// controllers/promotionController.js
const Promotion = require('../../models/MKT/Promotion');
const ProductImage = require('../../models/Stock/ProductImage');
const BranchStock = require('../../models/POS/BranchStock'); // Added import

// р╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Гр╕лр╕бр╣И
exports.createPromotion = async (req, res) => {
  try {
    const promotionData = req.body;

    // Validate dates
    if (new Date(promotionData.startDate) >= new Date(promotionData.endDate)) {
      return res.status(400).json({
        status: 'fail',
        message: 'р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Хр╣Йр╕нр╕Зр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф'
      });
    }

    // Set discountType based on type
    if (promotionData.type === 'discount_percentage') {
      promotionData.discountType = 'percentage';
    } else if (promotionData.type === 'discount_amount') {
      promotionData.discountType = 'amount';
    }

    // р╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
    const promotion = await Promotion.create({
      ...promotionData,
      createdBy: req.user?._id
    });

    // Populate before sending
    await promotion.populate('applicableProducts', 'name price productType');
    await promotion.populate('createdBy', 'name');

    // Emit socket event
    const io = req.app.get('io');
    if (io) {
      io.emit('promotionCreated', promotion);
    }

    res.status(201).json({
      status: 'success',
      data: promotion
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕Фр╕╣р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
exports.getAllPromotions = async (req, res) => {
  try {
    const { active, branch, startDate, endDate } = req.query;
    const filter = {};

    // Filter active only
    if (active === 'true') {
      const now = new Date();
      filter.isActive = true;
      filter.startDate = { $lte: now };
      filter.endDate = { $gte: now };
    }

    // Filter by branch
    if (branch) {
      filter.$or = [
        { applicableBranches: { $size: 0 } },
        { applicableBranches: branch }
      ];
    }

    // Filter by date range
    if (startDate || endDate) {
      filter.$and = filter.$and || [];
      if (startDate) {
        filter.$and.push({ endDate: { $gte: new Date(startDate) } });
      }
      if (endDate) {
        filter.$and.push({ startDate: { $lte: new Date(endDate) } });
      }
      // Remove empty $and
      if (filter.$and.length === 0) delete filter.$and;
    }

    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 50;
    const skip = (page - 1) * limit;

    const promotions = await Promotion.find(filter).lean()
      .populate('applicableProducts', 'name price productType')
      .populate('createdBy', 'name')
      .sort({ priority: 1, createdAt: -1 })
      .limit(limit)
      .skip(skip)
      .lean();

    const total = await Promotion.countDocuments(filter);

    res.json({
      status: 'success',
      results: promotions.length,
      total,
      data: promotions,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    });
  } catch (err) {
    res.status(500).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕Фр╕╣р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Хр╕▓р╕б ID
exports.getPromotionById = async (req, res) => {
  try {
    const promotion = await Promotion.findById(req.params.id).lean()
      .populate('applicableProducts')
      .populate('createdBy', 'name');

    if (!promotion) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ'
      });
    }

    res.json({
      status: 'success',
      data: promotion
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕нр╕▒р╕Юр╣Ар╕Фр╕Чр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.updatePromotion = async (req, res) => {
  try {
    const updateData = req.body;

    // Validate dates if both provided
    if (updateData.startDate && updateData.endDate) {
      if (new Date(updateData.startDate) >= new Date(updateData.endDate)) {
        return res.status(400).json({
          status: 'fail',
          message: 'р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Хр╣Йр╕нр╕Зр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф'
        });
      }
    }

    // Update discountType based on type
    if (updateData.type === 'discount_percentage') {
      updateData.discountType = 'percentage';
    } else if (updateData.type === 'discount_amount') {
      updateData.discountType = 'amount';
    }

    const promotion = await Promotion.findByIdAndUpdate(
      req.params.id,
      updateData,
      { new: true, runValidators: true }
    )
    .populate('applicableProducts', 'name price productType')
    .populate('createdBy', 'name');

    if (!promotion) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ'
      });
    }

    // Emit socket event
    const io = req.app.get('io');
    if (io) {
      io.emit('promotionUpdated', promotion);
    }

    res.json({
      status: 'success',
      data: promotion
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕ер╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.deletePromotion = async (req, res) => {
  try {
    const promotion = await Promotion.findByIdAndDelete(req.params.id);

    if (!promotion) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ'
      });
    }

    // Emit socket event
    const io = req.app.get('io');
    if (io) {
      io.emit('promotionDeleted', { id: req.params.id });
    }

    res.status(204).json({
      status: 'success',
      data: null
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕Др╕│р╕Щр╕зр╕Ур╕гр╕▓р╕Др╕▓р╕лр╕ер╕▒р╕Зр╕лр╕▒р╕Бр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.calculatePrice = async (req, res) => {
  try {
    const { productId, branchCode, quantity = 1, customerId } = req.body;

    // р╕лр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓
    const product = await ProductImage.findById(productId).lean();
    if (!product) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓'
      });
    }

    // р╕лр╕▓р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Др╕Фр╣Й
    const promotions = await Promotion.findActivePromotions({
      branchCode,
      productId,
      category: product.productType
    });

    // р╕Др╕│р╕Щр╕зр╕Ур╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Ир╕▓р╕Бр╣Бр╕Хр╣Ир╕ер╕░р╣Вр╕Ыр╕г
    let bestPromotion = null;
    let maxDiscount = 0;
    let originalPrice = product.price * quantity;
    let finalPrice = originalPrice;

    for (const promo of promotions) {
      // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б
      if (promo.conditions?.minPurchaseAmount > originalPrice) continue;

      const discount = promo.calculateDiscount(product.price, quantity);
      if (discount > maxDiscount) {
        maxDiscount = discount;
        bestPromotion = promo;
      }
    }

    finalPrice = originalPrice - maxDiscount;

    res.json({
      status: 'success',
      data: {
        originalPrice,
        discount: maxDiscount,
        finalPrice,
        appliedPromotion: bestPromotion ? {
          id: bestPromotion._id,
          name: bestPromotion.name,
          type: bestPromotion.type
        } : null
      }
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕Бр╕▒р╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓
// р╣Бр╕Бр╣Йр╣Др╕Вр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ checkAvailablePromotions р╣Гр╕Щр╣Др╕Яр╕ер╣М promotionController.js
// р╣Гр╕лр╣Йр╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕Фр╕┤р╕бр╕Фр╣Йр╕зр╕вр╣Вр╕Др╣Йр╕Фр╕Щр╕╡р╣Й

exports.checkAvailablePromotions = async (req, res) => {
  try {
    const { productIds, branchCode } = req.body;
    // console.log('ЁЯУе Request:', { productIds, branchCode });

    const now = new Date();

    // р╕Фр╕╢р╕Зр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣И active р╕Юр╕гр╣Йр╕нр╕б populate р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓
    const promotions = await Promotion.find({
      isActive: true,
      startDate: { $lte: now },
      endDate: { $gte: now },
      $or: [
        { applicableBranches: { $size: 0 } },
        { applicableBranches: branchCode }
      ]
    })
    .populate('applicableProducts', '_id name price') // р╕Хр╣Йр╕нр╕З populate name
    .lean();

    // console.log('ЁЯУЛ Found promotions:', promotions.length);

    const result = {};

    // р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Хр╣Ир╕ер╕░ branchStockId
    for (const branchStockId of productIds) {
      // р╕Фр╕╢р╕З BranchStock
      const stock = await BranchStock.findById(branchStockId).lean();
      if (!stock) {
        // console.log('тЭМ Stock not found:', branchStockId);
        continue;
      }

      // console.log('ЁЯУж Stock:', {
      //   _id: stock._id,
      //   name: stock.name,
      //   product_id: stock.product_id,
      //   productModel: stock.productModel
      // });

      // р╕Бр╕гр╕нр╕Зр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Др╕Фр╣Й - р╣Ар╕Кр╣Зр╕Др╕Фр╣Йр╕зр╕вр╕Кр╕╖р╣Ир╕нр╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕▒р╕Б
      const applicable = promotions.filter(p => {
        // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕кр╕┤р╕Щр╕Др╣Йр╕▓ = р╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕Бр╕▒р╕Ър╕Чр╕╕р╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓
        if (!p.applicableProducts || p.applicableProducts.length === 0) {
          // console.log(`тЬЕ Promotion "${p.name}" applies to all products.`);
          return true;
        }

        // р╣Ар╕Кр╣Зр╕Др╕Фр╣Йр╕зр╕вр╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕▒р╕Б
        if (stock.name) {
          const hasProductByName = p.applicableProducts.some(prod => {
            // р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ър╕Кр╕╖р╣Ир╕нр╣Бр╕Ър╕Ъ case-insensitive р╣Бр╕ер╕░ trim р╕Кр╣Ир╕нр╕Зр╕зр╣Ир╕▓р╕З
            const stockName = stock.name.trim().toLowerCase();
            const prodName = prod.name ? prod.name.trim().toLowerCase() : '';
            const match = stockName === prodName;

            if (match) {
              // console.log(`тЬЕ Promotion "${p.name}" matched by name: "${stock.name}" === "${prod.name}"`);
            }
            return match;
          });

          if (hasProductByName) {
            return true;
          }
        }

        // Fallback: р╣Ар╕Кр╣Зр╕Др╕Фр╣Йр╕зр╕в product_id (р╕Цр╣Йр╕▓р╕бр╕╡)
        if (stock.product_id && stock.productModel === 'ProductImage') {
          const hasProduct = p.applicableProducts.some(prod => {
            const match = prod._id.toString() === stock.product_id.toString();
            if (match) {
              // console.log(`тЬЕ Promotion "${p.name}" matched by product_id: ${stock.product_id}`);
            }
            return match;
          });
          if (hasProduct) {
            return true;
          }
        }

        // console.log(`ЁЯЪл Promotion "${p.name}" does not apply to: "${stock.name}"`);
        return false;
      });

      if (applicable.length) {
        result[branchStockId] = applicable.map(promo => ({
          id: promo._id,
          name: promo.name,
          type: promo.type,
          discount: promo.discountValue ?? promo.specialPrice ?? 0,
          discountType: promo.discountType
        }));
      }
    }

    // console.log('ЁЯУд Result:', JSON.stringify(result, null, 2));
    return res.json({ status: 'success', data: result });

  } catch (err) {
    console.error('Error in checkAvailablePromotions:', err);
    return res.status(500).json({ status: 'fail', message: err.message });
  }
};

// р╕нр╕▒р╕Юр╣Ар╕Фр╕Чр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.usePromotion = async (req, res) => {
  try {
    const { promotionId } = req.body;

    if (!promotionId) {
      return res.status(400).json({
        status: 'fail',
        message: 'promotionId is required'
      });
    }

    const promotion = await Promotion.findById(promotionId).lean();
    if (!promotion) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ'
      });
    }

    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕вр╕▒р╕Зр╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕нр╕вр╕╣р╣И
    if (!promotion.isValid) {
      return res.status(400).json({
        status: 'fail',
        message: 'р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╣Бр╕ер╣Йр╕з'
      });
    }

    // Check usage limit
    if (promotion.usageLimit && promotion.usageCount >= promotion.usageLimit) {
      return res.status(400).json({
        status: 'fail',
        message: 'р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Щр╕╡р╣Йр╕Цр╕╣р╕Бр╣Гр╕Кр╣Йр╣Ар╕Хр╣Зр╕бр╕Ир╕│р╕Щр╕зр╕Щр╣Бр╕ер╣Йр╕з'
      });
    }

    // р╣Ар╕Юр╕┤р╣Ир╕б usage count
    promotion.usageCount += 1;
    await promotion.save();

    res.json({
      status: 'success',
      message: 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в',
      data: {
        remainingUsage: promotion.usageLimit ? promotion.usageLimit - promotion.usageCount : 'unlimited'
      }
    });
  } catch (err) {
    res.status(400).json({
      status: 'fail',
      message: err.message
    });
  }
};

// р╕Фр╕╣р╕кр╕Цр╕┤р╕Хр╕┤р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.getPromotionStatistics = async (req, res) => {
  try {
    const { startDate, endDate, branchCode } = req.query;
    const filter = {};
    if (startDate || endDate) {
      filter.createdAt = {};
      if (startDate) filter.createdAt.$gte = new Date(startDate);
      if (endDate)   filter.createdAt.$lte = new Date(endDate);
    }
    if (branchCode) {
      filter.$or = [
        { applicableBranches: { $size: 0 } },
        { applicableBranches: branchCode }
      ];
    }
    const [ total, activeCount, expiredCount, upcomingCount, topUsed, agg ] = await Promise.all([
      Promotion.countDocuments(filter),
      Promotion.countDocuments({ ...filter, isActive: true, startDate: { $lte: new Date() }, endDate: { $gte: new Date() } }),
      Promotion.countDocuments({ ...filter, endDate: { $lt: new Date() } }),
      Promotion.countDocuments({ ...filter, startDate: { $gt: new Date() } }),
      Promotion.find(filter).lean().sort({ usageCount: -1 }).limit(5).select('name usageCount usageLimit type'),
      Promotion.aggregate([ { $match: filter }, { $group: { _id: null, totalUsage: { $sum: '$usageCount' } } } ])
    ]);
    const totalUsage = agg[0]?.totalUsage || 0;
    res.json({
      status: 'success',
      data: {
        р╕ар╕▓р╕Юр╕гр╕зр╕б: { р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: total, р╕Бр╕│р╕ер╕▒р╕Зр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ: activeCount, р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╣Бр╕ер╣Йр╕з: expiredCount, р╕Бр╕│р╕ер╕▒р╕Зр╕Ир╕░р╕бр╕▓: upcomingCount, р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕гр╕зр╕б: totalUsage },
        р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕вр╕нр╕Фр╕Щр╕┤р╕вр╕б: topUsed
      }
    });
  } catch (err) {
    res.status(500).json({ status: 'fail', message: err.message });
  }
};

// р╣Ар╕Ыр╕┤р╕Ф/р╕Ыр╕┤р╕Фр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕лр╕ер╕▓р╕вр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Щ
exports.bulkTogglePromotions = async (req, res) => {
  try {
    const { promotionIds, isActive } = req.body;
    if (!Array.isArray(promotionIds) || promotionIds.length === 0) {
      return res.status(400).json({ status: 'fail', message: 'р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕░р╕Ър╕╕р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕Цр╕▓р╕Щр╕░' });
    }
    const result = await Promotion.updateMany(
      { _id: { $in: promotionIds } },
      { isActive: Boolean(isActive) }
    );
    const io = req.app.get('io');
    if (io) io.emit('promotionsBulkUpdated', { promotionIds, isActive: Boolean(isActive), modifiedCount: result.modifiedCount });
    res.json({
      status: 'success',
      message: `р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в ${result.modifiedCount} р╕гр╕▓р╕вр╕Бр╕▓р╕г`,
      data: { р╣Бр╕Бр╣Йр╣Др╕Вр╣Бр╕ер╣Йр╕з: result.modifiedCount, р╕Юр╕Ър╣Бр╕ер╣Йр╕з: result.matchedCount }
    });
  } catch (err) {
    res.status(400).json({ status: 'fail', message: err.message });
  }
};

// р╕кр╣Ир╕Зр╕нр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.exportPromotions = async (req, res) => {
  try {
    const { format='csv', status, type, branch } = req.query;
    const filter = {};
    if (status && status!=='all') {
      const now = new Date();
      if (status==='active') {
        filter.isActive = true; filter.startDate={ $lte:now }; filter.endDate={ $gte:now };
      } else if (status==='expired') filter.endDate={ $lt:now };
      else if (status==='upcoming') filter.startDate={ $gt:now };
    }
    if (type && type!=='all') filter.type=type;
    if (branch && branch!=='all') filter.$or=[{ applicableBranches: { $size:0 }},{ applicableBranches:branch }];
    const promotions = await Promotion.find(filter).lean()
      .populate('applicableProducts','name')
      .populate('createdBy','name')
      .sort({ createdAt:-1 });
    const labels = {
      discount_percentage:'р╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣М',
      discount_amount:'р╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Ар╕Зр╕┤р╕Щ',
      special_price:'р╕гр╕▓р╕Др╕▓р╕Юр╕┤р╣Ар╕ир╕й',
      buy_x_get_y:'р╕Лр╕╖р╣Йр╕н X р╣Бр╕Цр╕б Y',
      bundle:'р╕Ир╕▒р╕Фр╕Кр╕╕р╕Фр╕кр╕┤р╕Щр╕Др╣Йр╕▓'
    };
    const statusLabel = promo=> {
      const now=new Date();
      if (!promo.isActive) return 'р╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ';
      if (now< promo.startDate) return 'р╕Бр╕│р╕ер╕▒р╕Зр╕Ир╕░р╕бр╕▓';
      if (now> promo.endDate) return 'р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╣Бр╕ер╣Йр╕з';
      return 'р╕Бр╕│р╕ер╕▒р╕Зр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ';
    };
    if (format==='csv') {
      const data = promotions.map(p=>({
        'р╕Кр╕╖р╣Ир╕нр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ':p.name,
        'р╕Ыр╕гр╕░р╣Ар╕ар╕Ч':labels[p.type]||p.type,
        'р╕кр╕Цр╕▓р╕Щр╕░': statusLabel(p),
        'р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ':p.startDate.toLocaleDateString('th-TH'),
        'р╕зр╕▒р╕Щр╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф':p.endDate.toLocaleDateString('th-TH'),
        'р╕Ир╕│р╕Щр╕зр╕Щр╕Бр╕▓р╕гр╣Гр╕Кр╣Й':p.usageCount||0,
        'р╕Ир╕│р╕Бр╕▒р╕Фр╕Бр╕▓р╕гр╣Гр╕Кр╣Й':p.usageLimit||'р╣Др╕бр╣Ир╕Ир╕│р╕Бр╕▒р╕Ф',
        'р╕Ьр╕╣р╣Йр╕кр╕гр╣Йр╕▓р╕З':p.createdBy?.name||'-',
        'р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕З':p.createdAt.toLocaleDateString('th-TH')
      }));
      const hdr=Object.keys(data[0]||{}).join(',');
      const rows=data.map(r=>Object.values(r).join(',')).join('\n');
      const csv=hdr+'\n'+rows;
      res.setHeader('Content-Type','text/csv; charset=utf-8');
      res.setHeader('Content-Disposition',`attachment; filename=promotions_${new Date().toISOString().split('T')[0]}.csv`);
      return res.send('\uFEFF'+csv);
    }
    res.json({ status:'success', data:promotions, exported_at:new Date().toISOString(), total_records:promotions.length });
  } catch(err){
    res.status(500).json({ status:'fail', message:err.message });
  }
};

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕Ор╕Вр╕нр╕Зр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.validatePromotionRules = async (req,res)=>{
  try {
    const { type,startDate,endDate,applicableProducts,applicableBranches,discountValue,specialPrice,bundleProducts,bundlePrice } = req.body;
    const errors=[], warnings=[];
    if (new Date(startDate)>=new Date(endDate)) errors.push('р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Хр╣Йр╕нр╕Зр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф');
    if (new Date(startDate)<new Date()) warnings.push('р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Ар╕Ыр╣Зр╕Щр╕нр╕Фр╕╡р╕Х р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Ир╕░р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕▒р╕Щр╕Чр╕╡');
    switch(type){
      case 'discount_percentage':
        if (!discountValue||discountValue<=0||discountValue>100) errors.push('р╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣Мр╕Хр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣Ир╕гр╕░р╕лр╕зр╣Ир╕▓р╕З 1-100%');
        break;
      case 'discount_amount':
        if (!discountValue||discountValue<=0) errors.push('р╕Ир╕│р╕Щр╕зр╕Щр╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Хр╣Йр╕нр╕Зр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 0');
        break;
      case 'special_price':
        if (!specialPrice||specialPrice<=0) errors.push('р╕гр╕▓р╕Др╕▓р╕Юр╕┤р╣Ар╕ир╕йр╕Хр╣Йр╕нр╕Зр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 0');
        break;
      case 'bundle':
        if (!bundleProducts||bundleProducts.length<2) errors.push('р╕Кр╕╕р╕Фр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕нр╕вр╣Ир╕▓р╕Зр╕Щр╣Йр╕нр╕в 2 р╕гр╕▓р╕вр╕Бр╕▓р╕г');
        if (!bundlePrice||bundlePrice<=0) warnings.push('р╕гр╕▓р╕Др╕▓р╕Кр╕╕р╕Фр╕Хр╣Йр╕нр╕Зр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 0');
        break;
    }
    const conflicts = await Promotion.find({
      $or:[{ startDate:{ $lte:new Date(endDate) }, endDate:{ $gte:new Date(startDate) } }],
      applicableProducts:{ $in: applicableProducts||[] },
      isActive:true
    }).select('name type startDate endDate');
    if (conflicts.length) warnings.push(`р╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Вр╕▒р╕Фр╣Бр╕вр╣Йр╕З: ${conflicts.map(p=>p.name).join(', ')}`);
    res.json({ status:'success', data:{ isValid: errors.length===0, errors, warnings, conflictingPromotions: conflicts } });
  } catch(err){
    res.status(500).json({ status:'fail', message:err.message });
  }
};

// р╕Др╕▒р╕Фр╕ер╕нр╕Бр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.clonePromotion = async (req,res)=>{
  try {
    const orig = await Promotion.findById(req.params.id).lean();
    if (!orig) return res.status(404).json({ status:'fail', message:'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Др╕▒р╕Фр╕ер╕нр╕Б' });
    const obj = { ...orig };
    delete obj._id; delete obj.createdAt; delete obj.updatedAt; delete obj.__v;
    obj.name = `${orig.name} (р╕кр╕│р╣Ар╕Щр╕▓)`; obj.usageCount=0; obj.isActive=false; obj.createdBy = req.user?._id;
    const dur = new Date(orig.endDate) - new Date(orig.startDate);
    const start = new Date(Date.now()+24*60*60*1000);
    obj.startDate = start;
    obj.endDate = new Date(start.getTime()+dur);
    const cloned = await Promotion.create(obj);
    await cloned.populate('applicableProducts','name price productType');
    await cloned.populate('createdBy','name');
    const io = req.app.get('io');
    if (io) io.emit('promotionCloned',{ original:orig._id, cloned:cloned._id });
    res.status(201).json({ status:'success', message:'р╕Др╕▒р╕Фр╕ер╕нр╕Бр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в', data:cloned });
  } catch(err){
    res.status(400).json({ status:'fail', message:err.message });
  }
};

// р╣Гр╕Кр╣Йр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Бр╕▒р╕Ър╕Хр╕░р╕Бр╕гр╣Йр╕▓
exports.applyPromotionToCart = async (req,res)=>{
  try {
    const { cartItems, branchCode } = req.body;
    const promotion = await Promotion.findById(req.params.id).lean();
    if (!promotion) return res.status(404).json({ status:'fail', message:'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ' });
    if (!promotion.isValid) return res.status(400).json({ status:'fail', message:'р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Кр╣Йр╣Др╕Фр╣Й' });
    if (promotion.applicableBranches.length>0 && !promotion.applicableBranches.includes(branchCode)) {
      return res.status(400).json({ status:'fail', message:'р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕кр╕▓р╕Вр╕▓' });
    }
    let totalDiscount=0, applicableItems=[];
    cartItems.forEach(it=>{
      const ok = !promotion.applicableProducts.length || promotion.applicableProducts.includes(it.productId);
      if (ok) {
        const d = promotion.calculateDiscount(it.price, it.quantity);
        totalDiscount += d;
        applicableItems.push({ ...it, discount:d, finalPrice:it.price*it.quantity-d });
      }
    });
    res.json({
      status:'success',
      data:{
        promotion:{ id:promotion._id, name:promotion.name, type:promotion.type },
        totalDiscount, applicableItems,
        summary:{
          itemsAffected:applicableItems.length,
          totalItemsInCart:cartItems.length,
          discountPercentage:((totalDiscount/cartItems.reduce((s,i)=>s+i.price*i.quantity,0))*100).toFixed(2)
        }
      }
    });
  } catch(err){
    res.status(400).json({ status:'fail', message:err.message });
  }
};

// р╕Хр╕▒р╕зр╕Кр╣Ир╕зр╕в Debug р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
exports.debugCalculatePrice = async (req, res) => {
  try {
    const { productId, branchCode, quantity = 1, customerId } = req.body;

    // console.log('=== DEBUG: р╕Др╕│р╕Вр╕нр╕Др╕│р╕Щр╕зр╕Ур╕гр╕▓р╕Др╕▓ ===');
    // console.log('р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓:', productId);
    // console.log('р╕гр╕лр╕▒р╕кр╕кр╕▓р╕Вр╕▓:', branchCode);
    // console.log('р╕Ир╕│р╕Щр╕зр╕Щ:', quantity);

    // р╕Др╣Йр╕Щр╕лр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓
    const product = await ProductImage.findById(productId).lean();
    if (!product) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓',
        debug: { productId, р╕Ьр╕ер╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓: null }
      });
    }

    // console.log('р╕Юр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓:', {
    //   р╕Кр╕╖р╣Ир╕н: product.name,
    //   р╕гр╕▓р╕Др╕▓: product.price,
    //   р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: product.productType
    // });

    // р╕Др╣Йр╕Щр╕лр╕▓р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣Ир╕Юр╕гр╣Йр╕нр╕б log р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф
    const promotions = await Promotion.findActivePromotions({
      branchCode,
      productId,
      category: product.productType
    });

    // console.log('р╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣И:', promotions.length, 'р╕гр╕▓р╕вр╕Бр╕▓р╕г');

    // р╕Др╕│р╕Щр╕зр╕Ур╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Бр╕Хр╣Ир╕ер╕░р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Юр╕гр╣Йр╕нр╕б debug
    let bestPromotion = null;
    let maxDiscount = 0;
    let originalPrice = product.price * quantity;
    let debugInfo = [];

    for (const promo of promotions) {
      // console.log(`\n--- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ: ${promo.name} ---`);
      // console.log('р╕Ыр╕гр╕░р╣Ар╕ар╕Ч:', promo.type);
      // console.log('р╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В:', promo.conditions);

      // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕вр╕нр╕Фр╕Лр╕╖р╣Йр╕нр╕Вр╕▒р╣Йр╕Щр╕Хр╣Ир╕│
      if (promo.conditions?.minPurchaseAmount > originalPrice) {
        // console.log(`р╕Вр╣Йр╕▓р╕б: р╕вр╕нр╕Фр╕Лр╕╖р╣Йр╕нр╕Вр╕▒р╣Йр╕Щр╕Хр╣Ир╕│ ${promo.conditions.minPurchaseAmount} > ${originalPrice}`);
        debugInfo.push({
          р╕Кр╕╖р╣Ир╕нр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ: promo.name,
          р╕Вр╣Йр╕▓р╕б: true,
          р╣Ар╕лр╕Хр╕╕р╕Ьр╕е: `р╕вр╕нр╕Фр╕Лр╕╖р╣Йр╕нр╕Вр╕▒р╣Йр╕Щр╕Хр╣Ир╕│ ${promo.conditions.minPurchaseAmount} р╕Ър╕▓р╕Ч`
        });
        continue;
      }

      // Debug р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕кр╣Ир╕зр╕Щр╕ер╕Ф
      // console.log('р╕Бр╕│р╕ер╕▒р╕Зр╕Др╕│р╕Щр╕зр╕Ур╕кр╣Ир╕зр╕Щр╕ер╕Ф...');
      // console.log('р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕кр╣Ир╕зр╕Щр╕ер╕Ф:', promo.discountType);
      // console.log('р╕бр╕╣р╕ер╕Др╣Ир╕▓р╕кр╣Ир╕зр╕Щр╕ер╕Ф:', promo.discountValue);
      // console.log('р╕гр╕▓р╕Др╕▓р╕Юр╕┤р╣Ар╕ир╕й:', promo.specialPrice);
      // console.log('р╕Лр╕╖р╣Йр╕н/р╣Бр╕Цр╕б:', promo.buyQuantity, '/', promo.getQuantity);

      const discount = promo.calculateDiscount(product.price, quantity);
      // console.log('р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Чр╕╡р╣Ир╕Др╕│р╕Щр╕зр╕Ур╣Др╕Фр╣Й:', discount);

      debugInfo.push({
        р╕Кр╕╖р╣Ир╕нр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ: promo.name,
        р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: promo.type,
        р╕бр╕╣р╕ер╕Др╣Ир╕▓р╕кр╣Ир╕зр╕Щр╕ер╕Ф: promo.discountValue,
        р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Чр╕╡р╣Ир╕Др╕│р╕Щр╕зр╕Ур╣Др╕Фр╣Й: discount,
        р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф: {
          р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕кр╣Ир╕зр╕Щр╕ер╕Ф: promo.discountType,
          р╕гр╕▓р╕Др╕▓р╕Юр╕┤р╣Ар╕ир╕й: promo.specialPrice,
          р╕Ир╕│р╕Щр╕зр╕Щр╕Лр╕╖р╣Йр╕н: promo.buyQuantity,
          р╕Ир╕│р╕Щр╕зр╕Щр╣Бр╕Цр╕б: promo.getQuantity
        }
      });

      if (discount > maxDiscount) {
        maxDiscount = discount;
        bestPromotion = promo;
      }
    }

    let finalPrice = originalPrice - maxDiscount;

    // console.log('\n=== р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в ===');
    // console.log('р╕гр╕▓р╕Др╕▓р╣Ар╕Фр╕┤р╕б:', originalPrice);
    // console.log('р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕кр╕╣р╕Зр╕кр╕╕р╕Ф:', maxDiscount);
    // console.log('р╕гр╕▓р╕Др╕▓р╕кр╕╕р╕Чр╕Шр╕┤:', finalPrice);
    // console.log('р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф:', bestPromotion?.name || 'р╣Др╕бр╣Ир╕бр╕╡');

    res.json({
      status: 'success',
      data: {
        р╕гр╕▓р╕Др╕▓р╣Ар╕Фр╕┤р╕б: originalPrice,
        р╕кр╣Ир╕зр╕Щр╕ер╕Ф: maxDiscount,
        р╕гр╕▓р╕Др╕▓р╕кр╕╕р╕Чр╕Шр╕┤: finalPrice,
        р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Й: bestPromotion ? {
          id: bestPromotion._id,
          р╕Кр╕╖р╣Ир╕н: bestPromotion.name,
          р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: bestPromotion.type
        } : null
      },
      debug: {
        р╕кр╕┤р╕Щр╕Др╣Йр╕▓: {
          р╕Кр╕╖р╣Ир╕н: product.name,
          р╕гр╕▓р╕Др╕▓: product.price,
          р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: product.productType
        },
        р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: debugInfo,
        р╕Ир╕│р╕Щр╕зр╕Щр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕Юр╕Ъ: promotions.length
      }
    });
  } catch (err) {
    console.error('ERROR in debugCalculatePrice:', err);
    res.status(400).json({
      status: 'fail',
      message: err.message,
      stack: err.stack
    });
  }
};

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
exports.validatePromotionSetup = async (req, res) => {
  try {
    const promotion = await Promotion.findById(req.params.id).lean()
      .populate('applicableProducts')
      .populate('bundleProducts');

    if (!promotion) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ'
      });
    }

    const issues = [];
    const warnings = [];

    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ
    if (!promotion.name) issues.push('р╣Др╕бр╣Ир╕бр╕╡р╕Кр╕╖р╣Ир╕нр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ');
    if (!promotion.type) issues.push('р╣Др╕бр╣Ир╕бр╕╡р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ');

    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Хр╕▓р╕бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ
    switch(promotion.type) {
      case 'discount_percentage':
        if (!promotion.discountValue || promotion.discountValue <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣Мр╕кр╣Ир╕зр╕Щр╕ер╕Ф р╕лр╕гр╕╖р╕нр╕Др╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ 0');
        }
        if (promotion.discountValue > 100) {
          issues.push('р╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣Мр╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Ар╕Бр╕┤р╕Щ 100%');
        }
        break;

      case 'discount_amount':
        if (!promotion.discountValue || promotion.discountValue <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щр╕кр╣Ир╕зр╕Щр╕ер╕Ф р╕лр╕гр╕╖р╕нр╕Др╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ 0');
        }
        break;

      case 'special_price':
        if (!promotion.specialPrice || promotion.specialPrice <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕гр╕▓р╕Др╕▓р╕Юр╕┤р╣Ар╕ир╕й р╕лр╕гр╕╖р╕нр╕Др╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ 0');
        }
        break;

      case 'buy_x_get_y':
        if (!promotion.buyQuantity || promotion.buyQuantity <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ир╕│р╕Щр╕зр╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Лр╕╖р╣Йр╕н');
        }
        if (!promotion.getQuantity || promotion.getQuantity <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ир╕│р╕Щр╕зр╕Щр╕Чр╕╡р╣Ир╣Бр╕Цр╕б');
        }
        break;

      case 'bundle':
        if (!promotion.bundleProducts || promotion.bundleProducts.length < 2) {
          issues.push('р╕Кр╕╕р╕Фр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕нр╕вр╣Ир╕▓р╕Зр╕Щр╣Йр╕нр╕в 2 р╕гр╕▓р╕вр╕Бр╕▓р╕г');
        }
        if (!promotion.bundlePrice || promotion.bundlePrice <= 0) {
          issues.push('р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕гр╕▓р╕Др╕▓р╕Кр╕╕р╕Фр╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╕лр╕гр╕╖р╕нр╕Др╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ 0');
        }
        break;
    }

    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╕▒р╕Щр╕Чр╕╡р╣И
    const now = new Date();
    if (promotion.startDate > promotion.endDate) {
      issues.push('р╕зр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕кр╕┤р╣Йр╕Щр╕кр╕╕р╕Ф');
    }
    if (promotion.endDate < now) {
      warnings.push('р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╣Бр╕ер╣Йр╕з');
    }

    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓/р╕кр╕▓р╕Вр╕▓
    if (promotion.applicableProducts.length === 0 &&
        promotion.applicableCategories.length === 0) {
      warnings.push('р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕Бр╕▒р╕Ър╕Чр╕╕р╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓');
    }

    if (promotion.applicableBranches.length === 0) {
      warnings.push('р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕Бр╕▒р╕Ър╕Чр╕╕р╕Бр╕кр╕▓р╕Вр╕▓');
    }

    res.json({
      status: 'success',
      data: {
        р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ: {
          id: promotion._id,
          р╕Кр╕╖р╣Ир╕н: promotion.name,
          р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: promotion.type,
          р╕кр╕Цр╕▓р╕Щр╕░: promotion.status,
          р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Й: promotion.isValid
        },
        р╕Ыр╕▒р╕Нр╕лр╕▓р╕Чр╕╡р╣Ир╕Юр╕Ъ: issues,
        р╕Др╕│р╣Ар╕Хр╕╖р╕нр╕Щ: warnings,
        р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓: issues.length === 0 ? 'р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З' : 'р╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓'
      }
    });
  } catch (err) {
    res.status(500).json({
      status: 'fail',
      message: err.message
    });
  }
};

// ===== NEW ADVANCED FEATURES =====

// Dashboard Analytics
exports.getPromotionAnalytics = async (req, res) => {
  try {
    const { startDate, endDate, branchCode } = req.query;
    const dateFilter = {};
    const branchFilter = {};

    if (startDate || endDate) {
      dateFilter.createdAt = {};
      if (startDate) dateFilter.createdAt.$gte = new Date(startDate);
      if (endDate) dateFilter.createdAt.$lte = new Date(endDate);
    }

    if (branchCode && branchCode !== 'all') {
      branchFilter.$or = [
        { applicableBranches: { $size: 0 } },
        { applicableBranches: branchCode }
      ];
    }

    const filter = { ...dateFilter, ...branchFilter };

    // Parallel queries for better performance
    const [
      totalPromotions,
      activePromotions,
      totalUsage,
      topPerforming,
      recentActivity,
      conversionRate
    ] = await Promise.all([
      Promotion.countDocuments(filter),
      Promotion.countDocuments({
        ...filter,
        isActive: true,
        startDate: { $lte: new Date() },
        endDate: { $gte: new Date() }
      }),
      Promotion.aggregate([
        { $match: filter },
        { $group: { _id: null, totalUsage: { $sum: '$usageCount' } } }
      ]),
      Promotion.find(filter)
        .sort({ usageCount: -1 })
        .limit(5)
        .populate('applicableProducts', 'name')
        .select('name type usageCount discountValue'),
      Promotion.find(filter)
        .sort({ createdAt: -1 })
        .limit(10)
        .select('name type createdAt isActive'),
      Promotion.aggregate([
        { $match: { ...filter, usageCount: { $gt: 0 } } },
        { $group: {
          _id: null,
          totalWithUsage: { $sum: 1 },
          avgUsage: { $avg: '$usageCount' }
        }}
      ])
    ]);

    res.json({
      status: 'success',
      data: {
        overview: {
          totalPromotions,
          activePromotions,
          totalUsage: totalUsage[0]?.totalUsage || 0,
          conversionRate: conversionRate[0] ?
            ((conversionRate[0].totalWithUsage / totalPromotions) * 100).toFixed(2) : 0
        },
        topPerforming,
        recentActivity,
        avgUsagePerPromotion: conversionRate[0]?.avgUsage || 0
      }
    });
  } catch (err) {
    res.status(500).json({ status: 'fail', message: err.message });
  }
};

// ROI Calculator
exports.calculateROI = async (req, res) => {
  try {
    const { promotionId } = req.params;
    const promotion = await Promotion.findById(promotionId).lean();

    if (!promotion) {
      return res.status(404).json({ status: 'fail', message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ' });
    }

    // Query actual sales data from SalesTransaction collection
    // Assuming sales records reference promotion ID
    const salesData = await mongoose.connection.db.collection('salestransactions').aggregate([
      {
        $match: {
          promotionId: new mongoose.Types.ObjectId(promotionId),
          createdAt: {
            $gte: promotion.startDate,
            $lte: promotion.endDate
          }
        }
      },
      {
        $group: {
          _id: null,
          totalSales: { $sum: '$totalAmount' },
          totalDiscount: { $sum: '$discountAmount' },
          transactionCount: { $sum: 1 }
        }
      }
    ]).toArray();

    if (salesData.length === 0) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╕Вр╕▓р╕вр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Щр╕╡р╣Й'
      });
    }

    const { totalSales, totalDiscount, transactionCount } = salesData[0];
    const netRevenue = totalSales - totalDiscount;
    const roi = totalDiscount > 0 ? ((netRevenue / totalDiscount) * 100).toFixed(2) : 0;

    res.json({
      status: 'success',
      data: {
        promotionName: promotion.name,
        totalTransactions: transactionCount,
        totalSales: totalSales,
        totalDiscount: totalDiscount,
        netRevenue: netRevenue,
        roi: `${roi}%`,
        effectiveness: roi > 100 ? 'р╕кр╕╣р╕З' : roi > 50 ? 'р╕Ыр╕▓р╕Щр╕Бр╕ер╕▓р╕З' : 'р╕Хр╣Ир╕│'
      }
    });
  } catch (err) {
    res.status(500).json({
      status: 'fail',
      message: `р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Др╕│р╕Щр╕зр╕У ROI: ${err.message}`
    });
  }
};

// Auto Schedule Promotions
exports.schedulePromotion = async (req, res) => {
  try {
    const { promotionId, scheduleType, scheduleData } = req.body;

    const promotion = await Promotion.findById(promotionId);
    if (!promotion) {
      return res.status(404).json({ status: 'fail', message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ' });
    }

    // Add schedule metadata
    promotion.schedule = {
      type: scheduleType, // 'auto_start', 'auto_end', 'recurring'
      data: scheduleData,
      createdAt: new Date()
    };

    await promotion.save();

    // In a real system, you'd integrate with a job scheduler like Bull Queue or node-cron
    console.log(`ЁЯУЕ Scheduled ${scheduleType} for promotion: ${promotion.name}`);

    res.json({
      status: 'success',
      message: 'р╕Ир╕▒р╕Фр╕Бр╕│р╕лр╕Щр╕Фр╕Бр╕▓р╕гр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в',
      data: promotion
    });
  } catch (err) {
    res.status(500).json({ status: 'fail', message: err.message });
  }
};

// Advanced Promotion Templates
exports.getPromotionTemplates = async (req, res) => {
  try {
    // Query existing promotions grouped by type to create dynamic templates
    const templateData = await Promotion.aggregate([
      { $match: { isActive: true } },
      {
        $group: {
          _id: '$type',
          count: { $sum: 1 },
          avgDiscount: { $avg: '$discountValue' },
          avgDuration: {
            $avg: {
              $divide: [
                { $subtract: ['$endDate', '$startDate'] },
                1000 * 60 * 60 * 24
              ]
            }
          },
          examples: { $push: { name: '$name', description: '$description' } }
        }
      },
      { $sort: { count: -1 } }
    ]);

    if (templateData.length === 0) {
      return res.status(404).json({
        status: 'fail',
        message: 'р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Хр╕Ир╕▓р╕Бр╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И'
      });
    }

    const templates = templateData.map(template => ({
      type: template._id,
      usage_count: template.count,
      average_discount: Math.round(template.avgDiscount || 0),
      average_duration_days: Math.round(template.avgDuration || 7),
      examples: template.examples.slice(0, 2)
    }));

    res.json({
      status: 'success',
      data: templates,
      message: `р╕Юр╕Ъ ${templates.length} р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Хр╕Ир╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕гр╕┤р╕З`
    });
  } catch (err) {
    res.status(500).json({
      status: 'fail',
      message: `р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Чр╕бр╣Ар╕Юр╕ер╕Х: ${err.message}`
    });
  }
};

// A/B Testing for Promotions
exports.createABTest = async (req, res) => {
  try {
    const { promotionAId, promotionBId, trafficSplit = 50 } = req.body;

    const [promoA, promoB] = await Promise.all([
      Promotion.findById(promotionAId),
      Promotion.findById(promotionBId)
    ]);

    if (!promoA || !promoB) {
      return res.status(404).json({ status: 'fail', message: 'р╣Др╕бр╣Ир╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щ' });
    }

    // Create A/B test record (in real system, this would be a separate model)
    const abTest = {
      id: `ab_${Date.now()}`,
      name: `A/B Test: ${promoA.name} vs ${promoB.name}`,
      promotionA: promoA,
      promotionB: promoB,
      trafficSplit: trafficSplit,
      status: 'active',
      createdAt: new Date(),
      results: {
        variantA: { impressions: 0, conversions: 0 },
        variantB: { impressions: 0, conversions: 0 }
      }
    };

    res.json({
      status: 'success',
      message: 'р╕кр╕гр╣Йр╕▓р╕З A/B Test р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в',
      data: abTest
    });
  } catch (err) {
    res.status(500).json({ status: 'fail', message: err.message });
  }
};

// Notification System
exports.getNotifications = async (req, res) => {
  try {
    const now = new Date();
    const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

    // First check if we have any promotions at all
    const totalPromotions = await Promotion.countDocuments({});
    if (totalPromotions === 0) {
      return res.json({
        status: 'success',
        data: {
          notifications: [],
          summary: {
            expiringSoon: 0,
            highUsage: 0,
            lowPerformance: 0,
            total: 0
          },
          message: 'р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ'
        }
      });
    }

    // Run queries with proper error handling for each
    let expiringSoon = [];
    let highUsage = [];
    let lowPerformance = [];

    try {
      // Promotions expiring soon
      expiringSoon = await Promotion.find({
        isActive: true,
        endDate: { $gte: now, $lte: weekFromNow }
      }).select('name endDate').lean() || [];
    } catch (err) {
      console.warn('Error fetching expiring promotions:', err.message);
    }

    try {
      // High usage promotions (near limit) - simplified query
      highUsage = await Promotion.find({
        isActive: true,
        usageLimit: { $ne: null, $gt: 0 }
      }).select('name usageCount usageLimit').lean() || [];

      // Filter in memory to avoid complex aggregation
      highUsage = highUsage.filter(promo =>
        promo.usageLimit && promo.usageCount >= (promo.usageLimit * 0.8)
      );
    } catch (err) {
      console.warn('Error fetching high usage promotions:', err.message);
    }

    try {
      // Low performing promotions
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      lowPerformance = await Promotion.find({
        isActive: true,
        createdAt: { $lte: oneWeekAgo },
        usageCount: { $lte: 5 }
      }).select('name usageCount createdAt').lean() || [];
    } catch (err) {
      console.warn('Error fetching low performance promotions:', err.message);
    }

    const notifications = [];

    // Add expiring notifications
    if (expiringSoon && expiringSoon.length > 0) {
      expiringSoon.forEach(promo => {
        try {
          const daysLeft = Math.ceil((new Date(promo.endDate) - now) / (24 * 60 * 60 * 1000));
          if (daysLeft >= 0) { // Only add if not already expired
            notifications.push({
              type: 'warning',
              title: 'р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╣Гр╕Бр╕ер╣Йр╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕',
              message: `${promo.name} р╕Ир╕░р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╣Гр╕Щр╕нр╕╡р╕Б ${daysLeft} р╕зр╕▒р╕Щ`,
              action: 'extend_promotion',
              promotionId: promo._id
            });
          }
        } catch (err) {
          console.warn('Error processing expiring notification:', err.message);
        }
      });
    }

    // Add high usage notifications
    if (highUsage && highUsage.length > 0) {
      highUsage.forEach(promo => {
        try {
          const usagePercent = ((promo.usageCount / promo.usageLimit) * 100).toFixed(0);
          notifications.push({
            type: 'info',
            title: 'р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕кр╕╣р╕З',
            message: `${promo.name} р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Ыр╣Бр╕ер╣Йр╕з ${usagePercent}%`,
            action: 'increase_limit',
            promotionId: promo._id
          });
        } catch (err) {
          console.warn('Error processing high usage notification:', err.message);
        }
      });
    }

    // Add low performance notifications
    if (lowPerformance && lowPerformance.length > 0) {
      lowPerformance.forEach(promo => {
        try {
          notifications.push({
            type: 'alert',
            title: 'р╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕Хр╣Ир╕│',
            message: `${promo.name} р╕бр╕╡р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Ар╕Юр╕╡р╕вр╕З ${promo.usageCount} р╕Др╕гр╕▒р╣Йр╕З`,
            action: 'optimize_promotion',
            promotionId: promo._id
          });
        } catch (err) {
          console.warn('Error processing low performance notification:', err.message);
        }
      });
    }

    res.json({
      status: 'success',
      data: {
        notifications: notifications || [],
        summary: {
          expiringSoon: (expiringSoon || []).length,
          highUsage: (highUsage || []).length,
          lowPerformance: (lowPerformance || []).length,
          total: notifications.length
        }
      }
    });
  } catch (err) {
    console.error('Notifications API Error:', err);
    // Return empty state instead of error to prevent frontend crashes
    res.json({
      status: 'success',
      data: {
        notifications: [],
        summary: {
          expiringSoon: 0,
          highUsage: 0,
          lowPerformance: 0,
          total: 0
        },
        error: `р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Вр╕лр╕ер╕Фр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ: ${err.message}`
      }
    });
  }
};

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╕Др╣Ир╕▓ 0
async function fixZeroDiscountPromotions() {
  try {
    const promotions = await Promotion.find({
      $or: [
        { discountValue: 0 },
        { discountValue: null },
        { discountValue: { $exists: false } }
      ]
    });

    // console.log(`р╕Юр╕Ър╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╣Ир╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╕кр╣Ир╕зр╕Щр╕ер╕Ф 0: ${promotions.length} р╕гр╕▓р╕вр╕Бр╕▓р╕г`);

    for (const promo of promotions) {
      // console.log(`\nр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ: ${promo.name}`);
      // console.log(`р╕Ыр╕гр╕░р╣Ар╕ар╕Ч: ${promo.type}`);
      // console.log(`р╕Др╣Ир╕▓р╕кр╣Ир╕зр╕Щр╕ер╕Ф: ${promo.discountValue}`);

      if (promo.type === 'discount_percentage' || promo.type === 'discount_amount') {
        // console.log('>>> р╕Хр╣Йр╕нр╕Зр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ discountValue р╣Гр╕лр╣Йр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 0');
      }
    }

    return promotions;
  } catch (err) {
    console.error('Error fixing promotions:', err);
  }
}
