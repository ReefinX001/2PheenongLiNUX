// File: controllers/ReceiptController.js
const mongoose = require('mongoose');
const InvoicePdfController = require('../InvoicePdfController');
const Receipt = require('../../models/Receipt');
const Counter = require('../../models/POS/Counter');
const Branch = require('../../models/Account/Branch');
const User = require('../../models/User/User');
const bahtText = require('thai-baht-text');
const path = require('path');
const Customer = require('../../models/Customer/Customer');
const PdfController = require('../pdf/PDFOutReceiptController');

// Constants
const DEFAULT_TAX_RATE = 7;
const DEFAULT_SEQUENCE_PADDING = 4;
const DEFAULT_COMPANY_NAME = '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î';

/**
 * ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠ fallback
 */
function ensureNumberData(value, fallback = 0) {
  const num = Number(value);
  return isNaN(num) ? fallback : num;
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡πÅ‡∏ö‡∏ö Tax Inclusive
 */
function calculateVATInclusive(amount, taxRate = DEFAULT_TAX_RATE) {
  return amount * taxRate / (100 + taxRate);
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡πÅ‡∏ö‡∏ö Tax Exclusive
 */
function calculateVATExclusive(amount, taxRate = DEFAULT_TAX_RATE) {
  return amount * taxRate / 100;
}

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì totalPrice ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö item
 */
function calculateItemTotalPrice(item) {
  const quantity = ensureNumberData(item.quantity, 1);
  const unitPrice = ensureNumberData(item.unitPrice, 0);
  const discount = ensureNumberData(item.discount, 0);
  return (quantity * unitPrice) - discount;
}

/**
 * sanitize ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô formatted object
 */
function sanitizeNumericSections(formatted) {
  if (Array.isArray(formatted.items)) {
    formatted.items = formatted.items.map(i => {
      const quantity = ensureNumberData(i.quantity, 1);
      const unitPrice = ensureNumberData(i.unitPrice, 0);
      const discount = ensureNumberData(i.discount, 0);
      const downAmount = ensureNumberData(i.downAmount, 0);
      const termCount = ensureNumberData(i.termCount, 0);
      const installmentAmount = ensureNumberData(i.installmentAmount, 0);

      return {
        ...i,
        quantity,
        unitPrice,
        discount,
        totalPrice: i.totalPrice ? ensureNumberData(i.totalPrice) : calculateItemTotalPrice(i),
        downAmount,
        termCount,
        installmentAmount,
        taxRate: ensureNumberData(i.taxRate, DEFAULT_TAX_RATE),
        amount: ensureNumberData(i.amount) || downAmount
      };
    });
  }

  if (formatted.summary) {
    formatted.summary = {
      financedTotal: ensureNumberData(formatted.summary.financedTotal),
      downTotal: ensureNumberData(formatted.summary.downTotal),
      subtotal: ensureNumberData(formatted.summary.subtotal),
      discount: ensureNumberData(formatted.summary.discount),
      beforeTax: ensureNumberData(formatted.summary.beforeTax),
      tax: ensureNumberData(formatted.summary.tax),
      netTotal: ensureNumberData(formatted.summary.netTotal),
    };
  }

  formatted.shippingFee = ensureNumberData(formatted.shippingFee);
  formatted.docFee = ensureNumberData(formatted.docFee);
  return formatted;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á receiptNumber
 */
async function generateReceiptNumber() {
  const now = new Date();
  const yearBE = now.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®.
  const yearShort = yearBE.toString().slice(-2); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 2 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (68)
  const MM = String(now.getMonth() + 1).padStart(2, '0'); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å (08)
  const DD = String(now.getDate()).padStart(2, '0'); // ‡∏ß‡∏±‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å (16)
  const datePrefix = `${yearShort}${MM}${DD}`; // 680816
  const dateKey = `RE-${datePrefix}`;

  const ctr = await Counter.findOneAndUpdate(
    { key: 'receipt', reference_value: dateKey },
    { $inc: { seq: 1 }, $setOnInsert: { key: 'receipt', reference_value: dateKey } },
    { new: true, upsert: true, strict: false }
  );

  const receiptNumber = `${dateKey}-${String(ctr.seq).padStart(3, '0')}`;
  console.log('üìÑ Generated receipt number with current date:', receiptNumber);
  console.log(`üóìÔ∏è Date format: ${datePrefix} (${DD}/${MM}/${yearBE} ‡∏û.‡∏®.)`);

  return receiptNumber;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á taxInvoiceNumber
 */
async function generateTaxInvoiceNumber() {
  const now = new Date();
  const yearBE = now.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®.
  const yearShort = yearBE.toString().slice(-2); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 2 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (68)
  const MM = String(now.getMonth() + 1).padStart(2, '0'); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å (08)
  const DD = String(now.getDate()).padStart(2, '0'); // ‡∏ß‡∏±‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å (16)
  const datePrefix = `${yearShort}${MM}${DD}`; // 680816
  const dateKey = `TX-${datePrefix}`;

  const ctr = await Counter.findOneAndUpdate(
    { key: 'tax_invoice', reference_value: dateKey },
    { $inc: { seq: 1 }, $setOnInsert: { key: 'tax_invoice', reference_value: dateKey } },
    { new: true, upsert: true, strict: false }
  );

  const taxInvoiceNumber = `${dateKey}-${String(ctr.seq).padStart(3, '0')}`;
  console.log('üìÑ Generated tax invoice number with current date:', taxInvoiceNumber);
  console.log(`üóìÔ∏è Date format: ${datePrefix} (${DD}/${MM}/${yearBE} ‡∏û.‡∏®.)`);

  return taxInvoiceNumber;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á invoiceNumber
 */
async function generateInvoiceNumber() {
  const now = new Date();
  const thaiYear = now.getFullYear() + 543;
  const MM = String(now.getMonth() + 1).padStart(2, '0');
  const DD = String(now.getDate()).padStart(2, '0');
  const dateKey = `INV-${thaiYear}${MM}${DD}`;

  const ctr = await Counter.findOneAndUpdate(
    { key: 'invoice', reference_value: dateKey },
    { $inc: { seq: 1 }, $setOnInsert: { key: 'invoice', reference_value: dateKey } },
    { new: true, upsert: true, strict: false }
  );

  const seqStr = String(ctr.seq).padStart(DEFAULT_SEQUENCE_PADDING, '0');
  return `${dateKey}${seqStr}`;
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
 */
async function getSalespersonInfo(userId, defaultName = '', defaultSignature = '') {
  if (!userId) {
    return {
      name: defaultName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)',
      signatureUrl: defaultSignature
    };
  }

  try {
    const user = await User.findById(userId).lean()
      .populate('employee', 'name')
      .lean();

    return {
      name: user?.employee?.name || defaultName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)',
      signatureUrl: user?.employeeSignatureUrl || defaultSignature
    };
  } catch (error) {
    console.warn('Error fetching salesperson info:', error);
    return {
      name: defaultName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)',
      signatureUrl: defaultSignature
    };
  }
}

/**
 * validate taxType
 */
const validateTaxType = (taxType) => {
  const validTypes = ['‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ', '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ', '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT', '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå', '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î'];
  return validTypes.includes(taxType) ? taxType : '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT';
};

/**
 * GET /api/receipt/:id/pdf
 * ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ _id ‡∏Ç‡∏≠‡∏á InvoiceReceipt
 */
exports.getPdf = async (req, res, next) => {
  try {
    const { id } = req.params;

    // Validation
    if (!mongoose.Types.ObjectId.isValid(id)) {
      return res.status(400).json({
        success: false,
        error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    // ‡∏´‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - ‡πÄ‡∏û‡∏¥‡πà‡∏° populate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    const order = await InvoiceReceipt.findById(id).lean()
      .populate('items.product', 'name')
      .populate({
        path: 'userId',
        select: 'employee',
        populate: {
          path: 'employee',
          select: 'name'
        }
      })
      .lean();

    if (!order) {
      return res.status(404).json({
        success: false,
        error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    if (!order.items || !Array.isArray(order.items)) {
      return res.status(400).json({
        success: false,
        error: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
    const rawBranch = await Branch.findOne({
      $or: [
        { code: order.branchCode },
        { branch_code: order.branchCode }
      ]
    })
    .select('branch_code code name address taxId tel')
    .lean();

    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å order ‡∏ó‡∏µ‡πà populate ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    const salespersonInfo = {
      name: order.userId?.employee?.name || order.salespersonName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)',
      signatureUrl: order.salespersonSignatureUrl || ''
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
    const branch = rawBranch ? {
      name: rawBranch.name,
      code: rawBranch.branch_code || rawBranch.code,
      address: rawBranch.address,
      taxId: rawBranch.taxId,
      tel: rawBranch.tel
    } : {
      name: '-',
      code: '-',
      address: '-',
      taxId: '-',
      tel: '-'
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• company
    const company = {
      name: DEFAULT_COMPANY_NAME,
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    const issueDate = order.date || new Date();
    const issueDateFormatted = order.date
      ? new Date(order.date).toLocaleDateString('th-TH')
      : '-';

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    const customer = {
      name: order.customer?.name || '-',
      address: order.customer?.address || '-',
      taxId: order.customer?.taxId || '-',
      phone: order.customer?.phone || '-'
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
    const items = order.items.map(i => {
      const downAmount = ensureNumberData(i.downAmount, 0);
      const installmentAmount = ensureNumberData(i.installmentAmount, 0);
      const termCount = ensureNumberData(i.termCount, 0);
      const amount = downAmount;

      return {
        description: i.description || i.product?.name || '-',
        imei: i.imei || '',
        quantity: ensureNumberData(i.quantity, 1),
        unitPrice: ensureNumberData(i.unitPrice, 0),
        discount: ensureNumberData(i.discount, 0),
        totalPrice: calculateItemTotalPrice(i),
        downAmount,
        termCount,
        installmentAmount,
        amount,
        taxRate: ensureNumberData(i.taxRate, DEFAULT_TAX_RATE),
        taxType: validateTaxType(i.taxType)
      };
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let sumAmount = 0;
    let vatTotal = 0;

    // ‚úÖ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Receipt_installment.js
    items.forEach(item => {
      sumAmount += item.amount;

      if (item.taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå') {
        // ‡∏´‡∏±‡∏Å VAT ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå
        const vatDown = item.downAmount * item.taxRate / (100 + item.taxRate);
        vatTotal += vatDown;
      } else if (item.taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î') {
        // ‡∏´‡∏±‡∏Å VAT ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const totalInst = item.installmentAmount * item.termCount;
        const vatInst = totalInst * item.taxRate / (100 + item.taxRate);
        vatTotal += vatInst;
      } else if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
        // VAT ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
        vatTotal += item.amount * item.taxRate / 100;
      } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
        // ‡∏´‡∏±‡∏Å VAT ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
        const vatIncluded = item.amount * item.taxRate / (100 + item.taxRate);
        vatTotal += vatIncluded;
      }
    });

    vatTotal = Math.round(vatTotal * 100) / 100;

    const netBeforeTax = sumAmount - vatTotal;
    const grandTotal = sumAmount;

    const summary = {
      financedTotal: items.reduce((sum, i) => sum + (i.installmentAmount * i.termCount), 0),
      downTotal: items.reduce((sum, i) => sum + i.downAmount, 0),
      subtotal: items.reduce((sum, i) => sum + (i.quantity * i.unitPrice), 0),
      discount: items.reduce((sum, i) => sum + i.discount, 0),
      beforeTax: netBeforeTax,
      tax: vatTotal,
      netTotal: grandTotal
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    const formatted = {
      receiptNumber: order.receiptNumber || '-',
      documentNumber: order.receiptNumber || '-',
      invoiceNumber: order.receiptNumber || '-',
      type: order.type || 'RECEIPT',
      issueDate,
      issueDateFormatted,
      pickupMethod: order.pickupMethod || '-',

      company,
      branch,
      customer,
      salesperson: salespersonInfo,

      items,

      shippingFee: ensureNumberData(order.shippingFee, 0),
      docFee: ensureNumberData(order.docFee, 0),
      paymentMethod: order.paymentMethod || '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',

      sumAmount,
      vatTotal,
      netBeforeTax,
      grandTotal,
      amountInWords: bahtText(grandTotal),
      summary,

      planSummaryText: order.planSummaryText || '',
      termsText: order.termsText || '',

      customerSignatureUrl: order.customerSignatureUrl || '',
      salespersonSignatureUrl: salespersonInfo.signatureUrl,
      authorizedSignatureUrl: order.authorizedSignatureUrl || path.join(process.cwd(), 'uploads', 'default-sign.png')
    };

    // sanitize ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    sanitizeNumericSections(formatted);

    // Debug log
    // console.log('‚û°Ô∏è formatted for Receipt PDF:', {
    //   receiptNumber: formatted.receiptNumber,
    //   issueDate: formatted.issueDateFormatted,
    //   branchName: formatted.branch.name,
    //   itemsCount: formatted.items.length,
    //   sumAmount: formatted.sumAmount,
    //   vatTotal: formatted.vatTotal,
    //   grandTotal: formatted.grandTotal
    // });

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
    const { buffer, fileName } = await InvoicePdfController.createReceiptOrTaxInvoicePdf(formatted);

    return res
      .type('application/pdf')
      .set('Content-Disposition', `attachment; filename="${fileName}"`)
      .send(buffer);

  } catch (err) {
    console.error('PDF Generate Error:', err);

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    if (err.name === 'CastError') {
      return res.status(400).json({
        success: false,
        error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    if (err.message?.includes('PDF')) {
      return res.status(500).json({
        success: false,
        error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF'
      });
    }

    next(err);
  }
};

/**
 * POST /api/receipt
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (RECEIPT) ‡∏´‡∏£‡∏∑‡∏≠ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (TAX_INVOICE)
 */
exports.create = async (req, res, next) => {
  try {
    const rawPayload = req.body;

    // Calculate idempotency key for duplicate prevention
    const summary = rawPayload.summary || {};
    const branchCode = rawPayload.branchCode || '00000';
    const customerKey = (rawPayload.customer?.taxId || rawPayload.customer?.tax_id || rawPayload.customer?.phone || '').toString().replace(/\s+/g, '');
    const subtotal = Number(summary.subtotal ?? rawPayload.downPaymentAmount ?? 0);
    const docFee = Number(summary.docFee ?? rawPayload.documentFee ?? 0);
    const totalWithTax = Number(summary.totalWithTax ?? (subtotal + docFee));
    const stableIdemKey = [
      'installment',
      branchCode,
      rawPayload.contractNo || 'N/A',
      customerKey || 'N/A',
      totalWithTax.toFixed(2),
      docFee.toFixed(2),
      subtotal.toFixed(2)
    ].join('|');

    // Check for existing receipts (idempotency)
    const InvoiceReceipt = require('../../models/Installment/InvoiceReceipt');
    const incomingKey = rawPayload.idempotencyKey;
    let existingReceipt = null;

    if (incomingKey) {
      existingReceipt = await InvoiceReceipt.findOne({ idempotencyKey: incomingKey });
    }
    if (!existingReceipt) {
      existingReceipt = await InvoiceReceipt.findOne({ idempotencyKey: stableIdemKey });
    }
    if (!existingReceipt && rawPayload.contractNo) {
      existingReceipt = await InvoiceReceipt.findOne({ contractNo: rawPayload.contractNo }).sort({ createdAt: -1 });
    }
    if (!existingReceipt && rawPayload.receiptNumber) {
      existingReceipt = await InvoiceReceipt.findOne({ receiptNumber: rawPayload.receiptNumber });
    }

    if (existingReceipt) {
      return res.status(200).json({
        success: true,
        message: 'Receipt already exists (idempotent)',
        data: existingReceipt
      });
    }

    // Set idempotencyKey in payload
    rawPayload.idempotencyKey = incomingKey || stableIdemKey;

    // Validation ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    if (!rawPayload.items || !Array.isArray(rawPayload.items) || rawPayload.items.length === 0) {
      return res.status(400).json({
        success: false,
        error: '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
      });
    }

    // Map items ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    rawPayload.items = rawPayload.items.map(i => ({
      ...i,
      product: i.product_id || i.product,
      amount: i.amount || ensureNumberData(i.downAmount)
    }));

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö paymentMethod
    rawPayload.paymentMethod = rawPayload.paymentMethod || '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';

    // ‡πÄ‡∏Å‡πá‡∏ö userId ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
    if (req.user && req.user.id) {
      rawPayload.userId = req.user.id;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
    const salespersonInfo = await getSalespersonInfo(
      req.user?.id,
      rawPayload.salespersonName,
      rawPayload.salespersonSignatureUrl
    );

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
    rawPayload.salespersonName = salespersonInfo.name;
    rawPayload.salespersonSignatureUrl = salespersonInfo.signatureUrl;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á receiptNumber
    const receiptNumber = await generateReceiptNumber();
    rawPayload.receiptNumber = receiptNumber;

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const receipt = new InvoiceReceipt(rawPayload);
    const saved = await receipt.save();

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let customerRecord = null;
    if (rawPayload.customer && (rawPayload.customer.individual || rawPayload.customer.customerType === 'individual')) {
      try {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î receiptType ‡∏ï‡∏≤‡∏° planType
        let receiptType = 'installment_ongoing'; // default
        if (rawPayload.planType === 'plan3') {
          receiptType = 'installment_pickup';
        } else if (rawPayload.type === 'PAYOFF_RECEIPT') {
          receiptType = 'installment_ongoing';
        }

        customerRecord = await recordReceiptCustomer(rawPayload.customer, saved, req.user?.id, receiptType);
        // console.log('‚úÖ Customer record saved for receipt:', customerRecord._id);
      } catch (customerError) {
        console.error('‚ùå Customer recording failed for receipt:', customerError);
        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
      }
    }

    return res.status(201).json({
      success: true,
      data: saved,
      customerInfo: customerRecord ? {
        customerId: customerRecord._id,
        isNewCustomer: customerRecord.statistics.isNewCustomer
      } : null
    });

  } catch (err) {
    console.error('Error in create InvoiceReceipt:', err);

    if (err.name === 'ValidationError') {
      const fieldErrors = Object.keys(err.errors).map(field => ({
        field,
        message: err.errors[field].message
      }));

      return res.status(400).json({
        success: false,
        error: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
        details: fieldErrors
      });
    }

    if (err.code === 11000 && err.keyPattern?.receiptNumber) {
      return res.status(400).json({
        success: false,
        error: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (receiptNumber) ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
      });
    }

    next(err);
  }
};

/**
 * POST /api/receipt/:quotationId/invoice
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (TAX_INVOICE) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Quotation
 */
exports.createFromQuotation = async (req, res, next) => {
  try {
    const Quotation = require('../models/Installment/Quotation');
    const { quotationId } = req.params;
    const {
      shippingFee = 0,
      docFee = 0,
      discount = 0,
      planSummaryText = '',
      paymentMethod = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'   // default ‡πÄ‡∏õ‡πá‡∏ô '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
    } = req.body;

    if (!mongoose.Types.ObjectId.isValid(quotationId)) {
      return res.status(400).json({
        success: false,
        error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Quotation ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    const quotation = await Quotation.findById(quotationId).lean()
      .populate('items.product', 'name')
      .lean();

    if (!quotation) {
      return res.status(404).json({
        success: false,
        error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'
      });
    }

    if (!quotation.items || !Array.isArray(quotation.items) || quotation.items.length === 0) {
      return res.status(400).json({
        success: false,
        error: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
      });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á receiptNumber ‡πÉ‡∏´‡∏°‡πà
    const receiptNumber = await generateReceiptNumber();

    // ‡πÅ‡∏õ‡∏•‡∏á items ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì amount
    const items = quotation.items.map(it => {
      const downAmount = ensureNumberData(it.downAmount, 0);
      const installmentAmount = ensureNumberData(it.installmentAmount, 0);
      const termCount = ensureNumberData(it.termCount, 0);
      const amount = downAmount;

      return {
        product: it.product._id,
        description: it.product.name,
        imei: it.imei || '',
        quantity: ensureNumberData(it.quantity, 1),
        unitPrice: ensureNumberData(it.unitPrice, 0),
        discount: ensureNumberData(it.discount, 0),
        downAmount,
        termCount,
        installmentAmount,
        amount,
        taxRate: quotation.summary?.taxRate || DEFAULT_TAX_RATE,
        taxType: validateTaxType(quotation.summary?.taxType)
      };
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö getPdf()
    const subtotal = items.reduce((sum, i) => sum + (i.quantity * i.unitPrice), 0);
    const totalDisc = items.reduce((sum, i) => sum + (i.discount || 0), 0);

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì taxVal ‡πÄ‡∏î‡∏¥‡∏°
    let vatTotal = 0;
    const taxType = validateTaxType(quotation.summary?.taxType);
    const taxRate = quotation.summary?.taxRate || DEFAULT_TAX_RATE;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏ï‡∏≤‡∏° taxType
    let sumAmount = 0; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
    items.forEach(item => {
      item.taxType = taxType; // ‡πÉ‡∏ä‡πâ taxType ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö
      sumAmount += item.amount; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î amount

      if (item.taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå') {
        const vatDown = item.downAmount * item.taxRate / (100 + item.taxRate);
        vatTotal += vatDown;
      } else if (item.taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î') {
        const totalInst = item.installmentAmount * item.termCount;
        const vatInst = totalInst * item.taxRate / (100 + item.taxRate);
        vatTotal += vatInst;
      } else if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
        vatTotal += item.amount * item.taxRate / 100;
      } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
        const vatIncluded = item.amount * item.taxRate / (100 + item.taxRate);
        vatTotal += vatIncluded;
      }
    });

    vatTotal = Math.round(vatTotal * 100) / 100;

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì netTotal ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö taxType
    let netTotalCalc;
    if (taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ: ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° + VAT + ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° - ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
      netTotalCalc = sumAmount + vatTotal + ensureNumberData(docFee) + ensureNumberData(shippingFee) - ensureNumberData(discount);
    } else if (taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ' || taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå' || taxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î') {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ: VAT ‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß
      netTotalCalc = sumAmount + ensureNumberData(docFee) + ensureNumberData(shippingFee) - ensureNumberData(discount);
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ VAT
      netTotalCalc = sumAmount + ensureNumberData(docFee) + ensureNumberData(shippingFee) - ensureNumberData(discount);
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì beforeTax ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const beforeTaxCalc = netTotalCalc - vatTotal;

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
    const salespersonInfo = await getSalespersonInfo(req.user?.id);

    // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö payload
    const invoicePayload = {
      receiptNumber,
      type: 'TAX_INVOICE',
      date: new Date(),
      branchCode: quotation.branchCode || '',
      pickupMethod: quotation.pickupMethod || '',
      customer: quotation.customer,
      items,
      docFee: ensureNumberData(docFee),
      shippingFee: ensureNumberData(shippingFee),
      planSummaryText,

      // **‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç** ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ paymentMethod ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å req.body ‡∏°‡∏≤‡πÉ‡∏™‡πà
      paymentMethod: paymentMethod,

      summary: {
        financedTotal: items.reduce((sum, i) => sum + (i.installmentAmount * i.termCount), 0),
        downTotal: items.reduce((sum, i) => sum + (i.downAmount || 0), 0),
        subtotal,
        discount: ensureNumberData(discount),
        beforeTax: beforeTaxCalc,
        tax: vatTotal,
        netTotal: netTotalCalc
      },
      salespersonName: salespersonInfo.name,
      salespersonSignatureUrl: salespersonInfo.signatureUrl
    };

    const invoice = new InvoiceReceipt(invoicePayload);
    const saved = await invoice.save();
    return res.status(201).json({ success: true, data: saved });

  } catch (err) {
    console.error('Error creating invoice from quotation:', err);

    if (err.name === 'ValidationError') {
      return res.status(400).json({
        success: false,
        error: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô',
        details: Object.keys(err.errors).map(field => ({
          field,
          message: err.errors[field].message
        }))
      });
    }

    if (err.code === 11000 && err.keyPattern?.receiptNumber) {
      return res.status(400).json({
        success: false,
        error: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (receiptNumber) ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
      });
    }

    next(err);
  }
};

/**
 * DELETE /api/receipt/:id
 * ‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ _id
 */
exports.remove = async (req, res, next) => {
  try {
    const { id } = req.params;

    if (!mongoose.Types.ObjectId.isValid(id)) {
      return res.status(400).json({
        success: false,
        error: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    const result = await InvoiceReceipt.findByIdAndDelete(id);
    if (!result) {
      return res.status(404).json({
        success: false,
        error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö'
      });
    }

    return res.json({
      success: true,
      message: '‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      deletedId: id
    });
  } catch (err) {
    console.error('Error deleting receipt:', err);
    next(err);
  }
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
async function findOrCreateCustomer(customerData, userId) {
  let customer = null;

  // ‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ taxId ‡∏Å‡πà‡∏≠‡∏ô
  if (customerData.individual?.taxId) {
    customer = await Customer.findOne({
      'individual.taxId': customerData.individual.taxId,
      deleted_at: null
    });
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
  if (!customer && customerData.individual?.phone) {
    customer = await Customer.findOne({
      'individual.phone': customerData.individual.phone,
      deleted_at: null
    });
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  if (!customer) {
    const newCustomerData = {
      ...customerData,
      createdBy: userId
    };
    customer = new Customer(newCustomerData);
    await customer.save();
  }

  return customer;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
async function recordReceiptCustomer(customerData, receiptData, userId, receiptType = 'installment_ongoing') {
  try {
    let customer = await findOrCreateCustomer(customerData, userId);

    const purchaseRecord = {
      type: receiptType,
      orderId: receiptData._id,
      orderModel: 'InvoiceReceipt',
      purchaseDate: new Date(),
      amount: receiptData.summary?.netTotal || receiptData.netTotal || 0,
      branchCode: receiptData.branchCode,
      contractNo: receiptData.receiptNumber,
      planType: receiptData.planType,
      saleDetails: {
        pickupMethod: receiptData.pickupMethod || 'store',
        deliveryStatus: receiptType === 'installment_pickup' ? 'pending' : 'delivered',
        usageStatus: receiptType === 'installment_ongoing' ? 'active' : 'completed',
        completionDate: receiptType === 'installment_pickup' ? null : new Date()
      },
      items: (receiptData.items || []).map(item => ({
        productId: item.product,
        name: item.description || item.name,
        imei: item.imei || '',
        qty: item.quantity,
        unitPrice: item.unitPrice,
        totalPrice: item.amount,
        downPayment: item.downAmount || 0,
        installmentAmount: item.installmentAmount || 0,
        installmentTerms: item.termCount || 0
      }))
    };

    customer.addPurchaseHistory(purchaseRecord);
    await customer.save();
    return customer;
  } catch (error) {
    console.error('Error recording receipt customer:', error);
    throw error;
  }
}

// Export functions for use in other controllers
exports.generateReceiptNumber = generateReceiptNumber;
exports.generateTaxInvoiceNumber = generateTaxInvoiceNumber;
exports.generateInvoiceNumber = generateInvoiceNumber;
