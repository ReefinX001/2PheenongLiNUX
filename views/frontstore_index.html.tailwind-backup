<!DOCTYPE html>
<html lang="th" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (Luxury UI)</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Google Font (Prompt + Inter for luxury) -->
  <link rel="preconnect" href="https://fonts.googleapis.com/" crossorigin />
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Prompt', 'sans-serif'],
            prompt: ['Prompt', 'sans-serif'],
          },
          boxShadow: {
            'lux': '0 8px 32px 0 rgba(31, 38, 135, 0.18)'
          }
        },
      },
      daisyui: {
        themes: ["luxury", "dark", "corporate"],
      },
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    body {
      background: linear-gradient(125deg, #eef2f7 0%, #e0e7ef 60%, #f2f8fc 100%);
      font-family: 'Inter', 'Prompt', sans-serif;
      min-height: 100vh;
    }
    .lux-shadow {
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    }
    .lux-glass {
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
    }
    .card-hover {
      transition: transform 0.3s cubic-bezier(.4,2.3,.3,1), box-shadow 0.35s;
      border-radius: 16px;
    }
    .card-hover:hover {
      transform: scale(1.03) translateY(-4px);
      box-shadow: 0 16px 32px 0 rgba(31,38,135,0.17), 0 1.5px 4px 0 rgba(0,0,0,0.05);
      border: 1.5px solid #3b82f6;
      background: linear-gradient(120deg,#f0f6ff 80%,#e6edf7 100%);
    }
    #searchBranch {
      border-radius: 10px;
      border: none;
      background: rgba(245,247,251,0.7);
      padding: 12px 18px;
      font-size: 1.08rem;
      box-shadow: 0 2px 10px 0 rgba(31,38,135,0.04);
      transition: box-shadow 0.22s, border-color 0.3s;
    }
    #searchBranch:focus {
      outline: none;
      box-shadow: 0 4px 16px 0 #3b82f66a;
      border: 1px solid #3b82f6;
      background: rgba(255,255,255,0.82);
    }
    .branch-banner {
      height: 84px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1.5px solid #e6eaf0;
      border-radius: 16px 16px 0 0;
      position: relative;
    }
    .banner-main { background: linear-gradient(93deg,#3B82F6 60%,#2563EB 100%);}
    .banner-south { background: linear-gradient(90deg,#10B981 60%,#059669 100%);}
    .banner-north { background: linear-gradient(90deg,#F59E0B 60%,#D97706 100%);}
    .banner-northeast { background: linear-gradient(90deg,#8B5CF6 60%,#7C3AED 100%);}
    .badge-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: .75;}
      50%{ opacity: 1;}
      100%{ opacity: .75;}
    }
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(125deg,rgba(31,41,55,.85),rgba(59,130,246,.5));
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(8px);
    }
    /* Navbar Glassmorphism */
    .navbar-glass {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(18px);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.12);
      border-bottom: 1.5px solid #dbeafe;
    }
    /* Footer */
    footer {
      background: linear-gradient(90deg,#22223b 0%,#3a415c 100%);
      color: #e0e7ef;
      padding: 24px 0 10px 0;
      width: 100%;
      font-size: 1.02rem;
      box-shadow: 0 -5px 20px 0 rgba(0,0,0,0.07);
      margin-top: 40px;
    }
    /* Remove Back to Top btn styles */
    #backToTop {
      position: fixed;
      bottom: 26px;
      right: 26px;
      display: none;
      z-index: 1001;
      border-radius: 9999px;
      background: linear-gradient(90deg,#3b82f6,#2563eb);
      color: white;
      box-shadow: 0 8px 20px 0 rgba(59,130,246,0.17);
    }
    #backToTop:hover {
      transform: translateY(-4px) scale(1.11);
      background: linear-gradient(90deg,#2563eb,#3b82f6);
    }
    /* Button */
    .btn {
      border-radius: 999px !important;
      font-weight: 500;
      letter-spacing: .04em;
    }
    /* Animations for fadein cards */
    .fadein-delay { opacity: 0; animation: fadeinMove .8s cubic-bezier(.4,1.7,.4,1) forwards; }
    @keyframes fadeinMove {
      from { opacity:0; transform: translateY(18px);}
      to { opacity:1; transform: translateY(0);}
    }
    /* Luxury scrollbar */
    ::-webkit-scrollbar { width: 12px; background: #f1f5fa;}
    ::-webkit-scrollbar-thumb { background: #dbeafe; border-radius: 8px;}
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-white min-h-screen">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center text-white">
      <div class="loading loading-spinner loading-lg mb-4"></div>
      <div class="text-xl font-semibold mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...</div>
      <div class="opacity-80 text-lg">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-glass shadow mb-7 sticky top-0 z-20 animate__animated animate__fadeInDown">
    <div class="max-w-7xl mx-auto w-full px-4 flex justify-between items-center h-18 py-2">
      <!-- Logo + System Name -->
      <div class="flex items-center space-x-3">
        <div class="h-12 w-12 rounded-xl banner-main flex items-center justify-center text-white lux-shadow">
          <i class="bi bi-shop text-3xl"></i>
        </div>
        <div>
          <h1 class="font-extrabold text-xl tracking-wide text-gray-800 dark:text-white drop-shadow">POS System</h1>
          <p class="text-xs text-blue-700 dark:text-blue-200 font-medium tracking-wide">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
        </div>
      </div>
      <!-- Right: Darkmode/Logout -->
      <div class="flex items-center space-x-3" id="navRight">
        <button id="btnToggleDarkMode" class="btn btn-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 border-none normal-case transition-colors" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏á/‡∏°‡∏∑‡∏î">
          <i class="bi bi-moon-fill mr-1"></i> <span class="hidden sm:inline">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
        </button>
        <button id="btnLogout" class="btn btn-sm btn-outline btn-error normal-case hover:bg-red-50 dark:hover:bg-red-900 transition-colors">
          <i class="bi bi-box-arrow-right mr-1"></i> <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-2">
    <!-- User Info -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-7 gap-4">
      <div id="loggedInUser" class="lux-glass shadow lux-shadow p-4 rounded-xl flex-grow min-w-[260px] animate__animated animate__fadeIn">
        <div class="flex items-center gap-3">
          <i class="bi bi-person-circle text-blue-500 text-3xl"></i>
          <div>
            <div class="font-semibold text-lg">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢</div>
            <div class="text-base text-gray-500 dark:text-gray-300 user-email">...</div>
          </div>
        </div>
      </div>
      <div class="lux-glass shadow p-3 rounded-xl flex items-center min-w-[245px] animate__animated animate__fadeIn">
        <div class="tooltip tooltip-left" data-tip="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
          <div class="flex items-center gap-2 px-2">
            <i class="bi bi-calendar-check text-green-500"></i>
            <span id="currentDate" class="text-base font-medium"></span>
          </div>
        </div>
        <div class="divider divider-horizontal mx-0"></div>
        <div class="tooltip tooltip-left" data-tip="‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
          <div class="flex items-center gap-2 px-2">
            <i class="bi bi-clock text-blue-500"></i>
            <span id="currentTime" class="text-base font-medium"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Branch -->
    <div class="lux-glass shadow-md rounded-xl p-6 mb-7 animate__animated animate__fadeIn">
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i class="bi bi-search text-blue-500"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤
      </h3>
      <div class="form-control">
        <label class="input-group">
          <span class="bg-blue-500 text-white dark:bg-blue-700 rounded-l-lg px-3 text-lg">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="text"
            id="searchBranch"
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤..."
            class="input w-full dark:bg-gray-700 shadow-md"
            autofocus
          />
        </label>
      </div>
    </div>

    <!-- Branch Count -->
    <div class="mb-4 animate__animated animate__fadeIn">
      <p class="bg-gradient-to-r from-blue-100 via-blue-50 to-violet-50 dark:from-blue-900/30 dark:via-blue-800/40 dark:to-violet-900/10 px-6 py-2 rounded-full inline-flex items-center text-blue-700 dark:text-blue-200 font-semibold tracking-wide shadow">
        <i class="bi bi-shop mr-2"></i>
        ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á <span id="branchCount" class="font-bold mx-1">0</span> ‡∏™‡∏≤‡∏Ç‡∏≤
        <span class="badge badge-sm badge-primary ml-2 badge-pulse">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </p>
    </div>

    <!-- Branch Card Container -->
    <div class="lux-glass shadow-md rounded-2xl p-5">
      <h5 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i class="bi bi-shop text-blue-500"></i>
        <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
      </h5>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-7" id="branchContainer">
        <!-- Branch cards by JS -->
      </div>
      <!-- No branch found -->
      <div id="noBranchFound" class="p-10 rounded-xl text-center mt-6 bg-white/80 dark:bg-gray-700/70 shadow-lg hidden">
        <img src="/api/placeholder/200/200" alt="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" class="mx-auto mb-5 opacity-80" />
        <h3 class="text-2xl font-bold mb-2 text-gray-700 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        <button class="btn btn-primary normal-case gap-2" id="btnClearSearch">
          <i class="bi bi-arrow-counterclockwise"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-12">
    <div class="container mx-auto text-center">
      <p>¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.</p>
      <p class="text-sm mt-1"></p>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <button id="backToTop" class="btn btn-circle btn-primary shadow-lg transition-all duration-300 hover:scale-110" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô">
    <i class="bi bi-chevron-up text-lg"></i>
  </button>

  <!-- JavaScript -->
  <script>
    let BRANCHES = [];
    // ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ - ‡πÉ‡∏ä‡πâ route ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô viewRoutes.js
    const FRONTSTORE_URL = '/frontstore_pattani';

    document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      updateDateTime();
      setInterval(updateDateTime, 1000);

      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        window.location.href = '/login';
        return;
      }
      try {
        const res = await fetch('/api/users/me', { headers: { 'Authorization': 'Bearer ' + token } });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error);

        const user = data.data;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ POS ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        const isPOSUser = user.role?.name?.toLowerCase() === 'pos' || 
                         user.role?.name?.toLowerCase() === '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô';
        
        if (isPOSUser && user.defaultBranches && user.defaultBranches.length > 0) {
          // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
          const defaultBranch = user.defaultBranches[0];
          const code = defaultBranch.branch_code || defaultBranch;
          const name = defaultBranch.name || 'Unknown Branch';
          const target = `${FRONTSTORE_URL}?branch=${encodeURIComponent(code)}&name=${encodeURIComponent(name)}`;
          console.log('üîÑ Auto-redirecting POS user to default branch:', code, '‚Üí', target);
          window.location.href = target;
          return;
        }

        // Load branches
        const brRes = await fetch('/api/branch', { headers: { 'Authorization': 'Bearer ' + token } });
        const brJson = await brRes.json();
        if (!brRes.ok || !brJson.success) throw new Error(brJson.error || 'Cannot load branches');
        BRANCHES = brJson.data;

        // User info
        document.querySelector('.user-email').textContent = user.username || user.email || 'Unknown User';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Role ‡πÉ‡∏´‡∏°‡πà
        let allowedCodes;
        
        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        console.log('üîç DEBUG: Full user data', user);
        console.log('üîç DEBUG: User role', user.role);
        console.log('üîç DEBUG: AllowedBranches', user.allowedBranches);
        console.log('üîç DEBUG: CheckinBranches', user.checkinBranches);
        console.log('üîç DEBUG: DefaultBranches', user.defaultBranches);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Super User - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        const userRole = user.role?.name?.toLowerCase() || '';
        const allowedPages = user.allowedPages || user.role?.allowedPages || [];
        
        const isSuperUser = userRole === 'super admin' || 
                           userRole === 'ceo' || 
                           userRole === '‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤' ||
                           allowedPages.includes('*');
        
        console.log('üîç DEBUG: User role:', userRole);
        console.log('üîç DEBUG: Allowed pages:', allowedPages);
        console.log('üîç DEBUG: Is Super User?', isSuperUser);
        
        if (isSuperUser) {
          // Super User ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          allowedCodes = BRANCHES.map(b => b.branch_code);
          console.log('‚úÖ Super User access - all branches allowed');
        } else {
          // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏ä‡πâ checkinBranches ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ)
          const userBranches = user.checkinBranches || user.allowedBranches || [];
          console.log('üîç DEBUG: User branches data', userBranches);
          
          if (userBranches.length === 0) {
            console.log('‚ö†Ô∏è WARNING: No branches found for user!');
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin role ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (fallback)
            if (userRole.includes('admin') || userRole === 'ceo') {
              console.log('üîß FALLBACK: User appears to be admin role, granting all access');
              allowedCodes = BRANCHES.map(b => b.branch_code);
            } else {
              allowedCodes = [];
            }
          } else {
            allowedCodes = userBranches.map(b => b.branch_code || b);
          }
        }
        
        console.log('üîç Branch access check:', {
          username: user.username,
          role: user.role?.name,
          isSuperUser,
          totalBranches: BRANCHES.length,
          allowedBranchesCount: allowedCodes.length,
          allowedCodes,
          userAllowedBranches: user.allowedBranches,
          userCheckinBranches: user.checkinBranches,
          userDefaultBranches: user.defaultBranches
        });
        
        document.getElementById('branchCount').textContent = allowedCodes.length;

        renderBranchCards(allowedCodes);

        document.getElementById('branchContainer').addEventListener('click', function(e) {
          const btn = e.target.closest('.branch-btn');
          if (!btn) return;
          const branchCode = btn.dataset.branchCode;
          const branchTitle = btn.dataset.branchTitle;
          goToBranch(branchCode, branchTitle);
        });

        document.getElementById('btnClearSearch').addEventListener('click', function() {
          document.getElementById('searchBranch').value = '';
          document.querySelectorAll('#branchContainer > div').forEach(card => { card.style.display = ''; });
          document.getElementById('noBranchFound').classList.add('hidden');
        });

        setTimeout(() => { showLoading(false); }, 600);
      } catch (err) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
        window.location.href = '/login';
      }
    });

    function renderBranchCards(allowedCodes) {
      const branchContainer = document.getElementById('branchContainer');
      branchContainer.innerHTML = '';

      // Sort branches: put main office ('00000') first
      const sortedBranches = BRANCHES.slice().sort((a, b) => {
        if (a.branch_code === '00000') return -1;
        if (b.branch_code === '00000') return 1;
        return 0;
      });

      sortedBranches.forEach((br, index) => {
        const isAllowed = allowedCodes.includes(br.branch_code);
        const disabledClass = isAllowed ? '' : 'opacity-60 cursor-not-allowed grayscale-[.6]';
        const animDelay = index * 0.08;
        let bannerClass = 'banner-south';
        if (br.region === 'north') bannerClass = 'banner-north';
        if (br.region === 'northeast') bannerClass = 'banner-northeast';
        if (br.branch_code === '00000') bannerClass = 'banner-main';

        const div = document.createElement('div');
        div.className = `card-hover lux-glass lux-shadow rounded-2xl overflow-hidden fadein-delay ${disabledClass}`;
        div.style.animationDelay = `${animDelay}s`;
        div.innerHTML = `
          <div class="relative">
            <div class="branch-banner ${bannerClass}">
              <i class="bi bi-building text-4xl text-white opacity-80 drop-shadow"></i>
            </div>
            ${br.branch_code === '00000' ? '<span class="absolute top-2 right-2 badge badge-info gap-1"><i class="bi bi-star-fill"></i> ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</span>' : ''}
          </div>
          <div class="p-6 pb-4">
            <h5 class="text-lg font-bold mb-2 text-gray-800 dark:text-white">${br.name}</h5>
            <p class="text-sm text-gray-500 dark:text-gray-300 mb-4">${br.address}</p>
            <button
              class="btn btn-md ${isAllowed ? 'btn-primary' : 'btn-outline btn-error'} mt-3 w-full branch-btn gap-2 font-semibold"
              data-branch-code="${br.branch_code}"
              data-branch-title="${br.name}"
              ${isAllowed ? '' : 'disabled'}
            >
              ${isAllowed ? '<i class="bi bi-box-arrow-in-right"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤' : '<i class="bi bi-lock-fill"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á'}
            </button>
          </div>
        `;
        branchContainer.appendChild(div);
        setTimeout(() => div.classList.add('animate__fadeInUp'), 30 + 80 * index);
      });
    }

    document.getElementById('searchBranch').addEventListener('input', function () {
      const search = this.value.toLowerCase();
      let found = false;
      document.querySelectorAll('#branchContainer > div').forEach(card => {
        const title = card.querySelector('h5').textContent.toLowerCase();
        const isVisible = title.includes(search);
        card.style.display = isVisible ? '' : 'none';
        if (isVisible) found = true;
      });
      document.getElementById('noBranchFound').classList.toggle('hidden', found || search === '');
    });

    function goToBranch(branchCode, branchTitle) {
      showLoading(true);
      
      // ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á branch code ‡πÅ‡∏•‡∏∞ name
      const targetUrl = `${FRONTSTORE_URL}?branch=${encodeURIComponent(branchCode)}&name=${encodeURIComponent(branchTitle)}`;
      
      document.querySelectorAll('.branch-btn').forEach(btn => btn.classList.remove('btn-success'));
      document.querySelector(`[data-branch-code="${branchCode}"]`).classList.add('btn-success');
      
      setTimeout(() => { 
        window.location.href = targetUrl; 
      }, 600);
    }

    document.getElementById('btnLogout').addEventListener('click', () => {
      showLoading(true);
      setTimeout(() => {
        localStorage.removeItem('authToken');
        window.location.href = '/login';
      }, 450);
    });

    document.getElementById('btnToggleDarkMode').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      updateDarkModeLabel();
    });
    function updateDarkModeLabel() {
      const isDark = document.documentElement.classList.contains('dark');
      document.getElementById('btnToggleDarkMode').innerHTML = isDark
        ? '<i class="bi bi-sun-fill mr-1"></i> <span class="hidden sm:inline">‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</span>'
        : '<i class="bi bi-moon-fill mr-1"></i> <span class="hidden sm:inline">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>';
    }

    function updateDateTime() {
      const now = new Date();
      const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('th-TH', dateOptions);
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('th-TH', timeOptions);
    }

    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');
      } else {
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // Back to Top button
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      backToTop.style.display = window.scrollY > 350 ? 'block' : 'none';
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    updateDarkModeLabel();
  </script>
</body>
</html>