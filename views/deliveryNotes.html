<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex, nofollow">
  <title>จัดการใบส่งของ - ระบบบัญชี</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(...args) {
      const message = args[0];
      if (message && typeof message === 'string') {
        if (message.includes('cdn.tailwindcss.com should not be used in production') ||
            message.includes('tailwindcss.com') ||
            message.includes('Tailwind CSS')) {
          return;
        }
      }
      originalWarn.apply(console, args);
    };

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <style>
    :root {
      --primary-color: #0d6efd;
      --primary-hover: #138af2;
      --bg-color: #ffffff;
      --text-color: #333333;
      --border-color: #e5e7eb;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(45deg, #5a6fd8, #6a42a0);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(45deg, #28a745, #20c997);
      border: none;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-success:hover {
      background: linear-gradient(45deg, #218838, #1ca085);
      transform: translateY(-2px);
    }

    .btn-outline-primary {
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-color: transparent;
      transform: translateY(-2px);
    }

    .btn-outline-secondary {
      border: 2px solid #6c757d;
      color: #6c757d;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
      background: #6c757d;
      transform: translateY(-2px);
    }

    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-pending {
      background: linear-gradient(45deg, #fff3cd, #ffeaa7);
      color: #856404;
    }

    .status-processing {
      background: linear-gradient(45deg, #cce7ff, #a8dadc);
      color: #004085;
    }

    .status-shipped {
      background: linear-gradient(45deg, #d4edda, #a8e6cf);
      color: #155724;
    }

    .status-delivered {
      background: linear-gradient(45deg, #d1ecf1, #81ecec);
      color: #0c5460;
    }

    .status-cancelled {
      background: linear-gradient(45deg, #f8d7da, #fab1a0);
      color: #721c24;
    }

    .table {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .table thead th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      font-weight: 600;
      padding: 1rem;
      font-size: 0.9rem;
    }

    .table tbody tr {
      transition: all 0.3s ease;
    }

    .table tbody tr:hover {
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      transform: scale(1.01);
    }

    .table tbody td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border: none;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border-radius: 20px 20px 0 0;
      padding: 1.5rem;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      background: rgba(255, 255, 255, 1);
    }

    .form-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: all 0.3s ease;
    }

    .loading-content {
      text-align: center;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .item-row {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .item-row:hover {
      border-color: #667eea;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
    }

    .btn-group .btn {
      margin: 0 0.125rem;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .toast {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 1rem;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .page-header {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .page-title {
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
    }

    .page-subtitle {
      color: #6b7280;
      font-size: 1.1rem;
      margin: 0.5rem 0 0 0;
    }

    /* DataTables Custom Styling */
    .dataTables_wrapper {
      background: transparent;
    }

    .dataTables_filter input {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.5rem 1rem;
    }

    .dataTables_length select {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.5rem;
    }

    .dataTables_paginate .paginate_button {
      border-radius: 8px;
      margin: 0 0.25rem;
    }

    .dataTables_paginate .paginate_button.current {
      background: linear-gradient(45deg, #667eea, #764ba2) !important;
      border-color: transparent !important;
      color: white !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-container {
        margin: 1rem;
        border-radius: 16px;
      }

      .page-title {
        font-size: 2rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .table {
        font-size: 0.875rem;
      }

      .modal-dialog {
        margin: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-content animate__animated animate__fadeIn">
      <div class="spinner"></div>
      <div class="text-lg font-semibold text-gray-700">กำลังโหลดข้อมูล...</div>
      <div class="text-sm text-gray-500 mt-2">โปรดรอสักครู่</div>
    </div>
  </div>

  <div class="container-fluid p-4">
    <div class="main-container p-6 animate__animated animate__fadeInUp">
      <!-- Page Header -->
      <div class="page-header">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
          <div>
            <h1 class="page-title">
              <i class="bi bi-truck mr-3"></i>
              จัดการใบส่งของ
            </h1>
            <p class="page-subtitle">ระบบจัดการใบส่งสินค้าและการจัดส่ง</p>
          </div>
          <div class="mt-4 lg:mt-0 flex flex-col sm:flex-row gap-3">
            <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise mr-2"></i>
              รีเฟรชข้อมูล
            </button>
            <button type="button" class="btn btn-success" onclick="openCreateModal()">
              <i class="bi bi-plus-circle mr-2"></i>
              สร้างใบส่งของใหม่
            </button>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="card mb-6 animate__animated animate__fadeInUp animate__delay-1s">
        <div class="card-body p-6">
          <h5 class="text-lg font-semibold text-gray-700 mb-4">
            <i class="bi bi-funnel mr-2"></i>
            ตัวกรองข้อมูล
          </h5>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            <div class="col-span-1 lg:col-span-2">
              <label class="form-label">ค้นหา</label>
              <input type="text" id="searchInput" class="form-control" placeholder="เลขที่เอกสาร, ชื่อลูกค้า...">
            </div>
            <div>
              <label class="form-label">สถานะ</label>
              <select id="statusFilter" class="form-select">
                <option value="">ทั้งหมด</option>
                <option value="pending">รอดำเนินการ</option>
                <option value="processing">กำลังจัดเตรียม</option>
                <option value="shipped">จัดส่งแล้ว</option>
                <option value="delivered">ส่งมอบแล้ว</option>
                <option value="cancelled">ยกเลิก</option>
              </select>
            </div>
            <div>
              <label class="form-label">วันที่เริ่มต้น</label>
              <input type="date" id="startDate" class="form-control">
            </div>
            <div>
              <label class="form-label">วันที่สิ้นสุด</label>
              <input type="date" id="endDate" class="form-control">
            </div>
            <div class="flex flex-col justify-end gap-2">
              <button type="button" class="btn btn-outline-primary" onclick="applyFilters()">
                <i class="bi bi-search mr-1"></i>
                ค้นหา
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                <i class="bi bi-x-circle mr-1"></i>
                ล้าง
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="card animate__animated animate__fadeInUp animate__delay-2s">
        <div class="card-body p-0">
          <div class="overflow-x-auto">
            <table id="deliveryNotesTable" class="table w-full">
              <thead>
                <tr>
                  <th class="text-left">เลขที่เอกสาร</th>
                  <th class="text-left">วันที่</th>
                  <th class="text-left">ลูกค้า</th>
                  <th class="text-center">จำนวนสินค้า</th>
                  <th class="text-left">ที่อยู่จัดส่ง</th>
                  <th class="text-center">สถานะ</th>
                  <th class="text-center">การดำเนินการ</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be loaded dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-xl font-semibold">
            <i class="bi bi-plus-circle mr-2"></i>
            <span id="modalTitle">สร้างใบส่งของใหม่</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="deliveryNoteForm">
            <input type="hidden" id="deliveryNoteId">

            <!-- Customer Information -->
            <div class="mb-6">
              <h6 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="bi bi-person mr-2"></i>
                ข้อมูลลูกค้า
              </h6>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="form-label">ชื่อลูกค้า *</label>
                  <input type="text" id="customerName" class="form-control" required>
                </div>
                <div>
                  <label class="form-label">เบอร์โทรศัพท์</label>
                  <input type="text" id="customerPhone" class="form-control">
                </div>
              </div>
            </div>

            <!-- Delivery Information -->
            <div class="mb-6">
              <h6 class="text-lg font-semibold text-gray-700 mb-4">
                <i class="bi bi-truck mr-2"></i>
                ข้อมูลการจัดส่ง
              </h6>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="form-label">วันที่จัดส่ง</label>
                  <input type="date" id="deliveryDate" class="form-control">
                </div>
                <div>
                  <label class="form-label">สถานะ</label>
                  <select id="deliveryStatus" class="form-select">
                    <option value="pending">รอดำเนินการ</option>
                    <option value="processing">กำลังจัดเตรียม</option>
                    <option value="shipped">จัดส่งแล้ว</option>
                    <option value="delivered">ส่งมอบแล้ว</option>
                  </select>
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label">ที่อยู่จัดส่ง *</label>
                <textarea id="deliveryAddress" class="form-control" rows="3" required placeholder="กรุณากรอกที่อยู่สำหรับจัดส่งสินค้า"></textarea>
              </div>
              <div>
                <label class="form-label">คำแนะนำพิเศษ</label>
                <textarea id="specialInstructions" class="form-control" rows="2" placeholder="กรุณาตรวจสอบสินค้าให้ครบถ้วนก่อนรับของ"></textarea>
              </div>
            </div>

            <!-- Items Section -->
            <div class="mb-6">
              <div class="flex items-center justify-between mb-4">
                <h6 class="text-lg font-semibold text-gray-700">
                  <i class="bi bi-box mr-2"></i>
                  รายการสินค้า
                </h6>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItem()">
                  <i class="bi bi-plus mr-1"></i>
                  เพิ่มสินค้า
                </button>
              </div>
              <div id="itemsContainer">
                <!-- Items will be added dynamically -->
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle mr-1"></i>
            ยกเลิก
          </button>
          <button type="button" class="btn btn-primary" onclick="saveDeliveryNote()">
            <i class="bi bi-save mr-1"></i>
            บันทึกข้อมูล
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-xl font-semibold">
            <i class="bi bi-eye mr-2"></i>
            รายละเอียดใบส่งของ
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalBody">
          <!-- Details will be loaded dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle mr-1"></i>
            ปิด
          </button>
          <button type="button" class="btn btn-primary" onclick="printDeliveryNote()">
            <i class="bi bi-printer mr-1"></i>
            พิมพ์ PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer">
    <!-- Toasts will be added dynamically -->
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    let deliveryNotesTable;
    let currentDeliveryNoteId = null;

    // Initialize page
    $(document).ready(function() {
      initializeDataTable();
      loadDeliveryNotes();
      addInitialItem();

      // Set default delivery date to today
      document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
    });

    // Initialize DataTable
    function initializeDataTable() {
      deliveryNotesTable = $('#deliveryNotesTable').DataTable({
        responsive: true,
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json'
        },
        order: [[1, 'desc']],
        columnDefs: [
          { orderable: false, targets: 6 },
          { className: 'text-center', targets: [3, 5, 6] }
        ],
        pageLength: 25,
        dom: '<"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4"<"mb-2 sm:mb-0"l><"mb-2 sm:mb-0"f>>rtip'
      });
    }

    // Load delivery notes data
    async function loadDeliveryNotes() {
      try {
        showLoading(true);

        const response = await fetch('/api/delivery-notes', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          populateTable(result.data);
        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
        }
      } catch (error) {
        console.error('Error loading delivery notes:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Populate table with data
    function populateTable(data) {
      deliveryNotesTable.clear();

      data.forEach(deliveryNote => {
        const formattedDate = new Date(deliveryNote.documentDate).toLocaleDateString('th-TH');
        const itemCount = deliveryNote.items ? deliveryNote.items.length : 0;
        const statusBadge = getStatusBadge(deliveryNote.deliveryStatus);
        const truncatedAddress = deliveryNote.deliveryInfo.address.length > 50 ?
          deliveryNote.deliveryInfo.address.substring(0, 50) + '...' :
          deliveryNote.deliveryInfo.address;

        const actions = `
          <div class="flex justify-center space-x-1">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewDeliveryNote('${deliveryNote._id}')" title="ดูรายละเอียด">
              <i class="bi bi-eye"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="editDeliveryNote('${deliveryNote._id}')" title="แก้ไข">
              <i class="bi bi-pencil"></i>
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="printDeliveryNote('${deliveryNote._id}')" title="พิมพ์ PDF">
              <i class="bi bi-printer"></i>
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteDeliveryNote('${deliveryNote._id}')" title="ลบ">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;

        deliveryNotesTable.row.add([
          deliveryNote.documentNumber,
          formattedDate,
          deliveryNote.customer.name,
          itemCount,
          truncatedAddress,
          statusBadge,
          actions
        ]);
      });

      deliveryNotesTable.draw();
    }

    // Get status badge HTML
    function getStatusBadge(status) {
      const statusMap = {
        'pending': { text: 'รอดำเนินการ', class: 'status-pending' },
        'processing': { text: 'กำลังจัดเตรียม', class: 'status-processing' },
        'shipped': { text: 'จัดส่งแล้ว', class: 'status-shipped' },
        'delivered': { text: 'ส่งมอบแล้ว', class: 'status-delivered' },
        'cancelled': { text: 'ยกเลิก', class: 'status-cancelled' }
      };

      const statusInfo = statusMap[status] || { text: status, class: 'status-pending' };
      return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    // Open create modal
    function openCreateModal() {
      resetForm();
      new bootstrap.Modal(document.getElementById('createModal')).show();
    }

    // Add initial item
    function addInitialItem() {
      const container = document.getElementById('itemsContainer');
      container.innerHTML = '';
      container.appendChild(createItemRow());
    }

    // Add new item row
    function addItem() {
      const container = document.getElementById('itemsContainer');
      const itemRow = createItemRow();
      container.appendChild(itemRow);

      // Add animation
      itemRow.classList.add('animate__animated', 'animate__fadeInUp');
    }

    // Create item row
    function createItemRow() {
      const div = document.createElement('div');
      div.className = 'item-row';
      div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
          <div class="lg:col-span-2">
            <label class="form-label">ชื่อสินค้า *</label>
            <input type="text" class="form-control item-name" required>
          </div>
          <div>
            <label class="form-label">จำนวน *</label>
            <input type="number" class="form-control item-quantity" min="1" value="1" required>
          </div>
          <div>
            <label class="form-label">ยี่ห้อ</label>
            <input type="text" class="form-control item-brand">
          </div>
          <div>
            <label class="form-label">IMEI/Serial</label>
            <input type="text" class="form-control item-imei">
          </div>
          <div class="flex items-end">
            <button type="button" class="btn btn-outline-danger btn-sm w-full" onclick="removeItem(this)">
              <i class="bi bi-trash mr-1"></i>
              ลบ
            </button>
          </div>
        </div>
      `;
      return div;
    }

    // Remove item row
    function removeItem(button) {
      const container = document.getElementById('itemsContainer');
      const itemRow = button.closest('.item-row');

      if (container.children.length > 1) {
        itemRow.classList.add('animate__animated', 'animate__fadeOutUp');
        setTimeout(() => {
          itemRow.remove();
        }, 300);
      } else {
        showToast('ต้องมีรายการสินค้าอย่างน้อย 1 รายการ', 'warning');
      }
    }

    // Save delivery note
    async function saveDeliveryNote() {
      try {
        const form = document.getElementById('deliveryNoteForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        showLoading(true);

        // Collect form data
        const deliveryNoteData = {
          customer: {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value
          },
          deliveryInfo: {
            address: document.getElementById('deliveryAddress').value,
            deliveryDate: document.getElementById('deliveryDate').value,
            specialInstructions: document.getElementById('specialInstructions').value
          },
          deliveryStatus: document.getElementById('deliveryStatus').value,
          items: []
        };

        // Collect items data
        document.querySelectorAll('.item-row').forEach(row => {
          const item = {
            name: row.querySelector('.item-name').value.trim(),
            quantity: parseInt(row.querySelector('.item-quantity').value),
            imei: row.querySelector('.item-imei').value.trim(),
            brand: row.querySelector('.item-brand').value.trim()
          };

          if (item.name) {
            deliveryNoteData.items.push(item);
          }
        });

        if (deliveryNoteData.items.length === 0) {
          showToast('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ', 'warning');
          return;
        }

        const deliveryNoteId = document.getElementById('deliveryNoteId').value;
        const isEdit = deliveryNoteId && deliveryNoteId.trim() !== '';

        const url = isEdit ? `/api/delivery-notes/${deliveryNoteId}` : '/api/delivery-notes';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify(deliveryNoteData)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          showToast(isEdit ? 'อัปเดตใบส่งของเรียบร้อยแล้ว' : 'สร้างใบส่งของเรียบร้อยแล้ว', 'success');
          bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
          loadDeliveryNotes();
          resetForm();
        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
        }
      } catch (error) {
        console.error('Error saving delivery note:', error);
        showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // View delivery note details
    async function viewDeliveryNote(id) {
      try {
        currentDeliveryNoteId = id;
        showLoading(true);

        const response = await fetch(`/api/delivery-notes/${id}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          displayDeliveryNoteDetails(result.data);
          new bootstrap.Modal(document.getElementById('viewModal')).show();
        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
        }
      } catch (error) {
        console.error('Error viewing delivery note:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Display delivery note details in modal
    function displayDeliveryNoteDetails(deliveryNote) {
      const formattedDate = new Date(deliveryNote.documentDate).toLocaleDateString('th-TH');
      const deliveryDate = deliveryNote.deliveryInfo.deliveryDate ?
        new Date(deliveryNote.deliveryInfo.deliveryDate).toLocaleDateString('th-TH') : 'ไม่ระบุ';

      let itemsHtml = '';
      if (deliveryNote.items && deliveryNote.items.length > 0) {
        itemsHtml = deliveryNote.items.map((item, index) => `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-center">${index + 1}</td>
            <td class="px-4 py-3">${item.name}</td>
            <td class="px-4 py-3 text-center">${item.quantity}</td>
            <td class="px-4 py-3">${item.brand || '-'}</td>
            <td class="px-4 py-3">${item.imei || '-'}</td>
          </tr>
        `).join('');
      } else {
        itemsHtml = '<tr><td colspan="5" class="text-center px-4 py-8 text-gray-500">ไม่มีรายการสินค้า</td></tr>';
      }

      const html = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
              <h6 class="text-lg font-semibold text-gray-700 mb-3">
                <i class="bi bi-file-text mr-2"></i>
                ข้อมูลเอกสาร
              </h6>
              <div class="space-y-2">
                <p><span class="font-semibold text-gray-600">เลขที่เอกสาร:</span> <span class="text-blue-600">${deliveryNote.documentNumber}</span></p>
                <p><span class="font-semibold text-gray-600">วันที่สร้าง:</span> ${formattedDate}</p>
                <p><span class="font-semibold text-gray-600">สถานะ:</span> ${getStatusBadge(deliveryNote.deliveryStatus)}</p>
              </div>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-teal-50 p-4 rounded-lg">
              <h6 class="text-lg font-semibold text-gray-700 mb-3">
                <i class="bi bi-person mr-2"></i>
                ข้อมูลลูกค้า
              </h6>
              <div class="space-y-2">
                <p><span class="font-semibold text-gray-600">ชื่อ:</span> ${deliveryNote.customer.name}</p>
                <p><span class="font-semibold text-gray-600">เบอร์โทร:</span> ${deliveryNote.customer.phone || '-'}</p>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg">
              <h6 class="text-lg font-semibold text-gray-700 mb-3">
                <i class="bi bi-truck mr-2"></i>
                ข้อมูลการจัดส่ง
              </h6>
              <div class="space-y-2">
                <p><span class="font-semibold text-gray-600">วันที่จัดส่ง:</span> ${deliveryDate}</p>
                <p><span class="font-semibold text-gray-600">ที่อยู่จัดส่ง:</span><br>
                  <span class="text-gray-700 bg-white p-2 rounded border">${deliveryNote.deliveryInfo.address}</span>
                </p>
                <p><span class="font-semibold text-gray-600">คำแนะนำพิเศษ:</span><br>
                  <span class="text-gray-700">${deliveryNote.deliveryInfo.specialInstructions || 'ไม่มี'}</span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h6 class="text-lg font-semibold text-gray-700 mb-4">
            <i class="bi bi-box mr-2"></i>
            รายการสินค้า
          </h6>
          <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="w-full">
              <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                <tr>
                  <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">#</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ชื่อสินค้า</th>
                  <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">จำนวน</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ยี่ห้อ</th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">IMEI/Serial</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                ${itemsHtml}
              </tbody>
            </table>
          </div>
        </div>
      `;

      document.getElementById('viewModalBody').innerHTML = html;
    }

    // Print delivery note
    function printDeliveryNote(id = null) {
      const deliveryNoteId = id || currentDeliveryNoteId;
      if (deliveryNoteId) {
        window.open(`/api/delivery-notes/${deliveryNoteId}/print`, '_blank');
      }
    }

    // Edit delivery note
    async function editDeliveryNote(id) {
      try {
        showLoading(true);

        const response = await fetch(`/api/delivery-notes/${id}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          populateEditForm(result.data);
          document.getElementById('modalTitle').textContent = 'แก้ไขใบส่งของ';
          new bootstrap.Modal(document.getElementById('createModal')).show();
        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
        }
      } catch (error) {
        console.error('Error loading delivery note for edit:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Populate edit form
    function populateEditForm(deliveryNote) {
      document.getElementById('deliveryNoteId').value = deliveryNote._id;
      document.getElementById('customerName').value = deliveryNote.customer.name;
      document.getElementById('customerPhone').value = deliveryNote.customer.phone || '';
      document.getElementById('deliveryAddress').value = deliveryNote.deliveryInfo.address;
      document.getElementById('deliveryStatus').value = deliveryNote.deliveryStatus;
      document.getElementById('specialInstructions').value = deliveryNote.deliveryInfo.specialInstructions || '';

      if (deliveryNote.deliveryInfo.deliveryDate) {
        document.getElementById('deliveryDate').value = new Date(deliveryNote.deliveryInfo.deliveryDate).toISOString().split('T')[0];
      }

      // Clear existing items
      const container = document.getElementById('itemsContainer');
      container.innerHTML = '';

      // Add items
      if (deliveryNote.items && deliveryNote.items.length > 0) {
        deliveryNote.items.forEach(item => {
          const itemRow = createItemRow();
          itemRow.querySelector('.item-name').value = item.name;
          itemRow.querySelector('.item-quantity').value = item.quantity;
          itemRow.querySelector('.item-imei').value = item.imei || '';
          itemRow.querySelector('.item-brand').value = item.brand || '';
          container.appendChild(itemRow);
        });
      } else {
        container.appendChild(createItemRow());
      }
    }

    // Delete delivery note
    async function deleteDeliveryNote(id) {
      const confirmed = await showConfirmDialog(
        'ยืนยันการลบ',
        'คุณแน่ใจหรือไม่ที่จะลบใบส่งของนี้? การดำเนินการนี้ไม่สามารถยกเลิกได้'
      );

      if (!confirmed) return;

      try {
        showLoading(true);

        const response = await fetch(`/api/delivery-notes/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          showToast('ลบใบส่งของเรียบร้อยแล้ว', 'success');
          loadDeliveryNotes();
        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการลบข้อมูล');
        }
      } catch (error) {
        console.error('Error deleting delivery note:', error);
        showToast('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    // Reset form
    function resetForm() {
      document.getElementById('deliveryNoteForm').reset();
      document.getElementById('deliveryNoteId').value = '';
      document.getElementById('modalTitle').textContent = 'สร้างใบส่งของใหม่';
      document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
      addInitialItem();
    }

    // Apply filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      deliveryNotesTable.columns().search('').draw();

      if (searchTerm) {
        deliveryNotesTable.search(searchTerm).draw();
      }

      if (statusFilter) {
        deliveryNotesTable.column(5).search(statusFilter).draw();
      }

      showToast('กรองข้อมูลเรียบร้อย', 'info');
    }

    // Clear filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      deliveryNotesTable.search('').columns().search('').draw();
      showToast('ล้างตัวกรองเรียบร้อย', 'info');
    }

    // Refresh data
    function refreshData() {
      loadDeliveryNotes();
      showToast('รีเฟรชข้อมูลเรียบร้อย', 'success');
    }

    // Show loading
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (show) {
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toastId = 'toast_' + Date.now();
      const toastClass = {
        'success': 'border-green-500 bg-green-50 text-green-800',
        'error': 'border-red-500 bg-red-50 text-red-800',
        'warning': 'border-yellow-500 bg-yellow-50 text-yellow-800',
        'info': 'border-blue-500 bg-blue-50 text-blue-800'
      }[type] || 'border-blue-500 bg-blue-50 text-blue-800';

      const iconClass = {
        'success': 'bi-check-circle-fill text-green-500',
        'error': 'bi-exclamation-triangle-fill text-red-500',
        'warning': 'bi-exclamation-triangle-fill text-yellow-500',
        'info': 'bi-info-circle-fill text-blue-500'
      }[type] || 'bi-info-circle-fill text-blue-500';

      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast border-l-4 ${toastClass} p-4 shadow-lg animate__animated animate__slideInRight`;
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="bi ${iconClass} mr-3 text-lg"></i>
          <div class="flex-1">${message}</div>
          <button type="button" class="ml-4 text-gray-400 hover:text-gray-600" onclick="removeToast('${toastId}')">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      setTimeout(() => {
        removeToast(toastId);
      }, 5000);
    }

    // Remove toast
    function removeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.classList.add('animate__slideOutRight');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }
    }

    // Show confirm dialog
    function showConfirmDialog(title, message) {
      return new Promise((resolve) => {
        const confirmed = confirm(`${title}\n\n${message}`);
        resolve(confirmed);
      });
    }

    // Reset form when modal is closed
    document.getElementById('createModal').addEventListener('hidden.bs.modal', function() {
      resetForm();
    });

    // Initialize search functionality
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  </script>
</body>

</html>