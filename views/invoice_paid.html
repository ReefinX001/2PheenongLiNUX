<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ใบแจ้งหนี้ทั้งหมด - ระบบบัญชี</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Google Font: Prompt -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CSS + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
    rel="stylesheet"
    type="text/css"
  />

  <!-- Bootstrap Icons (เฉพาะไอคอน) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- Socket.IO (โลคัลไฟล์) + Subresource Integrity (SRI) -->
  <script
    src="/socket.io.min.js"
    integrity="sha384-xWmNuOozkup5L7vb2ZFBg8dy0whlJd0gZAq3pvXuNa+5tSl/AjYqFNXN7kmjVTx2"
    crossorigin="anonymous"
  ></script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;'
    }
    /* กำหนดให้ container หลักเป็น max-width */
    .container-main {
      @apply max-w-5xl mx-auto px-4;
    }

    /* card-custom */
    .card-custom {
      @apply bg-white dark:bg-gray-800 rounded-lg shadow p-4 transition-transform;
    }
    .card-custom:hover {
      @apply -translate-y-1 shadow-lg;
    }

    /* Tabs using DaisyUI */
    .tab-active {
      @apply border-b-2 border-blue-500 text-blue-500 font-semibold;
    }
    .tab-badge {
      @apply text-xs inline-block ml-1 bg-gray-500 text-white rounded-full px-2;
    }

    /* Table styles */
    table {
      @apply w-full border border-gray-300 dark:border-gray-600 text-sm;
    }
    thead {
      @apply bg-gray-100 dark:bg-gray-700;
    }
    th, td {
      @apply px-2 py-2 border border-gray-200 dark:border-gray-600;
    }
    tbody tr:hover {
      @apply bg-gray-50 dark:bg-gray-800;
    }

    /* Footer style */
    footer {
      @apply mt-6 text-center bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 py-3;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

  <!-- สคริปต์ตรวจสอบ Token ก่อนเข้าหน้า -->
  <script>
    (function checkToken() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('กรุณาเข้าสู่ระบบก่อน');
        window.location.href = '/login'; // เปลี่ยนเป็นหน้า login ของคุณ'
      }
    })();
  </script>

  <!-- Header Navbar -->
  <div class="w-full bg-white dark:bg-gray-800 shadow mb-4">
    <div class="container-main py-3 flex items-center justify-between">
      <a href="accounting_dashboard.html" class="btn btn-sm btn-ghost">
        <i class="bi bi-arrow-left mr-1"></i> กลับหน้า Dashboard
      </a>
      <h2 class="text-xl font-bold hidden md:block">
        ใบแจ้งหนี้ทั้งหมด
      </h2>
    </div>
  </div>

  <!-- Container หลัก -->
  <div class="container-main">
    <!-- Tabs (Tailwind + DaisyUI) -->
    <div class="tabs mb-4 border-b border-gray-300 dark:border-gray-700">
      <a class="tab tab-bordered tab-active" data-status="all">ทั้งหมด</a>
      <a class="tab tab-bordered" data-status="draft">ร่าง</a>
      <a class="tab tab-bordered" data-status="pending_approval">
        รออนุมัติ <span class="tab-badge" id="badge-pending_approval">0</span>
      </a>
      <a class="tab tab-bordered" data-status="pending_payment">
        รอรับชำระ <span class="tab-badge" id="badge-pending_payment">0</span>
      </a>
      <a class="tab tab-bordered" data-status="overdue">
        เกินเวลารับชำระ <span class="tab-badge" id="badge-overdue">1</span>
      </a>
      <a class="tab tab-bordered" data-status="paid">
        รับชำระแล้ว <span class="tab-badge" id="badge-paid">0</span>
      </a>
      <a class="tab tab-bordered" data-status="trash">ถังขยะ</a>
      <a class="tab tab-bordered" data-status="monthly">เอกสารรายเดือน</a>
    </div>

    <!-- Card for Table -->
    <div class="card-custom">
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>เลขที่ใบแจ้งหนี้</th>
              <th>ยอดรวม</th>
              <th>วันที่ออกบิล</th>
              <th>วันครบกำหนด</th>
              <th>สถานะ</th>
              <th>ตัวเลือก</th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody">
            <!-- Render ด้วย JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <small>© 2025 ระบบบัญชี. สงวนลิขสิทธิ์.</small>
  </footer>

  <!-- Script เชื่อมต่อ Socket.IO -->
  <script>
    const socket = io();
    socket.on('connect', () => {'
      console.log('Socket.IO connected (InvoiceAll Page).');'
    });
    socket.on('disconnect', () => {'
      console.warn('Socket.IO disconnected.');
    });
    // ตัวอย่าง event
    socket.on('invoiceUpdate', (payload) => {'
      console.log('Realtime Invoice update:', payload);
      // ถ้าต้องการ reload:
      // loadInvoices(currentStatus);
    });
  </script>

  <script>
    let currentStatus = 'all';'

    document.addEventListener('DOMContentLoaded', () => {'
      setupTabs();
      loadInvoices('all');'
    });

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab[data-status]');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {'
          // เอา active ออกจากทุก tab
          tabs.forEach(t => t.classList.remove('tab-active'));'
          // ใส่ active ให้ tab ที่คลิก
          tab.classList.add('tab-active');
          const status = tab.getAttribute('data-status');
          currentStatus = status;
          loadInvoices(status);
        });
      });
    }

    async function loadInvoices(status) {
      try {
        const res = await fetch('/api/invoice?status=' + status);
        const data = await res.json();
        if (!res.ok || !data.success) {''
          throw new Error(data.error || 'ไม่สามารถโหลดข้อมูลใบแจ้งหนี้ได้');'
        }
        renderInvoices(data.data);
        updateBadges(data.counts || {});
      } catch (err) {
        console.error(err);
        alert('เกิดข้อผิดพลาดในการโหลดข้อมูลใบแจ้งหนี้');'
      }
    }

    function renderInvoices(invoices) {
      const tbody = document.getElementById('invoiceTableBody');
      tbody.innerHTML = '';'
      invoices.forEach(inv => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${inv._id}</td>
          <td>${inv.invoice_number || '-'}</td>'
          <td>${(inv.total_amount || 0).toLocaleString()} บาท</td>
          <td>${inv.billing_date ? new Date(inv.billing_date).toLocaleDateString('th-TH') : '-'}</td>'
          <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString('th-TH') : '-'}</td>'
          <td>${inv.status || 'Draft'}</td>'
          <td>
            <button
              class="btn btn-sm btn-outline btn-warning mr-2"
              onclick="editInvoice('${inv._id}')"
            >
              <i class="bi bi-pencil-square"></i>
            </button>
            <button
              class="btn btn-sm btn-outline btn-error"
              onclick="deleteInvoice('${inv._id}')"
            >
              <i class="bi bi-trash3"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateBadges(counts) {
      // counts เช่น { pending_approval: 0, pending_payment: 0, overdue: 1, paid: 0, ... }
      for (const key in counts) {
        const badgeEl = document.getElementById('badge-' + key);
        if (badgeEl) {
          badgeEl.textContent = counts[key];
        }
      }
    }

    async function editInvoice(id) {
      const newStatus = prompt('ใส่สถานะใหม่ (เช่น unpaid/paid/canceled):');
      if (!newStatus) return;
      try {
        const res = await fetch(`/api/invoice/${id}`, {
          method: 'PATCH','
          headers: { 'Content-Type': 'application/json' },'
          body: JSON.stringify({ status: newStatus })
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Update failed');'
        alert('อัปเดตใบแจ้งหนี้เรียบร้อย');'
        loadInvoices(currentStatus);
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);'
      }
    }

    async function deleteInvoice(id) {
      if (!confirm('คุณต้องการลบใบแจ้งหนี้นี้หรือไม่?')) return;'
      try {
        const res = await fetch(`/api/invoice/${id}`, { method: 'DELETE' });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Delete failed');'
        alert('ลบใบแจ้งหนี้เรียบร้อย');'
        loadInvoices(currentStatus);
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);'
      }
    }
  </script>
</body>
</html>
