<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายละเอียดโบนัสสะสม - HR System</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-gray-50 font-sans">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i class="bi bi-arrow-left text-xl text-gray-600"></i>
          </button>
          <!-- Employee Info -->
          <div class="flex items-center space-x-3">
            <img id="employeePhoto" src="/uploads/employees/default-avatar.png?v=2" alt="Employee Photo"
                 class="w-12 h-12 rounded-full object-cover border-2 border-blue-200"
                 onerror="this.src='/uploads/employees/default-avatar.png?v=2'">
            <div>
              <h1 class="text-xl font-semibold text-gray-800">รายละเอียดโบนัสสะสม</h1>
              <div class="flex items-center space-x-3 text-sm text-gray-500">
                <span id="employeeName">กำลังโหลด...</span>
                <span>•</span>
                <span id="employeePosition">ตำแหน่ง</span>
                <span>•</span>
                <span id="employeeDepartment">แผนก</span>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-500" id="currentDate"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
      <span class="ml-3 text-gray-600">กำลังโหลดข้อมูล...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="container mx-auto px-4 py-6 hidden">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Total Bonus -->
      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-100 text-sm">โบนัสสะสมทั้งหมด</p>
            <p class="text-2xl font-bold" id="totalBonus">0 บาท</p>
          </div>
          <div class="w-12 h-12 bg-green-400 rounded-full flex items-center justify-center">
            <i class="bi bi-wallet2 text-xl"></i>
          </div>
        </div>
      </div>

      <!-- This Month -->
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100 text-sm">โบนัสเดือนนี้</p>
            <p class="text-2xl font-bold" id="monthlyBonus">0 บาท</p>
          </div>
          <div class="w-12 h-12 bg-blue-400 rounded-full flex items-center justify-center">
            <i class="bi bi-calendar-month text-xl"></i>
          </div>
        </div>
      </div>

      <!-- Total Transactions -->
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-100 text-sm">จำนวนรายการ</p>
            <p class="text-2xl font-bold" id="totalTransactions">0 รายการ</p>
          </div>
          <div class="w-12 h-12 bg-purple-400 rounded-full flex items-center justify-center">
            <i class="bi bi-list-check text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-48">
          <label class="block text-sm font-medium text-gray-700 mb-2">ช่วงเวลา</label>
          <select id="periodFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <option value="all">ทั้งหมด</option>
            <option value="thisMonth">เดือนนี้</option>
            <option value="lastMonth">เดือนที่แล้ว</option>
            <option value="thisYear">ปีนี้</option>
          </select>
        </div>
        <div class="flex-1 min-w-48">
          <label class="block text-sm font-medium text-gray-700 mb-2">ประเภท</label>
          <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <option value="all">ทั้งหมด</option>
            <option value="sales">โบนัสยอดขาย</option>
            <option value="performance">โบนัสผลงาน</option>
            <option value="commission">ค่าคอมมิชชัน</option>
            <option value="special">โบนัสพิเศษ</option>
          </select>
        </div>
        <div class="flex items-end">
          <button onclick="applyFilters()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
            <i class="bi bi-funnel mr-2"></i>กรองข้อมูล
          </button>
        </div>
      </div>
    </div>

    <!-- Bonus History Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">ประวัติโบนัส</h3>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รายละเอียด</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนเงิน</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
            </tr>
          </thead>
          <tbody id="bonusTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="text-center py-12 hidden">
        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
          <i class="bi bi-inbox text-2xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">ไม่มีข้อมูลโบนัส</h3>
        <p class="text-gray-500">ยังไม่มีรายการโบนัสในช่วงเวลาที่เลือก</p>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // API Configuration - Detect environment and use appropriate API URL
    let API_BASE_URL = 'http://localhost:3000';
    
    // Check if we're running on production domain
    if (window.location.hostname === 'www.2pheenong.com' || window.location.hostname === '2pheenong.com') {
      API_BASE_URL = 'https://www.2pheenong.com';
      console.log('Production environment detected');
    } else if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      // For other domains, use the current origin
      API_BASE_URL = window.location.origin;
      console.log('Using current origin as API base:', API_BASE_URL);
    }
    
    console.log('API_BASE_URL set to:', API_BASE_URL);

    // Global HR Data Storage
    let hrData = {
      employee: null,
      bonuses: [],
      totalBonus: 0,
      monthlyBonus: 0,
      totalTransactions: 0
    };

    // Authentication helpers
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    function handleAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userName');
        console.warn('Auth cleared - staying on page for debugging');
        return true;
      }
      return false;
    }

    // Get current user information from localStorage
    function getCurrentUser() {
      return {
        userId: localStorage.getItem('userId'),
        token: localStorage.getItem('authToken'),
        role: localStorage.getItem('userRole'),
        name: localStorage.getItem('userName'),
        branchId: localStorage.getItem('branchId'),
        employeeId: localStorage.getItem('employeeId')
      };
    }

    // Normalize employee data to handle different field names and formats
    function normalizeEmployeeData(rawData) {
      const normalized = {
        id: rawData.id || rawData.userId || rawData.user_id || rawData.employeeId || rawData.employee_id,
        employeeId: rawData.employeeId || rawData.employee_id || rawData.emp_code || rawData.id,
        name: rawData.name || rawData.full_name || (rawData.first_name && rawData.last_name ? `${rawData.first_name} ${rawData.last_name}` : null) || rawData.display_name,
        firstName: rawData.firstName || rawData.first_name,
        lastName: rawData.lastName || rawData.last_name,
        position: rawData.position || rawData.job_title || rawData.role,
        department: rawData.department || rawData.dept,
        branchId: rawData.branchId || rawData.branch_id,
        branchName: rawData.branchName || rawData.branch_name || rawData.branch,
        email: rawData.email || rawData.email_address,
        phone: rawData.phone || rawData.phone_number || rawData.tel,
        startDate: rawData.startDate || rawData.start_date || rawData.hireDate || rawData.hire_date || rawData.joinDate || rawData.join_date,
    
        // Handle multiple possible image field names
        imageUrl: getEmployeeImageUrl(rawData),
    
        // Additional fields
        salary: rawData.salary || rawData.base_salary,
        status: rawData.status || rawData.employee_status,
        gender: rawData.gender,
        birthDate: rawData.birthDate || rawData.birth_date || rawData.dob
      };

      console.log('Normalized employee data:', normalized);
      return normalized;
    }

    // Extract image URL from various possible field names
    function getEmployeeImageUrl(employeeData) {
      const imageFields = [
        'imageUrl', 'image_url', 'image',
        'photoUrl', 'photo_url', 'photo',
        'avatar', 'avatar_url',
        'profileImage', 'profile_image', 'profile_image_url',
        'profilePicture', 'profile_picture',
        'picture', 'picture_url',
        'thumbnail', 'thumbnail_url'
      ];

      let imageUrl = null;

      // Try each possible field
      for (const field of imageFields) {
        if (employeeData[field] && employeeData[field].trim() !== '') {
          imageUrl = employeeData[field];
          console.log(`Found image URL in field '${field}':`, imageUrl);
          break;
        }
      }

      // If we found an image URL, process it
      if (imageUrl) {
        // Handle relative URLs
        if (imageUrl.startsWith('/')) {
          imageUrl = `${API_BASE_URL}${imageUrl}`;
        }
        // Handle URLs that don't start with http
        else if (!imageUrl.startsWith('http')) {
          imageUrl = `${API_BASE_URL}/${imageUrl}`;
        }

        // Add timestamp to prevent caching issues
        const separator = imageUrl.includes('?') ? '&' : '?';
        imageUrl = `${imageUrl}${separator}v=${Date.now()}`;
      }

      console.log('Final processed image URL:', imageUrl);
      return imageUrl;
    }

    // Fetch employee data from API
    async function fetchEmployeeData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No userId found, will try to get employee data from token');
        }

        // Try multiple endpoints to get employee data including profile pictures
        const endpoints = [
          `/api/hr/employees/user/${currentUser.userId}`,
          `/api/hr/employees/profile`,
          `/api/employees/user/${currentUser.userId}`,
          `/api/employees/profile`,
          `/api/employees/${currentUser.userId}`,
          `/api/hr/employees/${currentUser.userId || 'current'}`,
          `/api/users/${currentUser.userId}`,
          `/api/users/profile`,
          `/api/auth/profile`,
          `/api/profile`
        ];

        for (const endpoint of endpoints) {
          try {
            // Skip endpoints that require userId if we don't have it
            if (endpoint.includes('/undefined') || (endpoint.includes('/user/') && !currentUser.userId)) {
              console.log(`Skipping ${endpoint} - no userId available`);
              continue;
            }

            console.log(`Trying endpoint: ${endpoint}`);
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              headers: getAuthHeaders()
            });

            if (handleAuthError(response)) return null;

            if (response.ok) {
              const result = await response.json();
              console.log(`Response from ${endpoint}:`, result);

              let employeeData = null;

              // Handle different response formats
              if (result.success && result.data) {
                employeeData = result.data;
              } else if (result.employee) {
                employeeData = result.employee;
              } else if (result.data && result.data.employee) {
                employeeData = result.data.employee;
              } else if (result.user) {
                employeeData = result.user;
              } else if (result.data && result.data.user) {
                employeeData = result.data.user;
              } else if (result && typeof result === 'object' && (result.name || result.first_name)) {
                employeeData = result;
              }

              if (employeeData) {
                console.log('Employee data found:', employeeData);

                // Store additional employee info in localStorage
                if (employeeData.employeeId || employeeData.employee_id || employeeData.id) {
                  localStorage.setItem('employeeId', employeeData.employeeId || employeeData.employee_id || employeeData.id);
                }
                if (employeeData.branchId || employeeData.branch_id) {
                  localStorage.setItem('branchId', employeeData.branchId || employeeData.branch_id);
                }

                // Process and normalize employee data for consistent access
                const normalizedData = normalizeEmployeeData(employeeData);
                return normalizedData;
              }
            }
          } catch (endpointError) {
            console.warn(`Error with endpoint ${endpoint}:`, endpointError);
            continue; // Try next endpoint
          }
        }

        console.warn('No valid employee data found from any endpoint');
      } catch (error) {
        console.error('Error fetching employee data:', error);
      }
      return null;
    }

    // Fetch bonus data from API - personal bonuses only
    async function fetchBonusData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No user ID available for loading bonus data');
          return [];
        }

        console.log('Fetching personal bonus data for user:', currentUser.userId);

        // Use the same endpoint as payroll.html for consistency
        const response = await fetch(`${API_BASE_URL}/api/hr/bonus?userId=${currentUser.userId}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          console.log('Personal bonus data response:', result);

          // Handle response format same as payroll.html
          let bonusData = result.data || result || [];

          if (Array.isArray(bonusData)) {
            console.log(`Found ${bonusData.length} personal bonuses for user ${currentUser.userId}`);
            return bonusData;
          } else {
            console.warn('Bonus data is not an array:', bonusData);
            return [];
          }
        } else {
          console.warn('Failed to load bonus data:', response.status, response.statusText);
          return [];
        }
      } catch (error) {
        console.error('Error fetching bonus data:', error);
        return [];
      }
    }

    // Function to update employee photo with proper fallback and real API support
    function updateEmployeePhoto(photoUrl) {
      const defaultPhoto = '/uploads/employees/default-avatar.png?v=' + Date.now();
      const imgElement = document.getElementById('employeePhoto');
    
      if (!imgElement) return;

      // If we have a photo URL from employee data, try to use it
      if (photoUrl && photoUrl.trim() !== '') {
        console.log('Setting employee photo to:', photoUrl);
    
        // Create a new image to test if URL is valid
        const testImg = new Image();
        testImg.crossOrigin = 'anonymous'; // Handle CORS if needed
    
        testImg.onload = function() {
          console.log('Employee photo loaded successfully:', photoUrl);
          imgElement.src = photoUrl;
          imgElement.style.display = 'block';
        };
    
        testImg.onerror = function() {
          console.warn('Failed to load employee photo from:', photoUrl);
    
          // Try alternative image paths
          const alternatives = [
            photoUrl.replace(/^https?:\/\/[^\/]+/, API_BASE_URL),
            `${API_BASE_URL}/uploads/employees/${photoUrl.split('/').pop()}`,
            `${API_BASE_URL}/uploads/users/${photoUrl.split('/').pop()}`,
            `${API_BASE_URL}/images/employees/${photoUrl.split('/').pop()}`,
            defaultPhoto
          ];
    
          tryAlternativeImages(imgElement, alternatives, 0);
        };
    
        // Start testing the image
        testImg.src = photoUrl;
    
      } else {
        // No photo URL provided, use default
        console.log('No photo URL for employee, using default');
        setImageWithFallback(imgElement, defaultPhoto);
      }
    }

    // Try alternative image URLs if the primary one fails
    function tryAlternativeImages(imgElement, alternatives, index) {
      if (index >= alternatives.length) {
        // All alternatives failed, show placeholder
        console.warn('All image alternatives failed, showing placeholder');
        showImagePlaceholder(imgElement);
        return;
      }
    
      const currentUrl = alternatives[index];
      console.log(`Trying alternative ${index + 1}:`, currentUrl);
    
      const testImg = new Image();
      testImg.crossOrigin = 'anonymous';
    
      testImg.onload = function() {
        console.log(`Alternative image ${index + 1} loaded successfully:`, currentUrl);
        imgElement.src = currentUrl;
        imgElement.style.display = 'block';
      };
    
      testImg.onerror = function() {
        console.warn(`Alternative image ${index + 1} failed:`, currentUrl);
        // Try next alternative
        tryAlternativeImages(imgElement, alternatives, index + 1);
      };
    
      testImg.src = currentUrl;
    }

    // Set image with fallback handling
    function setImageWithFallback(imgElement, imageUrl) {
      const testImg = new Image();
      testImg.crossOrigin = 'anonymous';
    
      testImg.onload = function() {
        console.log('Default photo loaded successfully');
        imgElement.src = imageUrl;
        imgElement.style.display = 'block';
      };
    
      testImg.onerror = function() {
        console.warn('Default photo failed, showing placeholder');
        showImagePlaceholder(imgElement);
      };
    
      testImg.src = imageUrl;
    }

    // Show placeholder when all image options fail
    function showImagePlaceholder(imgElement) {
      imgElement.style.display = 'none';
    
      // Remove existing placeholder if any
      const existingPlaceholder = imgElement.nextElementSibling;
      if (existingPlaceholder && existingPlaceholder.textContent === '👤') {
        existingPlaceholder.remove();
      }
    
      // Create new placeholder
      const placeholder = document.createElement('div');
      placeholder.className = imgElement.className;
      placeholder.style.cssText = `
        background: #e5e7eb; 
        color: #9ca3af; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 16px;
        border-radius: 50%;
      `;
      placeholder.textContent = '👤';
      placeholder.title = 'ไม่สามารถโหลดรูปโปรไฟล์ได้';
    
      imgElement.parentNode.insertBefore(placeholder, imgElement.nextSibling);
    }

    // Initialize employee data display
    function initializeEmployeeData() {
      const currentUser = getCurrentUser();

      // Display employee information from HR data (now normalized)
      const employeeName = hrData.employee ? hrData.employee.name : (currentUser.name || 'ไม่พบข้อมูลพนักงาน');
      const employeePosition = hrData.employee ? hrData.employee.position : 'ตำแหน่ง';
      const employeeDepartment = hrData.employee ? hrData.employee.department : 'แผนก';

      // Get employee photo from normalized data
      let employeePhoto = null;
      if (hrData.employee && hrData.employee.imageUrl) {
        employeePhoto = hrData.employee.imageUrl;
        console.log('Employee photo found:', employeePhoto);
      } else {
        console.log('No employee photo found in normalized data');
      }

      // Update page elements
      const employeeNameEl = document.getElementById('employeeName');
      if (employeeNameEl) {
        employeeNameEl.textContent = employeeName;
      }
    
      const employeePositionEl = document.getElementById('employeePosition');
      if (employeePositionEl) {
        employeePositionEl.textContent = employeePosition;
      }

      const employeeDepartmentEl = document.getElementById('employeeDepartment');
      if (employeeDepartmentEl) {
        employeeDepartmentEl.textContent = employeeDepartment;
      }

      // Update profile photo
      console.log('Calling updateEmployeePhoto with:', employeePhoto);
      updateEmployeePhoto(employeePhoto);
    }

    // Load all data including employee and bonus information
    async function loadAllData() {
      try {
        console.log('Loading personal bonus data...');

        // Show loading state
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('mainContent').classList.add('hidden');

        // Load employee data first
        hrData.employee = await fetchEmployeeData();

        // Initialize employee display
        initializeEmployeeData();

        // Load personal bonus data
        hrData.bonuses = await fetchBonusData();

        // Calculate totals
        calculateBonusTotals();

        // Update UI
        updateSummaryCards(hrData.bonuses);
        renderBonusTable(hrData.bonuses);

        // Hide loading state and show content
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

        console.log('Personal bonus data loaded:', hrData);
        console.log(`Displaying ${hrData.bonuses.length} personal bonuses`);
        return true;
      } catch (error) {
        console.error('Error loading personal bonus data:', error);

        // Hide loading state and show content (even if data load failed)
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

        return false;
      }
    }

    // Calculate bonus totals
    function calculateBonusTotals() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      hrData.totalBonus = hrData.bonuses.reduce((sum, bonus) => sum + (bonus.amount || 0), 0);
      hrData.monthlyBonus = hrData.bonuses
        .filter(bonus => {
          const bonusDate = new Date(bonus.date);
          return bonusDate.getMonth() === currentMonth && bonusDate.getFullYear() === currentYear;
        })
        .reduce((sum, bonus) => sum + (bonus.amount || 0), 0);
      hrData.totalTransactions = hrData.bonuses.length;
    }


    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      setCurrentDate();
      // Load data using the new API-integrated system
      loadAllData();
    });

    function setCurrentDate() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      };
      document.getElementById('currentDate').textContent =
        now.toLocaleDateString('th-TH', options);
    }

    function goBack() {
      window.history.back();
    }

    // Update summary cards with real API data
    function updateSummaryCards(bonusData) {
      const total = bonusData.reduce((sum, item) => sum + item.amount, 0);
      const thisMonth = bonusData
        .filter(item => {
          const itemDate = new Date(item.date);
          const now = new Date();
          return itemDate.getMonth() === now.getMonth() &&
                 itemDate.getFullYear() === now.getFullYear();
        })
        .reduce((sum, item) => sum + item.amount, 0);

      // Update total bonus element
      const totalBonusEl = document.getElementById('totalBonus');
      if (totalBonusEl) {
        totalBonusEl.textContent = formatCurrency(total);
      }

      // Update monthly bonus element
      const monthlyBonusEl = document.getElementById('monthlyBonus');
      if (monthlyBonusEl) {
        monthlyBonusEl.textContent = formatCurrency(thisMonth);
      }

      // Update transactions count element
      const totalTransactionsEl = document.getElementById('totalTransactions');
      if (totalTransactionsEl) {
        totalTransactionsEl.textContent = `${bonusData.length} รายการ`;
      }

      // Also update data-stat elements if they exist
      const totalBonusStatEl = document.querySelector('[data-stat="total-bonus"]');
      if (totalBonusStatEl) {
        totalBonusStatEl.textContent = total.toLocaleString('th-TH');
      }

      const monthlyBonusStatEl = document.querySelector('[data-stat="monthly-bonus"]');
      if (monthlyBonusStatEl) {
        monthlyBonusStatEl.textContent = thisMonth.toLocaleString('th-TH');
      }

      const transactionsStatEl = document.querySelector('[data-stat="transactions"]');
      if (transactionsStatEl) {
        transactionsStatEl.textContent = bonusData.length.toString();
      }
    }

    // Render bonus table with real API data
    function renderBonusTable(bonusData) {
      const tbody = document.getElementById('bonusTableBody');
      const emptyState = document.getElementById('emptyState');

      if (!tbody) {
        console.warn('Bonus table body not found');
        return;
      }

      if (bonusData.length === 0) {
        tbody.innerHTML = '';
        if (emptyState) {
          emptyState.classList.remove('hidden');
        }
        return;
      }

      if (emptyState) {
        emptyState.classList.add('hidden');
      }

      tbody.innerHTML = bonusData.map((item, index) => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${formatDate(item.date)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTypeClass(item.type)}">
              <i class="${getTypeIcon(item.type)} mr-1"></i>
              ${getTypeDisplayName(item.type)}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">
            ${item.description}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-green-600">
            ${formatCurrency(item.amount)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(item.status)}">
              <i class="${getStatusIcon(item.status)} mr-1"></i>
              ${getStatusText(item.status)}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function applyFilters() {
      const periodFilter = document.getElementById('periodFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;

      // Use only hrData.bonuses from API
      let filteredData = [...(hrData.bonuses || [])];

      // Apply period filter
      if (periodFilter !== 'all') {
        const now = new Date();
        filteredData = filteredData.filter(item => {
          const itemDate = new Date(item.date);

          switch (periodFilter) {
            case 'thisMonth':
              return itemDate.getMonth() === now.getMonth() &&
                     itemDate.getFullYear() === now.getFullYear();
            case 'lastMonth':
              const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
              return itemDate.getMonth() === lastMonth.getMonth() &&
                     itemDate.getFullYear() === lastMonth.getFullYear();
            case 'thisYear':
              return itemDate.getFullYear() === now.getFullYear();
            default:
              return true;
          }
        });
      }

      // Apply type filter
      if (typeFilter !== 'all') {
        filteredData = filteredData.filter(item => item.type === typeFilter);
      }

      updateSummaryCards(filteredData);
      renderBonusTable(filteredData);
    }

    // Utility functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function getTypeClass(type) {
      const classes = {
        sales: 'bg-green-100 text-green-800',
        performance: 'bg-blue-100 text-blue-800',
        commission: 'bg-purple-100 text-purple-800',
        special: 'bg-yellow-100 text-yellow-800'
      };
      return classes[type] || 'bg-gray-100 text-gray-800';
    }

    function getTypeIcon(type) {
      const icons = {
        sales: 'bi bi-graph-up',
        performance: 'bi bi-trophy',
        commission: 'bi bi-percent',
        special: 'bi bi-star'
      };
      return icons[type] || 'bi bi-circle';
    }

    function getStatusClass(status) {
      const classes = {
        paid: 'bg-green-100 text-green-800',
        pending: 'bg-yellow-100 text-yellow-800',
        cancelled: 'bg-red-100 text-red-800'
      };
      return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusIcon(status) {
      const icons = {
        paid: 'bi bi-check-circle',
        pending: 'bi bi-clock',
        cancelled: 'bi bi-x-circle'
      };
      return icons[status] || 'bi bi-circle';
    }

    function getStatusText(status) {
      const texts = {
        paid: 'จ่ายแล้ว',
        pending: 'รอดำเนินการ',
        cancelled: 'ยกเลิก'
      };
      return texts[status] || 'ไม่ทราบสถานะ';
    }

    function getTypeDisplayName(type) {
      switch (type) {
        case 'sales': return 'โบนัสยอดขาย';
        case 'performance': return 'โบนัสผลงาน';
        case 'holiday': return 'โบนัสวันหยุด';
        case 'special': return 'โบนัสพิเศษ';
        case 'attendance': return 'โบนัสเข้างาน';
        case 'overtime': return 'โบนัสทำงานล่วงเวลา';
        case 'project': return 'โบนัสโครงการ';
        case 'commission': return 'ค่าคอมมิชชั่น';
        case 'incentive': return 'เงินจูงใจ';
        case 'other': return 'อื่นๆ';
        default: return type || 'ไม่ระบุ';
      }
    }

    // Debug function to show current data state
    function debugDataState() {
      console.log('Current HR Data State:', hrData);
      console.log('Current User:', getCurrentUser());
      console.log('API Base URL:', API_BASE_URL);
    }

    // Add debug panel (similar to employee_only.html)
    function createDebugPanel() {
      if (document.getElementById('debugPanel')) return; // Already exists

      const debugPanel = document.createElement('div');
      debugPanel.id = 'debugPanel';
      debugPanel.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        width: 350px;
        max-height: 400px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        z-index: 10000;
        overflow-y: auto;
        display: none;
      `;

      debugPanel.innerHTML = `
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
          <strong>Debug Panel</strong>
          <button onclick="document.getElementById('debugPanel').style.display='none'" 
                  style="background: #dc2626; color: white; border: none; padding: 2px 6px; border-radius: 3px; margin-left: auto;">
            ×
          </button>
        </div>
        <div id="debugContent">Loading...</div>
      `;

      document.body.appendChild(debugPanel);
    
      // Update debug content
      updateDebugContent();
    }

    // Update debug panel content
    function updateDebugContent() {
      const debugContent = document.getElementById('debugContent');
      if (!debugContent) return;

      const currentUser = getCurrentUser();
    
      debugContent.innerHTML = `
        <div><strong>API Base:</strong> ${API_BASE_URL}</div>
        <div><strong>Auth Token:</strong> ${currentUser.token ? 'Present' : 'Missing'}</div>
        <div><strong>User ID:</strong> ${currentUser.userId || 'N/A'}</div>
        <div><strong>Role:</strong> ${currentUser.role || 'N/A'}</div>
        <div><strong>Name:</strong> ${currentUser.name || 'N/A'}</div>
        <div><strong>Employee ID:</strong> ${currentUser.employeeId || 'N/A'}</div>
        <div><strong>Branch ID:</strong> ${currentUser.branchId || 'N/A'}</div>
        <hr style="margin: 10px 0; border-color: #333;">
        <div><strong>Employee Data:</strong> ${hrData.employee ? 'Loaded' : 'Not loaded'}</div>
        ${hrData.employee ? `
          <div style="margin-left: 10px;">
            <div>Name: ${hrData.employee.name || 'N/A'}</div>
            <div>Position: ${hrData.employee.position || 'N/A'}</div>
            <div>Department: ${hrData.employee.department || 'N/A'}</div>
            <div>Image: ${hrData.employee.imageUrl ? 'Available' : 'N/A'}</div>
          </div>
        ` : ''}
        <div><strong>Bonus Count:</strong> ${hrData.bonuses ? hrData.bonuses.length : 0}</div>
        <div><strong>Total Bonus:</strong> ฿${hrData.totalBonus ? hrData.totalBonus.toLocaleString() : '0'}</div>
        <div><strong>Monthly Bonus:</strong> ฿${hrData.monthlyBonus ? hrData.monthlyBonus.toLocaleString() : '0'}</div>
        <hr style="margin: 10px 0; border-color: #333;">
        <button onclick="debugDataState()" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 3px; margin-right: 5px;">
          Log Data
        </button>
        <button onclick="loadAllData()" style="background: #2563eb; color: white; border: none; padding: 4px 8px; border-radius: 3px;">
          Reload
        </button>
      `;
    }

    // Toggle debug panel with keyboard shortcut
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const debugPanel = document.getElementById('debugPanel');
        if (!debugPanel) {
          createDebugPanel();
        } else {
          debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
          if (debugPanel.style.display === 'block') {
            updateDebugContent();
          }
        }
      }
    });
  </script>
</body>
</html>