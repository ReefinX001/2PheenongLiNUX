<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ผังบัญชี</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link rel="stylesheet" href="/account/chart_of_accounts.css" />

  <!-- Required Libraries for Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/locale/th.js"></script>
  


  <script>
    tailwind.config = {
      darkMode: 'class'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],'
          },
          colors: {
            primary: {
              50: '#f0f9ff','
              100: '#e0f2fe','
              500: '#0ea5e9','
              600: '#0284c7','
            }
          }
        },
      }
    }
  </script>

  
  
     <!-- Template สำหรับเมนู -->
  <template id="mainMenuTemplate">
    <div class="flex justify-center">
      <ul class="menu menu-horizontal p-0 bg-white dark:bg-gray-800 rounded-lg shadow-md space-x-2">
<!-- ซื้อ -->
<li tabindex="0" class="dropdown">
  <a class="flex justify-between items-center px-4 py-2">
    <i class="bi bi-cart-fill text-green-600 mr-2"></i> ซื้อ
    <i class="bi bi-caret-down-fill text-green-600 ml-1"></i> <!-- Added ml-1 for spacing -->
  </a>
  <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg space-y-1">
    <li class="submenu-item">
      <a href="purchase_order">
        <i class="bi bi-file-earmark-text text-green-500 mr-2"></i> ใบสั่งซื้อ
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_product">
        <i class="bi bi-bag-fill text-green-500 mr-2"></i> ซื้อสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_asset"> 
        <i class="bi bi-archive-fill text-green-500 mr-2"></i> ซื้อสินทรัพย์ 
      </a>
      <li class="submenu-item">
      <a href="goods_receipt">
        <i class="bi bi-box-arrow-in-down text-green-500 mr-2"></i> ใบรับสินค้า 
      </a>
    </li>
    </li>
    <li class="submenu-item">
      <a href="supplier_details"> 
        <i class="bi bi-person-lines-fill text-green-500 mr-2"></i> รายละเอียดผู้จำหน่าย
      </a>
    </li>
    
    <li class="submenu-item">
      <a href="deposit_payment">
        <i class="bi bi-cash-stack text-green-500 mr-2"></i> ใบจ่ายเงินมัดจำ
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_tax_invoice">
        <i class="bi bi-file-earmark-spreadsheet text-green-500 mr-2"></i> ใบกำกับภาษีซื้อ
      </a>
    </li>
    <li class="submenu-item">
      <a href="credit_note">
        <i class="bi bi-file-earmark-minus text-green-500 mr-2"></i> ใบลดหนี้
      </a>
    </li>
    <li class="submenu-item">
      <a href="debit_note">
        <i class="bi bi-file-earmark-plus text-green-500 mr-2"></i> ใบเพิ่มหนี้
      </a>
    </li>
    <li class="submenu-item expense-group">
      <a href="expense_record">
        <i class="bi bi-journal-text text-green-500 mr-2"></i> บันทึกค่าใช้จ่าย
      </a>
    </li>
  </ul>
</li>
      
        <!-- ขาย -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-shop text-red-600 mr-2"></i> ขาย
            <i class="bi bi-caret-down-fill text-red-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="quotation">
                <i class="bi bi-file-earmark-text text-red-500 mr-2"></i> ใบเสนอราคา
              </a>
            </li>
            <li class="submenu-item">
              <a href="invoice">
                <i class="bi bi-receipt text-red-500 mr-2"></i> ใบแจ้งหนี้
              </a>
            </li>
            <li class="submenu-item">
              <a href="deposit_receipt">
                <i class="bi bi-file-earmark-check text-red-500 mr-2"></i> ใบรับเงินมัดจำ
              </a>
            </li>
            <li class="submenu-item">
              <a href="receipt">
                <i class="bi bi-receipt-cutoff text-red-500 mr-2"></i> ใบเสร็จรับเงิน
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_tax_invoice">
                <i class="bi bi-file-earmark-spreadsheet text-red-500 mr-2"></i> ใบกำกับภาษีขาย
              </a>
            </li>
            <li class="submenu-item">
              <a href="other_income">
                <i class="bi bi-cash-coin text-red-500 mr-2"></i> บันทึกรายได้อื่นๆ
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_debit_notee">
                <i class="bi bi-file-earmark-plus text-red-500 mr-2"></i> ใบเพิ่มหนี้
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_credit_notee">
                <i class="bi bi-file-earmark-minus text-red-500 mr-2"></i> ใบลดหนี้
              </a>
            </li>
            <!-- เพิ่มเมนู รายละเอียดลูกหนี้ -->
            <li class="submenu-item">
            <a href="customer_details">
            <i class="bi bi-people text-red-500 mr-2"></i> รายละเอียดลูกหนี้
            </a>
          </li>
          </ul>
        </li>
      
        <!-- บัญชี -->
         <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-bank text-blue-600 mr-2"></i> บัญชี
            <i class="bi bi-caret-down-fill text-blue-600 ml-1"></i>
          </a>
          
          <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="chart_of_accounts">
                <i class="bi bi-diagram-3-fill text-blue-500 mr-2"></i> ผังบัญชี
              </a>
            </li>

            <!-- หัวข้อย่อย ลงประจำวัน (Nested Dropdown) -->
            <li tabindex="0" class="submenu-item dropdown"> <!-- Added tabindex for focus -->
              <a href="javascript:void(0);" class="flex justify-between items-center w-full"> <!-- Use href for focusability -->
                <i class="bi bi-journal-text text-blue-500 mr-2"></i> ลงประจำวัน
                <i class="bi bi-caret-right-fill text-blue-500 ml-auto"></i>
              </a>
              <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg"> <!-- Nested UL for fly-out -->
                <li class="submenu-item">
                  <a href="journal_general">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันทั่วไป
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_payment">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันจ่าย
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_receipt">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันรับ
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_sales">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันขาย
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_purchase">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันซื้อ
                  </a>
                </li>
              </ul>
            </li>

            <!-- เพิ่มเมนู งบกระแสเงินสด -->
            <li class="submenu-item">
              <a href="cash_flow">
                <i class="bi bi-cash text-blue-500 mr-2"></i> งบกระแสเงินสด
              </a>
            </li>
  
             <li class="submenu-item">
              <a href="social_security">
                <i class="bi bi-shield-check text-blue-500 mr-2"></i> ภาษีและประกันสังคม
              </a>
            </li>
            <li class="submenu-item">
              <a href="assets">
                <i class="bi bi-collection-fill text-blue-500 mr-2"></i> สินทรัพย์
              </a>
            </li>
            <!-- เพิ่มเมนู ทุน -->
            <li class="submenu-item">
              <a href="capital">
                <i class="bi bi-piggy-bank text-blue-500 mr-2"></i> ทุน
              </a>
            </li>
          </ul>
        </li>

 <!-- การเงิน -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-currency-exchange text-teal-600 mr-2"></i> การเงิน
            <i class="bi bi-caret-down-fill text-teal-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="cash_management">
                <i class="bi bi-wallet2 text-teal-500 mr-2"></i> การจัดการเงินสด
              </a>
            </li>
            <li class="submenu-item">
              <a href="bank_reconciliation">
                <i class="bi bi-bank text-teal-500 mr-2"></i> กระทบยอดธนาคาร
              </a>
            </li>
            <li class="submenu-item">
              <a href="loan_management">
                <i class="bi bi-cash-coin text-teal-500 mr-2"></i> การจัดการเงินกู้
              </a>
            </li>
            <li class="submenu-item">
              <a href="investment_management">
                <i class="bi bi-bar-chart text-teal-500 mr-2"></i> การจัดการการลงทุน
              </a>
            </li>
             <li class="submenu-item">
              <a href="cash_flow_planning">
                <i class="bi bi-calendar3-range text-teal-500 mr-2"></i> วางแผนกระแสเงินสด
              </a>
            </li>
            <li class="submenu-item">
              <a href="received_checks">
                <i class="bi bi-receipt text-teal-500 mr-2"></i> เช็ครับ
              </a>
            </li>
            <li class="submenu-item">
              <a href="issued_checks">
                <i class="bi bi-journal-check text-teal-500 mr-2"></i> เช็คจ่าย
              </a>
            </li>
           
            <li class="submenu-item">
              <a href="withholding_tax_received">
                <i class="bi bi-file-earmark-minus text-teal-500 mr-2"></i> ภาษีถูกหัก ณ ที่จ่าย
              </a>
            </li>
            <li class="submenu-item">
              <a href="withholding_tax_paid">
                <i class="bi bi-file-earmark-plus text-teal-500 mr-2"></i> ภาษีหัก ณ ที่จ่าย
              </a>
            </li>
          </ul>
        </li>

      
        <!-- สินค้า -->
<li tabindex="0" class="dropdown">
  <a class="flex justify-between items-center px-4 py-2">
    <i class="bi bi-box-seam text-amber-600 mr-2"></i> สินค้า
    <i class="bi bi-caret-down-fill text-amber-600 ml-1"></i>
  </a>
  <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
    <li class="submenu-item">
      <a href="product_details">
        <i class="bi bi-info-circle text-amber-500 mr-2"></i> รายละเอียดสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="service_details">
        <i class="bi bi-briefcase text-amber-500 mr-2"></i> รายละเอียดบริการ
      </a>
    </li>
    <!-- เพิ่มเมนูรายการเคลื่อนไหวสินค้า -->
    <li class="submenu-item">
      <a href="product_movements">
        <i class="bi bi-arrow-left-right text-amber-500 mr-2"></i> รายการเคลื่อนไหวสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="opening_inventory">
        <i class="bi bi-box-arrow-in-left text-amber-500 mr-2"></i> สินค้าคงเหลือต้นงวด
      </a>
    </li>
    <li class="submenu-item">
      <a href="closing_inventory">
        <i class="bi bi-box-arrow-right text-amber-500 mr-2"></i> สินค้าคงเหลือปลายงวด
      </a>
    </li>
  </ul>
</li>
      
       
      
       <!-- รายงาน -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-folder2 text-cyan-600 mr-2"></i> รายงาน
            <i class="bi bi-caret-down-fill text-cyan-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="inventory_report">
                <i class="bi bi-box-seam text-cyan-500 mr-2"></i> รายงานสินค้าคงเหลือ
              </a>
            </li>
             <!-- ... other report items ... -->
            <li class="submenu-item">
              <a href="purchase_summary_report"><i class="bi bi-cart-check text-cyan-500 mr-2"></i> รายงานสรุปยอดซื้อ</a>
            </li>
            <li class="submenu-item">
              <a href="sales_summary_report"><i class="bi bi-bar-chart text-cyan-500 mr-2"></i> รายงานสรุปยอดขาย</a>
            </li>
            <li class="submenu-item">
              <a href="financial_statement"><i class="bi bi-graph-up text-cyan-500 mr-2"></i> รายงานงบการเงิน</a>
            </li>
            <li class="submenu-item">
              <a href="product_cost_report"><i class="bi bi-cash-coin text-cyan-500 mr-2"></i> รายงานต้นทุนสินค้า</a>
            </li>
            <li class="submenu-item">
              <a href="customer_report"><i class="bi bi-people text-cyan-500 mr-2"></i> รายงานลูกหนี้</a>
            </li>
            <li class="submenu-item">
              <a href="supplier_report"><i class="bi bi-truck text-cyan-500 mr-2"></i> รายงานเจ้าหนี้</a>
            </li>
            
    <li class="submenu-item">
      <a href="trial_balance">
        <i class="bi bi-list-ul text-cyan-500 mr-2"></i> รายงานงบทดลอง
      </a>
    </li>
    <li class="submenu-item">
      <a href="financial_position">
        <i class="bi bi-columns-gap text-cyan-500 mr-2"></i> รายงานงบฐานะการเงิน
      </a>
    </li>
    <li class="submenu-item">
      <a href="income_statement">
        <i class="bi bi-cash-stack text-cyan-500 mr-2"></i> รายงานงบกำไรขาดทุน
      </a>
    </li>
    <!-- รายงานงบกระแสเงินสด -->
    <li class="submenu-item">
      <a href="cash_flow">
        <i class="bi bi-cash text-cyan-500 mr-2"></i> รายงานงบกระแสเงินสด
      </a>
    </li>
        <!-- รายงานบัญชีแยกประเภท -->
    <li class="submenu-item">
      <a href="general_ledger">
        <i class="bi bi-journal-text text-cyan-500 mr-2"></i> รายงานบัญชีแยกประเภท
      </a>
    </li>
           

            <!-- รายงานภาษี (Nested Dropdown) -->
            <li tabindex="0" class="submenu-item dropdown">
              <a href="javascript:void(0);" class="flex justify-between items-center w-full">
                <i class="bi bi-receipt text-cyan-500 mr-2"></i> รายงานภาษี
                <i class="bi bi-caret-right-fill text-cyan-500 ml-auto"></i>
              </a>
              <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
                <!-- ภาษีมูลค่าเพิ่ม (Deeper Nested Dropdown) -->
                <li tabindex="0" class="submenu-item dropdown">
                  <a href="javascript:void(0);" class="flex justify-between items-center w-full">
                    ภาษีมูลค่าเพิ่ม
                    <i class="bi bi-caret-right-fill text-cyan-500 ml-auto"></i>
                  </a>
                  <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
                    <li class="submenu-item">
                      <a href="vat_purchase_report">
                        <i class="bi bi-arrow-down-circle text-cyan-500 mr-2"></i> ภาษีซื้อ
                      </a>
                    </li>
                    <li class="submenu-item">
                      <a href="vat_sales_report">
                        <i class="bi bi-arrow-up-circle text-cyan-500 mr-2"></i> ภาษีขาย
                      </a>
                    </li>
                  </ul>
                </li>
                <li class="submenu-item">
                  <a href="withholding_tax_report">
                    <i class="bi bi-currency-exchange text-cyan-500 mr-2"></i> ภาษีหัก ณ ที่จ่าย
                  </a>
                </li>
              </ul>
            </li>
                
            <li class="submenu-item">
              <a href="sales_analysis_report"><i class="bi bi-bar-chart-line text-cyan-500 mr-2"></i> รายงานวิเคราะห์การขาย</a>
            </li>
            <li class="submenu-item">
              <a href="purchase_analysis_report"><i class="bi bi-graph-up-arrow text-cyan-500 mr-2"></i> รายงานวิเคราะห์การซื้อ</a>
            </li>
          </ul>
        </li>
      
        <!-- ตั้งค่า -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-gear-fill text-slate-600 mr-2"></i> ตั้งค่า
            <i class="bi bi-caret-down-fill text-slate-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 dark:bg-gray-700 shadow-lg rounded-lg">
            
            <li class="submenu-item"><a href="organization_settings"><i class="bi bi-building text-slate-500 mr-2"></i> ตั้งค่าองค์กร</a></li>
            <li class="submenu-item"><a href="user_settings"><i class="bi bi-person-gear text-slate-500 mr-2"></i> ตั้งค่าผู้ใช้งาน</a></li>
            <li class="submenu-item"><a href="document_settings"><i class="bi bi-file-earmark-text text-slate-500 mr-2"></i> ตั้งค่าเอกสาร</a></li>
            <li class="submenu-item"><a href="accounting_policy"><i class="bi bi-shield-lock text-slate-500 mr-2"></i> นโยบายบัญชี</a></li>
            <li class="submenu-item"><a href="external_integration"><i class="bi bi-plug-fill text-slate-500 mr-2"></i> เชื่อมต่อภายนอก</a></li>
            <li class="submenu-item"><a href="register_accounting_firm"><i class="bi bi-journal-bookmark-fill text-slate-500 mr-2"></i> ลงทะเบียนสำนักงานบัญชี</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </template>

  <!-- Loading System -->
  <link rel="stylesheet" href="/css/loading-components.css">
  <script src="/js/loading-system.js"></script>

</head>

<body class="bg-white dark:bg-gray-900 dark:text-white w-full h-screen">
  <!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="loader"></div>
</div>
  <div id="mainContent" class="container mx-auto px-4 py-6">
    <!-- Navbar -->
    <div class="navbar bg-white dark:bg-gray-800 shadow-md sticky top-0"> <!-- Removed z-30 from navbar, menu will handle z-index -->
      <div class="flex-1 flex items-center space-x-6">
        <img src="/uploads/Logo2.png"
             alt="Logo"
             class="rounded-full shadow-lg"
             style="width: 40px; height: 40px;" />
        <span class="text-lg font-semibold">ระบบบัญชี - ผังบัญชี</span>
        <!-- จุดปล่อยเมนู -->
        <div id="mainMenuContainer" class="ml-auto"></div> <!-- Added ml-auto to push menu towards center/right if space allows -->
      </div>
      <div class="flex-none flex items-center space-x-2">
  <!-- เพิ่มส่วนแสดงข้อมูลผู้ใช้ -->
  <div class="flex items-center space-x-3 mr-4">
    <img id="employeePhoto" 
     alt="Profile" 
     class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600">
    <span id="employeeName" class="text-sm font-medium text-gray-700 dark:text-gray-300">Loading...</span>
  </div>
  
  <button id="btnToggleDark" class="btn btn-rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">
    <i id="themeIcon" class="bi bi-moon-stars-fill mr-2 text-gray-700 dark:text-yellow-300"></i>
    <span id="darkModeLabel">Dark Mode</span>
  </button>
  <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy">
    <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
  </button>
</div>
    </div>

  <script>
  // === 1. API Configuration ===
  const API_BASE_URL = '/api';'
  const AUTH_TOKEN = localStorage.getItem('token');'
  
  // === 2. API Helper Function ===
  async function apiCall(endpoint, options = {}) {
  try {
    // Check if we have a valid API URL
    if (!API_BASE_URL) {
      throw new Error('API base URL is not configured');'
    }
    
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json','
        'Authorization': `Bearer ${AUTH_TOKEN}`,'
        ...options.headers
      }
    });
    
    if (!response.ok) {
      throw new Error(`API Error: ${response.status} ${response.statusText}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API Call Error:', error);'
    
    // Provide more specific error messages
    if (error.message.includes('Failed to fetch')) {'
      throw new Error('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');'
    }
    
    throw error;
  }
}
  
  // === 3. Utility Functions ===
    function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';'
  }
  
  function showSuccess(message) {
    // TODO: ใช้ toast library แทน alert
    alert('✅ ' + message);'
  }
  
  function showError(message) {
    alert('❌ ' + message);'
  }
  


async function loadEmployeeProfile() {
  try {
    // ตรวจสอบ token จากหลายแหล่ง (เหมือนกับระบบคลังสินค้า)
    const token = localStorage.getItem('authToken') || '
                  localStorage.getItem('token') || '
                  sessionStorage.getItem('token');'
    
    if (!token) {
      console.warn('No authentication token found');'
      setDefaultProfile();
      return;
    }

    // ใช้ endpoint แบบเดียวกับระบบคลังสินค้า
    const response = await fetch('/api/users/me', {'
      method: 'GET','
      headers: {
        'Authorization': `Bearer ${token}`,'
        'Content-Type': 'application/json''
      }
    });

    if (!response.ok) {
      if (response.status === 401) {
        console.warn('Token expired or invalid');'
        clearAuthData();
        setDefaultProfile();
        setTimeout(() => {
          window.location.href = '/login';'
        }, 2000);
        return;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    
    // ตรวจสอบ response format
    let userData;
    if (data.success && data.data) {
      userData = data.data;
    } else {
      userData = data;
    }
    
    // Update UI - ใช้ชื่อ field เดียวกับระบบคลังสินค้า
    const employeeName = userData.name || userData.username || 'ผู้ใช้งาน';'
    document.getElementById('employeeName').textContent = employeeName;'
    
    // จัดการรูปภาพ - ตรวจสอบหลาย field
    let imageUrl = userData.imageUrl || 
                   userData.photoUrl || 
                   userData.image || 
                   userData.profileImage || 
                   userData.profile_image || 
                   userData.avatar;
    
    if (imageUrl) {
      // ตรวจสอบว่าเป็น URL แบบเต็มหรือไม่
      if (!imageUrl.startsWith('http')) {'
        imageUrl = imageUrl.startsWith('/') ? imageUrl : '/uploads/' + imageUrl;'
      }
      
      const img = document.getElementById('employeePhoto');'
      img.onerror = function() {
        this.src = '/static/images/avatar-placeholder.png';'
      };
      img.src = imageUrl;
    } else {
      // ใช้ placeholder
      document.getElementById('employeePhoto').src = '/static/images/avatar-placeholder.png';'
    }
    
  } catch (error) {
    console.error('Error loading employee profile:', error);'
    setDefaultProfile();
    
    if (error.message.includes('Failed to fetch')) {'
      console.error('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้');'
    }
  }
}

// เพิ่ม function clearAuthData ถ้ายังไม่มี
function clearAuthData() {
  localStorage.removeItem('token');'
  localStorage.removeItem('authToken');'
  localStorage.removeItem('userId');'
  localStorage.removeItem('userName');'
  sessionStorage.clear();
}


  // === 4. Data Loading Functions ===
async function loadChartOfAccounts() {
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    const res = await fetch('/api/chart-of-accounts', {'
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
    
    const jsonResponse = await res.json();
    
    const list = Array.isArray(jsonResponse.data)
      ? jsonResponse.data
      : Array.isArray(jsonResponse)
        ? jsonResponse
        : [];

    console.log('Raw data:', list);'

    // สร้าง tree structure
    const map = {};
    const roots = [];
    
    list.forEach(account => {
      map[account._id] = { 
        ...account, 
        children: [],
        parentId: account.parent
      };
    });

    list.forEach(account => {
      if (account.parent && map[account.parent]) {
        map[account.parent].children.push(map[account._id]);
      } else {
        roots.push(map[account._id]);
      }
    });

    const flat = [];
    
    function buildFlatArray(nodes, level = 0) {
      const sorted = nodes.sort((a, b) => {
        const codeA = parseInt(a.code, 10);
        const codeB = parseInt(b.code, 10);
        if (!isNaN(codeA) && !isNaN(codeB)) {
          return codeA - codeB;
        }
        return String(a.code).localeCompare(String(b.code));
      });

      sorted.forEach(account => {
        flat.push({
          ...account,
          level: level,
          hasChildren: account.children && account.children.length > 0
        });
        
        if (account.children && account.children.length > 0) {
          buildFlatArray(account.children, level + 1);
        }
      });
    }

    buildFlatArray(roots);

    console.log('Flat array:', flat);'

    renderTable(flat);
    
    // ❌ ลบการเรียก updateSummaryCards แบบเดิม
    // updateSummaryCards(groupAccountsByType(list));
    
    // ✅ เรียก API ใหม่เพื่อดึงจำนวนบัญชีที่ใช้งานจริง
    await loadAccountsSummary();
    
    updateTotalCount(list.length);
    
    hideLoading();
    
  } catch (err) {
    hideLoading();
    console.error('Failed to load chart of accounts:', err);'
    showError('ไม่สามารถโหลดข้อมูลผังบัญชีได้: ' + err.message);'
  }
}

// ✅ เพิ่ม function ใหม่สำหรับโหลดข้อมูลจำนวนบัญชีที่ใช้งานจริง
// ✅ แก้ไข function loadAccountsSummary ให้แสดงข้อมูลถูกต้อง
async function loadAccountsSummary() {
  try {
    const response = await fetch('/api/receipt-vouchers/dashboard/accounts-summary', {'
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load accounts summary');'
    }
    
    const result = await response.json();
    console.log('API Response:', result);'
    
    if (result.success && result.data) {
      // อัพเดทการ์ดสินทรัพย์ (card ที่ 1)
      const assetCard = document.querySelector('.stat-card:nth-child(1)');'
      if (assetCard) {
        // ✅ แก้ไข: ตรวจสอบว่าเป็นจำนวนเงินหรือจำนวนรายการ
        const assetAmount = result.data.assets || 0;
        
        // อัพเดทจำนวนรายการ - ถ้าเป็นตัวเลขมากๆ แสดงว่าเป็นจำนวนเงิน ไม่ใช่จำนวนรายการ
        const countElement = assetCard.querySelector('.text-sm');'
        if (countElement) {
          // ถ้าเป็นจำนวนเงิน (มากกว่า 1000) ให้นับเป็น 1 รายการ
          // ถ้าเป็นจำนวนนับ (น้อยกว่า 1000) ให้แสดงจำนวนนับ
          const itemCount = assetAmount > 1000 ? 1 : Math.round(assetAmount);
          countElement.textContent = `${itemCount} รายการ`;
        }
        
        // อัพเดทยอดเงิน
        const amountElement = assetCard.querySelector('.text-lg');'
        if (amountElement) {
          // ถ้าเป็นจำนวนเงิน ให้แสดงจำนวนเงิน
          // ถ้าเป็นจำนวนนับ ให้แสดง 0
          const displayAmount = assetAmount > 1000 ? assetAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
        
        // อัพเดท progress bar
        updateProgressBarForSummary(assetCard, assetAmount);
      }
      
      // อัพเดทการ์ดหนี้สิน (card ที่ 2)
      const liabCard = document.querySelector('.stat-card:nth-child(2)');'
      if (liabCard) {
        const liabAmount = result.data.liabilities || 0;
        
        const countElement = liabCard.querySelector('.text-sm');'
        if (countElement) {
          const itemCount = liabAmount > 1000 ? 1 : Math.round(liabAmount);
          countElement.textContent = `${itemCount} รายการ`;
        }
        
        const amountElement = liabCard.querySelector('.text-lg');'
        if (amountElement) {
          const displayAmount = liabAmount > 1000 ? liabAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
        
        updateProgressBarForSummary(liabCard, liabAmount);
      }
      
      // อัพเดทการ์ดรายได้ (card ที่ 4)
      const incomeCard = document.querySelector('.stat-card:nth-child(4)');'
      if (incomeCard) {
        const revenueAmount = result.data.revenue || 0;
        
        const countElement = incomeCard.querySelector('.text-sm');'
        if (countElement) {
          const itemCount = revenueAmount > 1000 ? 1 : Math.round(revenueAmount);
          countElement.textContent = `${itemCount} รายการ`;
        }
        
        const amountElement = incomeCard.querySelector('.text-lg');'
        if (amountElement) {
          const displayAmount = revenueAmount > 1000 ? revenueAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
        
        updateProgressBarForSummary(incomeCard, revenueAmount);
      }
      
      // อัพเดทการ์ดค่าใช้จ่าย (card ที่ 5)
      const expenseCard = document.querySelector('.stat-card:nth-child(5)');'
      if (expenseCard) {
        const expenseAmount = result.data.expenses || 0;
        
        const countElement = expenseCard.querySelector('.text-sm');'
        if (countElement) {
          const itemCount = expenseAmount > 1000 ? 1 : Math.round(expenseAmount);
          countElement.textContent = `${itemCount} รายการ`;
        }
        
        const amountElement = expenseCard.querySelector('.text-lg');'
        if (amountElement) {
          const displayAmount = expenseAmount > 1000 ? expenseAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
        
        updateProgressBarForSummary(expenseCard, expenseAmount);
      }
      
      // การ์ดส่วนของผู้ถือหุ้น - คงเดิมเพราะ API ไม่ส่งมา
      const equityCard = document.querySelector('.stat-card:nth-child(3)');'
      if (equityCard) {
        const countElement = equityCard.querySelector('.text-sm');'
        if (countElement) {
          countElement.textContent = `0 รายการ`;
        }
        const amountElement = equityCard.querySelector('.text-lg');'
        if (amountElement) {
          amountElement.textContent = formatCurrency(0);
        }
      }
      
      console.log('✅ Updated summary with amounts from Receipt Vouchers');'
    }
    
  } catch (error) {
    console.error('Error loading accounts summary:', error);'
    // ใช้ fallback จากผังบัญชี
    await loadAccountsSummaryFallback();
  }
}


    
    // === Export/Import Functions (แก้ไขใหม่) ===
async function exportToExcel() {
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    const response = await fetch('/api/accounts/export', {'
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (!response.ok) throw new Error('Export failed');'
    
    // รับ blob จาก response
    const blob = await response.blob();
    
    // สร้าง URL สำหรับ download
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');'
    a.href = url;
    a.download = `chart_of_accounts_${new Date().toISOString().split('T')[0]}.xlsx`;'
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    hideLoading();
    showSuccess('ส่งออกข้อมูลสำเร็จ');'
    
  } catch (error) {
    hideLoading();
    console.error('Export error:', error);'
    showError('ไม่สามารถส่งออกข้อมูลได้');'
  }
}

function importFromExcel() {
  const input = document.createElement('input');'
  input.type = 'file';'
  input.accept = '.xlsx,.xls';'
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);'
    
    try {
      const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
      
      const response = await fetch('/api/accounts/import', {'
        method: 'POST','
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`'
        },
        body: formData
      });
      
      if (!response.ok) throw new Error('Import failed');'
      
      const result = await response.json();
      
      hideLoading();
      showSuccess(`นำเข้าข้อมูลสำเร็จ ${result.data.success.length} รายการ`);
      
      // แสดงรายการที่ failed ถ้ามี
      if (result.data.failed.length > 0) {
        console.error('Failed imports:', result.data.failed);'
        showError(`มี ${result.data.failed.length} รายการที่นำเข้าไม่สำเร็จ ดูรายละเอียดใน Console`);
      }
      
      // โหลดข้อมูลใหม่
      await loadChartOfAccounts();
      
    } catch (error) {
      hideLoading();
      console.error('Import error:', error);'
      showError('ไม่สามารถนำเข้าข้อมูลได้');'
    }
  };
  
  input.click();
}

    
  
  // === 5. Data Processing Functions ===
  function groupAccountsByType(accounts) {
  const groups = {
    'Asset': { count: 0, total: 0, items: [] },'
    'Liabilities': { count: 0, total: 0, items: [] },'
    'Equity': { count: 0, total: 0, items: [] },'
    'Income': { count: 0, total: 0, items: [] },'
    'Expense': { count: 0, total: 0, items: [] }'
  };
  
  accounts.forEach(account => {
    const type = account.category; // ใช้ category ตาม Schema
    if (groups[type]) {
      groups[type].count++;
      groups[type].items.push(account);
      groups[type].total += parseFloat(account.balance || 0);
    }
  });
  
  return groups;
}

  // === 6. UI Update Functions ===
  function updateTotalCount(total) {
    // อัพเดทจำนวนรวมในหัวเรื่อง
    const headerElement = document.querySelector('.text-2xl.font-bold');'
    if (headerElement) {
      headerElement.innerHTML = `
        ทั้งหมด ${total} 
        <span class="text-gray-500 dark:text-gray-400 text-xl">รายการบัญชี</span>
      `;
    }
  }
  
  function updateSummaryCards(groupedAccounts) {
    // การ์ดสินทรัพย์ (card ที่ 1)
    const assetCard = document.querySelector('.stat-card:nth-child(1)');'
    if (assetCard) {
      assetCard.querySelector('.text-sm').textContent = `${groupedAccounts.Asset.count} รายการ`;'
      assetCard.querySelector('.text-lg').textContent = `฿${formatNumber(groupedAccounts.Asset.total)}`;'
      updateProgressBar(assetCard, groupedAccounts.Asset.count, getTotalAccounts(groupedAccounts));
    }
    
    // การ์ดหนี้สิน (card ที่ 2)
    const liabCard = document.querySelector('.stat-card:nth-child(2)');'
    if (liabCard) {
      liabCard.querySelector('.text-sm').textContent = `${groupedAccounts.Liabilities.count} รายการ`;'
      liabCard.querySelector('.text-lg').textContent = `฿${formatNumber(groupedAccounts.Liabilities.total)}`;'
      updateProgressBar(liabCard, groupedAccounts.Liabilities.count, getTotalAccounts(groupedAccounts));
    }
    
    // การ์ดส่วนของผู้ถือหุ้น (card ที่ 3)
    const equityCard = document.querySelector('.stat-card:nth-child(3)');'
    if (equityCard) {
      equityCard.querySelector('.text-sm').textContent = `${groupedAccounts.Equity.count} รายการ`;'
      equityCard.querySelector('.text-lg').textContent = `฿${formatNumber(groupedAccounts.Equity.total)}`;'
      updateProgressBar(equityCard, groupedAccounts.Equity.count, getTotalAccounts(groupedAccounts));
    }
    
    // การ์ดรายได้ (card ที่ 4)
    const incomeCard = document.querySelector('.stat-card:nth-child(4)');'
    if (incomeCard) {
      incomeCard.querySelector('.text-sm').textContent = `${groupedAccounts.Income.count} รายการ`;'
      incomeCard.querySelector('.text-lg').textContent = `฿${formatNumber(groupedAccounts.Income.total)}`;'
      updateProgressBar(incomeCard, groupedAccounts.Income.count, getTotalAccounts(groupedAccounts));
    }
    
    // การ์ดค่าใช้จ่าย (card ที่ 5)
    const expenseCard = document.querySelector('.stat-card:nth-child(5)');'
    if (expenseCard) {
      expenseCard.querySelector('.text-sm').textContent = `${groupedAccounts.Expense.count} รายการ`;'
      expenseCard.querySelector('.text-lg').textContent = `฿${formatNumber(groupedAccounts.Expense.total)}`;'
      updateProgressBar(expenseCard, groupedAccounts.Expense.count, getTotalAccounts(groupedAccounts));
    }
  }
  
  function updateProgressBar(card, count, total) {
    const progressBar = card.querySelector('.bg-blue-500, .bg-red-500, .bg-purple-500, .bg-green-500, .bg-yellow-500');'
    if (progressBar && total > 0) {
      const percentage = (count / total) * 100;
      progressBar.style.width = `${percentage}%`;
    }
  }
  
  function formatNumber(num) {
    return new Intl.NumberFormat('th-TH').format(num);'
  }
  
  function getTotalAccounts(grouped) {
    return Object.values(grouped).reduce((sum, g) => sum + g.count, 0);
  }

  // === Drag & Drop Functions ===
let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.style.opacity = '0.4';'
  e.dataTransfer.effectAllowed = 'move';'
  e.dataTransfer.setData('text/html', this.innerHTML);'
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';'
  
  const afterElement = getDragAfterElement(e.currentTarget.parentNode, e.clientY);
  if (afterElement == null) {
    e.currentTarget.parentNode.appendChild(draggedElement);
  } else {
    e.currentTarget.parentNode.insertBefore(draggedElement, afterElement);
  }
  
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedElement !== this) {
    // อัพเดทลำดับในฐานข้อมูล
    updateAccountOrder(draggedElement.dataset.accountId, this.dataset.accountId);
  }
  
  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';'
  
  // ลบ class ที่ใช้ในการ drag
  const rows = document.querySelectorAll('.account-table tbody tr');'
  rows.forEach(row => {
    row.classList.remove('drag-over');'
  });
  
  draggedElement = null;
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];'
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

async function updateAccountOrder(draggedId, targetId) {
  try {
    const response = await fetch(`/api/accounts/${draggedId}/reorder`, {
      method: 'PUT','
      headers: {
        'Content-Type': 'application/json','
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      },
      body: JSON.stringify({ targetId })
    });
    
    if (!response.ok) {
      throw new Error('Failed to update order');'
    }
    
  } catch (error) {
    console.error('Error updating account order:', error);'
    showError('ไม่สามารถเปลี่ยนลำดับได้');'
    // โหลดข้อมูลใหม่เพื่อ reset
    await loadChartOfAccounts();
  }
}

function addSubAccount(parentId, parentCode, parentName) {
  // ตั้งค่า parent account info
  document.getElementById('parentAccountId').value = parentId;'
  document.getElementById('parentAccountDisplay').textContent = `${parentCode} - ${parentName}`;'
  
  // แนะนำรหัสบัญชีย่อย
  const suggestedCode = parentCode + '01';'
  document.getElementById('subAccountCode').value = suggestedCode;'
  
  // เปิด modal
  document.getElementById('addSubAccountModal').classList.remove('hidden');'
}

function closeAddSubAccountModal() {
  document.getElementById('addSubAccountModal').classList.add('hidden');'
  document.getElementById('addSubAccountForm').reset();'
}

// Submit form สำหรับเพิ่มบัญชีย่อย
document.getElementById('addSubAccountForm')?.addEventListener('submit', async function(e) {'
  e.preventDefault();
  
  const parentId = document.getElementById('parentAccountId').value;'
  const code = document.getElementById('subAccountCode').value.trim();'
  const name = document.getElementById('subAccountName').value.trim();'
  
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    // หา parent account เพื่อดึง category
    const parentRow = document.querySelector(`tr[data-account-id="${parentId}"]`);
    const parentCategory = parentRow?.querySelector('td:nth-child(3) span')?.textContent;'
    
    const response = await fetch('/api/accounts', {'
      method: 'POST','
      headers: {
        'Content-Type': 'application/json','
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      },
      body: JSON.stringify({
        name: name,
        code: code,
        category: getCategoryFromThai(parentCategory), // แปลงกลับเป็นภาษาอังกฤษ
        type: 'detail','
        parent: parentId,
        balance: 0,
        status: 'active''
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to add sub account');'
    }
    
    closeAddSubAccountModal();
    hideLoading();
    showSuccess('เพิ่มบัญชีย่อยสำเร็จ');'
    
    // โหลดข้อมูลใหม่
    await loadChartOfAccounts();
    
  } catch (error) {
    hideLoading();
    console.error('Error adding sub account:', error);'
    showError('ไม่สามารถเพิ่มบัญชีย่อยได้');'
  }
});

// Helper function แปลงหมวดหมู่ภาษาไทยเป็นอังกฤษ
function getCategoryFromThai(thai) {
  const map = {
    'สินทรัพย์': 'Asset','
    'หนี้สิน': 'Liabilities','
    'ส่วนของเจ้าของ': 'Equity','
    'รายได้': 'Income','
    'ค่าใช้จ่าย': 'Expense''
  };
  return map[thai] || thai;
}

function createAccountRow(account, level) {
  const tr = document.createElement('tr');'
  tr.dataset.accountId = account._id;
  tr.dataset.level = level;
  tr.dataset.parentId = account.parentId || '';'
  
  // สร้าง cells ตามโครงสร้างเดิม
  const tdName = document.createElement('td');'
  tdName.className = 'p-4 border-b border-gray-200 dark:border-gray-700';'
  tdName.style.paddingLeft = `${level * 24 + 16}px`;
  tdName.textContent = `${account.code} – ${account.name}`;
  tr.appendChild(tdName);
  
  const tdCode = document.createElement('td');'
  tdCode.className = 'p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400';'
  tdCode.textContent = account.code;
  tr.appendChild(tdCode);
  
  const tdType = document.createElement('td');'
  tdType.className = 'p-4 border-b border-gray-200 dark:border-gray-700';'
  const typeLabel = getTypeLabel(account.category);
  tdType.innerHTML = `<span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded text-xs">${typeLabel}</span>`;
  tr.appendChild(tdType);
  
  const tdActions = document.createElement('td');'
  tdActions.className = 'p-4 border-b border-gray-200 dark:border-gray-700 text-right';'
  tdActions.innerHTML = `
    <div class="action-buttons flex items-center justify-end space-x-2">
      <button onclick="editAccount('${account._id}', '${account.name}', '${account.code}', '${account.category}')" '
              class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
              title="แก้ไข">
        <i class="bi bi-pencil-square"></i>
      </button>
      <button onclick="deleteAccount('${account._id}', '${account.code}')" '
              class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
              title="ลบ">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `;
  tr.appendChild(tdActions);
  
  return tr;
}
  // === 7. Table Rendering Functions ===
function renderTable(accounts) {
  const tbody = document.querySelector('.account-table tbody');'
  if (!tbody) {
    console.error("Table body '.account-table tbody' not found.");'
    return;
  }
  tbody.innerHTML = '';'

  accounts.forEach(acc => {
    const tr = document.createElement('tr');'
    tr.dataset.accountId = acc._id;
    tr.dataset.level = acc.level;
    tr.dataset.parentId = acc.parentId || ''; '
    
    // ซ่อนแถวที่ level > 0 ตอนเริ่มต้น
    if (acc.level > 0) {
      tr.classList.add('hidden');'
    }

    // Cell: Account Name
    const tdName = document.createElement('td');'
    tdName.className = `p-4 border-b border-gray-200 dark:border-gray-700`;
    tdName.style.paddingLeft = `${acc.level * 24 + 16}px`;
    
    // สร้างชื่อที่แสดง - ตรวจสอบไม่ให้แสดงรหัสซ้ำ
    const accountDisplayName = acc.name.startsWith(acc.code) 
      ? acc.name 
      : `${acc.code} – ${acc.name}`;

    if (acc.hasChildren) {
      const wrapper = document.createElement('div');'
      wrapper.className = 'flex items-center cursor-pointer hover:text-primary-600 dark:hover:text-primary-400';'
      
      let iconClass = 'bi bi-caret-right-fill text-xs mr-2 text-primary-600 dark:text-primary-400 transition-transform';'
      let spanClass = '';'

      // กำหนด style ตาม level
      if (acc.level === 0) {
        spanClass = 'font-bold text-lg text-primary-600 dark:text-primary-400';'
      } else if (acc.level === 1) {
        spanClass = 'font-semibold text-primary-600 dark:text-primary-400';'
      } else if (acc.level === 2) {
        spanClass = 'font-medium';'
      }
      
      wrapper.innerHTML = `
        <i class="${iconClass}"></i>
        <span class="${spanClass}">${accountDisplayName}</span>
      `;
      wrapper.addEventListener('click', toggleSubmenu);'
      tdName.appendChild(wrapper);
    } else {
      const span = document.createElement('span');'
      let spanClass = '';'
      
      // กำหนด style ตาม level สำหรับ leaf nodes
      if (acc.level === 0) {
        spanClass = 'font-bold text-lg text-primary-600 dark:text-primary-400';'
      } else if (acc.level === 1) {
        spanClass = 'font-semibold text-primary-600 dark:text-primary-400';'
      } else if (acc.level === 2) {
        spanClass = 'font-medium';'
      } else {
        spanClass = 'text-gray-700 dark:text-gray-300';'
      }
      
      if(spanClass) span.className = spanClass;
      span.textContent = accountDisplayName;
      tdName.appendChild(span);
    }
    tr.appendChild(tdName);

    // Cell: Account Code
    const tdCode = document.createElement('td');'
    tdCode.className = 'p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400';'
    tdCode.textContent = acc.code;
    tr.appendChild(tdCode);

    // Cell: Account Type
    const tdType = document.createElement('td');'
    tdType.className = 'p-4 border-b border-gray-200 dark:border-gray-700';'
    
    // กำหนดสีตามประเภทบัญชี
    let typeColor = 'blue';'
    let typeLabel = '';'
    
    switch(acc.category) {
      case 'Asset': '
        typeColor = 'blue';'
        typeLabel = 'สินทรัพย์';'
        break;
      case 'Liabilities': '
        typeColor = 'red';'
        typeLabel = 'หนี้สิน';'
        break;
      case 'Equity': '
        typeColor = 'purple';'
        typeLabel = 'ส่วนของเจ้าของ';'
        break;
      case 'Income': '
        typeColor = 'green';'
        typeLabel = 'รายได้';'
        break;
      case 'Expense': '
        typeColor = 'yellow';'
        typeLabel = 'ค่าใช้จ่าย';'
        break;
      default:
        typeLabel = acc.category;
    }
    
    tdType.innerHTML = `
      <span class="px-2 py-1 bg-${typeColor}-100 text-${typeColor}-800 dark:bg-${typeColor}-900/30 dark:text-${typeColor}-300 rounded text-xs">
        ${typeLabel}
      </span>
    `;
    tr.appendChild(tdType);

    // Cell: Actions
    const tdActions = document.createElement('td');'
    tdActions.className = 'p-4 border-b border-gray-200 dark:border-gray-700 text-right';'
    tdActions.innerHTML = `
      <div class="action-buttons flex items-center justify-end space-x-2">
        ${acc.level < 3 ? `
          <button onclick="addSubAccount('${acc._id}', '${acc.code}', '${acc.name}')" '
                  class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300"
                  title="เพิ่มบัญชีย่อย">
            <i class="bi bi-plus-circle"></i>
          </button>
        ` : ''}'
        <button onclick="editAccount('${acc._id}', '${acc.name}', '${acc.code}', '${acc.category}')" '
                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                title="แก้ไข">
          <i class="bi bi-pencil-square"></i>
        </button>
        ${!acc.hasChildren ? `
          <button onclick="deleteAccount('${acc._id}', '${acc.code}')" '
                  class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                  title="ลบ">
            <i class="bi bi-trash"></i>
          </button>
        ` : ''}'
      </div>
    `;
    tr.appendChild(tdActions);
    


    tbody.appendChild(tr);
  });
}
  

  
  




function closeLedgerModal() {
  const modal = document.getElementById('ledgerModal');'
  if (modal) {
    modal.remove();
  }
}

// === 5. เพิ่มฟังก์ชันค้นหาแบบ real-time ===
document.getElementById('search')?.addEventListener('input', function(e) {'
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.account-table tbody tr');'
  
  rows.forEach(row => {
    const code = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';'
    const name = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';'
    
    // แสดง/ซ่อนตามผลการค้นหา
    if (code.includes(searchTerm) || name.includes(searchTerm)) {
      row.style.display = '';'
      
      // แสดง parent rows ด้วย
      let parentLevel = parseInt(row.dataset.level) - 1;
      let prevRow = row.previousElementSibling;
      
      while (prevRow && parentLevel >= 0) {
        if (parseInt(prevRow.dataset.level) === parentLevel) {
          prevRow.classList.remove('hidden');'
          prevRow.style.display = '';'
          
          // เปลี่ยน icon เป็น expanded
          const icon = prevRow.querySelector('i.bi-caret-right-fill');'
          if (icon) {
            icon.classList.remove('bi-caret-right-fill');'
            icon.classList.add('bi-caret-down-fill');'
          }
          
          parentLevel--;
        }
        prevRow = prevRow.previousElementSibling;
      }
    } else {
      row.style.display = 'none';'
    }
  });
});

// === 6. เพิ่มฟังก์ชันสำหรับ Export ข้อมูล ===
async function exportToExcel() {
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    // ดึงข้อมูลทั้งหมด
    const response = await fetch('/api/accounts', {'
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (!response.ok) throw new Error('Failed to fetch accounts');'
    
    const data = await response.json();
    const accounts = data.data || data;
    
    // แปลงข้อมูลเป็น format สำหรับ Excel
    const exportData = accounts.map(acc => ({
      'รหัสบัญชี': acc.code,'
      'ชื่อบัญชี': acc.name,'
      'หมวดหมู่': getTypeLabel(acc.category),'
      'ยอดคงเหลือ': acc.balance || 0'
    }));
    
    // สร้าง workbook
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ผังบัญชี");
    
    // ดาวน์โหลดไฟล์
    XLSX.writeFile(wb, `chart_of_accounts_${new Date().toISOString().split('T')[0]}.xlsx`);'
    
    hideLoading();
    showSuccess('ส่งออกข้อมูลสำเร็จ');'
    
  } catch (error) {
    hideLoading();
    console.error('Export error:', error);'
    showError('ไม่สามารถส่งออกข้อมูลได้');'
  }
}


function importFromExcel() {
  const input = document.createElement('input');'
  input.type = 'file';'
  input.accept = '.xlsx,.xls';'
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
      
      // อ่านไฟล์
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);
      
      // แปลงข้อมูลกลับเป็น format API
      const accounts = jsonData.map(row => ({
        code: row['รหัสบัญชี'],'
        name: row['ชื่อบัญชี'],'
        category: getCategoryFromThai(row['หมวดหมู่']),'
        balance: row['ยอดคงเหลือ'] || 0'
      }));
      
      // ส่งข้อมูลไป API
      const response = await fetch('/api/accounts/import', {'
        method: 'POST','
        headers: {
          'Content-Type': 'application/json','
          'Authorization': `Bearer ${localStorage.getItem('token')}`'
        },
        body: JSON.stringify({ accounts })
      });
      
      if (!response.ok) throw new Error('Import failed');'
      
      const result = await response.json();
      
      hideLoading();
      showSuccess(`นำเข้าข้อมูลสำเร็จ ${result.imported || accounts.length} รายการ`);
      
      // โหลดข้อมูลใหม่
      await loadChartOfAccounts();
      
    } catch (error) {
      hideLoading();
      console.error('Import error:', error);'
      showError('ไม่สามารถนำเข้าข้อมูลได้');'
    }
  };
  
  input.click();
}

// === 8. เพิ่มฟังก์ชันกรองตามหมวดหมู่ ===
function filterByCategory(category) {
  const rows = document.querySelectorAll('.account-table tbody tr');'
  
  rows.forEach(row => {
    if (category === 'all') {'
      row.style.display = '';'
    } else {
      const rowCategory = row.querySelector('td:nth-child(3) span')?.textContent;'
      const categoryMap = {
        'Asset': 'สินทรัพย์','
        'Liabilities': 'หนี้สิน','
        'Equity': 'ส่วนของเจ้าของ','
        'Income': 'รายได้','
        'Expense': 'ค่าใช้จ่าย''
      };
      
      if (categoryMap[category] === rowCategory) {
        row.style.display = '';'
      } else {
        row.style.display = 'none';'
      }
    }
  });
}
    // Function to toggle submenus
function toggleSubmenu(event) {
  event.stopPropagation();
  const wrapper = event.currentTarget;
  const tr = wrapper.closest('tr');'
  if (!tr) return;

  const icon = wrapper.querySelector('i');'
  const accountId = tr.dataset.accountId;

  // Toggle icon
  const isExpanded = icon.classList.contains('bi-caret-down-fill');'
  icon.classList.toggle('bi-caret-right-fill', isExpanded);'
  icon.classList.toggle('bi-caret-down-fill', !isExpanded);'

  // ฟังก์ชันเพื่อซ่อน/แสดง children แบบ recursive
  function toggleDescendants(parentId, shouldHide) {
    // ใช้ data-parent-id (ซึ่งจะถูกแปลงเป็น dataset.parentId โดย JavaScript)
    const children = document.querySelectorAll(`tr[data-parent-id="${parentId}"]`);
    
    children.forEach(child => {
      child.classList.toggle('hidden', shouldHide);'
      
      // ถ้ากำลังซ่อน ให้ reset icon และซ่อน descendants ของ child ด้วย
      if (shouldHide) {
        const childIcon = child.querySelector('i.bi-caret-down-fill');'
        if (childIcon) {
          childIcon.classList.remove('bi-caret-down-fill');'
          childIcon.classList.add('bi-caret-right-fill');'
        }
        // Recursive call เพื่อซ่อน descendants
        toggleDescendants(child.dataset.accountId, true);
      }
    });
  }

  // Toggle direct children และ descendants
  toggleDescendants(accountId, isExpanded);
}


document.querySelectorAll('.filter-option').forEach(option => {'
  option.addEventListener('click', function() {'
    const filterType = this.dataset.filter;
    filterByCategory(filterType);
    
    // Update active state
    document.querySelectorAll('.filter-option').forEach(opt => {'
      opt.classList.remove('active');'
      opt.querySelector('i').className = 'bi bi-square';'
    });
    this.classList.add('active');'
    this.querySelector('i').className = 'bi bi-check';'
  });
});

    // Inject the menu template into the mainMenuContainer
    document.addEventListener('DOMContentLoaded', async () => {'
      const pageLoaderId = LoadingSystem.show({
        message: 'กำลังโหลดหน้าเว็บ...','
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
  // 1. โหลดเมนู
  const menuTemplate = document.getElementById('mainMenuTemplate');'
  const menuContainer = document.getElementById('mainMenuContainer');'
  if (menuTemplate && menuContainer) {
    menuContainer.innerHTML = menuTemplate.innerHTML;
  }
  
  // 2. โหลดข้อมูลผู้ใช้
  await loadEmployeeProfile();
  
  // 3. โหลดข้อมูลผังบัญชี (ซึ่งจะเรียก loadAccountsSummary อัตโนมัติ)
  await loadChartOfAccounts();
  
  // 4. Initialize dark mode
  const darkMode = localStorage.getItem('darkMode');'
  if (darkMode === 'true') {'
    document.documentElement.classList.add('dark');'
    const themeIcon = document.getElementById('themeIcon');'
    const darkModeLabel = document.getElementById('darkModeLabel');'
    if (themeIcon) {
      themeIcon.className = 'bi bi-sun-fill mr-2 text-yellow-300';'
    }
    if (darkModeLabel) {
      darkModeLabel.textContent = 'Light Mode';'
    }
  }
  
  // 5. Dark mode toggle event
  // Dark Mode Toggle
document.getElementById('btnToggleDark')?.addEventListener('click', function() {'
  try {
    // Toggle dark mode class
    document.documentElement.classList.toggle('dark');'
    const isDark = document.documentElement.classList.contains('dark');'
    
    // Get elements
    const themeIcon = document.getElementById('themeIcon');'
    const darkModeLabel = document.getElementById('darkModeLabel');'
    
    if (!themeIcon || !darkModeLabel) {
      console.warn('Theme icon or label not found');'
      return;
    }
    
    // Update UI based on mode
    if (isDark) {
      // Dark mode is ON
      themeIcon.className = 'bi bi-sun-fill mr-2 text-yellow-300';'
      darkModeLabel.textContent = 'Light Mode';'
      localStorage.setItem('darkMode', 'true');'
      
      // Optional: Add transition effect
      document.body.style.transition = 'background-color 0.3s ease';'
    } else {
      // Dark mode is OFF
      themeIcon.className = 'bi bi-moon-stars-fill mr-2 text-gray-700';'
      darkModeLabel.textContent = 'Dark Mode';'
      localStorage.setItem('darkMode', 'false');'
    }
    
    // Dispatch custom event for other components that might need to know
    window.dispatchEvent(new CustomEvent('darkModeChanged', { '
      detail: { isDark } 
    }));
    
  } catch (error) {
    console.error('Error toggling dark mode:', error);'
  }
});

// Optional: Listen for dark mode changes in other components
window.addEventListener('darkModeChanged', (event) => {'
  console.log('Dark mode changed:', event.detail.isDark);'
  // อัพเดท components อื่นๆ ถ้าจำเป็น
});

  // 6. Logout button event
  document.getElementById('btnLogout')?.addEventListener('click', function() {'
    // Clear all localStorage items
    localStorage.removeItem('token');'
    localStorage.removeItem('authToken');'
    localStorage.removeItem('userId');'
    localStorage.removeItem('userName');'
    localStorage.removeItem('darkMode');'
    
    // Redirect to login
    window.location.href = '/login';'
  });
});
  
}</script>
      
  

    <!-- ส่วนเนื้อหา (Main Content) -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">ผังบัญชี</h1>
        
        <!-- Header Actions -->
        <div class="flex items-center space-x-3">
          <!-- Notifications -->
          <div class="relative">
            <button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
              <i class="bi bi-bell"></i>
              <span class="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center">2</span>
            </button>
          </div>
          
          <!-- Help -->
          <button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <i class="bi bi-question-circle"></i>
          </button>
        </div>
      </header>

   

        <!-- สรุปยอดรวม (5 หมวด) -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-6 animate-fadeIn">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                ทั้งหมด 94 
                <span class="text-gray-500 dark:text-gray-400 text-xl">รายการบัญชี</span>
              </h1>
            </div>
            <div class="text-right">
              <span class="text-sm text-gray-600 dark:text-gray-400">ปีบัญชี 2568</span>
            </div>
          </div>
        </div>

        <!-- การ์ดสรุป 5 หมวด -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
          <!-- สินทรัพย์ -->
          <div class="stat-card bg-white dark:bg-gray-800 border-l-4 border-blue-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700 dark:text-gray-300">สินทรัพย์</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600 dark:text-gray-400">76 รายการ</div>
              <div class="text-lg font-semibold text-blue-600 dark:text-blue-400">฿00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-blue-500 h-1.5 rounded-full" style="width: 35%"></div>
              </div>
            </div>
          </div>
          
          <!-- หนี้สิน -->
          <div class="stat-card bg-white dark:bg-gray-800 border-l-4 border-red-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700 dark:text-gray-300">หนี้สิน</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600 dark:text-gray-400">37 รายการ</div>
              <div class="text-lg font-semibold text-red-600 dark:text-red-400">฿00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-red-500 h-1.5 rounded-full" style="width: 32%"></div>
              </div>
            </div>
          </div>
          
          <!-- ส่วนของผู้ถือหุ้น -->
          <div class="stat-card bg-white dark:bg-gray-800 border-l-4 border-purple-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700 dark:text-gray-300">ส่วนของผู้ถือหุ้น</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600 dark:text-gray-400">4 รายการ</div>
              <div class="text-lg font-semibold text-purple-600 dark:text-purple-400">฿00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-purple-500 h-1.5 rounded-full" style="width: 3%"></div>
              </div>
            </div>
          </div>
          
          <!-- รายได้ -->
          <div class="stat-card bg-white dark:bg-gray-800 border-l-4 border-green-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700 dark:text-gray-300">รายได้</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600 dark:text-gray-400">20 รายการ</div>
              <div class="text-lg font-semibold text-green-600 dark:text-green-400">฿00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-green-500 h-1.5 rounded-full" style="width: 18%"></div>
              </div>
            </div>
          </div>
          
          <!-- ค่าใช้จ่าย -->
          <div class="stat-card bg-white dark:bg-gray-800 border-l-4 border-yellow-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700 dark:text-gray-300">ค่าใช้จ่าย</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600 dark:text-gray-400">153 รายการ</div>
              <div class="text-lg font-semibold text-yellow-600 dark:text-yellow-400">฿00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-yellow-500 h-1.5 rounded-full" style="width: 12%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- แถบค้นหา/ตัวกรอง -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <!-- การค้นหาและตัวกรอง -->
            <div class="flex-1 min-w-[250px]">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <i class="bi bi-search text-gray-400"></i>
                </div>
                <input 
                  type="text" 
                  id="search" 
                  class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500" 
                  placeholder="ค้นหาบัญชี..."
                >
              </div>
            </div>
            
            <!-- ตัวกรอง -->
            <div class="dropdown dropdown-hover">
              <label tabindex="0" class="btn btn-outline btn-sm">
                <i class="bi bi-funnel mr-2"></i>
                ตัวกรอง
              </label>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-white dark:bg-gray-800 rounded-lg w-52 z-20">
                <li class="menu-title"><span>หมวดหมู่</span></li>
                <li><a class="active"><i class="bi bi-check"></i> ทั้งหมด</a></li>
                <li><a><i class="bi bi-square"></i> สินทรัพย์</a></li>
                <li><a><i class="bi bi-square"></i> หนี้สิน</a></li>
                <li><a><i class="bi bi-square"></i> ส่วนของผู้ถือหุ้น</a></li>
                <li><a><i class="bi bi-square"></i> รายได้</a></li>
                <li><a><i class="bi bi-square"></i> ค่าใช้จ่าย</a></li>
              </ul>
            </div>

            <div class="flex items-center gap-2">
  <button onclick="exportToExcel()" class="btn btn-outline btn-sm">
    <i class="bi bi-download mr-2"></i> ส่งออก Excel
  </button>
  <button onclick="importFromExcel()" class="btn btn-outline btn-sm">
    <i class="bi bi-upload mr-2"></i> นำเข้า Excel
  </button>
</div>
            <!-- ปุ่มเพิ่มข้อมูล -->
            <button 
              id="btnAddAccount" 
              class="btn btn-primary btn-sm"
              onclick="openAddAccountModal()"
            >
              <i class="bi bi-plus-circle mr-2"></i> เพิ่มข้อมูล
            </button>
          </div>
        </div>

        <!-- Modal Popup for Adding New Account -->
        <div id="addAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-hidden="true" role="dialog">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md p-6 relative">
            <button 
 
              class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100"
              onclick="closeAddAccountModal()"
              aria-label="Close"
            >
              <i class="bi bi-x-circle"></i>
            </button>
            <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">เพิ่มข้อมูลบัญชี</h2>
            <form id="addAccountForm">
              <div class="mb-4">
                <label for="accountName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ชื่อบัญชี</label>
                <input 
                  type="text" 
                  id="accountName" 
                  class="form-control" 
                  placeholder="กรอกชื่อบัญชี" 
                  required
                >
                <small id="accountNameError" class="text-red-500 hidden">กรุณากรอกชื่อบัญชี</small>
              </div>
              <div class="mb-4">
                <label for="accountNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">เลขที่บัญชี</label>
                <input 
                  type="text" 
                  id="accountNumber" 
                  class="form-control" 
                  placeholder="กรอกเลขที่บัญชี" 
                  required
                >
                <small id="accountNumberError" class="text-red-500 hidden">กรุณากรอกเลขที่บัญชี</small>
              </div>
              <div class="mb-4">
                <label for="accountCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300">หมวดหมู่</label>
                <select id="accountCategory" class="form-control" required>
                  <option value="สินทรัพย์">สินทรัพย์</option>
                  <option value="หนี้สิน">หนี้สิน</option>
                  <option value="ส่วนของผู้ถือหุ้น">ส่วนของผู้ถือหุ้น</option>
                  <option value="รายได้">รายได้</option>
                  <option value="ค่าใช้จ่าย">ค่าใช้จ่าย</option>
                </select>
              </div>
              <div class="flex justify-end gap-2">
                <button 
                  type="button" 
                  class="btn btn-outline btn-sm"
                  onclick="closeAddAccountModal()"
                >
                  ยกเลิก
                </button>
                <button 
                  type="submit" 
                  class="btn btn-primary btn-sm"
                >
                  บันทึก
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Modal สำหรับแก้ไขบัญชี -->
<div id="editAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-hidden="true" role="dialog">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button 
      class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100"
      onclick="closeEditAccountModal()"
      aria-label="Close"
    >
      <i class="bi bi-x-circle"></i>
    </button>
    <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">แก้ไขข้อมูลบัญชี</h2>
    <form id="editAccountForm">
      <input type="hidden" id="editAccountId">
      <div class="mb-4">
        <label for="editAccountName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ชื่อบัญชี</label>
        <input 
          type="text" 
          id="editAccountName" 
          class="form-control" 
          placeholder="กรอกชื่อบัญชี" 
          required
        >
      </div>
      <div class="mb-4">
        <label for="editAccountNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">เลขที่บัญชี</label>
        <input 
          type="text" 
          id="editAccountNumber" 
          class="form-control" 
          placeholder="กรอกเลขที่บัญชี" 
          readonly
        >
      </div>
      <div class="mb-4">
        <label for="editAccountCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300">หมวดหมู่</label>
        <select id="editAccountCategory" class="form-control" required>
          <option value="Asset">สินทรัพย์</option>
          <option value="Liabilities">หนี้สิน</option>
          <option value="Equity">ส่วนของผู้ถือหุ้น</option>
          <option value="Income">รายได้</option>
          <option value="Expense">ค่าใช้จ่าย</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="editAccountParent" class="block text-sm font-medium text-gray-700 dark:text-gray-300">บัญชีหลัก</label>
        <select id="editAccountParent" class="form-control">
          <option value="">-- ไม่มีบัญชีหลัก --</option>
          <!-- Options จะถูกเติมด้วย JavaScript -->
        </select>
      </div>
      <div class="flex justify-end gap-2">
        <button 
          type="button" 
          class="btn btn-outline btn-sm"
          onclick="closeEditAccountModal()"
        >
          ยกเลิก
        </button>
        <button 
          type="submit" 
          class="btn btn-primary btn-sm"
        >
          บันทึก
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal for Adding Sub Account -->
<div id="addSubAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button 
      class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100"
      onclick="closeAddSubAccountModal()"
    >
      <i class="bi bi-x-circle"></i>
    </button>
    <h2 class="text-lg font-semibold mb-4">เพิ่มบัญชีย่อย</h2>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
      บัญชีหลัก: <span id="parentAccountDisplay" class="font-semibold"></span>
    </p>
    <form id="addSubAccountForm">
      <input type="hidden" id="parentAccountId">
      <input type="hidden" id="parentAccountCategory">
      <div class="mb-4">
        <label for="subAccountCode" class="block text-sm font-medium mb-1">รหัสบัญชี</label>
        <input 
          type="text" 
          id="subAccountCode" 
          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
          placeholder="เช่น 1101"
          required
        >
      </div>
      <div class="mb-4">
        <label for="subAccountName" class="block text-sm font-medium mb-1">ชื่อบัญชี</label>
        <input 
          type="text" 
          id="subAccountName" 
          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
          placeholder="กรอกชื่อบัญชีย่อย"
          required
        >
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeAddSubAccountModal()" 
                class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300">
          ยกเลิก
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          บันทึก
        </button>
      </div>
    </form>
  </div>
</div>
        <script>
          // Open the modal
          function openAddAccountModal() {
            const modal = document.getElementById('addAccountModal');'
            modal.classList.remove('hidden');'
            modal.setAttribute('aria-hidden', 'false');'
          }

          // Close the modal
          function closeAddAccountModal() {
            const modal = document.getElementById('addAccountModal');'
            modal.classList.add('hidden');'
            modal.setAttribute('aria-hidden', 'true');'
          }

          // Close modal on outside click
          document.getElementById('addAccountModal').addEventListener('click', function(event) {'
            if (event.target === this) {
              closeAddAccountModal();
            }
          });

          document.getElementById('addAccountForm').addEventListener('submit', async function(event) {'
  event.preventDefault();

   // ✅ ย้ายการตรวจสอบ token มาไว้ใน function
  const AUTH_TOKEN = localStorage.getItem('token');'
  if (!AUTH_TOKEN) {
    showError('กรุณาเข้าสู่ระบบก่อนทำรายการ');'
    setTimeout(() => {
      window.location.href = '/login';'
    }, 2000);
    return; // ✅ ตอนนี้ return อยู่ใน function แล้ว
  }

  // Get form values
  const accountName = document.getElementById('accountName').value.trim();'
  const accountNumber = document.getElementById('accountNumber').value.trim();'
  const accountCategory = document.getElementById('accountCategory').value;'

  // Validate inputs
  let isValid = true;
  if (!accountName) {
    document.getElementById('accountNameError').classList.remove('hidden');'
    isValid = false;
  } else {
    document.getElementById('accountNameError').classList.add('hidden');'
  }

  if (!accountNumber) {
    document.getElementById('accountNumberError').classList.remove('hidden');'
    isValid = false;
  } else {
    document.getElementById('accountNumberError').classList.add('hidden');'
  }

  if (!isValid) return;

  try {
    // แสดง loading
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    // เตรียมข้อมูลสำหรับส่ง API
    const formData = {
      name: accountName,
      code: accountNumber,
      type: accountCategory,
      category: accountCategory,
      level: 0,
      parent_id: null,
      balance: 0,
      status: 'active''
    };
    
    // เรียก API เพื่อบันทึกข้อมูล
    const response = await fetch('/api/accounts', {'
  method: 'POST','
  headers: {
    'Content-Type': 'application/json','
    'Authorization': `Bearer ${localStorage.getItem('token')}`'
  },
  body: JSON.stringify({
    name: accountName,
    code: accountNumber,
    category: accountCategory, // ใช้ category ตาม Schema
    type: 'detail', // เพิ่ม type'
    level: 0,
    parentId: null,
    balance: 0,
    status: 'active''
  })
});
    
    // ถ้าสำเร็จ - เพิ่ม row ใหม่ในตาราง
    const tableBody = document.querySelector('.account-table tbody');'
    if (tableBody && response) {
      const newAccount = response.data || response;
      const newRow = createAccountRow(newAccount, 0);
      
      // หาตำแหน่งที่เหมาะสมตาม code
      const allRows = tableBody.querySelectorAll('tr[data-level="0"]');'
      let inserted = false;
      
      for (let row of allRows) {
        const rowCode = row.querySelector('td:nth-child(2)').textContent;'
        if (accountNumber < rowCode) {
          tableBody.insertBefore(newRow, row);
          inserted = true;
          break;
        }
      }
      
      // ถ้าไม่พบตำแหน่งที่เหมาะสม ให้เพิ่มท้ายสุด
      if (!inserted) {
        tableBody.appendChild(newRow);
      }
      
      // อัพเดทจำนวนในการ์ดสรุป
      await updateSummaryAfterAdd(accountCategory);
    }
    
    // ปิด modal และ reset form
    closeAddAccountModal();
    document.getElementById('addAccountForm').reset();'
    
    // ซ่อน loading
    hideLoading();
    
    // แสดงข้อความสำเร็จ
    showSuccess('เพิ่มบัญชี ' + accountNumber + ' - ' + accountName + ' สำเร็จ');'
    
  } catch (error) {
    // ซ่อน loading
    hideLoading();
    
    // จัดการ error
    console.error('Error adding account:', error);'
    
    // แสดง error message ที่เจาะจง
    let errorMessage = 'ไม่สามารถเพิ่มบัญชีได้';'
    
    if (error.message.includes('duplicate')) {'
      errorMessage = 'รหัสบัญชี ' + accountNumber + ' มีอยู่ในระบบแล้ว';'
    } else if (error.message.includes('network')) {'
      errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้';'
    } else if (error.message.includes('401')) {'
      errorMessage = 'กรุณาเข้าสู่ระบบใหม่';'
      setTimeout(() => {
        window.location.href = '/login';'
      }, 2000);
    }
    
    showError(errorMessage);
  }
});

// Functions สำหรับ Edit Account
function editAccount(id, name, code, category) {
  // เปิด modal และใส่ข้อมูล
  document.getElementById('editAccountId').value = id;'
  document.getElementById('editAccountName').value = name;'
  document.getElementById('editAccountNumber').value = code;'
  document.getElementById('editAccountCategory').value = category;'
  
  document.getElementById('editAccountModal').classList.remove('hidden');'
  document.getElementById('editAccountModal').setAttribute('aria-hidden', 'false');'
}

function closeEditAccountModal() {
  document.getElementById('editAccountModal').classList.add('hidden');'
  document.getElementById('editAccountModal').setAttribute('aria-hidden', 'true');'
  document.getElementById('editAccountForm').reset();'
}

// Close modal on outside click
document.getElementById('editAccountModal').addEventListener('click', function(event) {'
  if (event.target === this) {
    closeEditAccountModal();
  }
});

// Submit Edit Form
document.getElementById('editAccountForm').addEventListener('submit', async function(event) {'
  event.preventDefault();
  
  const id = document.getElementById('editAccountId').value;'
  const accountName = document.getElementById('editAccountName').value.trim();'
  const accountCategory = document.getElementById('editAccountCategory').value;'
  
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    const response = await fetch(`/api/accounts/${id}`, {
      method: 'PUT','
      headers: {
        'Content-Type': 'application/json','
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      },
      body: JSON.stringify({
        name: accountName,
        category: accountCategory
      })
    });
    
    if (!response.ok) {
      throw new Error('Failed to update account');'
    }
    
    closeEditAccountModal();
    hideLoading();
    showSuccess('แก้ไขบัญชีสำเร็จ');'
    
    // โหลดข้อมูลใหม่
    await loadChartOfAccounts();
    
  } catch (error) {
    hideLoading();
    console.error('Error updating account:', error);'
    showError('ไม่สามารถแก้ไขบัญชีได้');'
  }
});

// Function สำหรับ Delete Account
async function deleteAccount(id, code) {
  if (!confirm(`ต้องการลบบัญชี ${code} หรือไม่?`)) {
    return;
  }
  
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    const response = await fetch(`/api/accounts/${id}`, {
      method: 'DELETE','
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to delete account');'
    }
    
    hideLoading();
    showSuccess('ลบบัญชีสำเร็จ');'

    
    // โหลดข้อมูลใหม่
    await loadChartOfAccounts();
    
  } catch (error) {
    hideLoading();
    console.error('Error deleting account:', error);'
    showError('ไม่สามารถลบบัญชีได้ อาจมีรายการที่เกี่ยวข้อง');'
  }
}

// Function อัพเดทการ์ดสรุปหลังเพิ่มข้อมูล
async function updateSummaryAfterAdd(category) {
  try {
    // หาการ์ดที่ตรงกับ category
    let cardIndex;
    switch(category) {
      case 'สินทรัพย์': cardIndex =  1; break;'
      case 'หนี้สิน': cardIndex = 2; break;'
      case 'ส่วนของผู้ถือหุ้น': cardIndex = 3; break;'
      case 'รายได้': cardIndex = 4; break;'
      case 'ค่าใช้จ่าย': cardIndex = 5; break;'
    }
    
    if (cardIndex) {
      const card = document.querySelector(`.stat-card:nth-child(${cardIndex})`);
      if (card) {
        const countElement = card.querySelector('.text-sm');'
        const currentText = countElement.textContent;
        const currentCount = parseInt(currentText.match(/\d+/)[0]);
        countElement.textContent = `${currentCount + 1} รายการ`;
      }
    }
    
    // อัพเดทจำนวนรวม
    const totalElement = document.querySelector('.text-2xl.font-bold');'
    if (totalElement) {
      const currentTotal = parseInt(totalElement.textContent.match(/\d+/)[0]);
      totalElement.innerHTML = `
        ทั้งหมด ${currentTotal + 1} 
        <span class="text-gray-500 dark:text-gray-400 text-xl">รายการบัญชี</span>
      `;
    }
    
  } catch (error) {
    console.error('Error updating summary:', error);'
  }
}

async function viewAccountDetails(accountId) {
  try {
    const loaderId = LoadingSystem.show({
        message: 'กำลังโหลด...','
        showProgress: true,
        autoProgress: true
      });
    
    // เรียกข้อมูลรายการบัญชีแยกประเภท
    const response = await fetch(`/api/accounts/${accountId}/ledger`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    const ledgerData = await response.json();
    
    // แสดงใน Modal
    showAccountLedgerModal(ledgerData);
    
    hideLoading();
  } catch (error) {
    hideLoading();
    showError('ไม่สามารถโหลดข้อมูลได้');'
  }
}

// Expand All
// This will be replaced by the new DOMContentLoaded listener below
// document.getElementById('btnExpandAll')?.addEventListener('click', function() { ... });'

// Collapse All
// This will be replaced by the new DOMContentLoaded listener below
// document.getElementById('btnCollapseAll')?.addEventListener('click', function() { ... });'

function toggleChildren(parentRow, parentLevel, show) {
  let sibling = parentRow.nextElementSibling;
  
  while (sibling && parseInt(sibling.dataset.level) > parentLevel) {
    const siblingLevel = parseInt(sibling.dataset.level);
    
    if (siblingLevel === parentLevel + 1) {
      // Direct children
      sibling.classList.toggle('hidden', !show);'
      
      // Reset icon if hiding
      if (!show) {
        const icon = sibling.querySelector('i.bi-caret-down-fill');'
        if (icon) {
          icon.classList.remove('bi-caret-down-fill');'
          icon.classList.add('bi-caret-right-fill');'
        }
      }
    } else if (!show) {
      // Hide all descendants
      sibling.classList.add('hidden');'
    }
    
    sibling = sibling.nextElementSibling;
  }
}

// ✅ เพิ่ม Helper function สำหรับ format currency ที่ถูกต้อง
function formatCurrency(amount) {
  // ตรวจสอบว่าเป็นตัวเลขหรือไม่
  const numAmount = parseFloat(amount) || 0;
  
  return new Intl.NumberFormat('th-TH', {'
    style: 'currency','
    currency: 'THB','
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(numAmount);
}

// ✅ เพิ่ม Helper function สำหรับอัพเดท progress bar
function updateProgressBarForSummary(card, amount) {
  const progressBar = card.querySelector('.bg-blue-500, .bg-red-500, .bg-purple-500, .bg-green-500, .bg-yellow-500');'
  if (progressBar) {
    // คำนวณ percentage จากยอดเงิน (สมมติว่าเต็ม 100% = 1,000,000 บาท)
    const maxAmount = 1000000;
    const percentage = Math.min((amount / maxAmount) * 100, 100);
    progressBar.style.width = `${percentage}%`;
  }
}

async function loadAccountsSummaryFallback() {
  try {
    const res = await fetch('/api/chart-of-accounts', {'
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`'
      }
    });
    
    if (res.ok) {
      const jsonResponse = await res.json();
      const list = Array.isArray(jsonResponse.data) ? jsonResponse.data : jsonResponse;
      
      // นับจำนวนบัญชีแต่ละประเภท
      const summary = {
        assets: 0,
        liabilities: 0,
        equity: 0,
        income: 0,
        expenses: 0
      };
      
      list.forEach(account => {
        switch(account.category) {
          case 'Asset':'
            summary.assets++;
            break;
          case 'Liabilities':'
            summary.liabilities++;
            break;
          case 'Equity':'
            summary.equity++;
            break;
          case 'Income':'
            summary.income++;
            break;
          case 'Expense':'
            summary.expenses++;
            break;
        }
      });
      
      // อัพเดทการ์ด
      updateFallbackCards(summary);
      console.log('✅ Used fallback data from chart of accounts');'
    }
  } catch (error) {
    console.error('Fallback also failed:', error);'
  }
}

// ✅ Helper function สำหรับอัพเดทการ์ดด้วยข้อมูล fallback
function updateFallbackCards(summary) {
  // การ์ดสินทรัพย์
  const assetCard = document.querySelector('.stat-card:nth-child(1)');'
  if (assetCard) {
    assetCard.querySelector('.text-sm').textContent = `${summary.assets} รายการ`;'
    assetCard.querySelector('.text-lg').textContent = formatCurrency(0);'
  }
  
  // การ์ดหนี้สิน
  const liabCard = document.querySelector('.stat-card:nth-child(2)');'
  if (liabCard) {
    liabCard.querySelector('.text-sm').textContent = `${summary.liabilities} รายการ`;'
    liabCard.querySelector('.text-lg').textContent = formatCurrency(0);'
  }
  
  // การ์ดส่วนของผู้ถือหุ้น
  const equityCard = document.querySelector('.stat-card:nth-child(3)');'
  if (equityCard) {
    equityCard.querySelector('.text-sm').textContent = `${summary.equity} รายการ`;'
    equityCard.querySelector('.text-lg').textContent = formatCurrency(0);'
  }
  
  // การ์ดรายได้
  const incomeCard = document.querySelector('.stat-card:nth-child(4)');'
  if (incomeCard) {
    incomeCard.querySelector('.text-sm').textContent = `${summary.income} รายการ`;'
    incomeCard.querySelector('.text-lg').textContent = formatCurrency(0);'
  }
  
  // การ์ดค่าใช้จ่าย
  const expenseCard = document.querySelector('.stat-card:nth-child(5)');'
  if (expenseCard) {
    expenseCard.querySelector('.text-sm').textContent = `${summary.expenses} รายการ`;'
    expenseCard.querySelector('.text-lg').textContent = formatCurrency(0);'
  }
}

function formatDate(date) {
  return new Date(date).toLocaleDateString('th-TH');'
}

// Helper function สำหรับแปลงประเภทบัญชีเป็นภาษาไทย
function getTypeLabel(type) {
  const labels = {
    'Asset': 'สินทรัพย์','
    'Liabilities': 'หนี้สิน', '
    'Equity': 'ส่วนของเจ้าของ','
    'Income': 'รายได้','
    'Expense': 'ค่าใช้จ่าย''
  };
  return labels[type] || type;
}

function showAccountLedgerModal(data) {
  // สร้าง Modal แสดงรายการเคลื่อนไหว
  const modalHTML = `
    <div id="ledgerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-4xl max-h-[80vh] overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold">${data.accountCode} - ${data.accountName}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">ยอดคงเหลือ: ${formatCurrency(data.balance)}</p>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <table class="w-full">
            <thead>
              <tr class="border-b">
                <th class="text-left p-2">วันที่</th>
                <th class="text-left p-2">รายการ</th>
                <th class="text-right p-2">เดบิต</th>
                <th class="text-right p-2">เครดิต</th>
                <th class="text-right p-2">คงเหลือ</th>
              </tr>
            </thead>
            <tbody>
              ${data.entries.map(entry => `
                <tr class="border-b">
                  <td class="p-2">${formatDate(entry.date)}</td>
                  <td class="p-2">${entry.description}</td>
                  <td class="p-2 text-right">${entry.debit ? formatCurrency(entry.debit) : '-'}</td>'
                  <td class="p-2 text-right">${entry.credit ? formatCurrency(entry.credit) : '-'}</td>'
                  <td class="p-2 text-right">${formatCurrency(entry.balance)}</td>
                </tr>
              `).join('')}'
            </tbody>
          </table>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
          <button onclick="closeLedgerModal()" class="btn btn-outline">ปิด</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);'
}


// เพิ่ม function สำหรับ Expand/Collapse All
document.addEventListener('DOMContentLoaded', function() {'
      const pageLoaderId = LoadingSystem.show({
        message: 'กำลังโหลดหน้าเว็บ...','
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
  // เพิ่มปุ่ม Expand/Collapse All ใน UI
  const filterSection = document.querySelector('.dropdown.dropdown-hover');'
  if (filterSection && filterSection.parentNode) { // Check if parentNode exists
    const buttonContainer = document.createElement('div');'
    buttonContainer.className = 'flex items-center space-x-2 ml-2'; // Added ml-2 for spacing from filter'
    
    buttonContainer.innerHTML = `
      <button id="btnExpandAll" class="btn btn-outline btn-sm">
        <i class="bi bi-arrows-expand mr-2"></i>ขยายทั้งหมด
      </button>
      <button id="btnCollapseAll" class="btn btn-outline btn-sm">
        <i class="bi bi-arrows-collapse mr-2"></i>ยุบทั้งหมด
      </button>
    `;
    // Insert after the filter dropdown container
    filterSection.parentNode.insertBefore(buttonContainer, filterSection.nextSibling);
  }


  // Event listeners สำหรับ Expand/Collapse All
  document.getElementById('btnExpandAll')?.addEventListener('click', function() {'
    const allRows = document.querySelectorAll('.account-table tbody tr[data-level]');'
    const allIcons = document.querySelectorAll('.account-table tbody .bi-caret-right-fill, .account-table tbody .bi-caret-down-fill');'
    
    // แสดงทุกแถว
    allRows.forEach(row => {
      row.classList.remove('hidden');'
    });
    
    // เปลี่ยน icon เป็น expanded สำหรับแถวที่มี children
    allIcons.forEach(icon => {
      const parentRow = icon.closest('tr');'
      if (parentRow && parentRow.dataset.accountId) {
        const accountId = parentRow.dataset.accountId;
        // ตรวจสอบว่ามี children หรือไม่
        const hasChildren = Array.from(allRows).some(r => r.dataset.parentId === accountId);
        if(hasChildren) {
          icon.classList.remove('bi-caret-right-fill');'
          icon.classList.add('bi-caret-down-fill');'
        }
      }
    });
  });

  document.getElementById('btnCollapseAll')?.addEventListener('click', function() {'
    const allRows = document.querySelectorAll('.account-table tbody tr[data-level]');'
    const allIcons = document.querySelectorAll('.account-table tbody .bi-caret-right-fill, .account-table tbody .bi-caret-down-fill');'
    
    // ซ่อนทุกแถวที่ level > 0
    allRows.forEach(row => {
      if (parseInt(row.dataset.level) > 0) {
        row.classList.add('hidden');'
      }
    });
    
    // เปลี่ยน icon เป็น collapsed สำหรับแถวที่มี children
    allIcons.forEach(icon => {
       const parentRow = icon.closest('tr');'
       if (parentRow && parentRow.dataset.accountId) {
          const accountId = parentRow.dataset.accountId;
          const hasChildren = Array.from(allRows).some(r => r.dataset.parentId === accountId);
           if(hasChildren){
            icon.classList.remove('bi-caret-down-fill');'
            icon.classList.add('bi-caret-right-fill');'
           }
       }
    });
  });
});
        
}</script>

        <!-- ตารางผังบัญชี -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden mb-6">
          <!-- หัวตาราง -->
          <div class="border-b border-gray-200 dark:border-gray-700 p-4">
            <h2 class="font-semibold text-gray-900 dark:text-white">รายการบัญชีทั้งหมด</h2>
          </div>
          
          <!-- ตาราง -->
          <div class="table-container">
            <table class="account-table w-full">
  <thead>
  <tr class="text-left">
    <th class="p-4 border-b border-gray-200 dark:border-gray-700">ชื่อบัญชี</th>
    <th class="p-4 border-b border-gray-200 dark:border-gray-700">เลขที่บัญชี</th>
    <th class="p-4 border-b border-gray-200 dark:border-gray-700">หมวดหมู่</th>
    <th class="p-4 border-b border-gray-200 dark:border-gray-700 text-right">จัดการ</th> <!-- เพิ่มคอลัมน์นี้ -->
  </tr>
</thead>

<tbody id="accountsTableBody">
  <!-- ข้อมูลจะถูก render ด้วย JavaScript -->
</tbody>


          
          <!-- Pagination -->
          <div class="p-4 flex flex-wrap gap-4 items-center justify-between border-t border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              แสดง 1-20 จากทั้งหมด 94 รายการ
            </div>
            
            <div class="btn-group">
              <button class="btn btn-sm btn-outline">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button class="btn btn-sm btn-outline btn-active">1</button>
              <button class="btn btn-sm btn-outline">2</button>
              <button class="btn btn-sm btn-outline">3</button>
              <button class="btn btn-sm btn-outline">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



<!-- Footer -->
<footer class="bg-white dark:bg-gray-800 py-3 px-6 shadow-inner border-t border-gray-200 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400">
  © 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์.
</footer>
</body>
</html>