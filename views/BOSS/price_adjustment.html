<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบหลัก - Main Home</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- ตรวจสอบการล็อกอิน: หากไม่มี authToken ให้รีไดเร็กไปที่ login -->
  <script>
    if (!localStorage.getItem('authToken')) {'
      window.location.href = '/login';'
    }
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- 1) โหลด Tailwind CSS CDN ก่อน -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) ค่อยกำหนดค่า Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class','
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],'
          },
          colors: {
            primary: {
              50: '#f0f9ff','
              100: '#e0f2fe','
              200: '#bae6fd','
              300: '#7dd3fc','
              400: '#38bdf8','
              500: '#0ea5e9','
              600: '#0284c7','
              700: '#0369a1','
              800: '#075985','
              900: '#0c4a6e','
            },
            secondary: {
              50: '#f8fafc','
              100: '#f1f5f9','
              200: '#e2e8f0','
              300: '#cbd5e1','
              400: '#94a3b8','
              500: '#64748b','
              600: '#475569','
              700: '#334155','
              800: '#1e293b','
              900: '#0f172a','
            },
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05)','
            'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)','
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],'
      },
    }
  </script>

  <!-- animate.css สำหรับเอฟเฟกต์ Toast + Dot -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    /* Custom styles */
    body {
      font-family: 'Prompt', sans-serif;'
    }
    
    .menu-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--tw-shadow-hover);
    }
    
    .badge-dot {
      transition: all 0.2s ease-in-out;
    }
    
    .activity-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    .dark ::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #3B82F6;
    }

    input:focus + .toggle-slider {
      box-shadow: 0 0 1px #3B82F6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    /* Tooltip Styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Form Input Styles */
    .form-input {
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .dark .form-input {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4a5568;
    }

    .form-input:focus {
      color: #495057;
      background-color: #fff;
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .dark .form-input:focus {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4299e1;
      box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
    }

  </style>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';'
    import { getDatabase, ref, onValue, set, push, serverTimestamp }
      from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';'
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",  // Fixed the truncated API key
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    // expose to window
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebaseSet = set;
    window.firebasePush = push;
    window.firebaseServerTimestamp = serverTimestamp;
  </script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <!-- Cart Badge Styles -->
  <style>
    .cart-badge {
      position: absolute; top: -4px; right: -4px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 2px 5px; border-radius: 9999px;
      min-width: 18px; text-align: center;
    }
    .notification-badge {
      position: absolute; top: -2px; right: -2px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 1px 4px; border-radius: 9999px;
      min-width: 16px; text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">

  <!-- Container สำหรับ Toast แจ้งเตือน -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Sidebar Menu -->
  <div id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-all duration-300 z-40 sidebar-transition overflow-y-auto">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/favicon/favicon-32x32.png" alt="Logo" class="h-8 w-8">
        <span class="text-xl font-bold text-primary-600 dark:text-primary-400">ระบบจัดการ</span>
      </div>
      <button onclick="toggleMenu()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- User Info in Sidebar -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
          <i class="bi bi-person-fill"></i>
        </div>
        <div>
          <div id="sidebarUserName" class="font-medium">Loading...</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar Menu Items -->
    <div class="py-4">
      <div class="px-4 mb-2 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">เมนูหลัก</div>
      <ul>
        <li>
          <a href="#" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-house-fill text-primary-500"></i>
            <span>หน้าแรก</span>
          </a>
        </li>
        <li>
          <a href="#" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-info-circle-fill text-primary-500"></i>
            <span>คู่มือการใช้งาน</span>
          </a>
        </li>
        <li>
          <a href="#" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-question-circle-fill text-primary-500"></i>
            <span>ช่วยเหลือ</span>
          </a>
        </li>
        <li>
          <a href="price_adjustment" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-tag-fill text-orange-500"></i>
            <span>ปรับราคาสินค้า</span>
          </a>
        </li>
      </ul>
      
      <div class="px-4 pt-4 pb-2 mt-4 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">ระบบงาน</div>
      <ul>
        <li>
          <a href="accounting_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-journal-text text-blue-500"></i>
              <span>งานบัญชี</span>
            </div>
            <span id="sidebar-dot-accounting" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="HR_Dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-people-fill text-green-500"></i>
              <span>ฝ่ายบุคคล</span>
            </div>
            <span id="sidebar-dot-hr" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="StockManagehome" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-box-fill text-yellow-500"></i>
              <span>คลังสินค้า</span>
            </div>
            <span id="sidebar-dot-stock" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="financial_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-bar-chart-fill text-red-500"></i>
              <span>รายงาน</span>
            </div>
            <span id="sidebar-dot-report" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="loan_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-credit-card-fill text-gray-500"></i>
              <span>สินเชื่อ</span>
            </div>
            <span id="sidebar-dot-loan" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="frontstore_index" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-shop-window text-blue-400"></i>
              <span>POS - ขายหน้าร้าน</span>
            </div>
            <span id="sidebar-dot-pos" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="gifts_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-gift-fill text-pink-500"></i>
              <span>ของแถม</span>
            </div>
            <span id="sidebar-dot-gifts" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Logout Button -->
    <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
      <button id="btnLogout" class="w-full py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg flex items-center justify-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
        <i class="bi bi-box-arrow-right"></i>
        <span>ออกจากระบบ</span>
      </button>
    </div>
  </div>
  
  <!-- Mobile Toggle -->
  <div class="fixed top-0 left-0 p-3 z-30 block md:hidden">
    <button id="btnToggleMenu" class="bg-white dark:bg-gray-800 p-2 rounded-lg shadow-lg">
      <i class="bi bi-chevron-right text-blue-600 dark:text-blue-400"></i>
    </button>
  </div>
  
  <!-- Main Content Area -->
  <div id="mainContent" class="flex-1 p-6 transition-all duration-300 ease-in-out">
    <!-- Top Bar -->
    <header class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-6 flex justify-between items-center">
      <div class="flex items-center">
        <h1 class="text-2xl font-heading font-bold text-gray-800 dark:text-gray-100">ปรับราคา</h1>
        <div class="ml-4 px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full font-medium">
          ปรับปรุงล่าสุด: วันนี้
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <!-- User Info -->
        <div class="flex items-center space-x-3">
          <div class="text-right mr-3">
            <div id="employeeName" class="font-medium text-gray-800 dark:text-gray-100">Loading...</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
          </div>
          <img id="employeePhoto" src="/images/default-avatar.png" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-primary-500">
        </div>
        
        <button id="btnDocSettings" class="btn px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center transition-colors">
          <i class="bi bi-gear-fill mr-2"></i> 
          <span>ตั้งค่าเอกสาร</span>
        </button>
      </div>
    </header>
    
    <!-- Document Settings Modal -->
    <input type="checkbox" id="docSettingsModal" class="modal-toggle hidden" />
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden" id="docSettingsModalWrapper">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">ตั้งค่าค่าธรรมเนียมเอกสาร</h3>
            <button id="closeDocSettingsBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          
          <div class="space-y-5">
            <!-- Global fee -->
            <div class="border dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-750">
              <div class="flex items-center space-x-2">
                <input type="radio" name="feeScope" id="scopeGlobal" checked class="w-4 h-4 accent-blue-600" />
                <label for="scopeGlobal" class="font-medium text-gray-700 dark:text-gray-200">ใช้กับทุกสินค้า</label>
              </div>
              <div class="flex items-center space-x-3 mt-3">
                <label class="w-32 text-gray-600 dark:text-gray-300">ค่าธรรมเนียม (฿):</label>
                <input type="number" id="globalDocFee" value="0" class="form-input" />
              </div>
            </div>
            
            <!-- Per‐item fee -->
            <div class="border dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-750">
              <div class="flex items-center space-x-2">
                <input type="radio" name="feeScope" id="scopePerItem" class="w-4 h-4 accent-blue-600" />
                <label for="scopePerItem" class="font-medium text-gray-700 dark:text-gray-200">กำหนดแยกรายสินค้า</label>
              </div>
              <p class="text-sm text-gray-500 mt-2">หลังบันทึกในตาราง จะปรากฏช่องให้กรอก "ค่าธรรมเนียมเอกสาร" แต่ละแถวเอง</p>
              
              <div id="perItemContainer" class="hidden mt-3 space-y-3">
                <label class="font-medium text-gray-600 dark:text-gray-300">เลือกสินค้า (ติ๊กได้หลายตัว):</label>
                <div id="itemList" class="max-h-40 overflow-y-auto border rounded-lg p-3 bg-white dark:bg-gray-700 shadow-inner">
                  <!-- JS จะเติม checkbox list ที่นี่ -->
                </div>
                <div class="flex items-center space-x-3">
                  <input type="number" id="perItemDocFee" placeholder="ค่าธรรมเนียม (฿)" class="form-input w-1/2" />
                  <div class="relative flex items-center">
                    <input type="color" id="perItemColorPicker" value="#fffa65" class="w-8 h-8 rounded cursor-pointer border" title="เลือกสีไฮไลท์" />
                    <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">สีไฮไลท์</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelDocSettings" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
              ยกเลิก
            </button>
            <button id="applyDocSettings" class="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
              <i class="bi bi-check2-circle mr-1"></i> บันทึก
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toggle Columns Control Panel -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 mb-6">
      <h2 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
        <i class="bi bi-sliders mr-2 text-blue-500"></i> แสดง/ซ่อน คอลัมน์
      </h2>
      <div class="flex flex-wrap items-center gap-5">
        <label class="flex items-center space-x-3 py-1">
          <div class="toggle-switch">
            <input type="checkbox" id="toggleDown" checked>
            <span class="toggle-slider"></span>
          </div>
          <span class="font-medium">ดาวน์</span>
        </label>
        <label class="flex items-center space-x-3 py-1">
          <div class="toggle-switch">
            <input type="checkbox" id="togglePayUse" checked>
            <span class="toggle-slider"></span>
          </div>
          <span class="font-medium">ผ่อนไปใช้</span>
        </label>
        <label class="flex items-center space-x-3 py-1">
          <div class="toggle-switch">
            <input type="checkbox" id="togglePayOff" checked>
            <span class="toggle-slider"></span>
          </div>
          <span class="font-medium">ผ่อนหมดรับ</span>
        </label>
      </div>
    </div>
    
    <!-- Products Table Card -->
    <section class="card mb-6">
      <!-- Card Header with Search -->
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center">
          <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center mb-4 lg:mb-0">
            <i class="bi bi-tag-fill mr-2 text-blue-500"></i> รายการสินค้าในสต๊อก
          </h2>
          <div class="w-full lg:w-auto">
            <div class="relative">
              <input 
                type="text" 
                id="searchInput" 
                placeholder="ค้นหาสินค้า..." 
                class="w-full lg:w-64 pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200"
              >
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="bi bi-search text-gray-400"></i>
              </div>
            </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              ค้นหาตามชื่อสินค้า, ราคา หรือรายละเอียดสินค้า
            </p>
          </div>
        </div>
      </div>
      
      <!-- Table Container with Enhanced Styling -->
      <div class="overflow-x-auto scrollbar-thin">
        <table id="priceTable" class="data-table min-w-full">
          <thead class="bg-gray-50 dark:bg-gray-750">
            <tr>
              <th class="text-left font-semibold text-gray-700 dark:text-gray-200 w-1/4">
                ชื่อสินค้า
              </th>
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/12">
                สด
              </th>
              
              <!-- คอลัมน์ "ดาวน์" ใส่คลาส toggle-down -->
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/5 toggle-down">
                <div class="flex flex-col">
                  <span>ดาวน์</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">(ขั้นต่ำ/งวด/ผ่อน/เดือน)</span>
                </div>
              </th>
              
              <!-- คอลัมน์ "ผ่อนไปใช้" ใส่คลาส toggle-payuse -->
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/5 toggle-payuse">
                <div class="flex flex-col">
                  <span>ผ่อนไปใช้</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">(เครดิต/งวด/เดือน)</span>
                </div>
              </th>
              
              <!-- คอลัมน์ "ผ่อนหมดรับ" ใส่คลาส toggle-payoff -->
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/6 toggle-payoff">
                ผ่อนหมดรับ
              </th>
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/6">
                <div class="tooltip">
                  DocFee
                  <span class="tooltip-text">ค่าธรรมเนียมเอกสาร</span>
                </div>
              </th>
              <th class="text-center font-semibold text-gray-700 dark:text-gray-200 w-1/12">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
            <!-- Table rows will be inserted here by JavaScript -->
            <tr>
              <td colspan="7" class="text-center py-10">
                <div class="flex flex-col items-center justify-center">
                  <div class="w-16 h-16 mb-4 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center animate-pulse">
                    <i class="bi bi-hourglass text-2xl text-gray-400 dark:text-gray-500"></i>
                  </div>
                  <p class="text-gray-500 dark:text-gray-400">กำลังโหลดข้อมูล...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination with Better Styling -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <div class="text-sm text-gray-500 dark:text-gray-400">
          แสดง <span id="itemStart">1</span>-<span id="itemEnd">3</span> จาก <span id="itemTotal">24</span> รายการ
        </div>
        <div class="flex items-center space-x-2">
          <button id="prevBtn" class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
            <i class="bi bi-chevron-left"></i>
          </button>
          <button id="pageInfo" class="px-3 py-2 text-sm">1 / 1</button>
          <button id="nextBtn" class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </section>
    
    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 text-center text-sm text-gray-600 dark:text-gray-400">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <p>© 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์.</p>
        <div class="flex items-center space-x-3 mt-2 md:mt-0">
          <span>เวอร์ชั่น 3.5.2</span>
          <span>•</span>
          <a href="#" class="hover:text-blue-500 transition-colors">คู่มือใช้งาน</a>
          <span>•</span>
          <a href="#" class="hover:text-blue-500 transition-colors">แจ้งปัญหา</a>
        </div>
      </div>
    </footer>
  </div>
  
  <!-- Confirm Modal -->
  <div id="confirmActionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
      <div class="p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-3">ยืนยันการกระทำ</h3>
        <p id="confirmActionText" class="py-4 text-gray-700 dark:text-gray-300">ข้อความยืนยันที่นี่</p>
        <div class="flex justify-end space-x-3 mt-4">
          <button id="cancelActionBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            ยกเลิก
          </button>
          <button id="okActionBtn" class="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
            ตกลง
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Success Toast Notification -->
  <div id="successToast" class="fixed right-4 bottom-4 bg-green-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-3 transform translate-y-16 opacity-0 transition-all duration-300 z-50">
    <i class="bi bi-check-circle-fill text-xl"></i>
    <div>
      <p id="successToastMessage" class="font-medium">บันทึกข้อมูลสำเร็จ</p>
    </div>
    <button id="closeSuccessToast" class="ml-4 text-white hover:text-green-200 transition-colors">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <!-- Toggle Sidebar Script -->
  <script>
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');'
      const mainContent = document.getElementById('mainContent');'
      const icon = document.querySelector('#btnToggleMenu i');'
      
      sidebar.classList.toggle('-translate-x-full');'
      mainContent.classList.toggle('ml-64');'
      mainContent.classList.toggle('ml-0');'
      icon.classList.toggle('bi-chevron-left');'
      icon.classList.toggle('bi-chevron-right');'
    }
    document.getElementById('btnToggleMenu')?.addEventListener('click', toggleMenu);'
  </script>

  <!-- Socket.IO Connect Script -->
  <script>
    const socket = io();
    socket.on('connect', () => {
      console.log('Socket.IO connected on set_branch_price page');
    });
    socket.on('disconnect', () => {
      console.warn('Socket.IO disconnected on set_branch_price page');
    });
  </script>

  <!-- Dark Mode Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggleDarkBtn = document.getElementById('btnToggleDark');
      const darkModeLabel = document.getElementById('darkModeLabel');

      // Check theme from localStorage and apply
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
        darkModeLabel.textContent = 'Light Mode';
      } else {
        document.documentElement.classList.remove('dark');
        darkModeLabel.textContent = 'Dark Mode';
      }

      // Toggle theme
      toggleDarkBtn?.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        if (document.documentElement.classList.contains('dark')) {
          localStorage.setItem('theme', 'dark');
          darkModeLabel.textContent = 'Light Mode';
        } else {
          localStorage.setItem('theme', 'light');
          darkModeLabel.textContent = 'Dark Mode';
        }
      });
    });
  </script>

  <!-- Modal Controls Script -->
  <script>
    // Document Settings Modal
    const docSettingsModal = document.getElementById('docSettingsModalWrapper');'
    const openDocSettings = document.getElementById('btnDocSettings');'
    const closeDocSettings = document.getElementById('closeDocSettingsBtn');'
    const cancelDocSettings = document.getElementById('cancelDocSettings');'
    const scopeGlobal = document.getElementById('scopeGlobal');'
    const scopePerItem = document.getElementById('scopePerItem');'
    const perItemContainer = document.getElementById('perItemContainer');'
    
    openDocSettings.addEventListener('click', () => {'
      docSettingsModal.classList.remove('hidden');'
      document.body.style.overflow = 'hidden';'
      populateItemList();
    });
    
    function closeDocSettingsModal() {
      docSettingsModal.classList.add('hidden');'
      document.body.style.overflow = 'auto';'
    }
    
    closeDocSettings.addEventListener('click', closeDocSettingsModal);'
    cancelDocSettings.addEventListener('click', closeDocSettingsModal);'
    
    // When clicking outside the modal content
    docSettingsModal.addEventListener('click', (e) => {'
      if (e.target === docSettingsModal) {
        closeDocSettingsModal();
      }
    });
    
    // Toggle perItemContainer visibility based on radio selection
    scopeGlobal.addEventListener('change', () => {'
      perItemContainer.classList.add('hidden');'
    });
    
    scopePerItem.addEventListener('change', () => {'
      perItemContainer.classList.remove('hidden');'
    });
    
    // Populate item list in the modal
    function populateItemList() {
      const itemList = document.getElementById('itemList');'
      itemList.innerHTML = '';'
      
      document.querySelectorAll('#priceTable tbody tr').forEach(tr => {'
        if (tr.cells && tr.cells.length > 0) {
          const name = tr.cells[0].textContent.trim();
          if (name && name !== "-") {
            const div = document.createElement('div');'
            div.className = 'flex items-center space-x-2 py-1';'
            div.innerHTML = `
              <input type="checkbox" class="item-select w-4 h-4 accent-blue-600" value="${name}" id="item-${name.replace(/\s+/g, '-')}" />'
              <label for="item-${name.replace(/\s+/g, '-')}" class="cursor-pointer">${name}</label>'
            `;
            itemList.appendChild(div);
          }
        }
      });
    }
    
    // Confirm Action Modal
    function customConfirm(message, actionCallback) {
      const modal = document.getElementById('confirmActionModal');'
      const messageEl = document.getElementById('confirmActionText');'
      const okBtn = document.getElementById('okActionBtn');'
      const cancelBtn = document.getElementById('cancelActionBtn');'
      
      messageEl.textContent = message;
      modal.classList.remove('hidden');'
      document.body.style.overflow = 'hidden';'
      
      const handleOk = () => {
        if (typeof actionCallback === 'function') actionCallback();'
        closeConfirmModal();
      };
      
      const closeConfirmModal = () => {
        modal.classList.add('hidden');'
        document.body.style.overflow = 'auto';'
        okBtn.removeEventListener('click', handleOk);'
      };
      
      okBtn.addEventListener('click', handleOk, { once: true });'
      cancelBtn.addEventListener('click', closeConfirmModal);'
      
      // Close when clicking outside
      modal.addEventListener('click', (e) => {'
        if (e.target === modal) closeConfirmModal();
      }, { once: true });
    }
    
    // Success Toast
    function showSuccessToast(message) {
      const toast = document.getElementById('successToast');'
      const messageEl = document.getElementById('successToastMessage');'
      const closeBtn = document.getElementById('closeSuccessToast');'
      
      messageEl.textContent = message;
      toast.classList.remove('translate-y-16', 'opacity-0');'
      
      const hideToast = () => {
        toast.classList.add('translate-y-16', 'opacity-0');'
      };
      
      closeBtn.addEventListener('click', hideToast, { once: true });'
      
      // Auto hide after 3 seconds
      setTimeout(hideToast, 3000);
    }
  </script>

  <!-- Table Logic Script -->
  <script>
    // Format number with commas and decimals
    function formatNumber(num) {
      return new Intl.NumberFormat("th-TH", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(num);
    }
    
    // Apply document settings
    document.getElementById('applyDocSettings').addEventListener('click', () => {'
      const isGlobal = document.getElementById('scopeGlobal').checked;'
      const globalFee = parseFloat(document.getElementById('globalDocFee').value) || 0;'

      if (isGlobal) {
        // Apply to all rows
        document.querySelectorAll('input[data-field="docFee"]').forEach(inp => {'
          inp.value = globalFee.toFixed(2);
          inp.dispatchEvent(new Event('input'));'
          inp.closest('tr').style.backgroundColor = '';'
          inp.closest('tr').style.transition = 'background-color 0.5s ease';'
        });
        showSuccessToast(`ตั้งค่าธรรมเนียมเอกสาร ${globalFee.toFixed(2)} บาท สำหรับทุกสินค้า`);
      } else {
        // Apply per item
        const fee = parseFloat(document.getElementById('perItemDocFee').value) || 0;'
        const color = document.getElementById('perItemColorPicker').value;'
        let appliedCount = 0;

        document.querySelectorAll('#itemList .item-select:checked').forEach(cb => {'
          document.querySelectorAll('#priceTable tbody tr').forEach(tr => {'
            if (tr.cells[0].textContent.trim() === cb.value) {
              const inp = tr.querySelector('input[data-field="docFee"]');'
              inp.value = fee.toFixed(2);
              inp.dispatchEvent(new Event('input'));'
              tr.style.backgroundColor = color + '50'; // Add transparency'
              tr.style.transition = 'background-color 0.5s ease';'
              appliedCount++;
            }
          });
        });
        
        showSuccessToast(`ตั้งค่าธรรมเนียมเอกสาร ${fee.toFixed(2)} บาท สำหรับ ${appliedCount} สินค้า`);
      }

      // Close modal
      closeDocSettingsModal();
    });

    // Toggle column visibility
    document.addEventListener('DOMContentLoaded', function() {'
      // Toggle "ดาวน์"
      const chkDown = document.getElementById('toggleDown');'
      chkDown.addEventListener('change', function() {'
        document.querySelectorAll('.toggle-down').forEach(el => {'
          el.style.display = this.checked ? '' : 'none';'
        });
      });

      // Toggle "ผ่อนไปใช้"
      const chkPayUse = document.getElementById('togglePayUse');'
      chkPayUse.addEventListener('change', function() {'
        document.querySelectorAll('.toggle-payuse').forEach(el => {'
          el.style.display = this.checked ? '' : 'none';'
        });
      });

      // Toggle "ผ่อนหมดรับ"
      const chkPayOff = document.getElementById('togglePayOff');'
      chkPayOff.addEventListener('change', function() {'
        document.querySelectorAll('.toggle-payoff').forEach(el => {'
          el.style.display = this.checked ? '' : 'none';'
        });
      });
    });

    // Main initialization
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("authToken");
      if (!token) {
        customConfirm("ยังไม่ได้เข้าสู่ระบบ", () => {
          window.location.href = "login.html";
        });
        return;
      }

      // Load employee profile
      await loadEmployeeProfile();
      
      // Then load pricing data
      loadPricingData();

      // Search functionality
      const searchInput = document.getElementById('searchInput');'
      searchInput.addEventListener('input', function() {'
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#priceTable tbody tr');'
        
        rows.forEach(row => {
          const productName = row.cells[0]?.textContent.toLowerCase() || '';'
          if (productName.includes(searchTerm)) {
            row.style.display = '';'
          } else {
            row.style.display = 'none';'
          }
        });
      });

      // ปุ่ม Logout
      document.getElementById("btnLogout").addEventListener("click", () => {
        customConfirm("คุณต้องการออกจากระบบใช่หรือไม่?", () => {
          localStorage.removeItem("authToken");
          localStorage.removeItem("userEmail");
          window.location.href = "login.html";
        });
      });
    });
    
    // Load employee profile
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');'
        if (!token) return;

        const res = await fetch('/api/users/me', {'
          headers: { 
            'Authorization': 'Bearer ' + token,'
            'Content-Type': 'application/json''
          },
        });
        const result = await res.json();
        if (!res.ok || !result.success) {
          throw new Error(result.error || 'ไม่สามารถดึงข้อมูลผู้ใช้');'
        }

        const user = result.data;
        // Update name
        document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';'
        document.getElementById('sidebarUserName').textContent = user.name || '(ไม่พบชื่อ)';'

        // Update photo
        let photoUrl = user.photoUrl || '/images/default-avatar.png';'
        if (!photoUrl.startsWith('/') && !/^https?:\/\//.test(photoUrl)) {'
          photoUrl = '/' + photoUrl;'
        }
        document.getElementById('employeePhoto').src = photoUrl;'
      } catch (err) {
        console.error('Load Employee Profile Error:', err);'
      }
    }
    
    // Load pricing data
    async function loadPricingData() {
      const token = localStorage.getItem("authToken");
      try {
        // Show loading indicator
        document.querySelector("#priceTable tbody").innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-10">
              <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 mb-4 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center animate-pulse">
                  <i class="bi bi-hourglass text-2xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">กำลังโหลดข้อมูล...</p>
              </div>
            </td>
          </tr>
        `;
        
        const res = await fetch("/api/product-image/pricing", {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        
        if (!res.ok || data.status !== "success") {
          throw new Error(data.error || "ไม่สามารถโหลดข้อมูลราคา");
        }
        
        // Store all products
        allProducts = data.data || [];
        filteredProducts = [...allProducts];
        
        // Initial render
        renderTablePage();
        updatePagination();
        
        // Set up event listeners for pagination
        document.getElementById('prevBtn').addEventListener('click', () => {'
          if (currentPage > 1) {
            currentPage--;
            renderTablePage();
            updatePagination();
          }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {'
          const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            renderTablePage();
            updatePagination();
          }
        });
        
        // Set up search functionality
        document.getElementById('searchInput').addEventListener('input', searchProducts);'
        
      } catch (err) {
        console.error("Error loading pricing data:", err);
        document.querySelector("#priceTable tbody").innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-10">
              <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 mb-4 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center">
                  <i class="bi bi-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <p class="text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">${err.message}</p>
              </div>
            </td>
          </tr>
        `;
      }
    }
    
    // Render table with pricing data
    function renderTable(stocks) {
      const tbody = document.querySelector("#priceTable tbody");
      tbody.innerHTML = "";

      if (!stocks || stocks.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="7" class="text-center py-10">
            <div class="flex flex-col items-center justify-center">
              <div class="w-16 h-16 mb-4 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                <i class="bi bi-inbox text-2xl text-gray-400 dark:text-gray-500"></i>
              </div>
              <p class="text-gray-500 dark:text-gray-400">ไม่พบข้อมูลสินค้า</p>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
        return;
      }

      stocks.forEach((st) => {
        // Product name
        const productName = st.name || "-";
        // Price (cash)
        const price = typeof st.price === "number" ? st.price : 0;

        // Down payment
        const downAmount = typeof st.downAmount === "number" ? st.downAmount : 0;
        const downInstallmentCount = typeof st.downInstallmentCount === "number" ? st.downInstallmentCount : 0;
        const downInstallment = typeof st.downInstallment === "number" ? st.downInstallment : 0;

        // Pay and use
        const creditThreshold = typeof st.creditThreshold === "number" ? st.creditThreshold : 0;
        const payUseInstallmentCount = typeof st.payUseInstallmentCount === "number" ? st.payUseInstallmentCount : 0;
        const payUseInstallment = typeof st.payUseInstallment === "number" ? st.payUseInstallment : 0;

        // Pay off and receive
        const payOff = price + 2590;

        // Input class for styling
        const inputClass = `
          form-input text-right px-2 py-1.5 text-sm
          bg-white dark:bg-gray-700 
          text-gray-800 dark:text-gray-200
          border border-gray-300 dark:border-gray-600 
          rounded-md shadow-sm
          focus:border-blue-500 dark:focus:border-blue-400 
          focus:ring focus:ring-blue-200 dark:focus:ring-blue-800
          focus:ring-opacity-50
          transition-all duration-200
          w-full
        `;

        const tr = document.createElement("tr");
        tr.classList.add("hover:bg-gray-50", "dark:hover:bg-gray-750", "transition-colors");
        tr.innerHTML = `
          <!-- Product name column -->
          <td class="px-4 py-3">
            <div class="font-medium">${productName}</div>
          </td>

          <!-- Cash price column -->
          <td class="px-4 py-3">
            <input
              type="number"
              class="${inputClass}"
              value="${price.toFixed(2)}"
              data-field="price"
              data-action="update-payoff"
              step="0.01"
            />
          </td>

          <!-- Down payment column (toggle-down) -->
          <td class="px-4 py-3 toggle-down">
            <div class="grid grid-cols-3 gap-2">
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${downAmount.toFixed(2)}"
                  data-field="downAmount"
                  placeholder="ขั้นต่ำ"
                  step="0.01"
                />
                <span class="tooltip-text">ขั้นต่ำ</span>
              </div>
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${downInstallmentCount}"
                  data-field="downInstallmentCount"
                  placeholder="งวด"
                />
                <span class="tooltip-text">จำนวนงวด</span>
              </div>
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${downInstallment.toFixed(2)}"
                  data-field="downInstallment"
                  placeholder="ต่อเดือน"
                  step="0.01"
                />
                <span class="tooltip-text">จ่ายต่อเดือน</span>
              </div>
            </div>
          </td>

          <!-- Pay and use column (toggle-payuse) -->
          <td class="px-4 py-3 toggle-payuse">
            <div class="grid grid-cols-3 gap-2">
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${creditThreshold.toFixed(2)}"
                  data-field="creditThreshold"
                  placeholder="เครดิต"
                  step="0.01"
                />
                <span class="tooltip-text">เครดิต</span>
              </div>
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${payUseInstallmentCount}"
                  data-field="payUseInstallmentCount"
                  placeholder="งวด"
                />
                <span class="tooltip-text">จำนวนงวด</span>
              </div>
              <div class="tooltip">
                <input
                  type="number"
                  class="${inputClass}"
                  value="${payUseInstallment.toFixed(2)}"
                  data-field="payUseInstallment"
                  placeholder="ต่อเดือน"
                  step="0.01"
                />
                <span class="tooltip-text">จ่ายต่อเดือน</span>
              </div>
            </div>
          </td>

          <!-- Pay off and receive column (toggle-payoff) -->
          <td class="px-4 py-3 toggle-payoff">
            <div class="font-medium text-right">
              <span class="readonly-text" data-field="pricePayOff">
                ${formatNumber(payOff)}
              </span>
            </div>
          </td>

          <!-- Doc Fee column -->
          <td class="px-4 py-3">
            <input
              type="number"
              class="${inputClass}"
              data-field="docFee"
              value="${(st.docFee || 0).toFixed(2)}"
              placeholder="0.00" 
              step="0.01"
            />
          </td>

          <!-- Actions column -->
          <td class="px-4 py-3">
            <button
              class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center justify-center w-full"
              data-action="save-price"
              data-product-name="${productName}"
            >
              <i class="bi bi-save mr-1"></i> บันทึก
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Update Pay Off amount when changing cash price
    function updatePayOff(inputElem) {
      const tr = inputElem.closest("tr");
      if (!tr) return;
      const price = parseFloat(inputElem.value) || 0;
      const spanPayOff = tr.querySelector('span[data-field="pricePayOff"]');'
      if (spanPayOff) {
        spanPayOff.textContent = formatNumber(price + 2590);
      }
    }

    // Save price when clicking save button
    async function savePrice(productName, btnEl) {
      const tr = btnEl.closest("tr");
      if (!tr) return;

      // Change button state to loading
      const originalButtonText = btnEl.innerHTML;
      btnEl.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-1"></i> กำลังบันทึก...';'
      btnEl.disabled = true;

      // Prepare data for update
      const body = {
        price:                  parseFloat(tr.querySelector('input[data-field="price"]').value) || 0,'
        downAmount:             parseFloat(tr.querySelector('input[data-field="downAmount"]').value) || 0,'
        downInstallmentCount:   parseInt  (tr.querySelector('input[data-field="downInstallmentCount"]').value) || 0,'
        downInstallment:        parseFloat(tr.querySelector('input[data-field="downInstallment"]').value) || 0,'
        creditThreshold:        parseFloat(tr.querySelector('input[data-field="creditThreshold"]').value) || 0,'
        payUseInstallmentCount: parseInt  (tr.querySelector('input[data-field="payUseInstallmentCount"]').value) || 0,'
        payUseInstallment:      parseFloat(tr.querySelector('input[data-field="payUseInstallment"]').value) || 0,'
        pricePayOff:            parseFloat((parseFloat(tr.querySelector('input[data-field="price"]').value) || 0) + 2590).toFixed(2),'
        docFee:                 parseFloat(tr.querySelector('input[data-field="docFee"]').value) || 0'
      };

      try {
        const token = localStorage.getItem("authToken");
        const res = await fetch(
          `/api/product-image/price/name/${encodeURIComponent(productName)}`,
          {
            method: "PATCH",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body)
          }
        );
        const payload = await res.json();

        if (!res.ok || payload.status !== "success") {
          throw new Error(payload.message || "Update failed");
        }

        // If there's updated data from server, use it'
        const updated = payload.data || {};

        // Update fields with values from server response when available
        const finalDocFee = typeof updated.docFee === "number" ? updated.docFee : body.docFee;
        tr.querySelector('input[data-field="docFee"]').value = finalDocFee.toFixed(2);'

        const finalPrice = typeof updated.price === "number" ? updated.price : body.price;
        tr.querySelector('input[data-field="price"]').value = finalPrice.toFixed(2);'
        
        const spanPayOff = tr.querySelector('span[data-field="pricePayOff"]');'
        if (spanPayOff) {
          spanPayOff.textContent = formatNumber(finalPrice + 2590);
        }

        // Show success message
        showSuccessToast(`บันทึกสำเร็จสำหรับ: ${productName}`);
        
        // Highlight the row briefly to show success
        tr.style.backgroundColor = '#d1fae5';'
        setTimeout(() => {
          tr.style.backgroundColor = '';'
        }, 1500);

      } catch (err) {
        console.error("savePrice error:", err);
        customConfirm("เกิดข้อผิดพลาดในการบันทึก: " + err.message);
      } finally {
        // Reset button state after 1 second
        setTimeout(() => {
          btnEl.innerHTML = originalButtonText;
          btnEl.disabled = false;
        }, 1000);
      }
    }

    // Table pagination variables and functions
    let currentPage = 1;
    let itemsPerPage = 10;
    let allProducts = [];
    let filteredProducts = [];

    // Search products
    function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();'
      filteredProducts = allProducts.filter(product => {
        return (
          product.name.toLowerCase().includes(searchTerm) || 
          String(product.price).includes(searchTerm)
        );
      });
      currentPage = 1; // Reset to first page when searching
      renderTablePage();
      updatePagination();
    }

    // Render current page
    function renderTablePage() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageItems = filteredProducts.slice(startIndex, endIndex);
      
      // Render only the products for current page
      renderTable(pageItems);
      
      // Update item range display
      document.getElementById('itemStart').textContent = filteredProducts.length === 0 ? 0 : startIndex + 1;'
      document.getElementById('itemEnd').textContent = Math.min(endIndex, filteredProducts.length);'
      document.getElementById('itemTotal').textContent = filteredProducts.length;'
    }

    // Update pagination controls
    function updatePagination() {
      const totalPages = Math.max(1, Math.ceil(filteredProducts.length / itemsPerPage));
      document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;'
      document.getElementById('prevBtn').disabled = currentPage <= 1;'
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;'
    }

    // Modified loadPricingData to work with pagination
    async function loadPricingData() {
      const token = localStorage.getItem("authToken");
      try {
        // Show loading indicator
        document.querySelector("#priceTable tbody").innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-10">
              <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 mb-4 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center animate-pulse">
                  <i class="bi bi-hourglass text-2xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">กำลังโหลดข้อมูล...</p>
              </div>
            </td>
          </tr>
        `;
        
        const res = await fetch("/api/product-image/pricing", {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        
        if (!res.ok || data.status !== "success") {
          throw new Error(data.error || "ไม่สามารถโหลดข้อมูลราคา");
        }
        
        // Store all products
        allProducts = data.data || [];
        filteredProducts = [...allProducts];
        
        // Initial render
        renderTablePage();
        updatePagination();
        
        // Set up event listeners for pagination
        document.getElementById('prevBtn').addEventListener('click', () => {'
          if (currentPage > 1) {
            currentPage--;
            renderTablePage();
            updatePagination();
          }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {'
          const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            renderTablePage();
            updatePagination();
          }
        });
        
        // Set up search functionality
        document.getElementById('searchInput').addEventListener('input', searchProducts);'
        
      } catch (err) {
        console.error("Error loading pricing data:", err);
        document.querySelector("#priceTable tbody").innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-10">
              <div class="flex flex-col items-center justify-center">
                <div class="w-16 h-16 mb-4 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center">
                  <i class="bi bi-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <p class="text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">${err.message}</p>
              </div>
            </td>
          </tr>
        `;
      }
    }

    // Add event listener to table body for saving prices and updating pay off
    document.addEventListener('DOMContentLoaded', () => {'
      const tableBody = document.querySelector('#priceTable tbody');'
      
      tableBody.addEventListener('input', (e) => {'
        if (e.target.matches('input[data-action="update-payoff"]')) {'
          updatePayOff(e.target);
        }
      });
      
      tableBody.addEventListener('click', (e) => {'
        const saveBtn = e.target.closest('button[data-action="save-price"]');'
        if (saveBtn) {
          const productName = saveBtn.getAttribute('data-product-name');'
          savePrice(productName, saveBtn);
        }
      });
    });

    // Initialize sidebar toggle functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');'
      const mainContent = document.getElementById('mainContent');'
      
      sidebar.classList.toggle('-translate-x-full');'
      mainContent.classList.toggle('ml-64');'
      mainContent.classList.toggle('ml-0');'
    }
  </script>
</body>
</html>