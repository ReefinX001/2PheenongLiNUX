<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบหลัก - Main Home</title>
  
  <!-- Force cache refresh -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- ตรวจสอบการล็อกอิน: หากไม่มี authToken ให้รีไดเร็กไปที่ login -->
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.href = '/login';
    }
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- 1) โหลด Tailwind CSS CDN ก่อน -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) ค่อยกำหนดค่า Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
            },
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
            'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)',
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- animate.css สำหรับเอฟเฟกต์ Toast + Dot -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    /* Custom styles */
    body {
      font-family: 'Prompt', sans-serif;
    }
    
    .menu-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--tw-shadow-hover);
    }
    
    .badge-dot {
      transition: all 0.2s ease-in-out;
    }
    
    .activity-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    .dark ::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #3B82F6;
    }

    input:focus + .toggle-slider {
      box-shadow: 0 0 1px #3B82F6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    /* Tooltip Styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Form Input Styles */
    .form-input {
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .dark .form-input {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4a5568;
    }

    .form-input:focus {
      color: #495057;
      background-color: #fff;
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .dark .form-input:focus {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4299e1;
      box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
    }

    /* Additional CSS for customer page */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .customer-card {
      transition: all 0.2s ease;
    }
    
    .customer-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .required-field::after {
      content: "*";
      color: #ef4444;
      margin-left: 4px;
    }
    
    .pagination-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp }
      from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",  // Fixed the truncated API key
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    // expose to window
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebaseSet = set;
    window.firebasePush = push;
    window.firebaseServerTimestamp = serverTimestamp;
  </script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <!-- Cart Badge Styles -->
  <style>
    .cart-badge {
      position: absolute; top: -4px; right: -4px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 2px 5px; border-radius: 9999px;
      min-width: 18px; text-align: center;
    }
    .notification-badge {
      position: absolute; top: -2px; right: -2px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 1px 4px; border-radius: 9999px;
      min-width: 16px; text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">

  <!-- Container สำหรับ Toast แจ้งเตือน -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Sidebar Menu -->
  <div id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-all duration-300 z-40 sidebar-transition overflow-y-auto">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/favicon/favicon-32x32.png" alt="Logo" class="h-8 w-8">
        <span class="text-xl font-bold text-primary-600 dark:text-primary-400">ระบบจัดการ</span>
      </div>
      <button onclick="toggleMenu()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- User Info in Sidebar -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
          <i class="bi bi-person-fill"></i>
        </div>
        <div>
          <div id="sidebarUserName" class="font-medium">Loading...</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
        </div>
      </div>
    </div>
    
  <!-- Sidebar Menu Items -->
    <div class="py-4">
      <div class="px-4 mb-2 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">เมนูหลัก</div>
      <ul>
        <li>
          <a href="home" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-house-fill text-primary-500"></i>
            <span>หน้าแรก</span>
          </a>
        </li>
        <li>
          <a href="Login_Management" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-shield-lock-fill text-orange-500"></i>
            <span>อนุมัติคำขอ</span>
          </a>
        </li>
        <li>
          <a href="online-blocked-users" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-people-fill text-green-500"></i>
            <span>ผู้ใช้ออนไลน์</span>
          </a>
        </li>
        <li>
          <a href="price_adjustment" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-tag-fill text-orange-500"></i>
            <span>ปรับราคาสินค้า</span>
          </a>
        </li>
      </ul>
      
      <div class="px-4 pt-4 pb-2 mt-4 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">ระบบงาน</div>
      <ul>
        <li>
          <a href="accounting_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-journal-text text-blue-500"></i>
              <span>งานบัญชี</span>
            </div>
            <span id="sidebar-dot-accounting" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="HR_Dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-people-fill text-green-500"></i>
              <span>ฝ่ายบุคคล</span>
            </div>
            <span id="sidebar-dot-hr" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="StockManagehome" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-box-fill text-yellow-500"></i>
              <span>คลังสินค้า</span>
            </div>
            <span id="sidebar-dot-stock" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="financial_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-bar-chart-fill text-red-500"></i>
              <span>รายงาน</span>
            </div>
            <span id="sidebar-dot-report" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="loan_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-credit-card-fill text-gray-500"></i>
              <span>สินเชื่อ</span>
            </div>
            <span id="sidebar-dot-loan" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="frontstore_index" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-shop-window text-blue-400"></i>
              <span>POS - ขายหน้าร้าน</span>
            </div>
            <span id="sidebar-dot-pos" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="gifts_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-gift-fill text-pink-500"></i>
              <span>ของแถม</span>
            </div>
            <span id="sidebar-dot-gifts" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Logout Button -->
    <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
      <button id="btnLogout" class="w-full py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg flex items-center justify-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
        <i class="bi bi-box-arrow-right"></i>
        <span>ออกจากระบบ</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-grow p-4 sm:p-6 lg:p-8 pt-20">
    <!-- Top Bar with Menu Toggle and Page Title -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center">
        <button onclick="toggleMenu()" class="p-2 mr-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
          <i class="bi bi-list text-xl"></i>
        </button>
        <h1 class="text-2xl font-bold">รายงานยอดขายประจำวัน</h1>
      </div>
      
      <!-- User menu dropdown -->
      <div class="relative">
        <button id="userMenuBtn" class="flex items-center space-x-2 focus:outline-none">
          <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
            <i class="bi bi-person-fill"></i>
          </div>
          <span id="currentUserName" class="hidden sm:inline-block">Loading...</span>
          <i class="bi bi-chevron-down text-xs"></i>
        </button>
        
        <!-- User dropdown menu -->
        <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-1 z-50 hidden">
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-person-circle mr-2"></i> โปรไฟล์
          </a>
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-gear-fill mr-2"></i> ตั้งค่า
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
          <a href="#" id="darkModeToggle" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-moon-fill mr-2"></i> <span id="darkModeText">โหมดกลางคืน</span>
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
          <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-box-arrow-right mr-2"></i> ออกจากระบบ
          </a>
        </div>
      </div>
    </div>

    <!-- Sales Overview Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Sales Today Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">ยอดขายวันนี้</h3>
          <span class="text-primary-500 dark:text-primary-400 text-2xl">
            <i class="bi bi-cash-coin"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="totalSalesToday" class="text-3xl font-bold text-gray-900 dark:text-white">฿0</p>
          <span id="salesGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">เทียบกับเมื่อวาน</p>
      </div>

      <!-- Total Units Sold Today Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">จำนวนเครื่องที่ขายได้</h3>
          <span class="text-blue-500 dark:text-blue-400 text-2xl">
            <i class="bi bi-box-seam"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="totalUnitsSold" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="unitsGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">เทียบกับเมื่อวาน</p>
      </div>

      <!-- iPhone Sales Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">iPhone ขายได้</h3>
          <span class="text-gray-500 dark:text-gray-400 text-2xl">
            <i class="bi bi-phone-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="iphoneSold" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="iphoneGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">คิดเป็น <span id="iphonePercentage">0%</span> ของยอดขายทั้งหมด</p>
      </div>

      <!-- iPad Sales Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">iPad ขายได้</h3>
          <span class="text-gray-500 dark:text-gray-400 text-2xl">
            <i class="bi bi-tablet-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="ipadSold" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="ipadGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">คิดเป็น <span id="ipadPercentage">0%</span> ของยอดขายทั้งหมด</p>
      </div>
    </div>

    <!-- Sales by Branch Chart -->
    <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6 mb-8">
      <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">ยอดขายตามสาขา (วันนี้)</h3>
      <div class="w-full h-64">
        <canvas id="branchSalesChart"></canvas>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Sales List Section (Larger) -->
      <div class="lg:col-span-2 bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">รายการขายวันนี้</h3>
          <div class="flex space-x-2">
            <div class="relative">
              <input type="text" id="salesSearch" placeholder="ค้นหารายการขาย..." 
                class="form-input text-sm pl-8 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-600 focus:border-transparent">
              <i class="bi bi-search absolute left-3 top-2.5 text-gray-400"></i>
            </div>
            <button id="btnExportSales" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center text-sm">
              <i class="bi bi-file-earmark-excel mr-2"></i>ส่งออก
            </button>
          </div>
        </div>

        <!-- Filter Options -->
        <div class="flex flex-wrap gap-2 mb-4">
          <select id="filterBranch" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกสาขา</option>
            <!-- Branch options will be populated from API -->
          </select>
          <select id="filterProduct" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกสินค้า</option>
            <option value="iPhone">iPhone</option>
            <option value="iPad">iPad</option>
          </select>
          <select id="filterSalesPerson" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">พนักงานทั้งหมด</option>
          </select>
        </div>

        <!-- Sales Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">เวลาขาย</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สินค้า</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สี / ความจุ</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สาขา</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">พนักงานขาย</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ราคา</th>
              </tr>
            </thead>
            <tbody id="salesTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Sales rows will be generated here -->
              <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">กำลังโหลดข้อมูล...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-4">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            แสดง <span id="itemsShowing">0</span> จาก <span id="totalItems">0</span> รายการ
          </div>
          <div class="flex space-x-1">
            <button id="prevPage" class="pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 disabled:opacity-50">
              <i class="bi bi-chevron-left"></i>
            </button>
            <div id="pageNumbers" class="flex space-x-1">
              <!-- Page numbers will be generated here -->
            </div>
            <button id="nextPage" class="pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 disabled:opacity-50">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Sales Stats Section -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">ข้อมูลสรุป</h3>
        
        <!-- Product Distribution Chart -->
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">สัดส่วนประเภทสินค้า</h4>
          <div class="h-48">
            <canvas id="productDistributionChart"></canvas>
          </div>
        </div>
        
        <!-- Color Distribution Chart -->
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">สัดส่วนสีที่ขายได้</h4>
          <div class="h-48">
            <canvas id="colorDistributionChart"></canvas>
          </div>
        </div>
        
        <!-- Top Selling Staff -->
        <div>
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">พนักงานขายยอดเยี่ยม</h4>
          <div id="topSalesStaff" class="space-y-3">
            <!-- Top sales staff will be inserted here -->
            <div class="animate-pulse flex items-center space-x-3">
              <div class="rounded-full bg-gray-300 dark:bg-gray-600 h-10 w-10"></div>
              <div class="flex-1">
                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/2"></div>
              </div>
            </div>
            <div class="animate-pulse flex items-center space-x-3">
              <div class="rounded-full bg-gray-300 dark:bg-gray-600 h-10 w-10"></div>
              <div class="flex-1">
                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Global functions
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('-translate-x-full');
    }

    // DOM Elements
    const userDropdown = document.getElementById('userDropdown');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeText = document.getElementById('darkModeText');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserName = document.getElementById('currentUserName');
    const sidebarUserName = document.getElementById('sidebarUserName');

    // FORCE LOCALHOST API BASE - Override any global settings
    console.log('🔧 Window location details:');
    console.log('  - origin:', window.location.origin);
    console.log('  - hostname:', window.location.hostname);
    console.log('  - port:', window.location.port);
    console.log('  - href:', window.location.href);
    
    // Check for any existing global API configurations
    if (typeof window.API_BASE_CACHE !== 'undefined') {
        console.warn('🚫 Found existing API_BASE_CACHE, deleting:', window.API_BASE_CACHE);
        delete window.API_BASE_CACHE;
    }
    if (typeof window.API_BASE !== 'undefined') {
        console.warn('🚫 Found existing global API_BASE, deleting:', window.API_BASE);
        delete window.API_BASE;
    }
    
    // Smart API Base URL Configuration
    const getCorrectApiBase = () => {
      const origin = window.location.origin;
      const hostname = window.location.hostname;
      const apiBase = origin + '/api';
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        console.log('✅ Development environment - API base:', apiBase);
      } else {
        console.log('✅ Production environment - API base:', apiBase);
      }
      
      return apiBase;
    };
    
    const API_BASE = getCorrectApiBase();
    
    // Force debug - log API_BASE immediately
    console.log('🚀 Final API_BASE set to:', API_BASE);
    console.log('🚀 Window location:', window.location.href);
    
    // Clear any localStorage API cache
    localStorage.removeItem('API_BASE');
    localStorage.removeItem('api_base');
    
    // Smart environment detection for security checks
    const currentHostname = window.location.hostname;
    const isLocalhost = currentHostname === 'localhost' || currentHostname === '127.0.0.1';
    
    if (isLocalhost && API_BASE.includes('2pheenong.com')) {
        console.error('❌ CRITICAL: External domain detected in development environment:', API_BASE);
        console.error('❌ This should not happen in localhost development');
        alert('Security Error: External domain detected in development. Please check configuration.');
    } else if (!isLocalhost) {
        console.log('✅ Production environment detected, API_BASE:', API_BASE);
        console.log('✅ Running on domain:', currentHostname);
    }

    // URL validation and correction
    function validateAndFixUrl(url) {
      if (typeof url !== 'string') return url;
      
      console.log('🔍 Validating URL:', url);
      
นเดียวกัน ขายสด       // In development (localhost), block external domains
      if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
        const suspiciousDomains = ['2pheenong.com', 'external.domain', 'malicious.site'];
        for (const domain of suspiciousDomains) {
          if (url.includes(domain) && !url.includes(currentHostname)) {
            const apiPath = url.replace(/https?:\/\/[^\/]+/, '');
            const fixedUrl = window.location.origin + apiPath;
            console.warn('🚫 BLOCKED external domain in development:', url, '→', fixedUrl);
            return fixedUrl;
          }
        }
      }
      
      // Fix relative API URLs
      if (url.startsWith('/api/')) {
        const fixedUrl = window.location.origin + url;
        console.log('🔧 Fixed relative API URL:', url, '→', fixedUrl);
        return fixedUrl;
      }
      
      // Ensure localhost URLs use correct port
      if (url.includes('localhost') && !url.includes(window.location.port) && window.location.port) {
        const fixedUrl = url.replace(/localhost:\d+/, `localhost:${window.location.port}`);
        console.log('🔧 Fixed localhost port:', url, '→', fixedUrl);
        return fixedUrl;
      }
      
      console.log('✅ URL validated:', url);
      return url;
    }
    
    // Override fetch in development environment
    if (currentHostname === 'localhost' || currentHostname === '127.0.0.1') {
      console.log('🔧 Development mode: Enabling fetch override for security');
      
      const originalFetch = window.fetch;
      window.fetch = function(url, options = {}) {
        const validatedUrl = validateAndFixUrl(url);
        console.log('🌐 Development fetch with validated URL:', validatedUrl);
        
        // Add additional headers to prevent caching issues in development
        const enhancedOptions = {
          ...options,
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
            ...options.headers
          }
        };
        
        return originalFetch.call(this, validatedUrl, enhancedOptions);
      };
    } else {
      console.log('✅ Production mode: Using native fetch without override');
    }

    // Variables for data
    let todaySummary = {};
    let allSales = [];
    let filteredSales = [];
    let branchStats = [];
    let productDistribution = [];
    let colorDistribution = [];
    let topSalesStaff = [];
    let branches = [];
    let salespersons = [];

    // Current page for pagination
    let currentPage = 1;
    const itemsPerPage = 10;

    // API Functions
    async function loadTodaySummary() {
      try {
        console.log('🔄 Loading today summary from:', `${API_BASE}/sales-dashboard/today-summary`);
        const response = await fetch(`${API_BASE}/sales-dashboard/today-summary`);
        
        console.log('📡 Response status:', response.status);
        console.log('📡 Response ok:', response.ok);
        
        if (response.ok) {
          const result = await response.json();
          console.log('✅ Today summary data:', result);
          
          if (result.success && result.data) {
            todaySummary = result.data;
            updateDashboardStats();
            console.log('✅ Dashboard stats updated with:', todaySummary);
          } else {
            console.warn('⚠️ API returned success=false or no data:', result);
            // Set default values
            todaySummary = {
              totalSales: 0,
              salesGrowth: 0,
              totalUnits: 0,
              unitsGrowth: 0,
              iphoneUnits: 0,
              iphoneGrowth: 0,
              iphonePercentage: 0,
              ipadUnits: 0,
              ipadGrowth: 0,
              ipadPercentage: 0
            };
            updateDashboardStats();
          }
        } else {
          const errorText = await response.text();
          console.error('❌ Failed to load today summary:', response.status, errorText);
          
          // Set default values on error
          todaySummary = {
            totalSales: 0,
            salesGrowth: 0,
            totalUnits: 0,
            unitsGrowth: 0,
            iphoneUnits: 0,
            iphoneGrowth: 0,
            iphonePercentage: 0,
            ipadUnits: 0,
            ipadGrowth: 0,
            ipadPercentage: 0
          };
          updateDashboardStats();
        }
      } catch (error) {
        console.error('❌ Error loading today summary:', error);
        
        // Set default values on error
        todaySummary = {
          totalSales: 0,
          salesGrowth: 0,
          totalUnits: 0,
          unitsGrowth: 0,
          iphoneUnits: 0,
          iphoneGrowth: 0,
          iphonePercentage: 0,
          ipadUnits: 0,
          ipadGrowth: 0,
          ipadPercentage: 0
        };
        updateDashboardStats();
      }
    }

    async function loadTodaySales(page = 1, filters = {}) {
      try {
        const params = new URLSearchParams({
          page: page.toString(),
          limit: itemsPerPage.toString(),
          ...filters
        });
        
        const url = `${API_BASE}/sales-dashboard/today-sales?${params}`;
        console.log('🔄 Loading today sales from:', url);
        
        const response = await fetch(url);
        console.log('📡 Today sales response status:', response.status);
        
        if (response.ok) {
          const result = await response.json();
          console.log('✅ Today sales data:', result);
          
          if (result.success && result.data) {
            allSales = result.data.sales || [];
            filteredSales = [...allSales];
            updatePaginationInfo(result.data.pagination || {});
            refreshSalesTable();
            console.log('✅ Sales table updated with', allSales.length, 'items');
          } else {
            console.warn('⚠️ Today sales API returned success=false or no data:', result);
            allSales = [];
            filteredSales = [];
            refreshSalesTable();
          }
        } else {
          const errorText = await response.text();
          console.error('❌ Failed to load today sales:', response.status, errorText);
          allSales = [];
          filteredSales = [];
          refreshSalesTable();
        }
      } catch (error) {
        console.error('❌ Error loading today sales:', error);
        allSales = [];
        filteredSales = [];
        refreshSalesTable();
      }
    }

    async function loadBranchStats() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/branch-stats`);
        if (response.ok) {
          const result = await response.json();
          branchStats = result.data;
          updateCharts();
        } else {
          console.error('Failed to load branch stats');
        }
      } catch (error) {
        console.error('Error loading branch stats:', error);
      }
    }

    async function loadProductDistribution() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/product-distribution`);
        if (response.ok) {
          const result = await response.json();
          productDistribution = result.data;
          updateCharts();
        } else {
          console.error('Failed to load product distribution');
        }
      } catch (error) {
        console.error('Error loading product distribution:', error);
      }
    }

    async function loadColorDistribution() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/color-distribution`);
        if (response.ok) {
          const result = await response.json();
          colorDistribution = result.data;
          updateCharts();
        } else {
          console.error('Failed to load color distribution');
        }
      } catch (error) {
        console.error('Error loading color distribution:', error);
      }
    }

    async function loadTopSalesStaff() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/top-sales-staff`);
        if (response.ok) {
          const result = await response.json();
          topSalesStaff = result.data;
          updateTopSalesStaff();
        } else {
          console.error('Failed to load top sales staff');
        }
      } catch (error) {
        console.error('Error loading top sales staff:', error);
      }
    }

    async function loadBranches() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/branches`);
        if (response.ok) {
          const result = await response.json();
          branches = result.data;
          populateBranchFilter();
        } else {
          console.error('Failed to load branches');
        }
      } catch (error) {
        console.error('Error loading branches:', error);
      }
    }

    async function loadSalespersons() {
      try {
        const response = await fetch(`${API_BASE}/sales-dashboard/salespersons`);
        if (response.ok) {
          const result = await response.json();
          salespersons = result.data;
          populateSalespersonFilter();
        } else {
          console.error('Failed to load salespersons');
        }
      } catch (error) {
        console.error('Error loading salespersons:', error);
      }
    }

    // Initialize User Data
    function initUserData() {
      // Normally this would come from Firebase auth or user session
      const username = "คุณบอส (ผู้บริหาร)";
      currentUserName.textContent = username;
      sidebarUserName.textContent = username;
    }

    // Toggle user dropdown menu
    userMenuBtn.addEventListener('click', () => {
      userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
        userDropdown.classList.add('hidden');
      }
    });

    // Toggle dark mode
    function initDarkMode() {
      // Check if user preference exists in localStorage
      const darkMode = localStorage.getItem('darkMode') === 'true';
      
      // Apply dark mode if needed
      if (darkMode) {
        document.documentElement.classList.add('dark');
        darkModeText.textContent = 'โหมดกลางวัน';
      } else {
        document.documentElement.classList.remove('dark');
        darkModeText.textContent = 'โหมดกลางคืน';
      }
    }

    darkModeToggle.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Toggle dark mode class
      document.documentElement.classList.toggle('dark');
      
      // Update localStorage preference
      const isDarkMode = document.documentElement.classList.contains('dark');
      localStorage.setItem('darkMode', isDarkMode);
      
      // Update text
      darkModeText.textContent = isDarkMode ? 'โหมดกลางวัน' : 'โหมดกลางคืน';
    });

    // Logout functionality
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    });

    // Format price with commas
    function formatPrice(price) {
      return new Intl.NumberFormat('th-TH').format(price);
    }

    // Sales table functions
    function refreshSalesTable() {
      const tableBody = document.getElementById('salesTableBody');
      
      // Clear table
      tableBody.innerHTML = '';
      
      // No data case
      if (!allSales || allSales.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
            ไม่พบข้อมูลการขาย
          </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
      }
      
      // Generate table rows
      allSales.forEach(sale => {
        sale.items.forEach(item => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
          
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 dark:text-white">${sale.timestamp}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900 dark:text-white">${item.product}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${item.model}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <span class="h-4 w-4 rounded-full inline-block mr-2" style="background-color: ${getColorHex(item.color)}"></span>
                <div>
                  <div class="text-sm text-gray-900 dark:text-white">${item.color}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">${item.capacity}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 dark:text-white">${sale.branch}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 dark:text-white">${sale.salesperson}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
              <div class="text-sm font-semibold text-gray-900 dark:text-white">฿${formatPrice(item.price)}</div>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
      });
    }
    
    function updatePaginationInfo(pagination) {
      document.getElementById('itemsShowing').textContent = 
        pagination.totalItems > 0 ? 
        `${((pagination.currentPage - 1) * pagination.itemsPerPage) + 1}-${Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems)}` : 
        '0';
      document.getElementById('totalItems').textContent = pagination.totalItems;
      updatePagination(pagination.totalPages);
    }
    
    // Helper function to get color hex code for visual representation
    function getColorHex(colorName) {
      const colorMap = {
        'Blue Titanium': '#4C516D',
        'Natural Titanium': '#E3C7BC',
        'White Titanium': '#F5F5F0',
        'Black Titanium': '#232324',
        'Space Gray': '#535150',
        'Silver': '#E3E4E5',
        'Pink': '#FDDDD7',
        'Yellow': '#FFEC1F',
        'Blue': '#0071E3',
        'Purple': '#D1CDDB'
      };
      
      return colorMap[colorName] || '#CCCCCC'; // default gray if color not found
    }

    function updatePagination(totalPages) {
      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';
      
      // Previous button
      document.getElementById('prevPage').disabled = currentPage <= 1;
      
      // Next button
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
      
      // Only show a limited number of page buttons
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // First page button if needed
      if (startPage > 1) {
        const pageBtn = createPageButton(1);
        pageNumbers.appendChild(pageBtn);
        
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-btn flex items-center justify-center';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }
      }
      
      // Page buttons
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = createPageButton(i);
        pageNumbers.appendChild(pageBtn);
      }
      
      // Last page button if needed
      if (endPage < totalPages) {
        if (totalPages - endPage > 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-btn flex items-center justify-center';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }
        
        const pageBtn = createPageButton(totalPages);
        pageNumbers.appendChild(pageBtn);
      }
    }

    function createPageButton(page) {
      const button = document.createElement('button');
      button.className = `pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 
                          ${page === currentPage ? 'font-semibold bg-primary-500 text-white dark:bg-primary-600' : ''}`;
      button.textContent = page;
      button.disabled = page === currentPage;
      
      button.addEventListener('click', () => {
        currentPage = page;
        applyFiltersAndReload();
      });
      
      return button;
    }

    // Update dashboard stats
    function updateDashboardStats() {
      if (!todaySummary || Object.keys(todaySummary).length === 0) {
        return;
      }
      
      // Update UI with real data
      document.getElementById('totalSalesToday').textContent = '฿' + formatPrice(todaySummary.totalSalesToday);
      document.getElementById('totalUnitsSold').textContent = todaySummary.totalUnitsSold;
      document.getElementById('iphoneSold').textContent = todaySummary.iphoneSold;
      document.getElementById('ipadSold').textContent = todaySummary.ipadSold;
      document.getElementById('iphonePercentage').textContent = `${todaySummary.iphonePercentage}%`;
      document.getElementById('ipadPercentage').textContent = `${todaySummary.ipadPercentage}%`;
      
      // Growth metrics
      const salesGrowthIcon = todaySummary.salesGrowth >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short';
      const salesGrowthColor = todaySummary.salesGrowth >= 0 ? 'text-green-500' : 'text-red-500';
      document.getElementById('salesGrowth').innerHTML = 
        `<i class="bi ${salesGrowthIcon}"></i>${todaySummary.salesGrowth > 0 ? '+' : ''}${todaySummary.salesGrowth}%`;
      document.getElementById('salesGrowth').className = `ml-2 text-sm font-medium ${salesGrowthColor}`;
      
      const unitsGrowthIcon = todaySummary.unitsGrowth >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short';
      const unitsGrowthColor = todaySummary.unitsGrowth >= 0 ? 'text-green-500' : 'text-red-500';
      document.getElementById('unitsGrowth').innerHTML = 
        `<i class="bi ${unitsGrowthIcon}"></i>${todaySummary.unitsGrowth > 0 ? '+' : ''}${todaySummary.unitsGrowth}%`;
      document.getElementById('unitsGrowth').className = `ml-2 text-sm font-medium ${unitsGrowthColor}`;
      
      // iPhone Growth
      if (todaySummary.iphoneGrowth !== undefined) {
        const iphoneGrowthIcon = todaySummary.iphoneGrowth >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short';
        const iphoneGrowthColor = todaySummary.iphoneGrowth >= 0 ? 'text-green-500' : 'text-red-500';
        document.getElementById('iphoneGrowth').innerHTML = 
          `<i class="bi ${iphoneGrowthIcon}"></i>${todaySummary.iphoneGrowth > 0 ? '+' : ''}${todaySummary.iphoneGrowth}%`;
        document.getElementById('iphoneGrowth').className = `ml-2 text-sm font-medium ${iphoneGrowthColor}`;
      } else {
        document.getElementById('iphoneGrowth').innerHTML = 
          `<i class="bi bi-dash"></i>ไม่มีข้อมูล`;
        document.getElementById('iphoneGrowth').className = `ml-2 text-sm font-medium text-gray-400`;
      }
      
      // iPad Growth
      if (todaySummary.ipadGrowth !== undefined) {
        const ipadGrowthIcon = todaySummary.ipadGrowth >= 0 ? 'bi-arrow-up-short' : 'bi-arrow-down-short';
        const ipadGrowthColor = todaySummary.ipadGrowth >= 0 ? 'text-green-500' : 'text-red-500';
        document.getElementById('ipadGrowth').innerHTML = 
          `<i class="bi ${ipadGrowthIcon}"></i>${todaySummary.ipadGrowth > 0 ? '+' : ''}${todaySummary.ipadGrowth}%`;
        document.getElementById('ipadGrowth').className = `ml-2 text-sm font-medium ${ipadGrowthColor}`;
      } else {
        document.getElementById('ipadGrowth').innerHTML = 
          `<i class="bi bi-dash"></i>ไม่มีข้อมูล`;
        document.getElementById('ipadGrowth').className = `ml-2 text-sm font-medium text-gray-400`;
      }
    }
    
    function populateBranchFilter() {
      const filterBranch = document.getElementById('filterBranch');
      
      // Clear existing options except the first one
      while (filterBranch.options.length > 1) {
        filterBranch.remove(1);
      }
      
      // Add branch options
      branches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch;
        option.textContent = branch;
        filterBranch.appendChild(option);
      });
    }

    function populateSalespersonFilter() {
      const filterSalesPerson = document.getElementById('filterSalesPerson');
      
      // Clear existing options except the first one
      while (filterSalesPerson.options.length > 1) {
        filterSalesPerson.remove(1);
      }
      
      // Add salesperson options
      salespersons.forEach(person => {
        const option = document.createElement('option');
        option.value = person;
        option.textContent = person;
        filterSalesPerson.appendChild(option);
      });
    }
    
    // Update charts
    function updateCharts() {
      try {
        updateBranchChart();
        updateProductDistributionChart();
        updateColorDistributionChart();
      } catch (error) {
        console.error('Error updating charts:', error);
      }
    }

    function updateBranchChart() {
      if (!branchStats || branchStats.length === 0) {
        return;
      }

      const branches = branchStats.map(stat => stat._id);
      const iPhoneData = branchStats.map(stat => stat.iphoneCount);
      const iPadData = branchStats.map(stat => stat.ipadCount);
      const branchTotals = branchStats.map(stat => stat.totalAmount / 1000); // Convert to thousands

      const ctx1 = document.getElementById('branchSalesChart');
      if (ctx1) {
        // Check if chart instance exists and destroy it
        if (window.branchSalesChart instanceof Chart) {
          window.branchSalesChart.destroy();
        }
        
        window.branchSalesChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: branches,
            datasets: [
              {
                type: 'bar',
                label: 'iPhone (เครื่อง)',
                data: iPhoneData,
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                order: 2
              },
              {
                type: 'bar',
                label: 'iPad (เครื่อง)',
                data: iPadData,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                order: 1
              },
              {
                type: 'line',
                label: 'ยอดขายรวม (พันบาท)',
                data: branchTotals,
                borderColor: 'rgba(245, 158, 11, 0.7)',
                borderWidth: 3,
                fill: false,
                tension: 0.1,
                pointBackgroundColor: 'rgba(245, 158, 11, 0.7)',
                yAxisID: 'y1',
                order: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'จำนวนเครื่อง',
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                },
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                },
                grid: {
                  color: document.documentElement.classList.contains('dark') ? 'rgba(107, 114, 128, 0.1)' : 'rgba(229, 231, 235, 0.5)'
                }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'ยอดขาย (พันบาท)',
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                },
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                },
                grid: {
                  display: false
                }
              },
              x: {
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
    }

    function updateProductDistributionChart() {
      if (!productDistribution || productDistribution.length === 0) {
        return;
      }

      const labels = productDistribution.map(item => item._id);
      const data = productDistribution.map(item => item.count);
      
      const ctx2 = document.getElementById('productDistributionChart');
      if (ctx2) {
        // Check if chart instance exists and destroy it
        if (window.productDistributionChart instanceof Chart) {
          window.productDistributionChart.destroy();
        }
        
        window.productDistributionChart = new Chart(ctx2, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: [
                'rgba(245, 158, 11, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(34, 197, 94, 0.7)'
              ],
              borderColor: [
                document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                }
              }
            }
          }
        });
      }
    }

    function updateColorDistributionChart() {
      if (!colorDistribution || colorDistribution.length === 0) {
        return;
      }

      const colors = colorDistribution.map(item => item._id);
      const colorData = colorDistribution.map(item => item.count);
      const backgroundColors = colors.map(color => getColorHex(color));
      
      const ctx3 = document.getElementById('colorDistributionChart');
      if (ctx3) {
        // Check if chart instance exists and destroy it
        if (window.colorDistributionChart instanceof Chart) {
          window.colorDistributionChart.destroy();
        }
        
        window.colorDistributionChart = new Chart(ctx3, {
          type: 'doughnut',
          data: {
            labels: colors,
            datasets: [{
              data: colorData,
              backgroundColor: backgroundColors,
              borderColor: document.documentElement.classList.contains('dark') ? 
                Array(colors.length).fill('#1f2937') : 
                Array(colors.length).fill('#ffffff'),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                }
              }
            },
            cutout: '65%'
          }
        });
      }
    }
    
    // Update top sales staff
    function updateTopSalesStaff() {
      if (!topSalesStaff || topSalesStaff.length === 0) {
        return;
      }
      
      // Update UI
      const topSalesStaffEl = document.getElementById('topSalesStaff');
      topSalesStaffEl.innerHTML = '';
      
      topSalesStaff.forEach((staff, index) => {
        const staffEl = document.createElement('div');
        staffEl.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
        
        staffEl.innerHTML = `
          <div class="flex-shrink-0 w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center relative">
            <i class="bi bi-person-fill text-primary-500 dark:text-primary-400"></i>
            ${index === 0 ? '<span class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 bg-yellow-500 text-white rounded-full text-xs">1</span>' : ''}
          </div>
          <div class="flex-1">
            <h5 class="text-sm font-medium text-gray-900 dark:text-white">${staff._id}</h5>
            <p class="text-xs text-gray-500 dark:text-gray-400">${staff.totalUnits} เครื่อง - ฿${formatPrice(staff.totalAmount)}</p>
          </div>
        `;
        
        topSalesStaffEl.appendChild(staffEl);
      });
    }

    // Export to Excel functionality
    document.getElementById('btnExportSales').addEventListener('click', () => {
      // In a real app, this would generate an Excel file
      // For this example, we'll just show a toast notification
      showToast('กำลังส่งออกข้อมูลการขายเป็น Excel...', 'info');
      
      setTimeout(() => {
        showToast('ส่งออกข้อมูลสำเร็จ', 'success');
      }, 1500);
    });

    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `flex items-center p-4 mb-3 rounded-lg shadow-md animate__animated animate__fadeIn ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'warning' ? 'bg-yellow-500 text-white' : 
        'bg-primary-500 text-white'
      }`;
      
      // Icon based on type
      const iconClass = 
        type === 'success' ? 'bi-check-circle-fill' : 
        type === 'error' ? 'bi-x-circle-fill' : 
        type === 'warning' ? 'bi-exclamation-triangle-fill' : 
        'bi-info-circle-fill';
      
      toast.innerHTML = `
        <div class="flex-shrink-0 mr-3">
          <i class="bi ${iconClass} text-xl"></i>
        </div>
        <div class="text-sm font-medium">${message}</div>
        <button class="ml-auto">
          <i class="bi bi-x-lg"></i>
        </button>
      `;
      
      // Add to container
      toastContainer.appendChild(toast);
      
      // Close button functionality
      toast.querySelector('button').addEventListener('click', () => {
        toast.classList.add('animate__fadeOut');
        setTimeout(() => {
          toast.remove();
        }, 300);
      });
      
      // Auto close after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.add('animate__fadeOut');
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, 5000);
    }

    // Add event listeners for pagination
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        applyFiltersAndReload();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      currentPage++;
      applyFiltersAndReload();
    });

    // Add event listeners for filters
    document.getElementById('filterBranch').addEventListener('change', () => {
      currentPage = 1;
      applyFiltersAndReload();
    });

    document.getElementById('filterProduct').addEventListener('change', () => {
      currentPage = 1;
      applyFiltersAndReload();
    });

    document.getElementById('filterSalesPerson').addEventListener('change', () => {
      currentPage = 1;
      applyFiltersAndReload();
    });

    document.getElementById('salesSearch').addEventListener('input', () => {
      currentPage = 1;
      applyFiltersAndReload();
    });

    function applyFiltersAndReload() {
      const filters = {
        branch: document.getElementById('filterBranch').value,
        product: document.getElementById('filterProduct').value,
        salesperson: document.getElementById('filterSalesPerson').value,
        search: document.getElementById('salesSearch').value
      };
      
      // Remove empty filters
      Object.keys(filters).forEach(key => {
        if (!filters[key]) {
          delete filters[key];
        }
      });
      
      loadTodaySales(currentPage, filters);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
      initUserData();
      initDarkMode();
      
      // Load all data from API
      try {
        await Promise.all([
          loadTodaySummary(),
          loadTodaySales(),
          loadBranchStats(),
          loadProductDistribution(),
          loadColorDistribution(),
          loadTopSalesStaff(),
          loadBranches(),
          loadSalespersons()
        ]);
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
      }
    });
  </script>
</body>
</html>
        


