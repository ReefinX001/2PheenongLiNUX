<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö - Login Request Management</title>
  
  <!-- Favicon -->  
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase Realtime Database Enhanced -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp, onDisconnect, remove } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentSession = {
      branchCode: 'LOGIN_MANAGEMENT',
      sessionId: 'LOGIN_MGT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      staffId: localStorage.getItem('userId'),
      staffName: localStorage.getItem('userName'),
      timestamp: Date.now(),
      userRole: 'admin'
    };

    // Firebase References
    const sessionRef = ref(database, `sessions/login_management/${currentSession.sessionId}`);
    const notificationsRef = ref(database, 'notifications/login_management');
    const onlineUsersRef = ref(database, 'onlineUsers/login_management');
    const loginRequestsRef = ref(database, 'loginRequests/realtime');
    const systemStatsRef = ref(database, 'systemStats/login_management');
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let isFirebaseConnected = false;
    let lastNotificationTime = 0;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
    const connectedRef = ref(database, '.info/connected');
    onValue(connectedRef, (snapshot) => {
      isFirebaseConnected = snapshot.val() === true;
      window.isFirebaseConnected = isFirebaseConnected;
      console.log('üî• Firebase connection status:', isFirebaseConnected ? 'Connected' : 'Disconnected');
      
      if (isFirebaseConnected) {
        registerSession();
        setupOnDisconnect();
        
        if (typeof showToast === 'function') {
          showToast('üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Firebase
        updateFirebaseStatus(true);
      } else {
        if (typeof showToast === 'function') {
          showToast('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', 'warning');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Firebase
        updateFirebaseStatus(false);
      }
    });

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô session
    async function registerSession() {
      try {
        await set(sessionRef, {
          ...currentSession,
          status: 'online',
          lastActivity: serverTimestamp(),
          userAgent: navigator.userAgent,
          connectedAt: serverTimestamp(),
          page: 'login_management'
        });
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ online
        await set(ref(database, `onlineUsers/login_management/${currentSession.sessionId}`), {
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          sessionId: currentSession.sessionId,
          userRole: 'admin',
          connectedAt: serverTimestamp()
        });
        
        console.log('‚úÖ Login Management session registered to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to register session:', error);
      }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onDisconnect
    function setupOnDisconnect() {
      onDisconnect(sessionRef).set({
        ...currentSession,
        status: 'offline',
        lastActivity: serverTimestamp(),
        disconnectedAt: serverTimestamp()
      });
      
      onDisconnect(ref(database, `onlineUsers/login_management/${currentSession.sessionId}`)).remove();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    onValue(notificationsRef, (snapshot) => {
      const notifications = snapshot.val();
      if (notifications) {
        Object.entries(notifications).forEach(([key, notification]) => {
          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          if (notification.timestamp > (Date.now() - 120000) && notification.timestamp > lastNotificationTime) {
            if (typeof showToast === 'function') {
              showToast(`${notification.title}: ${notification.message}`, notification.type || 'info');
            }
            
            lastNotificationTime = notification.timestamp;
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ login ‡πÅ‡∏ö‡∏ö real-time
    onValue(loginRequestsRef, (snapshot) => {
      const data = snapshot.val();
      if (data && data.newRequest) {
        console.log('üîî New login request detected via Firebase:', data);
        
        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠
        if (typeof loadPendingRequests === 'function') {
          setTimeout(() => {
            loadPendingRequests();
          }, 500);
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (typeof showToast === 'function') {
          showToast(`üìù ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ${data.employeeName || data.username}`, 'info');
        }
        
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (typeof playNotificationSound === 'function') {
          playNotificationSound();
        }
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö
    onValue(systemStatsRef, (snapshot) => {
      const stats = snapshot.val();
      if (stats) {
        updateDashboardStats(stats);
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    onValue(onlineUsersRef, (snapshot) => {
      const users = snapshot.val() || {};
      const onlineCount = Object.keys(users).length;
      console.log(`üë• Login Management online users: ${onlineCount}`);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element
      const onlineCountEl = document.getElementById('onlineUserCount');
      if (onlineCountEl) {
        onlineCountEl.textContent = onlineCount;
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    window.sendNotificationToFirebase = function (notification) {
      if (!isFirebaseConnected) return;

      const notifRef = push(notificationsRef);
      set(notifRef, {
        ...notification,
        sessionId: currentSession.sessionId,
        timestamp: Date.now(),
        createdAt: serverTimestamp(),
        source: 'login_management'
      }).then(() => {
        console.log('‚úÖ Notification sent to Firebase');
      }).catch(err => {
        console.error('‚ùå Failed to send notification:', err);
      });
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Activity
    window.updateLoginManagementActivity = function (activity) {
      if (!isFirebaseConnected) return;
      
      set(ref(database, `sessions/login_management/${currentSession.sessionId}/lastActivity`), serverTimestamp());
      set(ref(database, `sessions/login_management/${currentSession.sessionId}/currentActivity`), activity);
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    window.updateLoginStatsToFirebase = function (stats) {
      if (!isFirebaseConnected) return;

      set(systemStatsRef, {
        ...stats,
        lastUpdated: serverTimestamp(),
        sessionId: currentSession.sessionId,
        timestamp: Date.now()
      }).then(() => {
        console.log('‚úÖ Stats updated to Firebase');
      }).catch(err => {
        console.error('‚ùå Failed to update stats:', err);
      });
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ login ‡πÉ‡∏´‡∏°‡πà
    window.sendLoginRequestToFirebase = function (requestData) {
      if (!isFirebaseConnected) return;

      set(loginRequestsRef, {
        newRequest: true,
        ...requestData,
        timestamp: Date.now(),
        sessionId: currentSession.sessionId
      }).then(() => {
        console.log('‚úÖ Login request sent to Firebase');
      }).catch(err => {
        console.error('‚ùå Failed to send login request:', err);
      });
    };

    // Heartbeat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤ session
    setInterval(() => {
      if (isFirebaseConnected) {
        set(ref(database, `sessions/login_management/${currentSession.sessionId}/lastHeartbeat`), serverTimestamp());
      }
    }, 30000); // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // Cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('beforeunload', () => {
      if (isFirebaseConnected) {
        set(ref(database, `sessions/login_management/${currentSession.sessionId}/status`), 'offline');
        remove(ref(database, `onlineUsers/login_management/${currentSession.sessionId}`));
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
    function updateFirebaseStatus(connected) {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        statusEl.className = connected ? 
          'w-2 h-2 rounded-full connected' : 
          'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 
          'Firebase: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' : 
          'Firebase: ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
      }
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
      if (typeof updateConnectionStatus === 'function') {
        updateConnectionStatus();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Dashboard
    function updateDashboardStats(stats) {
      console.log('üìä Updating login management stats:', stats);
      
      try {
        if (stats.pending !== undefined) {
          const pendingEl = document.getElementById('pendingCount');
          if (pendingEl) pendingEl.textContent = stats.pending;
        }
        
        if (stats.today) {
          if (stats.today.approved !== undefined) {
            const approvedEl = document.getElementById('approvedToday');
            if (approvedEl) approvedEl.textContent = stats.today.approved;
          }
          
          if (stats.today.rejected !== undefined) {
            const rejectedEl = document.getElementById('rejectedToday');
            if (rejectedEl) rejectedEl.textContent = stats.today.rejected;
          }
          
          if (stats.today.total !== undefined) {
            const totalEl = document.getElementById('totalToday');
            if (totalEl) totalEl.textContent = stats.today.total;
          }
        }
        
        console.log('‚úÖ Dashboard stats updated successfully');
      } catch (error) {
        console.error('‚ùå Error updating dashboard stats:', error);
      }
    }

    // Export functions
    window.updateFirebaseStatus = updateFirebaseStatus;
    window.currentSession = currentSession;
    window.isFirebaseConnected = isFirebaseConnected;

    console.log('üî• Firebase Realtime Database initialized for Login Management');
    console.log('üì± Session ID:', currentSession.sessionId);
  </script>

  <!-- Socket.IO Client Enhanced -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif']
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    };
  </script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
    }
    
    .pulse-badge {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

        .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Connection Status Styles */
    .connected {
      background-color: #10b981 !important;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
    }
    
    .disconnected {
      background-color: #ef4444 !important;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
    }
    
    .connecting {
      background-color: #f59e0b !important;
      box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.1);
      }
    }
  </style>

  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner { border-top-color: #10b981; }
    .loading-success .loading-progress-fill { background: #10b981; }

    .loading-warning .loading-spinner { border-top-color: #f59e0b; }
    .loading-warning .loading-progress-fill { background: #f59e0b; }

    .loading-error .loading-spinner { border-top-color: #ef4444; }
    .loading-error .loading-progress-fill { background: #ef4444; }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function(window) {
      'use strict';

      console.log('üöÄ LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-content';
    
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
    
        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    
        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';
    
          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }
    
        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);
    
        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function(options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();
    
            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);
    
            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }
    
            container.appendChild(overlay);
    
            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };
    
            activeLoaders.set(loaderId, loaderData);
    
            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }
    
            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }
    
            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });
    
            console.log(`‚úÖ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;
    
          } catch (error) {
            console.error('‚ùå LoadingSystem.show() error:', error);
            return null;
          }
        },
    
        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;
    
            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }
    
            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }
    
            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }
    
            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');
    
            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);
    
            console.log(`‚úÖ LoadingSystem.hide() - ID: ${loaderId}`);
    
          } catch (error) {
            console.error('‚ùå LoadingSystem.hide() error:', error);
          }
        },
    
        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`‚úÖ LoadingSystem.hideAll() - ‡∏ã‡πà‡∏≠‡∏ô ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('‚ùå LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function(loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
          } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function(loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
              }
            }
          } catch (error) {
            console.error('‚ùå LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function() {
          return activeLoaders.size;
        },

        cleanup: function() {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('üßπ LoadingSystem.cleanup() - ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
        },

        debug: function() {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('‚úÖ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

</head>
<body class="bg-gray-50 dark:bg-gray-900 dark:text-white min-h-screen">

    </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Header -->
  <div class="bg-white dark:bg-gray-800 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-primary-600">
            <i class="bi bi-arrow-left text-xl"></i>
          </a>
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Connection Status Indicator -->
          <div class="hidden md:flex items-center space-x-2 px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700">
            <div id="firebaseStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Firebase: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"></div>
            <div id="socketStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Socket.IO: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"></div>
            <span id="connectionStatus" class="text-xs text-gray-600 dark:text-gray-300">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
          </div>
          
          <button id="autoApproveToggle" class="flex items-center space-x-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition" 
                  title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ">
            <i class="bi bi-robot"></i>
            <span>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: <span id="autoApproveStatus">‡∏õ‡∏¥‡∏î</span></span>
            <i id="autoApproveIcon" class="bi bi-toggle-off text-lg"></i>
          </button>
          <button id="refreshBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
            <i class="bi bi-arrow-clockwise"></i>
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
          <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-moon-fill dark:hidden"></i>
            <i class="bi bi-sun-fill hidden dark:block"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
            <p id="pendingCount" class="text-3xl font-bold text-yellow-600">0</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center">
            <i class="bi bi-hourglass-split text-yellow-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="approvedToday" class="text-3xl font-bold text-green-600">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
            <i class="bi bi-check-circle-fill text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="rejectedToday" class="text-3xl font-bold text-red-600">0</p>
          </div>
          <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
            <i class="bi bi-x-circle-fill text-red-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="totalToday" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
            <i class="bi bi-calendar-check text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
          <select id="statusFilter" class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
            <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="dateFilter" class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700">
        </div>
        
        <div class="flex-1">
          <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ username..." 
                 class="w-full px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700">
        </div>
        
        <button id="clearFilters" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">
          <i class="bi bi-x-lg mr-1"></i>
          ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        </button>
      </div>
    </div>

    <!-- Pending Requests -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <span id="pendingBadge" class="w-3 h-3 bg-yellow-500 rounded-full pulse-badge"></span>
            ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </h2>
          <div class="flex items-center gap-2">
            <button id="approveAllBtn" class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-1">
              <i class="bi bi-check-all"></i>
              ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button id="rejectAllBtn" class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm flex items-center gap-1">
              <i class="bi bi-x-lg"></i>
              ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                <input type="checkbox" id="selectAllPending" class="rounded">
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/IP</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="pendingRequestsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Request History -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</h2>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
          </thead>
          <tbody id="historyTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <div class="text-sm text-gray-500 dark:text-gray-400">
          ‡πÅ‡∏™‡∏î‡∏á <span id="showingCount">0</span> ‡∏à‡∏≤‡∏Å <span id="totalCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
        <div class="flex gap-2">
          <button id="prevPage" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button id="nextPage" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Approve/Reject Modal -->
  <div id="actionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full mx-4">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 id="modalTitle" class="text-lg font-semibold">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
          <textarea id="actionNote" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
        </div>
        <div class="flex justify-end gap-3">
          <button onclick="closeActionModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button id="confirmActionBtn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notificationSound" preload="auto">
    <source src="/sounds/notification.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Global variables
    let pendingRequests = [];
    let historyRequests = [];
    let selectedRequests = new Set();
    let currentPage = 1;
    const pageSize = 10;
    let autoApproveEnabled = false;
    let refreshInterval = null;
    let currentActionCallback = null;
    let socket = null;
    
    // Auth error handling
    function handleApiError(error, response) {
      if (response && response.status === 401) {
        const errorCode = error.code || '';
        switch (errorCode) {
          case 'TOKEN_EXPIRED':
            alert('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            clearAuthAndRedirect();
            break;
    
          case 'TOKEN_REVOKED':
            alert('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            clearAuthAndRedirect();
            break;
    
          case 'SESSION_EXPIRED':
            alert('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏∏‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            clearAuthAndRedirect();
            break;
    
          case 'USER_NOT_FOUND':
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
            clearAuthAndRedirect();
            break;
    
          case 'NO_TOKEN':
          case 'INVALID_TOKEN':
          case 'INVALID_TOKEN_FORMAT':
          case 'INCOMPLETE_TOKEN_DATA':
            alert('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            clearAuthAndRedirect();
            break;
    
          default:
            alert(error.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
            clearAuthAndRedirect();
        }
      } else if (response && response.status === 403) {
        if (error.code === 'ACCOUNT_BLOCKED') {
          alert(`‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å: ${error.reason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'}`);
          clearAuthAndRedirect();
        } else {
          alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ');
        }
      }
    }
    
    // Clear auth data and redirect
    function clearAuthAndRedirect() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('userData');
      localStorage.removeItem('userRole');
      localStorage.removeItem('allowedPages');
      localStorage.removeItem('selectedBranch');
      localStorage.removeItem('defaultBranch');
      sessionStorage.clear();
      window.location.href = '/login.html';
    }
    
    // Fetch wrapper with auth
    async function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        clearAuthAndRedirect();
        return;
      }

      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      };

      try {
        const response = await fetch(url, { ...options, ...defaultOptions });
    
        if (!response.ok) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const contentType = response.headers.get('content-type');
          let errorData;
    
          if (contentType && contentType.includes('application/json')) {
            try {
              errorData = await response.json();
            } catch (parseError) {
              errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
            }
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πà‡∏ô HTML error page)
            errorData = {
              error: `HTTP ${response.status}: ${response.statusText}`,
              details: 'Server returned non-JSON response'
            };
          }
    
          handleApiError(errorData, response);
    
          if (response.status === 401 || response.status === 403) {
            throw new Error('Authentication failed');
          }
    
          throw new Error(errorData.error || 'Request failed');
        }
    
        return response;
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const pageLoaderId = LoadingSystem.show({
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...',
          showProgress: true,
          autoProgress: true,
          spinnerType: 'default'
        });
    
        checkAuth();
        setupEventListeners();
        setupSocketIO();
        loadData();
        startAutoRefresh();
        setupDarkMode();
        loadAutoApprovalSettings();
    
        LoadingSystem.completeProgress();
    
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°
        setTimeout(() => {
          if (window.isFirebaseConnected && socket && socket.connected) {
            showToast('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö Login Management ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (Firebase + Socket.IO)', 'success');
          } else if (window.isFirebaseConnected || (socket && socket.connected)) {
            showToast('‚ö° ‡∏£‡∏∞‡∏ö‡∏ö Login Management ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)', 'info');
          } else {
            showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö Login Management ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)', 'warning');
          }
    
          console.log('üéâ Login Management System fully loaded!');
          console.log('üìä Connection status:', {
            firebase: window.isFirebaseConnected,
            socket: socket && socket.connected,
            sessionId: window.currentSession?.sessionId
          });
        }, 2000);
    
      } catch (error) {
        console.error('Page loading error:', error);
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö', 'error');
      } finally {
        LoadingSystem.completeProgress();
      }
    });
    
    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
        return;
      }
    
      // Check permissions
      const userRole = localStorage.getItem('userRole');
      const allowedPages = JSON.parse(localStorage.getItem('allowedPages') || '[]');
      if (userRole !== 'admin' && !allowedPages.includes('hr') && !allowedPages.includes('*')) {
        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
        window.location.href = '/';
        return;
      }
    }
    
    // Setup Socket.IO Enhanced
    function setupSocketIO() {
      if (typeof io !== 'undefined') {
        socket = io({
          timeout: 10000,
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          auth: {
            token: localStorage.getItem('authToken')
          }
        });
    
        // Connection Events
        socket.on('connect', () => {
          console.log('‚úÖ Socket.IO connected:', socket.id);
          updateSocketStatus(true);
    
          // Join login management room
          socket.emit('join_login_management', {
            sessionId: window.currentSession?.sessionId,
            userRole: 'admin',
            userName: localStorage.getItem('userName')
          });
    
          showToast('üîå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Real-time ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        });
    
        socket.on('disconnect', (reason) => {
          console.log('‚ùå Socket.IO disconnected:', reason);
          updateSocketStatus(false);
          showToast('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Real-time ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', 'warning');
        });
    
        socket.on('reconnect', (attemptNumber) => {
          console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
          updateSocketStatus(true);
          showToast('üîÑ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Real-time ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'success');
        });
    
        socket.on('reconnect_error', (error) => {
          console.error('üîÑ‚ùå Reconnection failed:', error);
          updateSocketStatus(false);
        });
    
        // Login Request Events
        socket.on('loginRequestCreated', (data) => {
          console.log('üîî New login request via Socket:', data);
          showToast(`üìù ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ${data.employeeName || data.username}`, 'info');
          playNotificationSound();
          loadPendingRequests();
    
          // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
          if (typeof sendNotificationToFirebase === 'function') {
            sendNotificationToFirebase({
              type: 'info',
              title: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà',
              message: `${data.employeeName || data.username} ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö`,
              data: data
            });
          }
    
          // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase Real-time
          if (typeof sendLoginRequestToFirebase === 'function') {
            sendLoginRequestToFirebase(data);
          }
        });
    
        socket.on('loginRequestUpdated', (data) => {
          console.log('üìù Login request updated:', data);
          loadData();
          showToast(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${data.status}`, 'info');
        });
    
        socket.on('loginRequestApproved', (data) => {
          console.log('‚úÖ Login request approved:', data);
          loadData();
          showToast(`‚úÖ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${data.employeeName || data.username} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, 'success');
        });
    
        socket.on('loginRequestRejected', (data) => {
          console.log('‚ùå Login request rejected:', data);
          loadData();
          showToast(`‚ùå ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${data.employeeName || data.username} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, 'error');
        });
    
        // Auto Approval Events
        socket.on('autoApprovalStatusChanged', (data) => {
          console.log('ü§ñ Auto approval status changed via Socket:', data);
    
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
          updateAutoApprovalUI(data.enabled);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          const message = data.enabled ?
            `ü§ñ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.changedBy ? `‡πÇ‡∏î‡∏¢ ${data.changedBy}` : ''}` :
            `ü§ñ ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.changedBy ? `‡πÇ‡∏î‡∏¢ ${data.changedBy}` : ''}`;
    
          showToast(message, 'info');
        });
    
        socket.on('autoApprovalExecuted', (data) => {
          console.log('ü§ñ Auto approval executed via Socket:', data);
    
          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          loadData();
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          if (data.approvedCount > 0) {
            const message = `ü§ñ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${data.approvedCount} ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
            showToast(message, 'success');
    
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            playNotificationSound();
          }
        });
    
        // ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô toggle auto-approval
        socket.on('autoApprovalToggled', (data) => {
          console.log('üîÑ Auto approval toggled by another user:', data);
    
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
          const currentUser = localStorage.getItem('userName');
          if (data.changedBy && data.changedBy !== currentUser) {
            updateAutoApprovalUI(data.enabled);
    
            const message = `üîÑ ${data.changedBy} ${data.enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
            showToast(message, 'info');
          }
        });
    
        // System Stats Events
        socket.on('loginStatsUpdated', (data) => {
          console.log('üìä Login stats updated via Socket:', data);
          updateStatsFromAPI(data);
    
          // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
          if (typeof updateLoginStatsToFirebase === 'function') {
            updateLoginStatsToFirebase(data);
          }
        });
    
        // Error Handling
        socket.on('connect_error', (error) => {
          console.error('‚ùå Socket connection error:', error);
          updateSocketStatus(false);
    
          if (error.type === 'TransportError' && error.message.includes('401')) {
            showToast('üîê ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'warning');
            setTimeout(() => location.reload(), 2000);
          } else {
            showToast('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
          }
        });
    
        socket.on('error', (error) => {
          console.error('‚ùå Socket error:', error);
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Real-time', 'error');
        });
    
        // Heartbeat
        setInterval(() => {
          if (socket && socket.connected) {
            socket.emit('heartbeat', {
              sessionId: window.currentSession?.sessionId,
              timestamp: Date.now(),
              page: 'login_management'
            });
          }
        }, 30000); // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      }
    }
    
    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('statusFilter').addEventListener('change', filterRequests);
      document.getElementById('dateFilter').addEventListener('change', filterRequests);
      document.getElementById('searchInput').addEventListener('input', filterRequests);
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      document.getElementById('selectAllPending').addEventListener('change', toggleSelectAll);
      document.getElementById('approveAllBtn').addEventListener('click', approveSelected);
      document.getElementById('rejectAllBtn').addEventListener('click', rejectSelected);
      document.getElementById('autoApproveToggle').addEventListener('click', toggleAutoApproval);
      document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
      document.getElementById('nextPage').addEventListener('click', () => changePage(1));
    }
    
    // Dark mode setup
    function setupDarkMode() {
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
      }
    
      darkModeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
      });
    }
    
    // Load all data
    async function loadData() {
      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        showProgress: true,
        autoProgress: true
      });
      try {
        await Promise.all([
          loadPendingRequests(),
          loadRequestHistory()
        ]);
        updateStats();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      } finally {
        hideLoading();
      }
    }
    
    // Load pending requests
    async function loadPendingRequests() {
      try {
        const response = await fetchWithAuth('/api/users/login-requests');
        const data = await response.json();
    
        if (data.success) {
          const oldCount = pendingRequests.length;
    
          // Map the data properly to match what createPendingRequestRow expects
          pendingRequests = (data.data || []).map(req => ({
            requestId: req.requestId,
            username: req.username,
            employeeName: req.employeeName,
            reason: req.reason,
            createdAt: req.createdAt,
            expiresAt: req.expiresAt,
            photoUrl: req.photoUrl,
            device: req.device || 'Unknown',
            ipAddress: req.ipAddress || req.ip || '-',
            status: req.status
          }));
    
          // Play sound if new requests arrived
          if (pendingRequests.length > oldCount && oldCount > 0) {
            playNotificationSound();
            showToast(`‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà ${pendingRequests.length - oldCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'info');
          }
    
          renderPendingRequests();
    
          // ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô backend ‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô frontend
          console.log('üìã Pending requests loaded. Auto-approval running in backend.');
        }
      } catch (error) {
        console.error('Error loading pending requests:', error);
        if (error.message !== 'Authentication failed') {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'error');
        }
      }
    }
    
    // Load request history - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    async function loadRequestHistory() {
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: pageSize
        });
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° filter parameters
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const searchInput = document.getElementById('searchInput').value;
        if (statusFilter && statusFilter !== '') {
          params.append('status', statusFilter);
        }
    
        if (dateFilter) {
          params.append('startDate', dateFilter);
          params.append('endDate', dateFilter);
        }
    
        if (searchInput.trim()) {
          params.append('search', searchInput.trim());
        }
    
        const response = await fetchWithAuth(`/api/users/login-requests/history?${params}`);
        const data = await response.json();
    
        if (data.success) {
          historyRequests = data.data || [];
    
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
          if (data.stats) {
            updateStatsFromAPI(data.stats);
          }
    
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï pagination
          if (data.pagination) {
            updatePaginationFromAPI(data.pagination);
          }
    
        renderRequestHistory();
        } else {
          throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥');
        }
      } catch (error) {
        console.error('Error loading request history:', error);
        if (error.message !== 'Authentication failed') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', 'error');
        }
        historyRequests = [];
        renderRequestHistory();
      }
    }
    
    // Render pending requests
    function renderPendingRequests() {
      const tbody = document.getElementById('pendingRequestsTableBody');
      tbody.innerHTML = '';
      if (pendingRequests.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </td>
          </tr>
        `;
        document.getElementById('pendingBadge').classList.add('hidden');
        return;
      }
    
      document.getElementById('pendingBadge').classList.remove('hidden');
      pendingRequests.forEach(request => {
        const row = createPendingRequestRow(request);
        tbody.appendChild(row);
      });
    }
    
    // Create pending request row
    function createPendingRequestRow(request) {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors slide-in';
      // Get device and IP from request
      const device = request.device || 'Unknown';
      const ipAddress = request.ipAddress || request.ip || '-';
      tr.innerHTML = `
        <td class="px-6 py-4">
          <input type="checkbox" class="request-checkbox rounded" data-id="${request.requestId}" 
                 onchange="toggleRequestSelection('${request.requestId}')">
        </td>
        <td class="px-6 py-4">
          <div class="flex items-center">
            <div class="relative">
              ${request.photoUrl ?
                `<img src="${request.photoUrl}" alt="${request.employeeName}" class="w-10 h-10 rounded-full" onerror="this.onerror=null; this.src='/images/default-avatar.png'">` :
                `<div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center text-primary-600 dark:text-primary-300 font-medium">
                  ${(request.employeeName || request.username).charAt(0).toUpperCase()}
                </div>`
              }
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-900 dark:text-white">${request.employeeName || request.username}</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">${request.username}</p>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
          <div>${formatDateTime(new Date(request.createdAt))}</div>
          <div class="text-xs">${getTimeAgo(new Date(request.createdAt))}</div>
        </td>
        <td class="px-6 py-4 text-sm">
          ${request.reason || '<span class="text-gray-400">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>'}
        </td>
        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
          <div class="flex items-center gap-1">
            <i class="bi bi-${device === 'Mobile' ? 'phone' : 'laptop'}"></i>
            ${device}
          </div>
          <div class="text-xs">${ipAddress}</div>
        </td>
        <td class="px-6 py-4 text-sm">
          <div class="flex items-center gap-2">
            <button onclick="approveRequest('${request.requestId}')" 
                    class="text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 font-medium flex items-center gap-1">
              <i class="bi bi-check-circle"></i>
              ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </button>
            <button onclick="rejectRequest('${request.requestId}')" 
                    class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium flex items-center gap-1">
              <i class="bi bi-x-circle"></i>
              ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
            </button>
          </div>
        </td>
      `;
    
      return tr;
    }
    
    // Render request history
    function renderRequestHistory() {
      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = '';
      if (historyRequests.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
            </td>
          </tr>
        `;
        return;
      }
    
      historyRequests.forEach(request => {
        const row = createHistoryRow(request);
        tbody.appendChild(row);
      });
    }
    
    // Create history row
    function createHistoryRow(request) {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors fade-in';
      const statusBadge = getStatusBadge(request.status);
    
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      const approverInfo = request.approver ?
        `${request.approver.name || request.approver.username}` :
        (request.approverName || '-');
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
      const processedTime = request.processedAt ?
        formatDateTime(new Date(request.processedAt)) :
        (request.approvedAt ? formatDateTime(new Date(request.approvedAt)) : '-');
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      const additionalInfo = [];
      if (request.device) additionalInfo.push(`‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${request.device}`);
      if (request.ipAddress) additionalInfo.push(`IP: ${request.ipAddress}`);
      if (request.usageCount > 0) additionalInfo.push(`‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${request.usageCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
    
      tr.innerHTML = `
        <td class="px-6 py-4">
          <div class="flex items-center">
            ${request.photoUrl ?
              `<img src="${request.photoUrl}" alt="${request.employeeName}" class="w-8 h-8 rounded-full mr-3" onerror="this.style.display='none'">` :
              `<div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center text-primary-600 dark:text-primary-300 font-medium mr-3 text-sm">
                ${(request.employeeName || request.username).charAt(0).toUpperCase()}
              </div>`
            }
            <div>
              <p class="text-sm font-medium text-gray-900 dark:text-white">${request.employeeName || request.username}</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">${request.username}</p>
              ${additionalInfo.length > 0 ? `<p class="text-xs text-gray-400">${additionalInfo.join(' ‚Ä¢ ')}</p>` : ''}
            </div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
          <div>${formatDateTime(new Date(request.createdAt))}</div>
          <div class="text-xs">${getTimeAgo(new Date(request.createdAt))}</div>
        </td>
        <td class="px-6 py-4">
          ${statusBadge}
          ${request.status === 'used' && request.loginSuccessAt ?
            `<div class="text-xs text-green-600 mt-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${formatDateTime(new Date(request.loginSuccessAt))}</div>` : ''}
        </td>
        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
          ${approverInfo}
        </td>
        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
          ${processedTime}
        </td>
        <td class="px-6 py-4 text-sm">
          <div class="max-w-xs">
            ${request.approverNote || request.reason || '-'}
            ${request.auditLog && request.auditLog.length > 0 ?
              `<button onclick="showAuditLog('${request.requestId}')" class="text-blue-600 hover:text-blue-700 text-xs block mt-1">
                <i class="bi bi-clock-history mr-1"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (${request.auditLog.length})
              </button>` : ''}
          </div>
        </td>
      `;
    
      return tr;
    }
    
    // Get status badge
    function getStatusBadge(status) {
      const badges = {
        pending: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"><i class="bi bi-hourglass-split mr-1"></i>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
        approved: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"><i class="bi bi-check-circle mr-1"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>',
        rejected: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"><i class="bi bi-x-circle mr-1"></i>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß</span>',
        expired: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300"><i class="bi bi-clock-history mr-1"></i>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>',
        used: '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"><i class="bi bi-check2-all mr-1"></i>‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>'
      };
      return badges[status] || status;
    }
    
    // Update statistics
    function updateStats() {
      const today = new Date().toDateString();
      const todayRequests = [...pendingRequests, ...historyRequests].filter(
        req => new Date(req.createdAt).toDateString() === today
      );
    
      const approvedToday = todayRequests.filter(req => req.status === 'approved').length;
      const rejectedToday = todayRequests.filter(req => req.status === 'rejected').length;
      document.getElementById('pendingCount').textContent = pendingRequests.length;
      document.getElementById('approvedToday').textContent = approvedToday;
      document.getElementById('rejectedToday').textContent = rejectedToday;
      document.getElementById('totalToday').textContent = todayRequests.length;
    }
    
    // Update statistics from API
    function updateStatsFromAPI(stats) {
      document.getElementById('pendingCount').textContent = stats.pending || 0;
      document.getElementById('approvedToday').textContent = stats.today.approved || 0;
      document.getElementById('rejectedToday').textContent = stats.today.rejected || 0;
      document.getElementById('totalToday').textContent = stats.today.total || 0;
    }
    
    // Update pagination from API
    function updatePaginationFromAPI(pagination) {
      document.getElementById('showingCount').textContent = pagination.itemsPerPage;
      document.getElementById('totalCount').textContent = pagination.totalItems;
      document.getElementById('prevPage').disabled = pagination.currentPage === 1;
      document.getElementById('nextPage').disabled = pagination.currentPage >= pagination.totalPages;
      currentPage = pagination.currentPage;
    }
    
    // Request actions
    async function approveRequest(requestId) {
      showActionModal('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', async (note) => {
        await processRequest(requestId, true, note);
      });
    }
    
    async function rejectRequest(requestId) {
      showActionModal('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', async (note) => {
        if (!note) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', 'error');
          return false;
        }
        await processRequest(requestId, false, note);
        return true;
      }, true);
    }
    
    async function processRequest(requestId, approved, note) {
      try {
        const response = await fetchWithAuth(`/api/users/login-request/${requestId}/approve`, {
          method: 'POST',
          body: JSON.stringify({ approved, approverNote: note })
        });
    
        const data = await response.json();
    
        if (data.success) {
          showToast(`${approved ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'}‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
          loadData();
          closeActionModal();
        } else {
          showToast(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      } catch (error) {
        console.error('Process request error:', error);
        if (error.message !== 'Authentication failed') {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 'error');
        }
      }
    }
    
    // Bulk actions
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllPending');
      const checkboxes = document.querySelectorAll('.request-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        if (selectAll.checked) {
          selectedRequests.add(cb.dataset.id);
        } else {
          selectedRequests.delete(cb.dataset.id);
        }
      });
    }
    
    window.toggleRequestSelection = function(requestId) {
      if (selectedRequests.has(requestId)) {
        selectedRequests.delete(requestId);
      } else {
        selectedRequests.add(requestId);
      }
    };
    
    async function approveSelected() {
      if (selectedRequests.size === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'error');
        return;
      }
    
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${selectedRequests.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    
      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        showProgress: true,
        autoProgress: true
      });
    
      try {
        for (const requestId of selectedRequests) {
          await processRequest(requestId, true, '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°');
        }
    
        selectedRequests.clear();
        document.getElementById('selectAllPending').checked = false;
      } catch (error) {
        console.error('Error approving requests:', error);
      } finally {
        hideLoading();
      }
    }
    
    async function rejectSelected() {
      if (selectedRequests.size === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', 'error');
        return;
      }
    
      const reason = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:');
      if (!reason) return;
    
      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
        showProgress: true,
        autoProgress: true
      });
    
      try {
        for (const requestId of selectedRequests) {
          await processRequest(requestId, false, reason);
        }
    
        selectedRequests.clear();
        document.getElementById('selectAllPending').checked = false;
      } catch (error) {
        console.error('Error rejecting requests:', error);
      } finally {
        hideLoading();
      }
    }
    
    // Auto-approval toggle functionality
    async function toggleAutoApproval() {
      const status = document.getElementById('autoApproveStatus');
      const icon = document.getElementById('autoApproveIcon');
      if (!status || !icon) {
        console.error('Auto-approval elements not found');
        return;
      }
    
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      const currentlyEnabled = status.textContent.trim() === '‡πÄ‡∏õ‡∏¥‡∏î';
      const newEnabled = !currentlyEnabled;
    
      console.log(`ü§ñ Toggling auto-approval: ${currentlyEnabled} -> ${newEnabled}`);
    
      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading state
        const loaderId = LoadingSystem.show({
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤...',
          showProgress: true,
          autoProgress: true
        });
    
        // Update UI first for better UX
        status.textContent = newEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        icon.className = newEnabled ? 'bi bi-toggle-on text-lg text-green-500' : 'bi bi-toggle-off text-lg';
        autoApproveEnabled = newEnabled; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    
        // Call API to toggle auto-approval
        const response = await fetchWithAuth('/api/users/auto-approval/toggle', {
          method: 'POST',
          body: JSON.stringify({ enabled: newEnabled })
        });
    
        const result = await response.json();
    
        if (!result.success) {
          throw new Error(result.error || result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showToast(
          newEnabled ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
          'success'
        );
    
        // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
        if (typeof sendNotificationToFirebase === 'function') {
          sendNotificationToFirebase({
            type: 'info',
            title: '‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
            message: `${newEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`,
            data: { enabled: newEnabled, changedBy: localStorage.getItem('userName') }
          });
        }
    
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Socket.IO
        if (socket && socket.connected) {
          socket.emit('autoApprovalToggled', {
            enabled: newEnabled,
            changedBy: localStorage.getItem('userName'),
            timestamp: Date.now()
          });
        }
    
        // If enabled, refresh data to see changes
        if (newEnabled) {
          console.log('üîÑ Auto-approval enabled, refreshing data...');
          setTimeout(() => loadData(), 1000);
        }
    
        console.log(`‚úÖ Auto-approval successfully ${newEnabled ? 'enabled' : 'disabled'}`);
    
      } catch (error) {
        console.error('‚ùå Error toggling auto-approval:', error);
    
        // Revert UI state on error (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£ revert)
        status.textContent = currentlyEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        icon.className = currentlyEnabled ? 'bi bi-toggle-on text-lg text-green-500' : 'bi bi-toggle-off text-lg';
        autoApproveEnabled = currentlyEnabled; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        const errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorMessage, 'error');
    
      } finally {
        // ‡∏ã‡πà‡∏≠‡∏ô loading state
        LoadingSystem.hideAll();
      }
    }
    
    // Manual auto-approval trigger
    async function runAutoApproval() {
      console.log('ü§ñ Running manual auto-approval...');
    
      try {
        const loaderId = LoadingSystem.show({
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...',
          showProgress: true,
          autoProgress: true
        });
    
        const response = await fetchWithAuth('/api/users/auto-approval/run', {
          method: 'POST'
        });
    
        const result = await response.json();
    
        if (!result.success) {
          throw new Error(result.error || result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        if (result.approvedCount > 0) {
          showToast(`ü§ñ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ${result.approvedCount} ‡∏Ñ‡∏≥‡∏Ç‡∏≠`, 'success');
    
          // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
          if (typeof sendNotificationToFirebase === 'function') {
            sendNotificationToFirebase({
              type: 'success',
              title: '‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
              message: `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ${result.approvedCount} ‡∏Ñ‡∏≥‡∏Ç‡∏≠`,
              data: { approvedCount: result.approvedCount, triggeredBy: localStorage.getItem('userName') }
            });
          }
    
          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          setTimeout(() => loadData(), 500);
    
        } else {
          showToast('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'info');
        }
    
        console.log(`‚úÖ Manual auto-approval completed. Approved: ${result.approvedCount || 0} requests`);
    
      } catch (error) {
        console.error('‚ùå Error running auto-approval:', error);
        const errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorMessage, 'error');
    
      } finally {
        LoadingSystem.hideAll();
      }
    }
    
    // Helper function to update auto-approval UI status
    function updateAutoApprovalUI(enabled) {
      const status = document.getElementById('autoApproveStatus');
      const icon = document.getElementById('autoApproveIcon');
    
      if (status && icon) {
        status.textContent = enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
        icon.className = enabled ? 'bi bi-toggle-on text-lg text-green-500' : 'bi bi-toggle-off text-lg';
        autoApproveEnabled = enabled;
    
        console.log(`üéõÔ∏è Auto-approval UI updated: ${enabled ? 'enabled' : 'disabled'}`);
      }
    }
    
    // Helper function to get current auto-approval status
    function getCurrentAutoApprovalStatus() {
      const status = document.getElementById('autoApproveStatus');
      return status ? status.textContent.trim() === '‡πÄ‡∏õ‡∏¥‡∏î' : false;
    }
    
    // Load auto-approval settings on page load
    async function loadAutoApprovalSettings() {
      console.log('üîÑ Loading auto-approval settings...');
    
      try {
        const response = await fetchWithAuth('/api/users/auto-approval/settings');
        const settings = await response.json();
    
        if (settings.success && settings.data) {
          const isEnabled = settings.data.enabled || false;
          const status = document.getElementById('autoApproveStatus');
          const icon = document.getElementById('autoApproveIcon');
    
          if (status && icon) {
            status.textContent = isEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
            icon.className = isEnabled ? 'bi bi-toggle-on text-lg text-green-500' : 'bi bi-toggle-off text-lg';
            autoApproveEnabled = isEnabled; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    
            console.log(`‚úÖ Auto-approval settings loaded: ${isEnabled ? 'enabled' : 'disabled'}`);
          }
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (settings.data.lastChanged) {
            console.log(`üìÖ Last changed: ${new Date(settings.data.lastChanged).toLocaleString('th-TH')}`);
          }
    
        } else {
          throw new Error(settings.error || settings.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ');
        }
    
      } catch (error) {
        console.error('‚ùå Error loading auto-approval settings:', error);
    
        // Set default UI state on error
        const status = document.getElementById('autoApproveStatus');
        const icon = document.getElementById('autoApproveIcon');
    
        if (status) {
          status.textContent = '‡∏õ‡∏¥‡∏î';
        }
        if (icon) {
          icon.className = 'bi bi-toggle-off text-lg';
        }
    
        autoApproveEnabled = false; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å
        if (error.message !== 'Authentication failed') {
          console.warn('‚ö†Ô∏è Cannot load auto-approval settings, using default (disabled)');
        }
      }
    }
    
    // Filter functions
    function filterRequests() {
      currentPage = 1; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
      loadRequestHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ filter
    }
    
    function clearFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('dateFilter').value = '';
      document.getElementById('searchInput').value = '';
      currentPage = 1;
      loadRequestHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á filter
    }
    
    // Show audit log modal
    window.showAuditLog = function(requestId) {
      const request = historyRequests.find(r => r.requestId === requestId);
      if (!request || !request.auditLog) return;
    
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full mx-4 max-h-96 overflow-hidden">
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ - ${requestId}</h3>
          </div>
          <div class="p-6 overflow-y-auto max-h-80">
            <div class="space-y-3">
              ${request.auditLog.map(log => `
                <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                  <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                  <div class="flex-1">
                    <div class="flex items-center justify-between">
                      <span class="font-medium text-sm">${getActionText(log.action)}</span>
                      <span class="text-xs text-gray-500">${formatDateTime(new Date(log.performedAt))}</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${log.details || '-'}</p>
                    <div class="text-xs text-gray-500 mt-1">
                      ‡πÇ‡∏î‡∏¢: ${log.performedBy === 'system' ? '‡∏£‡∏∞‡∏ö‡∏ö' : log.performedBy}
                      ${log.ipAddress ? ` ‚Ä¢ IP: ${log.ipAddress}` : ''}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
            <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
              ‡∏õ‡∏¥‡∏î
            </button>
          </div>
        </div>
      `;
    
      document.body.appendChild(modal);
    
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    };
    
    // Get action text in Thai
    function getActionText(action) {
      const actions = {
        'created': '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠',
        'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        'rejected': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
        'expired': '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏',
        'used': '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        'token_created': '‡∏™‡∏£‡πâ‡∏≤‡∏á Token',
        'login_success': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'logout': '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'
      };
      return actions[action] || action;
    }
    
    // Pagination
    function changePage(direction) {
      currentPage += direction;
      loadRequestHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
    }
    
    // Modal functions
    function showActionModal(title, onConfirm, requireNote = false) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('actionNote').value = '';
      document.getElementById('actionNote').required = requireNote;
      document.getElementById('actionModal').classList.remove('hidden');
      currentActionCallback = onConfirm;
    
      const confirmBtn = document.getElementById('confirmActionBtn');
      confirmBtn.onclick = async () => {
        const note = document.getElementById('actionNote').value;
        const result = await currentActionCallback(note);
        if (result !== false) {
          closeActionModal();
        }
      };
    }
    
    window.closeActionModal = function() {
      document.getElementById('actionModal').classList.add('hidden');
      currentActionCallback = null;
    };
    
    // Utility functions
    function formatDateTime(date) {
      return date.toLocaleString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function getTimeAgo(date) {
      const diff = Date.now() - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
    
      if (days > 0) return `${days} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      if (hours > 0) return `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      if (minutes > 0) return `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    }
    
    function playNotificationSound() {
      try {
        const audio = document.getElementById('notificationSound');
        if (audio) {
          audio.play().catch(() => {});
        }
      } catch (error) {
        console.error('Error playing sound:', error);
      }
    }
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const colors = {
        success: 'bg-green-100 text-green-800 border-green-500',
        error: 'bg-red-100 text-red-800 border-red-500',
        info: 'bg-blue-100 text-blue-800 border-blue-500',
        warning: 'bg-yellow-100 text-yellow-800 border-yellow-500'
      };
    
      const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-x-circle-fill',
        info: 'bi-info-circle-fill',
        warning: 'bi-exclamation-triangle-fill'
      };
    
      toast.className = `px-4 py-3 rounded-lg shadow-lg mb-3 flex items-center border-l-4 ${colors[type]} fade-in`;
      toast.innerHTML = `
        <i class="bi ${icons[type]} mr-2"></i>
        <span>${message}</span>
      `;
    
      container.appendChild(toast);
    
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function hideLoading() {
      // Check if loadingOverlay element exists (fallback for compatibility)
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
      }
    
      // Use LoadingSystem to hide loading if available
      if (typeof LoadingSystem !== 'undefined' && LoadingSystem.hide) {
        LoadingSystem.hide();
      }
    }
    
    // Enhanced Auto refresh with Firebase and Socket.IO integration
    function startAutoRefresh() {
      refreshInterval = setInterval(async () => {
        try {
          await loadPendingRequests();
    
          // Update activity
          trackActivity('auto_refresh');
    
          // Send heartbeat to Firebase and Socket.IO
          if (window.isFirebaseConnected) {
            if (typeof updateLoginManagementActivity === 'function') {
              updateLoginManagementActivity({
                type: 'heartbeat',
                timestamp: Date.now()
              });
            }
          }
    
          if (socket && socket.connected) {
            socket.emit('heartbeat', {
              sessionId: window.currentSession?.sessionId,
              timestamp: Date.now(),
              page: 'login_management'
            });
          }
    
          console.log('üîÑ Enhanced auto refresh completed with Firebase/Socket.IO sync');
        } catch (error) {
          console.error('Auto refresh error:', error);
          // Don't show error toast for auto refresh failures
        }
      }, 15000); // Refresh every 15 seconds
    }
    
    // Enhanced Cleanup for Firebase and Socket.IO
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up Login Management resources...');
    
      // Track page unload
      trackActivity('page_unloaded');
    
      // Clear intervals
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    
      // Firebase cleanup
      if (window.isFirebaseConnected && window.currentSession) {
        try {
          // Send offline status to Firebase
          if (typeof updateLoginManagementActivity === 'function') {
            updateLoginManagementActivity({
              type: 'session_ended',
              timestamp: Date.now()
            });
          }
    
          console.log('‚úÖ Firebase cleanup completed');
        } catch (error) {
          console.error('‚ùå Firebase cleanup error:', error);
        }
      }
    
      // Socket.IO cleanup
      if (socket) {
        try {
          // Send goodbye message
          socket.emit('leave_login_management', {
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now()
          });
    
          // Disconnect socket
          socket.disconnect();
          console.log('‚úÖ Socket.IO cleanup completed');
        } catch (error) {
          console.error('‚ùå Socket.IO cleanup error:', error);
        }
      }
    
      console.log('üßπ Login Management cleanup completed');
    });
    
    // Enhanced page visibility handling
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        console.log('üëÅÔ∏è Page became visible - resuming operations');
        trackActivity('page_visible');
    
        // Reconnect if needed
        if (socket && !socket.connected) {
          socket.connect();
        }
    
        // Refresh data
        setTimeout(() => {
          loadData();
        }, 1000);
      } else {
        console.log('üëÅÔ∏è Page became hidden - reducing operations');
        trackActivity('page_hidden');
      }
    });
    
    // Connection monitoring
    window.addEventListener('online', () => {
      console.log('üåê Network came online');
      showToast('üåê ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
      trackActivity('network_online');
    
      // Reconnect services
      setTimeout(() => {
        if (socket && !socket.connected) {
          socket.connect();
        }
        loadData();
      }, 2000);
    });
    
    window.addEventListener('offline', () => {
      console.log('üåê Network went offline');
      showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'warning');
      trackActivity('network_offline');
      updateConnectionStatus();
    });
    
    // Global functions for onclick
    // Update Socket.IO Status
    function updateSocketStatus(connected) {
      const statusEl = document.getElementById('socketStatus');
      if (statusEl) {
        statusEl.className = connected ?
          'w-2 h-2 rounded-full connected' :
          'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ?
          'Socket.IO: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' :
          'Socket.IO: ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
      }
    
      // Update overall connection status
      updateConnectionStatus();
    }
    
    // Update overall connection status
    function updateConnectionStatus() {
      const connectionStatusEl = document.getElementById('connectionStatus');
      if (!connectionStatusEl) return;
    
      const firebaseConnected = window.isFirebaseConnected || false;
      const socketConnected = socket && socket.connected;
    
      if (firebaseConnected && socketConnected) {
        connectionStatusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå';
        connectionStatusEl.className = 'text-xs text-green-600 dark:text-green-400';
      } else if (firebaseConnected || socketConnected) {
        connectionStatusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
        connectionStatusEl.className = 'text-xs text-yellow-600 dark:text-yellow-400';
      } else {
        connectionStatusEl.textContent = '‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        connectionStatusEl.className = 'text-xs text-red-600 dark:text-red-400';
      }
    }
    
    // Enhanced activity tracking
    function trackActivity(activityType, details = {}) {
      const activity = {
        type: activityType,
        details: details,
        timestamp: Date.now(),
        sessionId: window.currentSession?.sessionId,
        page: 'login_management'
      };
    
      // Send to Firebase
      if (typeof updateLoginManagementActivity === 'function') {
        updateLoginManagementActivity(activity);
      }
    
      // Send via Socket.IO
      if (socket && socket.connected) {
        socket.emit('login_management_activity', activity);
      }
    
      console.log('üìä Activity tracked:', activity);
    }
    
    // Emit login management activities
    window.emitLoginActivity = function(activityData) {
      if (socket && socket.connected) {
        socket.emit('login_activity', {
          sessionId: window.currentSession?.sessionId,
          activity: activityData,
          timestamp: Date.now(),
          source: 'login_management'
        });
      }
    };
    
    // Emit system commands
    window.emitSystemCommand = function(commandData) {
      if (socket && socket.connected) {
        socket.emit('system_command', {
          sessionId: window.currentSession?.sessionId,
          command: commandData,
          timestamp: Date.now(),
          source: 'login_management'
        });
      }
    };
    
    // Enhanced versions of existing functions with tracking
    const originalProcessRequest = processRequest;
    
    // Override processRequest to include tracking
    window.processRequest = async function(requestId, approved, note) {
      const action = approved ? 'approve_request' : 'reject_request';
      trackActivity(action, { requestId, note });
      return originalProcessRequest(requestId, approved, note);
    };
    
    // Override toggleAutoApproval with tracking
    const originalToggleAutoApproval = toggleAutoApproval;
    toggleAutoApproval = async function() {
      trackActivity('toggle_auto_approval');
      return originalToggleAutoApproval();
    };
    
    // Track page activities
    window.addEventListener('load', () => {
      trackActivity('page_loaded');
    });
    
    // Track filter changes
    document.getElementById('statusFilter')?.addEventListener('change', (e) => {
      trackActivity('filter_changed', { filter: 'status', value: e.target.value });
    });
    
    document.getElementById('dateFilter')?.addEventListener('change', (e) => {
      trackActivity('filter_changed', { filter: 'date', value: e.target.value });
    });
    
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      if (e.target.value.length > 2) {
        trackActivity('search_performed', { query: e.target.value });
      }
    });
    
    // Global functions for onclick
    window.approveRequest = approveRequest;
    window.rejectRequest = rejectRequest;
    window.updateSocketStatus = updateSocketStatus;
    window.updateConnectionStatus = updateConnectionStatus;
    window.trackActivity = trackActivity;
    
    // Additional utility functions for auto-approval
    window.toggleAutoApproval = toggleAutoApproval;
    window.runAutoApproval = runAutoApproval;
    window.updateAutoApprovalUI = updateAutoApprovalUI;
    window.getCurrentAutoApprovalStatus = getCurrentAutoApprovalStatus;
    
    // Enhanced auto-approval status check
    function checkAutoApprovalStatus() {
      return new Promise((resolve) => {
        const status = getCurrentAutoApprovalStatus();
        const isSystemReady = window.isFirebaseConnected && socket && socket.connected;
    
        resolve({
          enabled: status,
          systemReady: isSystemReady,
          lastChecked: new Date().toISOString()
        });
      });
    }
    
    // Auto-approval monitoring function
    function startAutoApprovalMonitoring() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
      setInterval(async () => {
        try {
          const statusCheck = await checkAutoApprovalStatus();
          console.log('üîç Auto-approval status check:', statusCheck);
    
          // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô auto-approval
          if (statusCheck.enabled && statusCheck.systemReady) {
            console.log('‚úÖ Auto-approval system is active and ready');
          }
    
        } catch (error) {
          console.error('‚ùå Auto-approval monitoring error:', error);
        }
      }, 5 * 60 * 1000); // 5 minutes
    }
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô monitoring ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (typeof startAutoApprovalMonitoring === 'function') {
          startAutoApprovalMonitoring();
          console.log('üöÄ Auto-approval monitoring started');
        }
      }, 10000); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    });
    
    // Debug function for auto-approval (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô console)
    window.debugAutoApproval = function() {
      console.log('üêõ Auto-Approval Debug Info:');
      console.log('- Enabled:', getCurrentAutoApprovalStatus());
      console.log('- Global Variable:', autoApproveEnabled);
      console.log('- Firebase Connected:', window.isFirebaseConnected);
      console.log('- Socket Connected:', socket && socket.connected);
      console.log('- Status Element:', document.getElementById('autoApproveStatus')?.textContent);
      console.log('- Icon Element:', document.getElementById('autoApproveIcon')?.className);
    };
    
    console.log('üéØ Auto-approval system enhanced and ready!');
  </script>
</body>
</html>