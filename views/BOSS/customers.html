<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบหลัก - Main Home</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- ตรวจสอบการล็อกอิน: หากไม่มี authToken ให้รีไดเร็กไปที่ login -->
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.href = '/login';
    }
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- 1) โหลด Tailwind CSS CDN ก่อน -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) ค่อยกำหนดค่า Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
            },
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
            'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)',
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- animate.css สำหรับเอฟเฟกต์ Toast + Dot -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    /* Custom styles */
    body {
      font-family: 'Prompt', sans-serif;
    }
    
    .menu-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--tw-shadow-hover);
    }
    
    .badge-dot {
      transition: all 0.2s ease-in-out;
    }
    
    .activity-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    .dark ::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #3B82F6;
    }

    input:focus + .toggle-slider {
      box-shadow: 0 0 1px #3B82F6;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    /* Tooltip Styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Form Input Styles */
    .form-input {
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .dark .form-input {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4a5568;
    }

    .form-input:focus {
      color: #495057;
      background-color: #fff;
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .dark .form-input:focus {
      color: #e2e8f0;
      background-color: #2d3748;
      border-color: #4299e1;
      box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
    }

    /* Additional CSS for customer page */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .customer-card {
      transition: all 0.2s ease;
    }
    
    .customer-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .required-field::after {
      content: "*";
      color: #ef4444;
      margin-left: 4px;
    }
    
    .pagination-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp }
      from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",  // Fixed the truncated API key
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    // expose to window
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebaseSet = set;
    window.firebasePush = push;
    window.firebaseServerTimestamp = serverTimestamp;
  </script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <!-- Cart Badge Styles -->
  <style>
    .cart-badge {
      position: absolute; top: -4px; right: -4px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 2px 5px; border-radius: 9999px;
      min-width: 18px; text-align: center;
    }
    .notification-badge {
      position: absolute; top: -2px; right: -2px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 1px 4px; border-radius: 9999px;
      min-width: 16px; text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">

  <!-- Container สำหรับ Toast แจ้งเตือน -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Sidebar Menu -->
  <div id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-all duration-300 z-40 sidebar-transition overflow-y-auto">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/favicon/favicon-32x32.png" alt="Logo" class="h-8 w-8">
        <span class="text-xl font-bold text-primary-600 dark:text-primary-400">ระบบจัดการ</span>
      </div>
      <button onclick="toggleMenu()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- User Info in Sidebar -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
          <i class="bi bi-person-fill"></i>
        </div>
        <div>
          <div id="sidebarUserName" class="font-medium">Loading...</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
        </div>
      </div>
    </div>
    
  <!-- Sidebar Menu Items -->
    <div class="py-4">
      <div class="px-4 mb-2 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">เมนูหลัก</div>
      <ul>
        <li>
          <a href="home" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-house-fill text-primary-500"></i>
            <span>หน้าแรก</span>
          </a>
        </li>
        <li>
          <a href="Login_Management" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-shield-lock-fill text-orange-500"></i>
            <span>อนุมัติคำขอ</span>
          </a>
        </li>
        <li>
          <a href="online-blocked-users" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-people-fill text-green-500"></i>
            <span>ผู้ใช้ออนไลน์</span>
          </a>
        </li>
        <li>
          <a href="price_adjustment" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <i class="bi bi-tag-fill text-orange-500"></i>
            <span>ปรับราคาสินค้า</span>
          </a>
        </li>
      </ul>
      
      <div class="px-4 pt-4 pb-2 mt-4 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">ระบบงาน</div>
      <ul>
        <li>
          <a href="accounting_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-journal-text text-blue-500"></i>
              <span>งานบัญชี</span>
            </div>
            <span id="sidebar-dot-accounting" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="HR_Dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-people-fill text-green-500"></i>
              <span>ฝ่ายบุคคล</span>
            </div>
            <span id="sidebar-dot-hr" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="StockManagehome" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-box-fill text-yellow-500"></i>
              <span>คลังสินค้า</span>
            </div>
            <span id="sidebar-dot-stock" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="financial_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-bar-chart-fill text-red-500"></i>
              <span>รายงาน</span>
            </div>
            <span id="sidebar-dot-report" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="loan_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-credit-card-fill text-gray-500"></i>
              <span>สินเชื่อ</span>
            </div>
            <span id="sidebar-dot-loan" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="frontstore_index" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-shop-window text-blue-400"></i>
              <span>POS - ขายหน้าร้าน</span>
            </div>
            <span id="sidebar-dot-pos" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="gifts_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-gift-fill text-pink-500"></i>
              <span>ของแถม</span>
            </div>
            <span id="sidebar-dot-gifts" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Logout Button -->
    <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
      <button id="btnLogout" class="w-full py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg flex items-center justify-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
        <i class="bi bi-box-arrow-right"></i>
        <span>ออกจากระบบ</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-grow p-4 sm:p-6 lg:p-8 pt-20">
    <!-- Top Bar with Menu Toggle and Page Title -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center">
        <button onclick="toggleMenu()" class="p-2 mr-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300">
          <i class="bi bi-list text-xl"></i>
        </button>
        <h1 class="text-2xl font-bold">ระบบจัดการลูกค้า</h1>
      </div>
      
      <!-- User menu dropdown -->
      <div class="relative">
        <button id="userMenuBtn" class="flex items-center space-x-2 focus:outline-none">
          <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
            <i class="bi bi-person-fill"></i>
          </div>
          <span id="currentUserName" class="hidden sm:inline-block">Loading...</span>
          <i class="bi bi-chevron-down text-xs"></i>
        </button>
        
        <!-- User dropdown menu -->
        <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-1 z-50 hidden">
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-person-circle mr-2"></i> โปรไฟล์
          </a>
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-gear-fill mr-2"></i> ตั้งค่า
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
          <a href="#" id="darkModeToggle" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-moon-fill mr-2"></i> <span id="darkModeText">โหมดกลางคืน</span>
          </a>
          <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
          <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="bi bi-box-arrow-right mr-2"></i> ออกจากระบบ
          </a>
        </div>
      </div>
    </div>

    <!-- Customer Overview Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Customers Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">ลูกค้าทั้งหมด</h3>
          <span class="text-primary-500 dark:text-primary-400 text-2xl">
            <i class="bi bi-people-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="totalCustomers" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="customerGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">เทียบกับเดือนที่แล้ว</p>
      </div>

      <!-- New Customers This Month Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">ลูกค้าใหม่เดือนนี้</h3>
          <span class="text-blue-500 dark:text-blue-400 text-2xl">
            <i class="bi bi-person-plus-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="newCustomers" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="newCustomerGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">เทียบกับเดือนที่แล้ว</p>
      </div>

      <!-- iPhone Sales Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">ลูกค้าซื้อ iPhone</h3>
          <span class="text-gray-500 dark:text-gray-400 text-2xl">
            <i class="bi bi-phone-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="iphoneCustomers" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="iphoneGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">คิดเป็น <span id="iphonePercentage">0%</span> ของลูกค้าทั้งหมด</p>
      </div>

      <!-- iPad Sales Card -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">ลูกค้าซื้อ iPad</h3>
          <span class="text-gray-500 dark:text-gray-400 text-2xl">
            <i class="bi bi-tablet-fill"></i>
          </span>
        </div>
        <div class="flex items-baseline">
          <p id="ipadCustomers" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
          <span id="ipadGrowth" class="ml-2 text-sm font-medium text-green-500">
            <i class="bi bi-arrow-up-short"></i>0%
          </span>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">คิดเป็น <span id="ipadPercentage">0%</span> ของลูกค้าทั้งหมด</p>
      </div>
    </div>

    <!-- Sales by Branch Chart -->
    <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6 mb-8">
      <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">ยอดขายตามสาขา</h3>
      <div class="w-full h-64">
        <canvas id="branchSalesChart"></canvas>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Customer List Section (Larger) -->
      <div class="lg:col-span-2 bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">รายชื่อลูกค้า</h3>
          <div class="flex space-x-2">
            <div class="relative">
              <input type="text" id="customerSearch" placeholder="ค้นหาลูกค้า..." 
                class="form-input text-sm pl-8 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-600 focus:border-transparent">
              <i class="bi bi-search absolute left-3 top-2.5 text-gray-400"></i>
            </div>
            <button id="btnAddCustomer" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center text-sm">
              <i class="bi bi-plus-lg mr-2"></i>เพิ่มลูกค้า
            </button>
          </div>
        </div>

        <!-- Filter Options -->
        <div class="flex flex-wrap gap-2 mb-4">
          <select id="filterBranch" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกสาขา</option>
            <!-- Options will be populated from API -->
          </select>
          <select id="filterProduct" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกสินค้า</option>
            <!-- Options will be populated dynamically from customer data -->
          </select>
          <select id="filterPayment" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกประเภทการชำระ</option>
            <option value="เงินสด">เงินสด</option>
            <option value="ผ่อนชำระ">ผ่อนชำระ</option>
          </select>
          <select id="filterCustomerType" class="form-input text-sm py-1 rounded-lg border border-gray-300 dark:border-gray-600">
            <option value="">ทุกประเภทลูกค้า</option>
            <option value="cash">ลูกค้าขายสด</option>
            <option value="installment">ลูกค้าผ่อนชำระ</option>
          </select>
        </div>

        <!-- Customer Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ลูกค้า</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สินค้า</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สาขา</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">การชำระ</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ประเภท</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">วันที่</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">จัดการ</th>
              </tr>
            </thead>
            <tbody id="customerTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Customer rows will be generated here -->
              <tr>
                <td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">กำลังโหลดข้อมูล...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-4">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            แสดง <span id="itemsShowing">0</span> จาก <span id="totalItems">0</span> รายการ
          </div>
          <div class="flex space-x-1">
            <button id="prevPage" class="pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 disabled:opacity-50">
              <i class="bi bi-chevron-left"></i>
            </button>
            <div id="pageNumbers" class="flex space-x-1">
              <!-- Page numbers will be generated here -->
            </div>
            <button id="nextPage" class="pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 disabled:opacity-50">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Customer Stats Section -->
      <div class="bg-white dark:bg-gray-800 shadow-card rounded-xl p-6">
        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">ข้อมูลสรุป</h3>
        
        <!-- Payment Method Chart -->
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">สัดส่วนการชำระเงิน</h4>
          <div class="h-48">
            <canvas id="paymentMethodChart"></canvas>
          </div>
        </div>
        
        <!-- Product Distribution Chart -->
        <div class="mb-6">
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">สัดส่วนประเภทสินค้า</h4>
          <div class="h-48">
            <canvas id="productDistributionChart"></canvas>
          </div>
        </div>
        
        <!-- Latest Customers -->
        <div>
          <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">ลูกค้าล่าสุด</h4>
          <div id="latestCustomers" class="space-y-3">
            <!-- Latest customers will be inserted here -->
            <div class="animate-pulse flex items-center space-x-3">
              <div class="rounded-full bg-gray-300 dark:bg-gray-600 h-10 w-10"></div>
              <div class="flex-1">
                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/2"></div>
              </div>
            </div>
            <div class="animate-pulse flex items-center space-x-3">
              <div class="rounded-full bg-gray-300 dark:bg-gray-600 h-10 w-10"></div>
              <div class="flex-1">
                <div class="h-4 bg-gray-300 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded w-1/2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal for Adding/Editing Customer -->
  <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-semibold text-gray-800 dark:text-white">เพิ่มลูกค้าใหม่</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      
      <form id="customerForm" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Customer Information -->
          <div>
            <h4 class="font-medium text-lg mb-3 text-gray-700 dark:text-gray-300">ข้อมูลลูกค้า</h4>
            
            <div class="form-group">
              <label for="customerName" class="form-label required-field">ชื่อลูกค้า</label>
              <input type="text" id="customerName" name="customerName" class="form-input w-full" required>
            </div>
            
            <div class="form-group">
              <label for="customerPhone" class="form-label required-field">เบอร์โทรศัพท์</label>
              <input type="tel" id="customerPhone" name="customerPhone" class="form-input w-full" required pattern="[0-9]{10}">
              <small class="text-gray-500 dark:text-gray-400">ตัวอย่าง: 0812345678</small>
            </div>
            
            <div class="form-group">
              <label for="customerAddress" class="form-label">ที่อยู่</label>
              <textarea id="customerAddress" name="customerAddress" rows="3" class="form-input w-full"></textarea>
            </div>
            
            <div class="form-group">
              <label for="customerEmail" class="form-label">อีเมล</label>
              <input type="email" id="customerEmail" name="customerEmail" class="form-input w-full">
            </div>
          </div>
          
          <!-- Purchase Information -->
          <div>
            <h4 class="font-medium text-lg mb-3 text-gray-700 dark:text-gray-300">ข้อมูลการซื้อ</h4>
            
            <div class="form-group">
              <label for="productType" class="form-label required-field">ประเภทสินค้า</label>
              <select id="productType" name="productType" class="form-input w-full" required>
                <option value="">-- เลือกประเภทสินค้า --</option>
                <option value="iPhone">iPhone</option>
                <option value="iPad">iPad</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="productModel" class="form-label required-field">รุ่นสินค้า</label>
              <select id="productModel" name="productModel" class="form-input w-full" required disabled>
                <option value="">-- เลือกรุ่นสินค้า --</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="branch" class="form-label required-field">สาขาที่ซื้อ</label>
              <select id="branch" name="branch" class="form-input w-full" required>
                <option value="">-- เลือกสาขา --</option>
                <option value="สาขาเซ็นทรัลเวิลด์">สาขาเซ็นทรัลเวิลด์</option>
                <option value="สาขาสยามพารากอน">สาขาสยามพารากอน</option>
                <option value="สาขาเมกาบางนา">สาขาเมกาบางนา</option>
                <option value="สาขาเซ็นทรัลพระราม9">สาขาเซ็นทรัลพระราม9</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="paymentMethod" class="form-label required-field">วิธีการชำระเงิน</label>
              <select id="paymentMethod" name="paymentMethod" class="form-input w-full" required>
                <option value="">-- เลือกวิธีการชำระเงิน --</option>
                <option value="เงินสด">เงินสด</option>
                <option value="ผ่อนชำระ">ผ่อนชำระ</option>
              </select>
            </div>
            
            <div id="installmentDetails" class="form-group hidden">
              <label for="installmentMonths" class="form-label">จำนวนงวด</label>
              <select id="installmentMonths" name="installmentMonths" class="form-input w-full">
                <option value="3">3 เดือน</option>
                <option value="6">6 เดือน</option>
                <option value="10">10 เดือน</option>
                <option value="12">12 เดือน</option>
                <option value="24">24 เดือน</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" id="cancelButton" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
            ยกเลิก
          </button>
          <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
            <span id="submitButtonText">บันทึกข้อมูล</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Global functions
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('-translate-x-full');
    }

    // DOM Elements
    const userDropdown = document.getElementById('userDropdown');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeText = document.getElementById('darkModeText');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserName = document.getElementById('currentUserName');
    const sidebarUserName = document.getElementById('sidebarUserName');
    const customerModal = document.getElementById('customerModal');
    const btnAddCustomer = document.getElementById('btnAddCustomer');
    const closeModal = document.getElementById('closeModal');
    const cancelButton = document.getElementById('cancelButton');
    const customerForm = document.getElementById('customerForm');
    const productType = document.getElementById('productType');
    const productModel = document.getElementById('productModel');
    const paymentMethod = document.getElementById('paymentMethod');
    const installmentDetails = document.getElementById('installmentDetails');

    // Global customer data
    let customersData = [];
    let originalCustomersData = [];
    
    // Load customers data from API - Combined Cash Sales + Installment Customers
    async function loadCustomersData() {
      try {
        console.log('🔄 Loading combined customers data from APIs...');
    
        // Get auth token for API requests
        const authToken = localStorage.getItem('authToken');
        console.log('🔑 Auth token available:', !!authToken);
    
        if (!authToken) {
          console.warn('⚠️ No auth token found, redirecting to login...');
          window.location.href = '/login';
          return;
        }
    
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        };

        // Fetch data from all APIs in parallel
        const [cashSalesResponse, installmentResponse, branchesResponse] = await Promise.all([
          fetch('/api/cash-sales/', { headers }).catch(err => {
            console.warn('Cash sales API not available:', err);
            return { ok: false };
          }),
          fetch('/api/installment/customers/', { headers }).catch(err => {
            console.warn('Installment customers API not available:', err);
            return { ok: false };
          }),
          fetch('/api/branch/', { headers }).catch(err => {
            console.warn('Branch API not available:', err);
            return { ok: false };
          })
        ]);

        // Get branches data for mapping and dropdown
        let branchesMap = {};
        let branchesForDropdown = [];
        if (branchesResponse.ok) {
          try {
            const branchesResult = await branchesResponse.json();
            if (branchesResult.success && branchesResult.data) {
              branchesResult.data.forEach(branch => {
                const branchName = branch.branchName || branch.name || branch.branchCode;
    
                // For mapping
                if (branch.branchCode) {
                  branchesMap[branch.branchCode] = branchName;
                }
                if (branch._id) {
                  branchesMap[branch._id] = branchName;
                }
    
                // For dropdown
                branchesForDropdown.push({
                  code: branch.branchCode || branch._id,
                  name: branchName,
                  id: branch._id
                });
              });
              console.log('✅ Loaded branches mapping:', branchesMap);
              console.log('📋 Branches for dropdown:', branchesForDropdown);
            }
          } catch (error) {
            console.error('Error processing branches data:', error);
          }
        }

    
        console.log('📍 Final branches mapping:', branchesMap);
    
        // Store branches data globally for dropdown population
        window.branchesData = branchesForDropdown;
    
        let allCustomers = [];
    
        // Process Cash Sales Data
        if (cashSalesResponse.ok) {
          try {
            const cashSalesResult = await cashSalesResponse.json();
            if (cashSalesResult.success && cashSalesResult.data) {
              const cashCustomers = cashSalesResult.data.map(sale => {
    
                // Extract product information
                let productInfo = '';
                let modelInfo = '';
    
                // Extract product names from items array (now populated with real data)
                if (sale.items && Array.isArray(sale.items) && sale.items.length > 0) {
                  const productNames = sale.items.map(item =>
                    item.productName || item.name || 'ไม่ระบุสินค้า'
                  ).filter(name => name && name !== 'ไม่ระบุสินค้า');
    
                  if (productNames.length > 0) {
                    if (productNames.length === 1) {
                      productInfo = productNames[0];
                    } else if (productNames.length <= 3) {
                      productInfo = productNames.join(', ');
                    } else {
                      productInfo = `${productNames.slice(0, 2).join(', ')} และอีก ${productNames.length - 2} รายการ`;
                    }
                    modelInfo = productNames.join(', ');
                  } else {
                    productInfo = 'สินค้าไม่ระบุชื่อ';
                  }
                } else {
                  // Fallback for sales without items
                  if (sale.hasWarranty) {
                    productInfo = 'สินค้าอิเล็กทรอนิกส์ (มีประกัน)';
                  } else if (sale.totalAmount > 50000) {
                    productInfo = 'สินค้าราคาสูง';
                  } else if (sale.totalAmount > 10000) {
                    productInfo = 'สินค้าทั่วไป';
                  } else {
                    productInfo = 'สินค้าขายสด';
                  }
                }
    
                modelInfo = sale.productModel || sale.product_model || sale.model ||
                           sale.variant || sale.size || sale.color || '';
    
                // If items exist but are empty, still try to get product info from root level
                if (sale.items && Array.isArray(sale.items) && sale.items.length > 0) {
                  const productNames = sale.items.map(item => {
                    console.log('🔍 Item details:', item);
                    return item.productName || item.name || item.product_name || item.itemName ||
                           item.title || item.description || item.model || item.brand;
                  }).filter(name => name && name !== '' && name !== 'undefined' && name !== 'null');
    
                  if (productNames.length > 0) {
                    productInfo = productNames.join(', ');
                    modelInfo = productNames.join(', ');
                  }
                }
    
                // Extract branch information using branches mapping
                let branchInfo = 'สำนักงานใหญ่';
                const branchCode = sale.branchCode || sale.branch_code || sale.branch;
                const branchId = sale.branchId || sale.branch_id;
    
    
                if (branchCode && branchesMap[branchCode]) {
                  branchInfo = branchesMap[branchCode];
                } else if (branchId && branchesMap[branchId]) {
                  branchInfo = branchesMap[branchId];
                } else {
                  // Use branchCode as fallback if no mapping found
                  branchInfo = sale.branchName || sale.branch_name || branchCode || 'ไม่ระบุสาขา';
                }
    
                return {
                  id: sale._id || `cash_${Date.now()}_${Math.random()}`,
                  name: sale.customerName || sale.customer_name || 'ไม่ระบุชื่อ',
                  phone: sale.customerPhone || sale.customer_phone || sale.phone || '',
                  address: sale.customerAddress || sale.customer_address || sale.address || '',
                  email: sale.customerEmail || sale.customer_email || sale.email || '',
                  product: productInfo,
                  model: modelInfo,
                  branch: branchInfo,
                  payment: 'เงินสด',
                  date: sale.createdAt ? new Date(sale.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                  installment: null,
                  taxId: sale.customerTaxId || sale.customer_tax_id || sale.taxId || '',
                  totalAmount: sale.totalAmount || sale.total_amount || 0,
                  customerType: 'cash'
                };
              });
              allCustomers = allCustomers.concat(cashCustomers);
              console.log(`✅ Loaded ${cashCustomers.length} cash sale customers`);
            }
          } catch (error) {
            console.error('Error processing cash sales data:', error);
          }
        } else if (cashSalesResponse.status === 401) {
          console.warn('🔒 Cash sales API: Unauthorized - token may be expired');
        }
    
        // Process Installment Customers Data
        if (installmentResponse.ok) {
          try {
            const installmentResult = await installmentResponse.json();
            if (installmentResult.success && installmentResult.data) {
              const installmentCustomers = installmentResult.data.map(customer => {
                console.log('📊 Processing installment customer data:', customer); // Debug log
                console.log('🔍 Customer product fields:', {
                  product_name: customer.product_name,
                  productName: customer.productName,
                  items: customer.items,
                  itemName: customer.itemName
                }); // Debug product fields
    
                // Extract product information for installment customers
                let productInfo = '';
                let modelInfo = '';
    
                // For installment customers, productName is available at root level
                productInfo = customer.productName || customer.product_name ||
                             customer.itemName || customer.item_name ||
                             customer.title || customer.description ||
                             customer.productTitle || customer.product_title ||
                             'ไม่ระบุสินค้า';
    
                modelInfo = customer.productModel || customer.product_model ||
                           customer.model || customer.variant ||
                           customer.item_model || customer.itemModel || '';
    
                // If items array exists, try to get additional product info
                if (customer.items && Array.isArray(customer.items) && customer.items.length > 0) {
                  const productNames = customer.items.map(item => {
                    return item.productName || item.name || item.product_name || item.itemName ||
                           item.title || item.description || item.model || item.brand;
                  }).filter(name => name && name !== '' && name !== 'undefined' && name !== 'null');
    
                  if (productNames.length > 0 && !productInfo) {
                    productInfo = productNames.join(', ');
                    modelInfo = productNames.join(', ');
                  }
                }
    
                // Extract branch information using branches mapping
                let branchInfo = 'สำนักงานใหญ่';
                const branchCode = customer.branchCode || customer.branch_code || customer.branch;
                const branchId = customer.branchId || customer.branch_id;
    
                if (branchCode && branchesMap[branchCode]) {
                  branchInfo = branchesMap[branchCode];
                } else if (branchId && branchesMap[branchId]) {
                  branchInfo = branchesMap[branchId];
                } else {
                  branchInfo = customer.branchName || customer.branch_name || customer.branch || branchCode || 'ไม่ระบุสาขา';
                }
    
                return {
                  id: customer._id || `installment_${Date.now()}_${Math.random()}`,
                  name: `${customer.first_name || customer.firstName || ''} ${customer.last_name || customer.lastName || ''}`.trim() || 'ไม่ระบุชื่อ',
                  phone: customer.phone_number || customer.phone || customer.phoneNumber || '',
                  address: customer.address || customer.customer_address || '',
                  email: customer.email || customer.customer_email || '',
                  product: productInfo,
                  model: modelInfo,
                  branch: branchInfo,
                  payment: 'ผ่อนชำระ',
                  date: customer.createdAt ? new Date(customer.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                  installment: customer.installmentMonths || customer.term || customer.installment_months || 12,
                  taxId: customer.tax_id || customer.national_id || customer.taxId || '',
                  totalAmount: customer.totalAmount || customer.loan_amount || customer.total_amount || 0,
                  customerType: 'installment'
                };
              });
              allCustomers = allCustomers.concat(installmentCustomers);
              console.log(`✅ Loaded ${installmentCustomers.length} installment customers`);
            }
          } catch (error) {
            console.error('Error processing installment customers data:', error);
          }
        } else if (installmentResponse.status === 401) {
          console.warn('🔒 Installment customers API: Unauthorized - token may be expired');
          showToast('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่', 'warning');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        }
    
        if (allCustomers.length > 0) {
          // Debug: Show sample of processed data
          console.log('🔍 Sample processed customers:', allCustomers.slice(0, 3));
    
          // Remove duplicates based on phone number
          const uniqueCustomers = [];
          const phoneNumbers = new Set();
    
          allCustomers.forEach(customer => {
            if (customer.phone && !phoneNumbers.has(customer.phone)) {
              phoneNumbers.add(customer.phone);
              uniqueCustomers.push(customer);
            } else if (!customer.phone) {
              uniqueCustomers.push(customer);
            }
          });
    
          // Sort by date (newest first)
          originalCustomersData = uniqueCustomers.sort((a, b) => new Date(b.date) - new Date(a.date));
          customersData = [...originalCustomersData];
    
          console.log(`✅ Combined and deduplicated: ${customersData.length} unique customers`);
          console.log(`📊 Cash customers: ${customersData.filter(c => c.customerType === 'cash').length}`);
          console.log(`📊 Installment customers: ${customersData.filter(c => c.customerType === 'installment').length}`);
    
          // Debug: Show final processed data structure
          console.log('🎯 Final customer data sample:', customersData.slice(0, 2));
    
          // Initialize dashboard with real combined data
          initializeCustomerDashboard();
    
          // Populate dropdowns
          populateBranchDropdown();
          populateProductDropdown();
        } else {
          throw new Error('No customer data available from any API');
        }
    
      } catch (error) {
        console.error('❌ Error loading customers data:', error);
    
        // Show error message to user
        showToast('ไม่สามารถโหลดข้อมูลลูกค้าได้ กรุณาลองใหม่อีกครั้ง', 'error');
    
        // Use sample data as fallback
        customersData = getSampleCustomers();
        originalCustomersData = [...customersData];
        initializeCustomerDashboard();
    
        // Still try to populate dropdowns if available
        if (window.branchesData) {
          populateBranchDropdown();
        }
        populateProductDropdown();
      }
    }
    
    // Sample Data for Demo (fallback) - minimal data for testing
    function getSampleCustomers() {
      return [
        {
          id: 'sample_1',
          name: 'ลูกค้าตัวอย่าง',
          phone: '081-234-5678',
          address: 'ที่อยู่ตัวอย่าง',
          email: 'example@email.com',
          product: 'สินค้าตัวอย่าง',
          model: '',
          branch: 'ไม่ระบุสาขา',
          payment: 'เงินสด',
          date: '2025-01-15',
          installment: null,
          taxId: '',
          customerType: 'cash'
        }
      ];
    }

    // Current page for pagination
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredCustomers = [];

    // Initialize Customer Dashboard
    function initializeCustomerDashboard() {
      filteredCustomers = [...customersData];
      updateDashboardStats();
      refreshCustomerTable();
      updateCharts();
    }
    
    // Initialize User Data
    function initUserData() {
      // Normally this would come from Firebase auth or user session
      const username = 'คุณบอส (ผู้บริหาร)';
      currentUserName.textContent = username;
      sidebarUserName.textContent = username;
    }

    // Toggle user dropdown menu
    userMenuBtn.addEventListener('click', () => {
      userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
        userDropdown.classList.add('hidden');
      }
    });

    // Toggle dark mode
    function initDarkMode() {
      // Check if user preference exists in localStorage
      const darkMode = localStorage.getItem('darkMode') === 'true';
    
      // Apply dark mode if needed
      if (darkMode) {
        document.documentElement.classList.add('dark');
        darkModeText.textContent = 'โหมดกลางวัน';
      } else {
        document.documentElement.classList.remove('dark');
        darkModeText.textContent = 'โหมดกลางคืน';
      }
    }

    darkModeToggle.addEventListener('click', (e) => {
      e.preventDefault();
    
      // Toggle dark mode class
      document.documentElement.classList.toggle('dark');
    
      // Update localStorage preference
      const isDarkMode = document.documentElement.classList.contains('dark');
      localStorage.setItem('darkMode', isDarkMode);
    
      // Update text
      darkModeText.textContent = isDarkMode ? 'โหมดกลางวัน' : 'โหมดกลางคืน';
    });

    // Logout functionality
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    });

    // Modal functions
    btnAddCustomer.addEventListener('click', openAddCustomerModal);
    closeModal.addEventListener('click', closeCustomerModal);
    cancelButton.addEventListener('click', closeCustomerModal);

    function openAddCustomerModal() {
      document.getElementById('modalTitle').textContent = 'เพิ่มลูกค้าใหม่';
      document.getElementById('submitButtonText').textContent = 'บันทึกข้อมูล';
      customerForm.reset();
      customerForm.dataset.mode = 'add';
      customerModal.classList.remove('hidden');
    }

    function closeCustomerModal() {
      customerModal.classList.add('hidden');
    }

    // Form dependencies
    productType.addEventListener('change', function() {
      const selectedType = this.value;
      productModel.disabled = !selectedType;
    
      // Clear and populate model options
      productModel.innerHTML = '<option value="">-- เลือกรุ่นสินค้า --</option>';
    
      if (selectedType && productModels[selectedType]) {
        productModels[selectedType].forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          productModel.appendChild(option);
        });
      }
    });

    paymentMethod.addEventListener('change', function() {
      if (this.value === 'ผ่อนชำระ') {
        installmentDetails.classList.remove('hidden');
      } else {
        installmentDetails.classList.add('hidden');
      }
    });

    // Form submission
    customerForm.addEventListener('submit', function(e) {
      e.preventDefault();
    
      const formData = {
        id: 'cust' + (customersData.length + 1),
        name: document.getElementById('customerName').value,
        phone: document.getElementById('customerPhone').value,
        address: document.getElementById('customerAddress').value,
        email: document.getElementById('customerEmail').value,
        product: document.getElementById('productType').value,
        model: document.getElementById('productModel').value,
        branch: document.getElementById('branch').value,
        payment: document.getElementById('paymentMethod').value,
        date: new Date().toISOString().split('T')[0],
        installment: paymentMethod.value === 'ผ่อนชำระ' ?
                      document.getElementById('installmentMonths').value : null
      };
    
      if (this.dataset.mode === 'add') {
        // Add new customer
        customersData.unshift(formData);
      } else if (this.dataset.mode === 'edit') {
        // Edit existing customer
        const customerId = this.dataset.customerId;
        const index = customersData.findIndex(c => c.id === customerId);
        if (index !== -1) {
          customersData[index] = { ...formData, id: customerId };
        }
      }
    
      // Update UI
      updateDashboardStats();
      refreshCustomerTable();
      updateCharts();
    
      // Show success toast
      showToast(
        this.dataset.mode === 'add' ? 'เพิ่มลูกค้าใหม่สำเร็จ' : 'อัปเดตข้อมูลลูกค้าสำเร็จ',
        'success'
      );
    
      // Close modal
      closeCustomerModal();
    });

    // Customer table functions
    function refreshCustomerTable() {
      const tableBody = document.getElementById('customerTableBody');
      const filterBranch = document.getElementById('filterBranch').value;
      const filterProduct = document.getElementById('filterProduct').value;
      const filterPayment = document.getElementById('filterPayment').value;
      const filterCustomerType = document.getElementById('filterCustomerType').value;
      const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
    
      // Apply filters
      filteredCustomers = customersData.filter(customer => {
        return (
          (!filterBranch || customer.branch === filterBranch) &&
          (!filterProduct || customer.product === filterProduct) &&
          (!filterPayment || customer.payment === filterPayment) &&
          (!filterCustomerType || customer.customerType === filterCustomerType) &&
          (!searchTerm ||
            customer.name.toLowerCase().includes(searchTerm) ||
            customer.phone.includes(searchTerm) ||
            customer.email.toLowerCase().includes(searchTerm))
        );
      });
    
      // Update pagination info
      const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
      if (currentPage > totalPages) {
        currentPage = Math.max(1, totalPages);
      }
    
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredCustomers.length);
      const currentItems = filteredCustomers.slice(startIndex, endIndex);
    
      // Update pagination display
      document.getElementById('itemsShowing').textContent = filteredCustomers.length > 0 ? `${startIndex + 1}-${endIndex}` : '0';
      document.getElementById('totalItems').textContent = filteredCustomers.length;
    
      // Clear table
      tableBody.innerHTML = '';
    
      // No data case
      if (currentItems.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
            ไม่พบข้อมูลลูกค้า
          </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
      }
    
      // Generate table rows
      currentItems.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
    
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                <i class="bi bi-person-fill text-gray-500 dark:text-gray-400"></i>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900 dark:text-white">${customer.name}</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">${customer.phone}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900 dark:text-white">${customer.product || 'ไม่ระบุสินค้า'}</div>
            ${customer.model ? `<div class="text-xs text-gray-500 dark:text-gray-400">${customer.model}</div>` : ''}
            ${customer.totalAmount > 0 ? `<div class="text-xs text-blue-600 dark:text-blue-400">฿${customer.totalAmount.toLocaleString()}</div>` : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900 dark:text-white">${customer.branch}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${customer.payment === 'เงินสด'
              ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                  เงินสด
                </span>`
              : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                  ผ่อน ${customer.installment} เดือน
                </span>`
            }
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            ${customer.customerType === 'cash'
              ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">
                  <i class="bi bi-cash-coin mr-1"></i> ขายสด
                </span>`
              : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">
                  <i class="bi bi-credit-card mr-1"></i> ผ่อนชำระ
                </span>`
            }
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
            ${formatDate(customer.date)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 mr-3" 
                    onclick="viewCustomerDetails('${customer.id}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3" 
                    onclick="editCustomer('${customer.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" 
                    onclick="deleteCustomer('${customer.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
    
        tableBody.appendChild(row);
      });
    
      // Update pagination controls
      updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';
    
      // Previous button
      document.getElementById('prevPage').disabled = currentPage <= 1;
    
      // Next button
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
    
      // Only show a limited number of page buttons
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
    
      // First page button if needed
      if (startPage > 1) {
        const pageBtn = createPageButton(1);
        pageNumbers.appendChild(pageBtn);
    
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-btn flex items-center justify-center';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }
      }
    
      // Page buttons
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = createPageButton(i);
        pageNumbers.appendChild(pageBtn);
      }
    
      // Last page button if needed
      if (endPage < totalPages) {
        if (totalPages - endPage > 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'pagination-btn flex items-center justify-center';
          ellipsis.textContent = '...';
          pageNumbers.appendChild(ellipsis);
        }
    
        const pageBtn = createPageButton(totalPages);
        pageNumbers.appendChild(pageBtn);
      }
    }

    function createPageButton(page) {
      const button = document.createElement('button');
      button.className = `pagination-btn bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 
                          ${page === currentPage ? 'font-semibold bg-primary-500 text-white dark:bg-primary-600' : ''}`;
      button.textContent = page;
      button.disabled = page === currentPage;
    
      button.addEventListener('click', () => {
        currentPage = page;
        refreshCustomerTable();
      });
    
      return button;
    }

    // เพิ่มฟังก์ชันที่ยังไม่ได้ถูกประกาศ

    // เพิ่มฟังก์ชัน viewCustomerDetails, editCustomer, deleteCustomer ที่ยังขาดอยู่
    function viewCustomerDetails(customerId) {
      const customer = customersData.find(c => c.id === customerId);
      if (!customer) return;
    
      // แสดงข้อมูลลูกค้าในรูปแบบ modal
      let detailHTML = `
        <div class="p-4">
          <h3 class="text-lg font-medium mb-3">ข้อมูลลูกค้า: ${customer.name}</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p><span class="font-medium">เบอร์โทรศัพท์:</span> ${customer.phone}</p>
              <p><span class="font-medium">อีเมล:</span> ${customer.email || '-'}</p>
              <p><span class="font-medium">ที่อยู่:</span> ${customer.address || '-'}</p>
            </div>
            <div>
              <p><span class="font-medium">สินค้า:</span> ${customer.product} - ${customer.model}</p>
              <p><span class="font-medium">สาขาที่ซื้อ:</span> ${customer.branch}</p>
              <p><span class="font-medium">การชำระเงิน:</span> ${
                customer.payment === 'เงินสด' ? 'เงินสด' : `ผ่อนชำระ ${customer.installment} เดือน`
              }</p>
              <p><span class="font-medium">วันที่ซื้อ:</span> ${formatDate(customer.date)}</p>
            </div>
          </div>
        </div>
      `;
    
      // แสดง modal แบบง่าย
      const detailsModal = document.createElement('div');
      detailsModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      detailsModal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-lg">
          <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-xl font-semibold">รายละเอียดลูกค้า</h3>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 close-modal">
              <i class="bi bi-x-lg text-xl"></i>
            </button>
          </div>
          ${detailHTML}
          <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
            <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors close-modal">
              ปิด
            </button>
          </div>
        </div>
      `;
    
      document.body.appendChild(detailsModal);
    
      // เพิ่ม event listener สำหรับปุ่มปิด
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', () => {
          detailsModal.remove();
        });
      });
    }

    function editCustomer(customerId) {
      const customer = customersData.find(c => c.id === customerId);
      if (!customer) return;
    
      // Set form mode
      document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลลูกค้า';
      document.getElementById('submitButtonText').textContent = 'บันทึกการเปลี่ยนแปลง';
      customerForm.dataset.mode = 'edit';
      customerForm.dataset.customerId = customerId;
    
      // Populate form fields
      document.getElementById('customerName').value = customer.name;
      document.getElementById('customerPhone').value = customer.phone;
      document.getElementById('customerAddress').value = customer.address || '';
      document.getElementById('customerEmail').value = customer.email || '';
      document.getElementById('productType').value = customer.product;
    
      // Trigger change event to populate model dropdown
      const event = new Event('change');
      productType.dispatchEvent(event);
    
      // Set product model after options are populated
      setTimeout(() => {
        document.getElementById('productModel').value = customer.model;
      }, 100);
    
      document.getElementById('branch').value = customer.branch;
      document.getElementById('paymentMethod').value = customer.payment;
    
      // Show/hide installment details
      if (customer.payment === 'ผ่อนชำระ') {
        installmentDetails.classList.remove('hidden');
        document.getElementById('installmentMonths').value = customer.installment;
      } else {
        installmentDetails.classList.add('hidden');
      }
    
      // Open modal
      customerModal.classList.remove('hidden');
    }

    function deleteCustomer(customerId) {
      if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลลูกค้านี้?')) {
        const index = customersData.findIndex(c => c.id === customerId);
        if (index !== -1) {
          customersData.splice(index, 1);
          updateDashboardStats();
          refreshCustomerTable();
          updateCharts();
          showToast('ลบข้อมูลลูกค้าสำเร็จ', 'success');
        }
      }
    }

    // เพิ่มฟังก์ชัน formatDate
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('th-TH', options);
    }

    // เพิ่มฟังก์ชันแสดง toast notification
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
    
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `flex items-center p-4 mb-3 rounded-lg shadow-md animate__animated animate__fadeIn ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-primary-500 text-white'
      }`;
    
      // Icon based on type
      const iconClass =
        type === 'success' ? 'bi-check-circle-fill' :
        type === 'error' ? 'bi-x-circle-fill' :
        type === 'warning' ? 'bi-exclamation-triangle-fill' :
        'bi-info-circle-fill';
    
      toast.innerHTML = `
        <div class="flex-shrink-0 mr-3">
          <i class="bi ${iconClass} text-xl"></i>
        </div>
        <div class="text-sm font-medium">${message}</div>
        <button class="ml-auto">
          <i class="bi bi-x-lg"></i>
        </button>
      `;
    
      // Add to container
      toastContainer.appendChild(toast);
    
      // Close button functionality
      toast.querySelector('button').addEventListener('click', () => {
        toast.classList.add('animate__fadeOut');
        setTimeout(() => {
          toast.remove();
        }, 300);
      });
    
      // Auto close after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.add('animate__fadeOut');
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, 5000);
    }

    // เพิ่มฟังก์ชัน updateCharts ที่ขาดหายไป
    function updateCharts() {
      try {
        // Branch data
        const branchData = {};
        customersData.forEach(customer => {
          if (!branchData[customer.branch]) {
            branchData[customer.branch] = { iPhone: 0, iPad: 0 };
          }
          branchData[customer.branch][customer.product]++;
        });
    
        const branches = Object.keys(branchData);
        const iPhoneData = branches.map(branch => branchData[branch].iPhone);
        const iPadData = branches.map(branch => branchData[branch].iPad);

        // Branch Sales Chart
        const ctx1 = document.getElementById('branchSalesChart');
        if (ctx1) {
          // Check if chart instance exists and destroy it
          if (window.branchSalesChart instanceof Chart) {
            window.branchSalesChart.destroy();
          }
    
          window.branchSalesChart = new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: branches,
              datasets: [
                {
                  label: 'iPhone',
                  data: iPhoneData,
                  backgroundColor: 'rgba(59, 130, 246, 0.7)'
                },
                {
                  label: 'iPad',
                  data: iPadData,
                  backgroundColor: 'rgba(16, 185, 129, 0.7)'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                  },
                  grid: {
                    color: document.documentElement.classList.contains('dark') ? 'rgba(107, 114, 128, 0.1)' : 'rgba(229, 231, 235, 0.5)'
                  }
                },
                x: {
                  ticks: {
                    color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#4b5563'
                  },
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
    
        // Payment Method Chart
        const cashPayments = customersData.filter(c => c.payment === 'เงินสด').length;
        const installmentPayments = customersData.filter(c => c.payment === 'ผ่อนชำระ').length;
    
        const ctx2 = document.getElementById('paymentMethodChart');
        if (ctx2) {
          // Check if chart instance exists and destroy it
          if (window.paymentMethodChart instanceof Chart) {
            window.paymentMethodChart.destroy();
          }
    
          window.paymentMethodChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['เงินสด', 'ผ่อนชำระ'],
              datasets: [{
                data: [cashPayments, installmentPayments],
                backgroundColor: [
                  'rgba(16, 185, 129, 0.7)',
                  'rgba(59, 130, 246, 0.7)'
                ],
                borderColor: [
                  document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                  document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                  }
                }
              },
              cutout: '65%'
            }
          });
        }
    
        // Product Distribution Chart
        const ctx3 = document.getElementById('productDistributionChart');
        if (ctx3) {
          // Check if chart instance exists and destroy it
          if (window.productDistributionChart instanceof Chart) {
            window.productDistributionChart.destroy();
          }
    
          window.productDistributionChart = new Chart(ctx3, {
            type: 'pie',
            data: {
              labels: ['iPhone', 'iPad'],
              datasets: [{
              data: [
                customersData.filter(c => c.product === 'iPhone').length,
                customersData.filter(c => c.product === 'iPad').length
              ],
                backgroundColor: [
                  'rgba(245, 158, 11, 0.7)',
                  'rgba(139, 92, 246, 0.7)'
                ],
                borderColor: [
                  document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                  document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                  }
                }
              }
            }
          });
        }
      } catch (error) {
        console.error('Error updating charts:', error);
      }
    }

    // เพิ่มฟังก์ชัน updateDashboardStats
    function updateDashboardStats() {
      const totalCustomers = customersData.length;
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
    
      // Calculate new customers this month
      const newCustomersThisMonth = customersData.filter(customer => {
        const customerDate = new Date(customer.date);
        return customerDate.getMonth() === currentMonth &&
               customerDate.getFullYear() === currentYear;
      }).length;
    
      // iPhone and iPad customers
      const iphoneCustomers = customersData.filter(c => c.product === 'iPhone').length;
      const ipadCustomers = customersData.filter(c => c.product === 'iPad').length;
    
      // Calculate percentages
      const iphonePercentage = totalCustomers > 0 ?
        Math.round((iphoneCustomers / totalCustomers) * 100) : 0;
      const ipadPercentage = totalCustomers > 0 ?
        Math.round((ipadCustomers / totalCustomers) * 100) : 0;
    
      // Update UI
      document.getElementById('totalCustomers').textContent = totalCustomers;
      document.getElementById('newCustomers').textContent = newCustomersThisMonth;
      document.getElementById('iphoneCustomers').textContent = iphoneCustomers;
      document.getElementById('ipadCustomers').textContent = ipadCustomers;
      document.getElementById('iphonePercentage').textContent = `${iphonePercentage}%`;
      document.getElementById('ipadPercentage').textContent = `${ipadPercentage}%`;
    
      // Growth metrics (demo purposes - randomly generated)
      document.getElementById('customerGrowth').innerHTML =
        `<i class="bi bi-arrow-up-short"></i>+12%`;
      document.getElementById('newCustomerGrowth').innerHTML =
        `<i class="bi bi-arrow-up-short"></i>+8%`;
      document.getElementById('iphoneGrowth').innerHTML =
        `<i class="bi bi-arrow-up-short"></i>+15%`;
      document.getElementById('ipadGrowth').innerHTML =
        `<i class="bi bi-arrow-up-short"></i>+5%`;
    
      // Update latest customers list
      updateLatestCustomers();
    }

    // เพิ่มฟังก์ชัน updateLatestCustomers
    function updateLatestCustomers() {
      const latestCustomersEl = document.getElementById('latestCustomers');
      const latestCustomers = [...customersData].sort((a, b) =>
        new Date(b.date) - new Date(a.date)).slice(0, 3);
    
      latestCustomersEl.innerHTML = '';
    
      latestCustomers.forEach(customer => {
        const customerEl = document.createElement('div');
        customerEl.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
    
        const paymentBadge = customer.payment === 'เงินสด'
          ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"><i class="bi bi-cash-coin mr-1"></i> สด</span>'
          : '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"><i class="bi bi-credit-card mr-1"></i> ผ่อน</span>';
    
        customerEl.innerHTML = `
          <div class="flex-shrink-0 w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
            <i class="bi bi-person-fill text-primary-500 dark:text-primary-400"></i>
          </div>
          <div class="flex-1">
            <h5 class="text-sm font-medium text-gray-900 dark:text-white">${customer.name}</h5>
            <p class="text-xs text-gray-500 dark:text-gray-400">${customer.product} - ${formatDate(customer.date)}</p>
          </div>
          <div>
            ${paymentBadge}
          </div>
        `;
    
        latestCustomersEl.appendChild(customerEl);
      });
    }

    // ฟังก์ชันสำหรับ populate branch dropdown
    function populateBranchDropdown() {
      const filterBranch = document.getElementById('filterBranch');
      if (!filterBranch || !window.branchesData) return;
    
      // เคลียร์ options เก่า (เหลือไว้แค่ "ทุกสาขา")
      filterBranch.innerHTML = '<option value="">ทุกสาขา</option>';
    
      // เรียงลำดับสาขาตามชื่อ
      const sortedBranches = window.branchesData.sort((a, b) => a.name.localeCompare(b.name, 'th'));
    
      // เพิ่ม options จากข้อมูล API
      sortedBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.name; // ใช้ชื่อสาขาเป็น value สำหรับ filter
        option.textContent = branch.name;
        option.dataset.branchCode = branch.code;
        option.dataset.branchId = branch.id;
        filterBranch.appendChild(option);
      });
    
      console.log('✅ Populated branch dropdown with', sortedBranches.length, 'branches');
    }

    // ฟังก์ชันสำหรับ populate product dropdown
    function populateProductDropdown() {
      const filterProduct = document.getElementById('filterProduct');
      if (!filterProduct || !customersData || customersData.length === 0) return;
    
      // เคลียร์ options เก่า (เหลือไว้แค่ "ทุกสินค้า")
      filterProduct.innerHTML = '<option value="">ทุกสินค้า</option>';
    
      // รวบรวมชื่อสินค้าที่ไม่ซ้ำ
      const uniqueProducts = [...new Set(
        customersData
          .map(customer => customer.product)
          .filter(product => product && product.trim() !== '' && product !== 'ไม่ระบุสินค้า')
      )].sort();
    
      // เพิ่ม options จากข้อมูลลูกค้า
      uniqueProducts.forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        filterProduct.appendChild(option);
      });
    
      console.log('✅ Populated product dropdown with', uniqueProducts.length, 'products');
    }

    // ประกาศฟังก์ชัน global เพื่อให้ใช้งานได้จาก HTML
    window.viewCustomerDetails = viewCustomerDetails;
    window.editCustomer = editCustomer;
    window.deleteCustomer = deleteCustomer;

    // เรียกใช้ฟังก์ชันเริ่มต้นเพื่อแสดงข้อมูล
    document.addEventListener('DOMContentLoaded', () => {
      initUserData();
      initDarkMode();
      loadCustomersData(); // Load data from API first
    });

  </script>
</body>
</html>

