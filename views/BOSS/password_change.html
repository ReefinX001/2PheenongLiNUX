<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>เปลี่ยนรหัสผ่าน - BOSS System</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif']
          }
        }
      }
    };
  </script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
    }
    
    .form-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }
    
    .input-field.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .input-field.success {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: 4px;
      display: none;
    }
    
    .success-message {
      color: #10b981;
      font-size: 14px;
      margin-top: 4px;
      display: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #0284c7, #0369a1);
      transform: translateY(-2px);
    }
    
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .strength-meter {
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .strength-fill {
      height: 100%;
      transition: all 0.3s ease;
      border-radius: 2px;
    }
    
    .strength-weak { background: #ef4444; width: 25%; }
    .strength-medium { background: #f59e0b; width: 50%; }
    .strength-good { background: #10b981; width: 75%; }
    .strength-strong { background: #059669; width: 100%; }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(400px);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: #10b981;
      color: white;
    }
    
    .toast.error {
      background: #ef4444;
      color: white;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8">
    <div class="form-container">
      
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
        <div class="flex items-center space-x-3">
          <i class="bi bi-shield-lock text-3xl"></i>
          <div>
            <h2 class="text-2xl font-bold">เปลี่ยนรหัสผ่าน</h2>
            <p class="text-blue-100">เปลี่ยนรหัสผ่านสำหรับความปลอดภัย</p>
          </div>
        </div>
      </div>

      <!-- Form -->
      <div class="p-6">
        <form id="changePasswordForm">
          
          <!-- Username -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="bi bi-person mr-2"></i>ชื่อผู้ใช้งาน
            </label>
            <input 
              type="text" 
              id="username" 
              class="input-field" 
              placeholder="กรอกชื่อผู้ใช้งาน"
              required 
            />
            <div class="error-message" id="usernameError"></div>
          </div>

          <!-- Current Password -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="bi bi-lock mr-2"></i>รหัสผ่านเก่า
            </label>
            <div class="relative">
              <input 
                type="password" 
                id="currentPassword" 
                class="input-field pr-12" 
                placeholder="กรอกรหัสผ่านเก่า"
                required 
              />
              <i class="absolute right-3 top-1/2 transform -translate-y-1/2 bi bi-eye cursor-pointer text-gray-400 hover:text-gray-600" onclick="togglePassword('currentPassword', this)"></i>
            </div>
            <div class="error-message" id="currentPasswordError"></div>
          </div>

          <!-- New Password -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="bi bi-key mr-2"></i>รหัสผ่านใหม่
            </label>
            <div class="relative">
              <input 
                type="password" 
                id="newPassword" 
                class="input-field pr-12" 
                placeholder="กรอกรหัสผ่านใหม่"
                required 
              />
              <i class="absolute right-3 top-1/2 transform -translate-y-1/2 bi bi-eye cursor-pointer text-gray-400 hover:text-gray-600" onclick="togglePassword('newPassword', this)"></i>
            </div>
            <div class="strength-meter">
              <div class="strength-fill" id="strengthMeter"></div>
            </div>
            <div class="text-sm text-gray-500 mt-2" id="strengthText">ความแข็งแกร่งของรหัสผ่าน</div>
            <div class="error-message" id="newPasswordError"></div>
          </div>

          <!-- Confirm Password -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="bi bi-check2-square mr-2"></i>ยืนยันรหัสผ่านใหม่
            </label>
            <div class="relative">
              <input 
                type="password" 
                id="confirmPassword" 
                class="input-field pr-12" 
                placeholder="กรอกรหัสผ่านใหม่อีกครั้ง"
                required 
              />
              <i class="absolute right-3 top-1/2 transform -translate-y-1/2 bi bi-eye cursor-pointer text-gray-400 hover:text-gray-600" onclick="togglePassword('confirmPassword', this)"></i>
            </div>
            <div class="error-message" id="confirmPasswordError"></div>
            <div class="success-message" id="confirmPasswordSuccess"></div>
          </div>

          <!-- Password Requirements -->
          <div class="bg-blue-50 p-4 rounded-lg mb-6">
            <h4 class="font-medium text-blue-800 mb-2">
              <i class="bi bi-info-circle mr-2"></i>ข้อกำหนดรหัสผ่าน:
            </h4>
            <ul class="text-sm text-blue-700 space-y-1">
              <li id="req-length" class="flex items-center">
                <i class="bi bi-x-circle text-red-500 mr-2"></i>ความยาวอย่างน้อย 8 ตัวอักษร
              </li>
              <li id="req-uppercase" class="flex items-center">
                <i class="bi bi-x-circle text-red-500 mr-2"></i>มีตัวอักษรพิมพ์ใหญ่
              </li>
              <li id="req-lowercase" class="flex items-center">
                <i class="bi bi-x-circle text-red-500 mr-2"></i>มีตัวอักษรพิมพ์เล็ก
              </li>
              <li id="req-number" class="flex items-center">
                <i class="bi bi-x-circle text-red-500 mr-2"></i>มีตัวเลข
              </li>
            </ul>
          </div>

          <!-- Submit Button -->
          <button type="submit" class="btn-primary" id="submitBtn" disabled>
            <i class="bi bi-shield-check mr-2"></i>
            เปลี่ยนรหัสผ่าน
          </button>
          
          <!-- Cancel Button -->
          <a href="home.html" class="block w-full mt-3 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors text-center">
            <i class="bi bi-x-circle mr-2"></i>
            ยกเลิก
          </a>

        </form>
      </div>
      
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Password validation patterns
    const patterns = {
      length: /.{8,}/,
      uppercase: /[A-Z]/,
      lowercase: /[a-z]/,
      number: /[0-9]/
    };

    // DOM Elements
    const form = document.getElementById('changePasswordForm');
    const usernameInput = document.getElementById('username');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const strengthMeter = document.getElementById('strengthMeter');
    const strengthText = document.getElementById('strengthText');

    // Event Listeners
    usernameInput.addEventListener('input', validateForm);
    currentPasswordInput.addEventListener('input', validateForm);
    newPasswordInput.addEventListener('input', function() {
      validateNewPassword();
      checkPasswordMatch();
      updatePasswordStrength();
      updatePasswordRequirements();
      validateForm();
    });
    confirmPasswordInput.addEventListener('input', function() {
      checkPasswordMatch();
      validateForm();
    });
    form.addEventListener('submit', handleSubmit);

    // Toggle password visibility
    function togglePassword(inputId, icon) {
      const input = document.getElementById(inputId);
      const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
      input.setAttribute('type', type);
    
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    }

    // Validate new password
    function validateNewPassword() {
      const newPassword = newPasswordInput.value;
      const currentPassword = currentPasswordInput.value;
      const errorDiv = document.getElementById('newPasswordError');
    
      if (!newPassword) {
        showError(newPasswordInput, errorDiv, 'กรุณากรอกรหัสผ่านใหม่');
        return false;
      }
    
      if (newPassword === currentPassword && currentPassword) {
        showError(newPasswordInput, errorDiv, 'รหัสผ่านใหม่ต้องแตกต่างจากรหัสผ่านเก่า');
        return false;
      }
    
      let passedChecks = 0;
      Object.values(patterns).forEach(pattern => {
        if (pattern.test(newPassword)) passedChecks++;
      });
    
      if (passedChecks < 4) {
        showError(newPasswordInput, errorDiv, 'รหัสผ่านไม่เป็นไปตามข้อกำหนด');
        return false;
      }
    
      showSuccess(newPasswordInput, errorDiv);
      return true;
    }

    // Check password match
    function checkPasswordMatch() {
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      const errorDiv = document.getElementById('confirmPasswordError');
      const successDiv = document.getElementById('confirmPasswordSuccess');
    
      if (!confirmPassword) {
        confirmPasswordInput.classList.remove('success', 'error');
        hideError(errorDiv);
        hideSuccess(successDiv);
        return false;
      }
    
      if (newPassword !== confirmPassword) {
        showError(confirmPasswordInput, errorDiv, 'รหัสผ่านไม่ตรงกัน');
        hideSuccess(successDiv);
        return false;
      }
    
      showSuccess(confirmPasswordInput, errorDiv);
      showSuccessMessage(successDiv, 'รหัสผ่านตรงกัน ✓');
      return true;
    }

    // Update password strength
    function updatePasswordStrength() {
      const password = newPasswordInput.value;
      let strength = 0;
    
      Object.values(patterns).forEach(pattern => {
        if (pattern.test(password)) strength++;
      });
    
      strengthMeter.className = 'strength-fill';
    
      if (strength === 0) {
        strengthText.textContent = 'ความแข็งแกร่งของรหัสผ่าน';
        strengthText.className = 'text-sm text-gray-500 mt-2';
      } else if (strength <= 2) {
        strengthMeter.classList.add('strength-weak');
        strengthText.textContent = 'รหัสผ่านอ่อนแอ';
        strengthText.className = 'text-sm text-red-500 mt-2';
      } else if (strength <= 3) {
        strengthMeter.classList.add('strength-medium');
        strengthText.textContent = 'รหัสผ่านปานกลาง';
        strengthText.className = 'text-sm text-yellow-500 mt-2';
      } else {
        strengthMeter.classList.add('strength-strong');
        strengthText.textContent = 'รหัสผ่านแข็งแกร่ง';
        strengthText.className = 'text-sm text-green-600 mt-2 font-medium';
      }
    }

    // Update password requirements
    function updatePasswordRequirements() {
      const password = newPasswordInput.value;
    
      Object.entries(patterns).forEach(([key, pattern]) => {
        const element = document.getElementById(`req-${key}`);
        const icon = element.querySelector('i');
    
        if (pattern.test(password)) {
          icon.className = 'bi bi-check-circle text-green-500 mr-2';
          element.classList.add('text-green-600');
          element.classList.remove('text-blue-700');
        } else {
          icon.className = 'bi bi-x-circle text-red-500 mr-2';
          element.classList.remove('text-green-600');
          element.classList.add('text-blue-700');
        }
      });
    }

    // Validate form
    function validateForm() {
      const username = usernameInput.value.trim();
      const currentPassword = currentPasswordInput.value;
      const isNewPasswordValid = validateNewPassword();
      const isPasswordMatch = checkPasswordMatch();
    
      const allValid = username && currentPassword && isNewPasswordValid && isPasswordMatch;
    
      submitBtn.disabled = !allValid;
    }

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();
    
      if (submitBtn.disabled) return;
    
      const formData = {
        username: usernameInput.value.trim(),
        currentPassword: currentPasswordInput.value,
        newPassword: newPasswordInput.value
      };
    
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise animate-spin mr-2"></i>กำลังเปลี่ยน...';
    
      try {
        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify(formData)
        });
    
        const result = await response.json();
    
        if (result.success) {
          showToast('เปลี่ยนรหัสผ่านสำเร็จ!', 'success');
          setTimeout(() => {
            window.location.href = 'home.html';
          }, 2000);
        } else {
          showToast(result.message || 'เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน', 'error');
        }
    
      } catch (error) {
        console.error('Error:', error);
        showToast('เครือข่ายขัดข้อง กรุณาลองใหม่อีกครั้ง', 'error');
      } finally {
        submitBtn.innerHTML = '<i class="bi bi-shield-check mr-2"></i>เปลี่ยนรหัสผ่าน';
        validateForm();
      }
    }

    // Utility functions
    function showError(input, errorDiv, message) {
      input.classList.add('error');
      input.classList.remove('success');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function showSuccess(input, errorDiv) {
      input.classList.add('success');
      input.classList.remove('error');
      hideError(errorDiv);
    }

    function hideError(errorDiv) {
      errorDiv.style.display = 'none';
    }

    function showSuccessMessage(successDiv, message) {
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    function hideSuccess(successDiv) {
      successDiv.style.display = 'none';
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
    
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      usernameInput.focus();
    });
  </script>

</body>
</html> 