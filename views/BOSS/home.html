<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบหลัก - Main Home</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
  
  <!-- Google Fonts - Prompt (Thai) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- ตรวจสอบการล็อกอิน: หากไม่มี authToken ให้รีไดเร็กไปที่ login -->
  <script>
    // Enhanced authentication check
    function checkAuthAndRedirect() {
      const token = localStorage.getItem('authToken');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        console.log('No authentication token or user ID found, redirecting to login');
        localStorage.clear(); // Clear all stored data
        window.location.href = '/login';
        return false;
      }

      // Check if token format is valid (basic JWT check)
      try {
        const parts = token.split('.');
        if (parts.length !== 3) {
          console.log('Invalid token format, redirecting to login');
          localStorage.clear();
          window.location.href = '/login';
          return false;
        }

        // Try to decode payload to check if token is valid
        const payload = JSON.parse(atob(parts[1]));
        if (!payload.userId && !payload.id) {
          console.log('Invalid token payload, redirecting to login');
          localStorage.clear();
          window.location.href = '/login';
          return false;
        }

        return true;
      } catch (error) {
        console.log('Error validating token, redirecting to login:', error);
        localStorage.clear();
        window.location.href = '/login';
        return false;
      }
    }

    // Run authentication check
    if (!checkAuthAndRedirect()) {
      // If auth check fails, stop page execution
      document.body.style.display = 'none';
    }
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- 1) โหลด Tailwind CSS CDN ก่อน -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 2) ค่อยกำหนดค่า Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            secondary: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
            },
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
            'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)',
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- animate.css สำหรับเอฟเฟกต์ Toast + Dot -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <style>
    /* Custom styles */
    body {
      font-family: 'Prompt', sans-serif;
    }
    
    .menu-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .dark .menu-card {
      background: #1f2937;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
    }
    
    .dark .menu-card:hover {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    }
    
    .badge-dot {
      transition: all 0.2s ease-in-out;
    }
    
    .activity-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    .dark ::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    .dark ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5); z-index: 50;
    }
    .modal-content {
      background-color: white; border-radius: 0.5rem;
      padding: 1.5rem; box-shadow: 0 10px 15px rgba(0,0,0,0.1);
      max-width: 28rem; width: 100%;
    }
    .dark .modal-content {
      background-color: #1f2937;
    }

    /* fade-out animation */
    .fade-out {
      animation: fadeOut 0.2s ease-out forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; transform: scale(0.95); }
    }

    /* Connection Status Styles */
    .connection-status.online {
      color: #10b981;
    }
    .connection-status.offline {
      color: #ef4444;
    }
    .connection-status.connecting {
      color: #f59e0b;
    }

    #firebaseStatus.connected {
      background-color: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
    }
    #firebaseStatus.disconnected {
      background-color: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
    }
    #firebaseStatus.connecting {
      background-color: #f59e0b;
      box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
      animation: pulse 2s infinite;
    }

    #socketStatus.connected {
      background-color: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
    }
    #socketStatus.disconnected {
      background-color: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
    }
    #socketStatus.connecting {
      background-color: #f59e0b;
      box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>

  <!-- Firebase Realtime Database Enhanced -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp, onDisconnect, remove } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // ข้อมูล session ปัจจุบัน
    const currentSession = {
      branchCode: 'BOSS_DASHBOARD',
      sessionId: 'BOSS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      staffId: localStorage.getItem('userId'),
      staffName: localStorage.getItem('userName'),
      timestamp: Date.now(),
      userRole: 'boss'
    };

    // Firebase References - ใช้ path ที่ได้รับอนุญาตแล้ว
    const activitiesRef = ref(database, 'activities/boss');
    const sessionRef = ref(database, `sessions/boss/${currentSession.sessionId}`);
    const notificationsRef = ref(database, 'notifications/boss');
    const onlineUsersRef = ref(database, 'onlineUsers/boss');
    const systemStatsRef = ref(database, 'systemStats/boss');
    
    // Activity References สำหรับแต่ละโมดูล
    const moduleRefs = {
      accounting: ref(database, 'activities/accounting'),
      hr: ref(database, 'activities/hr'),
      stock: ref(database, 'activities/stock'),
      marketing: ref(database, 'activities/marketing'),
      loan: ref(database, 'activities/loan'),
      pos: ref(database, 'activities/pos'),
      report: ref(database, 'activities/report')
    };

    // ตัวแปรเก็บสถานะ
    let isFirebaseConnected = false;
    let lastNotificationTime = 0;

    // ตรวจสอบการเชื่อมต่อ Firebase
    const connectedRef = ref(database, '.info/connected');
    onValue(connectedRef, (snapshot) => {
      isFirebaseConnected = snapshot.val() === true;
      window.isFirebaseConnected = isFirebaseConnected;
      console.log('🔥 Firebase connection status:', isFirebaseConnected ? 'Connected' : 'Disconnected');
      
      if (isFirebaseConnected) {
        registerSession();
        setupOnDisconnect();
        
        if (typeof showToast === 'function') {
          showToast('🔥 เชื่อมต่อ Firebase สำเร็จ', 'success');
        }
        
        // อัปเดตสถานะ Firebase
        updateFirebaseStatus(true);
      } else {
        if (typeof showToast === 'function') {
          showToast('⚠️ การเชื่อมต่อ Firebase ขัดข้อง', 'warning');
        }
        
        // อัปเดตสถานะ Firebase
        updateFirebaseStatus(false);
      }
    });

    // ลงทะเบียน session
    async function registerSession() {
      try {
        await set(sessionRef, {
          ...currentSession,
          status: 'online',
          lastActivity: serverTimestamp(),
          userAgent: navigator.userAgent,
          connectedAt: serverTimestamp(),
          page: 'boss_dashboard'
        });
        
        // เพิ่มผู้ใช้ online
        await set(ref(database, `onlineUsers/boss/${currentSession.sessionId}`), {
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          sessionId: currentSession.sessionId,
          userRole: 'boss',
          connectedAt: serverTimestamp()
        });
        
        console.log('✅ Boss session registered to Firebase');
      } catch (error) {
        console.error('❌ Failed to register session:', error);
      }
    }

    // ตั้งค่า onDisconnect
    function setupOnDisconnect() {
      onDisconnect(sessionRef).set({
        ...currentSession,
        status: 'offline',
        lastActivity: serverTimestamp(),
        disconnectedAt: serverTimestamp()
      });
      
      onDisconnect(ref(database, `onlineUsers/boss/${currentSession.sessionId}`)).remove();
    }

    // ฟังการแจ้งเตือนจากระบบต่างๆ
    onValue(notificationsRef, (snapshot) => {
      const notifications = snapshot.val();
      if (notifications) {
        Object.entries(notifications).forEach(([key, notification]) => {
          // แสดงเฉพาะการแจ้งเตือนใหม่ (ใน 2 นาทีล่าสุด)
          if (notification.timestamp > (Date.now() - 120000) && notification.timestamp > lastNotificationTime) {
            if (typeof showToast === 'function') {
              showToast(`${notification.title}: ${notification.message}`, notification.type || 'info');
            }
            
            // แสดง notification dot
            showNotificationDot();
            lastNotificationTime = notification.timestamp;
          }
        });
      }
    });

    // ฟังสถิติระบบ
    onValue(systemStatsRef, (snapshot) => {
      const stats = snapshot.val();
      if (stats) {
        updateDashboardStats(stats);
      }
    });

    // ฟังกิจกรรมจากแต่ละโมดูล
    Object.entries(moduleRefs).forEach(([moduleName, moduleRef]) => {
      onValue(moduleRef, (snapshot) => {
        const data = snapshot.val();
        updateModuleActivity(moduleName, data);
      });
    });

    // ฟังก์ชันอัปเดตกิจกรรมของโมดูล
    function updateModuleActivity(moduleName, data) {
      const activityEl = document.getElementById(`activity-${moduleName}`);
      const dotEl = document.getElementById(`dot-${moduleName}`);
      const sidebarDotEl = document.getElementById(`sidebar-dot-${moduleName}`);
      
      if (activityEl) {
        activityEl.textContent = data?.message || 'ไม่มีกิจกรรม';
        
        // อัปเดตสีจุดสถานะ
        const statusDot = activityEl.previousElementSibling;
        if (statusDot && statusDot.classList.contains('activity-dot')) {
          statusDot.classList.toggle('bg-green-500', !!data);
          statusDot.classList.toggle('bg-gray-500', !data);
        }
      }
      
      // แสดงจุดแจ้งเตือนถ้ามีการอัปเดต
      if (data?.hasUpdate) {
        if (dotEl) dotEl.classList.remove('hidden');
        if (sidebarDotEl) sidebarDotEl.classList.remove('hidden');
      }
    }

    // ฟังก์ชันอัปเดตสถิติ Dashboard
    function updateDashboardStats(stats) {
      // อัปเดตยอดขายวันนี้
      const salesEl = document.querySelector('.bg-blue-50 .text-xl');
      if (salesEl && stats.dailySales) {
        salesEl.textContent = `฿${stats.dailySales.toLocaleString()}`;
      }
      
      // อัปเดตลูกค้าใหม่
      const customersEl = document.querySelector('.bg-green-50 .text-xl');
      if (customersEl && stats.newCustomers) {
        customersEl.textContent = stats.newCustomers;
      }
      
      // อัปเดตสต็อกคงเหลือ
      const stockEl = document.querySelector('.bg-purple-50 .text-xl');
      if (stockEl && stats.stockItems) {
        stockEl.textContent = stats.stockItems;
      }
      
      // อัปเดตคำสั่งซื้อรอส่ง
      const ordersEl = document.querySelector('.bg-yellow-50 .text-xl');
      if (ordersEl && stats.pendingOrders) {
        ordersEl.textContent = stats.pendingOrders;
      }
    }

    // ฟังก์ชันส่งการแจ้งเตือน
    window.sendNotificationToFirebase = function (notification) {
      if (!isFirebaseConnected) return;

      const notifRef = push(notificationsRef);
      set(notifRef, {
        ...notification,
        sessionId: currentSession.sessionId,
        timestamp: Date.now(),
        createdAt: serverTimestamp(),
        source: 'boss_dashboard'
      }).then(() => {
        console.log('✅ Notification sent to Firebase');
      }).catch(err => {
        console.error('❌ Failed to send notification:', err);
      });
    };

    // ฟังก์ชันอัปเดต Activity
    window.updateBossActivity = function (activity) {
      if (!isFirebaseConnected) return;
      
      set(ref(database, `sessions/boss/${currentSession.sessionId}/lastActivity`), serverTimestamp());
      set(ref(database, `sessions/boss/${currentSession.sessionId}/currentActivity`), activity);
    };

          // Heartbeat เพื่อรักษา session
      setInterval(() => {
        if (isFirebaseConnected) {
          set(ref(database, `sessions/boss/${currentSession.sessionId}/lastHeartbeat`), serverTimestamp());
        }
      }, 30000); // ทุก 30 วินาที

          // Cleanup เมื่อปิดหน้า
      window.addEventListener('beforeunload', () => {
        if (isFirebaseConnected) {
          set(ref(database, `sessions/boss/${currentSession.sessionId}/status`), 'offline');
          remove(ref(database, `onlineUsers/boss/${currentSession.sessionId}`));
        }
      });

    // ฟังก์ชันอัปเดตสถานะการเชื่อมต่อ Firebase
    function updateFirebaseStatus(connected) {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        statusEl.className = connected ? 
          'w-2 h-2 rounded-full connected' : 
          'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 
          'Firebase: เชื่อมต่อแล้ว' : 
          'Firebase: ขัดข้อง';
      }
      
      // อัปเดตสถานะรวม
      updateConnectionStatus();
    }

    // ฟังก์ชันอัปเดตสถานะการเชื่อมต่อ Socket.IO
    function updateSocketStatus(connected) {
      const statusEl = document.getElementById('socketStatus');
      if (statusEl) {
        statusEl.className = connected ? 
          'w-2 h-2 rounded-full connected' : 
          'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 
          'Socket.IO: เชื่อมต่อแล้ว' : 
          'Socket.IO: ขัดข้อง';
      }
      
      // อัปเดตสถานะรวม
      updateConnectionStatus();
    }

    // ฟังก์ชันอัปเดตสถานะการเชื่อมต่อรวม
    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      const firebaseStatusEl = document.getElementById('firebaseStatus');
      const socketStatusEl = document.getElementById('socketStatus');
      
      if (!statusEl) return;

      const firebaseOk = window.isFirebaseConnected || false;
      const socketOk = window.socketConnected || false;

      // อัปเดตสถานะแต่ละ indicator
      if (firebaseStatusEl) {
        updateFirebaseIndicator(firebaseOk);
      }
      if (socketStatusEl) {
        updateSocketIndicator(socketOk);
      }

      // อัปเดตสถานะรวม
      if (firebaseOk && socketOk) {
        statusEl.className = 'connection-status online text-xs';
        statusEl.textContent = 'ออนไลน์';
      } else if (!firebaseOk && !socketOk) {
        statusEl.className = 'connection-status offline text-xs';
        statusEl.textContent = 'ออฟไลน์';
      } else {
        statusEl.className = 'connection-status connecting text-xs';
        statusEl.textContent = 'เชื่อมต่อบางส่วน';
      }
    }

    // ฟังก์ชันอัปเดต Firebase indicator
    function updateFirebaseIndicator(connected) {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        statusEl.className = `w-2 h-2 rounded-full ${connected ? 'connected' : 'disconnected'}`;
        statusEl.title = `Firebase: ${connected ? 'เชื่อมต่อแล้ว' : 'ขัดข้อง'}`;
      }
    }

    // ฟังก์ชันอัปเดต Socket indicator
    function updateSocketIndicator(connected) {
      const statusEl = document.getElementById('socketStatus');
      if (statusEl) {
        statusEl.className = `w-2 h-2 rounded-full ${connected ? 'connected' : 'disconnected'}`;
        statusEl.title = `Socket.IO: ${connected ? 'เชื่อมต่อแล้ว' : 'ขัดข้อง'}`;
      }
    }

    // Export functions
    window.updateConnectionStatus = updateConnectionStatus;
    window.updateFirebaseStatus = updateFirebaseStatus;
    window.updateSocketStatus = updateSocketStatus;
    window.currentSession = currentSession;
    
    // expose to window
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
    window.firebaseSet = set;
    window.firebasePush = push;
    window.firebaseServerTimestamp = serverTimestamp;

    console.log('🔥 Firebase Realtime Database initialized with enhanced features');
    console.log('📱 Boss Session ID:', currentSession.sessionId);
    console.log('🏢 Dashboard Mode: BOSS');
  </script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <!-- Cart Badge Styles -->
  <style>
    .cart-badge {
      position: absolute; top: -4px; right: -4px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 2px 5px; border-radius: 9999px;
      min-width: 18px; text-align: center;
    }
    .notification-badge {
      position: absolute; top: -2px; right: -2px;
      background-color: #ef4444; color: white;
      font-size: 10px; font-weight: bold;
      padding: 1px 4px; border-radius: 9999px;
      min-width: 16px; text-align: center;
    }
  </style>

  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>

  <script>
    let lottieAnimation = null;
  </script>

  <!-- Add this script block right before the closing </head> tag -->
  <script>
    // Define toggleSidebar in global scope so it's available for onclick handlers
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');

      // Add body scroll lock when sidebar is open
      if (!sidebar.classList.contains('-translate-x-full')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
  </script>
</head>
<body class="bg-gray-50 font-sans dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Container สำหรับ Toast แจ้งเตือน -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Sidebar Menu -->
  <div id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-all duration-300 z-40 sidebar-transition overflow-y-auto">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/favicon/favicon-32x32.png" alt="Logo" class="h-8 w-8">
        <span class="text-xl font-bold text-primary-600 dark:text-primary-400">ระบบจัดการ</span>
      </div>
      <button onclick="toggleSidebar()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- User Info in Sidebar -->
    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center text-primary-600 dark:text-primary-300">
          <i class="bi bi-person-fill"></i>
        </div>
        <div>
          <div id="sidebarUserName" class="font-medium">Loading...</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
        </div>
      </div>
    </div>
    
<!-- Sidebar Menu Items -->
<div class="py-4">
  <div class="px-4 mb-2 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">เมนูหลัก</div>
  <ul>
    <li>
      <a href="#" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-house-fill text-primary-500"></i>
        <span>หน้าแรก</span>
      </a>
    </li>
    <li>
      <a href="/dashboard" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-graph-up-arrow text-blue-500"></i>
        <span>แดชบอร์ด</span>
      </a>
    </li>
    <li id="sidebar-login-management" style="display: none;">
      <a href="/Login_Management" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-shield-lock-fill text-orange-500"></i>
        <span>อนุมัติคำขอ</span>
      </a>
    </li>
    <li id="sidebar-online-users" style="display: none;">
      <a href="/online-blocked-users" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-people-fill text-green-500"></i>
        <span>ผู้ใช้ออนไลน์</span>
      </a>
    </li>
    <li id="sidebar-price-adjustment" style="display: none;">
      <a href="/price_adjustment" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-tag-fill text-orange-500"></i>
        <span>ปรับราคาสินค้า</span>
      </a>
    </li>
    <li id="sidebar-audit-log" style="display: none;">
      <a href="/audit_log" class="flex items-center space-x-3 px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
        <i class="bi bi-journal-check text-red-500"></i>
        <span>Audit Log</span>
      </a>
    </li>
  </ul>
      
      <div class="px-4 pt-4 pb-2 mt-4 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">ระบบงาน</div>
      <ul>
        <li>
          <a href="/views/BOSS/audit-log.html" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-journal-check text-red-500"></i>
              <span>Audit Log</span>
            </div>
            <span class="badge badge-xs bg-yellow-500 text-xs ml-2">สำหรับผู้บริหาร</span>
          </a>
        </li>
        <li>
          <a href="/accounting_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-journal-text text-blue-500"></i>
              <span>งานบัญชี</span>
            </div>
            <span id="sidebar-dot-accounting" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="/HR_Dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-people-fill text-green-500"></i>
              <span>ฝ่ายบุคคล</span>
            </div>
            <span id="sidebar-dot-hr" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="/StockManagehome" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-box-fill text-yellow-500"></i>
              <span>คลังสินค้า</span>
            </div>
            <span id="sidebar-dot-stock" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="/marketing_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-megaphone-fill text-purple-500"></i>
              <span>การตลาด</span>
            </div>
            <span id="sidebar-dot-marketing" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="/loan_dashboard" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-credit-card-fill text-gray-500"></i>
              <span>สินเชื่อ</span>
            </div>
            <span id="sidebar-dot-loan" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
        <li>
          <a href="/frontstore_index" class="flex items-center justify-between px-4 py-2.5 text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/30 rounded-lg mx-2 transition-colors">
            <div class="flex items-center space-x-3">
              <i class="bi bi-shop-window text-blue-400"></i>
              <span>POS - ขายหน้าร้าน</span>
            </div>
            <span id="sidebar-dot-pos" class="h-2 w-2 bg-red-500 rounded-full hidden"></span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Overlay for sidebar on mobile -->
  <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity duration-300"></div>

  <!-- Page Wrapper -->
  <div class="flex flex-col min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm px-6 py-4 sticky top-0 z-20">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <button onclick="toggleSidebar()" class="text-gray-600 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none">
            <i class="bi bi-list text-2xl"></i>
          </button>
          <div class="flex items-center space-x-2">
            <img src="/favicon/favicon-32x32.png" alt="Logo" class="h-8 w-8 hidden md:block">
            <span class="text-xl font-bold text-primary-600 dark:text-primary-400">ระบบบริหารจัดการ</span>
          </div>
        </div>

        <div class="flex items-center space-x-4">

          <!-- User Profile -->
          <div class="relative" id="profileDropdownContainer">
            <button id="profileDropdownButton" class="flex items-center space-x-2 focus:outline-none">
              <div class="w-8 h-8 rounded-full bg-primary-500 text-white flex items-center justify-center">
                <i class="bi bi-person-fill"></i>
              </div>
              <span id="topUserName" class="font-medium hidden md:block">Loading...</span>
              <i class="bi bi-chevron-down text-sm hidden md:block"></i>
            </button>
            
            <!-- Profile Dropdown -->
            <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden z-30">
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <div class="font-medium text-sm" id="dropdownUserName">Loading...</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</div>
              </div>
              <ul class="py-2">
                <li>
                <a href="profile" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                  <i class="bi bi-person mr-2"></i> โปรไฟล์
                </a>
              </li>
              <li>
                <a href="password_change" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                  <i class="bi bi-gear mr-2"></i> เปลี่ยนรหัสผ่าน
                </a>
              </li>
                <li class="border-t border-gray-200 dark:border-gray-700 mt-2">
                  <button id="btnLogout" class="w-full text-left flex items-center px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30">
                    <i class="bi bi-box-arrow-right mr-2"></i> ออกจากระบบ
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Search Overlay -->
 <div id="searchOverlay"
      class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-start justify-center pt-20">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-3xl w-full mx-4 overflow-hidden transition-all transform scale-95 opacity-0" id="searchModal">
        <div class="p-4 flex items-center border-b border-gray-200 dark:border-gray-700">
          <i class="bi bi-search text-gray-500 mr-3"></i>
          <input type="text" placeholder="ค้นหา..." class="w-full bg-transparent border-0 focus:ring-0 text-lg">
          <button id="closeSearch" class="text-gray-500">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="p-4">
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">ค้นหาล่าสุด</div>
          <div class="space-y-2">
            <div class="flex items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
              <i class="bi bi-clock-history text-gray-400 mr-3"></i>
              <span>รายงานยอดขาย</span>
            </div>
            <div class="flex items-center p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
              <i class="bi bi-clock-history text-gray-400 mr-3"></i>
              <span>ข้อมูลลูกค้า</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page Content -->
    <main class="flex-1 px-6 py-8">
      <div class="max-w-7xl mx-auto">
        <!-- Breadcrumbs -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
              <a href="#" class="inline-flex items-center text-sm text-gray-700 hover:text-primary-600 dark:text-gray-400 dark:hover:text-white">
                <i class="bi bi-house-door-fill mr-2"></i>
                หน้าแรก
              </a>
            </li>
          </ol>
        </nav>
        
        <!-- Welcome Section -->
        <section class="mb-8">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6">
            <div class="flex items-start justify-between">
              <div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2">ยินดีต้อนรับสู่ระบบหลัก</h1>
                <p class="text-gray-600 dark:text-gray-300 max-w-2xl">
                  กรุณาเลือกเมนูเพื่อต่อไปยังส่วนงานหลังบ้านหรือหน้าเว็บหน้าร้าน
                </p>
              </div>
              <div class="hidden md:block">
                <img src="https://via.placeholder.com/120" alt="Dashboard" class="h-20 w-auto rounded-lg">
              </div>
            </div>
            
            <!-- Stats Overview - Only for Super Admin and CEO -->
            <div id="dashboard-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6" style="display: none;">
              <a href="/sales" class="block">
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 hover:shadow-lg transition">
                  <div class="text-blue-600 dark:text-blue-300 text-sm">ยอดขายวันนี้</div>
                  <div class="text-xl font-bold mt-1">฿00</div>
                  <div class="text-xs text-green-600 dark:text-green-400 flex items-center mt-2">
                    <i class="bi bi-arrow-up-right"></i>
                    <span class="ml-1">3.2%</span>
                  </div>
                </div>
              </a>      
              
              <a href="/customers" class="block">
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 hover:shadow-lg transition">
                  <div class="text-green-600 dark:text-green-300 text-sm">ลูกค้าใหม่</div>
                  <div class="text-xl font-bold mt-1">00</div>
                  <div class="text-xs text-green-600 dark:text-green-400 flex items-center mt-2">
                    <i class="bi bi-arrow-up-right"></i>
                    <span class="ml-1">12.5%</span>
                  </div>
                </div>
              </a>

              <a href="/stock" class="block">
                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4 hover:shadow-lg transition">
                  <div class="text-purple-600 dark:text-purple-300 text-sm">สต็อกคงเหลือ</div>
                  <div class="text-xl font-bold mt-1"></div>
                  <div class="text-xs text-red-600 dark:text-red-400 flex items-center mt-2">
                    <i class="bi bi-arrow-down-right"></i>
                    <span class="ml-1">1.8%</span>
                  </div>
                </div>
              </a>

              <a href="/orders" class="block">
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 hover:shadow-lg transition">
                  <div class="text-yellow-600 dark:text-yellow-300 text-sm">คำสั่งซื้อรอส่ง</div>
                  <div class="text-xl font-bold mt-1"></div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center mt-2">
                    <i class="bi bi-dash"></i>
                    <span class="ml-1">คงที่</span>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </section>

        <!-- System Access Section -->
        <section class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">ระบบงาน</h2>
            <div class="text-sm text-primary-600 dark:text-primary-400 hover:underline cursor-pointer">
              <!-- <i class="bi bi-grid-3x3-gap-fill mr-1"></i> แสดงทั้งหมด -->
            </div>
          </div>
          
          <!-- Menu Grid with Enhanced Design -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Accounting Module -->
            <a href="/accounting_dashboard" id="menu-accounting" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <!-- Top color bar to visually distinguish modules -->
                <div class="h-1 bg-blue-500"></div>
                <div class="p-6">
                  <!-- Module Icon with status indicator -->
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-500 text-2xl">
                      <i class="bi bi-journal-text"></i>
                    </div>
                    <span id="dot-accounting" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  
                  <!-- Module Info -->
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">งานบัญชี</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">ระบบบัญชี การเงิน และรายรับ-รายจ่าย</p>
                  
                  <!-- Activity Indicator -->
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-accounting">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

            <!-- HR Module -->
            <a href="/HR_Dashboard" id="menu-hr" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <div class="h-1 bg-green-500"></div>
                <div class="p-6">
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-500 text-2xl">
                      <i class="bi bi-people-fill"></i>
                    </div>
                    <span id="dot-hr" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">ฝ่ายบุคคล</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">จัดการพนักงาน การลา และระบบเงินเดือน</p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-hr">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

            <!-- Stock Management -->
            <a href="/StockManagehome" id="menu-stock" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <div class="h-1 bg-yellow-500"></div>
                <div class="p-6">
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-500 text-2xl">
                      <i class="bi bi-box-fill"></i>
                    </div>
                    <span id="dot-stock" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">คลังสินค้า</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">Stock, สต๊อก และการตรวจนับสินค้า</p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-stock">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

            <!-- Marketing -->
<a href="/marketing_dashboard" id="menu-marketing" class="menu-card group">
  <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
    <div class="h-1 bg-purple-500"></div>
    <div class="p-6">
      <div class="relative mb-4">
        <div class="w-14 h-14 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-500 text-2xl">
          <i class="bi bi-megaphone-fill"></i>
        </div>
        <span id="dot-marketing" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
      </div>
      <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">การตลาด</h5>
      <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">แคมเปญการตลาดและวิเคราะห์ผลตอบรับ</p>
      <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
        <span class="activity-dot bg-gray-500 mr-1.5"></span>
        <span id="activity-marketing">กำลังโหลด...</span>
      </div>
    </div>
  </div>
</a>

            <!-- Employee Management -->
            <a href="/employee_only" id="menu-employee" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <div class="h-1 bg-indigo-500"></div>
                <div class="p-6">
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-500 text-2xl">
                      <i class="bi bi-person-badge-fill"></i>
                    </div>
                    <span id="dot-employee" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">พนักงาน</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">จัดการข้อมูลพนักงาน และประวัติการทำงาน</p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-employee">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

            <!-- Loan Management -->
            <a href="/loan_dashboard" id="menu-loan" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <div class="h-1 bg-red-500"></div>
                <div class="p-6">
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center bg-red-500 text-2xl">
                      <i class="bi bi-credit-card-fill"></i>
                    </div>
                    <span id="dot-loan" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">สินเชื่อ</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">จัดการสินเชื่อและเครดิตลูกค้า</p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-loan">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

            <!-- POS System -->
            <a href="/frontstore_index" id="menu-pos" class="menu-card group">
              <div class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden h-full">
                <div class="h-1 bg-blue-400"></div>
                <div class="p-6">
                  <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-400 text-2xl">
                      <i class="bi bi-shop"></i>
                    </div>
                    <span id="dot-pos" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse-slow"></span>
                  </div>
                  <h5 class="text-lg font-bold mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">POS - ขายหน้าร้าน</h5>
                  <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">ระบบขายหน้าร้านสำหรับพนักงานขาย</p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                    <span class="activity-dot bg-gray-500 mr-1.5"></span>
                    <span id="activity-pos">กำลังโหลด...</span>
                  </div>
                </div>
              </div>
            </a>

          </div>
        </section>

        <!-- System Analysis & Audit Log -->
        <div class="menu-card bg-gradient-to-br from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="p-3 bg-white/20 rounded-full">
                  <i class="fas fa-shield-alt text-2xl text-white"></i>
                </div>
                <div class="ml-4">
                  <h3 class="text-xl font-semibold text-white">ระบบตรวจสอบ Audit Log</h3>
                  <p class="text-red-100 text-sm">ติดตามกิจกรรมทั้งหมดในระบบ</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-white/80 text-xs">แสดงล่าสุด</div>
                <div id="auditCount" class="text-white font-bold">-</div>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2">
              <a href="audit-logs" class="bg-white/20 hover:bg-white/30 rounded-lg p-3 text-center transition-colors">
                <i class="fas fa-chart-line text-white text-lg"></i>
                <div class="text-white text-sm font-medium mt-1">Dashboard</div>
                <div class="text-red-100 text-xs">ภาพรวม</div>
              </a>
              <a href="audit_log" class="bg-white/20 hover:bg-white/30 rounded-lg p-3 text-center transition-colors">
                <i class="fas fa-list-alt text-white text-lg"></i>
                <div class="text-white text-sm font-medium mt-1">รายละเอียด</div>
                <div class="text-red-100 text-xs">ทุกระบบ</div>
              </a>
            </div>
          </div>
        </div>

        <!-- Recent Activities Section -->
        <section id="recent-activities" style="display: none;">
          <h2 class="text-xl font-semibold mb-4">กิจกรรมล่าสุด</h2>
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card overflow-hidden">
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
              <div class="p-4 flex items-start space-x-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-500">
                  <i class="bi bi-person-check-fill"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium">มีพนักงานใหม่เข้าระบบ</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">วันนี้, 10:23</p>
                </div>
              </div>
              <div class="p-4 flex items-start space-x-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-500">
                  <i class="bi bi-receipt"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium">มีรายงานการขายใหม่</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">วันนี้, 09:45</p>
                </div>
              </div>
              <div class="p-4 flex items-start space-x-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-500">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium">แจ้งเตือนสินค้าใกล้หมด</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">เมื่อวานนี้, 15:30</p>
                </div>
              </div>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 text-center">
              <a href="#" class="text-sm text-primary-600 dark:text-primary-400 hover:underline">
                ดูกิจกรรมทั้งหมด
              </a>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 py-6 px-6 mt-8 border-t border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto text-center">
        <p class="text-sm text-gray-500 dark:text-gray-400">
          &copy; 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์ทั้งหมด
        </p>
        <div class="flex justify-center space-x-4 mt-3">
          <a href="#" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">นโยบายความเป็นส่วนตัว</a>
          <a href="#" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">เงื่อนไขการใช้งาน</a>
          <a href="#" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">ติดต่อสนับสนุน</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script>
    /**************************************
     * ฟังก์ชันช่วยอัปเดตชื่อบน UI ทุกจุด
     **************************************/
    function updateNameOnPage(name) {
      const topUserName = document.getElementById('topUserName');
      const sidebarUserName = document.getElementById('sidebarUserName');
      const dropdownUserName = document.getElementById('dropdownUserName');

      if (topUserName) topUserName.textContent = name;
      if (sidebarUserName) sidebarUserName.textContent = name;
      if (dropdownUserName) dropdownUserName.textContent = name;
    }

    /**************************************
     * โหลดข้อมูลผู้ใช้และตรวจสอบสิทธิ์การเข้าถึง
     **************************************/

    // Retry wrapper function for network requests
    async function retryApiCall(apiCallFunction, maxRetries = 2, delay = 1000) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          return await apiCallFunction();
        } catch (error) {
          console.warn(`🔄 API call attempt ${attempt} failed:`, error.message);

          // Don't retry for authentication errors
          if (error.message.includes('โทเค็น') ||
              error.message.includes('token') ||
              error.message.includes('Invalid') ||
              error.message.includes('ไม่พบผู้ใช้ในระบบ')) {
            throw error;
          }

          if (attempt === maxRetries) {
            throw new Error(`การเรียก API ล้มเหลวหลังจากพยายาม ${maxRetries} ครั้ง: ${error.message}`);
          }

          // Wait before retry
          await new Promise(resolve => setTimeout(resolve, delay * attempt));
        }
      }
    }

    async function loadUserData() {
      const token = localStorage.getItem('authToken');

      if (!token) {
        window.location.href = '/login';
        return;
      }

      // แสดงชื่อเก่าก่อนได้เลย (ถ้ามี)
      updateNameOnPage(localStorage.getItem('userName') || 'ผู้ใช้');

      // Setup logout button
      const btnLogout = document.getElementById('btnLogout');
      if (btnLogout) {
        btnLogout.addEventListener('click', () => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userInfo');
          showToast('ออกจากระบบเรียบร้อยแล้ว', 'info');
          setTimeout(() => {
            window.location.href = '/login';
          }, 1000);
        });
      }
    
      try {
        console.log('🔄 Loading user data with token:', token.substring(0, 20) + '...');

        // Use retry wrapper for the API call
        const responseData = await retryApiCall(async () => {
          const res = await fetch('/api/users/me?ts=' + Date.now(), {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            cache: 'no-store'
          });

          console.log('📡 API Response status:', res.status, res.statusText);

          if (!res.ok) {
            let errorDetail = 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้';
            try {
              const errorData = await res.json();
              errorDetail = errorData.error || errorDetail;
              console.error('❌ API Error Response:', errorData);
            } catch (parseError) {
              console.error('❌ Failed to parse error response:', parseError);
            }

            // Handle specific HTTP status codes
            if (res.status === 401) {
              console.log('🔒 Token expired or invalid, redirecting to login');
              localStorage.removeItem('authToken');
              localStorage.removeItem('userName');
              localStorage.removeItem('userInfo');
              window.location.href = '/login';
              return;
            } else if (res.status === 404) {
              errorDetail = 'ไม่พบข้อมูลผู้ใช้ในระบบ กรุณาติดต่อผู้ดูแลระบบ';
            } else if (res.status === 503) {
              errorDetail = 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้ กรุณาลองใหม่ในภายหลัง';
            }

            throw new Error(errorDetail);
          }

          const data = await res.json();
          console.log('✅ API Response:', data);

          if (!data.success) {
            throw new Error(data.error || 'ตอบสนองจากเซิร์ฟเวอร์ไม่สำเร็จ');
          }

          if (!data.data) {
            throw new Error('ไม่พบข้อมูลผู้ใช้ในการตอบสนอง');
          }

          return data;
        });

        const userDetails = responseData.data;

        console.log('🔍 User Details:', userDetails);
        console.log('📋 userDetails.allowedPages =', userDetails.allowedPages);
        console.log('📋 userDetails.role =', userDetails.role);
        console.log('📋 userDetails.role.allowedPages =', userDetails.role?.allowedPages);
    
        // ดึงชื่อพนักงานจากข้อมูล employee
        let displayName = 'ผู้ใช้';
    
        if (userDetails.employee && userDetails.employee.name) {
          displayName = userDetails.employee.name;
        } else if (userDetails.employee && (userDetails.employee.firstName || userDetails.employee.lastName)) {
          // กรณีมี firstName และ lastName แยก
          const firstName = userDetails.employee.firstName || '';
          const lastName = userDetails.employee.lastName || '';
          displayName = `${firstName} ${lastName}`.trim();
        } else if (userDetails.fullName) {
          displayName = userDetails.fullName;
        } else if (userDetails.displayName) {
          displayName = userDetails.displayName;
        } else if (userDetails.name) {
          displayName = userDetails.name;
        } else {
          // ใช้ username เป็นทางเลือกสุดท้าย
          displayName = userDetails.username || 'ผู้ใช้';
        }
    
        console.log('👤 Display name resolved:', displayName);
        console.log('📋 Employee data:', userDetails.employee);
    
        localStorage.setItem('userName', displayName);
        updateNameOnPage(displayName);
    
        // ตรวจสอบสิทธิ์การเข้าถึง - ปรับปรุงให้ดีขึ้น
        let allowedPages = [];
    
        // ดึง allowedPages จาก role หรือ user โดยตรง
        if (userDetails.role?.allowedPages && Array.isArray(userDetails.role.allowedPages)) {
          allowedPages = userDetails.role.allowedPages;
        } else if (userDetails.allowedPages && Array.isArray(userDetails.allowedPages)) {
          allowedPages = userDetails.allowedPages;
        }
    
        // ตรวจสอบ admin role - ให้ admin เห็นทุกอย่าง
        let roleName = '';
        if (typeof userDetails.role === 'string') {
          roleName = userDetails.role.toLowerCase();
        } else if (userDetails.role?.name) {
          roleName = userDetails.role.name.toLowerCase();
        }
    
        const isAdmin = roleName === 'admin' ||
                       roleName === 'super admin' ||
                       roleName === 'ceo' ||
                       roleName.includes('นักพัฒนา') ||
                       roleName.includes('admin');
    
        const isSuperUser = allowedPages.includes('*') || isAdmin;
    
        console.log('🔍 Role detection details:');
        console.log('  - userDetails.role =', userDetails.role);
        console.log('  - typeof userDetails.role =', typeof userDetails.role);
        console.log('  - roleName (lowercase) =', roleName);
        console.log('  - isAdmin =', isAdmin);
        console.log('  - isSuperUser =', isSuperUser);
    
        // ถ้าเป็น admin แต่ไม่มี allowedPages ให้เซ็ตเป็น *
        if (isAdmin && allowedPages.length === 0) {
          allowedPages = ['*'];
        }
    
        const pageMap = {
          accounting:     'accounting_dashboard',
          hr:             'HR_Dashboard',
          stock:          'StockManagehome',
          marketing:      'marketing_dashboard',
          loan:           'loan_dashboard',
          pos:            'frontstore_index',
          gifts:          'gifts_dashboard',
          report:         'financial_dashboard',
          branch_pattani: 'frontstore_pattani',
          branch_hatyai:  'frontstore_Hatyai'
        };
    
        console.log('👤 Role name =', userDetails.role?.name);
        console.log('👤 isAdmin =', isAdmin);
        console.log('👤 isSuperUser =', isSuperUser, ', allowedPages =', allowedPages);
        console.log('🗂️ Available modules to check:', ['accounting', 'hr', 'stock', 'marketing', 'loan', 'pos', 'gifts']);
    
        // ถ้ามีสิทธิ์แค่หน้าเดียว และไม่ใช่ Super User ให้เด้งไปหน้าเลย
        if (!isSuperUser && allowedPages.length === 1) {
          const key = allowedPages[0]?.toString().toLowerCase();
          const target = pageMap[key];
          console.log('🔄 Single permission redirect:', key, '→', target);

          if (target) {
            window.location.href = target;
            return;
          }
        }

        // รอให้ DOM โหลดเสร็จก่อนจัดการ elements
        function applyPermissions() {
          // ประกาศโมดูลก่อนใช้งาน (ให้ตรงกับ register_user.html)
          const allModules = [
            { id: 'audit',      cardId: null,              sidebarHref: '/audit_log' },
            { id: 'accounting', cardId: 'menu-accounting', sidebarHref: '/accounting_dashboard' },
            { id: 'hr',         cardId: 'menu-hr',         sidebarHref: '/HR_Dashboard' },
            { id: 'stock',      cardId: 'menu-stock',      sidebarHref: '/StockManagehome' },
            { id: 'marketing',  cardId: 'menu-marketing',  sidebarHref: '/marketing_dashboard' },
            { id: 'loan',       cardId: 'menu-loan',       sidebarHref: '/loan_dashboard' },
            { id: 'pos',        cardId: 'menu-pos',        sidebarHref: '/frontstore_index' }
          ];

          console.log('🔄 Applying permissions to UI elements...');
          console.log('📊 DOM ready state:', document.readyState);

          // Apply admin sections visibility first
          showAdminSections();

          allModules.forEach(mod => {
            const inAllowed = isSuperUser || allowedPages.includes(mod.id);
            console.log(`🔍 Module ${mod.id}: inAllowed = ${inAllowed}, isSuperUser = ${isSuperUser}, allowedPages includes = ${allowedPages.includes(mod.id)}`);

            // 1) ซ่อน/โชว์ การ์ดบนหน้า Home
            if (mod.cardId) {
              const cardEl = document.getElementById(mod.cardId);
              if (cardEl) {
                cardEl.style.display = inAllowed ? 'block' : 'none';
                console.log(`  📋 Card ${mod.cardId}: ${inAllowed ? 'shown' : 'hidden'}`);
              } else {
                console.log(`  ⚠️ Card element not found: ${mod.cardId}`);
              }
            }

            // 2) ซ่อน/โชว์ ลิงก์ใน Sidebar
            if (mod.sidebarHref) {
              const linkEl = document.querySelector(`#sidebar a[href="${mod.sidebarHref}"]`);
              if (linkEl) {
                linkEl.closest('li').style.display = inAllowed ? 'block' : 'none';
                console.log(`  📋 Sidebar link ${mod.sidebarHref}: ${inAllowed ? 'shown' : 'hidden'}`);
              } else {
                console.log(`  ⚠️ Sidebar link not found: ${mod.sidebarHref}`);
              }
            }
          });
        }

        // ถ้า DOM โหลดเสร็จแล้ว ให้ทำงานทันที ไม่งั้นรอให้เสร็จ
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          applyPermissions();
        } else {
          document.addEventListener('DOMContentLoaded', applyPermissions);
        }
    
        // แสดง/ซ่อน admin-only sections
        function showAdminSections() {
          console.log('🔧 showAdminSections called with isAdmin =', isAdmin);
    
          // Dashboard stats
          const dashboardStats = document.getElementById('dashboard-stats');
          if (dashboardStats) {
            dashboardStats.style.display = isAdmin ? 'grid' : 'none';
            console.log('  📊 Dashboard stats:', isAdmin ? 'shown (grid)' : 'hidden (none)');
          } else {
            console.log('  ⚠️ Dashboard stats element not found');
          }
    
          // Recent activities
          const recentActivities = document.getElementById('recent-activities');
          if (recentActivities) {
            recentActivities.style.display = isAdmin ? 'block' : 'none';
            console.log('  📈 Recent activities:', isAdmin ? 'shown (block)' : 'hidden (none)');
          } else {
            console.log('  ⚠️ Recent activities element not found');
          }
    
          // Sidebar admin menu items
          const adminMenuItems = [
            'sidebar-login-management',
            'sidebar-online-users',
            'sidebar-price-adjustment'
          ];
    
          adminMenuItems.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
              item.style.display = isAdmin ? 'block' : 'none';
              console.log(`  📋 ${itemId}:`, isAdmin ? 'shown (block)' : 'hidden (none)');
            } else {
              console.log(`  ⚠️ ${itemId} element not found`);
            }
          });
    
          console.log('🔧 Admin sections visibility completed');
        }
    
      } catch (err) {
        console.error('Error loading user data:', err);
        if (
          err.name === 'TokenExpiredError' ||
          err.message.includes('โทเค็นหมดอายุ') ||
          err.message.includes('โทเค็นถูกยกเลิกแล้ว') ||
          err.message.includes('Invalid token') ||
          err.message.includes('ไม่พบผู้ใช้ในระบบ')
        ) {
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userInfo');
          window.location.href = '/login';
          return;
        }
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
      }
    }

    // เพิ่มฟังก์ชัน setupDarkMode
    function setupDarkMode() {
      function updateDarkMode() {
        localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
      }
      function loadDarkMode() {
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }
      loadDarkMode();
      const btn = document.getElementById('btnToggleDark');
      if (btn) btn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        updateDarkMode();
      });
    }

    /**************************************
     * ฟังก์ชันพื้นฐานสำหรับ UI
     **************************************/
    
    // Toggle Sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
    
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    
      // Add body scroll lock when sidebar is open
      if (!sidebar.classList.contains('-translate-x-full')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
    
    // User Profile Dropdown
    function setupProfileDropdown() {
      const button = document.getElementById('profileDropdownButton');
      const dropdown = document.getElementById('profileDropdown');
    
      if (button && dropdown) {
        button.addEventListener('click', () => {
          dropdown.classList.toggle('hidden');
        });
    
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
        });
      }
    }
    
    // Notification Dropdown
    function setupNotificationDropdown() {
      const button = document.getElementById('notificationButton');
      const dropdown = document.getElementById('notificationDropdown');
    
      if (button && dropdown) {
        button.addEventListener('click', () => {
          dropdown.classList.toggle('hidden');
          hideNotificationDot();
        });
    
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
        });
      }
    }
    
    // Search Modal
    function setupSearch() {
      const searchButton = document.getElementById('searchButton');
      const searchOverlay = document.getElementById('searchOverlay');
      const searchModal = document.getElementById('searchModal');
      const closeSearch = document.getElementById('closeSearch');
    
      if (searchButton && searchOverlay && closeSearch) {
        searchButton.addEventListener('click', () => {
          searchOverlay.classList.remove('hidden');
          searchOverlay.classList.add('flex');
    
          setTimeout(() => {
            searchModal.classList.remove('scale-95', 'opacity-0');
            searchModal.classList.add('scale-100', 'opacity-100');
          }, 10);
    
          // Focus search input
          const searchInput = searchModal.querySelector('input');
          if (searchInput) searchInput.focus();
        });
    
            const closeSearchModal = () => {
              searchModal.classList.remove('scale-100', 'opacity-100');
              searchModal.classList.add('scale-95', 'opacity-0');
    
              setTimeout(() => {
                searchOverlay.classList.add('hidden');
                searchOverlay.classList.remove('flex');
              }, 200);
            };
    
            // close handlers
            closeSearch.addEventListener('click', closeSearchModal);
            searchOverlay.addEventListener('click', e => {
              if (e.target === searchOverlay) closeSearchModal();
            });
          }
        } // end setupSearch

        // Toast Notifications
        function showToast(message, type = 'info') {
          const container = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          const colors = {
            success: 'bg-green-100 text-green-800 border-green-500',
            error: 'bg-red-100 text-red-800 border-red-500',
            info:    'bg-blue-100 text-blue-800 border-blue-500',
            warning: 'bg-yellow-100 text-yellow-800 border-yellow-500'
          };
          const icons = {
            success: 'bi-check-circle-fill',
            error:   'bi-x-circle-fill',
            info:    'bi-info-circle-fill',
            warning: 'bi-exclamation-triangle-fill'
          };
          toast.className = `px-4 py-3 mb-3 flex items-center border-l-4 rounded-lg shadow-lg animate__animated animate__fadeInRight ${colors[type]}`;
          toast.innerHTML = `<i class="bi ${icons[type]} mr-2"></i><span>${message}</span>`;
          container.appendChild(toast);
          setTimeout(() => {
            toast.classList.replace('animate__fadeInRight','animate__fadeOutRight');
            setTimeout(() => toast.remove(), 500);
          }, 3000);
        }

        // Show/Hide Loading Function (เหมือน frontstore_index.html)
        function showLoading(show) {
          const loader = document.getElementById('loadingOverlay');
          if (show) {
            loader.style.display = 'flex';
            loader.classList.remove('animate__fadeOut');
            loader.classList.add('animate__fadeIn');
    
            // โหลดและเล่น Lottie animation
            if (!lottieAnimation) {
              console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
              fetch('/Loading/Loading.json')
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
                })
                .then(animationData => {
                  lottieAnimation = lottie.loadAnimation({
                    container: document.getElementById('lottieContainer'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    animationData: animationData
                  });
    
                  console.log('✅ Lottie animation loaded successfully');
                })
                .catch(error => {
                  console.error('❌ Error loading Lottie animation:', error);
                  // Fallback เฉพาะเมื่อ Lottie โหลดไม่สำเร็จ
                  document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
                });
            } else {
              lottieAnimation.play();
            }
          } else {
            if (lottieAnimation) {
              lottieAnimation.pause();
            }
            loader.classList.remove('animate__fadeIn');
            loader.classList.add('animate__fadeOut');
            setTimeout(() => { loader.style.display = 'none'; }, 600);
          }
        }

        // Notification Dots
        function showNotificationDot() {
          const dot = document.getElementById('notificationDot');
          const badge = document.getElementById('notificationBadge');
          if (dot) dot.classList.remove('hidden');
          if (badge) { badge.classList.remove('hidden'); badge.textContent = '1'; }
        }
        function hideNotificationDot() {
          const dot = document.getElementById('notificationDot');
          const badge = document.getElementById('notificationBadge');
          if (dot) dot.classList.add('hidden');
          if (badge) badge.classList.add('hidden');
        }

        // Cart Badge
        function updateCartBadge(count) {
          const badge = document.getElementById('cartBadge');
          if (!badge) return;
          if (count > 0) { badge.classList.remove('hidden'); badge.textContent = count; }
          else badge.classList.add('hidden');
        }

        // Firebase Activity Monitor Enhanced
        function setupActivityMonitor() {
          if (!window.firebaseDB) {
            console.warn('⚠️ Firebase not available for activity monitoring');
            return;
          }
    
          console.log('🔍 Setting up Firebase activity monitoring...');
    
          const modules = {
            accounting: { ref:'activities/accounting', el:'activity-accounting', dot:'dot-accounting', sidebar:'sidebar-dot-accounting' },
            hr:         { ref:'activities/hr',         el:'activity-hr',       dot:'dot-hr',        sidebar:'sidebar-dot-hr' },
            stock:      { ref:'activities/stock',      el:'activity-stock',    dot:'dot-stock',     sidebar:'sidebar-dot-stock' },
            marketing:  { ref:'activities/marketing',  el:'activity-marketing',dot:'dot-marketing', sidebar:'sidebar-dot-marketing' },
            loan:       { ref:'activities/loan',       el:'activity-loan',     dot:'dot-loan',      sidebar:'sidebar-dot-loan' },
            pos:        { ref:'activities/pos',        el:'activity-pos',      dot:'dot-pos',       sidebar:'sidebar-dot-pos' },
            report:     { ref:'activities/report',     dot:'dot-report',       sidebar:'sidebar-dot-report' }
          };
    
          Object.entries(modules).forEach(([moduleName, cfg]) => {
            const dbRef = window.firebaseRef(window.firebaseDB, cfg.ref);
    
            window.firebaseOnValue(dbRef, (snap) => {
              const data = snap.val();
              console.log(`📊 Activity update for ${moduleName}:`, data);
    
              // อัปเดต activity message
              if (cfg.el) {
                const el = document.getElementById(cfg.el);
                if (el) {
                  el.textContent = data?.message || 'ไม่มีกิจกรรม';
    
                  // อัปเดตสีจุดสถานะ
                  const dotEl = el.previousElementSibling;
                  if (dotEl && dotEl.classList.contains('activity-dot')) {
                    dotEl.classList.toggle('bg-green-500', !!data && !!data.isActive);
                    dotEl.classList.toggle('bg-yellow-500', !!data && !data.isActive);
                    dotEl.classList.toggle('bg-gray-500', !data);
                  }
                }
              }
    
              // แสดงจุดแจ้งเตือนถ้ามีการอัปเดต
              if (data?.hasUpdate || data?.newActivity) {
                [cfg.dot, cfg.sidebar].forEach(id => {
                  const d = document.getElementById(id);
                  if (d) {
                    d.classList.remove('hidden');
                    d.classList.add('animate-pulse-slow');
                  }
                });
    
                // ส่งการแจ้งเตือน
                if (data.message && typeof showToast === 'function') {
                  showToast(`📊 ${moduleName.toUpperCase()}: ${data.message}`, 'info');
                }
              }
            }, (error) => {
              console.error(`❌ Firebase listener error for ${moduleName}:`, error);
            });
          });
    
          // ตั้งค่าการฟังข้อมูลสถิติระบบ
          const systemStatsRef = window.firebaseRef(window.firebaseDB, 'systemStats/boss');
          window.firebaseOnValue(systemStatsRef, (snap) => {
            const stats = snap.val();
            if (stats) {
              console.log('📈 System stats updated:', stats);
              updateDashboardStats(stats);
            }
          });
    
          // ตั้งค่าการฟังผู้ใช้ออนไลน์
          const onlineUsersRef = window.firebaseRef(window.firebaseDB, 'onlineUsers/boss');
          window.firebaseOnValue(onlineUsersRef, (snap) => {
            const users = snap.val() || {};
            const onlineCount = Object.keys(users).length;
            console.log(`👥 Boss dashboard online users: ${onlineCount}`);
    
            // อัปเดต UI ถ้ามี element
            const onlineCountEl = document.getElementById('onlineUserCount');
            if (onlineCountEl) {
              onlineCountEl.textContent = onlineCount;
            }
          });
    
          console.log('✅ Firebase activity monitoring setup complete');
        }

        // ฟังก์ชันอัปเดตสถิติ Dashboard (ปรับปรุงแล้ว)
        function updateDashboardStats(stats) {
          console.log('📊 Updating dashboard stats:', stats);
    
          try {
            // อัปเดตยอดขายวันนี้
            const salesEl = document.querySelector('.bg-blue-50 .text-xl');
            if (salesEl && stats.dailySales !== undefined) {
              salesEl.textContent = `฿${Number(stats.dailySales).toLocaleString()}`;
            }
    
            // อัปเดตลูกค้าใหม่
            const customersEl = document.querySelector('.bg-green-50 .text-xl');
            if (customersEl && stats.newCustomers !== undefined) {
              customersEl.textContent = stats.newCustomers;
            }
    
            // อัปเดตสต็อกคงเหลือ
            const stockEl = document.querySelector('.bg-purple-50 .text-xl');
            if (stockEl && stats.stockItems !== undefined) {
              stockEl.textContent = Number(stats.stockItems).toLocaleString();
            }
    
            // อัปเดตคำสั่งซื้อรอส่ง
            const ordersEl = document.querySelector('.bg-yellow-50 .text-xl');
            if (ordersEl && stats.pendingOrders !== undefined) {
              ordersEl.textContent = stats.pendingOrders;
            }
    
            // อัปเดต growth indicators
            updateGrowthIndicators(stats);
    
            console.log('✅ Dashboard stats updated successfully');
          } catch (error) {
            console.error('❌ Error updating dashboard stats:', error);
          }
        }

        // ฟังก์ชันอัปเดต growth indicators
        function updateGrowthIndicators(stats) {
          if (stats.growth) {
            // Sales growth
            const salesGrowthEl = document.querySelector('.bg-blue-50 .text-green-600');
            if (salesGrowthEl && stats.growth.sales !== undefined) {
              const growth = stats.growth.sales;
              salesGrowthEl.className = `text-xs flex items-center mt-2 ${growth >= 0 ? 'text-green-600' : 'text-red-600'}`;
              salesGrowthEl.innerHTML = `
                <i class="bi ${growth >= 0 ? 'bi-arrow-up-right' : 'bi-arrow-down-right'}"></i>
                <span class="ml-1">${Math.abs(growth)}%</span>
              `;
            }
    
            // Customer growth
            const customerGrowthEl = document.querySelector('.bg-green-50 .text-green-600');
            if (customerGrowthEl && stats.growth.customers !== undefined) {
              const growth = stats.growth.customers;
              customerGrowthEl.className = `text-xs flex items-center mt-2 ${growth >= 0 ? 'text-green-600' : 'text-red-600'}`;
              customerGrowthEl.innerHTML = `
                <i class="bi ${growth >= 0 ? 'bi-arrow-up-right' : 'bi-arrow-down-right'}"></i>
                <span class="ml-1">${Math.abs(growth)}%</span>
              `;
            }
          }
        }

        // Socket.IO Setup Enhanced
        function setupSocketIO() {
          // เชื่อมต่อ Socket.IO พร้อม configuration
          const socket = io({
            timeout: 10000,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            randomizationFactor: 0.5
          });

          let socketConnected = false;
          let reconnectAttempts = 0;
          let heartbeatInterval = null;

          socket.on('connect', () => {
            socketConnected = true;
            window.socketConnected = true;
            reconnectAttempts = 0;
            console.log('🔗 Socket.IO connected successfully');
            console.log('🆔 Socket ID:', socket.id);

            // ส่งข้อมูลสาขาไปยังเซิร์ฟเวอร์เพื่อ join room
            socket.emit('join_boss_dashboard', {
              sessionId: window.currentSession?.sessionId,
              staffId: localStorage.getItem('userId'),
              staffName: localStorage.getItem('userName'),
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent,
              userRole: 'boss'
            });

            if (typeof showToast === 'function') {
              showToast('🚀 เชื่อมต่อ Socket.IO สำเร็จ', 'success');
            }

            // เริ่ม heartbeat
            startHeartbeat();
    
            // อัปเดตสถานะการเชื่อมต่อ
            updateSocketStatus(true);
          });

          socket.on('disconnect', (reason) => {
            socketConnected = false;
            window.socketConnected = false;
            console.warn('⚠️ Socket.IO disconnected:', reason);

            if (typeof showToast === 'function') {
              showToast('⚠️ การเชื่อมต่อ Socket.IO ขัดข้อง', 'warning');
            }

            // หยุด heartbeat
            stopHeartbeat();
    
            // อัปเดตสถานะการเชื่อมต่อ
            updateSocketStatus(false);
          });

          socket.on('reconnect', (attemptNumber) => {
            console.log(`🔄 Socket.IO reconnected after ${attemptNumber} attempts`);
            if (typeof showToast === 'function') {
              showToast('✅ เชื่อมต่อ Socket.IO สำเร็จ', 'success');
            }
          });

          socket.on('reconnect_attempt', (attemptNumber) => {
            reconnectAttempts = attemptNumber;
            console.log(`🔄 Socket.IO reconnection attempt ${attemptNumber}`);
          });

          socket.on('reconnect_failed', () => {
            console.error('❌ Socket.IO reconnection failed');
            if (typeof showToast === 'function') {
              showToast('❌ ไม่สามารถเชื่อมต่อ Socket.IO ได้', 'error');
            }
          });

          // รับการแจ้งเตือนจากระบบ
          socket.on('notification', (data) => {
            if (typeof showToast === 'function') {
              showToast(data.message, data.type || 'info');
            }
            showNotificationDot();
    
            // ส่งไปยัง Firebase ด้วย
            if (window.sendNotificationToFirebase) {
              window.sendNotificationToFirebase({
                title: data.title || 'การแจ้งเตือน',
                message: data.message,
                type: data.type || 'info',
                source: 'socket_io'
              });
            }
          });

          // รับข้อมูลสถิติระบบ
          socket.on('system_stats_update', (data) => {
            console.log('📊 System stats update received:', data);
    
            // อัปเดตสถิติ Dashboard
            if (data.stats) {
              updateDashboardStats(data.stats);
            }
    
            // ส่งไปยัง Firebase
            if (window.isFirebaseConnected && window.firebaseSet) {
              const systemStatsRef = window.firebaseRef(window.firebaseDB, 'systemStats/boss');
              window.firebaseSet(systemStatsRef, {
                ...data.stats,
                lastUpdated: window.firebaseServerTimestamp(),
                source: 'socket_io'
              });
            }
          });

          // รับการอัปเดตกิจกรรมจากโมดูลต่างๆ
          socket.on('module_activity_update', (data) => {
            console.log('🔄 Module activity update:', data);
    
            const { module, activity, hasUpdate } = data;
    
            // อัปเดต UI
            const activityEl = document.getElementById(`activity-${module}`);
            if (activityEl) {
              activityEl.textContent = activity?.message || 'ไม่มีกิจกรรม';
            }
    
            // แสดงจุดแจ้งเตือน
            if (hasUpdate) {
              const dotEl = document.getElementById(`dot-${module}`);
              const sidebarDotEl = document.getElementById(`sidebar-dot-${module}`);
              if (dotEl) dotEl.classList.remove('hidden');
              if (sidebarDotEl) sidebarDotEl.classList.remove('hidden');
            }
    
            // ส่งไปยัง Firebase
            if (window.isFirebaseConnected && window.firebaseSet) {
              const moduleRef = window.firebaseRef(window.firebaseDB, `activities/${module}`);
              window.firebaseSet(moduleRef, {
                ...activity,
                lastUpdated: window.firebaseServerTimestamp(),
                hasUpdate: hasUpdate
              });
            }
          });

          // รับคำสั่งบังคับออกจากระบบ
          socket.on('forceLogout', (data) => {
            if (typeof showToast === 'function') {
              showToast(data.reason || 'คุณถูกเตะออกจากระบบ', 'error');
            }
    
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/login';
            }, 2000);
          });

          // รับข้อมูลผู้ใช้ออนไลน์
          socket.on('online_users_update', (data) => {
            console.log('👥 Online users update:', data);
    
            // อัปเดต UI ถ้ามี element
            const onlineCountEl = document.getElementById('onlineUserCount');
            if (onlineCountEl && data.count !== undefined) {
              onlineCountEl.textContent = data.count;
            }
          });

          // รับการอัปเดตโปรโมชั่น/ข่าวสาร
          socket.on('promotion_update', (data) => {
            console.log('🎁 Promotion update received:', data);
    
            if (typeof showToast === 'function') {
              showToast(`🎁 ${data.message || 'มีโปรโมชั่นใหม่'}`, 'info');
            }
          });

          // Error handling
          socket.on('error', (error) => {
            console.error('❌ Socket.IO error:', error);
            if (typeof showToast === 'function') {
              showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ Socket.IO', 'error');
            }
          });

          socket.on('connect_error', (error) => {
            console.error('❌ Socket.IO connection error:', error);
            if (typeof showToast === 'function') {
              showToast('ไม่สามารถเชื่อมต่อ Socket.IO ได้', 'error');
            }
          });

          // ฟังก์ชัน Heartbeat
          function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
    
            heartbeatInterval = setInterval(() => {
              if (socketConnected) {
                socket.emit('boss_heartbeat', {
                  sessionId: window.currentSession?.sessionId,
                  timestamp: new Date().toISOString(),
                  staffId: localStorage.getItem('userId')
                });
              }
            }, 30000); // ทุก 30 วินาที
          }

          function stopHeartbeat() {
            if (heartbeatInterval) {
              clearInterval(heartbeatInterval);
              heartbeatInterval = null;
            }
          }

          // ฟังก์ชันสำหรับส่ง event ไปยังเซิร์ฟเวอร์
          window.emitBossActivity = function (activityData) {
            if (socketConnected) {
              socket.emit('boss_activity', {
                ...activityData,
                sessionId: window.currentSession?.sessionId,
                timestamp: new Date().toISOString(),
                staffId: localStorage.getItem('userId')
              });
              console.log('📤 Boss activity sent to server');
            } else {
              console.warn('⚠️ Socket not connected, cannot emit boss activity');
            }
          };

          window.emitSystemCommand = function (commandData) {
            if (socketConnected) {
              socket.emit('system_command', {
                ...commandData,
                sessionId: window.currentSession?.sessionId,
                timestamp: new Date().toISOString(),
                issuer: localStorage.getItem('userId')
              });
              console.log('🎛️ System command sent to server');
            }
          };

          // ฟังก์ชันตรวจสอบสถานะการเชื่อมต่อ
          window.getSocketConnectionStatus = function () {
            return {
              connected: socketConnected,
              socketId: socket.id,
              reconnectAttempts: reconnectAttempts,
              transport: socket.io?.engine?.transport?.name,
              timestamp: new Date().toISOString()
            };
          };

          // ตรวจสอบสถานะการเชื่อมต่อเป็นระยะ
          setInterval(() => {
            const socketStatus = window.getSocketConnectionStatus();
            const firebaseOk = window.isFirebaseConnected || false;
            console.log('📊 Connection Status Check:', {
              socket: socketStatus,
              firebase: firebaseOk
            });
    
            // อัปเดตสถานะทั้งสองระบบ
            updateSocketStatus(socketStatus.connected);
            updateFirebaseStatus(firebaseOk);
          }, 60000); // ทุกนาที

          console.log('🔌 Enhanced Socket.IO client initialized');
          console.log('📡 Attempting to connect to server...');

          return socket;
        }

    // Fullscreen toggle functionality
    function setupFullscreenToggle() {
      const button = document.getElementById('btnToggleFullscreen');
      if (!button) return;
    
      button.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          // Enter fullscreen
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
            button.querySelector('i').classList.remove('bi-fullscreen');
            button.querySelector('i').classList.add('bi-fullscreen-exit');
          }
        } else {
          // Exit fullscreen
          if (document.exitFullscreen) {
            document.exitFullscreen();
            button.querySelector('i').classList.remove('bi-fullscreen-exit');
            button.querySelector('i').classList.add('bi-fullscreen');
          }
        }
      });
    
      // Update icon when fullscreen changes from other methods (like Esc key)
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          button.querySelector('i').classList.remove('bi-fullscreen-exit');
          button.querySelector('i').classList.add('bi-fullscreen');
        } else {
          button.querySelector('i').classList.remove('bi-fullscreen');
          button.querySelector('i').classList.add('bi-fullscreen-exit');
        }
      });
    }

    
    // Load dashboard data from APIs
    async function loadDashboardData() {
      try {
        console.log('🔄 Loading dashboard data from APIs...');
    
        // Load data in parallel
        const [stockData, salesData, customersData] = await Promise.allSettled([
          loadStockSummary(),
          loadSalesTodaySummary(),
          loadCustomersSummary()
        ]);
    
        // Update UI with loaded data
        if (stockData.status === 'fulfilled') {
          updateStockCards(stockData.value);
        } else {
          console.error('❌ Failed to load stock data:', stockData.reason);
          // Check if it's an authentication error
          if (stockData.reason?.message?.includes('401')) {
            showToast('เซสชันหมดอายุ กำลังเปลี่ยนเส้นทางไปหน้าเข้าสู่ระบบ', 'warning');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
          }
        }
    
        if (salesData.status === 'fulfilled') {
          updateSalesCards(salesData.value);
        } else {
          console.error('❌ Failed to load sales data:', salesData.reason);
          // Check if it's an authentication error
          if (salesData.reason?.message?.includes('401')) {
            showToast('เซสชันหมดอายุ กำลังเปลี่ยนเส้นทางไปหน้าเข้าสู่ระบบ', 'warning');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
          }
        }
    
        if (customersData.status === 'fulfilled') {
          updateCustomerCards(customersData.value);
        } else {
          console.error('❌ Failed to load customers data:', customersData.reason);
          // Check if it's an authentication error
          if (customersData.reason?.message?.includes('401')) {
            showToast('เซสชันหมดอายุ กำลังเปลี่ยนเส้นทางไปหน้าเข้าสู่ระบบ', 'warning');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
          }
        }
    
        // Combine all data and update the main dashboard stats
        if (stockData.status === 'fulfilled' && salesData.status === 'fulfilled' && customersData.status === 'fulfilled') {
          const combinedStats = {
            dailySales: salesData.value.totalSalesToday || 0,
            newCustomers: customersData.value.newCustomersThisMonth || 0,
            stockItems: stockData.value.totalProducts || 0,
            pendingOrders: 0 // This would need to be calculated from order data if available
          };
    
          console.log('📊 Updating main dashboard stats with combined data:', combinedStats);
          updateDashboardStats(combinedStats);
        }
    
        console.log('✅ Dashboard data loading completed');
      } catch (error) {
        console.error('❌ Error loading dashboard data:', error);
        showToast('ไม่สามารถโหลดข้อมูล Dashboard ได้ กรุณาลองใหม่อีกครั้ง', 'error');
      }
    }
    
    // Load stock summary from API
    async function loadStockSummary() {
      const token = localStorage.getItem('authToken');
    
      const response = await fetch('/api/branch-stock/overview', {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
    
      if (!response.ok) {
        if (response.status === 401) {
          // Token expired or invalid, redirect to login
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userInfo');
          window.location.href = '/login';
          return;
        }
        throw new Error(`Stock API error: ${response.status}`);
      }
    
      const result = await response.json();
      if (!result.success) throw new Error('Invalid stock API response');
    
      // Calculate summary statistics
      const totalStock = result.data.reduce((sum, item) => sum + (item.total_stock || 0), 0);
      const lowStockItems = result.data.filter(item => (item.total_stock || 0) < 10).length;
      const totalValue = result.data.reduce((sum, item) => sum + ((item.total_stock || 0) * (item.average_cost || 0)), 0);
    
      return {
        totalStock,
        lowStockItems,
        totalValue,
        totalProducts: result.data.length
      };
    }
    
    // Load sales today summary from API
    async function loadSalesTodaySummary() {
      const token = localStorage.getItem('authToken');
    
      const response = await fetch('/api/sales-dashboard/today-summary', {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
    
      if (!response.ok) {
        if (response.status === 401) {
          // Token expired or invalid, redirect to login
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userInfo');
          window.location.href = '/login';
          return;
        }
        throw new Error(`Sales API error: ${response.status}`);
      }
    
      const result = await response.json();
      if (!result.success) throw new Error('Invalid sales API response');
    
      return result.data;
    }
    
    // Load customers summary from API
    async function loadCustomersSummary() {
      const token = localStorage.getItem('authToken');
    
      const response = await fetch('/api/customers/', {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
    
      if (!response.ok) {
        if (response.status === 401) {
          // Token expired or invalid, redirect to login
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userInfo');
          window.location.href = '/login';
          return;
        }
        throw new Error(`Customers API error: ${response.status}`);
      }
    
      const result = await response.json();
      if (!result.success) throw new Error('Invalid customers API response');
    
      // Calculate summary statistics
      const totalCustomers = result.data.length;
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
    
      const newCustomersThisMonth = result.data.filter(customer => {
        const customerDate = new Date(customer.createdAt);
        return customerDate.getMonth() === currentMonth &&
               customerDate.getFullYear() === currentYear;
      }).length;
    
      return {
        totalCustomers,
        newCustomersThisMonth,
        activeCustomers: result.data.filter(c => c.status === 'active').length || totalCustomers
      };
    }
    
    // Update stock cards with real data
    function updateStockCards(stockData) {
      // Update total stock if element exists
      const totalStockEl = document.querySelector('[data-stat="total-stock"]');
      if (totalStockEl) {
        totalStockEl.textContent = stockData.totalStock.toLocaleString();
      }
    
      // Update low stock alert if element exists
      const lowStockEl = document.querySelector('[data-stat="low-stock"]');
      if (lowStockEl) {
        lowStockEl.textContent = stockData.lowStockItems.toLocaleString();
      }
    
      // Update total value if element exists
      const totalValueEl = document.querySelector('[data-stat="stock-value"]');
      if (totalValueEl) {
        totalValueEl.textContent = `฿${stockData.totalValue.toLocaleString()}`;
      }
    
      console.log('📊 Stock cards updated:', stockData);
    }
    
    // Update sales cards with real data
    function updateSalesCards(salesData) {
      // Update today's sales if element exists
      const todaySalesEl = document.querySelector('[data-stat="today-sales"]');
      if (todaySalesEl) {
        todaySalesEl.textContent = `฿${(salesData.totalAmount || 0).toLocaleString()}`;
      }
    
      // Update sales count if element exists
      const salesCountEl = document.querySelector('[data-stat="sales-count"]');
      if (salesCountEl) {
        salesCountEl.textContent = (salesData.totalOrders || 0).toLocaleString();
      }
    
      console.log('💰 Sales cards updated:', salesData);
    }
    
    // Update customer cards with real data
    function updateCustomerCards(customersData) {
      // Update total customers if element exists
      const totalCustomersEl = document.querySelector('[data-stat="total-customers"]');
      if (totalCustomersEl) {
        totalCustomersEl.textContent = customersData.totalCustomers.toLocaleString();
      }
    
      // Update new customers this month if element exists
      const newCustomersEl = document.querySelector('[data-stat="new-customers"]');
      if (newCustomersEl) {
        newCustomersEl.textContent = customersData.newCustomersThisMonth.toLocaleString();
      }
    
      console.log('👥 Customer cards updated:', customersData);
    }
    
    // Initialize all on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
          showLoading(true);
    
          try {
            setupDarkMode();
            setupProfileDropdown();
            setupNotificationDropdown();
            setupSearch();
            setupSocketIO();
            setupFullscreenToggle();
            await loadUserData();
            await loadDashboardData(); // Load dashboard data from APIs
            setupActivityMonitor();
            updateCartBadge(3);
    
            if (typeof showToast === 'function') {
              showToast('🏠 ระบบหลักโหลดเสร็จสิ้น', 'success');
            }
          } catch (error) {
            console.error('Page loading error:', error);
            if (typeof showToast === 'function') {
              showToast('เกิดข้อผิดพลาดในการโหลด: ' + error.message, 'error');
            }
          } finally {
            setTimeout(() => { showLoading(false); }, 600);
          }
        });

        // Auto cleanup เมื่อออกจากหน้า
        window.addEventListener('beforeunload', () => {
          if (lottieAnimation) {
            lottieAnimation.destroy();
            lottieAnimation = null;
          }
        });

      </script>
    </body>
    </html>