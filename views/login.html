<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Prevent console messages from appearing on webpage -->
  <script>
    // Ensure console messages only appear in browser console, not on webpage
    (function () {
      // Store original console methods
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info,
        debug: console.debug
      };

      // Override console to prevent webpage display but allow browser console
      window.console = {
        log: function (...args) {
          try {
            if (typeof originalConsole.log === 'function') {
              originalConsole.log.apply(console, args);
            }
          } catch (e) {
            // Silent fail to prevent webpage errors
          }
        },
        error: function (...args) {
          try {
            if (typeof originalConsole.error === 'function') {
              originalConsole.error.apply(console, args);
            }
          } catch (e) {
            // Silent fail to prevent webpage errors
          }
        },
        warn: function (...args) {
          try {
            if (typeof originalConsole.warn === 'function') {
              originalConsole.warn.apply(console, args);
            }
          } catch (e) {
            // Silent fail to prevent webpage errors
          }
        },
        info: function (...args) {
          try {
            if (typeof originalConsole.info === 'function') {
              originalConsole.info.apply(console, args);
            }
          } catch (e) {
            // Silent fail to prevent webpage errors
          }
        },
        debug: function (...args) {
          try {
            if (typeof originalConsole.debug === 'function') {
              originalConsole.debug.apply(console, args);
            }
          } catch (e) {
            // Silent fail to prevent webpage errors
          }
        }
      };

      // Prevent any error messages from showing on page
      window.addEventListener('error', function (e) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      });

      // Prevent unhandled promise rejections from showing on page
      window.addEventListener('unhandledrejection', function (e) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      });

      // Additional protection against console display
      window.onerror = function (msg, url, lineNo, columnNo, error) {
        return true; // Prevent default error handling
      };

      // Hide any potential console output on page load and continuously monitor
      function cleanupConsoleOutput() {
        try {
          // Remove any unwanted text from the page
          const allElements = document.querySelectorAll('*');

          allElements.forEach(element => {
            if (element.tagName && (
              element.tagName.toLowerCase() === 'script' ||
              element.tagName.toLowerCase() === 'style' ||
              element.tagName.toLowerCase() === 'meta' ||
              element.tagName.toLowerCase() === 'title' ||
              element.tagName.toLowerCase() === 'head'
            )) {
              return; // Skip these elements
            }

            const text = element.textContent;
            if (text && element.children.length === 0) {
              // Check if this text node contains debug information
              if (
                text.includes('console.') ||
                text.includes('Socket.IO') ||
                text.includes('Firebase') ||
                text.includes('LoadingSystem') ||
                text.includes('updateConnectionStatusUI') ||
                text.includes('trackActivity') ||
                text.includes('function(') ||
                text.includes('window.socket') ||
                text.includes('error:') ||
                text.includes('failed:') ||
                text.includes('‚úÖ') ||
                text.includes('‚ùå') ||
                text.includes('‚ö†Ô∏è') ||
                text.includes('üî•') ||
                text.includes('üö´') ||
                text.includes('üîß') ||
                text.includes('üì°') ||
                (text.length > 200 && text.includes('(')) // Long text that looks like code
              ) {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
                element.style.opacity = '0';
                element.style.position = 'absolute';
                element.style.left = '-9999px';
              }
            }
          });
        } catch (e) {
          // Silent fail
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        cleanupConsoleOutput();

        // Run cleanup every 500ms for the first 10 seconds
        let cleanupCount = 0;
        const cleanupInterval = setInterval(() => {
          cleanupConsoleOutput();
          cleanupCount++;
          if (cleanupCount >= 20) {
            clearInterval(cleanupInterval);
          }
        }, 500);
      });
    })();
  </script>

  <!-- Hide any console output that might appear on page -->
  <style>
    /* Hide any debug console output that might appear on page */
    #console,
    .console,
    [id*="console"],
    [class*="console"],
    .debug-console,
    .error-display,
    .console-output,
    pre.console,
    div.console,
    span.console,
    .javascript-console,
    .browser-console {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Hide error overlays */
    .error-overlay,
    .console-overlay,
    .debug-overlay {
      display: none !important;
    }

    /* Ensure body doesn't show console text */
    body::before,
    body::after {
      content: none !important;
    }

    /* Hide any text containing console/debug keywords */
    *:not(input):not(textarea) {
      /* Note: This is handled by JavaScript instead for better control */
    }

    /* Force hide top area if it contains unwanted text */
    body>*:first-child {
      background: transparent !important;
    }

    /* Hide any absolutely positioned debug text */
    body>div:first-child:not([class]):not([id]) {
      display: none !important;
    }

    /* Additional protection against debug text display in top area */
    body>*:first-child:not(.min-h-screen):not([class*="animated"]):not([class*="login"]) {
      display: none !important;
    }

    /* Hide any unidentified text at top of page */
    body::before {
      display: none !important;
    }
  </style>

  <!-- Prevent caching issues -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Firebase SDK v9 (Modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      off,
      onDisconnect,
      remove,
      serverTimestamp,
      connectDatabaseEmulator
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    // Firebase Configuration - Using same project as other files
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    // Initialize Firebase
    let app, database;

    try {
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);
      console.log('üî• Firebase initialized successfully');

      // Make Firebase available globally
      window.firebaseApp = app;
      window.firebaseDb = database;
      window.firebaseRefs = { ref, push, set, onValue, off, onDisconnect, remove, serverTimestamp };

    } catch (error) {
      console.error('‚ùå Firebase initialization failed:', error);

      // Create fallback objects
      window.firebaseApp = null;
      window.firebaseDb = null;
      window.firebaseRefs = {
        ref: () => null,
        push: () => Promise.resolve(),
        set: () => Promise.resolve(),
        onValue: () => { },
        off: () => { },
        onDisconnect: () => ({ remove: () => Promise.resolve() }),
        remove: () => Promise.resolve(),
        serverTimestamp: () => Date.now()
      };
    }

    // Initialize Firebase integration after DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
      if (window.firebaseDb) {
        initializeFirebaseIntegration();
      }
    });

    // Firebase Integration for Login System
    function initializeFirebaseIntegration() {
      try {
        console.log('üî• Initializing Firebase for Login System...');

        // Create current session for login system
        window.currentSession = {
          sessionId: `LOGIN-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          userId: 'anonymous',
          userRole: 'login',
          startTime: Date.now(),
          page: 'login',
          ip: window.location.hostname,
          userAgent: navigator.userAgent.substring(0, 100)
        };

        // Firebase References
        window.firebaseRefs.loginActivitiesRef = window.firebaseRefs.ref(window.firebaseDb, 'activities/login');
        window.firebaseRefs.sessionRef = window.firebaseRefs.ref(window.firebaseDb, `sessions/login/${window.currentSession.sessionId}`);
        window.firebaseRefs.notificationsRef = window.firebaseRefs.ref(window.firebaseDb, 'notifications/login');
        window.firebaseRefs.onlineUsersRef = window.firebaseRefs.ref(window.firebaseDb, 'onlineUsers/login');
        window.firebaseRefs.systemStatsRef = window.firebaseRefs.ref(window.firebaseDb, 'systemStats/login');
        window.firebaseRefs.loginAttemptsRef = window.firebaseRefs.ref(window.firebaseDb, 'loginAttempts');
        window.firebaseRefs.securityEventsRef = window.firebaseRefs.ref(window.firebaseDb, 'securityEvents');

        // Register session and setup listeners
        registerSession();
        setupFirebaseListeners();
        setupOnDisconnect();

        console.log('‚úÖ Firebase integration initialized successfully');
        updateConnectionStatusUI('firebase', true);

      } catch (error) {
        console.error('‚ùå Firebase integration failed:', error);
        updateConnectionStatusUI('firebase', false);
      }
    }

    // Register Session
    function registerSession() {
      if (!window.firebaseDb || !window.firebaseRefs.sessionRef) return;

      try {
        window.firebaseRefs.set(window.firebaseRefs.sessionRef, {
          ...window.currentSession,
          lastActivity: window.firebaseRefs.serverTimestamp(),
          status: 'active'
        });

        // Add to online users
        const userRef = window.firebaseRefs.ref(window.firebaseDb, `onlineUsers/login/${window.currentSession.sessionId}`);
        window.firebaseRefs.set(userRef, {
          sessionId: window.currentSession.sessionId,
          userRole: 'login',
          page: 'login',
          joinedAt: window.firebaseRefs.serverTimestamp(),
          lastSeen: window.firebaseRefs.serverTimestamp()
        });

        // Track login page visit
        trackActivity('page_visit', {
          page: 'login',
          timestamp: Date.now(),
          userAgent: navigator.userAgent.substring(0, 100)
        });

      } catch (error) {
        console.error('Session registration failed:', error);
      }
    }

    // Setup Firebase Listeners
    function setupFirebaseListeners() {
      if (!window.firebaseDb) return;

      try {
        // Listen for login notifications
        window.firebaseRefs.onValue(window.firebaseRefs.notificationsRef, (snapshot) => {
          if (snapshot.exists()) {
            const notifications = snapshot.val();
            Object.values(notifications).forEach(notification => {
              if (notification.targetPage === 'login' || notification.targetPage === 'all') {
                showToast(notification.message, notification.type || 'info');
              }
            });
          }
        });

        // Listen for system stats updates
        window.firebaseRefs.onValue(window.firebaseRefs.systemStatsRef, (snapshot) => {
          if (snapshot.exists()) {
            const stats = snapshot.val();
            updateLoginStats(stats);
          }
        });

        // Listen for NEW security events only (not old ones)
        const now = Date.now();
        const recentEventsQuery = window.firebaseRefs.query(
          window.firebaseRefs.securityEventsRef,
          window.firebaseRefs.orderByChild('timestamp'),
          window.firebaseRefs.startAt(now)
        );

        window.firebaseRefs.onChildAdded(recentEventsQuery, (snapshot) => {
          if (snapshot.exists()) {
            const event = snapshot.val();
            // Only log NEW events that happen after this page loads
            if (event.type === 'rate_limit' && event.severity === 'high') {
              console.warn('üö® Security Alert:', event.message);
            }
          }
        });

      } catch (error) {
        console.error('Firebase listeners setup failed:', error);
      }
    }

    // Setup On Disconnect
    function setupOnDisconnect() {
      if (!window.firebaseDb || !window.firebaseRefs.sessionRef) return;

      try {
        window.firebaseRefs.onDisconnect(window.firebaseRefs.sessionRef).remove();

        const userRef = window.firebaseRefs.ref(window.firebaseDb, `onlineUsers/login/${window.currentSession.sessionId}`);
        window.firebaseRefs.onDisconnect(userRef).remove();

      } catch (error) {
        console.error('OnDisconnect setup failed:', error);
      }
    }

    // Track Activity
    window.trackActivity = function (action, details = {}) {
      if (!window.firebaseDb || !window.firebaseRefs.loginActivitiesRef) return;

      try {
        const activity = {
          sessionId: window.currentSession?.sessionId || 'unknown',
          action: action,
          details: details,
          timestamp: window.firebaseRefs.serverTimestamp(),
          page: 'login',
          userRole: 'login'
        };

        window.firebaseRefs.push(window.firebaseRefs.loginActivitiesRef, activity);

        // Also emit to Socket.IO
        safeSocketEmit('activity', activity);

      } catch (error) {
        console.error('Activity tracking failed:', error);
      }
    };

    // Update Login Stats
    function updateLoginStats(stats) {
      // You can add login statistics display here if needed
      console.log('üìä Login Stats Updated:', stats);
    }

    // Connection Status Management
    window.connectionStatus = {
      firebase: false,
      socket: false
    };

    window.updateConnectionStatusUI = function (service, status) {
      window.connectionStatus[service] = status;

      // Update UI indicators
      try {
        const indicator = document.querySelector(`[data-service="${service}"]`);
        if (indicator) {
          indicator.className = status
            ? 'inline-block w-2 h-2 rounded-full bg-green-500'
            : 'inline-block w-2 h-2 rounded-full bg-red-500';
        }

        // Update overall status
        const firebaseConnected = document.querySelector('[data-service="firebase"]')?.classList.contains('bg-green-500');
        const socketConnected = document.querySelector('[data-service="socket"]')?.classList.contains('bg-green-500');

        const overallIndicator = document.querySelector('[data-service="overall"]');
        if (overallIndicator) {
          if (firebaseConnected && socketConnected) {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-green-500';
          } else if (firebaseConnected || socketConnected) {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-yellow-500';
          } else {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-red-500';
          }
        }

        console.log(`üì° ${service} connection status:`, status ? 'Connected' : 'Disconnected');
      } catch (error) {
        console.warn('Connection status update failed:', error);
      }
    };

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
      if (window.firebaseDb && window.currentSession) {
        try {
          // Track page leave
          trackActivity('page_leave', {
            duration: Date.now() - window.currentSession.startTime,
            timestamp: Date.now()
          });

          // Remove session
          if (window.firebaseRefs.sessionRef) {
            window.firebaseRefs.remove(window.firebaseRefs.sessionRef);
          }

          const userRef = window.firebaseRefs.ref(window.firebaseDb, `onlineUsers/login/${window.currentSession.sessionId}`);
          window.firebaseRefs.remove(userRef);

        } catch (error) {
          console.error('Cleanup failed:', error);
        }
      }
    });

    // Make functions available globally
    window.initializeFirebaseIntegration = initializeFirebaseIntegration;

  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Wait for Tailwind to be ready
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const pageLoaderId = LoadingSystem.show({
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...',
          showProgress: true,
          autoProgress: true
        });

        // Hide loading after page is fully loaded
        setTimeout(() => {
          if (pageLoaderId) {
            LoadingSystem.completeProgress(pageLoaderId);
          }
        }, 1000);
      } catch (error) {
        console.log('LoadingSystem v2.0.0 not available yet');
      }

      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Prompt', 'Poppins', 'sans-serif']
              },
              colors: {
                'brand': {
                  50: '#e6f0fa',
                  100: '#cce1f5',
                  200: '#99c3eb',
                  300: '#66a5e1',
                  400: '#3387d6',
                  500: '#0076d6',
                  600: '#0066b9',
                  700: '#00509c',
                  800: '#003b7f',
                  900: '#002762'
                },

              },
              keyframes: {
                fadeIn: {
                  '0%': { opacity: '0', transform: 'translateY(10px)' },
                  '100%': { opacity: '1', transform: 'translateY(0)' }
                }
              },
              animation: {
                'fade-in': 'fadeIn 0.5s ease-out forwards'
              }
            }
          }
        };
      }
    });
  </script>

  <!-- Google Fonts: Prompt (Thai) + Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- QR Code Generator Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Socket.io -->
  <script src="/socket.io.min.js" onload="console.log('‚úÖ Socket.IO script loaded successfully')"
    onerror="console.error('‚ùå Failed to load Socket.IO script from /socket.io.min.js')">
    </script>

  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner {
      border-top-color: #10b981;
    }

    .loading-success .loading-progress-fill {
      background: #10b981;
    }

    .loading-warning .loading-spinner {
      border-top-color: #f59e0b;
    }

    .loading-warning .loading-progress-fill {
      background: #f59e0b;
    }

    .loading-error .loading-spinner {
      border-top-color: #ef4444;
    }

    .loading-error .loading-progress-fill {
      background: #ef4444;
    }

    @keyframes loading-spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function (window) {
      'use strict';

      console.log('üöÄ LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';

        const content = document.createElement('div');
        content.className = 'loading-content';

        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';

        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';

          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }

        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);

        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function (options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();

            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);

            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }

            container.appendChild(overlay);

            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };

            activeLoaders.set(loaderId, loaderData);

            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }

            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }

            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });

            console.log(`‚úÖ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;

          } catch (error) {
            console.error('‚ùå LoadingSystem.show() error:', error);
            return null;
          }
        },

        hide: function (loaderId) {
          try {
            if (!loaderId) return;

            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;

            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }

            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }

            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }

            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');

            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);

            console.log(`‚úÖ LoadingSystem.hide() - ID: ${loaderId}`);

          } catch (error) {
            console.error('‚ùå LoadingSystem.hide() error:', error);
          }
        },

        hideAll: function () {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`‚úÖ LoadingSystem.hideAll() - ‡∏ã‡πà‡∏≠‡∏ô ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('‚ùå LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function (loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function (loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
          } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function (loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
              }
            }
          } catch (error) {
            console.error('‚ùå LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function (loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function () {
          return activeLoaders.size;
        },

        cleanup: function () {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('üßπ LoadingSystem.cleanup() - ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
        },

        debug: function () {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('‚úÖ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Gradient Animation ‡πÅ‡∏•‡∏∞ Floating Elements -->
  <style>
    @keyframes gradientAnimation {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .animated-gradient {
      background: linear-gradient(270deg, #014796, #01268d, #006fc2, #0087d6);
      background-size: 800% 800%;
      animation: gradientAnimation 15s ease infinite;
      font-family: 'Prompt', 'Poppins', sans-serif;
      overflow: hidden;
      position: relative;
    }

    @keyframes scatterTopLeft {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(-10vw, -10vh) rotate(-20deg) scale(0.8);
        opacity: 0.6;
      }

      20% {
        transform: translate(-20vw, -20vh) rotate(-40deg) scale(1.2);
        opacity: 0.8;
      }

      40% {
        transform: translate(-40vw, -40vh) rotate(-80deg) scale(1.6);
        opacity: 0.7;
      }

      70% {
        transform: translate(-70vw, -70vh) rotate(-120deg) scale(2.0);
        opacity: 0.4;
      }

      100% {
        transform: translate(-100vw, -100vh) rotate(-180deg) scale(2.2);
        opacity: 0;
      }
    }

    @keyframes scatterTopRight {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(10vw, -10vh) rotate(20deg) scale(0.8);
        opacity: 0.6;
      }

      20% {
        transform: translate(20vw, -20vh) rotate(40deg) scale(1.2);
        opacity: 0.8;
      }

      40% {
        transform: translate(40vw, -40vh) rotate(80deg) scale(1.6);
        opacity: 0.7;
      }

      70% {
        transform: translate(70vw, -70vh) rotate(120deg) scale(2.0);
        opacity: 0.4;
      }

      100% {
        transform: translate(100vw, -100vh) rotate(180deg) scale(2.2);
        opacity: 0;
      }
    }

    @keyframes scatterBottomLeft {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(-10vw, 10vh) rotate(20deg) scale(0.8);
        opacity: 0.6;
      }

      20% {
        transform: translate(-20vw, 20vh) rotate(40deg) scale(1.2);
        opacity: 0.8;
      }

      40% {
        transform: translate(-40vw, 40vh) rotate(80deg) scale(1.6);
        opacity: 0.7;
      }

      70% {
        transform: translate(-70vw, 70vh) rotate(120deg) scale(2.0);
        opacity: 0.4;
      }

      100% {
        transform: translate(-100vw, 100vh) rotate(180deg) scale(2.2);
        opacity: 0;
      }
    }

    @keyframes scatterBottomRight {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(10vw, 10vh) rotate(-20deg) scale(0.8);
        opacity: 0.6;
      }

      20% {
        transform: translate(20vw, 20vh) rotate(-40deg) scale(1.2);
        opacity: 0.8;
      }

      40% {
        transform: translate(40vw, 40vh) rotate(-80deg) scale(1.6);
        opacity: 0.7;
      }

      70% {
        transform: translate(70vw, 70vh) rotate(-120deg) scale(2.0);
        opacity: 0.4;
      }

      100% {
        transform: translate(100vw, 100vh) rotate(-180deg) scale(2.2);
        opacity: 0;
      }
    }

    @keyframes scatterLeft {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(-20vw, 0) rotate(-15deg) scale(1.0);
        opacity: 0.7;
      }

      30% {
        transform: translate(-40vw, 10vh) rotate(-30deg) scale(1.5);
        opacity: 0.8;
      }

      60% {
        transform: translate(-70vw, 15vh) rotate(-45deg) scale(1.8);
        opacity: 0.5;
      }

      100% {
        transform: translate(-100vw, 20vh) rotate(-60deg) scale(2.0);
        opacity: 0;
      }
    }

    @keyframes scatterRight {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(20vw, 0) rotate(15deg) scale(1.0);
        opacity: 0.7;
      }

      30% {
        transform: translate(40vw, -10vh) rotate(30deg) scale(1.5);
        opacity: 0.8;
      }

      60% {
        transform: translate(70vw, -15vh) rotate(45deg) scale(1.8);
        opacity: 0.5;
      }

      100% {
        transform: translate(100vw, -20vh) rotate(60deg) scale(2.0);
        opacity: 0;
      }
    }

    @keyframes scatterTop {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(0, -20vh) rotate(10deg) scale(1.0);
        opacity: 0.7;
      }

      30% {
        transform: translate(5vw, -50vh) rotate(20deg) scale(1.6);
        opacity: 0.8;
      }

      60% {
        transform: translate(8vw, -75vh) rotate(30deg) scale(1.8);
        opacity: 0.5;
      }

      100% {
        transform: translate(10vw, -100vh) rotate(40deg) scale(2.0);
        opacity: 0;
      }
    }

    @keyframes scatterBottom {
      0% {
        transform: translate(0, 0) rotate(0) scale(0);
        opacity: 0;
      }

      10% {
        transform: translate(0, 20vh) rotate(-10deg) scale(1.0);
        opacity: 0.7;
      }

      30% {
        transform: translate(-5vw, 50vh) rotate(-20deg) scale(1.6);
        opacity: 0.8;
      }

      60% {
        transform: translate(-8vw, 75vh) rotate(-30deg) scale(1.8);
        opacity: 0.5;
      }

      100% {
        transform: translate(-10vw, 100vh) rotate(-40deg) scale(2.0);
        opacity: 0;
      }
    }

    /* Bird flight animations */
    @keyframes birdFlight1 {
      0% {
        transform: translate(0, 0) rotate(0) scale(1);
        opacity: 0;
      }

      5% {
        transform: translate(10vw, -5vh) rotate(5deg) scale(0.9);
        opacity: 0.8;
      }

      100% {
        transform: translate(100vw, -15vh) rotate(5deg) scale(1.1);
        opacity: 0;
      }
    }

    @keyframes birdFlight2 {
      0% {
        transform: translate(0, 0) rotate(0) scale(1);
        opacity: 0;
      }

      5% {
        transform: translate(-10vw, 5vh) rotate(-5deg) scale(0.9);
        opacity: 0.8;
      }

      100% {
        transform: translate(-100vw, 10vh) rotate(-5deg) scale(1.1);
        opacity: 0;
      }
    }

    @keyframes birdFlight3 {
      0% {
        transform: translate(0, 0) rotate(0) scale(1);
        opacity: 0;
      }

      5% {
        transform: translate(5vw, -10vh) rotate(10deg) scale(0.9);
        opacity: 0.8;
      }

      100% {
        transform: translate(10vw, -100vh) rotate(0deg) scale(1.1);
        opacity: 0;
      }
    }

    @keyframes birdFlight4 {
      0% {
        transform: translate(0, 0) rotate(0) scale(1);
        opacity: 0;
      }

      5% {
        transform: translate(-5vw, 10vh) rotate(-10deg) scale(0.9);
        opacity: 0.8;
      }

      100% {
        transform: translate(-10vw, 100vh) rotate(0deg) scale(1.1);
        opacity: 0;
      }
    }

    /* Flapping animation */
    @keyframes wingFlap {
      0% {
        transform: scaleY(1) rotate(0deg);
      }

      25% {
        transform: scaleY(0.8) rotate(5deg);
      }

      50% {
        transform: scaleY(0.7) rotate(0deg);
      }

      75% {
        transform: scaleY(0.8) rotate(-5deg);
      }

      100% {
        transform: scaleY(1) rotate(0deg);
      }
    }

    .logo-center {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .logo-particle {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      will-change: transform, opacity;
      pointer-events: none;
    }

    /* Floating animations */
    @keyframes float-slow {

      0%,
      100% {
        transform: translateY(0) rotate(0);
      }

      25% {
        transform: translateY(-15px) rotate(5deg);
      }

      50% {
        transform: translateY(0) rotate(0);
      }

      75% {
        transform: translateY(15px) rotate(-5deg);
      }
    }

    @keyframes float-medium {

      0%,
      100% {
        transform: translate(0, 0) rotate(0);
      }

      25% {
        transform: translate(15px, -10px) rotate(3deg);
      }

      50% {
        transform: translate(0, -20px) rotate(0);
      }

      75% {
        transform: translate(-15px, -10px) rotate(-3deg);
      }
    }

    @keyframes float-fast {

      0%,
      100% {
        transform: translate(0, 0) rotate(0);
      }

      20% {
        transform: translate(-20px, 10px) rotate(-5deg);
      }

      40% {
        transform: translate(10px, 20px) rotate(3deg);
      }

      60% {
        transform: translate(20px, -10px) rotate(5deg);
      }

      80% {
        transform: translate(-10px, -20px) rotate(-3deg);
      }
    }

    @keyframes pulse-glow {

      0%,
      100% {
        opacity: 0.3;
        filter: blur(3px);
      }

      50% {
        opacity: 0.7;
        filter: blur(5px);
      }
    }

    .floating {
      position: absolute;
      z-index: 1;
      pointer-events: none;
    }

    .float-slow {
      animation: float-slow 20s ease-in-out infinite;
    }

    .float-medium {
      animation: float-medium 15s ease-in-out infinite;
    }

    .float-fast {
      animation: float-fast 10s ease-in-out infinite;
    }

    .glow {
      animation: pulse-glow 8s ease-in-out infinite;
    }

    /* Input focus styling */
    .input-focus-effect {
      position: relative;
      overflow: hidden;
    }

    .input-focus-effect::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #ffd700;
      transition: width 0.3s ease;
    }

    .input-focus-effect:focus-within::after {
      width: 100%;
    }

    /* Loading button animation */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Card entry animation */
    @keyframes cardEntrance {
      0% {
        opacity: 0;
        transform: translateY(25px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-entrance {
      animation: cardEntrance 0.8s ease-out forwards;
    }

    /* Pulsating effect for creating logo particles */
    @keyframes pulsate {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.8;
      }

      50% {
        transform: scale(1.05);
        opacity: 1;
      }
    }

    .pulsate {
      animation: pulsate 2s ease-in-out infinite;
    }

    /* QR Code scanning animation */
    @keyframes qrScan {
      0% {
        top: 0;
      }

      50% {
        top: calc(100% - 3px);
      }

      100% {
        top: 0;
      }
    }

    .qr-scan-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #0076d6, transparent);
      animation: qrScan 2s ease-in-out infinite;
    }

    /* Tab switching animation */
    .tab-content {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .tab-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
  </style>

  <script>
    // Override fetch to prevent external requests
    const originalFetch = window.fetch;
    window.fetch = function (url, options) {
      if (typeof url === 'string' && url.includes('2pheenong.com')) {
        console.warn('üö´ Blocked external fetch request:', url);
        // Redirect to local path
        if (url.includes('socket.io.min.js')) {
          url = '/socket.io.min.js';
        } else if (url.includes('socket.io')) {
          // Redirect Socket.IO requests to localhost
          url = url.replace('https://www.2pheenong.com', 'http://localhost:3000');
        } else {
          return Promise.reject(new Error('External request blocked'));
        }
      }
      return originalFetch.call(this, url, options);
    };

    // Override XMLHttpRequest
    const originalXHROpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function (method, url, ...args) {
      if (typeof url === 'string' && url.includes('2pheenong.com')) {
        console.warn('üö´ Blocked external XHR request:', url);
        // Special handling for Socket.IO polling requests
        if (url.includes('socket.io/?EIO=')) {
          console.log('üîß Redirecting Socket.IO polling to localhost:3000');
          url = url.replace('https://www.2pheenong.com', 'http://localhost:3000');
        } else if (url.includes('socket.io.min.js')) {
          url = '/socket.io.min.js';
        } else {
          throw new Error('External XHR request blocked');
        }
      }
      return originalXHROpen.call(this, method, url, ...args);
    };

    // Override dynamic script creation
    const originalCreateElement = document.createElement;
    document.createElement = function (tagName) {
      const element = originalCreateElement.call(this, tagName);
      if (tagName.toLowerCase() === 'script') {
        const originalSetAttribute = element.setAttribute;
        element.setAttribute = function (name, value) {
          if (name === 'src' && typeof value === 'string' && value.includes('2pheenong.com')) {
            console.warn('Blocked external script creation:', value);
            if (value.includes('socket.io.min.js')) {
              value = '/socket.io.min.js';
            } else {
              return; // Don't set the src
            }
          }
          return originalSetAttribute.call(this, name, value);
        };
      }
      return element;
    };

    // Clear any problematic cache or service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function (registrations) {
        for (let registration of registrations) {
          registration.unregister();
          console.log('Unregistered service worker:', registration.scope);
        }
      });
    }

    // Clear all caches
    if ('caches' in window) {
      caches.keys().then(function (cacheNames) {
        return Promise.all(
          cacheNames.map(function (cacheName) {
            console.log('Deleting cache:', cacheName);
            return caches.delete(cacheName);
          })
        );
      });
    }

    // Override global io function to force localhost connections ALWAYS
    if (window.io) {
      const originalIO = window.io;
      window.io = function (url, options) {
        // **ALWAYS force localhost:3000 connection**
        console.log('üîß Intercepted Socket.IO call, forcing localhost:3000');
        url = 'http://localhost:3000';

        // Ensure options prevent external connections
        options = options || {};
        options.forceNew = true;
        options.upgrade = false;
        options.rememberUpgrade = false;
        options.hostname = 'localhost';
        options.port = 3000;
        options.secure = false;

        return originalIO.call(this, url, options);
      };
    }

    // Check LoadingSystem after page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Wait for Socket.IO to be loaded before initializing
      waitForSocketIO();

      setTimeout(function () {
        console.log('LoadingSystem v2.0.0 loaded successfully');

        // Debug and fix network requests
        console.log('Checking for external scripts...');
        const scripts = document.querySelectorAll('script[src]');

        scripts.forEach(script => {
          if (script.src.includes('2pheenong.com')) {
            console.info('‚ìò Found cached external script reference, correcting path for:', script.src);

            // Fix the URL to use the correct local path
            if (script.src.includes('socket.io.min.js')) {
              script.src = '/socket.io.min.js';
            }
          }
        });

        // THE RELOAD LOOP HAS BEEN REMOVED.
        // The fetch and XHR overrides below will act as a secondary safety net.

        // Monitor Socket.IO connections
        if (socket && socket.io) {
          socket.io.on('error', (error) => {
            console.warn('Socket.IO connection error:', error);
            if (error.message && error.message.includes('2pheenong.com')) {
              console.log('Reinitializing Socket.IO with local server...');
              socket.disconnect();
              socket = io(window.location.origin, { forceNew: true });
            }
          });
        }

        // Set up MutationObserver to watch for new scripts
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            mutation.addedNodes.forEach(function (node) {
              if (node.tagName === 'SCRIPT' && node.src && node.src.includes('2pheenong.com')) {
                console.warn('Blocked dynamically added external script:', node.src);
                node.remove();
              }
            });
          });
        });

        observer.observe(document.head, { childList: true, subtree: true });
        observer.observe(document.body, { childList: true, subtree: true });

      }, 100);
    });

    // Wait for Socket.IO to be loaded
    let socketIOInitialized = false;
    let socketIOInitializing = false;

    function waitForSocketIO() {
      let attempts = 0;
      const maxAttempts = 10;

      function checkSocketIO() {
        attempts++;

        if (typeof io !== 'undefined' && typeof io === 'function') {
          console.log('‚úÖ Socket.IO library loaded successfully');

          // Test basic Socket.IO server connectivity
          try {
            const testSocket = io('http://localhost:3000', {
              timeout: 5000,
              autoConnect: false
            });

            let testCompleted = false;
            let testTimeout;

            testSocket.on('connect', () => {
              if (!testCompleted && !socketIOInitializing) {
                testCompleted = true;
                clearTimeout(testTimeout);
                console.log('‚úÖ Socket.IO server connection test passed');
                testSocket.disconnect();
                initializeSocketIO();
              }
            });

            testSocket.on('connect_error', (error) => {
              if (!testCompleted && !socketIOInitializing) {
                testCompleted = true;
                clearTimeout(testTimeout);
                console.warn('‚ö†Ô∏è Socket.IO server connection test failed:', error.message);
                console.log('üîÑ Proceeding with initialization anyway...');
                testSocket.disconnect();
                initializeSocketIO();
              }
            });

            testSocket.connect();

            // Fallback timeout
            testTimeout = setTimeout(() => {
              if (!testCompleted && !testSocket.connected && !socketIOInitializing) {
                testCompleted = true;
                console.log('‚è∞ Socket.IO server test timeout - proceeding with initialization');
                testSocket.disconnect();
                initializeSocketIO();
              }
            }, 3000);

          } catch (error) {
            if (!socketIOInitializing) {
              console.warn('Socket.IO test failed:', error);
              initializeSocketIO();
            }
          }
        } else {
          console.log(`‚è≥ Waiting for Socket.IO to load... (${attempts}/${maxAttempts})`);

          if (attempts >= maxAttempts) {
            console.error('‚ùå Socket.IO failed to load after', maxAttempts, 'attempts');

            // Try to check if the script file exists
            fetch('/socket.io.min.js')
              .then(response => {
                if (response.ok) {
                  console.log('üìÅ Socket.IO file exists but failed to load - trying to reload');
                  // Try to reload the script
                  const script = document.createElement('script');
                  script.src = '/socket.io.min.js';
                  script.onload = () => {
                    console.log('üîÑ Socket.IO script reloaded');
                    setTimeout(checkSocketIO, 500);
                  };
                  script.onerror = () => {
                    console.error('‚ùå Socket.IO script reload failed');
                    createFallbackSocket();
                  };
                  document.head.appendChild(script);
                } else {
                  console.error('‚ùå Socket.IO file not found on server');
                  createFallbackSocket();
                }
              })
              .catch(error => {
                console.error('‚ùå Failed to check Socket.IO file:', error);
                createFallbackSocket();
              });
            return;
          }

          setTimeout(checkSocketIO, 500);
        }
      }

      function createFallbackSocket() {
        console.warn('üîÑ Creating fallback socket object');
        updateConnectionStatusUI('socket', false);

        // Show user notification about Socket.IO unavailability
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥', 'warning', 8000);

        // Create fallback socket object
        window.socket = {
          emit: function (event, data) {
            console.warn('Socket.IO not available - emit ignored:', event, data);
          },
          on: function (event, callback) {
            console.warn('Socket.IO not available - on ignored:', event);
          },
          connected: false,
          disconnect: function () {
            console.warn('Socket.IO not available - disconnect ignored');
          }
        };
      }

      checkSocketIO();
    }

    // Enhanced Socket.IO initialization for Login System
    function initializeSocketIO() {
      // Prevent multiple simultaneous initializations
      if (socketIOInitializing) {
        console.log('‚è∏Ô∏è Socket.IO initialization already in progress, skipping...');
        return;
      }

      if (socketIOInitialized && window.socket && window.socket.connected) {
        console.log('‚úÖ Socket.IO already initialized and connected');
        return;
      }

      socketIOInitializing = true;

      try {
        // Clear any existing socket connection first
        if (window.socket) {
          window.socket.disconnect();
        }

        // **FORCE connection to localhost:3000 ALWAYS**
        const localUrl = 'http://localhost:3000';
        console.log('üîß Forcing Socket.IO connection to:', localUrl);

        window.socket = io(localUrl, {
          forceNew: true,
          autoConnect: true,
          timeout: 10000,
          upgrade: true,
          rememberUpgrade: false,
          transports: ['polling', 'websocket'],
          // Explicitly force localhost connection
          hostname: 'localhost',
          port: 3000,
          secure: false,
          // Enhanced configuration for login system
          auth: {
            page: 'login',
            sessionId: window.currentSession?.sessionId || null
          },
          // Reconnection settings
          reconnection: true,
          reconnectionAttempts: 3,
          reconnectionDelay: 2000,
          reconnectionDelayMax: 5000
        });

        // Enhanced Connection Event Handlers
        window.socket.on('connect', () => {
          console.log('‚úÖ Socket.IO connected successfully to localhost:3000');
          socketIOInitializing = false;
          socketIOInitialized = true;
          updateConnectionStatusUI('socket', true);

          // Show success notification to user
          showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 3000);

          // Process any queued events when socket connects
          if (eventQueue.length > 0) {
            console.log('üì§ Processing', eventQueue.length, 'queued socket events');
            const emitQueue = eventQueue.filter(item => item.type === 'emit');
            emitQueue.forEach(item => {
              window.socket.emit(item.event, item.data);
              console.log('üì° Processed queued emit:', item.event);
            });
            // Remove processed emits from queue
            eventQueue = eventQueue.filter(item => item.type !== 'emit');
          }

          // Join login-specific room
          window.socket.emit('join-room', 'login-system');

          // Send initial login session data
          if (window.currentSession) {
            window.socket.emit('register-session', {
              sessionId: window.currentSession.sessionId,
              page: 'login',
              userRole: 'login',
              timestamp: Date.now()
            });
          }

          // Track connection
          trackActivity('socket_connected', {
            timestamp: Date.now(),
            transport: window.socket.io.engine.transport.name
          });
        });

        window.socket.on('connect_error', (error) => {
          console.error('‚ùå Socket.IO connection error:', error);
          socketIOInitializing = false;
          updateConnectionStatusUI('socket', false);

          trackActivity('socket_error', {
            error: error.message,
            timestamp: Date.now()
          });
        });

        window.socket.on('disconnect', (reason) => {
          console.warn('‚ö†Ô∏è Socket.IO disconnected:', reason);
          socketIOInitialized = false;
          socketIOInitializing = false;
          updateConnectionStatusUI('socket', false);

          // Show disconnect notification to user
          if (reason !== 'io client disconnect') {
            showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', 'warning', 5000);
          }

          trackActivity('socket_disconnected', {
            reason: reason,
            timestamp: Date.now()
          });
        });

        window.socket.on('reconnect', (attemptNumber) => {
          console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
          updateConnectionStatusUI('socket', true);

          // Show reconnect success notification
          showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 3000);

          trackActivity('socket_reconnected', {
            attempts: attemptNumber,
            timestamp: Date.now()
          });
        });

        window.socket.on('reconnect_error', (error) => {
          console.error('‚ùå Socket.IO reconnection error:', error);
          updateConnectionStatusUI('socket', false);
        });

        window.socket.on('reconnect_failed', () => {
          console.error('‚ùå Socket.IO reconnection failed');
          updateConnectionStatusUI('socket', false);
          showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö', 'error');
        });

        // Login-specific event listeners with error handling
        window.socket.on('login-notification', (data) => {
          try {
            console.log('üì¢ Login notification:', data);
            if (data && data.message) {
              showToast(data.message, data.type || 'info');
            }
          } catch (error) {
            console.error('Error handling login notification:', error);
          }
        });

        window.socket.on('security-alert', (data) => {
          try {
            console.warn('üö® Security alert:', data);
            if (data && data.message) {
              if (data.severity === 'high') {
                showToast(`üö® ${data.message}`, 'error', 10000);
              } else {
                showToast(`‚ö†Ô∏è ${data.message}`, 'warning', 5000);
              }
            }
          } catch (error) {
            console.error('Error handling security alert:', error);
          }
        });

        window.socket.on('system-maintenance', (data) => {
          try {
            console.log('üîß System maintenance:', data);
            if (data && data.message) {
              showToast(`üîß ${data.message}`, 'info', 8000);
            }
          } catch (error) {
            console.error('Error handling system maintenance:', error);
          }
        });

        window.socket.on('force-logout', (data) => {
          try {
            console.warn('üö™ Force logout:', data);
            showToast('‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...', 'error');

            // Track force logout
            trackActivity('force_logout', {
              reason: data?.reason || 'unknown',
              timestamp: Date.now()
            });

            // Clear any stored auth data
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            localStorage.removeItem('userRole');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('allowedPages');

            // Redirect to login
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } catch (error) {
            console.error('Error handling force logout:', error);
            // Force reload even if there's an error
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        });

        // Enhanced heartbeat for connection monitoring
        let heartbeatInterval = setInterval(() => {
          try {
            if (window.socket && window.socket.connected) {
              safeSocketEmit('heartbeat', {
                sessionId: window.currentSession?.sessionId,
                timestamp: Date.now(),
                page: 'login',
                userAgent: navigator.userAgent.substring(0, 100),
                connectionType: navigator.connection?.effectiveType || 'unknown'
              });
            } else {
              console.warn('‚ö†Ô∏è Heartbeat skipped - socket not connected');
            }
          } catch (error) {
            console.error('‚ùå Heartbeat error:', error);
          }
        }, 30000); // Every 30 seconds

        // Store heartbeat interval for cleanup
        window.loginHeartbeatInterval = heartbeatInterval;

      } catch (error) {
        console.error('‚ùå Socket.IO initialization failed:', error);
        updateConnectionStatusUI('socket', false);

        // Show error notification to user
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥', 'warning', 8000);

        // Create a safe fallback socket object to prevent errors
        window.socket = {
          emit: function (event, data) {
            console.warn('Socket.IO not available - emit ignored:', event);
          },
          on: function (event, callback) {
            console.warn('Socket.IO not available - on ignored:', event);
          },
          connected: false,
          disconnect: function () {
            console.warn('Socket.IO not available - disconnect ignored');
          }
        };

        // Track initialization failure
        if (typeof trackActivity === 'function') {
          trackActivity('socket_init_failed', {
            error: error.message,
            timestamp: Date.now()
          });
        }
      }
    }
  </script>

</head>

<body class="min-h-screen animated-gradient flex flex-col items-center justify-center p-4 overflow-hidden">

  <!-- Rate Limit Modal -->
  <div id="rateLimitModal" class="modal fixed inset-0 items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div
      class="modal-content bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4 text-center">
      <div class="mb-6">
        <div class="mx-auto w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mb-4">
          <i class="bi bi-shield-exclamation text-red-400 text-2xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</h3>
        <p class="text-white/70 mb-4">
          ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        </p>

        <!-- Countdown Display -->
        <div class="bg-red-500/20 border border-red-400/30 rounded-lg p-4 mb-4">
          <div class="text-red-300 font-semibold mb-2">
            ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:
          </div>
          <div id="rateLimitCountdown" class="text-3xl font-mono font-bold text-red-400">
            15:00
          </div>
        </div>

        <div class="text-sm text-white/60 space-y-2">
          <p>üí° <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
          <p>üîí <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </div>

      <div class="flex space-x-3">
        <button type="button" onclick="closeRateLimitModal()"
          class="flex-1 py-3 px-4 bg-white/20 text-white/80 rounded-lg hover:bg-white/30 hover:text-white transition duration-300 font-semibold">
          ‡∏õ‡∏¥‡∏î
        </button>
        <button type="button" onclick="contactAdmin()"
          class="flex-1 py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
          ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
        </button>
      </div>
    </div>
  </div>

  <!-- Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toast Notifications -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-4"></div>

  <!-- Logo Center Scatter Effect -->
  <div class="logo-center">
    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ï‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î -->
  </div>

  <!-- Floating Background Elements -->
  <!-- Circle Elements -->
  <div class="floating float-slow glow w-56 h-56 rounded-full bg-blue-500/10 backdrop-blur-sm -top-20 -left-20"></div>
  <div class="floating float-medium glow w-80 h-80 rounded-full bg-blue-600/10 backdrop-blur-sm bottom-0 right-0"></div>
  <div class="floating float-fast glow w-40 h-40 rounded-full bg-blue-300/10 backdrop-blur-sm top-1/3 right-1/4"></div>
  <div class="floating float-medium glow w-64 h-64 rounded-full bg-blue-400/5 backdrop-blur-sm bottom-1/4 left-1/3">
  </div>

  <!-- Square Elements -->
  <div class="floating float-fast glow w-32 h-32 rounded-xl bg-white/5 rotate-45 backdrop-blur-sm top-1/4 left-10">
  </div>
  <div
    class="floating float-medium glow w-24 h-24 rounded-xl bg-white/10 rotate-12 backdrop-blur-sm bottom-20 left-1/4">
  </div>
  <div class="floating float-slow glow w-40 h-40 rounded-xl bg-white/5 -rotate-15 backdrop-blur-sm top-10 right-10">
  </div>

  <!-- Triangle Elements (CSS triangles) -->
  <div
    class="floating float-medium w-0 h-0 border-l-[25px] border-l-transparent border-r-[25px] border-r-transparent border-b-[50px] border-b-white/5 top-1/2 left-10">
  </div>
  <div
    class="floating float-slow w-0 h-0 border-l-[40px] border-l-transparent border-r-[40px] border-r-transparent border-b-[80px] border-b-white/5 bottom-10 right-1/3">
  </div>

  <!-- Card Login with entrance animation -->
  <div
    class="w-full max-w-md bg-white/10 backdrop-blur-md shadow-2xl rounded-2xl p-8 text-center border border-white/20 mx-2 card-entrance relative z-10">

    <!-- Connection Status Indicators -->
    <div class="absolute top-4 right-4 flex items-center gap-2 text-white/60 text-xs">
      <div class="flex items-center gap-1">
        <div data-service="firebase" class="inline-block w-2 h-2 rounded-full bg-red-500"></div>
        <span>FB</span>
      </div>
      <div class="flex items-center gap-1">
        <div data-service="socket" class="inline-block w-2 h-2 rounded-full bg-red-500"></div>
        <span>IO</span>
      </div>
      <div class="flex items-center gap-1">
        <div data-service="overall" class="inline-block w-2 h-2 rounded-full bg-red-500"></div>
        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
      </div>
    </div>

    <!-- Logo Area -->
    <div class="mb-6">
      <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-2 shadow-lg pulsate">
        <img src="/uploads/Logo2.png" alt="Logo" class="w-14 h-14 object-contain" id="mainLogo" />
      </div>
      <h2 class="text-white text-3xl font-semibold mb-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <p class="text-white/70 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex mb-6 bg-white/10 rounded-lg p-1">
      <button type="button" id="passwordTab"
        class="flex-1 py-2 px-4 rounded-md text-white/70 hover:text-white transition-all duration-300 flex items-center justify-center gap-2"
        onclick="switchTab('password')">
        <i class="bi bi-key"></i>
        <span>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
      </button>
      <button type="button" id="qrTab"
        class="flex-1 py-2 px-4 rounded-md text-white/70 hover:text-white transition-all duration-300 flex items-center justify-center gap-2"
        onclick="switchTab('qr')">
        <i class="bi bi-qr-code"></i>
        <span>QR Code</span>
      </button>
    </div>

    <!-- Password Login Form -->
    <div id="passwordContent" class="tab-content active">
      <form id="loginForm" class="space-y-5">
        <div>
          <div class="flex items-center justify-between mb-1">
            <label for="usernameInput" class="text-white/80 text-sm text-left">User</label>
          </div>
          <div class="relative input-focus-effect">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <i class="bi bi-person text-white/50"></i>
            </div>
            <input type="text" id="usernameInput" name="username" placeholder="Your username" required
              class="w-full rounded-lg bg-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-white/30 pl-10 pr-4 py-3 transition-all duration-300"
              autocomplete="username" />
          </div>
          <p id="usernameError" class="hidden mt-1 text-xs text-left text-red-300"></p>
        </div>

        <div>
          <div class="flex items-center justify-between mb-1">
            <label for="passwordInput" class="text-white/80 text-sm text-left">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <a href="#" onclick="showForgotPassword()"
              class="text-xs text-white/60 hover:text-white/90 transition-colors">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
          </div>
          <div class="relative input-focus-effect">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <i class="bi bi-lock text-white/50"></i>
            </div>
            <input type="password" id="passwordInput" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
              class="w-full rounded-lg bg-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-white/30 pl-10 pr-10 py-3 transition-all duration-300"
              autocomplete="current-password" />
            <button type="button" id="togglePassword"
              class="absolute inset-y-0 right-0 flex items-center pr-3 text-white/50 hover:text-white/80 transition-colors">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <p id="passwordError" class="hidden mt-1 text-xs text-left text-red-300"></p>
        </div>

        <div class="flex items-center">
          <input type="checkbox" id="rememberMe"
            class="w-4 h-4 bg-white/20 rounded border-none focus:ring-2 focus:ring-white/30 checked:bg-brand-500">
          <label for="rememberMe" class="ml-2 text-sm text-white/70">‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ</label>
        </div>

        <button type="submit" id="loginButton"
          class="w-full rounded-lg bg-white text-brand-600 font-bold hover:bg-brand-500 hover:text-white focus:ring focus:ring-white/30 transition-colors py-3 relative group flex items-center justify-center shadow-lg hover:shadow-xl">
          <span id="buttonText">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          <div id="buttonSpinner" class="hidden spinner ml-2"></div>
        </button>
      </form>
    </div>

    <!-- QR Code Login -->
    <div id="qrContent" class="tab-content">
      <div class="space-y-4">
        <p class="text-white/70 text-sm mb-4">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏û‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</p>

        <div class="bg-white rounded-xl p-4 mx-auto w-fit relative">
          <div id="qrCode" class="relative"></div>
          <div class="qr-scan-line"></div>
        </div>

        <div class="mt-4 space-y-2">
          <p class="text-white/60 text-xs">Session ID: <span id="sessionId" class="text-white/80 font-mono">-</span></p>
          <div class="flex items-center justify-center gap-2">
            <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
            <p class="text-white/70 text-sm">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...</p>
          </div>
        </div>

        <button type="button" id="refreshQR"
          class="mt-4 text-white/60 hover:text-white text-sm flex items-center gap-2 mx-auto transition-colors"
          onclick="generateQRCode()">
          <i class="bi bi-arrow-clockwise"></i>
          <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä QR Code</span>
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-white/40 text-xs">
      <p>¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 pheenong ‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
    </div>
  </div>

  <!-- Additional floating elements for depth -->
  <div class="floating float-slow glow w-20 h-20 rounded-full bg-white/5 backdrop-blur-sm bottom-1/3 right-1/6"></div>
  <div class="floating float-fast glow w-16 h-16 rounded-md bg-white/5 rotate-45 backdrop-blur-sm top-2/3 left-1/6">
  </div>

  <!-- Enhanced Login Request Modal -->
  <div id="loginRequestModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 w-full max-w-md animate-fade-in">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="bi bi-exclamation-triangle text-yellow-400 text-2xl"></i>
        </div>
        <h3 class="text-white text-xl font-semibold mb-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <p class="text-white/70 text-sm" id="requestModalMessage">
          ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </p>
      </div>

      <form id="loginRequestForm" class="space-y-4">
        <!-- Quick reason selection -->
        <div>
          <label class="text-white/80 text-sm block mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</label>
          <div class="space-y-2">
            <label class="flex items-center space-x-2 text-white/70 hover:text-white cursor-pointer">
              <input type="radio" name="quickReason" value="‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå"
                class="text-yellow-500 focus:ring-yellow-500">
              <span class="text-sm">‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</span>
            </label>
            <label class="flex items-center space-x-2 text-white/70 hover:text-white cursor-pointer">
              <input type="radio" name="quickReason" value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô"
                class="text-yellow-500 focus:ring-yellow-500">
              <span class="text-sm">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</span>
            </label>
            <label class="flex items-center space-x-2 text-white/70 hover:text-white cursor-pointer">
              <input type="radio" name="quickReason" value="‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤"
                class="text-yellow-500 focus:ring-yellow-500">
              <span class="text-sm">‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
            </label>
            <label class="flex items-center space-x-2 text-white/70 hover:text-white cursor-pointer">
              <input type="radio" name="quickReason" value="other" class="text-yellow-500 focus:ring-yellow-500">
              <span class="text-sm">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</span>
            </label>
          </div>
        </div>

        <div>
          <label for="loginReason" class="text-white/80 text-sm block mb-1">
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span class="text-red-400">*</span>
          </label>
          <textarea id="loginReason" rows="3" required
            class="w-full rounded-lg bg-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-white/30 px-4 py-3 transition-all duration-300"
            placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
        </div>

        <div class="bg-white/10 rounded-lg p-3 text-white/60 text-xs">
          <i class="bi bi-info-circle mr-1"></i>
          ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        </div>

        <div class="flex gap-3 mt-6">
          <button type="button" onclick="closeLoginRequestModal()"
            class="flex-1 rounded-lg bg-white/10 text-white font-medium hover:bg-white/20 focus:ring focus:ring-white/30 transition-colors py-2">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" id="requestSubmitBtn"
            class="flex-1 rounded-lg bg-yellow-500 text-white font-bold hover:bg-yellow-600 focus:ring focus:ring-yellow-500/30 transition-colors py-2 flex items-center justify-center">
            <span id="requestBtnText">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</span>
            <div id="requestSpinner" class="hidden spinner ml-2"></div>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Not Checked-In Modal -->
  <div id="notCheckedInModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 w-full max-w-md animate-fade-in">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="bi bi-exclamation-circle text-orange-400 text-2xl"></i>
        </div>
        <h3 class="text-white text-xl font-semibold mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</h3>
        <p class="text-white/70 text-sm">
          ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô
        </p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 mb-6">
        <h4 class="text-white/80 font-medium mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô:</h4>
        <ol class="text-white/60 text-sm space-y-1 list-decimal list-inside">
          <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏û 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á HR ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</li>
          <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô"</li>
          <li>‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</li>
          <li>‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li>
        </ol>
      </div>
      <div class="flex gap-3">
        <button type="button" onclick="closeNotCheckedInModal()"
          class="flex-1 rounded-lg bg-white/10 text-white font-medium hover:bg-white/20 focus:ring focus:ring-white/30 transition-colors py-2">
          ‡∏õ‡∏¥‡∏î
        </button>
        <button type="button" onclick="proceedToRequestApproval()"
          class="flex-1 rounded-lg bg-orange-500 text-white font-bold hover:bg-orange-600 focus:ring focus:ring-orange-500/30 transition-colors py-2">
          ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    </div>
  </div>

  <!-- Waiting for Approval Modal -->
  <div id="waitingApprovalModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-6 w-full max-w-md animate-fade-in">
      <div class="text-center mb-6">
        <div class="w-20 h-20 mx-auto mb-4 relative">
          <div class="absolute inset-0 border-4 border-yellow-400/30 rounded-full"></div>
          <div class="absolute inset-0 border-4 border-yellow-400 rounded-full border-t-transparent animate-spin"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <i class="bi bi-hourglass-split text-yellow-400 text-2xl animate-pulse"></i>
          </div>
        </div>
        <h3 class="text-white text-xl font-semibold mb-2">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
        <p class="text-white/70 text-sm">
          ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        </p>
      </div>
      <div class="bg-white/10 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-white/60 text-sm">Request ID:</span>
          <span id="requestIdDisplay" class="text-white font-mono text-sm">-</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-white/60 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
          <span class="text-yellow-400 text-sm flex items-center gap-1">
            <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </span>
        </div>
      </div>
      <div class="text-center">
        <button type="button" onclick="cancelLoginRequest()"
          class="rounded-lg bg-white/10 text-white font-medium hover:bg-white/20 focus:ring focus:ring-white/30 transition-colors py-2 px-6">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toast Notification ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏° -->
  <script>
    // Socket.IO Management System
    let socket = null;
    let socketReady = false;
    let eventQueue = [];

    function initializeSocketReference() {
      // Wait for window.socket to be ready
      const checkSocket = () => {
        if (window.socket && typeof window.socket === 'object' && window.socket.emit) {
          socket = window.socket;
          socketReady = true;
          console.log('‚úÖ Socket reference established');

          // Show user that socket is ready (only if connected)
          if (socket.connected && typeof showToast === 'function') {
            showToast('‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success', 2000);
          }

          // Process queued events
          eventQueue.forEach(item => {
            if (item.type === 'emit') {
              if (socket.connected) {
                socket.emit(item.event, item.data);
              } else {
                console.log('üîÑ Socket not connected - re-queuing emit:', item.event);
                // Keep in queue for later
                eventQueue.push(item);
              }
            } else if (item.type === 'on') {
              socket.on(item.event, item.callback);
            }
          });

          // Clear processed events
          eventQueue = eventQueue.filter(item => item.type === 'emit' && !socket.connected);

          return true;
        }
        return false;
      };

      if (!checkSocket()) {
        // Check every 500ms for up to 15 seconds
        let attempts = 0;
        const interval = setInterval(() => {
          attempts++;
          if (checkSocket() || attempts >= 30) {
            clearInterval(interval);
            if (!socketReady) {
              console.warn('‚ö†Ô∏è Socket.IO not available after 15 seconds - creating fallback');
              socket = createFallbackSocket();
              socketReady = true; // Mark as ready even with fallback
            }
          }
        }, 500);
      }
    }

    function createFallbackSocket() {
      console.warn('üîÑ Creating Socket.IO fallback object');
      return {
        emit: function (event, data) {
          // Silent fallback - don't spam console
        },
        on: function (event, callback) {
          // Silent fallback - don't spam console
        },
        connected: false,
        disconnect: function () {
          // Silent fallback - don't spam console
        }
      };
    }

    function safeSocketEmit(event, data) {
      if (socketReady && socket && socket.connected) {
        socket.emit(event, data);
      } else if (socketReady && socket) {
        console.log('üîÑ Socket not connected - queuing emit:', event);
        eventQueue.push({ type: 'emit', event, data });
      } else {
        // Silently queue events when socket not ready
        eventQueue.push({ type: 'emit', event, data });
      }
    }

    function safeSocketOn(event, callback) {
      if (socketReady && socket) {
        socket.on(event, callback);
      } else {
        console.log('üîÑ Socket not ready - queuing event listener:', event);
        eventQueue.push({ type: 'on', event, callback });
      }
    }

    // Initialize socket reference when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeSocketReference);

    // Debug function for Socket.IO status
    window.debugSocket = function () {
      console.log('üîç Socket.IO Debug Info:');
      console.log('- socketReady:', socketReady);
      console.log('- socket exists:', !!socket);
      console.log('- socket connected:', socket ? socket.connected : 'N/A');
      console.log('- eventQueue length:', eventQueue.length);
      console.log('- window.socket exists:', !!window.socket);
      console.log('- window.socket connected:', window.socket ? window.socket.connected : 'N/A');
      if (eventQueue.length > 0) {
        console.log('- queued events:', eventQueue.map(item => item.event));
      }
    };

    let currentSessionId = null;
    let qrCheckInterval = null;

    // Enhanced Tab switching with activity tracking
    function switchTab(tab) {
      const passwordTab = document.getElementById('passwordTab');
      const qrTab = document.getElementById('qrTab');
      const passwordContent = document.getElementById('passwordContent');
      const qrContent = document.getElementById('qrContent');

      // Track tab switching activity
      trackActivity('tab_switch', {
        from: passwordContent.classList.contains('active') ? 'password' : 'qr',
        to: tab,
        timestamp: Date.now()
      });

      if (tab === 'password') {
        passwordTab.classList.add('bg-white/20', 'text-white');
        passwordTab.classList.remove('text-white/70');
        qrTab.classList.remove('bg-white/20', 'text-white');
        qrTab.classList.add('text-white/70');

        passwordContent.classList.add('active');
        qrContent.classList.remove('active');

        // Clear QR check interval
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
          qrCheckInterval = null;
        }

        // Focus on username input
        setTimeout(() => {
          const usernameInput = document.getElementById('usernameInput');
          if (usernameInput) usernameInput.focus();
        }, 300);

      } else {
        qrTab.classList.add('bg-white/20', 'text-white');
        qrTab.classList.remove('text-white/70');
        passwordTab.classList.remove('bg-white/20', 'text-white');
        passwordTab.classList.add('text-white/70');

        qrContent.classList.add('active');
        passwordContent.classList.remove('active');

        // Generate QR Code when switching to QR tab
        generateQRCode();
      }

      // Emit Socket.IO event (safe)
      safeSocketEmit('login-tab-switch', {
        sessionId: window.currentSession?.sessionId,
        tab: tab,
        timestamp: Date.now()
      });
    }

    // Enhanced QR Code generation with activity tracking
    function generateQRCode() {
      // Track QR code generation
      trackActivity('qr_code_generated', {
        timestamp: Date.now(),
        action: 'generate'
      });

      // Clear previous QR code
      const qrContainer = document.getElementById('qrCode');
      qrContainer.innerHTML = '';

      // Generate session ID
      currentSessionId = 'WEB-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      document.getElementById('sessionId').textContent = currentSessionId;

      // Create QR code with session data
      const qrData = JSON.stringify({
        type: 'login',
        sessionId: currentSessionId,
        timestamp: Date.now(),
        url: window.location.origin,
        firebaseSessionId: window.currentSession?.sessionId || null
      });

      new QRCode(qrContainer, {
        text: qrData,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });

      // Track to Firebase
      if (window.firebaseDb && window.firebaseRefs.loginAttemptsRef) {
        window.firebaseRefs.push(window.firebaseRefs.loginAttemptsRef, {
          type: 'qr_generated',
          sessionId: currentSessionId,
          firebaseSessionId: window.currentSession?.sessionId,
          timestamp: window.firebaseRefs.serverTimestamp(),
          ip: window.location.hostname,
          userAgent: navigator.userAgent.substring(0, 100)
        });
      }

      // Emit to Socket.IO (safe)
      safeSocketEmit('qr-code-generated', {
        sessionId: currentSessionId,
        firebaseSessionId: window.currentSession?.sessionId,
        timestamp: Date.now()
      });

      // Start checking for login status
      startQRLoginCheck();
    }

    // Check QR login status
    function startQRLoginCheck() {
      // Clear existing interval
      if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
      }

      // Listen for QR login events via Socket.IO (safe)
      safeSocketEmit('registerQRSession', { sessionId: currentSessionId });

      safeSocketOn('qrLoginSuccess', (data) => {
        if (data.sessionId === currentSessionId) {
          handleQRLoginSuccess(data);
        }
      });

      // Also poll API as backup
      qrCheckInterval = setInterval(async () => {
        try {
          const res = await fetch('/api/users/qr-login-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: currentSessionId })
          });

          const data = await res.json();

          if (data.success && data.status === 'completed') {
            clearInterval(qrCheckInterval);
            handleQRLoginSuccess(data);
          }
        } catch (err) {
          console.error('Error checking QR login status:', err);
        }
      }, 2000); // Check every 2 seconds
    }

    // Handle successful QR login
    function handleQRLoginSuccess(data) {
      // Track successful QR login
      trackActivity('login_success', {
        method: 'qr',
        qrSessionId: currentSessionId,
        userId: data.user._id,
        userRole: data.user.role,
        timestamp: Date.now()
      });

      // Track to Firebase
      if (window.firebaseDb && window.firebaseRefs.loginAttemptsRef) {
        window.firebaseRefs.push(window.firebaseRefs.loginAttemptsRef, {
          type: 'qr_success',
          userId: data.user._id,
          username: data.user.name,
          qrSessionId: currentSessionId,
          firebaseSessionId: window.currentSession?.sessionId,
          timestamp: window.firebaseRefs.serverTimestamp(),
          ip: window.location.hostname,
          userAgent: navigator.userAgent.substring(0, 100)
        });
      }

      // Emit to Socket.IO
      if (window.socket && window.socket.connected) {
        window.socket.emit('login-success', {
          method: 'qr',
          userId: data.user._id,
          sessionId: window.currentSession?.sessionId,
          timestamp: Date.now()
        });
      }

      // Store auth data
      localStorage.setItem('authToken', data.token);
      localStorage.setItem('userName', data.user.name);
      localStorage.setItem('userId', data.user._id);
      localStorage.setItem('userRole', data.user.role);            // ‡πÄ‡∏û‡∏¥‡πà‡∏° userRole
      localStorage.setItem('sessionId', data.user.sessionId);      // ‡πÄ‡∏û‡∏¥‡πà‡∏° sessionId
      localStorage.setItem('allowedPages', JSON.stringify(data.user.allowedPages || []));
      localStorage.setItem('userData', JSON.stringify(data.user)); // ‡πÄ‡∏û‡∏¥‡πà‡∏° userData

      // Authenticate socket connection
      if (socket && data.token) {
        socket.emit('authenticate', { token: data.token });
      }

      // Redirect based on permissions and role
      const allowedPages = data.user.allowedPages || [];
      const userRole = data.user.role?.name?.toLowerCase() || '';

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Super Admin ‡∏´‡∏£‡∏∑‡∏≠ CEO
      const isSuperUser = userRole === 'super admin' ||
        userRole === 'ceo' ||
        userRole === '‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤' ||
        allowedPages.includes('*');

      const pageMap = {
        accounting: '/accounting_dashboard',
        hr: '/HR_Dashboard',
        stock: '/StockManagehome',
        marketing: '/marketing_dashboard',
        loan: '/loan_dashboard',
        pos: '/frontstore_index',
        gifts: '/gifts_dashboard',
        report: '/financial_dashboard'
      };

      let targetUrl = '/home';

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super User ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ home ‡πÄ‡∏™‡∏°‡∏≠
      if (isSuperUser) {
        targetUrl = '/home';
      }
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢
      else if (allowedPages.length === 1) {
        targetUrl = pageMap[allowedPages[0]] || '/home';
      }
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ home ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      else {
        targetUrl = '/home';
      }

      setTimeout(() => {
        window.location.href = targetUrl;
      }, 1500);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
    function createSingleLogo(container, logoPath) {
      if (!container) return;

      // Bird flight animations
      const birdAnimations = ['birdFlight1', 'birdFlight2', 'birdFlight3', 'birdFlight4'];
      const animType = birdAnimations[Math.floor(Math.random() * birdAnimations.length)];

      // Larger size for prominent flying logos
      const size = Math.floor(Math.random() * 60) + 60; // Increased size range to 60-120px

      // Container for bird animation
      const birdContainer = document.createElement('div');
      birdContainer.style.cssText = `
        position: absolute;
        left: 50%;
        top: 50%;
        width: ${size}px;
        height: ${size}px;
        opacity: 0;
        will-change: transform, opacity;
        animation: ${animType} ${15 + Math.random() * 10}s ease-out forwards;
        animation-delay: ${Math.random() * 0.5}s;
        transform-origin: center;
      `;

      // Logo with flapping wings
      const logo = document.createElement('img');
      logo.src = logoPath;
      logo.alt = '';
      logo.style.cssText = `
        width: 100%;
        height: 100%;
        animation: wingFlap ${0.3 + Math.random() * 0.4}s ease-in-out infinite;
        transform-origin: center;
      `;

      // Add hover effect to make the logo bounce away
      birdContainer.addEventListener('mouseenter', () => {
        const randomX = (Math.random() - 0.5) * 200; // Random horizontal movement
        const randomY = (Math.random() - 0.5) * 200; // Random vertical movement
        birdContainer.style.transition = 'transform 0.5s ease-out';
        birdContainer.style.transform = `translate(${randomX}px, ${randomY}px) scale(1.2)`;
        setTimeout(() => {
          birdContainer.style.transform = ''; // Reset transform after bounce
        }, 500);
      });

      birdContainer.appendChild(logo);
      container.appendChild(birdContainer);

      // Remove bird after animation ends
      setTimeout(() => {
        if (birdContainer.parentNode === container) {
          container.removeChild(birdContainer);
        }
      }, 35000);
    }

    function createScatteringLogos() {
      const logoCenter = document.querySelector('.logo-center');
      if (!logoCenter) return;

      // Clear old logos
      logoCenter.innerHTML = '';

      const logoPath = '/uploads/Logo2.png'; // ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà

      // Create initial flying birds with larger logos
      for (let i = 0; i < 8; i++) {
        setTimeout(() => {
          createSingleLogo(logoCenter, logoPath);
        }, i * 400);
      }

      // Periodically create new birds
      setInterval(() => {
        createSingleLogo(logoCenter, logoPath);

        // Remove excess birds
        if (logoCenter.children.length > 25) {
          const oldLogos = [...logoCenter.children].slice(0, 5);
          oldLogos.forEach(logo => logo.remove());
        }
      }, 4000 + Math.random() * 4000);
    }

    /**
     * Activity Tracking Function
     */
    function trackActivity(action, data = {}) {
      try {
        const activityData = {
          action: action,
          timestamp: Date.now(),
          page: 'login',
          sessionId: window.currentSession?.sessionId,
          ...data
        };

        // Track to Firebase
        if (window.firebaseDb && window.firebaseRefs.loginActivitiesRef) {
          window.firebaseRefs.push(window.firebaseRefs.loginActivitiesRef, activityData);
        }

        // Track to Socket.IO
        safeSocketEmit('activity', activityData);

        console.log('üìä Activity tracked:', action, data);
      } catch (error) {
        console.warn('Activity tracking failed:', error);
      }
    }

    /**
     * Connection Status Update Function
     */
    function updateConnectionStatus(service, connected) {
      try {
        const indicator = document.querySelector(`[data-service="${service}"]`);
        if (indicator) {
          indicator.className = connected
            ? 'inline-block w-2 h-2 rounded-full bg-green-500'
            : 'inline-block w-2 h-2 rounded-full bg-red-500';
        }

        // Update overall status
        const firebaseConnected = document.querySelector('[data-service="firebase"]')?.classList.contains('bg-green-500');
        const socketConnected = document.querySelector('[data-service="socket"]')?.classList.contains('bg-green-500');

        const overallIndicator = document.querySelector('[data-service="overall"]');
        if (overallIndicator) {
          if (firebaseConnected && socketConnected) {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-green-500';
          } else if (firebaseConnected || socketConnected) {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-yellow-500';
          } else {
            overallIndicator.className = 'inline-block w-2 h-2 rounded-full bg-red-500';
          }
        }

        console.log(`üì° ${service} connection status:`, connected ? 'Connected' : 'Disconnected');
      } catch (error) {
        console.warn('Connection status update failed:', error);
      }
    }

    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showToast: ‡πÅ‡∏™‡∏î‡∏á Toast ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ UX/UI ‡πÉ‡∏´‡∏°‡πà
     */
    function showToast(message, type = 'success', duration = 3000) {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) return;

      const toast = document.createElement('div');

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≤‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toast
      toast.className = 'max-w-xs w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 p-4 flex items-start space-x-2 animate-fade-in';

      // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      if (type === 'success') {
        toast.classList.add('border-l-4', 'border-green-500');
      } else if (type === 'error') {
        toast.classList.add('border-l-4', 'border-red-500');
      } else if (type === 'info') {
        toast.classList.add('border-l-4', 'border-blue-500');
      }

      // HTML ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô toast
      toast.innerHTML = `
        <div class="flex-shrink-0">
          ${type === 'success' ? `
            <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          ` : type === 'error' ? `
            <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          ` : `
            <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01" />
            </svg>
          `}
        </div>
        <div class="flex-1">
          <p class="text-sm text-gray-700">${message}</p>
        </div>
        <button class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;

      toastContainer.appendChild(toast);

      // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î toast
      const closeBtn = toast.querySelector('button');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          toast.classList.add('opacity-0');
          setTimeout(() => {
            if (toast.parentNode === toastContainer) {
              toastContainer.removeChild(toast);
            }
          }, 300);
        });
      }

      // ‡∏•‡∏ö toast ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      setTimeout(() => {
        toast.classList.add('opacity-0');
        setTimeout(() => {
          if (toast.parentNode === toastContainer) {
            toastContainer.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // Toggle Password Visibility
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('passwordInput');

    if (togglePassword && passwordInput) {
      togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        // Toggle icon
        const icon = togglePassword.querySelector('i');
        if (icon) {
          icon.classList.toggle('bi-eye');
          icon.classList.toggle('bi-eye-slash');
        }
      });
    }

    // Form Validation
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const passwordError = document.getElementById('passwordError');
    const loginButton = document.getElementById('loginButton');
    const buttonText = document.getElementById('buttonText');
    const buttonSpinner = document.getElementById('buttonSpinner');

    function validateUsername(u) {
      return u.trim().length > 0;
    }

    function hideLoading() {
      // Hide LoadingSystem overlay
      if (typeof LoadingSystem !== 'undefined' && LoadingSystem.hideAll && typeof LoadingSystem.hideAll === 'function') {
        try {
          LoadingSystem.hideAll();
        } catch (error) {
          console.warn('LoadingSystem hideAll error:', error);
        }
      }

      // Always reset login button state as fallback
      const buttonText = document.getElementById('buttonText');
      const buttonSpinner = document.getElementById('buttonSpinner');
      const loginButton = document.getElementById('loginButton');

      if (buttonText && buttonSpinner && loginButton) {
        buttonText.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        buttonSpinner.classList.add('hidden');
        loginButton.disabled = false;
        loginButton.classList.remove('opacity-80');
      }
    }

    // Login Request Functions
    let currentRequestId = null;
    let statusCheckInterval = null;

    function showLoginRequestModal() {
      const modal = document.getElementById('loginRequestModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('loginReason').focus();
      }
    }

    function closeLoginRequestModal() {
      const modal = document.getElementById('loginRequestModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('loginRequestForm').reset();
      }
    }

    function showWaitingApprovalModal() {
      const modal = document.getElementById('waitingApprovalModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('requestIdDisplay').textContent = currentRequestId || '-';
      }
    }

    function closeWaitingApprovalModal() {
      const modal = document.getElementById('waitingApprovalModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
      }
    }

    function cancelLoginRequest() {
      closeWaitingApprovalModal();
      showToast('‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 'info');
    }

    // Handle login request form submission
    const loginRequestForm = document.getElementById('loginRequestForm');
    if (loginRequestForm) {
      loginRequestForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const reason = document.getElementById('loginReason').value.trim();
        if (!reason) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'error');
          return;
        }

        const submitBtn = document.getElementById('requestSubmitBtn');
        const btnText = document.getElementById('requestBtnText');
        const spinner = document.getElementById('requestSpinner');

        // Show loading
        btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...';
        spinner.classList.remove('hidden');
        submitBtn.disabled = true;

        try {
          const creds = window.pendingLoginCredentials;
          if (!creds) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
          }

          const res = await fetch('/api/users/login-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: creds.username,
              password: creds.password,
              reason: reason
            })
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠');
          }

          currentRequestId = data.requestId;

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (data.autoApproved && data.token) {
            // ‡∏õ‡∏¥‡∏î modal ‡∏Ç‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
            closeLoginRequestModal();

            showToast('‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'success');

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ redirect
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('userName', data.user.name);
            localStorage.setItem('userId', data.user._id);
            localStorage.setItem('userRole', data.user.role.name);
            localStorage.setItem('allowedPages', JSON.stringify(data.user.allowedPages || []));
            localStorage.setItem('userData', JSON.stringify(data.user));
            localStorage.setItem('autoApproved', 'true');

            // Authenticate socket connection
            if (socket && data.token) {
              socket.emit('authenticate', { token: data.token });
            }

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Redirect ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /home ‡πÄ‡∏™‡∏°‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö auto-approved login
            window.location.href = '/home';

            return;
          }

          // ‡∏õ‡∏¥‡∏î modal ‡∏Ç‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
          closeLoginRequestModal();

          // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          showWaitingApprovalModal();

          // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          startStatusCheck();

        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          // Hide loading
          btnText.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠';
          spinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    function startStatusCheck() {
      if (!currentRequestId) return;

      // Listen for real-time updates via Socket.IO
      socket.on('loginRequestUpdated', (data) => {
        if (data.requestId === currentRequestId) {
          handleRequestStatusUpdate(data.status);
        }
      });

      // Also poll API as backup
      statusCheckInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/users/login-request/${currentRequestId}/status`);
          const data = await res.json();

          if (!data.success) {
            clearInterval(statusCheckInterval);
            closeWaitingApprovalModal();
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            return;
          }

          if (data.status !== 'pending') {
            handleRequestStatusUpdate(data.status);
          }

        } catch (err) {
          console.error('Status check error:', err);
        }
      }, 2000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    async function handleRequestStatusUpdate(status) {
      clearInterval(statusCheckInterval);
      closeWaitingApprovalModal();

      if (status === 'approved') {
        showToast('‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'success');

        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ approved token
        try {
          const res = await fetch('/api/users/login-approved', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requestId: currentRequestId })
          });

          const result = await res.json();

          if (!res.ok || !result.success) {
            throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
          }

          if (!result.token) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
          }

          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ login ‡∏õ‡∏Å‡∏ï‡∏¥
          localStorage.setItem('authToken', result.token);
          localStorage.setItem('userName', result.user.name);
          localStorage.setItem('userId', result.user._id);
          localStorage.setItem('userRole', result.user.role);
          localStorage.setItem('allowedPages', JSON.stringify(result.user.allowedPages || []));
          localStorage.setItem('userData', JSON.stringify(result.user));
          localStorage.setItem('approvedLogin', 'true'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° flag ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô approved login

          // Authenticate socket connection
          if (socket && result.token) {
            socket.emit('authenticate', { token: result.token });
          }

          // Redirect based on permissions and role
          const allowedPages = result.user.allowedPages || [];
          const userRole = result.user.role?.name?.toLowerCase() || '';

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Super Admin ‡∏´‡∏£‡∏∑‡∏≠ CEO
          const isSuperUser = userRole === 'super admin' ||
            userRole === 'ceo' ||
            userRole === '‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤' ||
            allowedPages.includes('*');

          const pageMap = {
            accounting: '/accounting_dashboard',
            hr: '/HR_Dashboard',
            stock: '/StockManagehome',
            marketing: '/marketing_dashboard',
            loan: '/loan_dashboard',
            pos: '/frontstore_index',
            gifts: '/gifts_dashboard',
            report: '/financial_dashboard'
          };

          let targetUrl = '/home';

          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Super User ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ home ‡πÄ‡∏™‡∏°‡∏≠
          if (isSuperUser) {
            targetUrl = '/home';
          }
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢
          else if (allowedPages.length === 1) {
            targetUrl = pageMap[allowedPages[0]] || '/home';
          }
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ home ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
          else {
            targetUrl = '/home';
          }

          setTimeout(() => {
            window.location.href = targetUrl;
          }, 1500);

        } catch (err) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        }

      } else if (status === 'rejected') {
        showToast('‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', 'error');
      } else if (status === 'expired') {
        showToast('‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà', 'error');
      }
    }

    // Form submission with validation
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Reset errors
        if (usernameError) usernameError.classList.add('hidden');
        if (passwordError) passwordError.classList.add('hidden');

        let hasError = false;
        const username = usernameInput?.value.trim() || '';
        const password = passwordInput?.value.trim() || '';

        // Username validation
        if (!validateUsername(username)) {
          if (usernameError) {
            usernameError.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            usernameError.classList.remove('hidden');
          }
          hasError = true;
        }

        // Password validation
        if (!password) {
          if (passwordError) {
            passwordError.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
            passwordError.classList.remove('hidden');
          }
          hasError = true;
        }

        if (hasError) return;

        // Track login attempt
        trackActivity('login_attempt', {
          method: 'password',
          username: username,
          timestamp: Date.now(),
          hasRememberMe: document.getElementById('rememberMe')?.checked || false
        });

        // Track to Firebase
        if (window.firebaseDb && window.firebaseRefs.loginAttemptsRef) {
          window.firebaseRefs.push(window.firebaseRefs.loginAttemptsRef, {
            type: 'password_attempt',
            username: username,
            timestamp: window.firebaseRefs.serverTimestamp(),
            ip: window.location.hostname,
            userAgent: navigator.userAgent.substring(0, 100),
            sessionId: window.currentSession?.sessionId
          });
        }

        // Emit to Socket.IO
        if (window.socket && window.socket.connected) {
          window.socket.emit('login-attempt', {
            method: 'password',
            username: username,
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now()
          });
        }

        // Show loading state
        let loaderId = null;
        if (typeof LoadingSystem !== 'undefined' && LoadingSystem.show && typeof LoadingSystem.show === 'function') {
          try {
            loaderId = LoadingSystem.show({
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
              showProgress: true,
              autoProgress: true
            });
          } catch (error) {
            console.warn('LoadingSystem error:', error);
            showLoadingButton();
          }
        } else {
          console.log('LoadingSystem not available, using button loading');
          showLoadingButton();
        }

        function showLoadingButton() {
          if (buttonText && buttonSpinner && loginButton) {
            buttonText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            buttonSpinner.classList.remove('hidden');
            loginButton.disabled = true;
            loginButton.classList.add('opacity-80');
          }
        }

        try {
          const res = await fetch('/api/users/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username,
              password,
              remember: document.getElementById('rememberMe')?.checked || false
            }),
          });

          const responseText = await res.text();
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (e) {
            // This catches non-JSON responses, like 502 gateway errors or 429 rate limit HTML pages
            throw new Error(responseText || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
          }

          // Now `result` is a valid JSON object, and we can check the status.
          if (!res.ok || !result.success) {
            if (result.error === 'attendance_required') {
              // Hide loading with LoadingSystem v2.0.0
              if (loaderId) {
                LoadingSystem.hide(loaderId);
              } else {
                LoadingSystem.hideAll();
              }
              console.log('Attendance Required Response:', result);

              // Store credentials for the request
              window.pendingLoginCredentials = { username, password };

              const isCheckedOut =
                result.requireApproval === true ||
                result.attendanceStatus?.isCheckedOut === true ||
                (result.message && result.message.includes('‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå'));

              if (isCheckedOut) {
                console.log('User has checked out - showing approval request modal');
                showLoginRequestModal();
              } else {
                console.log('User has not checked in - showing check-in required modal');
                showNotCheckedInModal();
              }
              return; // Stop execution here
            }
            // For other errors, throw to be caught by the outer catch block.
            throw new Error(result.error || result.message || '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
          }

          if (!result.token) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏™‡πç‡∏≤‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
          }

          // Track successful password login
          trackActivity('login_success', {
            method: 'password',
            userId: result.user._id,
            username: result.user.name,
            userRole: result.user.role,
            timestamp: Date.now(),
            hasRememberMe: document.getElementById('rememberMe')?.checked || false
          });

          // Track to Firebase
          if (window.firebaseDb && window.firebaseRefs.loginAttemptsRef) {
            window.firebaseRefs.push(window.firebaseRefs.loginAttemptsRef, {
              type: 'password_success',
              userId: result.user._id,
              username: result.user.name,
              userRole: result.user.role,
              firebaseSessionId: window.currentSession?.sessionId,
              timestamp: window.firebaseRefs.serverTimestamp(),
              ip: window.location.hostname,
              userAgent: navigator.userAgent.substring(0, 100),
              hasRememberMe: document.getElementById('rememberMe')?.checked || false
            });
          }

          // Emit to Socket.IO
          safeSocketEmit('login-success', {
            method: 'password',
            userId: result.user._id,
            username: result.user.name,
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now()
          });

          // Store important data in localStorage
          localStorage.setItem('authToken', result.token);
          localStorage.setItem('userName', result.user.name);
          localStorage.setItem('userId', result.user._id);
          localStorage.setItem('userRole', result.user.role);
          localStorage.setItem('sessionId', result.user.sessionId);
          localStorage.setItem('allowedPages', JSON.stringify(result.user.allowedPages || []));
          localStorage.setItem('userData', JSON.stringify(result.user));

          // Show success toast
          showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

          // Redirect based on permissions
          const allowedPages = result.user.allowedPages || [];
          const userRole = result.user.role?.name?.toLowerCase() || '';

          const isSuperUser = userRole === 'super admin' ||
            userRole === 'ceo' ||
            userRole === '‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤' ||
            allowedPages.includes('*');

          const pageMap = {
            accounting: '/accounting_dashboard',
            hr: '/HR_Dashboard',
            stock: '/StockManagehome',
            marketing: '/marketing_dashboard',
            loan: '/loan_dashboard',
            pos: '/frontstore_index',
            gifts: '/gifts_dashboard',
            report: '/financial_dashboard'
          };

          let targetUrl = '/home';

          if (isSuperUser) {
            targetUrl = '/home';
          }
          else if (allowedPages.length === 1) {
            targetUrl = pageMap[allowedPages[0]] || '/home';
          }
          else {
            targetUrl = '/home';
          }

          showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          setTimeout(() => {
            window.location.href = targetUrl;
          }, 2000);

        } catch (err) {
          console.error('Login failed:', err);
          // Hide loading with LoadingSystem v2.0.0
          if (loaderId) {
            LoadingSystem.hide(loaderId);
          } else {
            LoadingSystem.hideAll();
          }

          // Track login failure
          trackActivity('login_failed', {
            method: 'password',
            username: username,
            error: err.message,
            timestamp: Date.now()
          });

          // Track to Firebase
          if (window.firebaseDb && window.firebaseRefs.loginAttemptsRef) {
            window.firebaseRefs.push(window.firebaseRefs.loginAttemptsRef, {
              type: 'password_failed',
              username: username,
              error: err.message,
              firebaseSessionId: window.currentSession?.sessionId,
              timestamp: window.firebaseRefs.serverTimestamp(),
              ip: window.location.hostname,
              userAgent: navigator.userAgent.substring(0, 100)
            });
          }

          // Emit to Socket.IO
          safeSocketEmit('login-failed', {
            method: 'password',
            username: username,
            error: err.message,
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now()
          });

          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error 429 (Rate Limiting) ‡∏û‡∏¥‡πÄ‡∏®‡∏©
          if (err.message.includes('‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ') ||
            err.message.includes('Too many') ||
            err.message.includes('429')) {
            showRateLimitModal();
            return;
          }

          // Show appropriate error based on response
          if (err.message.includes('credentials') || err.message.includes('password') || err.message.includes('‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')) {
            showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          } else if (err.message.includes('network') || err.message.includes('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠')) {
            showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á', 'error');
          } else {
            showToast('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
          }
        }
      });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° animation ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏à
    window.addEventListener('load', () => {
      // Set default tab
      switchTab('password');

      // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      if (usernameInput) {
        setTimeout(() => usernameInput.focus(), 500);
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
      createDynamicBackgroundElements();

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢
      createScatteringLogos();
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°
    function createDynamicBackgroundElements() {
      const body = document.body;
      const shapes = ['circle', 'square', 'triangle'];
      const sizes = [10, 15, 20, 25, 30];
      const animations = ['float-slow', 'float-medium', 'float-fast'];

      for (let i = 0; i < 8; i++) {
        const shape = shapes[Math.floor(Math.random() * shapes.length)];
        const size = sizes[Math.floor(Math.random() * sizes.length)];
        const animation = animations[Math.floor(Math.random() * animations.length)];

        const element = document.createElement('div');
        element.classList.add('floating', animation, 'glow');

        // Position randomly
        element.style.top = `${Math.random() * 100}%`;
        element.style.left = `${Math.random() * 100}%`;

        // Apply shape
        if (shape === 'circle') {
          element.classList.add('rounded-full');
          element.style.width = `${size}px`;
          element.style.height = `${size}px`;
          element.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
        } else if (shape === 'square') {
          element.classList.add('rounded-md', 'rotate-45');
          element.style.width = `${size}px`;
          element.style.height = `${size}px`;
          element.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
        } else { // triangle
          element.style.width = '0';
          element.style.height = '0';
          element.style.borderLeft = `${size / 2}px solid transparent`;
          element.style.borderRight = `${size / 2}px solid transparent`;
          element.style.borderBottom = `${size}px solid rgba(255, 255, 255, 0.05)`;
        }

        body.appendChild(element);
      }
    }

    // Forgot Password Functions
    function showForgotPassword() {
      const modal = document.getElementById('forgotPasswordModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('forgotUsername').focus();
      }
    }

    function closeForgotPassword() {
      const modal = document.getElementById('forgotPasswordModal');
      if (modal) {
        modal.classList.add('hidden');
        document.getElementById('forgotPasswordForm').reset();
      }
    }

    // Handle forgot password form
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    if (forgotPasswordForm) {
      forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('forgotUsername').value.trim();
        const submitBtn = document.getElementById('forgotSubmitBtn');
        const btnText = document.getElementById('forgotBtnText');
        const spinner = document.getElementById('forgotSpinner');

        if (!username) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
          return;
        }

        // Show loading
        btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
        spinner.classList.remove('hidden');
        submitBtn.disabled = true;

        try {
          const res = await fetch('/api/users/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }

          showToast('‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'success');
          closeForgotPassword();

        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          // Hide loading
          btnText.textContent = '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
          spinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });
    }

    // Close modal on backdrop click
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    if (forgotPasswordModal) {
      forgotPasswordModal.addEventListener('click', (e) => {
        if (e.target === forgotPasswordModal) {
          closeForgotPassword();
        }
      });
    }

    // Close modals on backdrop click
    document.addEventListener('click', (e) => {
      const loginRequestModal = document.getElementById('loginRequestModal');
      const waitingModal = document.getElementById('waitingApprovalModal');

      if (e.target === loginRequestModal) {
        closeLoginRequestModal();
      } else if (e.target === waitingModal) {
        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î modal ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      }
    });

    // Enhanced cleanup on page unload
    window.addEventListener('beforeunload', () => {
      try {
        console.log('üßπ Starting login page cleanup...');

        // Clear QR checking interval
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
          qrCheckInterval = null;
        }

        // Clear heartbeat interval
        if (window.loginHeartbeatInterval) {
          clearInterval(window.loginHeartbeatInterval);
          window.loginHeartbeatInterval = null;
        }

        // Clear rate limit timer
        if (rateLimitTimer) {
          clearInterval(rateLimitTimer);
          rateLimitTimer = null;
        }

        // Unregister QR session
        if (currentSessionId) {
          safeSocketEmit('unregisterQRSession', { sessionId: currentSessionId });
        }

        // Clean disconnect from socket
        if (window.socket && window.socket.connected) {
          try {
            window.socket.disconnect();
          } catch (e) {
            console.warn('Socket disconnect error:', e);
          }
        }

        // Track page unload
        if (typeof trackActivity === 'function') {
          trackActivity('page_unload', {
            timestamp: Date.now(),
            duration: Date.now() - (window.currentSession?.startTime || Date.now()),
            page: 'login'
          });
        }

        // Firebase cleanup
        if (window.firebaseDb && window.currentSession) {
          try {
            if (window.firebaseRefs.sessionRef) {
              window.firebaseRefs.remove(window.firebaseRefs.sessionRef);
            }

            const userRef = window.firebaseRefs.ref(window.firebaseDb, `onlineUsers/login/${window.currentSession.sessionId}`);
            window.firebaseRefs.remove(userRef);
          } catch (e) {
            console.warn('Firebase cleanup error:', e);
          }
        }

        console.log('‚úÖ Login page cleanup completed');
      } catch (error) {
        console.error('‚ùå Cleanup error:', error);
      }
    });

    // JavaScript for Not Checked-In Modal
    function showNotCheckedInModal() {
      const modal = document.getElementById('notCheckedInModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
    }

    function closeNotCheckedInModal() {
      const modal = document.getElementById('notCheckedInModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    // Close modal on backdrop click
    document.getElementById('notCheckedInModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'notCheckedInModal') {
        closeNotCheckedInModal();
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Not Checked-In Modal
    function proceedToRequestApproval() {
      closeNotCheckedInModal();
      // ‡πÄ‡∏õ‡∏¥‡∏î Login Request Modal ‡πÇ‡∏î‡∏¢‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
      showLoginRequestModal(true);
    }

    // Handle quick reason selection
    document.querySelectorAll('input[name="quickReason"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const reasonTextarea = document.getElementById('loginReason');
        if (this.value !== 'other') {
          reasonTextarea.value = this.value;
        } else {
          reasonTextarea.value = '';
          reasonTextarea.focus();
        }
      });
    });

    // Update modal message based on attendance status
    function showLoginRequestModal(isNotCheckedIn = false) {
      const modal = document.getElementById('loginRequestModal');
      const message = document.getElementById('requestModalMessage');

      // Track modal show
      trackActivity('modal_shown', {
        modal: 'login_request',
        reason: isNotCheckedIn ? 'not_checked_in' : 'checked_out',
        timestamp: Date.now()
      });

      // Emit to Socket.IO
      safeSocketEmit('modal-interaction', {
        action: 'show',
        modal: 'login_request',
        sessionId: window.currentSession?.sessionId,
        timestamp: Date.now()
      });

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
      window.loginRequestIsNotCheckedIn = isNotCheckedIn;

      if (isNotCheckedIn) {
        message.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      } else {
        message.textContent = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
      }

      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('loginReason').focus();

        // Reset form
        document.getElementById('loginRequestForm').reset();
        document.querySelectorAll('input[name="quickReason"]').forEach(radio => radio.checked = false);
      }
    }

    // Rate Limit Modal Functions
    let rateLimitTimer = null;

    function showRateLimitModal() {
      const modal = document.getElementById('rateLimitModal');

      // Track rate limit event
      trackActivity('rate_limit_triggered', {
        timestamp: Date.now(),
        duration: 15 * 60 // 15 minutes
      });

      // Track to Firebase security events
      if (window.firebaseDb && window.firebaseRefs.securityEventsRef) {
        window.firebaseRefs.push(window.firebaseRefs.securityEventsRef, {
          type: 'rate_limit',
          severity: 'high',
          message: 'User triggered rate limit protection',
          sessionId: window.currentSession?.sessionId,
          timestamp: window.firebaseRefs.serverTimestamp(),
          ip: window.location.hostname,
          userAgent: navigator.userAgent.substring(0, 100)
        });
      }

      // Emit to Socket.IO
      safeSocketEmit('security-event', {
        type: 'rate_limit',
        sessionId: window.currentSession?.sessionId,
        timestamp: Date.now()
      });

      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        startRateLimitCountdown(15 * 60); // 15 minutes in seconds
      }
    }

    function closeRateLimitModal() {
      const modal = document.getElementById('rateLimitModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (rateLimitTimer) {
          clearInterval(rateLimitTimer);
          rateLimitTimer = null;
        }
      }
    }

    function startRateLimitCountdown(totalSeconds) {
      const countdownEl = document.getElementById('rateLimitCountdown');
      let remainingSeconds = totalSeconds;

      if (rateLimitTimer) {
        clearInterval(rateLimitTimer);
      }

      rateLimitTimer = setInterval(() => {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;

        countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        if (remainingSeconds <= 0) {
          clearInterval(rateLimitTimer);
          rateLimitTimer = null;
          closeRateLimitModal();
          showToast('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        remainingSeconds--;
      }, 1000);
    }

    function contactAdmin() {
      // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
      showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ‡πÇ‡∏ó‡∏£ 02-xxx-xxxx', 'info');
    }
  </script>
</body>

</html>