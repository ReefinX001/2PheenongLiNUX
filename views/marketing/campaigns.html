<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon ‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
  
  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Prompt', 'sans-serif'],
            prompt: ['Prompt', 'sans-serif'],
          },
          boxShadow: {
            'lux': '0 8px 32px 0 rgba(31, 38, 135, 0.18)'
          }
        },
      },
      daisyui: {
        themes: ['luxury', 'dark', 'corporate'],
      },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Flatpickr for date/time picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Animate.css for fade animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  
  <!-- User Profile Manager -->
  <script src="/views/marketing/js/user-profile.js"></script>
  <!-- Sidebar Manager -->
  <script src="/views/marketing/js/sidebar.js"></script>
  
  <!-- Shared Promotion Manager -->
  <script src="/views/shared/js/promotion-manager.js"></script>
  
  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .calendar-day {
      background-color: #374151;
    }

    .calendar-day-holiday {
      background-color: #fee2e2;
      color: #ef4444;
    }

    .dark .calendar-day-holiday {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #notificationBtn span.badge-notification { 
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status indicators */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-active {
      background-color: #10b981;
    }

    .status-away {
      background-color: #f59e0b;
    }

    .status-offline {
      background-color: #6b7280;
    }
    
    /* Dashboard specific styles */
    .main-content {
      flex: 1;
      padding: 20px 30px;
      overflow-y: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .page-title h1 {
      font-size: 1.8rem;
      color: var(--dark-color);
      margin-bottom: 5px;
    }
    
    .page-title p {
      color: var(--gray-color);
      font-size: 0.9rem;
    }
    
    .date-filter select {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      background-color: white;
      font-size: 0.9rem;
      color: #212529;
      cursor: pointer;
    }
    
    .dark .date-filter select {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }
    
    /* Summary Cards Styles */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 1200px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
    }
    
    .dark .card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .card-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.8rem;
      color: white;
    }
    
    .sales-icon {
      background-color: #4361ee;
    }
    
    .customers-icon {
      background-color: #4cc9f0;
    }
    
    .conversion-icon {
      background-color: #4caf50;
    }
    
    .avg-sale-icon {
      background-color: #ff9800;
    }
    
    .card-info h3 {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 5px;
    }
    
    .dark .card-info h3 {
      color: #9ca3af;
    }
    
    .card-info h2 {
      font-size: 1.5rem;
      color: #212529;
      margin-bottom: 5px;
    }
    
    .dark .card-info h2 {
      color: #f3f4f6;
    }
    
    .trend {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }
    
    .trend i {
      margin-right: 5px;
    }
    
    .positive {
      color: #4caf50;
    }
    
    .negative {
      color: #f44336;
    }
    
    /* Charts Container Styles */
    .charts-container {
      margin-bottom: 30px;
    }
    
    .chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 1200px) {
      .chart-row {
        flex-direction: column;
      }
    }
    
    .chart-card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      flex: 1;
    }
    
    .dark .chart-card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .chart-card.large {
      flex: 2;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .dark .chart-header {
      border-bottom-color: #4b5563;
    }
    
    .chart-header h3 {
      font-size: 1.1rem;
      color: #212529;
    }
    
    .dark .chart-header h3 {
      color: #f3f4f6;
    }
    
    .chart-actions button {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .dark .chart-actions button {
      color: #9ca3af;
    }
    
    .chart-content {
      padding: 20px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .map-container {
      background-color: #f0f4f9;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }
    
    .dark .map-container {
      background-color: #374151;
      color: #9ca3af;
    }
    
    /* Data Table Styles */
    .data-table-section {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    .dark .data-table-section {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .data-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .dark .data-table-header {
      border-bottom-color: #4b5563;
    }
    
    .data-table-header h3 {
      font-size: 1.1rem;
      color: #212529;
    }
    
    .dark .data-table-header h3 {
      color: #f3f4f6;
    }
    
    .table-actions {
      display: flex;
      gap: 10px;
    }
    
    .table-actions input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    
    .dark .table-actions input {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }
    
    .export-btn {
      padding: 8px 16px;
      background-color: #4361ee;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .data-table-container {
      overflow-x: auto;
      padding: 10px 20px;
    }
    
    #salesTable {
      width: 100%;
      border-collapse: collapse;
    }
    
    #salesTable th, #salesTable td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    .dark #salesTable th, .dark #salesTable td {
      border-bottom-color: #4b5563;
    }
    
    #salesTable th {
      font-weight: 600;
      color: #6c757d;
    }
    
    .dark #salesTable th {
      color: #9ca3af;
    }
    
    #salesTable tr:last-child td {
      border-bottom: none;
    }
    
    .status-pill {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-complete {
      background-color: rgba(76, 175, 80, 0.15);
      color: #4caf50;
    }
    
    .dark .status-complete {
      background-color: rgba(76, 175, 80, 0.3);
    }
    
    .status-pending {
      background-color: rgba(255, 152, 0, 0.15);
      color: #ff9800;
    }
    
    .dark .status-pending {
      background-color: rgba(255, 152, 0, 0.3);
    }
    
    .status-cancelled {
      background-color: rgba(244, 67, 54, 0.15);
      color: #f44336;
    }
    
    .dark .status-cancelled {
      background-color: rgba(244, 67, 54, 0.3);
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      border-top: 1px solid #e9ecef;
    }
    
    .dark .pagination {
      border-top-color: #4b5563;
    }
    
    .pagination button {
      background: none;
      border: none;
      color: #4361ee;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    .dark .pagination button {
      color: #93c5fd;
    }
    
    .pagination button:disabled {
      color: #e9ecef;
      cursor: not-allowed;
    }
    
    .dark .pagination button:disabled {
      color: #4b5563;
    }
    
    .pagination span {
      margin: 0 15px;
      color: #6c757d;
    }
    
    .dark .pagination span {
      color: #9ca3af;
    }
    
    /* === Promotion page specific styles === */
    body { font-family: 'Prompt', sans-serif; /* background moved to <body> */ }
    .promotion-card { transition: all 0.3s cubic-bezier(.25,.8,.25,1); }
    .promotion-card:hover { transform: translateY(-4px) scale(1.025); box-shadow: 0 8px 24px rgba(0,0,0,0.11); }
    .modal.modal-open { display: flex; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.18); align-items: center; justify-content: center; z-index: 50; }
    .modal-box { background: #fff; border-radius: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.18); }
    .tab.tab-active { background: #facc15 !important; color: #1e293b !important; }
    .tab { font-weight: 500; }
    .fade-in { animation: fadein .25s ease; }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(16px);}
      to { opacity: 1; transform: none;}
    }
    .shadow-card { box-shadow: 0 4px 20px rgba(0,0,0,0.06);}
    .input:focus, .select:focus, .textarea:focus {
      border-color: #f59e42; box-shadow: 0 0 0 1px #f59e42;
    }
    .btn-primary { background: linear-gradient(90deg,#f59e42 0%,#fbbf24 100%); border: none; color: #fff;}
    .btn-primary:hover { background: linear-gradient(90deg,#fb923c 0%,#facc15 100%);}
    .btn-secondary { background: #fff7ed; border: 1px solid #f59e42; color: #f59e42;}
    .btn-secondary:hover { background: #fef3c7;}
    .badge-success { background: #d1fae5; color: #059669;}
    .badge-warning { background: #fef9c3; color: #b45309;}
    .badge-error { background: #fee2e2; color: #e11d48;}
    .badge-ghost { background: #f3f4f6; color: #64748b;}
    .modal-action .btn { min-width: 112px; }
    .select, .input, .textarea { background: #f8fafc;}
    /* Hide default number spinners */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0;}
    input[type=number] { -moz-appearance: textfield;}
    /* Responsive modal */
    @media (max-width: 768px) {
      .modal-box { max-width: 98vw; width: 98vw; padding: 1rem; }
    }

    /* Sales Type Tabs */
    .sales-type-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: #f3f4f6; /* Light gray background for the container */
      padding: 5px; /* Padding around the tabs */
      border-radius: 10px; /* Rounded corners for the container */
    }

    .sales-type-tab {
      flex: 1; /* Distribute space equally */
      padding: 10px 20px;
      border-radius: 8px; /* Rounded corners for individual tabs */
      background: transparent; /* Default transparent background */
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex; /* For aligning icon, text, and badge */
      align-items: center;
      justify-content: center;
      gap: 8px; /* Space between icon, text, and badge */
    }

    .sales-type-tab.active {
      background: white; /* White background for active tab */
      color: #f59e42; /* Orange text color for active tab */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for active tab */
    }
    
    .sales-type-badge {
      background-color: #e5e7eb; /* Default badge background */
      color: #4b5563; /* Default badge text color */
      padding: 2px 8px;
      border-radius: 12px; /* Pill shape */
      font-size: 0.75rem; /* Smaller font size */
      font-weight: 600;
    }

    .sales-type-tab.active .sales-type-badge {
      background-color: #f59e42; /* Orange background for badge in active tab */
      color: white; /* White text for badge in active tab */
    }

    /* Dark mode support for sales type tabs */
    .dark .sales-type-tabs {
      background: #374151; /* Dark gray background for the container */
    }

    .dark .sales-type-tab {
      color: #d1d5db; /* Light gray text for inactive tabs */
    }

    .dark .sales-type-tab.active {
      background: #1f2937; /* Dark background for active tab */
      color: #f59e42; /* Keep orange text color for active tab */
    }

    .dark .sales-type-badge {
      background-color: #4b5563; /* Dark badge background */
      color: #d1d5db; /* Light badge text color */
    }

    .dark .sales-type-tab.active .sales-type-badge {
      background-color: #f59e42; /* Orange background for badge in active tab */
      color: white; /* White text for badge in active tab */
    }

    /* Dark mode support for form elements */
    .dark select {
      color: #f3f4f6;
    }

    .dark select option {
      background-color: #374151;
      color: #f3f4f6;
    }

    .dark input::placeholder {
      color: #9ca3af;
    }

  </style>

  <script>
    let lottieAnimation = null;
  </script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900 dark:bg-gray-700 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen flex">
    <!-- Sidebar Container -->
    <div id="sidebar-container">
      <!-- Sidebar content will be loaded here -->
    </div>
    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-white dark:bg-gray-800 shadow-card border-b dark:border-gray-600 sticky top-0 z-40 fade-in">
        <div class="container mx-auto px-4 py-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-megaphone-fill text-orange-500 text-3xl"></i>
              ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
            </h1>
            <button onclick="openCreateModal()" class="btn btn-primary flex items-center gap-2 shadow">
              <i class="bi bi-plus-circle"></i>
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <section class="container mx-auto px-4 py-4">
        <div class="sales-type-tabs">
          <button class="sales-type-tab active" onclick="switchMainTab('promotions')">
            <i class="bi bi-megaphone-fill"></i>
            <span>‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</span>
            <span class="sales-type-badge" id="promotionsCount">0</span>
          </button>
          <button class="sales-type-tab" onclick="switchMainTab('analytics')">
            <i class="bi bi-graph-up"></i>
            <span>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
            <span class="sales-type-badge" id="analyticsCount">üìä</span>
          </button>
          <button class="sales-type-tab" onclick="switchMainTab('templates')">
            <i class="bi bi-file-earmark-text"></i>
            <span>‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</span>
            <span class="sales-type-badge" id="templatesCount">üìã</span>
          </button>
          <button class="sales-type-tab" onclick="switchMainTab('notifications')">
            <i class="bi bi-bell"></i>
            <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
            <span class="sales-type-badge" id="notificationsCount">0</span>
          </button>
        </div>

        <!-- Sub Tabs for Promotions -->
        <div id="promotionSubTabs" class="sales-type-tabs mt-4">
          <button class="sales-type-tab active" onclick="switchSalesType('all')">
            <i class="bi bi-grid-3x3-gap"></i>
            <span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            <span class="sales-type-badge" id="allCount">0</span>
          </button>
          <button class="sales-type-tab" onclick="switchSalesType('cash')">
            <i class="bi bi-cash-stack"></i>
            <span>‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>
            <span class="sales-type-badge" id="cashCount">0</span>
          </button>
          <button class="sales-type-tab" onclick="switchSalesType('installment')">
            <i class="bi bi-credit-card"></i>
            <span>‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>
            <span class="sales-type-badge" id="installmentCount">0</span>
          </button>
        </div>
      </section>

      <!-- Filters -->
      <section class="container mx-auto px-4 py-6 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
          <h3 class="text-lg font-semibold mb-4 text-orange-600 dark:text-orange-400 flex items-center gap-2"><i class="bi bi-funnel"></i> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="filterStatus" class="select select-bordered w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                <option value="upcoming">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤</option>
                <option value="expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">‡∏™‡∏≤‡∏Ç‡∏≤</label>
              <select id="filterBranch" class="select select-bordered w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                <!-- will be populate -->
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300 font-semibold mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <select id="filterType" class="select select-bordered w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                <option value="discount_percentage">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î %</option>
                <option value="discount_amount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="special_price">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                <option value="buy_x_get_y">‡∏ã‡∏∑‡πâ‡∏≠ X ‡πÅ‡∏ñ‡∏° Y</option>
                <option value="bundle">‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Bundle)</option>
                <optgroup label="‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô" id="installmentTypes">
                  <option value="installment_discount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡πà‡∏≠‡∏ô</option>
                  <option value="installment_free_interest">‡∏ú‡πà‡∏≠‡∏ô 0%</option>
                  <option value="installment_special_terms">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡πà‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                  <option value="installment_down_payment_discount">‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</option>
                  <option value="installment_gift">‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô</option>
                </optgroup>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="applyFilters()" class="btn btn-secondary w-full flex items-center gap-2 shadow">
                <i class="bi bi-funnel"></i> ‡∏Å‡∏£‡∏≠‡∏á
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Summary Cards -->
      <div class="summary-cards container mx-auto px-4 mb-6">
        <div class="card">
          <div class="card-icon bg-orange-500">
            <i class="bi bi-megaphone"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <h2 class="text-2xl font-semibold">18</h2>
            <p class="trend positive"><i class="bi bi-arrow-up"></i> 3 ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡πÉ‡∏´‡∏°‡πà</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-green-500">
            <i class="bi bi-play-circle"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <h2 class="text-2xl font-semibold">7</h2>
            <p class="trend positive"><i class="bi bi-arrow-up"></i> 2 ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-blue-600">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</h3>
            <h2 class="text-2xl font-semibold">8</h2>
            <p class="trend negative"><i class="bi bi-arrow-down"></i> 1 ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-yellow-500">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h3>
            <h2 class="text-2xl font-semibold">75.4%</h2>
            <p class="trend positive"><i class="bi bi-arrow-up"></i> 12.7% ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</p>
          </div>
        </div>
      </div>

      <!-- Promotions Content -->
      <div id="promotionsContent">
        <!-- Promotions List -->
        <section class="container mx-auto px-4 pb-6 fade-in">
          <div id="promotionsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-7">
            <!-- Promotion cards will be inserted here -->
          </div>
        </section>
      </div>

      <!-- Analytics Dashboard Content -->
      <div id="analyticsContent" style="display: none;">
        <!-- Analytics Cards -->
        <section class="container mx-auto px-4 py-6">
          <div id="analyticsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="card">
              <div class="card-icon bg-green-600">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <div class="card-info">
                <h3 class="text-gray-500 dark:text-gray-400">ROI ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                <h2 class="text-2xl font-semibold" id="avgROI">-</h2>
                <p class="trend positive"><i class="bi bi-arrow-up"></i> ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
              </div>
            </div>
            <div class="card">
              <div class="card-icon bg-blue-600">
                <i class="bi bi-people-fill"></i>
              </div>
              <div class="card-info">
                <h3 class="text-gray-500 dark:text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <h2 class="text-2xl font-semibold" id="totalUsage">-</h2>
                <p class="trend neutral">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              </div>
            </div>
            <div class="card">
              <div class="card-icon bg-purple-600">
                <i class="bi bi-percent"></i>
              </div>
              <div class="card-info">
                <h3 class="text-gray-500 dark:text-gray-400">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á</h3>
                <h2 class="text-2xl font-semibold" id="conversionRate">-</h2>
                <p class="trend positive">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•</p>
              </div>
            </div>
            <div class="card">
              <div class="card-icon bg-orange-600">
                <i class="bi bi-star-fill"></i>
              </div>
              <div class="card-info">
                <h3 class="text-gray-500 dark:text-gray-400">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                <h2 class="text-2xl font-semibold" id="avgUsage">-</h2>
                <p class="trend neutral">‡∏ï‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Top Performing Promotions -->
        <section class="container mx-auto px-4 pb-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                <i class="bi bi-trophy"></i> ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
              </h3>
              <select id="analyticsDateRange" class="select select-bordered select-sm">
                <option value="7">7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                <option value="30">30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
                <option value="90">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</option>
              </select>
            </div>
            <div id="topPerformingList" class="space-y-4">
              <!-- Top performing promotions will be loaded here -->
            </div>
          </div>
        </section>

        <!-- Analytics Chart -->
        <section class="container mx-auto px-4 pb-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Usage Trends -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
                <i class="bi bi-graph-up"></i> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
              </h3>
              <div id="usageChart" class="h-64 flex items-center justify-center text-gray-500">
                <div class="text-center">
                  <i class="bi bi-bar-chart text-4xl mb-2"></i>
                  <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                  <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</small>
                </div>
              </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
                <i class="bi bi-clock-history"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
              </h3>
              <div id="recentActivities" class="space-y-4">
                <!-- Recent activities will be loaded here -->
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Templates Content -->
      <div id="templatesContent" style="display: none;">
        <section class="container mx-auto px-4 py-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
              <i class="bi bi-file-earmark-text"></i> ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
            </h3>
            <div id="templatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Templates will be loaded here -->
            </div>
          </div>
        </section>
      </div>

      <!-- Notifications Content -->
      <div id="notificationsContent" style="display: none;">
        <section class="container mx-auto px-4 py-6">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                <i class="bi bi-bell"></i> ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              </h3>
              <button onclick="refreshNotifications()" class="btn btn-sm btn-ghost">
                <i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
              </button>
            </div>
            <div id="notificationsList">
              <!-- Notifications will be loaded here -->
            </div>
          </div>
        </section>
      </div>

      <!-- Additional sections can be added here if needed -->

      <!-- Create/Edit Modal -->
      <div id="promotionModal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
          <h3 class="font-bold text-lg mb-4 flex gap-2 items-center" id="modalTitle">
            <i class="bi bi-megaphone-fill text-orange-500"></i>
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
          </h3>
          <!-- Sales Type Selection -->
          <div>
            <label class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ <span class="text-error">*</span></label>
            <div class="flex flex-wrap gap-4">
              <label class="cursor-pointer flex items-center">
                <input type="radio" name="salesType" value="cash" required class="radio radio-primary" onchange="toggleSalesTypeFields()" />
                <span class="ml-2"><i class="bi bi-cash-stack mr-1"></i>‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>
              </label>
              <label class="cursor-pointer flex items-center">
                <input type="radio" name="salesType" value="installment" required class="radio radio-primary" onchange="toggleSalesTypeFields()" />
                <span class="ml-2"><i class="bi bi-credit-card mr-1"></i>‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>
              </label>
              <label class="cursor-pointer flex items-center">
                <input type="radio" name="salesType" value="both" required class="radio radio-primary" checked onchange="toggleSalesTypeFields()" />
                <span class="ml-2"><i class="bi bi-grid-3x3-gap mr-1"></i>‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
              </label>
            </div>
          </div>
          <form id="promotionForm" class="space-y-4 mt-4">
            <!-- Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô <span class="text-error">*</span></label>
                <input type="text" name="name" required class="input input-bordered w-full" maxlength="64"/>
              </div>
              <div>
                <label class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô <span class="text-error">*</span></label>
                <select name="type" required class="select select-bordered w-full" onchange="togglePromotionFields()">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                  <option value="discount_percentage">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î %</option>
                  <option value="discount_amount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô</option>
                  <option value="special_price">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                  <option value="buy_x_get_y">‡∏ã‡∏∑‡πâ‡∏≠ X ‡πÅ‡∏ñ‡∏° Y</option>
                  <option value="bundle">‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Bundle)</option>
                  <optgroup label="‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô" id="installmentTypes">
                    <option value="installment_discount">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡πà‡∏≠‡∏ô</option>
                    <option value="installment_free_interest">‡∏ú‡πà‡∏≠‡∏ô 0%</option>
                    <option value="installment_special_terms">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡πà‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                    <option value="installment_down_payment_discount">‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</option>
                    <option value="installment_gift">‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô</option>
                  </optgroup>
                </select>
              </div>
            </div>
            <div>
              <label class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
              <textarea name="description" rows="2" class="textarea textarea-bordered w-full" maxlength="255"></textarea>
            </div>
            <!-- Type-specific fields -->
            <div id="typeSpecificFields" class="space-y-4 hidden">
              <div id="discountFields" class="hidden">
                <label class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                <div class="flex gap-2">
                  <input type="number" name="discountValue" min="0" class="input input-bordered flex-1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10"/>
                  <span class="flex items-center px-4" id="discountUnit">%</span>
                </div>
              </div>
              <div id="specialPriceField" class="hidden">
                <label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                <input type="number" name="specialPrice" min="0" step="0.01" class="input input-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 199.00"/>
              </div>
              <div id="buyGetFields" class="hidden grid grid-cols-2 gap-4">
                <div>
                  <label class="label">‡∏ã‡∏∑‡πâ‡∏≠ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                  <input type="number" name="buyQuantity" min="1" class="input input-bordered w-full" />
                </div>
                <div>
                  <label class="label">‡πÅ‡∏ñ‡∏° (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                  <input type="number" name="getQuantity" min="1" class="input input-bordered w-full" />
                </div>
              </div>
              
              <div id="bundleFields" class="hidden space-y-4">
                <div>
                  <label class="label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∏‡∏î <span class="text-error">*</span></label>
                  <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î..." class="input input-bordered w-full mb-3" onkeyup="searchBundleProducts(this.value)" />
                  <div id="bundleProductList" class="max-h-40 overflow-y-auto border rounded p-3 bg-gray-50 space-y-2">
                    <!-- Bundle product checkboxes will be inserted here -->
                  </div>
                  <div class="text-xs text-gray-500 mt-2">
                    <i class="bi bi-info-circle mr-1"></i>
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                  </div>
                </div>
                <div>
                  <label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î <span class="text-error">*</span></label>
                  <div class="relative">
                    <input type="number" name="bundlePrice" min="0" step="0.01" class="input input-bordered w-full pr-12" placeholder="‡πÄ‡∏ä‡πà‡∏ô 499.00"/>
                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">‡∏ö‡∏≤‡∏ó</span>
                  </div>
                </div>
              </div>

              <!-- ‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå -->
              <div id="installmentDownPaymentDiscountFields" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" name="downPaymentDiscountAmount" min="0" class="input input-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000"/>
                  </div>
                  <div>
                    <label class="label">‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</label>
                    <input type="number" name="downPaymentDiscountPercent" min="0" max="100" class="input input-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50"/>
                  </div>
                </div>
                <div class="alert alert-info text-sm p-3">
                  <i class="bi bi-info-circle"></i>
                  <span>‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</span>
                </div>
                <div>
                  <label class="label">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå)</label>
                  <select name="installmentMonthsCondition" class="select select-bordered w-full">
                    <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</option>
                    <option value="6">‡∏ú‡πà‡∏≠‡∏ô 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
                    <option value="10">‡∏ú‡πà‡∏≠‡∏ô 10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
                    <option value="12">‡∏ú‡πà‡∏≠‡∏ô 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
                    <option value="18">‡∏ú‡πà‡∏≠‡∏ô 18 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
                    <option value="24">‡∏ú‡πà‡∏≠‡∏ô 24 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
                  </select>
                </div>
              </div>

              <!-- ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô -->
              <div id="installmentGiftFields" class="hidden space-y-4">
                <div>
                  <label class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° <span class="text-error">*</span></label>
                  <textarea name="giftDetail" rows="3" class="textarea textarea-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ñ‡∏°‡∏´‡∏π‡∏ü‡∏±‡∏á Bluetooth ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 990 ‡∏ö‡∏≤‡∏ó ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏ñ‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 1 ‡∏õ‡∏µ"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" name="giftValue" min="0" class="input input-bordered w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 990"/>
                  </div>
                  <div>
                    <label class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°</label>
                    <input type="number" name="giftQuantity" min="1" value="1" class="input input-bordered w-full"/>
                  </div>
                </div>
                <div>
                  <label class="label">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô)</label>
                  <select name="giftCondition" class="select select-bordered w-full">
                    <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</option>
                    <option value="min_6_months">‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="min_10_months">‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="min_12_months">‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="min_amount_30000">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 30,000 ‡∏ö‡∏≤‡∏ó</option>
                    <option value="min_amount_50000">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 50,000 ‡∏ö‡∏≤‡∏ó</option>
                  </select>
                </div>
              </div>
            </div>
            <!-- Date Range -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span class="text-error">*</span></label>
                <input type="text" id="startDate" name="startDate" required class="input input-bordered w-full" autocomplete="off" />
              </div>
              <div>
                <label class="label">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="text-error">*</span></label>
                <input type="text" id="endDate" name="endDate" required class="input input-bordered w-full" autocomplete="off" />
              </div>
            </div>
            <!-- Applicable Items -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</label>
                <div class="tabs tabs-boxed mb-2" id="productTabsContainer">
                  <button type="button" class="tab tab-active" onclick="switchTab('all', this)">‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                  <button type="button" class="tab" onclick="switchTab('category', this)">‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
                  <button type="button" class="tab" onclick="switchTab('specific', this)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>
                <div id="productSelection">
                  <div id="allProductsTab" class="text-center py-4 text-gray-500">
                    <i class="bi bi-check-circle text-3xl text-green-500"></i>
                    <p class="mt-2">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                  </div>
                  <div id="categoryTab" class="hidden">
                    <div id="categoryList" class="flex flex-wrap gap-2">
                      <!-- Category checkboxes will be loaded from API -->
                    </div>
                  </div>
                  <div id="specificTab" class="hidden">
                    <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="input input-bordered w-full mb-3" onkeyup="searchProducts(this.value)" />
                    <div id="productList" class="max-h-44 overflow-y-auto space-y-2">
                      <!-- Product checkboxes will be inserted here -->
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <label class="label">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</label>
                <div class="tabs tabs-boxed mb-2" id="branchTabsContainer">
                  <button type="button" class="tab tab-active" onclick="switchBranchTab('all', this)">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</button>
                  <button type="button" class="tab" onclick="switchBranchTab('specific', this)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</button>
                </div>
                <div id="branchSelection">
                  <div id="allBranchesTab" class="text-center py-4 text-gray-500">
                    <i class="bi bi-shop text-3xl text-blue-500"></i>
                    <p class="mt-2">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</p>
                  </div>
                  <div id="specificBranchesTab" class="hidden">
                    <div id="branchList" class="max-h-32 overflow-y-auto space-y-2">
                      <!-- Branch checkboxes will be inserted here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Additional Conditions -->
            <div class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
              <input type="checkbox" id="additional-conditions-toggle" />
              <div class="collapse-title text-lg font-medium">
                <i class="bi bi-gear-wide mr-2"></i>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
              </div>
              <div class="collapse-content space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="label">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                    <input type="number" name="minPurchaseAmount" min="0" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö %)</label>
                    <input type="number" name="maxDiscountAmount" min="0" class="input input-bordered w-full" />
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="label">‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</label>
                    <input type="number" name="usageLimit" min="0" class="input input-bordered w-full" placeholder="‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î" />
                  </div>
                  <div>
                    <label class="label">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                    <input type="number" name="priority" min="1" value="100" class="input input-bordered w-full" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Installment Conditions (Initially Hidden) -->
            <div id="installmentConditions" class="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box hidden">
              <input type="checkbox" id="installment-conditions-toggle" />
              <div class="collapse-title text-lg font-medium">
                <i class="bi bi-credit-card-2-front mr-2"></i>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
              </div>
              <div class="collapse-content">
                <div>
                  <label class="label">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ú‡πà‡∏≠‡∏ô)</label>
                  <select name="financePartners" multiple class="select select-bordered w-full" size="5" id="financePartnersList">
                    <!-- Finance partners will be loaded from API -->
                  </select>
                  <div class="text-xs text-gray-500 mt-1">‡∏Å‡∏î Ctrl (‡∏´‡∏£‡∏∑‡∏≠ Cmd ‡∏ö‡∏ô Mac) ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏∏‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå" ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
                </div>
                <!-- Original content for interestDiscount and installmentMonths removed as per request -->
                <!-- If these are still needed for other installment types, they should be added back or handled differently -->
              </div>
            </div>

            <div class="modal-action flex justify-end gap-4">
              <button type="button" onclick="closeModal()" class="btn btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="btn btn-primary flex gap-2 items-center">
                <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script>
    let isLoading = false;  // ‡πÄ‡∏û‡∏¥‡πà‡∏° loading state

    // Helper function for formatting price
    function formatPrice(n) {
      if (n === undefined || n === null || isNaN(n)) return '0';
      return Number(n).toLocaleString('th-TH', { minimumFractionDigits: 0 });
    }

    const socket = io();
    let editingPromotionId = null;
    let allProducts = [];
    let allBranches = [];
    let promotionsRaw = [];
    let currentBranchCode = null; // Will be set from user profile or branch selection
    let currentSalesType = 'all'; // Added
    // window.activePromotions should be populated elsewhere if checkPromotionsLocally is to be fully functional

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á token
    function getAuthToken() {
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      if (!token) {
        console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö token, ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login...');
        // Clear any potentially stale tokens
        localStorage.removeItem('token');
        localStorage.removeItem('authToken');
        window.location.href = '/login'; // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        return null;
      }
      return token;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á headers
    function getAuthHeaders() {
      const token = getAuthToken();
      if (!token) return null; // Should have been redirected by getAuthToken already
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // (1) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å HTML ‡∏ó‡∏µ‡πà scope ‡∏´‡∏•‡∏±‡∏Å
    function openCreateModal() {
      editingPromotionId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-megaphone-fill text-orange-500"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô';
      document.getElementById('promotionForm').reset();
      // Reset salesType radio to 'both'
      document.querySelector('input[name="salesType"][value="both"]').checked = true;
      toggleSalesTypeFields(); // Call this to set initial state of dependent fields

      document.querySelectorAll('.tabs .tab').forEach((t,i) => t.classList.toggle('tab-active', i===0));
      document.getElementById('allProductsTab').classList.remove('hidden');
      document.getElementById('categoryTab').classList.add('hidden');
      document.getElementById('specificTab').classList.add('hidden');
      document.getElementById('allBranchesTab').classList.remove('hidden');
      document.getElementById('specificBranchesTab').classList.add('hidden');
      document.getElementById('typeSpecificFields').classList.add('hidden');
      document.querySelectorAll('#discountFields, #specialPriceField, #buyGetFields, #bundleFields, #installmentDownPaymentDiscountFields, #installmentGiftFields')
        .forEach(el => el.classList.add('hidden'));
      document.getElementById('promotionModal').classList.add('modal-open');
    }

    function closeModal() {
      document.getElementById('promotionModal').classList.remove('modal-open');
    }

    function togglePromotionFields() {
      const type = document.querySelector('[name="type"]').value;
      const container = document.getElementById('typeSpecificFields');
      document.querySelectorAll('#discountFields, #specialPriceField, #buyGetFields, #bundleFields, #installmentDownPaymentDiscountFields, #installmentGiftFields').forEach(el => {
        el.classList.add('hidden');
      });
      if (type) {
        container.classList.remove('hidden');
        switch(type) {
          case 'discount_percentage':
            document.getElementById('discountFields').classList.remove('hidden');
            document.getElementById('discountUnit').textContent = '%';
            document.querySelector('[name="discountValue"]').setAttribute('max','100');
            break;
          case 'discount_amount':
            document.getElementById('discountFields').classList.remove('hidden');
            document.getElementById('discountUnit').textContent = '‡∏ö‡∏≤‡∏ó';
            document.querySelector('[name="discountValue"]').removeAttribute('max');
            break;
          case 'special_price':
            document.getElementById('specialPriceField').classList.remove('hidden');
            break;
          case 'buy_x_get_y':
            document.getElementById('buyGetFields').classList.remove('hidden');
            break;
          case 'bundle':
            document.getElementById('bundleFields').classList.remove('hidden');
            displayBundleProductList();
            break;
          // Add cases for new installment types if they need specific fields beyond the general installmentConditions block
          case 'installment_discount':
          case 'installment_free_interest':
          case 'installment_special_terms':
            // These might not need specific fields here if handled by installmentConditions block
            // Or if they have their own specific fields, add them here.
            break;
          case 'installment_down_payment_discount':
            document.getElementById('installmentDownPaymentDiscountFields').classList.remove('hidden');
            break;
          case 'installment_gift':
            document.getElementById('installmentGiftFields').classList.remove('hidden');
            break;
        }
      } else {
        container.classList.add('hidden');
      }
    }

    function switchTab(tab, el) {
      document.querySelectorAll('#productTabsContainer .tab').forEach(t => t.classList.remove('tab-active'));
      if (el) el.classList.add('tab-active');
      document.getElementById('allProductsTab').classList.add('hidden');
      document.getElementById('categoryTab').classList.add('hidden');
      document.getElementById('specificTab').classList.add('hidden');
      if(tab === 'all') document.getElementById('allProductsTab').classList.remove('hidden');
      if(tab === 'category') document.getElementById('categoryTab').classList.remove('hidden');
      if(tab === 'specific') document.getElementById('specificTab').classList.remove('hidden');
    }

    function switchBranchTab(tab, el) {
      document.querySelectorAll('#branchTabsContainer .tab').forEach(t => t.classList.remove('tab-active'));
      if (el) el.classList.add('tab-active');
      document.getElementById('allBranchesTab').classList.toggle('hidden', tab !== 'all');
      document.getElementById('specificBranchesTab').classList.toggle('hidden', tab === 'all');
    }

    // Debounce ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let searchTimeout;
    function searchProducts(query) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
        displayProductList(filtered);
      }, 300);
    }

    // Debounce ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡∏∏‡∏î
    let bundleSearchTimeout;
    function searchBundleProducts(query) {
      clearTimeout(bundleSearchTimeout);
      bundleSearchTimeout = setTimeout(() => {
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
        displayBundleProductList(filtered);
      }, 300);
    }

    // Socket events with real-time updates
    socket.on('promotionCreated', (data) => {
      console.log('üéâ New promotion created:', data);
      loadPromotions();
      showToast('üéâ ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà!', 'success');
    });
    
    socket.on('promotionUpdated', (data) => {
      console.log('üìù Promotion updated:', data);
      loadPromotions();
      showToast('üìù ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï', 'info');
    });
    
    socket.on('promotionDeleted', (data) => {
      console.log('üóëÔ∏è Promotion deleted:', data);
      loadPromotions();
      showToast('üóëÔ∏è ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'warning');
    });
    
    socket.on('promotionUsed', (data) => {
      console.log('üéÅ Promotion used:', data);
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö real-time
      updatePromotionUsage(data.promotionId, data.usageCount);
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ö real-time
    function updatePromotionUsage(promotionId, newUsageCount) {
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô promotionsRaw
      const promoIndex = promotionsRaw.findIndex(p => p._id === promotionId);
      if (promoIndex !== -1) {
        promotionsRaw[promoIndex].usageCount = newUsageCount;
    
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏ö‡∏ö real-time ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        const promoCard = document.querySelector(`[data-promo-id="${promotionId}"]`);
        if (promoCard) {
          const usageElement = promoCard.querySelector('.usage-info');
          const promo = promotionsRaw[promoIndex];
          if (usageElement && promo.usageLimit) {
            const percentage = Math.min((newUsageCount / promo.usageLimit) * 100, 100);
            usageElement.innerHTML = `
              <i class="bi bi-people-fill mr-2"></i>
              ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ${newUsageCount} / ${promo.usageLimit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
              </div>
            `;
          }
        }
    
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï summary cards
        updateSummaryCards();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Toast notification
    function showToast(message, type = 'info') {
      // ‡πÉ‡∏ä‡πâ SweetAlert2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á notification
      const icon = type === 'success' ? 'success' :
                   type === 'warning' ? 'warning' :
                   type === 'error' ? 'error' : 'info';
    
      Swal.fire({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        icon: icon,
        title: message
      });
    }

    // New JS Functions
    function switchSalesType(type) {
      currentSalesType = type;
      document.querySelectorAll('.sales-type-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      // Ensure event.target is available or find the button by type
      const clickedButton = Array.from(document.querySelectorAll('.sales-type-tab')).find(btn => btn.getAttribute('onclick').includes(`'${type}'`));
      if (clickedButton) {
        clickedButton.classList.add('active');
      }
      applyFilters();
    }

    function toggleSalesTypeFields() {
      const salesType = document.querySelector('[name="salesType"]:checked')?.value;
      const promotionTypeSelect = document.querySelector('[name="type"]');
      const installmentTypesOptgroup = document.getElementById('installmentTypes');
      const installmentConditionsDiv = document.getElementById('installmentConditions');

      // Enable/disable promotion type options based on salesType
      promotionTypeSelect.querySelectorAll('optgroup[label="‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô"] option, option[value^="installment_"]').forEach(opt => {
        opt.disabled = (salesType === 'cash');
      });
    
      if (salesType === 'cash') {
        installmentTypesOptgroup.style.display = 'none';
        if (installmentConditionsDiv) installmentConditionsDiv.classList.add('hidden');
        // If current promotion type is an installment type, reset it
        if (promotionTypeSelect.value.startsWith('installment_')) {
          promotionTypeSelect.value = ''; // Or to a default cash type
          togglePromotionFields(); // Update specific fields based on new type
        }
      } else {
        installmentTypesOptgroup.style.display = 'block'; // or 'table-row-group' or ''
        if (installmentConditionsDiv) installmentConditionsDiv.classList.remove('hidden');
      }
    }


    function updateSalesTypeCounts() {
      let allCount = 0; // Will be set by total promotions that match current filters (excluding sales type)
      let cashCount = 0;
      let installmentCount = 0;
    
      // This count should reflect promotionsRaw or the currently filtered list before salesType filter
      const baseFilteredPromotions = getBaseFilteredPromotions(); // Helper to get promotions based on other filters

      baseFilteredPromotions.forEach(p => {
        if (p.salesType === 'cash') cashCount++;
        else if (p.salesType === 'installment') installmentCount++;
        else if (p.salesType === 'both') {
          cashCount++;
          installmentCount++;
        }
      });
      allCount = baseFilteredPromotions.length; // Total before sales type specific filtering
    
      document.getElementById('allCount').textContent = allCount;
      document.getElementById('cashCount').textContent = cashCount;
      document.getElementById('installmentCount').textContent = installmentCount;
    }

    // Helper function to get promotions based on filters other than salesType
    // This is needed for accurate counts on the sales type tabs
    function getBaseFilteredPromotions() {
        const status = document.getElementById('filterStatus').value;
        const branch = document.getElementById('filterBranch').value;
        const type = document.getElementById('filterType').value;
        const now = new Date();
        let filtered = promotionsRaw;

        if (status !== 'all') {
            filtered = filtered.filter(promo => {
                const startDate = new Date(promo.startDate);
                const endDate = new Date(promo.endDate);
                if (status === 'active') return now >= startDate && now <= endDate && promo.isActive;
                if (status === 'upcoming') return now < startDate;
                if (status === 'expired') return now > endDate;
                return true;
            });
        }
        if (branch !== 'all') {
            filtered = filtered.filter(promo => promo.applicableBranches?.includes(branch) || promo.applicableBranches?.length === 0);
        }
        if (type !== 'all') {
            filtered = filtered.filter(promo => promo.type === type);
        }
        return filtered;
    }


    // Load functions
    async function loadBranches() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch('/api/branch', { headers });
        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadBranches)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (!data.data) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å API');
        }
        allBranches = data.data;
        // Populate branch filter
        const branchFilter = document.getElementById('filterBranch');
        allBranches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch.branch_code;
          option.textContent = branch.name;
          branchFilter.appendChild(option);
        });
        // Populate branch checkboxes
        const branchList = document.getElementById('branchList');
        branchList.innerHTML = allBranches.map(branch => `
          <label class="cursor-pointer flex items-center p-2 hover:bg-gray-50 rounded">
            <input type="checkbox" name="branches" value="${branch.branch_code}" class="checkbox checkbox-sm" />
            <span class="ml-2">${branch.name}</span>
          </label>
        `).join('');
      } catch (err) {
        console.error('Error loading branches:', err);
      }
    }

    async function loadCategories() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch('/api/category/public', { headers });
        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadCategories)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          if (res.status === 403) {
            console.warn('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á categories - ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î');
            return; // Skip loading categories but continue
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (!data.data) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏≤‡∏Å API');
        }
        const categories = data.data;
    
        // Populate category checkboxes
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = categories.map(category => `
          <label class="cursor-pointer">
            <input type="checkbox" name="categories" value="${category.code || category._id}" class="checkbox checkbox-primary" />
            <span class="ml-2">${category.name}</span>
          </label>
        `).join('');
      } catch (err) {
        console.error('Error loading categories:', err);
        // Fallback to empty state
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = '<div class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏î‡πâ</div>';
      }
    }

    async function loadFinancePartners() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch('/api/finance-partners', { headers });

        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadFinancePartners)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        if (!data.data) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Finance Partners ‡∏à‡∏≤‡∏Å API');
        }
        const financePartners = data.data;
    
        // Populate finance partners select
        const financePartnersList = document.getElementById('financePartnersList');
        financePartnersList.innerHTML = financePartners.map(partner => `
          <option value="${partner.code}">${partner.name}</option>
        `).join('');
    
      } catch (err) {
        console.error('Error loading finance partners:', err);
        // Fallback to basic options
        const financePartnersList = document.getElementById('financePartnersList');
        financePartnersList.innerHTML = `
          <option value="all">‡∏ó‡∏∏‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå</option>
          <option value="ktc">KTC</option>
          <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
          <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
          <option value="bbl">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
          <option value="krungsri">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ</option>
        `;
      }
    }

    async function loadProducts() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch('/api/product-image', { headers });
        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadProducts)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (!data.data) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API');
        }
        allProducts = data.data;
        displayProductList();
      } catch (err) {
        console.error('Error loading products:', err);
      }
    }

    async function loadPromotions() {
      // show loading placeholder
      document.getElementById('promotionsList').innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="loading loading-spinner loading-lg text-orange-500"></div>
          <p class="mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>`;
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch('/api/promotion', { headers });
    
        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadPromotions)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        if (!data.data) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏≤‡∏Å API');
        }
        promotionsRaw = data.data;
    
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        await loadPromotionStats();
    
        displayPromotions(promotionsRaw);
        updateSummaryCards();  // update summary
        updateSalesTypeCounts(); // Added
      } catch (err) {
        console.error('Error loading promotions:', err);
        document.getElementById('promotionsList').innerHTML = `
          <div class="col-span-full text-center py-12 text-red-500">
            <i class="bi bi-exclamation-triangle text-6xl"></i>
            <p class="mt-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <button onclick="loadPromotions()" class="btn btn-sm btn-ghost mt-2">
              <i class="bi bi-arrow-clockwise"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>`;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    async function loadPromotionStats() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        const statsRes = await fetch('/api/promotion/stats', { headers });
        if (statsRes.ok) {
          const statsData = await statsRes.json();
          if (statsData.status === 'success' && statsData.data) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• usageCount ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
            promotionsRaw.forEach(promo => {
              const stat = statsData.data.find(s => s.promotionId === promo._id);
              if (stat) {
                promo.usageCount = stat.usageCount || 0;
                promo.lastUsed = stat.lastUsed;
                promo.totalRevenue = stat.totalRevenue || 0;
              }
            });
          }
        }
      } catch (error) {
        console.warn('Could not load promotion stats:', error);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á throw error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    function calculateAccessibilityRate() {
      if (!promotionsRaw.length) return 0;
    
      const now = new Date();
      let accessiblePromotions = 0;
      let totalActivePromotions = 0;
    
      promotionsRaw.forEach(p => {
        const startDate = new Date(p.startDate);
        const endDate = new Date(p.endDate);
    
        // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà active
        if (now >= startDate && now <= endDate && p.isActive) {
          totalActivePromotions++;
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          let isAccessible = true;
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö usage limit
          if (p.usageLimit && p.usageLimit > 0) {
            const usageCount = p.usageCount || 0;
            if (usageCount >= p.usageLimit) {
              isAccessible = false;
            }
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö minimum purchase amount
          if (p.conditions && p.conditions.minPurchaseAmount > 0) {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å accessibility ‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á
            const minAmount = p.conditions.minPurchaseAmount;
            if (minAmount > 50000) {
              isAccessible = false; // ‡∏¢‡∏≠‡∏î‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏¢‡∏≤‡∏Å
            } else if (minAmount > 20000) {
              // ‡∏¢‡∏≠‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ 70%
              accessiblePromotions += 0.7;
              return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å forEach callback
            } else if (minAmount > 5000) {
              // ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ 90%
              accessiblePromotions += 0.9;
              return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å forEach callback
            }
            // ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ 100% (‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ condition ‡∏ô‡∏µ‡πâ)
          }
    
          if (isAccessible) {
            accessiblePromotions++;
          }
        }
      });
    
      return totalActivePromotions > 0 ?
        ((accessiblePromotions / totalActivePromotions) * 100).toFixed(1) : 0;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Summary Cards ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    function updateSummaryCards() {
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    
      let total = promotionsRaw.length;
      let active = 0, expired = 0, upcoming = 0;
      let newThisMonth = 0, activeLastMonth = 0;
      let totalUsage = 0, totalLimit = 0;
    
      promotionsRaw.forEach(p => {
        const startDate = new Date(p.startDate);
        const endDate = new Date(p.endDate);
        const createdDate = new Date(p.createdAt || p.startDate);
    
        // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        if (now >= startDate && now <= endDate && p.isActive) {
          active++;
        } else if (now > endDate) {
          expired++;
        } else if (now < startDate) {
          upcoming++;
        }
    
        // ‡∏ô‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        if (createdDate >= new Date(now.getFullYear(), now.getMonth(), 1)) {
          newThisMonth++;
        }
    
        // ‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡πà active ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
        if (lastMonth >= startDate && lastMonth <= endDate && p.isActive) {
          activeLastMonth++;
        }
    
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        if (p.usageLimit && p.usageLimit > 0) {
          totalUsage += (p.usageCount || 0);
          totalLimit += p.usageLimit;
        }
      });
    
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      const activeChange = active - activeLastMonth;
      const activeChangePercent = activeLastMonth > 0 ? ((activeChange / activeLastMonth) * 100).toFixed(1) : 0;
    
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (usage rate)
      const usageRate = totalLimit > 0 ? ((totalUsage / totalLimit) * 100).toFixed(1) : 0;
    
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
      const accessibilityRate = calculateAccessibilityRate();
    
      document.querySelector('.summary-cards').innerHTML = `
        <div class="card">
          <div class="card-icon bg-orange-500">
            <i class="bi bi-megaphone"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <h2 class="text-2xl font-semibold">${total}</h2>
            <p class="trend ${newThisMonth > 0 ? 'positive' : 'text-gray-500'}">
              <i class="bi bi-arrow-up"></i> ${newThisMonth} ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡πÉ‡∏´‡∏°‡πà
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-green-500">
            <i class="bi bi-play-circle"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <h2 class="text-2xl font-semibold">${active}</h2>
            <p class="trend ${activeChange >= 0 ? 'positive' : 'negative'}">
              <i class="bi bi-arrow-${activeChange >= 0 ? 'up' : 'down'}"></i> 
              ${Math.abs(activeChange)} ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-blue-600">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</h3>
            <h2 class="text-2xl font-semibold">${expired}</h2>
            <p class="trend text-gray-500">
              <i class="bi bi-arrow-down"></i> ${expired} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-yellow-500">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h3>
            <h2 class="text-2xl font-semibold">${accessibilityRate}%</h2>
            <p class="trend positive">
              <i class="bi bi-arrow-up"></i> ${usageRate}% ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            </p>
          </div>
        </div>`;
    }

    // Filtering
    function applyFilters() {
      const status = document.getElementById('filterStatus').value;
      const branch = document.getElementById('filterBranch').value;
      const type = document.getElementById('filterType').value;

      const now = new Date();
      let filtered = promotionsRaw;

      if (status !== 'all') {
        filtered = filtered.filter(promo => {
          const startDate = new Date(promo.startDate);
          const endDate = new Date(promo.endDate);
          if (status === 'active') return now >= startDate && now <= endDate && promo.isActive;
          if (status === 'upcoming') return now < startDate;
          if (status === 'expired') return now > endDate;
          return true;
        });
      }
      if (branch !== 'all') {
        filtered = filtered.filter(promo => promo.applicableBranches?.includes(branch) || promo.applicableBranches?.length === 0);
      }
      if (type !== 'all') {
        filtered = filtered.filter(promo => promo.type === type);
      }

      // Filter by currentSalesType
      if (currentSalesType !== 'all') {
        filtered = filtered.filter(promo =>
          promo.salesType === currentSalesType || promo.salesType === 'both'
        );
      }
      updateSalesTypeCounts(); // Update counts after other filters are applied, but before sales type filter for display
      displayPromotions(filtered);
    }

    // Display functions
    function displayPromotions(promotions) {
      const container = document.getElementById('promotionsList');
      if (promotions.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <i class="bi bi-megaphone text-6xl opacity-20"></i>
            <p class="mt-4 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
          </div>
        `;
        return;
      }
      container.innerHTML = promotions.map(promo => {
        const now = new Date();
        const startDate = new Date(promo.startDate);
        const endDate = new Date(promo.endDate);
        let status, statusColor, statusIcon;
        if (now < startDate) {
          status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤'; statusColor = 'badge-warning'; statusIcon = 'bi-clock';
        } else if (now > endDate) {
          status = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß'; statusColor = 'badge-error'; statusIcon = 'bi-x-circle';
        } else if (!promo.isActive) {
          status = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusColor = 'badge-ghost'; statusIcon = 'bi-pause-circle';
        } else {
          status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusColor = 'badge-success'; statusIcon = 'bi-check-circle';
        }

        let salesTypeBadge = '';
        if (promo.salesType === 'cash') {
          salesTypeBadge = '<span class="badge badge-info badge-outline"><i class="bi bi-cash-stack mr-1"></i>‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>';
        } else if (promo.salesType === 'installment') {
          salesTypeBadge = '<span class="badge badge-warning badge-outline"><i class="bi bi-credit-card mr-1"></i>‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>';
        } else if (promo.salesType === 'both') {
          salesTypeBadge = '<span class="badge badge-primary badge-outline"><i class="bi bi-grid-3x3-gap mr-1"></i>‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>';
        } else {
          salesTypeBadge = '<span class="badge badge-ghost badge-outline">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≤‡∏¢</span>';
        }


        return `
          <div class="promotion-card bg-white rounded-2xl shadow-card p-6 fade-in flex flex-col justify-between min-h-[260px]" data-promo-id="${promo._id}">
            <div>
              <div class="flex justify-between items-start mb-3">
                <h3 class="text-lg font-bold text-gray-800">${promo.name}</h3>
                <div class="flex flex-col items-end gap-1">
                  <span class="badge ${statusColor} px-3 py-2 flex items-center gap-1 text-xs">
                    <i class="bi ${statusIcon} mr-1"></i>${status}
                  </span>
                  ${salesTypeBadge}
                </div>
              </div>
              <p class="text-gray-600 text-sm mb-3 line-clamp-2">${promo.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
              <div class="space-y-1 text-sm">
                <div class="flex items-center text-gray-500">
                  <i class="bi bi-tag-fill mr-2"></i>
                  ${getPromotionTypeLabel(promo.type)}
                </div>
                <div class="flex items-center text-gray-500">
                  <i class="bi bi-calendar-range mr-2"></i>
                  ${formatDate(promo.startDate)} - ${formatDate(promo.endDate)}
                </div>
                ${promo.usageLimit ? `
                <div class="flex items-center text-gray-500 usage-info">
                  <i class="bi bi-people-fill mr-2"></i>
                  ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ${promo.usageCount || 0} / ${promo.usageLimit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                  <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(((promo.usageCount || 0) / promo.usageLimit) * 100, 100)}%"></div>
                  </div>
                </div>
                ` : ''}
                ${promo.totalRevenue ? `
                <div class="flex items-center text-gray-500">
                  <i class="bi bi-currency-dollar mr-2"></i>
                  ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ‡∏ø${formatPrice(promo.totalRevenue)}
                </div>
                ` : ''}
                ${promo.lastUsed ? `
                <div class="flex items-center text-gray-500">
                  <i class="bi bi-clock mr-2"></i>
                  ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formatDate(promo.lastUsed)}
                </div>
                ` : ''}
              </div>
            </div>
            <div class="mt-4 flex gap-2 justify-end">
              <button title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" onclick="editPromotion('${promo._id}')" class="btn btn-sm btn-ghost rounded-full shadow">
                <i class="bi bi-pencil"></i>
              </button>
              <button title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î" onclick="togglePromotion('${promo._id}', ${promo.isActive})" class="btn btn-sm btn-ghost rounded-full shadow">
                <i class="bi ${promo.isActive ? 'bi-pause' : 'bi-play'}"></i>
              </button>
              <button title="‡∏•‡∏ö" onclick="deletePromotion('${promo._id}')" class="btn btn-sm btn-ghost rounded-full text-error shadow">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayProductList(products = allProducts) {
      console.log('üì¶ All products for selection:', products.map(p => ({
        id: p._id,
        name: p.name
      })));
    
      const container = document.getElementById('productList');
      container.innerHTML = products.map(product => `
        <label class="cursor-pointer flex items-center p-2 hover:bg-gray-50 rounded">
          <input type="checkbox" name="products" value="${product._id}" class="checkbox checkbox-sm" />
          <span class="ml-2">${product.name} (ID: ${product._id})</span>
          <span class="ml-auto text-xs text-gray-400">${product.productType}</span>
        </label>
      `).join('');
    }

    function displayBundleProductList(products = allProducts) {
      const container = document.getElementById('bundleProductList');
      container.innerHTML = products.map(product => `
        <label class="cursor-pointer flex items-center p-2 hover:bg-white rounded border">
          <input type="checkbox" name="bundleProducts" value="${product._id}" class="checkbox checkbox-sm checkbox-primary" />
          <div class="ml-3 flex-1">
            <span class="text-sm font-medium">${product.name}</span>
            <div class="text-xs text-gray-400">${product.productType} ‚Ä¢ ${formatPrice(product.price)} ‡∏ö‡∏≤‡∏ó</div>
          </div>
        </label>
      `).join('');
    }

    // Form handling
    async function handleSubmit(e) {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const original = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    
      try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData); // All values are initially strings

        // Get salesType
        data.salesType = document.querySelector('[name="salesType"]:checked')?.value;

        // Basic client-side validation
        if (!data.salesType) {
          Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' });
          submitBtn.disabled = false; submitBtn.innerHTML = original; return;
        }

        if (!data.name || !data.type || !data.startDate || !data.endDate) {
          Swal.fire({
            icon: 'error',
            title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô, ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)'
          });
          submitBtn.disabled = false;
          submitBtn.innerHTML = original;
          return;
        }
    
        // Process arrays first
        data.applicableCategories = [...formData.getAll('categories')];
        data.applicableProducts = [...formData.getAll('products')];
        data.applicableBranches = [...formData.getAll('branches')];
        data.bundleProducts = [...formData.getAll('bundleProducts')];
        data.financePartners = [...formData.getAll('financePartners')];


        // Convert and manage type-specific numeric fields
        if (data.type === 'discount_percentage' || data.type === 'discount_amount') {
            data.discountValue = (data.discountValue === '' || typeof data.discountValue === 'undefined') ? 0 : Number(data.discountValue);
        } else {
            delete data.discountValue;
        }

        if (data.type === 'special_price') {
            data.specialPrice = (data.specialPrice === '' || typeof data.specialPrice === 'undefined') ? 0 : Number(data.specialPrice);
        } else {
            delete data.specialPrice;
        }

        if (data.type === 'buy_x_get_y') {
            data.buyQuantity = (data.buyQuantity === '' || typeof data.buyQuantity === 'undefined') ? 1 : Number(data.buyQuantity);
            data.getQuantity = (data.getQuantity === '' || typeof data.getQuantity === 'undefined') ? 1 : Number(data.getQuantity);
        } else {
            delete data.buyQuantity;
            delete data.getQuantity;
        }
    
        if (data.type === 'bundle') {
            data.bundlePrice = (data.bundlePrice === '' || typeof data.bundlePrice === 'undefined') ? 0 : Number(data.bundlePrice);
            if (data.bundleProducts.length < 2 && editingPromotionId === null) { // Check only for new promotions or if explicitly required for updates
               Swal.fire({ icon:'error', title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' });
               submitBtn.disabled = false; submitBtn.innerHTML = original; return;
            }
        } else {
            delete data.bundlePrice;
            data.bundleProducts = []; // Ensure bundleProducts is empty if not bundle type
        }
    
        // Convert general numeric fields
        data.usageLimit = (data.usageLimit === '' || typeof data.usageLimit === 'undefined') ? null : Number(data.usageLimit);
        data.priority = (data.priority === '' || typeof data.priority === 'undefined') ? 100 : Number(data.priority);

        // Process conditions: ensure numeric values
        const minPurchaseAmountStr = data.minPurchaseAmount;
        const maxDiscountAmountStr = data.maxDiscountAmount;
        data.conditions = {
          minPurchaseAmount: (minPurchaseAmountStr === '' || typeof minPurchaseAmountStr === 'undefined') ? 0 : Number(minPurchaseAmountStr),
          maxDiscountAmount: (maxDiscountAmountStr === '' || typeof maxDiscountAmountStr === 'undefined') ? null : Number(maxDiscountAmountStr)
        };
    
        // Clean up original form fields that are now structured differently or typed
        delete data.categories;
        delete data.products;
        delete data.branches;
        delete data.minPurchaseAmount;
        delete data.maxDiscountAmount;

        // Handle installment specific fields
        if (data.type === 'installment_discount' || data.type === 'installment_free_interest' || data.type === 'installment_special_terms') {
            // data.interestDiscount = (data.interestDiscount === '' || typeof data.interestDiscount === 'undefined') ? null : Number(data.interestDiscount);
            // data.installmentMonths = data.installmentMonths ? data.installmentMonths.split(',').map(m => m.trim()).filter(m => m) : [];
            // These fields were removed from the HTML, so commenting out processing.
            // If they are part of the schema and needed, ensure they are collected or handled.
        } else {
            // delete data.interestDiscount; // Ensure these are not sent if not applicable
            // delete data.installmentMonths;
        }

        // Handle new installment-specific fields
        if (data.type === 'installment_down_payment_discount') {
          data.downPaymentDiscountAmount = data.downPaymentDiscountAmount ? Number(data.downPaymentDiscountAmount) : null;
          data.downPaymentDiscountPercent = data.downPaymentDiscountPercent ? Number(data.downPaymentDiscountPercent) : null;
          data.installmentMonthsCondition = data.installmentMonthsCondition ? Number(data.installmentMonthsCondition) : null;
    
          if (data.downPaymentDiscountAmount && data.downPaymentDiscountPercent) {
            Swal.fire({
              icon: 'error',
              title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
              text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á'
            });
            submitBtn.disabled = false;
            submitBtn.innerHTML = original;
            return;
          }
        } else {
          delete data.downPaymentDiscountAmount;
          delete data.downPaymentDiscountPercent;
          delete data.installmentMonthsCondition;
        }

        if (data.type === 'installment_gift') {
          data.giftDetail = data.giftDetail || '';
          data.giftValue = data.giftValue ? Number(data.giftValue) : 0;
          data.giftQuantity = data.giftQuantity ? Number(data.giftQuantity) : 1;
          data.giftCondition = data.giftCondition || '';
           if (!data.giftDetail && editingPromotionId === null) { // Basic validation for new gift promo
             Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏ú‡πà‡∏≠‡∏ô' });
             submitBtn.disabled = false; submitBtn.innerHTML = original; return;
           }
        } else {
          delete data.giftDetail;
          delete data.giftValue;
          delete data.giftQuantity;
          delete data.giftCondition;
        }

        // Consolidate installmentConditions if needed, or handle financePartners directly
        // For now, financePartners is directly on data. If it should be nested:
        // data.installmentConditions = { financePartners: data.financePartners };
        // delete data.financePartners; // if moved to nested structure


        // Log data before sending
        console.log('Data to send:', JSON.parse(JSON.stringify(data))); // Use JSON.parse(JSON.stringify()) for a clean log of the object state'

        const headers = getAuthHeaders();
        if (!headers) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = original;
          return;
        }

        const url = editingPromotionId
          ? `/api/promotion/${editingPromotionId}`
          : '/api/promotion';
        const method = editingPromotionId ? 'PATCH' : 'POST';
    
        const res = await fetch(url, {
          method,
          headers: headers,
          body: JSON.stringify(data)
        });
    
        if (!res.ok) {
          let errorData = { message: `HTTP error! status: ${res.status}` };
          try {
            errorData = await res.json(); // Attempt to parse error response from server
            console.error('Server error response:', errorData);
          } catch (parseError) {
            console.error('Could not parse error response:', parseError);
          }
    
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (handleSubmit)');
            getAuthToken();
            return;
          }
          throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
        }
    
        Swal.fire({ icon:'success', title: editingPromotionId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer:2000, showConfirmButton:false });
        closeModal();
        await loadPromotions();
      } catch (err) {
        console.error('Error saving promotion:', err);
        Swal.fire({
          icon:'error',
          title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
          text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = original;
      }
    }

    // Export promotions ‡πÄ‡∏õ‡πá‡∏ô CSV
    function exportPromotions() {
      if (!promotionsRaw.length) return;
      const data = promotionsRaw.map(p => ({
        '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô': p.name,
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': getPromotionTypeLabel(p.type),
        '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô': formatDate(p.startDate),
        '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î': formatDate(p.endDate),
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': p.isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ': p.usageCount || 0
      }));
      const csv = [
        Object.keys(data[0]).join(','),
        ...data.map(row => Object.values(row).join(','))
      ].join('\n');
      const blob = new Blob(['\ufeff'+csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `promotions_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // For edit functionality (not present in original, but for completeness)
    async function editPromotion(id) {
      const promo = promotionsRaw.find(p => p._id === id);
      if (!promo) return;
    
      editingPromotionId = id;
    
      // Open modal and fill data
      document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil-square text-orange-500"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô';
      document.getElementById('promotionForm').reset();
    
      // Set basic fields
      document.querySelector('[name="name"]').value = promo.name || '';
      document.querySelector('[name="type"]').value = promo.type || '';
      document.querySelector('[name="description"]').value = promo.description || '';
      document.getElementById('startDate').value = formatInputDate(promo.startDate);
      document.getElementById('endDate').value = formatInputDate(promo.endDate);

      // Set salesType radio
      const salesTypeRadio = document.querySelector(`input[name="salesType"][value="${promo.salesType || 'both'}"]`);
      if (salesTypeRadio) salesTypeRadio.checked = true;
      toggleSalesTypeFields(); // Call after setting salesType
    
      // Toggle type-specific fields
      togglePromotionFields();
    
      // Set type-specific values
      if (promo.type === 'discount_percentage' || promo.type === 'discount_amount') {
        document.querySelector('[name="discountValue"]').value = promo.discountValue || '';
      }
      if (promo.type === 'special_price') {
        document.querySelector('[name="specialPrice"]').value = promo.specialPrice || '';
      }
      if (promo.type === 'buy_x_get_y') {
        document.querySelector('[name="buyQuantity"]').value = promo.buyQuantity || '';
        document.querySelector('[name="getQuantity"]').value = promo.getQuantity || '';
      }
      if (promo.type === 'bundle') {
        // Set bundle products
        if (promo.bundleProducts && promo.bundleProducts.length) {
          setTimeout(() => {
            promo.bundleProducts.forEach(item => {
              const id = item._id || item;
              const el = document.querySelector(`#bundleProductList [value="${id}"]`);
              if (el) el.checked = true;
            });
          }, 100);
        }
        document.querySelector('[name="bundlePrice"]').value = promo.bundlePrice || '';
      }

      // Set installment specific fields if they exist on promo object
      // Commenting out old fields as they were removed from HTML
      // if (promo.interestDiscount !== undefined) {
      //   document.querySelector('[name="interestDiscount"]').value = promo.interestDiscount;
      // }
      // if (promo.installmentMonths !== undefined) {
      //   document.querySelector('[name="installmentMonths"]').value = Array.isArray(promo.installmentMonths) ? promo.installmentMonths.join(',') : promo.installmentMonths;
      // }

      // Set new installment specific fields
      if (promo.type === 'installment_down_payment_discount') {
        document.querySelector('[name="downPaymentDiscountAmount"]').value = promo.downPaymentDiscountAmount || '';
        document.querySelector('[name="downPaymentDiscountPercent"]').value = promo.downPaymentDiscountPercent || '';
        document.querySelector('[name="installmentMonthsCondition"]').value = promo.installmentMonthsCondition || '';
      }
      if (promo.type === 'installment_gift') {
        document.querySelector('[name="giftDetail"]').value = promo.giftDetail || '';
        document.querySelector('[name="giftValue"]').value = promo.giftValue || '';
        document.querySelector('[name="giftQuantity"]').value = promo.giftQuantity || '1';
        document.querySelector('[name="giftCondition"]').value = promo.giftCondition || '';
      }
    
      // Set finance partners
      const financePartnersSelect = document.querySelector('[name="financePartners"]');
      if (promo.financePartners && promo.financePartners.length > 0) {
        promo.financePartners.forEach(partner => {
          const option = financePartnersSelect.querySelector(`option[value="${partner}"]`);
          if (option) option.selected = true;
        });
      } else {
        // If no specific partners, 'all' might be the default or no selection'
        // Check if 'all' should be selected by default if promo.financePartners is empty or not present'
        const allOption = financePartnersSelect.querySelector('option[value="all"]');
        if (allOption && (!promo.financePartners || promo.financePartners.length === 0)) {
            // allOption.selected = true; // Decide if 'all' should be pre-selected'
        }
      }
    
      // Set conditions
      if (promo.conditions) {
        document.querySelector('[name="minPurchaseAmount"]').value = promo.conditions.minPurchaseAmount || '';
        document.querySelector('[name="maxDiscountAmount"]').value = promo.conditions.maxDiscountAmount || '';
      }
    
      // Set usage limit and priority
      document.querySelector('[name="usageLimit"]').value = promo.usageLimit || '';
      document.querySelector('[name="priority"]').value = promo.priority || 100;
    
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Product tabs
      if (promo.applicableCategories && promo.applicableCategories.length > 0) {
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        switchTab('category', document.querySelectorAll('#productTabsContainer .tab')[1]);
        setTimeout(() => {
          promo.applicableCategories.forEach(cat => {
            const checkbox = document.querySelector(`#categoryList [value="${cat}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }, 100); // Delay to ensure category list is populated
      } else if (promo.applicableProducts && promo.applicableProducts.length > 0) {
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        switchTab('specific', document.querySelectorAll('#productTabsContainer .tab')[2]);
        setTimeout(() => {
          promo.applicableProducts.forEach(item => {
            const id = item._id || item; // Handle populated vs non-populated
            const checkbox = document.querySelector(`#productList [value="${id}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }, 100); // Delay to ensure product list is populated
      } else {
        // ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (default)
        switchTab('all', document.querySelectorAll('#productTabsContainer .tab')[0]);
      }
    
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Branch tabs
      if (promo.applicableBranches && promo.applicableBranches.length > 0) {
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        switchBranchTab('specific', document.querySelectorAll('#branchTabsContainer .tab')[1]);
        setTimeout(() => { // Delay to ensure branch list might be populated if needed
          promo.applicableBranches.forEach(branchCode => {
            const checkbox = document.querySelector(`#branchList [value="${branchCode}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }, 100);
      } else {
        // ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (default)
        switchBranchTab('all', document.querySelectorAll('#branchTabsContainer .tab')[0]);
      }
    
      // Open modal
      document.getElementById('promotionModal').classList.add('modal-open');
    }

    async function togglePromotion(id, isActive) {
      const newStatus = !isActive;
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const res = await fetch(`/api/promotion/${id}`, {
          method: 'PATCH',
          headers: headers, // Use the generated headers
          body: JSON.stringify({ isActive: newStatus })
        });
        if (!res.ok) {
          if (res.status === 401) {
            console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (togglePromotion)');
            getAuthToken(); // This will trigger redirect
            return;
          }
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        Swal.fire({
          icon: 'success',
          title: `‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ${newStatus ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`,
          timer: 2000,
          showConfirmButton: false
        });
        await loadPromotions();
      } catch (err) {
        console.error('Error toggling promotion status:', err);
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ' });
      }
    }

    async function deletePromotion(id) {
      const result = await Swal.fire({
        title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });

      if (result.isConfirmed) {
        try {
          const headers = getAuthHeaders();
          if (!headers) return;
    
          // Remove 'Content-Type' for DELETE if no body is sent, or keep if backend expects it'
          const deleteHeaders = { ...headers };
          // delete deleteHeaders['Content-Type']; // Uncomment if backend doesn't need Content-Type for DELETE'

          const res = await fetch(`/api/promotion/${id}`, {
            method: 'DELETE',
            headers: deleteHeaders
          });
          if (!res.ok) {
            if (res.status === 401) {
              console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (deletePromotion)');
              getAuthToken(); // This will trigger redirect
              return;
            }
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          Swal.fire({
            icon: 'success',
            title: '‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            timer: 2000,
            showConfirmButton: false
          });
          await loadPromotions();
        } catch (err) {
          console.error('Error deleting promotion:', err);
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ' });
        }
      }
    }

    // Helper function for formatting date
    function formatInputDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // Helper function to format date as DD/MM/YYYY
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed'
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Helper function to get promotion type label
    function getPromotionTypeLabel(type) {
      switch (type) {
        case 'discount_percentage': return '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î %';
        case 'discount_amount': return '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô';
        case 'special_price': return '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©';
        case 'buy_x_get_y': return '‡∏ã‡∏∑‡πâ‡∏≠ X ‡πÅ‡∏ñ‡∏° Y';
        case 'bundle': return '‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        case 'installment_discount': return '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ú‡πà‡∏≠‡∏ô';
        case 'installment_free_interest': return '‡∏ú‡πà‡∏≠‡∏ô 0%';
        case 'installment_special_terms': return '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡πà‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
        case 'installment_down_payment_discount': return '‡∏•‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå';
        case 'installment_gift': return '‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° (‡∏ú‡πà‡∏≠‡∏ô)';
        default: return type;
      }
    }

    // --- New functions to be added below ---

    // Fallback function for local checking (optional)
    function checkPromotionsLocally(productId) {
      console.log('‚ö†Ô∏è Falling back to local promotion check for product:', productId);
    
      if (!window.activePromotions || window.activePromotions.length === 0) {
        console.log('No local active promotions found.');
        return false;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (local)
      for (const promo of window.activePromotions) {
        // Check if promo is active and within date range (assuming window.activePromotions are already filtered)
        // Check branch applicability
        const branchMatch = !promo.applicableBranches || promo.applicableBranches.length === 0 || promo.applicableBranches.includes(currentBranchCode);
        if (!branchMatch) continue;

        if (!promo.applicableProducts || promo.applicableProducts.length === 0) {
          console.log(`Promo "${promo.name}" applies to all products.`);
          return true; // ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        }
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ productId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const hasProduct = promo.applicableProducts.some(p => {
          const id = p._id || p; // p could be an objectId string or a populated product object
          return id.toString() === productId.toString();
        });
        if (hasProduct) {
          console.log(`Promo "${promo.name}" applies to product ${productId}.`);
          return true;
        }
      }
    
      console.log(`No local promotions found for product ${productId}.`);
      return false;
    }

    // Use shared promotion manager functions
    // Functions are now available via window.promotionManager or global aliases

    // All promotion functions are now handled by shared promotion manager
    // Available via window.promotionManager or global aliases

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÉ‡∏ä‡πâ API ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö PO.html)
    async function loadUserProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          console.warn('No auth token found');
          return;
        }
    
        const response = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        const result = await response.json();
        if (!response.ok || !result.success) throw new Error(result.error || 'Load profile failed');
    
        const user = result.data;
    
        // Set current branch code from user data
        if (user.branchCode) {
          currentBranchCode = user.branchCode;
          console.log('üè¢ Set current branch code:', currentBranchCode);
        }
    
        // Update ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const employeeNameElement = document.getElementById('employeeName');
        if (employeeNameElement) {
          employeeNameElement.textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
        }
    
        // Update ‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const employeePhotoElement = document.getElementById('employeePhoto');
        if (employeePhotoElement) {
          let url = user.photoUrl || '';
          if (url && !url.startsWith('/') && !/^https?:\/\//.test(url)) url = '/' + url;
          employeePhotoElement.src = url;
        }
    
      } catch (error) {
        console.error('loadUserProfile error:', error);
        // Fallback: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const employeeNameElement = document.getElementById('employeeName');
        if (employeeNameElement) {
          employeeNameElement.textContent = userInfo.name || userInfo.fullName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        }
      }
    }

    // Show/Hide Loading Function
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // No fallback spinner - just show empty container
              document.getElementById('lottieContainer').innerHTML = '';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // ===== NEW ADVANCED FUNCTIONS =====

    let currentMainTab = 'promotions';

    // Main Tab Switching
    function switchMainTab(tab) {
      currentMainTab = tab;

      // Update active tab
      document.querySelectorAll('.sales-type-tab').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.sales-type-tab').classList.add('active');

      // Hide all content sections
      const contentSections = ['promotionsContent', 'analyticsContent', 'templatesContent', 'notificationsContent'];
      contentSections.forEach(section => {
        const element = document.getElementById(section);
        if (element) element.style.display = 'none';
      });

      // Show selected content and sub-tabs
      const selectedContent = document.getElementById(tab + 'Content');
      const promotionSubTabs = document.getElementById('promotionSubTabs');

      if (selectedContent) selectedContent.style.display = 'block';

      // Show/hide promotion sub-tabs
      if (promotionSubTabs) {
        promotionSubTabs.style.display = tab === 'promotions' ? 'flex' : 'none';
      }

      // Load content based on tab
      switch(tab) {
        case 'analytics':
          loadAnalytics();
          break;
        case 'templates':
          loadTemplates();
          break;
        case 'notifications':
          loadNotifications();
          break;
        case 'promotions':
        default:
          loadPromotions();
          break;
      }
    }

    // Load Analytics Data
    async function loadAnalytics() {
      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/promotion/analytics', { headers });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        if (result.status === 'success') {
          displayAnalytics(result.data);
        }
      } catch (error) {
        console.error('Error loading analytics:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', 'error');
      }
    }

    // Display Analytics Data
    function displayAnalytics(data) {
      // Update analytics cards
      document.getElementById('totalUsage').textContent = data.overview.totalUsage || '0';
      document.getElementById('conversionRate').textContent = `${data.overview.conversionRate || '0'}%`;
      document.getElementById('avgUsage').textContent = Math.round(data.avgUsagePerPromotion || 0);

      // Display top performing promotions
      const topPerformingContainer = document.getElementById('topPerformingList');
      if (data.topPerforming && data.topPerforming.length > 0) {
        topPerformingContainer.innerHTML = data.topPerforming.map((promo, index) => `
          <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-600 font-bold">
                ${index + 1}
              </div>
              <div>
                <h4 class="font-semibold">${promo.name}</h4>
                <p class="text-sm text-gray-500">${getPromotionTypeLabel(promo.type)}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-bold text-lg">${promo.usageCount}</p>
              <p class="text-sm text-gray-500">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            </div>
          </div>
        `).join('');
      } else {
        topPerformingContainer.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</p>';
      }

      // Display recent activities
      const recentContainer = document.getElementById('recentActivities');
      if (data.recentActivity && data.recentActivity.length > 0) {
        recentContainer.innerHTML = data.recentActivity.map(activity => `
          <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <i class="bi bi-clock text-gray-400"></i>
            <div>
              <p class="font-medium">${activity.name}</p>
              <p class="text-sm text-gray-500">${formatDate(activity.createdAt)}</p>
            </div>
            <div class="ml-auto">
              <span class="badge ${activity.isActive ? 'badge-success' : 'badge-ghost'}">
                ${activity.isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
              </span>
            </div>
          </div>
        `).join('');
      } else {
        recentContainer.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
      }
    }

    // Load Templates
    async function loadTemplates() {
      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/promotion/templates', { headers });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const result = await response.json();
        if (result.status === 'success') {
          displayTemplates(result.data);
        }
      } catch (error) {
        console.error('Error loading templates:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï', 'error');
      }
    }

    // Display Templates
    function displayTemplates(templates) {
      const container = document.getElementById('templatesList');

      container.innerHTML = templates.map(template => `
        <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-4">
            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-orange-400 to-red-500 text-white">
              <i class="bi bi-file-earmark-text text-lg"></i>
            </div>
            <div>
              <h3 class="font-bold text-lg">${template.name}</h3>
              <p class="text-sm text-gray-500">${template.category}</p>
            </div>
          </div>

          <p class="text-gray-600 dark:text-gray-300 mb-4">${template.description}</p>

          ${template.suggestedDiscount ? `
            <div class="mb-4">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ${template.suggestedDiscount}% ‡∏•‡∏î
              </span>
            </div>
          ` : ''}

          <button onclick="useTemplate('${template.id}')" class="btn btn-primary w-full">
            <i class="bi bi-plus-circle"></i>
            ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ
          </button>
        </div>
      `).join('');
    }

    // Use Template
    function useTemplate(templateId) {
      // This would pre-fill the create promotion modal with template data
      showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï - ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'info');
      openCreateModal();
    }

    // Load Notifications
    async function loadNotifications() {
      try {
        const headers = getAuthHeaders();
        if (!headers) return;

        const response = await fetch('/api/promotion/notifications', { headers });

        if (response.status === 401) {
          console.error('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (loadNotifications)');
          return;
        }

        if (!response.ok) {
          console.warn(`Notifications API error: ${response.status} - using empty state`);
          // Show empty notifications state
          displayNotifications({ notifications: [], summary: { total: 0 } });
          document.getElementById('notificationsCount').textContent = '0';
          return;
        }

        const result = await response.json();
        if (result.status === 'success') {
          displayNotifications(result.data);

          // Update notification count in tab
          const notifCount = result.data.summary.total;
          const notifCountElement = document.getElementById('notificationsCount');
          if (notifCountElement) {
            notifCountElement.textContent = notifCount || '0';
          }
        }
      } catch (error) {
        console.warn('Notifications not available:', error.message);
        // Show empty state instead of error
        displayNotifications({ notifications: [], summary: { total: 0 } });
        const notifCountElement = document.getElementById('notificationsCount');
        if (notifCountElement) {
          notifCountElement.textContent = '0';
        }
      }
    }

    // Display Notifications
    function displayNotifications(data) {
      const container = document.getElementById('notificationsList');
      if (!container) {
        console.warn('Notifications container not found');
        return;
      }

      if (data && data.notifications && data.notifications.length > 0) {
        container.innerHTML = data.notifications.map(notif => {
          const iconClass = {
            'warning': 'bi-exclamation-triangle text-yellow-500',
            'info': 'bi-info-circle text-blue-500',
            'alert': 'bi-exclamation-circle text-red-500'
          }[notif.type] || 'bi-bell text-gray-500';

          return `
            <div class="flex items-start gap-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <i class="bi ${iconClass} text-xl flex-shrink-0 mt-1"></i>
              <div class="flex-grow">
                <h4 class="font-semibold mb-1">${notif.title}</h4>
                <p class="text-gray-600 dark:text-gray-300 mb-3">${notif.message}</p>
                ${notif.action ? `
                  <button onclick="handleNotificationAction('${notif.action}', '${notif.promotionId}')"
                          class="btn btn-sm btn-outline">
                    ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } else {
        container.innerHTML = `
          <div class="text-center py-12">
            <i class="bi bi-bell-slash text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
          </div>
        `;
      }
    }

    // Handle Notification Actions
    function handleNotificationAction(action, promotionId) {
      switch(action) {
        case 'extend_promotion':
          // Would show extend modal
          showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'info');
          break;
        case 'increase_limit':
          // Would show increase limit modal
          showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏°‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'info');
          break;
        case 'optimize_promotion':
          // Would show optimization suggestions
          showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'info');
          break;
        default:
          showToast('‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ', 'error');
      }
    }

    // Refresh Notifications
    function refreshNotifications() {
      if (currentMainTab === 'notifications') {
        loadNotifications();
        showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }
    }

    // Enhanced Export Functionality
    function exportPromotions() {
      const format = 'csv'; // Could be made selectable
      const params = new URLSearchParams({
        format: format,
        status: 'all',
        type: 'all',
        branch: 'all'
      });

      // Create download link
      const link = document.createElement('a');
      link.href = `/api/promotion/export?${params}`;
      link.download = `promotions_${new Date().toISOString().split('T')[0]}.csv`;

      // Trigger download
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...', 'info');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Load sidebar first
      try {
        const response = await fetch('/views/marketing/includes/sidebar.html');
        const sidebarHtml = await response.text();
        const sidebarContainer = document.getElementById('sidebar-container');
        if (sidebarContainer) {
          sidebarContainer.innerHTML = sidebarHtml;
          // Initialize sidebar functionality
          if (typeof initializeSidebar === 'function') {
            initializeSidebar();
          }
        }
      } catch (error) {
        console.error('Error loading sidebar:', error);
        // Fallback: show basic sidebar structure
        const sidebarContainer = document.getElementById('sidebar-container');
        if (sidebarContainer) {
          sidebarContainer.innerHTML = '<aside class="w-64 bg-white dark:bg-gray-800 sticky top-0 h-screen"><div class="p-4">Sidebar Loading Error</div></aside>';
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏Å‡πà‡∏≠‡∏ô
      const token = getAuthToken();
      if (!token) {
        return; // ‡∏à‡∏∞ redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢ getAuthToken
      }
    
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      await loadUserProfile();
    
      // Initialize shared promotion manager
      if (window.promotionManager) {
        await window.promotionManager.initialize();
        console.log('‚úÖ Shared promotion manager initialized for campaigns');
      }
    
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      try {
        await loadBranches();

        // Load optional endpoints with individual error handling
        await loadCategories().catch(err => console.warn('Categories skipped:', err.message));
        await loadFinancePartners().catch(err => console.warn('Finance partners skipped:', err.message));

        await loadProducts();
        await loadPromotions();

        // Load notifications count on startup (non-blocking)
        if (window.promotionManager) {
          loadNotifications().catch(err => console.warn('Notifications skipped:', err.message));
        }
    
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ flatpickr
        flatpickr('#startDate', { enableTime:true, dateFormat:'Y-m-d H:i', minDate:'today' });
        flatpickr('#endDate', {
          enableTime: true, dateFormat:'Y-m-d H:i', minDate:'today',
          onChange(selectedDates) {
            const start = document.getElementById('startDate')._flatpickr.selectedDates[0];
            if (start && selectedDates[0] <= start) {
              Swal.fire({ icon:'warning', title:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text:'‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' });
              this.clear();
            }
          }
        });
        document.getElementById('promotionForm').addEventListener('submit', handleSubmit);
      } catch (err) {
        console.error('Error in DOMContentLoaded:', err);
      }
    });
  </script>
</body>
</html>
