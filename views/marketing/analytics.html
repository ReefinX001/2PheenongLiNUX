<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>วิเคราะห์ข้อมูล - ระบบการตลาด</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- User Profile Manager -->
  <script src="/views/marketing/js/user-profile.js"></script>
  <!-- Sidebar Manager -->
  <script src="/views/marketing/js/sidebar.js"></script>

  <!-- Favicon ต่างๆ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
  
  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Prompt', 'sans-serif'],
            prompt: ['Prompt', 'sans-serif'],
          },
          boxShadow: {
            'lux': '0 8px 32px 0 rgba(31, 38, 135, 0.18)'
          }
        },
      },
      daisyui: {
        themes: ['luxury', 'dark', 'corporate'],
      },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Animate.css for fade animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ApexCharts - สำหรับกราฟขั้นสูง -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <style>
    /* เพิ่ม CSS สำหรับความสวยงาม */
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .calendar-day {
      background-color: #374151;
    }

    .calendar-day-holiday {
      background-color: #fee2e2;
      color: #ef4444;
    }

    .dark .calendar-day-holiday {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #notificationBtn span.badge-notification { 
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status indicators */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-active {
      background-color: #10b981;
    }

    .status-away {
      background-color: #f59e0b;
    }

    .status-offline {
      background-color: #6b7280;
    }
    
    /* Dashboard specific styles */
    .main-content {
      flex: 1;
      padding: 20px 30px;
      overflow-y: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .page-title h1 {
      font-size: 1.8rem;
      color: var(--dark-color);
      margin-bottom: 5px;
    }
    
    .page-title p {
      color: var(--gray-color);
      font-size: 0.9rem;
    }
    
    .date-filter select {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      background-color: white;
      font-size: 0.9rem;
      color: #212529;
      cursor: pointer;
    }
    
    .dark .date-filter select {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }
    
    /* Summary Cards Styles */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 1200px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-row {
        flex-direction: column;
      }
    }
    
    @media (max-width: 768px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
    }
    
    .dark .card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .card-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.8rem;
      color: white;
    }
    
    .card-info h3 {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 5px;
    }
    
    .dark .card-info h3 {
      color: #9ca3af;
    }
    
    .card-info h2 {
      font-size: 1.5rem;
      color: #212529;
      margin-bottom: 5px;
    }
    
    .dark .card-info h2 {
      color: #f3f4f6;
    }
    
    .trend {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }
    
    .trend i {
      margin-right: 5px;
    }
    
    .positive {
      color: #10b981;
    }
    
    .negative {
      color: #ef4444;
    }

    .neutral {
      color: #6b7280;
    }
    
    /* Charts Container Styles */
    .charts-container {
      margin-bottom: 30px;
    }
    
    .chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      flex: 1;
      overflow: hidden;
    }
    
    .dark .chart-card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .chart-card.large {
      flex: 2;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .dark .chart-header {
      border-bottom-color: #4b5563;
    }
    
    .chart-header h3 {
      font-size: 1.1rem;
      color: #212529;
    }
    
    .dark .chart-header h3 {
      color: #f3f4f6;
    }
    
    .chart-actions button {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .dark .chart-actions button {
      color: #9ca3af;
    }
    
    .chart-content {
      padding: 20px;
      height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* Segmentation Card Styles */
    .segmentation-card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dark .segmentation-card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .segmentation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .segmentation-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .segmentation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    .segment-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9fafb;
      transition: all 0.2s ease;
    }

    .dark .segment-item {
      background-color: #374151;
    }

    .segment-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
    }

    .segment-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .dark .segment-icon {
      background-color: #3b82f6;
    }

    .segment-icon i {
      font-size: 1.5rem;
      color: #3b82f6;
    }

    .dark .segment-icon i {
      color: #dbeafe;
    }

    .segment-value {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .segment-label {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .dark .segment-label {
      color: #9ca3af;
    }

    /* Map Styles */
    .map-container {
      height: 400px;
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: cover;
      background-position: center;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark .map-container {
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    }

    .map-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      padding: 20px;
      color: white;
      border-radius: 0 0 8px 8px;
    }

    /* Insights Cards */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
      .insights-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .insights-grid {
        grid-template-columns: 1fr;
      }
    }

    .insight-card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-top: 4px solid #3b82f6;
    }

    .dark .insight-card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .insight-card.positive {
      border-top-color: #10b981;
    }

    .insight-card.negative {
      border-top-color: #ef4444;
    }

    .insight-card.neutral {
      border-top-color: #f59e0b;
    }

    .insight-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .insight-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }

    .insight-icon.positive {
      background-color: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .dark .insight-icon.positive {
      background-color: rgba(16, 185, 129, 0.2);
    }

    .insight-icon.negative {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .dark .insight-icon.negative {
      background-color: rgba(239, 68, 68, 0.2);
    }

    .insight-icon.neutral {
      background-color: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .dark .insight-icon.neutral {
      background-color: rgba(245, 158, 11, 0.2);
    }

    .insight-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .insight-content {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #4b5563;
    }

    .dark .insight-content {
      color: #9ca3af;
    }

    .insight-footer {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .dark .insight-footer {
      color: #9ca3af;
    }

    .insight-action {
      color: #3b82f6;
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .insight-action i {
      margin-left: 5px;
    }

    .dark .insight-action {
      color: #60a5fa;
    }

    /* Table Styles */
    .data-table-container {
      overflow-x: auto;
      margin-bottom: 30px;
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dark .data-table {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
    }

    .data-table th {
      background-color: #f3f4f6;
      font-weight: 600;
      color: #4b5563;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .dark .data-table th {
      background-color: #374151;
      color: #e5e7eb;
    }

    .data-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
    }

    .dark .data-table tbody tr {
      border-bottom: 1px solid #4b5563;
    }

    .data-table tbody tr:last-child {
      border-bottom: none;
    }

    .data-table tbody tr:hover {
      background-color: #f9fafb;
    }

    .dark .data-table tbody tr:hover {
      background-color: #374151;
    }

    /* Status Pills */
    .status-pill {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
    }

    .status-high {
      background-color: #dcfce7;
      color: #15803d;
    }

    .dark .status-high {
      background-color: rgba(20, 83, 45, 0.4);
      color: #4ade80;
    }

    .status-medium {
      background-color: #fef9c3;
      color: #854d0e;
    }

    .dark .status-medium {
      background-color: rgba(113, 63, 18, 0.4);
      color: #fde047;
    }

    .status-low {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .dark .status-low {
      background-color: rgba(127, 29, 29, 0.4);
      color: #f87171;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .metric-card {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    .dark .metric-card {
      background-color: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .metric-title {
      font-size: 1rem;
      color: #6b7280;
    }

    .dark .metric-title {
      color: #9ca3af;
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 5px;
    }

    .dark .metric-value {
      color: #f9fafb;
    }

    .metric-delta {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
    }

    .metric-delta i {
      margin-right: 5px;
      font-size: 0.9rem;
    }

    .metric-chart {
      margin-top: 15px;
      height: 60px;
    }
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>

  <script>
    let lottieAnimation = null;
  </script>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen flex">
    <!-- Sidebar Container -->
    <div id="sidebar-container">
      <!-- Sidebar content will be loaded here -->
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <div class="page-title">
          <h1 class="text-2xl font-semibold">วิเคราะห์ข้อมูลการตลาด</h1>
          <p class="text-gray-500 dark:text-gray-400">ข้อมูลเชิงลึกเกี่ยวกับลูกค้า แนวโน้มตลาด และประสิทธิภาพการขาย</p>
        </div>
        <div class="flex gap-3">
          <div class="date-filter flex space-x-2">
            <select id="timeRangeFilter" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md">
              <option value="today">วันนี้</option>
              <option value="yesterday">เมื่อวาน</option>
              <option value="7days">7 วันล่าสุด</option>
              <option value="30days">30 วันล่าสุด</option>
              <option value="90days">90 วันล่าสุด</option>
              <option value="year" selected>ปีนี้</option>
              <option value="all">ข้อมูลทั้งหมด</option>
              <option value="custom">กำหนดเอง</option>
            </select>
            <button id="downloadReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center">
              <i class="bi bi-file-earmark-arrow-down mr-2"></i> ดาวน์โหลดรายงาน
            </button>
            <button id="debugAgeDataBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md flex items-center">
              <i class="bi bi-bug mr-2"></i> Debug Age Data
            </button>
            <button id="checkCustomerDataBtn" class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-md flex items-center">
              <i class="bi bi-database mr-2"></i> Check Customer Data
            </button>
            <button id="debugInstallmentDataBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md flex items-center">
              <i class="bi bi-credit-card mr-2"></i> Debug Installment Data
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="card">
          <div class="card-icon bg-blue-600">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">ยอดขายทั้งหมด</h3>
            <h2 class="text-2xl font-semibold" id="totalSalesValue">฿0</h2>
            <p class="trend" id="salesGrowthTrend">
              <i class="bi bi-arrow-up"></i> 0% จากเดือนที่แล้ว
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-green-500">
            <i class="bi bi-people"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">ลูกค้าใหม่</h3>
            <h2 class="text-2xl font-semibold" id="newCustomersValue">0</h2>
            <p class="trend" id="customersGrowthTrend">
              <i class="bi bi-arrow-up"></i> 0% จากเดือนที่แล้ว
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-purple-500">
            <i class="bi bi-cart-check"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">อัตราการซื้อซ้ำ</h3>
            <h2 class="text-2xl font-semibold" id="repeatRateValue">0%</h2>
            <p class="trend" id="repeatRateGrowthTrend">
              <i class="bi bi-arrow-up"></i> 0% จากเดือนที่แล้ว
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-icon bg-orange-500">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <div class="card-info">
            <h3 class="text-gray-500 dark:text-gray-400">มูลค่าเฉลี่ยต่อออเดอร์</h3>
            <h2 class="text-2xl font-semibold" id="avgOrderValue">฿0</h2>
            <p class="trend" id="avgOrderGrowthTrend">
              <i class="bi bi-arrow-up"></i> 0% จากเดือนที่แล้ว
            </p>
          </div>
        </div>
      </div>

      <!-- Sales Trend Chart -->
      <div class="chart-card mb-6">
        <div class="chart-header">
          <h3 class="text-lg font-semibold">แนวโน้มยอดขายและจำนวนลูกค้า</h3>
          <div class="chart-actions">
            <button><i class="bi bi-gear"></i></button>
            <button><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-content">
          <canvas id="salesTrendChart"></canvas>
        </div>
      </div>

      <!-- Customer & Sales Analytics -->
      <div class="chart-row">
        <div class="chart-card">
          <div class="chart-header">
            <h3>สัดส่วนยอดขายตามประเภทสินค้า</h3>
            <div class="chart-actions">
              <button><i class="bi bi-download"></i></button>
            </div>
          </div>
          <div class="chart-content">
            <canvas id="productCategoryChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3>สัดส่วนลูกค้าตามกลุ่มอายุ</h3>
            <div class="chart-actions">
              <button><i class="bi bi-download"></i></button>
            </div>
          </div>
          <div class="chart-content">
            <canvas id="ageDistributionChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-row">
        <div class="chart-card">
          <div class="chart-header">
            <h3>ประสิทธิภาพตามช่องทางการขาย</h3>
            <div class="chart-actions">
              <button><i class="bi bi-download"></i></button>
            </div>
          </div>
          <div class="chart-content">
            <canvas id="salesChannelChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <h3>สัดส่วนระยะเวลาการผ่อนชำระ</h3>
            <div class="chart-actions">
              <button><i class="bi bi-download"></i></button>
            </div>
          </div>
          <div class="chart-content">
            <canvas id="installmentPeriodChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Customer Segmentation -->
      <div class="segmentation-card">
        <div class="segmentation-header">
          <h3>การแบ่งกลุ่มลูกค้า</h3>
          <button class="text-blue-600 dark:text-blue-400 text-sm flex items-center">
            ดูรายงานเพิ่มเติม <i class="bi bi-arrow-right ml-1"></i>
          </button>
        </div>
        <div class="segmentation-grid">
          <div class="segment-item">
            <div class="segment-icon">
              <i class="bi bi-gem"></i>
            </div>
            <div class="segment-value">18%</div>
            <div class="segment-label">ลูกค้า Premium</div>
          </div>
          <div class="segment-item">
            <div class="segment-icon">
              <i class="bi bi-clock-history"></i>
            </div>
            <div class="segment-value">42%</div>
            <div class="segment-label">ลูกค้าประจำ</div>
          </div>
          <div class="segment-item">
            <div class="segment-icon">
              <i class="bi bi-person-plus"></i>
            </div>
            <div class="segment-value">25%</div>
            <div class="segment-label">ลูกค้าใหม่</div>
          </div>
          <div class="segment-item">
            <div class="segment-icon">
              <i class="bi bi-person-dash"></i>
            </div>
            <div class="segment-value">15%</div>
            <div class="segment-label">ลูกค้าที่กำลังจะหาย</div>
          </div>
        </div>
      </div>

      <!-- Geographic Distribution -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">การกระจายตัวของยอดขายตามภูมิภาค</h3>
          <div class="flex gap-2">
            <button id="debugRegionalDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded text-sm flex items-center">
              <i class="bi bi-bug mr-1"></i> Debug Regional Data
            </button>
            <button id="refreshRegionalDataBtn" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded text-sm flex items-center">
              <i class="bi bi-arrow-clockwise mr-1"></i> Refresh
            </button>
          </div>
        </div>
        
        <!-- Regional Sales Chart and Data -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Chart Section -->
          <div class="chart-content">
            <canvas id="regionalSalesChart" style="height: 400px;"></canvas>
          </div>
          
          <!-- Data Table Section -->
          <div class="space-y-4">
            <div id="regionalSalesData" class="space-y-3">
              <!-- Regional data will be loaded here -->
              <div class="text-center text-gray-500 py-8">
                <i class="bi bi-hourglass-split text-3xl mb-2"></i>
                <p>กำลังโหลดข้อมูลยอดขายตามภูมิภาค...</p>
              </div>
            </div>
            
            <!-- Summary Stats -->
            <div id="regionalSummary" class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <h4 class="font-semibold mb-3">สรุปข้อมูลภาพรวม</h4>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="text-gray-600 dark:text-gray-400">ยอดขายรวม:</span>
                  <span id="totalRegionalSales" class="font-semibold ml-2">฿0</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">ธุรกรรมทั้งหมด:</span>
                  <span id="totalRegionalTransactions" class="font-semibold ml-2">0</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">ภูมิภาคที่ขายดีที่สุด:</span>
                  <span id="topRegion" class="font-semibold ml-2 text-green-600">-</span>
                </div>
                <div>
                  <span class="text-gray-600 dark:text-gray-400">ข้อมูล:</span>
                  <span id="dataSource" class="font-semibold ml-2 text-blue-600">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Marketing Insights -->
      <h3 class="text-xl font-semibold mb-4">ข้อมูลเชิงลึกการตลาด</h3>
      <div class="insights-grid">
        <div class="insight-card positive">
          <div class="insight-header">
            <div class="insight-icon positive">
              <i class="bi bi-graph-up-arrow"></i>
            </div>
            <div class="insight-title">แคมเปญที่ประสบความสำเร็จ</div>
          </div>
          <div class="insight-content">
            โปรโมชั่นซัมเมอร์ 2025 สร้างยอดขายสูงสุดในเดือนนี้ โดยมีอัตราการเข้าถึงมากกว่า 85% และอัตราการมีส่วนร่วม 34.8%
          </div>
          <div class="insight-footer">
            <div>10 พ.ค. 2025</div>
            <a href="#" class="insight-action">ดูรายละเอียด <i class="bi bi-arrow-right"></i></a>
          </div>
        </div>

        <div class="insight-card negative">
          <div class="insight-header">
            <div class="insight-icon negative">
              <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="insight-title">ความท้าทาย</div>
          </div>
          <div class="insight-content">
            อัตราการยกเลิกการสั่งซื้อเพิ่มขึ้น 12% ในกลุ่มลูกค้าอายุ 18-24 ปี สาเหตุหลักมาจากขั้นตอนการชำระเงินที่ซับซ้อนเกินไป
          </div>
          <div class="insight-footer">
            <div>8 พ.ค. 2025</div>
            <a href="#" class="insight-action">ดูรายละเอียด <i class="bi bi-arrow-right"></i></a>
          </div>
        </div>

        <div class="insight-card neutral">
          <div class="insight-header">
            <div class="insight-icon neutral">
              <i class="bi bi-lightbulb"></i>
            </div>
            <div class="insight-title">โอกาส</div>
          </div>
          <div class="insight-content">
            การวิเคราะห์พบว่า 58% ของลูกค้าที่ซื้อ iPhone ไม่ได้ซื้ออุปกรณ์เสริม ควรพิจารณาเพิ่มโปรโมชั่น bundle เพื่อเพิ่มยอดขาย
          </div>
          <div class="insight-footer">
            <div>5 พ.ค. 2025</div>
            <a href="#" class="insight-action">ดูรายละเอียด <i class="bi bi-arrow-right"></i></a>
          </div>
        </div>
      </div>

      <!-- Campaign Performance Metrics -->
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">อัตราการเข้าถึง</div>
            <div class="metric-icon" style="background-color: #3b82f6;">
              <i class="bi bi-eye"></i>
            </div>
          </div>
          <div class="metric-value">85.7%</div>
          <div class="metric-delta positive">
            <i class="bi bi-arrow-up"></i> 12.3% จากเดือนที่แล้ว
          </div>
          <div class="metric-chart" id="reachRateChart"></div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">อัตราการมีส่วนร่วม</div>
            <div class="metric-icon" style="background-color: #10b981;">
              <i class="bi bi-hand-thumbs-up"></i>
            </div>
          </div>
          <div class="metric-value">32.4%</div>
          <div class="metric-delta positive">
            <i class="bi bi-arrow-up"></i> 8.7% จากเดือนที่แล้ว
          </div>
          <div class="metric-chart" id="engagementRateChart"></div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">อัตราการแปลง</div>
            <div class="metric-icon" style="background-color: #f59e0b;">
              <i class="bi bi-cart-check"></i>
            </div>
          </div>
          <div class="metric-value">7.2%</div>
          <div class="metric-delta positive">
            <i class="bi bi-arrow-up"></i> 1.5% จากเดือนที่แล้ว
          </div>
          <div class="metric-chart" id="conversionRateChart"></div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">ต้นทุนต่อการได้มาซึ่งลูกค้า</div>
            <div class="metric-icon" style="background-color: #ef4444;">
              <i class="bi bi-currency-dollar"></i>
            </div>
          </div>
          <div class="metric-value">฿450</div>
          <div class="metric-delta negative">
            <i class="bi bi-arrow-down"></i> 12.8% จากเดือนที่แล้ว
          </div>
          <div class="metric-chart" id="acquisitionCostChart"></div>
        </div>
      </div>

      <!-- Product Performance Table -->
      <h3 class="text-xl font-semibold mb-4">ประสิทธิภาพการขายตามผลิตภัณฑ์</h3>
      <div class="data-table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>รุ่น</th>
              <th>ยอดขาย</th>
              <th>การเติบโต</th>
              <th>การแปลงเป็นยอดขาย</th>
              <th>ความนิยม</th>
              <th>อัตราส่วนผ่อนชำระ</th>
              <th>สถานะ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="font-semibold">iPhone 15 Pro</td>
              <td>฿12,746,000</td>
              <td class="text-green-600 dark:text-green-400">+24.7%</td>
              <td>8.9%</td>
              <td>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 92%"></div>
                </div>
              </td>
              <td>78.5%</td>
              <td><span class="status-pill status-high">สูง</span></td>
            </tr>
            <tr>
              <td class="font-semibold">Samsung Galaxy S24</td>
              <td>฿10,582,000</td>
              <td class="text-green-600 dark:text-green-400">+18.3%</td>
              <td>7.8%</td>
              <td>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 85%"></div>
                </div>
              </td>
              <td>72.4%</td>
              <td><span class="status-pill status-high">สูง</span></td>
            </tr>
            <tr>
              <td class="font-semibold">Xiaomi 14</td>
              <td>฿5,347,800</td>
              <td class="text-green-600 dark:text-green-400">+32.5%</td>
              <td>6.7%</td>
              <td>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 68%"></div>
                </div>
              </td>
              <td>65.2%</td>
              <td><span class="status-pill status-medium">ปานกลาง</span></td>
            </tr>
            <tr>
              <td class="font-semibold">OPPO Find X6</td>
              <td>฿3,825,400</td>
              <td class="text-green-600 dark:text-green-400">+15.2%</td>
              <td>5.8%</td>
              <td>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 52%"></div>
                </div>
              </td>
              <td>61.8%</td>
              <td><span class="status-pill status-medium">ปานกลาง</span></td>
            </tr>
            <tr>
              <td class="font-semibold">Vivo X90</td>
              <td>฿2,947,200</td>
              <td class="text-red-600 dark:text-red-400">-5.7%</td>
              <td>4.2%</td>
              <td>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: 35%"></div>
                </div>
              </td>
              <td>58.3%</td>
              <td><span class="status-pill status-low">ต่ำ</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Campaign ROI Analysis -->
      <div class="chart-card mb-6">
        <div class="chart-header">
          <h3>การวิเคราะห์ ROI ตามแคมเปญ</h3>
          <div class="chart-actions">
            <button><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-content">
          <canvas id="campaignROIChart"></canvas>
        </div>
      </div>

      <!-- Customer Journey Funnel -->
      <div class="chart-card mb-6">
        <div class="chart-header">
          <h3>Funnel การซื้อของลูกค้า</h3>
          <div class="chart-actions">
            <button><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-content">
          <canvas id="customerFunnelChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Charts
    function initializeCharts() {
      // Define chart colors
      const chartColors = {
        blue: '#3b82f6',
        indigo: '#6366f1',
        purple: '#8b5cf6',
        pink: '#ec4899',
        red: '#ef4444',
        orange: '#f97316',
        amber: '#f59e0b',
        yellow: '#eab308',
        green: '#10b981',
        teal: '#14b8a6',
        cyan: '#06b6d4',
        // Alpha versions
        blueAlpha: 'rgba(59, 130, 246, 0.5)',
        indigoAlpha: 'rgba(99, 102, 241, 0.5)',
        purpleAlpha: 'rgba(139, 92, 246, 0.5)',
        pinkAlpha: 'rgba(236, 72, 153, 0.5)',
        redAlpha: 'rgba(239, 68, 68, 0.5)',
        orangeAlpha: 'rgba(249, 115, 22, 0.5)',
        amberAlpha: 'rgba(245, 158, 11, 0.5)',
        yellowAlpha: 'rgba(234, 179, 8, 0.5)',
        greenAlpha: 'rgba(16, 185, 129, 0.5)',
        tealAlpha: 'rgba(20, 184, 166, 0.5)',
        cyanAlpha: 'rgba(6, 182, 212, 0.5)'
      };
      
      // Sales Trend Chart will be loaded dynamically via loadSalesTrendData()
      
      // Product Category Chart will be loaded dynamically via loadProductCategoryData()
      
      // Age Distribution Chart will be loaded dynamically via loadAgeDistributionData()
      
      // Sales Channel Chart
      const salesChannelElement = document.getElementById('salesChannelChart');
      // Destroy existing chart if any
      const existingSalesChannelChart = Chart.getChart(salesChannelElement);
      if (existingSalesChannelChart) {
        existingSalesChannelChart.destroy();
      }
      
      const salesChannelCtx = salesChannelElement.getContext('2d');
      const salesChannelChart = new Chart(salesChannelCtx, {
        type: 'radar',
        data: {
          labels: ['หน้าร้าน', 'เว็บไซต์', 'แอปพลิเคชัน', 'ตัวแทนขาย', 'แพลตฟอร์มออนไลน์', 'โทรศัพท์'],
          datasets: [{
            label: 'ยอดขาย (ล้านบาท)',
            data: [3.2, 1.8, 2.5, 1.2, 0.9, 0.6],
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: chartColors.blue,
            pointBackgroundColor: chartColors.blue,
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: chartColors.blue,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: {
                display: true,
                color: '#e5e7eb'
              },
              grid: {
                color: '#e5e7eb',
                lineWidth: 1
              },
              ticks: {
                display: true,
                color: '#6b7280',
                beginAtZero: true
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#374151'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  let value = context.parsed.r;
                  label += ': ' + value + ' ล้านบาท';
                  return label;
                }
              }
            }
          }
        }
      });
      
      // Installment Period Chart will be loaded dynamically via loadInstallmentPeriodData()

      // Campaign ROI Chart
      const campaignROICtx = document.getElementById('campaignROIChart');
      if (campaignROICtx) {
        // Destroy existing chart if any
        const existingChart = Chart.getChart(campaignROICtx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const campaignROIChart = new Chart(campaignROICtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['โซเชียลมีเดีย', 'Google Ads', 'อีเมลมาร์เก็ตติ้ง', 'SEO', 'คอนเทนต์มาร์เก็ตติ้ง'],
            datasets: [{
              label: 'ROI (%)',
              data: [320, 280, 450, 380, 290],
              backgroundColor: [
                chartColors.blue,
                chartColors.green,
                chartColors.purple,
                chartColors.amber,
                chartColors.red
              ],
              borderRadius: 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }

      // Customer Funnel Chart
      const customerFunnelCtx = document.getElementById('customerFunnelChart');
      if (customerFunnelCtx) {
        // Destroy existing chart if any
        const existingChart = Chart.getChart(customerFunnelCtx);
        if (existingChart) {
          existingChart.destroy();
        }
        
        const customerFunnelChart = new Chart(customerFunnelCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['เข้าชมเว็บไซต์', 'ดูสินค้า', 'ใส่รถเข็น', 'เริ่มชำระเงิน', 'ซื้อสำเร็จ'],
            datasets: [{
              label: 'จำนวนลูกค้า',
              data: [10000, 6500, 2800, 1200, 850],
              backgroundColor: chartColors.blue,
              borderRadius: 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    // Initialize small charts (if any)
    function initializeSmallCharts() {
        // Small chart 1: Sales by Region (Bar Chart) - only if element exists
        const salesByRegionElement = document.getElementById('salesByRegionChart');
        if (salesByRegionElement) {
          const ctxSmall1 = salesByRegionElement.getContext('2d');
          const salesByRegionChart = new Chart(ctxSmall1, {
          type: 'bar',
          data: {
            labels: ['ภาคเหนือ', 'ภาคตะวันออกเฉียงเหนือ', 'ภาคกลาง', 'ภาคตะวันออก', 'ภาคใต้'],
            datasets: [{
              label: 'ยอดขาย (บาท)',
              data: [2500000, 1500000, 3000000, 2000000, 3500000],
              backgroundColor: [
                '#3b82f6',
                '#10b981',
                '#f97316',
                '#ef4444',
                '#8b5cf6'
              ],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  color: '#374151'
                }
              },
              y: {
                ticks: {
                  color: '#374151',
                  callback: function(value) {
                    return '฿' + (value/1000000).toFixed(1) + 'M';
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    label += ': ฿' + context.parsed.y.toLocaleString();
                    return label;
                  }
                }
              }
            }
          }
        });
      }

      // Small chart 2: Product Performance (Line Chart) - only if element exists
      const productPerformanceElement = document.getElementById('productPerformanceChart');
      if (productPerformanceElement) {
        const ctxSmall2 = productPerformanceElement.getContext('2d');
        const productPerformanceChart = new Chart(ctxSmall2, {
          type: 'line',
          data: {
            labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.'],
            datasets: [{
              label: 'ประสิทธิภาพสินค้า',
              data: [85, 92, 78, 95, 88, 91],
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
      }
    }

    // Wait for the DOM to load
    // Show/Hide Loading Function
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // โหลดและเล่น Lottie animation
        if (!lottieAnimation) {
          console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('✅ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('❌ Error loading Lottie animation:', error);
              // No fallback spinner - just show empty container
              document.getElementById('lottieContainer').innerHTML = '';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Load sidebar first
      try {
        const response = await fetch('/views/marketing/includes/sidebar.html');
        const sidebarHtml = await response.text();
        const sidebarContainer = document.getElementById('sidebar-container');
        if (sidebarContainer) {
          sidebarContainer.innerHTML = sidebarHtml;
          // Initialize sidebar functionality
          if (typeof initializeSidebar === 'function') {
            initializeSidebar();
          }
        }
      } catch (error) {
        console.error('Error loading sidebar:', error);
        // Fallback: show basic sidebar structure
        const sidebarContainer = document.getElementById('sidebar-container');
        if (sidebarContainer) {
          sidebarContainer.innerHTML = '<aside class="w-64 bg-white dark:bg-gray-800 sticky top-0 h-screen"><div class="p-4">Sidebar Loading Error</div></aside>';
        }
      }
      
      // Initialize Toggle Menu
      initToggleMenu();
      
      // Initialize Dark Mode
      initDarkMode();
      
      // Initialize Charts
      initializeCharts();
      
      // Initialize Small Charts
      initializeSmallCharts();
      
      // Set up event listeners
      setupEventListeners();
      
      // Load marketing summary data
      loadMarketingSummary();
      
      // Load sales trend data
      loadSalesTrendData();
      
      // Load product category data
      loadProductCategoryData();
      
      // Load age distribution data
      loadAgeDistributionData();
      
      // Load installment period data
      loadInstallmentPeriodData();
      
      // Load regional sales data
      loadRegionalSalesData();
      
      // Current date for report
      document.getElementById('employeeName').textContent = 'reefinX';
    });
    
    // Initialize sidebar toggle
    function initToggleMenu() {
      const btnToggleMenu = document.getElementById('btnToggleMenu');
      const sidebar = document.getElementById('sidebar');

      if (btnToggleMenu && sidebar) {
        btnToggleMenu.addEventListener('click', function() {
          if (sidebar.classList.contains('w-64')) {
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-0');
            this.innerHTML = '<i class="bi bi-chevron-right"></i>';
          } else {
            sidebar.classList.remove('w-0');
            sidebar.classList.add('w-64');
            this.innerHTML = '<i class="bi bi-chevron-left"></i>';
          }
        });
      }
    }
    
    // Initialize dark mode toggle
    function initDarkMode() {
      const btnToggleDark = document.getElementById('btnToggleDark');
      const darkModeLabel = document.getElementById('darkModeLabel');

      if (btnToggleDark) {
        // Check system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.classList.add('dark');
          if (darkModeLabel) darkModeLabel.textContent = 'Light Mode';
          btnToggleDark.innerHTML = '<i class="bi bi-brightness-high text-xl text-yellow-500 dark:text-yellow-400"></i><span class="ml-3">Light Mode</span>';
        }

        btnToggleDark.addEventListener('click', function() {
          if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            if (darkModeLabel) darkModeLabel.textContent = 'Dark Mode';
            btnToggleDark.innerHTML = '<i class="bi bi-moon text-xl text-slate-600"></i><span class="ml-3">Dark Mode</span>';
          } else {
            document.documentElement.classList.add('dark');
            if (darkModeLabel) darkModeLabel.textContent = 'Light Mode';
            btnToggleDark.innerHTML = '<i class="bi bi-brightness-high text-xl text-yellow-500"></i><span class="ml-3">Light Mode</span>';
          }
        });
      }
    }

    // Load Marketing Summary Data
    async function loadMarketingSummary() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || '30days';
        const response = await fetch(`/api/branch-stock-history/marketing-summary?period=${timeRange}`);
        const result = await response.json();
        
        if (result.success) {
          updateSummaryCards(result.data);
        } else {
          console.error('Error loading marketing summary:', result.message);
          // Show fallback data or error message
          showFallbackData();
        }
      } catch (error) {
        console.error('Error fetching marketing summary:', error);
        showFallbackData();
      }
    }

    // Load Sales Trend Data
    async function loadSalesTrendData() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || '30days';
        const response = await fetch(`/api/branch-stock-history/sales-trend?period=${timeRange}`);
        const result = await response.json();
        
        if (result.success) {
          updateSalesTrendChart(result.data);
        } else {
          console.error('Error loading sales trend:', result.message);
          // Show fallback chart data
          updateSalesTrendChart(getFallbackChartData());
        }
      } catch (error) {
        console.error('Error fetching sales trend:', error);
        updateSalesTrendChart(getFallbackChartData());
      }
    }

    // Load Product Category Data
    async function loadProductCategoryData() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || '30days';
        const response = await fetch(`/api/branch-stock-history/sales-by-category?period=${timeRange}&limit=5`);
        const result = await response.json();
        
        if (result.success) {
          updateProductCategoryChart(result.data);
        } else {
          console.error('Error loading product category data:', result.message);
          // Show fallback chart data
          updateProductCategoryChart(getFallbackCategoryData());
        }
      } catch (error) {
        console.error('Error fetching product category data:', error);
        updateProductCategoryChart(getFallbackCategoryData());
      }
    }

    // Load Age Distribution Data
    async function loadAgeDistributionData() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || '30days';
        console.log('🔍 Loading age distribution data for period:', timeRange);
        
        const response = await fetch(`/api/branch-stock-history/customers-by-age?period=${timeRange}`);
        console.log('📊 Age distribution API response status:', response.status);
        
        const result = await response.json();
        console.log('📊 Age distribution API result:', result);
        
        if (result.success) {
          console.log('✅ Age distribution data loaded successfully:', result.data);
          updateAgeDistributionChart(result.data);
        } else {
          console.error('❌ Error loading age distribution data:', result.message);
          console.log('📊 Using fallback age data');
          // Show fallback chart data
          updateAgeDistributionChart(getFallbackAgeData());
        }
      } catch (error) {
        console.error('❌ Error fetching age distribution data:', error);
        console.log('📊 Using fallback age data due to error');
        updateAgeDistributionChart(getFallbackAgeData());
      }
    }

    // Get fallback chart data
    function getFallbackChartData() {
      return {
        labels: ['วันที่ 1', 'วันที่ 2', 'วันที่ 3', 'วันที่ 4', 'วันที่ 5', 'วันที่ 6', 'วันที่ 7'],
        datasets: [
          {
            label: 'ยอดขาย (บาท)',
            data: [0, 0, 0, 0, 0, 0, 0],
            type: 'sales'
          },
          {
            label: 'จำนวนลูกค้า',
            data: [0, 0, 0, 0, 0, 0, 0],
            type: 'customers'
          }
        ]
      };
    }

    // Get fallback category data
    function getFallbackCategoryData() {
      return {
        categories: [
          { category: 'ไม่มีข้อมูล', sales: 0, percentage: 100 }
        ],
        totalSales: 0
      };
    }

    // Get fallback age data
    function getFallbackAgeData() {
      return {
        ageGroups: [
          { ageGroup: '18-24', customerCount: 0 },
          { ageGroup: '25-34', customerCount: 0 },
          { ageGroup: '35-44', customerCount: 0 },
          { ageGroup: '45-54', customerCount: 0 },
          { ageGroup: '55+', customerCount: 0 }
        ],
        totalCustomers: 0
      };
    }

    // Load Installment Period Data
    async function loadInstallmentPeriodData() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || 'year';
        console.log('🔍 Loading installment period data for period:', timeRange);
        
        const response = await fetch(`/api/branch-stock-history/installment-periods?period=${timeRange}`);
        console.log('📊 Installment period API response status:', response.status);
        
        const result = await response.json();
        console.log('📊 Installment period API result:', result);
        
        if (result.success) {
          console.log('✅ Installment period data loaded successfully:', result.data);
          updateInstallmentPeriodChart(result.data);
        } else {
          console.error('❌ Error loading installment period data:', result.message);
          console.log('📊 Using fallback installment period data');
          // Show fallback chart data
          updateInstallmentPeriodChart(getFallbackInstallmentData());
        }
      } catch (error) {
        console.error('❌ Error fetching installment period data:', error);
        console.log('📊 Using fallback installment period data due to error');
        updateInstallmentPeriodChart(getFallbackInstallmentData());
      }
    }

    // Get fallback installment data
    function getFallbackInstallmentData() {
      return {
        periods: [
          { period: '3 เดือน', count: 0, percentage: 30 },
          { period: '6 เดือน', count: 0, percentage: 25 },
          { period: '12 เดือน', count: 0, percentage: 35 },
          { period: '24 เดือน', count: 0, percentage: 10 },
          { period: '36+ เดือน', count: 0, percentage: 0 }
        ],
        totalInstallments: 0
      };
    }

    // Load Regional Sales Data
    async function loadRegionalSalesData() {
      try {
        const timeRange = document.getElementById('timeRangeFilter')?.value || 'year';
        console.log('🗺️ Loading regional sales data for period:', timeRange);
        
        const response = await fetch(`/api/branch-stock-history/sales-by-region?period=${timeRange}`);
        console.log('🗺️ Regional sales API response status:', response.status);
        
        const result = await response.json();
        console.log('🗺️ Regional sales API result:', result);
        
        if (result.success) {
          console.log('✅ Regional sales data loaded successfully:', result.data);
          updateRegionalSalesDisplay(result.data);
          updateRegionalSalesChart(result.data);
        } else {
          console.error('❌ Error loading regional sales data:', result.message);
          console.log('🗺️ Using fallback regional sales data');
          // Show fallback chart data
          const fallbackData = getFallbackRegionalData();
          updateRegionalSalesDisplay(fallbackData);
          updateRegionalSalesChart(fallbackData);
        }
      } catch (error) {
        console.error('❌ Error fetching regional sales data:', error);
        console.log('🗺️ Using fallback regional sales data due to error');
        const fallbackData = getFallbackRegionalData();
        updateRegionalSalesDisplay(fallbackData);
        updateRegionalSalesChart(fallbackData);
      }
    }

    // Get fallback regional data
    function getFallbackRegionalData() {
      return {
        regions: [
          { region: 'ภาคใต้', totalSales: 3500000, totalTransactions: 1250, percentage: 35.0, avgTransactionValue: 2800, branchCount: 8, salesPerTransaction: 2800 },
          { region: 'ภาคกลาง', totalSales: 3000000, totalTransactions: 1100, percentage: 30.0, avgTransactionValue: 2727, branchCount: 12, salesPerTransaction: 2727 },
          { region: 'ภาคเหนือ', totalSales: 2500000, totalTransactions: 900, percentage: 25.0, avgTransactionValue: 2778, branchCount: 6, salesPerTransaction: 2778 },
          { region: 'ภาคตะวันออก', totalSales: 2000000, totalTransactions: 750, percentage: 20.0, avgTransactionValue: 2667, branchCount: 4, salesPerTransaction: 2667 },
          { region: 'ภาคตะวันออกเฉียงเหนือ', totalSales: 1500000, totalTransactions: 600, percentage: 15.0, avgTransactionValue: 2500, branchCount: 5, salesPerTransaction: 2500 }
        ],
        totalSales: 12500000,
        totalTransactions: 4600,
        isRealData: false
      };
    }

    // Update Regional Sales Display
    function updateRegionalSalesDisplay(data) {
      console.log('🗺️ Updating regional sales display with data:', data);
      
      const regionalDataContainer = document.getElementById('regionalSalesData');
      if (!regionalDataContainer) {
        console.error('❌ Regional sales data container not found!');
        return;
      }
      
      // Clear existing content
      regionalDataContainer.innerHTML = '';
      
      // Create regional data cards
      data.regions.forEach((region, index) => {
        const regionCard = document.createElement('div');
        regionCard.className = 'flex items-center justify-between p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow';
        
        const regionColor = getRegionColor(index);
        
        regionCard.innerHTML = `
          <div class="flex items-center">
            <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${regionColor}"></div>
            <div>
              <div class="font-semibold text-gray-900 dark:text-gray-100">${region.region}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">${region.branchCount} สาขา • ${region.totalTransactions.toLocaleString()} ธุรกรรม</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-lg text-gray-900 dark:text-gray-100">฿${region.totalSales.toLocaleString()}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">${region.percentage.toFixed(1)}% ของยอดขายรวม</div>
          </div>
        `;
        
        regionalDataContainer.appendChild(regionCard);
      });
      
      // Update summary stats
      const totalSalesElement = document.getElementById('totalRegionalSales');
      const totalTransactionsElement = document.getElementById('totalRegionalTransactions');
      const topRegionElement = document.getElementById('topRegion');
      const dataSourceElement = document.getElementById('dataSource');
      
      if (totalSalesElement) {
        totalSalesElement.textContent = `฿${data.totalSales.toLocaleString()}`;
      }
      
      if (totalTransactionsElement) {
        totalTransactionsElement.textContent = data.totalTransactions.toLocaleString();
      }
      
      if (topRegionElement && data.regions.length > 0) {
        topRegionElement.textContent = data.regions[0].region;
      }
      
      if (dataSourceElement) {
        dataSourceElement.textContent = data.isRealData ? 'ข้อมูลจริง' : 'ข้อมูลตัวอย่าง';
        dataSourceElement.className = `font-semibold ml-2 ${data.isRealData ? 'text-green-600' : 'text-orange-600'}`;
      }
      
      console.log('✅ Regional sales display updated successfully');
    }

    // Get region color
    function getRegionColor(index) {
      const colors = [
        '#3b82f6', // Blue
        '#10b981', // Green
        '#f59e0b', // Amber
        '#ef4444', // Red
        '#8b5cf6', // Purple
        '#06b6d4', // Cyan
        '#84cc16', // Lime
        '#f97316'  // Orange
      ];
      return colors[index % colors.length];
    }

    // Update Regional Sales Chart
    function updateRegionalSalesChart(data) {
      console.log('🗺️ Updating regional sales chart with data:', data);
      
      const regionalChartElement = document.getElementById('regionalSalesChart');
      if (!regionalChartElement) {
        console.error('❌ Regional sales chart element not found!');
        return;
      }
      
      // Destroy existing chart if any
      const existingChart = Chart.getChart(regionalChartElement);
      if (existingChart) {
        console.log('🗑️ Destroying existing regional sales chart');
        existingChart.destroy();
      }
      
      // Prepare data for chart
      const labels = data.regions.map(region => region.region);
      const salesData = data.regions.map(region => region.totalSales);
      const colors = data.regions.map((_, index) => getRegionColor(index));
      
      console.log('🗺️ Chart labels:', labels);
      console.log('🗺️ Chart data:', salesData);
      
      const ctx = regionalChartElement.getContext('2d');
      const regionalSalesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'ยอดขาย',
            data: salesData,
            backgroundColor: colors,
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                color: '#374151'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const region = data.regions[context.dataIndex];
                  return [
                    `${context.label}: ฿${region.totalSales.toLocaleString()}`,
                    `สัดส่วน: ${region.percentage.toFixed(1)}%`,
                    `ธุรกรรม: ${region.totalTransactions.toLocaleString()} รายการ`,
                    `เฉลี่ยต่อธุรกรรม: ฿${region.salesPerTransaction.toLocaleString()}`
                  ];
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true
          }
        }
      });
      
      console.log('✅ Regional sales chart created successfully');
    }

    // Update Summary Cards with real data
    function updateSummaryCards(data) {
      // Update Total Sales
      const totalSalesElement = document.getElementById('totalSalesValue');
      if (totalSalesElement) {
        totalSalesElement.textContent = formatCurrency(data.totalSales || 0);
      }
      
      const salesGrowthElement = document.getElementById('salesGrowthTrend');
      if (salesGrowthElement) {
        updateTrendElement(salesGrowthElement, data.salesGrowth || 0);
      }

      // Update New Customers
      const newCustomersElement = document.getElementById('newCustomersValue');
      if (newCustomersElement) {
        newCustomersElement.textContent = (data.newCustomers || 0).toLocaleString();
      }
      
      const customersGrowthElement = document.getElementById('customersGrowthTrend');
      if (customersGrowthElement) {
        updateTrendElement(customersGrowthElement, data.customerGrowth || 0);
      }

      // Update Repeat Rate
      const repeatRateElement = document.getElementById('repeatRateValue');
      if (repeatRateElement) {
        repeatRateElement.textContent = `${data.repeatRate || 0}%`;
      }
      
      const repeatRateGrowthElement = document.getElementById('repeatRateGrowthTrend');
      if (repeatRateGrowthElement) {
        updateTrendElement(repeatRateGrowthElement, data.repeatRateGrowth || 0);
      }

      // Update Average Order Value
      const avgOrderElement = document.getElementById('avgOrderValue');
      if (avgOrderElement) {
        avgOrderElement.textContent = formatCurrency(data.avgOrderValue || 0);
      }
      
      const avgOrderGrowthElement = document.getElementById('avgOrderGrowthTrend');
      if (avgOrderGrowthElement) {
        updateTrendElement(avgOrderGrowthElement, data.avgOrderGrowth || 0);
      }
    }

    // Update trend element with proper styling
    function updateTrendElement(element, growthPercent) {
      const isPositive = growthPercent >= 0;
      const icon = isPositive ? 'bi-arrow-up' : 'bi-arrow-down';
      const trendClass = isPositive ? 'positive' : 'negative';
      
      element.className = `trend ${trendClass}`;
      element.innerHTML = `<i class="bi ${icon}"></i> ${Math.abs(growthPercent).toFixed(1)}% จากเดือนที่แล้ว`;
    }

    // Format currency
    function formatCurrency(amount) {
      return '฿' + amount.toLocaleString('th-TH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }

    // Show fallback data when API fails
    function showFallbackData() {
      const fallbackData = {
        totalSales: 0,
        salesGrowth: 0,
        newCustomers: 0,
        customerGrowth: 0,
        repeatRate: 0,
        repeatRateGrowth: 0,
        avgOrderValue: 0,
        avgOrderGrowth: 0
      };
      updateSummaryCards(fallbackData);
    }

    // Update Sales Trend Chart with real data
    function updateSalesTrendChart(chartData) {
      const salesTrendElement = document.getElementById('salesTrendChart');
      if (!salesTrendElement) return;
      
      // Destroy existing chart if any
      const existingChart = Chart.getChart(salesTrendElement);
      if (existingChart) {
        existingChart.destroy();
      }
      
      // Find datasets
      const salesDataset = chartData.datasets.find(d => d.type === 'sales');
      const customersDataset = chartData.datasets.find(d => d.type === 'customers');
      
      const ctx = salesTrendElement.getContext('2d');
      const salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: 'ยอดขาย (บาท)',
              data: salesDataset ? salesDataset.data : [],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              yAxisID: 'y',
              fill: true
            },
            {
              label: 'จำนวนลูกค้า',
              data: customersDataset ? customersDataset.data : [],
              borderColor: '#f59e0b',
              backgroundColor: 'transparent',
              borderWidth: 3,
              borderDash: [5, 5],
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'ยอดขาย (บาท)'
              },
              ticks: {
                callback: function(value) {
                  if (value >= 1000000) {
                  return '฿' + (value/1000000).toFixed(1) + 'M';
                  } else if (value >= 1000) {
                    return '฿' + (value/1000).toFixed(1) + 'K';
                  }
                  return '฿' + value.toLocaleString();
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'จำนวนลูกค้า'
              },
              grid: {
                drawOnChartArea: false,
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                    if (context.dataset.yAxisID === 'y') {
                      label += '฿' + context.parsed.y.toLocaleString();
                    } else {
                      label += context.parsed.y + ' คน';
                    }
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }
      
    // Update Product Category Chart with real data
    function updateProductCategoryChart(categoryData) {
      const productCategoryElement = document.getElementById('productCategoryChart');
      if (!productCategoryElement) return;
      
      // Destroy existing chart if any
      const existingChart = Chart.getChart(productCategoryElement);
      if (existingChart) {
        existingChart.destroy();
      }
      
      // Prepare data for chart
      const labels = categoryData.categories.map(item => item.category);
      const data = categoryData.categories.map(item => item.percentage);
      const colors = [
        '#3b82f6', // Blue
        '#10b981', // Green
        '#8b5cf6', // Purple
        '#f59e0b', // Amber
        '#ec4899', // Pink
        '#ef4444', // Red
        '#06b6d4', // Cyan
        '#84cc16', // Lime
        '#f97316', // Orange
        '#6366f1'  // Indigo
      ];
      
      const ctx = productCategoryElement.getContext('2d');
      const productCategoryChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const categoryItem = categoryData.categories[context.dataIndex];
                  const percentage = categoryItem.percentage;
                  const sales = categoryItem.sales || 0;
                  return [
                    context.label + ': ' + percentage.toFixed(1) + '%',
                    'ยอดขาย: ฿' + sales.toLocaleString()
                  ];
                }
              }
            }
          }
        }
      });
    }

    // Update Age Distribution Chart with real data
    function updateAgeDistributionChart(ageData) {
      console.log('📊 Updating age distribution chart with data:', ageData);
      
      const ageDistributionElement = document.getElementById('ageDistributionChart');
      if (!ageDistributionElement) {
        console.error('❌ Age distribution chart element not found!');
        return;
      }
      
      // Destroy existing chart if any
      const existingChart = Chart.getChart(ageDistributionElement);
      if (existingChart) {
        console.log('🗑️ Destroying existing age distribution chart');
        existingChart.destroy();
      }
      
      // Prepare data for chart
      const labels = ageData.ageGroups.map(item => item.ageGroup);
      const data = ageData.ageGroups.map(item => item.customerCount);
      
      console.log('📊 Chart labels:', labels);
      console.log('📊 Chart data:', data);
      console.log('📊 Total customers:', ageData.totalCustomers);
      
      const ctx = ageDistributionElement.getContext('2d');
      const ageDistributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'จำนวนลูกค้า',
            data: data,
            backgroundColor: '#14b8a6',
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const ageGroup = ageData.ageGroups[context.dataIndex];
                  const customerCount = ageGroup.customerCount;
                  const totalSales = ageGroup.totalSales || 0;
                  const avgPurchase = ageGroup.avgPurchasePerCustomer || 0;
                  
                  return [
                    `จำนวนลูกค้า: ${customerCount} คน`,
                    `ยอดขายรวม: ฿${totalSales.toLocaleString()}`,
                    `ยอดขายเฉลี่ย: ฿${avgPurchase.toLocaleString()}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      console.log('✅ Age distribution chart created successfully');
    }

    // Update Installment Period Chart with real data
    function updateInstallmentPeriodChart(installmentData) {
      console.log('📊 Updating installment period chart with data:', installmentData);
      
      const installmentPeriodElement = document.getElementById('installmentPeriodChart');
      if (!installmentPeriodElement) {
        console.error('❌ Installment period chart element not found!');
        return;
      }
      
      // Destroy existing chart if any
      const existingChart = Chart.getChart(installmentPeriodElement);
      if (existingChart) {
        console.log('🗑️ Destroying existing installment period chart');
        existingChart.destroy();
      }
      
      // Prepare data for chart
      const labels = installmentData.periods.map(item => item.period);
      const data = installmentData.periods.map(item => item.count);
      const percentages = installmentData.periods.map(item => item.percentage);
      
      console.log('📊 Chart labels:', labels);
      console.log('📊 Chart data:', data);
      console.log('📊 Chart percentages:', percentages);
      console.log('📊 Total installments:', installmentData.totalInstallments);
      
      // Define chart colors
      const chartColors = {
        green: '#10b981',
        blue: '#3b82f6',
        orange: '#f97316',
        red: '#ef4444',
        purple: '#8b5cf6'
      };
      
      const ctx = installmentPeriodElement.getContext('2d');
      const installmentPeriodChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'จำนวนการขาย',
            data: installmentData.totalInstallments > 0 ? data : percentages, // ใช้ percentage ถ้าไม่มีข้อมูลจริง
            backgroundColor: [
              chartColors.green,
              chartColors.blue,
              chartColors.orange,
              chartColors.red,
              chartColors.purple
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#374151'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const periodItem = installmentData.periods[context.dataIndex];
                  const count = periodItem.count;
                  const totalAmount = periodItem.totalAmount || 0;
                  const avgAmount = periodItem.avgAmount || 0;
                  const percentage = periodItem.percentage;
                  
                  if (installmentData.totalInstallments > 0) {
                    return [
                      `${context.label}: ${count} รายการ (${percentage.toFixed(1)}%)`,
                      `ยอดขายรวม: ฿${totalAmount.toLocaleString()}`,
                      `ยอดขายเฉลี่ย: ฿${avgAmount.toLocaleString()}`
                    ];
                  } else {
                    return `${context.label}: ${percentage.toFixed(1)}% (ข้อมูลตัวอย่าง)`;
                  }
                }
              }
            }
          }
        }
      });
      
      console.log('✅ Installment period chart created successfully');
    }

    // Show Debug Modal
    function showDebugModal(title, data) {
      const modalContent = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: #333;">${title}</h3>
              <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>
            
            <div style="margin-bottom: 15px;">
              <strong>Debug Information:</strong>
            </div>
            
            <textarea style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f8f8; border: 1px solid #ddd; padding: 10px;" readonly>${JSON.stringify(data, null, 2)}</textarea>
            
            <div style="text-align: center; margin-top: 15px;">
              <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                      style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Close
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalContent);
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Time Range Filter
      const timeRangeFilter = document.getElementById('timeRangeFilter');
      if (timeRangeFilter) {
        timeRangeFilter.addEventListener('change', function() {
          console.log('Time range changed to:', this.value);
          // Reload all data with new time range
          loadMarketingSummary();
          loadSalesTrendData();
          loadProductCategoryData();
          loadAgeDistributionData();
          loadInstallmentPeriodData();
          loadRegionalSalesData();
        });
      }

      // Download Report Button
      const downloadReportBtn = document.getElementById('downloadReportBtn');
      if (downloadReportBtn) {
        downloadReportBtn.addEventListener('click', function() {
          console.log('Downloading report...');
          // Add download logic here
        });
      }

      // Debug Age Data Button
      const debugAgeDataBtn = document.getElementById('debugAgeDataBtn');
      if (debugAgeDataBtn) {
        debugAgeDataBtn.addEventListener('click', async function() {
          console.log('🧪 === Debug Age Distribution Data ===');
          
          // Test API directly
          try {
            const timeRange = document.getElementById('timeRangeFilter')?.value || '30days';
            console.log('🔍 Testing API with period:', timeRange);
            
            const response = await fetch(`/api/branch-stock-history/customers-by-age?period=${timeRange}`);
            console.log('📡 API Response Status:', response.status);
            console.log('📡 API Response Headers:', Object.fromEntries(response.headers.entries()));
            
            const result = await response.json();
            console.log('📊 Raw API Response:', JSON.stringify(result, null, 2));
            
            if (result.success) {
              console.log('✅ API Success - Data received');
              console.log('📊 Age Groups:', result.data.ageGroups);
              console.log('📊 Total Customers:', result.data.totalCustomers);
              
              // Force update chart
              updateAgeDistributionChart(result.data);
              
              // Show modal with results
              showDebugModal('Age Distribution Debug Results', result);
            } else {
              console.error('❌ API Error:', result.message);
              showDebugModal('Age Distribution API Error', result);
            }
          } catch (error) {
            console.error('❌ Debug Error:', error);
            showDebugModal('Debug Error', { error: error.message, stack: error.stack });
          }
        });
      }

      // Check Customer Data Button
      const checkCustomerDataBtn = document.getElementById('checkCustomerDataBtn');
      if (checkCustomerDataBtn) {
        checkCustomerDataBtn.addEventListener('click', async function() {
          console.log('🧪 === Checking Customer Data in Database ===');
          
          try {
            // สร้าง API endpoint ใหม่สำหรับตรวจสอบข้อมูลลูกค้า
            const response = await fetch('/api/branch-stock-history/debug-customer-data');
            console.log('📡 Customer Data API Response Status:', response.status);
            
            const result = await response.json();
            console.log('📊 Customer Data Results:', result);
            
            // แสดงผลใน modal
            showDebugModal('Customer Data Analysis', result);
            
          } catch (error) {
            console.error('❌ Error checking customer data:', error);
            showDebugModal('Customer Data Error', { error: error.message });
          }
        });
      }

      // Debug Regional Data Button
      const debugRegionalDataBtn = document.getElementById('debugRegionalDataBtn');
      if (debugRegionalDataBtn) {
        debugRegionalDataBtn.addEventListener('click', async function() {
          console.log('🧪 === Debug Regional Sales Data ===');
          
          // Test API directly
          try {
            const timeRange = document.getElementById('timeRangeFilter')?.value || 'year';
            console.log('🔍 Testing Regional API with period:', timeRange);
            
            const response = await fetch(`/api/branch-stock-history/sales-by-region?period=${timeRange}`);
            console.log('📡 API Response Status:', response.status);
            console.log('📡 API Response Headers:', Object.fromEntries(response.headers.entries()));
            
            const result = await response.json();
            console.log('📊 Raw API Response:', JSON.stringify(result, null, 2));
            
            if (result.success) {
              console.log('✅ API Success - Data received');
              console.log('🗺️ Regions:', result.data.regions);
              console.log('🗺️ Total Sales:', result.data.totalSales);
              console.log('🗺️ Total Transactions:', result.data.totalTransactions);
              
              // Force update display and chart
              updateRegionalSalesDisplay(result.data);
              updateRegionalSalesChart(result.data);
              
              // Show modal with results
              showDebugModal('Regional Sales Debug Results', result);
            } else {
              console.error('❌ API Error:', result.message);
              showDebugModal('Regional Sales API Error', result);
            }
          } catch (error) {
            console.error('❌ Debug Error:', error);
            showDebugModal('Debug Error', { error: error.message, stack: error.stack });
          }
        });
      }

      // Refresh Regional Data Button
      const refreshRegionalDataBtn = document.getElementById('refreshRegionalDataBtn');
      if (refreshRegionalDataBtn) {
        refreshRegionalDataBtn.addEventListener('click', function() {
          console.log('🔄 Refreshing regional sales data...');
          loadRegionalSalesData();
        });
      }

      // Debug Installment Data Button
      const debugInstallmentDataBtn = document.getElementById('debugInstallmentDataBtn');
      if (debugInstallmentDataBtn) {
        debugInstallmentDataBtn.addEventListener('click', async function() {
          console.log('🧪 === Debug Installment Period Data ===');
          
          // Test API directly
          try {
            const timeRange = document.getElementById('timeRangeFilter')?.value || 'year';
            console.log('🔍 Testing Installment API with period:', timeRange);
            
            const response = await fetch(`/api/branch-stock-history/installment-periods?period=${timeRange}`);
            console.log('📡 API Response Status:', response.status);
            console.log('📡 API Response Headers:', Object.fromEntries(response.headers.entries()));
            
            const result = await response.json();
            console.log('📊 Raw API Response:', JSON.stringify(result, null, 2));
            
            if (result.success) {
              console.log('✅ API Success - Data received');
              console.log('📊 Installment Periods:', result.data.periods);
              console.log('📊 Total Installments:', result.data.totalInstallments);
              
              // Force update chart
              updateInstallmentPeriodChart(result.data);
              
              // Show modal with results
              showDebugModal('Installment Period Debug Results', result);
            } else {
              console.error('❌ API Error:', result.message);
              showDebugModal('Installment Period API Error', result);
            }
          } catch (error) {
            console.error('❌ Debug Error:', error);
            showDebugModal('Debug Error', { error: error.message, stack: error.stack });
          }
        });
      }
  </script>
</body>
</html>
              data: [2500000, 1500000, 3000000, 2000000, 3500000],
              backgroundColor: [
                chartColors.blue,
                chartColors.green,
                chartColors.orange,
                chartColors.red,
                chartColors.purple
              ],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  color: '#374151'
                }
              },
              y: {
                ticks: {
                  color: '#374151',
                  callback: function(value) {
                    return '฿' + (value/1000000).toFixed(1) + 'M';
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    label += ': ฿' + context.parsed.y.toLocaleString();
                    return label;
                  }
                }
              }
            }
          }
        });
        }

        // Small chart 2: Customer Growth (Line Chart) - only if element exists
        const customerGrowthElement = document.getElementById('customerGrowthChart');
        if (customerGrowthElement) {
          const ctxSmall2 = customerGrowthElement.getContext('2d');
        const customerGrowthChart = new Chart(ctxSmall2, {
          type: 'line',
          data: {
            labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.'],
            datasets: [{
              label: 'ลูกค้าใหม่',
              data: [50, 75, 100, 125, 150, 175, 200],
              borderColor: chartColors.green,
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true
            },
            {
              label: 'ลูกค้าที่ยกเลิก',
              data: [5, 10, 15, 20, 25, 30, 35],
              borderColor: chartColors.red,
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                ticks: {
                  color: '#374151'
                }
              },
              y: {
                ticks: {
                  color: '#374151'
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  color: '#374151'
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    label += ': ' + context.parsed.y + ' คน';
                    return label;
                  }
                }
              }
            }
          }
        });
        }

        // Initialize metric mini charts
        initializeMetricCharts();
      }

      // Initialize metric mini charts
      function initializeMetricCharts() {
        // Define chart colors for metric charts
        const chartColors = {
          blue: '#3b82f6',
          indigo: '#6366f1',
          purple: '#8b5cf6',
          pink: '#ec4899',
          red: '#ef4444',
          orange: '#f97316',
          amber: '#f59e0b',
          yellow: '#eab308',
          green: '#10b981',
          teal: '#14b8a6',
          cyan: '#06b6d4'
        };
        
        // Reach Rate Chart
        const reachRateElement = document.getElementById('reachRateChart');
        if (reachRateElement) {
          // Create canvas element if it doesn't exist
          let canvas = reachRateElement.querySelector('canvas');
          if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            reachRateElement.appendChild(canvas);
          }
          
          // Destroy existing chart if any
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
          
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['W1', 'W2', 'W3', 'W4'],
              datasets: [{
                data: [65, 72, 78, 85],
                borderColor: chartColors.blue,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }

        // Engagement Rate Chart
        const engagementRateElement = document.getElementById('engagementRateChart');
        if (engagementRateElement) {
          // Create canvas element if it doesn't exist
          let canvas = engagementRateElement.querySelector('canvas');
          if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            engagementRateElement.appendChild(canvas);
          }
          
          // Destroy existing chart if any
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
          
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['W1', 'W2', 'W3', 'W4'],
              datasets: [{
                data: [25, 28, 30, 32],
                borderColor: chartColors.green,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }

        // Conversion Rate Chart
        const conversionRateElement = document.getElementById('conversionRateChart');
        if (conversionRateElement) {
          // Create canvas element if it doesn't exist
          let canvas = conversionRateElement.querySelector('canvas');
          if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            conversionRateElement.appendChild(canvas);
          }
          
          // Destroy existing chart if any
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
          
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['W1', 'W2', 'W3', 'W4'],
              datasets: [{
                data: [5.5, 6.2, 6.8, 7.2],
                borderColor: chartColors.amber,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }

        // Acquisition Cost Chart
        const acquisitionCostElement = document.getElementById('acquisitionCostChart');
        if (acquisitionCostElement) {
          // Create canvas element if it doesn't exist
          let canvas = acquisitionCostElement.querySelector('canvas');
          if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            acquisitionCostElement.appendChild(canvas);
          }
          
          // Destroy existing chart if any
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
          
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['W1', 'W2', 'W3', 'W4'],
              datasets: [{
                data: [520, 480, 465, 450],
                borderColor: chartColors.red,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      }
    }
  </script>
</body>
</html>