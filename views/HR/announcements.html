<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประกาศ | HR System</title>
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
    
    <!-- Tailwind + DaisyUI -->
    <link href="/css/tailwind.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt','Sarabun','sans-serif'] }
                }
            },
            daisyui: { themes: ['light','dark','corporate'] },
        };
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    
    <!-- Google Fonts - Prompt & Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Sweet Alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #6b7280;
            --primary-dark: #4b5563;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --gray-light: #f8fafc;
            --gray-medium: #e2e8f0;
            --gray-dark: #64748b;
            --text-dark: #374151;
            --text-light: #f1f5f9;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --minimal-border: #e2e8f0;
            --minimal-bg: #ffffff;
            --minimal-card: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            line-height: 1.6;
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-dark);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--minimal-card);
            border: 1px solid var(--minimal-border);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .dark .card { 
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-color: #374151;
        }
        
        .announcement-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--minimal-card);
            border: 1px solid var(--minimal-border);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            border-left: 4px solid #3b82f6;
        }
        
        .announcement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .dark .announcement-card { 
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-color: #374151;
        }
        
        .announcement-card.urgent {
            border-left-color: #ef4444;
        }
        
        .announcement-card.info {
            border-left-color: #3b82f6;
        }
        
        .announcement-card.success {
            border-left-color: #10b981;
        }
        
        .announcement-card.warning {
            border-left-color: #f59e0b;
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1.25rem;
            border-bottom: 1px solid var(--minimal-border);
            border-radius: 16px 16px 0 0;
        }
        
        .dark .card-header {
            background: linear-gradient(135deg, #374151 0%, #2d3748 100%);
            border-bottom-color: #4b5563;
        }
        
        .card-body { 
            padding: 2rem; 
        }
        
        .form-control {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--minimal-border);
            border-radius: 8px;
            transition: all 0.2s;
            background: white;
            font-size: 0.875rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }
        
        .dark .form-control {
            background-color: #4a5568;
            color: white;
            border-color: #4a5568;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            padding: 0.625rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        .priority-badge {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .priority-high {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .priority-medium {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .priority-low {
            background-color: #f0f9ff;
            color: #0369a1;
        }
        
        .dark .priority-high {
            background-color: #7f1d1d;
            color: #fca5a5;
        }
        
        .dark .priority-medium {
            background-color: #78350f;
            color: #fde68a;
        }
        
        .dark .priority-low {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .stats-card {
            background: var(--minimal-card);
            border: 1px solid var(--minimal-border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }
        
        .dark .stats-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-color: #374151;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: var(--minimal-bg);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--minimal-border);
            width: 90%;
            max-width: 800px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .dark .modal-content {
            background-color: #1f2937;
            border-color: #374151;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="/uploads/Logo2.png" alt="2 พี่น้อง โมบาย" class="h-10 w-auto">
                    <div class="ml-4">
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">ระบบประกาศ</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">จัดการประกาศภายในองค์กร</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Search -->
                    <div class="relative">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="ค้นหาประกาศ..." 
                               class="form-control w-64 pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon text-gray-600 dark:text-gray-300"></i>
                    </button>
                    
                    <!-- Add Button -->
                    <button id="btnAddAnnouncement" 
                            class="btn-primary flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>เพิ่มประกาศ</span>
                    </button>
                    
                    <!-- Back to Dashboard -->
                    <a href="/HR_Dashboard" 
                       class="btn-primary bg-gradient-to-r from-gray-600 to-gray-700 flex items-center space-x-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>กลับหน้าหลัก</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                        <i class="fas fa-bullhorn text-blue-600 dark:text-blue-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">ประกาศทั้งหมด</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalAnnouncements">0</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                        <i class="fas fa-eye text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">ประกาศใหม่</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="newAnnouncements">0</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 dark:bg-red-900">
                        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">ประกาศด่วน</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="urgentAnnouncements">0</p>
                    </div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900">
                        <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">ประกาศวันนี้</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="todayAnnouncements">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-8">
            <div class="card-body">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ประเภท</label>
                            <select id="typeFilter" class="form-control w-40">
                                <option value="">ทั้งหมด</option>
                                <option value="general">ทั่วไป</option>
                                <option value="urgent">ด่วน</option>
                                <option value="info">ข้อมูล</option>
                                <option value="warning">คำเตือน</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ความสำคัญ</label>
                            <select id="priorityFilter" class="form-control w-40">
                                <option value="">ทั้งหมด</option>
                                <option value="high">สูง</option>
                                <option value="medium">ปานกลาง</option>
                                <option value="low">ต่ำ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">สถานะ</label>
                            <select id="statusFilter" class="form-control w-40">
                                <option value="">ทั้งหมด</option>
                                <option value="published" selected>เผยแพร่แล้ว</option>
                                <option value="draft">ร่าง</option>
                                <option value="expired">หมดอายุ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="btnRefresh" 
                                class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg flex items-center space-x-2 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                            <span>รีเฟรช</span>
                        </button>
                        
                        <button id="btnExport" 
                                class="btn-primary bg-gradient-to-r from-green-600 to-green-700 flex items-center space-x-2">
                            <i class="fas fa-download"></i>
                            <span>ส่งออก</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Announcements List -->
        <div class="space-y-6">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="loader"></div>
                <p class="mt-4 text-gray-500">กำลังโหลดประกาศ...</p>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <i class="fas fa-bullhorn text-gray-300 dark:text-gray-600 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">ไม่มีประกาศในขณะนี้</h3>
                <p class="text-gray-500 dark:text-gray-400 mb-4">เริ่มต้นด้วยการสร้างประกาศใหม่</p>
                <button onclick="openAddModal()" class="btn-primary">
                    เพิ่มประกาศแรก
                </button>
            </div>
            
            <!-- Announcements Container -->
            <div id="announcementsContainer" class="space-y-6">
                <!-- Announcements will be loaded here -->
            </div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="mt-8 flex justify-center hidden">
            <nav class="flex space-x-2">
                <button id="prevPage" class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-l-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    ก่อนหน้า
                </button>
                <div id="pageNumbers" class="flex">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button id="nextPage" class="px-3 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-r-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    ถัดไป
                </button>
            </nav>
        </div>
    </main>

    <!-- Add/Edit Announcement Modal -->
    <div id="announcementModal" class="modal">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h3 id="modalTitle" class="text-lg font-medium text-gray-900 dark:text-white">เพิ่มประกาศใหม่</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    
                    <form id="announcementForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">หัวข้อประกาศ *</label>
                                <input type="text" 
                                       id="title" 
                                       name="title" 
                                       required
                                       class="form-control"
                                       placeholder="ระบุหัวข้อประกาศ">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">เนื้อหา *</label>
                                <textarea id="content" 
                                          name="content" 
                                          required
                                          rows="6"
                                          class="form-control"
                                          placeholder="ระบุเนื้อหาประกาศ"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ประเภท</label>
                                    <select id="type" name="type" class="form-control">
                                        <option value="general">ทั่วไป</option>
                                        <option value="urgent">ด่วน</option>
                                        <option value="info">ข้อมูล</option>
                                        <option value="warning">คำเตือน</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ความสำคัญ</label>
                                    <select id="priority" name="priority" class="form-control">
                                        <option value="low">ต่ำ</option>
                                        <option value="medium">ปานกลาง</option>
                                        <option value="high">สูง</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">วันที่เริ่มต้น</label>
                                    <input type="datetime-local" 
                                           id="startDate" 
                                           name="startDate"
                                           class="form-control">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">วันที่สิ้นสุด</label>
                                    <input type="datetime-local" 
                                           id="endDate" 
                                           name="endDate"
                                           class="form-control">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ผู้รับ</label>
                                <select id="targetAudience" name="targetAudience" multiple class="form-control" style="min-height: 100px;">
                                    <option value="all">ทุกคน</option>
                                    <option value="management">ผู้บริหาร</option>
                                    <option value="hr">ฝ่าย HR</option>
                                    <option value="sales">ฝ่ายขาย</option>
                                    <option value="finance">ฝ่ายการเงิน</option>
                                    <option value="it">ฝ่าย IT</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       id="isPinned" 
                                       name="isPinned"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded">
                                <label for="isPinned" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                    ปักหมุดประกาศ (แสดงที่ด้านบน)
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" 
                                    id="cancelBtn"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600">
                                ยกเลิก
                            </button>
                            <button type="submit" 
                                    id="saveBtn"
                                    class="btn-primary">
                                บันทึก
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Configuration
        const API_BASE = '/api/announcements';
        let currentPage = 1;
        let totalPages = 1;
        let currentEditId = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded'); // Debug log
        
            const token = localStorage.getItem('authToken');
            console.log('Token in localStorage:', token ? 'Available' : 'Not found'); // Debug log
        
            if (!token) {
                console.warn('No auth token found! Redirecting to login...'); // Debug log
                alert('กรุณาเข้าสู่ระบบก่อน');
                window.location.href = '/login';
                return;
            }
        
            loadAnnouncements();
            loadStatistics();
            initializeEventListeners();
        });
        
        // Event Listeners
        function initializeEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', debounce(function() {
                currentPage = 1;
                loadAnnouncements();
            }, 500));
        
            // Filters
            document.getElementById('typeFilter').addEventListener('change', function() {
                currentPage = 1;
                loadAnnouncements();
            });
        
            document.getElementById('priorityFilter').addEventListener('change', function() {
                currentPage = 1;
                loadAnnouncements();
            });
        
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentPage = 1;
                loadAnnouncements();
            });
        
            // Buttons
            document.getElementById('btnAddAnnouncement').addEventListener('click', openAddModal);
            document.getElementById('btnRefresh').addEventListener('click', function() {
                loadAnnouncements();
                loadStatistics();
            });
            document.getElementById('btnExport').addEventListener('click', exportAnnouncements);
        
            // Modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('announcementForm').addEventListener('submit', saveAnnouncement);
        
            // Close modal when clicking outside
            document.getElementById('announcementModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
        
        // Load Announcements
        async function loadAnnouncements() {
            showLoading();
        
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10,
                    search: document.getElementById('searchInput').value,
                    type: document.getElementById('typeFilter').value,
                    priority: document.getElementById('priorityFilter').value,
                    status: document.getElementById('statusFilter').value
                });
        
                const token = localStorage.getItem('authToken');
                console.log('Token available:', !!token); // Debug log
        
                const response = await fetch(`${API_BASE}?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
        
                console.log('API Response:', data); // Debug log
                console.log('Announcements data:', data.data); // Debug log
        
                if (data.success) {
                    // API ส่ง data.data เป็น array โดยตรง ไม่ใช่ data.data.docs
                    const announcements = Array.isArray(data.data) ? data.data : [];
                    console.log('Processed announcements:', announcements); // Debug log
                    displayAnnouncements(announcements);
                    updatePagination(data.pagination || {});
                } else {
                    throw new Error(data.error || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                showError('ไม่สามารถโหลดข้อมูลประกาศได้: ' + error.message);
                showEmptyState();
            }
        }
        
        // Display Announcements
        function displayAnnouncements(announcements) {
            console.log('displayAnnouncements called with:', announcements); // Debug log
            const container = document.getElementById('announcementsContainer');
        
            if (!announcements || announcements.length === 0) {
                console.log('No announcements to display'); // Debug log
                showEmptyState();
                return;
            }
        
            console.log('Displaying', announcements.length, 'announcements'); // Debug log
            hideLoading();
            hideEmptyState();
        
            const html = announcements.map(announcement => `
                <div class="announcement-card ${announcement.type} p-6 relative animate-fadeIn">
                    ${announcement.isPinned ? '<i class="fas fa-thumbtack absolute top-4 left-4 text-blue-600 dark:text-blue-400"></i>' : ''}
                    <div class="absolute top-4 right-4">
                        <span class="priority-badge priority-${announcement.priority}">
                            ${getPriorityText(announcement.priority)}
                        </span>
                    </div>
                    
                    <div class="mb-4 ${announcement.isPinned ? 'ml-8' : ''}">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">${escapeHtml(announcement.title)}</h3>
                        <p class="text-gray-600 dark:text-gray-300 leading-relaxed">${escapeHtml(announcement.content)}</p>
                    </div>
                    
                    <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                        <div class="flex items-center space-x-4">
                            <span class="flex items-center">
                                <i class="fas fa-user text-xs mr-1"></i>
                                ${escapeHtml(announcement.author?.name || 'ระบบ')}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-calendar text-xs mr-1"></i>
                                ${formatDate(announcement.createdAt)}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-tag text-xs mr-1"></i>
                                ${getTypeText(announcement.type)}
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <button onclick="viewAnnouncement('${announcement._id}')" 
                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editAnnouncement('${announcement._id}')" 
                                    class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 p-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAnnouncement('${announcement._id}')" 
                                    class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${announcement.startDate || announcement.endDate ? `
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-clock mr-2"></i>
                                ${announcement.startDate ? `เริ่ม: ${formatDate(announcement.startDate)}` : ''}
                                ${announcement.startDate && announcement.endDate ? ' | ' : ''}
                                ${announcement.endDate ? `สิ้นสุด: ${formatDate(announcement.endDate)}` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        
            container.innerHTML = html;
        }
        
        // Load Statistics
        async function loadStatistics() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
        
                console.log('Statistics response:', data); // Debug log
        
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalAnnouncements').textContent = stats.total || 0;
                    document.getElementById('newAnnouncements').textContent = stats.published || 0; // เปลี่ยนจาก thisWeek
        
                    // หาจำนวน urgent จาก byType array
                    const urgentType = stats.byType?.find(type => type._id === 'urgent');
                    document.getElementById('urgentAnnouncements').textContent = urgentType?.count || 0;
        
                    document.getElementById('todayAnnouncements').textContent = stats.today || 0;
                } else {
                    console.error('Failed to load statistics:', data.error);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        // Modal Functions
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'เพิ่มประกาศใหม่';
            document.getElementById('announcementForm').reset();
        
            // Set default dates
            const now = new Date();
            const startDate = new Date(now);
            startDate.setHours(0, 0, 0, 0);
        
            const endDate = new Date(now);
            endDate.setDate(endDate.getDate() + 7);
            endDate.setHours(23, 59, 59, 999);
        
            document.getElementById('startDate').value = startDate.toISOString().slice(0, 16);
            document.getElementById('endDate').value = endDate.toISOString().slice(0, 16);
        
            showModal();
        }
        
        async function editAnnouncement(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`);
                const data = await response.json();
        
                if (data.success) {
                    currentEditId = id;
                    const announcement = data.data;
        
                    document.getElementById('modalTitle').textContent = 'แก้ไขประกาศ';
                    document.getElementById('title').value = announcement.title;
                    document.getElementById('content').value = announcement.content;
                    document.getElementById('type').value = announcement.type;
                    document.getElementById('priority').value = announcement.priority;
                    document.getElementById('isPinned').checked = announcement.isPinned;
        
                    if (announcement.startDate) {
                        document.getElementById('startDate').value = new Date(announcement.startDate).toISOString().slice(0, 16);
                    }
        
                    if (announcement.endDate) {
                        document.getElementById('endDate').value = new Date(announcement.endDate).toISOString().slice(0, 16);
                    }
        
                    showModal();
                } else {
                    throw new Error(data.error || 'ไม่สามารถโหลดข้อมูลประกาศได้');
                }
            } catch (error) {
                showError('ไม่สามารถโหลดข้อมูลประกาศได้: ' + error.message);
            }
        }
        
        async function deleteAnnouncement(id) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบประกาศนี้ใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
        
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`${API_BASE}/${id}`, {
                        method: 'DELETE'
                    });
        
                    const data = await response.json();
        
                    if (data.success) {
                        showSuccess('ลบประกาศเรียบร้อยแล้ว');
                        loadAnnouncements();
                        loadStatistics();
                    } else {
                        throw new Error(data.error || 'ไม่สามารถลบประกาศได้');
                    }
                } catch (error) {
                    showError('ไม่สามารถลบประกาศได้: ' + error.message);
                }
            }
        }
        
        async function saveAnnouncement(e) {
            e.preventDefault();
        
            const formData = new FormData(e.target);
            const data = {
                title: formData.get('title'),
                content: formData.get('content'),
                type: formData.get('type'),
                priority: formData.get('priority'),
                isPinned: formData.get('isPinned') === 'on',
                startDate: formData.get('startDate') || null,
                endDate: formData.get('endDate') || null,
                targetAudience: Array.from(document.getElementById('targetAudience').selectedOptions).map(option => option.value)
            };
        
            try {
                const url = currentEditId ? `${API_BASE}/${currentEditId}` : API_BASE;
                const method = currentEditId ? 'PATCH' : 'POST';
        
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
        
                const result = await response.json();
        
                if (result.success) {
                    showSuccess(currentEditId ? 'แก้ไขประกาศเรียบร้อยแล้ว' : 'เพิ่มประกาศเรียบร้อยแล้ว');
                    closeModal();
                    loadAnnouncements();
                    loadStatistics();
                } else {
                    throw new Error(result.error || 'ไม่สามารถบันทึกประกาศได้');
                }
            } catch (error) {
                showError('ไม่สามารถบันทึกประกาศได้: ' + error.message);
            }
        }
        
        function showModal() {
            document.getElementById('announcementModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('announcementModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEditId = null;
        }
        
        // Utility Functions
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('announcementsContainer').innerHTML = '';
            document.getElementById('emptyState').classList.add('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }
        
        function showEmptyState() {
            hideLoading();
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('announcementsContainer').innerHTML = '';
        }
        
        function hideEmptyState() {
            document.getElementById('emptyState').classList.add('hidden');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getPriorityText(priority) {
            const priorities = {
                high: 'สูง',
                medium: 'ปานกลาง',
                low: 'ต่ำ'
            };
            return priorities[priority] || priority;
        }
        
        function getTypeText(type) {
            const types = {
                general: 'ทั่วไป',
                urgent: 'ด่วน',
                info: 'ข้อมูล',
                warning: 'คำเตือน'
            };
            return types[type] || type;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'สำเร็จ',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }
        
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด',
                text: message
            });
        }
        
        // Export function (placeholder)
        function exportAnnouncements() {
            showError('ฟีเจอร์การส่งออกยังไม่พร้อมใช้งาน');
        }
        
        // View announcement (placeholder)
        function viewAnnouncement(id) {
            // You can implement a detailed view modal here
            console.log('Viewing announcement:', id);
        }
        
        // Update pagination
        function updatePagination(data) {
            if (!data.totalPages || data.totalPages <= 1) {
                document.getElementById('paginationContainer').classList.add('hidden');
                return;
            }
        
            document.getElementById('paginationContainer').classList.remove('hidden');
            totalPages = data.totalPages;
            currentPage = data.page;
        
            // Update pagination controls
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        
            // Generate page numbers (simplified)
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
        
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-2 text-sm font-medium border ${i === currentPage ? 'bg-blue-50 dark:bg-blue-900 border-blue-500 dark:border-blue-400 text-blue-600 dark:text-blue-300' : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    loadAnnouncements();
                };
                pageNumbers.appendChild(pageBtn);
            }
        
            // Previous/Next buttons
            document.getElementById('prevPage').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadAnnouncements();
                }
            };
        
            document.getElementById('nextPage').onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadAnnouncements();
                }
            };
        }
        
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or default to 'light'
        const currentTheme = localStorage.getItem('theme') || 'light';
        htmlElement.classList.toggle('dark', currentTheme === 'dark');
        updateThemeIcon();
        
        themeToggle.addEventListener('click', function() {
            const isDark = htmlElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        });
        
        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            if (htmlElement.classList.contains('dark')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }
    </script>
</body>
</html>
