<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าระบบพนักงาน</title>

    <script>
  // เช็ค token ก่อนจะโหลดอะไรเพิ่มเติม
  const token = localStorage.getItem('authToken');  // <-- เปลี่ยนตรงนี้'
  if (!token) {
    alert('กรุณาเข้าสู่ระบบก่อน');
    window.location.replace('/login');'
  }
</script>


    <!-- Favicon ต่างๆ -->
    <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <!-- Tailwind + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class','
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Prompt','sans-serif'] } '
                } 
            },
            daisyui: { themes: ['light','dark','corporate'] },'
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <!-- Google Fonts - Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      // Apply saved theme on load
      const storedTheme = localStorage.getItem('theme');'
      if (storedTheme) {
        const isDark = storedTheme === 'dark';'
        document.documentElement.classList.toggle('dark', isDark);'
        document.documentElement.setAttribute('data-theme', storedTheme);'
      }
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-transition {
            transition: all 0.3s ease;
        }
        
        .form-input-effect:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        .btn-save-effect {
            transition: all 0.2s ease;
        }
        
        .btn-save-effect:hover {
            transform: translateY(-2px);
        }
        
        /* Indicator for saved status */
        .save-indicator {
            transition: opacity 0.5s ease;
        }

        /* ปรับแต่ง scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* เพิ่มเอฟเฟกต์ฮฟเวอร์ให้กับ input */
        .input-hover-effect {
            transition: all 0.2s ease;
        }
        
        .input-hover-effect:hover {
            border-color: #3b82f6;
        }
        
        /* เอฟเฟกต์สำหรับการเช็คบ็อกซ์ */
        .checkbox-wrapper label {
            transition: all 0.2s ease;
        }
        
        .checkbox-wrapper:hover label {
            color: #3b82f6;
        }

        @layer components {
          .quota-card {
            @apply bg-white dark:bg-gray-800 shadow rounded-lg p-6 m-2 flex flex-col justify-between w-full sm:w-1/2 lg:w-1/3;
          }
          .quota-input {
            @apply input input-bordered input-sm w-20 text-center;
          }
          .quota-btn {
            @apply btn btn-sm btn-primary;
          }
        }
    </style>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-800 dark:text-gray-200">
    <script>
      // globals & handlers must load before buttons are clicked
      const initialCenter = [13.7563, 100.5018];

      // Define user‐profile API
      const USER_PROFILE_API = '/api/users/me';'
      const USERS_API_BASE = '/api/users';'

      async function getToken() {
        return localStorage.getItem('authToken');'
      }

      // เก็บไอดีสาขาที่เพิ่งสร้างหรืออัปเดต
      const newBranchIds = [];

      // โหลดข้อมูลโปรไฟล์พนักงาน
      async function loadEmployeeProfile() {
        try {
          const token = await getToken();
          if (!token) return window.location.replace('/login');'

          const res    = await fetch(`${USERS_API_BASE}/me`, {
            headers: {
              'Authorization': 'Bearer ' + token,'
              'Content-Type': 'application/json''
            }
          });
          const json   = await res.json();
          if (!res.ok) throw new Error(json.error || json.message || res.status);

          const u      = json.data;
          document.getElementById('employeeName').textContent = u.name || '(ไม่พบชื่อ)';'
          let photoUrl = u.photoUrl || '';'
          if (!photoUrl.startsWith('/') && !/^https?:\/\//.test(photoUrl)) {'
            photoUrl = '/' + photoUrl;'
          }
          document.getElementById('employeePhoto').src = photoUrl;'
          window.currentUserId = u._id || u.id;
        } catch (err) {
          console.error('Load Employee Profile Error:', err);'
          alert('ไม่สามารถโหลดโปรไฟล์ได้: ' + err.message);'
          logoutUser(false);
        }
      }

      // โหลด dropdown สาขา พร้อม optional chaining และ fallback
      async function loadBranchOptions() {
        try {
          const token = await getToken();
          const res   = await fetch('/api/branch', {'
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}'
          });
          const json = await res.json();
          if (!res.ok || !json.success) throw new Error(json.error);

          const sel = document.getElementById('zoneName');'
          sel.innerHTML = '<option value="">-- เลือกสาขา --</option>';'

          json.data.forEach(b => {
            const opt    = document.createElement('option');'
            opt.value    = b._id;
            opt.textContent = b.name;

            const lat    = b.center?.latitude  ?? '';'
            const lng    = b.center?.longitude ?? '';'
            const radius = b.radius             ?? '';'

            opt.dataset.lat    = lat;
            opt.dataset.lng    = lng;
            opt.dataset.radius = radius;

            sel.appendChild(opt);
          });
        } catch (e) {
          console.error('loadBranchOptions:', e);'
        }
      }

      // โหลดตารางสาขา: แสดงข้อมูลทั้งหมด
      async function loadBranches() {
  try {
    const token = await getToken();
    const res   = await fetch('/api/zone', {'
      headers: { 'Authorization': `Bearer ${token}` }'
    });
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error(json.error);

    // แสดงทุกสาขาที่ได้กลับมา
    const data = json.data;

    const tbody = document.getElementById('branchTbody');'
    tbody.innerHTML = data.map(b => {
      const lat    = b.center?.latitude?.toFixed(6)  ?? '';'
      const lng    = b.center?.longitude?.toFixed(6) ?? '';'
      const radius = b.radius                        ?? '';'
      const chk    = b.isActive ? 'checked' : '';'
      return `
        <tr data-id="${b._id}">
          <td><input type="text"   value="${b.name}"    class="input input-sm w-full"/></td>
          <td><input type="text"   value="${lat}"        class="input input-sm w-full"/></td>
          <td><input type="text"   value="${lng}"        class="input input-sm w-full"/></td>
          <td><input type="number" value="${radius}"     class="input input-sm w-full" min="1"/></td>
          <td><input type="checkbox" ${chk}              class="checkbox checkbox-sm"/></td>
          <td class="space-x-2">
            <button class="btn btn-sm btn-info" onclick="updateBranch('${b._id}', this)">บันทึก</button>'
            <button class="btn btn-sm btn-error" onclick="deleteBranch('${b._id}')">ลบ</button>'
          </td>
        </tr>
      `;
    }).join('');'
  } catch (e) {
    console.error('loadBranches:', e);'
  }
}

      function openTab(tabName) {
        document.querySelectorAll('.tab-content')'
          .forEach(c => c.classList.toggle('hidden', c.id !== tabName));'
        document.querySelectorAll('.tab')'
          .forEach(t => t.classList.toggle('tab-active', t.id === 'tab-' + tabName));'
        if (tabName === 'leavequota') loadLeaveQuotas();'
        if (tabName === 'zone') {'
          loadBranchOptions();
          loadBranches();
        }
      }

      function bindTabs() {
        // ผูกคลิกแท็บ
        document.querySelectorAll('.tab')'
          .forEach(tab => tab.addEventListener('click', () =>'
            openTab(tab.id.replace('tab-', ''))'
          ));
      }

      async function addLeaveType(event) {
        event.preventDefault();

        const sel = document.getElementById('newLeaveTypeId');'
        const leaveType = sel.value;
        const label = sel.options[sel.selectedIndex].text.trim();
        const totalDays = parseInt(document.getElementById('newLeaveTypeQuota').value, 10);'

        if (!leaveType || !label || isNaN(totalDays)) {
            return alert('กรุณาเลือกประเภท และกรอกโควต้าวันให้ถูกต้อง');'
        }

        try {
            const res = await fetch('/api/leave-quotas', {'
                method: 'POST','
                headers: {
                    'Content-Type': 'application/json','
                    'Authorization': `Bearer ${await getToken()}`'
                },
                body: JSON.stringify({ leaveType, label, totalDays })
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || 'สร้างไม่สำเร็จ');'

            document.getElementById('leaveTypeForm').reset();'
            await loadLeaveQuotas();

            // แสดง indicator
            const ind = document.getElementById('leaveType-save-indicator');'
            ind.style.opacity = '1';'
            setTimeout(() => ind.style.opacity = '0', 2000);'
        } catch (e) {
            console.error(e);
            alert('ไม่สามารถสร้างประเภทการลาได้: ' + e.message);'
        }
      }

      // Generic form-submit handler
      document.querySelectorAll('form').forEach(form => {'
        form.addEventListener('submit', function (e) {'
            e.preventDefault();
            const formId = this.id;
            const submitBtn = this.querySelector('button[type="submit"]');'
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-2"></i> กำลังบันทึก...';'
            submitBtn.disabled = true;

            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                const saveIndicator = document.getElementById(formId.replace('Form', '-save-indicator'));'
                if (saveIndicator) {
                    saveIndicator.style.opacity = '1';'
                    setTimeout(() => saveIndicator.style.opacity = '0', 3000);'
                }
            }, 800);
        });
      });

      // เริ่มต้นแอป
      async function initApp() {
        await loadEmployeeProfile();    // ← โหลดโปรไฟล์ก่อนส่วนอื่นๆ
        bindTabs();
        openTab('worktime');'
        loadLeaveQuotas();
        loadSettings();
      }
      document.addEventListener('DOMContentLoaded', initApp);'
    </script>

    <!-- Toggle Sidebar Button -->
    <button id="btnToggleMenu" class="fixed left-0 top-1/2 -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition-all">
        <i class="bi bi-chevron-left"></i>
    </button>
    
    <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 flex flex-col transition-all duration-300">
      <a href="hr_dashboard">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto"/>
        </div>
      </a>
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li>
            <a href="hr_dashboard" class="flex items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700">
              <i class="bi bi-speedometer2 text-xl text-indigo-600 dark:text-indigo-400"></i>
              <span class="ml-3">แดชบอร์ด</span>
            </a>
          </li>
          <li>
            <a href="employee_directory" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-people-fill text-xl text-blue-500 dark:text-blue-400"></i>
              <span class="ml-3">พนักงาน</span>
            </a>
          </li>
          <li>
            <a href="attendance" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-clock text-xl text-green-500 dark:text-green-400"></i>
              <span class="ml-3">บันทึกเวลาเข้า-ออก</span>
            </a>
          </li>
          <li>
            <a href="leave_requests" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-file-earmark-text text-xl text-yellow-500 dark:text-yellow-300"></i>
              <span class="ml-3">การลา</span>
            </a>
          </li>
          <li>
            <a href="payroll" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-cash-stack text-xl text-emerald-500 dark:text-emerald-400"></i>
              <span class="ml-3">เงินเดือน</span>
            </a>
          </li>
          <li>
            <a href="performance_reviews" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-award text-xl text-purple-500 dark:text-purple-400"></i>
              <span class="ml-3">ประเมินผลงาน</span>
            </a>
          </li>
          <li>
            <a href="bonus_list" class="flex items-center px-4 h-12 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gift text-xl text-pink-500 dark:text-pink-400 mr-3"></i>
              <span>รายการโบนัส</span>
            </a>
          </li>
          <li>
           
          <li class="mt-4">
            <a href="role_management" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gear text-xl text-gray-600 dark:text-gray-300"></i>
              <span class="ml-3">การตั้งค่า</span>
            </a>
          </li>
          <li class="mt-6">
            <button id="btnToggleDark" class="flex items-center h-12 px-4 rounded-lg w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-moon text-xl text-slate-600 dark:text-slate-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <li>
            <button id="btnLogoutSidebar" class="flex items-center h-12 px-4 rounded-lg w-full text-left text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">ออกจากระบบ</span>
            </button>
          </li>
          <li>
            <div id="profile" class="flex items-center h-12 px-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
              <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Employee Photo" class="w-10 h-10 rounded-full mr-3"/>
              <span id="employeeName">Loading...</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

          <!-- Main Content Area -->
          <div class="flex-1 flex flex-col overflow-hidden">
              <!-- Header -->
              <header class="bg-white dark:bg-gray-800 shadow-sm z-10 p-4 flex justify-between items-center">
                  <div class="flex items-center">
                      <h1 class="text-2xl font-bold text-gray-800 dark:text-white">การตั้งค่าระบบ</h1>
                      </span>
                  </div>
                  
                  <div class="flex items-center space-x-4">
                      <div class="dropdown dropdown-end">
                          <button id="notificationBtn" tabindex="0" class="btn btn-ghost btn-circle">
                              <div class="indicator">
                                  <i class="bi bi-bell-fill text-xl"></i>
                                  <span class="badge badge-sm badge-primary indicator-item badge-notification">3</span>
                              </div>
                          </button>
                          <div tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-80 dark:bg-gray-700">
                              <div class="p-3 text-sm font-medium border-b border-gray-200 dark:border-gray-600">
                                  การแจ้งเตือน
                              </div>
                              <div class="max-h-60 overflow-y-auto">
                                  <a class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 block">
                                      <div class="font-medium">มีการอนุมัติคำขอลา</div>
                                      <div class="text-xs text-gray-500 dark:text-gray-400">10 นาทีที่แล้ว</div>
                                  </a>
                                  <a class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 block">
                                      <div class="font-medium">มีการส่งเอกสารใหม่</div>
                                      <div class="text-xs text-gray-500 dark:text-gray-400">1 ชั่วโมงที่แล้ว</div>
                                  </a>
                                  <a class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 block">
                                      <div class="font-medium">แจ้งเตือนการประชุม</div>
                                      <div class="text-xs text-gray-500 dark:text-gray-400">วันนี้ 15:00 น.</div>
                                  </a>
                              </div>
                              <div class="p-2 text-center border-t border-gray-200 dark:border-gray-600">
                                  <a class="text-sm text-blue-500 dark:text-blue-400 hover:underline">ดูการแจ้งเตือนทั้งหมด</a>
                              </div>
                          </div>
                      </div>
                  </div>
              </header>

              <!-- Settings Content -->
              <main class="flex-1 overflow-y-auto p-5 bg-gray-100 dark:bg-gray-900">
                  <div class="max-w-4xl mx-auto animate-fadeIn">
                      <!-- Breadcrumb Navigation -->
                      <div class="text-sm breadcrumbs mb-4 text-gray-500 dark:text-gray-400">
                          <ul>
                              <li><a href="hr_dashboard">หน้าหลัก</a></li>
                              <li><a href="role_management">การตั้งค่า</a></li>
                              <li>ตั้งค่าระบบพนักงาน</li>
                          </ul>
                      </div>
                      
                      <!-- Settings Card -->
                      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                          <div class="p-6">
                              <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                                  <i class="bi bi-sliders mr-3 text-blue-500"></i>
                                  ตั้งค่าระบบพนักงาน
                              </h2>
                              
                              <!-- Tab Navigation -->
                              <div class="tabs tabs-boxed bg-gray-100 dark:bg-gray-700 p-1 mb-8">
                                  <button id="tab-worktime" class="tab tab-active tab-transition flex items-center">
                                      <i class="bi bi-clock mr-2"></i> เวลาทำงาน
                                  </button>
                                  <button id="tab-computer" class="tab tab-transition flex items-center">
                                      <i class="bi bi-laptop mr-2"></i> ค่าคอม
                                  </button>
                                  <button id="tab-bonus" class="tab tab-transition flex items-center">
                                      <i class="bi bi-gift mr-2"></i> โบนัส
                                  </button>
                                   <button id="tab-leavequota" class="tab tab-transition flex items-center">
                                     <i class="bi bi-calendar-range mr-2"></i> วันลาคงเหลือ
                                   </button>
                                  <button id="tab-zone" class="tab tab-transition flex items-center">
                                      <i class="bi bi-pin-map mr-2"></i> พื้นที่เช็คอิน
                                  </button>
                              </div>
                              
                              <!-- Tab Content -->
                              <div>
                                  <!-- Worktime Tab -->
                                  <div id="worktime" class="tab-content block">
                                      <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg mb-6">
                                          <div class="flex items-start">
                                              <i class="bi bi-info-circle text-blue-500 text-xl mt-1"></i>
                                              <div class="ml-4">
                                                  <h4 class="text-blue-700 dark:text-blue-300 font-semibold">เกี่ยวกับการตั้งค่าเวลาทำงาน</h4>
                                                  <p class="text-sm text-blue-600 dark:text-blue-400">
                                                      การตั้งค่าเวลาทำงานจะมีผลต่อการบันทึกเวลาเข้า-ออกงานและการคำนวณการมาสาย 
                                                      ระบบจะใช้ค่านี้ในการคำนวณโบนัสการมาทำงานของพนักงาน
                                                  </p>
                                              </div>
                                          </div>
                                      </div>
                                      
                                      <form id="worktimeForm" action="settings" method="post" class="space-y-6" onsubmit="return validateWorktimeForm()">
                                          <input type="hidden" name="setting_type" value="worktime">
                                          
                                          <!-- การตั้งค่าเวลาทำงานปกติ -->
                                          <div class="grid md:grid-cols-2 gap-6">
                                              <div class="form-control">
                                                  <label for="work_start_time" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-sunrise mr-2 text-yellow-500"></i>
                                                          เวลาเริ่มงาน
                                                      </span>
                                                  </label>
                                                  <input type="time" 
                                                      id="work_start_time" 
                                                      name="work_start_time" 
                                                      value="09:00" 
                                                      required 
                                                      class="input input-bordered form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                              </div>
                                              
                                              <div class="form-control">
                                                  <label for="work_end_time" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-sunset mr-2 text-orange-500"></i>
                                                          เวลาเลิกงาน
                                                      </span>
                                                  </label>
                                                  <input type="time" 
                                                      id="work_end_time" 
                                                      name="work_end_time" 
                                                      value="18:00" 
                                                      required 
                                                      class="input input-bordered form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                              </div>
                                          </div>
                                          
                                          <div class="form-control">
                                              <label for="late_threshold" class="label font-semibold">
                                                  <span class="label-text dark:text-gray-200">
                                                      <i class="bi bi-exclamation-triangle mr-2 text-red-500"></i>
                                                      ถือว่าสายหลังจาก (นาที)
                                                  </span>
                                              </label>
                                              <div class="relative">
                                                  <input type="number" 
                                                      id="late_threshold" 
                                                      name="late_threshold" 
                                                      min="0" max="60" 
                                                      value="15" 
                                                      required 
                                                      class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">นาที</span>
                                              </div>
                                              <label class="label">
                                                  <span class="label-text-alt text-gray-500 dark:text-gray-400">การมาทำงานหลังจากเวลาที่กำหนดจะถูกบันทึกเป็นการมาสาย</span>
                                              </label>
                                          </div>

                                          <!-- บันทึกการตั้งค่า -->
                                          <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                                              <span id="worktime-save-indicator" class="save-indicator text-green-500 opacity-0">
                                                  <i class="bi bi-check-circle mr-1"></i> บันทึกการตั้งค่าเรียบร้อย
                                              </span>
                                              <div>
                                                  <button type="reset" class="btn btn-outline mr-2">
                                                      <i class="bi bi-arrow-counterclockwise mr-2"></i> ยกเลิก
                                                  </button>
                                                  <button type="submit" class="btn btn-primary btn-save-effect">
                                                      <i class="bi bi-save mr-2"></i> บันทึกการตั้งค่า
                                                  </button>
                                              </div>
                                          </div>
                                      </form>
                                  </div>
                                  <script>
                                      function validateWorktimeForm() {
                                          const startTime = document.getElementById('work_start_time').value;'
                                          const endTime = document.getElementById('work_end_time').value;'

                                          if (startTime >= endTime) {
                                              alert('เวลาเริ่มงานต้องน้อยกว่าเวลาเลิกงาน');'
                                              return false;
                                          }
                                          return true;
                                      }
                                  </script>
                                  
                                  <!-- Computer Tab -->
                                  <div id="computer" class="tab-content hidden">
                                      <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg mb-6">
                                          <div class="flex items-start">
                                              <i class="bi bi-info-circle text-green-500 text-xl mt-1"></i>
                                              <div class="ml-4">
                                                  <h4 class="text-green-700 dark:text-green-300 font-semibold">เกี่ยวกับการตั้งค่าค่าคอม</h4>
                                                  <p class="text-sm text-green-600 dark:text-green-400">
                                                      การตั้งค่าค่าคอมกำหนดจำนวนเงินที่พนักงานสามารถเบิกเพื่อซื้อหรือบำรุงรักษาอุปกรณ์คอมสำหรับการทำงาน
                                                  </p>
                                              </div>
                                          </div>
                                      </div>
                                      
                                      <form id="computerForm" action="settings" method="post" class="space-y-6">
                                          <input type="hidden" name="setting_type" value="computer">
                                          
                                          <div class="grid md:grid-cols-2 gap-6">
                                              <div class="form-control">
                                                  <label for="computer_allowance" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-currency-dollar mr-2 text-green-500"></i>
                                                          ค่าคอมต่อเดือน
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="computer_allowance" 
                                                          name="computer_allowance" 
                                                          min="0" step="100" 
                                                          value="1000" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">บาท</span>
                                                  </div>
                                              </div>
                                              
                                              <div class="form-control">
                                                  <label for="computer_allowance_max" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-calculator mr-2 text-purple-500"></i>
                                                          ค่าคอมสูงสุด
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="computer_allowance_max" 
                                                          name="computer_allowance_max" 
                                                          min="0" step="1000" 
                                                          value="50000" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">บาท</span>
                                                  </div>
                                              </div>
                                          </div>
                                          
                                          <div class="form-control">
                                              <label for="eligibility_months" class="label font-semibold">
                                                  <span class="label-text dark:text-gray-200">
                                                      <i class="bi bi-calendar-check mr-2 text-blue-500"></i>
                                                      ระยะเวลาการทำงานขั้นต่ำเพื่อรับสิทธิ์
                                                  </span>
                                              </label>
                                              <div class="relative">
                                                  <input type="number" 
                                                      id="eligibility_months" 
                                                      name="eligibility_months" 
                                                      min="0"  
                                                      value="3" 
                                                      required 
                                                      class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">เดือน</span>
                                              </div>
                                              <label class="label">
                                                  <span class="label-text-alt text-gray-500 dark:text-gray-400">พนักงานต้องทำงานครบตามระยะเวลานี้จึงมีสิทธิ์เบิกค่าคอมพิวเตอร์</span>
                                              </label>
                                          </div>
                                          
                                          <div class="form-control checkbox-wrapper">
                                              <label class="label cursor-pointer justify-start">
                                                  <input type="checkbox" id="require_receipts" name="require_receipts" class="checkbox checkbox-primary mr-3" checked>
                                                  <span class="label-text dark:text-gray-200">
                                                      <i class="bi bi-receipt mr-2 text-amber-500"></i>
                                                      ต้องแนบใบเสร็จเพื่อเบิก
                                                  </span>
                                              </label>
                                              <label class="label ml-8">
                                                  <span class="label-text-alt text-gray-500 dark:text-gray-400">พนักงานต้องแนบใบเสร็จรับเงินเพื่อขอเบิกค่าคอม</span>
                                              </label>
                                          </div>
                                          
                                          <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                                              <span id="computer-save-indicator" class="save-indicator text-green-500 opacity-0">
                                                  <i class="bi bi-check-circle mr-1"></i> บันทึกการตั้งค่าเรียบร้อย
                                              </span>
                                              <div>
                                                  <button type="reset" class="btn btn-outline mr-2">
                                                      <i class="bi bi-arrow-counterclockwise mr-2"></i> ยกเลิก
                                                  </button>
                                                  <button type="submit" class="btn btn-primary btn-save-effect">
                                                      <i class="bi bi-save mr-2"></i> บันทึกการตั้งค่า
                                                  </button>
                                              </div>
                                          </div>
                                      </form>
                                  </div>
                                  
                                  <!-- Bonus Tab -->
                                  <div id="bonus" class="tab-content hidden">
                                      <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg mb-6">
                                          <div class="flex items-start">
                                              <i class="bi bi-info-circle text-purple-500 text-xl mt-1"></i>
                                              <div class="ml-4">
                                                  <h4 class="text-purple-700 dark:text-purple-300 font-semibold">เกี่ยวกับการตั้งค่าโบนัส</h4>
                                                  <p class="text-sm text-purple-600 dark:text-purple-400">
                                                      การตั้งค่าโบนัสกำหนดรูปแบบและเงื่อนไขการจ่ายโบนัสให้กับพนักงาน 
                                                      ระบบจะคำนวณโบนัสตามเกณฑ์ที่กำหนดไว้
                                                  </p>
                                              </div>
                                          </div>
                                      </div>
                                      
                                      <form id="bonusForm" action="settings" method="post" class="space-y-6">
                                          <input type="hidden" name="setting_type" value="bonus">
                                          
                                          <div class="grid md:grid-cols-2 gap-6">
                                              <div class="form-control">
                                                  <label for="annual_bonus_months" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-calendar-event mr-2 text-red-500"></i>
                                                          โบนัสประจำปี
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="annual_bonus_months" 
                                                          name="annual_bonus_months" 
                                                          min="0" step="0.5" 
                                                          value="2" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">เดือน</span>
                                                  </div>
                                                  <label class="label">
                                                      <span class="label-text-alt text-gray-500 dark:text-gray-400">จำนวนเดือนของเงินเดือนที่จะจ่ายเป็นโบนัสประจำปี</span>
                                                  </label>
                                              </div>
                                              
                                              <div class="form-control">
                                                  <label for="performance_bonus_percent" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-graph-up-arrow mr-2 text-emerald-500"></i>
                                                          โบนัสตามผลงาน
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="performance_bonus_percent" 
                                                          name="performance_bonus_percent" 
                                                          min="0" max="100" 
                                                          value="10" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">%</span>
                                                  </div>
                                                  <label class="label">
                                                      <span class="label-text-alt text-gray-500 dark:text-gray-400">เปอร์เซ็นต์ของเงินเดือนที่จะจ่ายเพิ่มตามผลการประเมิน</span>
                                                  </label>
                                              </div>
                                          </div>
                                          
                                          <div class="grid md:grid-cols-2 gap-6">
                                              <div class="form-control">
                                                  <label for="attendance_bonus" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-calendar-check mr-2 text-blue-500"></i>
                                                          โบนัสการมาทำงาน
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="attendance_bonus" 
                                                          name="attendance_bonus" 
                                                          min="0" step="100" 
                                                          value="1000" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">บาท/เดือน</span>
                                                  </div>
                                              </div>
                                              
                                              <div class="form-control">
                                                  <label for="max_late_days" class="label font-semibold">
                                                      <span class="label-text dark:text-gray-200">
                                                          <i class="bi bi-exclamation-triangle mr-2 text-amber-500"></i>
                                                          จำนวนวันสายสูงสุดที่ยังได้รับโบนัส
                                                      </span>
                                                  </label>
                                                  <div class="relative">
                                                      <input type="number" 
                                                          id="max_late_days" 
                                                          name="max_late_days" 
                                                          min="0" max="31" 
                                                          value="3" 
                                                          required 
                                                          class="input input-bordered w-full form-input-effect input-hover-effect focus:input-primary dark:bg-gray-700 dark:border-gray-600">
                                                      <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">วัน</span>
                                                  </div>
                                                  <label class="label">
                                                      <span class="label-text-alt text-gray-500 dark:text-gray-400">พนักงานที่มาสายเกินจำนวนวันที่กำหนดจะไม่ได้รับโบนัสการมาทำงาน</span>
                                                  </label>
                                              </div>
                                          </div>
                                          
                                          <div class="mt-8 flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                                              <span id="bonus-save-indicator" class="save-indicator text-green-500 opacity-0">
                                                  <i class="bi bi-check-circle mr-1"></i> บันทึกการตั้งค่าเรียบร้อย
                                              </span>
                                              <div>
                                                  <button type="reset" class="btn btn-outline mr-2">
                                                      <i class="bi bi-arrow-counterclockwise mr-2"></i> ยกเลิก
                                                  </button>
                                                  <button type="submit" class="btn btn-primary btn-save-effect">
                                                      <i class="bi bi-save mr-2"></i> บันทึกการตั้งค่า
                                                  </button>
                                              </div>
                                          </div>
                                      </form>
                                  </div>

                                  <!-- Leave Quotas Tab -->
                                  <div id="leavequota" class="tab-content hidden px-4">
                                      <!-- ◼️ ฟอร์มสร้างประเภทการลาใหม่ -->
                                      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                          <h4 class="text-lg font-semibold mb-4 flex items-center">
                                              <i class="bi bi-plus-square-fill mr-2 text-green-500"></i> สร้างประเภทการลาใหม่
                                          </h4>
                                          <form id="leaveTypeForm" onsubmit="return addLeaveType(event)" class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                              <!-- เลือกประเภทการลา -->
                                              <select id="newLeaveTypeId" class="select select-bordered w-full col-span-1 sm:col-span-2" required>
                                                  <option value="" disabled selected>เลือกประเภทการลา</option>
                                                  <option value="sick" data-icon="bi bi-activity-heartbeat text-red-500">⚕️ ลาป่วย</option>
                                                  <option value="personal" data-icon="bi bi-briefcase text-green-500">💼 ลากิจ</option>
                                                  <option value="annual" data-icon="bi bi-umbrella-fill text-blue-500">☂️ ลาพักร้อน</option>
                                                  <option value="maternity" data-icon="bi bi-baby text-pink-500">👶 ลาคลอด</option>
                                                  <option value="training" data-icon="bi bi-mortarboard text-purple-500">🎓 ลาฝึกอบรม</option>
                                              </select>

                                              <!-- โควต้าจำนวนวัน -->
                                              <input id="newLeaveTypeQuota" type="number" placeholder="โควต้าวัน" class="input input-bordered w-full col-span-1 sm:col-span-2" min="0" required />

                                              <!-- ปุ่มเพิ่ม -->
                                              <button type="submit" class="btn btn-sm btn-success col-span-1 sm:col-span-4 mt-4">
                                                  <i class="bi bi-plus-circle mr-2"></i> เพิ่มประเภทการลา
                                              </button>
                                          </form>
                                      </div>

                                      <!-- Indicator สำหรับการบันทึก -->
                                      <span id="leaveType-save-indicator" class="save-indicator text-green-500 opacity-0">
                                          <i class="bi bi-check-circle mr-1"></i> บันทึกเรียบร้อย
                                      </span>

                                      <!-- ◼️ ตารางแสดงประเภทการลา -->
                                      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                          <h4 class="text-lg font-semibold mb-4">รายการประเภทการลา</h4>
                                          <div class="overflow-x-auto">
                                              <table class="table w-full table-zebra">
                                                  <thead>
                                                      <tr>
                                                          <th>รหัส</th>
                                                          <th>ชื่อประเภท</th>
                                                          <th>โควต้าวัน</th>
                                                          <th>จัดการ</th>
                                                      </tr>
                                                  </thead>
                                                  <tbody id="leaveTypeTbody">
                                                      <!-- JS จะเติมข้อมูลที่นี่ -->
                                                  </tbody>
                                              </table>
                                          </div>
                                      </div>
                                  </div>
                                  
                                  <!-- Zone Tab -->
                                  <div id="zone" class="tab-content hidden">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
                                      <h3 class="text-xl font-semibold mb-4"><i class="bi bi-pin-map mr-2 text-indigo-500"></i> พื้นที่เช็คอิน</h3>
                                      <div class="mb-4">
                                        <label for="zoneName" class="block font-semibold mb-1">ชื่อสาขา:</label>
                                        <select id="zoneName" class="w-full select select-bordered">
                                          <option value="">-- เลือกสาขา --</option>
                                        </select>
                                      </div>
                                      <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                          <label class="block font-semibold mb-1">ละติจูด (Latitude):</label>
                                          <input type="number" step="0.000001" id="latitude" class="input input-bordered w-full"
                                            placeholder="เช่น 13.756331">
                                        </div>
                                        <div>
                                          <label class="block font-semibold mb-1">ลองจิจูด (Longitude):</label>
                                          <input type="number" step="0.000001" id="longitude" class="input input-bordered w-full"
                                            placeholder="เช่น 100.501762">
                                        </div>
                                      </div>
                                      <div class="mb-4">
                                        <label for="radius" class="block font-semibold mb-1">รัศมี (เมตร):</label>
                                        <input type="number" id="radius" class="input input-bordered w-full" value="100" min="1">
                                      </div>
                                      <div class="mb-4">
                                        <div id="map" style="width:100%; height:300px; margin-bottom:1rem;"></div>
                                      </div>
                                      <button type="button" class="btn btn-primary" onclick="saveZone()">บันทึกพื้นที่</button>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                                      <h4 class="text-lg font-semibold mb-4">รายการสาขา</h4>
                                      <div class="overflow-x-auto">
                                        <table class="table w-full table-zebra">
                                          <thead>
                                            <tr>
                                              <th>ชื่อสาขา</th><th>ละติจูด</th><th>ลองจิจูด</th>
                                              <th>รัศมี (ม.)</th><th>สถานะ</th><th>จัดการ</th>
                                            </tr>
                                          </thead>
                                          <tbody id="branchTbody"></tbody>
                                        </table>
                                      </div>
                                    </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                    
                    <!-- Last Update Info -->
                    <div class="mt-4 text-right text-sm text-gray-500 dark:text-gray-400">
                        การอัปเดตล่าสุด: <span class="font-medium">10 พ.ค. 2568 15:59:45</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

  <!-- ====== เพิ่ม Leave‐Quota API ====== -->
  <script>
    const API_BASE = '/api/leave-quotas';'

    // แผนที่ระหว่าง leaveType กับคลาสไอคอน
    const leaveTypeIcons = {
      annual:    'bi bi-umbrella-fill','
      sick:      'bi bi-activity-heartbeat','
      personal:  'bi bi-briefcase','
      maternity: 'bi bi-baby','
      training:  'bi bi-mortarboard','
      // เพิ่มเติมถ้ามีประเภทอื่น...
    };

    async function getToken() {
      return localStorage.getItem('authToken');'
    }

    // โหลดรายการประเภทการลา
    async function loadLeaveQuotas() {
        const token = await getToken();
        if (!token) return window.location.replace('/login');'
        const res = await fetch(API_BASE, {
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }'
        });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.error || 'โหลดไม่สำเร็จ');'
        renderLeaveTypeTable(json.data);
    }

    // แสดงผลประเภทการลาในตาราง พร้อมไอคอน
    function renderLeaveTypeTable(quotas) {
        const tbody = document.getElementById('leaveTypeTbody');'
        tbody.innerHTML = quotas.map(q => {
            const iconClass = leaveTypeIcons[q.leaveType] || 'bi bi-calendar-check text-gray-500';'
            return `
                <tr data-id="${q._id}">
                    <td>${q.leaveType}</td>
                    <td>
                        <i class="${iconClass} mr-2"></i>
                    <select class="select select-sm w-full leave-label-input hidden" onchange="updateIcon(this)">
                    <option value="sick" ${q.leaveType === 'sick' ? 'selected' : ''} data-icon="bi bi-activity-heartbeat text-red-500">⚕️ ลาป่วย</option>'
                    <option value="personal" ${q.leaveType === 'personal' ? 'selected' : ''} data-icon="bi bi-briefcase text-green-500">💼 ลากิจ</option>'
                    <option value="annual" ${q.leaveType === 'annual' ? 'selected' : ''} data-icon="bi bi-umbrella-fill text-blue-500">☂️ ลาพักร้อน</option>'
                    <option value="maternity" ${q.leaveType === 'maternity' ? 'selected' : ''} data-icon="bi bi-baby text-pink-500">👶 ลาคลอด</option>'
                    <option value="training" ${q.leaveType === 'training' ? 'selected' : ''} data-icon="bi bi-mortarboard text-purple-500">🎓 ลาฝึกอบรม</option>'
                </select>
                        <span class="leave-label">${q.label}</span>
                    </td>
                    <td>
                        <span class="leave-days">${q.totalDays}</span>
                        <input type="number" value="${q.totalDays}" class="input input-sm w-20 text-center hidden leave-days-input" min="0" />
                    </td>
                    <td class="space-x-2">
                        <button class="btn btn-sm btn-info edit-btn" onclick="toggleEdit('${q._id}', this)">แก้ไข</button>'
                        <button class="btn btn-sm btn-error" onclick="deleteLeaveType('${q._id}')">ลบ</button>'
                    </td>
                </tr>
            `;
        }).join('');'
    }

    function updateIcon(select) {
        const selectedOption = select.options[select.selectedIndex];
        const iconClass = selectedOption.dataset.icon || 'bi bi-calendar-check text-gray-500';'
        const iconElement = select.closest('td').querySelector('i');'
        iconElement.className = `${iconClass} mr-2`;
    }

    function toggleEdit(id, btn) {
        const row = btn.closest('tr');'
        const isEditing = row.classList.toggle('editing');'
        const labelSpan = row.querySelector('.leave-label');'
        const labelSelect = row.querySelector('.leave-label-input');'
        const daysSpan = row.querySelector('.leave-days');'
        const daysInput = row.querySelector('.leave-days-input');'

        if (isEditing) {
            // Switch to edit mode
            labelSpan.classList.add('hidden');'
            labelSelect.classList.remove('hidden');'
            daysSpan.classList.add('hidden');'
            daysInput.classList.remove('hidden');'
            btn.textContent = 'บันทึก';'
            btn.classList.replace('btn-info', 'btn-success');'
        } else {
            // Save changes
            const updatedLabel = labelSelect.options[labelSelect.selectedIndex].textContent.trim();
            const updatedLeaveType = labelSelect.value;
            const updatedDays = parseInt(daysInput.value, 10) || 0;

            updateLeaveType(id, updatedLabel, updatedLeaveType, updatedDays, btn);
        }
    }

    async function updateLeaveType(id, label, leaveType, totalDays, btn) {
        const token = await getToken();
        try {
            const res = await fetch(`${API_BASE}/${id}`, {
                method: 'PATCH','
                headers: {
                    'Content-Type': 'application/json','
                    'Authorization': `Bearer ${token}`'
                },
                body: JSON.stringify({ label, leaveType, totalDays })
            });

            if (!res.ok) throw new Error('อัปเดตไม่สำเร็จ');'
            btn.textContent = 'แก้ไข';'
            btn.classList.replace('btn-success', 'btn-info');'
            const row = btn.closest('tr');'
            row.classList.remove('editing');'
            row.querySelector('.leave-label').textContent = label;'
            row.querySelector('.leave-days').textContent = totalDays;'
            row.querySelector('.leave-label').classList.remove('hidden');'
            row.querySelector('.leave-label-input').classList.add('hidden');'
            row.querySelector('.leave-days').classList.remove('hidden');'
            row.querySelector('.leave-days-input').classList.add('hidden');'
            alert('บันทึกข้อมูลสำเร็จ');'
        } catch (e) {
            console.error('updateLeaveType error:', e);'
            alert('ไม่สามารถอัปเดตประเภทการลาได้: ' + e.message);'
        }
    }

    // ลบประเภทการลา
    async function deleteLeaveType(id) {
        if (!confirm('ยืนยันลบประเภทการลานี้?')) return;'

        const token = await getToken();
        try {
            const res = await fetch(`${API_BASE}/${id}`, {
                method: 'DELETE','
                headers: {
                    'Authorization': `Bearer ${token}`'
                }
            });

            const json = await res.json();
            if (!res.ok) {
                throw new Error(json.error || 'ไม่สามารถลบประเภทการลาได้');'
            }

            await loadLeaveQuotas();
            alert('ลบประเภทการลาสำเร็จ');'
        } catch (e) {
            console.error('deleteLeaveType error:', e);'
            alert(`ไม่สามารถลบประเภทการลาได้: ${e.message}`);
        }
    }

    // โหลดข้อมูลเมื่อเปิดแท็บ Leave Quotas
    document.querySelectorAll('.tab').forEach(tab =>'
        tab.addEventListener('click', () => {'
            if (tab.id === 'tab-leavequota') loadLeaveQuotas();'
        })
    );
  </script>
    <script>
        async function saveZone() {
            const sel      = document.getElementById('zoneName');'
            const branchId = sel.value;
            // สำหรับสร้างใหม่เราไม่ต้องแยกระหว่าง branchId หรือ zoneId
            const name     = sel.selectedOptions[0]?.text.trim();
            const lat      = parseFloat(document.getElementById('latitude').value);'
            const lng      = parseFloat(document.getElementById('longitude').value);'
            const radius   = parseInt(document.getElementById('radius').value, 10);'
            if (!name || isNaN(lat) || isNaN(lng) || isNaN(radius)) {
              return alert('กรุณากรอกข้อมูลให้ครบถ้วน');'
            }
            const payload = { name, center:{ latitude: lat, longitude: lng }, radius, isActive: true };
            const token   = await getToken();
    const url    = '/api/zone';'
    const method = 'POST';'
            try {
              const res  = await fetch(url, {
                method,
                headers: {
                  'Content-Type':'application/json','
                  'Authorization': `Bearer ${token}`'
                },
                body: JSON.stringify(payload)
              });
              const json = await res.json();
              if (!res.ok) throw new Error(json.error);

              // บันทึกไอดีสาขาใหม่
              newBranchIds.push(json.data._id);

              alert(`สาขา "${name}" ถูก${branchId?'อัปเดต':'สร้าง'}เรียบร้อย`);'
              await loadBranches();
              await loadBranchOptions();
              sel.value = '';'
              document.getElementById('latitude').value  = '';'
              document.getElementById('longitude').value = '';'
              document.getElementById('radius').value    = 100;'
              initMap();
            } catch (e) {
              console.error('saveZone:', e);'
              alert('บันทึกไม่สำเร็จ: ' + e.message);'
            }
        }

        async function updateBranch(id, btn) {
          const row = btn.closest('tr');'
          const [inpName, inpLat, inpLng, inpRad, inpActive] = row.querySelectorAll('input');'
          const payload = {
            name: inpName.value.trim(),
            center: {
              latitude: parseFloat(inpLat.value)||0,
              longitude: parseFloat(inpLng.value)||0
            },
            radius: parseInt(inpRad.value,10)||0,
            isActive: inpActive.checked
          };
          try {
            const res  = await fetch(`/api/zone/${id}`, {
              method:'PATCH','
              headers:{ 
                'Content-Type':'application/json','
                'Authorization': `Bearer ${await getToken()}` '
              },
              body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error);
            alert('อัปเดตสำเร็จ');'
            loadBranches();
            loadBranchOptions();
          } catch (e) {
            console.error('updateBranch:', e);'
            alert('อัปเดตไม่สำเร็จ: '+e.message);'
          }
        }

        async function deleteBranch(id) {
          if (!confirm('ยืนยันลบสาขานี้?')) return;'
          try {
            const token = await getToken();
            const res   = await fetch(`/api/zone/${id}`, {
              method:'DELETE','
              headers:{ 'Authorization': `Bearer ${token}` }'
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error);
            alert('ลบสำเร็จ');'
            loadBranches();
            loadBranchOptions();
          } catch (e) {
            console.error('deleteBranch:', e);'
            alert('ลบไม่สำเร็จ: '+e.message);'
          }
        }

        // Form submission handling with AJAX (ไม่เปลี่ยนแปลง)
        document.querySelectorAll('form').forEach(form => {'
            form.addEventListener('submit', function(e) {'
                e.preventDefault();
                const formId = this.id;
                const submitBtn = this.querySelector('button[type="submit"]');'
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-2"></i> กำลังบันทึก...';'
                submitBtn.disabled = true;

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    const saveIndicator = document.getElementById(formId.replace('Form', '-save-indicator'));'
                    saveIndicator.style.opacity = '1';'
                    setTimeout(() => saveIndicator.style.opacity = '0', 3000);'
                }, 800);
            });
        });

        // Toggle dark mode with persistence
        document.getElementById('btnToggleDark').addEventListener('click', () => {'
            const isDark = document.documentElement.classList.toggle('dark');'
            const theme = isDark ? 'dark' : 'light';'
            document.documentElement.setAttribute('data-theme', theme);'
            localStorage.setItem('theme', theme);'
            document.getElementById('darkModeLabel').innerText = isDark ? 'Light Mode' : 'Dark Mode';'
        });

        // Toggle sidebar แบบโค้ดที่ 1
        document.getElementById('btnToggleMenu').addEventListener('click', function() {'
            const sidebar = document.getElementById('sidebar');'
            // เรียกใช้คลาสเดียวเพื่อเลื่อน Sidebar เข้-ออก
            sidebar.classList.toggle('-ml-64');'
            const btnIcon = this.querySelector('i');'
            // สลับไอคอนให้เหมือนโค้ดที่ 1
            btnIcon.classList.toggle('bi-chevron-right');'
            btnIcon.classList.toggle('bi-chevron-left');'
        });

        // logout: ลบ authToken และ redirect ไป login
        async function logout() {
            const token = localStorage.getItem('authToken');'
            try {
                await fetch('/api/users/logout', {'
                    method: 'POST','
                    headers: {
                        'Content-Type': 'application/json','
                        'Authorization': `Bearer ${token}`'
                    }
                });
            } catch (e) {
                console.error('Logout error', e);'
            } finally {
                localStorage.removeItem('authToken');'
                window.location.href = '/login';'
            }
        }
        // ผูก event ให้ปุ่ม logout
        document.getElementById('btnLogout').addEventListener('click', logout);'
        document.getElementById('btnLogoutSidebar').addEventListener('click', logout);'

        // Load actual settings values from server (replace with actual data loading in production)
        function loadSettings() {
            console.log('Loading settings from server...');'
            
            const tabs = ['worktime', 'computer', 'bonus'];'
            tabs.forEach(tab => {
                const form = document.getElementById(tab + 'Form');'
                if (form) {
                    form.querySelectorAll('input').forEach(input => {'
                        input.classList.add('animate-pulse', 'bg-gray-100', 'dark:bg-gray-700');'
                    });
                    
                    setTimeout(() => {
                        form.querySelectorAll('input').forEach(input => {'
                            input.classList.remove('animate-pulse', 'bg-gray-100', 'dark:bg-gray-700');'
                        });
                    }, 800);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {'
          loadBranchOptions();
          loadBranches();
        });
    </script>

    <script>
      let map, geoCircle, originalRadius, pulseTimer;

      function initMap() {
        const lat = parseFloat(document.getElementById('latitude').value) || 13.7563;'
        const lng = parseFloat(document.getElementById('longitude').value) || 100.5018;'
        const r   = parseInt(document.getElementById('radius').value,10)   || 100;'

        map = new google.maps.Map(document.getElementById('map'), {'
          center: { lat, lng },
          zoom: 15
        });

        geoCircle = new google.maps.Circle({
          strokeColor: "#4285F4", strokeOpacity: 0.8, strokeWeight: 2,
          fillColor: "#4285F4", fillOpacity: 0.2,
          map: map, center: { lat, lng }, radius: r
        });

        originalRadius = r;
        startPulse();
      }

      function updateCircleCenter() {
        const lat = parseFloat(document.getElementById('latitude').value);'
        const lng = parseFloat(document.getElementById('longitude').value);'
        if (isNaN(lat)||isNaN(lng)) return;
        const center = { lat, lng };
        map.setCenter(center);
        geoCircle.setCenter(center);
      }

      function onRadiusChange() {
        const r = parseInt(document.getElementById('radius').value,10);'
        if (isNaN(r)||r<1) return;
        geoCircle.setRadius(r);
        originalRadius = r;
      }

      function startPulse() {
        let grow = true;
        pulseTimer = setInterval(() => {
          const cur = geoCircle.getRadius();
          const delta = originalRadius * 0.05;
          geoCircle.setRadius(grow ? cur + delta : cur - delta);
          grow = !grow;
        }, 800);
      }

      function stopPulse() {
        clearInterval(pulseTimer);
      }

      function updateInputsFromOption(opt) {
        const latVal = parseFloat(opt.dataset.lat);
        const lngVal = parseFloat(opt.dataset.lng);
        const rVal   = parseInt(opt.dataset.radius, 10);

        document.getElementById('latitude').value  = isNaN(latVal) ? '' : latVal.toFixed(6);'
        document.getElementById('longitude').value = isNaN(lngVal) ? '' : lngVal.toFixed(6);'
        document.getElementById('radius').value    = isNaN(rVal)   ? '' : rVal;'

        updateCircleCenter();
        onRadiusChange();
      }

      document.addEventListener('DOMContentLoaded', () => {'
        document.getElementById('zoneName').addEventListener('change', e => updateInputsFromOption(e.target.selectedOptions[0]));'
        document.getElementById('latitude').addEventListener('change', updateCircleCenter);'
        document.getElementById('longitude').addEventListener('change', updateCircleCenter);'
        document.getElementById('radius').addEventListener('input', onRadiusChange);'
      });
    </script>

  <script
  async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzMQbHjNv9byjPS7a4y9aZbLoqjaw4jzI&libraries=geometry&callback=initMap">
</script>
</body>
</html>