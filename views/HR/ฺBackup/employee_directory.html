<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>รายชื่อพนักงาน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon ต่างๆ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
      theme: { 
        extend: { 
          fontFamily: { sans: ['Prompt','sans-serif'] } '
        } 
      },
      daisyui: { themes: ['light','dark','corporate'] },'
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* เพิ่ม CSS สำหรับความสวยงาม */
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .calendar-day {
      background-color: #374151;
    }

    .calendar-day-holiday {
      background-color: #fee2e2;
      color: #ef4444;
    }

    .dark .calendar-day-holiday {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #notificationBtn span.badge-notification { /* More specific selector for the badge */
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status indicators */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-active {
      background-color: #10b981;
    }

    .status-away {
      background-color: #f59e0b;
    }

    .status-offline {
      background-color: #6b7280;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
    }

    .dark .modal-content {
      background-color: #2d3748;
      color: #f7fafc;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .dark .close:hover,
    .dark .close:focus {
      color: white;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
    }

    .dark .form-group input,
    .dark .form-group select {
      background-color: #4a5568;
      color: white;
      border-color: #4a5568;
    }
  </style>

  <!-- เพิ่ม resolvePhotoUrl & loadEmployeeProfile -->
  <script>
    // แปลง photoUrl จาก API ให้เป็น path ที่ถูกต้อง
    function resolvePhotoUrl(raw) {
      if (!raw) return '/api/placeholder/36/36';'
      if (/^https?:\/\//.test(raw)) return raw;
      return raw.startsWith('/') ? raw : '/' + raw;'
    }

    // โหลดข้อมูลผู้ใช้ปัจจุบันจาก /api/users/me
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');'
        if (!token) return;
        const res = await fetch('/api/users/me', {'
          headers: {
            'Authorization': 'Bearer ' + token,'
            'Content-Type': 'application/json''
          }
        });
        const result = await res.json();
        if (!res.ok || !result.success) throw new Error(result.error||'ไม่สามารถดึงข้อมูลผู้ใช้');'
        const user = result.data;
        document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';'
        const photoEl = document.getElementById('employeePhoto');'
        photoEl.src = user.photoUrl ? resolvePhotoUrl(user.photoUrl)
                                    : '/api/placeholder/36/36';'
      } catch (err) {
        console.error('Load Employee Profile Error:', err);'
      }
    }
  </script>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 flex flex-col transition-all duration-300">
      <a href="hr_dashboard">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto"/>
        </div>
      </a>
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li>
            <a href="hr_dashboard" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-speedometer2 text-xl text-indigo-600 dark:text-indigo-400"></i>
              <span class="ml-3">แดชบอร์ด</span>
            </a>
          </li>
          <li>
            <a href="employee_directory" class="flex items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700">
              <i class="bi bi-people-fill text-xl text-blue-500 dark:text-blue-400"></i>
              <span class="ml-3">พนักงาน</span>
            </a>
          </li>
          <li>
            <a href="attendance" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-clock text-xl text-green-500 dark:text-green-400"></i>
              <span class="ml-3">บันทึกเวลาเข้า-ออก</span>
            </a>
          </li>
          <li>
            <a href="leave_requests" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-file-earmark-text text-xl text-yellow-500 dark:text-yellow-300"></i>
              <span class="ml-3">การลา</span>
            </a>
          </li>
          <li>
            <a href="payroll" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-cash-stack text-xl text-emerald-500 dark:text-emerald-400"></i>
              <span class="ml-3">เงินเดือน</span>
            </a>
          </li>
          <li>
            <a href="performance_reviews" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-award text-xl text-purple-500 dark:text-purple-400"></i>
              <span class="ml-3">ประเมินผลงาน</span>
            </a>
          </li>
          <li>
            <a href="bonus_list" class="flex items-center px-4 h-12 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gift text-xl text-pink-500 dark:text-pink-400 mr-3"></i>
              <span>รายการโบนัส</span>
            </a>
          </li>
          <li>
        
          <li class="mt-4">
            <a href="role_management" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gear text-xl text-gray-600 dark:text-gray-300"></i>
              <span class="ml-3">การตั้งค่า</span>
            </a>
          </li>
          <li class="mt-6">
            <button id="btnToggleDark" class="flex items-center h-12 px-4 rounded-lg w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-moon text-xl text-slate-600 dark:text-slate-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <li>
            <button id="btnLogoutSidebar" class="flex items-center h-12 px-4 rounded-lg w-full text-left text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">ออกจากระบบ</span>
            </button>
          </li>
          <li>
            <div id="profile" class="flex items-center h-12 px-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
              <img id="employeePhoto" src="/api/placeholder/36/36" alt="Employee Photo" class="w-10 h-10 rounded-full mr-3"/>
              <span id="employeeName">Loading...</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 transition-all duration-300">
      <div class="container mx-auto">
        <div class="mb-6">
          <h1 class="text-2xl font-semibold text-gray-800 dark:text-white">รายชื่อพนักงาน</h1>
          <p class="text-gray-600 dark:text-gray-400">จัดการข้อมูลพนักงานทั้งหมดในระบบ HR</p>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4 mb-6">
          <div class="flex mb-4 md:mb-0 w-full md:w-auto">
            <div class="relative w-full md:w-auto flex-grow md:flex-grow-0">
              <input type="text" id="searchInput" placeholder="ค้นหาพนักงาน..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div class="absolute left-3 top-2.5 text-gray-400"><i class="bi bi-search"></i></div>
            </div>
            <button id="btnSearchEmployees" class="ml-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"><i class="bi bi-search"></i> ค้นหา</button>


          </div>
          <!-- ปุ่ม สมัคร User และ เพิ่มพนักงานใหม่ อยู่คู่กัน -->
          <div class="flex space-x-2 w-full md:w-auto">
            <a href="register_user" id="btnRegisterUser" class="w-full md:w-auto px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg flex items-center justify-center transition">
              <i class="bi bi-person-plus-fill mr-2"></i> สมัคร User
            </a>
            <!-- *** Removed onclick from here, will be handled by JS event listener *** -->
            <a href="employee" id="btnAddEmployee" class="w-full md:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center justify-center transition">
              <i class="bi bi-plus-lg mr-2"></i> เพิ่มพนักงานใหม่
            </a>
            <!-- ปุ่ม ใบแจ้งเตือน -->
            <a href="notifications" id="btnNotifications"
               class="w-full md:w-auto px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg flex items-center justify-center transition">
              <i class="bi bi-bell-fill mr-2"></i> ใบแจ้งเตือน
            </a>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-900 shadow-sm rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">รหัสพนักงาน</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">รูปพนักงาน & ชื่อ-นามสกุล</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ตำแหน่ง</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">แผนก</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">อีเมล</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">เบอร์โทรศัพท์</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">วันที่เริ่มงาน</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">การจัดการ</th>
                </tr>
              </thead>
              <tbody id="employeeList" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Add/Edit -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <span id="btnCloseEmployeeModal" class="close">&times;</span>
      <h2 id="modalTitle" class="text-xl font-semibold mb-4 dark:text-gray-100"></h2>
      <form id="employeeForm">
        <input type="hidden" id="employeeId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group"><label for="empCode">รหัสพนักงาน</label><input type="text" id="empCode" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empName">ชื่อ-นามสกุล</label><input type="text" id="empName" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empPosition">ตำแหน่ง</label><input type="text" id="empPosition" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empDepartment">แผนก</label><select id="empDepartment" required class="w-full px-3 py-2 border rounded-md"><option value="">เลือกแผนก</option><option value="บัญชี">บัญชี</option><option value="การตลาด">การตลาด</option><option value="ไอที">ไอที</option><option value="ทรัพยากรบุคคล">ทรัพยากรบุคคล</option><option value="ขาย">ขาย</option><option value="จัดซื้อ">จัดซื้อ</option><option value="ผลิต">ผลิต</option></select></div>
          <div class="form-group"><label for="empEmail">อีเมล</label><input type="email" id="empEmail" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empPhone">เบอร์โทรศัพท์</label><input type="tel" id="empPhone" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empStartDate">วันที่เริ่มงาน</label><input type="date" id="empStartDate" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empOrigin">ภูมิลำเนา</label><input type="text" id="empOrigin" class="w-full px-3 py-2 border rounded-md"></div>
        </div>
        <div class="flex justify-end mt-6 gap-2">
          <button type="button" id="btnCancelEmployeeForm" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md">ยกเลิก</button>
          <button type="button" id="btnSaveEmployeeForm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: View -->
  <div id="viewEmployeeModal" class="modal">
    <div class="modal-content">
      <span id="btnCloseViewModal" class="close">&times;</span>
      <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">ข้อมูลพนักงาน</h2>
      <div id="viewContent" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // Placed resolvePhotoUrl globally so it's accessible'
 function resolvePhotoUrl(raw) {
   if (!raw) return '/api/placeholder/36/36';'
      if (raw.startsWith('http')) return raw; // Already a full URL'
      // If starts with /uploads/ but not /uploads/employees/
      if (raw.startsWith('/uploads/') && !raw.includes('/employees/')) {'
        return raw.replace(/^\/uploads\//, '/uploads/employees/');'
      }
      // If it's just a filename without a leading slash'
      if (!raw.startsWith('/')) {'
        return `/uploads/employees/${raw}`;
      }
      // For other cases like /uploads/employees/filename.jpg (already correct) or other unhandled paths
      return raw;
    }

    // Function to open the add/edit modal
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'เพิ่มพนักงานใหม่';'
      document.getElementById('employeeForm').reset(); // Reset form fields'
      document.getElementById('employeeId').value = ''; // Clear employee ID for new entry'
      const modal = document.getElementById('employeeModal');'
      if (modal) {
        modal.style.display = 'block';'
      }
      console.log('Add/Edit Modal should be visible now for adding.');'
    }
    
    const API_BASE = '/api/employees';'
    let employees = []; // This will store the list of users/employees
    const token = localStorage.getItem('authToken');'

    // Main DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', async () => {'
      if (!token) {
        window.location.href = '/login';'
        return; // Stop further execution if no token
      }

      // Initial data fetching
      await loadEmployeeProfile(); // Fetches and updates sidebar profile
      await fetchEmployees();   // Fetches and renders employee list

      // Setup UI toggles and static event listeners
      if (localStorage.getItem('darkMode') === 'true') {'
        document.documentElement.classList.add('dark');'
        const darkModeLabel = document.getElementById('darkModeLabel');'
        if (darkModeLabel) darkModeLabel.textContent = 'Light Mode';'
      }
      
      const btnToggleDark = document.getElementById('btnToggleDark');'
      if (btnToggleDark) btnToggleDark.addEventListener('click', toggleDarkMode);'
      
      const btnToggleMenu = document.getElementById('btnToggleMenu');'
      if (btnToggleMenu) btnToggleMenu.addEventListener('click', toggleSidebar);'
      
      const btnLogoutSidebar = document.getElementById('btnLogoutSidebar');'
      if (btnLogoutSidebar) btnLogoutSidebar.addEventListener('click', logoutUser);'

      // Event listeners for static elements in the main content
      const btnSearchEmployees = document.getElementById('btnSearchEmployees');'
      if (btnSearchEmployees) btnSearchEmployees.addEventListener('click', searchEmployees);'
      
      // Modal close/cancel buttons
      const btnCloseEmployeeModal = document.getElementById('btnCloseEmployeeModal');'
      if (btnCloseEmployeeModal) btnCloseEmployeeModal.addEventListener('click', closeModal);'
      
      const btnCancelEmployeeForm = document.getElementById('btnCancelEmployeeForm');'
      if (btnCancelEmployeeForm) btnCancelEmployeeForm.addEventListener('click', closeModal);'
      
      const btnSaveEmployeeForm = document.getElementById('btnSaveEmployeeForm');'
      if (btnSaveEmployeeForm) btnSaveEmployeeForm.addEventListener('click', saveEmployee);'
      
      const btnCloseViewModal = document.getElementById('btnCloseViewModal');'
      if (btnCloseViewModal) btnCloseViewModal.addEventListener('click', closeViewModal);'

      // Event delegation for dynamically generated buttons in the employee list
      const employeeListTbody = document.getElementById('employeeList');'
      if (employeeListTbody) {
        employeeListTbody.addEventListener('click', function(event) {'
          const targetButton = event.target.closest('button'); // Get the button element'
          if (!targetButton) return;

          const action = targetButton.dataset.action;
          const employeeId = targetButton.dataset.id;

          if (action === 'view') {'
            // Note: View action is an <a> tag in your current renderEmployees, 
            // this delegation is for <button> tags. Adjust if needed.
            // viewEmployee(employeeId); 
          } else if (action === 'edit') {'
            // Note: Edit action is also an <a> tag.
            // editEmployee(employeeId);
          } else if (action === 'delete') {'
            deleteEmployee(employeeId);
          }
        });
      }
    });

    // ======= Fetch Current User's Profile ======='
    async function fetchUserProfile() {
      try {
        const res = await fetch('/api/users/me', {'
          headers: { 'Authorization': 'Bearer ' + token }'
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          if (res.status === 401 || res.status === 403) {
            alert('Session expired or invalid. Please log in again.');'
            logoutUser(false); // Pass false to avoid double alert
            return;
          }
          throw new Error(json.message || `Failed to load profile (${res.status})`);
        }
        
        const employeeNameSpan = document.getElementById('employeeName');'
        const employeePhotoImg = document.getElementById('employeePhoto');'

        if(employeeNameSpan) employeeNameSpan.textContent = json.data.name;
        if(employeePhotoImg) employeePhotoImg.src = resolvePhotoUrl(json.data.photoUrl); // Use resolvePhotoUrl

      } catch (err) {
        console.error('Error fetching user profile:', err);'
        alert('ไม่สามารถโหลดข้อมูลผู้ใช้ได้: ' + err.message);'
      }
    }

    // ======= Fetch All Users (Employees) =======
    async function fetchEmployees() {
      try {
        const res = await fetch(`${API_BASE}`, {
          headers: { 'Authorization': 'Bearer ' + token }'
        });
        if (res.status === 401) {
          alert('เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่');'
          logoutUser(false);
          return;
        }
        if (res.status === 403) {
          alert('คุณไม่มีสิทธิ์เข้าถึงข้อมูลพนักงาน');'
          return; // Or redirect, or disable features
        }
        const json = await res.json();
        if (!json.success) {
            throw new Error(json.message || `Failed to fetch employees (${res.status})`);
        }
        employees = json.data || []; // Ensure employees is an array
        renderEmployees();
      } catch (err) {
          console.error('Error fetching employees:', err);'
          const tbody = document.getElementById('employeeList');'
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน: ${err.message}</td></tr>`;
          }
      }
    } 

    // ======= Render Employee Table =======
    function renderEmployees(filteredList = null) {
      const listToRender = filteredList || employees;
      const tbody = document.getElementById('employeeList');'
      tbody.innerHTML = ''; '

      if (!listToRender || listToRender.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
              ไม่พบข้อมูลพนักงาน
            </td>
          </tr>`;
        return;
      }

      listToRender.forEach(emp => {
        // Use resolvePhotoUrl for employee images in the table as well
        const imagePath = resolvePhotoUrl(emp.imageUrl); // Assuming 'imageUrl' is the field from API for table'
        
        const tr = document.createElement('tr');'
        tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition';'
        const employeeId = emp._id || emp.id; // Use _id from MongoDB or id

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.employeeCode || 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <img
                  src="${imagePath}" 
                  alt="${emp.name || 'Photo'}"'
                  class="h-10 w-10 rounded-full object-cover"
                />
              </div>
              <div class="ml-4">
                <div class="font-medium">${emp.name || 'N/A'}</div>'
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.position || 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.department || 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.email || 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.phone || 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${emp.startDate ? formatDate(emp.startDate) : 'N/A'}</td>'
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <a href="employee_detail?id=${employeeId}" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200" title="แก้ไข/ดูรายละเอียด">
                <i class="bi bi-pencil-square"></i>
              </a>
              <button data-action="delete" data-id="${employeeId}" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200" title="ลบพนักงาน">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    
    // ======= Helper: Format Date =======
    function formatDate(dateString) {
      if (!dateString) return 'N/A';'
      try {
        return new Date(dateString).toLocaleDateString('th-TH', {'
          year: 'numeric', month: 'short', day: 'numeric' // Using 'short' for month for brevity'
        });
      } catch (e) {
        console.warn('Invalid Date for formatting:', dateString);'
        return 'Invalid Date';'
      }
    }

    // ======= UI Toggles =======
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');'
      const isDark = document.documentElement.classList.contains('dark');'
      const darkModeLabel = document.getElementById('darkModeLabel');'
      if (darkModeLabel) darkModeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';'
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');'
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');'
      const icon = document.querySelector('#btnToggleMenu i');'
      if (sidebar) sidebar.classList.toggle('-ml-64'); // Assuming sidebar width is w-64 (16rem)'
      if (icon) {
        icon.classList.toggle('bi-chevron-left');'
        icon.classList.toggle('bi-chevron-right');'
      }
    }

    // ======= Search Employees =======
    function searchEmployees() {
      const searchInput = document.getElementById('searchInput');'
      if (!searchInput) return;
      const searchTerm = searchInput.value.toLowerCase().trim();
      if (!searchTerm) {
        renderEmployees(); // Render all if search is empty
        return;
      }
      const filtered = employees.filter(emp =>
        (emp.employeeCode && emp.employeeCode.toLowerCase().includes(searchTerm)) ||
        (emp.name && emp.name.toLowerCase().includes(searchTerm)) ||
        (emp.position && emp.position.toLowerCase().includes(searchTerm)) ||
        (emp.department && emp.department.toLowerCase().includes(searchTerm)) ||
        (emp.email && emp.email.toLowerCase().includes(searchTerm))
      );
      renderEmployees(filtered);
    }
    
    // ======= Modal Controls =======
    // openAddModal is defined globally earlier

    function closeModal() {
      const modal = document.getElementById('employeeModal');'
      if (modal) modal.style.display = 'none';'
    }

    function closeViewModal() {
      const modal = document.getElementById('viewEmployeeModal');'
      if (modal) modal.style.display = 'none';'
    }

    // ======= CRUD Operations for Employees/Users =======
    function editEmployee(employeeId) { // Called from employee_detail page or similar, not directly from this table's buttons yet'
      const emp = employees.find(e => (e.id === employeeId || e._id === employeeId));
      if (!emp) {
        alert('ไม่พบข้อมูลพนักงานสำหรับแก้ไข');'
        return;
      }
      document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลพนักงาน';'
      const empIdField = document.getElementById('employeeId');'
      if(empIdField) empIdField.value = emp.id || emp._id;
      
      // Populate form fields (ensure element IDs exist)
      const empCode = document.getElementById('empCode'); if(empCode) empCode.value = emp.employeeCode || '';'
      const empName = document.getElementById('empName'); if(empName) empName.value = emp.name || '';'
      const empPosition = document.getElementById('empPosition'); if(empPosition) empPosition.value = emp.position || '';'
      const empDepartment = document.getElementById('empDepartment'); if(empDepartment) empDepartment.value = emp.department || '';'
      const empEmail = document.getElementById('empEmail'); if(empEmail) empEmail.value = emp.email || '';'
      const empPhone = document.getElementById('empPhone'); if(empPhone) empPhone.value = emp.phone || '';'
      const empStartDate = document.getElementById('empStartDate'); '
      if(empStartDate) empStartDate.value = emp.startDate ? emp.startDate.split('T')[0] : ''; // Format for date input'
      const empOrigin = document.getElementById('empOrigin'); if(empOrigin) empOrigin.value = emp.origin || '';'
      
      const modal = document.getElementById('employeeModal');'
      if (modal) modal.style.display = 'block';'
      console.log('Add/Edit Modal should be visible now for editing employee ID:', employeeId);'
    }

    async function saveEmployee() {
      const employeeId = document.getElementById('employeeId').value;'
      const formData = new FormData(); // Use FormData for potential file uploads (image)

      // Example: if you add an <input type="file" id="empImage"> to your form
      // const imageInput = document.getElementById('empImage');'
      // if (imageInput && imageInput.files.length > 0) {
      //   formData.append('image', imageInput.files[0]);'
      // }

      formData.append('employeeCode', document.getElementById('empCode').value);'
      formData.append('name', document.getElementById('empName').value);'
      formData.append('position', document.getElementById('empPosition').value);'
      formData.append('department', document.getElementById('empDepartment').value);'
      formData.append('email', document.getElementById('empEmail').value);'
      formData.append('phone', document.getElementById('empPhone').value);'
      formData.append('startDate', document.getElementById('empStartDate').value);'
      formData.append('origin', document.getElementById('empOrigin').value);'
      // Add other fields to formData as needed

      const method = employeeId ? 'PATCH' : 'POST'; // Or PUT for update'
      const url = employeeId ? `${API_BASE}/${employeeId}` : `${API_BASE}`;

      try {
        const res = await fetch(url, {
          method,
          headers: {
            // 'Content-Type': 'application/json', // Not needed for FormData, browser sets it'
            'Authorization': 'Bearer ' + token'
          },
          body: formData // For JSON: JSON.stringify(employeeData)
        });

        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.message || `Failed to save employee (${res.status})`);
        }

        alert(json.message || 'บันทึกข้อมูลพนักงานสำเร็จ!');'
        closeModal();
        await fetchEmployees(); // Refresh the list
      } catch (err) {
        console.error('Error saving employee:', err);'
        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + err.message);'
      }
    }

    async function viewEmployee(employeeId) { // This would be called if you had a view button triggering it
      try {
        const res = await fetch(`${API_BASE}/${employeeId}`, {
          headers: { 'Authorization': 'Bearer ' + token }'
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.message || `Failed to fetch employee details (${res.status})`);
        }
        const emp = json.data;
        const viewContent = document.getElementById('viewContent');'
        if (viewContent) {
          viewContent.innerHTML = `
            <p><strong>รหัสพนักงาน:</strong> ${emp.employeeCode || 'N/A'}</p>'
            <p><strong>ชื่อ-นามสกุล:</strong> ${emp.name || 'N/A'}</p>'
            <p><strong>ตำแหน่ง:</strong> ${emp.position || 'N/A'}</p>'
            <p><strong>แผนก:</strong> ${emp.department || 'N/A'}</p>'
            <p><strong>อีเมล:</strong> ${emp.email || 'N/A'}</p>'
            <p><strong>เบอร์โทรศัพท์:</strong> ${emp.phone || 'N/A'}</p>'
            <p><strong>วันที่เริ่มงาน:</strong> ${emp.startDate ? formatDate(emp.startDate) : 'N/A'}</p>'
            <p><strong>ภูมิลำเนา:</strong> ${emp.origin || 'N/A'}</p>'
            <!-- Add more fields as needed -->
          `;
        }
        const modal = document.getElementById('viewEmployeeModal');'
        if (modal) modal.style.display = 'block';'
      } catch (err) {
        console.error('Error viewing employee:', err);'
        alert('ไม่สามารถโหลดรายละเอียดพนักงานได้: ' + err.message);'
      }
    }

    async function deleteEmployee(employeeId) {
  if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบพนักงาน ID: ${employeeId}?`)) return;

  try {
    const res = await fetch(`${API_BASE}/${employeeId}`, {
      method: 'DELETE','
      headers: { 'Authorization': 'Bearer ' + token }'
    });

    // 204 No Content → success
    if (res.status === 204) {
      alert('ลบข้อมูลพนักงานเรียบร้อย');'
      await fetchEmployees();
      return;
    }

    // ถ้าไม่ 204 ให้ parse JSON
    const contentType = res.headers.get('content-type') || '';'
    if (contentType.includes('application/json')) {'
      const payload = await res.json();
      if (!res.ok || !payload.success) {
        // อ่านจาก payload.error หรือ payload.message
        throw new Error(payload.error || payload.message || `Request failed with status ${res.status}`);
      }
      // กรณี API คืน success + มี message
      alert(payload.message || 'ลบข้อมูลพนักงานเรียบร้อย');'
      await fetchEmployees();
    } else {
      // ไม่ใช่ JSON → อ่านเป็น text
      const txt = await res.text();
      throw new Error(txt || `Request failed with status ${res.status}`);
    }

  } catch (err) {
    console.error('Error deleting employee:', err);'
    alert('❌ เกิดข้อผิดพลาดในการลบ: ' + err.message);'
  }
}


    // ======= Logout =======
    function logoutUser(showAlert = true) {
      localStorage.removeItem('authToken');'
      localStorage.removeItem('userId'); '
      localStorage.removeItem('userInfo'); // Clear stored user info'
      if (showAlert) {
        alert('ออกจากระบบแล้ว');'
      }
      window.location.href = '/login';'
    }
  </script>
</body>
</html>