<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบ HR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon ต่างๆ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] }
        }
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* เพิ่ม CSS สำหรับความสวยงาม */
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .calendar-day {
      background-color: #374151;
    }

    .calendar-day-holiday {
      background-color: #fee2e2;
      color: #ef4444;
    }

    .dark .calendar-day-holiday {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #notificationBtn span.badge-notification { /* More specific selector for the badge */
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status indicators */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-active {
      background-color: #10b981;
    }

    .status-away {
      background-color: #f59e0b;
    }

    .status-offline {
      background-color: #6b7280;
    }
    
    /* Toast notifications */
    .toast {
      min-width: 300px;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease-in-out;
      display: flex;
      align-items: center;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast-success {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .toast-error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .toast-info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    
    .toast-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    /* Table improvements */
    .table-improved {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table-improved th {
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    
    .table-improved tbody tr:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Divider gradient */
    .divider-gradient {
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
      border-radius: 1px;
    }

    /* Shadow soft */
    .shadow-soft {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Animation keyframes */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slideUp {
      animation: slideUp 0.5s ease-out;
    }
  </style>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white dark:bg-gray-800 flex flex-col transition-all duration-300 z-40">
      <a href="hr_dashboard">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto"/>
        </div>
      </a>
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li>
            <a href="hr_dashboard" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-speedometer2 text-xl text-indigo-600 dark:text-indigo-400"></i>
              <span class="ml-3">แดชบอร์ด</span>
            </a>
          </li>
          <li>
            <a href="employee_directory" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-people-fill text-xl text-blue-500 dark:text-blue-400"></i>
              <span class="ml-3">พนักงาน</span>
            </a>
          </li>
          <li>
            <a href="attendance" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-clock text-xl text-green-500 dark:text-green-400"></i>
              <span class="ml-3">บันทึกเวลาเข้า-ออก</span>
            </a>
          </li>
          <li>
            <a href="leave_requests" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-file-earmark-text text-xl text-yellow-500 dark:text-yellow-300"></i>
              <span class="ml-3">การลา</span>
            </a>
          </li>
          <li>
            <a href="payroll" class="flex items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700">
              <i class="bi bi-cash-stack text-xl text-emerald-500 dark:text-emerald-400"></i>
              <span class="ml-3">เงินเดือน</span>
            </a>
          </li>
          <li>
            <a href="performance_reviews" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-award text-xl text-purple-500 dark:text-purple-400"></i>
              <span class="ml-3">ประเมินผลงาน</span>
            </a>
          </li>
          <li>
            <a href="bonus_list" class="flex items-center px-4 h-12 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gift text-xl text-pink-500 dark:text-pink-400 mr-3"></i>
              <span>รายการโบนัส</span>
            </a>
          </li>
          <li>
       
          <li class="mt-4">
            <a href="role_management" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gear text-xl text-gray-600 dark:text-gray-300"></i>
              <span class="ml-3">การตั้งค่า</span>
            </a>
          </li>
          <li class="mt-6">
            <button id="btnToggleDark" class="flex items-center h-12 px-4 rounded-lg w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i id="darkModeIcon" class="bi bi-moon text-xl text-slate-600 dark:text-slate-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <li>
            <button id="btnLogoutSidebar" class="flex items-center h-12 px-4 rounded-lg w-full text-left text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">ออกจากระบบ</span>
            </button>
          </li>
          <li>
            <div id="profile" class="flex items-center h-12 px-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
              <img id="employeePhoto" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTgiIGN5PSIxOCIgcj0iMTgiIGZpbGw9IiNFNUU3RUIiLz4KPHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4IDlDMTQuNjg2MyA5IDEyIDExLjY4NjMgMTIgMTVDMTIgMTguMzEzNyAxNC42ODYzIDIxIDE4IDIxQzIxLjMxMzcgMjEgMjQgMTguMzEzNyAyNCAxNUMyNCAxMS42ODYzIDIxLjMxMzcgOSAxOCA5WiIgZmlsbD0iIzk0QTNBRiIvPgo8cGF0aCBkPSJNMTggMjNDMTIuNDc3MSAyMyA4IDI3LjQ3NzEgOCAzM0g2QzYgMjYuMzcyNiAxMS4zNzI2IDIxIDE4IDIxQzI0LjYyNzQgMjEgMzAgMjYuMzcyNiAzMCAzM0gyOEMyOCAyNy40NzcxIDIzLjUyMjkgMjMgMTggMjNaIiBmaWxsPSIjOTRBM0FGIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="Employee Photo" class="w-10 h-10 rounded-full mr-3"/>
              <span id="employeeName">ผู้ใช้งาน</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>
  
    <!-- Main Content -->
    <main id="mainContent" class="ml-64 transition-all duration-300 animate-fade-in">
      <div class="container mx-auto p-4 md:p-6">
        <!-- Header Card -->
        <header class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-soft mb-6 animate-slideUp">
          <h1 class="text-2xl md:text-3xl font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
            <i class="bi bi-cash-stack text-blue-500 mr-3"></i>
            ระบบรายการเงินเดือนพนักงาน
          </h1>
          <div class="divider-gradient my-3"></div>
          <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mt-4">
            <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center" id="currentDateTime">
              <i class="bi bi-calendar3 mr-2 text-blue-500"></i>
              กำลังโหลดวันที่และเวลา...
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <button onclick="openBasicEmployeeModal()" class="btn btn-primary gap-2 hover:shadow-lg transition-all">
                <i class="bi bi-person-plus"></i> เพิ่มข้อมูลพื้นฐาน
              </button>
              <button id="importBtn" class="btn btn-success gap-2 hover:shadow-lg transition-all">
                <i class="bi bi-cloud-upload"></i> นำเข้าข้อมูล
              </button>
              <div class="relative">
                <input type="text" id="searchInput" placeholder="ค้นหาพนักงาน..." 
                      class="input input-bordered w-full pr-10 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" />
                <div class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-circle">
                  <i class="bi bi-search"></i>
                </div>
              </div>
            </div>
          </div>
        </header>
        
        <!-- Authentication Warning Banner -->
        <div id="authWarningBanner" class="hidden bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg mx-4">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="bi bi-exclamation-triangle text-yellow-400 text-xl"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm text-yellow-700 dark:text-yellow-300">
                <strong>⚠️ คำเตือน:</strong> คุณยังไม่ได้เข้าสู่ระบบ ข้อมูลบางส่วนอาจไม่แสดงหรือเป็นข้อมูลตัวอย่าง
              </p>
              <div class="mt-2 flex space-x-3">
                <a href="/login" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-medium py-1 px-3 rounded transition-colors">
                  เข้าสู่ระบบ
                </a>
                <button onclick="hideAuthWarning()" class="text-yellow-600 hover:text-yellow-700 dark:text-yellow-400 dark:hover:text-yellow-300 text-xs font-medium underline">
                  ซ่อนข้อความนี้
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tabs Navigation with Period Selector -->
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl shadow-soft p-4 animate-slideUp">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
          <div class="tabs tabs-boxed bg-gray-100 dark:bg-gray-700">
            <a id="salaryTab" class="tab tab-active" onclick="switchTab('salary')">
              <i class="bi bi-cash-stack mr-2"></i>เงินเดือน
            </a>
            <a id="commissionTab" class="tab" onclick="switchTab('commission')">
              <i class="bi bi-percent mr-2"></i>ค่าคอมมิชชั่น
            </a>
            <a id="bonusTab" class="tab" onclick="switchTab('bonus')">
              <i class="bi bi-gift mr-2"></i>โบนัสพนักงาน
            </a>
            </div>
            
            <!-- Period Selector -->
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-600 dark:text-gray-300">รอบเวลา:</span>
              <div class="form-control">
                <select id="payrollMonth" class="select select-bordered select-sm w-32" onchange="loadPayrollByPeriod()">
                  <option value="1">มกราคม</option>
                  <option value="2">กุมภาพันธ์</option>
                  <option value="3">มีนาคม</option>
                  <option value="4">เมษายน</option>
                  <option value="5">พฤษภาคม</option>
                  <option value="6">มิถุนายน</option>
                  <option value="7">กรกฎาคม</option>
                  <option value="8">สิงหาคม</option>
                  <option value="9">กันยายน</option>
                  <option value="10">ตุลาคม</option>
                  <option value="11">พฤศจิกายน</option>
                  <option value="12">ธันวาคม</option>
                </select>
              </div>
              <div class="form-control">
                <select id="payrollYear" class="select select-bordered select-sm w-24" onchange="loadPayrollByPeriod()">
                  <option value="2025">2568</option>
                  <option value="2024">2567</option>
                  <option value="2023">2566</option>
                </select>
              </div>
              <div class="badge badge-primary badge-lg">
                <i class="bi bi-calendar3 mr-1"></i>
                <span id="currentPeriodDisplay">มกราคม 2568</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Employee Salary Table Card -->
        <div id="salaryContent" class="bg-white dark:bg-gray-800 rounded-b-2xl shadow-soft overflow-hidden animate-slideUp" style="animation-delay: 0.1s">
          <!-- Filter/Sort Controls -->
          <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex flex-wrap gap-3 justify-between items-center">
            <div class="flex flex-wrap gap-2">
              <!-- ช่องค้นหา -->
              <div class="form-control">
                <div class="input-group">
                  <input type="text" id="searchInput" placeholder="ค้นหาพนักงาน..." class="input input-bordered input-sm w-full max-w-xs" />
                  <button class="btn btn-square btn-sm">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
              </div>
              
              <div class="dropdown">
                <label tabindex="0" class="btn btn-sm btn-outline gap-1">
                  <i class="bi bi-funnel"></i> กรอง
                </label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 dark:bg-gray-700 rounded-box w-52 z-50">
                  <li><a onclick="filterByDepartment('')">แผนก: ทั้งหมด</a></li>
                  <li><a onclick="filterByDepartment('บัญชี')">แผนก: บัญชี</a></li>
                  <li><a onclick="filterByDepartment('การตลาด')">แผนก: การตลาด</a></li>
                  <li><a onclick="filterByDepartment('ไอที')">แผนก: ไอที</a></li>
                  <li><a onclick="filterByDepartment('ทรัพยากรบุคคล')">แผนก: ทรัพยากรบุคคล</a></li>
                  <li><a onclick="filterByDepartment('ขาย')">แผนก: ขาย</a></li>
                </ul>
              </div>
              <div class="dropdown">
                <label tabindex="0" class="btn btn-sm btn-outline gap-1">
                  <i class="bi bi-sort-alpha-down"></i> เรียงลำดับ
                </label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 dark:bg-gray-700 rounded-box w-52 z-50">
                  <li><a onclick="sortEmployees('name', 'asc')">ชื่อ: A-Z</a></li>
                  <li><a onclick="sortEmployees('name', 'desc')">ชื่อ: Z-A</a></li>
                  <li><a onclick="sortEmployees('salary', 'desc')">เงินเดือน: สูง-ต่ำ</a></li>
                  <li><a onclick="sortEmployees('salary', 'asc')">เงินเดือน: ต่ำ-สูง</a></li>
                </ul>
              </div>
              <button class="btn btn-sm btn-outline gap-1" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i> ส่งออก Excel
              </button>
            </div>
            <div class="flex gap-2 items-center">
              <span class="text-sm text-gray-500 dark:text-gray-400" id="employeeCount">พนักงานทั้งหมด: 0 คน</span>
              <button class="btn btn-primary btn-sm gap-2" onclick="openBasicEmployeeModal()">
                <i class="bi bi-person-plus"></i> เพิ่มข้อมูลพื้นฐาน
              </button>
              <button class="btn btn-success btn-sm gap-2 import-btn">
                <i class="bi bi-cloud-upload"></i> นำเข้าข้อมูล
              </button>
            </div>
          </div>

          <!-- Table -->
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full table-improved">
              <thead>
                <tr>
                  <th class="bg-gray-100 dark:bg-gray-700">รหัส</th>
                  <th class="bg-gray-100 dark:bg-gray-700">ชื่อพนักงาน</th>
                  <th class="bg-gray-100 dark:bg-gray-700">แผนก</th>
                  <th class="bg-gray-100 dark:bg-gray-700">ธนาคาร</th>
                  <th class="bg-gray-100 dark:bg-gray-700 text-right">เงินเดือนพื้นฐาน</th>
                  <th class="bg-gray-100 dark:bg-gray-700 text-center">วันเข้าทำงาน</th>
                  <th class="bg-gray-100 dark:bg-gray-700 text-center">สถานะเงินเดือน</th>
                  <th class="bg-gray-100 dark:bg-gray-700 text-center">การจัดการ</th>
                </tr>
              </thead>
              <tbody id="salaryTableBody">
                <!-- ข้อมูลจะถูกเพิ่มที่นี่จาก JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="flex justify-between items-center p-4 border-t border-gray-100 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400" id="paginationInfo">
              แสดง 1-5 จาก 5 รายการ
            </div>
            <div class="btn-group" id="paginationControls">
              <button class="btn btn-sm btn-outline" disabled>«</button>
              <button class="btn btn-sm btn-active">1</button>
              <button class="btn btn-sm btn-outline" disabled>»</button>
            </div>
          </div>
        </div>

        <!-- Commission Content -->
        <div id="commissionContent" class="hidden">
          <!-- Commission Controls Bar -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-4 mb-4">
            <div class="flex flex-wrap gap-3 justify-between items-center">
              <div class="flex flex-wrap gap-2">
                <!-- Period Filter -->
                <div class="form-control">
                  <select id="commissionMonth" class="select select-bordered select-sm">
                    <option value="">เดือนปัจจุบัน</option>
                    <option value="1">มกราคม</option>
                    <option value="2">กุมภาพันธ์</option>
                    <option value="3">มีนาคม</option>
                    <option value="4">เมษายน</option>
                    <option value="5">พฤษภาคม</option>
                    <option value="6">มิถุนายน</option>
                    <option value="7">กรกฎาคม</option>
                    <option value="8">สิงหาคม</option>
                    <option value="9">กันยายน</option>
                    <option value="10">ตุลาคม</option>
                    <option value="11">พฤศจิกายน</option>
                    <option value="12">ธันวาคม</option>
                  </select>
                </div>
                <div class="form-control">
                  <select id="commissionYear" class="select select-bordered select-sm">
                    <option value="2025">2568</option>
                    <option value="2024">2567</option>
                    <option value="2023">2566</option>
                  </select>
                </div>
                <!-- View Mode -->
                <div class="btn-group">
                  <button class="btn btn-sm btn-active" onclick="setCommissionView('realtime')">
                    <i class="bi bi-lightning"></i> Realtime
                  </button>
                  <button class="btn btn-sm" onclick="setCommissionView('history')">
                    <i class="bi bi-clock-history"></i> ประวัติ
                  </button>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary btn-sm gap-2" onclick="openCommissionSettings()">
                  <i class="bi bi-gear"></i> ตั้งค่าคอมมิชชั่น
                </button>
                <button class="btn btn-info btn-sm gap-2" onclick="openActivityModal()">
                  <i class="bi bi-activity"></i> บันทึกกิจกรรม
                </button>
                <button class="btn btn-success btn-sm gap-2" onclick="calculateAllCommissions()">
                  <i class="bi bi-calculator"></i> คำนวณทั้งหมด
                </button>
              </div>
            </div>
          </div>

          <!-- Commission Realtime View -->
          <div id="realtimeCommissionView" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Leaderboard Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-6">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="bi bi-trophy text-yellow-500 mr-2"></i>
                อันดับค่าคอมมิชชั่น (เดือนปัจจุบัน)
              </h3>
              <div id="commissionLeaderboard" class="space-y-3">
                <!-- จะถูกเติมด้วย JavaScript -->
              </div>
            </div>

            <!-- Commission Statistics -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-6">
              <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="bi bi-graph-up text-green-500 mr-2"></i>
                สถิติค่าคอมมิชชั่น
              </h3>
              <div class="space-y-4">
                <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                  <div class="stat">
                    <div class="stat-figure text-primary">
                      <i class="bi bi-cash-coin text-2xl"></i>
                    </div>
                    <div class="stat-title">ยอดขายรวม</div>
                    <div class="stat-value text-primary" id="totalSalesAmount">฿0</div>
                    <div class="stat-desc">เดือนนี้</div>
                  </div>
                  <div class="stat">
                    <div class="stat-figure text-secondary">
                      <i class="bi bi-percent text-2xl"></i>
                    </div>
                    <div class="stat-title">ค่าคอมรวม</div>
                    <div class="stat-value text-secondary" id="totalCommissionAmount">฿0</div>
                    <div class="stat-desc" id="commissionPercentage">0% จากยอดขาย</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Commission Details Table -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft overflow-hidden mt-4">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
              <h3 class="text-lg font-semibold flex items-center">
                <i class="bi bi-list-ul mr-2"></i>
                รายละเอียดค่าคอมมิชชั่น
              </h3>
            </div>
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full">
                <thead>
                  <tr>
                    <th>ลำดับ</th>
                    <th>พนักงาน</th>
                    <th>ประเภทการขาย</th>
                    <th class="text-right">ยอดขาย</th>
                    <th class="text-center">กิจกรรม</th>
                    <th class="text-right">ค่าคอมพื้นฐาน</th>
                    <th class="text-right">ค่าคอมกิจกรรม</th>
                    <th class="text-right">ค่าคอมรวม</th>
                    <th>สถานะ</th>
                    <th class="text-center">การดำเนินการ</th>
                  </tr>
                </thead>
                <tbody id="commissionTableBody">
                  <!-- จะถูกเติมด้วย JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- History View (Hidden by default) -->
          <div id="historyCommissionView" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft overflow-hidden">
              <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                <h3 class="text-lg font-semibold flex items-center">
                  <i class="bi bi-clock-history mr-2"></i>
                  ประวัติค่าคอมมิชชั่น
                </h3>
              </div>
              <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                  <thead>
                    <tr>
                      <th>เดือน/ปี</th>
                      <th>พนักงาน</th>
                      <th class="text-right">ยอดขายรวม</th>
                      <th class="text-right">ค่าคอมรวม</th>
                      <th class="text-right">จ่ายแล้ว</th>
                      <th class="text-right">รอจ่าย</th>
                      <th>สถานะ</th>
                      <th class="text-center">การดำเนินการ</th>
                    </tr>
                  </thead>
                  <tbody id="commissionHistoryTableBody">
                    <!-- จะถูกเติมด้วย JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Bonus Content -->
        <div id="bonusContent" class="hidden">
          <!-- Bonus Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card bg-gradient-to-r from-yellow-400 to-orange-500 text-white">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="card-title text-white text-lg">โบนัสของฉัน</h2>
                    <div class="text-2xl font-bold" id="totalBonusAmount">฿0</div>
                  </div>
                  <i class="bi bi-gift text-3xl opacity-80"></i>
                </div>
              </div>
            </div>

            <div class="card bg-gradient-to-r from-green-400 to-blue-500 text-white">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="card-title text-white text-lg">โบนัสเดือนนี้</h2>
                    <div class="text-2xl font-bold" id="thisMonthBonusAmount">฿0</div>
                  </div>
                  <i class="bi bi-calendar-check text-3xl opacity-80"></i>
                </div>
              </div>
            </div>

            <div class="card bg-gradient-to-r from-purple-400 to-pink-500 text-white">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <h2 class="card-title text-white text-lg">จำนวนรายการ</h2>
                    <div class="text-2xl font-bold" id="bonusCount">0</div>
                  </div>
                  <i class="bi bi-list-stars text-3xl opacity-80"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Bonus Controls -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-4 mb-4">
            <div class="flex flex-wrap gap-3 justify-between items-center">
              <div class="flex flex-wrap gap-2">
                <!-- Period Filter -->
                <div class="form-control">
                  <select id="bonusPeriodFilter" class="select select-bordered select-sm" onchange="filterBonusData()">
                    <option value="all">ทั้งหมด</option>
                    <option value="thisMonth">เดือนนี้</option>
                    <option value="lastMonth">เดือนที่แล้ว</option>
                    <option value="thisYear">ปีนี้</option>
                  </select>
                </div>

                <!-- Type Filter -->
                <div class="form-control">
                  <select id="bonusTypeFilter" class="select select-bordered select-sm" onchange="filterBonusData()">
                    <option value="all">ประเภททั้งหมด</option>
                    <option value="sales">โบนัสยอดขาย</option>
                    <option value="performance">โบนัสผลงาน</option>
                    <option value="holiday">โบนัสวันหยุด</option>
                    <option value="special">โบนัสพิเศษ</option>
                  </select>
                </div>
              </div>

              <div class="flex gap-2">
                <!-- Hide add bonus button for employee view - bonuses are managed by HR -->
                <button class="btn btn-outline btn-sm gap-2" onclick="exportBonusData()">
                  <i class="bi bi-download"></i> ส่งออก
                </button>
              </div>
            </div>
          </div>

          <!-- Bonus Table -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                  <i class="bi bi-gift mr-2 text-yellow-500"></i>
                  รายการโบนัสของฉัน
                </h3>
                <button onclick="showAddBonusModal()" class="btn btn-primary btn-sm">
                  <i class="bi bi-plus-circle mr-2"></i>เพิ่มโบนัส
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="table table-zebra w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th class="text-gray-600 dark:text-gray-300">วันที่</th>
                    <th class="text-gray-600 dark:text-gray-300">ประเภท</th>
                    <th class="text-gray-600 dark:text-gray-300">รายละเอียด</th>
                    <th class="text-gray-600 dark:text-gray-300">จำนวนเงิน</th>
                    <th class="text-gray-600 dark:text-gray-300">สถานะ</th>
                    <th class="text-gray-600 dark:text-gray-300">การจัดการ</th>
                  </tr>
                </thead>
                <tbody id="bonusTableBody">
                  <!-- จะถูกเติมด้วย JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div id="bonusEmptyState" class="hidden text-center py-8">
              <i class="bi bi-gift text-4xl text-gray-400 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400">คุณยังไม่มีข้อมูลโบนัส</p>
              <p class="text-sm text-gray-400 mt-2">โบนัสจะถูกจัดการโดยแผนก HR</p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 dark:text-gray-400 text-sm p-4 border-t border-gray-200 dark:border-gray-700">
          <p>&copy; 2025 ระบบรายการเงินเดือนพนักงาน | พัฒนาโดย บริษัท 2พี่น้อง โมบาย จำกัด</p>
        </footer>
      </div>
    </main>
  </div>

  <!-- สำหรับแปะข้อความ Toast -->
  <div id="toastContainer" class="fixed top-5 right-5 space-y-2 z-50"></div>

  <!-- Basic Employee Info Modal (ข้อมูลพื้นฐาน - ทำครั้งเดียว) -->
  <div id="basicEmployeeModal" class="modal">
    <div class="modal-box max-w-3xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-xl text-blue-600 dark:text-blue-400">
          <i class="bi bi-person-plus mr-2"></i>เพิ่มข้อมูลพื้นฐานพนักงาน
        </h3>
        <button onclick="closeBasicEmployeeModal()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i>
        <div>
          <h4 class="font-bold">ข้อมูลพื้นฐานพนักงาน (ทำครั้งเดียว)</h4>
          <div class="text-sm">บันทึกข้อมูลพื้นฐานลงตารางก่อน หลังจากนั้นใช้ปุ่มในตารางเพื่ออัปเดตเงินเดือนรายเดือน</div>
        </div>
      </div>

      <form id="basicEmployeeForm">
        <input type="hidden" id="basicEmpId" name="employeeId">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Column 1: ข้อมูลส่วนตัว -->
          <div class="space-y-4">
            <h4 class="font-semibold text-blue-600 flex items-center border-b pb-2">
              <i class="bi bi-person mr-2"></i>ข้อมูลส่วนตัว
            </h4>
            
            <!-- 1. เลือกพนักงาน -->
            <div class="form-control">
              <label class="label" for="selectEmployee">
                <span class="label-text font-medium">
                  <i class="bi bi-person-check mr-2 text-blue-500"></i>1. เลือกพนักงาน
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <select id="selectEmployee" name="employeeSelect" required class="select select-bordered w-full">
                <option value="">กรุณาเลือกพนักงาน</option>
              </select>
              <div class="text-xs text-red-500 hidden" id="selectEmployeeError">กรุณาเลือกพนักงาน</div>
            </div>

            <!-- 2. แผนก -->
            <div class="form-control">
              <label class="label" for="empDepartment">
                <span class="label-text font-medium">
                  <i class="bi bi-diagram-3 mr-2 text-blue-500"></i>2. แผนก
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <select id="empDepartment" name="department" required class="select select-bordered w-full">
                <option value="">เลือกแผนก</option>
                <option value="บัญชี">บัญชี</option>
                <option value="การตลาด">การตลาด</option>
                <option value="ไอที">ไอที</option>
                <option value="ทรัพยากรบุคคล">ทรัพยากรบุคคล</option>
                <option value="ขาย">ขาย</option>
              </select>
              <div class="text-xs text-red-500 hidden" id="empDepartmentError">กรุณาเลือกแผนก</div>
            </div>

            <!-- 6. วันเข้าทำงาน -->
            <div class="form-control">
              <label class="label" for="startWorkDate">
                <span class="label-text font-medium">
                  <i class="bi bi-calendar-plus mr-2 text-blue-500"></i>6. วันเข้าทำงาน
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input type="date" id="startWorkDate" name="startDate" required class="input input-bordered w-full">
              <div class="text-xs text-red-500 hidden" id="startWorkDateError">กรุณาเลือกวันเข้าทำงาน</div>
            </div>
          </div>

          <!-- Column 2: ข้อมูลธนาคารและเงินเดือน -->
          <div class="space-y-4">
            <h4 class="font-semibold text-green-600 flex items-center border-b pb-2">
              <i class="bi bi-bank mr-2"></i>ข้อมูลธนาคารและเงินเดือน
            </h4>
            
            <!-- 3. ธนาคาร -->
            <div class="form-control">
              <label class="label" for="employeeBank">
                <span class="label-text font-medium">
                  <i class="bi bi-bank mr-2 text-green-500"></i>3. ธนาคาร
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <select id="employeeBank" name="bankName" required class="select select-bordered w-full">
                <option value="">เลือกธนาคาร</option>
                <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ (BBL)</option>
                <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย (KBANK)</option>
                <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์ (SCB)</option>
                <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย (KTB)</option>
                <option value="ธนาคารทหารไทยธนชาต">ธนาคารทหารไทยธนชาต (TTB)</option>
                <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา (BAY)</option>
                <option value="ธนาคารออมสิน">ธนาคารออมสิน (GSB)</option>
              </select>
              <div class="text-xs text-red-500 hidden" id="employeeBankError">กรุณาเลือกธนาคาร</div>
            </div>

            <!-- 4. เลขบัญชี -->
            <div class="form-control">
              <label class="label" for="bankAccount">
                <span class="label-text font-medium">
                  <i class="bi bi-credit-card mr-2 text-green-500"></i>4. เลขบัญชี
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <input type="text" id="bankAccount" name="accountNumber" required 
                     class="input input-bordered w-full" placeholder="เลขบัญชีธนาคาร" maxlength="15">
              <div class="text-xs text-red-500 hidden" id="bankAccountError">กรุณากรอกเลขบัญชี</div>
            </div>

            <!-- 5. เงินเดือนพื้นฐาน -->
            <div class="form-control">
              <label class="label" for="basicSalaryAmount">
                <span class="label-text font-medium">
                  <i class="bi bi-cash mr-2 text-green-500"></i>5. เงินเดือนพื้นฐาน
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <div class="relative">
                <input type="number" id="basicSalaryAmount" name="baseSalary" required 
                       class="input input-bordered w-full pl-10" min="0" step="100" placeholder="25000">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*เงินเดือนพื้นฐานก่อนเบี้ยเลี้ยงและค่าตอบแทนอื่นๆ</div>
              <div class="text-xs text-red-500 hidden" id="basicSalaryAmountError">กรุณากรอกเงินเดือนพื้นฐาน</div>
            </div>
          </div>
        </div>

        <div class="divider-gradient my-6"></div>
        
        <div class="modal-action">
          <button type="button" class="btn btn-outline gap-2" onclick="closeBasicEmployeeModal()">
            <i class="bi bi-x-lg mr-2"></i>ยกเลิก
          </button>
          <button type="submit" class="btn btn-primary gap-2">
            <i class="bi bi-save mr-2"></i>บันทึกข้อมูลพื้นฐาน
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Monthly Salary Update Modal (อัปเดตเงินเดือนรายเดือน) -->
  <div id="monthlySalaryUpdateModal" class="modal">
    <div class="modal-box max-w-5xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-xl text-green-600 dark:text-green-400">
          <i class="bi bi-cash-stack mr-2"></i>อัปเดตเงินเดือนรายเดือน
        </h3>
        <button onclick="closeMonthlySalaryUpdateModal()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <div class="alert alert-warning mb-4">
        <i class="bi bi-clock-history"></i>
        <div>
          <h4 class="font-bold">อัปเดตเงินเดือนรายเดือน</h4>
          <div class="text-sm">อัปเดตข้อมูลเงินเดือนสำหรับเดือน <span id="monthlyCurrentPeriod" class="font-medium text-blue-600"></span></div>
        </div>
      </div>

      <!-- Employee Info Display -->
      <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 p-4 rounded-lg mb-6 border border-blue-200 dark:border-blue-700">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <span class="text-gray-600 dark:text-gray-300">พนักงาน:</span>
            <span id="monthlyDisplayName" class="font-medium ml-1"></span>
          </div>
          <div>
            <span class="text-gray-600 dark:text-gray-300">แผนก:</span>
            <span id="monthlyDisplayDept" class="font-medium ml-1"></span>
          </div>
          <div>
            <span class="text-gray-600 dark:text-gray-300">เงินเดือนพื้นฐาน:</span>
            <span id="monthlyDisplayBaseSalary" class="font-medium ml-1 text-green-600"></span>
          </div>
          <div>
            <span class="text-gray-600 dark:text-gray-300">ธนาคาร:</span>
            <span id="monthlyDisplayBank" class="font-medium ml-1"></span>
          </div>
        </div>
      </div>

      <form id="monthlySalaryForm">
        <input type="hidden" id="monthlyEmpId" name="employeeId">
        <input type="hidden" id="monthlyBaseSalary" name="baseSalary">
        <input type="hidden" id="monthlySalaryRecordId" name="salaryRecordId">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Column 1: รายได้ -->
          <div class="space-y-4">
            <h4 class="font-semibold text-green-600 flex items-center">
              <i class="bi bi-plus-circle mr-2"></i>💰 รายได้
            </h4>
            
            <!-- 1. ค่าตำแหน่ง -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">1. ค่าตำแหน่ง</span>
              </label>
              <div class="relative">
                <input type="number" id="monthlyPositionAllowance" name="positionAllowance" 
                       class="input input-bordered w-full pl-10" min="0" step="100" placeholder="0">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
            </div>

            <!-- 3. ค่าคอม -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">3. ค่าคอมมิชชั่น</span>
              </label>
              <div class="relative">
                <input type="number" id="monthlyCommission" name="commission" 
                       class="input input-bordered w-full pl-10" min="0" step="100" placeholder="0">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*หัก ณ ที่จ่าย 3% หากเกิน 1,000 บาท</div>
            </div>

            <!-- 5. ค่าออกพื้นที่ -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">5. ค่าออกพื้นที่</span>
              </label>
              <div class="grid grid-cols-2 gap-2 mb-2">
                <div>
                  <label class="text-xs text-gray-500">จำนวนวัน</label>
                  <input type="number" id="monthlyFieldDays" placeholder="0" 
                         class="input input-bordered input-sm w-full" min="0" step="1">
                </div>
                <div>
                  <label class="text-xs text-gray-500">ประเภท</label>
                  <select id="monthlyFieldType" class="select select-bordered select-sm w-full">
                    <option value="none">ไม่ออกพื้นที่</option>
                    <option value="upper">สาขาบน (300/วัน)</option>
                    <option value="lower">สาขาล่าง (200/วัน)</option>
                  </select>
                </div>
              </div>
              <div class="bg-green-50 dark:bg-green-900 dark:bg-opacity-20 p-2 rounded">
                <div class="flex justify-between text-sm">
                  <span>รวม:</span>
                  <span id="monthlyFieldTotal" class="font-medium text-green-600">฿0</span>
                </div>
              </div>
            </div>

            <!-- 6. OT -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">6. ค่าล่วงเวลา (OT)</span>
              </label>
              <div class="grid grid-cols-2 gap-2 mb-2">
                <div>
                  <label class="text-xs text-gray-500">ชั่วโมง</label>
                  <input type="number" id="monthlyOTHours" placeholder="0" 
                         class="input input-bordered input-sm w-full" min="0" step="0.5">
                </div>
                <div>
                  <label class="text-xs text-gray-500">อัตรา (บาท/ชม.)</label>
                  <select id="monthlyOTRate" class="select select-bordered select-sm w-full">
                    <option value="55">55</option>
                    <option value="60">60</option>
                    <option value="65">65</option>
                  </select>
                </div>
              </div>
              <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 p-2 rounded">
                <div class="flex justify-between text-sm">
                  <span>รวม:</span>
                  <span id="monthlyOTTotal" class="font-medium text-blue-600">฿0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Column 2: รายการหัก -->
          <div class="space-y-4">
            <h4 class="font-semibold text-red-600 flex items-center">
              <i class="bi bi-dash-circle mr-2"></i>📋 รายการหัก
            </h4>
            
            <!-- 2. ประกันสังคม 5% -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium text-red-600">2. หักประกันสังคม 5%</span>
              </label>
              <div class="relative">
                <input type="number" id="monthlySocialSecurity" name="socialSecurity" readonly 
                       class="input input-bordered w-full pl-10 bg-gray-50 dark:bg-gray-700 text-red-600">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-500">-฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*คำนวณอัตโนมัติ 5% จากเงินเดือนพื้นฐาน</div>
            </div>

            <!-- 4. หัก ณ ที่จ่าย 3% -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium text-red-600">4. หัก ณ ที่จ่าย 3%</span>
              </label>
              <div class="relative">
                <input type="number" id="monthlyWithholdingTax" name="withholdingTax" readonly 
                       class="input input-bordered w-full pl-10 bg-gray-50 dark:bg-gray-700 text-red-600">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-500">-฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*คำนวณอัตโนมัติ 3% จากค่าคอม (เฉพาะ ≥ 1,000 บาท)</div>
            </div>

            <!-- 7. เอกสารแนบ PDF -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">7. เอกสารแนบ (PDF)</span>
              </label>
              <input type="file" id="monthlySalaryDocument" name="document" accept=".pdf" 
                     class="file-input file-input-bordered w-full">
              <div class="text-xs text-gray-500 mt-1">*ไฟล์ PDF เท่านั้น, ขนาดไม่เกิน 10MB</div>
            </div>
          </div>

          <!-- Column 3: สรุปเงินเดือน -->
          <div class="space-y-4">
            <h4 class="font-semibold text-purple-600 flex items-center">
              <i class="bi bi-calculator mr-2"></i>💼 สรุปเงินเดือน
            </h4>
            
            <!-- 8. เงินได้รวม -->
            <div class="bg-green-50 dark:bg-green-900 dark:bg-opacity-20 p-4 rounded-lg border border-green-200">
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">8. เงินได้รวม</div>
              <div id="monthlyGrossIncome" class="text-2xl font-bold text-green-600">฿0</div>
              <div class="text-xs text-gray-500 mt-1">พื้นฐาน + ตำแหน่ง + คอม + ออกพื้นที่ + OT</div>
            </div>

            <!-- รายการหักรวม -->
            <div class="bg-red-50 dark:bg-red-900 dark:bg-opacity-20 p-4 rounded-lg border border-red-200">
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">📋 รายการหักรวม</div>
              <div id="monthlyTotalDeductions" class="text-2xl font-bold text-red-600">-฿0</div>
              <div class="text-xs text-gray-500 mt-1">ประกันสังคม + หัก ณ ที่จ่าย</div>
            </div>

            <!-- เงินเดือนสุทธิ -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900 dark:to-blue-900 dark:bg-opacity-20 p-4 rounded-lg border-2 border-purple-300 dark:border-purple-700">
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">เงินเดือนสุทธิ</div>
              <div id="monthlyNetSalary" class="text-3xl font-bold text-purple-600 dark:text-purple-400">฿0</div>
              <div class="text-xs text-gray-500 mt-1">จำนวนที่จ่ายจริง</div>
            </div>
          </div>
        </div>

        <div class="divider-gradient my-6"></div>
        
        <div class="modal-action">
          <button type="button" class="btn btn-outline gap-2" onclick="closeMonthlySalaryUpdateModal()">
            <i class="bi bi-x-lg mr-2"></i>ยกเลิก
          </button>
          <button type="submit" class="btn btn-success gap-2">
            <i class="bi bi-save mr-2"></i>บันทึกเงินเดือนรายเดือน
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Employee Modal (using DaisyUI modal) -->
  <div id="employeeModal" class="modal">
    <div class="modal-box max-w-2xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 id="modalTitle" class="font-bold text-xl text-blue-600 dark:text-blue-400">กำหนดเงินเดือนพนักงาน</h3>
        <button onclick="closeModal()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <form id="employeeForm">
        <input type="hidden" id="employeeId" name="employeeId">
        <input type="hidden" id="fieldAllowance" name="fieldAllowance">
        <input type="hidden" id="overtime" name="overtime">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- First Column -->
          <div>
            <!-- เลือกพนักงาน -->
            <div class="form-control mb-3">
              <label class="label" for="employeeSelect">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-person-check mr-2 text-blue-500"></i>เลือกพนักงาน
                </span>
              </label>
              <select id="employeeSelect" name="employeeSelect" required class="select select-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition">
                <option value="">กรุณาเลือกพนักงาน</option>
                <!-- Options will be loaded from API -->
              </select>
              <div class="text-xs text-blue-500 mt-1">*เลือกจากรายชื่อพนักงานที่มีในระบบ</div>
              <div class="text-xs text-red-500 hidden" id="employeeSelectError">กรุณาเลือกพนักงาน</div>
            </div>
            
            <!-- ข้อมูลพนักงาน (แสดงหลังเลือก) -->
            <div id="selectedEmployeeInfo" class="hidden bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 p-3 rounded-lg mb-3 border border-blue-200 dark:border-blue-700">
              <h4 class="font-medium text-blue-600 dark:text-blue-400 mb-2 flex items-center">
                <i class="bi bi-info-circle mr-2"></i>ข้อมูลพนักงานที่เลือก
              </h4>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-300">รหัสพนักงาน:</span>
                  <span id="selectedEmpCode" class="font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-300">ชื่อ-นามสกุล:</span>
                  <span id="selectedEmpName" class="font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-300">ตำแหน่ง:</span>
                  <span id="selectedPosition" class="font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-300">แผนก:</span>
                  <span id="selectedDepartment" class="font-medium"></span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-300">สาขา:</span>
                  <span id="selectedBranch" class="font-medium"></span>
                </div>
              </div>
            </div>

            <!-- เอกสารแนบ PDF -->
            <div class="form-control mb-3">
              <label class="label" for="salaryDocument">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-file-earmark-pdf mr-2 text-red-500"></i>เอกสารแนบ (PDF)
                </span>
              </label>
              <input type="file" id="salaryDocument" name="salaryDocument" 
                     accept=".pdf" 
                     class="file-input file-input-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" />
              <div class="text-xs text-gray-500 mt-1">*รองรับไฟล์ PDF เท่านั้น ขนาดไม่เกิน 10MB</div>
              
              <!-- แสดงข้อมูลไฟล์ที่เลือก -->
              <div id="fileInfo" class="hidden bg-green-50 dark:bg-green-900 dark:bg-opacity-20 p-2 rounded border border-green-200 dark:border-green-700 mt-2">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center">
                    <i class="bi bi-check-circle text-green-500 mr-2"></i>
                    <span id="fileName" class="text-green-700 dark:text-green-300"></span>
                  </div>
                  <span id="fileSize" class="text-gray-500"></span>
                </div>
              </div>
              
              <!-- แสดงข้อผิดพลาด -->
              <div id="fileError" class="hidden text-xs text-red-500 mt-1"></div>
            </div>

            <!-- Hidden inputs สำหรับเก็บข้อมูล -->
            <input type="hidden" id="empCode" name="empCode" />
            <input type="hidden" id="empName" name="empName" />
            <input type="hidden" id="position" name="position" />
            <input type="hidden" id="department" name="department" />
            <input type="hidden" id="branch" name="branch" />
            
            <div class="form-control mb-3">
              <label class="label" for="department">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-diagram-3 mr-2 text-blue-500"></i>แผนก
                </span>
              </label>
              <select id="department" name="department" required class="select select-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition">
                <option value="">เลือกแผนก</option>
                <option value="บัญชี">บัญชี</option>
                <option value="การตลาด">การตลาด</option>
                <option value="ไอที">ไอที</option>
                <option value="ทรัพยากรบุคคล">ทรัพยากรบุคคล</option>
                <option value="ขาย">ขาย</option>
              </select>
              <div class="text-xs text-red-500 hidden" id="departmentError">กรุณาเลือกแผนก</div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="bankName">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-bank mr-2 text-blue-500"></i>ธนาคาร
                </span>
              </label>
              <select id="bankName" name="bankName" required class="select select-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition">
                <option value="">เลือกธนาคาร</option>
                <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ (BBL)</option>
                <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย (KBANK)</option>
                <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์ (SCB)</option>
                <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย (KTB)</option>
                <option value="ธนาคารทหารไทยธนชาต">ธนาคารทหารไทยธนชาต (TTB)</option>
                <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา (BAY)</option>
                <option value="ธนาคารออมสิน">ธนาคารออมสิน (GSB)</option>
                <option value="ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร">ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร (BAAC)</option>
              </select>
              <div class="text-xs text-red-500 hidden" id="bankNameError">กรุณาเลือกธนาคาร</div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="accountNumber">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-credit-card mr-2 text-blue-500"></i>เลขบัญชี
                </span>
              </label>
              <input type="text" id="accountNumber" name="accountNumber" required class="input input-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" placeholder="เลขบัญชีธนาคาร" maxlength="15" />
              <div class="text-xs text-red-500 hidden" id="accountNumberError">กรุณากรอกเลขบัญชี</div>
            </div>
          </div>
          
          <!-- Second Column -->
          <div>
            <div class="form-control mb-3">
              <label class="label" for="baseSalary">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-cash mr-2 text-blue-500"></i>เงินเดือนพื้นฐาน
                </span>
              </label>
              <div class="relative">
                <input type="number" id="baseSalary" name="baseSalary" required class="input input-bordered w-full pl-10 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" min="0" step="100" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
              <div class="text-xs text-red-500 hidden" id="baseSalaryError">กรุณากรอกเงินเดือนพื้นฐาน</div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="socialSecurity">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-shield-check mr-2 text-red-500"></i>หักค่าประกันสังคม 5%
                </span>
              </label>
              <div class="relative">
                <input type="number" id="socialSecurity" name="socialSecurity" readonly class="input input-bordered w-full pl-10 bg-gray-50 dark:bg-gray-700 text-red-600 dark:text-red-400 font-medium" min="0" step="50" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-500">-฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*คำนวณอัตโนมัติ 5% จากเงินเดือนพื้นฐาน</div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="positionAllowance">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-award mr-2 text-blue-500"></i>ค่าตำแหน่ง
                </span>
              </label>
              <div class="relative">
                <input type="number" id="positionAllowance" name="positionAllowance" class="input input-bordered w-full pl-10 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" min="0" step="100" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="commission">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-percent mr-2 text-blue-500"></i>ค่าคอม
                </span>
              </label>
              <div class="relative">
                <input type="number" id="commission" name="commission" class="input input-bordered w-full pl-10 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" min="0" step="100" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
            </div>

            <div class="form-control mb-3">
              <label class="label" for="withholdingTax">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-receipt mr-2 text-red-500"></i>หัก ณ ที่จ่าย 3%
                </span>
              </label>
              <div class="relative">
                <input type="number" id="withholdingTax" name="withholdingTax" readonly class="input input-bordered w-full pl-10 bg-gray-50 dark:bg-gray-700 text-red-600 dark:text-red-400 font-medium" min="0" step="10" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-500">-฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*คำนวณอัตโนมัติ 3% จากค่าคอม (เฉพาะค่าคอม ≥ 1,000 บาท)</div>
            </div>

            <div class="form-control mb-3">
              <label class="label">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-geo-alt mr-2 text-blue-500"></i>ค่าออกลงพื้นที่
                </span>
              </label>
              
              <!-- จำนวนวันและประเภทสาขา -->
              <div class="grid grid-cols-2 gap-2 mb-2">
                <div>
                  <label class="label-text text-xs text-gray-500">จำนวนวันลงพื้นที่</label>
                  <div class="relative">
                    <input type="number" id="fieldAllowanceDays" class="input input-bordered w-full pl-8 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" min="0" step="1" />
                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">วัน</span>
                  </div>
                </div>
                
                <div>
                  <label class="label-text text-xs text-gray-500">ประเภทสาขา</label>
                  <select id="fieldAllowanceType" name="fieldAllowanceType" class="select select-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition">
                    <option value="none">ไม่ได้ลงพื้นที่</option>
                    <option value="upper">สาขาบน (300 บาท/วัน)</option>
                    <option value="lower">สาขาล่าง (200 บาท/วัน)</option>
                  </select>
                </div>
              </div>
              
              <!-- แสดงค่าออกพื้นที่รวม -->
              <div class="bg-green-50 dark:bg-green-900 dark:bg-opacity-20 p-2 rounded border">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-gray-600 dark:text-gray-300">ค่าออกพื้นที่รวม:</span>
                  <span id="fieldAllowanceTotal" class="font-medium text-green-600 dark:text-green-400"></span>
                </div>
              </div>
              
              <!-- Hidden input สำหรับเก็บค่าออกพื้นที่รวม -->
              <input type="hidden" id="fieldAllowance" />
            </div>
            
            <div class="form-control mb-3">
              <label class="label">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-clock-history mr-2 text-blue-500"></i>OT
                </span>
              </label>
              
              <!-- จำนวนชั่วโมงโอที -->
              <div class="grid grid-cols-2 gap-2 mb-2">
                <div>
                  <label class="label-text text-xs text-gray-500">จำนวนชั่วโมง</label>
                  <div class="relative">
                    <input type="number" id="overtimeHours" class="input input-bordered w-full pl-8 focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition" min="0" step="0.5" />
                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ชม.</span>
                  </div>
                </div>
                
                <div>
                  <label class="label-text text-xs text-gray-500">อัตราค่าโอที</label>
                  <select id="overtimeRate" name="overtimeRate" class="select select-bordered w-full focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-700 transition">
                    <option value="55">55 บาท/ชม.</option>
                    <option value="60">60 บาท/ชม.</option>
                  </select>
                </div>
              </div>
              
              <!-- แสดงค่าโอทีรวม -->
              <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 p-2 rounded border">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-gray-600 dark:text-gray-300">ค่าโอทีรวม:</span>
                  <span id="overtimeTotal" class="font-medium text-blue-600 dark:text-blue-400">฿</span>
                </div>
              </div>
              
              <!-- Hidden input สำหรับเก็บค่าโอทีรวม -->
              <input type="hidden" id="overtime" />
            </div>
            
            <!-- เงินเดือนที่ได้ (รวม) -->
            <div class="form-control mb-3">
              <label class="label">
                <span class="label-text font-medium text-green-600 flex items-center">
                  <i class="bi bi-cash-stack mr-2"></i>💰 เงินเดือนที่ได้ (รวม)
                </span>
              </label>
              <div class="relative">
                <input type="text" id="grossSalary" class="input input-bordered w-full pl-10 bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300 font-bold" readonly>
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
              <div class="text-xs text-green-600 mt-1">*เงินเดือนพื้นฐาน + ค่าตำแหน่ง + ค่าออกพื้นที่ + โอที + ค่าคอม</div>
            </div>

            <!-- รายการหัก -->
            <div class="bg-red-50 dark:bg-red-900 dark:bg-opacity-20 p-4 rounded-lg mb-3 border border-red-200 dark:border-red-700">
              <h4 class="font-medium text-red-600 dark:text-red-400 mb-3 flex items-center">
                <i class="bi bi-clipboard-minus mr-2"></i>📋 รายการหัก
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-300">หัก ณ ที่จ่าย (3% จากค่าคอม ≥ 1,000 บาท):</span>
                  <span id="withholdingTaxDisplay" class="text-red-600 dark:text-red-400 font-medium">-฿</span>
                </div>
                <div class="flex justify-between items-center py-1">
                  <span class="text-gray-600 dark:text-gray-300">ประกันสังคม (5% จากเงินเดือนพื้นฐาน):</span>
                  <span id="socialSecurityDisplay" class="text-red-600 dark:text-red-400 font-medium">-฿</span>
                </div>
                <div class="border-t border-red-200 dark:border-red-700 pt-2 mt-2">
                  <div class="flex justify-between items-center font-medium">
                    <span class="text-red-700 dark:text-red-300">รวมยอดหัก:</span>
                    <span id="totalDeductionDisplay" class="text-red-600 dark:text-red-400 font-bold">-฿</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-control mb-3">
              <label class="label" for="totalSalary">
                <span class="label-text font-medium flex items-center">
                  <i class="bi bi-calculator mr-2 text-green-500"></i>เงินเดือนสุทธิ
                </span>
              </label>
              <div class="relative">
                <input type="text" id="totalSalary" disabled class="input input-bordered w-full pl-10 bg-gray-50 dark:bg-gray-700 text-green-600 dark:text-green-400 font-medium" />
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">฿</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">*คำนวณอัตโนมัติจากยอดรวมทั้งหมด หักประกันสังคม</div>
            </div>
          </div>
        </div>

        <div class="divider-gradient my-4"></div>
        
        <div class="modal-action">
          <button type="button" class="btn btn-outline gap-2" onclick="closeModal()">
            <i class="bi bi-x-lg"></i> ยกเลิก
          </button>
          <button type="submit" class="btn btn-primary gap-2">
            <i class="bi bi-save"></i> บันทึก
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirmDeleteModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg text-red-600"><i class="bi bi-exclamation-triangle mr-2"></i>ยืนยันการลบ</h3>
      <p class="py-4">คุณต้องการลบข้อมูลพนักงาน <span id="deleteEmployeeName" class="font-medium"></span> ใช่หรือไม่?</p>
      <p class="text-gray-500 text-sm">การกระทำนี้ไม่สามารถย้อนกลับได้</p>
      <div class="modal-action">
        <button onclick="hideConfirmDeleteModal()" class="btn btn-outline">ยกเลิก</button>
        <button onclick="confirmDelete()" class="btn btn-error gap-2">
          <i class="bi bi-trash"></i> ลบข้อมูล
        </button>
      </div>
    </div>
  </div>

  <!-- Import Data Modal -->
  <div id="importModal" class="modal">
    <div class="modal-box max-w-2xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-xl text-green-600 dark:text-green-400">
          <i class="bi bi-cloud-upload mr-2"></i>นำเข้าข้อมูลพนักงาน
        </h3>
        <button onclick="closeImportModal()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <!-- File Type Selection -->
      <div class="mb-6">
        <label class="label">
          <span class="label-text font-medium">ประเภทไฟล์ที่รองรับ</span>
        </label>
        <div class="flex flex-wrap gap-3 mb-4">
          <div class="badge badge-primary gap-2">
            <i class="bi bi-file-earmark-excel"></i> Excel (.xlsx, .xls)
          </div>
          <div class="badge badge-info gap-2">
            <i class="bi bi-filetype-csv"></i> CSV (.csv)
          </div>
          <div class="badge badge-warning gap-2">
            <i class="bi bi-filetype-json"></i> JSON (.json)
          </div>
        </div>
      </div>

      <!-- File Upload Area -->
      <div class="mb-6">
        <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
          <div id="dropZoneContent">
            <i class="bi bi-cloud-upload text-4xl text-gray-400 mb-3 block"></i>
            <p class="text-gray-600 dark:text-gray-400 mb-2">ลากไฟล์มาวางที่นี่ หรือ คลิกเพื่อเลือกไฟล์</p>
            <p class="text-sm text-gray-500">รองรับไฟล์ Excel, CSV, หรือ JSON</p>
          </div>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.json" class="hidden">
        </div>
      </div>

      <!-- File Info -->
      <div id="fileInfo" class="hidden mb-4 p-4 bg-blue-50 dark:bg-blue-900 dark:bg-opacity-30 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i id="fileIcon" class="bi bi-file-earmark text-2xl text-blue-600 dark:text-blue-400"></i>
            <div>
              <p id="fileName" class="font-medium text-blue-800 dark:text-blue-200"></p>
              <p id="fileSize" class="text-sm text-blue-600 dark:text-blue-400"></p>
            </div>
          </div>
          <button onclick="clearFile()" class="btn btn-sm btn-ghost btn-circle text-red-500">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <!-- Import Options -->
      <div class="mb-6">
        <label class="label">
          <span class="label-text font-medium">ตัวเลือกการนำเข้า</span>
        </label>
        <div class="form-control">
          <label class="label cursor-pointer justify-start gap-3">
            <input type="checkbox" id="skipDuplicates" class="checkbox checkbox-primary" checked>
            <span class="label-text">ข้ามข้อมูลที่มีรหัสพนักงานซ้ำ</span>
          </label>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer justify-start gap-3">
            <input type="checkbox" id="updateExisting" class="checkbox checkbox-primary">
            <span class="label-text">อัปเดตข้อมูลที่มีอยู่แล้ว (ถ้ามีรหัสซ้ำ)</span>
          </label>
        </div>
      </div>

      <!-- Import Progress -->
      <div id="importProgress" class="hidden mb-4">
        <div class="flex justify-between text-sm mb-2">
          <span>กำลังนำเข้าข้อมูล...</span>
          <span id="progressText">0%</span>
        </div>
        <progress class="progress progress-primary w-full" value="0" max="100" id="progressBar"></progress>
      </div>

      <!-- Template Download -->
      <div class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-30 rounded-lg">
        <div class="flex items-start gap-3">
          <i class="bi bi-info-circle text-yellow-600 dark:text-yellow-400 text-lg mt-0.5"></i>
          <div>
            <p class="font-medium text-yellow-800 dark:text-yellow-200 mb-2">ต้องการไฟล์ตัวอย่าง?</p>
            <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-3">ดาวน์โหลดไฟล์ตัวอย่างเพื่อดูรูปแบบข้อมูลที่ถูกต้อง</p>
            <div class="flex gap-2">
              <button onclick="downloadTemplate('excel')" class="btn btn-xs btn-outline gap-1">
                <i class="bi bi-download"></i> Excel Template
              </button>
              <button onclick="downloadTemplate('csv')" class="btn btn-xs btn-outline gap-1">
                <i class="bi bi-download"></i> CSV Template
              </button>
              <button onclick="downloadTemplate('json')" class="btn btn-xs btn-outline gap-1">
                <i class="bi bi-download"></i> JSON Template
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-outline gap-2" onclick="closeImportModal()">
          <i class="bi bi-x-lg"></i> ยกเลิก
        </button>
        <button type="button" id="importButton" class="btn btn-success gap-2" onclick="processImport()" disabled>
          <i class="bi bi-cloud-upload"></i> นำเข้าข้อมูล
        </button>
      </div>
    </div>
  </div>

  <!-- Commission Settings Modal -->
  <div id="commissionSettingsModal" class="modal">
    <div class="modal-box max-w-5xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-xl text-primary">
          <i class="bi bi-gear mr-2"></i>ตั้งค่าค่าคอมมิชชั่น (ตาม MEMO 2PN 2025-005)
        </h3>
        <button onclick="closeCommissionSettings()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <div class="tabs">
        <a class="tab tab-lifted tab-active" onclick="switchCommissionTab('memo', this)">MEMO Settings</a>
        <a class="tab tab-lifted" onclick="switchCommissionTab('activities', this)">กิจกรรมส่งเสริม</a>
        <a class="tab tab-lifted" onclick="switchCommissionTab('rules', this)">กฎการคำนวณ</a>
        <a class="tab tab-lifted" onclick="switchCommissionTab('employees', this)">พนักงาน</a>
      </div>

      <!-- MEMO Settings Tab -->
      <div id="memoTab" class="tab-content p-4 bg-base-200 rounded-b-lg">
        <div class="alert alert-info mb-4">
          <i class="bi bi-info-circle"></i>
          <div>
            <h3 class="font-bold">MEMO ภายในองค์กร</h3>
            <div class="text-xs">เลขที่: 2PN Memo. 2025-005 | วันที่: 28 กรกฎาคม 2568 | มีผลบังคับใช้: 1 สิงหาคม 2568</div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">เลขที่ MEMO</span>
            </label>
            <input type="text" id="memoNumber" class="input input-bordered" value="2PN Memo. 2025-005" placeholder="เลขที่ MEMO">
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">วันที่มีผลบังคับใช้</span>
            </label>
            <input type="date" id="effectiveDate" class="input input-bordered" value="2025-08-01">
          </div>
        </div>
        
        <div class="divider">ค่าคอมมิชชั่นพื้นฐาน</div>
        
        <div class="card bg-base-100 p-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">ค่าคอมฐานจากการขายสด</span>
            </label>
            <div class="input-group">
              <input type="number" id="baseCashCommission" class="input input-bordered" value="10" min="0" step="1">
              <span class="btn no-animation">บาท/บิล</span>
            </div>
          </div>
        </div>
        
        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">หมายเหตุ</span>
          </label>
          <textarea id="memoNotes" class="textarea textarea-bordered" rows="3" placeholder="หลักเกณฑ์การคิดและการจ่าย...">หากค่าคอมฯ มีเศษสตางค์ มากกว่า 0.50 บาท ให้ปัดขึ้นเป็นจำนวนเต็มบาท\nการนับค่าคอมฯ อ้างอิงจาก "ราคาขายจริงต่อชิ้น"\nต้องระบุชื่อผู้ทำบิลในระบบหรือในรายการขายอย่างชัดเจนทุกครั้ง</textarea>
        </div>
      </div>

      <!-- Activities Tab -->
      <div id="activitiesTab" class="tab-content hidden p-4 bg-base-200 rounded-b-lg">
        <h4 class="font-semibold mb-4">กิจกรรมส่งเสริมการขาย (รวม 50 บาท หากทำครบ)</h4>
        
        <div class="space-y-3">
          <div class="card bg-base-100">
            <div class="card-body p-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">กิจกรรม</span>
                  </label>
                  <input type="text" value="สัมภาษณ์ลูกค้า" class="input input-bordered input-sm" readonly>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">ค่าตอบแทน</span>
                  </label>
                  <div class="input-group input-group-sm">
                    <input type="number" id="interviewFee" class="input input-bordered" value="10" min="0">
                    <span class="btn no-animation btn-sm">บาท</span>
                  </div>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">สถานะ</span>
                  </label>
                  <input type="checkbox" class="toggle toggle-primary" checked>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-base-100">
            <div class="card-body p-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">กิจกรรม</span>
                  </label>
                  <input type="text" value="ลงสตอรี Boomerang + แท็กร้าน" class="input input-bordered input-sm" readonly>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">ค่าตอบแทน</span>
                  </label>
                  <div class="input-group input-group-sm">
                    <input type="number" id="boomerangFee" class="input input-bordered" value="10" min="0">
                    <span class="btn no-animation btn-sm">บาท</span>
                  </div>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">สถานะ</span>
                  </label>
                  <input type="checkbox" class="toggle toggle-primary" checked>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-base-100">
            <div class="card-body p-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">กิจกรรม</span>
                  </label>
                  <input type="text" value="รีวิวใน Google Map" class="input input-bordered input-sm" readonly>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">ค่าตอบแทน</span>
                  </label>
                  <div class="input-group input-group-sm">
                    <input type="number" id="googleReviewFee" class="input input-bordered" value="10" min="0">
                    <span class="btn no-animation btn-sm">บาท</span>
                  </div>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">สถานะ</span>
                  </label>
                  <input type="checkbox" class="toggle toggle-primary" checked>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-base-100">
            <div class="card-body p-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">กิจกรรม</span>
                  </label>
                  <input type="text" value="ลูกค้าลงคลิปในช่องตนเอง + ส่งลิงก์" class="input input-bordered input-sm" readonly>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">ค่าตอบแทน</span>
                  </label>
                  <div class="input-group input-group-sm">
                    <input type="number" id="videoFee" class="input input-bordered" value="20" min="0">
                    <span class="btn no-animation btn-sm">บาท</span>
                  </div>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">สถานะ</span>
                  </label>
                  <input type="checkbox" class="toggle toggle-primary" checked>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="alert alert-warning mt-4">
          <i class="bi bi-exclamation-triangle"></i>
          <span>กิจกรรมส่งเสริมรวม 50 บาท หากทำครบทุกกิจกรรม</span>
        </div>
      </div>

      <!-- Rules Tab -->
      <div id="rulesTab" class="tab-content hidden p-4 bg-base-200 rounded-b-lg">
        <div class="space-y-4">
          <div class="card bg-base-100">
            <div class="card-body">
              <h4 class="card-title text-sm">กฎการคำนวณเพิ่มเติม</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="form-control">
                  <label class="label">
                    <span class="label-text text-xs">ประเภทสินค้า</span>
                  </label>
                  <select id="productCategory" class="select select-bordered select-sm">
                    <option value="all">ทั้งหมด</option>
                    <option value="accessories">Accessories</option>
                    <option value="phone">โทรศัพท์</option>
                    <option value="tablet">แท็บเล็ต</option>
                  </select>
                </div>
                <div class="form-control">
                  <label class="label">
                    <span class="label-text text-xs">รูปแบบคำนวณ</span>
                  </label>
                  <select id="ruleType" class="select select-bordered select-sm" onchange="toggleRuleFields()">
                    <option value="percentage">เปอร์เซ็นต์</option>
                    <option value="fixed">คงที่ต่อชิ้น</option>
                    <option value="tiered">ขั้นบันได</option>
                  </select>
                </div>
                <div class="form-control" id="percentageField">
                  <label class="label">
                    <span class="label-text text-xs">อัตรา (% หรือ บาท)</span>
                  </label>
                  <input type="number" id="rulePercentage" class="input input-bordered input-sm" min="0" max="100" step="0.1" value="3">
                </div>
              </div>
              <button class="btn btn-sm btn-primary mt-3" onclick="addCommissionRule()">
                <i class="bi bi-plus"></i> เพิ่มกฎ
              </button>
            </div>
          </div>
          
          <div id="rulesList" class="space-y-2">
            <!-- กฎจะแสดงที่นี่ -->
          </div>
        </div>
      </div>

      <!-- Employees Tab -->
      <div id="employeesTab" class="tab-content hidden p-4 bg-base-200 rounded-b-lg">
        <div class="form-control">
          <label class="label">
            <span class="label-text">พนักงานที่ใช้การตั้งค่านี้</span>
          </label>
          <div class="flex gap-2 mb-3">
            <select id="employeeSelect" class="select select-bordered flex-1">
              <option value="">เลือกพนักงาน...</option>
              <option value="all_sales">พนักงานขายทั้งหมด</option>
              <option value="all_managers">ผู้จัดการทั้งหมด</option>
              <!-- จะถูกเติมด้วย JavaScript -->
            </select>
            <button class="btn btn-primary" onclick="addEmployeeToSetting()">
              <i class="bi bi-plus"></i> เพิ่ม
            </button>
          </div>
          <div id="selectedEmployeesList" class="space-y-2">
            <!-- พนักงานที่เลือกจะแสดงที่นี่ -->
          </div>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn btn-outline" onclick="closeCommissionSettings()">ยกเลิก</button>
        <button class="btn btn-primary" onclick="saveCommissionSettings()">
          <i class="bi bi-save"></i> บันทึกการตั้งค่า
        </button>
      </div>
    </div>
  </div>

  <!-- Customer Activity Tracking Modal -->
  <div id="activityTrackingModal" class="modal">
    <div class="modal-box max-w-3xl">
      <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-bold text-xl text-blue-600">
          <i class="bi bi-activity mr-2"></i>บันทึกกิจกรรมส่งเสริมการขาย
        </h3>
        <button onclick="closeActivityModal()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <form id="activityForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">เลขที่บิล</span>
            </label>
            <input type="text" id="billNumber" class="input input-bordered" required placeholder="เลขที่บิลขาย">
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">พนักงานขาย</span>
            </label>
            <select id="salesPerson" class="select select-bordered" required>
              <option value="">เลือกพนักงาน</option>
              <!-- จะถูกเติมด้วย JavaScript -->
            </select>
          </div>
        </div>
        
        <div class="divider">กิจกรรมที่ทำ</div>
        
        <div class="space-y-3">
          <label class="flex items-center p-3 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300">
            <input type="checkbox" id="customerInterview" class="checkbox checkbox-primary mr-3">
            <div class="flex-1">
              <span class="font-medium">สัมภาษณ์ลูกค้า</span>
              <span class="text-sm text-gray-500 ml-2">(10 บาท)</span>
            </div>
          </label>
          
          <label class="flex items-center p-3 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300">
            <input type="checkbox" id="boomerangStory" class="checkbox checkbox-primary mr-3">
            <div class="flex-1">
              <span class="font-medium">ลงสตอรี Boomerang + แท็กร้าน</span>
              <span class="text-sm text-gray-500 ml-2">(10 บาท)</span>
            </div>
          </label>
          
          <label class="flex items-center p-3 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300">
            <input type="checkbox" id="googleMapReview" class="checkbox checkbox-primary mr-3">
            <div class="flex-1">
              <span class="font-medium">รีวิวใน Google Map</span>
              <span class="text-sm text-gray-500 ml-2">(10 บาท)</span>
            </div>
          </label>
          
          <label class="flex items-center p-3 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300">
            <input type="checkbox" id="customerVideo" class="checkbox checkbox-primary mr-3">
            <div class="flex-1">
              <span class="font-medium">ลูกค้าลงคลิปในช่องตนเอง + ส่งลิงก์</span>
              <span class="text-sm text-gray-500 ml-2">(20 บาท)</span>
              <input type="url" id="videoLink" class="input input-bordered input-sm mt-2 w-full" placeholder="ลิงก์วิดีโอ (ถ้ามี)">
            </div>
          </label>
        </div>
        
        <div class="bg-primary/10 p-4 rounded-lg mt-4">
          <div class="flex justify-between items-center">
            <span class="font-medium">รวมค่าคอมมิชชั่นจากกิจกรรม:</span>
            <span id="activityCommissionTotal" class="text-xl font-bold text-primary">0 บาท</span>
          </div>
        </div>
        
        <div class="modal-action">
          <button type="button" class="btn btn-outline" onclick="closeActivityModal()">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> บันทึก
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global Variables
    let isDarkMode = false;
    let isSidebarVisible = true;
    let currentEmployeeId = null;
    let currentPage = 1;
    let itemsPerPage = 5;
    let filteredEmployees = [];
    let currentFilter = '';
    let currentSort = { field: '', order: '' };
    let employees = []; // จะโหลดจาก API
    let basicEmployees = []; // ข้อมูลพื้นฐานพนักงาน
    let monthlyPayrolls = []; // ข้อมูลเงินเดือนรายเดือน
    let currentPayrollMonth = new Date().getMonth() + 1; // เดือนปัจจุบัน (1-12)
    let currentPayrollYear = new Date().getFullYear(); // ปีปัจจุบัน
    
    // API Base URL - ตรวจสอบว่าอยู่ใน development หรือ production
    const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : window.location.origin;

    // HR Data storage for integrated employee and bonus data
    const hrData = {
      employee: null,
      salaries: [],
      attendance: [],
      leaves: [],
      commissions: [],
      bonuses: []
    };
    
    console.log('Current hostname:', window.location.hostname);
    console.log('Current port:', window.location.port);
    console.log('API Base URL:', API_BASE_URL);
    
    // Authentication utility functions
    function getAuthToken() {
      return localStorage.getItem('token') ||
             localStorage.getItem('authToken') ||
             localStorage.getItem('accessToken') ||
             sessionStorage.getItem('token') ||
             sessionStorage.getItem('authToken');
    }
    
    function getAuthHeaders() {
      const token = getAuthToken();
      const headers = {
        'Content-Type': 'application/json'
      };
    
      if (token && token !== 'development-token-12345') {
        headers['Authorization'] = `Bearer ${token}`;
      }
    
      return headers;
    }
    
    function handleAuthError(response) {
      if (response.status === 401) {
        console.warn('Authentication failed - clearing tokens');
        localStorage.removeItem('token');
        localStorage.removeItem('authToken');
        localStorage.removeItem('accessToken');
        sessionStorage.removeItem('token');
        sessionStorage.removeItem('authToken');

        showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
        return true;
      }
      return false;
    }

    // ========== INTEGRATED HR DATA FUNCTIONS (from employee_only.html and Bonusdetail.html) ==========

    // Get current user information
    function getCurrentUser() {
      try {
        const token = getAuthToken();
        if (token && token !== 'development-token-12345') {
          // Try to decode JWT token to get user info
          const payload = JSON.parse(atob(token.split('.')[1]));
          return {
            userId: payload.userId || payload.id,
            employeeId: payload.employeeId,
            name: payload.name || payload.username,
            role: payload.role
          };
        }
      } catch (error) {
        console.warn('Unable to decode token:', error);
      }

      // Fallback to localStorage data
      return {
        userId: localStorage.getItem('userId'),
        employeeId: localStorage.getItem('employeeId'),
        name: localStorage.getItem('userName') || 'ผู้ใช้งาน',
        role: localStorage.getItem('userRole')
      };
    }

    // Fetch comprehensive employee data from HR APIs
    async function fetchEmployeeData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No userId found, will try to get employee data from token');
        }

        // Fetch employee profile
        const response = await fetch(`${API_BASE_URL}/api/employees/profile`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const employeeData = await response.json();
          hrData.employee = employeeData.data || employeeData;
          console.log('Employee data loaded:', hrData.employee);
        }

        // Fetch salary data
        await fetchSalaryData();

        // Fetch attendance data
        await fetchAttendanceData();

        // Fetch leave data
        await fetchLeaveData();

        // Fetch commission data
        await fetchCommissionHistory();

        // Fetch bonus data
        await fetchBonusData();

        // Calculate summary statistics
        calculateHRStatistics();

        return hrData;
      } catch (error) {
        console.error('Error fetching employee data:', error);
        return null;
      }
    }

    // Fetch salary data
    async function fetchSalaryData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/salaries?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          hrData.salaries = result.data || result || [];
          console.log('Salary data loaded:', hrData.salaries.length, 'records');
        }
      } catch (error) {
        console.error('Error fetching salary data:', error);
        hrData.salaries = [];
      }
    }

    // Fetch attendance data
    async function fetchAttendanceData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/attendance?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          hrData.attendance = result.data || result || [];
          console.log('Attendance data loaded:', hrData.attendance.length, 'records');
        }
      } catch (error) {
        console.error('Error fetching attendance data:', error);
        hrData.attendance = [];
      }
    }

    // Fetch leave data
    async function fetchLeaveData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/leaves?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          hrData.leaves = result.data || result || [];
          console.log('Leave data loaded:', hrData.leaves.length, 'records');
        }
      } catch (error) {
        console.error('Error fetching leave data:', error);
        hrData.leaves = [];
      }
    }

    // Fetch commission history
    async function fetchCommissionHistory() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/commission/history?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          hrData.commissions = result.data || result || [];
          console.log('Commission data loaded:', hrData.commissions.length, 'records');
        }
      } catch (error) {
        console.error('Error fetching commission data:', error);
        hrData.commissions = [];
      }
    }

    // Fetch bonus data (integrated from Bonusdetail.html) - User-specific only
    async function fetchBonusData() {
      try {
        const currentUser = getCurrentUser();

        if (!currentUser.userId) {
          console.warn('No user ID available for loading bonus data');
          hrData.bonuses = [];
          return;
        }

        console.log('Fetching personal bonus data for user:', currentUser.userId);

        // Prioritize user-specific HR bonus API first
        let response = await fetch(`${API_BASE_URL}/api/hr/bonus?userId=${currentUser.userId}`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          hrData.bonuses = result.data || result || [];
          console.log('Personal bonus data loaded from HR API:', hrData.bonuses.length, 'records');
          return;
        }

        // Try main bonus API as fallback and filter by user
        response = await fetch(`${API_BASE_URL}/api/bonuses`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          let allBonuses = result.data || result.bonuses || result || [];

          // Filter to only current user's bonuses
          hrData.bonuses = allBonuses.filter(bonus =>
            bonus.userId === currentUser.userId ||
            bonus.employeeId === currentUser.userId ||
            bonus.employeeId === currentUser.employeeId
          );
          console.log('Personal bonus data filtered from main API:', hrData.bonuses.length, 'out of', allBonuses.length, 'total records');
          return;
        }

        // If all APIs fail, use empty array instead of mock data
        console.warn('Bonus APIs not available');
        hrData.bonuses = [];

      } catch (error) {
        console.error('Error fetching bonus data:', error);
        hrData.bonuses = [];
      }
    }


    // Calculate HR statistics
    function calculateHRStatistics() {
      // Calculate attendance rate
      if (hrData.attendance && hrData.attendance.length > 0) {
        const totalDays = hrData.attendance.length;
        const presentDays = hrData.attendance.filter(att => att.status === 'present').length;
        hrData.attendanceRate = totalDays > 0 ? (presentDays / totalDays) * 100 : 0;
      } else {
        hrData.attendanceRate = 0;
      }

      // Calculate total bonus amount
      if (hrData.bonuses && hrData.bonuses.length > 0) {
        hrData.totalBonusAmount = hrData.bonuses.reduce((sum, bonus) => sum + (bonus.amount || 0), 0);
        hrData.paidBonusAmount = hrData.bonuses
          .filter(bonus => bonus.status === 'paid')
          .reduce((sum, bonus) => sum + (bonus.amount || 0), 0);
      } else {
        hrData.totalBonusAmount = 0;
        hrData.paidBonusAmount = 0;
      }

      // Calculate total commission amount
      if (hrData.commissions && hrData.commissions.length > 0) {
        hrData.totalCommissionAmount = hrData.commissions.reduce((sum, comm) => sum + (comm.amount || 0), 0);
      } else {
        hrData.totalCommissionAmount = 0;
      }

      console.log('HR Statistics calculated:', {
        attendanceRate: hrData.attendanceRate,
        totalBonusAmount: hrData.totalBonusAmount,
        paidBonusAmount: hrData.paidBonusAmount,
        totalCommissionAmount: hrData.totalCommissionAmount
      });
    }
    
    // Authentication warning banner functions
    function showAuthWarning() {
      const banner = document.getElementById('authWarningBanner');
      if (banner) {
        banner.classList.remove('hidden');
      }
    }
    
    function hideAuthWarning() {
      const banner = document.getElementById('authWarningBanner');
      if (banner) {
        banner.classList.add('hidden');
      }
      // Store preference to not show again for this session
      sessionStorage.setItem('hideAuthWarning', 'true');
    }
    
    function checkAuthenticationStatus() {
      const token = getAuthToken();
      const hideWarning = sessionStorage.getItem('hideAuthWarning');
    
      if (!token && !hideWarning) {
        showAuthWarning();
        return false;
      } else if (token) {
        hideAuthWarning();
        return true;
      }
    
      return false;
    }

    // DOM Elements
    const salaryTableBody = document.getElementById('salaryTableBody');
    const modal = document.getElementById('employeeModal');
    const confirmModal = document.getElementById('confirmDeleteModal');
    const importModal = document.getElementById('importModal');
    const deleteEmployeeName = document.getElementById('deleteEmployeeName');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('employeeForm');
    const searchInput = document.getElementById('searchInput');
    const addEmployeeBtn = document.getElementById('addEmployeeBtn');
    const importBtn = document.getElementById('importBtn');
    const currentDateTimeEl = document.getElementById('currentDateTime');
    const employeeCountEl = document.getElementById('employeeCount');
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationControls = document.getElementById('paginationControls');
    const sidebar = document.getElementById('sidebar');
    const btnToggleMenu = document.getElementById('btnToggleMenu');
    const btnToggleDark = document.getElementById('btnToggleDark');
    const darkModeLabel = document.getElementById('darkModeLabel');
    const darkModeIcon = document.getElementById('darkModeIcon');
    const htmlElement = document.documentElement;
    const baseSalaryInput = document.getElementById('baseSalary');
    const positionAllowanceInput = document.getElementById('positionAllowance');
    const fieldAllowanceTypeSelect = document.getElementById('fieldAllowanceType');
    const overtimeInput = document.getElementById('overtime');
    const overtimeHoursInput = document.getElementById('overtimeHours');
    const overtimeRateSelect = document.getElementById('overtimeRate');
    const overtimeTotalDisplay = document.getElementById('overtimeTotal');
    const commissionInput = document.getElementById('commission');
    const socialSecurityInput = document.getElementById('socialSecurity');
    const withholdingTaxInput = document.getElementById('withholdingTax');
    const totalSalaryDisplay = document.getElementById('totalSalary');
    const grossSalaryDisplay = document.getElementById('grossSalary');
    const withholdingTaxDisplay = document.getElementById('withholdingTaxDisplay');
    const socialSecurityDisplay = document.getElementById('socialSecurityDisplay');
    const totalDeductionDisplay = document.getElementById('totalDeductionDisplay');
    const toastContainer = document.getElementById('toastContainer');
    
    // Import Modal Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileIcon = document.getElementById('fileIcon');
    const importButton = document.getElementById('importButton');
    const skipDuplicates = document.getElementById('skipDuplicates');
    const updateExisting = document.getElementById('updateExisting');
    const importProgress = document.getElementById('importProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    let selectedFile = null;

    // แสดงข้อความแจ้งเตือนแบบ Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.classList.add('toast', `toast-${type}`);
    
      let icon = '';
      switch (type) {
        case 'success': icon = '<i class="bi bi-check-circle mr-2"></i>'; break;
        case 'error': icon = '<i class="bi bi-x-circle mr-2"></i>'; break;
        case 'info': icon = '<i class="bi bi-info-circle mr-2"></i>'; break;
      }
    
      toast.innerHTML = `${icon} ${message}`;
      toastContainer.appendChild(toast);
    
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
    
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // โหลดข้อมูลเงินเดือนจาก API (Legacy - now integrated with new system)
    async function loadEmployeeSalaries() {
      try {
        showToast('กำลังโหลดข้อมูลเงินเดือน...', 'info');
    
        const response = await fetch(`${API_BASE_URL}/api/employee-salaries?limit=50&sortBy=totalSalary&sortOrder=desc`, {
          headers: getAuthHeaders()
        });
    
        if (!response.ok) {
          console.warn('Employee salaries API not available, trying alternative endpoints...');
    
          // Try to load basic employees and monthly payrolls instead
          await loadBasicEmployees();
          return;
        }
    
        const result = await response.json();

        if (result.success && result.data) {
          // แปลงข้อมูลให้ตรงกับรูปแบบเดิม
          employees = result.data.map(salary => ({
            id: salary._id,
            code: salary.code,
            name: salary.name,
            position: salary.position,
            department: salary.department,
            baseSalary: salary.baseSalary,
            positionAllowance: salary.positionAllowance || 0,
            fieldAllowanceType: salary.fieldAllowanceType || 'none',
            fieldAllowanceDays: salary.fieldAllowanceDays || 0,
            fieldAllowance: salary.fieldAllowance || 0,
            overtime: salary.overtime || 0,
            overtimeHours: salary.overtimeHours || 0,
            overtimeRate: salary.overtimeRate || 55,
            commission: salary.commission || 0,
            socialSecurity: salary.socialSecurity || 0,
            withholdingTax: salary.withholdingTax || 0,
            totalSalary: salary.totalSalary,
            bankName: salary.bankName || '',
            accountNumber: salary.accountNumber || '',
            status: salary.status || 'active'
          }));

          renderEmployees(employees);
          showToast('โหลดข้อมูลเงินเดือนสำเร็จ', 'success');
        } else {
          throw new Error('No salary data found');
        }

      } catch (error) {
        console.error('API Error:', error);
        employees = [];
        renderEmployees(employees);
        showToast('ไม่สามารถโหลดข้อมูลเงินเดือนได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
      }
    }

    // แสดงข้อผิดพลาด
    function showError(message) {
      if (salaryTableBody) {
        salaryTableBody.innerHTML = `
          <tr>
            <td colspan="12" class="text-center py-8 text-red-500">
              <i class="bi bi-exclamation-triangle text-4xl mb-2 block"></i>
              ${message}
              <div class="mt-4">
                <button onclick="loadEmployeeSalaries()" class="btn btn-primary btn-sm">
                  <i class="bi bi-arrow-clockwise mr-1"></i>ลองอีกครั้ง
                </button>
              </div>
            </td>
          </tr>
        `;
      }
      showToast(message, 'error');
    }

    // Toggle Sidebar แบบโค้ดที่ 1
      btnToggleMenu.addEventListener('click', function() {
        const mainContent = document.getElementById('mainContent');
    
        // สลับคลาสเลื่อน sidebar เข้า-ออก
          sidebar.classList.toggle('-translate-x-64');
    
        // สลับ margin ของ main content
        if (mainContent) {
          mainContent.classList.toggle('ml-64');
        mainContent.classList.toggle('ml-0');
        }
    
        // สลับไอคอนของปุ่ม
        const icon = btnToggleMenu.querySelector('i');
          icon.classList.toggle('bi-chevron-left');
          icon.classList.toggle('bi-chevron-right');
      });

    // Toggle Dark Mode
      btnToggleDark.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
          htmlElement.classList.toggle('dark', isDarkMode);
          htmlElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
          darkModeLabel.textContent = isDarkMode ? 'โหมดกลางวัน' : 'โหมดกลางคืน';
        const icon = document.getElementById('darkModeIcon');
          icon.className = isDarkMode ? 'bi bi-sun text-xl' : 'bi bi-moon text-xl';
        localStorage.setItem('darkMode', isDarkMode);
      });

    // Logout functionality
    document.getElementById('btnLogoutSidebar').addEventListener('click', () => {
        showToast('กำลังออกจากระบบ...', 'info');
        setTimeout(() => {
          window.location.href = '/login';
        }, 1000);
      });

    // แสดงวันที่และเวลาปัจจุบัน
    function updateDateTime() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      currentDateTimeEl.innerHTML = `
        <i class="bi bi-calendar3 mr-2 text-blue-500"></i>
        วันที่: ${now.toLocaleDateString('th-TH', options)}
      `;
    }

    // Format เงินเป็นรูปแบบสกุลเงินบาทไทย
    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 2
      }).format(amount);
    }

    // อัพเดทแสดงจำนวนพนักงาน
    function updateEmployeeCount(count) {
      employeeCountEl.textContent = `พนักงานทั้งหมด: ${count} คน`;
    }

    // แสดงข้อมูลทั้งหมดในตาราง (Legacy function - now calls new function)
    function renderEmployees(employeesList) {
      // Redirect to new rendering function
      renderNewEmployeeTable();
    }

    // Legacy function maintained for compatibility
    function renderEmployeesLegacy(employeesList) {
      // Filter employees if needed
      if (currentFilter) {
        employeesList = employeesList.filter(emp => emp.department === currentFilter);
      }
    
      // Apply search filter
      const searchTerm = searchInput.value.toLowerCase();
      if (searchTerm) {
        employeesList = employeesList.filter(emp =>
          emp.code.toLowerCase().includes(searchTerm) ||
          emp.name.toLowerCase().includes(searchTerm) ||
          emp.position.toLowerCase().includes(searchTerm) ||
          emp.department.toLowerCase().includes(searchTerm)
        );
      }
    
      // Apply sorting if needed
      if (currentSort.field && currentSort.order) {
        employeesList = [...employeesList].sort((a, b) => {
          if (currentSort.field === 'salary') {
            return currentSort.order === 'asc'
              ? a.totalSalary - b.totalSalary
              : b.totalSalary - a.totalSalary;
          } else {
            return currentSort.order === 'asc'
              ? a.name.localeCompare(b.name)
              : b.name.localeCompare(a.name);
          }
        });
      }
    
      // Save filtered employees for pagination
      filteredEmployees = [...employeesList];
    
      // Calculate pagination
      const totalPages = Math.ceil(employeesList.length / itemsPerPage);
      if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
      }
    
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentPageEmployees = employeesList.slice(startIndex, endIndex);
    
      // Update pagination info
      updatePaginationInfo(startIndex, endIndex, employeesList.length);
    
      // Render pagination controls
      renderPaginationControls(totalPages);
    
      salaryTableBody.innerHTML = '';
    
      if (currentPageEmployees.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="13" class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="bi bi-search text-4xl mb-2 block"></i>
            ไม่พบข้อมูลพนักงาน
          </td>
        `;
        salaryTableBody.appendChild(emptyRow);
        updateEmployeeCount(0);
        return;
      }
    
      currentPageEmployees.forEach((emp, index) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-blue-50 dark:hover:bg-blue-900 dark:hover:bg-opacity-20 transition-colors';
    
        // แสดงข้อความค่าออกพื้นที่
        let fieldAllowanceText = '0';
        if (emp.fieldAllowanceType === 'upper') {
          fieldAllowanceText = '300 (สาขาบน)';
        } else if (emp.fieldAllowanceType === 'lower') {
          fieldAllowanceText = '200 (สาขาล่าง)';
        }
    
        tr.innerHTML = `
          <td class="font-mono">${emp.code}</td>
          <td>
            <div class="flex items-center space-x-3">
              <div class="avatar placeholder">
                <div class="bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 w-8 mask mask-squircle">
                  <span>${emp.name.charAt(0)}</span>
                </div>
              </div>
              <div>
                <div class="font-medium">${emp.name}</div>
                <div class="text-sm text-gray-500">${emp.bankName || ''}</div>
                <div class="text-xs text-gray-400">${emp.accountNumber || ''}</div>
              </div>
            </div>
          </td>
          <td>${emp.position}</td>
          <td>
            <div class="badge ${getBadgeColorForDepartment(emp.department)}">${emp.department}</div>
          </td>
          <td class="text-right">${formatCurrency(emp.baseSalary)}</td>
          <td class="text-right">${formatCurrency(emp.positionAllowance || 0)}</td>
          <td class="text-right">
            <div class="text-sm">${fieldAllowanceText}</div>
          </td>
          <td class="text-right">${formatCurrency(emp.overtime)}</td>
          <td class="text-right">${formatCurrency(emp.commission)}</td>
          <td class="text-right text-red-600 dark:text-red-400">-${formatCurrency(emp.withholdingTax || 0)}</td>
          <td class="text-right text-red-600 dark:text-red-400">-${formatCurrency(emp.socialSecurity || 750)}</td>
          <td class="text-right font-medium text-green-700 dark:text-green-400">${formatCurrency(emp.totalSalary)}</td>
          <td>
            <div class="flex gap-1 justify-center">
              <button class="btn btn-sm btn-info btn-circle tooltip tooltip-info tooltip-left" data-tip="แก้ไข" onclick="editEmployee(${emp.id})">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-error btn-circle tooltip tooltip-error tooltip-left" data-tip="ลบ" onclick="showDeleteConfirmation(${emp.id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        salaryTableBody.appendChild(tr);

        // Adding animation delay for staggered appearance
        tr.style.animation = `slideUp 0.3s ease-out ${index * 0.05}s forwards`;
        tr.style.opacity = '0';
      });

      updateEmployeeCount(employeesList.length);
    }

    // Update pagination info text
    function updatePaginationInfo(start, end, total) {
      if (total === 0) {
        paginationInfo.textContent = 'ไม่มีข้อมูลพนักงาน';
        return;
      }
    
      paginationInfo.textContent = `แสดง ${start + 1}-${Math.min(end, total)} จาก ${total} รายการ`;
    }

    // Render pagination controls
    function renderPaginationControls(totalPages) {
      paginationControls.innerHTML = '';
    
      // Add previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn btn-sm btn-outline';
      prevBtn.innerHTML = '«';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderEmployees(filteredEmployees);
        }
      });
      paginationControls.appendChild(prevBtn);
    
      // Add page number buttons
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
    
      if (endPage - startPage + 1 < maxButtons) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
    
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-active' : 'btn-outline'}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          renderEmployees(filteredEmployees);
        });
        paginationControls.appendChild(pageBtn);
      }
    
      // Add next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn btn-sm btn-outline';
      nextBtn.innerHTML = '»';
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderEmployees(filteredEmployees);
        }
      });
      paginationControls.appendChild(nextBtn);
    }

    // Return badge color based on department
    function getBadgeColorForDepartment(department) {
      switch(department) {
        case 'บัญชี': return 'badge-warning badge-outline';
        case 'การตลาด': return 'badge-info badge-outline';
        case 'ไอที': return 'badge-success badge-outline';
        case 'ทรัพยากรบุคคล': return 'badge-secondary badge-outline';
        case 'ขาย': return 'badge-primary badge-outline';
        default: return 'badge-outline';
      }
    }

    // คำนวณเงินเดือนรวมและแสดงในช่องแสดงผลรวม
    function updateTotalSalaryPreview() {
      const baseSalary = Number(baseSalaryInput.value) || 0;
      const positionAllowance = Number(positionAllowanceInput.value) || 0;
      const fieldAllowance = calculateFieldAllowanceAmount(); // ใช้ฟังก์ชันคำนวณค่าออกพื้นที่ใหม่
      const overtime = calculateOvertimeAmount(); // ใช้ฟังก์ชันคำนวณโอทีใหม่
      const commission = Number(commissionInput.value) || 0;
    
      // คำนวณเงินเดือนรวม (ก่อนหัก)
      const grossSalary = baseSalary + positionAllowance + fieldAllowance + overtime + commission;
    
      // คำนวณประกันสังคม 5% จากเงินเดือนพื้นฐาน
      const socialSecurity = Math.round(baseSalary * 0.05);
      socialSecurityInput.value = socialSecurity;
    
      // คำนวณหัก ณ ที่จ่าย 3% จากค่าคอม (เฉพาะเมื่อค่าคอม >= 1000 บาท)
      let withholdingTax = 0;
      if (commission >= 1000) {
        withholdingTax = Math.round(commission * 0.03);
      }
    
      const withholdingTaxInput = document.getElementById('withholdingTax');
      if (withholdingTaxInput) {
        withholdingTaxInput.value = withholdingTax;
      }
    
      // คำนวณรวมยอดหัก
      const totalDeduction = socialSecurity + withholdingTax;
    
      // คำนวณเงินเดือนสุทธิ
      const netSalary = grossSalary - totalDeduction;
    
      // แสดงผลในฟอร์ม
      if (grossSalaryDisplay) {
        grossSalaryDisplay.value = formatCurrency(grossSalary);
      }
    
      if (withholdingTaxDisplay) {
        withholdingTaxDisplay.textContent = `-${formatCurrency(withholdingTax)}`;
      }
    
      if (socialSecurityDisplay) {
        socialSecurityDisplay.textContent = `-${formatCurrency(socialSecurity)}`;
      }
    
      if (totalDeductionDisplay) {
        totalDeductionDisplay.textContent = `-${formatCurrency(totalDeduction)}`;
      }
    
      totalSalaryDisplay.value = formatCurrency(netSalary);
    }

    // สร้างรหัสพนักงานอัตโนมัติ
    function generateEmployeeCode() {
      const maxId = employees.reduce((max, emp) => {
        const empNum = parseInt(emp.code.replace('EMP', ''));
        return empNum > max ? empNum : max;
      }, 0);
    
      const newId = maxId + 1;
      return 'EMP' + String(newId).padStart(3, '0');
    }

    // คำนวณค่าออกลงพื้นที่
    function calculateFieldAllowanceAmount() {
      const days = Number(document.getElementById('fieldAllowanceDays')?.value) || 0;
      const type = document.getElementById('fieldAllowanceType')?.value || 'none';
    
      let ratePerDay = 0;
      switch(type) {
        case 'upper': ratePerDay = 300; break;
        case 'lower': ratePerDay = 200; break;
        default: ratePerDay = 0; break;
      }
    
      const total = days * ratePerDay;
    
      // อัปเดตการแสดงผล
      const fieldAllowanceTotalDisplay = document.getElementById('fieldAllowanceTotal');
      if (fieldAllowanceTotalDisplay) {
        fieldAllowanceTotalDisplay.textContent = formatCurrency(total);
      }
    
      // อัปเดต hidden input
      const fieldAllowanceInput = document.getElementById('fieldAllowance');
      if (fieldAllowanceInput) {
        fieldAllowanceInput.value = total;
      }
    
      return total;
    }

    // คำนวณค่าออกลงพื้นที่ (ฟังก์ชันเก่าสำหรับความเข้ากันได้)
    function getFieldAllowanceAmount(type) {
      return calculateFieldAllowanceAmount();
    }

    // คำนวณค่าโอที
    function calculateOvertimeAmount() {
      const hours = Number(overtimeHoursInput?.value) || 0;
      const rate = Number(overtimeRateSelect?.value) || 55;
      const total = hours * rate;
    
      // อัปเดตการแสดงผล
      if (overtimeTotalDisplay) {
        overtimeTotalDisplay.textContent = formatCurrency(total);
      }
    
      // อัปเดต hidden input
      if (overtimeInput) {
        overtimeInput.value = total;
      }
    
      return total;
    }

    // คำนวณเงินเดือนรวมแบบใหม่
    function calculateTotalSalary(baseSalary, positionAllowance, fieldAllowance, overtime, commission, socialSecurity, withholdingTax = 0) {
      const grossSalary = Number(baseSalary) + Number(positionAllowance) + Number(fieldAllowance) + Number(overtime) + Number(commission);
      return grossSalary - Number(socialSecurity) - Number(withholdingTax);
    }

    // คำนวณเงินเดือนรวม (เก่า - เพื่อความเข้ากันได้)
    function calculateTotalSalaryOld(baseSalary, overtime, commission) {
      return Number(baseSalary) + Number(overtime) + Number(commission);
    }

    // เปิด Modal
    function openModal() {
      modal.classList.add('modal-open');
    }

    // ปิด Modal
    function closeModal() {
      modal.classList.remove('modal-open');
      resetFormValidation();
      clearFileUpload(); // Clear file upload when closing modal
    }

    // เพิ่มพนักงานใหม่
    function addEmployee() {
      modalTitle.innerHTML = '<i class="bi bi-person-plus mr-2"></i>เพิ่มพนักงานใหม่';
      form.reset();
      form.employeeId.value = '';
    
      // Reset employee selection
      document.getElementById('employeeSelect').value = '';
      document.getElementById('selectedEmployeeInfo').classList.add('hidden');
    
      // Clear hidden inputs
      document.getElementById('empCode').value = '';
      document.getElementById('empName').value = '';
      document.getElementById('position').value = '';
      document.getElementById('department').value = '';
      document.getElementById('branch').value = '';
    
      // ตั้งค่าเริ่มต้น
      document.getElementById('positionAllowance').value = '';
      document.getElementById('fieldAllowanceType').value = 'none';
      document.getElementById('fieldAllowanceDays').value = '';
      document.getElementById('overtimeHours').value = '';
      document.getElementById('overtimeRate').value = '55';
      document.getElementById('commission').value = '';
    
      // รีเซ็ตการแสดงผล
      if (grossSalaryDisplay) grossSalaryDisplay.value = '';
      if (withholdingTaxDisplay) withholdingTaxDisplay.textContent = '';
      if (socialSecurityDisplay) socialSecurityDisplay.textContent = '';
      if (totalDeductionDisplay) totalDeductionDisplay.textContent = '';
      if (overtimeTotalDisplay) overtimeTotalDisplay.textContent = '';
    
      // รีเซ็ตค่าออกพื้นที่
      const fieldAllowanceTotalDisplay = document.getElementById('fieldAllowanceTotal');
      if (fieldAllowanceTotalDisplay) fieldAllowanceTotalDisplay.textContent = '';
    
      // Clear file upload
      clearFileUpload();
    
      updateTotalSalaryPreview();
      openModal();
    }

    // แก้ไขข้อมูลพนักงาน
    function editEmployee(id) {
      modalTitle.innerHTML = '<i class="bi bi-pencil-square mr-2"></i>แก้ไขข้อมูลพนักงาน';
      const employee = employees.find(emp => emp.id === id);
    
      if (employee) {
        form.employeeId.value = employee.id;
        form.empCode.value = employee.code;
        form.empName.value = employee.name;
        form.position.value = employee.position;
        form.department.value = employee.department;
        form.bankName.value = employee.bankName || '';
        form.accountNumber.value = employee.accountNumber || '';
        form.baseSalary.value = employee.baseSalary;
        form.positionAllowance.value = employee.positionAllowance || 0;
        form.fieldAllowanceType.value = employee.fieldAllowanceType || 'none';
        form.commission.value = employee.commission;
    
        // จัดการข้อมูลค่าออกพื้นที่
        if (employee.fieldAllowanceDays) {
          document.getElementById('fieldAllowanceDays').value = employee.fieldAllowanceDays;
        } else {
          // ถ้าเป็นข้อมูลเก่า ให้คำนวณจำนวนวันจากยอดรวม
          const fieldAllowanceAmount = employee.fieldAllowance || 0;
          const ratePerDay = employee.fieldAllowanceType === 'upper' ? 300 :
                           employee.fieldAllowanceType === 'lower' ? 200 : 0;
          const estimatedDays = ratePerDay > 0 ? (fieldAllowanceAmount / ratePerDay) : 0;
          document.getElementById('fieldAllowanceDays').value = estimatedDays;
        }
    
        // จัดการข้อมูลโอทีที่มีอยู่แล้ว (ถ้ามี)
        const overtimeAmount = employee.overtime || 0;
        if (employee.overtimeHours && employee.overtimeRate) {
          // ถ้ามีข้อมูลชั่วโมงและอัตราแล้ว
          document.getElementById('overtimeHours').value = employee.overtimeHours;
          document.getElementById('overtimeRate').value = employee.overtimeRate;
        } else {
          // ถ้าเป็นข้อมูลเก่าที่เก็บแค่ยอดรวม ให้คำนวณย้อนกลับ (สมมติอัตรา 55 บาท)
          const estimatedHours = overtimeAmount > 0 ? (overtimeAmount / 55) : 0;
          document.getElementById('overtimeHours').value = estimatedHours;
          document.getElementById('overtimeRate').value = '55';
        }
    
        // อัปเดตการแสดงผลทั้งหมด
        updateTotalSalaryPreview();
        openModal();
      }
    }
    
    // แสดง modal ยืนยันการลบ
    function showDeleteConfirmation(id) {
      const employee = employees.find(emp => emp.id === id);
      if (employee) {
        currentEmployeeId = id;
        deleteEmployeeName.textContent = employee.name;
        confirmModal.classList.add('modal-open');
      }
    }
    
    // ซ่อน modal ยืนยันการลบ
    function hideConfirmDeleteModal() {
      confirmModal.classList.remove('modal-open');
      currentEmployeeId = null;
    }
    
    // ยืนยันการลบพนักงาน
    async function confirmDelete() {
      if (currentEmployeeId) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/employee-salaries/${currentEmployeeId}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (result.success) {
            hideConfirmDeleteModal();
            showToast(result.message || 'ลบข้อมูลเรียบร้อยแล้ว', 'success');
            await loadEmployeeSalaries(); // โหลดข้อมูลใหม่
          } else {
            throw new Error(result.message || 'ไม่สามารถลบข้อมูลได้');
          }

        } catch (error) {
          console.error('Delete Error:', error);
          hideConfirmDeleteModal();
          showToast('ไม่สามารถลบข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'error');
        }
      }
    }

    // ตรวจสอบข้อมูลในฟอร์ม
    function validateForm() {
      let isValid = true;
    
      // Check employee selection first
      const employeeSelect = document.getElementById('employeeSelect');
      const employeeSelectError = document.getElementById('employeeSelectError');
      if (!employeeSelect.value) {
        employeeSelectError.classList.remove('hidden');
        isValid = false;
        employeeSelect.classList.add('border-red-500');
      } else {
        employeeSelectError.classList.add('hidden');
        employeeSelect.classList.remove('border-red-500');
      }
    
      // Check other required fields (department, bank info, salary)
      const requiredFields = [
        { field: 'department', errorEl: document.getElementById('departmentError') },
        { field: 'bankName', errorEl: document.getElementById('bankNameError') },
        { field: 'accountNumber', errorEl: document.getElementById('accountNumberError') },
        { field: 'baseSalary', errorEl: document.getElementById('baseSalaryError') }
      ];
    
      requiredFields.forEach(({ field, errorEl }) => {
        const inputEl = document.getElementById(field);
        if (inputEl && !inputEl.value.trim()) {
          if (errorEl) {
            errorEl.classList.remove('hidden');
            isValid = false;
          }
          inputEl.classList.add('border-red-500');
        } else if (inputEl && errorEl) {
          errorEl.classList.add('hidden');
          inputEl.classList.remove('border-red-500');
        }
      });
    
      return isValid;
    }
    
    // Reset form validation visual state
    function resetFormValidation() {
      const errorElements = document.querySelectorAll('[id$="Error"]');
      errorElements.forEach(el => {
        el.classList.add('hidden');
      });
    
      const inputElements = form.querySelectorAll('input, select');
      inputElements.forEach(el => {
        el.classList.remove('border-red-500');
      });
    }
    
    // กรองข้อมูลตามแผนก
    function filterByDepartment(department) {
      currentFilter = department;
      currentPage = 1;
      renderEmployees(employees);
    }
    
    // เรียงลำดับข้อมูล
    function sortEmployees(field, order) {
      currentSort = { field, order };
      renderEmployees(employees);
    }
    
    // ส่งออกเป็นไฟล์ Excel
    function exportToExcel() {
      showToast('กำลังส่งออกข้อมูล... (ฟีเจอร์นี้จะทำงานเมื่อเชื่อมต่อกับ API จริง)', 'info');
    }

    // ======= IMPORT FUNCTIONS =======

    // เปิด Modal นำเข้าข้อมูล
    function openImportModal() {
      importModal.classList.add('modal-open');
      clearFile();
    }

    // ปิด Modal นำเข้าข้อมูล
    function closeImportModal() {
      importModal.classList.remove('modal-open');
      clearFile();
      hideImportProgress();
    }

    // ล้างไฟล์ที่เลือก
    function clearFile() {
      selectedFile = null;
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      importButton.disabled = true;
      updateDropZoneUI(false);
    }

    // อัปเดต UI ของ Drop Zone
    function updateDropZoneUI(isDragOver = false) {
      if (isDragOver) {
        dropZone.classList.add('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900', 'dark:bg-opacity-20');
      } else {
        dropZone.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-blue-900', 'dark:bg-opacity-20');
      }
    }

    // จัดการไฟล์ที่เลือก
    function handleFileSelect(file) {
      if (!file) return;

      // ตรวจสอบประเภทไฟล์
      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel', // .xls
        'text/csv', // .csv
        'application/json' // .json
      ];

      const fileExtension = file.name.split('.').pop().toLowerCase();
      const isValidType = allowedTypes.includes(file.type) ||
                         ['xlsx', 'xls', 'csv', 'json'].includes(fileExtension);

      if (!isValidType) {
        showToast('ประเภทไฟล์ไม่ถูกต้อง กรุณาเลือกไฟล์ Excel, CSV หรือ JSON', 'error');
        return;
      }

      // ตรวจสอบขนาดไฟล์ (จำกัดที่ 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showToast('ไฟล์มีขนาดใหญ่เกินไป (สูงสุด 10MB)', 'error');
        return;
      }

      selectedFile = file;

      // แสดงข้อมูลไฟล์
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
    
      // เลือกไอคอนตามประเภทไฟล์
      if (fileExtension === 'xlsx' || fileExtension === 'xls') {
        fileIcon.className = 'bi bi-file-earmark-excel text-2xl text-green-600 dark:text-green-400';
      } else if (fileExtension === 'csv') {
        fileIcon.className = 'bi bi-filetype-csv text-2xl text-blue-600 dark:text-blue-400';
      } else if (fileExtension === 'json') {
        fileIcon.className = 'bi bi-filetype-json text-2xl text-yellow-600 dark:text-yellow-400';
      }

      fileInfo.classList.remove('hidden');
      importButton.disabled = false;
    
      showToast(`เลือกไฟล์ ${file.name} เรียบร้อยแล้ว`, 'success');
    }

    // แปลงขนาดไฟล์เป็นรูปแบบที่อ่านง่าย
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // แสดง Progress Bar
    function showImportProgress() {
      importProgress.classList.remove('hidden');
    }

    // ซ่อน Progress Bar
    function hideImportProgress() {
      importProgress.classList.add('hidden');
      progressBar.value = 0;
      progressText.textContent = '0%';
    }

    // อัปเดต Progress
    function updateProgress(percent) {
      progressBar.value = percent;
      progressText.textContent = Math.round(percent) + '%';
    }

    // ประมวลผลการนำเข้าข้อมูล
    async function processImport() {
      if (!selectedFile) {
        showToast('กรุณาเลือกไฟล์ก่อน', 'error');
        return;
      }

      showImportProgress();
      importButton.disabled = true;

      try {
        let importedData = [];
        const fileExtension = selectedFile.name.split('.').pop().toLowerCase();

        updateProgress(20);

        // อ่านไฟล์ตามประเภท
        if (fileExtension === 'json') {
          importedData = await readJSONFile(selectedFile);
        } else if (fileExtension === 'csv') {
          importedData = await readCSVFile(selectedFile);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
          // สำหรับไฟล์ Excel ในที่นี้จะจำลองข้อมูล
          // ในระบบจริงต้องใช้ library เช่น SheetJS
          importedData = await simulateExcelRead(selectedFile);
        }

        updateProgress(60);

        // ตรวจสอบและประมวลผลข้อมูล
        const processedData = processImportedData(importedData);
    
        updateProgress(80);

        // นำเข้าข้อมูลเข้าระบบ
        const result = await importEmployeeData(processedData);
    
        updateProgress(100);

        // แสดงผลลัพธ์
        showImportResult(result);

        setTimeout(() => {
          closeImportModal();
          hideImportProgress();
          importButton.disabled = false;
          // ข้อมูลจะถูกรีเฟรชแล้วใน importEmployeeData
        }, 2000);

      } catch (error) {
        console.error('Error importing file:', error);
        showToast('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message, 'error');
        hideImportProgress();
        importButton.disabled = false;
      }
    }

    // อ่านไฟล์ JSON
    function readJSONFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            resolve(Array.isArray(data) ? data : [data]);
          } catch (error) {
            reject(new Error('ไฟล์ JSON ไม่ถูกต้อง'));
          }
        };
        reader.onerror = () => reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
        reader.readAsText(file);
      });
    }

    // อ่านไฟล์ CSV
    function readCSVFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
              reject(new Error('ไฟล์ CSV ต้องมีหัวตารางและข้อมูลอย่างน้อย 1 แถว'));
              return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',').map(v => v.trim().replace(/['"]/g, ''));
              if (values.length === headers.length) {
                const row = {};
                headers.forEach((header, index) => {
                  row[header] = values[index];
                });
                data.push(row);
              }
            }

            resolve(data);
          } catch (error) {
            reject(new Error('ไฟล์ CSV ไม่ถูกต้อง'));
          }
        };
        reader.onerror = () => reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
        reader.readAsText(file);
      });
    }

    // จำลองการอ่านไฟล์ Excel (ในระบบจริงต้องใช้ library)
    function simulateExcelRead(file) {
      return new Promise((resolve) => {
        // จำลองข้อมูลตัวอย่างจากไฟล์ Excel
        setTimeout(() => {
          const sampleData = [
            {
              'employeeId': 'EMP009',
              'code': 'EMP009',
              'name': 'ทดสอบ นำเข้า',
              'position': 'พนักงานทดสอบ',
              'department': 'ไอที',
              'baseSalary': '25000',
              'positionAllowance': '1000',
              'fieldAllowanceType': 'none',
              'fieldAllowance': '0',
              'overtime': '2000',
              'commission': '1000',
              'socialSecurity': '750',
              'bankName': 'ธนาคารกรุงเทพ',
              'accountNumber': '123-456-7890',
              'status': 'active'
            }
          ];
          resolve(sampleData);
        }, 1000);
      });
    }

    // ประมวลผลข้อมูลที่นำเข้า
    function processImportedData(rawData) {
      const processedData = [];

      rawData.forEach((row, index) => {
        try {
          // จับคู่ชื่อคอลัมน์ที่เป็นไปได้
          const mappedRow = {
            employeeId: row['employeeId'] || row['รหัสพนักงาน'] || row['code'] || row['employee_code'] || row['รหัส'],
            code: row['code'] || row['รหัสพนักงาน'] || row['employee_code'] || row['รหัส'],
            name: row['name'] || row['ชื่อพนักงาน'] || row['employee_name'] || row['ชื่อ'],
            position: row['position'] || row['ตำแหน่ง'] || row['job_title'] || row['หน้าที่'],
            department: row['department'] || row['แผนก'] || row['dept'],
            baseSalary: parseFloat(row['baseSalary'] || row['เงินเดือนพื้นฐาน'] || row['base_salary'] || row['salary'] || row['เงินเดือน'] || 0),
            positionAllowance: parseFloat(row['positionAllowance'] || row['ค่าตำแหน่ง'] || row['position_allowance'] || 0),
            fieldAllowanceType: row['fieldAllowanceType'] || row['ประเภทค่าออกพื้นที่'] || row['field_allowance_type'] || 'none',
            fieldAllowance: parseFloat(row['fieldAllowance'] || row['ค่าออกพื้นที่'] || row['field_allowance'] || 0),
            overtime: parseFloat(row['overtime'] || row['โอที'] || row['ot'] || 0),
            commission: parseFloat(row['commission'] || row['ค่าคอม'] || row['com'] || 0),
            socialSecurity: parseFloat(row['socialSecurity'] || row['ประกันสังคม'] || row['social_security'] || 750),
            bankName: row['bankName'] || row['ธนาคาร'] || row['bank_name'] || '',
            accountNumber: row['accountNumber'] || row['เลขบัญชี'] || row['account_number'] || '',
            status: row['status'] || row['สถานะ'] || 'active'
          };

          // ตรวจสอบข้อมูลที่จำเป็น
          if (!mappedRow.code || !mappedRow.name) {
            throw new Error(`แถวที่ ${index + 1}: ขาดข้อมูลรหัสพนักงานหรือชื่อ`);
          }

          // ใช้ code เป็น employeeId ถ้าไม่มี employeeId
          if (!mappedRow.employeeId) {
            mappedRow.employeeId = mappedRow.code;
          }

          // คำนวณเงินเดือนรวม (จะถูกคำนวณใหม่ใน backend แต่ส่งไปเป็นค่าเริ่มต้น)
          mappedRow.totalSalary = mappedRow.baseSalary + mappedRow.positionAllowance + mappedRow.fieldAllowance + mappedRow.overtime + mappedRow.commission - mappedRow.socialSecurity;
    
          processedData.push(mappedRow);

        } catch (error) {
          console.warn(`ข้ามแถวที่ ${index + 1}: ${error.message}`);
        }
      });

      return processedData;
    }

    // นำเข้าข้อมูลพนักงานเข้าระบบ
    async function importEmployeeData(data) {
      try {
        const formData = {
          employees: data,
          updateExisting: updateExisting ? updateExisting.checked : false
        };

        const response = await fetch(`${API_BASE_URL}/api/employee-salaries/bulk-import`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
    
        // รีเฟรชข้อมูลหลังจากนำเข้าเสร็จ
        await loadEmployeeSalaries();
    
        return result;
      } catch (error) {
        console.error('Error importing employee data:', error);
        return {
          total: data.length,
          imported: 0,
          updated: 0,
          skipped: 0,
          errors: [`เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ${error.message}`]
        };
      }
    }

    // แสดงผลลัพธ์การนำเข้า
    function showImportResult(result) {
      let message = `นำเข้าข้อมูลเสร็จสิ้น!\n`;
      message += `- เพิ่มใหม่: ${result.imported} คน\n`;
      message += `- อัปเดต: ${result.updated} คน\n`;
      message += `- ข้าม: ${result.skipped} คน`;

      if (result.errors.length > 0) {
        message += `\n- ข้อผิดพลาด: ${result.errors.length} รายการ`;
      }

      showToast(message, result.errors.length > 0 ? 'info' : 'success');
    }

    // ดาวน์โหลดไฟล์ตัวอย่าง
    function downloadTemplate(type) {
      const templateData = {
        'employeeId': 'EMP001',
        'code': 'EMP001',
        'name': 'ตัวอย่าง พนักงาน',
        'position': 'พนักงานตัวอย่าง',
        'department': 'ไอที',
        'baseSalary': '25000',
        'positionAllowance': '1000',
        'fieldAllowanceType': 'none',
        'fieldAllowance': '0',
        'overtime': '2000',
        'commission': '1000',
        'socialSecurity': '750',
        'bankName': 'ธนาคารกรุงเทพ',
        'accountNumber': '123-456-7890',
        'status': 'active'
      };

      if (type === 'json') {
        downloadJSONTemplate([templateData]);
      } else if (type === 'csv') {
        downloadCSVTemplate([templateData]);
      } else if (type === 'excel') {
        showToast('การดาวน์โหลด Excel Template จะพร้อมใช้ในเวอร์ชันถัดไป', 'info');
      }
    }

    // ดาวน์โหลดไฟล์ JSON ตัวอย่าง
    function downloadJSONTemplate(data) {
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'employee_template.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ดาวน์โหลดไฟล์ CSV ตัวอย่าง
    function downloadCSVTemplate(data) {
      const headers = Object.keys(data[0]);
      let csvContent = headers.join(',') + '\n';
    
      data.forEach(row => {
        const values = headers.map(header => `"${row[header]}"`);
        csvContent += values.join(',') + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'employee_template.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Event Listeners
    // เปิด Modal เพื่อเพิ่มพนักงานใหม่ (redirect to new modal)
    if (addEmployeeBtn) {
      addEmployeeBtn.addEventListener('click', openBasicEmployeeModal);
    }
    
    // Handle additional add employee buttons (redirect to new modal)
    document.querySelectorAll('.add-employee-btn').forEach(btn => {
      btn.addEventListener('click', openBasicEmployeeModal);
    });

    // เปิด Modal นำเข้าข้อมูล
      importBtn.addEventListener('click', openImportModal);
    
    // Handle additional import buttons
    document.querySelectorAll('.import-btn').forEach(btn => {
        btn.addEventListener('click', openImportModal);
    });

    // ======= IMPORT EVENT LISTENERS =======

    // Drop zone events
    dropZone.addEventListener('click', () => fileInput.click());
    
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        updateDropZoneUI(true);
      });
    
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        updateDropZoneUI(false);
      });
    
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        updateDropZoneUI(false);
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

    // File input change event
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

    // Checkbox conflict resolution
      skipDuplicates.addEventListener('change', () => {
      if (skipDuplicates.checked) {
          updateExisting.checked = false;
        }
      });

      updateExisting.addEventListener('change', () => {
      if (updateExisting.checked) {
          skipDuplicates.checked = false;
        }
      });

    // Update total salary display as user types
      baseSalaryInput.addEventListener('input', updateTotalSalaryPreview);
      positionAllowanceInput.addEventListener('input', updateTotalSalaryPreview);
      fieldAllowanceTypeSelect.addEventListener('change', updateTotalSalaryPreview);
    
    // เพิ่ม event listeners สำหรับค่าออกพื้นที่
    const fieldAllowanceDaysInput = document.getElementById('fieldAllowanceDays');
    if (fieldAllowanceDaysInput) {
      fieldAllowanceDaysInput.addEventListener('input', updateTotalSalaryPreview);
    }
    
      overtimeHoursInput.addEventListener('input', updateTotalSalaryPreview);
      overtimeRateSelect.addEventListener('change', updateTotalSalaryPreview);
      commissionInput.addEventListener('input', updateTotalSalaryPreview);
    // ไม่ต้องฟัง socialSecurityInput เพราะคำนวณอัตโนมัติแล้ว

    // Submit form - ใช้ API จริง
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
    
        if (!validateForm()) {
          showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
          return;
      }
    
      try {
        const isEdit = !!form.employeeId.value;
        const fileInput = document.getElementById('salaryDocument');
        const hasFile = fileInput && fileInput.files.length > 0;
    
        // Create FormData for file upload
        const formData = new FormData();
    
        // Add all form fields to FormData
        formData.append('empCode', form.empCode.value);
        formData.append('empName', form.empName.value);
        formData.append('position', form.position.value);
        formData.append('department', form.department.value);
        formData.append('bankName', form.bankName.value);
        formData.append('accountNumber', form.accountNumber.value);
        formData.append('baseSalary', parseFloat(form.baseSalary.value));
        formData.append('positionAllowance', parseFloat(form.positionAllowance.value) || 0);
        formData.append('fieldAllowanceType', form.fieldAllowanceType.value);
        formData.append('fieldAllowanceDays', parseFloat(document.getElementById('fieldAllowanceDays').value) || 0);
        formData.append('overtimeHours', parseFloat(document.getElementById('overtimeHours').value) || 0);
        formData.append('overtimeRate', parseFloat(document.getElementById('overtimeRate').value) || 55);
        formData.append('overtime', parseFloat(form.overtime.value) || 0);
        formData.append('commission', parseFloat(form.commission.value) || 0);
        formData.append('socialSecurity', parseFloat(form.socialSecurity.value) || 0);
        formData.append('withholdingTax', parseFloat(document.getElementById('withholdingTax').value) || 0);
    
        // Add file if selected
        if (hasFile) {
          formData.append('salaryDocument', fileInput.files[0]);
          console.log('Uploading file:', fileInput.files[0].name);
        }

        let response;
    
        // Set up headers (don't include Content-Type for FormData - browser will set it automatically)
        const headers = {};
        const token = getAuthToken();
        if (token && token !== 'development-token-12345') {
          headers['Authorization'] = `Bearer ${token}`;
        }
    
        if (isEdit) {
          // แก้ไขข้อมูล
          response = await fetch(`${API_BASE_URL}/api/employee-salaries/${form.employeeId.value}`, {
            method: 'PUT',
            headers: headers,
            body: formData
          });
        } else {
          // เพิ่มข้อมูลใหม่
          response = await fetch(`${API_BASE_URL}/api/employee-salaries`, {
            method: 'POST',
            headers: headers,
            body: formData
          });
        }

        if (!response.ok) {
          // พยายามอ่านข้อความผิดพลาดจาก server
          try {
            const errorData = await response.json();
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
          } catch (parseError) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        }

        const result = await response.json();

        if (result.success) {
          showToast(result.message || (isEdit ? 'อัปเดตข้อมูลสำเร็จ' : 'เพิ่มข้อมูลสำเร็จ'), 'success');
          closeModal();
          await loadEmployeeSalaries(); // โหลดข้อมูลใหม่
        } else {
          throw new Error(result.message || 'ไม่สามารถบันทึกข้อมูลได้');
        }

      } catch (error) {
        console.error('Save Error:', error);
        showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    });

    // ค้นหาพนักงาน (updated for new system)
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        currentPage = 1;
        renderNewEmployeeTable();
      });
    }

    // Check for preferred color scheme and saved settings
    function initializeTheme() {
      // Check local storage first
      const savedDarkMode = localStorage.getItem('darkMode');
    
      if (savedDarkMode !== null) {
        isDarkMode = savedDarkMode === 'true';
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // If no saved preference, check system preference
        isDarkMode = true;
      }
    
      // Apply theme
      htmlElement.classList.toggle('dark', isDarkMode);
      htmlElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
      darkModeLabel.textContent = isDarkMode ? 'โหมดกลางวัน' : 'โหมดกลางคืน';
      darkModeIcon.className = isDarkMode ? 'bi bi-sun text-xl' : 'bi bi-moon text-xl';
    }

    // Responsive sidebar handling
    function handleResponsiveness() {
      const mainContent = document.getElementById('mainContent');
    
      if (window.innerWidth < 1024) {
        isSidebarVisible = false;
        sidebar.classList.add('-translate-x-64');
        if (mainContent) {
          mainContent.classList.remove('ml-64');
          mainContent.classList.add('ml-0');
        }
        btnToggleMenu.innerHTML = '<i class="bi bi-chevron-right text-xl"></i>';
      } else {
        isSidebarVisible = true;
        sidebar.classList.remove('-translate-x-64');
        if (mainContent) {
          mainContent.classList.remove('ml-0');
          mainContent.classList.add('ml-64');
        }
        btnToggleMenu.innerHTML = '<i class="bi bi-chevron-left text-xl"></i>';
      }
    }

    window.addEventListener('resize', handleResponsiveness);

    // ========== COMMISSION FUNCTIONS ==========
    
    let currentTab = 'salary';
    let commissionView = 'realtime';
    let commissionData = [];
    let commissionSettings = [];
    let selectedRules = [];
    let selectedEmployees = [];

    // Switch between Salary and Commission tabs
    function switchTab(tab) {
      currentTab = tab;

      // Update tab appearance
      document.getElementById('salaryTab').classList.toggle('tab-active', tab === 'salary');
      document.getElementById('commissionTab').classList.toggle('tab-active', tab === 'commission');
      document.getElementById('bonusTab').classList.toggle('tab-active', tab === 'bonus');

      // Show/hide content
      document.getElementById('salaryContent').classList.toggle('hidden', tab !== 'salary');
      document.getElementById('commissionContent').classList.toggle('hidden', tab !== 'commission');
      document.getElementById('bonusContent').classList.toggle('hidden', tab !== 'bonus');

      // Load data when switching tabs
      if (tab === 'commission') {
        loadCommissionData();
      } else if (tab === 'bonus') {
        loadBonusData();
      }
    }

    // Set commission view (realtime or history)
    function setCommissionView(view) {
      commissionView = view;
    
      document.getElementById('realtimeCommissionView').classList.toggle('hidden', view !== 'realtime');
      document.getElementById('historyCommissionView').classList.toggle('hidden', view !== 'history');
    
      if (view === 'realtime') {
        loadRealtimeCommissions();
      } else {
        loadCommissionHistory();
      }
    }

    // Load commission data
    async function loadCommissionData() {
      try {
        // Load employees for commission tracking
        await loadEmployeesForCommission();
    
        // Load current commission data
        await loadRealtimeCommissions();
    
        // Start real-time updates if socket is available
        if (window.io) {
          setupCommissionSocket();
        }
      } catch (error) {
        console.error('Error loading commission data:', error);
        showToast('ไม่สามารถโหลดข้อมูลค่าคอมมิชชั่นได้', 'error');
      }
    }

    // Load employees for commission
    async function loadEmployeesForCommission() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/users?role=sales&limit=0`, {
          headers: getAuthHeaders()
        });
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
          const result = await response.json();
        const employees = result.data || result.users || result || [];
    
        const employeeSelect = document.getElementById('employeeSelect');
        if (employeeSelect && Array.isArray(employees)) {
            employeeSelect.innerHTML = '<option value="">เลือกพนักงาน...</option>';
    
          employees.forEach(emp => {
            const name = emp.name || emp.fullName || 'ไม่ระบุชื่อ';
            const position = emp.position || emp.role || 'พนักงานขาย';
            employeeSelect.innerHTML += `<option value="${emp._id || emp.id}">${name} - ${position}</option>`;
          });
    
          console.log(`Loaded ${employees.length} sales employees for commission`);
        }
      } catch (error) {
        console.error('Error loading employees for commission:', error);
        const employeeSelect = document.getElementById('employeeSelect');
        if (employeeSelect) {
          employeeSelect.innerHTML = '<option value="">ไม่สามารถโหลดรายชื่อพนักงานได้</option>';
        }
      }
    }

    // Load all employees for payroll (using main users API)
    async function loadAllEmployeesForPayroll() {
      const employeeSelect = document.getElementById('employeeSelect');
    
      try {
        const response = await fetch(`${API_BASE_URL}/api/users?limit=0`, {
          headers: getAuthHeaders()
        });
    
        if (!response.ok) {
          if (response.status === 401) {
            showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
            return;
          } else if (response.status === 403) {
            showToast('ไม่มีสิทธิ์เข้าถึงข้อมูลพนักงาน', 'error');
            return;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const result = await response.json();
        populateEmployeeSelect(result);
        console.log('✅ Loaded employees for payroll from /api/users');
    
      } catch (error) {
        console.error('Error loading employees for payroll:', error);
    
        if (employeeSelect) {
          employeeSelect.innerHTML = '<option value="">ไม่สามารถโหลดรายชื่อพนักงานได้</option>';
        }
        showToast('ไม่สามารถโหลดรายชื่อพนักงานได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
      }
    }

    // Helper function to populate employee select
    function populateEmployeeSelect(result) {
      const employeeSelect = document.getElementById('employeeSelect');
    
      if (!employeeSelect) return;
    
      // Initialize dropdown
      employeeSelect.innerHTML = '<option value="">กรุณาเลือกพนักงาน</option>';
    
      // Check if we have any data
      let employees = [];
    
      if (result && result.data && Array.isArray(result.data)) {
        employees = result.data;
      } else if (result && result.users && Array.isArray(result.users)) {
        employees = result.users;
      } else if (result && Array.isArray(result)) {
        employees = result;
      } else {
        console.warn('No employee data found in API response');
        showToast('ไม่พบข้อมูลพนักงาน', 'warning');
        return;
      }
    
      console.log('Processing employees from API:', employees.length);
    
      // Debug: Log first employee structure
      if (employees.length > 0) {
        console.log('📋 First employee structure:', employees[0]);
      }
    
      employees.forEach((emp, index) => {
        // Handle different data structures from real API with better name extraction
        let empName = '';
        if (emp.employee && emp.employee.name && emp.employee.name.trim()) {
          empName = emp.employee.name.trim();
        } else if (emp.name && emp.name.trim()) {
          empName = emp.name.trim();
        } else if (emp.fullName && emp.fullName.trim()) {
          empName = emp.fullName.trim();
        } else if (emp.firstName || emp.lastName) {
          empName = `${emp.firstName || ''} ${emp.lastName || ''}`.trim();
        } else if (emp.username && emp.username.trim()) {
          empName = emp.username.trim();
        } else {
          empName = `User ${emp._id || emp.id || index + 1}`;
        }
    
        const empData = {
          id: emp._id || emp.id || `emp_${index}`,
          code: emp.emp_code || emp.employeeId || emp.code || `EMP${String(index + 1).padStart(3, '0')}`,
          name: empName,
          position: emp.position || emp.role || emp.job_title || 'พนักงาน',
          department: emp.department || emp.dept || emp.division || 'ฝ่ายทั่วไป',
          branch: emp.branch?.name || emp.branchName || emp.branch_name || emp.location || 'สำนักงานใหญ่'
        };
    
        // Debug log for first few employees
        if (index < 3) {
          console.log(`👤 Employee ${index + 1} name extraction:`, {
            original: {
              employee_name: emp.employee?.name,
              name: emp.name,
              fullName: emp.fullName,
              firstName: emp.firstName,
              lastName: emp.lastName,
              username: emp.username
            },
            extracted: empName
          });
        }
    
        employeeSelect.innerHTML += `
          <option value="${empData.id}" 
                  data-code="${empData.code}"
                  data-name="${empData.name}"
                  data-position="${empData.position}"
                  data-department="${empData.department}"
                  data-branch="${empData.branch}">
            ${empData.name} - ${empData.position} (${empData.branch})
          </option>`;
      });
    
      console.log(`โหลดข้อมูลพนักงาน ${employees.length} คนสำเร็จ`);
    }


    // Handle employee selection for payroll form
    function handleEmployeeSelection() {
      const employeeSelect = document.getElementById('employeeSelect');
      const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');
    
      if (!employeeSelect || !selectedEmployeeInfo) {
        console.warn('Employee select elements not found');
        return;
      }
    
      employeeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
    
        if (this.value && selectedOption) {
          console.log('Employee selected:', selectedOption.dataset);
    
          // Show employee info
          selectedEmployeeInfo.classList.remove('hidden');
    
          // Get data with fallbacks
          const empCode = selectedOption.dataset.code || selectedOption.getAttribute('data-code') || 'ไม่มีรหัส';
          const empName = selectedOption.dataset.name || selectedOption.getAttribute('data-name') || 'ไม่ระบุชื่อ';
          const position = selectedOption.dataset.position || selectedOption.getAttribute('data-position') || 'ไม่ระบุตำแหน่ง';
          const department = selectedOption.dataset.department || selectedOption.getAttribute('data-department') || 'ไม่ระบุแผนก';
          const branch = selectedOption.dataset.branch || selectedOption.getAttribute('data-branch') || 'ไม่ระบุสาขา';
    
          // Fill in the information with null checks
          const codeEl = document.getElementById('selectedEmpCode');
          const nameEl = document.getElementById('selectedEmpName');
          const positionEl = document.getElementById('selectedPosition');
          const departmentEl = document.getElementById('selectedDepartment');
          const branchEl = document.getElementById('selectedBranch');
    
          if (codeEl) codeEl.textContent = empCode;
          if (nameEl) nameEl.textContent = empName;
          if (positionEl) positionEl.textContent = position;
          if (departmentEl) departmentEl.textContent = department;
          if (branchEl) branchEl.textContent = branch;
    
          // Fill hidden inputs with null checks
          const empCodeInput = document.getElementById('empCode');
          const empNameInput = document.getElementById('empName');
          const positionInput = document.getElementById('position');
          const departmentInput = document.getElementById('department');
          const branchInput = document.getElementById('branch');
    
          if (empCodeInput) empCodeInput.value = empCode === 'ไม่มีรหัส' ? '' : empCode;
          if (empNameInput) empNameInput.value = empName === 'ไม่ระบุชื่อ' ? '' : empName;
          if (positionInput) positionInput.value = position === 'ไม่ระบุตำแหน่ง' ? '' : position;
          if (departmentInput) departmentInput.value = department === 'ไม่ระบุแผนก' ? '' : department;
          if (branchInput) branchInput.value = branch === 'ไม่ระบุสาขา' ? '' : branch;
    
          console.log('Employee data filled:', {
            code: empCode,
            name: empName,
            position: position,
            department: department,
            branch: branch
          });
    
        } else {
          // Hide employee info
          selectedEmployeeInfo.classList.add('hidden');
    
          // Clear all data
          ['selectedEmpCode', 'selectedEmpName', 'selectedPosition', 'selectedDepartment', 'selectedBranch']
            .forEach(id => {
              const el = document.getElementById(id);
              if (el) el.textContent = '';
            });
    
          // Clear hidden inputs
          ['empCode', 'empName', 'position', 'department', 'branch']
            .forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = '';
            });
        }
      });
    }

    // Load realtime commissions
    async function loadRealtimeCommissions() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/commission/realtime`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            displayCommissionLeaderboard(result.data);
            displayCommissionTable(result.data);
            updateCommissionStatistics(result.data);
          }
        }
      } catch (error) {
        console.error('Error loading realtime commissions:', error);
      }
    }

    // Display commission leaderboard
    function displayCommissionLeaderboard(data) {
      const leaderboard = document.getElementById('commissionLeaderboard');
      if (!leaderboard) return;
    
      leaderboard.innerHTML = '';
    
      // Sort by commission amount and take top 5
      const topEmployees = data.slice(0, 5);
    
      topEmployees.forEach((emp, index) => {
        const rankBadge = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
    
        leaderboard.innerHTML += `
          <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg hover:bg-base-300 transition">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${rankBadge}</span>
              <div>
                <div class="font-medium">${emp.employeeName || 'ไม่ระบุ'}</div>
                <div class="text-sm text-gray-500">${emp.employeeId?.position || 'พนักงานขาย'}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-primary">${formatCurrency(emp.totalCommission || 0)}</div>
              <div class="text-xs text-gray-500">ยอดขาย ${formatCurrency(emp.totalSales || 0)}</div>
            </div>
          </div>
        `;
      });
    
      if (topEmployees.length === 0) {
        leaderboard.innerHTML = '<div class="text-center text-gray-500 py-4">ยังไม่มีข้อมูลค่าคอมมิชชั่น</div>';
      }
    }

    // Display commission table
    function displayCommissionTable(data) {
      const tableBody = document.getElementById('commissionTableBody');
      if (!tableBody) return;
    
      tableBody.innerHTML = '';
      const memoSettings = getMemoCommissionSettings();
    
      data.forEach((commission, index) => {
        const sales = commission.sales || [];
    
        sales.forEach((sale, saleIndex) => {
          // Calculate commissions based on MEMO
          const baseCommission = sale.saleType === 'cash' ? memoSettings.baseCashCommission : 0;
          const activityCommission = calculateActivityCommission(sale.activities || {});
          const totalCommission = calculateCommissionWithRounding(baseCommission + activityCommission);
    
          // Build activity icons
          let activityIcons = '';
          if (sale.activities) {
            if (sale.activities.interview) activityIcons += '<i class="bi bi-mic text-blue-500" title="สัมภาษณ์"></i>';
            if (sale.activities.boomerang) activityIcons += '<i class="bi bi-camera text-purple-500" title="Boomerang"></i>';
            if (sale.activities.googleReview) activityIcons += '<i class="bi bi-star text-yellow-500" title="Google Review"></i>';
            if (sale.activities.video) activityIcons += '<i class="bi bi-play-circle text-red-500" title="วิดีโอ"></i>';
          }
          if (!activityIcons) activityIcons = '<span class="text-gray-400">-</span>';
    
          const statusBadge = getCommissionStatusBadge(sale.status);
    
          tableBody.innerHTML += `
            <tr>
              <td>${index + 1}.${saleIndex + 1}</td>
              <td>${commission.employeeName || 'ไม่ระบุ'}</td>
              <td>
                <span class="badge badge-outline">
                  ${getSaleTypeLabel(sale.saleType)}
                </span>
              </td>
              <td class="text-right">${formatCurrency(sale.saleAmount || 0)}</td>
              <td class="text-center">
                <div class="flex justify-center gap-1">
                  ${activityIcons}
                </div>
              </td>
              <td class="text-right">${formatCurrency(baseCommission)}</td>
              <td class="text-right">${formatCurrency(activityCommission)}</td>
              <td class="text-right font-medium text-primary">
                ${formatCurrency(totalCommission)}
              </td>
              <td>${statusBadge}</td>
              <td class="text-center">
                <div class="dropdown dropdown-end">
                  <label tabindex="0" class="btn btn-ghost btn-sm btn-circle">
                    <i class="bi bi-three-dots-vertical"></i>
                  </label>
                  <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a onclick="viewCommissionDetail('${commission._id}', '${sale._id}')">
                      <i class="bi bi-eye"></i> ดูรายละเอียด
                    </a></li>
                    <li><a onclick="openActivityModal()">
                      <i class="bi bi-activity"></i> เพิ่มกิจกรรม
                    </a></li>
                    ${sale.status === 'pending' ? `
                      <li><a onclick="approveCommissionItem('${commission._id}', '${sale._id}')">
                        <i class="bi bi-check-circle text-success"></i> อนุมัติ
                      </a></li>
                    ` : ''}
                    ${sale.status === 'approved' ? `
                      <li><a onclick="payCommissionItem('${commission._id}', '${sale._id}')">
                        <i class="bi bi-cash text-primary"></i> จ่ายเงิน
                      </a></li>
                    ` : ''}
                  </ul>
                </div>
              </td>
            </tr>
          `;
        });
      });
    
      if (data.length === 0 || data.every(c => !c.sales || c.sales.length === 0)) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-8 text-gray-500">
              <i class="bi bi-inbox text-4xl mb-2 block"></i>
              ยังไม่มีข้อมูลค่าคอมมิชชั่น
            </td>
          </tr>
        `;
      }
    }

    // Update commission statistics
    function updateCommissionStatistics(data) {
      let totalSales = 0;
      let totalCommission = 0;
    
      // Calculate totals from sales data
      if (Array.isArray(data)) {
        data.forEach(commission => {
          if (commission.sales) {
            commission.sales.forEach(sale => {
              totalSales += sale.saleAmount || 0;
              // Calculate commission based on MEMO rules
              const baseCommission = sale.saleType === 'cash' ? 10 : 0;
              const activityCommission = calculateActivityCommission(sale.activities || {});
              totalCommission += calculateCommissionWithRounding(baseCommission + activityCommission);
            });
          } else if (commission.totalSales) {
            totalSales += commission.totalSales || 0;
            totalCommission += commission.totalCommission || 0;
          }
        });
      }
    
      const percentage = totalSales > 0 ? ((totalCommission / totalSales) * 100).toFixed(2) : 0;
    
      const salesElement = document.getElementById('totalSalesAmount');
      const commissionElement = document.getElementById('totalCommissionAmount');
      const percentageElement = document.getElementById('commissionPercentage');
    
      if (salesElement) salesElement.textContent = formatCurrency(totalSales);
      if (commissionElement) commissionElement.textContent = formatCurrency(totalCommission);
      if (percentageElement) percentageElement.textContent = `${percentage}% จากยอดขาย`;
    }

    // Get sale type label
    function getSaleTypeLabel(type) {
      const labels = {
        'cash': 'ขายสด',
        'installment': 'ขายผ่อน',
        'deposit': 'มัดจำ'
      };
      return labels[type] || type;
    }

    // Get commission status badge
    function getCommissionStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-warning">รออนุมัติ</span>',
        'approved': '<span class="badge badge-info">อนุมัติแล้ว</span>',
        'paid': '<span class="badge badge-success">จ่ายแล้ว</span>',
        'cancelled': '<span class="badge badge-error">ยกเลิก</span>'
      };
      return badges[status] || '<span class="badge">' + status + '</span>';
    }

    // Load commission history
    async function loadCommissionHistory() {
      try {
        const month = document.getElementById('commissionMonth').value;
        const year = document.getElementById('commissionYear').value;
    
        let url = `${API_BASE_URL}/api/commission/history?`;
        if (month) url += `month=${month}&`;
        if (year) url += `year=${year}&`;
    
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            displayCommissionHistory(result.data);
          }
        }
      } catch (error) {
        console.error('Error loading commission history:', error);
      }
    }

    // Display commission history
    function displayCommissionHistory(data) {
      const tableBody = document.getElementById('commissionHistoryTableBody');
      if (!tableBody) return;
    
      tableBody.innerHTML = '';
    
      data.forEach(commission => {
        const statusBadge = getCommissionStatusBadge(commission.status);
    
        tableBody.innerHTML += `
          <tr>
            <td>${commission.periodDisplay || `${commission.period.month}/${commission.period.year}`}</td>
            <td>${commission.employeeName || 'ไม่ระบุ'}</td>
            <td class="text-right">${formatCurrency(commission.totalSales || 0)}</td>
            <td class="text-right font-medium">${formatCurrency(commission.totalCommission || 0)}</td>
            <td class="text-right text-success">${formatCurrency(commission.paidCommission || 0)}</td>
            <td class="text-right text-warning">${formatCurrency(commission.pendingCommission || 0)}</td>
            <td>${statusBadge}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-ghost" onclick="viewCommissionDetail('${commission._id}')">
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
        `;
      });
    
      if (data.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500">
              <i class="bi bi-inbox text-4xl mb-2 block"></i>
              ไม่พบประวัติค่าคอมมิชชั่น
            </td>
          </tr>
        `;
      }
    }

    // Calculate all commissions
    async function calculateAllCommissions() {
      try {
        showToast('กำลังคำนวณค่าคอมมิชชั่น...', 'info');
    
        // Get sales data from installment and cash sales
        const salesData = await fetchSalesDataForCommission();
    
        if (salesData.length === 0) {
          showToast('ไม่พบข้อมูลการขายในเดือนนี้', 'warning');
          return;
        }
    
        // Process each sale with MEMO-based calculation
        const memoSettings = getMemoCommissionSettings();
        for (const sale of salesData) {
          // Calculate base commission
          let commission = 0;
    
          // Base cash commission (10 baht per bill)
          if (sale.type === 'cash') {
            commission = memoSettings.baseCashCommission;
          }
    
          // Add activity commissions if any
          if (sale.activities) {
            commission += calculateActivityCommission(sale.activities);
          }
    
          // Apply rounding rule from MEMO
          commission = calculateCommissionWithRounding(commission);
    
          // Save commission
          sale.commission = commission;
          await addSaleCommission(sale);
        }
    
        showToast('คำนวณค่าคอมมิชชั่นเสร็จสิ้น', 'success');
        loadRealtimeCommissions();
    
      } catch (error) {
        console.error('Error calculating commissions:', error);
        showToast('เกิดข้อผิดพลาดในการคำนวณค่าคอมมิชชั่น', 'error');
      }
    }

    // Calculate commission with rounding rule from memo
    function calculateCommissionWithRounding(amount) {
      // Round up if decimal > 0.50 baht
      const decimal = amount - Math.floor(amount);
      if (decimal > 0.50) {
        return Math.ceil(amount);
      }
      return Math.floor(amount);
    }

    // Calculate base cash commission
    function calculateCashCommission(numberOfBills) {
      const memoSettings = getMemoCommissionSettings();
      return numberOfBills * memoSettings.baseCashCommission;
    }

    // Calculate activity commission
    function calculateActivityCommission(activities) {
      const memoSettings = getMemoCommissionSettings();
      let total = 0;
      if (activities.interview) total += memoSettings.activities.interview;
      if (activities.boomerang) total += memoSettings.activities.boomerang;
      if (activities.googleReview) total += memoSettings.activities.googleReview;
      if (activities.video) total += memoSettings.activities.video;
      return total;
    }

    // Get commission settings from memo configuration
    function getMemoCommissionSettings() {
      return {
        memoNumber: document.getElementById('memoNumber')?.value || '2PN Memo. 2025-005',
        effectiveDate: document.getElementById('effectiveDate')?.value || '2025-08-01',
        baseCashCommission: Number(document.getElementById('baseCashCommission')?.value) || 10,
        activities: {
          interview: Number(document.getElementById('interviewFee')?.value) || 10,
          boomerang: Number(document.getElementById('boomerangFee')?.value) || 10,
          googleReview: Number(document.getElementById('googleReviewFee')?.value) || 10,
          video: Number(document.getElementById('videoFee')?.value) || 20
        },
        notes: document.getElementById('memoNotes')?.value || ''
      };
    }

    // Fetch sales data for commission calculation
    async function fetchSalesDataForCommission() {
      const salesData = [];
    
      try {
        // Get current month and year for filtering
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
    
        // 1. Fetch installment contracts
        const installmentData = localStorage.getItem('contracts');
        if (installmentData) {
          const contracts = JSON.parse(installmentData);
          contracts.forEach(contract => {
            const contractDate = new Date(contract.contractDate || contract.date || contract.createdAt);
            if (contractDate.getMonth() === currentMonth && contractDate.getFullYear() === currentYear) {
              salesData.push({
                employeeId: contract.staffId || contract.userId,
                employeeName: contract.staffName || contract.salesperson || localStorage.getItem('userName'),
                saleType: 'installment',
                saleAmount: contract.totalPrice || contract.totalAmount || contract.grandTotal,
                saleDate: contractDate,
                customerName: contract.customerName,
                productDetails: contract.productName || contract.items?.map(i => i.name).join(', '),
                saleId: contract.id || contract.contractNumber,
                billNumber: contract.contractNumber,
                activities: contract.activities || {},
                branchCode: contract.branchCode || 'PATTANI'
              });
            }
          });
        }
    
        // 2. Fetch cash sales orders
        const salesOrders = localStorage.getItem('salesOrders');
        if (salesOrders) {
          const orders = JSON.parse(salesOrders);
          orders.forEach(order => {
            const orderDate = new Date(order.date || order.createdAt);
            if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
              salesData.push({
                employeeId: order.staffId || order.userId,
                employeeName: order.salesperson || order.staffName || localStorage.getItem('userName'),
                saleType: order.paymentMethod === 'CASH' ? 'cash' : 'other',
                saleAmount: order.total || order.totalAmount,
                saleDate: orderDate,
                customerName: order.customerName,
                productDetails: order.items?.map(i => i.name).join(', '),
                saleId: order.id || order.orderId,
                billNumber: order.invoiceNumber || order.receiptNumber,
                activities: order.activities || {},
                branchCode: order.branchCode || 'PATTANI'
              });
            }
          });
        }
    
        // 3. Fetch POS transactions from frontstore_pattani
        const posTransactions = localStorage.getItem('pos_transactions');
        if (posTransactions) {
          const transactions = JSON.parse(posTransactions);
          transactions.forEach(transaction => {
            const transDate = new Date(transaction.timestamp || transaction.date || transaction.createdAt);
            if (transDate.getMonth() === currentMonth && transDate.getFullYear() === currentYear) {
              salesData.push({
                employeeId: transaction.staffId || localStorage.getItem('userId'),
                employeeName: transaction.staffName || localStorage.getItem('userName'),
                saleType: transaction.paymentMethod === 'CASH' ? 'cash' : 'other',
                saleAmount: transaction.total || transaction.totalAmount,
                saleDate: transDate,
                customerName: transaction.customerName || transaction.customerEmail,
                productDetails: transaction.items?.map(i => i.name || i.productName).join(', '),
                saleId: transaction.transactionId || transaction.id,
                billNumber: transaction.receiptNumber || transaction.invoiceNumber,
                activities: transaction.activities || {},
                branchCode: 'PATTANI'
              });
            }
          });
        }
    
        // 4. Check for any sales stored with employee-specific keys
        const userName = localStorage.getItem('userName');
        const userId = localStorage.getItem('userId');
        if (userName || userId) {
          const employeeSalesKey = `sales_${userId || userName}`;
          const employeeSales = localStorage.getItem(employeeSalesKey);
          if (employeeSales) {
            const empSales = JSON.parse(employeeSales);
            empSales.forEach(sale => {
              const saleDate = new Date(sale.date || sale.createdAt);
              if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                salesData.push({
                  employeeId: userId || sale.employeeId,
                  employeeName: userName || sale.employeeName,
                  saleType: sale.type || (sale.paymentMethod === 'CASH' ? 'cash' : 'other'),
                  saleAmount: sale.amount || sale.total,
                  saleDate: saleDate,
                  customerName: sale.customerName,
                  productDetails: sale.productDetails,
                  saleId: sale.id,
                  billNumber: sale.billNumber,
                  activities: sale.activities || {},
                  branchCode: sale.branchCode || 'PATTANI'
                });
              }
            });
          }
        }
    
      } catch (error) {
        console.error('Error fetching sales data:', error);
      }
    
      return salesData;
    }

    // Add sale commission
    async function addSaleCommission(saleData) {
      try {
        // Find employee by name
        const employees = await fetch(`${API_BASE_URL}/api/users?limit=0`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
    
        const empResult = await employees.json();
        const employee = empResult.data?.find(e => e.name === saleData.employeeName);
    
        if (!employee) {
          console.warn(`Employee not found: ${saleData.employeeName}`);
          return;
        }
    
        const response = await fetch(`${API_BASE_URL}/api/commission/add-sale`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            employeeId: employee._id,
            saleData: {
              ...saleData,
              saleDate: new Date(saleData.saleDate)
            }
          })
        });
    
        if (!response.ok) {
          throw new Error('Failed to add commission');
        }
    
      } catch (error) {
        console.error('Error adding sale commission:', error);
      }
    }

    // Open commission settings modal
    function openCommissionSettings() {
      document.getElementById('commissionSettingsModal').classList.add('modal-open');
      loadCommissionSettings();
    }

    // Close commission settings modal
    function closeCommissionSettings() {
      document.getElementById('commissionSettingsModal').classList.remove('modal-open');
    }

    // Switch commission settings tabs
    function switchCommissionTab(tab, element) {
      // Hide all tabs safely
      const tabIds = ['memoTab', 'activitiesTab', 'rulesTab', 'employeesTab'];
      tabIds.forEach(tabId => {
        const tabElement = document.getElementById(tabId);
        if (tabElement) {
          tabElement.classList.add('hidden');
        }
      });
    
      // Show selected tab
      const selectedTab = document.getElementById(tab + 'Tab');
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }
    
      // Update tab active states
      document.querySelectorAll('#commissionSettingsModal .tab').forEach(t => {
        t.classList.remove('tab-active');
      });
    
      // Add active class to clicked element
      if (element) {
        element.classList.add('tab-active');
      }
    }

    // Open activity tracking modal
    function openActivityModal() {
      document.getElementById('activityTrackingModal').classList.add('modal-open');
      loadSalesPersons();
    }

    // Close activity tracking modal
    function closeActivityModal() {
      document.getElementById('activityTrackingModal').classList.remove('modal-open');
      document.getElementById('activityForm').reset();
      updateActivityCommissionTotal();
    }

    // Load sales persons for activity tracking
    async function loadSalesPersons() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/users?role=sales&limit=0`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          const select = document.getElementById('salesPerson');
          select.innerHTML = '<option value="">เลือกพนักงาน</option>';
    
          if (result.data && Array.isArray(result.data)) {
            result.data.forEach(emp => {
              select.innerHTML += `<option value="${emp._id}">${emp.name}</option>`;
            });
          }
        }
      } catch (error) {
        console.error('Error loading sales persons:', error);
      }
    }

    // Update activity commission total
    function updateActivityCommissionTotal() {
      const memoSettings = getMemoCommissionSettings();
      let total = 0;
    
      if (document.getElementById('customerInterview').checked) total += memoSettings.activities.interview;
      if (document.getElementById('boomerangStory').checked) total += memoSettings.activities.boomerang;
      if (document.getElementById('googleMapReview').checked) total += memoSettings.activities.googleReview;
      if (document.getElementById('customerVideo').checked) total += memoSettings.activities.video;
    
      document.getElementById('activityCommissionTotal').textContent = total + ' บาท';
    }

    // Initialize activity tracking listeners
    function initializeActivityTracking() {
      const activityCheckboxes = ['customerInterview', 'boomerangStory', 'googleMapReview', 'customerVideo'];
      activityCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener('change', updateActivityCommissionTotal);
        }
      });
    
      // Activity form submission
      const activityForm = document.getElementById('activityForm');
      if (activityForm) {
        activityForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveActivityCommission();
        });
      }
    }

    // Save activity commission
    async function saveActivityCommission() {
      const billNumber = document.getElementById('billNumber').value;
      const salesPerson = document.getElementById('salesPerson').value;
      const activities = {
        interview: document.getElementById('customerInterview').checked,
        boomerang: document.getElementById('boomerangStory').checked,
        googleReview: document.getElementById('googleMapReview').checked,
        video: document.getElementById('customerVideo').checked,
        videoLink: document.getElementById('videoLink').value
      };
    
      const commission = calculateActivityCommission(activities);
      const finalCommission = calculateCommissionWithRounding(commission);
    
      const data = {
        billNumber,
        salesPerson,
        activities,
        totalCommission: finalCommission,
        date: new Date().toISOString()
      };
    
      try {
        const response = await fetch(`${API_BASE_URL}/api/commission/activity`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(data)
        });
    
        if (response.ok) {
          showToast('บันทึกกิจกรรมส่งเสริมเรียบร้อย', 'success');
          closeActivityModal();
          loadCommissionData();
        } else {
          showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
        }
      } catch (error) {
        console.error('Error saving activity commission:', error);
        showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
      }
    }

    // Load commission settings
    async function loadCommissionSettings() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/commission/settings/active`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            commissionSettings = result.data;
            displayCommissionSettings();
          }
        }
      } catch (error) {
        console.error('Error loading commission settings:', error);
      }
    }

    // Display commission settings
    function displayCommissionSettings() {
      const rulesList = document.getElementById('rulesList');
      if (!rulesList) return;
    
      rulesList.innerHTML = '';
    
      selectedRules.forEach((rule, index) => {
        rulesList.innerHTML += `
          <div class="card bg-base-100">
            <div class="card-body p-3">
              <div class="flex justify-between items-center">
                <div>
                  <span class="font-medium">${getSaleTypeLabel(rule.saleType)}</span>
                  <span class="text-sm text-gray-500 ml-2">
                    ${rule.ruleType === 'percentage' ? `${rule.percentageRate}%` :
                      rule.ruleType === 'fixed' ? `฿${rule.fixedAmount}` : 'ขั้นบันได'}
                  </span>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="removeRule(${index})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
    }

    // Add commission rule
    function addCommissionRule() {
      // Check for both possible element IDs
      const saleTypeElement = document.getElementById('productCategory') || document.getElementById('ruleSaleType');
      const ruleTypeElement = document.getElementById('ruleType');
      const percentageElement = document.getElementById('rulePercentage');
    
      if (!saleTypeElement || !ruleTypeElement || !percentageElement) {
        console.error('Rule form elements not found:', {
          saleType: !!saleTypeElement,
          ruleType: !!ruleTypeElement,
          percentage: !!percentageElement
        });
        showToast('เกิดข้อผิดพลาดในการเพิ่มกฎ', 'error');
        return;
      }
    
      const saleType = saleTypeElement.value;
      const ruleType = ruleTypeElement.value;
      const percentage = percentageElement.value;
    
      const rule = {
        saleType,
        ruleType,
        percentageRate: ruleType === 'percentage' ? parseFloat(percentage) : null,
        priority: selectedRules.length
      };
    
      selectedRules.push(rule);
      displayCommissionSettings();
      showToast('เพิ่มกฎการคำนวณเรียบร้อย', 'success');
    }

    // Remove rule
    function removeRule(index) {
      selectedRules.splice(index, 1);
      displayCommissionSettings();
    }

    // Save commission settings
    async function saveCommissionSettings() {
      try {
        const settingData = {
          name: document.getElementById('settingName').value,
          description: document.getElementById('settingDescription').value,
          isActive: document.getElementById('settingActive').checked,
          rules: selectedRules,
          applicableEmployees: selectedEmployees
        };
    
        const response = await fetch(`${API_BASE_URL}/api/commission/settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(settingData)
        });
    
        if (response.ok) {
          showToast('บันทึกการตั้งค่าเรียบร้อย', 'success');
          closeCommissionSettings();
        } else {
          throw new Error('Failed to save settings');
        }
      } catch (error) {
        console.error('Error saving commission settings:', error);
        showToast('ไม่สามารถบันทึกการตั้งค่าได้', 'error');
      }
    }

    // Setup commission socket for real-time updates
    function setupCommissionSocket() {
      if (!window.io) return;
    
      const socket = io(API_BASE_URL);
    
      socket.on('commissionUpdated', (data) => {
        if (commissionView === 'realtime') {
          loadRealtimeCommissions();
        }
      });
    
      socket.on('newSaleCommission', (data) => {
        showToast(`ค่าคอมมิชชั่นใหม่: ${data.employeeName} - ${formatCurrency(data.commissionAmount)}`, 'info');
        if (commissionView === 'realtime') {
          loadRealtimeCommissions();
        }
      });
    }

    // Toggle rule fields based on type
    function toggleRuleFields() {
      const ruleType = document.getElementById('ruleType').value;
      document.getElementById('percentageField').style.display = ruleType === 'percentage' ? 'block' : 'none';
    }

    // Tab switching for settings modal
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('#commissionSettingsModal .tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
    
          if (!tabName) return;
    
          // Update active tab
          tabs.forEach(t => t.classList.remove('tab-active'));
          tab.classList.add('tab-active');
    
          // Show/hide tab content safely
          const tabElements = [
            { id: 'memoTab', name: 'memo' },
            { id: 'activitiesTab', name: 'activities' },
            { id: 'rulesTab', name: 'rules' },
            { id: 'employeesTab', name: 'employees' },
            { id: 'basicTab', name: 'basic' }
          ];
    
          tabElements.forEach(({ id, name }) => {
            const element = document.getElementById(id);
            if (element) {
              element.classList.toggle('hidden', tabName !== name);
            }
          });
        });
      });
    });

    // ========== FILE UPLOAD FUNCTIONS ==========
    function initializeFileUpload() {
      const fileInput = document.getElementById('salaryDocument');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const fileError = document.getElementById('fileError');
    
      if (fileInput) {
        fileInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
    
          // Reset previous states
          fileInfo.classList.add('hidden');
          fileError.classList.add('hidden');
    
          if (file) {
            // Validate file type
            if (file.type !== 'application/pdf') {
              showFileError('กรุณาเลือกไฟล์ PDF เท่านั้น');
              fileInput.value = '';
              return;
            }
    
            // Validate file size (10MB = 10 * 1024 * 1024 bytes)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
              showFileError('ขนาดไฟล์ใหญ่เกินไป กรุณาเลือกไฟล์ขนาดไม่เกิน 10MB');
              fileInput.value = '';
              return;
            }
    
            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
    
            console.log('File selected:', file.name, 'Size:', formatFileSize(file.size));
          }
        });
      }
    }
    
    function showFileError(message) {
      const fileError = document.getElementById('fileError');
      if (fileError) {
        fileError.textContent = message;
        fileError.classList.remove('hidden');
      }
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function clearFileUpload() {
      const fileInput = document.getElementById('salaryDocument');
      const fileInfo = document.getElementById('fileInfo');
      const fileError = document.getElementById('fileError');
    
      if (fileInput) fileInput.value = '';
      if (fileInfo) fileInfo.classList.add('hidden');
      if (fileError) fileError.classList.add('hidden');
    }

    // ========== END FILE UPLOAD FUNCTIONS ==========

    // ========== END COMMISSION FUNCTIONS ==========

    window.addEventListener('resize', handleResponsiveness);

    // แสดงข้อมูลเมื่อโหลดหน้าเว็บ
    document.addEventListener('DOMContentLoaded', () => {
      // Check for authentication token - try different possible keys
      const existingToken = localStorage.getItem('token') ||
                           localStorage.getItem('authToken') ||
                           localStorage.getItem('accessToken');
    
      if (!existingToken) {
        console.warn('No authentication token found');
        // Don't set a fake token - let the API calls handle this properly
        showToast('กรุณาเข้าสู่ระบบเพื่อใช้งานเต็มรูปแบบ', 'warning');
      } else if (existingToken === 'development-token-12345') {
        console.warn('Using development token - some features may not work');
      }
    
      initializeTheme();
      handleResponsiveness();
      updateDateTime();
      setInterval(updateDateTime, 60000); // อัพเดทเวลาทุกๆ 1 นาที
    
      // Initialize activity tracking listeners
      initializeActivityTracking();
    
      // Initialize file upload functionality
      initializeFileUpload();

      // Initialize new payroll system
      initializeNewPayrollSystem();

      // Initialize bonus form (new)
      setTimeout(() => {
        initializeBonusForm();
      }, 100);

      // Load integrated HR data (employee + bonus data)
      fetchEmployeeData();
    
      // Initialize commission year select with current year
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('commissionYear');
      if (yearSelect) {
        yearSelect.value = currentYear.toString();
      }
    });

    // ========== BONUS DATA DISPLAY FUNCTIONS (from Bonusdetail.html) ==========

    // Format currency for display
    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount || 0);
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Get bonus type styling class
    function getTypeClass(type) {
      const classes = {
        'sales': 'bg-green-100 text-green-800',
        'commission': 'bg-blue-100 text-blue-800',
        'performance': 'bg-purple-100 text-purple-800',
        'annual': 'bg-orange-100 text-orange-800'
      };
      return classes[type] || 'bg-gray-100 text-gray-800';
    }

    // Get bonus type icon
    function getTypeIcon(type) {
      const icons = {
        'sales': 'bi bi-graph-up',
        'commission': 'bi bi-percent',
        'performance': 'bi bi-award',
        'annual': 'bi bi-calendar-check'
      };
      return icons[type] || 'bi bi-cash-coin';
    }

    // Get status styling class
    function getStatusClass(status) {
      const classes = {
        'paid': 'bg-green-100 text-green-800',
        'pending': 'bg-yellow-100 text-yellow-800',
        'cancelled': 'bg-red-100 text-red-800'
      };
      return classes[status] || 'bg-gray-100 text-gray-800';
    }

    // Get status icon
    function getStatusIcon(status) {
      const icons = {
        'paid': 'bi bi-check-circle',
        'pending': 'bi bi-clock',
        'cancelled': 'bi bi-x-circle'
      };
      return icons[status] || 'bi bi-question-circle';
    }

    // Get status text in Thai
    function getStatusText(status) {
      const texts = {
        'paid': 'จ่ายแล้ว',
        'pending': 'รอดำเนินการ',
        'cancelled': 'ยกเลิก'
      };
      return texts[status] || 'ไม่ทราบสถานะ';
    }

    // Update bonus summary in existing payroll tables
    function updateBonusSummary() {
      if (!hrData.bonuses || hrData.bonuses.length === 0) {
        console.log('No bonus data to display');
        return;
      }

      // Try to find an existing summary section or create one
      let summarySection = document.querySelector('.bonus-summary-section');
      if (!summarySection) {
        // Create bonus summary section if it doesn't exist
        summarySection = document.createElement('div');
        summarySection.className = 'bonus-summary-section mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200';
        summarySection.innerHTML = `
          <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="bi bi-cash-coin text-green-600 mr-2"></i>สรุปโบนัสและค่าตอบแทนพิเศษ
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg shadow-sm">
              <div class="text-sm text-gray-600">โบนัสทั้งหมด</div>
              <div id="totalBonusDisplay" class="text-2xl font-bold text-green-600">฿0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
              <div class="text-sm text-gray-600">โบนัสที่จ่ายแล้ว</div>
              <div id="paidBonusDisplay" class="text-2xl font-bold text-blue-600">฿0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
              <div class="text-sm text-gray-600">รายการทั้งหมด</div>
              <div id="bonusCountDisplay" class="text-2xl font-bold text-purple-600">0 รายการ</div>
            </div>
          </div>
          <div class="mt-4">
            <button onclick="showBonusDetails()" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-list-ul mr-1"></i>ดูรายละเอียดโบนัส
            </button>
          </div>
        `;

        // Insert after the main content header
        const mainContent = document.querySelector('#mainContent .container-xxl');
        if (mainContent && mainContent.children.length > 0) {
          mainContent.insertBefore(summarySection, mainContent.children[1]);
        }
      }

      // Update the values
      document.getElementById('totalBonusDisplay').textContent = formatCurrency(hrData.totalBonusAmount);
      document.getElementById('paidBonusDisplay').textContent = formatCurrency(hrData.paidBonusAmount);
      document.getElementById('bonusCountDisplay').textContent = `${hrData.bonuses.length} รายการ`;

      console.log('Bonus summary updated');
    }

    // Show detailed bonus information
    function showBonusDetails() {
      if (!hrData.bonuses || hrData.bonuses.length === 0) {
        showToast('ไม่มีข้อมูลโบนัสให้แสดง', 'warning');
        return;
      }

      const modalContent = `
        <div class="modal fade" id="bonusDetailsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-cash-coin text-green-600 mr-2"></i>รายละเอียดโบนัสและค่าตอบแทนพิเศษ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>วันที่</th>
                        <th>ประเภท</th>
                        <th>รายละเอียด</th>
                        <th class="text-end">จำนวนเงิน</th>
                        <th class="text-center">สถานะ</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${hrData.bonuses.map(bonus => `
                        <tr>
                          <td>${formatDate(bonus.date)}</td>
                          <td>
                            <span class="badge ${getTypeClass(bonus.type)}">
                              <i class="${getTypeIcon(bonus.type)} me-1"></i>
                              ${bonus.typeName}
                            </span>
                          </td>
                          <td>${bonus.description}</td>
                          <td class="text-end fw-bold">${formatCurrency(bonus.amount)}</td>
                          <td class="text-center">
                            <span class="badge ${getStatusClass(bonus.status)}">
                              <i class="${getStatusIcon(bonus.status)} me-1"></i>
                              ${getStatusText(bonus.status)}
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('bonusDetailsModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalContent);

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('bonusDetailsModal'));
      modal.show();
    }

    // Update bonus summary when HR data is loaded
    if (typeof window !== 'undefined') {
      window.addEventListener('load', () => {
        // Wait a bit for data to load, then update bonus summary
        setTimeout(() => {
          if (hrData.bonuses && hrData.bonuses.length > 0) {
            updateBonusSummary();
          }
        }, 2000);
      });
    }

    // =============== BONUS FUNCTIONALITY ===============

    // Bonus data variables
    let currentBonusData = [];
    let filteredBonusData = [];


    // Load bonus data from API - User-specific only
    async function loadBonusData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No user ID available for loading bonus data');
          currentBonusData = [];
          filterBonusData();
          updateBonusSummary();
          return;
        }

        console.log('Loading personal bonus data for user:', currentUser.userId);

        // Prioritize user-specific HR bonus API first
        let response = await fetch(`${API_BASE_URL}/api/hr/bonus?userId=${currentUser.userId}`, {
          method: 'GET',
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const result = await response.json();
          currentBonusData = result.data || result || [];
          console.log('Personal bonus data loaded from HR API:', currentBonusData.length, 'records');
        } else {
          // Try main bonuses API as fallback and filter by user
          response = await fetch(`${API_BASE_URL}/api/bonuses`, {
            method: 'GET',
            headers: getAuthHeaders()
          });

          if (response.ok) {
            const data = await response.json();
            let allBonuses = data.bonuses || data.data || data || [];

            // Filter to only current user's bonuses
            currentBonusData = allBonuses.filter(bonus =>
              bonus.userId === currentUser.userId ||
              bonus.employeeId === currentUser.userId ||
              bonus.employeeId === currentUser.employeeId
            );
            console.log('Personal bonus data filtered from main API:', currentBonusData.length, 'out of', allBonuses.length, 'total records');
          } else {
            throw new Error('All bonus APIs failed');
          }
        }

      // Apply current filters
      filterBonusData();

      // Update summary cards
      updateBonusSummary();

      console.log('Bonus data loaded successfully');
    
      } catch (error) {
        console.error('Error loading bonus data:', error);
        currentBonusData = [];
        filterBonusData();
        updateBonusSummary();
        showToast('ไม่สามารถโหลดข้อมูลโบนัสได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
      }
    }

    // Filter bonus data
    function filterBonusData() {
      const periodFilter = document.getElementById('bonusPeriodFilter').value;
      const typeFilter = document.getElementById('bonusTypeFilter').value;

      let filtered = [...currentBonusData];

      // Apply period filter
      if (periodFilter !== 'all') {
        const now = new Date();
        filtered = filtered.filter(item => {
          const itemDate = new Date(item.date);

          switch (periodFilter) {
            case 'thisMonth':
              return itemDate.getMonth() === now.getMonth() &&
                     itemDate.getFullYear() === now.getFullYear();
            case 'lastMonth':
              const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
              return itemDate.getMonth() === lastMonth.getMonth() &&
                     itemDate.getFullYear() === lastMonth.getFullYear();
            case 'thisYear':
              return itemDate.getFullYear() === now.getFullYear();
            default:
              return true;
          }
        });
      }

      // Apply type filter
      if (typeFilter !== 'all') {
        filtered = filtered.filter(item => item.type === typeFilter);
      }

      filteredBonusData = filtered;
      renderBonusTable();
    }

    // Update bonus summary cards
    function updateBonusSummary() {
      const totalAmount = currentBonusData.reduce((sum, item) => sum + item.amount, 0);
      const thisMonthAmount = currentBonusData
        .filter(item => {
          const itemDate = new Date(item.date);
          const now = new Date();
          return itemDate.getMonth() === now.getMonth() &&
                 itemDate.getFullYear() === now.getFullYear();
        })
        .reduce((sum, item) => sum + item.amount, 0);

      document.getElementById('totalBonusAmount').textContent = `฿${totalAmount.toLocaleString()}`;
      document.getElementById('thisMonthBonusAmount').textContent = `฿${thisMonthAmount.toLocaleString()}`;
      document.getElementById('bonusCount').textContent = currentBonusData.length;
    }

    // Render bonus table
    function renderBonusTable() {
      const tbody = document.getElementById('bonusTableBody');
      const emptyState = document.getElementById('bonusEmptyState');

      if (filteredBonusData.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      tbody.innerHTML = filteredBonusData.map(bonus => {
        const statusClass = getStatusClass(bonus.status);
        const statusText = getStatusText(bonus.status);
        const formattedDate = new Date(bonus.date).toLocaleDateString('th-TH');

        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="text-sm">${formattedDate}</td>
            <td>
              <div class="badge badge-outline ${getTypeColor(bonus.type)}">${bonus.typeName}</div>
            </td>
            <td class="text-sm max-w-xs truncate" title="${bonus.description}">${bonus.description}</td>
            <td class="font-semibold text-green-600">฿${bonus.amount.toLocaleString()}</td>
            <td>
              <span class="badge ${statusClass}">${statusText}</span>
            </td>
            <td>
              <div class="flex gap-1">
                <button onclick="viewBonusDetails(${bonus.id})" class="btn btn-ghost btn-xs" title="ดูรายละเอียด">
                  <i class="bi bi-eye"></i>
                </button>
                <button onclick="editBonus(${bonus.id})" class="btn btn-ghost btn-xs" title="แก้ไข">
                  <i class="bi bi-pencil"></i>
                </button>
                <button onclick="deleteBonus(${bonus.id})" class="btn btn-ghost btn-xs text-red-500" title="ลบ">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Helper functions
    function getStatusClass(status) {
      switch (status) {
        case 'paid': return 'badge-success';
        case 'approved': return 'badge-info';
        case 'pending': return 'badge-warning';
        default: return 'badge-ghost';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'paid': return 'จ่ายแล้ว';
        case 'approved': return 'อนุมัติแล้ว';
        case 'pending': return 'รออนุมัติ';
        default: return status;
      }
    }

    function getTypeColor(type) {
      switch (type) {
        case 'sales': return 'badge-primary';
        case 'performance': return 'badge-secondary';
        case 'holiday': return 'badge-accent';
        case 'special': return 'badge-warning';
        default: return 'badge-ghost';
      }
    }

    // Bonus management functions
    function showAddBonusModal() {
      const modal = document.getElementById('bonusModal');
      if (modal) {
        // Reset form
        const form = document.getElementById('bonusForm');
        if (form) form.reset();

        const titleEl = document.getElementById('bonusModalTitle');
        if (titleEl) titleEl.textContent = 'เพิ่มโบนัส';

        const submitTextEl = document.getElementById('bonusSubmitText');
        if (submitTextEl) submitTextEl.textContent = 'บันทึกโบนัส';

        // Show modal
        modal.classList.remove('hidden');

        // Set default date to today
        const dateEl = document.getElementById('bonusDate');
        if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];

        // Hide sales bonus section
        const salesSection = document.getElementById('salesBonusSection');
        if (salesSection) salesSection.classList.add('hidden');

        // Load employees into select
        loadEmployeesForBonus();

        // Show modal
        modal.classList.remove('hidden');
      }
    }

    function viewBonusDetails(bonusId) {
      const bonus = currentBonusData.find(b => b.id === bonusId);
      if (bonus) {
        showToast(`รายละเอียด: ${bonus.description} - จำนวน ฿${bonus.amount.toLocaleString()}`, 'info');
      }
    }

    function editBonus(bonusId) {
      showToast('ฟีเจอร์แก้ไขโบนัสจะเปิดใช้งานเร็วๆ นี้', 'info');
    }

    function deleteBonus(bonusId) {
      if (confirm('คุณต้องการลบรายการโบนัสนี้หรือไม่?')) {
        currentBonusData = currentBonusData.filter(b => b.id !== bonusId);
        filterBonusData();
        updateBonusSummary();
        showToast('ลบรายการโบนัสเรียบร้อยแล้ว', 'success');
      }
    }

    function exportBonusData() {
      const dataStr = JSON.stringify(filteredBonusData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'bonus_data.json';
      link.click();
      URL.revokeObjectURL(url);
      showToast('ส่งออกข้อมูลโบนัสเรียบร้อยแล้ว', 'success');
    }

    // ========== NEW PAYROLL SYSTEM FUNCTIONS ==========

    // Initialize current period on page load
    function initializeCurrentPeriod() {
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();
    
      // Set dropdowns to current period
      document.getElementById('payrollMonth').value = month.toString();
      document.getElementById('payrollYear').value = year.toString();
    
      // Update global variables
      currentPayrollMonth = month;
      currentPayrollYear = year;
    
      // Update display
      updatePeriodDisplay();
    }

    // Update period display
    function updatePeriodDisplay() {
      const monthNames = ['', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม',
                         'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      const buddhist = currentPayrollYear + 543;
      const display = `${monthNames[currentPayrollMonth]} ${buddhist}`;
    
      document.getElementById('currentPeriodDisplay').textContent = display;
    
      // Update monthly modal displays too
      const monthlyElement = document.getElementById('monthlyCurrentPeriod');
      if (monthlyElement) monthlyElement.textContent = display;
    }

    // Load payroll data by selected period
    function loadPayrollByPeriod() {
      const month = parseInt(document.getElementById('payrollMonth').value);
      const year = parseInt(document.getElementById('payrollYear').value);
    
      currentPayrollMonth = month;
      currentPayrollYear = year;
    
      updatePeriodDisplay();
    
      // Load data
      loadBasicEmployees().then(() => {
        loadMonthlyPayrolls(month, year);
      });
    }

    // Load basic employees from API
    async function loadBasicEmployees() {
      try {
        // Initialize if not exist
        if (!window.basicEmployees) window.basicEmployees = [];
    
        showToast('กำลังโหลดข้อมูลพนักงาน...', 'info');
    
        // Try to load from basic-employees endpoint first
        let response = await fetch(`${API_BASE_URL}/api/basic-employees`, {
          headers: getAuthHeaders()
        });
    
        if (response.ok) {
          const result = await response.json();
          basicEmployees = result.data || result || [];
          console.log('Basic employees loaded from API:', basicEmployees.length);
    
          // Debug: Log sample basic employee
          if (basicEmployees.length > 0) {
            console.log('📋 Sample basic employee from API:', basicEmployees[0]);
          }
        } else {
          // Fallback to users endpoint
          console.warn('Basic employees API not found, trying users API...');
          response = await fetch(`${API_BASE_URL}/api/users?limit=0`, {
            headers: getAuthHeaders()
          });
    
          if (response.ok) {
            const result = await response.json();
            const users = result.data || result.users || result || [];
    
            // Debug: Log sample user data structure
            if (users.length > 0) {
              console.log('📋 Sample user from API:', users[0]);
            }
    
            // Transform users data to basic employee structure
            basicEmployees = await transformUsersToBasicEmployees(users);
            console.log('Users transformed to basic employees:', basicEmployees.length);
    
            // Debug: Log sample transformed data
            if (basicEmployees.length > 0) {
              console.log('📋 Sample transformed employee:', basicEmployees[0]);
            }
          } else {
            throw new Error('Both APIs not available');
          }
        }
    
        // Ensure monthlyPayrolls is initialized before rendering
        if (!window.monthlyPayrolls) window.monthlyPayrolls = [];
    
        renderNewEmployeeTable();
        showToast('โหลดข้อมูลสำเร็จ', 'success');
    
      } catch (error) {
        console.error('Error loading basic employees:', error);
        basicEmployees = [];
        // Ensure monthlyPayrolls is initialized before rendering
        if (!window.monthlyPayrolls) window.monthlyPayrolls = [];
        renderNewEmployeeTable();
        showToast('ไม่สามารถโหลดข้อมูลพนักงานได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
      }
    }

    // Load monthly payrolls for specific period
    async function loadMonthlyPayrolls(month, year) {
      try {
        // Initialize if not exist
        if (!window.monthlyPayrolls) window.monthlyPayrolls = [];
    
        const response = await fetch(`${API_BASE_URL}/api/monthly-payrolls?month=${month}&year=${year}`, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
    
        console.log('📋 Monthly payrolls API response status:', response.status);
    
        if (response.ok) {
          const result = await response.json();
          monthlyPayrolls = result.data || result || [];
          console.log('✅ Monthly payrolls loaded:', monthlyPayrolls.length);
    
          // Debug: log sample payroll
          if (monthlyPayrolls.length > 0) {
            console.log('📋 Sample monthly payroll:', monthlyPayrolls[0]);
          }
        } else {
          console.warn('Monthly payrolls API not available');
          monthlyPayrolls = [];
        }
    
        // Re-render table to show updated status
        renderNewEmployeeTable();
    
      } catch (error) {
        console.error('Error loading monthly payrolls:', error);
        monthlyPayrolls = [];
      }
    }

    // Transform users data to basic employee structure
    async function transformUsersToBasicEmployees(users) {
      if (!users || !Array.isArray(users)) return [];
    
      return users.map((user, index) => {
        // Handle name extraction with multiple fallback options
        let name = '';
    
        // Try different name formats from API
        if (user.employee && user.employee.name && user.employee.name.trim()) {
          name = user.employee.name.trim();
        } else if (user.name && user.name.trim()) {
          name = user.name.trim();
        } else if (user.fullName && user.fullName.trim()) {
          name = user.fullName.trim();
        } else if (user.firstName || user.lastName) {
          const firstName = (user.firstName || '').trim();
          const lastName = (user.lastName || '').trim();
          name = `${firstName} ${lastName}`.trim();
        } else if (user.username && user.username.trim()) {
          name = user.username.trim();
        }
    
        // Final check - if still empty, use fallback
        if (!name || name === '') {
          name = `User ${user._id || user.id || index + 1}`;
        }
    
        // Handle employee code
        let code = '';
        if (user.employee && user.employee.employeeId) {
          code = user.employee.employeeId;
        } else if (user.emp_code) {
          code = user.emp_code;
        } else if (user.employeeId) {
          code = user.employeeId;
        } else if (user.code) {
          code = user.code;
        } else {
          code = `EMP${String(index + 1).padStart(3, '0')}`;
        }
    
        // Handle position
        let position = '';
        if (user.employee && user.employee.position) {
          position = user.employee.position;
        } else if (user.position) {
          position = user.position;
        } else if (user.role && typeof user.role === 'string') {
          position = user.role;
        } else if (user.role && user.role.name) {
          position = user.role.name;
        } else if (user.job_title) {
          position = user.job_title;
        } else {
          position = 'พนักงาน';
        }
    
        // Handle department
        let department = '';
        if (user.employee && user.employee.department) {
          department = user.employee.department;
        } else if (user.department) {
          department = user.department;
        } else if (user.dept) {
          department = user.dept;
        } else if (user.division) {
          department = user.division;
        } else {
          department = 'ไม่ระบุแผนก';
        }
    
        return {
          id: user._id || user.id || `emp_${index}`,
          employeeId: user._id || user.id,
          code: code,
          name: name,
          position: position,
          department: department,
          bankName: user.bankName || user.bank || '',
          accountNumber: user.accountNumber || user.account || '',
          baseSalary: user.baseSalary || user.salary || (user.employee && user.employee.salary) || 0,
          startDate: user.startDate || user.joinDate || user.createdAt || new Date().toISOString().split('T')[0],
          status: user.status || 'active'
        };
      });
    }

    // Render new employee table
    function renderNewEmployeeTable() {
      const tableBody = document.getElementById('salaryTableBody');
      if (!tableBody) return;
    
      // Ensure arrays are initialized
      if (!window.basicEmployees) window.basicEmployees = [];
      if (!window.monthlyPayrolls) window.monthlyPayrolls = [];
    
      tableBody.innerHTML = '';
    
      if (basicEmployees.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="bi bi-inbox text-4xl mb-2 block"></i>
              ยังไม่มีข้อมูลพนักงานพื้นฐาน
              <div class="mt-4">
                <button onclick="openBasicEmployeeModal()" class="btn btn-primary btn-sm">
                  <i class="bi bi-person-plus mr-1"></i>เพิ่มข้อมูลพนักงานแรก
                </button>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('employeeCount').textContent = 'พนักงานทั้งหมด: 0 คน';
        return;
      }
    
      // Apply filters
      let filteredEmployees = [...basicEmployees];
    
      if (currentFilter) {
        filteredEmployees = filteredEmployees.filter(emp => emp.department === currentFilter);
      }
    
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filteredEmployees = filteredEmployees.filter(emp =>
          emp.code.toLowerCase().includes(searchTerm) ||
          emp.name.toLowerCase().includes(searchTerm) ||
          emp.department.toLowerCase().includes(searchTerm)
        );
      }
    
      filteredEmployees.forEach((emp, index) => {
        // Check if employee has monthly payroll for current period
        // Note: monthlyPayrolls contains BasicEmployee._id, emp.employeeId is User._id
        const hasMonthlyPayroll = monthlyPayrolls && monthlyPayrolls.some(p => p.employeeId === emp.id);
        const statusIcon = hasMonthlyPayroll ?
          '<i class="bi bi-check-circle text-green-500"></i>' :
          '<i class="bi bi-clock text-yellow-500"></i>';
    
        const statusText = hasMonthlyPayroll ? 'อัปเดตแล้ว' : 'รอการอัปเดต';
        const statusClass = hasMonthlyPayroll ? 'badge-success' : 'badge-warning';
    
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-blue-50 dark:hover:bg-blue-900 dark:hover:bg-opacity-20 transition-colors';
    
        tr.innerHTML = `
          <td class="font-mono">${emp.code}</td>
          <td>
            <div class="flex items-center space-x-3">
              <div class="avatar placeholder">
                <div class="bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 w-8 mask mask-squircle">
                  <span>${emp.name.charAt(0)}</span>
                </div>
              </div>
              <div>
                <div class="font-medium">${emp.name}</div>
                <div class="text-sm text-gray-500">${emp.code}</div>
              </div>
            </div>
          </td>
          <td>
            <div class="badge ${getBadgeColorForDepartment(emp.department)}">${emp.department}</div>
          </td>
          <td>
            <div class="text-sm">${emp.bankName}</div>
            <div class="text-xs text-gray-500">${emp.accountNumber}</div>
          </td>
          <td class="text-right font-medium">${formatCurrency(emp.baseSalary)}</td>
          <td class="text-center">
            <div class="text-sm">${formatDate(emp.startDate)}</div>
          </td>
          <td class="text-center">
            <div class="badge ${statusClass} gap-2">
              ${statusIcon}
              ${statusText}
            </div>
          </td>
          <td class="text-center">
            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-sm btn-circle">
                <i class="bi bi-three-dots-vertical"></i>
              </label>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-64 z-50">
                <li><a onclick="editBasicEmployee(${emp.id})">
                  <i class="bi bi-pencil text-blue-500"></i>
                  แก้ไขข้อมูลพื้นฐาน
                </a></li>
                <li><a onclick="openMonthlySalaryUpdateModal(${emp.id})" class="text-green-600">
                  <i class="bi bi-cash-stack text-green-500"></i>
                  อัปเดตเงินเดือนรายเดือน
                </a></li>
                <li><a onclick="viewSalaryHistory(${emp.id})" class="text-purple-600">
                  <i class="bi bi-clock-history text-purple-500"></i>
                  ดูประวัติเงินเดือน
                </a></li>
                <li class="divider"></li>
                <li><a onclick="deleteBasicEmployee(${emp.id})" class="text-red-600">
                  <i class="bi bi-trash text-red-500"></i>
                  ลบข้อมูล
                </a></li>
              </ul>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    
      document.getElementById('employeeCount').textContent = `พนักงานทั้งหมด: ${filteredEmployees.length} คน`;
    }

    // ===== BASIC EMPLOYEE MODAL FUNCTIONS =====

    // Test basic employee API
    async function testBasicEmployeeAPI() {
      try {
        console.log('🧪 Testing basic employee API...');
        const response = await fetch(`${API_BASE_URL}/api/basic-employees/test`);
    
        if (response.ok) {
          const result = await response.json();
          console.log('🧪 Test result:', result);
          showToast('API Test: ' + result.message, 'success');
        } else {
          const errorResult = await response.json();
          console.log('🧪 Test failed with status:', response.status, errorResult);
          showToast('API Test Failed: ' + (errorResult.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('🧪 Test failed:', error);
        showToast('API Test Failed: ' + error.message, 'error');
      }
    }

    // Open basic employee modal
    function openBasicEmployeeModal() {
      const modal = document.getElementById('basicEmployeeModal');
      if (modal) {
        modal.classList.add('modal-open');
        resetBasicEmployeeForm();
        loadEmployeesForSelection();
    
        // Test API when opening modal
        testBasicEmployeeAPI();
      }
    }

    // Close basic employee modal
    function closeBasicEmployeeModal() {
      const modal = document.getElementById('basicEmployeeModal');
      if (modal) {
        modal.classList.remove('modal-open');
        resetBasicEmployeeForm();
      }
    }

    // Reset basic employee form
    function resetBasicEmployeeForm() {
      const form = document.getElementById('basicEmployeeForm');
      if (form) {
        form.reset();
        form.querySelectorAll('[id$="Error"]').forEach(el => el.classList.add('hidden'));
        form.querySelectorAll('input, select').forEach(el => el.classList.remove('border-red-500'));
      }
    }

    // Load employees for selection
    async function loadEmployeesForSelection() {
      const select = document.getElementById('selectEmployee');
      if (!select) return;
    
      try {
        // Get all users from main API (with no limit to get all employees)
        const response = await fetch(`${API_BASE_URL}/api/users?limit=0`, {
          headers: getAuthHeaders()
        });
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const result = await response.json();
        const employeeList = result.data || result.users || result || [];
    
        // Debug: Log pagination info if exists
        if (result.pagination) {
          console.log('📊 API Pagination Info:', result.pagination);
          if (result.pagination.total > employeeList.length) {
            console.warn(`⚠️ API returned ${employeeList.length} employees but total is ${result.pagination.total}`);
          }
        } else if (result.total) {
          console.log('📊 API Total Count:', result.total);
          if (result.total !== employeeList.length) {
            console.warn(`⚠️ API returned ${employeeList.length} employees but total count is ${result.total}`);
          }
        } else {
          console.log('📊 API returned unlimited results:', employeeList.length);
        }
    
        if (!Array.isArray(employeeList)) {
          throw new Error('Invalid data format from API');
        }
    
        console.log('📋 Raw API response sample (first 2 users):', employeeList.slice(0, 2));
        console.log('📊 Total employees from API:', employeeList.length);
        console.log('📊 Current basicEmployees:', basicEmployees.length);
    
        select.innerHTML = '<option value="">กรุณาเลือกพนักงาน</option>';
    
        // Filter out employees who already have basic info
        const availableEmployees = employeeList.filter(emp =>
          !basicEmployees.some(basic => basic.employeeId === (emp._id || emp.id))
        );
    
        console.log(`🔍 Filtered available employees: ${availableEmployees.length} out of ${employeeList.length} total`);
    
        if (availableEmployees.length === 0) {
          select.innerHTML += '<option value="" disabled>ไม่มีพนักงานที่ยังไม่ได้ตั้งค่าข้อมูลพื้นฐาน</option>';
          console.log('⚠️ No available employees after filtering');
          return;
        }
    
        availableEmployees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp._id || emp.id;
    
          // Extract name with multiple fallback options
          let displayName = '';
          if (emp.employee && emp.employee.name && emp.employee.name.trim()) {
            displayName = emp.employee.name.trim();
          } else if (emp.name && emp.name.trim()) {
            displayName = emp.name.trim();
          } else if (emp.fullName && emp.fullName.trim()) {
            displayName = emp.fullName.trim();
          } else if (emp.firstName || emp.lastName) {
            const firstName = (emp.firstName || '').trim();
            const lastName = (emp.lastName || '').trim();
            displayName = `${firstName} ${lastName}`.trim();
          } else if (emp.username && emp.username.trim()) {
            displayName = emp.username.trim();
          }
    
          // Final check - if still empty, use fallback
          if (!displayName || displayName === '') {
            displayName = `User ${emp._id || emp.id || 'Unknown'}`;
          }
    
          // Extract position
          let displayPosition = '';
          if (emp.employee && emp.employee.position) {
            displayPosition = emp.employee.position;
          } else if (emp.position) {
            displayPosition = emp.position;
          } else if (emp.role && typeof emp.role === 'string') {
            displayPosition = emp.role;
          } else if (emp.role && emp.role.name) {
            displayPosition = emp.role.name;
          } else {
            displayPosition = 'พนักงาน';
          }
    
          // Extract employee code
          let empCode = '';
          if (emp.employee && emp.employee.employeeId) {
            empCode = emp.employee.employeeId;
          } else if (emp.emp_code) {
            empCode = emp.emp_code;
          } else if (emp.employeeId) {
            empCode = emp.employeeId;
          } else if (emp.code) {
            empCode = emp.code;
          }
    
          option.textContent = `${displayName} - ${displayPosition}${empCode ? ` (${empCode})` : ''}`;
          option.dataset.name = displayName;
          option.dataset.code = empCode;
          option.dataset.position = displayPosition;
          select.appendChild(option);
    
          // Debug log for first few employees
          if (availableEmployees.indexOf(emp) < 3) {
            console.log(`Employee ${availableEmployees.indexOf(emp) + 1}:`, {
              original: emp,
              displayName,
              displayPosition,
              empCode
            });
          }
        });
    
        console.log(`✅ Loaded ${availableEmployees.length} available employees for selection`);
        console.log('📋 Available employees summary:', availableEmployees.map(emp => ({
          name: emp.name || emp.fullName || emp.username,
          position: emp.position || emp.role,
          hasEmployee: !!emp.employee
        })));
    
        // Show success message with count
        showToast(`โหลดพนักงาน ${availableEmployees.length} คนที่พร้อมตั้งค่าข้อมูลพื้นฐาน`, 'success');
    
      } catch (error) {
        console.error('Error loading employees for selection:', error);
    
        // Show specific error messages
        if (error.message.includes('403')) {
          select.innerHTML = '<option value="">ไม่มีสิทธิ์เข้าถึงข้อมูลพนักงาน</option>';
          showToast('ไม่มีสิทธิ์เข้าถึงข้อมูลพนักงาน กรุณาติดต่อผู้ดูแลระบบ', 'error');
        } else if (error.message.includes('401')) {
          select.innerHTML = '<option value="">กรุณาเข้าสู่ระบบใหม่</option>';
          showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
        } else {
          select.innerHTML = '<option value="">เกิดข้อผิดพลาดในการโหลดรายชื่อพนักงาน</option>';
          showToast('ไม่สามารถโหลดรายชื่อพนักงานได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error');
        }
      }
    }

    // Validate basic employee form
    function validateBasicEmployeeForm() {
      let isValid = true;
    
      const requiredFields = [
        { id: 'selectEmployee', errorId: 'selectEmployeeError' },
        { id: 'empDepartment', errorId: 'empDepartmentError' },
        { id: 'employeeBank', errorId: 'employeeBankError' },
        { id: 'bankAccount', errorId: 'bankAccountError' },
        { id: 'basicSalaryAmount', errorId: 'basicSalaryAmountError' },
        { id: 'startWorkDate', errorId: 'startWorkDateError' }
      ];
    
      requiredFields.forEach(({ id, errorId }) => {
        const field = document.getElementById(id);
        const errorEl = document.getElementById(errorId);
    
        if (!field?.value?.trim()) {
          isValid = false;
          if (errorEl) errorEl.classList.remove('hidden');
          if (field) field.classList.add('border-red-500');
        } else {
          if (errorEl) errorEl.classList.add('hidden');
          if (field) field.classList.remove('border-red-500');
        }
      });
    
      return isValid;
    }

    // Save basic employee info
    async function saveBasicEmployeeInfo() {
      if (!validateBasicEmployeeForm()) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }
    
      const form = document.getElementById('basicEmployeeForm');
      const formData = new FormData(form);
      const selectElement = document.getElementById('selectEmployee');
      const selectedOption = selectElement.options[selectElement.selectedIndex];
    
      const employeeId = formData.get('employeeId');
      const isEdit = !!employeeId;
    
      const data = {
        employeeSelect: formData.get('employeeSelect'), // The actual selected employee ID
        employeeId: formData.get('employeeId'), // Hidden field for edit mode
        name: selectedOption.dataset.name || 'ไม่ระบุชื่อ',
        code: selectedOption.dataset.code || '',
        position: selectedOption.dataset.position || 'พนักงาน',
        department: formData.get('department'),
        bankName: formData.get('bankName'),
        accountNumber: formData.get('accountNumber'),
        baseSalary: parseFloat(formData.get('baseSalary')) || 0,
        startDate: formData.get('startDate'),
        status: 'active'
      };
    
      // Validate data before sending
      if (!data.employeeSelect) {
        showToast('กรุณาเลือกพนักงาน', 'error');
        return;
      }
    
      if (!data.name || data.name === 'ไม่ระบุชื่อ') {
        showToast('ไม่สามารถดึงชื่อพนักงานได้ กรุณาเลือกใหม่', 'error');
        return;
      }
    
      console.log('💾 Saving basic employee data:', data);
      console.log('💾 FormData entries:');
      for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
      }
      console.log('💾 Selected option details:', {
        value: selectedOption.value,
        text: selectedOption.textContent,
        dataset: selectedOption.dataset
      });
    
      try {
        let response;
        if (isEdit) {
          response = await fetch(`${API_BASE_URL}/api/basic-employees/${employeeId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`${API_BASE_URL}/api/basic-employees`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
        }
    
        console.log('📡 API Response status:', response.status);
    
        if (response.ok) {
          const result = await response.json();
          console.log('✅ API Response:', result);
          showToast(isEdit ? 'อัปเดตข้อมูลพื้นฐานเรียบร้อย' : 'บันทึกข้อมูลพื้นฐานเรียบร้อย', 'success');
        } else {
          // Get error details from response
          let errorData;
          try {
            errorData = await response.json();
            console.log('❌ API Error Response:', errorData);
          } catch (parseError) {
            console.log('❌ Could not parse error response');
            errorData = { error: 'Unknown error' };
          }
    
          showToast(errorData.error || 'เกิดข้อผิดพลาดในการบันทึก', 'error');
          return; // Don't proceed with mock save on real API error
        }
      } catch (error) {
        console.error('❌ Network/Parse Error saving basic employee:', error);
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง', 'error');
        return; // Don't proceed with mock save on network error
      }
    
      closeBasicEmployeeModal();
      renderNewEmployeeTable();
    }

    // Edit basic employee
    function editBasicEmployee(employeeId) {
      const employee = basicEmployees.find(emp => emp.id === employeeId);
      if (!employee) return;
    
      openBasicEmployeeModal();
    
      // Fill form with existing data
      setTimeout(() => {
        document.getElementById('basicEmpId').value = employeeId;
        document.getElementById('empDepartment').value = employee.department;
        document.getElementById('employeeBank').value = employee.bankName;
        document.getElementById('bankAccount').value = employee.accountNumber;
        document.getElementById('basicSalaryAmount').value = employee.baseSalary;
        document.getElementById('startWorkDate').value = employee.startDate;
      }, 100);
    }

    // Delete basic employee
    function deleteBasicEmployee(employeeId) {
      const employee = basicEmployees.find(emp => emp.id === employeeId);
      if (!employee) return;
    
      if (confirm(`คุณต้องการลบข้อมูลพนักงาน ${employee.name} ใช่หรือไม่?`)) {
        // Try API delete
        fetch(`${API_BASE_URL}/api/basic-employees/${employeeId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        }).then(response => {
          if (response.ok) {
            showToast('ลบข้อมูลเรียบร้อยแล้ว', 'success');
          } else {
            showToast('ลบข้อมูลเรียบร้อยแล้ว (Demo Mode)', 'success');
          }
        }).catch(error => {
          console.error('Error deleting employee:', error);
          showToast('ลบข้อมูลเรียบร้อยแล้ว (Demo Mode)', 'success');
        });
    
        // Remove from local data
        basicEmployees = basicEmployees.filter(emp => emp.id !== employeeId);
        renderNewEmployeeTable();
      }
    }

    // ===== MONTHLY SALARY UPDATE MODAL FUNCTIONS =====

    // Open monthly salary update modal
    function openMonthlySalaryUpdateModal(employeeId) {
      const employee = basicEmployees.find(emp => emp.id === employeeId);
      if (!employee) {
        showToast('ไม่พบข้อมูลพนักงาน', 'error');
            return;
          }
    
      const modal = document.getElementById('monthlySalaryUpdateModal');
      if (modal) {
        modal.classList.add('modal-open');
    
        // Fill employee info
        document.getElementById('monthlyEmpId').value = employee.employeeId; // Use User._id, not BasicEmployee.id
        document.getElementById('monthlyBaseSalary').value = employee.baseSalary;
        document.getElementById('monthlyDisplayName').textContent = employee.name;
        document.getElementById('monthlyDisplayDept').textContent = employee.department;
        document.getElementById('monthlyDisplayBaseSalary').textContent = formatCurrency(employee.baseSalary);
        document.getElementById('monthlyDisplayBank').textContent = employee.bankName;
    
        console.log('📋 Opening monthly salary modal for:', {
          basicEmployeeId: employeeId,
          userEmployeeId: employee.employeeId,
          employeeName: employee.name
        });
    
        // Update period display
        updatePeriodDisplay();
    
        // Calculate social security (5% of base salary)
        const socialSecurity = Math.round(employee.baseSalary * 0.05);
        document.getElementById('monthlySocialSecurity').value = socialSecurity;
    
        // Load existing monthly salary data if exists
        loadExistingMonthlySalary(employee.employeeId); // Pass User._id
    
        // Initialize calculations
        setupMonthlySalaryCalculations();
      }
    }

    // Close monthly salary update modal
    function closeMonthlySalaryUpdateModal() {
      const modal = document.getElementById('monthlySalaryUpdateModal');
      if (modal) {
        modal.classList.remove('modal-open');
        resetMonthlySalaryForm();
      }
    }

    // Reset monthly salary form
    function resetMonthlySalaryForm() {
      const form = document.getElementById('monthlySalaryForm');
      if (form) {
        // Reset only input fields, not hidden fields
        form.querySelectorAll('input[type="number"]:not([readonly]), input[type="file"], select').forEach(input => {
          if (input.type !== 'hidden') {
            input.value = '';
          }
        });
    
        // Reset displays
        document.getElementById('monthlyFieldTotal').textContent = '฿0';
        document.getElementById('monthlyOTTotal').textContent = '฿0';
        document.getElementById('monthlyGrossIncome').textContent = '฿0';
        document.getElementById('monthlyTotalDeductions').textContent = '-฿0';
        document.getElementById('monthlyNetSalary').textContent = '฿0';
      }
    }

    // Setup monthly salary calculations
    function setupMonthlySalaryCalculations() {
      const inputIds = [
        'monthlyPositionAllowance',
        'monthlyCommission',
        'monthlyFieldDays',
        'monthlyFieldType',
        'monthlyOTHours',
        'monthlyOTRate'
      ];
    
      inputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', calculateMonthlySalary);
          element.addEventListener('change', calculateMonthlySalary);
        }
      });
    
      // Initial calculation
      calculateMonthlySalary();
    }

    // Calculate monthly salary totals
    function calculateMonthlySalary() {
      const baseSalary = parseFloat(document.getElementById('monthlyBaseSalary').value) || 0;
      const positionAllowance = parseFloat(document.getElementById('monthlyPositionAllowance').value) || 0;
      const commission = parseFloat(document.getElementById('monthlyCommission').value) || 0;
    
      // Field allowance calculation
      const fieldDays = parseInt(document.getElementById('monthlyFieldDays').value) || 0;
      const fieldType = document.getElementById('monthlyFieldType').value;
      let fieldRate = 0;
      if (fieldType === 'upper') fieldRate = 300;
      else if (fieldType === 'lower') fieldRate = 200;
      const fieldAllowance = fieldDays * fieldRate;
      document.getElementById('monthlyFieldTotal').textContent = formatCurrency(fieldAllowance);
    
      // OT calculation
      const otHours = parseFloat(document.getElementById('monthlyOTHours').value) || 0;
      const otRate = parseFloat(document.getElementById('monthlyOTRate').value) || 55;
      const otTotal = otHours * otRate;
      document.getElementById('monthlyOTTotal').textContent = formatCurrency(otTotal);
    
      // Gross income calculation
      const grossIncome = baseSalary + positionAllowance + commission + fieldAllowance + otTotal;
      document.getElementById('monthlyGrossIncome').textContent = formatCurrency(grossIncome);
    
      // Deductions calculation
      const socialSecurity = Math.round(baseSalary * 0.05);
      let withholdingTax = 0;
      if (commission >= 1000) {
        withholdingTax = Math.round(commission * 0.03);
      }
      document.getElementById('monthlyWithholdingTax').value = withholdingTax;
    
      const totalDeductions = socialSecurity + withholdingTax;
      document.getElementById('monthlyTotalDeductions').textContent = formatCurrency(-totalDeductions);
    
      // Net salary calculation
      const netSalary = grossIncome - totalDeductions;
      document.getElementById('monthlyNetSalary').textContent = formatCurrency(netSalary);
    }

    // Load existing monthly salary data
    async function loadExistingMonthlySalary(userEmployeeId) {
      try {
        console.log('📋 Loading existing monthly salary for userEmployeeId:', userEmployeeId);
    
        const response = await fetch(`${API_BASE_URL}/api/monthly-payrolls/${userEmployeeId}?month=${currentPayrollMonth}&year=${currentPayrollYear}`, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
    
        console.log('📋 Load existing salary response status:', response.status);
    
        if (response.ok) {
          const result = await response.json();
          const existing = result.data;
    
          console.log('📋 Existing monthly salary data:', existing);
    
          if (existing) {
            document.getElementById('monthlySalaryRecordId').value = existing._id || existing.id;
            document.getElementById('monthlyPositionAllowance').value = existing.positionAllowance || '';
            document.getElementById('monthlyCommission').value = existing.commission || '';
            document.getElementById('monthlyFieldDays').value = existing.fieldDays || '';
            document.getElementById('monthlyFieldType').value = existing.fieldType || 'none';
            document.getElementById('monthlyOTHours').value = existing.otHours || '';
            document.getElementById('monthlyOTRate').value = existing.otRate || 55;
    
            // Recalculate after loading data
            setTimeout(calculateMonthlySalary, 100);
            console.log('✅ Loaded existing monthly salary data');
          } else {
            console.log('📋 No existing monthly salary data found');
          }
        } else {
          console.log('📋 No existing monthly salary data (API response not ok)');
        }
      } catch (error) {
        console.error('Error loading existing monthly salary:', error);
      }
    }

    // Save monthly salary data
    async function saveMonthlySalaryData() {
      const form = document.getElementById('monthlySalaryForm');
      const formData = new FormData(form);
    
      const monthlySalaryId = formData.get('salaryRecordId');
      const isEdit = !!monthlySalaryId;
    
      const employeeId = formData.get('employeeId'); // Keep as string (ObjectId)
    
      const data = {
        employeeId: employeeId, // This should be User._id (from employee.employeeId)
        month: currentPayrollMonth,
        year: currentPayrollYear,
        positionAllowance: parseFloat(document.getElementById('monthlyPositionAllowance').value) || 0,
        commission: parseFloat(document.getElementById('monthlyCommission').value) || 0,
        fieldDays: parseInt(document.getElementById('monthlyFieldDays').value) || 0,
        fieldType: document.getElementById('monthlyFieldType').value || 'none',
        fieldAllowance: parseFloat(document.getElementById('monthlyFieldTotal').textContent.replace(/[฿,]/g, '')) || 0,
        otHours: parseFloat(document.getElementById('monthlyOTHours').value) || 0,
        otRate: parseFloat(document.getElementById('monthlyOTRate').value) || 55,
        otTotal: parseFloat(document.getElementById('monthlyOTTotal').textContent.replace(/[฿,]/g, '')) || 0,
        socialSecurity: parseFloat(document.getElementById('monthlySocialSecurity').value) || 0,
        withholdingTax: parseFloat(document.getElementById('monthlyWithholdingTax').value) || 0,
        grossIncome: parseFloat(document.getElementById('monthlyGrossIncome').textContent.replace(/[฿,]/g, '')) || 0,
        netSalary: parseFloat(document.getElementById('monthlyNetSalary').textContent.replace(/[฿,]/g, '')) || 0
      };
    
      console.log('💾 Monthly salary data to save:', data);
    
      // Validate required fields
      if (!employeeId || !currentPayrollMonth || !currentPayrollYear) {
        showToast('ข้อมูลพนักงานหรือรอบเวลาไม่ครบถ้วน', 'error');
        return;
      }
    
      try {
        let response;
        if (isEdit) {
          response = await fetch(`${API_BASE_URL}/api/monthly-payrolls/${monthlySalaryId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
          });
        } else {
          response = await fetch(`${API_BASE_URL}/api/monthly-payrolls`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
              // Remove auth for testing
            },
            body: JSON.stringify(data)
          });
        }
    
        console.log('📡 Monthly payroll API response status:', response.status);
    
        if (response.ok) {
          const result = await response.json();
          console.log('✅ Monthly payroll API response:', result);
          showToast('บันทึกข้อมูลเงินเดือนรายเดือนเรียบร้อย', 'success');
        } else {
          // Get error details from response
          let errorData;
          try {
            errorData = await response.json();
            console.log('❌ Monthly payroll API error response:', errorData);
          } catch (parseError) {
            console.log('❌ Could not parse monthly payroll error response');
            errorData = { error: 'Unknown error' };
          }
    
          showToast(errorData.error || 'เกิดข้อผิดพลาดในการบันทึกเงินเดือน', 'error');
          return; // Don't proceed with mock save
        }
      } catch (error) {
        console.error('❌ Network/Parse Error saving monthly salary:', error);
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง', 'error');
        return; // Don't proceed with mock save on network error
      }
    
      closeMonthlySalaryUpdateModal();
      renderNewEmployeeTable();
    }

    // View salary history
    function viewSalaryHistory(employeeId) {
      const employee = basicEmployees.find(emp => emp.id === employeeId);
      if (!employee) return;
    
      showToast(`ประวัติเงินเดือนของ ${employee.name} จะแสดงเร็วๆ นี้`, 'info');
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }

    // Initialize new payroll system
    function initializeNewPayrollSystem() {
      console.log('Initializing new payroll system...');
    
      // Initialize arrays first
      if (!window.basicEmployees) window.basicEmployees = [];
      if (!window.monthlyPayrolls) window.monthlyPayrolls = [];
    
      initializeCurrentPeriod();
    
      // Initialize form handlers
      setTimeout(() => {
        const basicForm = document.getElementById('basicEmployeeForm');
        if (basicForm) {
          basicForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveBasicEmployeeInfo();
          });
        }

        const monthlyForm = document.getElementById('monthlySalaryForm');
        if (monthlyForm) {
          monthlyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveMonthlySalaryData();
          });
        }
      }, 100);
    
      // Load data for current period
      loadPayrollByPeriod();
    }

    // Get bonus type label in Thai
    function getBonusTypeLabel(type) {
      const typeLabels = {
        'performance': 'โบนัสผลงาน',
        'sales': 'โบนัสยอดขาย',
        'festival': 'โบนัสเทศกาล',
        'annual': 'โบนัสประจำปี',
        'special': 'โบนัสพิเศษ',
        'other': 'อื่นๆ'
      };
      return typeLabels[type] || type || 'ไม่ระบุประเภท';
    }

    // Get status label in Thai
    function getBonusStatusLabel(status) {
      const statusLabels = {
        'pending': 'รอดำเนินการ',
        'approved': 'อนุมัติแล้ว',
        'paid': 'จ่ายแล้ว',
        'cancelled': 'ยกเลิก'
      };
      return statusLabels[status] || status || 'ไม่ระบุสถานะ';
    }

    // Handle bonus type change
    function handleBonusTypeChange() {
      const bonusType = document.getElementById('bonusTypeSelect').value;
      const salesBonusSection = document.getElementById('salesBonusSection');
      const manualAmountSection = document.getElementById('manualAmountSection');

      if (salesBonusSection && manualAmountSection) {
        if (bonusType === 'sales') {
          salesBonusSection.classList.remove('hidden');
          manualAmountSection.classList.add('hidden');
          // Clear manual amount and make it not required
          const bonusAmountInput = document.getElementById('bonusAmount');
          if (bonusAmountInput) {
            bonusAmountInput.value = '';
            bonusAmountInput.removeAttribute('required');
          }
        } else {
          salesBonusSection.classList.add('hidden');
          manualAmountSection.classList.remove('hidden');
          // Make manual amount required again
          const bonusAmountInput = document.getElementById('bonusAmount');
          if (bonusAmountInput) {
            bonusAmountInput.setAttribute('required', 'required');
          }
        }
      }

      console.log('📋 Bonus type changed to:', bonusType);
    }

    // Calculate sales bonus and update amount field
    function calculateSalesBonus() {
      const salesAmount = parseFloat(document.getElementById('salesAmount').value) || 0;
      const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;
      const calculatedBonus = (salesAmount * commissionRate) / 100;

      // Update calculated bonus display
      const calculatedBonusElement = document.getElementById('calculatedBonus');
      if (calculatedBonusElement) {
        calculatedBonusElement.textContent = `฿${calculatedBonus.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      // Auto-fill the hidden bonus amount field
      const bonusAmountInput = document.getElementById('bonusAmount');
      if (bonusAmountInput) {
        bonusAmountInput.value = calculatedBonus.toFixed(2);
      }

      console.log('📊 Sales bonus calculated:', { salesAmount, commissionRate, calculatedBonus });
    }

    // Initialize bonus form
    function initializeBonusForm() {
      const form = document.getElementById('bonusForm');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveBonusData();
        });
      }
    
      // Set default date to today
      const dateInput = document.getElementById('bonusDate');
      if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
    }

    // Save bonus data
    async function saveBonusData() {
      const form = document.getElementById('bonusForm');
      const formData = new FormData(form);
    
      const bonusType = document.getElementById('bonusTypeSelect').value;
      let bonusAmount = parseFloat(document.getElementById('bonusAmount').value) || 0;

      // For sales bonus, ensure we use calculated amount if available
      if (bonusType === 'sales') {
        const salesAmount = parseFloat(document.getElementById('salesAmount').value) || 0;
        const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;
        if (salesAmount > 0 && commissionRate > 0) {
          bonusAmount = (salesAmount * commissionRate) / 100;
        }
      }

      const bonusData = {
        employeeId: document.getElementById('bonusEmployeeSelect').value,
        type: bonusType,
        amount: bonusAmount,
        date: document.getElementById('bonusDate').value,
        description: document.getElementById('bonusDescription').value,
        status: document.getElementById('bonusStatus').value
      };
    
      console.log('💾 Saving bonus data:', bonusData);
    
      // Validate required fields
      if (!bonusData.employeeId || !bonusData.type || !bonusData.date || !bonusData.description) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }

      // Special validation for sales bonus
      if (bonusData.type === 'sales') {
        const salesAmount = parseFloat(document.getElementById('salesAmount').value) || 0;
        const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;
        if (salesAmount <= 0 || commissionRate <= 0) {
          showToast('กรุณากรอกยอดขายและอัตราคอมมิชชันสำหรับโบนัสยอดขาย', 'error');
          return;
        }
      } else if (!bonusData.amount || bonusData.amount <= 0) {
        showToast('กรุณากรอกจำนวนเงินโบนัส', 'error');
        return;
      }
    
      // Get employee name for display
      const selectedOption = document.getElementById('bonusEmployeeSelect').selectedOptions[0];
      if (selectedOption) {
        bonusData.employeeName = selectedOption.dataset.employeeName;
        bonusData.department = selectedOption.dataset.department;
        bonusData.position = selectedOption.dataset.position;
      }
    
      // Add type name mapping
      const typeNames = {
        'performance': 'โบนัสผลงาน',
        'sales': 'โบนัสยอดขาย',
        'festival': 'โบนัสเทศกาล',
        'annual': 'โบนัสประจำปี',
        'special': 'โบนัสพิเศษ',
        'other': 'อื่นๆ'
      };
      bonusData.typeName = typeNames[bonusData.type] || bonusData.type;
    
      try {
        const response = await fetch(`${API_BASE_URL}/api/bonuses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bonusData)
        });
    
        if (response.ok) {
          const result = await response.json();
          showToast('บันทึกโบนัสเรียบร้อยแล้ว', 'success');
          closeBonusModal();
          // Reload bonus data if on bonus tab
          if (currentTab === 'bonus') {
            loadBonusData();
          }
        } else {
          const errorData = await response.json();
          console.log('❌ Bonus API Error:', errorData);
          showToast(errorData.error || 'เกิดข้อผิดพลาดในการบันทึก', 'error');
        }
      } catch (error) {
        console.error('❌ Error saving bonus:', error);
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
      }
    }

    // Close bonus modal
    function closeBonusModal() {
      const modal = document.getElementById('bonusModal');
      if (modal) {
        modal.classList.add('hidden');
    
        // Reset form
        const form = document.getElementById('bonusForm');
        if (form) form.reset();
      }
    }

    // Load employees for bonus selection
    async function loadEmployeesForBonus() {
      const select = document.getElementById('bonusEmployeeSelect');
      if (!select) return;
    
      try {
        console.log('📋 Loading employees for bonus selection...');
    
        // Get employees from users API
        const response = await fetch(`${API_BASE_URL}/api/users?limit=0`, {
          headers: getAuthHeaders()
        });
    
        if (response.ok) {
          const result = await response.json();
          const employeeList = result.data || result.users || result || [];
    
          select.innerHTML = '<option value="">กรุณาเลือกพนักงาน</option>';
    
          employeeList.forEach(emp => {
            // Extract name
            let displayName = '';
            if (emp.employee && emp.employee.name && emp.employee.name.trim()) {
              displayName = emp.employee.name.trim();
            } else if (emp.name && emp.name.trim()) {
              displayName = emp.name.trim();
            } else if (emp.fullName && emp.fullName.trim()) {
              displayName = emp.fullName.trim();
            } else if (emp.firstName || emp.lastName) {
              displayName = `${emp.firstName || ''} ${emp.lastName || ''}`.trim();
            } else if (emp.username && emp.username.trim()) {
              displayName = emp.username.trim();
            } else {
              displayName = `User ${emp._id || emp.id}`;
            }
    
            const option = document.createElement('option');
            option.value = emp._id || emp.id;
            option.textContent = `${displayName} (${emp.employee?.employeeId || emp.emp_code || emp.code || 'No Code'})`;
            option.dataset.employeeName = displayName;
            option.dataset.department = emp.employee?.department || emp.department || '';
            option.dataset.position = emp.employee?.position || emp.position || '';
            select.appendChild(option);
          });
    
          console.log(`✅ Loaded ${employeeList.length} employees for bonus selection`);
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Error loading employees for bonus:', error);
        select.innerHTML = '<option value="">ไม่สามารถโหลดรายชื่อพนักงานได้</option>';
        showToast('ไม่สามารถโหลดรายชื่อพนักงานได้', 'error');
      }
    }

    // ========== END NEW PAYROLL SYSTEM FUNCTIONS ==========

  </script>

  <!-- Bonus Management Modal -->
  <div id="bonusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">

        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="bi bi-plus-circle text-green-600 mr-2"></i>
            <span id="bonusModalTitle">เพิ่มโบนัส</span>
          </h3>
          <button onclick="closeBonusModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <form id="bonusForm" class="p-6 space-y-4">
          <!-- Employee Selection -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">พนักงาน <span class="text-red-500">*</span></span>
            </label>
            <select id="bonusEmployeeSelect" class="select select-bordered w-full" required>
              <option value="">เลือกพนักงาน</option>
            </select>
          </div>

          <!-- Bonus Type -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">ประเภทโบนัส <span class="text-red-500">*</span></span>
            </label>
            <select id="bonusTypeSelect" class="select select-bordered w-full" required onchange="handleBonusTypeChange()">
              <option value="">เลือกประเภทโบนัส</option>
              <option value="performance">โบนัสผลงาน</option>
              <option value="sales">โบนัสยอดขาย</option>
              <option value="festival">โบนัสเทศกาล</option>
              <option value="annual">โบนัสประจำปี</option>
              <option value="special">โบนัสพิเศษ</option>
              <option value="other">อื่นๆ</option>
            </select>
          </div>


          <!-- Description -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">รายละเอียด <span class="text-red-500">*</span></span>
            </label>
            <textarea id="bonusDescription" class="textarea textarea-bordered h-20"
                      placeholder="กรอกรายละเอียดโบนัส..." required></textarea>
          </div>

          <!-- Sales Bonus Section (Hidden by default) -->
          <div id="salesBonusSection" class="hidden space-y-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
            <h4 class="font-medium text-blue-800 dark:text-blue-200">
              <i class="bi bi-graph-up mr-2"></i>คำนวณโบนัสยอดขาย
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">ยอดขาย (บาท)</span>
                </label>
                <input type="number" id="salesAmount" class="input input-bordered"
                       placeholder="0.00" min="0" step="0.01" onchange="calculateSalesBonus()">
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">อัตราคอมมิชชัน (%)</span>
                </label>
                <input type="number" id="commissionRate" class="input input-bordered"
                       value="5" min="0" max="100" step="0.1" onchange="calculateSalesBonus()">
              </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-3 rounded border">
              <div class="text-sm text-gray-600 dark:text-gray-400">จำนวนโบนัสที่คำนวณได้:</div>
              <div id="calculatedBonus" class="text-lg font-bold text-green-600">฿0</div>
              <div class="text-xs text-gray-500 mt-1">
                <i class="bi bi-info-circle mr-1"></i>
                ระบบจะใช้ยอดนี้เป็นจำนวนโบนัสโดยอัตโนมัติ
              </div>
            </div>
          </div>

          <!-- Manual Amount Section -->
          <div id="manualAmountSection" class="form-control">
            <label class="label">
              <span class="label-text font-medium">จำนวนเงิน (บาท) <span class="text-red-500">*</span></span>
            </label>
            <input type="number" id="bonusAmount" class="input input-bordered"
                   placeholder="0.00" min="0" step="0.01" required>
          </div>

          <!-- Date -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">วันที่ <span class="text-red-500">*</span></span>
            </label>
            <input type="date" id="bonusDate" class="input input-bordered" required>
          </div>

          <!-- Description -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">รายละเอียด <span class="text-red-500">*</span></span>
            </label>
            <textarea id="bonusDescription" class="textarea textarea-bordered h-20"
                      placeholder="กรอกรายละเอียดโบนัส..." required></textarea>
          </div>

          <!-- Status -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">สถานะ</span>
            </label>
            <select id="bonusStatus" class="select select-bordered w-full">
              <option value="pending">รอดำเนินการ</option>
              <option value="approved">อนุมัติแล้ว</option>
            </select>
          </div>

          <!-- Loading State -->
          <div id="bonusFormLoading" class="hidden text-center py-4">
            <div class="loading loading-spinner loading-md"></div>
            <p class="text-sm text-gray-500 mt-2">กำลังบันทึกข้อมูล...</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-3 pt-4">
            <button type="button" onclick="closeBonusModal()" class="btn btn-outline flex-1">
              ยกเลิก
            </button>
            <button type="submit" class="btn btn-primary flex-1">
              <i class="bi bi-check-circle mr-2"></i>
              <span id="bonusSubmitText">บันทึกโบนัส</span>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

</body>
</html>