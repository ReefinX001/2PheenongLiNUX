<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>รายชื่อพนักงาน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon ต่างๆ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] }
        }
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <!-- animate.css for Loading Effects -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* CSS Variables for Theme Support */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .dark {
      --bg-primary: #1f2937;
      --bg-secondary: #111827;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    .dark .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }

    /* Enhanced body transition */
    body {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Table responsive improvements */
    .table-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .table-container table {
      background: var(--bg-primary);
    }

    .table-container thead {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
    }

    /* เพิ่ม CSS สำหรับความสวยงาม */
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Quick Actions Dropdown Animation */
    #quickActionsDropdown {
      animation: dropdownFadeIn 0.2s ease-out;
      transform-origin: top right;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Dropdown hover effects */
    #quickActionsDropdown a:hover {
      transform: translateX(2px) scale(0.98);
    }

    /* Dark mode support for dropdown */
    .dark #quickActionsDropdown {
      background: #374151;
      border-color: #6b7280;
    }
    
    /* Button styles matching DaisyUI */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
      white-space: nowrap;
    }
    
    .btn-outline {
      background-color: transparent;
      border-color: currentColor;
    }
    
    .btn-outline:hover {
      background-color: currentColor;
      color: white;
    }
    
    /* DaisyUI Button Classes */
    .btn-primary {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
      border-color: #2563eb;
    }
    
    .btn-secondary {
      background-color: #8b5cf6;
      color: white;
      border-color: #8b5cf6;
    }
    
    .btn-secondary:hover {
      background-color: #7c3aed;
      border-color: #7c3aed;
    }
    
    .btn-outline {
      background-color: transparent;
      color: #6b7280;
      border-color: #d1d5db;
    }
    
    .btn-outline:hover {
      background-color: #6b7280;
      color: white;
      border-color: #6b7280;
    }
    
    /* Dark mode button styles */
    .dark .btn-outline {
      color: #9ca3af;
      border-color: #6b7280;
    }
    
    .dark .btn-outline:hover {
      background-color: #9ca3af;
      color: #1f2937;
      border-color: #9ca3af;
    }
    
    /* Button sizes */
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #f3f4f6;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dark .calendar-day {
      background-color: #374151;
    }

    .calendar-day-holiday {
      background-color: #fee2e2;
      color: #ef4444;
    }

    .dark .calendar-day-holiday {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* Table improvements */
    table {
      border-collapse: separate;
      border-spacing: 0;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      min-width: 120px;
    }

    tbody tr {
      border-bottom: 1px solid var(--border-color);
    }

    tbody td {
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    /* Special handling for employee name column */
    .employee-name-cell {
      min-width: 250px;
      max-width: 300px;
    }

    .employee-name-cell .employee-name {
      white-space: normal;
      word-wrap: break-word;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    #notificationBtn span.badge-notification { /* More specific selector for the badge */
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Filter and Sort Section Styling */
    .filter-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .dark .filter-section {
      background: linear-gradient(135deg, #4c5270 0%, #5a4575 100%);
    }

    /* Sort select styling */
    #sortBy:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .dark #sortBy:focus {
      border-color: #a78bfa;
      box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
    }

    /* Active sort indication */
    #sortBy:not([value=""]) {
      border-color: #8b5cf6;
      background-color: #f3f4ff;
    }

    .dark #sortBy:not([value=""]) {
      border-color: #a78bfa;
      background-color: #312e4a;
    }

    /* Responsive design improvements */
    @media (max-width: 768px) {
      .filter-section {
        padding: 0.75rem;
      }
      
      .filter-section .flex {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* Status indicators */
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .status-active {
      background-color: #10b981;
    }

    .status-away {
      background-color: #f59e0b;
    }

    .status-offline {
      background-color: #6b7280;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
    }

    .dark .modal-content {
      background-color: #2d3748;
      color: #f7fafc;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .dark .close:hover,
    .dark .close:focus {
      color: white;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
    }

    .dark .form-group input,
    .dark .form-group select {
      background-color: #4a5568;
      color: white;
      border-color: #4a5568;
    }
  </style>

  <!-- Early theme detection to prevent flash -->
  <script>
    // Early theme detection - run immediately to prevent flash
    (function() {
      const storedTheme = localStorage.getItem('theme');
      const storedDarkMode = localStorage.getItem('darkMode');

      let theme = 'light'; // Default

      if (storedTheme) {
        theme = storedTheme;
      } else if (storedDarkMode !== null) {
        theme = storedDarkMode === 'true' ? 'dark' : 'light';
      } else {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      console.log('⚡ Early theme detection:', theme);

      // Apply theme to document element immediately (this is always available)
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      // Apply theme to body when available
      function applyThemeToBody() {
        if (document.body) {
          if (theme === 'dark') {
            document.body.classList.add('dark');
          } else {
            document.body.classList.remove('dark');
          }
        } else {
          // If body not ready, try again after a short delay
          setTimeout(applyThemeToBody, 10);
        }
      }

      applyThemeToBody();

      // Store the determined theme immediately
      localStorage.setItem('theme', theme);
    })();
  </script>

  <!-- โหลดข้อมูลผู้ใช้ปัจจุบันจาก /api/users/me -->
  <script>
    // โหลดข้อมูลผู้ใช้ปัจจุบันจาก /api/users/me
    let lottieAnimation = null;

    // ====== Show/Hide Loading Function ======
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // โหลดและเล่น Lottie animation
        if (!lottieAnimation) {
          console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('✅ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('❌ Error loading Lottie animation:', error);
              // Fallback เฉพาะเมื่อ Lottie โหลดไม่สำเร็จ
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    async function loadEmployeeProfile() {
      showLoading(true);
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const res = await fetch('/api/users/me', {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        const result = await res.json();
        if (!res.ok || !result.success) throw new Error(result.error||'ไม่สามารถดึงข้อมูลผู้ใช้');
        const user = result.data;
        document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';
        const photoEl = document.getElementById('employeePhoto');
    
        // Use resolvePhotoUrl with user name and small size for profile photo (36px)
        photoEl.src = resolvePhotoUrl(user.photoUrl, user.name || 'User', 36);
    
        // Add error handler to the profile photo
        photoEl.onerror = function() {
          handleImageError(this, user.name || 'User');
        };
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }
  </script>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white dark:bg-gray-800 flex flex-col transition-all duration-300 z-40">
      <a href="Login_Management">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto"/>
        </div>
      </a>
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li>
            <a href="hr_dashboard" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-speedometer2 text-xl text-indigo-600 dark:text-indigo-400"></i>
              <span class="ml-3">แดชบอร์ด</span>
            </a>
          </li>
          <li>
            <a href="employee_directory" class="flex items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700">
              <i class="bi bi-people-fill text-xl text-blue-500 dark:text-blue-400"></i>
              <span class="ml-3">พนักงาน</span>
            </a>
          </li>
          <li>
            <a href="attendance" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-clock text-xl text-green-500 dark:text-green-400"></i>
              <span class="ml-3">บันทึกเวลาเข้า-ออก</span>
            </a>
          </li>
          <li>
            <a href="leave_requests" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-file-earmark-text text-xl text-yellow-500 dark:text-yellow-300"></i>
              <span class="ml-3">การลา</span>
            </a>
          </li>      
          <li>
            <a href="payroll" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-cash-stack text-xl text-emerald-500 dark:text-emerald-400"></i>
              <span class="ml-3">เงินเดือน</span>
            </a>
          </li>
          <li>
            <a href="performance_reviews" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-award text-xl text-purple-500 dark:text-purple-400"></i>
              <span class="ml-3">ประเมินผลงาน</span>
            </a>
          </li>
          <li>
            <a href="bonus_list" class="flex items-center px-4 h-12 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gift text-xl text-pink-500 dark:text-pink-400 mr-3"></i>
              <span>รายการโบนัส</span>
            </a>
          </li>
          <li>
        
          <li class="mt-4">
            <a href="role_management" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gear text-xl text-gray-600 dark:text-gray-300"></i>
              <span class="ml-3">การตั้งค่า</span>
            </a>
          </li>
          <li class="mt-6">
            <button id="btnToggleDark" class="flex items-center h-12 px-4 rounded-lg w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-moon text-xl text-slate-600 dark:text-slate-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <li>
            <button id="btnLogoutSidebar" class="flex items-center h-12 px-4 rounded-lg w-full text-left text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">ออกจากระบบ</span>
            </button>
          </li>
          <li>
            <div id="profile" class="flex items-center h-12 px-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
              <img id="employeePhoto" src="https://ui-avatars.com/api/?name=User&size=36&background=3B82F6&color=fff&rounded=true" alt="Employee Photo" class="w-10 h-10 rounded-full mr-3"/>
              <span id="employeeName">Loading...</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 p-6 transition-all duration-300" id="mainContent">
      <div class="container mx-auto">
        <div class="mb-6">
          <h1 class="text-2xl font-semibold text-gray-800 dark:text-white">รายชื่อพนักงาน</h1>
          <p class="text-gray-600 dark:text-gray-400">จัดการข้อมูลพนักงานทั้งหมดในระบบ HR</p>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4 mb-6">
          <div class="flex flex-col md:flex-row mb-4 md:mb-0 w-full md:w-auto space-y-2 md:space-y-0 md:space-x-2">
            <!-- Search Section -->
            <div class="flex w-full md:w-auto">
              <div class="relative flex-grow md:flex-grow-0">
                <input type="text" id="searchInput" placeholder="ค้นหาพนักงาน..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="absolute left-3 top-2.5 text-gray-400"><i class="bi bi-search"></i></div>
              </div>
              <button id="btnSearchEmployees" class="btn btn-primary ml-2 px-4 py-2"><i class="bi bi-search"></i> ค้นหา</button>
            </div>
            
            <!-- Filter Section -->
            <div class="flex space-x-2 w-full md:w-auto">
              <select id="sortBy" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- เลือกการเรียงลำดับ --</option>
                <option value="name-asc">ชื่อ ก-ฮ (A-Z)</option>
                <option value="name-desc">ชื่อ ฮ-ก (Z-A)</option>
                <option value="code-asc">รหัสพนักงาน น้อย-มาก</option>
                <option value="code-desc">รหัสพนักงาน มาก-น้อย</option>
                <option value="position-asc">ตำแหน่ง ก-ฮ</option>
                <option value="department-asc">แผนก ก-ฮ</option>
                <option value="department-desc">แผนก ฮ-ก</option>
                <option value="date-asc">วันเริ่มงาน เก่า-ใหม่</option>
                <option value="date-desc">วันเริ่มงาน ใหม่-เก่า</option>
              </select>
              <button id="btnApplySort" class="btn btn-secondary px-4 py-2">
                <i class="bi bi-sort-alpha-down"></i> เรียง
              </button>
              <button id="btnResetFilter" class="btn btn-outline px-4 py-2">
                <i class="bi bi-arrow-clockwise"></i> รีเซ็ต
              </button>
            </div>
          </div>
          <!-- Quick Actions Menu แบบ Dropdown -->
          <div class="relative">
            <button id="quickActionsBtn" class="btn btn-outline flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
              <i class="bi bi-list text-lg"></i>
              <span class="hidden md:inline">เมนูด่วน</span>
              <i class="bi bi-chevron-down text-sm ml-1"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50 dark:bg-gray-800 dark:border-gray-600">
              <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between dark:text-gray-300 dark:border-gray-600">
                <span>เลือกหน้าที่ต้องการ</span>
                <span class="text-xs text-gray-400">HR Management</span>
              </div>
              
              <a href="register_user" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 dark:text-gray-300 dark:hover:bg-blue-900 dark:hover:text-blue-300">
                <i class="bi bi-person-plus-fill text-yellow-500"></i>
                <div>
                  <div class="font-medium">สมัคร User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">สร้างบัญชีผู้ใช้ใหม่</div>
                </div>
              </a>
              
              <a href="employee" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 dark:text-gray-300 dark:hover:bg-blue-900 dark:hover:text-blue-300">
                <i class="bi bi-plus-lg text-green-500"></i>
                <div>
                  <div class="font-medium">เพิ่มพนักงานใหม่</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">บันทึกข้อมูลพนักงานใหม่</div>
                </div>
              </a>
              
              <a href="notifications" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 dark:text-gray-300 dark:hover:bg-blue-900 dark:hover:text-blue-300">
                <i class="bi bi-bell-fill text-orange-500"></i>
                <div>
                  <div class="font-medium">ใบแจ้งเตือน</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">ดูการแจ้งเตือนของระบบ</div>
                </div>
              </a>
              
              <div class="border-t border-gray-100 mt-2 dark:border-gray-600">
                <a href="reports" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 dark:text-gray-300 dark:hover:bg-blue-900 dark:hover:text-blue-300">
                  <i class="bi bi-graph-up text-blue-500"></i>
                  <div>
                    <div class="font-medium">รายงาน</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">รายงานข้อมูลพนักงาน</div>
                  </div>
                </a>
                
                <a href="settings" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 dark:text-gray-300 dark:hover:bg-blue-900 dark:hover:text-blue-300">
                  <i class="bi bi-gear-fill text-gray-500"></i>
                  <div>
                    <div class="font-medium">ตั้งค่า</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">การตั้งค่าระบบ HR</div>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="table-container bg-white dark:bg-gray-900 shadow-sm rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full table-auto">
              <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">รหัสพนักงาน</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">รูปพนักงาน & ชื่อ-นามสกุล</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ตำแหน่ง</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">แผนก</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">อีเมล</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">เบอร์โทรศัพท์</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">วันที่เริ่มงาน</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">การจัดการ</th>
                </tr>
              </thead>
              <tbody id="employeeList" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
          </div>
          
          <!-- Pagination Controls -->
          <div id="paginationContainer" class="bg-white dark:bg-gray-900 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <!-- รายการต่อหน้า -->
              <div class="flex items-center space-x-2">
                <label for="itemsPerPage" class="text-sm text-gray-700 dark:text-gray-300">แสดง:</label>
                <select id="itemsPerPage" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                  <option value="5">5 รายการ</option>
                  <option value="10" selected>10 รายการ</option>
                  <option value="20">20 รายการ</option>
                  <option value="50">50 รายการ</option>
                </select>
              </div>
              
              <!-- ข้อมูล pagination -->
              <div class="flex items-center space-x-4">
                <span id="paginationInfo" class="text-sm text-gray-700 dark:text-gray-300">
                  แสดง 1-10 จาก 0 รายการ
                </span>
                
                <!-- ปุ่ม pagination -->
                <div class="flex items-center space-x-2">
                  <button id="btnFirst" class="btn btn-outline btn-sm px-3 py-1 text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="bi bi-chevron-double-left"></i> แรก
                  </button>
                  <button id="btnPrev" class="btn btn-outline btn-sm px-3 py-1 text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="bi bi-chevron-left"></i> ก่อนหน้า
                  </button>
                  <span id="pageNumbers" class="flex items-center space-x-1">
                    <!-- Page numbers will be generated here -->
                  </span>
                  <button id="btnNext" class="btn btn-outline btn-sm px-3 py-1 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    ถัดไป <i class="bi bi-chevron-right"></i>
                  </button>
                  <button id="btnLast" class="btn btn-outline btn-sm px-3 py-1 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    สุดท้าย <i class="bi bi-chevron-double-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: Add/Edit -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <span id="btnCloseEmployeeModal" class="close">&times;</span>
      <h2 id="modalTitle" class="text-xl font-semibold mb-4 dark:text-gray-100"></h2>
      <form id="employeeForm">
        <input type="hidden" id="employeeId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group"><label for="empCode">รหัสพนักงาน</label><input type="text" id="empCode" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empName">ชื่อ-นามสกุล</label><input type="text" id="empName" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empPosition">ตำแหน่ง</label><input type="text" id="empPosition" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empDepartment">แผนก</label><select id="empDepartment" required class="w-full px-3 py-2 border rounded-md"><option value="">เลือกแผนก</option><option value="บัญชี">บัญชี</option><option value="การตลาด">การตลาด</option><option value="ไอที">ไอที</option><option value="ทรัพยากรบุคคล">ทรัพยากรบุคคล</option><option value="ขาย">ขาย</option><option value="จัดซื้อ">จัดซื้อ</option><option value="ผลิต">ผลิต</option></select></div>
          <div class="form-group"><label for="empEmail">อีเมล</label><input type="email" id="empEmail" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empPhone">เบอร์โทรศัพท์</label><input type="tel" id="empPhone" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empStartDate">วันที่เริ่มงาน</label><input type="date" id="empStartDate" required class="w-full px-3 py-2 border rounded-md"></div>
          <div class="form-group"><label for="empOrigin">ภูมิลำเนา</label><input type="text" id="empOrigin" class="w-full px-3 py-2 border rounded-md"></div>
        </div>
        <div class="flex justify-end mt-6 gap-2">
          <button type="button" id="btnCancelEmployeeForm" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md">ยกเลิก</button>
          <button type="button" id="btnSaveEmployeeForm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: View -->
  <div id="viewEmployeeModal" class="modal">
    <div class="modal-content">
      <span id="btnCloseViewModal" class="close">&times;</span>
      <h2 class="text-xl font-semibold mb-4 dark:text-gray-100">ข้อมูลพนักงาน</h2>
      <div id="viewContent" class="space-y-2"></div>
    </div>
  </div>

  <script>
    // Enhanced resolvePhotoUrl with better fallback handling
    function resolvePhotoUrl(raw, employeeName = 'Employee', size = 150) {
      // Default fallback image using ui-avatars service with appropriate size
      const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(employeeName)}&size=${size}&background=3B82F6&color=fff&rounded=true`;
    
      if (!raw) return defaultAvatar;
    
      if (raw.startsWith('http')) return raw; // Already a full URL
    
      let resolvedUrl;
      // If starts with /uploads/ but not /uploads/employees/
      if (raw.startsWith('/uploads/') && !raw.includes('/employees/')) {
        resolvedUrl = raw.replace(/^\/uploads\//, '/uploads/employees/');
      }
      // If it's just a filename without a leading slash
      else if (!raw.startsWith('/')) {
        resolvedUrl = `/uploads/employees/${raw}`;
      }
      // For other cases like /uploads/employees/filename.jpg (already correct)
      else {
        resolvedUrl = raw;
      }
    
      return resolvedUrl;
    }
    
    // Function to handle image loading errors with size detection
    function handleImageError(imgElement, employeeName = 'Employee') {
      // Detect size from element or use default
      const elementWidth = imgElement.offsetWidth || imgElement.width || 150;
      const size = elementWidth < 50 ? 36 : (elementWidth < 100 ? 80 : 150);
    
      const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(employeeName)}&size=${size}&background=3B82F6&color=fff&rounded=true`;
      imgElement.src = fallbackUrl;
      imgElement.onerror = null; // Prevent infinite loop
    
      console.log(`🖼️ Using fallback image for "${employeeName}" with size ${size}px`);
    }

    // Function to open the add/edit modal
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'เพิ่มพนักงานใหม่';
      document.getElementById('employeeForm').reset(); // Reset form fields
      document.getElementById('employeeId').value = ''; // Clear employee ID for new entry
      const modal = document.getElementById('employeeModal');
      if (modal) {
        modal.style.display = 'block';
      }
      console.log('Add/Edit Modal should be visible now for adding.');
    }
    
    const API_BASE = '/api/hr/employees';
    let employees = []; // This will store the list of users/employees
    const token = localStorage.getItem('authToken');
    
    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalItems = 0;
    let currentFilteredEmployees = []; // สำหรับเก็บข้อมูลที่ผ่านการกรอง

    // Main DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', async () => {
      if (!token) {
        window.location.href = '/login';
        return; // Stop further execution if no token
      }

      // Initial data fetching
      await loadEmployeeProfile(); // Fetches and updates sidebar profile
      await fetchEmployees();   // Fetches and renders employee list

      // Setup UI toggles and static event listeners
      // Theme is already initialized by early detection script
      const currentTheme = localStorage.getItem('theme') || 'light';
      const isDarkMode = currentTheme === 'dark';

      console.log('🎨 Current theme from localStorage:', currentTheme);

      // Update UI elements to match current theme
      const darkModeLabel = document.getElementById('darkModeLabel');
      const darkModeIcon = document.querySelector('#btnToggleDark i');

      if (darkModeLabel) {
        darkModeLabel.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
      }

      if (darkModeIcon) {
        darkModeIcon.classList.remove('bi-moon', 'bi-sun');
        if (isDarkMode) {
          darkModeIcon.classList.add('bi-sun');
        } else {
          darkModeIcon.classList.add('bi-moon');
        }
      }

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        const currentStoredTheme = localStorage.getItem('theme');
        if (!currentStoredTheme || currentStoredTheme === 'system') {
          console.log('🔄 System theme changed to:', e.matches ? 'dark' : 'light');
          const systemTheme = e.matches ? 'dark' : 'light';

          if (systemTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.body.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
            document.body.classList.remove('dark');
          }

          const darkModeLabel = document.getElementById('darkModeLabel');
          const darkModeIcon = document.querySelector('#btnToggleDark i');
          if (darkModeLabel) darkModeLabel.textContent = systemTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
          if (darkModeIcon) {
            if (systemTheme === 'dark') {
              darkModeIcon.classList.remove('bi-moon');
              darkModeIcon.classList.add('bi-sun');
            } else {
              darkModeIcon.classList.remove('bi-sun');
              darkModeIcon.classList.add('bi-moon');
            }
          }

          localStorage.setItem('theme', systemTheme);
        }
      });

      const btnToggleDark = document.getElementById('btnToggleDark');
      if (btnToggleDark) btnToggleDark.addEventListener('click', toggleDarkMode);
    
      const btnToggleMenu = document.getElementById('btnToggleMenu');
      if (btnToggleMenu) btnToggleMenu.addEventListener('click', toggleSidebar);
    
      const btnLogoutSidebar = document.getElementById('btnLogoutSidebar');
      if (btnLogoutSidebar) btnLogoutSidebar.addEventListener('click', logoutUser);

      // Event listeners for static elements in the main content
      const btnSearchEmployees = document.getElementById('btnSearchEmployees');
      if (btnSearchEmployees) btnSearchEmployees.addEventListener('click', searchEmployees);
    
      const btnApplySort = document.getElementById('btnApplySort');
      if (btnApplySort) btnApplySort.addEventListener('click', applySorting);
    
      const btnResetFilter = document.getElementById('btnResetFilter');
      if (btnResetFilter) btnResetFilter.addEventListener('click', resetFilters);
    
      // Add search on Enter key
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            searchEmployees();
          }
        });
      }

      // Auto-sort when dropdown changes
      const sortBySelect = document.getElementById('sortBy');
      if (sortBySelect) {
        sortBySelect.addEventListener('change', function() {
          applySorting();
        });
      }
    
      // Pagination event listeners
      const btnFirst = document.getElementById('btnFirst');
      if (btnFirst) btnFirst.addEventListener('click', goToFirstPage);
    
      const btnPrev = document.getElementById('btnPrev');
      if (btnPrev) btnPrev.addEventListener('click', goToPreviousPage);
    
      const btnNext = document.getElementById('btnNext');
      if (btnNext) btnNext.addEventListener('click', goToNextPage);
    
      const btnLast = document.getElementById('btnLast');
      if (btnLast) btnLast.addEventListener('click', goToLastPage);
    
      const itemsPerPageSelect = document.getElementById('itemsPerPage');
      if (itemsPerPageSelect) itemsPerPageSelect.addEventListener('change', changeItemsPerPage);
    
      // Quick Actions Dropdown event listeners
      const quickActionsBtn = document.getElementById('quickActionsBtn');
      const quickActionsDropdown = document.getElementById('quickActionsDropdown');
      if (quickActionsBtn && quickActionsDropdown) {
        const chevronIcon = quickActionsBtn.querySelector('.bi-chevron-down');
    
        // Toggle dropdown
        quickActionsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
    
          const isHidden = quickActionsDropdown.classList.contains('hidden');
          if (isHidden) {
            quickActionsDropdown.classList.remove('hidden');
            chevronIcon.style.transform = 'rotate(180deg)';
          } else {
            quickActionsDropdown.classList.add('hidden');
            chevronIcon.style.transform = 'rotate(0deg)';
          }
        });
    
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!quickActionsBtn.contains(e.target) && !quickActionsDropdown.contains(e.target)) {
            quickActionsDropdown.classList.add('hidden');
            chevronIcon.style.transform = 'rotate(0deg)';
          }
        });
    
        // Close dropdown on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            quickActionsDropdown.classList.add('hidden');
            chevronIcon.style.transform = 'rotate(0deg)';
          }
        });
      }
    
      // Modal close/cancel buttons
      const btnCloseEmployeeModal = document.getElementById('btnCloseEmployeeModal');
      if (btnCloseEmployeeModal) btnCloseEmployeeModal.addEventListener('click', closeModal);
    
      const btnCancelEmployeeForm = document.getElementById('btnCancelEmployeeForm');
      if (btnCancelEmployeeForm) btnCancelEmployeeForm.addEventListener('click', closeModal);
    
      const btnSaveEmployeeForm = document.getElementById('btnSaveEmployeeForm');
      if (btnSaveEmployeeForm) btnSaveEmployeeForm.addEventListener('click', saveEmployee);
    
      const btnCloseViewModal = document.getElementById('btnCloseViewModal');
      if (btnCloseViewModal) btnCloseViewModal.addEventListener('click', closeViewModal);

      // Event delegation for dynamically generated buttons in the employee list
      const employeeListTbody = document.getElementById('employeeList');
      if (employeeListTbody) {
        employeeListTbody.addEventListener('click', function(event) {
          const targetButton = event.target.closest('button'); // Get the button element
          if (!targetButton) return;

          const action = targetButton.dataset.action;
          const employeeId = targetButton.dataset.id;

          if (action === 'view') {
            // Note: View action is an <a> tag in your current renderEmployees,
            // this delegation is for <button> tags. Adjust if needed.
            // viewEmployee(employeeId);
          } else if (action === 'edit') {
            // Note: Edit action is also an <a> tag.
            // editEmployee(employeeId);
          } else if (action === 'delete') {
            deleteEmployee(employeeId);
          }
        });
      }
    });

    // ======= Fetch Current User's Profile =======
    async function fetchUserProfile() {
      try {
        const res = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          if (res.status === 401 || res.status === 403) {
            alert('Session expired or invalid. Please log in again.');
            logoutUser(false); // Pass false to avoid double alert
            return;
          }
          throw new Error(json.message || `Failed to load profile (${res.status})`);
        }
    
        const employeeNameSpan = document.getElementById('employeeName');
        const employeePhotoImg = document.getElementById('employeePhoto');

        if(employeeNameSpan) employeeNameSpan.textContent = json.data.name;
        if(employeePhotoImg) employeePhotoImg.src = resolvePhotoUrl(json.data.photoUrl); // Use resolvePhotoUrl

      } catch (err) {
        console.error('Error fetching user profile:', err);
        alert('ไม่สามารถโหลดข้อมูลผู้ใช้ได้: ' + err.message);
      }
    }

    // ======= Fetch All Users (Employees) =======
    async function fetchEmployees() {
      showLoading(true);
      try {
        console.log('📊 Fetching employees from:', API_BASE);

        if (!token) {
          console.warn('❌ No token found, redirecting to login');
          showLoading(false);
          logoutUser(false);
          return;
        }

        const res = await fetch(`${API_BASE}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'X-Request-ID': Date.now().toString()
          }
        });

        console.log('📊 Employee fetch response status:', res.status);

        if (res.status === 401) {
          console.warn('🔒 Authentication failed');
          alert('เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่');
          logoutUser(false);
          return;
        }

        if (res.status === 403) {
          console.warn('🚫 Access forbidden');
          alert('คุณไม่มีสิทธิ์เข้าถึงข้อมูลพนักงาน');
          return;
        }

        const json = await res.json();
        console.log('📊 Employee data received:', json);

        if (!json.success) {
            throw new Error(json.message || `Failed to fetch employees (${res.status})`);
        }

        employees = json.data || [];
        console.log('👥 Found employees:', employees.length);
        renderEmployees();
      } catch (err) {
          console.error('❌ Error fetching employees:', err);
          const tbody = document.getElementById('employeeList');
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน: ${err.message}</td></tr>`;
          }
      } finally {
        showLoading(false);
      }
    }

    // ======= Render Employee Table with Pagination =======
    function renderEmployees(filteredList = null) {
      // อัพเดต currentFilteredEmployees
      currentFilteredEmployees = filteredList || employees;
      totalItems = currentFilteredEmployees.length;
    
      const tbody = document.getElementById('employeeList');
      tbody.innerHTML = '';

      if (!currentFilteredEmployees || currentFilteredEmployees.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
              ไม่พบข้อมูลพนักงาน
            </td>
          </tr>`;
        updatePagination();
        return;
      }
    
      // คำนวณข้อมูลสำหรับหน้าปัจจุบัน
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentPageData = currentFilteredEmployees.slice(startIndex, endIndex);

      currentPageData.forEach(emp => {
        // Debug log to see what data we're getting
        console.log('📊 Employee data:', emp);


        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200';
        const employeeId = emp._id || emp.id; // Use _id from MongoDB or id

        // Extract employee data from nested structure
        const employeeData = emp.employee || emp;
        const employeeCode = employeeData.employeeId || emp.employeeId || '(ไม่มีรหัส)';
        const employeeName = employeeData.name || emp.name || '(ไม่มีชื่อ)';
        const position = employeeData.position || emp.position || '(ไม่ระบุตำแหน่ง)';
        const department = employeeData.department || emp.department || '(ไม่ระบุแผนก)';
        const email = emp.email || employeeData.email || '(ไม่มีอีเมล)';
        const phone = employeeData.phone || emp.phone || '(ไม่มีเบอร์)';
        const startDate = employeeData.startDate || emp.startDate || null;
        const photoUrl = employeeData.imageUrl || employeeData.photoUrl || emp.photoUrl || emp.imageUrl;

        // Use resolvePhotoUrl with employee name and table size (80px for 10x10 table images)
        const imagePath = resolvePhotoUrl(photoUrl, employeeName, 80);

        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100 font-medium">
            ${employeeCode}
          </td>
          <td class="employee-name-cell px-4 py-3 text-sm">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <img
                  src="${imagePath}"
                  alt="${employeeName}"
                  class="h-10 w-10 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600"
                  onerror="handleImageError(this, '${employeeName}')"
                />
              </div>
              <div class="min-w-0 flex-1">
                <div class="employee-name text-sm font-medium text-gray-900 dark:text-white truncate">
                  ${employeeName}
                </div>
                ${email !== '(ไม่มีอีเมล)' ? `<div class="text-xs text-gray-500 dark:text-gray-400 truncate">${email}</div>` : ''}
              </div>
            </div>
          </td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
            ${position}
          </td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
            ${department}
          </td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
            ${email !== '(ไม่มีอีเมล)' ? `<a href="mailto:${email}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">${email}</a>` : email}
          </td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
            ${phone !== '(ไม่มีเบอร์)' ? `<a href="tel:${phone}" class="text-green-600 hover:text-green-800 dark:text-green-400">${phone}</a>` : phone}
          </td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
            ${startDate ? formatDate(startDate) : '(ไม่ระบุวันที่)'}
          </td>
          <td class="px-4 py-3 text-sm">
            <div class="flex items-center space-x-2">
              <a href="employee_detail?id=${employeeId}"
                 class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200 dark:text-indigo-400 dark:bg-indigo-900 dark:hover:bg-indigo-800 transition-colors"
                 title="ดูรายละเอียด">
                <i class="bi bi-eye mr-1"></i>
                ดู
              </a>
              <button data-action="delete" data-id="${employeeId}"
                      class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-red-600 bg-red-100 hover:bg-red-200 dark:text-red-400 dark:bg-red-900 dark:hover:bg-red-800 transition-colors"
                      title="ลบพนักงาน">
                <i class="bi bi-trash mr-1"></i>
                ลบ
              </button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    
      updatePagination();
    }
    
    // ======= Helper: Format Date =======
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        return new Date(dateString).toLocaleDateString('th-TH', {
          year: 'numeric', month: 'short', day: 'numeric' // Using 'short' for month for brevity
        });
      } catch (e) {
        console.warn('Invalid Date for formatting:', dateString);
        return 'Invalid Date';
      }
    }

    // ======= UI Toggles =======
    function toggleDarkMode() {
      console.log('🔄 Dark mode toggle clicked');
      const currentTheme = localStorage.getItem('theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      console.log('🎯 Switching from', currentTheme, 'to', newTheme);

      // Apply/remove dark mode classes properly
      if (newTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
        document.body.classList.remove('dark');
      }

      const isDark = newTheme === 'dark';
      const darkModeLabel = document.getElementById('darkModeLabel');
      const darkModeIcon = document.querySelector('#btnToggleDark i');

      if (darkModeLabel) darkModeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      if (darkModeIcon) {
        if (isDark) {
          darkModeIcon.classList.remove('bi-moon');
          darkModeIcon.classList.add('bi-sun');
        } else {
          darkModeIcon.classList.remove('bi-sun');
          darkModeIcon.classList.add('bi-moon');
        }
      }

      localStorage.setItem('theme', newTheme);
      localStorage.setItem('darkMode', isDark ? 'true' : 'false'); // Keep backward compatibility

      // Force repaint for smooth transition
      document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
      void document.body.offsetHeight; // Trigger reflow

      console.log('🎨 Theme switched to:', newTheme);
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
    
      if (sidebar) {
        sidebar.classList.toggle('-translate-x-64');
        if (mainContent) {
          mainContent.classList.toggle('ml-64');
          mainContent.classList.toggle('ml-0');
        }
      }
      if (icon) {
        icon.classList.toggle('bi-chevron-left');
        icon.classList.toggle('bi-chevron-right');
      }
    }

    // ======= Search Employees =======
    function searchEmployees() {
      const searchInput = document.getElementById('searchInput');
      if (!searchInput) return;
    
      const searchTerm = searchInput.value.toLowerCase().trim();
      let filteredEmployees;
    
      if (!searchTerm) {
        filteredEmployees = employees; // แสดงทั้งหมดถ้าไม่มีคำค้นหา
      } else {
        filteredEmployees = employees.filter(emp => {
          const employeeData = emp.employee || emp;
          const employeeCode = employeeData.employeeId || emp.employeeId || '';
          const employeeName = employeeData.name || emp.name || '';
          const position = employeeData.position || emp.position || '';
          const department = employeeData.department || emp.department || '';
          const email = emp.email || employeeData.email || '';
    
          return employeeCode.toLowerCase().includes(searchTerm) ||
                 employeeName.toLowerCase().includes(searchTerm) ||
                 position.toLowerCase().includes(searchTerm) ||
                 department.toLowerCase().includes(searchTerm) ||
                 email.toLowerCase().includes(searchTerm);
        });
      }
    
      // ตรวจสอบว่ามีการเรียงลำดับหรือไม่
      const sortBy = document.getElementById('sortBy').value;
      if (sortBy) {
        filteredEmployees = applySortToList(filteredEmployees, sortBy);
      }
    
      // รีเซ็ตไปหน้าแรกเมื่อค้นหา
      currentPage = 1;
      renderEmployees(filteredEmployees);
    }

    // ======= Sort Functions =======
    function applySorting() {
      const sortBy = document.getElementById('sortBy').value;
    
      // ตรวจสอบว่ามีการค้นหาหรือไม่
      const searchInput = document.getElementById('searchInput');
      let currentList = employees;
    
      if (searchInput && searchInput.value.trim()) {
        const searchTerm = searchInput.value.toLowerCase().trim();
        currentList = employees.filter(emp => {
          const employeeData = emp.employee || emp;
          const employeeCode = employeeData.employeeId || emp.employeeId || '';
          const employeeName = employeeData.name || emp.name || '';
          const position = employeeData.position || emp.position || '';
          const department = employeeData.department || emp.department || '';
          const email = emp.email || employeeData.email || '';
    
          return employeeCode.toLowerCase().includes(searchTerm) ||
                 employeeName.toLowerCase().includes(searchTerm) ||
                 position.toLowerCase().includes(searchTerm) ||
                 department.toLowerCase().includes(searchTerm) ||
                 email.toLowerCase().includes(searchTerm);
        });
      }
    
      if (!sortBy) {
        renderEmployees(currentList);
        return;
      }

      const sortedEmployees = applySortToList(currentList, sortBy);
      renderEmployees(sortedEmployees);
    
      // แสดงข้อความสถานะการเรียงลำดับ
      const sortOption = document.querySelector(`#sortBy option[value="${sortBy}"]`);
      if (sortOption) {
        showFilterMessage(`เรียงลำดับ: ${sortOption.textContent}`, 'success');
      }
    }

    function applySortToList(employeeList, sortBy) {
      let sortedEmployees = [...employeeList];
    
      switch(sortBy) {
        case 'name-asc':
          sortedEmployees.sort((a, b) => {
            const nameA = (a.employee?.name || a.name || '');
            const nameB = (b.employee?.name || b.name || '');
            return compareThaiEnglish(nameA, nameB, true);
          });
          break;
        case 'name-desc':
          sortedEmployees.sort((a, b) => {
            const nameA = (a.employee?.name || a.name || '');
            const nameB = (b.employee?.name || b.name || '');
            return compareThaiEnglish(nameA, nameB, false);
          });
          break;
        case 'code-asc':
          sortedEmployees.sort((a, b) => {
            const codeA = (a.employee?.employeeId || a.employeeId || '');
            const codeB = (b.employee?.employeeId || b.employeeId || '');
            return codeA.localeCompare(codeB);
          });
          break;
        case 'code-desc':
          sortedEmployees.sort((a, b) => {
            const codeA = (a.employee?.employeeId || a.employeeId || '');
            const codeB = (b.employee?.employeeId || b.employeeId || '');
            return codeB.localeCompare(codeA);
          });
          break;
        case 'position-asc':
          sortedEmployees.sort((a, b) => {
            const posA = (a.employee?.position || a.position || '');
            const posB = (b.employee?.position || b.position || '');
            return compareThaiEnglish(posA, posB, true);
          });
          break;
        case 'department-asc':
          sortedEmployees.sort((a, b) => {
            const deptA = (a.employee?.department || a.department || '');
            const deptB = (b.employee?.department || b.department || '');
            return compareThaiEnglish(deptA, deptB, true);
          });
          break;
        case 'department-desc':
          sortedEmployees.sort((a, b) => {
            const deptA = (a.employee?.department || a.department || '');
            const deptB = (b.employee?.department || b.department || '');
            return compareThaiEnglish(deptA, deptB, false);
          });
          break;
        case 'date-asc':
          sortedEmployees.sort((a, b) => {
            const dateA = new Date(a.employee?.startDate || a.startDate || 0);
            const dateB = new Date(b.employee?.startDate || b.startDate || 0);
            return dateA - dateB;
          });
          break;
        case 'date-desc':
          sortedEmployees.sort((a, b) => {
            const dateA = new Date(a.employee?.startDate || a.startDate || 0);
            const dateB = new Date(b.employee?.startDate || b.startDate || 0);
            return dateB - dateA;
          });
          break;
      }
    
      return sortedEmployees;
    }

    // ฟังก์ชันเปรียบเทียบสำหรับภาษาไทยและอังกฤษ
    function compareThaiEnglish(a, b, ascending = true) {
      // แปลงเป็นตัวพิมพ์เล็กสำหรับการเปรียบเทียบ
      const strA = a.toLowerCase();
      const strB = b.toLowerCase();
    
      // ตรวจสอบว่าเป็นภาษาไทยหรืออังกฤษ
      const isThaiA = /[\u0E00-\u0E7F]/.test(strA);
      const isThaiB = /[\u0E00-\u0E7F]/.test(strB);
    
      // ถ้าเป็นภาษาเดียวกัน ใช้ localeCompare
      if (isThaiA === isThaiB) {
        const result = strA.localeCompare(strB, isThaiA ? 'th' : 'en');
        return ascending ? result : -result;
      }
    
      // ถ้าต่างภาษา ให้ภาษาไทยมาก่อน (หรือตามที่ต้องการ)
      if (isThaiA && !isThaiB) {
        return ascending ? -1 : 1;
      } else {
        return ascending ? 1 : -1;
      }
    }

    function resetFilters() {
      const searchInput = document.getElementById('searchInput');
      const sortBy = document.getElementById('sortBy');
    
      if (searchInput) searchInput.value = '';
      if (sortBy) sortBy.value = '';
    
      // รีเซ็ต pagination ไปหน้าแรก
      currentPage = 1;
      renderEmployees(); // แสดงข้อมูลทั้งหมดใหม่
    
      // แสดงข้อความแจ้งเตือน
      showFilterMessage('รีเซ็ตตัวกรองเรียบร้อย', 'success');
    }

    // ฟังก์ชันแสดงข้อความสถานะ
    function showFilterMessage(message, type = 'info') {
      // สร้าง element สำหรับแสดงข้อความ
      const messageDiv = document.createElement('div');
      messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
      }`;
      messageDiv.textContent = message;
    
      document.body.appendChild(messageDiv);
    
      // ลบข้อความหลังจาก 3 วินาที
      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }
    
    // ======= Modal Controls =======
    // openAddModal is defined globally earlier

    function closeModal() {
      const modal = document.getElementById('employeeModal');
      if (modal) modal.style.display = 'none';
    }

    function closeViewModal() {
      const modal = document.getElementById('viewEmployeeModal');
      if (modal) modal.style.display = 'none';
    }

    // ======= CRUD Operations for Employees/Users =======
    function editEmployee(employeeId) { // Called from employee_detail page or similar, not directly from this table's buttons yet
      const emp = employees.find(e => (e.id === employeeId || e._id === employeeId));
      if (!emp) {
        alert('ไม่พบข้อมูลพนักงานสำหรับแก้ไข');
        return;
      }
      document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลพนักงาน';
      const empIdField = document.getElementById('employeeId');
      if(empIdField) empIdField.value = emp.id || emp._id;
    
      // Populate form fields (ensure element IDs exist)
      const empCode = document.getElementById('empCode'); if(empCode) empCode.value = emp.employeeId || '';
      const empName = document.getElementById('empName'); if(empName) empName.value = emp.name || '';
      const empPosition = document.getElementById('empPosition'); if(empPosition) empPosition.value = emp.position || '';
      const empDepartment = document.getElementById('empDepartment'); if(empDepartment) empDepartment.value = emp.department || '';
      const empEmail = document.getElementById('empEmail'); if(empEmail) empEmail.value = emp.email || '';
      const empPhone = document.getElementById('empPhone'); if(empPhone) empPhone.value = emp.phone || '';
      const empStartDate = document.getElementById('empStartDate');
      if(empStartDate) empStartDate.value = emp.startDate ? emp.startDate.split('T')[0] : ''; // Format for date input
      const empOrigin = document.getElementById('empOrigin'); if(empOrigin) empOrigin.value = emp.origin || '';
    
      const modal = document.getElementById('employeeModal');
      if (modal) modal.style.display = 'block';
      console.log('Add/Edit Modal should be visible now for editing employee ID:', employeeId);
    }

    async function saveEmployee() {
      showLoading(true);
      try {
        const employeeId = document.getElementById('employeeId').value;
        const formData = new FormData(); // Use FormData for potential file uploads (image)

        // Example: if you add an <input type="file" id="empImage"> to your form
        // const imageInput = document.getElementById('empImage');
        // if (imageInput && imageInput.files.length > 0) {
        //   formData.append('image', imageInput.files[0]);
        // }

        formData.append('employeeId', document.getElementById('empCode').value);
        formData.append('name', document.getElementById('empName').value);
        formData.append('position', document.getElementById('empPosition').value);
        formData.append('department', document.getElementById('empDepartment').value);
        formData.append('email', document.getElementById('empEmail').value);
        formData.append('phone', document.getElementById('empPhone').value);
        formData.append('startDate', document.getElementById('empStartDate').value);
        formData.append('origin', document.getElementById('empOrigin').value);
        // Add other fields to formData as needed

        const method = employeeId ? 'PATCH' : 'POST'; // Or PUT for update
        const url = employeeId ? `${API_BASE}/${employeeId}` : `${API_BASE}`;

        const res = await fetch(url, {
          method,
          headers: {
            // 'Content-Type': 'application/json', // Not needed for FormData, browser sets it
            'Authorization': 'Bearer ' + token
          },
          body: formData // For JSON: JSON.stringify(employeeData)
        });

        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.message || `Failed to save employee (${res.status})`);
        }

        alert(json.message || 'บันทึกข้อมูลพนักงานสำเร็จ!');
        closeModal();
        await fetchEmployees(); // Refresh the list
      } catch (err) {
        console.error('Error saving employee:', err);
        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    async function viewEmployee(employeeId) { // This would be called if you had a view button triggering it
      showLoading(true);
      try {
        const res = await fetch(`${API_BASE}/${employeeId}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.message || `Failed to fetch employee details (${res.status})`);
        }
        const emp = json.data;
        const viewContent = document.getElementById('viewContent');
        if (viewContent) {
          viewContent.innerHTML = `
            <p><strong>รหัสพนักงาน:</strong> ${emp.employeeId || 'N/A'}</p>
            <p><strong>ชื่อ-นามสกุล:</strong> ${emp.name || 'N/A'}</p>
            <p><strong>ตำแหน่ง:</strong> ${emp.position || 'N/A'}</p>
            <p><strong>แผนก:</strong> ${emp.department || 'N/A'}</p>
            <p><strong>อีเมล:</strong> ${emp.email || 'N/A'}</p>
            <p><strong>เบอร์โทรศัพท์:</strong> ${emp.phone || 'N/A'}</p>
            <p><strong>วันที่เริ่มงาน:</strong> ${emp.startDate ? formatDate(emp.startDate) : 'N/A'}</p>
            <p><strong>ภูมิลำเนา:</strong> ${emp.origin || 'N/A'}</p>
            <!-- Add more fields as needed -->
          `;
        }
        const modal = document.getElementById('viewEmployeeModal');
        if (modal) modal.style.display = 'block';
      } catch (err) {
        console.error('Error viewing employee:', err);
        alert('ไม่สามารถโหลดรายละเอียดพนักงานได้: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    async function deleteEmployee(employeeId) {
      if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบพนักงาน ID: ${employeeId}?`)) return;

      showLoading(true);
      try {
        console.log('🗑️ Deleting employee:', employeeId);

        if (!token) {
          console.warn('❌ No token found');
          alert('กรุณาเข้าสู่ระบบใหม่');
          showLoading(false);
          return;
        }

        const res = await fetch(`${API_BASE}/${employeeId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'X-Request-ID': Date.now().toString()
          }
        });

        console.log('🗑️ Delete response status:', res.status);

        if (res.status === 401) {
          console.warn('🔒 Authentication failed during delete');
          alert('กรุณาเข้าสู่ระบบใหม่');
          showLoading(false);
          logoutUser(false);
          return;
        }

        // 204 No Content → success
        if (res.status === 204) {
          console.log('✅ Employee deleted successfully');
          alert('ลบข้อมูลพนักงานเรียบร้อย');
          await fetchEmployees();
          return;
        }

        // ถ้าไม่ 204 ให้ parse JSON
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          const payload = await res.json();
          if (!res.ok || !payload.success) {
            // อ่านจาก payload.error หรือ payload.message
            throw new Error(payload.error || payload.message || `Request failed with status ${res.status}`);
          }
          // กรณี API คืน success + มี message
          alert(payload.message || 'ลบข้อมูลพนักงานเรียบร้อย');
          await fetchEmployees();
        } else {
          // ไม่ใช่ JSON → อ่านเป็น text
          const txt = await res.text();
          throw new Error(txt || `Request failed with status ${res.status}`);
        }

      } catch (err) {
        console.error('❌ Error deleting employee:', err);
        alert('❌ เกิดข้อผิดพลาดในการลบ: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    // ======= Pagination Functions =======
    function updatePagination() {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const btnFirst = document.getElementById('btnFirst');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const btnLast = document.getElementById('btnLast');
      const paginationInfo = document.getElementById('paginationInfo');
      const pageNumbers = document.getElementById('pageNumbers');
    
      // อัพเดต pagination info
      const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
    
      if (paginationInfo) {
        paginationInfo.innerHTML = `แสดง <span class="font-medium">${startItem}</span> ถึง <span class="font-medium">${endItem}</span> จากทั้งหมด <span class="font-medium">${totalItems}</span> รายการ`;
      }
    
      // อัพเดต First button
      if (btnFirst) {
        btnFirst.disabled = currentPage <= 1;
      }
    
      // อัพเดต Previous button
      if (btnPrev) {
        btnPrev.disabled = currentPage <= 1;
      }
    
      // อัพเดต Next button
      if (btnNext) {
        btnNext.disabled = currentPage >= totalPages;
      }
    
      // อัพเดต Last button
      if (btnLast) {
        btnLast.disabled = currentPage >= totalPages;
      }
    
      // อัพเดต page numbers
      if (pageNumbers && totalPages > 0) {
        let pagesHTML = '';
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
    
        for (let page = startPage; page <= endPage; page++) {
          const isActive = page === currentPage;
          pagesHTML += `
            <button onclick="goToPage(${page})" class="btn btn-sm ${isActive
              ? 'btn-primary'
              : 'btn-outline'
            }">
              ${page}
            </button>
          `;
        }
        pageNumbers.innerHTML = pagesHTML;
      }
    }

    function goToFirstPage() {
      if (currentPage > 1) {
        currentPage = 1;
        renderEmployees(currentFilteredEmployees);
      }
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderEmployees(currentFilteredEmployees);
      }
    }

    function goToNextPage() {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderEmployees(currentFilteredEmployees);
      }
    }
    
    function goToLastPage() {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage = totalPages;
        renderEmployees(currentFilteredEmployees);
      }
    }
    
    function goToPage(page) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        renderEmployees(currentFilteredEmployees);
      }
    }

    function changeItemsPerPage() {
      const itemsSelect = document.getElementById('itemsPerPage');
      if (itemsSelect) {
        itemsPerPage = parseInt(itemsSelect.value);
        currentPage = 1; // รีเซ็ตกลับไปหน้าแรก
        renderEmployees(currentFilteredEmployees);
      }
    }

    // ======= Logout =======
    function logoutUser(showAlert = true) {
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('userInfo'); // Clear stored user info
      if (showAlert) {
        alert('ออกจากระบบแล้ว');
      }
      window.location.href = '/login';
    }
  </script>
</body>
</html>