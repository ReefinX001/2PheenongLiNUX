<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö HR ‚Äî ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon ‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
  <link rel="icon" href="/favicon/favicon.ico" type="image/x-icon" />

  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] }
        }
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts - Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Socket.IO client (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô real-time) -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Calendar Day Styling */
    .calendar-day {
      width: 60px; height: 60px; border-radius: 10px;
      background-color: #f3f4f6; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .dark .calendar-day {
      background-color: #374151;
    }
    .calendar-day-holiday {
      background-color: #fee2e2; color: #ef4444;
    }
    .dark .calendar-day-holiday {
      background-color: #7f1d1d; color: #fca5a5;
    }

    /* Card hover effects */
    .card {
      transition: all 0.2s ease-in-out;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                  0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Notification badge animation */
    @keyframes pulse {
      0%   { transform: scale(1);   }
      50%  { transform: scale(1.1); }
      100% { transform: scale(1);   }
    }
    #notificationBtn span.badge-notification {
      animation: pulse 2s infinite;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .dark ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    ::-webkit-scrollbar-thumb {
      background: #888; border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status indicators */
    .status-indicator {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 5px;
    }
    .status-active   { background-color: #10b981; }
    .status-away     { background-color: #f59e0b; }
    .status-offline  { background-color: #6b7280; }
  </style>

  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadEmployeeProfile ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å -->
  <script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å API
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const res = await fetch('/api/users/me', {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
        });
        const result = await res.json();
        if (!res.ok || !result.success) {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        }
        const user = result.data;
        document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
        let photoUrl = user.photoUrl || '';
        if (!photoUrl.startsWith('/') && !/^https?:\/\//.test(photoUrl)) {
          photoUrl = '/' + photoUrl;
        }
        document.getElementById('employeePhoto').src = photoUrl;
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }
  </script>
</head>

<body class="bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-200">

  <!-- Toggle Sidebar Button -->
  <button id="btnToggleMenu"
          class="fixed left-0 top-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700">
    <i id="toggleIcon" class="bi bi-chevron-left"></i>
  </button>

  <div class="min-h-screen">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white dark:bg-gray-800 flex flex-col transition-all duration-300 z-40">
      <a href="hr_dashboard">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto"/>
        </div>
      </a>

      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li>
            <a href="hr_dashboard"
               class="flex items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700">
              <i class="bi bi-speedometer2 text-xl text-indigo-600 dark:text-indigo-400"></i>
              <span class="ml-3">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </a>
          </li>
          <li>
            <a href="employee_directory"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-people-fill text-xl text-blue-500 dark:text-blue-400"></i>
              <span class="ml-3">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
            </a>
          </li>
          <li>
            <a href="attendance"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-clock text-xl text-green-500 dark:text-green-400"></i>
              <span class="ml-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</span>
            </a>
          </li>
          <li>
            <a href="leave_requests"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-file-earmark-text text-xl text-yellow-500 dark:text-yellow-300"></i>
              <span class="ml-3">‡∏Å‡∏≤‡∏£‡∏•‡∏≤</span>
            </a>
          </li>
          <li>
            <a href="payroll"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-cash-stack text-xl text-emerald-500 dark:text-emerald-400"></i>
              <span class="ml-3">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
            </a>
          </li>
          <li>
            <a href="performance_reviews"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-award text-xl text-purple-500 dark:text-purple-400"></i>
              <span class="ml-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô</span>
            </a>
          </li>
          <li>
            <a href="bonus_list"
               class="flex items-center px-4 h-12 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gift text-xl text-pink-500 dark:text-pink-400 mr-3"></i>
              <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span>
            </a>
          </li>
          <li class="mt-4">
            <a href="role_management"
               class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-gear text-xl text-gray-600 dark:text-gray-300"></i>
              <span class="ml-3">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
          </li>
          <li class="mt-6">
            <button id="btnToggleDark"
                    class="flex items-center h-12 px-4 rounded-lg w-full text-left hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-moon text-xl text-slate-600 dark:text-slate-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <li>
            <button id="btnLogoutSidebar"
                    class="flex items-center h-12 px-4 rounded-lg w-full text-left text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </li>
          <li>
            <div id="profile"
                 class="flex items-center h-12 px-4 rounded-lg bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700">
              <img id="employeePhoto"
                   src="/img/default-avatar.png"
                   alt="Employee Photo"
                   class="w-10 h-10 rounded-full mr-3"/>
              <span id="employeeName">Loading...</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Main Content -->
    <main id="mainContent"
          class="ml-64 p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900
                 transition-all duration-300">
      <!-- Top Bar -->
      <div class="mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div class="flex items-center">
            <button id="menuToggle" class="mr-4 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 md:hidden">
              <i class="bi bi-list text-2xl"></i>
            </button>
            <div>
              <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h1>
              <p class="text-sm text-gray-500 dark:text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-3">
            <!-- Leave Policy Management Card -->
            <div class="card bg-gradient-to-r from-green-500 to-blue-600 text-white shadow-lg">
              <div class="card-body p-4">
                <h3 class="card-title text-sm font-medium flex items-center justify-between">
                  <span>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤</span>
                  <button id="openPolicyModal" class="btn btn-sm btn-outline btn-white">
                    <i class="bi bi-sliders"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                  </button>
                </h3>
                <div class="text-xs space-y-1">
                  <div class="flex justify-between">
                    <span>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
                    <span id="currentPolicyYear">‡∏õ‡∏µ -</span>
                  </div>
                  <div class="flex justify-between">
                    <span>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô:</span>
                    <span id="policyAnnual">- ‡∏ß‡∏±‡∏ô</span>
                  </div>
                  <div class="flex justify-between">
                    <span>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:</span>
                    <span id="policySick">- ‡∏ß‡∏±‡∏ô</span>
                  </div>
                  <div class="flex justify-between">
                    <span>‡∏•‡∏≤‡∏Å‡∏¥‡∏à:</span>
                    <span id="policyPersonal">- ‡∏ß‡∏±‡∏ô</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="stats stats-vertical lg:stats-horizontal shadow bg-white dark:bg-dark-card">
              <div class="stat">
                <div class="stat-title">‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</div>
                <div id="leaveStatsPending" class="stat-value text-warning">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div>
                <div id="leaveStatsApproved" class="stat-value text-success">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                <div id="leaveStatsRejected" class="stat-value text-error">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Search and Filters -->
      <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="relative w-full md:flex-grow">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <i class="bi bi-search text-gray-400"></i>
            </div>
            <input type="text" id="searchInput" class="input input-bordered w-full pl-10" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...">
          </div>
          
          <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto md:flex-shrink-0">
            <div class="dropdown dropdown-end w-full sm:w-auto">
              <label tabindex="0" id="btnFilterStatus" class="btn btn-outline w-full sm:w-auto">
                <i class="bi bi-filter mr-2"></i>‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              </label>
              <ul tabindex="0" id="filterStatusDropdown" class="dropdown-content menu p-2 shadow bg-base-100 dark:bg-base-content/10 rounded-box w-44 border dark:border-gray-700 mt-2 z-[55]">
                <li><a data-status="all" class="filter-status-item active">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
                <li><a data-status="pending" class="filter-status-item">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</a></li>
                <li><a data-status="approved" class="filter-status-item">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</a></li>
                <li><a data-status="rejected" class="filter-status-item">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</a></li>
              </ul>
            </div>
            
            <div class="dropdown dropdown-end w-full sm:w-auto">
              <label tabindex="0" id="btnFilterDateRange" class="btn btn-outline w-full sm:w-auto">
                <i class="bi bi-calendar-event mr-2"></i>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
              </label>
              <div tabindex="0" id="filterDateRangeDropdown" class="dropdown-content p-4 shadow bg-base-100 dark:bg-base-content/10 rounded-box w-64 border dark:border-gray-700 mt-2 z-[55]">
                  <label class="block text-sm mb-1">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                  <input type="date" id="dateFrom" class="input input-bordered input-sm w-full mb-2">
                  <label class="block text-sm mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                  <input type="date" id="dateTo" class="input input-bordered input-sm w-full mb-2">
                  <button id="btnApplyDateFilter" class="btn btn-sm btn-primary w-full">‡∏ï‡∏Å‡∏•‡∏á</button>
              </div>
            </div>
            
            <div class="dropdown dropdown-end w-full sm:w-auto">
              <label tabindex="0" id="btnSortLeave" class="btn btn-outline w-full sm:w-auto">
                <i class="bi bi-sort-down mr-2"></i>‡πÄ‡∏£‡∏µ‡∏¢‡∏á
              </label>
              <ul tabindex="0" id="sortLeaveDropdown" class="dropdown-content menu p-2 shadow bg-base-100 dark:bg-base-content/10 rounded-box w-52 border dark:border-gray-700 mt-2 z-[55]">
                <li><a data-sort-by="createdAt" data-sort-dir="desc" class="sort-leave-item active">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ (‡πÉ‡∏´‡∏°‡πà‚Üí‡πÄ‡∏Å‡πà‡∏≤)</a></li>
                <li><a data-sort-by="createdAt" data-sort-dir="asc" class="sort-leave-item">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ (‡πÄ‡∏Å‡πà‡∏≤‚Üí‡πÉ‡∏´‡∏°‡πà)</a></li>
                <li><a data-sort-by="user.name" data-sort-dir="asc" class="sort-leave-item">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Å‚Üí‡∏Æ)</a></li>
                <li><a data-sort-by="user.name" data-sort-dir="desc" class="sort-leave-item">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Æ‚Üí‡∏Å)</a></li>
              </ul>
            </div>
            
            <button id="btnAddLeave" class="btn btn-primary w-full sm:w-auto">
              <i class="bi bi-plus-circle mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤
            </button>
          </div>
        </div>
      </div>

      <!-- Leave Requests Table -->
      <div class="bg-white dark:bg-dark-card rounded-lg shadow-md overflow-x-auto">
          <table class="table w-full table-hover">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
                <th class="px-4 py-3">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th class="px-4 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th>
                <th class="px-4 py-3">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="px-4 py-3">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="px-4 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="leaveTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
              <tr><td colspan="7" class="text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
          </table>
        
        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
          <div class="mx-auto w-24 h-24 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
            <i class="bi bi-calendar-x text-4xl text-gray-400"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏î‡πÜ ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          <div class="mt-6">
            <button id="btnResetFilters" class="btn btn-sm btn-outline">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="paginationControls" class="mt-6 flex flex-col sm:flex-row justify-between items-center hidden">
        <div id="paginationInfo" class="text-sm text-gray-500 dark:text-gray-400 mb-3 sm:mb-0">
          ‡πÅ‡∏™‡∏î‡∏á 0-0 ‡∏à‡∏≤‡∏Å 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
        <div id="paginationLinks" class="btn-group">
          <!-- Pagination links will be populated here -->
        </div>
      </div>
    </main>
  </div> <!-- End of min-h-screen flex -->

  <!-- Modal for Add/Edit Leave -->
  <div id="leaveModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden items-center justify-center z-[100] p-4">
    <div class="modal-box w-full max-w-lg dark:bg-gray-800">
        <div class="flex justify-between items-center pb-3 border-b dark:border-gray-700">
            <h3 id="leaveModalTitle" class="text-xl font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
            <button id="btnCloseLeaveModal" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
        </div>
        <form id="leaveForm" class="pt-4 space-y-4">
            <input type="hidden" id="leaveRequestId">
            <div>
                <label for="employeeSelectModal" class="block text-sm font-medium mb-1">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <select id="employeeSelectModal" name="employeeSelectModal" class="select select-bordered w-full">
                  <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
                </select>
            </div>
            <div>
                <label for="leaveTypeModal" class="block text-sm font-medium mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                <select id="leaveTypeModal" name="leaveTypeModal" class="select select-bordered w-full">
                    <option value="sick">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                    <option value="personal">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                    <option value="vacation">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
                    <option value="other">‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="startDateModal" class="block text-sm font-medium mb-1">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="startDateModal" name="startDateModal" class="input input-bordered w-full">
                </div>
                <div>
                    <label for="endDateModal" class="block text-sm font-medium mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="endDateModal" name="endDateModal" class="input input-bordered w-full">
                </div>
            </div>
            <div>
                <label for="reasonModal" class="block text-sm font-medium mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
                <textarea id="reasonModal" name="reasonModal" rows="3" class="textarea textarea-bordered w-full"></textarea>
            </div>
            <div class="modal-action">
                <button type="button" id="btnCancelLeaveForm" class="btn btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" id="btnSaveLeaveForm" class="btn btn-primary">
                    <span class="loading loading-spinner loading-sm hidden"></span>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </form>
    </div>
  </div>

  <!-- Modal for Manage Actions -->
  <div id="manageActionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden items-center justify-center z-[101] p-4">
    <div class="modal-box w-full max-w-xs dark:bg-gray-800">
      <div class="flex justify-between items-center pb-3">
        <h3 id="manageActionsModalTitle" class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
        <button id="btnCloseManageActionsModal" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
      </div>
      <div id="manageActionsModalBody" class="space-y-2 pt-2">
        <!-- Action buttons will be populated here by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Leave Allocation Management Modal -->
  <div id="allocationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden items-center justify-center z-[100] p-4">
    <div class="modal-box w-full max-w-6xl h-5/6 dark:bg-gray-800">
      <div class="flex justify-between items-center pb-3 border-b dark:border-gray-700">
        <h3 class="text-xl font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
        <button id="btnCloseAllocationModal" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
      </div>

      <div class="pt-4 h-full overflow-hidden flex flex-col">
        <!-- Search and Filter Section -->
        <div class="flex flex-wrap gap-3 mb-4">
          <div class="flex-1 min-w-64">
            <input type="text" id="employeeSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..."
                   class="input input-bordered w-full" />
          </div>
          <button id="addNewAllocationBtn" class="btn btn-primary">
            <i class="bi bi-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>

        <!-- Employee Leave Allocation Table -->
        <div class="flex-1 overflow-auto">
          <table class="table table-compact w-full">
            <thead class="sticky top-0 bg-base-200">
              <tr>
                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
                <th>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</th>
                <th>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
                <th>‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</th>
                <th>‡∏õ‡∏µ</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="allocationTableBody">
              <tr>
                <td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Allocation Modal -->
  <div id="editAllocationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden items-center justify-center z-[110] p-4">
    <div class="modal-box w-full max-w-md dark:bg-gray-800">
      <div class="flex justify-between items-center pb-3 border-b dark:border-gray-700">
        <h3 id="editAllocationTitle" class="text-lg font-semibold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤</h3>
        <button id="btnCloseEditAllocationModal" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
      </div>

      <form id="allocationForm" class="pt-4 space-y-4">
        <input type="hidden" id="allocationUserId">
        <input type="hidden" id="allocationId">

        <div>
          <label class="block text-sm font-medium mb-1">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select id="allocationEmployeeSelect" class="select select-bordered w-full">
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">‡∏õ‡∏µ</label>
          <select id="allocationYear" class="select select-bordered w-full">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏ß‡∏±‡∏ô)</label>
            <input type="number" id="allocationSick" min="0" max="365" value="30" class="input input-bordered w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô)</label>
            <input type="number" id="allocationAnnual" min="0" max="365" value="10" class="input input-bordered w-full">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡∏ß‡∏±‡∏ô)</label>
            <input type="number" id="allocationPersonal" min="0" max="365" value="3" class="input input-bordered w-full">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ß‡∏±‡∏ô)</label>
            <input type="number" id="allocationSpecial" min="0" max="365" value="5" class="input input-bordered w-full">
          </div>
        </div>

        <div class="modal-action">
          <button type="button" class="btn btn-outline" onclick="closeEditAllocationModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>


<script>
  // API Configuration for GMJ API
  const USE_LOCAL_STORAGE = false; // Set to false to use GMJ API
  const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  const API_HOST = window.location.origin; // Use current host for all API calls
  const API_BASE = `${API_HOST}/api/hr/leaves`; // Local leave endpoint
  const USERS_API_BASE = `${API_HOST}/api/users`;
  const token          = localStorage.getItem('authToken');

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  // 1) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á/‡πÄ‡∏£‡∏µ‡∏¢‡∏á/‡∏´‡∏ô‡πâ‡∏≤
  let allLeaveRequests      = [];
  let currentFilter         = { status: 'all', dateFrom: '', dateTo: '', searchTerm: '' };
  let currentSort           = { by: 'createdAt', dir: 'desc' };
  let currentPage           = 1;
  const itemsPerPage        = 10;
  let currentLeaveIdForModal = null;
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

  // ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á URL ‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  function resolvePhotoUrl(raw) {
    if (!raw) {
      // Return a data URI SVG as placeholder instead of external URL
      return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect width='40' height='40' fill='%23e5e7eb'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='16' fill='%236b7280'%3Eüë§%3C/text%3E%3C/svg%3E";
    }
    if (/^https?:\/\//.test(raw)) return raw;
    if (raw.startsWith('data:')) return raw; // Already a data URI
    if (raw.startsWith('/uploads/employees/')) return raw;
    if (raw.startsWith('/uploads/')) return raw.replace(/^\/uploads\//, '/uploads/employees/');
    return `/uploads/employees/${raw}`;
  }

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  async function fetchUserProfile() {
    // Use localStorage directly if configured
    if (USE_LOCAL_STORAGE) {
      console.log('Using user profile from localStorage');
      const mockUser = {
        _id: localStorage.getItem('userId') || `user_${Date.now()}`,
        name: localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        email: localStorage.getItem('userEmail') || `user${Date.now()}@company.com`,
        role: localStorage.getItem('userRole') || 'hr',
        department: localStorage.getItem('userDepartment') || 'HR',
        photoUrl: localStorage.getItem('userPhoto') || null
      };
      document.getElementById('employeeName').textContent = mockUser.name;
      document.getElementById('employeePhoto').src = resolvePhotoUrl(mockUser.photoUrl);
      window.currentUserId = mockUser._id;
      return;
    }

    // API fetch for GMJ API
    try {
      console.log('Fetching user profile from GMJ API');
      const res = await fetch(`${USERS_API_BASE}/me`, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
  
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('API endpoint not available');
      }
  
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.error || json.message || res.status);

      const u = json.data;
      document.getElementById('employeeName').textContent = u.name;
      document.getElementById('employeePhoto').src = resolvePhotoUrl(u.photoUrl);
      window.currentUserId = u._id || u.id;
    } catch (err) {
      console.error('Failed to fetch user profile:', err);
      showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');

      // Redirect to login if authentication fails
      if (err.message.includes('Unauthorized') || err.message.includes('403')) {
        window.location.href = '/login.html';
        return;
      }

      // Show error state instead of mock data
      document.getElementById('employeeName').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
      document.getElementById('employeePhoto').src = '/img/default-avatar.png';
    }
  }

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Leave Policy Management
  let currentPolicy = null;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  function showNotification(message, type = 'info') {
    // ‡πÉ‡∏ä‡πâ alert ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const prefix = type === 'error' ? '‚ùå ' : type === 'success' ? '‚úÖ ' : '‚ÑπÔ∏è ';
    alert(prefix + message);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Leave Policy
  async function fetchLeavePolicy() {
    try {
      console.log('üìä Fetching leave policy from API');
      const res = await fetch(`${API_HOST}/api/hr/leave-policy`, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const json = await res.json();
      console.log('‚úÖ Leave policy loaded:', json);
      console.log('‚úÖ Leave policy data:', json.data);

      if (json.success && json.data) {
        currentPolicy = json.data;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï policy display ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ã‡∏≤‡∏¢‡∏î‡πå‡∏ö‡∏≤‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡∏î‡∏±‡∏•
        updatePolicyDisplay(json.data);
        updatePolicyModal(json.data);
        updatePolicyStats(json.data);
      } else {
        console.warn('‚ö†Ô∏è No policy data received or success=false');
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢
        displayDefaultPolicy();
      }
    } catch (err) {
      console.error('Failed to fetch leave policy:', err);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      displayDefaultPolicy();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error
      showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  function displayDefaultPolicy() {
    const currentYear = new Date().getFullYear();
    const defaultPolicy = {
      name: `‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ ${currentYear}`,
      year: currentYear,
      version: '1.0',
      isActive: true,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      policy: {
        annual: { days: 6, description: '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô' },
        sick: { days: 30, description: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' },
        personal: { days: 3, description: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à' },
        special: { days: 5, description: '‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©' },
        maternity: { days: 98, description: '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î' },
        paternity: { days: 15, description: '‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤' }
      }
    };

    currentPolicy = defaultPolicy;
    updatePolicyDisplay(defaultPolicy);
    updatePolicyModal(defaultPolicy);
    console.log('üìã Displaying default policy:', defaultPolicy);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Policy
  function updatePolicyDisplay(policy) {
    if (!policy) {
      console.warn('‚ö†Ô∏è No policy data to display');
      return;
    }

    console.log('üìä Updating policy display with:', policy);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏µ‡πÉ‡∏ô sidebar
    const currentPolicyYearEl = document.getElementById('currentPolicyYear');
    if (currentPolicyYearEl) {
      currentPolicyYearEl.textContent = policy.year ? `‡∏õ‡∏µ ${policy.year}` : '‡∏õ‡∏µ -';
      console.log('‚úÖ Updated year display:', currentPolicyYearEl.textContent);
    } else {
      console.warn('‚ö†Ô∏è Element currentPolicyYear not found');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ô sidebar
    if (policy.policy) {
      const policyAnnualEl = document.getElementById('policyAnnual');
      if (policyAnnualEl && policy.policy.annual) {
        policyAnnualEl.textContent = `${policy.policy.annual.days} ‡∏ß‡∏±‡∏ô`;
        console.log('‚úÖ Updated annual leave display:', policyAnnualEl.textContent);
      } else {
        console.warn('‚ö†Ô∏è Element policyAnnual not found or no annual data');
      }

      const policySickEl = document.getElementById('policySick');
      if (policySickEl && policy.policy.sick) {
        policySickEl.textContent = `${policy.policy.sick.days} ‡∏ß‡∏±‡∏ô`;
        console.log('‚úÖ Updated sick leave display:', policySickEl.textContent);
      } else {
        console.warn('‚ö†Ô∏è Element policySick not found or no sick data');
      }

      const policyPersonalEl = document.getElementById('policyPersonal');
      if (policyPersonalEl && policy.policy.personal) {
        policyPersonalEl.textContent = `${policy.policy.personal.days} ‡∏ß‡∏±‡∏ô`;
        console.log('‚úÖ Updated personal leave display:', policyPersonalEl.textContent);
      } else {
        console.warn('‚ö†Ô∏è Element policyPersonal not found or no personal data');
      }
    } else {
      console.warn('‚ö†Ô∏è No policy.policy data found in:', policy);
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏ô modal (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const policyNameEl = document.getElementById('policyName');
    if (policyNameEl) {
      policyNameEl.textContent = policy.name || '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤';
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏µ‡πÉ‡∏ô modal (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const policyYearEl = document.getElementById('policyYear');
    if (policyYearEl) {
      policyYearEl.textContent = policy.year ? `‡∏õ‡∏µ ${policy.year}` : '‡∏õ‡∏µ -';
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Policy Stats
  function updatePolicyStats(policy) {
    if (!policy) return;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏£‡∏ß‡∏°
    const totalDays = Object.values(policy.policy).reduce((sum, type) => sum + (type.days || 0), 0);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stats display
    const totalEl = document.getElementById('totalLeavePolicy');
    if (totalEl) {
      totalEl.textContent = `${totalDays} ‡∏ß‡∏±‡∏ô`;
    }

    const statusEl = document.getElementById('policyStatus');
    if (statusEl) {
      statusEl.textContent = policy.isActive ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      statusEl.className = policy.isActive ? 'text-success' : 'text-error';
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Allocation
  function updateAllocationTable() {
    const tableBody = document.getElementById('allocationTableBody');

    if (filteredAllocations.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="8" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }

    let html = '';
    filteredAllocations.forEach(allocation => {
      const user = allocation.user;
      const emp = user?.employee;
      const isAllocated = allocation.isAllocated !== false;

      html += `
        <tr class="${!isAllocated ? 'bg-yellow-50' : ''}">
          <td>
            <div class="flex items-center">
              <img src="${emp?.photoUrl || '/img/default-avatar.png'}"
                   alt="Avatar" class="w-8 h-8 rounded-full mr-2">
              <div>
                <div class="font-medium">${emp?.name || user?.username || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div class="text-xs text-gray-500">${user?.email || ''}</div>
              </div>
            </div>
          </td>
          <td>${emp?.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
          <td class="text-center">
            <span class="badge ${isAllocated ? 'badge-primary' : 'badge-ghost'}">${allocation.allocation?.sick || 0}</span>
          </td>
          <td class="text-center">
            <span class="badge ${isAllocated ? 'badge-success' : 'badge-ghost'}">${allocation.allocation?.annual || 0}</span>
          </td>
          <td class="text-center">
            <span class="badge ${isAllocated ? 'badge-warning' : 'badge-ghost'}">${allocation.allocation?.personal || 0}</span>
          </td>
          <td class="text-center">
            <span class="badge ${isAllocated ? 'badge-info' : 'badge-ghost'}">${allocation.allocation?.special || 0}</span>
          </td>
          <td class="text-center">${allocation.year}</td>
          <td>
            <div class="flex gap-1">
              <button onclick="editAllocation('${allocation._id || ''}', '${user?._id || user?.id}')"
                      class="btn btn-xs btn-primary">
                <i class="bi bi-pencil"></i>
              </button>
              ${isAllocated ? `
                <button onclick="deleteAllocation('${allocation._id}')"
                        class="btn btn-xs btn-error">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `;
    });

    tableBody.innerHTML = html;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Policy Modal
  function openPolicyModal() {
    document.getElementById('policyModal').classList.remove('hidden');
    document.getElementById('policyModal').classList.add('flex');
    fetchLeavePolicy();
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏î‡πâ‡∏ß‡∏¢
    if (currentPolicy) {
      updatePolicyModal(currentPolicy);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Policy Modal
  function closePolicyModal() {
    document.getElementById('policyModal').classList.add('hidden');
    document.getElementById('policyModal').classList.remove('flex');
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
  function openCreatePolicyForm() {
    const currentPolicyDiv = document.getElementById('currentPolicy');
    if (!currentPolicyDiv) return;

    currentPolicyDiv.innerHTML = `
      <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
        <h5 class="text-lg font-medium mb-4 text-blue-800 dark:text-blue-200">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
        <form id="createPolicyForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢</label>
              <input type="text" id="policyName" class="input input-bordered w-full"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ 2568" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏õ‡∏µ</label>
              <input type="number" id="policyYear" class="input input-bordered w-full"
                     value="${currentPolicy ? currentPolicy.year + 1 : new Date().getFullYear()}"
                     min="2024" max="2030" required>
              ${currentPolicy ? `<div class="text-xs text-gray-500 mt-1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏µ ${currentPolicy.year + 1} (‡∏õ‡∏µ ${currentPolicy.year} ‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)</div>` : ''}
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="annualDays" class="input input-bordered w-full"
                     value="6" min="0" max="30" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="sickDays" class="input input-bordered w-full"
                     value="30" min="0" max="365" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="personalDays" class="input input-bordered w-full"
                     value="3" min="0" max="30" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="specialDays" class="input input-bordered w-full"
                     value="5" min="0" max="30" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="maternityDays" class="input input-bordered w-full"
                     value="98" min="0" max="365" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤ (‡∏ß‡∏±‡∏ô/‡∏õ‡∏µ)</label>
              <input type="number" id="paternityDays" class="input input-bordered w-full"
                     value="15" min="0" max="30" required>
            </div>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="fetchLeavePolicy()" class="btn btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢
            </button>
          </div>
        </form>
      </div>
    `;

    // Add form submit handler
    document.getElementById('createPolicyForm').addEventListener('submit', handleCreatePolicy);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•
  function updatePolicyModal(policy) {
    const currentPolicyDiv = document.getElementById('currentPolicy');
    if (!currentPolicyDiv) return;

    if (!policy) {
      currentPolicyDiv.innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <i class="bi bi-exclamation-triangle text-3xl mb-2"></i>
          <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
        </div>
      `;
      return;
    }

    currentPolicyDiv.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h5 class="text-lg font-medium text-gray-900 dark:text-white">${policy.name}</h5>
            <p class="text-sm text-gray-500">‡∏õ‡∏µ ${policy.year} | ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô ${policy.version || '1.0'}</p>
          </div>
          <span class="badge ${policy.isActive ? 'badge-success' : 'badge-warning'}">
            ${policy.isActive ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
          </span>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-2xl font-bold text-blue-600">${policy.policy?.annual?.days || 0}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</div>
          </div>
          <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
            <div class="text-2xl font-bold text-red-600">${policy.policy?.sick?.days || 0}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</div>
          </div>
          <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <div class="text-2xl font-bold text-yellow-600">${policy.policy?.personal?.days || 0}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</div>
          </div>
          <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
            <div class="text-2xl font-bold text-purple-600">${policy.policy?.special?.days || 0}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
          </div>
          <div class="text-center p-3 bg-pink-50 dark:bg-pink-900/20 rounded-lg">
            <div class="text-2xl font-bold text-pink-600">${policy.policy?.maternity?.days || 98}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î</div>
          </div>
          <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="text-2xl font-bold text-green-600">${policy.policy?.paternity?.days || 15}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">‡∏•‡∏≤‡∏ö‡∏¥‡∏î‡∏≤</div>
          </div>
        </div>

        <div class="mt-4 text-xs text-gray-500">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(policy.createdAt).toLocaleDateString('th-TH')} |
          ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(policy.updatedAt).toLocaleDateString('th-TH')}
        </div>
      </div>
    `;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢
  function updatePolicyStats(policy) {
    // This can be expanded to show policy usage statistics
    console.log('Policy stats updated for:', policy.name);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
  async function handleCreatePolicy(event) {
    event.preventDefault();

    const year = parseInt(document.getElementById('policyYear').value);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (currentPolicy && currentPolicy.year === year) {
      const confirmReplace = confirm(
        `‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year} ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n` +
        `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n` +
        `‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°: ${currentPolicy.name}\n` +
        `‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà`
      );

      if (!confirmReplace) {
        return;
      }
    }

    const formData = {
      name: document.getElementById('policyName').value,
      year: parseInt(document.getElementById('policyYear').value),
      policy: {
        annual: {
          days: parseInt(document.getElementById('annualDays').value),
          description: '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ'
        },
        sick: {
          days: parseInt(document.getElementById('sickDays').value),
          description: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå'
        },
        personal: {
          days: parseInt(document.getElementById('personalDays').value),
          description: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß'
        },
        special: {
          days: parseInt(document.getElementById('specialDays').value),
          description: '‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á ‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó'
        },
        maternity: {
          days: parseInt(document.getElementById('maternityDays').value),
          description: '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£'
        },
        paternity: {
          days: parseInt(document.getElementById('paternityDays').value),
          description: '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏î‡∏≤'
        }
      }
    };

    try {
      console.log('üìù Creating new leave policy:', formData);

      const res = await fetch(`${API_HOST}/api/hr/leave-policy`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
      }

      const result = await res.json();
      console.log('‚úÖ Policy created successfully:', result);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
      const message = result.data.replacedExisting ?
        '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°)' :
        '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';

      showNotification(message, 'success');

      // Refresh the policy display
      await fetchLeavePolicy();

    } catch (error) {
      console.error('‚ùå Create policy error:', error);
      showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô dropdown
  function populateEmployeeSelect() {
    const select = document.getElementById('allocationEmployeeSelect');

    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• allUsers ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
    if (allUsers && allUsers.length > 0) {
      select.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';
      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user._id || user.id;
        option.textContent = user.employee?.name || user.username || `User ID: ${user._id || user.id}`;
        select.appendChild(option);
      });
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Edit Allocation Modal
  function editAllocation(allocationId, userId) {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô dropdown
    populateEmployeeSelect();

    const allocation = allAllocations.find(a => a._id === allocationId || a.user?._id === userId);

    if (allocation && allocation._id) {
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      document.getElementById('editAllocationTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤';
      document.getElementById('allocationId').value = allocation._id;
      document.getElementById('allocationUserId').value = allocation.user._id;
      document.getElementById('allocationEmployeeSelect').value = allocation.user._id;
      document.getElementById('allocationYear').value = allocation.year;
      document.getElementById('allocationSick').value = allocation.allocation.sick;
      document.getElementById('allocationAnnual').value = allocation.allocation.annual;
      document.getElementById('allocationPersonal').value = allocation.allocation.personal;
      document.getElementById('allocationSpecial').value = allocation.allocation.special;

      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      document.getElementById('allocationEmployeeSelect').disabled = true;
    } else {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
      document.getElementById('editAllocationTitle').textContent = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà';
      document.getElementById('allocationId').value = '';
      document.getElementById('allocationUserId').value = userId || '';
      document.getElementById('allocationEmployeeSelect').value = userId || '';
      document.getElementById('allocationYear').value = new Date().getFullYear();
      document.getElementById('allocationSick').value = 30;
      document.getElementById('allocationAnnual').value = 10;
      document.getElementById('allocationPersonal').value = 3;
      document.getElementById('allocationSpecial').value = 5;

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      document.getElementById('allocationEmployeeSelect').disabled = false;
    }

    document.getElementById('editAllocationModal').classList.remove('hidden');
    document.getElementById('editAllocationModal').classList.add('flex');
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Edit Allocation Modal
  function closeEditAllocationModal() {
    document.getElementById('editAllocationModal').classList.add('hidden');
    document.getElementById('editAllocationModal').classList.remove('flex');
    document.getElementById('allocationForm').reset();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö Allocation
  async function deleteAllocation(allocationId) {
    if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    try {
      const res = await fetch(`${API_HOST}/api/hr/leave-allocations/${allocationId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) throw new Error('Failed to delete allocation');

      alert('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      await fetchLeavePolicy(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    } catch (err) {
      console.error('Delete allocation error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + err.message);
    }
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  document.addEventListener('DOMContentLoaded', async () => {
    if (!token) return window.location.href = '/login';

    checkDarkMode();
    checkSidebarState();
    await fetchUserProfile();      // ‚Üê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô
    await fetchUsersList();        // ‚Üê ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ currentUserId
    await fetchLeaveRequests();

    // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
    try {
      await fetchLeavePolicy();       // ‚Üê ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• leave policy
    } catch (error) {
      console.error('Failed to load leave policy, showing default:', error);
      displayDefaultPolicy();
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    setTimeout(() => {
      const currentPolicyYearEl = document.getElementById('currentPolicyYear');
      if (currentPolicyYearEl && currentPolicyYearEl.textContent.includes('‡∏õ‡∏µ -')) {
        console.log('üîÑ Policy data still not loaded after 3 seconds, showing default policy');
        displayDefaultPolicy();
      }
    }, 3000);

    setupEventListeners();

    document.querySelector(`.filter-status-item[data-status="all"]`)?.classList.add('active','font-semibold');
    document.querySelector(`.sort-leave-item[data-sort-by="createdAt"][data-sort-dir="desc"]`)?.classList.add('active','font-semibold');
  });

  async function fetchUsersList() {
    const sel = document.getElementById('employeeSelectModal');
  
    // Use localStorage directly if configured
    if (USE_LOCAL_STORAGE) {
      console.log('Using employee list from localStorage');
      allUsers = getLocalUsers();
      sel.innerHTML = '<option value="" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';
      allUsers.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u._id || u.id;
        opt.textContent = u.employee?.name || u.name || `User ID: ${u._id || u.id}`;
        sel.appendChild(opt);
      });
      return;
    }

    // API fetch for GMJ API
    try {
      console.log('Fetching users list from GMJ API');
      const res = await fetch(USERS_API_BASE, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
  
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('API endpoint not available');
      }
  
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.error || json.message || `Status: ${res.status}`);
  
      allUsers = json.data || [];
      sel.innerHTML = '<option value="" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';
      allUsers.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u._id || u.id;
        opt.textContent = u.employee?.name || u.name || `User ID: ${u._id || u.id}`;
        sel.appendChild(opt);
      });
    } catch (err) {
      console.error('Failed to fetch users list:', err);
      sel.innerHTML = '<option value="" disabled>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</option>';
      showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
    }
  }
  
  // Get real users from localStorage or employee data
  function getLocalUsers() {
    // First, try to get employees from payroll system
    let employees = localStorage.getItem('employees');
    if (employees) {
      try {
        const employeeList = JSON.parse(employees);
        return employeeList.map(emp => ({
          _id: emp.id || emp._id || `emp_${Date.now()}_${Math.random()}`,
          name: emp.name,
          employee: { name: emp.name },
          department: emp.department,
          position: emp.position
        }));
      } catch (e) {
        console.error('Error parsing employees from localStorage:', e);
      }
    }
  
    // Try to get users from sales system
    let salesUsers = [];
    const posTransactions = localStorage.getItem('pos_transactions');
    if (posTransactions) {
      try {
        const transactions = JSON.parse(posTransactions);
        const uniqueUsers = new Map();
  
        transactions.forEach(t => {
          if (t.employeeId && t.employeeName) {
            uniqueUsers.set(t.employeeId, {
              _id: t.employeeId,
              name: t.employeeName,
              employee: { name: t.employeeName },
              department: '‡∏Ç‡∏≤‡∏¢',
              branch: t.branchCode
            });
          }
        });
  
        salesUsers = Array.from(uniqueUsers.values());
      } catch (e) {
        console.error('Error parsing POS transactions:', e);
      }
    }
  
    // Get current user from localStorage
    const currentUserName = localStorage.getItem('userName');
    const currentUserId = localStorage.getItem('userId');
  
    if (currentUserName && !salesUsers.find(u => u._id === currentUserId)) {
      salesUsers.push({
        _id: currentUserId || 'current_user',
        name: currentUserName,
        employee: { name: currentUserName },
        department: 'HR'
      });
    }
  
    return salesUsers.length > 0 ? salesUsers : [];
  }

  async function fetchLeaveRequests() {
    const tableBody = document.getElementById('leaveTableBody');
    if(tableBody) tableBody.innerHTML =
      '<tr><td colspan="7" class="text-center p-6"><span class="loading loading-dots loading-lg"></span></td></tr>';
  
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('paginationControls').classList.add('hidden');

    // Use localStorage directly if configured
    if (USE_LOCAL_STORAGE) {
      console.log('Using localStorage for leave requests');
      allLeaveRequests = getLocalLeaveRequests();
      currentPage = 1;
      applyFiltersAndRender();
      updateLeaveStats();
  
      if(tableBody && allLeaveRequests.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-6 text-base">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</td></tr>`;
      }
      return;
    }

    // API fetch for GMJ API
    try {
      console.log('Fetching leave requests from GMJ API:', API_BASE);
      const res = await fetch(API_BASE, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
  
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        console.error('Invalid response type from API');
        throw new Error('API endpoint not available');
      }
  
      const json = await res.json();
      console.log('GMJ API Response:', json);
  
      if (!res.ok) {
        throw new Error(json.error || json.message || `Status: ${res.status}`);
      }
  
      // Handle GMJ API response format
      allLeaveRequests = json.data || json || [];
      console.log('Leave requests loaded:', allLeaveRequests.length);
  
      currentPage = 1;
      applyFiltersAndRender();
      updateLeaveStats();
    } catch (err) {
      console.error('Failed to fetch leave requests from API:', err);
      showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');

      // Show empty state instead of mock data
      allLeaveRequests = [];
      currentPage = 1;
      applyFiltersAndRender();
      updateLeaveStats();

      const tableBody = document.getElementById('leaveTableBody');
      if(tableBody) {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 p-6 text-base">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏î‡πâ: ${err.message}</td></tr>`;
      }
    }
  }
  
  // Get real leave requests from localStorage
  function getLocalLeaveRequests() {
    // Try to get real data from localStorage first
    let leaveRequests = localStorage.getItem('leave_requests');
  
    if (leaveRequests) {
      try {
        return JSON.parse(leaveRequests);
      } catch (e) {
        console.error('Error parsing leave requests from localStorage:', e);
      }
    }
  
    // If no real data exists, return empty array to start fresh
    return [];
  }
  
  // Save leave requests to localStorage
  function saveLeaveRequestsToStorage(requests) {
    try {
      localStorage.setItem('leave_requests', JSON.stringify(requests));
      localStorage.setItem('leave_requests_updated', new Date().toISOString());
    } catch (e) {
      console.error('Error saving leave requests to localStorage:', e);
    }
  }

  async function saveLeaveRequest() {
    const leaveId = document.getElementById('leaveRequestId').value;
    const selectedUserId = document.getElementById('employeeSelectModal').value;
  
    const saveButton = document.getElementById('btnSaveLeaveForm');
    const loadingSpinner = saveButton.querySelector('.loading-spinner');

    if (!selectedUserId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        return;
    }

    const payload = {
      userId: selectedUserId,
      leaveType: document.getElementById('leaveTypeModal').value,
      startDate: document.getElementById('startDateModal').value,
      endDate: document.getElementById('endDateModal').value,
      reason: document.getElementById('reasonModal').value.trim(),
    };

    if (!payload.leaveType || !payload.startDate || !payload.endDate || !payload.reason) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)');
      return;
    }
    if (new Date(payload.endDate) < new Date(payload.startDate)) {
      alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
      return;
    }

    if(loadingSpinner) loadingSpinner.classList.remove('hidden');
    saveButton.disabled = true;

    // For GMJ API
    const method = leaveId ? 'PUT' : 'POST';
    const url = leaveId ? `${API_BASE}/${leaveId}` : API_BASE;
  
    console.log('Sending leave request to GMJ API:', url, payload);

    try {
      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });
  
      // Check if API is available
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('API endpoint not available');
      }
  
      const json = await res.json();
      console.log('GMJ API save response:', json);
  
      if (!res.ok) throw new Error(json.error || json.message || `Status: ${res.status}`);
      alert(json.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      closeLeaveModal();
      await fetchLeaveRequests();
      await fetchLeaveBalance(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï leave balance ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
    } catch (err) {
      console.error('Error saving leave request:', err);
  
      // Fallback to localStorage when API is not available
      if (err.message.includes('API endpoint not available') || err.message.includes('Failed to fetch')) {
        try {
          // Get existing leave requests from localStorage
          let leaveRequests = localStorage.getItem('leave_requests');
          leaveRequests = leaveRequests ? JSON.parse(leaveRequests) : [];
  
          // Find user info for this request
          const selectedUser = allUsers.find(emp => (emp._id || emp.id) === selectedUserId);
  
          if (leaveId) {
            // Update existing request
            const index = leaveRequests.findIndex(r => (r._id || r.id) === leaveId);
            if (index !== -1) {
              leaveRequests[index] = {
                ...leaveRequests[index],
                ...payload,
                user: selectedUser || leaveRequests[index].user,
                updatedAt: new Date().toISOString()
              };
            }
          } else {
            // Create new request
            const newRequest = {
              _id: `leave_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              id: `leave_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              ...payload,
              user: selectedUser || { _id: selectedUserId, name: 'Unknown User' },
              status: 'pending',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            leaveRequests.push(newRequest);
          }
  
          // Save back to localStorage
          localStorage.setItem('leave_requests', JSON.stringify(leaveRequests));
  
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)');
          closeLeaveModal();
          await fetchLeaveRequests();
        } catch (localErr) {
          console.error('Error saving to localStorage:', localErr);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + localErr.message);
        }
      } else {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    } finally {
      if(loadingSpinner) loadingSpinner.classList.add('hidden');
      saveButton.disabled = false;
    }
  }

  async function updateLeaveStatus(id, statusAction) { // 'approve' or 'reject'
    const actionText = statusAction === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
    const newStatus = statusAction === 'approve' ? 'approved' : 'rejected';
  
    console.log(`Updating leave status via GMJ API: ${id} -> ${statusAction}`);
  
    try {
      const res = await fetch(`${API_BASE}/${id}/${statusAction}`, {
        method: 'PUT', // GMJ API uses PUT for updates
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
      });
  
      // Check if API is available
      const contentType = res.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('API endpoint not available - using localStorage');
      }
  
      if (!res.ok) {
          const errorData = await res.json().catch(() => ({ message: `Status ${res.status}`}));
          throw new Error(errorData.message || `Status ${res.status}`);
      }
      // const responseData = await res.json(); // If API returns data
      alert(`${actionText}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      await fetchLeaveRequests();
      await fetchLeaveBalance(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï leave balance ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
    } catch (err) {
      // Fallback to localStorage when API is not available
      if (err.message.includes('API endpoint not available') || err.message.includes('Failed to fetch')) {
        try {
          // Get existing leave requests from localStorage
          let leaveRequests = localStorage.getItem('leave_requests');
          leaveRequests = leaveRequests ? JSON.parse(leaveRequests) : [];
  
          // Find and update the request
          const index = leaveRequests.findIndex(r => (r._id || r.id) === id);
          if (index !== -1) {
            leaveRequests[index] = {
              ...leaveRequests[index],
              status: newStatus,
              updatedAt: new Date().toISOString(),
              approvedBy: newStatus === 'approved' ? localStorage.getItem('userName') : null,
              approvedAt: newStatus === 'approved' ? new Date().toISOString() : null,
              rejectedBy: newStatus === 'rejected' ? localStorage.getItem('userName') : null,
              rejectedAt: newStatus === 'rejected' ? new Date().toISOString() : null
            };
  
            // Save back to localStorage
            localStorage.setItem('leave_requests', JSON.stringify(leaveRequests));
  
            alert(`${actionText}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)`);
            await fetchLeaveRequests();
          } else {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
          }
        } catch (localErr) {
          console.error('Error updating in localStorage:', localErr);
          alert(`${actionText}‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${localErr.message}`);
        }
      } else {
        alert(`${actionText}‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
      }
    }
  }


  async function handleLeaveAction(action, id) {
    closeManageActionsModal(); // Close modal first
    const requestToHandle = allLeaveRequests.find(r => (r.id || r._id) === id);
    if (!requestToHandle) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠');
        return;
    }
    const employeeName = requestToHandle.user?.employee?.name || requestToHandle.user?.name || 'N/A';

    switch (action) {
      case 'view':
        alert(`‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ID: ${id}\n‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${employeeName}\n‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${requestToHandle.leaveType}\n‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(requestToHandle.startDate)} - ${formatDate(requestToHandle.endDate)}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${requestToHandle.reason}`);
        break;
      case 'approve':
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${employeeName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          await updateLeaveStatus(id, 'approve');
        }
        break;
      case 'reject':
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${employeeName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          await updateLeaveStatus(id, 'reject');
        }
        break;
      case 'edit':
        openEditLeaveModal(id);
        break;
      case 'delete':
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á ${employeeName} (ID: ${id}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
          try {
            console.log('Deleting leave request via GMJ API:', id);
            const res = await fetch(`${API_BASE}/${id}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
  
            // Check response
            if (!res.ok && res.status !== 204) {
              const contentType = res.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                const errorData = await res.json();
                throw new Error(errorData.message || `Failed to delete (${res.status})`);
              } else {
                throw new Error(`Failed to delete (${res.status})`);
              }
            }
  
            alert('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            await fetchLeaveRequests();
          } catch (err) {
            // Fallback to localStorage when API is not available
            if (err.message.includes('API endpoint not available') || err.message.includes('Failed to fetch')) {
              try {
                // Get existing leave requests from localStorage
                let leaveRequests = localStorage.getItem('leave_requests');
                leaveRequests = leaveRequests ? JSON.parse(leaveRequests) : [];
  
                // Remove the request
                const filteredRequests = leaveRequests.filter(r => (r._id || r.id) !== id);
  
                if (filteredRequests.length < leaveRequests.length) {
                  // Save back to localStorage
                  localStorage.setItem('leave_requests', JSON.stringify(filteredRequests));
                  alert('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)');
                  await fetchLeaveRequests();
                } else {
                  throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                }
              } catch (localErr) {
                console.error('Error deleting from localStorage:', localErr);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + localErr.message);
              }
            } else {
              console.error('Error deleting leave request:', err);
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + err.message);
            }
          }
        }
        break;
      case 'print':
        // Implement print functionality or a placeholder
        window.open(`/print/leave_form?id=${id}`, '_blank'); // Example
        // alert(`‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏≤ ID: ${id} (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ implement)`);
        break;
      default:
        console.warn('Unknown action:', action);
    }
  }

  function applyFiltersAndRender() {
    let filtered = [...allLeaveRequests];

    // Status Filter
    if (currentFilter.status && currentFilter.status !== 'all') {
      filtered = filtered.filter(req => req.status === currentFilter.status);
    }

    // Search Term Filter (Employee Name)
    if (currentFilter.searchTerm) {
      const term = currentFilter.searchTerm.toLowerCase();
      filtered = filtered.filter(req =>
        (req.user?.employee?.name || req.user?.name || '').toLowerCase().includes(term)
      );
    }

    // Date Range Filter
    if (currentFilter.dateFrom) {
      const fromDate = new Date(currentFilter.dateFrom);
      fromDate.setHours(0,0,0,0); // Start of the day
      filtered = filtered.filter(req => new Date(req.startDate) >= fromDate);
    }
    if (currentFilter.dateTo) {
      const toDate = new Date(currentFilter.dateTo);
      toDate.setHours(23, 59, 59, 999); // End of the day
      filtered = filtered.filter(req => new Date(req.startDate) <= toDate); // Usually filter by startDate within range
    }
  
    // Sorting
    filtered.sort((a, b) => {
      let valA, valB;
      // Handle nested properties for sorting, e.g., user.name
      if (currentSort.by.includes('.')) {
          const keys = currentSort.by.split('.');
          valA = keys.reduce((obj, key) => (obj && obj[key] !== 'undefined') ? obj[key] : '', a);
          valB = keys.reduce((obj, key) => (obj && obj[key] !== 'undefined') ? obj[key] : '', b);
      } else {
          valA = a[currentSort.by];
          valB = b[currentSort.by];
      }

      // Default to empty string if undefined, and convert to lowercase for string comparison
      valA = valA === undefined ? '' : String(valA).toLowerCase();
      valB = valB === undefined ? '' : String(valB).toLowerCase();
  
      // Specific handling for dates
      if (currentSort.by === 'createdAt' || currentSort.by === 'startDate' || currentSort.by === 'endDate') {
          valA = new Date(a[currentSort.by]);
          valB = new Date(b[currentSort.by]);
      }

      if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
      if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
      return 0;
    });

    renderLeaveRequests(filtered);
  }

  function renderLeaveRequests(requests) {
    const tbody = document.getElementById('leaveTableBody');
    const emptyState = document.getElementById('emptyState');
    if(!tbody || !emptyState) return;

    tbody.innerHTML = '';

    if (!requests || requests.length === 0) {
      emptyState.classList.remove('hidden');
      document.getElementById('paginationControls').classList.add('hidden');
      return;
    }
    emptyState.classList.add('hidden');
    document.getElementById('paginationControls').classList.remove('hidden');


    const paginatedRequests = paginate(requests, currentPage, itemsPerPage);

    paginatedRequests.forEach((req, index) => {
      const tr = document.createElement('tr');
      // tr.className = 'animate-fadeIn hover:bg-gray-50 dark:hover:bg-gray-700/50';
      // tr.style.animationDelay = `${index * 50}ms`; // Animation can be performance intensive

      const statusBadge = getStatusBadge(req.status);
      const employeeName = req.user?.employee?.name || req.user?.name || 'N/A';
      const employeeDepartment = req.user?.employee?.department || req.user?.department || 'N/A';
      const employeePhoto = resolvePhotoUrl(req.user?.employee?.photoUrl || req.user?.photoUrl); // Use resolvePhotoUrl

      tr.innerHTML = `
        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(req.createdAt)}</td>
        <td class="px-4 py-3">
          <div class="flex items-center">
            <div class="flex-shrink-0 h-8 w-8">
              <img class="h-8 w-8 rounded-full object-cover" src="${employeePhoto}" alt="${employeeName}">
            </div>
            <div class="ml-3">
              <div class="text-sm font-medium">${employeeName}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${employeeDepartment}</div>
            </div>
          </div>
        </td>
        <td class="px-4 py-3 text-sm"><span class="px-2 py-1 text-xs rounded-full ${getLeaveTypeBadge(req.leaveType)}">${req.leaveType || 'N/A'}</span></td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(req.startDate)}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDate(req.endDate)}</td>
        <td class="px-4 py-3 text-sm">${statusBadge}</td>
        <td class="px-4 py-3 text-center">
          <button data-action="open-manage-modal" data-id="${req._id || req.id}" class="btn btn-ghost btn-sm btn-circle text-gray-500 hover:text-blue-600 dark:hover:text-blue-400">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    renderPagination(requests.length, currentPage, itemsPerPage);
  }

  function paginate(items, page, perPage) {
    const start = (page - 1) * perPage;
    const end = start + perPage;
    return items.slice(start, end);
  }

  function renderPagination(totalItems, page, perPage) {
    const paginationControls = document.getElementById('paginationControls');
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationLinks = document.getElementById('paginationLinks');
    if(!paginationControls || !paginationInfo || !paginationLinks) return;

    paginationLinks.innerHTML = '';
    if (totalItems === 0) {
      paginationControls.classList.add('hidden');
      return;
    }
    paginationControls.classList.remove('hidden');

    const totalPages = Math.ceil(totalItems / perPage);
    const startItem = (page - 1) * perPage + 1;
    const endItem = Math.min(startItem + perPage - 1, totalItems);
    paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    const createPageButton = (content, pageNum, isDisabled = false, isActive = false) => {
        const button = document.createElement('button');
        button.innerHTML = content;
        button.className = `btn btn-sm ${isActive ? 'btn-active btn-primary' : 'btn-outline'}`;
        if (isDisabled) {
            button.classList.add('btn-disabled');
        } else {
            button.addEventListener('click', () => {
                currentPage = pageNum;
                applyFiltersAndRender();
            });
        }
        return button;
    };
  
    paginationLinks.appendChild(createPageButton('<i class="bi bi-chevron-left"></i>', page > 1 ? page - 1 : 1, page === 1));

    let pagesToShow = [];
    if (totalPages <= 7) { // Show all pages if 7 or less
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else {
        pagesToShow.push(1);
        if (page > 3) pagesToShow.push('...');
  
        let startPage = Math.max(2, page - 1);
        let endPage = Math.min(totalPages - 1, page + 1);

        if (page <= 3) { // Near the beginning
            startPage = 2;
            endPage = Math.min(4, totalPages -1);
        } else if (page >= totalPages - 2) { // Near the end
            startPage = Math.max(2, totalPages - 3);
            endPage = totalPages - 1;
        }
        // For middle pages, page-1, page, page+1 is fine

        for (let i = startPage; i <= endPage; i++) pagesToShow.push(i);
  
        if (page < totalPages - 2 && endPage < totalPages -1) pagesToShow.push('...');
        if (totalPages > 1) pagesToShow.push(totalPages); // Always show last page if more than 1 page
    }
  
    // Remove duplicate '...' and ensure '...' are not adjacent to actual page numbers they'd replace
    pagesToShow = pagesToShow.filter((item, index, self) => {
        if (item === '...') {
            return (index === 0 || self[index-1] !== '...') && // Not first and prev is not '...'
                   (index === self.length -1 || self[index+1] !== '...') && // Not last and next is not '...'
                   (typeof self[index-1] === 'number' && typeof self[index+1] === 'number' && self[index+1] - self[index-1] > 1); // Gap exists
        }
        return true;
    });


    pagesToShow.forEach(p => {
        if (p === '...') {
             const disabledBtn = document.createElement('button');
             disabledBtn.className = 'btn btn-sm btn-disabled';
             disabledBtn.textContent = '...';
             paginationLinks.appendChild(disabledBtn);
        } else {
            paginationLinks.appendChild(createPageButton(p, p, false, p === page));
        }
    });

    paginationLinks.appendChild(createPageButton('<i class="bi bi-chevron-right"></i>', page < totalPages ? page + 1 : totalPages, page === totalPages));
  }


  function updateLeaveStats() {
    const pending = allLeaveRequests.filter(r => r.status === 'pending').length;
    const approved = allLeaveRequests.filter(r => r.status === 'approved').length;
    const rejected = allLeaveRequests.filter(r => r.status === 'rejected').length;
    document.getElementById('leaveStatsPending').textContent = pending;
    document.getElementById('leaveStatsApproved').textContent = approved;
    document.getElementById('leaveStatsRejected').textContent = rejected;
  }

  function getStatusBadge(status) {
    status = (status || '').toLowerCase();
    switch (status) {
      case 'pending':
        return `<span class="badge badge-warning gap-1 text-xs"><i class="bi bi-hourglass-split"></i>‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>`;
      case 'approved':
        return `<span class="badge badge-success gap-1 text-xs"><i class="bi bi-check-circle"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>`;
      case 'rejected':
        return `<span class="badge badge-error gap-1 text-xs"><i class="bi bi-x-circle"></i>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
      default:
        return `<span class="badge badge-ghost gap-1 text-xs">${status || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}</span>`;
    }
  }

  function getLeaveTypeBadge(leaveType) {
    leaveType = (leaveType || '').toLowerCase();
    if (leaveType.includes('‡∏õ‡πà‡∏ß‡∏¢') || leaveType === 'sick') return 'badge-secondary';
    if (leaveType.includes('‡∏Å‡∏¥‡∏à') || leaveType === 'personal') return 'badge-info';
    if (leaveType.includes('‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô') || leaveType === 'vacation') return 'badge-accent';
    return 'badge-ghost';
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      // Format to DD/MM/YYYY (Thai Buddhist Era)
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear() + 543;
      return `${day}/${month}/${year}`;
    } catch (e) {
      console.warn('Invalid date for formatting:', dateString);
      return 'Invalid Date';
    }
  }

  function setupEventListeners() {
    document.getElementById('btnToggleMenu')?.addEventListener('click', () => {
      const sb   = document.getElementById('sidebar');
      const mc   = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      sb.classList.toggle('-translate-x-64');            // ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå sidebar
      if (mc) {
        mc.classList.toggle('ml-64');
        mc.classList.toggle('ml-0');
      }
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    });
    document.getElementById('menuToggle')?.addEventListener('click', () => {
      const sb   = document.getElementById('sidebar');
      const mc   = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      sb.classList.toggle('-translate-x-64');
      if (mc) {
        mc.classList.toggle('ml-64');
        mc.classList.toggle('ml-0');
      }
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    });
    document.getElementById('btnToggleDark')?.addEventListener('click', toggleDarkMode);
    document.getElementById('btnLogoutSidebar')?.addEventListener('click', () => logoutUser());

    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      currentFilter.searchTerm = e.target.value;
      currentPage = 1;
      applyFiltersAndRender();
    });
    document.getElementById('btnAddLeave')?.addEventListener('click', openAddLeaveModal);
    document.getElementById('btnResetFilters')?.addEventListener('click', resetAllFilters);

    document.querySelectorAll('.filter-status-item').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelectorAll('.filter-status-item').forEach(i => i.classList.remove('active', 'font-semibold'));
        this.classList.add('active', 'font-semibold');
        currentFilter.status = this.dataset.status;
        currentPage = 1;
        applyFiltersAndRender();
        this.closest('.dropdown')?.removeAttribute('open'); // DaisyUI v3+ way to close
        if (document.activeElement) document.activeElement.blur(); // General way
      });
    });

    document.querySelectorAll('.sort-leave-item').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelectorAll('.sort-leave-item').forEach(i => i.classList.remove('active', 'font-semibold'));
        this.classList.add('active', 'font-semibold');
        currentSort.by = this.dataset.sortBy;
        currentSort.dir = this.dataset.sortDir;
        currentPage = 1;
        applyFiltersAndRender();
        this.closest('.dropdown')?.removeAttribute('open');
        if (document.activeElement) document.activeElement.blur();
      });
    });

    document.getElementById('btnApplyDateFilter')?.addEventListener('click', () => {
      currentFilter.dateFrom = document.getElementById('dateFrom').value;
      currentFilter.dateTo = document.getElementById('dateTo').value;
      currentPage = 1;
      applyFiltersAndRender();
      document.getElementById('btnFilterDateRange').closest('.dropdown')?.removeAttribute('open');
      if (document.activeElement) document.activeElement.blur();
    });

    document.getElementById('leaveTableBody').addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action="open-manage-modal"]');
      if (button) {
        const id = button.dataset.id;
        openManageActionsModal(id);
      }
    });

    document.getElementById('btnCloseLeaveModal')?.addEventListener('click', closeLeaveModal);
    document.getElementById('btnCancelLeaveForm')?.addEventListener('click', closeLeaveModal);
    document.getElementById('leaveForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      await saveLeaveRequest();
    });

    document.getElementById('btnCloseManageActionsModal')?.addEventListener('click', closeManageActionsModal);
    document.getElementById('manageActionsModalBody').addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (button) {
            const action = button.dataset.action;
            if (currentLeaveIdForModal) {
                handleLeaveAction(action, currentLeaveIdForModal);
            }
            // closeManageActionsModal(); // Moved inside handleLeaveAction or handled by specific actions
        }
    });

    // Leave Policy Management Event Listeners
    document.getElementById('openPolicyModal')?.addEventListener('click', openPolicyModal);
    document.getElementById('btnClosePolicyModal')?.addEventListener('click', closePolicyModal);
    document.getElementById('btnCreatePolicy')?.addEventListener('click', openCreatePolicyForm);
    document.getElementById('btnCloseEditAllocationModal')?.addEventListener('click', closeEditAllocationModal);
    document.getElementById('addNewAllocationBtn')?.addEventListener('click', () => {
      editAllocation('', ''); // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    });

    // Employee Search in Allocation Modal
    document.getElementById('employeeSearchInput')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      filteredAllocations = allAllocations.filter(allocation => {
        const user = allocation.user;
        const emp = user?.employee;
        return (emp?.name || '').toLowerCase().includes(searchTerm) ||
               (user?.email || '').toLowerCase().includes(searchTerm) ||
               (emp?.department || '').toLowerCase().includes(searchTerm);
      });
      updateAllocationTable();
    });

    // Allocation Form Submission
    document.getElementById('allocationForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const allocationId = document.getElementById('allocationId').value;
      const userId = document.getElementById('allocationUserId').value ||
                     document.getElementById('allocationEmployeeSelect').value;
      const year = document.getElementById('allocationYear').value;
      const allocation = {
        annual: parseInt(document.getElementById('allocationAnnual').value),
        sick: parseInt(document.getElementById('allocationSick').value),
        personal: parseInt(document.getElementById('allocationPersonal').value),
        special: parseInt(document.getElementById('allocationSpecial').value)
      };

      if (!userId) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        return;
      }

      try {
        const method = allocationId ? 'PUT' : 'POST';
        const url = allocationId ?
          `${API_HOST}/api/hr/leave-allocations/${allocationId}` :
          `${API_HOST}/api/hr/leave-allocations`;

        const payload = allocationId ? { allocation } : { userId, year, allocation };

        const res = await fetch(url, {
          method,
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to save allocation');
        }

        const result = await res.json();
        alert(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

        closeEditAllocationModal();
        await fetchLeavePolicy(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      } catch (err) {
        console.error('Save allocation error:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      }
    });
  }

  function resetAllFilters() {
    currentFilter = { status: 'all', dateFrom: '', dateTo: '', searchTerm: '' };
    currentSort = { by: 'createdAt', dir: 'desc' };
    currentPage = 1;
  
    const searchInput = document.getElementById('searchInput');
    if(searchInput) searchInput.value = '';
    const dateFromInput = document.getElementById('dateFrom');
    if(dateFromInput) dateFromInput.value = '';
    const dateToInput = document.getElementById('dateTo');
    if(dateToInput) dateToInput.value = '';
  
    document.querySelectorAll('.filter-status-item.active').forEach(i => i.classList.remove('active', 'font-semibold'));
    document.querySelector('.filter-status-item[data-status="all"]')?.classList.add('active', 'font-semibold');
  
    document.querySelectorAll('.sort-leave-item.active').forEach(i => i.classList.remove('active', 'font-semibold'));
    document.querySelector('.sort-leave-item[data-sort-by="createdAt"][data-sort-dir="desc"]')?.classList.add('active', 'font-semibold');

    applyFiltersAndRender();
  }

  function toggleMenu() {
    const sb   = document.getElementById('sidebar');
    const mc   = document.getElementById('mainContent');
    const icon = document.querySelector('#btnToggleMenu i');

    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå sidebar ‡∏î‡πâ‡∏ß‡∏¢ translate-x
    sb.classList.toggle('-translate-x-64');
    // ‡∏õ‡∏£‡∏±‡∏ö margin-left ‡∏Ç‡∏≠‡∏á main content
    if (mc) {
      mc.classList.toggle('ml-64');
      mc.classList.toggle('ml-0');
    }
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£
    icon.classList.toggle('bi-chevron-left');
    icon.classList.toggle('bi-chevron-right');
  }

  function checkSidebarState() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    if (sidebar) {
        const isSidebarStoredCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        const icon = document.querySelector('#btnToggleMenu i');
        if (isSidebarStoredCollapsed) {
            sidebar.classList.add('-translate-x-64');
            if (mainContent) {
              mainContent.classList.remove('ml-64');
              mainContent.classList.add('ml-0');
            }
            if (icon) icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        } else {
            sidebar.classList.remove('-translate-x-64');
            if (mainContent) {
              mainContent.classList.remove('ml-0');
              mainContent.classList.add('ml-64');
            }
             if (icon) icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
        }
    }
  }

  function setDarkMode(isDark) {
    const htmlElement = document.documentElement;
    htmlElement.classList.toggle('dark', isDark);
    // For DaisyUI, setting the data-theme attribute is important
    htmlElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    const label = document.getElementById('darkModeLabel');
    const iconElement = document.querySelector('#btnToggleDark i');
  
    if (label) label.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    if (iconElement) {
        iconElement.className = isDark ? 'bi bi-sun text-xl text-yellow-400' : 'bi bi-moon text-xl text-slate-600';
    }
  }

  function toggleDarkMode() {
    const isDarkNow = document.documentElement.classList.contains('dark');
    setDarkMode(!isDarkNow); // Toggle to the opposite state
  }

  function checkDarkMode() {
    // Check localStorage first, then system preference
    const storedDarkMode = localStorage.getItem('darkMode');
    let initialIsDark;
    if (storedDarkMode !== null) {
        initialIsDark = storedDarkMode === 'true';
    } else {
        initialIsDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    setDarkMode(initialIsDark);
  }

  function logoutUser(showAlert = true) {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userId');
    localStorage.removeItem('userInfo'); // Clear specific user info
    // Optionally clear sidebar and dark mode preferences on logout
    // localStorage.removeItem('sidebarCollapsed');
    // localStorage.removeItem('darkMode');
    if (showAlert) alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    window.location.href = '/login'; // Ensure this is your login page
  }

  function openAddLeaveModal() {
    document.getElementById('leaveModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤';
    const form = document.getElementById('leaveForm');
    if(form) form.reset();
    const leaveRequestIdInput = document.getElementById('leaveRequestId');
    if(leaveRequestIdInput) leaveRequestIdInput.value = '';
  
    const employeeSelect = document.getElementById('employeeSelectModal');
    if (employeeSelect && currentUserId) { // Pre-select current user
        employeeSelect.value = currentUserId;
    } else if (employeeSelect) {
        employeeSelect.value = ''; // Default to no selection if currentUserId is not available
    }

    document.getElementById('leaveModal').classList.remove('hidden');
    document.getElementById('leaveModal').classList.add('flex');
  }

  async function openEditLeaveModal(leaveId) {
    const request = allLeaveRequests.find(r => (r._id || r.id) === leaveId);
    if (!request) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤');
      return;
    }
    document.getElementById('leaveModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏≤';
    const form = document.getElementById('leaveForm');
    if(form) form.reset();
  
    const leaveRequestIdInput = document.getElementById('leaveRequestId');
    if(leaveRequestIdInput) leaveRequestIdInput.value = leaveId;

    // Ensure user ID is correctly referenced
    const userIdToSelect = request.user?._id || request.user; // request.user might be just an ID or an object
    const employeeSelect = document.getElementById('employeeSelectModal');
    if(employeeSelect) employeeSelect.value = userIdToSelect || '';

    const leaveTypeModal = document.getElementById('leaveTypeModal');
    if(leaveTypeModal) leaveTypeModal.value = request.leaveType || 'sick';
  
    const startDateModal = document.getElementById('startDateModal');
    if(startDateModal) startDateModal.value = request.startDate ? request.startDate.split('T')[0] : '';
  
    const endDateModal = document.getElementById('endDateModal');
    if(endDateModal) endDateModal.value = request.endDate ? request.endDate.split('T')[0] : '';
  
    const reasonModal = document.getElementById('reasonModal');
    if(reasonModal) reasonModal.value = request.reason || '';

    document.getElementById('leaveModal').classList.remove('hidden');
    document.getElementById('leaveModal').classList.add('flex');
  }

  function closeLeaveModal() {
    document.getElementById('leaveModal').classList.add('hidden');
    document.getElementById('leaveModal').classList.remove('flex');
  }

  function openManageActionsModal(leaveId) {
    currentLeaveIdForModal = leaveId;
    const request = allLeaveRequests.find(r => (r._id || r.id) === leaveId);
    if (!request) {
        console.error('Request not found for ID in openManageActionsModal:', leaveId);
        return;
    }

    const modalBody = document.getElementById('manageActionsModalBody');
    if(!modalBody) return;
    modalBody.innerHTML = '';

    const employeeName = request.user?.employee?.name || request.user?.name || 'N/A';
    const modalTitle = document.getElementById('manageActionsModalTitle');
    if(modalTitle) modalTitle.textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ (${employeeName.substring(0,15)}${employeeName.length > 15 ? '...' : ''})`;

    const createActionButton = (action, text, iconClass, extraClasses = '') => {
        const button = document.createElement('button');
        button.dataset.action = action;
        // DaisyUI button classes
        button.className = `btn btn-sm w-full my-1 ${extraClasses}`;
        // Align icon and text using flex
        button.innerHTML = `<span class="flex items-center justify-start w-full"><i class="bi ${iconClass} mr-2"></i>${text}</span>`;
        modalBody.appendChild(button);
    };

    createActionButton('view', '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'bi-eye', 'btn-outline');
    if (request.status === 'pending') {
        createActionButton('approve', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'bi-check2-circle', 'btn-outline btn-success');
        createActionButton('reject', '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'bi-x-circle', 'btn-outline btn-error');
        createActionButton('edit', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'bi-pencil', 'btn-outline btn-info');
    }
    if (request.status === 'approved') { // Typically, only print is available after approval
        createActionButton('print', '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏≤', 'bi-printer', 'btn-outline');
    }
    // Allow delete for most statuses, or adjust based on your business rules
    createActionButton('delete', '‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'bi-trash', 'btn-outline btn-warning');

    document.getElementById('manageActionsModal').classList.remove('hidden');
    document.getElementById('manageActionsModal').classList.add('flex');
  }

  function closeManageActionsModal() {
    document.getElementById('manageActionsModal').classList.add('hidden');
    document.getElementById('manageActionsModal').classList.remove('flex');
    currentLeaveIdForModal = null;
  }
</script>

<!-- Leave Policy Management Modal -->
<div id="policyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden items-center justify-center z-[100] p-4">
  <div class="modal-box w-full max-w-4xl dark:bg-gray-800">
    <div class="flex justify-between items-center pb-3 border-b dark:border-gray-700">
      <h3 class="text-xl font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
      <button id="btnClosePolicyModal" class="btn btn-sm btn-circle btn-ghost">‚úï</button>
    </div>
    <div class="pt-4">
      <div id="policyContent" class="space-y-4">
        <div class="flex justify-between items-center">
          <h4 class="text-lg font-medium">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
          <button id="btnCreatePolicy" class="btn btn-primary btn-sm">
            <i class="bi bi-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>

        <div id="currentPolicy" class="bg-base-200 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-center text-gray-500 py-8">
            <i class="bi bi-clock-history text-3xl mb-2"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤...</p>
          </div>
        </div>

        <div id="policyHistory" class="mt-6">
          <h5 class="text-md font-medium mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢</h5>
          <div id="policyHistoryList" class="space-y-2">
            <!-- History items will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
