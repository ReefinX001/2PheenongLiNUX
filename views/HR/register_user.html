<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] },
          colors: {
            primary: '#5a23c8',
          }
        }
      },
      daisyui: { themes: ['light'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- animate.css for Loading Effects -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
    }
    .stats-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.75rem;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 0.375rem;
      background-color: #f9fafb;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    .checkbox-container:hover {
      background-color: #f3f4f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-color: #e5e7eb;
    }
    .checkbox-container input {
      margin-right: 0.5rem;
    }
    .checkbox-container.flex-col {
      align-items: flex-start;
    }
    /* ‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠ radio button ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
    .checkbox-container:has(input[type="radio"]:checked) {
      background-color: #dbeafe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö browser ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö :has() */
    .checkbox-container.selected {
      background-color: #dbeafe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px #3b82f6;
    }
    /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal */
    .modal-box {
      max-width: 800px;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö toggle switch */
    .toggle-status {
      opacity: 1;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
    }
    .toggle-status.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
    #notification-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .notification {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      color: white;
      display: flex;
      align-items: center;
      transform: translateX(0);
      opacity: 1;
      transition: all 0.3s ease;
    }
    .notification.hide {
      transform: translateX(100%);
      opacity: 0;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    .dark .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm py-3 px-4 flex justify-between items-center">
    <div class="flex items-center">
      <div class="text-primary font-semibold text-xl">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
   
    </div>
    <div class="flex items-center">
      <div class="relative mr-4">
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="input input-bordered w-64 pl-10 h-10" />
        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
      </div>
      <div class="relative mr-4">
        <i class="fas fa-bell text-gray-600"></i>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
      </div>
      <div class="avatar">
        <div class="w-10 rounded-full">
          
        </div>
      </div>
    </div>
  </header>

  <div class="flex">
    <!-- Main Content (now with no sidebar) -->
    <main class="flex-1 p-6">
      <!-- Page Header -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold flex items-center">
          <i class="fas fa-users text-primary mr-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        </h1>
        <div class="flex gap-2">
          <button class="btn btn-outline">
            <i class="fas fa-file-export mr-1"></i> ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
          
            
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="stats-card flex items-center">
          <div class="flex-1">
            <h3 class="text-3xl font-bold">2</h3>
            <p class="text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <p class="text-blue-500 text-sm mt-1">
              <i class="fas fa-sort-amount-down mr-1"></i>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô
            </p>
          </div>
          <div class="bg-indigo-100 p-3 rounded-lg">
            <i class="fas fa-users text-indigo-500 text-2xl"></i>
          </div>
        </div>
        
        <div class="stats-card flex items-center">
          <div class="flex-1">
            <h3 id="rolesCount" class="text-3xl font-bold">-</h3>
            <p class="text-gray-600">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            <p id="rolesSource" class="text-gray-500 text-sm mt-1">
              <i class="fas fa-sync-alt mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </p>
          </div>
          <div class="bg-pink-100 p-3 rounded-lg">
            <i class="fas fa-user-tag text-pink-500 text-2xl"></i>
          </div>
        </div>
        
        <div class="stats-card flex items-center">
          <div class="flex-1">
            <h3 class="text-3xl font-bold">6</h3>
            <p class="text-gray-600">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <p class="text-blue-500 text-sm mt-1"><i class="fas fa-plus mr-1"></i>0 ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg">
            <i class="fas fa-building text-blue-500 text-2xl"></i>
          </div>
        </div>
        
        <div class="stats-card flex items-center">
          <div class="flex-1">
            <h3 class="text-3xl font-bold">0</h3>
            <p class="text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</p>
            <p class="text-red-500 text-sm mt-1"><i class="fas fa-arrow-down mr-1"></i>0 ‡∏£‡∏≤‡∏¢ ‡∏•‡∏î‡∏•‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</p>
          </div>
          <div class="bg-red-100 p-3 rounded-lg">
            <i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Information Alert -->


      <!-- API Status Alert -->
      <div id="apiStatusAlert" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-red-400"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-red-700">
              <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API:</strong> <span id="apiStatusMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
            </p>
            <div id="troubleshootingTips" class="mt-3 text-xs text-red-600 bg-red-100 p-2 rounded hidden">
              <strong>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong><br>
              üîÑ <strong>Error 502:</strong> ‡∏£‡∏≠ 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà"<br>
              üîÑ <strong>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"<br>
              üîÑ <strong>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            </div>
          </div>
        </div>
      </div>

      <!-- Registration Form Card -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6 flex items-center">
          <i class="fas fa-user-plus text-primary mr-2"></i>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </h2>
        
        <form id="registerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Checkbox ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Virtual Employee -->
          <div class="form-control w-full md:col-span-2">
            <div class="flex items-center gap-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <label class="label cursor-pointer flex items-center gap-2">
                <input type="checkbox" id="isVirtualEmployee" class="checkbox checkbox-warning" />
                <span class="label-text font-medium text-yellow-800">
                  <i class="fas fa-crown mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (CEO/Admin) - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </span>
              </label>
            </div>
          </div>

          <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
          <div class="form-control w-full" id="employeeSelectDiv">
            <label class="label">
              <span class="label-text font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
              <button type="button" id="reloadEmployeesBtn" class="btn btn-xs btn-outline" onclick="reloadEmployees()">
                <i class="fas fa-sync-alt mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
              </button>
            </label>
            <select id="employeeSelect" name="employee" required class="select select-bordered w-full">
              <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
            </select>
          </div>

          <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Virtual Employee -->
          <div id="virtualEmployeeFields" class="form-control w-full md:col-span-2 hidden">
            <div class="bg-gray-50 p-4 rounded-lg border">
              <h3 class="text-lg font-medium mb-4 text-gray-700">
                <i class="fas fa-user-tie mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                  <label class="label"><span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></span></label>
                  <input type="text" id="virtualName" name="virtualName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" 
                         class="input input-bordered w-full"/>
                </div>
                <div class="form-control">
                  <label class="label"><span class="label-text font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span class="text-red-500">*</span></span></label>
                  <input type="email" id="virtualEmail" name="virtualEmail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ceo@company.com" 
                         class="input input-bordered w-full"/>
                </div>
                <div class="form-control">
                  <label class="label"><span class="label-text font-medium">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span></label>
                  <input type="text" id="virtualPosition" name="virtualPosition" placeholder="‡πÄ‡∏ä‡πà‡∏ô CEO, ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£" 
                         class="input input-bordered w-full" value="CEO"/>
                </div>
                <div class="form-control">
                  <label class="label"><span class="label-text font-medium">‡πÅ‡∏ú‡∏ô‡∏Å</span></label>
                  <input type="text" id="virtualDepartment" name="virtualDepartment" placeholder="‡πÄ‡∏ä‡πà‡∏ô Management" 
                         class="input input-bordered w-full" value="Management"/>
                </div>
                <div class="form-control">
                  <label class="label"><span class="label-text font-medium">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span></label>
                  <input type="tel" id="virtualPhone" name="virtualPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" 
                         class="input input-bordered w-full"/>
                </div>
              </div>
              
              <!-- Image Upload Section -->
              <div class="mt-6 border-t pt-4">
                <h4 class="text-md font-medium mb-4 text-gray-700">
                  <i class="fas fa-camera mr-2"></i>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                </h4>
                <div class="flex justify-center">
                  <!-- Profile Image -->
                  <div class="form-control">
                    <label class="label"><span class="label-text font-medium">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></label>
                    <div class="flex flex-col items-center">
                      <div class="avatar mb-3">
                        <div class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                          <img id="virtualProfilePreview" src="https://via.placeholder.com/150/e2e8f0/64748b?text=Profile" 
                               alt="Profile Preview" class="object-cover"/>
                        </div>
                      </div>
                      <input type="file" id="virtualProfileImage" name="virtualProfileImage" 
                             accept="image/*" class="file-input file-input-bordered file-input-sm w-full max-w-xs"
                             onchange="previewVirtualImage(this, 'virtualProfilePreview')"/>
                      <span class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Username -->
          <div class="form-control w-full">
            <label class="label"><span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</span></label>
            <input type="text" name="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required
                 class="input input-bordered w-full"/>
          </div>
          
          <!-- Password -->
          <div class="form-control w-full">
            <label class="label"><span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</span></label>
            <input type="password" name="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required
                 class="input input-bordered w-full"/>
          </div>
          
          <!-- Role (Changed to Checkboxes) -->
          <div class="form-control w-full md:col-span-2">
            <label class="label">
              <span class="label-text font-medium">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (Role) <span class="text-red-500">*</span></span>
              <div class="flex gap-2">
                <button type="button" id="reloadRolesBtn" class="btn btn-xs btn-outline" onclick="reloadRoles()">
                  <i class="fas fa-sync-alt mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                </button>
                <button type="button" id="useDefaultRolesBtn" class="btn btn-xs btn-outline btn-warning" onclick="useDefaultRoles()">
                  <i class="fas fa-list mr-1"></i>‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                </button>
                <button type="button" id="manageRolesBtn" class="btn btn-xs btn-primary" onclick="openRoleManagementModal()">
                  <i class="fas fa-cog mr-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
                </button>
              </div>
            </label>
            <div id="roleCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
              <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
              <p class="text-gray-400 text-center p-2 col-span-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
          </div>
          
          <!-- Allowed Pages (Changed to Checkboxes) -->
          <div id="pagesDiv" class="form-control w-full md:col-span-2">
            <label class="label"><span class="label-text font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</span></label>
            <div id="pagesCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
              <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
            </div>
          </div>
          
          <!-- Check-in Branches (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô) -->
          <div id="checkinBranchesDiv" class="form-control w-full md:col-span-2">
            <label class="label">
              <span class="label-text font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ <span class="text-red-500">*</span></span>
              <button type="button" id="reloadBranchesBtn" class="btn btn-xs btn-outline" onclick="reloadBranches()">
                <i class="fas fa-sync-alt mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
              </button>
            </label>
            <div id="checkinBranchCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
              <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
            </div>
            <p class="text-xs text-gray-500 mt-1">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô-‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡πÑ‡∏î‡πâ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤)</p>
          </div>
          

          
          <div class="md:col-span-2 flex justify-end mt-4">
            <button type="button" class="btn btn-outline mr-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-primary px-6">
              <i class="fas fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>
        </form>
      </div>

      <!-- Example User Table (Just for UI demonstration) -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
        
        <!-- Filter Section -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3">
            <!-- Role Filter -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</span>
              </label>
              <select id="roleFilter" class="select select-sm select-bordered w-full">
                <option value="all">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
              </select>
            </div>
            
            <!-- Branch Filter -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">‡∏™‡∏≤‡∏Ç‡∏≤</span>
              </label>
              <select id="branchFilter" class="select select-sm select-bordered w-full">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
              </select>
            </div>
            
            <!-- Status Filter -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
              </label>
              <select id="statusFilter" class="select select-sm select-bordered w-full">
                <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                <option value="inactive">‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
              </select>
            </div>

            <!-- Sort Filter -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</span>
              </label>
              <select id="sortFilter" class="select select-sm select-bordered w-full">
                <option value="name-asc">‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ / A-Z</option>
                <option value="name-desc">‡∏ä‡∏∑‡πà‡∏≠ ‡∏Æ-‡∏Å / Z-A</option>
                <option value="username-asc">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å-‡∏Æ / A-Z</option>
                <option value="username-desc">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Æ-‡∏Å / Z-A</option>
                <option value="role">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ‡∏Å-‡∏Æ / A-Z</option>
              </select>
            </div>
            
            <!-- Search -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
              </label>
              <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô..." 
                     class="input input-sm input-bordered w-full" />
            </div>
            
            <!-- Filter Button -->
            <div class="form-control">
              <label class="label">
                <span class="label-text text-sm font-medium">&nbsp;</span>
              </label>
              <button id="filterBtn" class="btn btn-sm btn-primary">
                <i class="fas fa-filter mr-1"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
          
          <!-- Reset Filter -->
          <div class="flex justify-end">
            <button id="resetFilterBtn" class="btn btn-xs btn-outline">
              <i class="fas fa-undo mr-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
            </button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table id="usersTable" class="table w-full">
            <thead>
              <tr>
                <th>
                  <label>
                    <input type="checkbox" class="checkbox" />
                  </label>
                </th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                <th>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</th>
                <th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              <!-- Cleared sample rows -->
            </tbody>
          </table>
          <!-- Pagination -->
          <div class="py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">‡πÅ‡∏™‡∏î‡∏á</span>
              <select id="limitSelect" class="select select-xs select-bordered">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</span>
            </div>
            <div class="text-sm text-gray-500">
              <span id="paginationInfo">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏ñ‡∏∂‡∏á 0 ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="btn-group">
              <button id="prevPageBtn" class="btn btn-sm btn-disabled">¬´</button>
              <span id="currentPageSpan" class="btn btn-sm btn-active">1</span>
              <button id="nextPageBtn" class="btn btn-sm btn-disabled">¬ª</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
  <input type="checkbox" id="role-management-modal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box max-w-6xl">
      <h3 class="font-bold text-xl mb-6 flex items-center">
        <i class="fas fa-user-tag text-primary mr-2"></i>
        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      </h3>
      
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex gap-2">
          <button onclick="resetToDefaultRoles()" class="btn btn-outline btn-sm" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">
            <i class="fas fa-undo mr-1"></i>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
          </button>
          <button onclick="syncAllUsers()" class="btn btn-outline btn-sm btn-info" title="Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà">
            <i class="fas fa-sync-alt mr-1"></i>Sync ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </button>
          <button onclick="exportRoles()" class="btn btn-outline btn-sm" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó">
            <i class="fas fa-download mr-1"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
          </button>
        </div>
        <button onclick="openAddRoleModal()" class="btn btn-primary btn-sm">
          <i class="fas fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
      
      <!-- Roles Summary -->
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
          <div>
            <div id="totalRolesCount" class="text-2xl font-bold text-blue-600">-</div>
            <div class="text-sm text-gray-600">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div>
            <div id="defaultRolesCount" class="text-2xl font-bold text-yellow-600">-</div>
            <div class="text-sm text-gray-600">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
          </div>
          <div>
            <div id="customRolesCount" class="text-2xl font-bold text-green-600">-</div>
            <div class="text-sm text-gray-600">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</div>
          </div>
          <div>
            <div id="adminRolesCount" class="text-2xl font-bold text-purple-600">-</div>
            <div class="text-sm text-gray-600">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</div>
          </div>
        </div>
      </div>
      
      <!-- Roles Grid -->
      <div id="rolesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
      </div>
      
      <div class="modal-action">
        <button type="button" class="btn btn-outline" onclick="closeRoleManagementModal()">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
  <input type="checkbox" id="role-modal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4 flex items-center">
        <i class="fas fa-user-tag text-primary mr-2"></i>
        <span id="roleModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà</span>
      </h3>
      
      <form id="roleForm" class="space-y-4">
        <input type="hidden" id="roleId" />
        
        <!-- Role Name -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó <span class="text-red-500">*</span></span>
          </label>
          <input type="text" id="roleName" placeholder="‡πÄ‡∏ä‡πà‡∏ô HR Manager, Accounting Staff" 
                 class="input input-bordered w-full" required />
        </div>
        
        <!-- Role Description -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</span>
          </label>
          <textarea id="roleDescription" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" 
                    class="textarea textarea-bordered w-full" rows="3"></textarea>
        </div>
        
        <!-- Allowed Pages -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö <span class="text-red-500">*</span></span>
          </label>
          <div class="form-control">
            <label class="label cursor-pointer justify-start">
              <input type="checkbox" id="allowAll" class="checkbox checkbox-primary mr-2" 
                     onchange="toggleAllPages(this)" />
              <span class="label-text">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Admin/CEO)</span>
            </label>
          </div>
          <div id="roleAllowedPages" class="grid grid-cols-2 gap-2 mt-2 p-3 bg-gray-50 rounded-md border max-h-48 overflow-y-auto">
            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
          </div>
        </div>
      </form>
      
      <div class="modal-action">
        <button type="button" class="btn btn-outline" onclick="closeRoleModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" onclick="saveRole()">
          <i class="fas fa-save mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
  <input type="checkbox" id="edit-user-modal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 flex items-center">
        <i class="fas fa-user-edit text-primary mr-2"></i>
        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      </h3>
      

      <form id="editUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input type="hidden" id="editUserId" name="userId" />
        
        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div class="form-control w-full">
          <label class="label"><span class="label-text font-medium">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span></label>
          <select id="editEmployeeSelect" name="employee" required class="select select-bordered w-full" disabled>
            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
          </select>
          <div class="label">
            <span class="label-text-alt text-gray-500">
              <i class="fas fa-lock mr-1"></i>
              ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </span>
          </div>
        </div>
        
        <!-- Username -->
        <div class="form-control w-full">
          <label class="label"><span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</span></label>
          <input type="text" id="editUsername" name="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required
                class="input input-bordered w-full"/>
        </div>
        
        <!-- Password - optional for edit -->
        <div class="form-control w-full">
          <label class="label">
            <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</span>
          </label>
          <input type="password" id="editPassword" name="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô"
                class="input input-bordered w-full"/>
          <div class="label">
            <span class="label-text-alt text-gray-500">
              <i class="fas fa-info-circle mr-1"></i>
              ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            </span>
          </div>
        </div>
        
        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="status" value="active" class="radio radio-primary" checked />
              <span>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="status" value="inactive" class="radio" />
              <span>‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </label>
          </div>
        </div>
        
        <!-- Role (Changed to Checkboxes) -->
        <div class="form-control w-full md:col-span-2">
          <label class="label">
            <span class="label-text font-medium">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (Role)</span>
            <div class="flex gap-2">
              <button type="button" id="editReloadRolesBtn" class="btn btn-xs btn-outline" onclick="reloadRoles()">
                <i class="fas fa-sync-alt mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
              </button>
              <button type="button" id="editUseDefaultRolesBtn" class="btn btn-xs btn-outline btn-warning" onclick="useDefaultRoles()">
                <i class="fas fa-list mr-1"></i>‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
              </button>
            </div>
          </label>
          <div id="editRoleCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
            <p class="text-gray-400 text-center p-2 col-span-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
        </div>
        
        <!-- Allowed Pages -->
        <div id="editPagesDiv" class="form-control w-full md:col-span-2">
          <label class="label">
            <span class="label-text font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</span>
          </label>
          <div id="editPagesCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
          </div>
        </div>
        
        <!-- Check-in Branches (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô) -->
        <div id="editCheckinBranchesDiv" class="form-control w-full md:col-span-2">
          <label class="label">
            <span class="label-text font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ</span>
          </label>
          <div id="editCheckinBranchCheckboxes" class="checkbox-group bg-gray-50 p-3 rounded-md border">
            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
            <p class="text-gray-400 text-center p-2 col-span-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
        </div>
        

      </form>
      
      <div class="modal-action">
        <button type="button" class="btn btn-outline" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" onclick="saveUserEdit()">
          <i class="fas fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        </button>
      </div>
    </div>
  </div>



  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <div id="notification-container"></div>

  <script>
    // API Endpoints
    const API_ENDPOINTS = {
      employees: '/api/employees',
      roles: '/api/user-role',  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö API ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô server.js
      userRegister: '/api/users/register',
      userGet: '/api/users',
      branches: '/api/branch'
    };

    let lottieAnimation = null;

    // ====== Show/Hide Loading Function ======
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô
    const workExperienceStyles = `
      <style>
        .work-experience-icon {
          transition: all 0.3s ease;
        }
        .work-experience-icon:hover {
          transform: scale(1.1);
        }
        .seniority-badge {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tooltip {
          z-index: 1000;
        }
        .work-exp-cell {
          min-width: 150px;
        }
      </style>
    `;
    document.head.insertAdjacentHTML('beforeend', workExperienceStyles);



    // Cache and State Management
    const appCache = {
      roles: null,
      branches: null,
      employees: null,
      lastUpdate: {}
    };

    const token = localStorage.getItem('authToken');
    let selectedRole = null;

    // Modules Configuration (‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö home.html)
    const modules = [
      { id: 'accounting', name: '‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', icon: 'bi-journal-text', color: 'blue' },
      { id: 'hr', name: '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', icon: 'bi-people-fill', color: 'green' },
      { id: 'stock', name: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', icon: 'bi-box-fill', color: 'yellow' },
      { id: 'marketing', name: '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î', icon: 'bi-megaphone-fill', color: 'purple' },
      { id: 'loan', name: '‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠', icon: 'bi-credit-card-fill', color: 'red' },
      { id: 'pos', name: 'POS - ‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô', icon: 'bi-shop', color: 'blue' },
      { id: 'gifts', name: '‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°', icon: 'bi-gift-fill', color: 'pink' },
      { id: 'audit', name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Audit Log', icon: 'bi-journal-check', color: 'red' },
      { id: 'none', name: '‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ)', icon: 'bi-slash-circle', color: 'gray' }
    ];

    // Default Roles Configuration (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ)
    const defaultRoles = [
      { 
        _id: 'admin', 
        name: 'Admin', 
        allowedPages: ['*'],
        description: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö - ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Audit Log'
      },
      { 
        _id: 'ceo', 
        name: 'CEO', 
        allowedPages: ['*'],
        description: '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î - ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Audit Log'
      },
      { 
        _id: 'hr_manager', 
        name: 'HR Manager', 
        allowedPages: ['hr'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'
      },
      { 
        _id: 'hr_staff', 
        name: 'HR Staff', 
        allowedPages: ['hr'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'
      },
      { 
        _id: 'accounting_manager', 
        name: 'Accounting Manager', 
        allowedPages: ['accounting'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'
      },
      { 
        _id: 'accounting_staff', 
        name: 'Accounting Staff', 
        allowedPages: ['accounting'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'
      },
      { 
        _id: 'stock_manager', 
        name: 'Stock Manager', 
        allowedPages: ['stock'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
      },
      { 
        _id: 'stock_staff', 
        name: 'Stock Staff', 
        allowedPages: ['stock'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
      },
      { 
        _id: 'marketing_manager', 
        name: 'Marketing Manager', 
        allowedPages: ['marketing'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
      },
      { 
        _id: 'marketing_staff', 
        name: 'Marketing Staff', 
        allowedPages: ['marketing'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
      },
      { 
        _id: 'loan_manager', 
        name: 'Loan Manager', 
        allowedPages: ['loan'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠'
      },
      { 
        _id: 'loan_staff', 
        name: 'Loan Staff', 
        allowedPages: ['loan'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠'
      },
      { 
        _id: 'pos_manager', 
        name: 'POS Manager', 
        allowedPages: ['pos'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'
      },
      { 
        _id: 'pos_staff', 
        name: 'POS Staff', 
        allowedPages: ['pos'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô'
      },
      { 
        _id: 'gifts_manager', 
        name: 'Gifts Manager', 
        allowedPages: ['gifts'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°'
      },
      { 
        _id: 'gifts_staff', 
        name: 'Gifts Staff', 
        allowedPages: ['gifts'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°'
      },
      { 
        _id: 'multi_department', 
        name: 'Multi Department', 
        allowedPages: ['accounting', 'hr', 'stock'],
        description: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, HR, ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)'
      },
      { 
        _id: 'supervisor', 
        name: 'Supervisor', 
        allowedPages: ['accounting', 'hr', 'stock', 'marketing'],
        description: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, HR, ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î)'
      },
      { 
        _id: 'branch_manager', 
        name: 'Branch Manager', 
        allowedPages: ['pos', 'stock', 'accounting'],
        description: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ (POS, ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)'
      },
      { 
        _id: 'guest', 
        name: 'Guest', 
        allowedPages: ['none'],
        description: '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏° - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ'
      }
    ];

    // Utility Functions
    const debounce = (func, wait) => {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    };

    const showLoading = (element, show = true) => {
      if (show) {
        element.classList.add('loading', 'loading-spinner');
      } else {
        element.classList.remove('loading', 'loading-spinner');
      }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
    function compareNames(a, b) {
      const nameA = (a || '').toString().toLowerCase();
      const nameB = (b || '').toString().toLowerCase();
      
      // ‡πÉ‡∏ä‡πâ localeCompare ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
      return nameA.localeCompare(nameB, ['th', 'en'], {
        numeric: true,
        sensitivity: 'base'
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™) ‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
    function sortUsersBySeniority(users) {
      return users.sort((a, b) => {
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
        const dateA = a.employee?.startDate ? new Date(a.employee.startDate) : new Date();
        const dateB = b.employee?.startDate ? new Date(b.employee.startDate) : new Date();
        
        // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
        if (dateA.getTime() === dateB.getTime()) {
          return compareNames(a.employee?.name, b.employee?.name);
        }
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
        return dateA - dateB;
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    function sortUsers(users, sortType) {
      return users.sort((a, b) => {
        switch (sortType) {
          case 'name-asc':
            // ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ / A-Z
            return compareNames(a.employee?.name, b.employee?.name);

          case 'name-desc':
            // ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Æ-‡∏Å / Z-A
            return compareNames(b.employee?.name, a.employee?.name);

          case 'username-asc':
            // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å-‡∏Æ / A-Z
            return compareNames(a.username, b.username);

          case 'username-desc':
            // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Æ-‡∏Å / Z-A
            return compareNames(b.username, a.username);

          case 'role':
            // ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ‡∏Å-‡∏Æ / A-Z
            const roleComparison = compareNames(a.role?.name, b.role?.name);
            if (roleComparison === 0) {
              return compareNames(a.employee?.name, b.employee?.name);
            }
            return roleComparison;

          default:
            // default ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ A-Z
            return compareNames(a.employee?.name, b.employee?.name);
        }
      });
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Virtual Employee Toggle
    document.addEventListener('DOMContentLoaded', function() {
      const virtualCheckbox = document.getElementById('isVirtualEmployee');
      if (virtualCheckbox) {
        virtualCheckbox.addEventListener('change', function() {
          const isChecked = this.checked;
          const employeeSelectDiv = document.getElementById('employeeSelectDiv');
          const virtualFields = document.getElementById('virtualEmployeeFields');
          const employeeSelect = document.getElementById('employeeSelect');
          
          if (isChecked) {
            // ‡∏ã‡πà‡∏≠‡∏ô dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå virtual
            employeeSelectDiv.classList.add('hidden');
            virtualFields.classList.remove('hidden');
            employeeSelect.removeAttribute('required');
            
            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå virtual ‡πÄ‡∏õ‡πá‡∏ô required
            document.getElementById('virtualName').setAttribute('required', 'required');
            document.getElementById('virtualEmail').setAttribute('required', 'required');
          } else {
            // ‡πÅ‡∏™‡∏î‡∏á dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå virtual
            employeeSelectDiv.classList.remove('hidden');
            virtualFields.classList.add('hidden');
            employeeSelect.setAttribute('required', 'required');
            
            // ‡∏•‡∏ö required ‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå virtual
            document.getElementById('virtualName').removeAttribute('required');
            document.getElementById('virtualEmail').removeAttribute('required');
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Virtual Employee
    function previewVirtualImage(input, previewId) {
      const file = input.files[0];
      const preview = document.getElementById(previewId);
      
      if (file) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (5MB = 5 * 1024 * 1024 bytes)
        if (file.size > 5 * 1024 * 1024) {
          showNotification('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB', 'warning');
          input.value = '';
          return;
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
        if (!file.type.startsWith('image/')) {
          showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'warning');
          input.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô placeholder
        preview.src = 'https://via.placeholder.com/150/e2e8f0/64748b?text=Profile';
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug - ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏° FormData)
    async function uploadVirtualEmployeeFiles(profileFile) {
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏¢‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô createVirtualEmployee
      console.log('‚ö†Ô∏è uploadVirtualEmployeeFiles called but skipped - using direct file upload');
      return { profileImagePath: null };
    }

    // ===== UTILITY FUNCTIONS =====

    // Generate UUID v4
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Generate secure employee ID
    function generateEmployeeId() {
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substr(2, 4).toUpperCase();
      return `VE${timestamp}${random}`;
    }

    // Generate unique citizen ID
    function generateCitizenId() {
      const uuid = generateUUID().replace(/-/g, '');
      return '9' + uuid.substr(0, 12);
    }

    // Sanitize user input
    function sanitizeInput(input) {
      if (typeof input !== 'string') return input;
      return input.trim()
        .replace(/[<>\"']/g, '') // Remove potential XSS characters
        .replace(/\s+/g, ' '); // Normalize whitespace
    }

    // Enhanced error handler
    function handleApiError(response, responseText) {
      let errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (HTTP ${response.status})`;

      try {
        if (responseText.trim()) {
          if (responseText.includes('<!DOCTYPE html>')) {
            // Handle HTML error pages
            switch (response.status) {
              case 502:
                return 'üîß ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (502 Bad Gateway)\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n‚Ä¢ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï\n‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà';
              case 500:
                return '‚ö†Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (500)\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
              case 503:
                return 'üîß ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (503)\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
              default:
                return `‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ HTML Error Page (HTTP ${response.status})`;
            }
          }

          try {
            const errorData = JSON.parse(responseText);
            console.error('‚ùå Parsed API Error:', errorData);

            if (errorData.message) {
              return errorData.message;
            } else if (errorData.error) {
              return Array.isArray(errorData.error)
                ? errorData.error.map(e => e.message || e).join(', ')
                : errorData.error;
            } else if (errorData.errors && Array.isArray(errorData.errors)) {
              return errorData.errors.map(e => e.message || e).join(', ');
            }
          } catch (parseError) {
            console.error('‚ùå Cannot parse JSON, using raw text');
            return responseText.substring(0, 200);
          }
        }
      } catch (readError) {
        console.error('‚ùå Cannot read response:', readError);
      }

      return errorMessage;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Virtual Employee
    async function createVirtualEmployee(virtualData, profileFile = null) {
      showLoading(true);
      try {
        console.log('üîÑ Creating Virtual Employee with data:', virtualData);

        if (profileFile) {
          console.log('üì∏ Profile image file ready:', profileFile.name, profileFile.size, 'bytes');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (!virtualData.name || !virtualData.email) {
          throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å');
        }

        // ‡πÉ‡∏ä‡πâ FormData ‡πÅ‡∏ó‡∏ô JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö API ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á multipart/form-data
        const formData = new FormData();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á employeeId ‡πÅ‡∏•‡∏∞ citizenId ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
        const employeeId = generateEmployeeId();
        const citizenId = generateCitizenId();
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏° sanitization)
        formData.append('employeeId', employeeId);
        formData.append('name', sanitizeInput(virtualData.name));
        formData.append('email', sanitizeInput(virtualData.email));
        formData.append('position', sanitizeInput(virtualData.position) || 'CEO');
        formData.append('department', sanitizeInput(virtualData.department) || 'Management');
        formData.append('citizenId', citizenId);
        formData.append('birthDate', '1990-01-01');
        formData.append('phone', virtualData.phone?.replace(/\D/g, '') || '0000000000');
        formData.append('address', 'Head Office');
        formData.append('startDate', new Date().toISOString().split('T')[0]);
        formData.append('salary', '0');
        formData.append('branch', 'HEAD_OFFICE');
        formData.append('emergencyContactName', 'N/A');
        formData.append('emergencyContactRelationship', 'N/A');
        formData.append('emergencyContactPhone', '0000000000');
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (profileFile) {
          formData.append('image', profileFile);
        }
        
        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö FormData
        console.log('üì§ FormData contents:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}:`, value);
        }
        
        const response = await fetch('/api/employees', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
            // ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà Content-Type ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ browser set multipart/form-data ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          },
          body: formData
        });
        
        console.log('üì° Response status:', response.status);
        
        if (!response.ok) {
          const responseText = await response.text();
          console.error('‚ùå Raw API Response:', responseText);
          const errorMessage = handleApiError(response, responseText);
          throw new Error(errorMessage);
        }
        
        const result = await response.json();
        console.log('‚úÖ API Success Response:', result);
        
        if (!result.success) {
          throw new Error(result.message || '‡∏™‡∏£‡πâ‡∏≤‡∏á Virtual Employee ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        
        console.log('‚úÖ Virtual Employee created with ID:', result.data._id);
        return result.data._id;
        
      } catch (error) {
        console.error('‚ùå Error creating virtual employee:', error);
        throw error;
      } finally {
        showLoading(false);
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function loadModules() {
      const container = document.getElementById('pagesCheckboxes');
      container.innerHTML = '';
      
      modules.forEach(m => {
        const div = document.createElement('div');
        div.className = 'checkbox-container flex items-center p-3 border rounded-md hover:bg-gray-100 cursor-pointer transition-colors';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'allowedPages';
        checkbox.value = m.id;
        checkbox.id = `page_${m.id}`;
        checkbox.className = 'checkbox checkbox-sm mr-3';
        
        const iconSpan = document.createElement('span');
        iconSpan.className = `text-${m.color}-500 mr-2`;
        iconSpan.innerHTML = `<i class="bi ${m.icon}"></i>`;
        
        const label = document.createElement('label');
        label.htmlFor = `page_${m.id}`;
        label.className = 'cursor-pointer font-medium flex-1';
        label.textContent = m.name;
        
        div.appendChild(checkbox);
        div.appendChild(iconSpan);
        div.appendChild(label);
        container.appendChild(div);
      });
      
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÉ‡∏ô Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      const editContainer = document.getElementById('editPagesCheckboxes');
      editContainer.innerHTML = '';
      
      modules.forEach(m => {
        const div = document.createElement('div');
        div.className = 'checkbox-container flex items-center p-3 border rounded-md hover:bg-gray-100 cursor-pointer transition-colors';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'editAllowedPages';
        checkbox.value = m.id;
        checkbox.id = `edit_page_${m.id}`;
        checkbox.className = 'checkbox checkbox-sm mr-3';
        
        const iconSpan = document.createElement('span');
        iconSpan.className = `text-${m.color}-500 mr-2`;
        iconSpan.innerHTML = `<i class="bi ${m.icon}"></i>`;
        
        const label = document.createElement('label');
        label.htmlFor = `edit_page_${m.id}`;
        label.className = 'cursor-pointer font-medium flex-1';
        label.textContent = m.name;
        
        div.appendChild(checkbox);
        div.appendChild(iconSpan);
        div.appendChild(label);
        editContainer.appendChild(div);
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πâ‡∏ß‡∏¢ Cache
    async function loadEmployees(forceRefresh = false) {
      showLoading(true);
      const sel = document.getElementById('employeeSelect');
      const editSel = document.getElementById('editEmployeeSelect');
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cache ‡∏Å‡πà‡∏≠‡∏ô
      if (!forceRefresh && appCache.employees && Date.now() - appCache.lastUpdate.employees < 300000) {
        populateEmployeeSelects(appCache.employees);
        showLoading(false);
        return;
      }
      
      try {
        
        const res = await fetch(API_ENDPOINTS.employees, { 
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        
        if (!json.success) {
          throw new Error(json.error || json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache
        appCache.employees = json.data || [];
        appCache.lastUpdate.employees = Date.now();
        
        populateEmployeeSelects(json.data || []);
        
      } catch (err) {
        console.error('‚ùå Error loading employees:', err);

        let errorMessage = '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
        let errorType = 'error';
        let optionText = '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error messages ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        if (err.message.includes('502') || err.message.includes('Bad gateway')) {
          errorMessage = 'üîß ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (502 Bad Gateway)\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n‚Ä¢ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ ‡πÉ‡∏ä‡πâ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©" ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà';
          optionText = 'üîß ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÉ‡∏ä‡πâ Virtual Employee';
          errorType = 'warning';
        } else if (err.message.includes('500')) {
          errorMessage = '‚ö†Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (500)\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
          optionText = '‚ö†Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå error - ‡πÉ‡∏ä‡πâ Virtual Employee';
          errorType = 'warning';
        } else if (err.message.includes('404')) {
          errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö API endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API';
          optionText = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö API - ‡πÉ‡∏ä‡πâ Virtual Employee';
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          errorMessage = 'üåê ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï\n‚Ä¢ ‡πÉ‡∏ä‡πâ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©" ‡πÅ‡∏ó‡∏ô';
          optionText = 'üåê ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ - ‡πÉ‡∏ä‡πâ Virtual Employee';
          errorType = 'warning';
        } else if (err.message.includes('403') || err.message.includes('Forbidden')) {
          errorMessage = 'üîí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á API ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á';
          optionText = 'üîí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå - ‡πÉ‡∏ä‡πâ Virtual Employee';
        } else {
          errorMessage = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: ${err.message}\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÉ‡∏ä‡πâ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©" ‡πÅ‡∏ó‡∏ô`;
          optionText = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î - ‡πÉ‡∏ä‡πâ Virtual Employee';
        }
        
        sel.innerHTML = `<option value="">${optionText}</option>`;
        editSel.innerHTML = `<option value="">${optionText}</option>`;
        showNotification(errorMessage, errorType);
      } finally {
        showLoading(false);
      }
    }

    function populateEmployeeSelects(employees) {
      const sel = document.getElementById('employeeSelect');
      const editSel = document.getElementById('editEmployeeSelect');
      
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';
      
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      editSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';
      
      employees.forEach(emp => {
        const o = document.createElement('option');
        o.value = emp._id; 
        o.textContent = `${emp.name} (${emp.employeeId || 'N/A'})`;
        sel.appendChild(o);
        
        const editOpt = o.cloneNode(true);
        editSel.appendChild(editOpt);
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πâ‡∏ß‡∏¢ Cache ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function loadRoles(forceRefresh = false, useDefaultOnly = false) {
      const container = document.getElementById('roleCheckboxes');
      const editContainer = document.getElementById('editRoleCheckboxes');
      
      console.log('üîÑ Loading roles, forceRefresh:', forceRefresh, 'useDefaultOnly:', useDefaultOnly);
      console.log('üîç Cache roles:', appCache.roles);
      console.log('üîç Cache lastUpdate:', appCache.lastUpdate.roles);
      
      // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Default Roles ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô)
      if (useDefaultOnly) {
        console.log('üéØ Using default roles only - seeding to database first...');
        try {
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠ seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const seedRes = await fetch(`${API_ENDPOINTS.roles}/seed`, {
            method: 'POST',
            headers: { 
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
          
          if (seedRes.ok) {
            console.log('‚úÖ Seeded default roles to database');
            // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å seed ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API
            return await loadRoles(true, false);
          } else {
            console.log('‚ö†Ô∏è Failed to seed, using local default roles');
          }
        } catch (error) {
          console.log('‚ö†Ô∏è Seed failed, using local default roles:', error);
        }
        
        // fallback ‡πÉ‡∏ä‡πâ default roles ‡πÉ‡∏ô JavaScript
        appCache.roles = defaultRoles;
        appCache.lastUpdate.roles = Date.now();
        populateRoleContainers(defaultRoles);
        updateRoleStats(defaultRoles);
        showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${defaultRoles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)`, 'success');
        return defaultRoles;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cache ‡∏Å‡πà‡∏≠‡∏ô
      if (!forceRefresh && appCache.roles && Array.isArray(appCache.roles) && appCache.roles.length > 0 && Date.now() - appCache.lastUpdate.roles < 300000) {
        console.log('‚úÖ Using cached roles:', appCache.roles.length);
        populateRoleContainers(appCache.roles);
        updateRoleStats(appCache.roles);
        return appCache.roles;
      }
      
      try {
        console.log('üåê Fetching roles from database API...');
        showLoading(container);
        showLoading(editContainer);
        
        const res = await fetch(API_ENDPOINTS.roles, { 
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        console.log('üì° Roles API response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        console.log('üìÑ Roles API response:', json);
        
        if (!json.success) {
          throw new Error(json.error || json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (!Array.isArray(json.data) || json.data.length === 0) {
          console.log('‚ö†Ô∏è No roles in database, attempting to seed...');
          
          try {
            const seedRes = await fetch(`${API_ENDPOINTS.roles}/seed`, {
              method: 'POST',
              headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
            
            if (seedRes.ok) {
              console.log('‚úÖ Seeded default roles, retrying fetch...');
              // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å seed
              return await loadRoles(true, false);
            } else {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ seed ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            }
          } catch (seedError) {
            console.error('‚ùå Seed failed:', seedError);
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ');
          }
        }
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache
        appCache.roles = json.data;
        appCache.lastUpdate.roles = Date.now();
        
        console.log('‚úÖ Roles loaded successfully from database:', json.data.length);
        populateRoleContainers(json.data);
        updateRoleStats(json.data);
        
        return json.data;
        
      } catch (err) {
        console.error('‚ùå Error loading roles from database API:', err);
        
        // ‡πÉ‡∏ä‡πâ Default Roles ‡πÄ‡∏°‡∏∑‡πà‡∏≠ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        console.log('üîÑ Falling back to default roles...');
        appCache.roles = defaultRoles;
        appCache.lastUpdate.roles = Date.now();
        populateRoleContainers(defaultRoles);
        updateRoleStats(defaultRoles);
        
        let errorMessage = '‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ error
        if (err.message.includes('HTTP 404')) {
          errorMessage += '\n\nüí° ‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ API endpoint /api/user-role ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)';
        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          errorMessage += '\n\nüí° ‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢)';
        } else if (err.message.includes('403') || err.message.includes('Forbidden')) {
          errorMessage += '\n\nüí° ‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á API - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token)';
        } else {
          errorMessage += '\n\nüí° ‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
        }
        
        showNotification(errorMessage, 'warning');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ Default Roles
        showNotification(`‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (${defaultRoles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó) - ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠ seed ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`, 'info');
        
        return defaultRoles;
      } finally {
        showLoading(container, false);
        showLoading(editContainer, false);
      }
    }

    function populateRoleContainers(roles) {
      const container = document.getElementById('roleCheckboxes');
      const editContainer = document.getElementById('editRoleCheckboxes');
      
      container.innerHTML = '';
      editContainer.innerHTML = '';
      
      roles.forEach(role => {
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const div = document.createElement('div');
        div.className = 'checkbox-container flex-col items-start p-3 border rounded-md hover:bg-gray-100 cursor-pointer';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'radio';
        checkbox.name = 'role';
        checkbox.value = role._id;
        checkbox.id = `role_${role._id}`;
        checkbox.className = 'radio radio-primary radio-sm';
        checkbox.addEventListener('change', debounce(function() {
          if (this.checked) {
            // ‡πÄ‡∏≠‡∏≤ class selected ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            document.querySelectorAll('#roleCheckboxes .checkbox-container').forEach(card => {
              card.classList.remove('selected');
            });
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° class selected ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            div.classList.add('selected');
            onRoleChange(role._id);
          }
        }, 300));
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö
        div.addEventListener('click', function(e) {
          // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà radio button ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
          if (e.target === checkbox) return;
          
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        });
        
        const label = document.createElement('label');
        label.htmlFor = `role_${role._id}`;
        label.className = 'cursor-pointer font-medium';
        label.textContent = role.name;
        
        const topRow = document.createElement('div');
        topRow.className = 'flex items-center gap-2 w-full';
        topRow.appendChild(checkbox);
        topRow.appendChild(label);
        
        div.appendChild(topRow);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (role.description) {
          const desc = document.createElement('div');
          desc.className = 'text-xs text-gray-600 mt-1 ml-6';
          desc.textContent = role.description;
          div.appendChild(desc);
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
        if (role.allowedPages && role.allowedPages.length > 0) {
          const pages = document.createElement('div');
          pages.className = 'text-xs text-blue-600 mt-1 ml-6';
          if (role.allowedPages.includes('*')) {
            pages.textContent = 'üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
          } else {
            const pageNames = role.allowedPages.map(pageId => {
              const module = modules.find(m => m.id === pageId);
              return module ? module.name : pageId;
            });
            pages.textContent = `üìã ${pageNames.join(', ')}`;
          }
          div.appendChild(pages);
        }
        
        container.appendChild(div);
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        const editDiv = document.createElement('div');
        editDiv.className = 'checkbox-container flex-col items-start p-3 border rounded-md hover:bg-gray-100 cursor-pointer';
        
        const editCheckbox = document.createElement('input');
        editCheckbox.type = 'radio';
        editCheckbox.name = 'editRole';
        editCheckbox.value = role._id;
        editCheckbox.id = `edit_role_${role._id}`;
        editCheckbox.className = 'radio radio-primary radio-sm';
        editCheckbox.addEventListener('change', debounce(function() {
          if (this.checked) {
            // ‡πÄ‡∏≠‡∏≤ class selected ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            document.querySelectorAll('#editRoleCheckboxes .checkbox-container').forEach(card => {
              card.classList.remove('selected');
            });
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° class selected ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            editDiv.classList.add('selected');
            onEditRoleChange(role._id);
          }
        }, 300));
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        editDiv.addEventListener('click', function(e) {
          // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà radio button ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
          if (e.target === editCheckbox) return;
          
          editCheckbox.checked = true;
          editCheckbox.dispatchEvent(new Event('change'));
        });
        
        const editLabel = document.createElement('label');
        editLabel.htmlFor = `edit_role_${role._id}`;
        editLabel.className = 'cursor-pointer font-medium';
        editLabel.textContent = role.name;
        
        const editTopRow = document.createElement('div');
        editTopRow.className = 'flex items-center gap-2 w-full';
        editTopRow.appendChild(editCheckbox);
        editTopRow.appendChild(editLabel);
        
        editDiv.appendChild(editTopRow);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (role.description) {
          const editDesc = document.createElement('div');
          editDesc.className = 'text-xs text-gray-600 mt-1 ml-6';
          editDesc.textContent = role.description;
          editDiv.appendChild(editDesc);
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
        if (role.allowedPages && role.allowedPages.length > 0) {
          const editPages = document.createElement('div');
          editPages.className = 'text-xs text-blue-600 mt-1 ml-6';
          if (role.allowedPages.includes('*')) {
            editPages.textContent = 'üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
          } else {
            const pageNames = role.allowedPages.map(pageId => {
              const module = modules.find(m => m.id === pageId);
              return module ? module.name : pageId;
            });
            editPages.textContent = `üìã ${pageNames.join(', ')}`;
          }
          editDiv.appendChild(editPages);
        }
        
        editContainer.appendChild(editDiv);
      });
    }

    // ‡∏î‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πâ‡∏ß‡∏¢ Cache ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
    async function loadBranches(forceRefresh = false) {
      console.log('üîÑ loadBranches called, forceRefresh:', forceRefresh);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Cache ‡∏Å‡πà‡∏≠‡∏ô
      if (!forceRefresh && appCache.branches && Date.now() - appCache.lastUpdate.branches < 300000) {
        console.log('üìã Using cached branches:', appCache.branches.length);
        return appCache.branches;
      }
      
      try {
        console.log('üåê Fetching branches from API:', API_ENDPOINTS.branches);
        const res = await fetch(API_ENDPOINTS.branches, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        console.log('üì° API Response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        console.log('üìÑ API Response data:', json);
        
        if (!json.success || !Array.isArray(json.data)) {
          throw new Error(json.message || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
        console.log('üîÑ Processing branch data...');
        const branches = json.data.map((b, index) => {
          console.log(`Branch ${index}:`, b);
          return {
            id: b._id, 
            code: b.branch_code || b.code || 'N/A', 
            name: b.name || 'Unknown Branch'
          };
        });

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cache
        appCache.branches = branches;
        appCache.lastUpdate.branches = Date.now();
        
        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', branches.length, '‡∏™‡∏≤‡∏Ç‡∏≤');
        console.log('üìÑ Raw API Response:', json);
        console.log('üè¢ Processed branches:', branches);
        return branches;
        
      } catch (err) {
        console.error('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', err);
        console.error('‚ùå Error details:', err.message, err.stack);
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
        appCache.branches = [];
        return [];
      }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    async function onRoleChange(roleId) {
      selectedRole = roleId;
      console.log('üîÑ onRoleChange called with roleId:', roleId);
      
      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å Cache
      const role = appCache.roles?.find(r => r._id === roleId);
      if (!role) {
        console.error('‚ùå Role not found in cache:', roleId);
        return;
      }
      
      console.log('‚úÖ Found role:', role.name);

      const pagesDiv = document.getElementById('pagesDiv');
      const checkinBranchesDiv = document.getElementById('checkinBranchesDiv');
      const defaultDiv = document.getElementById('defaultBranchDiv');
      const checkinBranchContainer = document.getElementById('checkinBranchCheckboxes');
      const defaultContainer = document.getElementById('defaultBranchCheckboxes');

      console.log('üìã Elements found:', {
        pagesDiv: !!pagesDiv,
        checkinBranchesDiv: !!checkinBranchesDiv,
        defaultDiv: !!defaultDiv,
        checkinBranchContainer: !!checkinBranchContainer,
        defaultContainer: !!defaultContainer
      });
      
      // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ class ‡∏Ç‡∏≠‡∏á elements
      if (checkinBranchesDiv) {
        console.log('üîç checkinBranchesDiv classes:', checkinBranchesDiv.className);
        console.log('üîç checkinBranchesDiv has hidden class:', checkinBranchesDiv.classList.contains('hidden'));
      }
      if (defaultDiv) {
        console.log('üîç defaultDiv classes:', defaultDiv.className);
        console.log('üîç defaultDiv has hidden class:', defaultDiv.classList.contains('hidden'));
      }

      // reset & show all
      pagesDiv?.classList.remove('hidden');
      checkinBranchesDiv?.classList.remove('hidden');
      defaultDiv?.classList.remove('hidden');
      
      // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å remove hidden
      console.log('üîÑ After removing hidden class:');
      if (checkinBranchesDiv) {
        console.log('üîç checkinBranchesDiv classes after:', checkinBranchesDiv.className);
        console.log('üîç checkinBranchesDiv visible:', !checkinBranchesDiv.classList.contains('hidden'));
      }
      
      if (checkinBranchContainer) checkinBranchContainer.innerHTML = '';
      if (defaultContainer) defaultContainer.innerHTML = '';

      // admin hides all branch selections
      const isAdmin = role.name.toLowerCase() === 'admin';
      console.log('üë§ Role name:', role.name);
      console.log('üë§ Role name lowercase:', role.name.toLowerCase());
      console.log('üë§ Is Admin:', isAdmin);
      
      if (isAdmin) {
        pagesDiv?.classList.add('hidden');
        checkinBranchesDiv?.classList.add('hidden');
        defaultDiv?.classList.add('hidden');
        console.log('üîí Hidden all sections for Admin');
        return;
      }
      
      console.log('üìã Not admin, showing branch sections...');

      // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
      if (checkinBranchContainer) checkinBranchContainer.innerHTML = '<p class="text-gray-400 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>';
      if (defaultContainer) defaultContainer.innerHTML = '<p class="text-gray-400 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>';

      try {
        console.log('üîÑ Loading branches...');
        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const branches = await loadBranches();
        console.log('‚úÖ Loaded branches:', branches.length, 'branches');
        
        if (checkinBranchContainer) checkinBranchContainer.innerHTML = '';
        if (defaultContainer) defaultContainer.innerHTML = '';

        if (branches.length === 0) {
          console.log('‚ö†Ô∏è No branches found, creating test data...');
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
          const testBranches = [
            { id: 'test1', name: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà', code: 'HQ' },
            { id: 'test2', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', code: 'HDY' },
            { id: 'test3', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', code: 'PTN' }
          ];
          
          if (checkinBranchContainer) {
            checkinBranchContainer.innerHTML = '<p class="text-yellow-600 p-2 mb-2">‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö (API ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤)</p>';
            testBranches.forEach(b => {
              const div = document.createElement('div');
              div.className = 'checkbox-container';
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.name = 'checkinBranches';
              cb.value = b.id;
              cb.id = `checkin_branch_${b.id}`;
              cb.className = 'checkbox checkbox-sm';
              const lbl = document.createElement('label');
              lbl.htmlFor = cb.id;
              lbl.textContent = b.name;
              div.append(cb, lbl);
              checkinBranchContainer.append(div);
            });
          }
          
          if (defaultContainer) {
            defaultContainer.innerHTML = '<p class="text-yellow-600 p-2 mb-2">‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>';
            testBranches.forEach(b => {
              const div = document.createElement('div');
              div.className = 'checkbox-container';
              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.name = 'defaultBranches';
              cb.value = b.id;
              cb.id = `def_branch_${b.id}`;
              cb.className = 'checkbox checkbox-sm';
              const lbl = document.createElement('label');
              lbl.htmlFor = cb.id;
              lbl.textContent = b.name;
              div.append(cb, lbl);
              defaultContainer.append(div);
            });
          }
          return;
        }

        branches.forEach(b => {
          // checkinBranches checkbox (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)
          const div1 = document.createElement('div');
          div1.className = 'checkbox-container';
          const cb1 = document.createElement('input');
          cb1.type = 'checkbox';
          cb1.name = 'checkinBranches';
          cb1.value = b.id;
          cb1.id = `checkin_branch_${b.id}`;
          cb1.className = 'checkbox checkbox-sm';
          const lbl1 = document.createElement('label');
          lbl1.htmlFor = cb1.id;
          lbl1.textContent = b.name;
          div1.append(cb1, lbl1);
          if (checkinBranchContainer) checkinBranchContainer.append(div1);

          // defaultBranch checkbox
          const div2 = document.createElement('div');
          div2.className = 'checkbox-container';
          const cb2 = document.createElement('input');
          cb2.type = 'checkbox';
          cb2.name = 'defaultBranches';
          cb2.value = b.id;
          cb2.id = `def_branch_${b.id}`;
          cb2.className = 'checkbox checkbox-sm';
          const lbl2 = document.createElement('label');
          lbl2.htmlFor = cb2.id;
          lbl2.textContent = b.name;
          div2.append(cb2, lbl2);
          if (defaultContainer) defaultContainer.append(div2);
        });
        
        console.log('‚úÖ Successfully populated branch checkboxes');
      } catch (error) {
        console.error('‚ùå Error in onRoleChange:', error);
        if (checkinBranchContainer) checkinBranchContainer.innerHTML = '<p class="text-red-600 p-2">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
        if (defaultContainer) defaultContainer.innerHTML = '<p class="text-red-600 p-2">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
      }
    }
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    async function onEditRoleChange(roleId) {
      selectedRole = roleId;
      
      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å Cache
      const role = appCache.roles?.find(r => r._id === roleId);
      if (!role) {
        console.error('Role not found in cache:', roleId);
        return;
      }

      const pagesDiv = document.getElementById('editPagesDiv');
      const checkinBranchesDiv = document.getElementById('editCheckinBranchesDiv');
      const checkinBranchContainer = document.getElementById('editCheckinBranchCheckboxes');

      // reset & show all (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö element ‡∏Å‡πà‡∏≠‡∏ô)
      if (pagesDiv) pagesDiv.classList.remove('hidden');
      if (checkinBranchesDiv) checkinBranchesDiv.classList.remove('hidden');
      if (checkinBranchContainer) checkinBranchContainer.innerHTML = '';

      // admin hides all branch selections
      const isAdmin = role.name.toLowerCase() === 'admin';
      if (isAdmin) {
        if (pagesDiv) pagesDiv.classList.add('hidden');
        if (checkinBranchesDiv) checkinBranchesDiv.classList.add('hidden');
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
      if (checkinBranchContainer) checkinBranchContainer.innerHTML = '<p class="text-gray-400 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>';

      try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const branches = await loadBranches();
        
        if (checkinBranchContainer) checkinBranchContainer.innerHTML = '';

        branches.forEach(b => {
          // editCheckinBranches (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)
          if (checkinBranchContainer) {
            const div1 = document.createElement('div');
            div1.className = 'checkbox-container';
            const cb1 = document.createElement('input');
            cb1.type = 'checkbox';
            cb1.name = 'editCheckinBranches';
            cb1.value = b.id;
            cb1.id = `edit_checkin_branch_${b.id}`;
            cb1.className = 'checkbox checkbox-sm';
            const lbl1 = document.createElement('label');
            lbl1.htmlFor = cb1.id;
            lbl1.textContent = b.name;
            div1.append(cb1, lbl1);
            checkinBranchContainer.append(div1);
          }
        });
      } catch (error) {
        if (checkinBranchContainer) checkinBranchContainer.innerHTML = '<p class="text-red-600 p-2">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
      }
    }

    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    document.getElementById('registerForm').addEventListener('submit', async ev => {
      ev.preventDefault();
      
      const submitBtn = ev.target.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      
      try {
        // Disable submit button ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        
        const isVirtual = document.getElementById('isVirtualEmployee').checked;
        let employeeId = null;
        
        if (isVirtual) {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á Virtual Employee ‡∏Å‡πà‡∏≠‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏° sanitization)
          const virtualData = {
            name: sanitizeInput(document.getElementById('virtualName').value),
            email: sanitizeInput(document.getElementById('virtualEmail').value),
            position: sanitizeInput(document.getElementById('virtualPosition').value) || 'CEO',
            department: sanitizeInput(document.getElementById('virtualDepartment').value) || 'Management',
            phone: document.getElementById('virtualPhone').value.trim().replace(/\D/g, '') // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
          };
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          if (!virtualData.name || !virtualData.email) {
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©');
          }
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(virtualData.email)) {
            throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          }
          
          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          const profileFile = document.getElementById('virtualProfileImage').files[0];
          
          showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©...', 'info');
          employeeId = await createVirtualEmployee(virtualData, profileFile);
          
        } else {
          // ‡πÉ‡∏ä‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          const formData = new FormData(ev.target);
          employeeId = formData.get('employee');
          
          if (!employeeId) {
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
          }
        }
        
        // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö roles ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
        console.log('üîç Available roles in cache:', appCache.roles);
        console.log('üîç Role checkboxes in DOM:', document.querySelectorAll('input[name="role"]').length);
        
        // Get selected role
        const selectedRoleInput = document.querySelector('input[name="role"]:checked');
        const allRoleInputs = document.querySelectorAll('input[name="role"]');
        
        console.log('üîç All role inputs found:', allRoleInputs.length);
        console.log('üîç Selected role input:', selectedRoleInput);
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ role inputs ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ roles ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
        if (allRoleInputs.length === 0) {
          console.log('‚ö†Ô∏è No role inputs found, trying to reload roles...');
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà...', 'warning');
          
          // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÇ‡∏´‡∏•‡∏î roles ‡πÉ‡∏´‡∏°‡πà
          const roles = await loadRoles(true);
          
          if (!roles || roles.length === 0) {
            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
          }
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role inputs ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î
          const newRoleInputs = document.querySelectorAll('input[name="role"]');
          if (newRoleInputs.length === 0) {
            throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
          }
          
          throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
        
        if (!selectedRoleInput) {
          // ‡πÅ‡∏™‡∏î‡∏á roles ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          const availableRoles = Array.from(allRoleInputs).map(input => {
            const label = document.querySelector(`label[for="${input.id}"]`);
            return label ? label.textContent : input.value;
          }).join(', ');
          
          throw new Error(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${availableRoles})`);
        }
        
        const rid = selectedRoleInput.value;
        const role = appCache.roles?.find(r => r._id === rid);
        if (!role) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
        }

        console.log('üîç Selected role:', role);
        console.log('üîç Roles loaded from API:', appCache.roles?.length || 0);

        let allowedPages = [], allowedBranches = [], checkinBranches = [];

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
        const isAdmin = role.name.toLowerCase() === 'admin' || role.name.toLowerCase() === 'ceo';
        if (isAdmin) {
          // Admin/CEO ‡πÉ‡∏ä‡πâ allowedPages ‡∏à‡∏≤‡∏Å role definition
          allowedPages = role.allowedPages || ['*'];
          
          const branches = await loadBranches();
          if (branches.length > 0) {
            allowedBranches = branches.map(b => b.id);
            checkinBranches = branches.map(b => b.id);
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÉ‡∏ä‡πâ default
            allowedBranches = ['default'];
            checkinBranches = ['default'];
          }
          
          console.log('üîë Admin/CEO setup:', { allowedPages, allowedBranches, checkinBranches });
        } else {
          // user ‡∏õ‡∏Å‡∏ï‡∏¥
          document.querySelectorAll('input[name="allowedPages"]:checked')
            .forEach(cb => allowedPages.push(cb.value));
          document.querySelectorAll('input[name="checkinBranches"]:checked')
            .forEach(cb => {
              checkinBranches.push(cb.value);
              allowedBranches.push(cb.value); // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            });
          
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å pages ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å role definition
          if (allowedPages.length === 0 && role.allowedPages) {
            allowedPages = role.allowedPages;
          }
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (checkinBranches.length === 0) {
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤');
          }
          
          console.log('üë§ Regular user setup:', { allowedPages, allowedBranches, checkinBranches });
        }

        // checkinBranches ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô defaultBranch
        const defaultBranch = checkinBranches[0] || null;

        const formData = new FormData(ev.target);
        const payload = {
          employee: employeeId,
          username: sanitizeInput(formData.get('username')),
          password: formData.get('password'), // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà sanitize ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
          role: rid,
          allowedPages,
          allowedBranches,
          checkinBranches,
          defaultBranch
        };

        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
        console.log('üìù Payload to send:', {
          employee: employeeId,
          username: payload.username,
          role: rid,
          roleName: role.name,
          isAdmin: isAdmin,
          allowedPages: allowedPages.length,
          allowedPagesData: allowedPages,
          allowedBranches: allowedBranches.length,
          allowedBranchesIds: allowedBranches,
          checkinBranches: checkinBranches.length,
          checkinBranchesIds: checkinBranches,
          defaultBranch: defaultBranch
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (!payload.username) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        }
        if (!payload.password) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
        }

        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...', 'info');

        const res = await fetch(API_ENDPOINTS.userRegister, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token   //  ‚Üê added
          },
          body: JSON.stringify(payload)
        });

        // ‡∏ñ‡πâ‡∏≤ status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 2xx ‡πÉ‡∏´‡πâ‡∏î‡∏π error page ‡∏Å‡πà‡∏≠‡∏ô
        if (!res.ok) {
          let errorMessage = `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (HTTP ${res.status})`;
          
          try {
            const errData = await res.text();
            console.error('Register API error:', errData);
            
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse ‡πÄ‡∏õ‡πá‡∏ô JSON
            try {
              const errorJson = JSON.parse(errData);
              if (errorJson.error) {
                errorMessage = errorJson.error;
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error messages ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
                if (errorMessage.includes('‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß') || errorMessage.includes('already registered')) {
                  errorMessage = '‚ùå ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                } else if (errorMessage.includes('validation') || errorMessage.includes('required')) {
                  errorMessage = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                } else if (errorMessage.includes('permission') || errorMessage.includes('unauthorized')) {
                  errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô\n\nüí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                }
              }
            } catch (parseError) {
              // ‡∏ñ‡πâ‡∏≤ parse JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
              console.log('Cannot parse error as JSON:', parseError);
            }
          } catch (readError) {
            console.error('Cannot read error response:', readError);
          }
          
          throw new Error(errorMessage);
        }

        // ‡πÅ‡∏Ñ‡πà status OK ‡∏à‡∏∂‡∏á parse JSON
        const result = await res.json();
        if (!result.success) {
          throw new Error(result.error || result.message || '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showNotification('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        resetForm();
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
        await loadUsers();
        
      } catch (err) {
        console.error('Registration error:', err);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
      } finally {
        // Enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset Form
    function resetForm() {
      const form = document.getElementById('registerForm');
      form.reset();
      
      // Reset UI states
      document.getElementById('isVirtualEmployee').checked = false;
      document.getElementById('employeeSelectDiv').classList.remove('hidden');
      document.getElementById('virtualEmployeeFields').classList.add('hidden');
      document.getElementById('employeeSelect').setAttribute('required', 'required');
      document.getElementById('virtualName').removeAttribute('required');
      document.getElementById('virtualEmail').removeAttribute('required');
      
      // Reset ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Virtual Employee
      document.getElementById('virtualProfileImage').value = '';
      document.getElementById('virtualProfilePreview').src = 'https://via.placeholder.com/150/e2e8f0/64748b?text=Profile';
      
      // Reset sections - ‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô UI ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      document.getElementById('pagesDiv').classList.add('hidden');
      
      // Uncheck all checkboxes and radios
      document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
        input.checked = false;
      });
      
      selectedRole = null;
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    async function openEditModal(userId) {
      document.getElementById('editUserId').value = userId;
      
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      try {
        const res = await fetch(`${API_ENDPOINTS.userGet}/${userId}`, { // ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        
        const userData = await res.json();
        
        if (!userData.success) throw new Error(userData.message || '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        
        const user = userData.data;
        
        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
        console.log('üîç Edit Modal - User data:', {
          username: user.username,
          checkinBranches: user.checkinBranches,
          allowedBranches: user.allowedBranches,
          defaultBranches: user.defaultBranches,
          role: user.role
        });
        
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('editUsername').value = user.username;
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        if (user.employee && user.employee._id) {
          document.getElementById('editEmployeeSelect').value = user.employee._id;
        } else if (user.employee) {
          document.getElementById('editEmployeeSelect').value = user.employee;
        }
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
        document.getElementById('editPassword').value = '';
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ user.role._id)
        if (user.role && user.role._id) {
          const roleRadio = document.querySelector(`input[name="editRole"][value="${user.role._id}"]`);
          if (roleRadio) {
            roleRadio.checked = true;
            onEditRoleChange(user.role._id);
          }
        }
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusActive = document.querySelector('input[name="status"][value="active"]');
        const statusInactive = document.querySelector('input[name="status"][value="inactive"]');
        
        if (!user.isBlocked) {
          statusActive.checked = true;
        } else {
          statusInactive.checked = true;
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô Edit Modal ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à
        await loadBranchesIntoEditModal();
        
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(() => {
          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (‡∏à‡∏≤‡∏Å role.allowedPages)
          if (user.role?.allowedPages) {
            user.role.allowedPages.forEach(page => {
              const pageCheckbox = document.querySelector(`input[name="editAllowedPages"][value="${page}"]`);
              if (pageCheckbox) pageCheckbox.checked = true;
            });
          }
          
          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          let userBranches = [];
          
          // ‡πÉ‡∏ä‡πâ checkinBranches ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
          if (user.checkinBranches && user.checkinBranches.length > 0) {
            userBranches = user.checkinBranches;
            console.log('üè¢ Using checkinBranches:', userBranches);
          } else if (user.allowedBranches && user.allowedBranches.length > 0) {
            userBranches = user.allowedBranches;
            console.log('üè¢ Using allowedBranches:', userBranches);
          } else if (user.defaultBranches && user.defaultBranches.length > 0) {
            userBranches = user.defaultBranches;
            console.log('üè¢ Using defaultBranches:', userBranches);
          }
          
          if (userBranches.length > 0) {
            userBranches.forEach(branch => {
              let branchId;
              
              // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô string ID ‡∏´‡∏£‡∏∑‡∏≠ object
              if (typeof branch === 'string') {
                branchId = branch;
              } else if (branch && branch._id) {
                branchId = branch._id;
              } else if (branch && branch.id) {
                branchId = branch.id;
              }
              
              if (branchId) {
                const checkinBranchCheckbox = document.querySelector(`input[name="editCheckinBranches"][value="${branchId}"]`);
                if (checkinBranchCheckbox) {
                  checkinBranchCheckbox.checked = true;
                  console.log('‚úÖ Selected branch:', branchId);
                } else {
                  console.log('‚ùå Branch checkbox not found for:', branchId);
                }
              }
            });
          } else {
            console.log('‚ö†Ô∏è No branches found for user');
          }
          

        }, 500);
        
      } catch (err) {
        console.error(err);
        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + err.message, 'error');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentEmployeeName = document.getElementById('currentEmployeeName');
        const currentUsername = document.getElementById('currentUsername');
        const currentRole = document.getElementById('currentRole');
        const currentPages = document.getElementById('currentPages');
        const currentBranches = document.getElementById('currentBranches');
        
        const errorText = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
        if (currentEmployeeName) currentEmployeeName.textContent = errorText;
        if (currentUsername) currentUsername.textContent = errorText;
        if (currentRole) currentRole.textContent = errorText;
        if (currentPages) currentPages.textContent = errorText;
        if (currentBranches) currentBranches.textContent = errorText;
      }
      
      // ‡πÄ‡∏õ‡∏¥‡∏î Modal
      document.getElementById('edit-user-modal').checked = true;
    }
    
    // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    function closeEditModal() {
      document.getElementById('edit-user-modal').checked = false;
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('editUserForm').reset();
      document.getElementById('editPassword').value = '';
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ
      const currentEmployeeName = document.getElementById('currentEmployeeName');
      const currentUsername = document.getElementById('currentUsername');
      const currentRole = document.getElementById('currentRole');
      const currentPages = document.getElementById('currentPages');
      const currentBranches = document.getElementById('currentBranches');
      
      if (currentEmployeeName) currentEmployeeName.textContent = '-';
      if (currentUsername) currentUsername.textContent = '-';
      if (currentRole) currentRole.textContent = '-';
      if (currentPages) currentPages.textContent = '-';
      if (currentBranches) currentBranches.textContent = '-';
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å checkbox ‡πÅ‡∏•‡∏∞ radio
      document.querySelectorAll('#editUserForm input[type="checkbox"], #editUserForm input[type="radio"]').forEach(input => {
        input.checked = false;
      });
    }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    async function saveUserEdit() {
      showLoading(true);
      const userId = document.getElementById('editUserId').value;
      
      // Get selected role
      const selectedRoleInput = document.querySelector('input[name="editRole"]:checked');
      if (!selectedRoleInput) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó', 'warning');
        return;
      }
      
      const rid = selectedRoleInput.value;
      const role = appCache.roles?.find(r => r._id === rid);
      const isAdmin = role?.name.toLowerCase() === 'admin' || role?.name.toLowerCase() === 'ceo';
      
      let checkinBranches = [];
      let allowedBranches = [];
      let defaultBranches = [];

      if (isAdmin) {
        // Admin ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
        const branches = await loadBranches();
        if (branches.length > 0) {
          checkinBranches = branches.map(b => b.id);
          allowedBranches = branches.map(b => b.id);
          defaultBranches = [branches[0].id];
        } else {
          checkinBranches = ['default'];
          allowedBranches = ['default'];
          defaultBranches = ['default'];
        }
      } else {
        // User ‡∏õ‡∏Å‡∏ï‡∏¥ - ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.querySelectorAll('input[name="editCheckinBranches"]:checked').forEach(cb => {
          checkinBranches.push(cb.value);
          allowedBranches.push(cb.value);
        });
        
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô defaultBranches
        defaultBranches = checkinBranches.length > 0 ? [checkinBranches[0]] : [];
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (checkinBranches.length === 0) {
          showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏≤‡∏Ç‡∏≤', 'warning');
          return;
        }
      }
      
      const username = document.getElementById('editUsername').value.trim();
      const password = document.getElementById('editPassword').value.trim();
      const active = document.querySelector('input[name="status"]:checked').value === 'active';
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      if (!username) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'warning');
        return;
      }
      
      // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (allowedPages)
      const allowedPages = [];
      document.querySelectorAll('input[name="editAllowedPages"]:checked').forEach(cb => {
        allowedPages.push(cb.value);
      });
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏ï‡∏≤‡∏° validation schema ‡∏Ç‡∏≠‡∏á API
      const payload = {
        username,
        role: rid,
        isBlocked: !active,
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        checkinBranches: checkinBranches,
        allowedBranches: allowedBranches,
        defaultBranches: defaultBranches
      };
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° allowedPages ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      if (!isAdmin && allowedPages.length > 0) {
        payload.allowedPages = allowedPages;
      } else if (!isAdmin) {
        payload.allowedPages = [];
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å
      if (password && password.length > 0) {
        payload.password = password;
        console.log('üîê Password will be updated');
      } else {
        console.log('üîê Password will remain unchanged');
      }
      
      console.log('üîÑ Updating user:', userId);
      console.log('üì¶ Payload with branches:', {
        ...payload,
        checkinBranchesCount: payload.checkinBranches?.length,
        allowedBranchesCount: payload.allowedBranches?.length,
        defaultBranchesCount: payload.defaultBranches?.length
      });
      
      try {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô
        const res = await fetch(`${API_ENDPOINTS.userGet}/${userId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('‚ùå Update User API Error:', errorText);
          let errorMessage = `HTTP ${res.status}: ${res.statusText}`;
          
          // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON error response
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.message || errorData.error || errorMessage;
          } catch (e) {
            // ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô HTML error page
            if (errorText.includes('<!DOCTYPE html>')) {
              errorMessage = `‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ HTML Error Page (HTTP ${res.status})`;
            }
          }
          
          throw new Error(errorMessage);
        }

        const data = await res.json();
        
        if (!data.success) {
          throw new Error(data.message || data.error || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        
        showNotification('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
        if (password && password.length > 0) {
          showNotification('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        
        closeEditModal();
        
        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö refresh
        await loadUsersWithFilter(true);
        
      } catch (err) {
        console.error(err);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
      }
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    document.addEventListener('click', function(e) {
      if (e.target.closest('.edit-user-btn')) {
        const btn = e.target.closest('.edit-user-btn');
        const userId = btn.getAttribute('data-user-id');
        openEditModal(userId);
      }
    });
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (toggle switch)
    document.addEventListener('change', async function(e) {
      if (e.target.classList.contains('status-toggle')) {
        const toggle = e.target;
        const userId = toggle.getAttribute('data-user-id');
        const isActive = toggle.checked;
        const toggleContainer = toggle.closest('.toggle-status');
        const statusLabel = toggleContainer.querySelector('.status-label');
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° class loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        toggleContainer.classList.add('loading');
        
        try {
          console.log('üîÑ Updating user status:', { userId, isActive });
          console.log('üì° API endpoint:', `${API_ENDPOINTS.userGet}/${userId}`);
          
          // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ PATCH ‡πÅ‡∏ó‡∏ô PUT)
          const res = await fetch(`${API_ENDPOINTS.userGet}/${userId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              isBlocked: !isActive // ‡∏™‡πà‡∏á isBlocked ‡πÅ‡∏ó‡∏ô active (‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤)
            })
          });
          
          console.log('üì° Response status:', res.status);
          
          if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå API Error Response:', errorText);
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          const data = await res.json();
          console.log('‚úÖ API Success Response:', data);
          
          if (!data.success) {
            throw new Error(data.message || data.error || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
          }
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
          if (isActive) {
            statusLabel.textContent = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            statusLabel.className = 'status-label ml-2 text-xs text-green-600';
          } else {
            statusLabel.textContent = '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            statusLabel.className = 'status-label ml-2 text-xs text-gray-500';
          }
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          showNotification(
            `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô "${isActive ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 
            'success'
          );
          
        } catch (err) {
          console.error(err);
          
          // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°
          toggle.checked = !isActive;
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ toggle
          if (!isActive) {
            statusLabel.textContent = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            statusLabel.className = 'status-label ml-2 text-xs text-green-600';
          } else {
            statusLabel.textContent = '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            statusLabel.className = 'status-label ml-2 text-xs text-gray-500';
          }
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
          showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        } finally {
          // ‡∏•‡∏ö class loading ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
          toggleContainer.classList.remove('loading');
        }
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notification-container');
      
      const notification = document.createElement('div');
      
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      let bgColor = 'bg-blue-500';
      if (type === 'success') bgColor = 'bg-green-500';
      if (type === 'error') bgColor = 'bg-red-500';
      if (type === 'warning') bgColor = 'bg-yellow-500';
      
      notification.className = `notification ${bgColor} px-4 py-2 rounded-lg shadow-lg max-w-md`;
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      let icon = 'info-circle';
      if (type === 'success') icon = 'check-circle';
      if (type === 'error') icon = 'exclamation-circle';
      if (type === 'warning') icon = 'exclamation-triangle';
      
      // ‡πÅ‡∏õ‡∏•‡∏á \n ‡πÄ‡∏õ‡πá‡∏ô <br> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
      const formattedMessage = message.replace(/\n/g, '<br>');
      
      notification.innerHTML = `
        <div class="flex items-start">
          <i class="fas fa-${icon} mr-2 mt-1 flex-shrink-0"></i>
          <span class="text-sm leading-relaxed">${formattedMessage}</span>
        </div>
      `;
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏á‡πÉ‡∏ô container
      container.appendChild(notification);
      
      // ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)
      const timeout = message.length > 100 ? 7000 : 5000;
      setTimeout(() => {
        notification.classList.add('hide');
        
        // ‡∏•‡∏ö element ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ transition ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, timeout);
    }

    // Fetch and populate the user table - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    async function loadUsers(forceRefresh = false) {
      const tbody = document.querySelector('#usersTable tbody');
      
      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading state
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4"><i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
        
        const res = await fetch(API_ENDPOINTS.userGet, {
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        if (!json.success) {
          throw new Error(json.error || json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API response
        console.log('üì° Users API Response:', json);
        console.log('üìä Number of users:', json.data?.length || 0);

        // Clear existing rows in the table
        tbody.innerHTML = '';

        if (!json.data || json.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td></tr>';
          return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠
        const sortedUsers = sortUsersBySeniority(json.data);
        
        console.log('üìä Users sorted by name:', sortedUsers.map(u => ({
          name: u.employee?.name,
          startDate: u.employee?.startDate
        })));

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
        const fragment = document.createDocumentFragment();
        
        sortedUsers.forEach((user, index) => {
          // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
          console.log('üîç User data:', {
            index,
            username: user.username,
            role: user.role?.name,
            roleAllowedPages: user.role?.allowedPages,
            checkinBranches: user.checkinBranches,
            allowedBranches: user.allowedBranches,
            defaultBranches: user.defaultBranches,
            checkinBranchesType: typeof user.checkinBranches,
            checkinBranchesLength: user.checkinBranches?.length,
            firstCheckinBranch: user.checkinBranches?.[0]
          });
          
          // ‡πÉ‡∏ä‡πâ checkinBranches ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ fallback ‡πÄ‡∏õ‡πá‡∏ô allowedBranches
          let branches = '-';
          
          if (user.checkinBranches?.length) {
            branches = user.checkinBranches.map(b => {
              if (typeof b === 'string') {
                return 'ID: ' + b; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ID
              }
              return b?.name || b?.branch_code || 'Unknown Branch';
            }).join(', ');
          } else if (user.allowedBranches?.length) {
            branches = user.allowedBranches.map(b => {
              if (typeof b === 'string') {
                return 'ID: ' + b; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ID
              }
              return b?.name || b?.branch_code || 'Unknown Branch';
            }).join(', ');
           } else if (user.defaultBranches?.length) {
             branches = user.defaultBranches.map(b => {
               if (typeof b === 'string') {
                 return 'ID: ' + b; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ID
               }
               return b?.name || b?.branch_code || 'Unknown Branch';
             }).join(', ');
           }
           
           // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©
           if (user.role?.name?.toLowerCase() === 'admin') {
             branches = 'üîë Admin (‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤)';
           } else if (branches === '-') {
             branches = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≤‡∏Ç‡∏≤';
           }

          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å role.allowedPages)
          let allowedSystems = '-';
          const roleAllowedPages = user.role?.allowedPages || [];
          
          if (roleAllowedPages.length > 0) {
            const systemNames = roleAllowedPages.map(pageId => {
              const module = modules.find(m => m.id === pageId);
              return module ? module.name : pageId;
            });
            allowedSystems = systemNames.join(', ');
          } else if (user.role?.name?.toLowerCase().includes('admin') || 
                     user.role?.name?.toLowerCase().includes('ceo') ||
                     user.role?.name?.toLowerCase().includes('super') ||
                     user.role?.name?.toLowerCase().includes('‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤')) {
            allowedSystems = 'üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
          } else {
            allowedSystems = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏ö‡∏ö';
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <th>
              <label>
                <input type="checkbox" class="checkbox" data-user-id="${user._id}"/></label>
            </th>
            <td class="font-medium">${user.username || '-'}</td>
            <td>
              <div class="flex flex-col">
                <span class="font-medium">${user.employee?.name || '-'}</span>
                ${user.employee?.employeeId ? 
                  `<span class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${user.employee.employeeId}</span>` : 
                  ''
                }
              </div>
            </td>
            <td>
              <span class="badge badge-sm bg-primary text-white border-0 px-2">
                ${user.role?.name || 'No Role'}
              </span>
            </td>
            <td class="text-sm">
              <div class="max-w-xs overflow-hidden">
                <div class="text-sm text-gray-800 dark:text-gray-200" title="${allowedSystems}">
                  ${allowedSystems}
                </div>
                ${roleAllowedPages.length ? 
                  `<div class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${roleAllowedPages.length} ‡∏£‡∏∞‡∏ö‡∏ö</div>` : 
                  ''
                }
              </div>
            </td>
            <td class="text-sm">
              <div class="max-w-xs overflow-hidden">
                <div class="text-sm text-gray-800 dark:text-gray-200" title="${branches}">
                  ${branches}
                </div>
                ${user.checkinBranches?.length ? 
                  `<div class="text-xs text-gray-500 mt-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô: ${user.checkinBranches.length} ‡∏™‡∏≤‡∏Ç‡∏≤</div>` : 
                  ''
                }
              </div>
            </td>
            <td>
              <div class="toggle-status">
                <input type="checkbox" class="toggle toggle-success toggle-sm status-toggle"
                       data-user-id="${user._id}" ${!user.isBlocked ? 'checked' : ''} />
                <span class="status-label ml-2 text-xs ${!user.isBlocked ? 'text-green-600' : 'text-gray-500'}">
                  ${!user.isBlocked ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö'}
                </span>
              </div>
            </td>
            <td>
              <div class="flex gap-1">
                <button class="btn btn-ghost btn-xs text-blue-600 edit-user-btn hover:bg-blue-50" 
                        data-user-id="${user._id}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-ghost btn-xs text-red-600 delete-user-btn hover:bg-red-50" 
                        data-user-id="${user._id}" title="‡∏•‡∏ö">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          fragment.appendChild(tr);
        });
        
        tbody.appendChild(fragment);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        updateUserStats(sortedUsers.length);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        console.log('‚úÖ Users loaded and sorted by seniority successfully');
        if (sortedUsers.length > 0) {
          const seniorEmployee = sortedUsers[0].employee;
          const newestEmployee = sortedUsers[sortedUsers.length - 1].employee;
          
          console.log('üìä Seniority Summary:', {
            total: sortedUsers.length,
            senior: { name: seniorEmployee?.name, workExp: calculateWorkExperience(seniorEmployee?.startDate) },
            newest: { name: newestEmployee?.name, workExp: calculateWorkExperience(newestEmployee?.startDate) }
          });
        }

      } catch (err) {
        console.error('Error loading users:', err);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</td></tr>';
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    function updateUserStats(userCount) {
      const statsElement = document.querySelector('.stats-card h3');
      if (statsElement) {
        statsElement.textContent = userCount.toString();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function updateRoleStats(roles) {
      const countElement = document.getElementById('rolesCount');
      const sourceElement = document.getElementById('rolesSource');
      
      if (countElement) {
        countElement.textContent = roles.length.toString();
      }
      
      if (sourceElement) {
        const isDefaultRoles = roles === defaultRoles || JSON.stringify(roles) === JSON.stringify(defaultRoles);
        
        if (isDefaultRoles) {
          sourceElement.innerHTML = '<i class="fas fa-list text-yellow-500 mr-1"></i>‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
          sourceElement.className = 'text-yellow-600 text-sm mt-1';
        } else {
          sourceElement.innerHTML = '<i class="fas fa-cloud text-blue-500 mr-1"></i>‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API';
          sourceElement.className = 'text-blue-600 text-sm mt-1';
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô Edit Modal
    async function loadBranchesIntoEditModal() {
      console.log('üîÑ Loading branches into Edit Modal...');
      
      const editCheckinBranchContainer = document.getElementById('editCheckinBranchCheckboxes');
      
      if (!editCheckinBranchContainer) {
        console.error('‚ùå Edit Branch container not found');
        return;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á loading
      editCheckinBranchContainer.innerHTML = '<p class="text-gray-400 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>';
      
      try {
        const branches = await loadBranches();
        console.log('‚úÖ Branches loaded for Edit Modal:', branches.length);
        console.log('üìÑ Branch data:', branches);
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå loading
        editCheckinBranchContainer.innerHTML = '';
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å
        const uniqueBranches = branches.filter((branch, index, self) => 
          index === self.findIndex(b => b.id === branch.id)
        );
        
        console.log('üîç Unique branches for Edit Modal:', uniqueBranches.length, 'from', branches.length);
        
        if (uniqueBranches.length === 0) {
          console.log('‚ö†Ô∏è No branches found, creating test data for Edit Modal...');
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
          const testBranches = [
            { id: 'test1', name: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà', code: 'HQ' },
            { id: 'test2', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', code: 'HDY' },
            { id: 'test3', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', code: 'PTN' }
          ];
          
          populateBranchUI(testBranches, editCheckinBranchContainer, true, true);
          return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á (edit mode)
        populateBranchUI(uniqueBranches, editCheckinBranchContainer, false, true);
        
        console.log('‚úÖ Successfully populated Edit Modal branch UI');
        
      } catch (error) {
        console.error('‚ùå Error loading branches into Edit Modal:', error);
        editCheckinBranchContainer.innerHTML = '<p class="text-red-600 p-2">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    async function loadBranchesIntoUI() {
      console.log('üîÑ Loading branches into UI...');
      
      const checkinBranchContainer = document.getElementById('checkinBranchCheckboxes');
      
      if (!checkinBranchContainer) {
        console.error('‚ùå Branch container not found');
        return;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)
      if (checkinBranchContainer.children.length > 0 && 
          !checkinBranchContainer.innerHTML.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î')) {
        console.log('‚úÖ Branches already loaded, skipping...');
        return;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á loading
      checkinBranchContainer.innerHTML = '<p class="text-gray-400 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>';
      
      try {
        const branches = await loadBranches();
        console.log('‚úÖ Branches loaded for UI:', branches.length);
        console.log('üìÑ Branch data:', branches);
        
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå loading
        checkinBranchContainer.innerHTML = '';
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å (‡πÉ‡∏ä‡πâ id ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)
        const uniqueBranches = branches.filter((branch, index, self) => 
          index === self.findIndex(b => b.id === branch.id)
        );
        
        console.log('üîç Unique branches:', uniqueBranches.length, 'from', branches.length);
        
        if (uniqueBranches.length === 0) {
          console.log('‚ö†Ô∏è No branches found, creating test data...');
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
          const testBranches = [
            { id: 'test1', name: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà', code: 'HQ' },
            { id: 'test2', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', code: 'HDY' },
            { id: 'test3', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', code: 'PTN' }
          ];
          
          populateBranchUI(testBranches, checkinBranchContainer, true);
          return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
        populateBranchUI(uniqueBranches, checkinBranchContainer, false);
        
        console.log('‚úÖ Successfully populated branch UI');
        
      } catch (error) {
        console.error('‚ùå Error loading branches into UI:', error);
        checkinBranchContainer.innerHTML = '<p class="text-red-600 p-2">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>';
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á register ‡πÅ‡∏•‡∏∞ edit)
    function populateBranchUI(branches, checkinContainer, isTestData = false, isEditMode = false) {
      if (isTestData) {
        checkinContainer.innerHTML = '<p class="text-yellow-600 p-2 mb-2">‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö (API ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤)</p>';
      }
      
      branches.forEach(b => {
        // checkinBranches checkbox
        const div = document.createElement('div');
        div.className = 'checkbox-container';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = isEditMode ? 'editCheckinBranches' : 'checkinBranches';
        cb.value = b.id;
        cb.id = isEditMode ? `edit_checkin_branch_${b.id}` : `checkin_branch_${b.id}`;
        cb.className = 'checkbox checkbox-sm';
        const lbl = document.createElement('label');
        lbl.htmlFor = cb.id;
        lbl.textContent = `${b.name}${b.code ? ` (${b.code})` : ''}`;
        div.append(cb, lbl);
        checkinContainer.append(div);
      });
    }

     // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
    async function deleteUser(userId) {
      // ‡πÉ‡∏ä‡πâ Sweet Alert ‡∏´‡∏£‡∏∑‡∏≠ Modal ‡πÅ‡∏ó‡∏ô confirm
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
        return;
      }

      // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á loading
      const deleteBtn = document.querySelector(`[data-user-id="${userId}"].delete-user-btn`);
      const originalBtnContent = deleteBtn?.innerHTML;

      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        const res = await fetch(`${API_ENDPOINTS.userGet}/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 2xx ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô text ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug HTML error page
        if (!res.ok) {
          const errData = await res.text();
          console.error('Delete API error:', errData);
          throw new Error(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (HTTP ${res.status})`);
        }

        // ‡∏ñ‡πâ‡∏≤ OK ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡πà‡∏≤‡∏ô JSON
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.message || '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        showNotification('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        
        // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û)
        const userRow = deleteBtn?.closest('tr');
        if (userRow) {
          userRow.style.transition = 'all 0.3s ease';
          userRow.style.opacity = '0';
          userRow.style.transform = 'translateX(-100%)';
          
          setTimeout(() => {
            userRow.remove();
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            const remainingRows = document.querySelectorAll('#usersTable tbody tr').length;
            updateUserStats(remainingRows);
          }, 300);
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
          await loadUsers();
        }
        
      } catch (err) {
        console.error('Delete user error:', err);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
      } finally {
        // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
        if (deleteBtn && originalBtnContent) {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = originalBtnContent;
        }
      }
    }

// ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
document.addEventListener('click', function (e) {
  if (e.target.closest('.delete-user-btn')) {
    const btn = e.target.closest('.delete-user-btn');
    const userId = btn.getAttribute('data-user-id');
    deleteUser(userId);
  }
});


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    function closeEditModal() {
      // ‡∏õ‡∏¥‡∏î modal
      document.getElementById('edit-user-modal').checked = false;
      
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('editUserForm').reset();
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å checkboxes ‡πÅ‡∏•‡∏∞ radios
      document.querySelectorAll('#editUserForm input[type="checkbox"], #editUserForm input[type="radio"]').forEach(input => {
        input.checked = false;
      });
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
      document.getElementById('editUserId').value = '';
      document.getElementById('editPassword').value = '';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î roles ‡πÉ‡∏´‡∏°‡πà
    async function reloadRoles() {
      const btn = document.getElementById('reloadRolesBtn');
      const originalContent = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡πÇ‡∏´‡∏•‡∏î...';
        
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å API...', 'info');
        
        // ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        appCache.roles = null;
        appCache.lastUpdate.roles = 0;
        
        const roles = await loadRoles(true);
        
        if (roles && roles.length > 0) {
          const source = roles === defaultRoles ? '‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'API';
          showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${roles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - ‡∏à‡∏≤‡∏Å ${source})`, 'success');
        } else {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó', 'error');
        }
        
      } catch (error) {
        console.error('Error reloading roles:', error);
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    async function useDefaultRoles() {
      const btn = document.getElementById('useDefaultRolesBtn');
      const originalContent = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...', 'info');
        
        // ‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        await loadRoles(false, true);
        
        showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${defaultRoles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)`, 'success');
        
      } catch (error) {
        console.error('Error using default roles:', error);
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    async function reloadEmployees() {
      const btn = document.getElementById('reloadEmployeesBtn');
      const originalContent = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡πÇ‡∏´‡∏•‡∏î...';
        
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...', 'info');
        
        // ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        appCache.employees = null;
        appCache.lastUpdate.employees = 0;
        
        await loadEmployees(true);
        
        if (appCache.employees && appCache.employees.length > 0) {
          showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${appCache.employees.length} ‡∏Ñ‡∏ô - ‡∏à‡∏≤‡∏Å API)`, 'success');
        } else {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å API', 'warning');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API
        updateApiStatus();
        
      } catch (error) {
        console.error('Error reloading employees:', error);
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà
    async function reloadBranches() {
      const btn = document.getElementById('reloadBranchesBtn');
      const originalContent = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>‡πÇ‡∏´‡∏•‡∏î...';
        
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà...', 'info');
        
        // ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        appCache.branches = null;
        appCache.lastUpdate.branches = 0;
        
        const branches = await loadBranches(true);
        
        if (branches && branches.length > 0) {
          showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${branches.length} ‡∏™‡∏≤‡∏Ç‡∏≤ - ‡∏à‡∏≤‡∏Å API)`, 'success');
          
          // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô UI ‡πÉ‡∏´‡∏°‡πà
          await loadBranchesIntoUI();
        } else {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏à‡∏≤‡∏Å API', 'warning');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API
        updateApiStatus();
        
      } catch (error) {
        console.error('Error reloading branches:', error);
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API
    function updateApiStatus() {
      const alert = document.getElementById('apiStatusAlert');
      const message = document.getElementById('apiStatusMessage');
      const tips = document.getElementById('troubleshootingTips');
      
      let statusParts = [];
      let hasErrors = false;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ API
      if (appCache.roles && appCache.roles.length > 0) {
        statusParts.push('‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      } else {
        statusParts.push('‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        hasErrors = true;
      }
      
      if (appCache.employees && appCache.employees.length > 0) {
        statusParts.push('‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      } else {
        statusParts.push('‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ‚ùå API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        hasErrors = true;
      }
      
      if (appCache.branches && appCache.branches.length > 0) {
        statusParts.push('‡∏™‡∏≤‡∏Ç‡∏≤: ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      } else {
        statusParts.push('‡∏™‡∏≤‡∏Ç‡∏≤: ‚ùå API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        hasErrors = true;
      }
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ API ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      if (hasErrors) {
        alert.classList.remove('hidden');
        message.textContent = statusParts.join(' | ');
        
        // ‡πÅ‡∏™‡∏î‡∏á troubleshooting tips
        if (tips) {
          tips.classList.remove('hidden');
        }
      } else {
        alert.classList.add('hidden');
        
        // ‡∏ã‡πà‡∏≠‡∏ô troubleshooting tips
        if (tips) {
          tips.classList.add('hidden');
        }
      }
    }

    // ===== ROLE MANAGEMENT FUNCTIONS =====
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function openRoleManagementModal() {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal
      displayRoles();
      
      // ‡πÄ‡∏õ‡∏¥‡∏î modal
      document.getElementById('role-management-modal').checked = true;
    }
    
    // ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function closeRoleManagementModal() {
      document.getElementById('role-management-modal').checked = false;
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function createRoleCard(role) {
      const isDefaultRole = defaultRoles.some(dr => dr._id === role._id);
      
      return `
        <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-semibold text-gray-800">${role.name}</h3>
              ${isDefaultRole ? '<span class="badge badge-sm badge-warning">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>' : '<span class="badge badge-sm badge-primary">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>'}
            </div>
            <div class="flex gap-1">
              <button onclick="editRole('${role._id}')" class="btn btn-ghost btn-xs text-blue-600 hover:bg-blue-50" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                <i class="fas fa-edit"></i>
              </button>
              ${!isDefaultRole ? `
                <button onclick="deleteRole('${role._id}')" class="btn btn-ghost btn-xs text-red-600 hover:bg-red-50" title="‡∏•‡∏ö">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </div>
          
          <p class="text-sm text-gray-600 mb-2">${role.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</p>
          
          <div class="text-xs">
            <span class="font-medium text-gray-700">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á:</span>
            <div class="mt-1">
              ${role.allowedPages && role.allowedPages.includes('*') ? 
                '<span class="text-blue-600">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>' : 
                role.allowedPages?.map(pageId => {
                  const module = modules.find(m => m.id === pageId);
                  return module ? `<span class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs mr-1 mb-1">${module.name}</span>` : '';
                }).join('') || '<span class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>'
              }
            </div>
          </div>
        </div>
      `;
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function displayRoles() {
      const grid = document.getElementById('rolesGrid');
      if (!grid) return;
      
      const roles = appCache.roles || defaultRoles;
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
      updateRolesSummary(roles);
      
      if (roles.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
        return;
      }
      
      grid.innerHTML = roles.map(role => createRoleCard(role)).join('');
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function updateRolesSummary(roles) {
      const defaultCount = roles.filter(role => defaultRoles.some(dr => dr._id === role._id)).length;
      const customCount = roles.length - defaultCount;
      const adminCount = roles.filter(role => 
        role.allowedPages?.includes('*') || 
        role.name.toLowerCase().includes('admin') || 
        role.name.toLowerCase().includes('ceo')
      ).length;
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
      const totalElement = document.getElementById('totalRolesCount');
      const defaultElement = document.getElementById('defaultRolesCount');
      const customElement = document.getElementById('customRolesCount');
      const adminElement = document.getElementById('adminRolesCount');
      
      if (totalElement) totalElement.textContent = roles.length;
      if (defaultElement) defaultElement.textContent = defaultCount;
      if (customElement) customElement.textContent = customCount;
      if (adminElement) adminElement.textContent = adminCount;
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function openAddRoleModal() {
      document.getElementById('roleModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà';
      document.getElementById('roleId').value = '';
      document.getElementById('roleName').value = '';
      document.getElementById('roleDescription').value = '';
      document.getElementById('allowAll').checked = false;
      
      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
      loadModulesIntoRoleForm();
      
      // ‡πÄ‡∏õ‡∏¥‡∏î Modal
      document.getElementById('role-modal').checked = true;
    }
    
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function editRole(roleId) {
      const role = (appCache.roles || defaultRoles).find(r => r._id === roleId);
      if (!role) {
        showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
        return;
      }
      
      document.getElementById('roleModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó';
      document.getElementById('roleId').value = role._id;
      document.getElementById('roleName').value = role.name;
      document.getElementById('roleDescription').value = role.description || '';
      
      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
      loadModulesIntoRoleForm();
      
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
      if (role.allowedPages && role.allowedPages.includes('*')) {
        document.getElementById('allowAll').checked = true;
        toggleAllPages(document.getElementById('allowAll'));
      } else {
        document.getElementById('allowAll').checked = false;
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        if (role.allowedPages) {
          role.allowedPages.forEach(pageId => {
            const checkbox = document.querySelector(`#roleAllowedPages input[value="${pageId}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }
      }
      
      // ‡πÄ‡∏õ‡∏¥‡∏î Modal
      document.getElementById('role-modal').checked = true;
    }
    
    // ‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    async function deleteRole(roleId) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isDefaultRole = defaultRoles.some(dr => dr._id === roleId);
      if (isDefaultRole) {
        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ', 'warning');
        return;
      }
      
      const role = (appCache.roles || defaultRoles).find(r => r._id === roleId);
      if (!role) {
        showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
        return;
      }
      
      if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${role.name}"?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`)) {
        return;
      }
      
      try {
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó...', 'info');
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API DELETE
        console.log('üîÑ Deleting role:', roleId);
        const response = await fetch(`${API_ENDPOINTS.roles}/${roleId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Delete role API response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìÑ Delete role API response:', result);
        
        if (!result.success) {
          throw new Error(result.error || result.message || '‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        // ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        console.log('‚úÖ Role deleted successfully, refreshing data...');
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å API
        const updatedRoles = await loadRoles(true);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        displayRoles();
        updateRoleStats(updatedRoles);
        populateRoleContainers(updatedRoles);
        
        showNotification(`‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${role.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        
      } catch (error) {
        console.error('‚ùå Error deleting role:', error);
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ' + error.message;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ error
        if (error.message.includes('HTTP 400')) {
          errorMessage += '\n\nüí° ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ';
        } else if (error.message.includes('HTTP 403')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó';
        } else if (error.message.includes('HTTP 404')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage += '\n\nüí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢';
        }
        
        showNotification(errorMessage, 'error');
      }
    }
    
    // ‡∏õ‡∏¥‡∏î Modal
    function closeRoleModal() {
      document.getElementById('role-modal').checked = false;
      document.getElementById('roleForm').reset();
      
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡∏î‡∏π‡∏•
      const pageCheckboxes = document.querySelectorAll('#roleAllowedPages input[type="checkbox"]');
      pageCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
      });
      document.getElementById('allowAll').checked = false;
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏ô Modal
    document.addEventListener('keydown', function(e) {
      const modal = document.getElementById('role-modal');
      if (modal && modal.checked) {
        if (e.key === 'Escape') {
          closeRoleModal();
        } else if (e.key === 'Enter' && e.ctrlKey) {
          saveRole();
        }
      }
    });
    
    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function loadModulesIntoRoleForm() {
      const container = document.getElementById('roleAllowedPages');
      container.innerHTML = '';
      
      modules.forEach(module => {
        if (module.id === 'none') return; // ‡∏Ç‡πâ‡∏≤‡∏° "‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"
        
        const div = document.createElement('div');
        div.className = 'form-control';
        
        const label = document.createElement('label');
        label.className = 'label cursor-pointer justify-start p-2 rounded-md hover:bg-gray-100 transition-colors';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox checkbox-sm mr-3';
        checkbox.value = module.id;
        checkbox.name = 'rolePages';
        
        const iconSpan = document.createElement('span');
        iconSpan.className = `text-${module.color}-500 mr-2`;
        iconSpan.innerHTML = `<i class="bi ${module.icon}"></i>`;
        
        const span = document.createElement('span');
        span.className = 'label-text text-sm font-medium';
        span.textContent = module.name;
        
        label.appendChild(checkbox);
        label.appendChild(iconSpan);
        label.appendChild(span);
        div.appendChild(label);
        container.appendChild(div);
      });
    }
    
    // toggle ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function toggleAllPages(checkbox) {
      const pageCheckboxes = document.querySelectorAll('#roleAllowedPages input[type="checkbox"]');
      pageCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        cb.disabled = checkbox.checked;
      });
    }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    async function saveRole() {
      const roleId = document.getElementById('roleId').value;
      const roleName = document.getElementById('roleName').value.trim();
      const roleDescription = document.getElementById('roleDescription').value.trim();
      const allowAll = document.getElementById('allowAll').checked;
      
      if (!roleName) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó', 'warning');
        return;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
      const existingRole = (appCache.roles || defaultRoles).find(r => r.name === roleName && r._id !== roleId);
      if (existingRole) {
        showNotification('‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        return;
      }
      
      // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
      let allowedPages = [];
      if (allowAll) {
        allowedPages = ['*'];
      } else {
        const selectedPages = document.querySelectorAll('#roleAllowedPages input[type="checkbox"]:checked');
        allowedPages = Array.from(selectedPages).map(cb => cb.value);
        
        if (allowedPages.length === 0) {
          showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
          return;
        }
      }
      
      const roleData = {
        name: roleName,
        description: roleDescription,
        allowedPages: allowedPages
      };
      
      try {
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó...', 'info');
        
        let response;
        if (roleId) {
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API PATCH
          console.log('üîÑ Updating role:', roleId, roleData);
          response = await fetch(`${API_ENDPOINTS.roles}/${roleId}`, {
            method: 'PATCH',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(roleData)
          });
        } else {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API POST
          console.log('üîÑ Creating new role:', roleData);
          response = await fetch(API_ENDPOINTS.roles, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(roleData)
          });
        }
        
        console.log('üì° Save role API response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìÑ Save role API response:', result);
        
        if (!result.success) {
          throw new Error(result.error || result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        console.log('‚úÖ Role saved successfully, refreshing data...');
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å API
        const updatedRoles = await loadRoles(true);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        displayRoles();
        updateRoleStats(updatedRoles);
        populateRoleContainers(updatedRoles);
        
        showNotification(`${roleId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°'}‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${roleName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        closeRoleModal();
        
      } catch (error) {
        console.error('‚ùå Error saving role:', error);
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ' + error.message;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ error
        if (error.message.includes('HTTP 400')) {
          errorMessage += '\n\nüí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';
        } else if (error.message.includes('HTTP 403')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó';
        } else if (error.message.includes('HTTP 404')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage += '\n\nüí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢';
        }
        
        showNotification(errorMessage, 'error');
      }
    }
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    function resetToDefaultRoles() {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?\n\n‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö!')) {
        return;
      }
      
      try {
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï cache ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        appCache.roles = [...defaultRoles];
        appCache.lastUpdate.roles = Date.now();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
        displayRoles();
        updateRoleStats(appCache.roles);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        populateRoleContainers(appCache.roles);
        
        showNotification(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${defaultRoles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)`, 'success');
        
      } catch (error) {
        console.error('Error resetting roles:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï: ' + error.message, 'error');
      }
    }
    
    // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    function exportRoles() {
      try {
        const roles = appCache.roles || defaultRoles;
        const exportData = {
          exportDate: new Date().toISOString(),
          version: '1.0',
          totalRoles: roles.length,
          roles: roles
        };
        
        const jsonString = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `roles_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${roles.length} ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó)`, 'success');
        
      } catch (error) {
        console.error('Error exporting roles:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å: ' + error.message, 'error');
      }
    }
    
    // Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏±‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    async function syncAllUsers() {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏±‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà?\n\n‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö')) {
        return;
      }
      
      try {
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...', 'info');
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API sync
        console.log('üîÑ Syncing all users with roles...');
        const response = await fetch(`${API_ENDPOINTS.roles}/sync-users`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Sync API response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìÑ Sync API response:', result);
        
        if (!result.success) {
          throw new Error(result.error || result.message || 'Sync ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        showNotification(`‚úÖ ${result.message}\n\nüìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:\n‚Ä¢ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${result.data.totalUsers} ‡∏Ñ‡∏ô\n‚Ä¢ Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.data.syncedUsers} ‡∏Ñ‡∏ô`, 'success');
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        await loadUsers(true);
        
      } catch (error) {
        console.error('‚ùå Error syncing users:', error);
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ' + error.message;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ error
        if (error.message.includes('HTTP 403')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        } else if (error.message.includes('HTTP 404')) {
          errorMessage += '\n\nüí° ‡πÑ‡∏°‡πà‡∏û‡∏ö API endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sync';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage += '\n\nüí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢';
        }
        
        showNotification(errorMessage, 'error');
      }
    }
    
    // ===== END ROLE MANAGEMENT FUNCTIONS =====

    // Socket.IO Connection ‡πÅ‡∏•‡∏∞ Event Handlers
    let socket = null;
    
    function initializeSocket() {
      if (typeof io !== 'undefined') {
        socket = io();
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
        socket.on('roleUpdated', (data) => {
          console.log('üîÑ Role updated:', data);
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
          loadRoles(true).then(() => {
            displayRoles();
            updateRoleStats(appCache.roles || defaultRoles);
            populateRoleContainers(appCache.roles || defaultRoles);
            
            showNotification(`‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${data.data.name}" ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß`, 'info');
          });
        });
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà
        socket.on('roleCreated', (data) => {
          console.log('‚úÖ Role created:', data);
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
          loadRoles(true).then(() => {
            displayRoles();
            updateRoleStats(appCache.roles || defaultRoles);
            populateRoleContainers(appCache.roles || defaultRoles);
            
            showNotification(`‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡∏°‡πà "${data.data.name}" ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß`, 'success');
          });
        });
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
        socket.on('roleDeleted', (data) => {
          console.log('üóëÔ∏è Role deleted:', data);
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
          loadRoles(true).then(() => {
            displayRoles();
            updateRoleStats(appCache.roles || defaultRoles);
            populateRoleContainers(appCache.roles || defaultRoles);
            
            showNotification(`‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${data.data.name}" ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
          });
        });
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ô‡∏µ‡πâ
        socket.on('userRoleUpdated', (data) => {
          console.log('üë§ User role updated:', data);
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
          if (currentUser.username === data.username) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            currentUser.role = data.updatedRole;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            showNotification(`‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô "${data.updatedRole.name}"`, 'info');
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            loadUsers(true);
          }
        });
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ô‡∏µ‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin/HR)
        socket.on('roleUsersUpdated', (data) => {
          console.log('üìä Role users updated:', data);
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          loadUsers(true);
          
          showNotification(`‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó "${data.roleName}" ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${data.affectedUsers.length} ‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï`, 'info');
        });
        
        // ‡∏ü‡∏±‡∏á event ‡∏Å‡∏≤‡∏£ sync ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        socket.on('allUsersSynced', (data) => {
          console.log('üîÑ All users synced:', data);
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          loadUsers(true);
          
          showNotification(`üîÑ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô\n‚Ä¢ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.totalUsers} ‡∏Ñ‡∏ô\n‚Ä¢ Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.syncedUsers} ‡∏Ñ‡∏ô`, 'success');
        });
        
        console.log('üì° Socket.IO initialized for role sync');
      } else {
        console.log('‚ö†Ô∏è Socket.IO not available, role sync disabled');
      }
    }

    // ===== FILTERING AND PAGINATION FUNCTIONS =====
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pagination ‡πÅ‡∏•‡∏∞ filter
    let currentPage = 1;
    let currentLimit = 10;
    let currentFilters = {
      role: 'all',
      branch: 'all',
      status: 'all',
      search: '',
      sort: 'name-asc'  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    };
    let totalPages = 1;
    let totalUsers = 0;
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡∏á‡πÉ‡∏ô filter
    async function loadRoleFilter() {
      const roleFilter = document.getElementById('roleFilter');
      if (!roleFilter) return;
      
      try {
        const roles = await loadRoles();
        roleFilter.innerHTML = '<option value="all">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        
        if (roles && roles.length > 0) {
          roles.forEach(role => {
            const option = document.createElement('option');
            option.value = role._id;
            option.textContent = role.name;
            roleFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading roles for filter:', error);
      }
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô filter
    async function loadBranchFilter() {
      const branchFilter = document.getElementById('branchFilter');
      if (!branchFilter) return;
      
      try {
        const branches = await loadBranches();
        branchFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
        
        if (branches && branches.length > 0) {
          branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.id;
            option.textContent = `${branch.name} (${branch.code})`;
            branchFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading branches for filter:', error);
      }
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö pagination ‡πÅ‡∏•‡∏∞ filter)
    async function loadUsersWithFilter(resetPage = false) {
      const tbody = document.querySelector('#usersTable tbody');
      
      if (resetPage) {
        currentPage = 1;
      }
      
      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading state
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4"><i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
        const params = new URLSearchParams({
          page: currentPage,
          limit: currentLimit,
          role: currentFilters.role,
          branch: currentFilters.branch,
          status: currentFilters.status,
          search: currentFilters.search
        });
        
        const res = await fetch(`${API_ENDPOINTS.userGet}?${params}`, {
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const json = await res.json();
        if (!json.success) {
          throw new Error(json.error || json.message || '‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ pagination
        totalPages = json.pagination.pages;
        totalUsers = json.pagination.total;
        
        // Clear existing rows
        tbody.innerHTML = '';
        
        if (!json.data || json.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
          updatePaginationInfo(0, 0, 0);
          updatePaginationButtons();
          return;
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const sortedUsers = sortUsers(json.data, currentFilters.sort);
        
        console.log('üìä Users sorted by', currentFilters.sort + ':', sortedUsers.map(u => ({
          name: u.employee?.name,
          username: u.username,
          role: u.role?.name,
          startDate: u.employee?.startDate
        })));
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        const fragment = document.createDocumentFragment();
        
        sortedUsers.forEach((user, index) => {
          // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
          console.log('üîç User branch data:', {
            index,
            username: user.username,
            checkinBranches: user.checkinBranches,
            allowedBranches: user.allowedBranches,
            defaultBranches: user.defaultBranches
          });
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ - ‡πÉ‡∏´‡πâ priority checkinBranches > allowedBranches > defaultBranches
          let branches = '-';
          let branchesArray = [];
          
          // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          if (user.checkinBranches && Array.isArray(user.checkinBranches) && user.checkinBranches.length > 0) {
            branchesArray = user.checkinBranches;
            console.log('üìã Using checkinBranches:', branchesArray);
          } else if (user.allowedBranches && Array.isArray(user.allowedBranches) && user.allowedBranches.length > 0) {
            branchesArray = user.allowedBranches;
            console.log('üìã Using allowedBranches:', branchesArray);
          } else if (user.defaultBranches && Array.isArray(user.defaultBranches) && user.defaultBranches.length > 0) {
            branchesArray = user.defaultBranches;
            console.log('üìã Using defaultBranches:', branchesArray);
          }
          
          if (branchesArray.length > 0) {
            const branchNames = branchesArray.map(b => {
              if (typeof b === 'string') {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ID ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å cache
                const branchData = appCache.branches?.find(branch => branch.id === b);
                return branchData ? `${branchData.name} (${branchData.code})` : `ID: ${b}`;
              } else if (b && typeof b === 'object') {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ name ‡∏´‡∏£‡∏∑‡∏≠ branch_code
                return `${b.name || 'Unknown'} ${b.code || b.branch_code ? `(${b.code || b.branch_code})` : ''}`;
              }
              return 'Unknown Branch';
            });
            
            branches = branchNames.join(', ');
            console.log('‚úÖ Final branch display:', branches);
          }
          
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©
          if (user.role?.name?.toLowerCase() === 'admin' || user.role?.name?.toLowerCase() === 'ceo') {
            branches = 'üîë Admin (‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤)';
          } else if (branches === '-') {
            branches = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≤‡∏Ç‡∏≤';
          }
          
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
          let allowedSystems = '-';
          const roleAllowedPages = user.role?.allowedPages || [];
          
          if (roleAllowedPages.includes('*')) {
            allowedSystems = 'üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
          } else if (roleAllowedPages.length > 0) {
            const systemNames = roleAllowedPages.map(pageId => {
              const module = modules.find(m => m.id === pageId);
              return module ? module.name : pageId;
            });
            allowedSystems = systemNames.join(', ');
          } else if (user.role?.name?.toLowerCase().includes('admin') || 
                     user.role?.name?.toLowerCase().includes('ceo')) {
            allowedSystems = 'üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
          } else {
            allowedSystems = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏ö‡∏ö';
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <th>
              <label>
                <input type="checkbox" class="checkbox" data-user-id="${user._id}"/></label>
            </th>
            <td class="font-medium">${user.username || '-'}</td>
            <td>
              <div class="flex flex-col">
                <span class="font-medium">${user.employee?.name || '-'}</span>
                ${user.employee?.employeeId ? 
                  `<span class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${user.employee.employeeId}</span>` : 
                  ''
                }
              </div>
            </td>
            <td>
              <span class="badge badge-sm bg-primary text-white border-0 px-2">
                ${user.role?.name || 'No Role'}
              </span>
            </td>
            <td class="text-sm">
              <div class="max-w-xs overflow-hidden">
                <div class="text-sm text-gray-800 dark:text-gray-200" title="${allowedSystems}">
                  ${allowedSystems}
                </div>
                ${roleAllowedPages.length ? 
                  `<div class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${roleAllowedPages.length} ‡∏£‡∏∞‡∏ö‡∏ö</div>` : 
                  ''
                }
              </div>
            </td>
            <td class="text-sm">
              <div class="max-w-xs overflow-hidden">
                <div class="text-sm text-gray-800 dark:text-gray-200" title="${branches}">
                  ${branches}
                </div>
                ${user.checkinBranches?.length ? 
                  `<div class="text-xs text-gray-500 mt-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô: ${user.checkinBranches.length} ‡∏™‡∏≤‡∏Ç‡∏≤</div>` : 
                  ''
                }
              </div>
            </td>
            <td>
              <div class="toggle-status">
                <input type="checkbox" class="toggle toggle-success toggle-sm status-toggle"
                       data-user-id="${user._id}" ${!user.isBlocked ? 'checked' : ''} />
                <span class="status-label ml-2 text-xs ${!user.isBlocked ? 'text-green-600' : 'text-gray-500'}">
                  ${!user.isBlocked ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö'}
                </span>
              </div>
            </td>
            <td>
              <div class="flex gap-1">
                <button class="btn btn-ghost btn-xs text-blue-600 edit-user-btn hover:bg-blue-50" 
                        data-user-id="${user._id}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-ghost btn-xs text-red-600 delete-user-btn hover:bg-red-50" 
                        data-user-id="${user._id}" title="‡∏•‡∏ö">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          fragment.appendChild(tr);
        });
        
        tbody.appendChild(fragment);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï pagination info
        const start = (currentPage - 1) * currentLimit + 1;
        const end = Math.min(start + json.data.length - 1, totalUsers);
        updatePaginationInfo(start, end, totalUsers);
        updatePaginationButtons();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        console.log('‚úÖ Users loaded and sorted successfully');
        if (sortedUsers.length > 0) {
          showNotification(
            `üìä ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${sortedUsers.length} ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
            'info'
          );
        }
        
      } catch (err) {
        console.error('Error loading users:', err);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</td></tr>';
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
      }
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pagination
    function updatePaginationInfo(start, end, total) {
      const paginationInfo = document.getElementById('paginationInfo');
      if (paginationInfo) {
        paginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${start} ‡∏ñ‡∏∂‡∏á ${end} ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      }
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° pagination
    function updatePaginationButtons() {
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const currentPageSpan = document.getElementById('currentPageSpan');
      
      if (prevBtn) {
        prevBtn.disabled = currentPage <= 1;
        prevBtn.className = currentPage <= 1 ? 'btn btn-sm btn-disabled' : 'btn btn-sm';
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentPage >= totalPages;
        nextBtn.className = currentPage >= totalPages ? 'btn btn-sm btn-disabled' : 'btn btn-sm';
      }
      
      if (currentPageSpan) {
        currentPageSpan.textContent = currentPage;
      }
    }
    
    // Initialize application
    document.addEventListener('DOMContentLoaded', async () => {
      if (!token) {
        showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà', 'error');
        return;
      }
      
      try {
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Socket.IO
        initializeSocket();
        
        // Load ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö sequential ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug
        console.log('üîÑ Loading modules...');
        loadModules();
        
        console.log('üîÑ Loading employees...');
        await loadEmployees();
        
        console.log('üîÑ Loading roles...');
        const roles = await loadRoles();
        console.log('‚úÖ Roles loaded:', roles?.length || 0);
        
        console.log('üîÑ Loading branches...');
        await loadBranches();
        
        console.log('üîÑ Loading users...');
        await loadUsersWithFilter();
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏á‡πÉ‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        console.log('üîÑ Loading branches into UI...');
        await loadBranchesIntoUI();
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô filter
        await loadRoleFilter();
        await loadBranchFilter();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners
        setupEventListeners();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API
        updateApiStatus();
        
        showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
        
      } catch (error) {
        console.error('Error during initialization:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
        updateApiStatus();
      }
    });
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners
    function setupEventListeners() {
      // Filter button
      document.getElementById('filterBtn')?.addEventListener('click', () => {
        currentFilters.role = document.getElementById('roleFilter').value;
        currentFilters.branch = document.getElementById('branchFilter').value;
        currentFilters.status = document.getElementById('statusFilter').value;
        currentFilters.search = document.getElementById('searchInput').value;
        currentFilters.sort = document.getElementById('sortFilter').value;
        
        loadUsersWithFilter(true);
      });
      
      // Reset filter button
      document.getElementById('resetFilterBtn')?.addEventListener('click', () => {
        document.getElementById('roleFilter').value = 'all';
        document.getElementById('branchFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('searchInput').value = '';
        document.getElementById('sortFilter').value = 'name-asc';
        
        currentFilters = {
          role: 'all',
          branch: 'all',
          status: 'all',
          search: '',
          sort: 'name-asc'
        };
        
        loadUsersWithFilter(true);
      });
      
      // Sort filter change event
      document.getElementById('sortFilter')?.addEventListener('change', (e) => {
        currentFilters.sort = e.target.value;
        loadUsersWithFilter(true);
      });
      
      // Pagination buttons
      document.getElementById('prevPageBtn')?.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadUsersWithFilter();
        }
      });
      
      document.getElementById('nextPageBtn')?.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadUsersWithFilter();
        }
      });
      
      // Limit select
      document.getElementById('limitSelect')?.addEventListener('change', (e) => {
        currentLimit = parseInt(e.target.value);
        loadUsersWithFilter(true);
      });
      
      // Search input (debounced)
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentFilters.search = e.target.value;
            loadUsersWithFilter(true);
          }, 500);
        });
      }
    }
    
    // Override loadUsers function to use the new filtering version
    async function loadUsers(forceRefresh = false) {
      await loadUsersWithFilter(forceRefresh);
    }
  </script>
</body>
</html>