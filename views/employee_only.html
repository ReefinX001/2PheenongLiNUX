<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡πÄ‡∏•‡∏∞‡πÇ‡∏ö‡∏ô‡∏±‡∏™ - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'prompt': ['Prompt', 'sans-serif'],
          }
        }
      }
    };
  </script>

  <!-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ authToken ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authToken ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà redirect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    function checkInitialAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        console.warn('No auth token found - user may need to login');
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ redirect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        return false;
      }
      return true;
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à - ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö auth
    window.addEventListener('load', function() {
      console.log('Employee page loaded - auth check disabled');
      // ‡∏´‡∏≤‡∏Å token ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ redirect
      if (!checkInitialAuth()) {
        console.warn('No auth token - continuing without redirect');
        // ‡πÑ‡∏°‡πà redirect ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠
      }
    });
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <style>
    .wallet-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bonus-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .withdraw-card {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .notification-badge {
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
      40%, 43% { transform: translateY(-10px); }
      70% { transform: translateY(-5px); }
      90% { transform: translateY(-2px); }
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body class="font-prompt bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/dashboard" class="flex items-center space-x-2">
            <i class="bi bi-arrow-left text-gray-600 text-xl"></i>
            <span class="text-gray-600">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
          </a>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Employee Profile Section -->
          <div class="flex items-center space-x-3">
            <div class="relative">
              <img id="employeePhoto" src="/uploads/employees/default-avatar.png?v=2" alt="Employee Photo"
                   class="w-10 h-10 rounded-full object-cover border-2 border-gray-300"
                   onerror="this.src='/uploads/employees/default-avatar.png?v=2'">
              <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"
                   id="onlineStatus" title="‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"></div>
            </div>
            <div class="hidden md:block">
              <div id="employeeName" class="text-gray-700 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
              <div id="employeePosition" class="text-sm text-gray-500">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
            </div>
          </div>
          <!-- Notification Bell -->
          <div class="relative">
            <button id="notificationBtn" class="p-2 text-gray-600 hover:text-gray-800 relative">
              <i class="bi bi-bell text-xl"></i>
              <span id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center notification-badge hidden">0</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center space-x-4 mb-4">
        <img id="headerEmployeePhoto" src="/uploads/employees/default-avatar.png?v=2" alt="Employee Photo"
             class="w-16 h-16 rounded-full object-cover border-4 border-blue-200"
             onerror="this.src='/uploads/employees/default-avatar.png?v=2'">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏°</h1>
          <div class="flex items-center space-x-4 mt-1">
            <p class="text-gray-600">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <span id="headerEmployeeName" class="font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
            <span class="text-sm text-gray-500">|</span>
            <p class="text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="headerEmployeeId" class="font-mono">-</span></p>
            <span class="text-sm text-gray-500">|</span>
            <p class="text-gray-600">‡∏™‡∏≤‡∏Ç‡∏≤: <span id="headerBranchName" class="font-medium">-</span></p>
          </div>
        </div>
      </div>
      <p class="text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°</p>
    </div>

    <!-- Income Summary Cards -->
    <div class="space-y-6 mb-8">
      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, OT, Incentive, ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
          <div class="flex items-center justify-between mb-3">
            <i class="bi bi-cash-stack text-2xl text-blue-600"></i>
            <span class="text-sm text-gray-600 font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
          </div>
          <div class="mb-2">
            <h3 id="baseSalary" class="text-2xl font-bold text-gray-900">‡∏ø0.00</h3>
          </div>
          <p class="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</p>
        </div>

        <!-- OT -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
          <div class="flex items-center justify-between mb-3">
            <i class="bi bi-clock text-2xl text-green-600"></i>
            <span class="text-sm text-gray-600 font-medium">OT</span>
          </div>
          <div class="mb-2">
            <h3 id="overtimeAmount" class="text-2xl font-bold text-gray-900">‡∏ø0.00</h3>
          </div>
          <p class="text-xs text-gray-500">‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>
        </div>

        <!-- Incentive -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
          <div class="flex items-center justify-between mb-3">
            <i class="bi bi-trophy text-2xl text-purple-600"></i>
            <span class="text-sm text-gray-600 font-medium">Incentive</span>
          </div>
          <div class="mb-2">
            <h3 id="incentiveAmount" class="text-2xl font-bold text-gray-900">‡∏ø0.00</h3>
          </div>
          <p class="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏π‡∏á‡πÉ‡∏à</p>
        </div>

        <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÄ‡∏î‡πà‡∏ô) -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl shadow-xl p-6 text-white transform hover:scale-105 transition-transform duration-200">
          <div class="flex items-center justify-between mb-3">
            <i class="bi bi-wallet2 text-3xl text-white"></i>
            <span class="text-sm text-white font-medium opacity-90">‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
          </div>
          <div class="mb-2">
            <h3 id="netIncome" class="text-3xl font-bold text-white pulse-animation">‡∏ø0.00</h3>
          </div>
          <p class="text-xs text-white opacity-80">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        </div>
      </div>

      <!-- ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á -->
      <div class="border-t border-gray-200 my-6"></div>

      <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°, ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏° -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏° -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white relative overflow-hidden">
          <div class="glass-effect absolute inset-0 rounded-xl"></div>
          <div class="relative z-10">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-graph-up-arrow text-3xl"></i>
              <span class="text-base opacity-90 font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°</span>
            </div>
            <div class="mb-3">
              <h2 id="totalIncome" class="text-3xl font-bold">‡∏ø0.00</h2>
            </div>
            <p class="text-xs opacity-90">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span></p>
            <div class="text-xs opacity-90 space-y-1 mb-2">
              <div>‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô: <span id="workExperience" class="font-semibold">0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>
              <div>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: <span id="totalWorkDays" class="font-semibold">0 ‡∏ß‡∏±‡∏ô</span></div>
            </div>
            <div class="mt-3 flex items-center space-x-4 text-xs">
              <span class="opacity-80">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: <span id="thisYearIncome" class="font-semibold">‡∏ø0.00</span></span>
            </div>
          </div>
        </div>

        <!-- ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏° -->
        <div id="bonusCard" class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white relative overflow-hidden cursor-pointer transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
          <div class="glass-effect absolute inset-0 rounded-xl"></div>
          <div class="relative z-10">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-star-fill text-3xl"></i>
              <div class="text-right">
                <div class="text-base opacity-90 font-medium">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏°</div>
                <div class="text-xs opacity-75">(‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°)</div>
              </div>
            </div>
            <div class="mb-3">
              <h2 id="totalBonus" class="text-3xl font-bold pulse-animation">‡∏ø0.00</h2>
            </div>
            <p class="text-xs opacity-90">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: <span id="bonusIncrease" class="font-semibold">+‡∏ø0.00</span></p>
            <div class="mt-3 flex items-center space-x-4 text-xs">
              <span class="opacity-80">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: <span id="thisYearBonus" class="font-semibold">‡∏ø0.00</span></span>
            </div>
            <!-- Click indicator -->
            <div class="absolute top-2 right-2">
              <i class="bi bi-arrow-right-circle text-white opacity-75 text-lg"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Debug Panel (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô Development) -->
  <div id="debugPanel" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-lg max-w-md hidden z-40">
    <div class="flex items-center justify-between mb-2">
      <h4 class="font-semibold text-sm">Debug Information</h4>
      <button onclick="toggleDebugPanel()" class="text-gray-400 hover:text-white">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="text-xs space-y-1">
      <div>API: <span id="debugAPIStatus" class="text-yellow-400">Testing...</span></div>
      <div>Employee Data: <span id="debugEmployeeStatus" class="text-yellow-400">Loading...</span></div>
      <div>Image URL: <span id="debugImageStatus" class="text-yellow-400">Checking...</span></div>
      <div>Environment: <span id="debugEnvironment" class="text-blue-400"></span></div>
    </div>
    <button onclick="testImageLoad()" class="mt-2 bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">
      Test Image Load
    </button>
  </div>

  <!-- Debug Toggle Button -->
  <button id="debugToggle" onclick="toggleDebugPanel()" 
          class="fixed bottom-4 left-4 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full shadow-lg z-40">
    <i class="bi bi-bug"></i>
  </button>

  <!-- Notification Modal -->
  <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-xl max-w-md w-full p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
          <button id="closeNotificationModal" class="text-gray-500 hover:text-gray-700">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div id="notificationContent" class="space-y-3">
          <!-- Notifications will be loaded here -->
        </div>
      </div>
    </div>
  </div>


  <!-- Transaction Detail Modal -->
  <div id="transactionDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-xl max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h3>
          <button id="closeTransactionDetailModal" class="text-gray-500 hover:text-gray-700">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>

        <!-- Transaction Header -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div id="detailTransactionIcon" class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="bi bi-cash-coin text-blue-600 text-xl"></i>
              </div>
              <div>
                <h4 id="detailTransactionType" class="text-lg font-semibold text-gray-900">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h4>
                <p id="detailTransactionRef" class="text-sm text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: TXN-2024-001</p>
              </div>
            </div>
            <div class="text-right">
              <div id="detailTransactionAmount" class="text-2xl font-bold text-green-600">+‡∏ø2,000</div>
              <div id="detailTransactionStatus" class="text-sm text-green-600 font-medium">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
            </div>
          </div>
        </div>

        <!-- Transaction Details -->
        <div class="space-y-6">
          <!-- Basic Information -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <div id="detailTransactionDate" class="font-medium text-gray-900">25 ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2024</div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <div id="detailTransactionTime" class="font-medium text-gray-900">14:30:25</div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <div id="detailTransactionCategory" class="font-medium text-gray-900">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô</div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <div id="detailTransactionSubtype" class="font-medium text-gray-900">‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢</div>
              </div>
            </div>
          </div>

          <!-- Amount Breakdown -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</h5>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å</span>
                <span id="detailBasicAmount" class="font-medium text-gray-900">‡∏ø2,000.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                <span id="detailBonusAmount" class="font-medium text-gray-900">‡∏ø0.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ</span>
                <span id="detailTaxAmount" class="font-medium text-red-600">-‡∏ø0.00</span>
              </div>
              <hr class="border-gray-300">
              <div class="flex justify-between font-semibold">
                <span class="text-gray-900">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                <span id="detailNetAmount" class="text-green-600">‡∏ø2,000.00</span>
              </div>
            </div>
          </div>

          <!-- Reason and Description -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡πÇ‡∏≠‡∏Å‡∏≤‡∏™</h5>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™</label>
                <div id="detailOccasion" class="font-medium text-gray-900">‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ 120%</div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                <div id="detailDescription" class="text-gray-700">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ 20% ‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</div>
              </div>
            </div>
          </div>

          <!-- Verification Info -->
          <div class="bg-green-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <div class="flex items-center space-x-2">
                  <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <i class="bi bi-person text-gray-600"></i>
                  </div>
                  <div>
                    <div id="detailDataEntry" class="font-medium text-gray-900">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</div>
                    <div class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢</div>
                  </div>
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                <div class="flex items-center space-x-2">
                  <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <i class="bi bi-person-check text-gray-600"></i>
                  </div>
                  <div>
                    <div id="detailApprover" class="font-medium text-gray-900">‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥</div>
                    <div class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢ HR</div>
                  </div>
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <div id="detailEntryDate" class="font-medium text-gray-900">25 ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2024 - 14:25</div>
              </div>
              <div>
                <label class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
                <div id="detailApprovalDate" class="font-medium text-gray-900">25 ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2024 - 14:30</div>
              </div>
            </div>
          </div>

          <!-- Supporting Documents -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h5>
            <div id="detailDocuments" class="space-y-2">
              <div class="flex items-center space-x-3 p-2 border border-gray-200 rounded">
                <i class="bi bi-file-earmark-text text-blue-600"></i>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</div>
                  <div class="text-sm text-gray-500">PDF - 256 KB</div>
                </div>
                <button class="text-blue-600 hover:text-blue-800">
                  <i class="bi bi-download"></i>
                </button>
              </div>
              <div class="flex items-center space-x-3 p-2 border border-gray-200 rounded">
                <i class="bi bi-file-earmark-spreadsheet text-green-600"></i>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô</div>
                  <div class="text-sm text-gray-500">Excel - 84 KB</div>
                </div>
                <button class="text-blue-600 hover:text-blue-800">
                  <i class="bi bi-download"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- System Logs -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h5 class="font-semibold text-gray-900 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö</h5>
            <div id="detailSystemLogs" class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <span class="text-gray-900">25/11/2024 14:25 ‡πÇ‡∏î‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                <span class="text-gray-900">25/11/2024 14:26 ‡πÇ‡∏î‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                <span class="text-gray-900">25/11/2024 14:30 ‡πÇ‡∏î‡∏¢ ‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡∏®‡∏£‡∏µ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span>
                <span class="text-gray-900">25/11/2024 14:30 ‡πÇ‡∏î‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3 mt-6">
          <button class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
            <i class="bi bi-printer mr-2"></i>
            ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          </button>
          <button class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors font-medium">
            <i class="bi bi-download mr-2"></i>
            ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API Configuration - Detect environment and use appropriate API URL
    let API_BASE_URL = 'http://localhost:3000';
    
    // Check if we're running on production domain
    if (window.location.hostname === 'www.2pheenong.com' || window.location.hostname === '2pheenong.com') {
      API_BASE_URL = 'https://www.2pheenong.com';
      console.log('Production environment detected');
    } else if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      // For other domains, use the current origin
      API_BASE_URL = window.location.origin;
      console.log('Using current origin as API base:', API_BASE_URL);
    }
    
    console.log('API_BASE_URL set to:', API_BASE_URL);
    console.log('Current hostname:', window.location.hostname);
    console.log('Current origin:', window.location.origin);

    // Global HR Data Storage
    let hrData = {
      employee: null,
      salaries: [],
      attendance: [],
      leaves: [],
      announcements: [],
      commission: [],
      bonuses: [], // Add bonuses array
      totalBonus: 0,
      thisYearBonus: 0,
      totalSalary: 0,
      attendanceRate: 0
    };

    // Authentication helpers
    function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    function handleAuthError(response) {
      if (response.status === 401 || response.status === 403) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userName');
        console.warn('Auth cleared - staying on page for debugging');
        // window.location.href = '/login'; // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£ redirect
        return true;
      }
      return false;
    }

    // Get current user information from localStorage
    function getCurrentUser() {
      return {
        userId: localStorage.getItem('userId'),
        token: localStorage.getItem('authToken'),
        role: localStorage.getItem('userRole'),
        name: localStorage.getItem('userName'),
        branchId: localStorage.getItem('branchId'),
        employeeId: localStorage.getItem('employeeId')
      };
    }

    // Check if user is authenticated (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
    function checkAuthentication() {
      const user = getCurrentUser();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
      if (!user.token) {
        console.warn('No token found - continuing without authentication');
        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error modal ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠
        // showAuthenticationError(); // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á error
        return true; // ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ token
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á token
      try {
        // ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö format ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        const tokenParts = user.token.split('.');
        if (tokenParts.length !== 3) {
          console.warn('Invalid token format detected');
          showAuthenticationError();
          return false;
        }
      } catch (error) {
        console.warn('Token validation error:', error);
        showAuthenticationError();
        return false;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ userId ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      if (!user.userId) {
        console.warn('No userId found, but token exists - continuing with limited functionality');
        // ‡πÑ‡∏°‡πà redirect ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏ï‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô console
        return true; // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      }

      return true;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    function showAuthenticationError() {
      const errorMessage = `
        <div class="fixed inset-0 bg-red-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg shadow-lg p-8 max-w-lg mx-4">
            <div class="text-center">
              <i class="bi bi-exclamation-triangle text-red-500 text-4xl mb-4"></i>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</h3>
              <p class="text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>

              <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug -->
              <div class="bg-gray-100 p-4 rounded-lg mb-4 text-left text-sm">
                <h4 class="font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Debug:</h4>
                <div id="authDebugInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
              </div>

              <div class="space-y-3">
                <button onclick="window.location.href='/login'" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                  ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
                </button>
                <button onclick="location.reload()" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700">
                  ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
                <button onclick="window.open('/debug-auth.html', '_blank')" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700">
                  üîç Debug Authentication
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ redirect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      document.body.insertAdjacentHTML('beforeend', errorMessage);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug
      setTimeout(() => {
        const debugElement = document.getElementById('authDebugInfo');
        if (debugElement) {
          const authData = {
            authToken: localStorage.getItem('authToken') ? '‡∏°‡∏µ' : '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            userId: localStorage.getItem('userId') || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            userName: localStorage.getItem('userName') || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            userRole: localStorage.getItem('userRole') || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            employeeId: localStorage.getItem('employeeId') || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            branchId: localStorage.getItem('branchId') || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
            totalItems: localStorage.length
          };

          let debugHtml = '';
          Object.keys(authData).forEach(key => {
            debugHtml += `<div><strong>${key}:</strong> ${authData[key]}</div>`;
          });

          debugElement.innerHTML = debugHtml;
        }
      }, 100);
    }

    // HR Data Fetching Functions
    async function fetchEmployeeData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No userId found, will try to get employee data from token');
        }

        // Try multiple endpoints to get employee data including profile pictures
        const endpoints = [
          `/api/hr/employees/user/${currentUser.userId}`,
          `/api/hr/employees/profile`,
          `/api/employees/user/${currentUser.userId}`,
          `/api/employees/profile`,
          `/api/employees/${currentUser.userId}`,
          `/api/hr/employees/${currentUser.userId || 'current'}`,
          `/api/users/${currentUser.userId}`,
          `/api/users/profile`,
          `/api/auth/profile`,
          `/api/profile`
        ];

        for (const endpoint of endpoints) {
          try {
            // Skip endpoints that require userId if we don't have it
            if (endpoint.includes('/undefined') || (endpoint.includes('/user/') && !currentUser.userId)) {
              console.log(`Skipping ${endpoint} - no userId available`);
              continue;
            }

            console.log(`Trying endpoint: ${endpoint}`);
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              headers: getAuthHeaders()
            });

            if (handleAuthError(response)) return null;

            if (response.ok) {
              const result = await response.json();
              console.log(`Response from ${endpoint}:`, result);

              let employeeData = null;

              // Handle different response formats
              if (result.success && result.data) {
                employeeData = result.data;
              } else if (result.employee) {
                employeeData = result.employee;
              } else if (result.data && result.data.employee) {
                employeeData = result.data.employee;
              } else if (result.user) {
                employeeData = result.user;
              } else if (result.data && result.data.user) {
                employeeData = result.data.user;
              } else if (result && typeof result === 'object' && (result.name || result.first_name)) {
                employeeData = result;
              }

              if (employeeData) {
                console.log('Employee data found:', employeeData);

                // Store additional employee info in localStorage
                if (employeeData.employeeId || employeeData.employee_id || employeeData.id) {
                  localStorage.setItem('employeeId', employeeData.employeeId || employeeData.employee_id || employeeData.id);
                }
                if (employeeData.branchId || employeeData.branch_id) {
                  localStorage.setItem('branchId', employeeData.branchId || employeeData.branch_id);
                }

                // Process and normalize employee data for consistent access
                const normalizedData = normalizeEmployeeData(employeeData);
                return normalizedData;
              }
            }
          } catch (endpointError) {
            console.warn(`Error with endpoint ${endpoint}:`, endpointError);
            continue; // Try next endpoint
          }
        }

        console.warn('No valid employee data found from any endpoint');
      } catch (error) {
        console.error('Error fetching employee data:', error);
      }
      return null;
    }

    // Normalize employee data to handle different field names and formats
    function normalizeEmployeeData(rawData) {
      const normalized = {
        id: rawData.id || rawData.userId || rawData.user_id || rawData.employeeId || rawData.employee_id,
        employeeId: rawData.employeeId || rawData.employee_id || rawData.emp_code || rawData.id,
        name: rawData.name || rawData.full_name || (rawData.first_name && rawData.last_name ? `${rawData.first_name} ${rawData.last_name}` : null) || rawData.display_name,
        firstName: rawData.firstName || rawData.first_name,
        lastName: rawData.lastName || rawData.last_name,
        position: rawData.position || rawData.job_title || rawData.role,
        department: rawData.department || rawData.dept,
        branchId: rawData.branchId || rawData.branch_id,
        branchName: rawData.branchName || rawData.branch_name || rawData.branch,
        email: rawData.email || rawData.email_address,
        phone: rawData.phone || rawData.phone_number || rawData.tel,
        startDate: rawData.startDate || rawData.start_date || rawData.hireDate || rawData.hire_date || rawData.joinDate || rawData.join_date,
    
        // Handle multiple possible image field names
        imageUrl: getEmployeeImageUrl(rawData),
    
        // Additional fields
        salary: rawData.salary || rawData.base_salary,
        status: rawData.status || rawData.employee_status,
        gender: rawData.gender,
        birthDate: rawData.birthDate || rawData.birth_date || rawData.dob
      };

      console.log('Normalized employee data:', normalized);
      return normalized;
    }

    // Extract image URL from various possible field names
    function getEmployeeImageUrl(employeeData) {
      const imageFields = [
        'imageUrl', 'image_url', 'image',
        'photoUrl', 'photo_url', 'photo',
        'avatar', 'avatar_url',
        'profileImage', 'profile_image', 'profile_image_url',
        'profilePicture', 'profile_picture',
        'picture', 'picture_url',
        'thumbnail', 'thumbnail_url'
      ];

      let imageUrl = null;

      // Try each possible field
      for (const field of imageFields) {
        if (employeeData[field] && employeeData[field].trim() !== '') {
          imageUrl = employeeData[field];
          console.log(`Found image URL in field '${field}':`, imageUrl);
          break;
        }
      }

      // If we found an image URL, process it
      if (imageUrl) {
        // Handle relative URLs
        if (imageUrl.startsWith('/')) {
          imageUrl = `${API_BASE_URL}${imageUrl}`;
        }
        // Handle URLs that don't start with http
        else if (!imageUrl.startsWith('http')) {
          imageUrl = `${API_BASE_URL}/${imageUrl}`;
        }

        // Add timestamp to prevent caching issues
        const separator = imageUrl.includes('?') ? '&' : '?';
        imageUrl = `${imageUrl}${separator}v=${Date.now()}`;
      }

      console.log('Final processed image URL:', imageUrl);
      return imageUrl;
    }

    async function fetchSalaryData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/salaries?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          return result.success ? result.data.filter(salary =>
            salary.userId === currentUser.userId || salary.employeeId === currentUser.employeeId
          ) : [];
        }
      } catch (error) {
        console.error('Error fetching salary data:', error);
      }
      return [];
    }

    async function fetchAttendanceData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/attendance?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          return result.success ? result.data.filter(attendance =>
            attendance.userId === currentUser.userId || attendance.employeeId === currentUser.employeeId
          ) : [];
        }
      } catch (error) {
        console.error('Error fetching attendance data:', error);
      }
      return [];
    }

    async function fetchLeaveData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/leaves?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          return result.success ? result.data.filter(leave =>
            leave.userId === currentUser.userId || leave.employeeId === currentUser.employeeId
          ) : [];
        }
      } catch (error) {
        console.error('Error fetching leave data:', error);
      }
      return [];
    }

    async function fetchAnnouncementData() {
      try {
        const currentUser = getCurrentUser();

        // Announcements are usually for all employees, but can be filtered by branch
        const response = await fetch(`${API_BASE_URL}/api/hr/announcements?branchId=${currentUser.branchId || ''}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          return result.success ? result.data : [];
        }
      } catch (error) {
        console.error('Error fetching announcement data:', error);
      }
      return [];
    }

    async function fetchCommissionData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) return [];

        const response = await fetch(`${API_BASE_URL}/api/hr/commission/history?userId=${currentUser.userId}&employeeId=${currentUser.employeeId || ''}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          return result.success ? result.data.filter(commission =>
            commission.userId === currentUser.userId || commission.employeeId === currentUser.employeeId
          ) : [];
        }
      } catch (error) {
        console.error('Error fetching commission data:', error);
      }
      return [];
    }

    // Add function to fetch bonus data
    async function fetchBonusData() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser.userId) {
          console.warn('No user ID available for loading bonus data');
          return [];
        }

        console.log('Fetching personal bonus data for user:', currentUser.userId);

        // Use the same endpoint as payroll.html and Bonusdetail.html for consistency
        const response = await fetch(`${API_BASE_URL}/api/hr/bonus?userId=${currentUser.userId}`, {
          headers: getAuthHeaders()
        });

        if (handleAuthError(response)) return [];

        if (response.ok) {
          const result = await response.json();
          console.log('Personal bonus data response:', result);

          // Handle response format same as other files
          let bonusData = result.data || result || [];

          if (Array.isArray(bonusData)) {
            console.log(`Found ${bonusData.length} personal bonuses for user ${currentUser.userId}`);
            return bonusData;
          } else {
            console.warn('Bonus data is not an array:', bonusData);
            return [];
          }
        } else {
          console.warn('Failed to load bonus data:', response.status, response.statusText);
          return [];
        }
      } catch (error) {
        console.error('Error fetching bonus data:', error);
        return [];
      }
    }

    // Calculate totals from HR data
    function calculateHRTotals() {
      // Calculate total bonus from both commission and bonus data
      const commissionTotal = hrData.commission.reduce((total, comm) => total + (comm.amount || 0), 0);
      const bonusTotal = hrData.bonuses.reduce((total, bonus) => total + (bonus.amount || 0), 0);
      hrData.totalBonus = commissionTotal + bonusTotal;

      // Calculate this year bonus from both sources
      const currentYear = new Date().getFullYear();
      const thisYearCommission = hrData.commission
        .filter(comm => new Date(comm.date || comm.createdAt).getFullYear() === currentYear)
        .reduce((total, comm) => total + (comm.amount || 0), 0);

      const thisYearBonus = hrData.bonuses
        .filter(bonus => new Date(bonus.date || bonus.createdAt).getFullYear() === currentYear)
        .reduce((total, bonus) => total + (bonus.amount || 0), 0);

      hrData.thisYearBonus = thisYearCommission + thisYearBonus;

      // Calculate total salary
      hrData.totalSalary = hrData.salaries.reduce((total, salary) => total + (salary.amount || 0), 0);

      // Calculate attendance rate
      const totalDays = hrData.attendance.length;
      const presentDays = hrData.attendance.filter(att => att.status === 'present').length;
      hrData.attendanceRate = totalDays > 0 ? (presentDays / totalDays) * 100 : 0;
    }

    // Function to update employee photo with proper fallback and real API support
    function updateEmployeePhoto(photoUrl) {
      const defaultPhoto = '/uploads/employees/default-avatar.png?v=' + Date.now();

      // List of photo elements to update
      const photoElements = [
        { id: 'employeePhoto', fallback: 'nav' },
        { id: 'headerEmployeePhoto', fallback: 'header' }
      ];

      photoElements.forEach(element => {
        const imgElement = document.getElementById(element.id);
        if (imgElement) {
          // If we have a photo URL from employee data, try to use it
          if (photoUrl && photoUrl.trim() !== '') {
            console.log(`Setting ${element.fallback} photo to:`, photoUrl);
    
            // Create a new image to test if URL is valid
            const testImg = new Image();
            testImg.crossOrigin = 'anonymous'; // Handle CORS if needed
    
            testImg.onload = function() {
              console.log(`${element.fallback} photo loaded successfully:`, photoUrl);
              imgElement.src = photoUrl;
              imgElement.style.display = 'block';
    
              // Remove any previous error placeholders
              const errorPlaceholder = imgElement.nextElementSibling;
              if (errorPlaceholder && errorPlaceholder.textContent === 'üë§') {
                errorPlaceholder.remove();
              }
            };
    
            testImg.onerror = function() {
              console.warn(`Failed to load ${element.fallback} photo from:`, photoUrl);
    
              // Try alternative image paths
              const alternatives = [
                photoUrl.replace(/^https?:\/\/[^\/]+/, API_BASE_URL),
                `${API_BASE_URL}/uploads/employees/${photoUrl.split('/').pop()}`,
                `${API_BASE_URL}/uploads/users/${photoUrl.split('/').pop()}`,
                `${API_BASE_URL}/images/employees/${photoUrl.split('/').pop()}`,
                defaultPhoto
              ];
    
              tryAlternativeImages(imgElement, alternatives, element.fallback, 0);
            };
    
            // Start testing the image
            testImg.src = photoUrl;
    
          } else {
            // No photo URL provided, use default
            console.log(`No photo URL for employee, using default for ${element.fallback}`);
            setImageWithFallback(imgElement, defaultPhoto, element.fallback);
          }
        }
      });
    }

    // Try alternative image URLs if the primary one fails
    function tryAlternativeImages(imgElement, alternatives, fallbackType, index) {
      if (index >= alternatives.length) {
        // All alternatives failed, show placeholder
        console.warn(`All image alternatives failed for ${fallbackType}, showing placeholder`);
        showImagePlaceholder(imgElement);
        return;
      }
    
      const currentUrl = alternatives[index];
      console.log(`Trying alternative ${index + 1} for ${fallbackType}:`, currentUrl);
    
      const testImg = new Image();
      testImg.crossOrigin = 'anonymous';
    
      testImg.onload = function() {
        console.log(`Alternative image ${index + 1} loaded successfully for ${fallbackType}:`, currentUrl);
        imgElement.src = currentUrl;
        imgElement.style.display = 'block';
      };
    
      testImg.onerror = function() {
        console.warn(`Alternative image ${index + 1} failed for ${fallbackType}:`, currentUrl);
        // Try next alternative
        tryAlternativeImages(imgElement, alternatives, fallbackType, index + 1);
      };
    
      testImg.src = currentUrl;
    }

    // Set image with fallback handling
    function setImageWithFallback(imgElement, imageUrl, fallbackType) {
      const testImg = new Image();
      testImg.crossOrigin = 'anonymous';
    
      testImg.onload = function() {
        console.log(`${fallbackType} default photo loaded successfully`);
        imgElement.src = imageUrl;
        imgElement.style.display = 'block';
      };
    
      testImg.onerror = function() {
        console.warn(`Default photo failed for ${fallbackType}, showing placeholder`);
        showImagePlaceholder(imgElement);
      };
    
      testImg.src = imageUrl;
    }

    // Show placeholder when all image options fail
    function showImagePlaceholder(imgElement) {
      imgElement.style.display = 'none';
    
      // Remove existing placeholder if any
      const existingPlaceholder = imgElement.nextElementSibling;
      if (existingPlaceholder && existingPlaceholder.textContent === 'üë§') {
        existingPlaceholder.remove();
      }
    
      // Create new placeholder
      const placeholder = document.createElement('div');
      placeholder.className = imgElement.className;
      placeholder.style.cssText = `
        background: #e5e7eb; 
        color: #9ca3af; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 24px;
        border-radius: 50%;
      `;
      placeholder.textContent = 'üë§';
      placeholder.title = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ';
    
      imgElement.parentNode.insertBefore(placeholder, imgElement.nextSibling);
    }

    // Calculate work experience and savings based on employee data
    function calculateWorkExperienceAndSavings(employee) {
      const now = new Date();
      let startDate = new Date();
      let totalSavings = 0;
      let monthlySavings = 0;
      let workExperienceText = '0 ‡∏õ‡∏µ 0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';

      if (employee && employee.startDate) {
        startDate = new Date(employee.startDate);
      } else if (employee && employee.hireDate) {
        startDate = new Date(employee.hireDate);
      } else if (employee && employee.joinDate) {
        startDate = new Date(employee.joinDate);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        const firstSalary = hrData.salaries.sort((a, b) => new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt))[0];
        if (firstSalary) {
          startDate = new Date(firstSalary.date || firstSalary.createdAt);
        }
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      const diffTime = Math.abs(now - startDate);
      const totalDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      const totalMonths = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 30.44)); // ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 30.44 ‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏µ, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏ß‡∏±‡∏ô ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
      const years = Math.floor(totalDays / 365);
      const remainingDaysAfterYears = totalDays % 365;
      const months = Math.floor(remainingDaysAfterYears / 30);
      const days = remainingDaysAfterYears % 30;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      let workExperienceParts = [];
      if (years > 0) workExperienceParts.push(`${years} ‡∏õ‡∏µ`);
      if (months > 0) workExperienceParts.push(`${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
      if (days > 0 || workExperienceParts.length === 0) workExperienceParts.push(`${days} ‡∏ß‡∏±‡∏ô`);

      workExperienceText = workExperienceParts.join(' ');

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô
      // ‡∏™‡∏π‡∏ï‡∏£: ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ê‡∏≤‡∏ô √ó 0.05 (5%) + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô
      const baseSalary = hrData.salaries.length > 0 ?
        hrData.salaries.reduce((total, salary) => total + (salary.baseSalary || salary.amount || 0), 0) / hrData.salaries.length : 0;

      // ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô 5% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      const baseSavingsRate = 0.05;

      // ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô: ‡πÄ‡∏û‡∏¥‡πà‡∏° 0.5% ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10%)
      const experienceBonus = Math.min(years * 0.005, 0.10);

      // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°
      const totalSavingsRate = baseSavingsRate + experienceBonus;

      // ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      monthlySavings = Math.floor(baseSalary * totalSavingsRate);

      // ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏° (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
      totalSavings = monthlySavings * totalMonths;

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° 2% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
      const interestRate = 0.02 / 12; // 2% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      if (totalMonths > 0) {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏ö‡∏ï‡πâ‡∏ô
        const monthlyInterest = totalSavings * interestRate * (totalMonths / 12);
        totalSavings += monthlyInterest;
      }

      return {
        totalSavings: Math.floor(totalSavings),
        monthlySavings: monthlySavings,
        workExperienceText: workExperienceText,
        totalDays: totalDays,
        years: years,
        months: months,
        days: days,
        totalMonths: totalMonths,
        savingsRate: (totalSavingsRate * 100).toFixed(1),
        startDate: startDate.toLocaleDateString('th-TH'),
        workingDaysText: `${totalDays.toLocaleString()} ‡∏ß‡∏±‡∏ô`
      };
    }

    // Test API connection and debug employee data
    async function testAPIConnection() {
      console.log('=== Testing API Connection ===');
      console.log('API Base URL:', API_BASE_URL);
    
      try {
        // Test basic connectivity
        const response = await fetch(`${API_BASE_URL}/api/health`, {
          method: 'GET',
          headers: getAuthHeaders()
        });
    
        if (response.ok) {
          const result = await response.json();
          console.log('API Health Check Success:', result);
        } else {
          console.warn('API Health Check Failed:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('API Connection Error:', error);
      }
    
      // Test employee endpoint specifically
      try {
        const currentUser = getCurrentUser();
        const testEndpoint = `/api/employees/profile`;
        console.log('Testing employee endpoint:', testEndpoint);
    
        const response = await fetch(`${API_BASE_URL}${testEndpoint}`, {
          headers: getAuthHeaders()
        });
    
        console.log('Employee endpoint response status:', response.status);
    
        if (response.ok) {
          const result = await response.json();
          console.log('Employee endpoint response:', result);
    
          // Look for image data specifically
          if (result && typeof result === 'object') {
            console.log('Searching for image fields in response...');
            const imageFields = ['imageUrl', 'image_url', 'photo', 'avatar', 'profile_image'];
            imageFields.forEach(field => {
              if (result[field]) {
                console.log(`Found image field '${field}':`, result[field]);
              }
            });
          }
        } else {
          console.warn('Employee endpoint failed:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('Employee endpoint error:', error);
      }
    }

    // Load all HR data
    async function loadAllHRData() {
      try {
        console.log('Loading HR data...');

        // Test API connection first
        await testAPIConnection();

        // Fetch all data in parallel
        const [employee, salaries, attendance, leaves, announcements, commission, bonuses] = await Promise.all([
          fetchEmployeeData(),
          fetchSalaryData(),
          fetchAttendanceData(),
          fetchLeaveData(),
          fetchAnnouncementData(),
          fetchCommissionData(),
          fetchBonusData() // Add bonus data fetching
        ]);

        // Store in global hrData object
        hrData.employee = employee;
        hrData.salaries = salaries;
        hrData.attendance = attendance;
        hrData.leaves = leaves;
        hrData.announcements = announcements;
        hrData.commission = commission;
        hrData.bonuses = bonuses; // Store bonus data

        // Calculate totals
        calculateHRTotals();

        console.log('HR Data loaded:', hrData);
    
        // Debug employee image specifically
        if (hrData.employee && hrData.employee.imageUrl) {
          console.log('Employee image URL found:', hrData.employee.imageUrl);
    
          // Test if image URL is accessible
          const imgTest = new Image();
          imgTest.onload = () => console.log('Employee image is accessible');
          imgTest.onerror = () => console.warn('Employee image is not accessible');
          imgTest.src = hrData.employee.imageUrl;
        } else {
          console.log('No employee image URL found');
        }
    
        return true;
      } catch (error) {
        console.error('Error loading HR data:', error);
        return false;
      }
    }

    // Debug function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage
    function debugAuthenticationStatus() {
      console.log('=== Debug Authentication Status ===');
      console.log('localStorage contents:');
      console.log('- authToken:', localStorage.getItem('authToken') ? 'EXISTS (length: ' + localStorage.getItem('authToken').length + ')' : 'MISSING');
      console.log('- userId:', localStorage.getItem('userId'));
      console.log('- userRole:', localStorage.getItem('userRole'));
      console.log('- userName:', localStorage.getItem('userName'));
      console.log('- employeeId:', localStorage.getItem('employeeId'));
      console.log('- branchId:', localStorage.getItem('branchId'));
      console.log('- sessionId:', localStorage.getItem('sessionId'));
      console.log('- allowedPages:', localStorage.getItem('allowedPages'));
      console.log('- Total localStorage items:', localStorage.length);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å item ‡πÉ‡∏ô localStorage
      console.log('All localStorage items:');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        console.log(`  ${key}: ${value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : 'null'}`);
      }

      const currentUser = getCurrentUser();
      console.log('getCurrentUser() result:', currentUser);

      // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö token validation
      if (currentUser.token) {
        try {
          const tokenParts = currentUser.token.split('.');
          console.log('Token parts count:', tokenParts.length);
          if (tokenParts.length === 3) {
            console.log('Token appears to be valid JWT format');
            try {
              const payload = JSON.parse(atob(tokenParts[1]));
              console.log('Token payload:', payload);
              if (payload.exp) {
                const expDate = new Date(payload.exp * 1000);
                const now = new Date();
                console.log('Token expires:', expDate.toLocaleString('th-TH'));
                console.log('Token is expired:', expDate <= now);
              }
            } catch (e) {
              console.warn('Cannot decode token payload:', e.message);
            }
          } else {
            console.warn('Token is not in JWT format');
          }
        } catch (e) {
          console.warn('Token validation error:', e.message);
        }
      }

      console.log('==================================');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Debug authentication status
        debugAuthenticationStatus();

        // Check authentication first with graceful handling
        const isAuthenticated = checkAuthentication();

        if (!isAuthenticated) {
          console.warn('Authentication failed, but allowing page to continue with limited functionality');
          // Don't return immediately - allow page to show with limited features
        }

        // Show current user name from localStorage immediately
        const currentUser = getCurrentUser();
        console.log('Current user loaded:', currentUser);

        // Update UI elements if they exist
        const employeeNameElement = document.getElementById('employeeName');
        if (employeeNameElement) {
          employeeNameElement.textContent = currentUser.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }

        // Always setup basic event listeners
        setupEventListeners();

        // Initialize debug panel if in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          setTimeout(updateDebugInfo, 1000);
        }

        if (isAuthenticated && currentUser.token) {
          // Load all HR data if authenticated
          console.log('Loading HR data for authenticated user...');
          const dataLoaded = await loadAllHRData();

          if (dataLoaded) {
            // Initialize page with HR data
            initializeEmployeeData();

            // *** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á ***
            await initializeFallbackMode();

            initializeChart();
            loadTransactions();
            checkForNewNotifications();
    
            // Update debug info after data is loaded
            setTimeout(updateDebugInfo, 2000);
          } else {
            // Fallback: ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• HR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            console.warn('HR data loading failed, using fallback mode');
            initializeFallbackMode();
          }
        } else {
          // If not authenticated, use fallback mode
          console.log('Using fallback mode due to authentication issues');
          initializeFallbackMode();
        }

      } catch (error) {
        console.error('Error during page initialization:', error);
        // Even if there's an error, show fallback mode
        initializeFallbackMode();
        setupEventListeners();
    
        // Update debug info even in error case
        setTimeout(updateDebugInfo, 1000);
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö fallback
    async function initializeFallbackMode() {
      console.log('üîÑ initializeFallbackMode called!');
      const currentUser = getCurrentUser();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
      document.getElementById('employeeName').textContent = currentUser.name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      if (document.getElementById('headerEmployeeName')) {
        document.getElementById('headerEmployeeName').textContent = currentUser.name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      }
      if (document.getElementById('employeePosition')) {
        document.getElementById('employeePosition').textContent = currentUser.role || '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
      }
      if (document.getElementById('headerEmployeeId')) {
        document.getElementById('headerEmployeeId').textContent = currentUser.userId || '-';
      }

      // Update photo in fallback mode
      updateEmployeePhoto(null);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô hrData (‡∏´‡∏≤‡∏Å‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡∏°‡πà
      let baseSalary = 0;
      let overtimeAmount = 0;
      let incentiveAmount = 0;
      let positionAllowance = 0;

      // Load real salary data from API endpoints
      async function loadRealSalaryData() {
        try {
          const currentUser = getCurrentUser();
          console.log('üîç Loading real salary data for user:', currentUser);

          // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ default
          baseSalary = 0;
          overtimeAmount = 0;
          incentiveAmount = 0;
          positionAllowance = 0;

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
          if (!currentUser.userId && !currentUser.employeeId && !currentUser.name) {
            console.log('‚ö†Ô∏è No user identification data found - cannot fetch personal salary data');
            console.log('Current user data:', currentUser);
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
            updateSalaryDisplay();
            return;
          }

          // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å basic-employees
          try {
            console.log('üì° Fetching from /api/basic-employees...');
            const headers = currentUser.token ? getAuthHeaders() : { 'Content-Type': 'application/json' };
            const employeeResponse = await fetch(`${API_BASE_URL}/api/basic-employees`, {
              headers: headers
            });

            if (employeeResponse.ok) {
              const employeeResult = await employeeResponse.json();
              console.log('‚úÖ Basic employees API response:', employeeResult);

              if (employeeResult.success && employeeResult.data?.length > 0) {
                // ‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ user data
                let currentEmployee = null;

                if (currentUser.userId || currentUser.employeeId || currentUser.name) {
                  currentEmployee = employeeResult.data.find(emp => {
                    const matches = emp.employeeId === currentUser.userId ||
                                  emp.employeeId === currentUser.employeeId ||
                                  emp.name === currentUser.name ||
                                  emp._id === currentUser.userId ||
                                  emp.code === currentUser.userId ||
                                  emp.code === currentUser.employeeId;

                    if (matches) {
                      console.log('üë§ Found matching employee:', {
                        name: emp.name,
                        baseSalary: emp.baseSalary,
                        position: emp.position
                      });
                    }
                    return matches;
                  });
                }

                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (!currentEmployee) {
                  console.log('‚ö†Ô∏è No matching employee found in database');
                }

                if (currentEmployee && currentEmployee.baseSalary) {
                  baseSalary = currentEmployee.baseSalary;
                  console.log('üí∞ Base salary from API:', baseSalary);

                  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô hrData
                  hrData.employee = {
                    ...hrData.employee,
                    baseSalary: baseSalary,
                    name: currentEmployee.name,
                    position: currentEmployee.position,
                    department: currentEmployee.department,
                    startDate: currentEmployee.startDate
                  };

                  // ‡πÄ‡∏Å‡πá‡∏ö employee ID ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ monthly payroll
                  currentUser.matchedEmployeeId = currentEmployee._id;
                } else {
                  console.log('‚ö†Ô∏è No employee data available');
                }
              } else {
                console.log('‚ö†Ô∏è No employee data available');
              }
            } else {
              console.log('‚ùå Basic employees API returned:', employeeResponse.status);
            }
          } catch (error) {
            console.log('‚ùå Error fetching basic employees:', error.message);
          }

          // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å monthly-payrolls
          try {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();

            console.log(`üì° Fetching monthly payroll for ${currentMonth}/${currentYear}...`);
            const headers2 = currentUser.token ? getAuthHeaders() : { 'Content-Type': 'application/json' };
            const monthlyResponse = await fetch(`${API_BASE_URL}/api/monthly-payrolls?month=${currentMonth}&year=${currentYear}`, {
              headers: headers2
            });

            if (monthlyResponse.ok) {
              const monthlyResult = await monthlyResponse.json();
              console.log('‚úÖ Monthly payroll API response:', monthlyResult);

              if (monthlyResult.success && monthlyResult.data?.length > 0) {
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                let currentMonthlyData = null;

                // ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ user ID ‡∏´‡∏£‡∏∑‡∏≠ employee ID ‡∏ó‡∏µ‡πà‡∏°‡∏µ
                if (currentUser.userId || currentUser.employeeId || currentUser.matchedEmployeeId) {
                  currentMonthlyData = monthlyResult.data.find(payroll => {
                    const matches = payroll.employeeId === currentUser.userId ||
                                  payroll.employeeId === currentUser.employeeId ||
                                  payroll.employeeId === currentUser.matchedEmployeeId ||
                                  payroll.userEmployeeId === currentUser.userId ||
                                  payroll.userEmployeeId === currentUser.employeeId;

                    if (matches) {
                      console.log('üìã Found matching monthly payroll:', {
                        employeeId: payroll.employeeId,
                        baseSalary: payroll.baseSalary,
                        positionAllowance: payroll.positionAllowance,
                        overtime: payroll.overtime || payroll.otTotal,
                        commission: payroll.commission,
                        note: 'Commission ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Incentive'
                      });
                    }
                    return matches;
                  });
                }

                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• monthly payroll
                if (!currentMonthlyData) {
                  console.log('‚ö†Ô∏è No matching monthly payroll found for current user');
                }

                if (currentMonthlyData) {
                  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                  if (currentMonthlyData.baseSalary && currentMonthlyData.baseSalary > 0) {
                    baseSalary = currentMonthlyData.baseSalary; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å monthly payroll ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
                  }
                  positionAllowance = currentMonthlyData.positionAllowance || 0;
                  overtimeAmount = currentMonthlyData.otTotal || currentMonthlyData.overtime || 0;
                  incentiveAmount = currentMonthlyData.commission || 0; // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô

                  console.log('üíº Updated salary from monthly payroll:', {
                    baseSalary,
                    positionAllowance,
                    overtimeAmount: `‡∏ø${overtimeAmount} (OT)`,
                    incentiveAmount: `‡∏ø${incentiveAmount} (Commission)`,
                    commission: currentMonthlyData.commission
                  });
                } else {
                  console.log('‚ö†Ô∏è No matching monthly payroll data found');
                }
              } else {
                console.log('‚ö†Ô∏è No monthly payroll data available');
              }
            } else {
              console.log('‚ùå Monthly payroll API returned:', monthlyResponse.status);
            }
          } catch (error) {
            console.log('‚ùå Error fetching monthly payroll:', error.message);
          }

          // 3. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          const netIncome = baseSalary + positionAllowance + overtimeAmount + incentiveAmount;

          console.log('üìä Final salary calculation:', {
            baseSalary: `‡∏ø${baseSalary.toLocaleString()} (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)`,
            positionAllowance: `‡∏ø${positionAllowance.toLocaleString()} (‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)`,
            overtimeAmount: `‡∏ø${overtimeAmount.toLocaleString()} (OT)`,
            incentiveAmount: `‡∏ø${incentiveAmount.toLocaleString()} (Commission/‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°)`,
            netIncome: `‡∏ø${netIncome.toLocaleString()} (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`
          });

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
          updateSalaryDisplay();

        } catch (error) {
          console.error('‚ùå Error loading real salary data:', error);

          // Fallback: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å hrData ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
          if (hrData.salaries?.length > 0) {
            baseSalary = hrData.salaries.reduce((total, salary) => total + (salary.baseSalary || salary.amount || 0), 0);
            overtimeAmount = hrData.salaries.reduce((total, salary) => total + (salary.overtime || 0), 0);
            console.log('üîÑ Using fallback salary data from hrData');
          }

          if (hrData.commission?.length > 0) {
            incentiveAmount = hrData.commission.reduce((total, comm) => total + (comm.amount || 0), 0);
          }

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏°‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback
          updateSalaryDisplay();
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      function updateSalaryDisplay() {
        const { regularSalary, netIncome } = calculateDisplayValues();
        const totalAccumulatedIncome = calculateTotalAccumulatedIncome();
        const thisYearIncome = calculateThisYearIncome();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô salary cards
        const baseSalaryEl = document.getElementById('baseSalary');
        const overtimeAmountEl = document.getElementById('overtimeAmount');
        const incentiveAmountEl = document.getElementById('incentiveAmount');
        const netIncomeEl = document.getElementById('netIncome');

        if (baseSalaryEl) baseSalaryEl.textContent = `‡∏ø${regularSalary.toLocaleString()}.00`;
        if (overtimeAmountEl) overtimeAmountEl.textContent = `‡∏ø${overtimeAmount.toLocaleString()}.00`;
        if (incentiveAmountEl) incentiveAmountEl.textContent = `‡∏ø${incentiveAmount.toLocaleString()}.00`;
        if (netIncomeEl) netIncomeEl.textContent = `‡∏ø${netIncome.toLocaleString()}.00`;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°
        const totalIncomeEl = document.getElementById('totalIncome');
        const thisYearIncomeEl = document.getElementById('thisYearIncome');

        if (totalIncomeEl) totalIncomeEl.textContent = `‡∏ø${totalAccumulatedIncome.toLocaleString()}.00`;
        if (thisYearIncomeEl) thisYearIncomeEl.textContent = `‡∏ø${thisYearIncome.toLocaleString()}.00`;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢
        const totalBonusEl = document.getElementById('totalBonus');
        const thisYearBonusEl = document.getElementById('thisYearBonus');

        if (totalBonusEl) totalBonusEl.textContent = `‡∏ø${(hrData.totalBonus || 0).toLocaleString()}.00`;
        if (thisYearBonusEl) thisYearBonusEl.textContent = `‡∏ø${(hrData.thisYearBonus || 0).toLocaleString()}.00`;

        console.log('UI updated with salary and bonus data:', {
          regularSalary,
          overtimeAmount,
          incentiveAmount,
          netIncome,
          totalAccumulatedIncome,
          thisYearIncome,
          totalBonus: hrData.totalBonus || 0,
          thisYearBonus: hrData.thisYearBonus || 0
        });
      }

      // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á payroll.html
      await loadRealSalaryData();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤ API ‡∏à‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
      setTimeout(() => {
        console.log('üîÑ Force updating salary display after timeout');
        updateSalaryDisplay();
      }, 1000);

      function calculateDisplayValues() {
        const regularSalary = baseSalary + positionAllowance; // ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ = ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        const netIncome = regularSalary + overtimeAmount + incentiveAmount;
        return { regularSalary, netIncome };
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      function calculateTotalAccumulatedIncome() {
        // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏° = ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏° + OT ‡∏™‡∏∞‡∏™‡∏°
        const currentEmployee = hrData.employee;
        if (!currentEmployee || !currentEmployee.startDate) {
          return baseSalary; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        }

        const startDate = new Date(currentEmployee.startDate);
        const now = new Date();
        const monthsWorked = Math.floor((now - startDate) / (1000 * 60 * 60 * 24 * 30.44)); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

        // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°
        const accumulatedBaseSalary = baseSalary * Math.max(monthsWorked, 1);

        // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÅ‡∏•‡∏∞ commission ‡∏™‡∏∞‡∏™‡∏°
        const totalBonus = hrData.totalBonus || 0;

        // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°
        const totalAccumulated = accumulatedBaseSalary + totalBonus;

        console.log('Accumulated income calculation:', {
          monthsWorked,
          baseSalary,
          accumulatedBaseSalary,
          totalBonus,
          totalAccumulated
        });

        return totalAccumulated;
      }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
      function calculateThisYearIncome() {
        const currentYear = new Date().getFullYear();
        const startOfYear = new Date(currentYear, 0, 1);
        const now = new Date();

        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        const monthsThisYear = Math.min(now.getMonth() + 1, 12);

        // ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)
        const salaryThisYear = baseSalary * monthsThisYear;

        // ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
        const bonusThisYear = hrData.thisYearBonus || 0;

        const totalThisYear = salaryThisYear + bonusThisYear;

        console.log('This year income calculation:', {
          monthsThisYear,
          baseSalary,
          salaryThisYear,
          bonusThisYear,
          totalThisYear
        });

        return totalThisYear;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      const bonusIncreaseEl = document.getElementById('bonusIncrease');
      const lastUpdateEl = document.getElementById('lastUpdate');

      const bonusIncrease = (hrData.thisYearBonus || 0) * 0.1;
      if (bonusIncreaseEl) bonusIncreaseEl.textContent = `+‡∏ø${bonusIncrease.toLocaleString()}.00`;
      if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleDateString('th-TH');

      console.log('Fallback mode initialized with real API data integration');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏≤‡∏Å‡∏°‡∏µ)
      const workExperienceData = calculateWorkExperienceAndSavings(hrData.employee);
      document.getElementById('workExperience').textContent = workExperienceData.workExperienceText;
      document.getElementById('totalWorkDays').textContent = workExperienceData.workingDaysText;

      if (document.getElementById('withdrawAmount')) {
        document.getElementById('withdrawAmount').textContent = `‡∏ø${(hrData.withdrawableAmount || 0).toLocaleString()}.00`;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ
      const transactionList = document.getElementById('transactionList');
      if (transactionList) {
        if (hrData.commission && hrData.commission.length > 0) {
          loadTransactions(); // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏≤‡∏Å‡∏°‡∏µ
        } else {
          transactionList.innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <i class="bi bi-info-circle text-4xl mb-2"></i>
              <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</p>
              <p class="text-sm opacity-75">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
            </div>
          `;
        }
      }

    }

    // Display additional HR dashboard information
    function displayHRDashboard() {
      // Add new sections to show comprehensive HR data
      addHRSections();
    }

    function addHRSections() {
      // This function will add new sections to display all HR data

      // Add HR Summary Cards
      const hrSummaryHTML = `
        <!-- HR Summary Section -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
          <!-- Salary Summary -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-cash-stack text-3xl text-green-600"></i>
              <span class="text-sm text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">‡∏ø${hrData.totalSalary.toLocaleString()}</h3>
            <p class="text-sm text-gray-500">‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${hrData.salaries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
          </div>

          <!-- Attendance Rate -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-calendar-check text-3xl text-blue-600"></i>
              <span class="text-sm text-gray-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">${hrData.attendanceRate.toFixed(1)}%</h3>
            <p class="text-sm text-gray-500">${hrData.attendance.length} ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
          </div>

          <!-- Leave Balance -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-calendar-x text-3xl text-orange-600"></i>
              <span class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏•‡∏≤</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">${hrData.leaves.length}</h3>
            <p class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
          </div>

          <!-- Announcements -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <i class="bi bi-megaphone text-3xl text-purple-600"></i>
              <span class="text-sm text-gray-600">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">${hrData.announcements.length}</h3>
            <p class="text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà</p>
          </div>
        </div>

        <!-- HR Details Sections -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Recent Attendance -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="attendanceList" class="space-y-3">
              ${generateAttendanceHTML()}
            </div>
          </div>

          <!-- HR Announcements -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢ HR</h3>
            <div id="announcementList" class="space-y-3">
              ${generateAnnouncementsHTML()}
            </div>
          </div>
        </div>
      `;

      // Insert before the closing div of main content
      const targetElement = document.querySelector('.max-w-7xl.mx-auto');
      if (targetElement) {
        // Insert at the end of main content
        targetElement.insertAdjacentHTML('beforeend', hrSummaryHTML);
        console.log('HR summary section added successfully');
      } else {
        console.warn('Could not find main content section to insert HR summary');
      }
    }

    function generateAttendanceHTML() {
      if (hrData.attendance.length === 0) {
        return '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>';
      }

      return hrData.attendance.slice(0, 5).map(att => {
        const date = new Date(att.date || att.createdAt);
        const status = att.status === 'present' ? '‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : att.status === 'absent' ? '‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô' : '‡∏•‡∏≤';
        const statusColor = att.status === 'present' ? 'text-green-600' : 'text-red-600';

        return `
          <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
            <div>
              <div class="font-medium">${date.toLocaleDateString('th-TH')}</div>
              <div class="text-sm text-gray-500">${att.checkIn ? '‡πÄ‡∏Ç‡πâ‡∏≤: ' + att.checkIn : ''} ${att.checkOut ? '‡∏≠‡∏≠‡∏Å: ' + att.checkOut : ''}</div>
            </div>
            <span class="font-medium ${statusColor}">${status}</span>
          </div>
        `;
      }).join('');
    }

    function generateAnnouncementsHTML() {
      if (hrData.announcements.length === 0) {
        return '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà</div>';
      }

      return hrData.announcements.slice(0, 3).map(ann => {
        const date = new Date(ann.date || ann.createdAt);

        return `
          <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
            <div class="font-medium text-gray-900 mb-1">${ann.title || '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®'}</div>
            <div class="text-sm text-gray-600 mb-2">${ann.content || ann.message || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®'}</div>
            <div class="text-xs text-gray-500">${date.toLocaleDateString('th-TH')}</div>
          </div>
        `;
      }).join('');
    }

    function initializeEmployeeData() {
      // Get current user info
      const currentUser = getCurrentUser();

      // Display employee information from HR data (now normalized)
      const employeeName = hrData.employee ? hrData.employee.name : (currentUser.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      const employeePosition = hrData.employee ? hrData.employee.position : '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
      const employeeId = hrData.employee ? hrData.employee.employeeId : (currentUser.employeeId || '-');
      const branchName = hrData.employee ? hrData.employee.branchName : '-';

      // Get employee photo from normalized data
      let employeePhoto = null;
      if (hrData.employee && hrData.employee.imageUrl) {
        employeePhoto = hrData.employee.imageUrl;
        console.log('Employee photo found:', employeePhoto);
        console.log('Employee data:', hrData.employee);
      } else {
        console.log('No employee photo found in normalized data');
      }

      // Update navigation bar
      const employeeNameEl = document.getElementById('employeeName');
      if (employeeNameEl) {
        employeeNameEl.textContent = employeeName;
      }
    
      const employeePositionEl = document.getElementById('employeePosition');
      if (employeePositionEl) {
        employeePositionEl.textContent = employeePosition;
      }

      // Update header section
      const headerEmployeeNameEl = document.getElementById('headerEmployeeName');
      if (headerEmployeeNameEl) {
        headerEmployeeNameEl.textContent = employeeName;
      }
    
      const headerEmployeeIdEl = document.getElementById('headerEmployeeId');
      if (headerEmployeeIdEl) {
        headerEmployeeIdEl.textContent = employeeId;
      }
    
      const headerBranchNameEl = document.getElementById('headerBranchName');
      if (headerBranchNameEl) {
        headerBranchNameEl.textContent = branchName;
      }

      // Update profile photos with improved handling
      console.log('Calling updateEmployeePhoto with:', employeePhoto);
      updateEmployeePhoto(employeePhoto);

      // Note: Salary data is now handled by loadRealSalaryData() and updateSalaryDisplay() functions

      // Calculate and display work experience data
      const workExperienceData = calculateWorkExperienceAndSavings(hrData.employee);
      document.getElementById('workExperience').textContent = workExperienceData.workExperienceText;
      document.getElementById('totalWorkDays').textContent = workExperienceData.workingDaysText;

      // Display bonus information
      document.getElementById('totalBonus').textContent = `‡∏ø${hrData.totalBonus.toLocaleString()}.00`;
      document.getElementById('thisYearBonus').textContent = `‡∏ø${hrData.thisYearBonus.toLocaleString()}.00`;

      // Calculate bonus increase based on actual growth from previous year
      const previousYear = new Date().getFullYear() - 1;
      const previousYearBonus = hrData.commission
        .filter(comm => new Date(comm.date || comm.createdAt).getFullYear() === previousYear)
        .reduce((total, comm) => total + (comm.amount || 0), 0) +
        hrData.bonuses
        .filter(bonus => new Date(bonus.date || bonus.createdAt).getFullYear() === previousYear)
        .reduce((total, bonus) => total + (bonus.amount || 0), 0);
    
      const bonusIncrease = previousYearBonus > 0 ? hrData.thisYearBonus - previousYearBonus : 0;
      document.getElementById('bonusIncrease').textContent = `${bonusIncrease >= 0 ? '+' : ''}‡∏ø${bonusIncrease.toLocaleString()}.00`;

      document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('th-TH');

      // Withdrawal elements are optional - check if they exist before updating
      const withdrawalElements = ['lastWithdrawal', 'lastWithdrawalAmount', 'nextWithdrawal', 'nextAvailable', 'withdrawBtn'];
      const withdrawalElementsExist = withdrawalElements.every(id => document.getElementById(id));

      if (withdrawalElementsExist) {
        // Find last withdrawal from commission data
        const withdrawals = hrData.commission.filter(comm => comm.type === 'withdrawal');
        let lastWithdrawal = null;
        let lastWithdrawalAmount = 0;

        if (withdrawals.length > 0) {
          const sortedWithdrawals = withdrawals.sort((a, b) => new Date(b.date) - new Date(a.date));
          lastWithdrawal = new Date(sortedWithdrawals[0].date);
          lastWithdrawalAmount = sortedWithdrawals[0].amount;
        }

        // Set withdrawal status
        if (lastWithdrawal) {
          const nextYear = new Date(lastWithdrawal.getFullYear() + 1, 0, 1);
          document.getElementById('lastWithdrawal').textContent = lastWithdrawal.toLocaleDateString('th-TH');
          document.getElementById('lastWithdrawalAmount').textContent = `‡∏ø${lastWithdrawalAmount.toLocaleString()}.00`;
          document.getElementById('nextWithdrawal').textContent = nextYear.toLocaleDateString('th-TH');

          const now = new Date();
          if (now >= nextYear) {
            document.getElementById('nextAvailable').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å';
            document.getElementById('nextAvailable').className = 'font-medium text-green-600';
            document.getElementById('withdrawBtn').disabled = false;
          } else {
            document.getElementById('nextAvailable').textContent = '‡∏£‡∏≠‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
            document.getElementById('nextAvailable').className = 'font-medium text-red-600';
            document.getElementById('withdrawBtn').disabled = true;
            document.getElementById('withdrawBtn').className += ' opacity-50 cursor-not-allowed';
          }
        } else {
          document.getElementById('lastWithdrawal').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ö‡∏¥‡∏Å';
          document.getElementById('lastWithdrawalAmount').textContent = '‡∏ø0.00';
          document.getElementById('nextWithdrawal').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å';
          document.getElementById('nextAvailable').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ö‡∏¥‡∏Å';
          document.getElementById('nextAvailable').className = 'font-medium text-green-600';
          document.getElementById('withdrawBtn').disabled = false;
        }
      } else {
        console.log('Withdrawal elements not found in DOM, skipping withdrawal status update');
      }
    }

    function initializeChart() {
      const chartElement = document.getElementById('bonusChart');
      if (!chartElement) {
        console.warn('Chart element not found, skipping chart initialization');
        return;
      }
      const ctx = chartElement.getContext('2d');

      // Generate chart data from HR commission data
      const chartData = generateChartData();

      const data = {
        labels: chartData.labels,
        datasets: [{
          label: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏° (‡∏ö‡∏≤‡∏ó)',
          data: chartData.data,
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      };

      new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‡∏ø' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    function generateChartData() {
      // Generate last 6 months of data from HR commission
      const months = [];
      const data = [];
      const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

      // Get current date
      const now = new Date();
      let cumulativeTotal = 0;

      // Generate data for last 6 months
      for (let i = 5; i >= 0; i--) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthLabel = monthNames[targetDate.getMonth()];

        // Calculate cumulative bonus up to this month from both commission and bonus data
        const monthlyCommission = hrData.commission
          .filter(comm => {
            const commDate = new Date(comm.date || comm.createdAt);
            return commDate.getFullYear() === targetDate.getFullYear() &&
                   commDate.getMonth() === targetDate.getMonth();
          })
          .reduce((sum, comm) => sum + (comm.amount || 0), 0);

        const monthlyBonusData = hrData.bonuses
          .filter(bonus => {
            const bonusDate = new Date(bonus.date || bonus.createdAt);
            return bonusDate.getFullYear() === targetDate.getFullYear() &&
                   bonusDate.getMonth() === targetDate.getMonth();
          })
          .reduce((sum, bonus) => sum + (bonus.amount || 0), 0);

        const monthlyBonus = monthlyCommission + monthlyBonusData;

        cumulativeTotal += monthlyBonus;

        months.push(monthLabel);
        data.push(cumulativeTotal);
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ return ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á
      if (data.every(val => val === 0)) {
        return {
          labels: months,
          data: data
        };
      }

      return { labels: months, data: data };
    }

    function loadTransactions() {
      const transactionList = document.getElementById('transactionList');
      if (!transactionList) {
        console.warn('Transaction list element not found, skipping transaction loading');
        return;
      }
      transactionList.innerHTML = '';

      // Use HR commission data for transactions
      const recentTransactions = hrData.commission.slice(0, 5); // Show latest 5 transactions

      if (recentTransactions.length === 0) {
        transactionList.innerHTML = '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>';
        return;
      }

      recentTransactions.forEach((transaction, index) => {
        const transactionElement = document.createElement('div');
        transactionElement.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer';

        const typeColors = {
          performance: 'text-blue-600 bg-blue-100',
          attendance: 'text-green-600 bg-green-100',
          sales: 'text-purple-600 bg-purple-100'
        };

        const typeIcons = {
          performance: 'bi-trophy',
          attendance: 'bi-clock',
          sales: 'bi-graph-up'
        };

        const transactionType = transaction.type || 'commission';
        const typeColor = typeColors[transactionType] || 'text-blue-600 bg-blue-100';
        const typeIcon = typeIcons[transactionType] || 'bi-cash-coin';
        const description = transaction.description || transaction.note || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ö‡∏ô‡∏±‡∏™';
        const amount = transaction.amount || 0;
        const date = transaction.date || transaction.createdAt || new Date();

        transactionElement.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full ${typeColor} flex items-center justify-center">
              <i class="bi ${typeIcon}"></i>
            </div>
            <div>
              <div class="font-medium text-gray-900">${description}</div>
              <div class="text-sm text-gray-500">${new Date(date).toLocaleDateString('th-TH')}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-green-600">+‡∏ø${amount.toLocaleString()}</div>
            <div class="text-xs text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
          </div>
        `;

        // Add click handler to show transaction details
        transactionElement.addEventListener('click', () => {
          showTransactionDetail(transaction, index);
        });

        transactionList.appendChild(transactionElement);
      });
    }

    function setupEventListeners() {
      // Notification modal
      document.getElementById('notificationBtn').addEventListener('click', showNotifications);
      document.getElementById('closeNotificationModal').addEventListener('click', hideNotifications);

      // Transaction detail modal
      document.getElementById('closeTransactionDetailModal').addEventListener('click', hideTransactionDetail);

      // Bonus card click event
      const bonusCard = document.getElementById('bonusCard');
      if (bonusCard) {
        bonusCard.addEventListener('click', function() {
          // Navigate to Bonusdetail.html
          window.location.href = 'Bonusdetail';
        });
      }
    }

    function checkForNewNotifications() {
      // Check for actual notifications from HR data
      const notifications = generateHRNotifications();

      if (notifications.length > 0) {
        showNotificationBadge(notifications.length);
      }

      // Periodically check for new notifications
      setInterval(() => {
        const newNotifications = generateHRNotifications();
        if (newNotifications.length > notifications.length) {
          showNotificationBadge(newNotifications.length);
        }
      }, 30000); // Check every 30 seconds
    }

    function showNotificationBadge(count) {
      const badge = document.getElementById('notificationBadge');
      badge.textContent = count;
      badge.classList.remove('hidden');
    }

    function showNotifications() {
      const modal = document.getElementById('notificationModal');
      const content = document.getElementById('notificationContent');

      // Generate notifications from HR data
      const notifications = generateHRNotifications();

      content.innerHTML = '';
      if (notifications.length === 0) {
        content.innerHTML = '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>';
      } else {
        notifications.forEach(notif => {
          const notifElement = document.createElement('div');
          notifElement.className = 'p-3 border border-gray-200 rounded-lg';
          notifElement.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                <i class="bi ${getNotificationIcon(notif.type)} text-blue-600"></i>
              </div>
              <div class="flex-1">
                <div class="font-medium text-gray-900">${notif.title}</div>
                <div class="text-sm text-gray-600 mt-1">${notif.message}</div>
                <div class="text-xs text-gray-500 mt-2">${notif.time}</div>
              </div>
            </div>
          `;
          content.appendChild(notifElement);
        });
      }

      modal.classList.remove('hidden');
      document.getElementById('notificationBadge').classList.add('hidden');
    }

    function generateHRNotifications() {
      const notifications = [];
      const now = new Date();

      // Check for recent commission/bonus
      const recentCommissions = hrData.commission.filter(comm => {
        const commDate = new Date(comm.date || comm.createdAt);
        const daysDiff = (now - commDate) / (1000 * 60 * 60 * 24);
        return daysDiff <= 7; // Last 7 days
      });

      const recentBonuses = hrData.bonuses.filter(bonus => {
        const bonusDate = new Date(bonus.date || bonus.createdAt);
        const daysDiff = (now - bonusDate) / (1000 * 60 * 60 * 24);
        return daysDiff <= 7; // Last 7 days
      });

      // Add commission notifications
      recentCommissions.forEach(comm => {
        const daysDiff = Math.floor((now - new Date(comm.date || comm.createdAt)) / (1000 * 60 * 60 * 24));
        notifications.push({
          title: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
          message: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö${comm.description || '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô'} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${(comm.amount || 0).toLocaleString()}`,
          time: daysDiff === 0 ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : `${daysDiff} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'bonus'
        });
      });

      // Add bonus notifications
      recentBonuses.forEach(bonus => {
        const daysDiff = Math.floor((now - new Date(bonus.date || bonus.createdAt)) / (1000 * 60 * 60 * 24));
        notifications.push({
          title: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö',
          message: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö${bonus.description || '‡πÇ‡∏ö‡∏ô‡∏±‡∏™'} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${(bonus.amount || 0).toLocaleString()}`,
          time: daysDiff === 0 ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : `${daysDiff} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'bonus'
        });
      });

      // Check for HR announcements
      const recentAnnouncements = hrData.announcements.filter(ann => {
        const annDate = new Date(ann.date || ann.createdAt);
        const daysDiff = (now - annDate) / (1000 * 60 * 60 * 24);
        return daysDiff <= 3; // Last 3 days
      });

      recentAnnouncements.forEach(ann => {
        const daysDiff = Math.floor((now - new Date(ann.date || ann.createdAt)) / (1000 * 60 * 60 * 24));
        notifications.push({
          title: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢ HR',
          message: ann.title || ann.content || '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà',
          time: daysDiff === 0 ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : `${daysDiff} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'announcement'
        });
      });

      // Check for leave status
      const pendingLeaves = hrData.leaves.filter(leave => leave.status === 'pending');
      if (pendingLeaves.length > 0) {
        notifications.push({
          title: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
          message: `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ ${pendingLeaves.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`,
          time: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î',
          type: 'leave'
        });
      }

      // Sort by most recent
      return notifications.slice(0, 5);
    }

    function getNotificationIcon(type) {
      switch (type) {
        case 'bonus': return 'bi-cash-coin';
        case 'announcement': return 'bi-megaphone';
        case 'leave': return 'bi-calendar-x';
        case 'withdraw': return 'bi-bank';
        default: return 'bi-bell';
      }
    }

    function hideNotifications() {
      document.getElementById('notificationModal').classList.add('hidden');
    }


    function updateChart() {
      const chartPeriodElement = document.getElementById('chartPeriod');
      if (!chartPeriodElement) {
        console.warn('Chart period selector not found');
        return;
      }

      const period = chartPeriodElement.value;
      console.log('Updating chart for period:', period);

      // Regenerate chart based on selected period
      const chartData = generateChartDataForPeriod(period);

      // Update existing chart
      const chart = Chart.getChart('bonusChart');
      if (chart) {
        chart.data.labels = chartData.labels;
        chart.data.datasets[0].data = chartData.data;
        chart.update();
      }
    }

    function generateChartDataForPeriod(period) {
      const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      const now = new Date();
      let months = [];
      let data = [];
      let monthsToShow;

      switch (period) {
        case '6months':
          monthsToShow = 6;
          break;
        case 'year':
          monthsToShow = 12;
          break;
        case 'all':
          monthsToShow = 24; // 2 years
          break;
        default:
          monthsToShow = 6;
      }

      let cumulativeTotal = 0;

      for (let i = monthsToShow - 1; i >= 0; i--) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthLabel = monthNames[targetDate.getMonth()];

        const monthlyCommission = hrData.commission
          .filter(comm => {
            const commDate = new Date(comm.date || comm.createdAt);
            return commDate.getFullYear() === targetDate.getFullYear() &&
                   commDate.getMonth() === targetDate.getMonth();
          })
          .reduce((sum, comm) => sum + (comm.amount || 0), 0);

        const monthlyBonusData = hrData.bonuses
          .filter(bonus => {
            const bonusDate = new Date(bonus.date || bonus.createdAt);
            return bonusDate.getFullYear() === targetDate.getFullYear() &&
                   bonusDate.getMonth() === targetDate.getMonth();
          })
          .reduce((sum, bonus) => sum + (bonus.amount || 0), 0);

        const monthlyBonus = monthlyCommission + monthlyBonusData;

        cumulativeTotal += monthlyBonus;
        months.push(monthLabel);
        data.push(cumulativeTotal);
      }

      return { labels: months, data: data };
    }

    function viewAllTransactions() {
      // Navigate to full transaction history page
      window.location.href = '/employee/transactions';
    }

    // Transaction Detail Functions
    function showTransactionDetail(transaction, index) {
      // Generate mock data based on transaction
      const typeLabels = {
        performance: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô',
        attendance: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô',
        sales: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
        commission: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô'
      };

      const occasions = {
        performance: '‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ 120%',
        attendance: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö 100% ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
        sales: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
        commission: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô'
      };

      const descriptions = {
        performance: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ 20% ‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó',
        attendance: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏π‡∏á‡πÉ‡∏à‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
        sales: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏µ‡∏° ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        commission: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á'
      };

      const transactionType = transaction.type || 'commission';
      const amount = transaction.amount || 0;
      const date = new Date(transaction.date || transaction.createdAt || new Date());

      // Update modal content
      document.getElementById('detailTransactionType').textContent = typeLabels[transactionType] || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ö‡∏ô‡∏±‡∏™';
      document.getElementById('detailTransactionRef').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: TXN-${new Date().getFullYear()}-${String(index + 1).padStart(3, '0')}`;
      document.getElementById('detailTransactionAmount').textContent = `+‡∏ø${amount.toLocaleString()}`;
      document.getElementById('detailTransactionStatus').textContent = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      // Basic information
      document.getElementById('detailTransactionDate').textContent = date.toLocaleDateString('th-TH');
      document.getElementById('detailTransactionTime').textContent = date.toLocaleTimeString('th-TH');
      document.getElementById('detailTransactionCategory').textContent = typeLabels[transactionType] || '‡πÇ‡∏ö‡∏ô‡∏±‡∏™';
      document.getElementById('detailTransactionSubtype').textContent = '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢';

      // Amount breakdown
      const basicAmount = Math.floor(amount * 0.9);
      const bonusAmount = Math.floor(amount * 0.1);
      const taxAmount = 0;

      document.getElementById('detailBasicAmount').textContent = `‡∏ø${basicAmount.toLocaleString()}.00`;
      document.getElementById('detailBonusAmount').textContent = `‡∏ø${bonusAmount.toLocaleString()}.00`;
      document.getElementById('detailTaxAmount').textContent = `-‡∏ø${taxAmount.toLocaleString()}.00`;
      document.getElementById('detailNetAmount').textContent = `‡∏ø${amount.toLocaleString()}.00`;

      // Reason and description
      document.getElementById('detailOccasion').textContent = occasions[transactionType] || '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
      document.getElementById('detailDescription').textContent = descriptions[transactionType] || transaction.description || transaction.note || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏ö‡∏ô‡∏±‡∏™';

      // Verification info - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö HR ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å transaction
      const dataEntryPerson = transaction.entryBy || transaction.createdBy || hrData.employee?.name || '‡∏£‡∏∞‡∏ö‡∏ö';
      const approver = transaction.approvedBy || hrData.employee?.supervisor || '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';

      document.getElementById('detailDataEntry').textContent = dataEntryPerson;
      document.getElementById('detailApprover').textContent = approver;

      const entryDate = new Date(date.getTime() - 5 * 60 * 1000); // 5 minutes before
      const approvalDate = date;

      document.getElementById('detailEntryDate').textContent = entryDate.toLocaleDateString('th-TH') + ' - ' + entryDate.toLocaleTimeString('th-TH');
      document.getElementById('detailApprovalDate').textContent = approvalDate.toLocaleDateString('th-TH') + ' - ' + approvalDate.toLocaleTimeString('th-TH');

      // Update system logs
      const systemLogsHTML = `
        <div class="flex justify-between">
          <span class="text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          <span class="text-gray-900">${entryDate.toLocaleDateString('th-TH')} ${entryDate.toLocaleTimeString('th-TH')} ‡πÇ‡∏î‡∏¢ ${dataEntryPerson.replace('‡∏Ñ‡∏∏‡∏ì', '')}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
          <span class="text-gray-900">${entryDate.toLocaleDateString('th-TH')} ${new Date(entryDate.getTime() + 60000).toLocaleTimeString('th-TH')} ‡πÇ‡∏î‡∏¢ ${dataEntryPerson.replace('‡∏Ñ‡∏∏‡∏ì', '')}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
          <span class="text-gray-900">${approvalDate.toLocaleDateString('th-TH')} ${approvalDate.toLocaleTimeString('th-TH')} ‡πÇ‡∏î‡∏¢ ${approver.replace('‡∏Ñ‡∏∏‡∏ì', '')}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span>
          <span class="text-gray-900">${approvalDate.toLocaleDateString('th-TH')} ${approvalDate.toLocaleTimeString('th-TH')} ‡πÇ‡∏î‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö</span>
        </div>
      `;
      document.getElementById('detailSystemLogs').innerHTML = systemLogsHTML;

      // Show modal
      document.getElementById('transactionDetailModal').classList.remove('hidden');
    }

    function hideTransactionDetail() {
      document.getElementById('transactionDetailModal').classList.add('hidden');
    }

    // Real-time updates simulation
    setInterval(() => {
      // Simulate real-time bonus updates
      const currentBonus = parseInt(document.getElementById('totalBonus').textContent.replace(/[‡∏ø,]/g, ''));
      if (Math.random() > 0.95) { // 5% chance of bonus update
        const newAmount = Math.floor(Math.random() * 1000) + 500;
        const newTotal = currentBonus + newAmount;
        document.getElementById('totalBonus').textContent = `‡∏ø${newTotal.toLocaleString()}.00`;

        // Show notification
        showNotificationBadge(1);
      }
    }, 30000); // Check every 30 seconds

    // ========== DEBUG FUNCTIONS ==========
    
    // Toggle debug panel visibility
    function toggleDebugPanel() {
      const panel = document.getElementById('debugPanel');
      const toggle = document.getElementById('debugToggle');
    
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.innerHTML = '<i class="bi bi-bug-fill"></i>';
        updateDebugInfo();
      } else {
        panel.classList.add('hidden');
        toggle.innerHTML = '<i class="bi bi-bug"></i>';
      }
    }

    // Update debug information
    function updateDebugInfo() {
      // Environment info
      const environment = window.location.hostname === 'localhost' ? 'Development' :
                         window.location.hostname.includes('2pheenong') ? 'Production' : 'Other';
      document.getElementById('debugEnvironment').textContent = environment;

      // API Status
      fetch(`${API_BASE_URL}/api/health`)
        .then(response => {
          if (response.ok) {
            document.getElementById('debugAPIStatus').textContent = 'Connected ‚úì';
            document.getElementById('debugAPIStatus').className = 'text-green-400';
          } else {
            document.getElementById('debugAPIStatus').textContent = 'Error ' + response.status;
            document.getElementById('debugAPIStatus').className = 'text-red-400';
          }
        })
        .catch(error => {
          document.getElementById('debugAPIStatus').textContent = 'Failed ‚úó';
          document.getElementById('debugAPIStatus').className = 'text-red-400';
        });

      // Employee Data Status
      if (hrData.employee) {
        document.getElementById('debugEmployeeStatus').textContent = 'Loaded ‚úì';
        document.getElementById('debugEmployeeStatus').className = 'text-green-400';
      } else {
        document.getElementById('debugEmployeeStatus').textContent = 'No Data ‚úó';
        document.getElementById('debugEmployeeStatus').className = 'text-red-400';
      }

      // Image Status
      if (hrData.employee && hrData.employee.imageUrl) {
        document.getElementById('debugImageStatus').textContent = 'Found ‚úì';
        document.getElementById('debugImageStatus').className = 'text-green-400';
      } else {
        document.getElementById('debugImageStatus').textContent = 'Not Found ‚úó';
        document.getElementById('debugImageStatus').className = 'text-red-400';
      }
    }

    // Test image loading manually
    function testImageLoad() {
      if (hrData.employee && hrData.employee.imageUrl) {
        console.log('Testing image URL:', hrData.employee.imageUrl);
    
        const testImg = new Image();
        testImg.onload = function() {
          console.log('‚úì Image loaded successfully');
          alert('‚úì Image loaded successfully: ' + hrData.employee.imageUrl);
        };
        testImg.onerror = function() {
          console.log('‚úó Image failed to load');
          alert('‚úó Image failed to load: ' + hrData.employee.imageUrl);
        };
        testImg.src = hrData.employee.imageUrl;
      } else {
        alert('No image URL found in employee data');
      }
    }

    // Show debug panel on development environment
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // Auto-show debug panel in development after 2 seconds
      setTimeout(() => {
        document.getElementById('debugToggle').style.display = 'block';
      }, 2000);
    }
  </script>
</body>
</html>