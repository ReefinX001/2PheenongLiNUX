<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ใบสั่งซื้อย้อนหลัง - Purchase Order Backdated</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  
  <!-- Flatpickr CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Flatpickr Thai locale -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  
  <script src="../js/activity-tracker.js"></script>
  
  <!-- Tailwind CSS - Note: CDN should be replaced with local installation for production -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'Prompt', 'sans-serif'],
            prompt: ['Prompt', 'sans-serif'],
          },
          boxShadow: {
            'lux': '0 8px 32px 0 rgba(31, 38, 135, 0.18)'
          }
        },
      },
      daisyui: {
        themes: ['luxury', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Lottie Web for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Prompt', sans-serif;
    }
    /* Animation สำหรับ fadeIn */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    /* สไตล์สำหรับ Sidebar ที่ยุบ */
    aside.collapsed {
      width: 5rem;
    }
    /* ซ่อนข้อความในเมนู เมื่อ Sidebar ยุบ */
    aside.collapsed .ml-3 {
      display: none;
    }
    /* Spinner สำหรับโหลดข้อมูล */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .dark .form-control {
      border-color: #4b5563;
      background-color: #374151;
      color: #f3f4f6;
    }

    .form-control:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .dark .form-control:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1);
    }

    .btn-create-po {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }

    .btn-create-po:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .item-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #ffffff;
      transition: all 0.3s ease;
      position: relative;
    }

    .dark .item-card {
      border-color: #4b5563;
      background: #374151;
    }

    .item-card.backdated {
      border-color: #e5e7eb;
      background: #f9fafb;
      border-left: 4px solid #3b82f6;
      position: relative;
    }

    .dark .item-card.backdated {
      border-color: #4b5563;
      background: #374151;
      border-left: 4px solid #60a5fa;
    }

    .item-card.backdated::before {
      content: 'เร่งด่วน';
      background: #f3f4f6;
      color: #6b7280;
      border: 1px solid #d1d5db;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      position: absolute;
      top: -0.5rem;
      right: 1rem;
    }

    .dark .item-card.backdated::before {
      background: #4b5563;
      color: #9ca3af;
      border-color: #6b7280;
    }

    .status-pending {
      background: #fef3cd;
      color: #856404;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .dark .status-pending {
      background: #78350f;
      color: #fbbf24;
    }

    .hidden { display: none !important; }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>

<body class="flex flex-col min-h-screen bg-white text-gray-700 dark:bg-gray-800 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- ปุ่ม Toggle Menu แบบลอย (Floating) -->
  <button id="btnToggleMenu" title="Toggle Menu" aria-label="Toggle Menu"
          class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition">
    <i class="bi bi-chevron-left"></i>
  </button>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 p-4 rounded-lg text-white z-50 hidden"></div>

  <div class="flex">
    <!-- Sidebar -->
    <div class="flex w-full">
      <!-- Sidebar -->
      <aside id="sidebar"
         class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                transform transition-transform duration-300 translate-x-0 z-20">
        <!-- ส่วนหัว (Logo/Title) -->
        <a href="StockManagehome" class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png"
               alt="Logo"
               class="Logo animate-float shadow-soft w-full h-full object-cover" />
        </a>
        <!-- เมนูหลัก (Vertical Menu) -->
        <div class="flex-1 p-4 overflow-hidden">
          <ul class="flex flex-col w-full space-y-1">

        <li class="my-px">
                        <a href="branch_stock_overview"
                          class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                          <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                            <i class="bi bi-grid text-xl"></i>
                          </span>
                          <span class="ml-3">สต๊อกคงเหลือ</span>
                        </a>
                      </li>

            <!-- เมนู: ตรวจสินค้า/อนุมัติ -->
            <li class="my-px">
              <a href="inventory_dashboard"
                 class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                  <i class="bi bi-clipboard-check text-xl"></i>
                </span>
                <span class="ml-3">ตรวจสินค้า/อนุมัติ</span>
              </a>
            </li>

            <!-- เมนู:PO -->
            <li class="my-px">
              <a href="PO"
                 class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                  <i class="bi bi-file-earmark-text text-xl"></i>
                </span>
                <span class="ml-3">ใบสั่งซื้อ</span>
              </a>
            </li>

            <!-- เมนู: Quotation -->
            <li class="my-px">
              <a href="quotation_Stock"
                 class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                  <i class="bi bi-file-earmark-richtext text-xl"></i>
                </span>
                <span class="ml-3">สร้างใบเสนอราคา</span>
              </a>
            </li>
            <!-- เมนู: Transfer -->
            <li class="my-px">
              <a href="Transfer"
                      class="flex flex-row items-center h-12 px-4 rounded-lg
              text-gray-600 dark:text-gray-200 
              hover:bg-gray-100 dark:hover:bg-gray-700 transition-all sidebar-link">
                <span class="flex items-center justify-center text-lg text-primary-500 dark:text-primary-400">
                  <i class="bi bi-truck text-xl"></i>
                </span>
                <span class="ml-3">ย้ายสินค้า</span>
              </a>
            </li>
            <li class="my-px">
              <a href="product_Image"
                 class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <span class="flex items-center justify-center text-lg text-yellow-500 dark:text-yellow-400">
                  <i class="bi bi-upc-scan text-xl"></i>
                </span>
                <span class="ml-3">ลงทะเบียนสินค้า</span>
              </a>
            </li>

            <!-- เมนู: เพิ่มเติม -->
            <li class="my-px">
              <a href="StockAdditional"
                 class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                <span class="flex items-center justify-center text-lg text-indigo-500 dark:text-indigo-400">
                  <i class="bi bi-three-dots text-xl"></i>
                </span>
                <span class="ml-3">เพิ่มเติม</span>
              </a>
            </li>


            <li class="my-px mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
              <!-- Dark Mode Toggle -->
              <button id="btnToggleDark"
                      class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-left transition-all">
                <span class="flex items-center justify-center text-lg text-indigo-600 dark:text-indigo-300">
                  <i class="bi bi-moon-stars text-xl"></i>
                </span>
                <span class="ml-3" id="darkModeLabel">Dark Mode</span>
              </button>
            </li>
            <!-- Logout -->
            <li class="my-px">
              <button id="btnLogout"
                      class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-left transition-all">
                <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                  <i class="bi bi-box-arrow-right text-xl"></i>
                </span>
                <span class="ml-3">ออกจากระบบ</span>
              </button>
            </li>
            <!-- Profile (แสดงชื่อและรูปพนักงานจาก API) -->
            <li class="my-px mt-2">
              <div id="profile"
                   class="flex flex-row items-center h-16 px-4 w-full rounded-lg bg-gray-50 text-gray-700 dark:bg-gray-800/50 dark:text-gray-200 text-left transition-colors">
                <div class="avatar mr-3">
                  <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                    <img id="employeePhoto" src="" alt="Employee Photo" class="w-full h-full object-cover" />
                  </div>
                </div>
                <div class="flex flex-col">
                  <span class="text-sm font-medium" id="employeeName">Loading...</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</span>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </aside>

       <!-- ส่วนเนื้อหา (Main Content) -->
      <div id="mainContent"
        class="flex-1 ml-56 p-6 pb-20 space-y-6 transition-all duration-300 ease-in-out">  <!-- ← เพิ่ม pb-20 -->
    <!-- Header -->
    <header class="p-6 bg-white dark:bg-gray-800 rounded-lg flex items-center justify-between transition-colors">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">จัดการ PO สำหรับสินค้าขายด่วน</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ใบสั่งซื้อย้อนหลัง</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="userName">กำลังโหลด...</p>
          <p class="text-xs text-gray-500 dark:text-gray-400" id="userRole">-</p>
        </div>
        <button onclick="goBack()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
          <i class="bi bi-arrow-left mr-2"></i>กลับ
        </button>
      </div>
    </header>

  <!-- Main Content -->
  <div class="space-y-6">
    
    <!-- Info Banner -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 mb-8">
      <div class="flex items-center gap-4 mb-4">
        <div class="text-4xl">📋</div>
        <div>
          <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">ใบสั่งซื้อย้อนหลัง (Backdated Purchase Orders)</h2>
          <p class="text-gray-600 dark:text-gray-400">สำหรับสินค้าที่เพิ่มผ่านระบบขายด่วนฉุกเฉิน ที่ต้องการสร้าง PO ให้ครบถ้วน</p>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="totalBackdatedItems">-</div>
          <div class="text-sm text-blue-600 dark:text-blue-400">รายการรอ PO</div>
        </div>
        <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="completedPOs">-</div>
          <div class="text-sm text-green-600 dark:text-green-400">PO สำเร็จแล้ว</div>
        </div>
        <div class="text-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
          <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="totalValue">-</div>
          <div class="text-sm text-orange-600 dark:text-orange-400">มูลค่ารวม (บาท)</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 mb-8">
      <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">🔍 ตัวกรอง</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">สาขา</label>
          <select id="branchFilter" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="">ทุกสาขา</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">สถานะ</label>
          <select id="statusFilter" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="">ทุกสถานะ</option>
            <option value="pending_po">รอสร้าง PO</option>
            <option value="po_created">สร้าง PO แล้ว</option>
            <option value="completed">เสร็จสิ้น</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">วันที่เริ่มต้น</label>
          <input type="date" id="startDate" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">วันที่สิ้นสุด</label>
          <input type="date" id="endDate" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
      </div>
      <div class="flex gap-4 mt-4">
        <button onclick="applyFilters()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">ค้นหา</button>
        <button onclick="clearFilters()" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">ล้างตัวกรอง</button>
      </div>
    </div>

    <!-- Backdated Items List -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">📦 รายการสินค้าขายด่วนที่รอสร้าง PO</h3>
        <div class="flex gap-2">
          <button onclick="selectAll()" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition">เลือกทั้งหมด</button>
          <button onclick="createSelectedPOs()" class="btn-create-po text-sm" style="width: auto;">สร้าง PO ที่เลือก</button>
        </div>
      </div>
      
      <div id="backdatedItemsList" class="space-y-4">
        <!-- Items will be loaded here -->
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <div class="spinner mx-auto mb-4"></div>
          <p>กำลังโหลดข้อมูล...</p>
        </div>
      </div>
    </div>

    <!-- Create PO Modal -->
    <div id="createPOModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-2xl mx-4 w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">สร้างใบสั่งซื้อย้อนหลัง</h3>
          <button onclick="closePOModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>

        <form id="createPOForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">ผู้จำหน่าย <span class="text-red-500">*</span></label>
              <select id="supplierSelect" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                <option value="">-- เลือกผู้จำหน่าย --</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">วันที่สั่งซื้อ <span class="text-red-500">*</span></label>
              <input type="date" id="purchaseDate" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-600 dark:text-gray-300">หมายเหตุ</label>
            <textarea id="poNote" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" rows="3" placeholder="หมายเหตุเพิ่มเติม..."></textarea>
          </div>

          <div class="mb-6">
            <h4 class="font-semibold mb-4 text-gray-800 dark:text-gray-200">รายการสินค้าที่เลือก:</h4>
            <div id="selectedItemsList" class="space-y-2 max-h-40 overflow-y-auto">
              <!-- Selected items will appear here -->
            </div>
          </div>

          <div class="flex gap-4">
            <button type="button" onclick="closePOModal()" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">ยกเลิก</button>
            <button type="submit" class="btn-create-po flex-1" id="createPOBtn">
              <i class="bi bi-plus-circle mr-2"></i>
              สร้างใบสั่งซื้อ
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
</div>

  <script>
    // Global Variables
    let backdatedItems = [];
    let selectedItems = [];
    let suppliers = [];
    let branches = [];
    let lottieAnimation = null;

    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        if (!lottieAnimation) {
          console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => response.json())
            .then(animationData => {
              console.log('✅ Lottie animation data loaded successfully');
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: false,
                animationData: animationData
              });
            })
            .catch(error => {
              console.warn('Failed to load Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        }
        if (lottieAnimation) lottieAnimation.play();
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }

    // Make showLoading globally accessible
    window.showLoading = showLoading;

    // Utility Functions
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
    
      toast.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${colors[type] || colors.info}`;
      toast.innerHTML = message;
      toast.classList.remove('hidden');
    
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount || 0);
    }

    function formatDate(dateString) {
      if (!dateString) return 'ไม่ระบุวันที่';
    
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'ไม่ระบุวันที่';
    
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Authentication
    async function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
        return false;
      }
    
      try {
        const response = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        const data = await response.json();
        if (data.success) {
          document.getElementById('userName').textContent = data.data.name;
          document.getElementById('userRole').textContent = data.data.role;
          return true;
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        localStorage.clear();
        window.location.href = '/login';
        return false;
      }
    }

    // Load Functions
    async function loadBackdatedItems() {
      try {
        showLoading(true);
        const token = localStorage.getItem('authToken');

        // Build query parameters
        const params = new URLSearchParams();
        const branchFilter = document.getElementById('branchFilter')?.value;
        const statusFilter = document.getElementById('statusFilter')?.value;
        const startDate = document.getElementById('startDate')?.value;
        const endDate = document.getElementById('endDate')?.value;

        if (branchFilter) params.append('branchCode', branchFilter);
        if (statusFilter) params.append('status', statusFilter);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        const response = await fetch(`/api/quick-sale?${params.toString()}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const result = await response.json();
        if (result.success) {
          backdatedItems = result.data || [];

          // โหลดข้อมูล PO ที่บันทึกไว้ใน localStorage (สำหรับข้อมูลที่ยังไม่ได้บันทึก)
          const savedPOData = JSON.parse(localStorage.getItem('backdatedPOData') || '{}');
          backdatedItems.forEach(item => {
            if (savedPOData[item._id]) {
              item.poData = savedPOData[item._id];
            } else if (!item.poData) {
              // ตั้งค่าเริ่มต้นสำหรับข้อมูลที่ยังไม่มี PO data
              item.poData = {
                unitCost: item.cost || 0,
                unitDiscount: 0,
                taxRate: 7,
                taxType: 'แยกภาษี',
                categoryGroup: item.category || 'มือถือ'
              };
            }
          });

          renderBackdatedItems();
          updateStatistics();
        } else {
          throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลได้');
        }
      } catch (err) {
        console.error('Error loading backdated items:', err);
        showToast('ไม่สามารถโหลดข้อมูลสินค้าขายด่วน: ' + err.message, 'error');

        // Fallback: แสดงข้อความว่าไม่มีข้อมูล
        document.getElementById('backdatedItemsList').innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <div class="text-4xl mb-4">⚠️</div>
            <p>ไม่สามารถโหลดข้อมูลได้</p>
            <p class="text-sm mt-2">${err.message}</p>
            <button onclick="loadBackdatedItems()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ลองใหม่</button>
          </div>
        `;
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    }

    async function loadSuppliers() {
      try {
        showLoading(true);
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/supplier', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        const result = await response.json();
        if (result.success) {
          suppliers = result.data || [];
          populateSupplierSelect();
        }
      } catch (err) {
        console.error('Error loading suppliers:', err);
        showToast('ไม่สามารถโหลดข้อมูลผู้จำหน่าย: ' + err.message, 'error');
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    }

    async function loadBranches() {
      try {
        showLoading(true);
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/branch', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        const result = await response.json();
        if (result.success) {
          branches = result.data || [];
          populateBranchFilter();
        }
      } catch (err) {
        console.error('Error loading branches:', err);
        showToast('ไม่สามารถโหลดข้อมูลสาขา: ' + err.message, 'error');
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    }

    // Render Functions
    function renderBackdatedItems() {
      const container = document.getElementById('backdatedItemsList');
    
      if (backdatedItems.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <div class="text-4xl mb-4">📭</div>
            <p>ไม่มีรายการสินค้าขายด่วนที่รอสร้าง PO</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-sm">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สินค้า</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ซัพพลายเออร์</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">กลุ่มประเภท</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ต้นทุน/หน่วย</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ส่วนลด/หน่วย</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ภาษี (%)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ประเภทภาษี</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">มูลค่าก่อนภาษี</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ภาษี (บาท)</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">รวมภาษี</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">สถานะ</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              ${backdatedItems.map(item => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" data-item-id="${item._id}">
                  <td class="px-4 py-3 whitespace-nowrap">
                    <input type="checkbox" class="item-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" value="${item._id}" onchange="toggleItemSelection('${item._id}')">
                  </td>
                  <td class="px-4 py-3">
                    <div>
                      <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${item.name}</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">
                        📱 ${item.imei} | 🏷️ ${item.brand} | 📍 ${item.branchCode || 'PATTANI'}
                      </div>
                      <div class="text-xs text-gray-400 dark:text-gray-500">
                        เพิ่มเมื่อ: ${formatDate(item.timestamp || item.createdAt)} โดย: ${item.addedByName || item.addedBy?.name || 'ขายด่วนฉุกเฉิน'}
                      </div>
                    </div>
                  </td>
                  <td class="px-4 py-3">
                    <select class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                            onchange="updateItemField('${item._id}', 'supplier', this.value)">
                      <option value="">-- เลือกซัพพลายเออร์ --</option>
                      ${suppliers.map(supplier => `
                        <option value="${supplier._id}" ${item.poData?.supplierId === supplier._id ? 'selected' : ''}>
                          ${supplier.name}
                        </option>
                      `).join('')}
                    </select>
                  </td>
                  <td class="px-4 py-3">
                    <select class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                            onchange="updateItemField('${item._id}', 'categoryGroup', this.value)">
                      <option value="">-- เลือกกลุ่ม --</option>
                      <option value="มือถือ" ${item.poData?.categoryGroup === 'มือถือ' ? 'selected' : ''}>มือถือ</option>
                      <option value="อุปกรณ์เสริม" ${item.poData?.categoryGroup === 'อุปกรณ์เสริม' ? 'selected' : ''}>อุปกรณ์เสริม</option>
                      <option value="ของแถม" ${item.poData?.categoryGroup === 'ของแถม' ? 'selected' : ''}>ของแถม</option>
                      <option value="อื่นๆ" ${item.poData?.categoryGroup === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ</option>
                    </select>
                  </td>
                  <td class="px-4 py-3">
                    <input type="number" class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                           min="0" step="0.01" value="${item.poData?.unitCost || item.cost || ''}" 
                           onchange="updateItemField('${item._id}', 'unitCost', this.value)" placeholder="0.00">
                  </td>
                  <td class="px-4 py-3">
                    <input type="number" class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                           min="0" step="0.01" value="${item.poData?.unitDiscount || ''}" 
                           onchange="updateItemField('${item._id}', 'unitDiscount', this.value)" placeholder="0.00">
                  </td>
                  <td class="px-4 py-3">
                    <input type="number" class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                           min="0" max="100" step="0.01" value="${item.poData?.taxRate || 7}" 
                           onchange="updateItemField('${item._id}', 'taxRate', this.value)" placeholder="7.00">
                  </td>
                  <td class="px-4 py-3">
                    <select class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 dark:text-gray-100" 
                            onchange="updateItemField('${item._id}', 'taxType', this.value)">
                      <option value="">-- เลือกประเภทภาษี --</option>
                      <option value="แยกภาษี" ${item.poData?.taxType === 'แยกภาษี' ? 'selected' : ''}>แยกภาษี</option>
                      <option value="รวมภาษี" ${item.poData?.taxType === 'รวมภาษี' ? 'selected' : ''}>รวมภาษี</option>
                      <option value="ไม่มีภาษี" ${item.poData?.taxType === 'ไม่มีภาษี' ? 'selected' : ''}>ไม่มีภาษี</option>
                    </select>
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-blue-600" id="preVat_${item._id}">
                    ฿${item.poData?.preVatAmount ? parseFloat(item.poData.preVatAmount).toLocaleString('th-TH', {minimumFractionDigits: 2}) : '0.00'}
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-orange-600" id="vat_${item._id}">
                    ฿${item.poData?.vatAmount ? parseFloat(item.poData.vatAmount).toLocaleString('th-TH', {minimumFractionDigits: 2}) : '0.00'}
                  </td>
                  <td class="px-4 py-3 text-sm font-bold text-purple-600" id="total_${item._id}">
                    ฿${item.poData?.totalAmount ? parseFloat(item.poData.totalAmount).toLocaleString('th-TH', {minimumFractionDigits: 2}) : '0.00'}
                  </td>
                  <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${
                      item.poData && item.poData.supplierName && item.poData.unitCost
                        ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
                        : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400'
                    }">
                      ${item.poData && item.poData.supplierName && item.poData.unitCost ? 'ครบถ้วน' : 'รอกรอกข้อมูล'}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function populateSupplierSelect() {
      const select = document.getElementById('supplierSelect');
      select.innerHTML = '<option value="">-- เลือกผู้จำหน่าย --</option>';
    
      suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier._id;
        option.textContent = `${supplier.name} (${supplier.supplier_type})`;
        select.appendChild(option);
      });
    }

    function populateBranchFilter() {
      const select = document.getElementById('branchFilter');
      select.innerHTML = '<option value="">ทุกสาขา</option>';
    
      branches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.branchCode;
        option.textContent = `${branch.branchName} (${branch.branchCode})`;
        select.appendChild(option);
      });
    }

    function updateStatistics() {
      const total = backdatedItems.length;
      const completed = backdatedItems.filter(item => item.poData && item.poData.supplierName).length;
    
      // คำนวณมูลค่ารวมจากข้อมูล PO ที่กรอกแล้ว
      const totalValue = backdatedItems.reduce((sum, item) => {
        return sum + (item.poData?.totalAmount || 0);
      }, 0);
    
      document.getElementById('totalBackdatedItems').textContent = total;
      document.getElementById('completedPOs').textContent = completed;
      document.getElementById('totalValue').textContent = formatCurrency(totalValue);
    }

    // Selection Functions
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    
      if (selectAllCheckbox.checked) {
        selectedItems = backdatedItems.map(item => item._id);
        itemCheckboxes.forEach(checkbox => checkbox.checked = true);
        showToast(`เลือกแล้ว ${selectedItems.length} รายการ`, 'success');
      } else {
        selectedItems = [];
        itemCheckboxes.forEach(checkbox => checkbox.checked = false);
      }
    
      updateSelectedItemsDisplay();
    }

    function updateItemField(itemId, field, value) {
      const itemIndex = backdatedItems.findIndex(item => item._id === itemId);
      if (itemIndex === -1) return;
    
      const item = backdatedItems[itemIndex];
      if (!item.poData) {
        item.poData = {};
      }
    
      // อัพเดทค่าตามฟิลด์
      switch (field) {
        case 'supplier':
          const supplier = suppliers.find(s => s._id === value);
          item.poData.supplierId = value;
          item.poData.supplierName = supplier ? supplier.name : '';
          break;
        case 'categoryGroup':
          item.poData.categoryGroup = value;
          break;
        case 'unitCost':
          item.poData.unitCost = parseFloat(value) || 0;
          break;
        case 'unitDiscount':
          item.poData.unitDiscount = parseFloat(value) || 0;
          break;
        case 'taxRate':
          item.poData.taxRate = parseFloat(value) || 0;
          break;
        case 'taxType':
          item.poData.taxType = value;
          break;
      }
    
      // คำนวณยอดเงินใหม่
      calculateItemTotals(itemId);
    
      // บันทึกข้อมูลลง localStorage
      const savedPOData = JSON.parse(localStorage.getItem('backdatedPOData') || '{}');
      savedPOData[itemId] = item.poData;
      localStorage.setItem('backdatedPOData', JSON.stringify(savedPOData));
    
      // อัพเดทสถิติ
      updateStatistics();
    }

    function calculateItemTotals(itemId) {
      const item = backdatedItems.find(i => i._id === itemId);
      if (!item || !item.poData) return;
    
      const unitCost = parseFloat(item.poData.unitCost) || 0;
      const unitDiscount = parseFloat(item.poData.unitDiscount) || 0;
      const taxRate = parseFloat(item.poData.taxRate) || 0;
    
      const netCost = unitCost - unitDiscount;
      const vatAmount = (netCost * taxRate) / 100;
      const totalAmount = netCost + vatAmount;
    
      // อัพเดทข้อมูลใน object
      item.poData.preVatAmount = netCost;
      item.poData.vatAmount = vatAmount;
      item.poData.totalAmount = totalAmount;
    
      // อัพเดทการแสดงผลในตาราง
      const preVatElement = document.getElementById(`preVat_${itemId}`);
      const vatElement = document.getElementById(`vat_${itemId}`);
      const totalElement = document.getElementById(`total_${itemId}`);
    
      if (preVatElement) preVatElement.textContent = `฿${netCost.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
      if (vatElement) vatElement.textContent = `฿${vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
      if (totalElement) totalElement.textContent = `฿${totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
    }
    function toggleItemSelection(itemId) {
      const checkbox = document.querySelector(`input[value="${itemId}"]`);
      if (checkbox.checked) {
        if (!selectedItems.includes(itemId)) {
          selectedItems.push(itemId);
        }
      } else {
        selectedItems = selectedItems.filter(id => id !== itemId);
      }
    
      updateSelectedItemsDisplay();
    }

    function selectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = true;
        toggleSelectAll();
      } else {
        // Fallback for old method
        selectedItems = backdatedItems.map(item => item._id);
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
          checkbox.checked = true;
        });
        updateSelectedItemsDisplay();
        showToast(`เลือกแล้ว ${selectedItems.length} รายการ`, 'success');
      }
    }

    function updateSelectedItemsDisplay() {
      const container = document.getElementById('selectedItemsList');
      const selectedItemsData = backdatedItems.filter(item => selectedItems.includes(item._id));
    
      if (selectedItemsData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">ยังไม่ได้เลือกรายการ</p>';
        return;
      }

      container.innerHTML = selectedItemsData.map(item => `
        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div>
            <span class="font-medium text-gray-800 dark:text-gray-200">${item.name}</span>
            <span class="text-sm text-gray-600 dark:text-gray-400 ml-2">(${item.brand})</span>
          </div>
          <span class="text-sm text-gray-500 dark:text-gray-400">${item.imei}</span>
        </div>
      `).join('');
    }

    // Modal Functions
    function createSelectedPOs() {
      if (selectedItems.length === 0) {
        showToast('กรุณาเลือกรายการที่ต้องการสร้าง PO', 'warning');
        return;
      }
    
      // ตรวจสอบว่าสินค้าที่เลือกมีข้อมูล PO ครบหรือยัง
      const incompleteItems = selectedItems.filter(itemId => {
        const item = backdatedItems.find(i => i._id === itemId);
        return !item.poData || !item.poData.supplierName || !item.poData.unitCost;
      });
    
      if (incompleteItems.length > 0) {
        showToast('มีสินค้าบางรายการยังไม่ได้กรอกข้อมูล PO ครบถ้วน กรุณากรอกข้อมูลให้ครบก่อน', 'warning');
        return;
      }
    
      updateSelectedItemsDisplay();
      document.getElementById('createPOModal').classList.remove('hidden');
    
      // Set default date to today
      document.getElementById('purchaseDate').valueAsDate = new Date();
    }

    function closePOModal() {
      document.getElementById('createPOModal').classList.add('hidden');
      document.getElementById('createPOForm').reset();
    }

    // Form Functions
    async function handleCreatePO(event) {
      event.preventDefault();
      showLoading(true);

      const formData = {
        supplierSelect: document.getElementById('supplierSelect').value,
        purchaseDate: document.getElementById('purchaseDate').value,
        note: document.getElementById('poNote').value,
        items: selectedItems
      };

      if (!formData.supplierSelect || !formData.purchaseDate) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        showLoading(false);
        return;
      }

      try {
        const token = localStorage.getItem('authToken');
        const selectedItemsData = backdatedItems.filter(item => selectedItems.includes(item._id));
        const supplier = suppliers.find(s => s._id === formData.supplierSelect);

        // ตรวจสอบข้อมูล PO ของแต่ละรายการ
        const incompleteItems = selectedItemsData.filter(item =>
          !item.poData || !item.poData.unitCost || item.poData.unitCost <= 0
        );

        if (incompleteItems.length > 0) {
          showToast(`มีรายการที่ยังไม่ได้กรอกข้อมูลครบถ้วน: ${incompleteItems.map(item => item.name).join(', ')}`, 'error');
          showLoading(false);
          return;
        }

        // เตรียมข้อมูลสำหรับส่งไป API
        const bulkPOData = {
          selectedItems: selectedItems,
          supplier: supplier,
          purchaseDate: formData.purchaseDate,
          note: formData.note,
          poNumber: `PO-BD-${Date.now()}`
        };

        // เรียก API สร้าง PO ย้อนหลัง
        const response = await fetch('/api/quick-sale/bulk-create-po', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(bulkPOData)
        });

        const result = await response.json();

        if (result.success) {
          showToast(result.message || 'สร้าง PO ย้อนหลังสำเร็จ!', 'success');

          // เตรียมข้อมูลสำหรับส่งไปยัง PO.html
          const poDataForTransfer = result.data.poData;

          // บันทึกลง localStorage สำหรับส่งต่อ
          const existingPOs = JSON.parse(localStorage.getItem('backdatedPOs') || '[]');
          existingPOs.push(poDataForTransfer);
          localStorage.setItem('backdatedPOs', JSON.stringify(existingPOs));

          // ส่งข้อมูลไปยัง purchase_order.html (ฝ่ายบัญชี)
          const accountingPOs = JSON.parse(localStorage.getItem('accountingPOs') || '[]');
          accountingPOs.push({
            ...poDataForTransfer,
            status: 'waiting_approval',
            sentToAccounting: new Date().toISOString()
          });
          localStorage.setItem('accountingPOs', JSON.stringify(accountingPOs));

          // Clear localStorage data ที่ไม่ต้องการแล้ว
          selectedItems.forEach(itemId => {
            const savedPOData = JSON.parse(localStorage.getItem('backdatedPOData') || '{}');
            delete savedPOData[itemId];
            localStorage.setItem('backdatedPOData', JSON.stringify(savedPOData));
          });

          // Reset form และ selection
          closePOModal();
          selectedItems = [];
          document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.checked = false;
          });
          document.getElementById('selectAllCheckbox').checked = false;

          // รีเฟรชข้อมูล
          loadBackdatedItems();

          // เปิดหน้า PO.html ในแท็บใหม่
          const poUrl = `./PO.html?newPO=${encodeURIComponent(JSON.stringify({
            ...poDataForTransfer,
            source: 'backdated'
          }))}`;

          setTimeout(() => {
            window.open(poUrl, '_blank');
          }, 1000);

        } else {
          throw new Error(result.error || 'เกิดข้อผิดพลาดในการสร้าง PO');
        }

      } catch (err) {
        console.error('Error creating PO:', err);
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    }

    // Filter Functions
    function applyFilters() {
      // Implementation for filtering
      showToast('กำลังกรองข้อมูล...', 'info');
      loadBackdatedItems();
    }

    function clearFilters() {
      document.getElementById('branchFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      loadBackdatedItems();
    }

    // Navigation
    function goBack() {
      window.location.href = './PO.html';
    }

    async function logout() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login';
    }

    // Sidebar Toggle Functionality
    function initializeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const toggleBtn = document.getElementById('btnToggleMenu');
      const toggleIcon = toggleBtn.querySelector('i');

      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
    
        if (sidebar.classList.contains('collapsed')) {
          sidebar.style.width = '5rem';
          mainContent.style.marginLeft = '5rem';
          toggleIcon.classList.remove('bi-chevron-left');
          toggleIcon.classList.add('bi-chevron-right');
        } else {
          sidebar.style.width = '14rem';
          mainContent.style.marginLeft = '14rem';
          toggleIcon.classList.remove('bi-chevron-right');
          toggleIcon.classList.add('bi-chevron-left');
        }
      });
    }

    // Dark Mode Toggle
    function initializeDarkMode() {
      const toggleBtn = document.getElementById('btnToggleDark');
      const darkModeLabel = document.getElementById('darkModeLabel');
      const body = document.body;

      // Check for saved theme preference
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        body.classList.add('dark');
        darkModeLabel.textContent = 'Light Mode';
      }

      toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark');
    
        if (body.classList.contains('dark')) {
          localStorage.setItem('theme', 'dark');
          darkModeLabel.textContent = 'Light Mode';
        } else {
          localStorage.setItem('theme', 'light');
          darkModeLabel.textContent = 'Dark Mode';
        }
      });
    }

    // Employee Profile Loading
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const employee = result.data;
            document.getElementById('employeeName').textContent = employee.name || 'ไม่ระบุชื่อ';
    
            // Set employee photo
            const photoElement = document.getElementById('employeePhoto');
            if (employee.photo) {
              photoElement.src = `/uploads/${employee.photo}`;
            } else {
              photoElement.src = 'https://via.placeholder.com/40x40?text=👤';
            }
          }
        }
      } catch (error) {
        console.error('Error loading employee profile:', error);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        showLoading(true);
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;
    
        // Initialize UI components
        initializeSidebar();
        initializeDarkMode();
        loadEmployeeProfile();
    
        // Load initial data
        await Promise.all([
          loadBackdatedItems(),
          loadSuppliers(),
          loadBranches()
        ]);
    
        // Initialize flatpickr with Thai locale
        flatpickr('#purchaseDate', {
          locale: 'th',
          dateFormat: 'Y-m-d',
          defaultDate: new Date()
        });

        flatpickr('#startDate', {
          locale: 'th',
          dateFormat: 'Y-m-d'
        });

        flatpickr('#endDate', {
          locale: 'th',
          dateFormat: 'Y-m-d'
        });

        // Setup form listener
        document.getElementById('createPOForm').addEventListener('submit', handleCreatePO);

        // Setup logout button
        document.getElementById('btnLogout').addEventListener('click', logout);
    
      } catch (err) {
        console.error('Initialization error:', err);
        showToast('ไม่สามารถเตรียมระบบได้: ' + err.message, 'error');
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    });

    // ทำความสะอาด Lottie animation เมื่อหน้าเว็บถูกปิด
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>
</body>
</html>