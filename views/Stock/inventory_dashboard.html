<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Stock Management - ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ï‡πä‡∏≠‡∏Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
    

<script src="../js/activity-tracker.js"></script>
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] }
        }
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>

  <!-- DaisyUI -->
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
    rel="stylesheet"
    type="text/css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Lottie Web for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <!-- Global socket initialization -->
  <script>
    // Global socket declaration with enhanced error handling
    let socket;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const RECONNECT_DELAY = 5000; // 5 seconds

    function initializeSocket() {
      try {
        // Configure socket with options
        socket = io({
          reconnection: true,
          reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
          reconnectionDelay: RECONNECT_DELAY,
          timeout: 10000,
          transports: ['websocket', 'polling']
        });

        // Connection event handlers
        socket.on('connect', () => {
          console.log('‚úÖ Socket connected successfully');
          reconnectAttempts = 0;
        });

        socket.on('connect_error', (error) => {
          console.warn('‚ö†Ô∏è Socket connection error:', error);
          reconnectAttempts++;
    
          if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            console.error('‚ùå Max reconnection attempts reached');
            // Create fallback socket object
            socket = {
              on: () => {},
              emit: () => {},
              disconnect: () => {},
              connected: false
            };
          }
        });

        socket.on('disconnect', (reason) => {
          console.log('üîå Socket disconnected:', reason);
          if (reason === 'io server disconnect') {
            // Server disconnected us, try to reconnect
            setTimeout(() => {
              if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                console.log('üîÑ Attempting to reconnect...');
                socket.connect();
              }
            }, RECONNECT_DELAY);
          }
        });

        // Error event handler
        socket.on('error', (error) => {
          console.error('üö® Socket error:', error);
        });

      } catch (error) {
        console.error('‚ùå Socket initialization error:', error);
        // Create fallback socket object
        socket = {
          on: () => {},
          emit: () => {},
          disconnect: () => {},
          connected: false
        };
      }
    }

    // Initialize socket connection
    initializeSocket();
  </script>

  <style>
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Prompt', sans-serif;
    }
    /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fadeIn */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sidebar ‡∏ó‡∏µ‡πà‡∏¢‡∏∏‡∏ö */
    aside.collapsed {
      width: 5rem;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Sidebar ‡∏¢‡∏∏‡∏ö */
    aside.collapsed .ml-3 {
      display: none;
    }
    /* Spinner ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    details summary i {
      transition: transform 0.2s;
    }
    details[open] summary i {
      transform: rotate(180deg);
    }

    /* Logo styling */
    .Logo { max-width:100%; height:auto; }

    /* Mobile Menu Overlay */
    .menu-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); z-index: 15; display: none;
    }
    .menu-overlay.active { display: block; }

    /* Stock type badges */
    .stock-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .stock-badge-imei {
      background-color: #dbeafe;
      color: #1e40af;
    }
    .dark .stock-badge-imei {
      background-color: #1e3a8a;
      color: #bfdbfe;
    }
    .stock-badge-quantity {
      background-color: #dcfce7;
      color: #166534;
    }
    .dark .stock-badge-quantity {
      background-color: #14532d;
      color: #bbf7d0;
    }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
    .last-edited-info {
      max-width: 120px;
      word-wrap: break-word;
    }
    .last-edited-info .editor-name {
      font-weight: 500;
      color: #2563eb;
    }
    .last-edited-info .edit-date {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .dark .last-edited-info .editor-name {
      color: #60a5fa;
    }
    .dark .last-edited-info .edit-date {
      color: #9ca3af;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      aside { z-index: 30; }
      #mainContent { margin-left: 0 !important; }
      aside:not(.translate-x-0) { transform: translateX(-100%); }
      .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      table { min-width: 600px; }
    }
    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>

<body class="flex flex-col min-h-screen bg-white text-gray-700 dark:bg-gray-800 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Mobile Menu Overlay -->
  <div id="menuOverlay" class="menu-overlay"></div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Toggle Menu ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ (Floating) -->
  <button id="btnToggleMenu" title="Toggle Menu" aria-label="Toggle Menu"
          class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition md:p-2 p-3">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="flex flex-1">
    <!-- Sidebar -->
    <div class="flex w-full">
    <!-- Sidebar -->
    <aside id="sidebar"
       class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
              transform transition-transform duration-300 translate-x-0 z-20">
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Logo/Title) -->
      <a href="StockManagehome" class="p-4 border-b border-gray-200 dark:border-gray-700">
        <img src="/uploads/Logo2.png"
             alt="Logo"
             class="Logo animate-float shadow-soft w-full h-full object-cover" />
      </a>
      <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å (Vertical Menu) -->
      <div class="flex-1 p-4 overflow-hidden">
        <ul class="flex flex-col w-full space-y-1">

        <li class="my-px">
                    <a href="branch_stock_overview"
                      class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                      <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                        <i class="bi bi-grid text-xl"></i>
                      </span>
                      <span class="ml-3">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                    </a>
                  </li>

          <!-- ‡πÄ‡∏°‡∏ô‡∏π: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
          <li class="my-px">
            <a href="inventory_dashboard"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                <i class="bi bi-clipboard-check text-xl"></i>
              </span>
              <span class="ml-3">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
            </a>
          </li>

          <!-- ‡πÄ‡∏°‡∏ô‡∏π:PO -->
          <li class="my-px">
            <a href="PO"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                <i class="bi bi-file-earmark-text text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
            </a>
          </li>
          <!-- ‡πÄ‡∏°‡∏ô‡∏π: Quotation -->
          <li class="my-px">
            <a href="quotation_Stock"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                <i class="bi bi-file-earmark-richtext text-xl"></i>
              </span>
              <span class="ml-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
            </a>
          </li>
          <!-- ‡πÄ‡∏°‡∏ô‡∏π: Transfer -->
          <li class="my-px">
            <a href="Transfer"
                    class="flex flex-row items-center h-12 px-4 rounded-lg
            text-gray-600 dark:text-gray-200 
            hover:bg-gray-100 dark:hover:bg-gray-700 transition-all sidebar-link">
              <span class="flex items-center justify-center text-lg text-primary-500 dark:text-primary-400">
                <i class="bi bi-truck text-xl"></i>
              </span>
              <span class="ml-3">‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>
          <li class="my-px">
            <a href="product_Image"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-yellow-500 dark:text-yellow-400">
                <i class="bi bi-upc-scan text-xl"></i>
              </span>
              <span class="ml-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>
          <!-- ‡πÄ‡∏°‡∏ô‡∏π: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
          <li class="my-px">
            <a href="StockAdditional"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-indigo-500 dark:text-indigo-400">
                <i class="bi bi-three-dots text-xl"></i>
              </span>
              <span class="ml-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
            </a>
          </li>


          <li class="my-px mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
            <!-- Dark Mode Toggle -->
            <button id="btnToggleDark"
                    class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-left transition-all">
              <span class="flex items-center justify-center text-lg text-indigo-600 dark:text-indigo-300">
                <i class="bi bi-moon-stars text-xl"></i>
              </span>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <!-- Logout -->
          <li class="my-px">
            <button id="btnLogout"
                    class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-left transition-all">
              <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                <i class="bi bi-box-arrow-right text-xl"></i>
              </span>
              <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </li>
          <!-- Profile (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å API) -->
          <li class="my-px mt-2">
            <div id="profile"
                 class="flex flex-row items-center h-16 px-4 w-full rounded-lg bg-gray-50 text-gray-700 dark:bg-gray-800/50 dark:text-gray-200 text-left transition-colors">
              <div class="avatar mr-3">
                <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                  <img id="employeePhoto" src="" alt="Employee Photo" class="w-full h-full object-cover" />
                </div>
              </div>
              <div class="flex flex-col">
                <span class="text-sm font-medium" id="employeeName">Loading...</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Main Content) -->
    <div id="mainContent"
         class="flex-1 flex flex-col ml-0 md:ml-56 transition-all duration-300 ease-in-out">
      <!-- Header -->
      <header class="p-4 bg-white dark:bg-gray-800  flex justify-between items-center transition-colors">
        <h1 class="text-xl font-bold" id="pageTitle">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h1>
      </header>

   <!-- Container ‡∏´‡∏•‡∏±‡∏Å -->
<div class="container mx-auto p-4 md:p-6 space-y-6">

  <!-- Card: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ + ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
  <section class="bg-white dark:bg-gray-800 rounded-2xl overflow-hidden">
      <div class="px-6 py-4">
        <h2 class="text-lg font-semibold text-white flex items-center">
          <i class="bi bi-building-fill mr-2 text-2xl"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ &amp; ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        </h2>
      </div>
    <div class="p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 items-end">
      <!-- ‡∏™‡∏≤‡∏Ç‡∏≤ -->
      <div>
        <label for="branchSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏™‡∏≤‡∏Ç‡∏≤</label>
        <select id="branchSelect"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-300 transition">
          <option value="all">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
        </select>
      </div>
     <!-- 1. ‡πÇ‡∏´‡∏•‡∏î Flatpickr CSS -->
<link
rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>

<!-- 2. ‡πÇ‡∏´‡∏•‡∏î Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>





      <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏•‡πâ‡∏≤‡∏á -->
      <div class="sm:col-span-2 lg:col-span-2 flex space-x-4">
        <button id="btnFilter"
                class="flex-1 inline-flex justify-center items-center px-6 py-2 bg-gradient-to-r from-blue-400 to-blue-600 hover:from-green-600 hover:to-green-700 text-white font-medium rounded-lg shadow-lg transition">
          <i class="bi bi-search mr-2"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
        <button id="btnReset"
                class="flex-1 inline-flex justify-center items-center px-6 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-lg shadow transition">
          <i class="bi bi-arrow-counterclockwise mr-2"></i> ‡∏•‡πâ‡∏≤‡∏á
        </button>
      </div>
    </div>
  </section>

   <!-- Card: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å (Grouped) ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î -->
   <section class="bg-white dark:bg-gray-800 rounded-2xl overflow-hidden">
    <div class="px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-semibold text-white flex items-center">
        <i class="bi bi-box-seam-fill mr-3 text-2xl"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å (Grouped)
      </h2>
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á/‡∏¢‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
      <button id="btnExpandAll" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
        ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
    </div>
    <!-- Ensure only one groupedStockContainer exists -->
    <div id="groupedStockContainer" class="px-6 py-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏ú‡πà‡∏≤‡∏ô JS -->
    </div>
  </section>

  <!-- Hidden input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î -->
<input
  type="text"
  id="barcodeInput"
  autofocus
  class="absolute top-0 left-0 w-px h-px opacity-0 border-0"
/>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Item -->
<div
  id="editItemModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm hidden"
>
  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Modal ‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô -->
  <div
    class="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100
           rounded-lg shadow-2xl w-full max-w-2xl mx-4 md:mx-auto
           max-h-[90vh] overflow-y-auto animate-fadeIn p-6 transition-colors"
  >
    <form id="editItemForm" class="space-y-6">
      <!-- Header -->
      <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
        <h5 class="text-xl font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô PO</h5>
        <button
          type="button"
          id="btnCloseEditItemModal"
          class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition"
        >
          <i class="bi bi-x-lg text-2xl"></i>
        </button>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="editPoId" />
      <input type="hidden" id="editItemIndex" />
      <input type="hidden" id="editProductId" />

      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏¥‡∏î 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Barcode -->
        <div>
          <label for="editBarcode" class="block text-sm font-medium mb-1">Barcode</label>
          <input
            type="text"
            id="editBarcode"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-300 transition-colors"
          />
        </div>
        <!-- SKU (read-only) -->
        <div>
          <label for="editSku" class="block text-sm font-medium mb-1">SKU</label>
          <input
            type="text"
            id="editSku"
            readonly
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 transition-colors"
          />
        </div>
        <!-- IMEI -->
        <div id="editImeiContainer">
          <label for="editImei" class="block text-sm font-medium mb-1">IMEI</label>
          <input
            type="text"
            id="editImei"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-300 transition-colors"
          />
        </div>
        <!-- Name -->
        <div>
          <label for="editName" class="block text-sm font-medium mb-1">Name</label>
          <input
            type="text"
            id="editName"
            required
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-300 transition-colors"
          />
        </div>
        <!-- Invoice Number -->
        <div>
          <label for="editInvoiceNumber" class="block text-sm font-medium mb-1">Invoice Number (IN)</label>
          <input
            type="text"
            id="editInvoiceNumber"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-300 transition-colors"
          />
        </div>
        <!-- Brand -->
        <div>
          <label for="editBrand" class="block text-sm font-medium mb-1">Brand</label>
          <input
            type="text"
            id="editBrand"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                   bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-300 transition-colors"
          />
        </div>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å -->
      <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button
          type="button"
          id="btnCancelEdit"
          class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-lg hover:bg-gray-600 dark:hover:bg-gray-500 transition"
        >
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button
          type="submit"
          class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          <i class="bi bi-save mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </form>
  </div>
</div>



  <!-- Footer ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô flex layout -->
  <footer class="bg-white dark:bg-gray-800 py-2 text-center text-sm text-gray-600 dark:text-gray-400 mt-auto">
    ¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.
  </footer>

  <!-- Toast Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö showToast() -->
  <div id="toastContainer" class="fixed top-5 right-5 space-y-2 z-50"></div>

  <script>
    // -------------------------------------------
    // 1) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Toast Notification
    // -------------------------------------------
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      let alertClass = 'alert alert-info';
      if (type === 'success') alertClass = 'alert alert-success';
      else if (type === 'error') alertClass = 'alert alert-error';
      else if (type === 'warning') alertClass = 'alert alert-warning';
      toast.className = `${alertClass} shadow-lg mb-4 animate-fadeIn`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition', 'duration-500');
        setTimeout(() => {
          toast.remove();
        }, 500);
      }, 3000);
    }

    // --------------------
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Dark Mode
    // --------------------
    function loadDarkModeSetting() {
      const darkMode = localStorage.getItem('darkMode') === 'true';
      document.documentElement.classList.toggle('dark', darkMode);
      document.getElementById('darkModeLabel').textContent = darkMode ? 'Light Mode' : 'Dark Mode';
    }
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);
      document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }

    // --------------------
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -> ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ
    // --------------------
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const res = await fetch('/api/users/me', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const result = await res.json();

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Unauthorized (401) ‡∏´‡∏£‡∏∑‡∏≠ success=false ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        if (res.status === 401 || (!res.ok && result.error?.includes('‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß'))) {
          // ‡∏•‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡πÄ‡∏Å‡πà‡∏≤
          localStorage.removeItem('authToken');
          // ‡∏ö‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          showToast('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'warning');
          // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô redirect ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ toast ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á)
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1500);
          return;
        }

        if (!res.ok || !result.success) {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
        }

        const user = result.data;
        document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';

        let photoUrl = user.photoUrl || '';
        if (!photoUrl.startsWith('/') && !/^https?:\/\//.test(photoUrl)) {
          photoUrl = '/' + photoUrl;
        }
        document.getElementById('employeePhoto').src = photoUrl;

      } catch (err) {
        console.error('Load Employee Profile Error:', err);
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á toast ‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + err.message, 'error');
      }
    }

    // ‡∏î‡∏∂‡∏á user ID ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å token
    async function getCurrentUserId() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return null;
        const res = await fetch('/api/users/me', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const result = await res.json();
        if (res.ok && result.success) return result.data._id;
        return null;
      } catch (err) {
        console.error('Error getting user ID:', err);
        return null;
      }
    }

    // --------------------
    // Global Variables
    // --------------------
    let allStocks = [];
    let originalValues = {};
    let currentLang = 'th';

    // --------------------
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
    // --------------------
    async function loadBranches() {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/branch', {
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          }
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤');
        }
        const branchSelect = document.getElementById('branchSelect');
        branchSelect.innerHTML = '<option value="all">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
        data.data.forEach((b) => {
          const opt = document.createElement('option');
          opt.value = b.branch_code;
          opt.textContent = `[${b.branch_code}] ${b.name}`;
          branchSelect.appendChild(opt);
        });
      } catch (err) {
        showToast('Error loading branches: ' + err.message, 'error');
      }
    }

    // --------------------
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å
    // --------------------
    async function loadStock() {
  // 1) ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô
  const openIds = getOpenStockIds();

  const branchCode = document.getElementById('branchSelect').value;
  if (!branchCode) return;

  showLoading(true);
  try {
    const token = localStorage.getItem('authToken');
    let url = branchCode === 'all'
      ? '/api/branch-stock?include_unverified=1&populate=supplier,poNumber'  // ‡πÄ‡∏û‡∏¥‡πà‡∏° populate supplier ‡πÅ‡∏•‡∏∞ poNumber
      : `/api/branch-stock?branch_code=${branchCode}&include_unverified=1&populate=supplier,poNumber`;

    console.log('Loading stock from:', url);

    const res = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + token
      }
    });

    const data = await res.json();
    
    // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• supplier
    if (data.data && data.data.length > 0) {
      console.log('Sample stock supplier data:', {
        stockId: data.data[0]._id,
        supplier: data.data[0].supplier
      });
    }

    if (!res.ok || !data.success) throw new Error(data.error || '‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const rawStocks = data.data || [];

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    const pendingStocks    = rawStocks.filter(s => s.pending === true);
    const unverifiedStocks = rawStocks.filter(s => s.pending !== true && s.verified !== true);

    console.log('Pending stocks:', pendingStocks.length);
    console.log('Unverified stocks:', unverifiedStocks.length);

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô allStocks
    allStocks = [...pendingStocks, ...unverifiedStocks];

    // ‡∏•‡πâ‡∏≤‡∏á container ‡∏Å‡πà‡∏≠‡∏ô
    const container = document.getElementById('groupedStockContainer');
    container.innerHTML = '';

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° pending ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (pendingStocks.length > 0) {
      renderPendingStocks(pendingStocks);
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° unverified ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (unverifiedStocks.length > 0) {
      const grouped = groupStockByBrand(unverifiedStocks);
      renderGroupedStocks(grouped);
    } else if (pendingStocks.length === 0) {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
      container.innerHTML = `<div class="col-span-full text-center text-gray-500">
        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      </div>`;
    }

    // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÄ‡∏õ‡∏¥‡∏î" ‡∏Ç‡∏≠‡∏á <details>
    openIds.forEach(id => {
      const detail = Array.from(
        document.querySelectorAll('#groupedStockContainer details')
      ).find(d => d.querySelector(`[data-stock-id="${id}"]`));
      if (detail) detail.open = true;
    });

  } catch (err) {
    console.error('Error loading stock:', err);
    showToast('Error loading stock: ' + err.message, 'error');
  } finally {
    setTimeout(() => { showLoading(false); }, 600);
  }

      // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• stock ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    console.log('üìä All stocks received:', allStocks);
    if (allStocks.length > 0) {
      console.log('üìã First stock sample:', allStocks[0]);
      console.log('üìã Barcode:', allStocks[0].barcode);
      console.log('üìã SKU:', allStocks[0].sku);
    }
}


    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (pending=true)
     */
    function renderPendingStocks(pendingArray) {
      const container = document.getElementById('groupedStockContainer');
      const oldHdr = document.getElementById('pendingSectionHeader');
      const oldLst = document.getElementById('pendingSectionList');
      if (oldHdr) oldHdr.remove();
      if (oldLst) oldLst.remove();

      const hdr = document.createElement('h3');
      hdr.id = 'pendingSectionHeader';
      hdr.className = 'col-span-full text-lg font-semibold text-red-600 dark:text-red-400';
      hdr.textContent = `üìå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${pendingArray.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

      const list = document.createElement('div');
      list.id = 'pendingSectionList';
      list.className = 'grid grid-cols-1 gap-4 mb-6';

      pendingArray.forEach(stock => {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• supplier ‡∏à‡∏≤‡∏Å stock ‡πÅ‡∏•‡∏∞ log ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
        console.log('Pending stock supplier data:', {
          stockId: stock._id,
          supplier: stock.supplier,
          rawData: stock
        });

        // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ supplier ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        let supplierName = '‚Äì';
        if (stock.supplier) {
          if (typeof stock.supplier === 'object' && stock.supplier.name) {
            supplierName = stock.supplier.name;
          } else if (typeof stock.supplier === 'string') {
            supplierName = stock.supplier;
          }
        }

        const card = document.createElement('details');
        card.className = 'bg-yellow-50 dark:bg-yellow-800 rounded-lg shadow p-4 transition group';
        const sum = document.createElement('summary');
        sum.className = 'flex justify-between items-center cursor-pointer';
        // ‡∏î‡∏∂‡∏á stockType ‡∏à‡∏≤‡∏Å product_id (ProductImage) ‡∏´‡∏£‡∏∑‡∏≠ stockType field ‡πÉ‡∏ô BranchStock
        let stockTypeBadge = '';
        let stockType = stock.stockType || 'imei'; // default to imei
    
        // ‡∏ñ‡πâ‡∏≤ product_id populated ‡πÅ‡∏•‡∏∞‡∏°‡∏µ stockType
        if (stock.product_id && stock.product_id.stockType) {
          stockType = stock.product_id.stockType;
        }
    
        // Debug logging
        console.log('Stock name:', stock.name, 'stockType:', stockType, 'product_id:', stock.product_id);
    
        stockTypeBadge = stockType === 'imei'
          ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200"><i class="bi bi-qr-code mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>'
          : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"><i class="bi bi-boxes mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>';
    
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quantity ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á IMEI ‡πÄ‡∏•‡∏¢
        const imeiDisplay = (stockType === 'quantity') ? null : (stock.imei || '-');
    
        sum.innerHTML = `
          <div>
            <div class="font-medium text-gray-800 dark:text-gray-100">${stock.name}</div>
            ${imeiDisplay ? `<div class="text-sm text-gray-500 dark:text-gray-400">IMEI: ${imeiDisplay}</div>` : ''}
            ${stockTypeBadge ? `<div class="mt-1">${stockTypeBadge}</div>` : ''}
          </div>
          <i class="bi bi-exclamation-circle text-red-500 text-xl"></i>
        `;
        card.appendChild(sum);

        const detail = document.createElement('div');
        detail.className = 'mt-3 grid grid-cols-1 gap-1 text-sm text-gray-700 dark:text-gray-200';
        console.log('üîç Pending stock data:', stock.name, 'barcode:', stock.barcode, 'sku:', stock.sku);
        detail.innerHTML = `
          <div><strong>Supplier:</strong> ${supplierName}</div>
          <div><strong>Barcode:</strong> ${stock.barcode||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
          <div><strong>SKU:</strong> ${stock.sku||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
          <div><strong>Brand:</strong> ${stock.brand||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
          <div class="flex items-center space-x-2 mt-2">
            <button class="btn-approve-stock btn btn-sm btn-outline btn-success" data-stock-id="${stock._id}">
              <i class="bi bi-check-lg mr-1"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </button>
            <button class="btn-reject-stock btn btn-sm btn-outline btn-error" data-stock-id="${stock._id}">
              <i class="bi bi-trash mr-1"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
            </button>
          </div>
        `;
        card.appendChild(detail);
        card.addEventListener('toggle', function() {
          if (!this.open) return;
          document.querySelectorAll('#groupedStockContainer details')
            .forEach(d => { if (d!==this) d.open = false; });
        });
        list.appendChild(card);
      });

      container.prepend(list);
      container.prepend(hdr);

      document.querySelectorAll('.btn-approve-stock')
        .forEach(btn => btn.addEventListener('click', () => approvePending(btn.dataset.stockId)));
      document.querySelectorAll('.btn-reject-stock')
        .forEach(btn => btn.addEventListener('click', () => rejectPending(btn.dataset.stockId)));
    }

// ==================== INVENTORY DUPLICATE VALIDATION SYSTEM ====================

// Enhanced duplicate validation cache for performance
const duplicateCheckCache = new Map();
const CACHE_DURATION = 30000; // 30 seconds

// Comprehensive duplicate validation for inventory items
async function validateInventoryItemDuplicate(stockId, stockData) {
  try {
    console.log('üîç Validating duplicate for stock:', stockId, stockData);
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentBranchDuplicate = await checkCurrentBranchDuplicate(stockData);
    if (currentBranchDuplicate.isDuplicate) {
      return {
        isDuplicate: true,
        source: 'current_branch',
        duplicateInfo: currentBranchDuplicate.data,
        message: createInventoryDuplicateMessage(currentBranchDuplicate.data, 'current_branch'),
        recommendation: getInventoryDuplicateRecommendation(currentBranchDuplicate.data)
      };
    }
    
    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
    const crossBranchDuplicate = await checkCrossBranchDuplicate(stockData);
    if (crossBranchDuplicate.isDuplicate) {
      return {
        isDuplicate: true,
        source: 'cross_branch',
        duplicateInfo: crossBranchDuplicate.data,
        message: createInventoryDuplicateMessage(crossBranchDuplicate.data, 'cross_branch'),
        recommendation: getInventoryDuplicateRecommendation(crossBranchDuplicate.data)
      };
    }
    
    return {
      isDuplicate: false,
      source: null,
      duplicateInfo: null,
      message: null,
      recommendation: null
    };
    
  } catch (error) {
    console.error('Inventory duplicate validation error:', error);
    return {
      isDuplicate: false,
      source: null,
      duplicateInfo: null,
      message: null,
      recommendation: null
    };
  }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
async function checkCurrentBranchDuplicate(stockData) {
  try {
    const branchCode = stockData.branch_code;
    const cacheKey = `current_branch_${branchCode}_${stockData.barcode}_${stockData.imei}`;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö cache
    if (duplicateCheckCache.has(cacheKey)) {
      const cached = duplicateCheckCache.get(cacheKey);
      if (Date.now() - cached.timestamp < CACHE_DURATION) {
        console.log('üöÄ Using cached current branch duplicate check');
        return cached.result;
      }
    }
    
    const url = `/api/branch-stock?branch_code=${branchCode}&include_all=1&verified=true`;
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
      }
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      const fallbackResult = { isDuplicate: false, data: null };
      duplicateCheckCache.set(cacheKey, { result: fallbackResult, timestamp: Date.now() });
      return fallbackResult;
    }
    
    const existingStocks = result.data || [];
    let duplicate = null;
    
    const stockType = stockData.stockType || 'imei';
    
    if (stockType === 'imei') {
      duplicate = existingStocks.find(s =>
        s._id !== stockData._id && // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        s.barcode === stockData.barcode &&
        s.imei === stockData.imei &&
        s.verified === true // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà verified ‡πÅ‡∏•‡πâ‡∏ß
      );
    } else if (stockType === 'quantity') {
      duplicate = existingStocks.find(s =>
        s._id !== stockData._id && // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        s.barcode === stockData.barcode &&
        s.stockType === 'quantity' &&
        s.verified === true // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà verified ‡πÅ‡∏•‡πâ‡∏ß
      );
    }
    
    const duplicateResult = {
      isDuplicate: !!duplicate,
      data: duplicate
    };
    
    // Cache result
    duplicateCheckCache.set(cacheKey, { result: duplicateResult, timestamp: Date.now() });
    
    return duplicateResult;
    
  } catch (error) {
    console.error('Current branch duplicate check error:', error);
    return { isDuplicate: false, data: null };
  }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
async function checkCrossBranchDuplicate(stockData) {
  try {
    const cacheKey = `cross_branch_${stockData.barcode}_${stockData.imei}`;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö cache
    if (duplicateCheckCache.has(cacheKey)) {
      const cached = duplicateCheckCache.get(cacheKey);
      if (Date.now() - cached.timestamp < CACHE_DURATION) {
        console.log('üöÄ Using cached cross branch duplicate check');
        return cached.result;
      }
    }
    
    // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ API ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    try {
      const response = await fetch('/api/branch-stock/check-cross-branch-duplicate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('authToken')
        },
        body: JSON.stringify({
          barcode: stockData.barcode,
          imei: stockData.imei,
          stockType: stockData.stockType || 'imei',
          excludeBranch: stockData.branch_code,
          excludeStockId: stockData._id
        })
      });
    
      if (response.status === 404) {
        // Fallback ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ API endpoint
        return await checkCrossBranchDuplicateFallback(stockData);
      }
    
      const result = await response.json();
    
      if (!response.ok || !result.success) {
        const fallbackResult = { isDuplicate: false, data: null };
        duplicateCheckCache.set(cacheKey, { result: fallbackResult, timestamp: Date.now() });
        return fallbackResult;
      }
    
      const duplicateResult = {
        isDuplicate: result.data.isDuplicate,
        data: result.data.duplicateInfo
      };
    
      // Cache result
      duplicateCheckCache.set(cacheKey, { result: duplicateResult, timestamp: Date.now() });
    
      return duplicateResult;
    
    } catch (apiError) {
      console.warn('Cross branch duplicate API failed, using fallback:', apiError.message);
      return await checkCrossBranchDuplicateFallback(stockData);
    }
    
  } catch (error) {
    console.error('Cross branch duplicate check error:', error);
    return { isDuplicate: false, data: null };
  }
}

// Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
async function checkCrossBranchDuplicateFallback(stockData) {
  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏≠‡∏≤‡∏à‡∏ä‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô fallback)
    const response = await fetch('/api/branch-stock?include_all=1&verified=true&limit=1000', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
      }
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      return { isDuplicate: false, data: null };
    }
    
    const allStocks = result.data || [];
    const stockType = stockData.stockType || 'imei';
    
    let duplicate = null;
    
    if (stockType === 'imei') {
      duplicate = allStocks.find(s =>
        s._id !== stockData._id && // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        s.branch_code !== stockData.branch_code && // ‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤
        s.barcode === stockData.barcode &&
        s.imei === stockData.imei &&
        s.verified === true // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà verified ‡πÅ‡∏•‡πâ‡∏ß
      );
    } else if (stockType === 'quantity') {
      duplicate = allStocks.find(s =>
        s._id !== stockData._id && // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        s.branch_code !== stockData.branch_code && // ‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤
        s.barcode === stockData.barcode &&
        s.stockType === 'quantity' &&
        s.verified === true // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà verified ‡πÅ‡∏•‡πâ‡∏ß
      );
    }
    
    return {
      isDuplicate: !!duplicate,
      data: duplicate
    };
    
  } catch (error) {
    console.error('Cross branch duplicate fallback error:', error);
    return { isDuplicate: false, data: null };
  }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö inventory
function createInventoryDuplicateMessage(duplicateInfo, source) {
  if (!duplicateInfo) return '‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';

  let message = `üö´ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤!\n\n`;

  message += `üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${duplicateInfo.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n`;
  message += `üè∑Ô∏è ‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î: ${duplicateInfo.barcode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n`;

  if (duplicateInfo.imei && (duplicateInfo.stockType === 'imei' || !duplicateInfo.stockType)) {
    message += `üì± IMEI: ${duplicateInfo.imei}\n`;
  }

  message += `üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤: ${duplicateInfo.branch_code || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n`;

  if (duplicateInfo.verified) {
    message += `‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß\n`;
  } else if (duplicateInfo.pending) {
    message += `‚è≥ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥\n`;
  } else {
    message += `‚è±Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥\n`;
  }

  if (duplicateInfo.created_at) {
    message += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ${new Date(duplicateInfo.created_at).toLocaleString('th-TH')}\n`;
  }

  if (duplicateInfo.scanned_by_name) {
    message += `üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢: ${duplicateInfo.scanned_by_name}\n`;
  }

  if (source === 'cross_branch') {
    message += `\n‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß`;
  } else {
    message += `\n‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß`;
  }

  message += `\n\nüí° ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å`;

  return message;
}

// ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÉ‡∏ô inventory
function getInventoryDuplicateRecommendation(duplicateInfo) {
  if (!duplicateInfo) return null;

  if (duplicateInfo.verified) {
    return {
      type: 'warning',
      message: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πâ‡∏≥‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å',
      canProceed: false
    };
  } else {
    return {
      type: 'info',
      message: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
      canProceed: true
    };
  }
}

// ‡πÅ‡∏™‡∏î‡∏á Alert ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÉ‡∏ô inventory
function showInventoryDuplicateAlert(duplicateResult) {
  const { duplicateInfo, source, message, recommendation } = duplicateResult;

  const existingAlert = document.querySelector('.inventory-duplicate-alert');
  if (existingAlert) existingAlert.remove();

  const alertModal = document.createElement('div');
  alertModal.className = 'inventory-duplicate-alert fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

  let recommendationHtml = '';
  if (recommendation) {
    const iconClass = recommendation.type === 'warning' ? 'bi-exclamation-triangle-fill text-yellow-500' :
                     'bi-info-circle-fill text-blue-500';
    
    recommendationHtml = `
      <div class="mt-3 p-3 rounded-lg ${recommendation.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200' :
                                        'bg-blue-50 dark:bg-blue-900/20 border border-blue-200'}">
        <div class="flex items-start gap-2">
          <i class="bi ${iconClass} mt-0.5"></i>
          <span class="text-sm">${recommendation.message}</span>
        </div>
      </div>
    `;
  }

  let actionButtons = '';
  if (source === 'current_branch' && duplicateInfo) {
    actionButtons += `
      <button onclick="showItemHistory('${duplicateInfo._id}')" 
              class="btn btn-info btn-sm mr-2">
        <i class="bi bi-clock-history mr-1"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      </button>
    `;
  } else if (source === 'cross_branch' && duplicateInfo) {
    actionButtons += `
      <button onclick="showBranchStockDetails('${duplicateInfo.branch_code}')" 
              class="btn btn-warning btn-sm mr-2">
        <i class="bi bi-building mr-1"></i> ‡∏î‡∏π‡∏™‡∏≤‡∏Ç‡∏≤ ${duplicateInfo.branch_code}
      </button>
    `;
  }

  alertModal.innerHTML = `
    <div class="modal-box max-w-lg">
      <div class="flex items-start gap-3">
        <i class="bi bi-exclamation-triangle-fill text-red-500 text-3xl flex-shrink-0 mt-1"></i>
        <div class="flex-1">
          <h3 class="text-lg font-bold mb-3 text-red-600">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤!</h3>
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 mb-4">
            <pre class="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300 font-medium">${message}</pre>
          </div>
          
          ${recommendationHtml}
          
          ${actionButtons ? `
            <div class="mt-4">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</p>
              <div class="flex flex-wrap gap-2">
                ${actionButtons}
              </div>
            </div>
          ` : ''}
        </div>
      </div>
      <div class="modal-action mt-4">
        ${recommendation && recommendation.canProceed ? `
          <button onclick="proceedWithDuplicateApproval('${duplicateInfo._id}')" 
                  class="btn btn-warning mr-2">
            <i class="bi bi-exclamation-triangle mr-1"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÑ‡∏õ
          </button>
        ` : ''}
        <button onclick="this.closest('.inventory-duplicate-alert').remove()"
                class="btn btn-primary">
          <i class="bi bi-check mr-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(alertModal);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
async function showItemHistory(stockId) {
  try {
    const response = await fetch(`/api/branch-stock-history?product_id=${stockId}`, {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
      }
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏™‡∏£‡πâ‡∏≤‡∏á modal ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ existing modal)
      console.log('Item history:', result.data);
      showToast('‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•', 'info');
    } else {
      showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
    }
  } catch (error) {
    console.error('Error loading item history:', error);
    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', 'error');
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
function showBranchStockDetails(branchCode) {
  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á branch ‡∏ô‡∏±‡πâ‡∏ô
  window.open(`inventory_dashboard.html?branch=${branchCode}`, '_blank');
}

// ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥
async function proceedWithDuplicateApproval(stockId) {
  const modal = document.querySelector('.inventory-duplicate-alert');
  if (modal) modal.remove();

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å approvePending ‡πÇ‡∏î‡∏¢‡∏Ç‡πâ‡∏≤‡∏° duplicate check
  await approvePendingWithoutDuplicateCheck(stockId);
}

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥
function setupDuplicateValidationSystem() {
  console.log('üîß Setting up duplicate validation system for inventory');

  // Clear cache ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
  setInterval(() => {
    const now = Date.now();
    for (const [key, value] of duplicateCheckCache.entries()) {
      if (now - value.timestamp > CACHE_DURATION) {
        duplicateCheckCache.delete(key);
      }
    }
  }, 300000); // 5 minutes

  console.log('‚úÖ Duplicate validation system initialized');
}

// ==================== END INVENTORY DUPLICATE VALIDATION SYSTEM ====================

// ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending (pending‚Üífalse & verified=true)
async function approvePending(stockId) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

  console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ stock ID:', stockId);
  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    const token = localStorage.getItem('authToken');
    const stockRes = await fetch(`/api/branch-stock/${stockId}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const stockResult = await stockRes.json();
    
    if (!stockRes.ok || !stockResult.success) {
      throw new Error(stockResult.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
    }
    
    const stockData = stockResult.data;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥
    const duplicateCheck = await validateInventoryItemDuplicate(stockId, stockData);
    if (duplicateCheck.isDuplicate) {
      showInventoryDuplicateAlert(duplicateCheck);
      return;
    }
    
    // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    await approvePendingWithoutDuplicateCheck(stockId);
    
  } catch (err) {
    console.error('Error approving stock:', err);
    showToast('Error: ' + err.message, 'error');
  }
}

// ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÑ‡∏õ)
async function approvePendingWithoutDuplicateCheck(stockId) {
  console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ stock ID (bypass duplicate check):', stockId);
  try {
    const token = localStorage.getItem('authToken');
    const res = await fetch(`/api/branch-stock/${stockId}/approve`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    console.log('Response status:', res.status);
    const result = await res.json();
    console.log('Response data:', result);
    if (!res.ok || !result.success) {
      throw new Error(result.error || result.message || '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
    showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

    // üì° ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Socket ‡πÑ‡∏õ‡∏¢‡∏±‡∏á POS ‡πÅ‡∏•‡∏∞ product.html
    try {
      if (socket && socket.connected && typeof socket.emit === 'function') {
        console.log('üì° Sending socket events for approved stock:', stockId);
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Promise ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const emitPromises = [
          new Promise((resolve) => {
            socket.emit('stockUpdate', null, () => resolve());
          }),
          new Promise((resolve) => {
            socket.emit('stockApproved', {
              stockId,
              branchCode: document.getElementById('branchSelect').value,
              timestamp: new Date().toISOString()
            }, () => resolve());
          }),
          new Promise((resolve) => {
            socket.emit('stockStatusChanged', {
              stockId,
              status: 'approved',
              branchCode: document.getElementById('branchSelect').value,
              timestamp: new Date().toISOString()
            }, () => resolve());
          })
        ];

        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        Promise.all(emitPromises)
          .then(() => {
            console.log('‚úÖ All socket events sent successfully');
          })
          .catch((error) => {
            console.warn('‚ö†Ô∏è Some socket events failed:', error);
          });

      } else {
        if (!socket) {
          console.warn('‚ö†Ô∏è Socket object not initialized');
        } else if (!socket.connected) {
          console.warn('‚ö†Ô∏è Socket not connected - attempting to reconnect');
          initializeSocket(); // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
        } else {
          console.warn('‚ö†Ô∏è Socket emit function not available');
        }
      }
    } catch (error) {
      console.error('‚ùå Error emitting socket events:', error);
    }

    await loadStock();
  } catch (err) {
    console.error('Error approving stock (without duplicate check):', err);
    showToast('Error: ' + err.message, 'error');
  }
}

    // --------------------
    // Group ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡∏≤‡∏° Brand, Name, Category
    // --------------------
    function groupStockByBrand(stocks) {
      const grouped = {};
      stocks.forEach((st) => {
        if (st.verified) return;
        const brand = st.brand || 'Unknown Brand';
        const name = st.name || 'NoName';
        const category = st.category || 'Default';
        if (!grouped[brand]) grouped[brand] = {};
        if (!grouped[brand][name]) grouped[brand][name] = {};
        if (!grouped[brand][name][category]) {
          grouped[brand][name][category] = [];
        }
        grouped[brand][name][category].push(st);
      });
      return grouped;
    }

    // --------------------
    // Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Grouped (UX/UI ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 2)
    // --------------------
    function renderGroupedStocks(groupedData) {
  const container = document.getElementById('groupedStockContainer');
  container.innerHTML = '';
  const brands = Object.keys(groupedData);

  if (!brands.length) {
    container.innerHTML = `<div class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  brands.forEach(brand => {
    // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
    const brandHeader = document.createElement('h3');
    brandHeader.className = 'col-span-full text-lg font-semibold text-gray-700 dark:text-gray-200';
    brandHeader.textContent = `Brand: ${brand}`;
    container.appendChild(brandHeader);

    const products = groupedData[brand];
    Object.keys(products).forEach(prodName => {
      const categories = products[prodName];
      Object.keys(categories).forEach(catKey => {
        const list = categories[catKey];

        list.forEach(stock => {
          const card = document.createElement('details');
          card.className = 'bg-white dark:bg-gray-700 rounded-lg shadow p-4 transition group';

          // ‡∏™‡πà‡∏ß‡∏ô summary (‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î)
          const summary = document.createElement('summary');
          summary.className = 'flex justify-between items-center cursor-pointer';
          // ‡∏î‡∏∂‡∏á stockType ‡∏à‡∏≤‡∏Å product_id (ProductImage) ‡∏´‡∏£‡∏∑‡∏≠ stockType field ‡πÉ‡∏ô BranchStock
          let stockTypeBadge = '';
          let stockType = stock.stockType || 'imei'; // default to imei
    
          // ‡∏ñ‡πâ‡∏≤ product_id populated ‡πÅ‡∏•‡∏∞‡∏°‡∏µ stockType
          if (stock.product_id && stock.product_id.stockType) {
            stockType = stock.product_id.stockType;
          }
    
          stockTypeBadge = stockType === 'imei'
            ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 mt-1"><i class="bi bi-qr-code mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>'
            : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 mt-1"><i class="bi bi-boxes mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>';
    
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quantity ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á IMEI ‡πÄ‡∏•‡∏¢
          const imeiDisplay = (stockType === 'quantity') ? null : (stock.imei || '-');
    
          summary.innerHTML = `
            <div>
              <div class="font-medium text-gray-800 dark:text-gray-100">${stock.name}</div>
              ${imeiDisplay ? `<div class="text-sm text-gray-500 dark:text-gray-400">IMEI: ${imeiDisplay}</div>` : ''}
              ${stockTypeBadge}
            </div>
            <i class="bi bi-chevron-down transition-transform group-open:rotate-180"></i>
          `;
          card.appendChild(summary);

          // ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
          const detailContent = document.createElement('div');
          detailContent.className = 'mt-3 grid grid-cols-1 gap-2 text-sm text-gray-700 dark:text-gray-200';
          console.log('üîç Grouped stock data:', stock.name, 'barcode:', stock.barcode, 'sku:', stock.sku);
          // Debug log for supplier data
          console.log('Stock supplier data:', {
            stockId: stock._id,
            supplier: stock.supplier,
            supplierName: stock.supplier?.name,
            rawSupplier: stock.supplier
          });

          // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ supplier ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          let supplierName = '‚Äì';
          if (stock.supplier) {
            if (typeof stock.supplier === 'object' && stock.supplier.name) {
              supplierName = stock.supplier.name;
            } else if (typeof stock.supplier === 'string') {
              supplierName = stock.supplier;
            }
          }

          detailContent.innerHTML = `
            <div><strong>Supplier:</strong> ${supplierName}</div>
            <div><strong>Barcode:</strong> ${stock.barcode || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
            <div><strong>SKU:</strong> ${stock.sku || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
            <div><strong>Brand:</strong> ${stock.brand || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
            <div><strong>Category:</strong> ${catKey}</div>
            <div><strong>Stock:</strong> ${stock.stock_value || 0}</div>
            <div class="flex items-center space-x-2 mt-2">
              ${
                stock.verified
                  ? `<span class="badge badge-success flex items-center gap-1">
                       <i class="bi bi-check-circle-fill"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß
                     </span>`
                  : `<button 
                       class="btn-verify-stock btn btn-sm btn-outline btn-primary flex items-center" 
                       data-stock-id="${stock._id}"
                     >
                       <i class="bi bi-check-lg mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                     </button>`
              }
              <button 
                class="btn-open-edit-modal btn btn-sm btn-outline btn-warning flex items-center" 
                data-stock-id="${stock._id}"
              >
                <i class="bi bi-pencil"></i>
              </button>
              <button 
                class="btn-delete-stock btn btn-sm btn-outline btn-error flex items-center" 
                data-stock-id="${stock._id}"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          `;
          card.appendChild(detailContent);

          container.appendChild(card);

         // Accordion: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
         card.addEventListener('toggle', function() {
           if (!this.open) return;
           document
             .querySelectorAll('#groupedStockContainer details')
             .forEach(d => { if (d !== this) d.open = false; });
         });
        });

      });
    });
  });
}


function getOpenStockIds() {
  return Array.from(
    document.querySelectorAll('#groupedStockContainer details[open]')
  )
  .map(detail => {
    const btn = detail.querySelector('[data-stock-id]');
    return btn?.dataset.stockId;
  })
  .filter(id => id);
}

    // --------------------
    // Inline edit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ quantity)
    // --------------------
    function enableCellEdit(e) {
      const cell = e.currentTarget;
      const originalText = cell.textContent.trim();
      const row = cell.closest('tr');
      const stockId = row.dataset.stockId;
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quantity ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (originalText === '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ') {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÑ‡∏î‡πâ', 'warning');
        return;
      }
    
      if (cell.querySelector('input')) return;
      if (!originalValues[stockId]) {
        originalValues[stockId] = { imei: originalText === '-' ? '' : originalText };
      }
      cell.innerHTML = '';
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalValues[stockId].imei;
      input.className = 'p-1 border rounded w-24';
      cell.appendChild(input);
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'px-2 py-1 border rounded text-green-600 hover:bg-green-50 transition text-xs ml-1 inline-edit-confirm';
      confirmBtn.innerHTML = '<i class="bi bi-check"></i>';
      cell.appendChild(confirmBtn);
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'px-2 py-1 border rounded text-gray-600 hover:bg-gray-50 transition text-xs ml-1 inline-edit-cancel';
      cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
      cell.appendChild(cancelBtn);
      row.classList.add('editing');
      input.focus();
    }
    function cancelInlineEdit(cell) {
      const row = cell.closest('tr');
      const stockId = row.dataset.stockId;
      const oldVal = (originalValues[stockId] || {}).imei || '';
      cell.textContent = oldVal || '-';
      row.classList.remove('editing');
      delete originalValues[stockId];
    }
    async function saveInlineEdit(cell, newVal) {
      const row = cell.closest('tr');
      const stockId = row.dataset.stockId;
      const oldVal = (originalValues[stockId] || {}).imei || '';
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch(`/api/branch-stock/${stockId}`, {
          method: 'PATCH',
          headers: {
            Authorization: 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ imei: newVal })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        cell.textContent = newVal || '-';
        row.classList.remove('editing');
        delete originalValues[stockId];
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
        cell.textContent = oldVal || '-';
        row.classList.remove('editing');
      }
    }

    // Socket event listeners for real-time updates
    try {
      if (socket && typeof socket.on === 'function') {
        socket.on('stockUpdate', () => {
          console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì update ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö realtime');
          loadStock();
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
        socket.on('stockSentForApproval', (data) => {
          console.log('üì® ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô:', data);
          showToast(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${data.stockIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å ${data.sentByName} ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`, 'info');
          loadStock(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        });
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Error setting up real-time socket listeners:', error);
    }

    // --------------------
    // Verify ‡∏™‡∏ï‡πä‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏á BranchStockHistory
    // --------------------
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô verifyStock ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Frontend
async function verifyStock(stockId) {
  // ‡∏´‡∏≤ button ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  const btn = document.querySelector(`.btn-verify-stock[data-stock-id="${stockId}"]`);
  if (!btn || btn.disabled) return;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
  btn.disabled = true;
  btn.innerHTML = `<i class="bi bi-hourglass-split mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à...`;

  try {
    const token = localStorage.getItem('authToken') || '';
    const stock = allStocks.find(s => s._id === stockId);
    
    if (!stock) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å');
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ - ‡∏î‡∏∂‡∏á userId
    const userId = await getCurrentUserId();
    const costValue = stock.cost || 0;

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API patch ‡∏Ñ‡πà‡∏≤ verified ‡∏û‡∏£‡πâ‡∏≠‡∏° verified_by
    const res = await fetch(`/api/branch-stock/${stockId}`, {
      method: 'PATCH',
      headers: {
        Authorization: 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        verified: true,
        cost: costValue,
        verified_by: userId   // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      })
    });

    const data = await res.json();
    if (!res.ok || !data.success) {
      throw new Error(data.error || 'Verify stock failed');
    }

    const updatedStock = data.data;

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ badge "‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß"
    const badge = document.createElement('span');
    badge.className = 'badge badge-success flex items-center gap-1';
    badge.innerHTML = `<i class="bi bi-check-circle-fill"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß`;
    btn.replaceWith(badge);

    showToast('Verify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + stockId, 'success');

    // üì° ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì Socket ‡πÑ‡∏õ‡∏¢‡∏±‡∏á POS (‡∏™‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á emit ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
    try {
      if (socket && typeof socket.emit === 'function') {
        console.log('üì° Sending socket events for verified stock:', stockId);
        socket.emit('stockVerified', { stockId, stockData: updatedStock });
        console.log('‚úÖ Socket event sent: stockVerified');
      } else {
        console.warn('‚ö†Ô∏è Socket not available - cannot emit stockVerified event');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Error emitting socket event:', error);
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ BranchStockHistory ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (updatedStock) {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• stock ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
      const stockRes = await fetch(`/api/branch-stock/${stockId}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      const stockJson = await stockRes.json();
      const fullStock = stockJson.data;

      // ‡πÉ‡∏ä‡πâ supplier ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      const supplierId = fullStock.supplier?._id || fullStock.supplier;
      if (!supplierId) console.warn('Warning: No supplier ID for stock', stockId);

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload
      const historyPayload = {
        branch_code:   fullStock.branch_code,
        change_type:   'IN',
        supplier:      supplierId,                       // ‚Üê ‡∏™‡πà‡∏á ObjectId
        invoiceNumber: fullStock.invoiceNumber || '',
        items: [{
          product_id:     fullStock._id,
          poNumber:       fullStock.poNumber   || '',
          name:           fullStock.name       || 'NoName',
          brand:          fullStock.brand      || '',
          model:          fullStock.model      || '',
          sku:            fullStock.sku        || '',
          barcode:        fullStock.barcode    || '',
          imei:           fullStock.imei       || '',
          price:          fullStock.price      || 0,
          cost:           fullStock.cost       || 0,
          qty:            1,
          remainQty:      1,
          documentNumber: fullStock.documentNumber || '',
          unit:           fullStock.unit       || '‡∏ä‡∏¥‡πâ‡∏ô'
        }],
        reason:        '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (Verified)',
        performed_by:  userId,
        quantity:      1,
        stock_value:   1,
        categoryGroup: fullStock.categoryGroup?._id || fullStock.categoryGroup,
        taxType:       fullStock.taxType     || '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ'
    };

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      const createHistoryRes = await fetch('/api/branch-stock-history', {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(historyPayload)
      });

      if (!createHistoryRes.ok) {
        const errorText = await createHistoryRes.text();
        console.error('‡∏™‡∏£‡πâ‡∏≤‡∏á branch-stock-history ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', errorText);
        showToast('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'warning');
      } else {
        const createHistoryData = await createHistoryRes.json();
        if (!createHistoryData.success) {
          console.error('‡∏™‡∏£‡πâ‡∏≤‡∏á branch-stock-history ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', createHistoryData.error);
          showToast('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'warning');
        } else {
          console.log('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ IN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:', createHistoryData.data);
          showToast('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
      }
    }

    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å
    loadStock();

  } catch (err) {
    showToast('Error verifyStock: ' + err.message, 'error');
    
    // ‡∏ñ‡πâ‡∏≤ error ‡∏Å‡πá‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-check-lg mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`;
    }
  }
}

    async function openEditModal(stockId) {
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch(`/api/branch-stock/${stockId}`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å');
        }
    
        const stock = data.data;
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('editPoId').value = stock.poId || '';
        document.getElementById('editItemIndex').value = stock.itemIndex || '';
        document.getElementById('editProductId').value = stock.productId || '';
        document.getElementById('editBarcode').value = stock.barcode || '';
        document.getElementById('editSku').value = stock.sku || '';
        document.getElementById('editName').value = stock.name || '';
        document.getElementById('editInvoiceNumber').value = stock.invoiceNumber || '';
        document.getElementById('editBrand').value = stock.brand || '';
    
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ IMEI field ‡∏ï‡∏≤‡∏° stockType
        const imeiContainer = document.getElementById('editImeiContainer');
        const imeiInput = document.getElementById('editImei');
    
        // Reset modal state
        imeiContainer.style.display = 'block';
        const oldHelpText = imeiContainer.querySelector('.help-text');
        if (oldHelpText) {
          oldHelpText.remove();
        }
    
        // ‡∏î‡∏∂‡∏á stockType ‡∏à‡∏≤‡∏Å product_id (ProductImage) ‡∏´‡∏£‡∏∑‡∏≠ stockType field ‡πÉ‡∏ô BranchStock
        let stockType = stock.stockType || 'imei'; // default to imei
    
        // ‡∏ñ‡πâ‡∏≤ product_id populated ‡πÅ‡∏•‡∏∞‡∏°‡∏µ stockType
        if (stock.product_id && stock.product_id.stockType) {
          stockType = stock.product_id.stockType;
        }
    
        if (stockType === 'quantity') {
          imeiContainer.style.display = 'none';
          imeiInput.value = '';
          imeiInput.removeAttribute('required');
        } else {
          imeiContainer.style.display = 'block';
          imeiInput.value = stock.imei || '';
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏ä‡πà‡∏≠‡∏á IMEI
          let helpText = imeiContainer.querySelector('.help-text');
          if (!helpText) {
            helpText = document.createElement('p');
            helpText.className = 'help-text text-sm text-gray-500 dark:text-gray-400 mt-1';
            helpText.innerHTML = '<i class="bi bi-info-circle mr-1"></i>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
            imeiContainer.appendChild(helpText);
          }
        }
    
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï modal title
        const modalTitle = document.querySelector('#editItemModal h3');
        if (modalTitle) {
          const stockTypeBadge = stockType === 'imei'
            ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 mt-2"><i class="bi bi-qr-code mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>'
            : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 mt-2"><i class="bi bi-boxes mr-1"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç IMEI</span>';
    
          modalTitle.innerHTML = `
            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <div>${stockTypeBadge}</div>
          `;
        }
    
        toggleModal('editItemModal', true);
    
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteStock(stockId) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ô‡∏µ‡πâ?')) return;
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch(`/api/branch-stock/${stockId}`, {
          method: 'DELETE',
          headers: {
            Authorization: 'Bearer ' + token
          }
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        showToast('‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        loadStock();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    // --------------------
    // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Item (PO)
    // --------------------
    function openEditItemModal(poId, itemIndex) {
      const po = allPO.find((p) => p._id === poId);
      if (!po) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö PO ‡∏ô‡∏µ‡πâ');
        return;
      }
      const item = po.items[itemIndex];
      if (!item) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö item index = ' + itemIndex);
        return;
      }
      document.getElementById('editPoId').value = poId;
      document.getElementById('editItemIndex').value = itemIndex;
      let productIdValue = item.productId;
      if (typeof productIdValue === 'object' && productIdValue !== null && productIdValue._id) {
        productIdValue = productIdValue._id;
      }
      document.getElementById('editProductId').value = productIdValue || '';
      document.getElementById('editBarcode').value = item.barcode || '';
      document.getElementById('editSku').value = item.sku || '';  // ‡πÅ‡∏™‡∏î‡∏á SKU (Auto Generated)
      document.getElementById('editImei').value = item.imei || '';
      document.getElementById('editName').value = item.name || '';
      document.getElementById('editInvoiceNumber').value = item.invoiceNumber || '';
      document.getElementById('editBrand').value = item.brand || '';
      toggleModal('editItemModal', true);
    }

    async function onEditItemSubmit(e) {
      e.preventDefault();
      const token = localStorage.getItem('authToken') || '';
      const poId = document.getElementById('editPoId').value;
      const itemIndex = parseInt(document.getElementById('editItemIndex').value, 10);
      const productId = document.getElementById('editProductId').value.trim();
      const barcode = document.getElementById('editBarcode').value.trim();
      // SKU ‡πÄ‡∏õ‡πá‡∏ô read-only (Auto Generated) ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ SKU ‡∏à‡∏≤‡∏Å backend response ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
      const sku = document.getElementById('editSku').value.trim();
      const imei = document.getElementById('editImei').value.trim();
      const name = document.getElementById('editName').value.trim();
      const invoiceNumber = document.getElementById('editInvoiceNumber').value.trim();
      const brand = document.getElementById('editBrand').value.trim();
      const po = allPO.find((p) => p._id === poId);
      if (!po) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö PO ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô allPO');
        return;
      }
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ IMEI ‡∏ã‡πâ‡∏≥ (SKU ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
      for (let i = 0; i < po.items.length; i++) {
        if (i === itemIndex) continue;
        const other = po.items[i];
        if (imei && other.imei === imei) {
          alert('IMEI ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô PO ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!');
          return;
        }
      }
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stockType ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á IMEI
      let finalImei = imei;
      const imeiContainer = document.getElementById('editImeiContainer');
      if (imeiContainer.style.display === 'none') {
        finalImei = ''; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quantity
      }
    
      try {
        const formData = new FormData();
        formData.append('productId', productId);
        formData.append('barcode', barcode);
        // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á SKU, Price, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞ Upload ‡∏£‡∏π‡∏õ
        formData.append('imei', finalImei);
        formData.append('name', name);
        formData.append('invoiceNumber', invoiceNumber);
        formData.append('brand', brand);
        const res = await fetch(`/api/purchase-order/${poId}/items/${itemIndex}`, {
          method: 'PATCH',
          headers: { Authorization: 'Bearer ' + token },
          body: formData,
        });
        const contentType = res.headers.get('content-type') || '';
        let data;
        if (contentType.includes('application/json')) {
          data = await res.json();
        } else {
          const errorText = await res.text();
          throw new Error(errorText || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç item ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON)');
        }
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç item ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        // ‡∏´‡∏≤‡∏Å backend ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ SKU ‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ update ‡∏Ñ‡πà‡∏≤ SKU ‡πÉ‡∏ô modal
        if (data.data && data.data.sku) {
          document.getElementById('editSku').value = data.data.sku;
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç item ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        toggleModal('editItemModal', false);
        const branchCode = document.getElementById('selectBranch').value;
        loadPurchaseOrders(branchCode);
      } catch (err) {
        alert('Error update item: ' + err.message);
      }
    }

    // --------------------
    // Toggle Sidebar + shift mainContent
    // --------------------
    function toggleMenu() {
      const sb   = document.getElementById('sidebar');
      const mc   = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
      const overlay = document.getElementById('menuOverlay');

      sb.classList.toggle('-translate-x-full');
      sb.classList.toggle('translate-x-0');
      if (window.innerWidth >= 768) {
        mc.classList.toggle('ml-64');
        mc.classList.toggle('ml-0');
      }
      if (window.innerWidth < 768) {
        overlay.classList.toggle('active');
      }
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }
    document.getElementById('menuOverlay')
      .addEventListener('click', () => { if (window.innerWidth < 768) toggleMenu(); });

    // Global Lottie animation variable
    let lottieAnimation = null;

    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => response.json())
            .then(animationData => {
              console.log('‚úÖ Lottie animation data loaded successfully');
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: false,
                animationData: animationData
              });
            })
            .catch(error => {
              console.warn('Failed to load Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        }
        if (lottieAnimation) lottieAnimation.play();
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }

    // Make showLoading globally accessible
    window.showLoading = showLoading;

    // --------------------
    // DOMContentLoaded
    // --------------------
    document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);
      loadDarkModeSetting();
      document.getElementById('btnToggleDark').addEventListener('click', toggleDarkMode);
      document.getElementById('btnLogout').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      });
      document.getElementById('btnToggleMenu').addEventListener('click', toggleMenu);
      document.getElementById('branchSelect').addEventListener('change', loadStock);

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥
      setupDuplicateValidationSystem();

      await loadEmployeeProfile();
      await loadBranches();
      loadStock();

      // Socket listeners with error handling
      try {
        if (socket && typeof socket.on === 'function') {
          socket.on('stockUpdate', () => {
            console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì stockUpdate');
            loadStock();
          });
          socket.on('stockApproved', data => {
            console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì stockApproved:', data);
            loadStock();
          });
          socket.on('stockRejected', data => {
            console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì stockRejected:', data);
            loadStock();
          });
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö product.html
          socket.on('stockStatusChanged', data => {
            console.log('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì stockStatusChanged:', data);
            loadStock();
          });
    
          socket.on('connect_error', error => {
            console.error('Socket connection error:', error);
          });
          socket.on('disconnect', reason => {
            console.log('Socket disconnected:', reason);
          });
          console.log('‚úÖ Socket event listeners initialized successfully');
        } else {
          console.warn('‚ö†Ô∏è Socket.io not available - real-time updates disabled');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Error setting up socket listeners:', error);
      }

      // Sidebar link highlighting
      const sidebarLinks = document.querySelectorAll('aside a');
      function highlightSidebar(link) {
        sidebarLinks.forEach(l => {
          l.style.backgroundColor = '';
          l.style.color = '';
          const ico = l.querySelector('i');
          if (ico) ico.style.color = '';
        });
        const icon = link.querySelector('i');
        if (icon) {
          const c = getComputedStyle(icon).color;
          link.style.backgroundColor = c;
          link.style.color = '#fff';
          icon.style.color = '#fff';
        }
      }
      sidebarLinks.forEach(link => {
        link.addEventListener('click', () => highlightSidebar(link));
      });
      // initial highlight based on href
      const page = window.location.pathname.split('/').pop();
      sidebarLinks.forEach(link => {
        if (link.getAttribute('href') === page) highlightSidebar(link);
      });

      // Complete initial loading
      setTimeout(() => { showLoading(false); }, 1000);
    });

    // --------------------
    // Event Delegation
    // --------------------
    document.addEventListener('click', (e) => {
      const verifyBtn = e.target.closest('.btn-verify-stock');
      if (verifyBtn) {
        const id = verifyBtn.dataset.stockId;
        verifyStock(id);
        return;
      }
      const editBtn = e.target.closest('.btn-open-edit-modal');
      if (editBtn) {
        const id = editBtn.dataset.stockId;
        openEditModal(id);
        return;
      }
      const delBtn = e.target.closest('.btn-delete-stock');
      if (delBtn) {
        const id = delBtn.dataset.stockId;
        deleteStock(id);
        return;
      }
      const confirmInline = e.target.closest('.inline-edit-confirm');
      if (confirmInline) {
        const cell = confirmInline.closest('.editable-cell');
        if (!cell) return;
        const input = cell.querySelector('input');
        if (!input) return;
        const newVal = input.value.trim();
        saveInlineEdit(cell, newVal);
        return;
      }
      const cancelInline = e.target.closest('.inline-edit-cancel');
      if (cancelInline) {
        const cell = cancelInline.closest('.editable-cell');
        if (!cell) return;
        cancelInlineEdit(cell);
        return;
      }
    });

    // --------------------
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ format ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    // --------------------
    function formatNumber(num) {
      return num.toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å)
    async function rejectPending(stockId) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

      console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò stock ID:', stockId);
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch(`/api/branch-stock/${stockId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        console.log('Response status:', res.status);
        const result = await res.json();
        console.log('Response data:', result);
        if (!res.ok || !result.success) {
          throw new Error(result.error || result.message || '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

        try {
          if (socket && typeof socket.emit === 'function') {
            socket.emit('stockUpdate');
            socket.emit('stockRejected', {
    
              stockId,
              branchCode: document.getElementById('branchSelect').value,
              timestamp: new Date().toISOString()
            });
    
            // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏û‡∏¥‡πÄ ‡∏©‡πÉ‡∏´‡πâ product.html   -
    
            socket.emit('stockStatusChanged', {
              stockId,
              status: 'rejected',
              branchCode: document.getElementById('branchSelect').value,
              timestamp: new Date().toISOString()
            });
    
            console.log('‚úÖ Socket events sent: stockUpdate, stockRejected, stockStatusChanged');
          } else {
            console.warn('‚ö†Ô∏è Socket not available - cannot emit rejection events');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Error emitting socket events:', error);
        }

        await loadStock();
      } catch (err) {
        console.error('Error rejecting stock:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        setTimeout(() => { showLoading(false); }, 600);
      }
    }

    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>
</body>
</html>
