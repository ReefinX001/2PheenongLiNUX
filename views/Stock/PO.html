<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Stock Management - ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ï‡πä‡∏≠‡∏Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="../js/activity-tracker.js"></script>
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt','sans-serif'] }
        }
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>

  <!-- DaisyUI -->
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
    rel="stylesheet"
    type="text/css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    html {
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Prompt', sans-serif;
    }
    /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fadeIn */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sidebar ‡∏ó‡∏µ‡πà‡∏¢‡∏∏‡∏ö */
    aside.collapsed {
      width: 5rem;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Sidebar ‡∏¢‡∏∏‡∏ö */
    aside.collapsed .ml-3 {
      display: none;
    }
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .document-number-input {
      transition: all 0.2s ease;
    }
    
    .document-number-input:focus {
      background-color: #f0f9ff !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1) !important;
    }
    
    .dark .document-number-input:focus {
      background-color: #1e293b !important;
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1) !important;
    }
    
    .document-number-input:hover {
      border-color: #9ca3af;
    }
    
    .dark .document-number-input:hover {
      border-color: #6b7280;
    }
    
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ */
    .document-number-input:not(:placeholder-shown) {
      padding-right: 2.5rem;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'%3e%3c/path%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem 1rem;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen bg-white text-gray-700 dark:bg-gray-800 dark:text-gray-200">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- ‡∏õ‡∏∏‡πà‡∏° Toggle Menu ‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ (Floating) -->
  <button id="btnToggleMenu" title="Toggle Menu" aria-label="Toggle Menu"
          class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="flex">
    <!-- Sidebar -->
<div class="flex w-full">
    <!-- Sidebar -->
    <aside id="sidebar"
       class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
              transform transition-transform duration-300 translate-x-0 z-20">
      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Logo/Title) -->
      <a href="StockManagehome" class="p-4 border-b border-gray-200 dark:border-gray-700">
        <img src="/uploads/Logo2.png"
             alt="Logo"
             class="Logo animate-float shadow-soft w-full h-full object-cover" />
      </a>
      <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å (Vertical Menu) -->
      <div class="flex-1 p-4 overflow-hidden">
        <ul class="flex flex-col w-full space-y-1">

      <li class="my-px">
                  <a href="branch_stock_overview"
                    class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                      <i class="bi bi-grid text-xl"></i>
                    </span>
                    <span class="ml-3">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                  </a>
                </li>

          <!-- ‡πÄ‡∏°‡∏ô‡∏π: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
          <li class="my-px">
            <a href="inventory_dashboard"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                <i class="bi bi-clipboard-check text-xl"></i>
              </span>
              <span class="ml-3">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
            </a>
          </li>

          <!-- ‡πÄ‡∏°‡∏ô‡∏π:PO -->
          <li class="my-px">
            <a href="PO"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                <i class="bi bi-file-earmark-text text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
            </a>
          </li>
          <!-- ‡πÄ‡∏°‡∏ô‡∏π: Quotation -->
          <li class="my-px">
            <a href="quotation_Stock"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                <i class="bi bi-file-earmark-richtext text-xl"></i>
              </span>
              <span class="ml-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
            </a>
          </li>
          <!-- ‡πÄ‡∏°‡∏ô‡∏π: Transfer -->
          <li class="my-px">
            <a href="Transfer"
                    class="flex flex-row items-center h-12 px-4 rounded-lg
            text-gray-600 dark:text-gray-200 
            hover:bg-gray-100 dark:hover:bg-gray-700 transition-all sidebar-link">
              <span class="flex items-center justify-center text-lg text-primary-500 dark:text-primary-400">
                <i class="bi bi-truck text-xl"></i>
              </span>
              <span class="ml-3">‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>
          <li class="my-px">
            <a href="product_Image"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-yellow-500 dark:text-yellow-400">
                <i class="bi bi-upc-scan text-xl"></i>
              </span>
              <span class="ml-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>

          <!-- ‡πÄ‡∏°‡∏ô‡∏π: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
          <li class="my-px">
            <a href="StockAdditional"
               class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-indigo-500 dark:text-indigo-400">
                <i class="bi bi-three-dots text-xl"></i>
              </span>
              <span class="ml-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
            </a>
          </li>


          <li class="my-px mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
            <!-- Dark Mode Toggle -->
            <button id="btnToggleDark"
                    class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-left transition-all">
              <span class="flex items-center justify-center text-lg text-indigo-600 dark:text-indigo-300">
                <i class="bi bi-moon-stars text-xl"></i>
              </span>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          <!-- Logout -->
          <li class="my-px">
            <button id="btnLogout"
                    class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-left transition-all">
              <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                <i class="bi bi-box-arrow-right text-xl"></i>
              </span>
              <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </li>
          <!-- Profile (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å API) -->
          <li class="my-px mt-2">
            <div id="profile"
                 class="flex flex-row items-center h-16 px-4 w-full rounded-lg bg-gray-50 text-gray-700 dark:bg-gray-800/50 dark:text-gray-200 text-left transition-colors">
              <div class="avatar mr-3">
                <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                  <img id="employeePhoto" src="" alt="Employee Photo" class="w-full h-full object-cover" />
                </div>
              </div>
              <div class="flex flex-col">
                <span class="text-sm font-medium" id="employeeName">Loading...</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </aside>

     <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Main Content) -->
    <div id="mainContent"
      class="flex-1 ml-56 p-6 pb-20 space-y-6 transition-all duration-300 ease-in-out">  <!-- ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏° pb-20 -->
  <!-- Header -->
  <header class="p-6 bg-white dark:bg-gray-800  rounded-lg flex items-center justify-between transition-colors">
    <h1 id="pageTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100">
      <i class="bi bi-gear-fill text-blue-500 mr-2"></i>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    </h1>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡πà‡∏ß‡∏° (Dropdown Menu) -->
    <div class="relative">
      <button id="dropdownMenuButton" 
              class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition flex items-center">
        <i class="bi bi-gear mr-2"></i>
        ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
        <i class="bi bi-chevron-down ml-2"></i>
      </button>
      
      <!-- Dropdown Menu -->
      <div id="dropdownMenu" 
           class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 hidden">
        <div class="py-2">
          <a href="/po-creation" 
             class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="bi bi-lightning-charge text-orange-500 mr-3"></i>
            <div>
              <div class="font-medium">‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô</div>
            </div>
          </a>
          
          <hr class="my-2 border-gray-200 dark:border-gray-600">
          
          <a href="register_supplier" 
             class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="bi bi-person-plus text-green-500 mr-3"></i>
            <div>
              <div class="font-medium">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ã‡∏±‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡∏±‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà</div>
            </div>
          </a>
          
          <hr class="my-2 border-gray-200 dark:border-gray-600">
          
          <a href="PO_Report" 
             class="flex items-center px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="bi bi-graph-up text-blue-500 mr-3"></i>
            <div>
              <div class="font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PO</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </header>



         
                <div class="bg-white dark:bg-gray-800  rounded-xl p-6 mb-8">
                  <h6 class="flex items-center text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">
                    <svg class="w-5 h-5 mr-2 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 3h18v2H3V3zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z" />
                    </svg>
                    <span id="createPOFormTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                  </h6>
                  <form id="createPOForm" class="space-y-6">
              
                   <!-- Row 1: PO Number / Document Number / Date / Branch -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <div>
                    <label for="poNumber" class="block text-sm font-medium text-gray-600 dark:text-gray-300">
                      ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO Number)
                    </label>
                    <input
                      type="text"
                      id="poNumber"
                      disabled
                      placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Generate ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
                      class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                  </div>
                  <div>
                    <!-- <label for="documentNumber" class="block text-sm font-medium text-gray-600 dark:text-gray-300">
                      ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ <span class="text-xs text-gray-500">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                    </label>
                    <input
                      type="text"
                      id="documentNumber"
                      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
                      class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                  </div>
                  <div> -->
                    <label for="docDate" class="block text-sm font-medium text-gray-600 dark:text-gray-300">
                      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                    </label>
                    <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô type ‡πÄ‡∏õ‡πá‡∏ô text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Flatpickr ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ -->
                    <input
                      type="text"
                      id="docDate"
                      class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                      placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..."
                    />
                  </div>
                  <div>
                    <label for="selectBranchForPO" class="block text-sm font-medium text-gray-600 dark:text-gray-300">
                      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
                    </label>
                    <select
                      id="selectBranchForPO"
                      required
                      class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    >
                      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                    </select>
                  </div>
                </div>
              
                    <!-- Row 2: Supplier / Category Group -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div>
                        <label for="selectSupplierForPO" class="block text-sm font-medium text-gray-600 dark:text-gray-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</label>
                        <select id="selectSupplierForPO" required class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå --</option>
                        </select>
                      </div>
                      <div>
                        <label for="categoryGroup" class="block text-sm font-medium text-gray-600 dark:text-gray-300">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="categoryGroup" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                        </select>
                      </div>
                    </div>
              
                    <!-- Row 3: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
                    <div>
                      <label for="orderNotes" class="block text-sm font-medium text-gray-600 dark:text-gray-300">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                      <input type="text" id="orderNotes" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="mt-2 block w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-100 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
                    <div>
                      <h6 class="flex items-center text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">
                        <svg class="w-5 h-5 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4z" />
                          <path d="M3 18v-2c0-2 4-3 9-3s9 1 9 3v2H3z" />
                        </svg>
                        <span id="poItemsTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                      </h6>
                      <button type="button" id="btnAddItem" class="inline-flex items-center px-4 py-2 mb-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                      </button>
                      <div class="overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                          <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                              <th class="px-4 py-2">Brand</th>
                              <th class="px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Name)</th>
                              <th class="px-4 py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</th>
                              <th class="px-4 py-2">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                              <th class="px-4 py-2">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                              <th class="px-4 py-2">‡∏†‡∏≤‡∏©‡∏µ (%)</th>
                              <th class="px-4 py-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ</th>
                              <th class="px-4 py-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ</th>
                              <th class="px-4 py-2">‡∏†‡∏≤‡∏©‡∏µ (‡∏ö‡∏≤‡∏ó)</th>     <!-- ‡πÉ‡∏´‡∏°‡πà -->
                              <th class="px-4 py-2">‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ (‡∏ö‡∏≤‡∏ó)</th> <!-- ‡πÉ‡∏´‡∏°‡πà -->
                              <th class="px-4 py-2">‡∏•‡∏ö</th>
                            </tr>
                          </thead>
                          <tbody id="poItemsTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                          </tbody>
                        </table>
                      </div>
                      
                      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                      <div id="poSummary" class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border">
                        <h6 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">
                          <i class="bi bi-calculator text-green-500 mr-2"></i>
                          ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                        </h6>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                            <div class="text-sm text-gray-600 dark:text-gray-400">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°</div>
                            <div class="text-lg font-medium text-blue-600 dark:text-blue-400" id="summarySubtotal">0.00</div>
                          </div>
                          <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                            <div class="text-sm text-gray-600 dark:text-gray-400">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°</div>
                            <div class="text-lg font-medium text-orange-600 dark:text-orange-400" id="summaryDiscount">0.00</div>
                          </div>
                          <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                            <div class="text-sm text-gray-600 dark:text-gray-400">‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°</div>
                            <div class="text-lg font-medium text-purple-600 dark:text-purple-400" id="summaryTax">0.00</div>
                          </div>
                          <div class="bg-white dark:bg-gray-800 p-3 rounded border border-green-200 dark:border-green-600">
                            <div class="text-sm text-gray-600 dark:text-gray-400">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                            <div class="text-xl font-bold text-green-600 dark:text-green-400" id="summaryTotal">0.00</div>
                          </div>
                        </div>
                      </div>
                    </div>
              
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á PO -->
                    <div class="text-right">
                      <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition">
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                      </button>
                    </div>
                  </form>
                </div>
              
                <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PO ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h6 class="flex items-center text-xl font-semibold text-gray-700 dark:text-gray-200">
                      <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 3h18v2H3V3zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                      </svg>
                      <span id="poListTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </h6>
                    <!-- ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß -->
                  </div>
                  <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-50 dark:bg-gray-900 rounded-lg overflow-hidden">
                      <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                          <th class="px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</th>
                          <th class="px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                          <th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                          <th class="px-4 py-2">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                          <th class="px-4 py-2">‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</th>
                          <th class="px-4 py-2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                          <th class="px-4 py-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                          <th class="px-4 py-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                          <th class="px-4 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                          <th class="px-4 py-2">‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                          <th class="px-4 py-2">‡∏•‡∏ö</th>
                          <th class="px-4 py-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</th>
                        </tr>
                      </thead>
                      <tbody id="poTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PO ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <!-- Pagination Controls -->
                  <div class="flex items-center justify-between mt-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      ‡πÅ‡∏™‡∏î‡∏á <span id="startIndex">0</span> ‡∏ñ‡∏∂‡∏á <span id="endIndex">0</span> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalPO">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="flex space-x-2">
                      <button id="btnPrevPage"
                              class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <i class="bi bi-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                      </button>
                      <div id="pageNumbers" class="flex space-x-1">
                        <!-- Page numbers will be generated here -->
                      </div>
                      <button id="btnNextPage"
                              class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="bi bi-chevron-right"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </section>
              

    <!-- Footer ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô relative -->
    <!-- Footer (relative ‡πÅ‡∏ó‡∏ô fixed) -->
    <footer
      id="footer"
      class="bg-white dark:bg-gray-800 text-center py-4 mt-8 relative">                  <!-- ‚Üê fixed‚Üírelative & ‡∏•‡∏ö left-64/width -->
      <div class="container mx-auto">
        <small>¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.</small>
      </div>
    </footer>

<!-- New Alert Modal -->
<input type="checkbox" id="alertModal" class="modal-toggle" />
<div class="modal">
  <div
    class="modal-box 
           bg-white dark:bg-gray-800 
           text-gray-900 dark:text-gray-100 
           border border-gray-200 dark:border-gray-700"
  >
    <h3 class="font-bold text-lg">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
    <p class="py-4" id="alertMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
    <div class="modal-action">
      <label
        for="alertModal"
        class="btn btn-primary
               bg-blue-600 dark:bg-orange-500
               text-white
               hover:bg-blue-700 dark:hover:bg-orange-600"
        id="okAlertBtn"
      >
        ‡∏ï‡∏Å‡∏•‡∏á
      </label>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<input type="checkbox" id="confirmActionModal" class="modal-toggle" />
<div class="modal">
  <div
    class="modal-box 
           bg-white dark:bg-gray-800 
           text-gray-900 dark:text-gray-100 
           border border-gray-200 dark:border-gray-700"
  >
    <h3 class="font-bold text-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
    <p class="py-4" id="confirmActionText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
    <div class="modal-action">
      <label
        for="confirmActionModal"
        class="btn btn-secondary
               bg-gray-200 dark:bg-gray-700
               text-gray-800 dark:text-gray-200
               hover:bg-gray-300 dark:hover:bg-gray-600"
        id="cancelActionBtn"
      >
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </label>
      <label
        for="confirmActionModal"
        class="btn btn-primary
               bg-blue-600 dark:bg-orange-500
               text-white
               hover:bg-blue-700 dark:hover:bg-orange-600"
        id="okActionBtn"
      >
        ‡∏ï‡∏Å‡∏•‡∏á
      </label>
    </div>
  </div>
</div>

<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
<script>
  // Show/Hide Loading with Lottie animation
  let lottieAnimation = null;
  function showLoading(show) {
    const loader = document.getElementById('loadingOverlay');
    if (show) {
      loader.style.display = 'flex';
      loader.classList.remove('animate__fadeOut');
      loader.classList.add('animate__fadeIn');

      // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
      if (!lottieAnimation) {
        console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
        fetch('/Loading/Loading.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(animationData => {
            lottieAnimation = lottie.loadAnimation({
              container: document.getElementById('lottieContainer'),
              renderer: 'svg',
              loop: true,
              autoplay: true,
              animationData: animationData
            });

            console.log('‚úÖ Lottie animation loaded successfully');
          })
          .catch(error => {
            console.error('‚ùå Error loading Lottie animation:', error);
            // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
          });
      } else {
        lottieAnimation.play();
      }
    } else {
      if (lottieAnimation) {
        lottieAnimation.pause();
      }
      loader.classList.remove('animate__fadeIn');
      loader.classList.add('animate__fadeOut');
      setTimeout(() => { loader.style.display = 'none'; }, 600);
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠+‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å /api/users/me
  async function loadEmployeeProfile() {
    try {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      const res = await fetch('/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const result = await res.json();
      if (!res.ok || !result.success) throw new Error(result.error || 'Load profile failed');
      const user = result.data;
      document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
      let url = user.photoUrl || '';
      if (!url.startsWith('/') && !/^https?:\/\//.test(url)) url = '/' + url;
      document.getElementById('employeePhoto').src = url;
    } catch (err) {
      console.error('loadEmployeeProfile error:', err);
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    showLoading(true);
    loadEmployeeProfile();
    // ‚Ä¶‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‚Ä¶
    setTimeout(() => showLoading(false), 800);
  });
</script>

<!-- Script ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å -->
<script>
// === Custom Alert Function ===
function customAlert(message, callback) {
  // ‡πÉ‡∏ä‡πâ modal ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  const modal = document.getElementById('alertModal');
  const messageEl = document.getElementById('alertMessage');
  const okBtn = document.getElementById('okAlertBtn');

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  messageEl.textContent = message;

  // ‡πÅ‡∏™‡∏î‡∏á modal
  modal.checked = true;

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ callback ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î OK
  if (callback && typeof callback === 'function') {
    const handleOk = () => {
      callback();
      okBtn.removeEventListener('click', handleOk);
    };
    okBtn.addEventListener('click', handleOk);
  }
}

// === Custom Confirm Function ===
function customConfirm(message, onConfirm, onCancel) {
  const modal = document.getElementById('confirmActionModal');
  const messageEl = document.getElementById('confirmActionText');
  const okBtn = document.getElementById('okActionBtn');
  const cancelBtn = document.getElementById('cancelActionBtn');

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  messageEl.textContent = message;

  // ‡πÅ‡∏™‡∏î‡∏á modal
  modal.checked = true;

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° OK
  const handleOk = () => {
    if (onConfirm && typeof onConfirm === 'function') {
      onConfirm();
    }
    okBtn.removeEventListener('click', handleOk);
    cancelBtn.removeEventListener('click', handleCancel);
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Cancel
  const handleCancel = () => {
    if (onCancel && typeof onCancel === 'function') {
      onCancel();
    }
    okBtn.removeEventListener('click', handleOk);
    cancelBtn.removeEventListener('click', handleCancel);
  };

  okBtn.addEventListener('click', handleOk);
  cancelBtn.addEventListener('click', handleCancel);
}

// === Error Handler Function ===
function handleError(error, defaultMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î') {
  console.error('Error:', error);
  customAlert(error.message || defaultMessage);
}

// --- Dark Mode Persistence ---
  const darkModePreference = localStorage.getItem('darkMode');
  const darkModeLabel = document.getElementById('darkModeLabel');
  if (darkModePreference === 'true') {
    document.documentElement.classList.add('dark');
    darkModeLabel.textContent = 'Light Mode';
  } else {
    document.documentElement.classList.remove('dark');
    darkModeLabel.textContent = 'Dark Mode';
  }
  const btnToggleDark = document.getElementById('btnToggleDark');
  btnToggleDark.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    darkModeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    localStorage.setItem('darkMode', isDark);
  });

  // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  async function fetchLoggedInUser() {
    try {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      const res = await fetch('/api/users/me', {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });
      const json = await res.json();
      if (!res.ok || !json.success) {
        console.error('Cannot fetch /me:', json.error);
        return;
      }
      const user = json.data;
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
      document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      if (user.photoUrl) {
        document.getElementById('employeePhoto').src = user.photoUrl;
      } else {
        document.getElementById('employeePhoto').src = '/uploads/default-avatar.png';
      }
    } catch (err) {
      console.error('fetchLoggedInUser error:', err);
    }
  }

  // 3) Logout (‡∏•‡∏ö authToken, userEmail ‡πÅ‡∏•‡∏∞ userId)
  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userId');
    window.location.href = 'login.html';
  });

  // 4) Toggle Sidebar Menu ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Footer
  function toggleMenu() {
    const sb   = document.getElementById('sidebar');
    const mc   = document.getElementById('mainContent');
    const icon = document.querySelector('#btnToggleMenu i');

    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå sidebar ‡∏î‡πâ‡∏ß‡∏¢ translate-x
    sb.classList.toggle('-translate-x-full');
    // ‡∏õ‡∏£‡∏±‡∏ö margin-left ‡∏Ç‡∏≠‡∏á content
    mc.classList.toggle('ml-64');
    mc.classList.toggle('ml-0');
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£
    icon.classList.toggle('bi-chevron-left');
    icon.classList.toggle('bi-chevron-right');
  }
  document.getElementById('btnToggleMenu')
          .addEventListener('click', toggleMenu);

  // Dropdown Menu Control
  const dropdownButton = document.getElementById('dropdownMenuButton');
  const dropdownMenu = document.getElementById('dropdownMenu');

  if (dropdownButton && dropdownMenu) {
    dropdownButton.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add('hidden');
      }
    });

    // Close dropdown when pressing Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dropdownMenu.classList.add('hidden');
      }
    });
  }

  // 5) Modal Functions
  function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
  }
  function hideModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  }

  // ---------------------------------------------------------
  // 6) Logic ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Supplier, PO, Branch, ‡πÅ‡∏•‡∏∞ *‡πÄ‡∏û‡∏¥‡πà‡∏°* Products
  // ---------------------------------------------------------
  let allBranches = [];
  let allSuppliers = [];
  let poItemsArr = [];

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  let allProducts = [];
  let allBrands = []; // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ allBrands

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Category Groups ‡∏à‡∏≤‡∏Å API
  async function loadCategoryGroups() {
    try {
      const res = await fetch('/api/category-group');
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ');
      }
      const groups = data.data;
      const sel = document.getElementById('categoryGroup');
      sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>`;
      groups.forEach(group => {
        const opt = document.createElement('option');
        opt.value = group._id; // ‡∏™‡πà‡∏á ObjectId ‡∏Ç‡∏≠‡∏á Category Group
        opt.textContent = group.name;
        sel.appendChild(opt);
      });
    } catch (err) {
      console.error('Error loading category groups: ', err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    loadBranches();
    loadSuppliers();
    loadAllPO();
    loadCategoryGroups();

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Flatpickr ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    flatpickr('#docDate', {
      dateFormat: 'd/m/Y',
      defaultDate: 'today',
      locale: 'th', // ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
      altInput: true,
      altFormat: 'j F Y', // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "1 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2568"
      parseDate: function(datestr) {
        return new Date(datestr);
      }
    });

    document
      .getElementById('createPOForm')
      .addEventListener('submit', createPO);
    document
      .getElementById('btnAddItem')
      .addEventListener('click', addItemRow);

    document.querySelectorAll('.btn-close-modal').forEach((btn) => {
      btn.addEventListener('click', () => {
        const modalId = btn.dataset.modal;
        hideModal(modalId);
      });
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    const btnViewHistory = document.getElementById('btnViewHistory');
    if (btnViewHistory) {
      btnViewHistory.addEventListener('click', () => {
        window.location.href = 'POHistery.html';
      });
    }

    // Socket.IO
    const socket = io();
    socket.on('connect', () => {
      console.log('Socket.IO connected (Supplier & PO page).');
    });
    socket.on('disconnect', () => {
      console.warn('Socket.IO disconnected.');
    });
    socket.on('poUpdate', (payload) => {
      console.log('Realtime PO update:', payload);
    });

    // Sidebar link highlighting
    const sidebarLinks = document.querySelectorAll('aside a');
    function highlightSidebar(link) {
      // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πÄ‡∏Å‡πà‡∏≤
      sidebarLinks.forEach(l => {
        l.style.backgroundColor = '';
        l.style.color = '';
        const ico = l.querySelector('i');
        if (ico) ico.style.color = '';
      });
      // ‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß override ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏ß
      const icon = link.querySelector('i');
      if (icon) {
        const c = getComputedStyle(icon).color;
        link.style.backgroundColor = c;
        link.style.color = '#fff';
        icon.style.color = '#fff';
      }
    }
    sidebarLinks.forEach(link => {
      link.addEventListener('click', () => highlightSidebar(link));
    });
    // initial highlight based on href
    const page = window.location.pathname.split('/').pop();
    sidebarLinks.forEach(link => {
      if (link.getAttribute('href') === page) highlightSidebar(link);
    });

    // Pagination event listeners
    document.getElementById('btnPrevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        goToPage(currentPage - 1);
      }
    });

    document.getElementById('btnNextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(allPO.length / itemsPerPage);
      if (currentPage < totalPages) {
        goToPage(currentPage + 1);
      }
    });
  });

  // Helper: format number
  function formatNumber(num) {
    return num.toLocaleString('en-US', { minimumFractionDigits: 2 });
  }

  // Helper: format date to dd/mm/yyyy format
  function formatDateThai(dateString) {
    if (!dateString) return '-';
    try {
      const date = new Date(dateString);
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (isNaN(date.getTime())) return '-';

      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear(); // ‡πÉ‡∏ä‡πâ ‡∏Ñ.‡∏®.

      return `${day}/${month}/${year}`;
    } catch (err) {
      console.error('Error formatting date:', err);
      return '-';
    }
  }

  // Helper: ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô (iPhone 13, iPhone 14, etc.)
  function sortProductsByModel(products) {
    return products.sort((a, b) => {
      // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏∏‡πà‡∏ô
      const getModelInfo = (name) => {
        if (!name) return { base: '', number: 0 };

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "iPhone 13" -> base: "iPhone", number: 13
        const match = name.match(/^(.+?)\s*(\d+)(.*)$/);
        if (match) {
          return {
            base: match[1].trim().toLowerCase(),
            number: parseInt(match[2], 10),
            suffix: match[3].trim()
          };
        }
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
        return { base: name.toLowerCase(), number: 0, suffix: '' };
      };

      const aInfo = getModelInfo(a.name);
      const bInfo = getModelInfo(b.name);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Å‡πà‡∏≠‡∏ô
      if (aInfo.base !== bInfo.base) {
        return aInfo.base.localeCompare(bInfo.base);
      }

      // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏∏‡πà‡∏ô
      if (aInfo.number !== bInfo.number) {
        return aInfo.number - bInfo.number;
      }

      // ‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° suffix
      return aInfo.suffix.localeCompare(bInfo.suffix);
    });
  }

  // ----------------------------------------------------
  // (A) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ capacity / color / brand
  // ----------------------------------------------------
  async function loadProducts() {
    try {
      const res = await fetch('/api/product-image');
      const data = await res.json();
      if (!data.data && !data.success) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      }
      let products = data.data || (data.success && data.success.data) || [];

      // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô
      allProducts = sortProductsByModel(products);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö capacity, color ‡πÅ‡∏•‡∏∞ brand
      const capacitySet = new Set();
      const colorSet = new Set();
      const brandSet = new Set();
      allProducts.forEach((p) => {
        if (p.capacity) capacitySet.add(p.capacity);
        if (p.color) colorSet.add(p.color);
        if (p.brand) brandSet.add(p.brand);
      });
      allCapacities = Array.from(capacitySet);
      allColors = Array.from(colorSet);
      allBrands = Array.from(brandSet); // ‡πÅ‡∏õ‡∏•‡∏á Set ‡πÄ‡∏õ‡πá‡∏ô Array

      console.log('Loaded products (sorted by model):', allProducts);
    } catch (err) {
      console.error('Error loadProducts:', err);
    }
  }

  // ----------------------------------------------------
  // (B) Supplier Logic
  // ----------------------------------------------------
  async function registerSupplier(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const res = await fetch('/api/supplier', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        customAlert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (data.error || 'Error'));
        return;
      }
      customAlert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      e.target.reset();
      loadSuppliers();
    } catch (err) {
      customAlert('Error registerSupplier: ' + err.message);
    }
  }

  async function loadSuppliers() {
    try {
      const res = await fetch('/api/supplier');
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.error || 'Error loading suppliers');
      allSuppliers = json.data;

      // ‡πÄ‡∏ï‡∏¥‡∏° <select> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const sel = document.getElementById('selectSupplierForPO');
      sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå --</option>';
      allSuppliers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s._id;
        opt.textContent = `[${s.code}] ${s.name}`;
        sel.appendChild(opt);
      });

    } catch (err) {
      console.error(err);
      customAlert('‡πÇ‡∏´‡∏•‡∏î‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }


  // ----------------------------------------------------
  // (C) Branch Logic
  // ----------------------------------------------------
  async function loadBranches() {
    try {
      const res = await fetch('/api/branch');
      const data = await res.json();
      if (!res.ok || !data.success) {
        customAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ: ' + (data.error || 'Error'));
        return;
      }
      allBranches = data.data;
      populateBranchForPO(allBranches);
    } catch (err) {
      customAlert('Error loadBranches: ' + err.message);
    }
  }

  function populateBranchForPO(branches) {
    const sel = document.getElementById('selectBranchForPO');
    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>`;
    branches.forEach((b) => {
      const opt = document.createElement('option');
      // ‡πÉ‡∏ä‡πâ branch_code ‡πÄ‡∏õ‡πá‡∏ô value
      opt.value = b.branch_code;
      // ‡πÅ‡∏™‡∏î‡∏á branch_code, code ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
      opt.textContent = `[${b.branch_code}] ${b.name}`;
      sel.appendChild(opt);
    });
  }


  // ----------------------------------------------------
  // (D) Purchase Order Logic
  // ----------------------------------------------------
  let allPO = [];

  // ‚Üê Insert pagination variables & functions here, before loadAllPO
let currentPage = 1;
const itemsPerPage = 5;

function renderPOTableWithPagination(poList) {
  const totalPages = Math.ceil(poList.length / itemsPerPage);
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex   = Math.min(startIndex + itemsPerPage, poList.length);
  renderPOTable(poList.slice(startIndex, endIndex));
  updatePaginationInfo(startIndex + 1, endIndex, poList.length, totalPages);
}

function updatePaginationInfo(start, end, total, totalPages) {
  document.getElementById('startIndex').textContent = total > 0 ? start : 0;
  document.getElementById('endIndex').textContent   = end;
  document.getElementById('totalPO').textContent    = total;
  document.getElementById('btnPrevPage').disabled   = currentPage <= 1;
  document.getElementById('btnNextPage').disabled   = currentPage >= totalPages;
  generatePageNumbers(totalPages);
}

function generatePageNumbers(totalPages) {
  const container = document.getElementById('pageNumbers');
  container.innerHTML = '';
  let startPage = Math.max(1, currentPage - 2);
  let endPage   = Math.min(totalPages, startPage + 4);
  if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `px-3 py-1 rounded-lg transition ${
      i === currentPage
        ? 'bg-blue-600 text-white'
        : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
    }`;
    btn.onclick = () => goToPage(i);
    container.appendChild(btn);
  }
}

function goToPage(page) {
  currentPage = page;
  renderPOTableWithPagination(allPO);
}

  async function loadAllPO() {
    try {
      const token = localStorage.getItem('authToken');

      // ‡∏•‡∏ö ?mode=pending ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ PO ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const res = await fetch('/api/purchase-order', {
        headers: {
          'Authorization': token ? `Bearer ${token}` : ''
        }
      });

      const data = await res.json();

      // === ‡πÄ‡∏û‡∏¥‡πà‡∏° Debug Code ===
      console.log('=== RAW API Response ===');
      console.log('Full Response:', data);

      if (data.data && data.data.length > 0) {
        console.log('=== First PO Structure ===');
        console.log(JSON.stringify(data.data[0], null, 2));

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö field ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
        console.log('=== Creator Fields ===');
        data.data.forEach((po, idx) => {
          console.log(`PO ${idx + 1} (${po.poNumber}):`);
          console.log('- createdBy:', po.createdBy);
          console.log('- createdByName:', po.createdByName);
          console.log('- creator:', po.creator);
          console.log('- user:', po.user);
          console.log('- All keys:', Object.keys(po));
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ
        console.log('=== Tax Data in Items ===');
        data.data.forEach((po, idx) => {
          if (po.items && po.items.length > 0) {
            console.log(`PO ${idx + 1} Items:`);
            po.items.forEach((item, itemIdx) => {
              console.log(`  Item ${itemIdx + 1}:`, {
                name: item.name,
                taxType: item.taxType,
                taxRate: item.taxRate
              });
            });
          }
        });
      }
      // === ‡∏à‡∏ö Debug Code ===

      if (!res.ok || !data.success) {
        customAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î PO ‡πÑ‡∏î‡πâ: ' + (data.error || 'Error'));
        return;
      }

      allPO = data.data;

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PO ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
      console.log('PO Data Structure:', allPO[0]);

      renderPOTableWithPagination(allPO);
    } catch (err) {
      customAlert('Error: ' + err.message);
    }
  }

  // Add helper function for consistent display values
  function getDisplayValue(value, defaultValue = '-') {
    if (value === null || value === undefined || value === '') {
      return defaultValue;
    }
    return value;
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á PO
  function renderPOTable(poList) {
    const tbody = document.getElementById('poTable');
    tbody.innerHTML = '';

    poList.forEach(po => {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° debug ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞ PO
      console.log('Processing PO:', po);

      const tr = document.createElement('tr');
      const branchName   = po.branch?.name || po.branch_code || '-';
      const supplierName = po.supplier?.name || '-';
      const categoryName = po.categoryGroup?.name || '-';

      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡∏î‡πå
      let createdByName = po.createdByName ||
                         po.createdBy?.name ||
                         po.createdBy?.fullName ||
                         po.creator ||
                         po.userName ||
                         po.userEmail ||
                         '';

      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." ‡∏´‡∏£‡∏∑‡∏≠ email
      if (!createdByName || createdByName === '-') {
        createdByName = po.createdByEmail || po.userEmail || '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      }

      console.log(`PO ${po.poNumber} creator:`, {
        createdByName: po.createdByName,
        createdBy: po.createdBy,
        creator: po.creator,
        final: createdByName
      });

      const statusText = po.status || 'Pending';

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
    let totalAmount = 0;
    if (Array.isArray(po.items) && po.items.length) {
      po.items.forEach(item => {
        const baseAmount = item.qty * (item.cost - (item.discount || 0));
        let itemTotal = baseAmount;

        if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ' && item.taxRate) {
          itemTotal = baseAmount + (baseAmount * (item.taxRate / 100));
        }

        totalAmount += itemTotal;
      });
    } else {
      totalAmount = po.totalAmount || 0;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let statusClass = '';
    let statusColor = '';
    if (statusText === 'Pending') {
      statusClass = 'bg-yellow-100 text-yellow-800';
      statusColor = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    } else if (statusText === 'Approved') {
      statusClass = 'bg-green-100 text-green-800';
      statusColor = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
    } else if (statusText === 'Rejected') {
      statusClass = 'bg-red-100 text-red-800';
      statusColor = '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß';
    }

    tr.innerHTML = `
      <td class="px-2 py-1 border">${po.poNumber || '-'}</td>
      <td class="px-2 py-1 border">
        <input type="text" 
               id="docNumber_${po._id}" 
               value="${po.documentNumber || ''}" 
               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
               class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-400 document-number-input"
               onblur="updateDocumentNumber('${po._id}', this.value)"
               onkeypress="if(event.key==='Enter') this.blur()"
               title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß">
      </td>
      <td class="px-2 py-1 border text-center">${formatDateThai(po.docDate)}</td>
      <td class="px-2 py-1 border">${branchName}</td>
      <td class="px-2 py-1 border">${supplierName}</td>
      <td class="px-2 py-1 border">${categoryName}</td>
      <td class="px-2 py-1 border">${po.notes || '-'}</td>
      <td class="px-2 py-1 border">
        ${totalAmount.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2})}
      </td>
      <td class="px-2 py-1 border">
        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
          ${statusColor}
        </span>
      </td>
      <td class="px-2 py-1 border text-xs font-semibold text-blue-600">${createdByName}</td>
      <td class="px-2 py-1 border">
        <button class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition"
                onclick="deletePurchaseOrder('${po._id}')"
                ${statusText === 'Approved' ? 'disabled' : ''}>
          ‡∏•‡∏ö
        </button>
      </td>
      <td class="px-2 py-1 border">
        <button class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                onclick="downloadPOPDF('${po._id}')">
          PDF
        </button>
      </td>`;
    tbody.appendChild(tr);

    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    if (Array.isArray(po.items) && po.items.length) {
      const itemRow = document.createElement('tr');
      itemRow.className = 'bg-gray-50 dark:bg-gray-800';
      itemRow.innerHTML = `<td colspan="12" class="px-2 py-2">
        ${createItemTableHtml(po.items)}
      </td>`;
      tbody.appendChild(itemRow);
    }
  });
}

// Helper function to create HTML table for PO items
function createItemTableHtml(items) {
  if (!items || !items.length) return '<p class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';

  let html = `
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100 dark:bg-gray-700">
        <tr>
          <th class="px-2 py-1 text-left">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="px-2 py-1 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th class="px-2 py-1 text-left">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</th>
          <th class="px-2 py-1 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="px-2 py-1 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th class="px-2 py-1 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
          <th class="px-2 py-1 text-right">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ</th>
          <th class="px-2 py-1 text-right">‡∏†‡∏≤‡∏©‡∏µ (%)</th>
          <th class="px-2 py-1 text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody>
  `;

  items.forEach((item, index) => {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const baseAmount = item.qty * (item.cost - item.discount);
    let netAmount = baseAmount;
    let taxAmount = 0;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏™‡∏°‡∏≠‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
    let taxDisplay = '-';
    if (item.taxRate !== undefined && item.taxRate !== null) {
      taxDisplay = item.taxRate + '%';
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ taxType ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤ taxRate
      if (!item.taxType && item.taxRate > 0) {
        item.taxType = '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ'; // default
      }
    }

    if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      taxAmount = baseAmount * (item.taxRate / 100);
    } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
      netAmount = baseAmount / (1 + (item.taxRate / 100));
      taxAmount = baseAmount - netAmount;
    }

    const totalWithTax = netAmount + taxAmount;

    html += `
      <tr class="border-b border-gray-200 dark:border-gray-700">
        <td class="px-2 py-1">${index + 1}</td>
        <td class="px-2 py-1">${getDisplayValue(item.name)}</td>
        <td class="px-2 py-1">${getDisplayValue(item.brand)}</td>
        <td class="px-2 py-1 text-right">${item.qty}</td>
        <td class="px-2 py-1 text-right">${formatNumber(item.cost)}</td>
        <td class="px-2 py-1 text-right">${formatNumber(item.discount)}</td>
        <td class="px-2 py-1 text-right">${getDisplayValue(item.taxType, '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ')}</td>
        <td class="px-2 py-1 text-right">${taxDisplay}</td>
        <td class="px-2 py-1 text-right">${formatNumber(totalWithTax)}</td>
      </tr>
    `;
  });

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô
  const totalAmount = items.reduce((sum, item) => {
    const baseAmount = item.qty * (item.cost - item.discount);
    let netAmount = baseAmount;
    let taxAmount = 0;

    if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      taxAmount = baseAmount * (item.taxRate / 100);
    } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
      netAmount = baseAmount / (1 + (item.taxRate / 100));
      taxAmount = baseAmount - netAmount;
    }

    return sum + netAmount + taxAmount;
  }, 0);

  html += `
      </tbody>
      <tfoot>
        <tr class="bg-gray-50 dark:bg-gray-800 font-medium">
          <td colspan="8" class="px-2 py-1 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</td>
          <td class="px-2 py-1 text-right">${formatNumber(totalAmount)}</td>
        </tr>
      </tfoot>
    </table>
  `;

  return html;
}

// 1) createPO() - ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á taxType ‡∏£‡∏∞‡∏î‡∏±‡∏ö PO-level (‡πÅ‡∏ï‡πà‡∏•‡∏∞ item ‡∏°‡∏µ taxType ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
async function createPO(e) {
  e.preventDefault();

  const branch_code     = document.getElementById('selectBranchForPO').value;
  const supplierId      = document.getElementById('selectSupplierForPO').value;
  const categoryGroup   = document.getElementById('categoryGroup').value || null;
  const docDate         = document.getElementById('docDate').value;
  const notes           = document.getElementById('orderNotes').value.trim();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ documentNumber element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const documentNumberElement = document.getElementById('documentNumber');
  const documentNumber  = documentNumberElement ? documentNumberElement.value.trim() : '';

  if (!branch_code)    return customAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤');
  if (!supplierId)     return customAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå');
  if (poItemsArr.length < 1) return customAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡πâ‡∏ß
  for (let i = 0; i < poItemsArr.length; i++) {
    const item = poItemsArr[i];
    if (!item.taxType || item.taxType === '') {
      return customAlert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1} (${item.name || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'})`);
    }
    if (!item.name || item.name === '') {
      return customAlert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1}`);
    }
  }

  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å /api/users/me (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö loadEmployeeProfile)
    const token = localStorage.getItem('authToken');
    let currentUser = null;

    try {
      const userRes = await fetch('/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const userResult = await userRes.json();

      if (userRes.ok && userResult.success) {
        currentUser = userResult.data;
        console.log('Current user from /api/users/me:', currentUser);
      }
    } catch (err) {
      console.error('Error fetching user data:', err);
    }

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å API response
    const creatorData = {
      userId: currentUser?._id || currentUser?.id || '',
      name: currentUser?.name || currentUser?.fullName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á',
      email: currentUser?.email || ''
    };

    console.log('Creator data to be sent:', creatorData); // Debug

    const bodyData = {
      docDate,
      branch_code,
      supplierId,
      categoryGroup,
      notes,
      documentNumber, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      items: poItemsArr.map(item => ({
        ...item,
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á taxRate ‡πÅ‡∏•‡∏∞ taxType
        taxRate: item.taxRate || 0,
        taxType: item.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ'
      })),
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ backend ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ
      createdBy: creatorData.userId,
      createdByName: creatorData.name,
      createdByEmail: creatorData.email,
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠ backend ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô
      creator: creatorData.name,
      userId: creatorData.userId,
      userName: creatorData.name,
      userEmail: creatorData.email
    };

    console.log('=== Full PO Data being sent ===');
    console.log(JSON.stringify(bodyData, null, 2));

    const res = await fetch('/api/purchase-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      body: JSON.stringify(bodyData)
    });

    const data = await res.json();
    console.log('Response from create PO:', data); // Debug

    if (!res.ok || !data.success) {
      customAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ: ' + (data.error || 'Error'));
      return;
    }

    customAlert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', () => {
      e.target.reset();
      document.getElementById('documentNumber').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      poItemsArr = [];
      renderPoItemsTable();
      loadAllPO();
    });
  } catch (err) {
    console.error('Error in createPO:', err);
    customAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}

// 2) addItemRow() - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î taxType ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function addItemRow() {
  const newItem = {
    brand: '',
    name: '',
    capacity: '',
    color: '',
    qty: 1,
    cost: 0,
    discount: 0,
    taxRate: 7,
    taxType: '',     // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    wh: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    status: 'active'
  };
  poItemsArr.push(newItem);
  renderPoItemsTable();
}

// 3) renderPoItemsTable() - ‡πÉ‡∏ä‡πâ item.taxType ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
function renderPoItemsTable() {
  const tbody = document.getElementById('poItemsTable');
  tbody.innerHTML = '';

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
  let totalSubtotal = 0;     // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏° (qty * cost)
  let totalDiscount = 0;     // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°
  let totalTax = 0;          // ‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°
  let grandTotal = 0;        // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥

  poItemsArr.forEach((item, index) => {
    const subtotal = item.qty * item.cost;           // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î
    const discountAmount = item.qty * item.discount; // ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
    const base = subtotal - discountAmount;          // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î

    let net = 0, taxAmount = 0, totalWithTax = 0;
    if (item.taxType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ') {
      net = base;
      taxAmount = 0;
      totalWithTax = base;
    } else if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      net = base;
      taxAmount = base * (item.taxRate / 100);
      totalWithTax = net + taxAmount;
    } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
      totalWithTax = base;
      net = totalWithTax / (1 + item.taxRate / 100);
      taxAmount = totalWithTax - net;
    } else {
      // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å taxType: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ"
      net = base;
      taxAmount = 0;
      totalWithTax = base;
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
    totalSubtotal += subtotal;
    totalDiscount += discountAmount;
    totalTax += taxAmount;
    grandTotal += totalWithTax;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <!-- Brand -->
      <td class="px-2 py-1 border">
        <select class="inp-po-item w-full rounded border bg-white dark:bg-gray-700" data-index="${index}" data-field="brand">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå --</option>
          ${allBrands.map(b => `<option value="${b}" ${item.brand === b ? 'selected' : ''}>${b}</option>`).join('')}
        </select>
      </td>
      <!-- Name -->
      <td class="px-2 py-1 border">
        <select class="inp-po-item w-full rounded border bg-white dark:bg-gray-700" data-index="${index}" data-field="name">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
          ${sortProductsByModel(allProducts.filter(p => p.brand === item.brand))
            .map(p => `<option value="${p.name}" ${item.name === p.name ? 'selected' : ''}>${p.name}</option>`).join('')}
        </select>
      </td>
      <!-- Qty -->
      <td class="px-2 py-1 border">
        <input type="number" class="inp-po-item w-full rounded border border-gray-300 bg-white text-gray-800 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" data-index="${index}" data-field="qty" min="1" value="${item.qty}" />
      </td>
      <!-- Cost -->
      <td class="px-2 py-1 border">
        <input type="number" class="inp-po-item w-full rounded border border-gray-300 bg-white text-gray-800 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" data-index="${index}" data-field="cost" step="0.01" value="${item.cost}" />
      </td>
      <!-- Discount -->
      <td class="px-2 py-1 border">
        <input type="number" class="inp-po-item w-full rounded border border-gray-300 bg-white text-gray-800 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" data-index="${index}" data-field="discount" step="0.01" value="${item.discount}" />
      </td>
      <!-- Tax Rate -->
      <td class="px-2 py-1 border">
        <input type="number" class="inp-po-item w-full rounded border border-gray-300 bg-white text-gray-800 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" data-index="${index}" data-field="taxRate" step="0.01" value="${item.taxRate || 7}" />
      </td>
      <!-- Tax Type -->
      <td class="px-2 py-1 border">
        <select class="inp-po-item w-full rounded border bg-white dark:bg-gray-700" data-index="${index}" data-field="taxType">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ --</option>
          <option value="‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ" ${item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ' ? 'selected' : ''}>‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ</option>
          <option value="‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ" ${item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ' ? 'selected' : ''}>‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ</option>
          <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ" ${item.taxType === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ</option>
        </select>
      </td>
      <!-- Net Amount -->
      <td class="px-2 py-1 border">${formatNumber(net)}</td>
      <!-- Tax Amount -->
      <td class="px-2 py-1 border">${formatNumber(taxAmount)}</td>
      <!-- Total With Tax -->
      <td class="px-2 py-1 border">${formatNumber(totalWithTax)}</td>
      <!-- Remove Button -->
      <td class="px-2 py-1 border">
        <button class="btn-remove-po-item px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition" data-index="${index}">
          ‡∏•‡∏ö
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
  updatePOSummary(totalSubtotal, totalDiscount, totalTax, grandTotal);
  attachPoItemsEvents();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
function updatePOSummary(subtotal, discount, tax, total) {
  document.getElementById('summarySubtotal').textContent = formatNumber(subtotal);
  document.getElementById('summaryDiscount').textContent = formatNumber(discount);
  document.getElementById('summaryTax').textContent = formatNumber(tax);
  document.getElementById('summaryTotal').textContent = formatNumber(total);
}

// 4) attachPoItemsEvents() - ‡∏ú‡∏π‡∏Å event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö taxType ‡πÅ‡∏•‡∏∞ input ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
function attachPoItemsEvents() {
  // (1) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
  document.querySelectorAll(".inp-po-item[data-field='brand']").forEach(select => {
    select.addEventListener('change', e => {
      const idx = parseInt(e.target.dataset.index, 10);
      poItemsArr[idx].brand = e.target.value;
      poItemsArr[idx].name = ''; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      renderPoItemsTable();
    });
  });
  // (2) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  document.querySelectorAll(".inp-po-item[data-field='name']").forEach(select => {
    select.addEventListener('change', e => {
      const idx = parseInt(e.target.dataset.index, 10);
      poItemsArr[idx].name = e.target.value;
      const prod = allProducts.find(p => p.name === e.target.value);
      if (prod) {
        poItemsArr[idx].cost    = prod.cost || 0;
        poItemsArr[idx].taxRate = prod.taxRate || 7;
      }
      renderPoItemsTable();
    });
  });
  // (3) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ input ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (qty, cost, discount, taxRate)
  document.querySelectorAll('.inp-po-item').forEach(inp => {
    inp.addEventListener('change', e => {
      const idx = parseInt(e.target.dataset.index, 10);
      const field = e.target.dataset.field;
      if (['qty', 'cost', 'discount', 'taxRate'].includes(field)) {
        poItemsArr[idx][field] = parseFloat(e.target.value) || 0;
        renderPoItemsTable();
      }
    });
  });
  // (4) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ (taxType)
  document.querySelectorAll(".inp-po-item[data-field='taxType']").forEach(select => {
    select.addEventListener('change', e => {
      const idx = parseInt(e.target.dataset.index, 10);
      poItemsArr[idx].taxType = e.target.value;
      renderPoItemsTable();
    });
  });
  // (5) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß
  document.querySelectorAll('.btn-remove-po-item').forEach(btn => {
    btn.addEventListener('click', e => {
      const idx = parseInt(e.target.dataset.index, 10);
      poItemsArr.splice(idx, 1);
      renderPoItemsTable();
    });
  });
}

// Add stub functions for deletePurchaseOrder and downloadPOPDF at the end of your script:
function deletePurchaseOrder(poId) {
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö PO ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ?')) return;

  const token = localStorage.getItem('authToken');

  fetch(`/api/purchase-order/${poId}`, {
    method: 'DELETE',
    headers: {
      'Authorization': token ? `Bearer ${token}` : ''
    }
  })
    .then(response => response.json())
    .then(data => {
      if (!data.success) {
        customAlert('‡∏•‡∏ö PO ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + data.error);
      } else {
        customAlert('‡∏•‡∏ö PO ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', () => loadAllPO());
      }
    })
    .catch(err => customAlert('Error: ' + err.message));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
async function updateDocumentNumber(poId, documentNumber) {
  try {
    const token = localStorage.getItem('authToken');

    const response = await fetch(`/api/purchase-order/${poId}/document-number`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      body: JSON.stringify({ documentNumber: documentNumber.trim() })
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      customAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + (data.error || 'Error'));
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      const inputElement = document.getElementById(`docNumber_${poId}`);
      if (inputElement && data.originalValue !== undefined) {
        inputElement.value = data.originalValue;
      }
      return;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô allPO array
    const poIndex = allPO.findIndex(po => po._id === poId);
    if (poIndex !== -1) {
      allPO[poIndex].documentNumber = documentNumber.trim();
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
    if (documentNumber.trim()) {
      console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PO ${data.data?.poNumber || poId} ‡πÄ‡∏õ‡πá‡∏ô "${documentNumber.trim()}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }

  } catch (error) {
    console.error('Error updating document number:', error);
    customAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ' + error.message);

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
    const inputElement = document.getElementById(`docNumber_${poId}`);
    const po = allPO.find(p => p._id === poId);
    if (inputElement && po) {
      inputElement.value = po.documentNumber || '';
    }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö PO
async function deletePurchaseOrder(poId) {
  customConfirm(
    '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?',
    async () => {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/purchase-order/${poId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': token ? `Bearer ${token}` : ''
          }
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          customAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ: ' + (data.error || 'Error'));
          return;
        }

        customAlert('‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', () => {
          loadAllPO(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        });

      } catch (error) {
        console.error('Error deleting PO:', error);
        customAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ' + error.message);
      }
    }
  );
}

function downloadPOPDF(poId) {
  const token = localStorage.getItem('authToken');

  if (!token) {
    customAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
    return;
  }

  // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ fetch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF
  fetch(`/api/purchase-order/pdf/${poId}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => {
        throw new Error(err.error || `HTTP ${response.status}: ${response.statusText}`);
      });
    }
    return response.blob();
  })
  .then(blob => {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF
    const url = window.URL.createObjectURL(blob);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á link ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    const link = document.createElement('a');
    link.href = url;
    link.download = `PO_${poId}.pdf`;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° link ‡πÑ‡∏õ‡∏¢‡∏±‡∏á DOM ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å
    document.body.appendChild(link);
    link.click();

    // ‡∏•‡∏ö link ‡πÅ‡∏•‡∏∞ URL object
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  })
  .catch(error => {
    console.error('Error downloading PDF (method 1):', error);

    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏´‡∏≤‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô tab ‡πÉ‡∏´‡∏°‡πà
    console.log('Trying alternative method...');
    const url = `/api/purchase-order/pdf/${poId}?token=${encodeURIComponent(token)}`;
    window.open(url, '_blank');
  });
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° default date ‡πÉ‡∏ô DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  loadEmployeeProfile();
  // ‚Ä¶existing init‚Ä¶

  const today        = new Date();
  const docDateInput = document.getElementById('docDate');

  flatpickr(docDateInput, {
    dateFormat: 'd/m/Y',      // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏Ñ.‡∏®.
    defaultDate: today,
    locale: {
      firstDayOfWeek: 1,
      weekdays: {
        shorthand: ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'],
        longhand: ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå']
      },
      months: {
        shorthand: ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'],
        longhand: ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                   '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°']
      }
    },
    allowInput: true,
    altInput: true,
    altFormat: 'j F Y',       // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô "25 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2567"
    onReady: function(selectedDates, dateStr, instance) {
      instance.altInput.value = formatThaiDate(selectedDates[0] || today);
    },
    onChange: function(selectedDates, dateStr, instance) {
      instance.altInput.value = formatThaiDate(selectedDates[0]);
    }
  });

  function formatThaiDate(date) {
    if (!date) return '';
    const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    const d     = new Date(date);
    const day   = d.getDate();
    const month = months[d.getMonth()];
    const year  = d.getFullYear() + 543; // ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä
    return `${day} ${month} ${year}`;
  }

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô downloadPOPDF ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Fetch API
  function downloadPOPDF(poId) {
    const token = localStorage.getItem('authToken');

    if (!token) {
      customAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
      return;
    }

    fetch(`/api/purchase-order/pdf/${poId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏î‡πâ');
        });
      }
      return response.blob();
    })
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PO_${poId}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error downloading PDF:', error);
      customAlert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
    });
  }
});

// ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
window.addEventListener('beforeunload', () => {
  if (lottieAnimation) {
    lottieAnimation.destroy();
    lottieAnimation = null;
  }
});
</script>
</body>
</html>