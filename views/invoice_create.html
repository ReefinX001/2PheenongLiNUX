<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>สร้างใบแจ้งหนี้ / ใบกำกับภาษี</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Google Font: Prompt -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CSS + DaisyUI -->
  <link href="/css/tailwind.css" rel="stylesheet">
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
    rel="stylesheet"
    type="text/css"
  />

  <!-- Bootstrap Icons (เฉพาะไอคอน) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- Socket.IO (ไฟล์โลคัล) + Subresource Integrity (SRI) -->
  <script
    src="/socket.io.min.js"
    integrity="sha384-xWmNuOozkup5L7vb2ZFBg8dy0whlJd0gZAq3pvXuNa+5tSl/AjYqFNXN7kmjVTx2"
    crossorigin="anonymous"
  ></script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;'
    }
    .container-main {
      @apply max-w-4xl mx-auto px-4 py-4;
    }
    /* card-custom */
    .card-custom {
      @apply bg-white dark:bg-gray-800 rounded-lg shadow p-4;
    }
    .card-custom:hover {
      @apply -translate-y-1 shadow-lg;
    }
    /* table styles */
    table {
      @apply w-full border border-gray-300 dark:border-gray-600 text-sm;
    }
    thead {
      @apply bg-gray-100 dark:bg-gray-700;
    }
    th, td {
      @apply px-2 py-2 border border-gray-200 dark:border-gray-600;
    }
    tbody tr:hover {
      @apply bg-gray-50 dark:bg-gray-800;
    }
    /* summary box */
    .summary-box {
      @apply bg-white dark:bg-gray-800 rounded-lg shadow p-4;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

  <!-- ตรวจสอบ Token ก่อนเข้าหน้า -->
  <script>
    (function checkToken() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('กรุณาเข้าสู่ระบบก่อน');
        window.location.href = '/login'; // เปลี่ยนเป็นหน้า login ของคุณ'
      }
    })();
  </script>

  <!-- ส่วน header -->
  <div class="w-full bg-white dark:bg-gray-800 shadow">
    <div class="container-main flex items-center justify-between">
      <h2 class="text-xl font-bold py-4">
        สร้างใบแจ้งหนี้ / ใบกำกับภาษี
      </h2>
      <div class="text-sm text-gray-500 dark:text-gray-300">
        เลขที่ใบแจ้งหนี้ : <strong id="invoiceNumber">IVT-2025000001</strong>
      </div>
    </div>
  </div>

  <!-- Container หลัก -->
  <div class="container-main">
    <!-- card: ข้อมูลลูกค้าและวันที่ -->
    <div class="card-custom mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label for="customerSelect" class="block font-semibold mb-1">ชื่อลูกค้า</label>
          <select id="customerSelect" class="select select-bordered w-full dark:bg-gray-700">
            <!-- จะโหลดจาก API -->
          </select>
        </div>
        <div>
          <label for="billingDate" class="block font-semibold mb-1">วันที่ออกบิล</label>
          <input type="date" id="billingDate" class="input input-bordered w-full dark:bg-gray-700">
        </div>
        <div>
          <label for="dueDate" class="block font-semibold mb-1">วันครบกำหนด</label>
          <input type="date" id="dueDate" class="input input-bordered w-full dark:bg-gray-700">
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="tel" class="block font-semibold mb-1">เบอร์โทร</label>
          <input type="text" id="tel" placeholder="08XXXXXXXX" class="input input-bordered w-full dark:bg-gray-700">
        </div>
        <div>
          <label for="groupType" class="block font-semibold mb-1">กลุ่มอัตราภาษี</label>
          <select id="groupType" class="select select-bordered w-full dark:bg-gray-700">
            <option value="แยกภาษี">แยกภาษี</option>
            <option value="รวมภาษี">รวมภาษี</option>
          </select>
        </div>
        <div>
          <label for="taxMode" class="block font-semibold mb-1">การออกใบกำกับ</label>
          <select id="taxMode" class="select select-bordered w-full dark:bg-gray-700">
            <option value="ออกใบกำกับภาษี">ออกใบกำกับภาษี</option>
            <option value="ไม่ออกใบกำกับภาษี">ไม่ออกใบกำกับภาษี</option>
          </select>
        </div>
      </div>
    </div>

    <!-- card: ตารางรายการสินค้า/บริการ -->
    <div class="card-custom mb-4">
      <h5 class="text-lg font-semibold mb-3">รายการสินค้า/บริการ</h5>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>สินค้า/บริการ</th>
              <th>จำนวน</th>
              <th>ราคาต่อหน่วย</th>
              <th>ส่วนลด</th>
              <th>VAT</th>
              <th>มูลค่าสุทธิ</th>
              <th>จัดการ</th>
            </tr>
          </thead>
          <tbody id="invoiceItems">
            <!-- แถวรายการจาก JS -->
          </tbody>
        </table>
      </div>
      <button class="btn btn-primary btn-sm mt-2" id="addItem">
        <i class="bi bi-plus-circle mr-1"></i> เพิ่มรายการ
      </button>
    </div>

    <!-- สรุปยอดรวม + หมายเหตุ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- col1: สรุปยอด -->
      <div class="md:col-span-1 summary-box mb-4">
        <h5 class="font-semibold mb-3">สรุปยอดรวม</h5>
        <div class="flex justify-between mb-1">
          <span>ส่วนลดรวม</span>
          <span id="totalDiscount">0.00 บาท</span>
        </div>
        <div class="flex justify-between items-center mb-1">
          <span>ค่าขนส่ง / ส่วนเพิ่ม</span>
          <input
            type="number"
            id="shippingFeeInput"
            value="0"
            step="0.01"
            class="input input-bordered w-28 text-right dark:bg-gray-700"
          >
        </div>
        <hr class="my-2">
        <div class="flex justify-between mb-1">
          <span>ยอดรวม</span>
          <span id="subTotal">0.00 บาท</span>
        </div>
        <div class="flex justify-between mb-2">
          <span>VAT (7%)</span>
          <span id="vatAmount">0.00 บาท</span>
        </div>
        <div class="flex justify-between font-bold text-lg">
          <span>จำนวนเงินทั้งสิ้น</span>
          <span id="grandTotal">0.00 บาท</span>
        </div>
      </div>

      <!-- col2-3: หมายเหตุ + ปุ่ม action -->
      <div class="md:col-span-2 flex flex-col gap-4">
        <div class="card-custom">
          <label for="notes" class="block font-semibold mb-1">หมายเหตุสำหรับลูกค้า</label>
          <textarea id="notes" rows="2" class="textarea textarea-bordered w-full dark:bg-gray-700" placeholder="ข้อความอธิบายเพิ่มเติม..."></textarea>
        </div>
        <div class="card-custom">
          <label for="taxFiles" class="block font-semibold mb-1">แนบไฟล์ใบกำกับภาษี (ถ้ามี)</label>
          <input type="file" id="taxFiles" multiple class="file-input file-input-bordered w-full dark:bg-gray-700">
        </div>
        <div class="card-custom flex justify-between items-center">
          <button class="btn btn-sm btn-error">ยกเลิก</button>
          <div>
            <button class="btn btn-sm btn-secondary mr-2">บันทึกฉบับร่าง</button>
            <button class="btn btn-sm btn-success" id="approveInvoice">อนุมัติใบแจ้งหนี้</button>
          </div>
        </div>
      </div>
    </div>
  </div><!-- /container-main -->

  <!-- Footer -->
  <footer class="mt-6 text-center bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 py-3">
    © 2025 ระบบบัญชี. สงวนลิขสิทธิ์.
  </footer>

  <!-- Script เชื่อมต่อ Socket.IO -->
  <script>
    const socket = io(); // เรียกใช้จากไฟล์ socket.io.min.js
    socket.on('connect', () => {'
      console.log('Socket.IO connected (CreateInvoice Page).');'
    });
    socket.on('disconnect', () => {'
      console.warn('Socket.IO disconnected.');
    });
    // ตัวอย่าง event
    socket.on('invoiceNotify', (payload) => {'
      console.log('Realtime invoice notification:', payload);
      // สามารถทำอย่างอื่นได้ เช่น update UI
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {'
      loadCustomers();
      document.getElementById('addItem').addEventListener('click', addRow);'
      document.getElementById('approveInvoice').addEventListener('click', saveInvoice);'
      document.getElementById('shippingFeeInput').addEventListener('input', updateTotal);'
    });

    // โหลดรายชื่อลูกค้าจาก API
    async function loadCustomers() {
      try {
        const res = await fetch('/api/customers');
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Load customers failed');'
        const sel = document.getElementById('customerSelect');
        sel.innerHTML = json.data.map(c => `<option value="${c._id}">${c.first_name} ${c.last_name}</option>`).join('');'
      } catch (err) {
        console.error(err);
      }
    }

    // เพิ่มแถว
    function addRow() {
      const tbody = document.getElementById('invoiceItems');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="text" class="input input-bordered w-full dark:bg-gray-700 itemName" placeholder="สินค้า/บริการ">
        </td>
        <td>
          <input type="number" class="input input-bordered w-20 text-right dark:bg-gray-700 qty" value="1" min="1">
        </td>
        <td>
          <input type="number" class="input input-bordered w-24 text-right dark:bg-gray-700 price" value="0" step="0.01">
        </td>
        <td>
          <input type="number" class="input input-bordered w-24 text-right dark:bg-gray-700 discount" value="0" step="0.01">
        </td>
        <td>7%</td>
        <td class="netVal text-right">0.00</td>
        <td>
          <button class="btn btn-sm btn-outline btn-error" onclick="removeRow(this)">
            ลบ
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      // ผูก event updateTotal
      tr.querySelectorAll('input').forEach(inp => {'
        inp.addEventListener('input', updateTotal);
      });
      updateTotal();
    }

    // ลบแถว
    function removeRow(btn) {
      btn.closest('tr').remove();'
      updateTotal();
    }

    // คำนวณยอดรวม
    function updateTotal() {
      let subTotal = 0;
      let totalDiscount = 0;
      const rows = document.querySelectorAll('#invoiceItems tr');
      rows.forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const discount = parseFloat(row.querySelector('.discount').value) || 0;
        const lineTotal = (qty * price) - discount;
        row.querySelector('.netVal').textContent = lineTotal.toFixed(2);
        subTotal += lineTotal;
        totalDiscount += discount;
      });
      const shippingFee = parseFloat(document.getElementById('shippingFeeInput').value) || 0;
      const vat = (subTotal + shippingFee) * 0.07;
      const grand = subTotal + shippingFee + vat;

      document.getElementById('totalDiscount').textContent = totalDiscount.toFixed(2) + ' บาท';'
      document.getElementById('subTotal').textContent = subTotal.toFixed(2) + ' บาท';'
      document.getElementById('vatAmount').textContent = vat.toFixed(2) + ' บาท';'
      document.getElementById('grandTotal').textContent = grand.toFixed(2) + ' บาท';'
    }

    // บันทึกใบแจ้งหนี้
    async function saveInvoice() {
      const payload = {
        customer_id: document.getElementById('customerSelect').value,'
        billing_date: document.getElementById('billingDate').value,'
        due_date: document.getElementById('dueDate').value,'
        tel: document.getElementById('tel').value,'
        group_type: document.getElementById('groupType').value,'
        tax_mode: document.getElementById('taxMode').value,'
        notes: document.getElementById('notes').value,'
        items: Array.from(document.querySelectorAll('#invoiceItems tr')).map(row => {'
          return {
            name: row.querySelector('.itemName').value.trim(),'
            qty: parseFloat(row.querySelector('.qty').value) || 0,'
            price: parseFloat(row.querySelector('.price').value) || 0,'
            discount: parseFloat(row.querySelector('.discount').value) || 0'
          };
        }),
        shipping_fee: parseFloat(document.getElementById('shippingFeeInput').value) || 0,'
        total_amount: parseFloat(document.getElementById('grandTotal').textContent) || 0'
      };

      try {
        const res = await fetch('/api/invoice', {'
          method: 'POST','
          headers: { 'Content-Type': 'application/json' },'
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.error || 'Create invoice failed');'
        }
        alert('สร้างใบแจ้งหนี้เรียบร้อย!');'
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err.message);'
      }
    }
  </script>
</body>
</html>
