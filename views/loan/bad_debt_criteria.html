<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzM3ODNmZiIvPgo8cGF0aCBkPSJNOCAxMmg0djhoLTR2LTh6bTYgMGg0djhoLTR2LTh6bTYgMGg0djhoLTR2LTh6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS & DaisyUI (Production Build) -->
  <link href="/dist/output.css" rel="stylesheet" />
image.png
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
thai-accounting-maintenance
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Day.js with Thai locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
  <script>dayjs.locale('th');</script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>

  <!-- SweetAlert2 for better alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Utility Functions -->
  <script>
    function showToast(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
      if (typeof Swal !== 'undefined') {
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
        Toast.fire({ icon: type === 'error' ? 'error' : type === 'success' ? 'success' : 'info', title: message });
      }
    }
    let lottieAnimation = null;
    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }
    function formatCurrency(amount) { return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount || 0); }
    function formatDate(date) { return !date ? '-' : dayjs(date).format('DD/MM/YYYY'); }
    function formatDateTime(date) { return !date ? '-' : dayjs(date).format('DD/MM/YYYY HH:mm'); }
    window.showToast = showToast; window.showLoading = showLoading; window.formatCurrency = formatCurrency;
    window.formatDate = formatDate; window.formatDateTime = formatDateTime;
  </script>


  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Loan Sidebar JS -->
  <script src="/views/loan/loan-sidebar.js"></script>

  <script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      const isDark = savedTheme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', 'Prompt', sans-serif; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .spinner { border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite; }
    .Logo { max-width:100%;height:auto; }
    .status-paid { color: #16a34a; }
    .status-pending { color: #ca8a04; }
    .status-late { color: #dc2626; }
    
    /* Button styles like dashboard */
    .btn {
      @apply inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg transition-colors;
    }

    .btn-primary {
      @apply bg-blue-600 text-white hover:bg-blue-700;
    }

    .btn-secondary {
      @apply bg-gray-600 text-white hover:bg-gray-700;
    }
    
    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
    
    /* Sidebar styles handled by loan-sidebar.js and sidebar.css */
  </style>
</head>

<body class="w-full border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition 
             bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ loan-sidebar.js -->
  <div id="sidebarContainer"></div>

  <div class="min-h-screen flex">

    <!-- Main Content -->
    <main id="mainContent" class="flex-1 p-4 transition-all duration-300 ml-64">
      <!-- Breadcrumbs -->
      <nav class="text-sm breadcrumbs mb-4">
        <ul class="flex flex-wrap items-center space-x-2">
          <li><a href="loan_dashboard" class="text-blue-500 hover:text-blue-700">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
          <li class="flex items-center space-x-2">
            <i class="bi bi-chevron-right text-gray-400"></i>
            <span class="text-gray-600 dark:text-gray-300">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç</span>
          </li>
        </ul>
      </nav>

      <!-- Content Header -->
      <div class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 rounded-lg mb-6">
        <div class="max-w-full px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center py-4">
            <div class="flex items-center space-x-4">
              <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                <i class="bi bi-journal-check text-2xl text-blue-500"></i>
              </div>
              <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç, ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç, ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
              </div>
            </div>
            <!-- Action Button -->
            <div class="flex items-center space-x-3">
              <button type="button" id="btnOpenCriteriaModal"
                      class="btn btn-primary flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200">
                <i class="bi bi-gear-fill text-lg"></i>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>
              </button>
              <button type="button" id="btnRefreshData"
                      class="btn btn-secondary flex items-center space-x-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors duration-200">
                <i class="bi bi-arrow-clockwise text-lg"></i>
                <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Display Current Criteria -->
      <div id="currentCriteriaDisplay" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg p-6 mb-6 mt-6 hidden">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
          <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
              <p><strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç:</strong> <span id="displayAllowance">N/A</span>%</p>
              <p><strong>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç:</strong> <span id="displayDoubtful">N/A</span>%</p>
              <p><strong>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç:</strong> <span id="displayBadDebt">N/A</span>%</p>
              <p><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <span id="displayRepossession">N/A</span> ‡∏ö‡∏≤‡∏ó</p>
              <p><strong>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> <span id="displayPolicyNotes" class="whitespace-pre-wrap">N/A</span></p>
          </div>
      </div>

      <!-- Bad Debt Summary by Aging -->
      <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="bi bi-pie-chart-fill mr-2 text-blue-500"></i>
            ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
          </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="debtSummaryStats">
          <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="stat">
              <div class="stat-figure text-primary">
                <i class="bi bi-shield-check text-2xl"></i>
            </div>
              <div class="stat-title">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç</div>
              <div class="stat-value text-primary" id="allowanceStatValue">-</div>
              <div class="stat-desc" id="allowanceStatDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
          </div>

          <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="stat">
              <div class="stat-figure text-warning">
                <i class="bi bi-exclamation-triangle text-2xl"></i>
            </div>
              <div class="stat-title">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç</div>
              <div class="stat-value text-warning" id="doubtfulStatValue">-</div>
              <div class="stat-desc" id="doubtfulStatDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
          </div>

          <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="stat">
              <div class="stat-figure text-error">
                <i class="bi bi-x-circle text-2xl"></i>
            </div>
              <div class="stat-title">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç</div>
              <div class="stat-value text-error" id="badDebtStatValue">-</div>
              <div class="stat-desc" id="badDebtStatDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
          </div>
        </div>
        
        <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-4">
          <div class="stat">
            <div class="stat-figure text-secondary">
              <i class="bi bi-gear text-2xl"></i>
          </div>
            <div class="stat-title">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
            <div class="stat-value text-secondary" id="repossessionStatValue">-</div>
            <div class="stat-desc" id="repossessionStatDesc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>
        </div>

        <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="rounded-lg overflow-hidden mb-6">
          <canvas id="badDebtChart" height="200"></canvas>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm mb-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">
            <i class="bi bi-table mr-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡∏µ‡πâ
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ (‡∏ß‡∏±‡∏ô)
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (%)
                  </th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="agingSummaryTableBody">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="bi bi-hourglass-split text-4xl mb-2"></i>
                      <p class="text-lg font-medium mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...</p>
                      <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á ‡πÜ -->
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">
              <i class="bi bi-cash mr-2 text-green-500"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
            </h2>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-800 text-left">
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="expenseTableBody">
                  <!-- Dynamic content will be populated here by JavaScript -->
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                      <div class="flex flex-col items-center">
                        <i class="bi bi-hourglass-split text-4xl mb-2"></i>
                        <p class="text-lg font-medium mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢...</p>
                        <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</span>
                <span class="text-lg font-semibold text-red-600 dark:text-red-400" id="totalExpenseAmount">
                  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...
                </span>
              </div>
              <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç
              </div>
            </div>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ -->
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">
              <i class="bi bi-people mr-2 text-blue-500"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
            </h2>
            
            <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° -->
            <div class="h-48 mb-4">
              <canvas id="debtorsChart"></canvas>
            </div>
            
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ -->
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-800 text-left">
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</th>
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏£‡∏≤‡∏¢)</th>
                    <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="debtorSummaryTableBody">
                  <!-- Dynamic content will be populated here by JavaScript -->
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                      <div class="flex flex-col items-center">
                        <i class="bi bi-hourglass-split text-4xl mb-2"></i>
                        <p class="text-lg font-medium mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ...</p>
                        <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm mb-6">
          <div class="flex flex-wrap items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
              <i class="bi bi-exclamation-circle mr-2 text-red-500"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
            </h2>
            <div class="flex space-x-2 mt-2 md:mt-0">
              <div class="relative">
                <input type="text" id="overdueSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-200">
                <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              </div>
              <select id="overdueFilterSelect" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-200">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="30days">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 30 ‡∏ß‡∏±‡∏ô</option>
                <option value="60days">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 60 ‡∏ß‡∏±‡∏ô</option>
                <option value="90days">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ 90+ ‡∏ß‡∏±‡∏ô</option>
              </select>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto">
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-800 text-left">
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á</th>
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                  <th class="p-3 text-sm font-medium text-gray-700 dark:text-gray-300 text-center">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="overdueCustomersList">
                <!-- Dynamic content will be populated here by JavaScript -->
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                    <div class="flex flex-col items-center">
                      <i class="bi bi-hourglass-split text-4xl mb-2"></i>
                      <p class="text-lg font-medium mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞...</p>
                      <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="flex items-center justify-between mt-4" id="overduePagination">
            <div class="text-sm text-gray-600 dark:text-gray-400" id="overduePaginationInfo">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </div>
            <div class="flex space-x-1" id="overduePaginationButtons">
              <!-- Pagination will be populated dynamically -->
            </div>
          </div>
        </div>
        
        <!-- Footer / ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm mb-6">
          <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">
            <i class="bi bi-gear-fill mr-2 text-gray-600"></i>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button class="btn btn-primary" onclick="window.print()">
              <i class="bi bi-printer mr-2"></i>
              ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç
            </button>
            <button class="btn btn-secondary" onclick="refreshBadDebtData()">
              <i class="bi bi-arrow-repeat mr-2"></i>
              ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
            </button>
            <button class="btn btn-secondary" onclick="exportBadDebtData()">
              <i class="bi bi-file-earmark-excel mr-2"></i>
              ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Excel)
            </button>
          </div>
        </div>
      </div>

      <!-- Customer Data by Aging -->
      <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
            <i class="bi bi-people-fill mr-2 text-green-500"></i>
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
          </h2>
          <div class="flex space-x-2">
            <div class="relative">
              <input type="text" id="searchCustomer" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." 
                     class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-blue-500 focus:border-blue-500">
              <i class="bi bi-search absolute right-3 top-2.5 text-gray-400"></i>
            </div>
            <select id="filterCustomerStatus" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
              <option value="active">‡∏õ‡∏Å‡∏ï‡∏¥</option>
              <option value="allowance">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç</option>
              <option value="doubtful">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç</option>
              <option value="baddebt">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç</option>
            </select>
          </div>
        </div>
        
        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ (‡∏ß‡∏±‡∏ô)
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                </th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="customerList">
              <!-- Dynamic content will be populated here by JavaScript from loadCustomerData() -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 sm:px-6" id="customerPagination">
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div id="customerPaginationInfo">
              <p class="text-sm text-gray-700 dark:text-gray-300">
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </p>
            </div>
            <div id="customerPaginationButtons">
              <!-- Pagination will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Show loading initially
      showLoading(true);
    
      try {
        // Initialize loan sidebar first
        if (typeof initializeLoanSidebar === 'function') {
          initializeLoanSidebar();
        }

        // Check authentication
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          window.location.href = '/login';
          return;
        }

        // API headers configuration
        const headers = {
          'Authorization': 'Bearer ' + authToken,
          'Content-Type': 'application/json'
        };

        // Note: Dark mode, sidebar toggle, logout, and employee profile
        // are now handled by loan-sidebar.js

        // Global variables
        let customerData = [];
        let filteredCustomerData = [];
        let overdueCustomersData = [];
        let filteredOverdueData = [];
        let currentPage = 1;
        let currentOverduePage = 1;
        const itemsPerPage = 10;
        const overdueItemsPerPage = 10;

        // Bad Debt Criteria Logic - Modal only
        const criteriaForm = document.getElementById('modalBadDebtCriteriaForm');

        // Display elements for current criteria
        const currentCriteriaDisplaySection = document.getElementById('currentCriteriaDisplay');
        const displayAllowanceEl = document.getElementById('displayAllowance');
        const displayDoubtfulEl = document.getElementById('displayDoubtful');
        const displayBadDebtEl = document.getElementById('displayBadDebt');
        const displayRepossessionEl = document.getElementById('displayRepossession');
        const displayPolicyNotesEl = document.getElementById('displayPolicyNotes');

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç
        const DEFAULT_CRITERIA = {
          allowance: '5.00',
          doubtful: '2.00',
          badDebt: '1.00',
          repossession: '500',
          policyNotes: '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç:\n1. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç: ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ 60-90 ‡∏ß‡∏±‡∏ô\n2. ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç: ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ 90-180 ‡∏ß‡∏±‡∏ô\n3. ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç: ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 180 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏ô‡∏µ‡πâ'
        };

        // Load criteria from API
        async function loadCriteria() {
          try {
            showLoading(true);
            let criteria = DEFAULT_CRITERIA;
    
            try {
              // ‡πÄ‡∏ä‡πá‡∏Ñ auth token
              const authToken = localStorage.getItem('authToken');
              if (!authToken) {
                console.warn('No auth token found');
                throw new Error('No authentication token');
              }
    
              // Try multiple API endpoints in order of preference
              let response;
              const apiEndpoints = [
                '/api/loan/bad-debt-criteria',
                '/api/bad-debt/criteria',
                '/api/loan/bad-debt/criteria'
              ];
    
              let lastError;
              for (const endpoint of apiEndpoints) {
                try {
                  console.log(`üîÑ Trying API endpoint: ${endpoint}`);
                  response = await fetch(endpoint, {
                    headers: {
                      'Authorization': 'Bearer ' + authToken,
                      'Content-Type': 'application/json'
                    }
                  });
    
                  if (response.ok) {
                    console.log(`‚úÖ Successfully connected to: ${endpoint}`);
                    break;
                  } else if (response.status === 403) {
                    console.warn(`üîê Permission denied for: ${endpoint}`);
                    lastError = new Error(`Permission denied (403) for ${endpoint}`);
                    continue;
                  } else {
                    console.warn(`‚ö†Ô∏è Failed to connect to: ${endpoint} (${response.status})`);
                    lastError = new Error(`API returned ${response.status}: ${response.statusText}`);
                    continue;
                  }
                } catch (fetchError) {
                  console.warn(`‚ùå Network error for: ${endpoint}`, fetchError.message);
                  lastError = fetchError;
                  continue;
                }
              }
    
              if (!response || !response.ok) {
                throw lastError || new Error('All API endpoints failed');
              }
    
              if (response.ok) {
                const text = await response.text();
                if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                  const data = JSON.parse(text);
                  if (data.success && data.data) {
                    criteria = data.data;
                  }
                }
              } else {
                throw new Error(`API returned ${response.status}: ${response.statusText}`);
              }
            } catch (apiError) {
              // Handle different types of API errors
              if (apiError.message.includes('403')) {
                console.warn('üîê Permission denied for bad debt criteria API - using defaults');
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'info');
              } else if (apiError.message.includes('401')) {
                console.warn('üîë Authentication failed for bad debt criteria API - using defaults');
                showNotification('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
              } else {
                console.error('‚ùå API not available:', apiError.message);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç‡πÑ‡∏î‡πâ - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'warning');
              }
            }
    
            // Load criteria into display only (modal will be populated when opened)
            updateCurrentCriteriaDisplay(criteria);
          } catch (error) {
            console.error('Error loading criteria:', error);
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            const criteria = DEFAULT_CRITERIA;
            updateCurrentCriteriaDisplay(criteria);
          } finally {
            showLoading(false);
          }
        }

        // Load customer data for debt analysis
        async function loadCustomerData() {
          try {
            // ‡πÄ‡∏ä‡πá‡∏Ñ auth token
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
              console.warn('No auth token found');
              displayEmptyState();
              showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
              return;
            }
    
            const response = await fetch('/api/loan/dashboard/debtors', {
              headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              const text = await response.text();
              if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                const data = JSON.parse(text);
                if (data.success && data.data) {
                  customerData = data.data;
                  filteredCustomerData = [...customerData];
                  updateDebtStats(data.data);
                  updateExpenseTable(data.expenses || []);
                  updateDebtorSummaryTable(data.summary || {});
                  updateAgingSummaryTable(data.data);
                  updateOverdueCustomersList(data.data);
                  displayCustomerTable();
                  initializeCharts();
                  return;
                }
              }
            }
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
          } catch (error) {
            console.error('Error loading customer data:', error);
            displayEmptyState();
            showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
          }
        }

        // Update debt statistics
        function updateDebtStats(customers) {
          if (!customers || !Array.isArray(customers)) {
            console.warn('Invalid customers data for updateDebtStats');
            // Set default values when no data
            document.getElementById('allowanceStatValue').textContent = '0.00%';
            document.getElementById('allowanceStatDesc').textContent = '0 ‡∏£‡∏≤‡∏¢ | 0 ‡∏ö‡∏≤‡∏ó';
            document.getElementById('doubtfulStatValue').textContent = '0.00%';
            document.getElementById('doubtfulStatDesc').textContent = '0 ‡∏£‡∏≤‡∏¢ | 0 ‡∏ö‡∏≤‡∏ó';
            document.getElementById('badDebtStatValue').textContent = '0.00%';
            document.getElementById('badDebtStatDesc').textContent = '0 ‡∏£‡∏≤‡∏¢ | 0 ‡∏ö‡∏≤‡∏ó';
            document.getElementById('repossessionStatValue').textContent = '500 ‡∏ö‡∏≤‡∏ó/‡∏™‡∏±‡∏ç‡∏ç‡∏≤';
            document.getElementById('repossessionStatDesc').textContent = '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: 0 ‡∏ö‡∏≤‡∏ó';
            return;
          }
    
          const allowanceCustomers = customers.filter(c => c.status === 'allowance');
          const doubtfulCustomers = customers.filter(c => c.status === 'doubtful');
          const badDebtCustomers = customers.filter(c => c.status === 'baddebt');
    
          const allowanceAmount = allowanceCustomers.reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0);
          const doubtfulAmount = doubtfulCustomers.reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0);
          const badDebtAmount = badDebtCustomers.reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0);
    
          const totalAmount = customers.reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0);
    
          // Update stats cards
          document.getElementById('allowanceStatValue').textContent =
            totalAmount > 0 ? ((allowanceAmount / totalAmount) * 100).toFixed(2) + '%' : '0.00%';
          document.getElementById('allowanceStatDesc').textContent =
            `${allowanceCustomers.length} ‡∏£‡∏≤‡∏¢ | ${allowanceAmount.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`;
    
          document.getElementById('doubtfulStatValue').textContent =
            totalAmount > 0 ? ((doubtfulAmount / totalAmount) * 100).toFixed(2) + '%' : '0.00%';
          document.getElementById('doubtfulStatDesc').textContent =
            `${doubtfulCustomers.length} ‡∏£‡∏≤‡∏¢ | ${doubtfulAmount.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`;
    
          document.getElementById('badDebtStatValue').textContent =
            totalAmount > 0 ? ((badDebtAmount / totalAmount) * 100).toFixed(2) + '%' : '0.00%';
          document.getElementById('badDebtStatDesc').textContent =
            `${badDebtCustomers.length} ‡∏£‡∏≤‡∏¢ | ${badDebtAmount.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`;
    
          // Update repossession cost (use default if no input available)
          const repossessionCost = 500; // Default value
          const totalRepossessionCost = (allowanceCustomers.length + doubtfulCustomers.length + badDebtCustomers.length) * repossessionCost;
    
          document.getElementById('repossessionStatValue').textContent = `${repossessionCost.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó/‡∏™‡∏±‡∏ç‡∏ç‡∏≤`;
          document.getElementById('repossessionStatDesc').textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: ${totalRepossessionCost.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`;
        }

        // Update expense table
        function updateExpenseTable(expenses) {
          const tableBody = document.getElementById('expenseTableBody');
          const totalExpenseElement = document.getElementById('totalExpenseAmount');

          if (!expenses || !Array.isArray(expenses) || expenses.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  <div class="flex flex-col items-center">
                    <i class="bi bi-inbox text-4xl mb-2"></i>
                    <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                    <p class="text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                  </div>
                </td>
              </tr>
            `;
            if (totalExpenseElement) {
              totalExpenseElement.textContent = '‡∏ø 0';
            }
            return;
          }

          // Calculate total expenses
          const totalExpense = expenses.reduce((sum, expense) => sum + Math.max(0, expense.amount || 0), 0);

          const rows = expenses.map(expense => {
            const amount = Math.max(0, expense.amount || 0);
            const percentage = totalExpense > 0 ? ((amount / totalExpense) * 100).toFixed(1) : '0.0';

            return `
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                <td class="p-3 text-sm text-gray-700 dark:text-gray-300">
                  <div>
                    <div class="font-medium">${expense.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${percentage}% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                  </div>
                </td>
                <td class="p-3 text-sm text-gray-700 dark:text-gray-300 text-right font-medium">
                  ‡∏ø ${amount.toLocaleString('th-TH')}
                </td>
                <td class="p-3 text-right">
                  <span class="px-2 py-1 text-xs rounded-full ${expense.trend === 'up' ? 'bg-red-100 text-red-800' : expense.trend === 'down' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} dark:bg-gray-700 dark:text-gray-300">
                    <i class="bi bi-arrow-${expense.trend === 'up' ? 'up' : expense.trend === 'down' ? 'down' : 'dash'} mr-1"></i>
                    ${expense.changeText || '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á'}
                  </span>
                </td>
              </tr>
            `;
          }).join('');

          tableBody.innerHTML = rows;

          // Update total expense display
          if (totalExpenseElement) {
            totalExpenseElement.textContent = `‡∏ø ${totalExpense.toLocaleString('th-TH')}`;
          }
        }

        // Update debtor summary table
        function updateDebtorSummaryTable(summary) {
          const tableBody = document.getElementById('debtorSummaryTableBody');
          if (!summary || Object.keys(summary).length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  <div class="flex flex-col items-center">
                    <i class="bi bi-inbox text-4xl mb-2"></i>
                    <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>
                    <p class="text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }
    
          // Create summary from customerData if summary from API is not complete
          if (customerData && customerData.length > 0) {
            const generatedSummary = {
              '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥': {
                count: customerData.filter(c => c.status === 'active').length,
                amount: customerData.filter(c => c.status === 'active').reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0)
              },
              '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç': {
                count: customerData.filter(c => c.status === 'allowance').length,
                amount: customerData.filter(c => c.status === 'allowance').reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0)
              },
              '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç': {
                count: customerData.filter(c => c.status === 'doubtful').length,
                amount: customerData.filter(c => c.status === 'doubtful').reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0)
              },
              '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç': {
                count: customerData.filter(c => c.status === 'baddebt').length,
                amount: customerData.filter(c => c.status === 'baddebt').reduce((sum, c) => sum + Math.max(0, c.remainingAmount || 0), 0)
              }
            };
    
            const rows = Object.entries(generatedSummary).map(([type, data]) => `
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                <td class="p-3 text-sm text-gray-700 dark:text-gray-300">${type}</td>
                <td class="p-3 text-sm text-gray-700 dark:text-gray-300 text-center font-medium">${data.count || 0}</td>
                <td class="p-3 text-sm text-gray-700 dark:text-gray-300 text-right font-medium">‡∏ø ${Math.max(0, data.amount || 0).toLocaleString('th-TH')}</td>
              </tr>
            `).join('');
    
            tableBody.innerHTML = rows;
          } else {
            // Fallback to API summary with safe property access
            const rows = Object.entries(summary).map(([type, data]) => {
              const count = data && typeof data === 'object' ? (data.count || 0) : 0;
              const amount = data && typeof data === 'object' ? Math.max(0, data.amount || 0) : 0;
    
              return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                  <td class="p-3 text-sm text-gray-700 dark:text-gray-300">${type}</td>
                  <td class="p-3 text-sm text-gray-700 dark:text-gray-300 text-center font-medium">${count}</td>
                  <td class="p-3 text-sm text-gray-700 dark:text-gray-300 text-right font-medium">‡∏ø ${Math.max(0, amount).toLocaleString('th-TH')}</td>
                </tr>
              `;
            }).join('');
    
            tableBody.innerHTML = rows;
          }
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        // Setup modal event handlers
        function setupModalHandlers() {
          const modal = document.getElementById('criteriaModal');
          const openBtn = document.getElementById('btnOpenCriteriaModal');
          const closeBtn = document.getElementById('closeCriteriaModal');
          const cancelBtn = document.getElementById('cancelCriteriaModal');
          const saveBtn = document.getElementById('saveCriteriaModal');
          const refreshBtn = document.getElementById('btnRefreshData');
          const modalForm = document.getElementById('modalBadDebtCriteriaForm');

          // Open modal
          if (openBtn) {
            openBtn.addEventListener('click', openCriteriaModal);
          }

          // Close modal events
          if (closeBtn) {
            closeBtn.addEventListener('click', closeCriteriaModal);
          }
          if (cancelBtn) {
            cancelBtn.addEventListener('click', closeCriteriaModal);
          }

          // Click outside modal to close
          if (modal) {
            modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                closeCriteriaModal();
              }
            });
          }

          // Refresh data button
          if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
              showLoading(true);
              loadCriteria();
              loadCustomerData();
              showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß', 'success');
            });
          }

          // Save criteria
          if (modalForm) {
            modalForm.addEventListener('submit', handleModalSave);
          }

          // ESC key to close modal
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeCriteriaModal();
            }
          });
        }

        // Open modal and load current criteria
        async function openCriteriaModal() {
          const modal = document.getElementById('criteriaModal');
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling

          // Load current criteria into modal
          try {
            showLoading(true);
            await loadCriteriaIntoModal();
            showLoading(false);
          } catch (error) {
            console.error('Error loading criteria into modal:', error);
            showLoading(false);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
          }
        }

        // Close modal
        function closeCriteriaModal() {
          const modal = document.getElementById('criteriaModal');
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }

        // Load current criteria into modal form
        async function loadCriteriaIntoModal() {
          try {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
            }

            // Try multiple API endpoints in order of preference
            let response;
            const apiEndpoints = [
              '/api/loan/bad-debt-criteria',
              '/api/bad-debt/criteria',
              '/api/loan/bad-debt/criteria'
            ];
    
            let lastError;
            for (const endpoint of apiEndpoints) {
              try {
                response = await fetch(endpoint, {
                  method: 'GET',
                  headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                  }
                });
    
                if (response.ok) {
                  break;
                } else {
                  lastError = new Error(`API returned ${response.status}: ${response.statusText}`);
                  continue;
                }
              } catch (fetchError) {
                lastError = fetchError;
                continue;
              }
            }

            if (response && response.ok) {
              const text = await response.text();
              if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                const data = JSON.parse(text);
                if (data.success && data.data) {
                  const criteria = data.data;

                  // Populate modal form fields
                  document.getElementById('modalAllowanceForDoubtfulAccounts').value = criteria.allowance || DEFAULT_CRITERIA.allowance;
                  document.getElementById('modalDoubtfulAccounts').value = criteria.doubtful || DEFAULT_CRITERIA.doubtful;
                  document.getElementById('modalBadDebt').value = criteria.badDebt || DEFAULT_CRITERIA.badDebt;
                  document.getElementById('modalRepossessionCost').value = criteria.repossession || DEFAULT_CRITERIA.repossession;
                  document.getElementById('modalPolicyNotes').value = criteria.policyNotes || DEFAULT_CRITERIA.policyNotes;
                  return;
                }
              }
            }
    
            throw lastError || new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÑ‡∏î‡πâ');
          } catch (error) {
            console.error('Error loading criteria:', error);
            // Use default values
            document.getElementById('modalAllowanceForDoubtfulAccounts').value = DEFAULT_CRITERIA.allowance;
            document.getElementById('modalDoubtfulAccounts').value = DEFAULT_CRITERIA.doubtful;
            document.getElementById('modalBadDebt').value = DEFAULT_CRITERIA.badDebt;
            document.getElementById('modalRepossessionCost').value = DEFAULT_CRITERIA.repossession;
            document.getElementById('modalPolicyNotes').value = DEFAULT_CRITERIA.policyNotes;
          }
        }

        // Handle modal save
        async function handleModalSave(e) {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);

          const criteria = {
            allowance: parseFloat(formData.get('allowanceForDoubtfulAccounts')) || 5.0,
            doubtful: parseFloat(formData.get('doubtfulAccounts')) || 2.0,
            badDebt: parseFloat(formData.get('badDebt')) || 1.0,
            repossession: parseFloat(formData.get('repossessionCost')) || 500,
            notes: formData.get('policyNotes') || ''
          };

          // Validate criteria
          if (criteria.allowance < 0 || criteria.allowance > 100) {
            showToast('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-100%', 'error');
            return;
          }
          if (criteria.doubtful < 0 || criteria.doubtful > 100) {
            showToast('‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-100%', 'error');
            return;
          }
          if (criteria.badDebt < 0 || criteria.badDebt > 100) {
            showToast('‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0-100%', 'error');
            return;
          }
          if (criteria.repossession < 0) {
            showToast('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö', 'error');
            return;
          }

          try {
            showLoading(true);

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
            }

            // Try multiple API endpoints for saving
            let response;
            const apiEndpoints = [
              '/api/loan/bad-debt-criteria',
              '/api/bad-debt/criteria',
              '/api/loan/bad-debt/criteria'
            ];
    
            let lastError;
            for (const endpoint of apiEndpoints) {
              try {
                response = await fetch(endpoint, {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(criteria)
                });
    
                if (response.ok) {
                  break;
                } else {
                  lastError = new Error(`API returned ${response.status}: ${response.statusText}`);
                  continue;
                }
              } catch (fetchError) {
                lastError = fetchError;
                continue;
              }
            }

            if (response && response.ok) {
              const text = await response.text();
              let result;
    
              if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                result = JSON.parse(text);
              } else {
                result = { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' };
              }
    
              if (result.success !== false) {
                showLoading(false);
                closeCriteriaModal();
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');

                // Reload data to reflect changes
                await loadCriteria();
                await loadCustomerData();
              } else {
                throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
              }
            } else {
              throw lastError || new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            }
          } catch (error) {
            console.error('Error saving criteria:', error);
            showLoading(false);
            showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÑ‡∏î‡πâ: ' + error.message, 'error');
          }
        }

        // Update aging summary table
        function updateAgingSummaryTable(customers) {
          const tableBody = document.getElementById('agingSummaryTableBody');

          if (!customers || !Array.isArray(customers) || customers.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  <div class="flex flex-col items-center">
                    <i class="bi bi-info-circle text-4xl mb-2"></i>
                    <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>
                    <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                  </div>
                </td>
              </tr>
            `;
            return;
          }

          // Define aging categories
          const agingCategories = [
            {
              name: '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥',
              status: 'active',
              ageRange: '0-59 ‡∏ß‡∏±‡∏ô',
              minAge: 0,
              maxAge: 59,
              riskLevel: '‡∏ï‡πà‡∏≥',
              riskColor: 'bg-green-100 text-green-800',
              description: '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á'
            },
            {
              name: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç',
              status: 'allowance',
              ageRange: '60-89 ‡∏ß‡∏±‡∏ô',
              minAge: 60,
              maxAge: 89,
              riskLevel: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
              riskColor: 'bg-yellow-100 text-yellow-800',
              description: '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á'
            },
            {
              name: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç',
              status: 'doubtful',
              ageRange: '90-179 ‡∏ß‡∏±‡∏ô',
              minAge: 90,
              maxAge: 179,
              riskLevel: '‡∏™‡∏π‡∏á',
              riskColor: 'bg-orange-100 text-orange-800',
              description: '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á'
            },
            {
              name: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç',
              status: 'baddebt',
              ageRange: '180+ ‡∏ß‡∏±‡∏ô',
              minAge: 180,
              maxAge: Infinity,
              riskLevel: '‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å',
              riskColor: 'bg-red-100 text-red-800',
              description: '‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ'
            }
          ];

          // Calculate data for each category
          const totalAmount = customers.reduce((sum, c) => sum + (c.remainingAmount || 0), 0);

          const categoryData = agingCategories.map(category => {
            // Filter customers by status and age
            const categoryCustomers = customers.filter(customer => {
              const ageInDays = customer.ageInDays || 0;
              const hasStatus = customer.status === category.status;
              const hasAge = ageInDays >= category.minAge && ageInDays <= category.maxAge;

              // For active customers, also check age range
              if (category.status === 'active') {
                return hasStatus && ageInDays < 60;
              }

              // For other statuses, check both status and age
              return hasStatus || hasAge;
            });

            const count = categoryCustomers.length;
            const amount = categoryCustomers.reduce((sum, c) => sum + (c.remainingAmount || 0), 0);
            const percentage = totalAmount > 0 ? ((amount / totalAmount) * 100).toFixed(1) : '0.0';

            return {
              ...category,
              count,
              amount,
              percentage
            };
          });

          // Generate table rows
          const rows = categoryData.map(data => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-4 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900 dark:text-white">
                  ${data.name}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  ${data.description}
                </div>
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                ${data.ageRange}
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white text-right font-medium">
                ${data.count.toLocaleString('th-TH')} ‡∏£‡∏≤‡∏¢
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white text-right font-medium">
                ‡∏ø ${data.amount.toLocaleString('th-TH')}
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-right">
                ${data.percentage}%
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-center">
                <span class="px-3 py-1 text-xs font-semibold rounded-full ${data.riskColor}">
                  ${data.riskLevel}
                </span>
              </td>
            </tr>
          `).join('');

          // Add total row
          const totalRow = `
            <tr class="bg-gray-50 dark:bg-gray-700 border-t-2 border-gray-300 dark:border-gray-600">
              <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">
                ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white text-right">
                ${customers.length.toLocaleString('th-TH')} ‡∏£‡∏≤‡∏¢
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white text-right">
                ‡∏ø ${totalAmount.toLocaleString('th-TH')}
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white text-right">
                100.0%
              </td>
              <td class="px-4 py-4 whitespace-nowrap text-center">
                <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                  ‡∏™‡∏£‡∏∏‡∏õ
                </span>
              </td>
            </tr>
          `;

          tableBody.innerHTML = rows + totalRow;
        }

        // Update overdue customers list
        function updateOverdueCustomersList(customers) {
          if (!customers || !Array.isArray(customers)) {
            overdueCustomersData = [];
            filteredOverdueData = [];
            displayOverdueCustomers();
            return;
          }

          // Filter for overdue customers (those with positive ageInDays indicating they're past due)
          overdueCustomersData = customers.filter(customer => {
            const ageInDays = customer.ageInDays || 0;
            const isOverdue = ageInDays > 0 && customer.remainingAmount > 0;
            const isRiskyStatus = ['allowance', 'doubtful', 'baddebt'].includes(customer.status);
            return isOverdue || isRiskyStatus;
          });

          // Sort by risk level and age
          overdueCustomersData.sort((a, b) => {
            const riskPriority = { 'baddebt': 4, 'doubtful': 3, 'allowance': 2, 'active': 1 };
            const aPriority = riskPriority[a.status] || 1;
            const bPriority = riskPriority[b.status] || 1;

            if (aPriority !== bPriority) {
              return bPriority - aPriority; // Higher risk first
            }

            return (b.ageInDays || 0) - (a.ageInDays || 0); // Older debts first
          });

          filteredOverdueData = [...overdueCustomersData];
          currentOverduePage = 1;
          displayOverdueCustomers();
        }

        // Display overdue customers with pagination
        function displayOverdueCustomers() {
          const overdueList = document.getElementById('overdueCustomersList');
          const overduePaginationInfo = document.getElementById('overduePaginationInfo');

          if (filteredOverdueData.length === 0) {
            overdueList.innerHTML = `
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  <div class="flex flex-col items-center">
                    <i class="bi bi-check-circle text-4xl mb-2 text-green-500"></i>
                    <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <p class="text-sm">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p>
                  </div>
                </td>
              </tr>
            `;
            overduePaginationInfo.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
            return;
          }

          // Pagination
          const startIndex = (currentOverduePage - 1) * overdueItemsPerPage;
          const endIndex = startIndex + overdueItemsPerPage;
          const currentData = filteredOverdueData.slice(startIndex, endIndex);

          // Generate table rows
          const rows = currentData.map(customer => {
            const ageInDays = customer.ageInDays || 0;
            const remainingAmount = Math.max(0, customer.remainingAmount || 0);

            // Determine risk level
            let riskLevel = '‡∏ï‡πà‡∏≥';
            let riskColor = 'bg-green-100 text-green-800';

            if (customer.status === 'baddebt' || ageInDays > 180) {
              riskLevel = '‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å';
              riskColor = 'bg-red-100 text-red-800';
            } else if (customer.status === 'doubtful' || ageInDays > 90) {
              riskLevel = '‡∏™‡∏π‡∏á';
              riskColor = 'bg-orange-100 text-orange-800';
            } else if (customer.status === 'allowance' || ageInDays > 60) {
              riskLevel = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
              riskColor = 'bg-yellow-100 text-yellow-800';
            } else if (ageInDays > 30) {
              riskLevel = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
              riskColor = 'bg-yellow-100 text-yellow-800';
            }

            // Format overdue period
            let overduePeriod = '‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
            if (ageInDays > 0) {
              if (ageInDays >= 365) {
                overduePeriod = `${Math.floor(ageInDays / 365)} ‡∏õ‡∏µ ${ageInDays % 365} ‡∏ß‡∏±‡∏ô`;
              } else if (ageInDays >= 30) {
                overduePeriod = `${Math.floor(ageInDays / 30)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${ageInDays % 30} ‡∏ß‡∏±‡∏ô`;
              } else {
                overduePeriod = `${ageInDays} ‡∏ß‡∏±‡∏ô`;
              }
            }

            return `
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="p-3 text-sm text-gray-900 dark:text-white font-medium">
                  ${customer.contractNo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </td>
                <td class="p-3 text-sm text-gray-900 dark:text-white">
                  ${customer.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </td>
                <td class="p-3 text-sm text-gray-900 dark:text-white text-right font-medium">
                  ‡∏ø ${remainingAmount.toLocaleString('th-TH')}
                </td>
                <td class="p-3 text-sm text-gray-500 dark:text-gray-300">
                  ${overduePeriod}
                </td>
                <td class="p-3">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full ${riskColor}">
                    ${riskLevel}
                  </span>
                </td>
                <td class="p-3 text-center">
                  <div class="flex justify-center space-x-2">
                    <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400"
                            onclick="viewCustomerDetail('${customer.contractNo}')"
                            title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="text-green-600 hover:text-green-800 dark:text-green-400"
                            onclick="contactCustomer('${customer.contractNo}')"
                            title="‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                      <i class="bi bi-telephone"></i>
                    </button>
                    <button class="text-orange-600 hover:text-orange-800 dark:text-orange-400"
                            onclick="scheduleFollowUp('${customer.contractNo}')"
                            title="‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°">
                      <i class="bi bi-calendar-plus"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');

          overdueList.innerHTML = rows;

          // Update pagination info
          const totalItems = filteredOverdueData.length;
          const totalPages = Math.ceil(totalItems / overdueItemsPerPage);
          const startItem = startIndex + 1;
          const endItem = Math.min(endIndex, totalItems);

          overduePaginationInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startItem}-${endItem} ‡∏à‡∏≤‡∏Å ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

          // Update pagination buttons
          updateOverduePagination(totalPages);
        }

        // Update overdue pagination buttons
        function updateOverduePagination(totalPages) {
          const paginationButtons = document.getElementById('overduePaginationButtons');

          if (totalPages <= 1) {
            paginationButtons.innerHTML = '';
            return;
          }

          let buttons = '';

          // Previous button
          buttons += `
            <button class="px-3 py-1 rounded border ${currentOverduePage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                    onclick="changeOverduePage(${currentOverduePage - 1})"
                    ${currentOverduePage === 1 ? 'disabled' : ''}>
              <i class="bi bi-chevron-left"></i>
            </button>
          `;

          // Page numbers
          for (let i = 1; i <= totalPages; i++) {
            if (i === currentOverduePage) {
              buttons += `
                <button class="px-3 py-1 rounded border bg-blue-500 text-white">
                  ${i}
                </button>
              `;
            } else {
              buttons += `
                <button class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50"
                        onclick="changeOverduePage(${i})">
                  ${i}
                </button>
              `;
            }
          }

          // Next button
          buttons += `
            <button class="px-3 py-1 rounded border ${currentOverduePage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                    onclick="changeOverduePage(${currentOverduePage + 1})"
                    ${currentOverduePage === totalPages ? 'disabled' : ''}>
              <i class="bi bi-chevron-right"></i>
            </button>
          `;

          paginationButtons.innerHTML = buttons;
        }

        // Change overdue page
        window.changeOverduePage = function(page) {
          const totalPages = Math.ceil(filteredOverdueData.length / overdueItemsPerPage);
          if (page >= 1 && page <= totalPages) {
            currentOverduePage = page;
            displayOverdueCustomers();
          }
        };

        // Filter overdue customers
        function filterOverdueCustomers() {
          const searchTerm = document.getElementById('overdueSearchInput')?.value.toLowerCase() || '';
          const filterValue = document.getElementById('overdueFilterSelect')?.value || 'all';

          filteredOverdueData = overdueCustomersData.filter(customer => {
            // Search filter
            const customerName = (customer.customerName || '').toLowerCase();
            const contractNo = (customer.contractNo || '').toLowerCase();
            const matchesSearch = customerName.includes(searchTerm) || contractNo.includes(searchTerm);

            // Age filter
            const ageInDays = customer.ageInDays || 0;
            let matchesFilter = true;

            switch (filterValue) {
              case '30days':
                matchesFilter = ageInDays >= 30 && ageInDays < 60;
                break;
              case '60days':
                matchesFilter = ageInDays >= 60 && ageInDays < 90;
                break;
              case '90days':
                matchesFilter = ageInDays >= 90;
                break;
              case 'all':
              default:
                matchesFilter = true;
                break;
            }

            return matchesSearch && matchesFilter;
          });

          currentOverduePage = 1;
          displayOverdueCustomers();
        }

        // Save criteria function is now handled by modal save handler

        function updateCurrentCriteriaDisplay(criteria) {
            const formatPercent = (val) => val ? parseFloat(val).toFixed(2) : 'N/A';
            const formatCurrency = (val) => val ? Math.max(0, parseFloat(val) || 0).toLocaleString('th-TH') : 'N/A';

            displayAllowanceEl.textContent = formatPercent(criteria.allowance);
            displayDoubtfulEl.textContent = formatPercent(criteria.doubtful);
            displayBadDebtEl.textContent = formatPercent(criteria.badDebt);
            displayRepossessionEl.textContent = formatCurrency(criteria.repossession);
            displayPolicyNotesEl.textContent = criteria.policyNotes || 'N/A';

            // Show or hide the display section based on whether there's data
            const hasData = Object.values(criteria).some(value => value && value.toString().trim() !== '');
            if (hasData) {
                currentCriteriaDisplaySection.classList.remove('hidden');
            } else {
                currentCriteriaDisplaySection.classList.add('hidden');
            }
        }

        // Display customer table
        function displayCustomerTable() {
          const customerList = document.getElementById('customerList');
    
          if (filteredCustomerData.length === 0) {
            customerList.innerHTML = `
              <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  <div class="flex flex-col items-center">
                    <i class="bi bi-inbox text-4xl mb-2"></i>
                    <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                    <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                </div>
                </td>
              </tr>
            `;
            return;
          }

          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const currentData = filteredCustomerData.slice(startIndex, endIndex);

          const rows = currentData.map(customer => {
            const statusInfo = getStatusInfo(customer.status);
            const allowanceAmount = Math.max(0, customer.allowance || 0);
    
            return `
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                  ${customer.contractNo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                  ${customer.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                  ${customer.productName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white text-right">
                  ‡∏ø ${Math.max(0, customer.remainingAmount || 0).toLocaleString('th-TH')}
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 text-center">
                  ${customer.ageInDays || 0} ‡∏ß‡∏±‡∏ô
                </td>
                <td class="px-4 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.bgColor} ${statusInfo.textColor}">
                    ${statusInfo.text}
                  </span>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white text-right">
                  ‡∏ø ${Math.max(0, allowanceAmount).toLocaleString('th-TH', {minimumFractionDigits: 2})}
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                  <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-2" onclick="viewCustomerDetail('${customer.contractNo}')">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300" onclick="contactCustomer('${customer.contractNo}')">
                    <i class="bi bi-telephone"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join('');

          customerList.innerHTML = rows;
          updatePagination();
        }

        // Get status information for display
        function getStatusInfo(status) {
          switch (status) {
            case 'active':
              return { text: '‡∏õ‡∏Å‡∏ï‡∏¥', bgColor: 'bg-green-100', textColor: 'text-green-800' };
            case 'allowance':
              return { text: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç', bgColor: 'bg-yellow-100', textColor: 'text-yellow-800' };
            case 'doubtful':
              return { text: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç', bgColor: 'bg-orange-100', textColor: 'text-orange-800' };
            case 'baddebt':
              return { text: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç', bgColor: 'bg-red-100', textColor: 'text-red-800' };
            default:
              return { text: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', bgColor: 'bg-gray-100', textColor: 'text-gray-800' };
          }
        }

        // Update pagination
        function updatePagination() {
          const totalPages = Math.ceil(filteredCustomerData.length / itemsPerPage);
          const paginationInfo = document.getElementById('customerPaginationInfo');
          const paginationButtons = document.getElementById('customerPaginationButtons');
    
          if (filteredCustomerData.length === 0) {
            paginationInfo.innerHTML = '<p class="text-sm text-gray-700 dark:text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            paginationButtons.innerHTML = '';
            return;
          }
    
          const startIndex = (currentPage - 1) * itemsPerPage + 1;
          const endIndex = Math.min(currentPage * itemsPerPage, filteredCustomerData.length);
    
          paginationInfo.innerHTML = `
            <p class="text-sm text-gray-700 dark:text-gray-300">
              ‡πÅ‡∏™‡∏î‡∏á <span class="font-medium">${startIndex}</span> ‡∏ñ‡∏∂‡∏á <span class="font-medium">${endIndex}</span> ‡∏à‡∏≤‡∏Å <span class="font-medium">${filteredCustomerData.length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </p>
          `;
    
          if (totalPages <= 1) {
            paginationButtons.innerHTML = '';
            return;
          }
    
          let buttonsHTML = '';
    
          // Previous button
          buttonsHTML += `
            <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">
              <i class="bi bi-chevron-left"></i>
            </button>
          `;
    
          // Page numbers
          for (let i = 1; i <= Math.min(totalPages, 5); i++) {
            const isActive = i === currentPage;
            buttonsHTML += `
              <button onclick="changePage(${i})" 
                      class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium ${isActive ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-200' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-white'} hover:bg-gray-50 dark:hover:bg-gray-700">
                ${i}
              </button>
            `;
          }
    
          // Next button
          buttonsHTML += `
            <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
              <i class="bi bi-chevron-right"></i>
            </button>
          `;
    
          paginationButtons.innerHTML = `<nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">${buttonsHTML}</nav>`;
        }

        // Change page
        window.changePage = function(page) {
          const totalPages = Math.ceil(filteredCustomerData.length / itemsPerPage);
          if (page >= 1 && page <= totalPages) {
            currentPage = page;
            displayCustomerTable();
          }
        };

        // Display empty state
        function displayEmptyState() {
          const customerList = document.getElementById('customerList');
          customerList.innerHTML = `
            <tr>
              <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                <div class="flex flex-col items-center">
                  <i class="bi bi-exclamation-triangle text-4xl mb-2"></i>
                  <p class="text-lg font-medium mb-1">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                  <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
              </td>
            </tr>
          `;
    
          // Clear stats
          document.getElementById('allowanceStatValue').textContent = '-';
          document.getElementById('allowanceStatDesc').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          document.getElementById('doubtfulStatValue').textContent = '-';
          document.getElementById('doubtfulStatDesc').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          document.getElementById('badDebtStatValue').textContent = '-';
          document.getElementById('badDebtStatDesc').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          document.getElementById('repossessionStatValue').textContent = '-';
          document.getElementById('repossessionStatDesc').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }

        // Wait for Chart.js to load
        function waitForChart(callback, maxAttempts = 10) {
          if (typeof Chart !== 'undefined') {
            callback();
          } else if (maxAttempts > 0) {
            setTimeout(() => waitForChart(callback, maxAttempts - 1), 100);
                        } else {
            console.warn('Chart.js failed to load after waiting');
          }
        }

        // Initialize charts
        function initializeCharts() {
          // Use waitForChart to ensure Chart.js is loaded
          waitForChart(() => {
            // Bad debt chart
            const badDebtCtx = document.getElementById('badDebtChart');
            if (badDebtCtx) {
              try {
                // Properly destroy existing chart
                if (window.badDebtChart && typeof window.badDebtChart.destroy === 'function') {
                  window.badDebtChart.destroy();
                }
    
                const chartData = getChartData();
                window.badDebtChart = new Chart(badDebtCtx, {
                  type: 'doughnut',
                  data: chartData,
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'bottom',
                        labels: {
                          usePointStyle: true,
                          padding: 15,
                          font: {
                            size: 12
                          }
                        }
                      },
                      tooltip: {
                        callbacks: {
                          label: function(context) {
                            const dataset = context.dataset;
                            const amounts = dataset.amounts || dataset.data;
                            const amount = amounts[context.dataIndex];
                            const total = amounts.reduce((sum, val) => sum + val, 0);
                            const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : '0.0';

                            return [
                              context.label,
                              `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø${amount.toLocaleString('th-TH')}`,
                              `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô: ${percentage}%`
                            ];
                          }
                        },
                        titleFont: {
                          size: 14
                        },
                        bodyFont: {
                          size: 12
                        },
                        padding: 12
                      }
                    },
                    elements: {
                      arc: {
                        borderWidth: 2
                      }
                    }
                  }
                });
              } catch (error) {
                console.error('Error initializing bad debt chart:', error);
                // Show fallback message in chart container
                badDebtCtx.parentElement.innerHTML = `
                  <div class="flex items-center justify-center h-48 text-gray-500">
                    <div class="text-center">
                      <i class="bi bi-bar-chart text-4xl mb-2"></i>
                      <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ</p>
                    </div>
                  </div>
                `;
              }
            }
    
            // Debtors trend chart
        const debtorsCtx = document.getElementById('debtorsChart');
            if (debtorsCtx) {
              try {
                // Properly destroy existing chart
                if (window.debtorsChart && typeof window.debtorsChart.destroy === 'function') {
                  window.debtorsChart.destroy();
                }
    
                const trendData = getTrendData();
                window.debtorsChart = new Chart(debtorsCtx, {
            type: 'line',
                  data: trendData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
                    scales: {
                      y: {
                        beginAtZero: true
                      }
                    },
                    plugins: {
                      legend: {
                    display: false
                  }
                    }
                  }
                });
              } catch (error) {
                console.error('Error initializing debtors chart:', error);
                // Show fallback message in chart container
                debtorsCtx.parentElement.innerHTML = `
                  <div class="flex items-center justify-center h-48 text-gray-500">
                    <div class="text-center">
                      <i class="bi bi-graph-up text-4xl mb-2"></i>
                      <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ</p>
                    </div>
                  </div>
                `;
              }
            }
          });
        }
    
        // Get chart data

        // Get chart data for bad debt doughnut chart
        function getChartData() {
          if (!customerData || customerData.length === 0) {
            return {
              labels: ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
              datasets: [{
                data: [1],
                backgroundColor: ['#e5e7eb'],
                borderColor: ['#d1d5db'],
                borderWidth: 1
              }]
            };
          }

          // Count customers by status
          const statusCounts = {
            'active': customerData.filter(c => c.status === 'active').length,
            'allowance': customerData.filter(c => c.status === 'allowance').length,
            'doubtful': customerData.filter(c => c.status === 'doubtful').length,
            'baddebt': customerData.filter(c => c.status === 'baddebt').length
          };

          // Calculate amounts by status
          const statusAmounts = {
            'active': customerData.filter(c => c.status === 'active').reduce((sum, c) => sum + (c.remainingAmount || 0), 0),
            'allowance': customerData.filter(c => c.status === 'allowance').reduce((sum, c) => sum + (c.remainingAmount || 0), 0),
            'doubtful': customerData.filter(c => c.status === 'doubtful').reduce((sum, c) => sum + (c.remainingAmount || 0), 0),
            'baddebt': customerData.filter(c => c.status === 'baddebt').reduce((sum, c) => sum + (c.remainingAmount || 0), 0)
          };

          const labels = [];
          const data = [];
          const amounts = [];
          const backgroundColors = [];
          const borderColors = [];

          // Add data for each status that has customers
          if (statusCounts.active > 0) {
            labels.push(`‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏Å‡∏ï‡∏¥ (${statusCounts.active} ‡∏£‡∏≤‡∏¢)`);
            data.push(statusAmounts.active);
            amounts.push(statusAmounts.active);
            backgroundColors.push('rgba(34, 197, 94, 0.8)'); // Green
            borderColors.push('rgb(34, 197, 94)');
          }

          if (statusCounts.allowance > 0) {
            labels.push(`‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç (${statusCounts.allowance} ‡∏£‡∏≤‡∏¢)`);
            data.push(statusAmounts.allowance);
            amounts.push(statusAmounts.allowance);
            backgroundColors.push('rgba(251, 191, 36, 0.8)'); // Yellow
            borderColors.push('rgb(251, 191, 36)');
          }

          if (statusCounts.doubtful > 0) {
            labels.push(`‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç (${statusCounts.doubtful} ‡∏£‡∏≤‡∏¢)`);
            data.push(statusAmounts.doubtful);
            amounts.push(statusAmounts.doubtful);
            backgroundColors.push('rgba(249, 115, 22, 0.8)'); // Orange
            borderColors.push('rgb(249, 115, 22)');
          }

          if (statusCounts.baddebt > 0) {
            labels.push(`‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç (${statusCounts.baddebt} ‡∏£‡∏≤‡∏¢)`);
            data.push(statusAmounts.baddebt);
            amounts.push(statusAmounts.baddebt);
            backgroundColors.push('rgba(239, 68, 68, 0.8)'); // Red
            borderColors.push('rgb(239, 68, 68)');
          }

          // If no data, show placeholder
          if (data.length === 0) {
            return {
              labels: ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ'],
              datasets: [{
                data: [1],
                backgroundColor: ['#e5e7eb'],
                borderColor: ['#d1d5db'],
                borderWidth: 1
              }]
            };
          }

          return {
            labels: labels,
            datasets: [{
              data: data,
              amounts: amounts, // Store amounts for tooltip
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 2,
              hoverBorderWidth: 3
            }]
          };
        }

        // Get trend data
        function getTrendData() {
          const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.'];
          const data = customerData.length > 0 ?
            [20, 35, 25, 40, 30, customerData.length] :
            [0, 0, 0, 0, 0, 0];
    
          return {
            labels: months,
            datasets: [{
              label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ',
              data: data,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            }]
          };
        }

        // Show notification
        function showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          const bgColor = type === 'error' ? 'bg-red-100 border-red-400 text-red-700' :
                          type === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                          'bg-blue-100 border-blue-400 text-blue-700';
    
          notification.className = `fixed top-4 right-4 ${bgColor} px-4 py-3 rounded z-50 max-w-md`;
          notification.innerHTML = `
            <div class="flex items-center">
              <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
              <span>${message}</span>
              <button class="ml-4 text-current hover:opacity-75" onclick="this.parentElement.parentElement.remove()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          `;
          document.body.appendChild(notification);
    
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 5000);
        }

        // Filter customers
        function filterCustomers() {
          const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
          const statusFilter = document.getElementById('filterCustomerStatus').value;
    
          filteredCustomerData = customerData.filter(customer => {
            const matchesSearch = !searchTerm ||
              (customer.customerName && customer.customerName.toLowerCase().includes(searchTerm)) ||
              (customer.contractNo && customer.contractNo.toLowerCase().includes(searchTerm));
    
            const matchesStatus = !statusFilter || customer.status === statusFilter;
    
            return matchesSearch && matchesStatus;
          });
    
          currentPage = 1;
          displayCustomerTable();
        }

        // Event listeners - criteriaForm is now handled by modal
    
        document.getElementById('searchCustomer').addEventListener('input', filterCustomers);
        document.getElementById('filterCustomerStatus').addEventListener('change', filterCustomers);

        // Global functions
        window.refreshBadDebtData = async function() {
          showLoading(true);
          await loadCustomerData();
          showLoading(false);
          showNotification('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        };
    
        window.exportBadDebtData = async function() {
          try {
            const response = await fetch('/api/loan/bad-debt/export', { headers });
            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `bad_debt_report_${new Date().toISOString().split('T')[0]}.csv`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
              showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } else {
              throw new Error('Export failed');
            }
          } catch (error) {
            console.error('Export error:', error);
            showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
          }
        };

        window.viewCustomerDetail = function(customerCode) {
          showNotification(`‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customerCode}`, 'info');
        };

        window.contactCustomer = function(customerCode) {
          showNotification(`‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customerCode}`, 'info');
        };

        window.scheduleFollowUp = function(customerCode) {
          showNotification(`‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customerCode}`, 'info');
        };

        // Add event listeners for overdue customers search and filter
        const overdueSearchInput = document.getElementById('overdueSearchInput');
        const overdueFilterSelect = document.getElementById('overdueFilterSelect');

        if (overdueSearchInput) {
          overdueSearchInput.addEventListener('input', filterOverdueCustomers);
        }

        if (overdueFilterSelect) {
          overdueFilterSelect.addEventListener('change', filterOverdueCustomers);
        }

        // Modal control handlers
        setupModalHandlers();

        // Load data on page load
        loadCriteria();
        loadCustomerData();

      } catch (error) {
        console.error('Error initializing page:', error);
        showLoading(false);
      }
    });
  </script>

  <!-- Avatar Utils Script -->
  <script src="/js/avatar-utils.js"></script>

  <!-- Bad Debt Criteria Modal -->
  <div id="criteriaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="bi bi-gear-fill mr-2 text-blue-500"></i>
          ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç
        </h3>
        <button type="button" id="closeCriteriaModal"
                class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
          <i class="bi bi-x-lg w-5 h-5"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6">
        <form id="modalBadDebtCriteriaForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç -->
            <div>
              <label for="modalAllowanceForDoubtfulAccounts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-shield-check mr-1 text-green-500"></i>
                ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç (%)
              </label>
              <input type="number" id="modalAllowanceForDoubtfulAccounts" name="allowanceForDoubtfulAccounts"
                     min="0" max="100" step="0.01"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.00">
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç -->
            <div>
              <label for="modalDoubtfulAccounts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-exclamation-triangle mr-1 text-yellow-500"></i>
                ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç (%)
              </label>
              <input type="number" id="modalDoubtfulAccounts" name="doubtfulAccounts"
                     min="0" max="100" step="0.01"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.00">
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏™‡∏π‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô</p>
            </div>

            <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç -->
            <div>
              <label for="modalBadDebt" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-x-circle mr-1 text-red-500"></i>
                ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏ç (%)
              </label>
              <input type="number" id="modalBadDebt" name="badDebt"
                     min="0" max="100" step="0.01"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.00">
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
            </div>

            <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <div>
              <label for="modalRepossessionCost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-gear mr-1 text-purple-500"></i>
                ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤)
              </label>
              <input type="number" id="modalRepossessionCost" name="repossessionCost"
                     min="0" step="1"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 500">
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</p>
            </div>
          </div>

          <!-- Policy Notes -->
          <div class="mt-6">
            <label for="modalPolicyNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              <i class="bi bi-journal-text mr-1 text-indigo-500"></i>
              ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            </label>
            <textarea id="modalPolicyNotes" name="policyNotes" rows="4"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á, ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"></textarea>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="flex items-center justify-between p-6 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
          <i class="bi bi-info-circle mr-2"></i>
          ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </div>
        <div class="flex space-x-3">
          <button type="button" id="cancelCriteriaModal"
                  class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
            <i class="bi bi-x-circle mr-1"></i>
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button type="submit" id="saveCriteriaModal" form="modalBadDebtCriteriaForm"
                  class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="bi bi-check-circle mr-1"></i>
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>

</body>
</html>