<!DOCTYPE html>
<html lang="th" data-theme="light"> <!-- Set default theme to light -->
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Minimal Blue)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      // darkMode: 'class', // Can be removed if not using dark mode toggle for this page'
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif']'
          },
          colors: {
            'sky-50': '#f0f9ff','
            'sky-100': '#e0f2fe','
            'sky-200': '#bae6fd','
            'sky-300': '#7dd3fc','
            'sky-400': '#38bdf8','
            'sky-500': '#0ea5e9','
            'sky-600': '#0284c7','
            'sky-700': '#0369a1','
            'brand-text-subtle': '#6b7280', // gray-500'
            'brand-border': '#e5e7eb',     // gray-200'
          }
        }
      },
      plugins: [require("daisyui")], // Ensure DaisyUI plugin is loaded
      daisyui: {
        themes: ["light"], // Focus on light theme
         styled: true,
         base: true,
         utils: true,
         logs: true,
         rtl: false,
      },
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" /> <!-- Keep DaisyUI for components if needed, or remove if fully custom -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f0f9ff; /* sky-50 */
      color: #374151; /* gray-700 */
    }
    .content-card {
      background-color: white;
      border-radius: 0.5rem; /* rounded-lg */
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03); /* Softer shadow */
      border: 1px solid #e5e7eb; /* gray-200, subtle border */
    }
    .card-title-minimal {
      font-size: 1.125rem; /* text-lg */
      font-weight: 600; /* semibold */
      color: #0369a1; /* sky-700 */
      padding-bottom: 0.75rem; /* pb-3 */
      border-bottom: 1px solid #e0f2fe; /* sky-100 */
      margin-bottom: 1rem; /* mb-4 */
      display: flex;
      align-items: center;
    }
    .card-title-minimal i {
      margin-right: 0.5rem; /* mr-2 */
      color: #0ea5e9; /* sky-500 */
    }
    .key-value-item {
      display: flex;
      justify-content: space-between;
      padding-top: 0.375rem; /* py-1.5 */
      padding-bottom: 0.375rem;
      border-bottom: 1px dashed #e0f2fe; /* sky-100 */
    }
    .key-value-item:last-child {
      border-bottom: none;
    }
    .key-value-item .key {
      color: #6b7280; /* gray-500 */
      font-size: 0.875rem; /* text-sm */
      margin-right: 0.5rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á key ‡∏Å‡∏±‡∏ö value */
      white-space: nowrap; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô key ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
    }
    .key-value-item .value {
      font-weight: 500; /* medium */
      /* text-align: right; */ /* ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
      color: #1f2937; /* gray-800 */
      font-size: 0.875rem; /* text-sm */
      flex-grow: 1; /* ‡πÉ‡∏´‡πâ value ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
      word-break: break-word; /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß */
      text-align: left; /* ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
    }
    .image-placeholder-minimal {
      background-color: #e0f2fe; /* sky-100 */
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7dd3fc; /* sky-300 */
      font-size: 2rem; /* text-3xl */
      border-radius: 0.375rem; /* rounded-md */
      border: 1px dashed #bae6fd; /* sky-200 */
    }
    .image-card-minimal {
      border: 1px solid #e0f2fe; /* sky-100 */
      border-radius: 0.375rem; /* rounded-md */
      background-color: #f0f9ff; /* sky-50 */
      padding: 0.5rem; /* p-2 */
    }
    .image-card-minimal img {
      border-radius: 0.25rem; /* rounded-sm */
    }
    .image-card-minimal p {
      font-size: 0.75rem; /* text-xs */
      color: #0369a1; /* sky-700 */
      margin-top: 0.25rem; /* mt-1 */
    }
    .list-item-minimal {
      padding: 0.75rem; /* p-3 */
      margin-bottom: 0.5rem; /* mb-2 */
      border-radius: 0.375rem; /* rounded-md */
      background-color: white;
      border: 1px solid #e0f2fe; /* sky-100 */
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease-in-out;
    }
    .list-item-minimal:hover {
      background-color: #f0f9ff; /* sky-50 */
    }
    .list-item-minimal .contract-no {
      font-weight: 500; /* medium */
      color: #0284c7; /* sky-600 */
    }
    .list-item-minimal .status-badge {
      font-size: 0.75rem; /* text-xs */
      padding: 0.25rem 0.625rem; /* py-1 px-2.5 */
      border-radius: 9999px; /* rounded-full */
      font-weight: 500;
    }
    .status-badge.active { background-color: #d1fae5; color: #065f46; } /* green */
    .status-badge.paid { background-color: #ccfbf1; color: #0f766e; } /* teal */
    .status-badge.default { background-color: #fee2e2; color: #991b1b; } /* red */
    .status-badge.ghost { background-color: #f3f4f6; color: #4b5563; } /* gray */

    .btn-ghost-sky {
        color: #0284c7; /* sky-600 */
    }
    .btn-ghost-sky:hover {
        background-color: #e0f2fe; /* sky-100 */
    }
    .print-button {
      display: inline-block;
    }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }

        [data-theme="dark"]       </style>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Day.js with Thai locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
  <script>dayjs.locale('th');</script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>

  <!-- SweetAlert2 for better alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Lottie Web for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Utility Functions -->
  <script>
    // Utility functions to prevent console errors
    function showToast(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // If SweetAlert2 is available, use it
      if (typeof Swal !== 'undefined') {
        const Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true
        });
        Toast.fire({
          icon: type === 'error' ? 'error' : type === 'success' ? 'success' : 'info',
          title: message
        });
      }
    }

    let lottieAnimation = null;
    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => response.json())
            .then(animationData => {
              console.log('‚úÖ Lottie animation data loaded successfully');
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: false,
                animationData: animationData
              });
            })
            .catch(error => {
              console.warn('Failed to load Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        }
        if (lottieAnimation) lottieAnimation.play();
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(amount || 0);
    }

    function formatDate(date) {
      if (!date) return '-';
      return dayjs(date).format('DD/MM/YYYY');
    }

    function formatDateTime(date) {
      if (!date) return '-';
      return dayjs(date).format('DD/MM/YYYY HH:mm');
    }

    // Make functions globally available
    window.showToast = showToast;
    window.showLoading = showLoading;
    window.formatCurrency = formatCurrency;
    window.formatDate = formatDate;
    window.formatDateTime = formatDateTime;
  </script>

</head>
<body class="min-h-screen w-full p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

    </div>

  <!-- Menu Toggle Button -->
  <button id="btnToggleMenu" class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition-all duration-300"
          title="Toggle Menu" aria-label="Toggle Menu">
    <i class="bi bi-chevron-left"></i>
  </button>
  <div class="container mx-auto p-4 sm:p-6 max-w-4xl"> <!-- Max width for better readability -->
    <div class="mb-8 flex items-center justify-between">
      <button onclick="history.back()" class="btn btn-ghost-sky text-sm">
        <i class="bi bi-arrow-left text-lg"></i> <!-- Slightly smaller icon -->
        <span class="ml-1.5">‡∏Å‡∏•‡∏±‡∏ö</span>
      </button>
      <h1 class="text-2xl font-semibold text-sky-700 text-center flex-grow">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
      <div class="w-20"></div> <!-- Spacer -->
    </div>

    <div class="space-y-5">

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-person"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="key-value-item"><span class="key">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</span> <span id="custPrefix" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ä‡∏∑‡πà‡∏≠:</span> <span id="custFirstName" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span> <span id="custLastName" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span> <span id="custPhone" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">E-mail:</span> <span id="custEmail" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span> <span id="custTaxId" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span> <span id="custBirthDate" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏≠‡∏≤‡∏¢‡∏∏:</span> <span id="custAge" class="value">‚Äì</span></div>
            <div class="key-value-item md:col-span-2"><span class="key">Invoice No:</span> <span id="custInvoice" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-chat-dots"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="key-value-item"><span class="key">Facebook URL:</span> <span id="custFacebookUrl" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">Line ID:</span> <span id="custLineId" class="value">‚Äì</span></div>
            <div class="key-value-item md:col-span-2"><span class="key">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span> <span id="custAddress" class="value">‚Äì</span></div>
            <div class="key-value-item md:col-span-2"><span class="key">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà GPS:</span> <span id="custLocationAddress" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î:</span> <span id="custLatitude" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î:</span> <span id="custLongitude" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-geo-alt"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6">
            <div class="key-value-item"><span class="key">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span> <span id="custHouseNo" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà:</span> <span id="custMoo" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ã‡∏≠‡∏¢:</span> <span id="custSoi" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ñ‡∏ô‡∏ô:</span> <span id="custRoad" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏ï‡∏≥‡∏ö‡∏•:</span> <span id="custSubDistrict" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</span> <span id="custDistrict" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span> <span id="custProvince" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:</span> <span id="custZipcode" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>

      <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ & ‡∏£‡∏π‡∏õ -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-images"></i>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>
          <div id="docsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <!-- ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å inject ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
          </div>
        </div>
      </div>
      
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-people"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="key-value-item"><span class="key">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ô:</span> <span id="witName" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£:</span> <span id="witId" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span> <span id="witPhone" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå:</span> <span id="witRelation" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-receipt"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-x-6">
            <div class="key-value-item"><span class="key">Plan:</span> <span id="plan" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏î‡∏≤‡∏ß‡∏ô‡πå:</span> <span id="down" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î:</span> <span id="count" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏á‡∏ß‡∏î‡∏•‡∏∞:</span> <span id="amount" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠:</span> <span id="credit" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span> <span id="payoff" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">‡∏Ñ‡πà‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span> <span id="docFee" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>
      
      <!-- Quotation / Agreement -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-file-text"></i>Quotation / Agreement</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div class="key-value-item"><span class="key">Quotation No:</span> <span id="quoNo" class="value">‚Äì</span></div>
            <div class="key-value-item"><span class="key">Credit Term:</span> <span id="term" class="value">‚Äì</span></div>
          </div>
        </div>
      </div>

      <!-- ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ -->
      <div class="content-card">
        <div class="p-5 flex items-center gap-4">
          <div class="avatar">
            <div class="w-12 h-12 rounded-full ring-2 ring-sky-300 ring-offset-2 ring-offset-white">
              <img id="salesPhoto" src="" alt="Salesperson Photo" class="rounded-full" />
            </div>
          </div>
          <div>
            <h3 class="text-md font-semibold text-sky-700">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</h3>
            <p id="salesName" class="text-sm text-gray-600">‚Äì</p>
          </div>
        </div>
      </div>
      
      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô -->
      <div class="content-card">
        <div class="p-5">
          <h2 class="card-title-minimal"><i class="bi bi-list-check"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô</h2>
          <ul id="installmentList" class="space-y-1.5">
            <li class="text-center p-4 text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('authToken');'
    if (!token && !window.location.pathname.endsWith('login.html')) { // Avoid redirect loop from login page'
      // window.location.href = '/login';'
      console.warn('No auth token found. Displaying page with potentially limited data.');'
    }
    const headers = {
      'Content-Type': 'application/json','
      'Authorization': 'Bearer ' + token'
    };

    const placeholderImageMinimal = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23bae6fd'%3E%3Cpath d='M19.5 3.75H4.5C3.5335 3.75 2.75 4.5335 2.75 5.5V18.5C2.75 19.4665 3.5335 20.25 4.5 20.25H19.5C20.4665 20.25 21.25 19.4665 21.25 18.5V5.5C21.25 4.5335 20.4665 3.75 19.5 3.75ZM4.25 18.5V5.5C4.25 5.25163 4.40804 5.02903 4.5 5.00337V18.7466C4.40804 18.721 4.25 18.4984 4.25 18.5ZM19.5 18.75H4.5C4.27897 18.75 4.07804 18.6904 3.90625 18.5781L18.5781 3.90625C18.6904 4.07804 18.75 4.27897 18.75 4.5V18.5C18.75 18.6381 18.6973 18.75 18.5938 18.75H19.5C19.7484 18.75 20 18.592 20 18.5V5.5C20 5.20795 19.7921 5 19.5 5H5.00337C5.02903 4.90804 5.25163 4.75 5.5 4.75H19.5C19.7761 4.75 20 4.97386 20 5.25V18.25C20 18.5261 19.7761 18.75 19.5 18.75Z'/%3E%3Cpath d='M7.5 10.5C8.32843 10.5 9 9.82843 9 9C9 8.17157 8.32843 7.5 7.5 7.5C6.67157 7.5 6 8.17157 6 9C6 9.82843 6.67157 10.5 7.5 10.5Z'/%3E%3Cpath d='M17.25 15H6.75L9.75 12L12.75 15L14.25 13.5L17.25 16.5V15Z'/%3E%3C/svg%3E";'


    function injectImg(label, url) {
      const container = document.createElement('div');'
      container.className = 'image-card-minimal text-center';'
      
      let imgElement;
      if (url) {
        imgElement = `<img src="${url}" alt="${label}" class="h-28 w-full object-contain"/>`; // object-contain for documents
      } else {
        imgElement = `<div class="h-28 w-full image-placeholder-minimal"><i class="bi bi-image"></i></div>`;
      }

      container.innerHTML = `
        ${imgElement}
        <p class="truncate">${label}</p>
      `;
      const docsGrid = document.getElementById('docsGrid');
      if (docsGrid) {
        docsGrid.appendChild(container);
      } else {
        console.error('docsGrid element not found');
      }
    }

    function renderInstallmentOrders(orders) {
      const ul = document.getElementById('installmentList');
      if (!ul) {
        console.error('installmentList element not found');
        return;
      }
      
      if (!orders || orders.length === 0) {
        ul.innerHTML = '<li class="text-center p-4 text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</li>';
        return;
      }
      ul.innerHTML = orders.map(o => {
        let statusBadgeClass = 'ghost';'
        if (o.status) {
            const stat = o.status.toLowerCase();
            if (stat.includes('active') || stat.includes('current') || stat.includes('‡∏õ‡∏Å‡∏ï‡∏¥')) statusBadgeClass = 'active';'
            else if (stat.includes('paid') || stat.includes('complete') || stat.includes('‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö')) statusBadgeClass = 'paid';'
            else if (stat.includes('default') || stat.includes('overdue') || stat.includes('‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞')) statusBadgeClass = 'default';'
        }
        
        return `
          <li class="list-item-minimal">
            <span class="contract-no"><i class="bi bi-file-earmark-text text-sky-500 mr-1.5"></i>${o.contractNo || 'N/A'}</span>'
            <span class="status-badge ${statusBadgeClass}">${o.status || 'N/A'}</span>'
          </li>`;
      }).join('');'
    }

    async function loadDetail() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');'
      if (!id) {
        // More user-friendly message directly in the page
        document.body.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-sky-50">
                                     <i class="bi bi-exclamation-triangle text-5xl text-sky-400 mb-4"></i>
                                     <h1 class="text-xl font-semibold text-sky-700 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
                                     <p class="text-gray-600 mb-6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ô URL</p>
                                     <button onclick="history.back()" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 transition">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                                   </div>`;
        return;
      }

      try {
        let loaderId;
        if (typeof LoadingSystem !== 'undefined') {
          loaderId = LoadingSystem.show({
            message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
            showProgress: true,
            autoProgress: true
          });
        } else {
          showLoading(true);
        }
        const res = await fetch(`/api/loan/customer/${id}/loans`, { headers });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (HTTP ${res.status})`);
        }
        const result = await res.json();
        if (!result.success || !result.data) {
          throw new Error(result.message || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
        }
        const c = result.data;

        // Update customer info with null checks
        const elements = {
          'custPrefix': c.prefix,
          'custFirstName': c.first_name,
          'custLastName': c.last_name,
          'custPhone': c.phone_number,
          'custEmail': c.email,
          'custTaxId': c.tax_id,
          'custBirthDate': formatDate(c.birth_date),
          'custAge': c.age,
          'custInvoice': c.invoice_no
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value || '‚Äì';
          }
        });
        const addr = c.address || {};
        document.getElementById('custAddress').textContent = 
          [addr.houseNo, addr.moo && `‡∏´‡∏°‡∏π‡πà ${addr.moo}`, addr.subDistrict && `‡∏ï.${addr.subDistrict}`,
           addr.district && `‡∏≠.${addr.district}`, addr.province && `‡∏à.${addr.province}`, addr.zipcode]
          .filter(Boolean).join(' ') || '‚Äì';

        // Populate new contact fields with null checks
        const contactElements = {
          'custFacebookUrl': c.facebook_url,
          'custLineId': c.line_id,
          'custLocationAddress': c.location_address,
          'custLatitude': c.latitude
        };
        
        Object.entries(contactElements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value || '‚Äì';
          }
        });
        const longitudeEl = document.getElementById('custLongitude');
        if (longitudeEl) {
          longitudeEl.textContent = c.longitude || '‚Äì';
        }
        
        // Populate detailed address fields with null checks
        const addressElements = {
          'custHouseNo': addr.houseNo,
          'custMoo': addr.moo,
          'custSoi': addr.soi,
          'custRoad': addr.road,
          'custSubDistrict': addr.subDistrict,
          'custDistrict': addr.district,
          'custProvince': addr.province,
          'custZipcode': addr.zipcode
        };
        
        Object.entries(addressElements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value || '‚Äì';
          }
        });
        
        // Create clickable Facebook link if available
        if (c.facebook_url) {
          const facebookElement = document.getElementById('custFacebookUrl');
          if (facebookElement) {
            facebookElement.innerHTML = `<a href="${c.facebook_url}" target="_blank" class="text-blue-600 hover:underline">${c.facebook_url}</a>`;
          }
        }
        
        // Add GPS coordinates link if available
        if (c.latitude && c.longitude) {
          const latElement = document.getElementById('custLatitude');
          const lngElement = document.getElementById('custLongitude');
          if (latElement && lngElement) {
            const mapsUrl = `https://maps.google.com/?q=${c.latitude},${c.longitude}`;
            latElement.innerHTML = `<a href="${mapsUrl}" target="_blank" class="text-blue-600 hover:underline">${c.latitude}</a>`;
            lngElement.innerHTML = `<a href="${mapsUrl}" target="_blank" class="text-blue-600 hover:underline">${c.longitude}</a>`;
          }
        }

        const docsGrid = document.getElementById('docsGrid');
        if (docsGrid) {
          docsGrid.innerHTML = '';
          injectImg('‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', c.idCardImage);
          injectImg('‡∏™‡∏•‡∏¥‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', c.incomeSlip);
          injectImg('‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà', c.selfieImage);
          injectImg('‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', c.customerSignature);
          injectImg('‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', c.employeeSignature);
          injectImg('‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', c.authorizedSignature);
        }

        const wit = c.witness || {};
        const witnessElements = {
          'witName': wit.name,
          'witId': wit.idCard,
          'witPhone': wit.phone,
          'witRelation': wit.relation
        };
        
        Object.entries(witnessElements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value || '‚Äì';
          }
        });
        
        // Update payment info with null checks and currency formatting
        const paymentElements = {
          'plan': c.paymentPlan || '‚Äì',
          'down': typeof c.downPayment === 'number' ? formatCurrency(Math.max(0, c.downPayment || 0)) : '‚Äì',
          'count': typeof c.installmentCount === 'number' ? Math.max(0, c.installmentCount || 0) : '‚Äì',
          'amount': typeof c.installmentAmount === 'number' ? formatCurrency(Math.max(0, c.installmentAmount || 0)) : '‚Äì',
          'credit': typeof c.creditAmount === 'number' ? formatCurrency(Math.max(0, c.creditAmount || 0)) : '‚Äì',
          'payoff': typeof c.payoffAmount === 'number' ? formatCurrency(Math.max(0, c.payoffAmount || 0)) : '‚Äì',
          'docFee': typeof c.docFee === 'number' ? formatCurrency(Math.max(0, c.docFee || 0)) : '‚Äì'
        };
        
        Object.entries(paymentElements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        });

        document.getElementById('quoNo').textContent = c.quotationNo || '‚Äì';'
        document.getElementById('term').textContent  = c.creditTerm || '‚Äì';'

        const sales = c.salesperson || {};
        document.getElementById('salesName').textContent = sales.name || '‚Äì';'
        document.getElementById('salesPhoto').src = sales.imageUrl || placeholderImageMinimal;'

        renderInstallmentOrders(c.installmentOrders || []);

      } catch (err) {
        console.error('loadDetail error:', err);'
        document.body.innerHTML = `<div class="min-h-screen flex flex-col items-center justify-center p-4 text-center bg-sky-50">
                                     <i class="bi bi-wifi-off text-5xl text-red-400 mb-4"></i>
                                     <h1 class="text-xl font-semibold text-red-700 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h1>
                                     <p class="text-gray-600 mb-6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ<br>(${err.message})</p>
                                     <button onclick="window.location.reload()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition mr-2">‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                                     <button onclick="history.back()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition">‡∏Å‡∏•‡∏±‡∏ö</button>
                                   </div>`;
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }
    // Loading state management
}

document.addEventListener('DOMContentLoaded', async function() {
      let pageLoaderId;
      
      try {
        if (typeof LoadingSystem !== 'undefined') {
          pageLoaderId = LoadingSystem.show({
            message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...',
            showProgress: true,
            autoProgress: true,
            spinnerType: 'default'
          });
        }
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        if (typeof LoadingSystem !== 'undefined') {
          LoadingSystem.completeProgress();
        }
      }
      
      try {
        // Show loading initially
        let loaderId;
        if (typeof LoadingSystem !== 'undefined') {
          loaderId = LoadingSystem.show({
            message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
            showProgress: true,
            autoProgress: true
          });
        }
        
        try {
          await loadDetail();
        } catch (error) {
          console.error('Error loading data:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        } finally {
          showLoading(false);
        }
      } catch (error) {
        console.error('Critical error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á', 'error');
      }
    });

    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>
</body>
</html>