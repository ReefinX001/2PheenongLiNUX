<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS & DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'Prompt', 'sans-serif'] },
        },
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <!-- jQuery & Day.js (locale ‡πÑ‡∏ó‡∏¢) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/locale/th.js"></script>

  <!-- Avatar Utils - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 404 errors ‡∏à‡∏≤‡∏Å avatar-default.png -->
  <script src="/js/avatar-utils.js"></script>

  <!-- Lottie Web for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Loan Sidebar JS -->
  <script src="/views/loan/loan-sidebar.js"></script>

  <script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      const isDark = savedTheme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    body { 
      font-family: 'Inter', 'Prompt', sans-serif; 
      font-weight: 400;
      line-height: 1.5;
    }
    
    /* Minimal animations */
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(8px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    
    /* Minimal spinner */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { 
      border: 2px solid #f1f5f9;
      border-top: 2px solid #64748b;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite; 
    }
    
    /* Minimal status colors */
    .status-paid { color: #374151; font-weight: 500; }
    .status-pending { color: #6b7280; font-weight: 500; }
    .status-late { color: #374151; font-weight: 500; }
    
    /* Clean table styling */
    .minimal-table th {
      background: #fafafa;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 16px;
      text-align: left;
      font-weight: 500;
      font-size: 14px;
      color: #374151;
    }
    
    .minimal-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
      color: #374151;
    }
    
    .minimal-table tbody tr:hover {
      background: #fafafa;
    }
    
    /* Dark mode adjustments */
    .dark .minimal-table th {
      background: #1f2937;
      border-bottom: 1px solid #374151;
      color: #d1d5db;
    }
    
    .dark .minimal-table td {
      border-bottom: 1px solid #374151;
      color: #d1d5db;
    }
    
    .dark .minimal-table tbody tr:hover {
      background: #1f2937;
    }
    
    /* Clean inputs */
    .input-minimal {
      @apply border-gray-300 focus:border-gray-500 focus:ring-0 text-sm bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100;
    }
    
    .Logo { max-width: 100%; height: auto; }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>

<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-light">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ loan-sidebar.js -->
  <div id="sidebarContainer"></div>

  <div class="min-h-screen bg-white dark:bg-gray-900">
    <div class="flex-1 flex flex-col ml-64 main-content">
      
      <!-- Minimal Header -->
      <header class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
        <div class="flex justify-between items-center">
          <h1 class="text-xl font-medium text-gray-900 dark:text-gray-100" id="pageTitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
          <div class="flex gap-2">
            <button id="btnRefresh" class="btn btn-sm">
              <i class="bi bi-arrow-clockwise text-sm"></i>
              <span class="ml-1">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
          </button>
            <button id="btnExport" class="btn btn-primary btn-sm">
              <i class="bi bi-download text-sm"></i>
              <span class="ml-1">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</span>
          </button>
          </div>
        </div>
      </header>

      <div class="p-6">
        <!-- Minimal Filters -->
        <div class="flex flex-wrap gap-3 mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
          <input type="date" id="filter-from" class="input input-minimal w-40" />
          <input type="text" id="filter-search" class="input input-minimal flex-1" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£" />
          <select id="filter-branch" class="select input-minimal w-40">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
        </select>
          <select id="filter-status" class="select input-minimal w-32">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
          <button id="btnApplyFilter" class="btn btn-primary btn-sm px-4">
            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
          <button id="btnClearFilter" class="btn btn-sm px-4">
            ‡∏•‡πâ‡∏≤‡∏á
        </button>
      </div>

        <!-- Stats Section -->
        <div class="stats stats-vertical sm:stats-horizontal shadow-sm mb-6 w-full">
          <div class="stat">
            <div class="stat-figure text-primary">
              <i class="bi bi-receipt text-2xl"></i>
            </div>
            <div class="stat-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value text-primary" id="total-transactions">0</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-success">
              <i class="bi bi-cash text-2xl"></i>
            </div>
            <div class="stat-title">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</div>
            <div class="stat-value text-success" id="total-amount">0</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-info">
              <i class="bi bi-calendar-check text-2xl"></i>
        </div>
            <div class="stat-title">‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="stat-value text-info" id="today-payments">0</div>
        </div>
          <div class="stat">
            <div class="stat-figure text-secondary">
              <i class="bi bi-calendar-month text-2xl"></i>
        </div>
            <div class="stat-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="stat-value text-secondary" id="month-payments">0</div>
        </div>
      </div>

        <!-- Minimal Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
          <table id="installment-table" class="w-full minimal-table">
          <thead>
            <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</th>
                <th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th>
                <th>‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                <th>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
                <th>‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
                <th class="text-right">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th>
                <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</th>
                <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            <tr>
                <td colspan="11" class="text-center py-8">
                  <div class="flex items-center justify-center">
                    <div class="spinner mr-2"></div>
                    <span class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                  </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

        <!-- Minimal Pagination -->
        <div class="flex justify-between items-center mt-6">
          <div class="text-sm text-gray-500 dark:text-gray-400">
            ‡πÅ‡∏™‡∏î‡∏á <span id="showing-records">0</span> ‡∏à‡∏≤‡∏Å <span id="total-records">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </div>
          <div class="flex gap-2">
            <button id="btn-prev-page" class="btn btn-sm px-4 py-2">
              <i class="bi bi-chevron-left"></i>
              <span class="ml-1">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
            </button>
            <button id="btn-next-page" class="btn btn-sm px-4 py-2">
              <span class="mr-1">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
              <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Minimal Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
      <h3 class="font-medium text-lg mb-6 text-gray-900 dark:text-gray-100">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
      <div id="modalContent" class="space-y-4"></div>
      <div class="modal-action mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button id="btnPrintReceipt" class="btn btn-primary">
          <i class="bi bi-printer"></i>
          <span class="ml-1">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
        </button>
        <button id="btnCloseModal" class="btn">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
    // Utility functions
    function showToast(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    let lottieAnimation = null;
    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => response.json())
            .then(animationData => {
              console.log('‚úÖ Lottie animation data loaded successfully');
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: false,
                animationData: animationData
              });
            })
            .catch(error => {
              console.warn('Failed to load Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        }
        if (lottieAnimation) lottieAnimation.play();
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount || 0);
    }

    function formatDate(date) {
      if (!date) return '-';
      return new Date(date).toLocaleDateString('th-TH');
    }

    // Make functions globally available
    window.showToast = showToast;
    window.showLoading = showLoading;
    window.formatCurrency = formatCurrency;
    window.formatDate = formatDate;

    const API_BASE    = '/api';  // Changed to use /api prefix
    const token       = localStorage.getItem('authToken');
    let installmentData = [];
    let currentPage     = 1;
    const itemsPerPage  = 10;
    let totalRecords    = 0;
    let branchList      = [];  // List to store available branches

    // Loading state management

    $(async function(){
      try {
        dayjs.locale('th');

        // Initialize loan sidebar first
        if (typeof initializeLoanSidebar === 'function') {
          initializeLoanSidebar();
        }

        // Show loading
        showLoading(true);

        const branches = await loadBranches();        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô dropdown
        const branchSelect = $('#filter-branch');
        branches.forEach(branch => {
          const branchId = branch._id || branch.branch_code;
          const branchName = branch.name || branch.branch_code;
          branchSelect.append(`<option value="${branchId}">${branchName}</option>`);
        });

        setupEventListeners();
        await fetchData();

        // ‚Äî‚Äî‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏° realtime update ‚Äî‚Äî‚Äî
        const socket = io(window.location.origin, {
          transports: ['websocket'],
          path: '/socket.io'
        });
        socket.on('installmentHistoryUpdated', async () => {
          await fetchData(currentPage);
        });
      } catch (error) {
        console.error('Error loading data:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function loadBranches() {
      try {
        console.log('üîÑ Loading branches...');

        // ‡πÉ‡∏ä‡πâ API ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: /api/branch (‡πÑ‡∏°‡πà‡∏°‡∏µ s)
        const res = await fetch('/api/branch', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (res.ok) {
          const data = await res.json();
          if (data.success) {
            branchList = data.data || [];
          } else {
            branchList = [];
          }
        } else {
          branchList = [];
        }

        return branchList;
      } catch (err) {
        console.warn('‚ùå Load Branches Error, using fallback:', err.message);

        // Fallback: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        branchList = [
          { _id: 'PATTANI', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', branch_code: 'PATTANI' },
          { _id: 'YALA', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏¢‡∏∞‡∏•‡∏≤', branch_code: 'YALA' },
          { _id: 'NARATHIWAT', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', branch_code: 'NARATHIWAT' },
          { _id: 'MAIN', name: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å', branch_code: 'MAIN' }
        ];

        console.log('üìã Using fallback branches:', branchList.length);
        return branchList;
      }
    }

    // Note: Employee profile loading is handled by loan-sidebar.js

    function setupEventListeners(){
      $('#btnRefresh').on('click', async () => await fetchData(currentPage));
      $('#btnExport').on('click', exportExcel);
      $('#btnApplyFilter').on('click', async () => await fetchData(1));
      $('#btnClearFilter').on('click', async () => {
        $('#filter-from,#filter-search,#filter-status,#filter-branch').val('');
        await fetchData(1);
      });
      $('#btn-prev-page').on('click', async () => {
        if(currentPage>1) await fetchData(currentPage-1);
      });
      $('#btn-next-page').on('click', async () => {
        const totalPages = Math.ceil(totalRecords/itemsPerPage);
        if(currentPage<totalPages) await fetchData(currentPage+1);
      });
      // View payment details button
      $(document).on('click','.view-payment-btn',function(){
        const id = $(this).data('id');
        const payment = installmentData.find(i=>i._id===id);
        if(!payment) return;
        viewPaymentDetails(payment);
      });

      // Print receipt button
      $(document).on('click','.print-receipt-btn',function(){
        const id = $(this).data('id');
        printPaymentReceipt(id);
      });

      // Edit button (legacy - kept for compatibility)
      $(document).on('click','.edit-btn',function(){
        const id = $(this).data('id');
        const item = installmentData.find(i=>i._id===id);
        if(!item) return;
        $('#detailModal h3').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
        $('#modalContent').html(`
          <form id="editForm" class="space-y-5">
            <input type="hidden" name="id" value="${item.id}" />
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
              <input name="name" value="${item.name}" class="input input-minimal w-full"/>
            </div>
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
              <input name="phone" value="${item.phone}" class="input input-minimal w-full"/>
            </div>
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</label>
              <input name="id_card" value="${item.id_card}" class="input input-minimal w-full"/>
            </div>
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
              <input type="date" name="dueDate" value="${item.dueDate}" class="input input-minimal w-full"/>
            </div>
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
              <input type="number" name="amount" value="${item.amount}" class="input input-minimal w-full"/>
            </div>
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select name="paid" class="select input-minimal w-full">
                <option value="true" ${item.paid?'selected':''}>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="false" ${!item.paid?'selected':''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞</option>
              </select>
            </div>
            <div class="flex justify-end gap-3 pt-4">
              <button type="button" id="btnCloseModal" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        `);
        $('#detailModal').addClass('modal-open');
      });
      $(document).on('click','#btnCloseModal',()=> $('#detailModal').removeClass('modal-open'));
      $(document).on('submit','#editForm',function(e){
        e.preventDefault();
        const f = e.currentTarget;
        const id = Number(f.id.value);
        const idx = installmentData.findIndex(i=>i.id===id);
        if(idx<0) return;
        installmentData[idx]={
          ...installmentData[idx],
          name: f.name.value,
          phone: f.phone.value,
          id_card: f.id_card.value,
          dueDate: f.dueDate.value,
          amount: Number(f.amount.value),
          paid: f.paid.value==='true'
        };
        $('#detailModal').removeClass('modal-open');
        renderTable(installmentData);
      });
    }

    let isLoading = false;

    async function fetchData(page=1){
      if (isLoading) {
        console.log('‚è≥ Already loading data, skipping...');
        return;
      }

      isLoading = true;
      currentPage = page;
    
      try {
        // Build query parameters
        const params = new URLSearchParams({
          page: page,
          limit: itemsPerPage
        });
    
        // Add filters if selected
        const startDate = $('#filter-from').val();
        const searchQuery = $('#filter-search').val();
        const status = $('#filter-status').val();
        const branchCode = $('#filter-branch').val();
    
        if (startDate) params.append('startDate', startDate);
        if (searchQuery) params.append('search', searchQuery);
        if (status) params.append('status', status);
        if (branchCode) params.append('branch', branchCode);
    
        console.log('üîÑ Fetching payment history with params:', Object.fromEntries(params));
    
        // Show loading state
        $('#installment-table tbody').html(`
          <tr><td colspan="15" class="text-center py-8">
            <div class="flex items-center justify-center">
              <div class="spinner mr-2"></div>
              <span class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...</span>
            </div>
          </td></tr>`);
    
        // Use the correct API endpoint for payment history
        const response = await fetch(`${API_BASE}/installment/payment-history?${params}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('üìä API Response:', data);
        console.log('üìä Data length:', data.data ? data.data.length : 0);
        console.log('üìä Statistics:', data.statistics);

        if (data.success && data.data) {
          installmentData = data.data;
          totalRecords = data.pagination?.totalRecords || installmentData.length;

          // Debug: Show sample data
          if (installmentData.length > 0) {
            console.log('‚úÖ Sample payment data:', JSON.stringify(installmentData[0], null, 2));
          }

          console.log(`‚úÖ Successfully loaded ${installmentData.length} payment records`);
    
          // Update dashboard with statistics from API
          if (data.statistics) {
            updateDashboardFromAPI(data.statistics);
          } else {
            updateDashboard(installmentData);
          }
    
          renderTable(installmentData);
          updatePaginationControls();
        } else {
          displayEmptyState();
        }
    
      } catch (error) {
        console.error('‚ùå Error loading payment history:', error);
        displayErrorState(error.message);
      } finally {
        isLoading = false;
      }
    }

    function displayEmptyState() {
      $('#installment-table tbody').html(`
        <tr><td colspan="15" class="text-center py-8">
          <div class="text-gray-500">
            <i class="bi bi-inbox text-4xl mb-3"></i>
            <div class="mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
            <p class="text-sm">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
          </div>
        </td></tr>`);
    
      installmentData = [];
      totalRecords = 0;
      updateDashboard([]);
      updatePaginationControls();
    }

    function displayErrorState(error) {
      $('#installment-table tbody').html(`
        <tr><td colspan="15" class="text-center py-8">
          <div class="text-gray-500">
            <i class="bi bi-exclamation-triangle text-yellow-500 text-4xl mb-3"></i>
            <div class="mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ</div>
            <p class="text-sm mb-3">Error: ${error}</p>
            <button onclick="fetchData(${currentPage})" class="btn btn-sm">
              <i class="bi bi-arrow-clockwise"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        </td></tr>`);

      installmentData = [];
      totalRecords = 0;
      updateDashboard([]);
      updatePaginationControls();
    }

    function updateTable(data){
      installmentData=data;
      updateDashboard(data);
      renderTable(data);
    }

    function renderTable(data) {
      if (!data || !data.length) {
        displayEmptyState();
        return;
      }

      const rows = data.map(item => {
        // 1) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        const paymentDate = new Date(item.paymentDate || item.createdAt);
        const fmtDate = paymentDate.toLocaleDateString('th-TH');
        const fmtTime = paymentDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

        // 2) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á field ‡∏à‡∏≤‡∏Å API ‡πÅ‡∏•‡∏∞ fallback values
        const customerName = item.customerName || item.customer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const customerPhone = item.customerPhone || item.customer_phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

        // 3) ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á installmentNo ‡πÅ‡∏•‡∏∞ installmentNumber
        const installmentNo = item.installmentNo || item.installmentNumber || 1;
        const installmentText = `‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${installmentNo}`;

        // 4) ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        let nextDueDate = new Date(paymentDate);
        nextDueDate.setMonth(nextDueDate.getMonth() + 1);
        const fmtDue = nextDueDate.toLocaleDateString('th-TH');

        // 5) ‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        const nextInstallment = `‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${installmentNo + 1}`;

        // 6) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞ - ‡πÉ‡∏ä‡πâ amount ‡∏ï‡∏≤‡∏° database model
        const amount = item.amount || 0;
        const fmtAmount = `${amount.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`;

        // 7) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
        let branchName = item.branchName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        if (!branchName || branchName === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
          // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å branchCode
          if (item.branchCode && branchList.length > 0) {
            const branch = branchList.find(b =>
              b._id === item.branchCode ||
              b.branch_code === item.branchCode
            );
            branchName = branch ? branch.name : item.branchCode;
          }
        }

        // 8) ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        const paymentMethodDisplay = getPaymentMethodDisplay(item.paymentMethod, item);

        // 9) ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusDisplay = getStatusDisplay(item.status);

        // 10) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        const receiptNumber = item.receiptNumber || item.paymentId || '-';

        // 11) ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á contractNo ‡πÅ‡∏•‡∏∞ contractNumber
        const contractNo = item.contractNo || item.contractNumber || '-';

        return `
          <tr class="animate-fadeIn">
            <td>${fmtDate}</td>
            <td>${fmtTime}</td>
            <td>-</td>
            <td>${customerName}</td>
            <td>${customerPhone}</td>
            <td>${contractNo}</td>
            <td>${installmentText}</td>
            <td>${receiptNumber}</td>
            <td>${fmtDue}</td>
            <td>${nextInstallment}</td>
            <td class="text-right">${fmtAmount}</td>
            <td>${branchName}</td>
            <td>${paymentMethodDisplay}</td>
            <td class="text-center">${statusDisplay}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-info view-payment-btn" data-id="${item._id}" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-primary print-receipt-btn" data-id="${item._id}" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                <i class="bi bi-printer"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      $('#installment-table tbody').html(rows);
    }

    function getPaymentMethodDisplay(method, paymentData) {
      switch (method) {
        case 'cash':
          return '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
        case 'transfer':
          const bankName = paymentData.transferDetails?.bankName || '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
          return `‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (${bankName})`;
        case 'mixed':
          const cashAmount = paymentData.mixedPayment?.cashAmount || 0;
          const transferAmount = paymentData.mixedPayment?.transferAmount || 0;
          return `‡∏ú‡∏™‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ${cashAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó, ‡πÇ‡∏≠‡∏ô: ${transferAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
        default:
          return method || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    }

    function getStatusDisplay(status) {
      switch (status) {
        case 'confirmed':
          return '<span class="badge badge-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>';
        case 'pending':
          return '<span class="badge badge-warning">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
        case 'cancelled':
          return '<span class="badge badge-error">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
        default:
          return '<span class="badge badge-info">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>';
      }
    }

    function updateDashboard(data){
      $('#total-transactions').text(data.length);
    
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°
      let totalAmount = 0;
      let todayPayments = 0;
      let monthPayments = 0;
    
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
    
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
    
      data.forEach(item => {
        // ‡πÉ‡∏ä‡πâ amount field ‡∏ï‡∏≤‡∏° database model
        const amount = Math.max(0, item.amount || 0);
        totalAmount += amount;
    
        const paymentDate = new Date(item.paymentDate || item.createdAt);
    
        // ‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        if (paymentDate >= today && paymentDate < tomorrow) {
          todayPayments++;
        }
    
        // ‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        if (paymentDate >= startOfMonth && paymentDate <= endOfMonth) {
          monthPayments++;
        }
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó
      $('#total-amount').text(Math.max(0, totalAmount).toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó');
      $('#today-payments').text(todayPayments);
      $('#month-payments').text(monthPayments);
    }

    function updateDashboardFromAPI(statistics) {
      $('#total-transactions').text(statistics.totalTransactions || 0);
      $('#total-amount').text((statistics.totalAmount || 0).toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó');
      $('#today-payments').text(statistics.todayPayments || 0);
      $('#month-payments').text(statistics.monthPayments || 0);
    }


    function updatePaginationControls(){
      const totalPages = Math.ceil(totalRecords/itemsPerPage);
      $('#showing-records').text(installmentData.length);
      $('#total-records').text(totalRecords);
    
      // Update button states with minimal styling
      if (currentPage <= 1) {
        $('#btn-prev-page').addClass('opacity-50 cursor-not-allowed').prop('disabled', true);
      } else {
        $('#btn-prev-page').removeClass('opacity-50 cursor-not-allowed').prop('disabled', false);
      }
    
      if (currentPage >= totalPages) {
        $('#btn-next-page').addClass('opacity-50 cursor-not-allowed').prop('disabled', true);
      } else {
        $('#btn-next-page').removeClass('opacity-50 cursor-not-allowed').prop('disabled', false);
      }
    }

    function exportExcel(){
      let csv = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞,‡πÄ‡∏ß‡∏•‡∏≤,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£,‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà,‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞,‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞,‡∏™‡∏≤‡∏Ç‡∏≤,‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n';
      installmentData.forEach(payment => {
        const paymentDate = new Date(payment.paymentDate || payment.createdAt);
        const fmtDate = paymentDate.toLocaleDateString('th-TH');
        const fmtTime = paymentDate.toLocaleTimeString('th-TH');
        const amt = (payment.amount || 0).toLocaleString('th-TH');
        const branchName = payment.branchName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const paymentMethod = getPaymentMethodDisplay(payment.paymentMethod, payment);
        const status = payment.status === 'confirmed' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : payment.status;

        csv += [
          fmtDate,
          fmtTime,
          payment.contractNumber || '-',
          payment.customerName || '-',
          payment.customerPhone || '-',
          payment.installmentNumber || '-',
          amt + ' ‡∏ö‡∏≤‡∏ó',
          paymentMethod,
          branchName,
          payment.receiptNumber || payment.paymentId || '-',
          status
        ].join(',') + '\n';
      });
    
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    function viewPaymentDetails(payment) {
      const paymentDate = new Date(payment.paymentDate || payment.createdAt);
      const fmtDate = paymentDate.toLocaleDateString('th-TH');
      const fmtTime = paymentDate.toLocaleTimeString('th-TH');
    
      $('#detailModal h3').text('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
      $('#modalContent').html(`
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-3">
            <div>
              <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
              <p class="text-gray-900 font-mono">${payment.paymentId || '-'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
              <p class="text-gray-900">${payment.contractNo || payment.contractNumber || '-'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
              <p class="text-gray-900">${payment.customerName || payment.customer_name || '-'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
              <p class="text-gray-900">${payment.customerPhone || payment.customer_phone || '-'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</label>
              <p class="text-gray-900">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${payment.installmentNo || payment.installmentNumber || 1}</p>
            </div>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
              <p class="text-gray-900">${fmtDate} ${fmtTime}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</label>
              <p class="text-gray-900 text-lg font-semibold">${(payment.amount || 0).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
              <p class="text-gray-900">${getPaymentMethodDisplay(payment.paymentMethod, payment)}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏™‡∏≤‡∏Ç‡∏≤</label>
              <p class="text-gray-900">${payment.branchName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <p class="text-gray-900">${getStatusDisplay(payment.status)}</p>
            </div>
          </div>
        </div>
        ${payment.transferDetails ? `
          <div class="mt-4 p-3 bg-blue-50 rounded-lg">
            <h4 class="font-medium text-blue-900 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: ${payment.transferDetails.bankName || '-'}</div>
              <div>‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${payment.transferDetails.referenceNumber || '-'}</div>
            </div>
          </div>
        ` : ''}
        ${payment.mixedPayment ? `
          <div class="mt-4 p-3 bg-green-50 rounded-lg">
            <h4 class="font-medium text-green-900 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ${(payment.mixedPayment.cashAmount || 0).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</div>
              <div>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${(payment.mixedPayment.transferAmount || 0).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</div>
            </div>
          </div>
        ` : ''}
      `);
    
      $('#detailModal').addClass('modal-open');
    }

    function printPaymentReceipt(paymentId) {
      // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
      const printUrl = `${API_BASE}/installment/payment/${paymentId}/receipt`;
      window.open(printUrl, '_blank');
    }

    // Note: Dark mode, sidebar toggle, and logout are handled by loan-sidebar.js

    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>
</body>
</html>
