<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="<%= csrfToken %>" />

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- jQuery & Day.js -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
  
  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>

  <!-- Lottie Web for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css for smooth animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Prompt', sans-serif; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }

    aside.collapsed { width: 5rem; }
    aside.collapsed .ml-3 { display: none; }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .Logo { max-width: 100%; height: auto; }

    .status-paid { color: #16a34a; }
    .status-pending { color: #ca8a04; }
    .status-late { color: #dc2626; }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-200">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
  <div class="text-center">
    <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
  </div>
</div>

  <!-- Toggle Menu Button -->
  <button id="btnToggleMenu" title="Toggle Menu" aria-label="Toggle Menu"
    class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition">
    <i class="bi bi-chevron-left"></i>
  </button>

  <!-- Layout: Sidebar - Main Content -->
  <div class="min-h-screen flex flex-row">
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-gray-800 flex flex-col transition-all duration-300">
      <!-- Logo -->
      <a href="loan_dashboard.html">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <img src="/uploads/Logo2.png" alt="Logo" class="Logo" />
        </div>
      </a>

      <!-- Menu -->
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full">
          <li class="my-px">
            <a href="loan_dashboard" class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-house-door text-xl"></i>
              </span>
              <span class="ml-3">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
            </a>
          </li>

          <li class="my-px">
            <a href="repayment" class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-wallet2 text-xl"></i>
              </span>
              <span class="ml-3">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>
            </a>
          </li>

          <li class="my-px">
            <a href="status" class="flex flex-row items-center h-12 px-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-graph-up text-xl"></i>
              </span>
              <span class="ml-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            </a>
          </li>

          <li class="my-px">
            <a href="installment_history" class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-clock-history text-xl"></i>
              </span>
              <span class="ml-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</span>
            </a>
          </li>

          <li class="my-px">
            <a href="customer" class="flex flex-row items-center h-12 px-4 rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-people text-xl"></i>
              </span>
              <span class="ml-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>

          <!-- Dark Mode Toggle -->
          <li class="my-px mt-6">
            <button id="btnToggleDark" class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 text-left transition">
              <span class="flex items-center justify-center text-lg text-gray-400 dark:text-gray-300">
                <i class="bi bi-moon"></i>
              </span>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>

          <!-- Logout -->
          <li class="my-px">
            <button id="btnLogout" class="flex flex-row items-center h-12 px-4 w-full rounded-lg text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 text-left transition">
              <span class="flex items-center justify-center text-lg text-red-400 dark:text-red-300">
                <i class="bi bi-box-arrow-right"></i>
              </span>
              <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </li>

          <!-- Profile -->
          <li class="my-px">
            <div id="profile" class="flex flex-row items-center h-12 px-4 w-full rounded-lg bg-white text-gray-700 hover:bg-gray-100 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700 text-left transition">
              <div class="avatar mr-3 -ml-4">
                <div class="w-10 rounded-full">
                  <img id="employeePhoto" src="/images/default-avatar.png" alt="Employee Photo" />
                </div>
              </div>
              <span class="ml-3" id="employeeName">Loading...</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="p-4 bg-white dark:bg-gray-800 shadow flex justify-between items-center transition-colors">
        <h1 class="text-xl font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h1>
        <div class="flex space-x-3">
          <button id="btnRefresh" class="btn btn-outline btn-sm flex items-center">
            <i class="bi bi-arrow-clockwise mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
          <button id="btnHelp" class="btn btn-outline btn-sm flex items-center">
            <i class="bi bi-question-circle mr-1"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ
          </button>
        </div>
      </header>
      
      <!-- Main Content Area -->
      <main class="flex-1 p-6 overflow-y-auto">
        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <p class="text-2xl font-bold" id="totalContracts">0</p>
              </div>
              <i class="bi bi-file-text text-3xl text-blue-500"></i>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</p>
                <p class="text-2xl font-bold text-green-600" id="activeContracts">0</p>
              </div>
              <i class="bi bi-check-circle text-3xl text-green-500"></i>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                <p class="text-2xl font-bold text-red-600" id="overdueContracts">0</p>
              </div>
              <i class="bi bi-exclamation-triangle text-3xl text-red-500"></i>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                <p class="text-2xl font-bold text-blue-600" id="completedContracts">0</p>
              </div>
              <i class="bi bi-trophy text-3xl text-blue-500"></i>
            </div>
          </div>
        </div>
        
        <!-- Filter Tabs -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-6">
          <div class="flex flex-wrap gap-2">
            <button class="filter-tab btn btn-sm btn-primary" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="filter-tab btn btn-sm btn-outline" data-filter="active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</button>
            <button class="filter-tab btn btn-sm btn-outline" data-filter="overdue">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>
            <button class="filter-tab btn btn-sm btn-outline" data-filter="new">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞</button>
            <button class="filter-tab btn btn-sm btn-outline" data-filter="completed">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
          </div>
        </div>
        
        <!-- Installment Status Container -->
        <div id="installmentStatus" class="animate-fadeIn">
          <!-- Dynamic content will be loaded here -->
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="hidden">
          <div class="flex justify-center items-center py-12">
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
              <p class="mt-4 text-gray-600 dark:text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="hidden">
          <div class="bg-white dark:bg-gray-800 p-12 rounded-lg shadow-sm text-center">
            <i class="bi bi-inbox text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p class="text-gray-600 dark:text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Utility functions
    function showToast(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Use the existing showNotification function if available
      if (typeof showNotification === 'function') {
        showNotification(message, type);
      }
    }

    let lottieAnimation = null;
    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => response.json())
            .then(animationData => {
              console.log('‚úÖ Lottie animation data loaded successfully');
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: false,
                animationData: animationData
              });
            })
            .catch(error => {
              console.warn('Failed to load Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        }
        if (lottieAnimation) lottieAnimation.play();
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount || 0);
    }

    function formatDate(date) {
      if (!date) return '-';
      return new Date(date).toLocaleDateString('th-TH');
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Security Configuration
      const CONFIG = {
        API_TIMEOUT: 30000,
        RETRY_ATTEMPTS: 3,
        RETRY_DELAY: 1000
      };

      // Get CSRF Token
      function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
      }

      // Input Sanitization
      function sanitizeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
      }

      function escapeHtml(text) {
        if (!text) return '';
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
      }

      // Enhanced Authentication Check
      const authToken = localStorage.getItem('authToken');
    
      if (!authToken) {
        console.error('No authentication token found');
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/login';
        return;
      }
    
      let sessionId = sessionStorage.getItem('sessionId');
    
      if (!sessionId) {
        sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('sessionId', sessionId);
      }

      // API headers with security
      const headers = {
        'Authorization': 'Bearer ' + authToken,
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken(),
        'X-Session-Id': sessionId
      };

      // Check token expiration periodically
      setInterval(() => {
        const token = localStorage.getItem('authToken');
        if (!token) {
          window.location.href = '/login';
        }
      }, 60000);

      // Notification System
      function showNotification(message, type = 'info') {
        const notificationDiv = document.createElement('div');
        const notificationId = 'notification-' + Date.now();
        notificationDiv.id = notificationId;
    
        const typeConfig = {
          error: 'bg-red-100 border-red-500 text-red-700',
          success: 'bg-green-100 border-green-500 text-green-700',
          warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
          info: 'bg-blue-100 border-blue-500 text-blue-700'
        };
    
        notificationDiv.className = `fixed top-4 right-4 ${typeConfig[type]} border-l-4 p-4 rounded shadow-lg z-50 animate-fadeIn`;
    
        const container = document.createElement('div');
        container.className = 'flex items-center';
    
        const messageP = document.createElement('p');
        messageP.textContent = message;
        container.appendChild(messageP);
    
        const closeBtn = document.createElement('button');
        closeBtn.className = 'ml-4 font-bold';
        closeBtn.textContent = '√ó';
        closeBtn.addEventListener('click', () => {
          document.getElementById(notificationId).remove();
        });
        container.appendChild(closeBtn);
    
        notificationDiv.appendChild(container);
        document.body.appendChild(notificationDiv);
    
        setTimeout(() => {
          const element = document.getElementById(notificationId);
          if (element) element.remove();
        }, 5000);
      }

      // API Request with retry logic
      async function apiRequest(url, options = {}, retries = CONFIG.RETRY_ATTEMPTS) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);
    
          const response = await fetch(url, {
            ...options,
            headers: { ...headers, ...options.headers },
            signal: controller.signal
          });
    
          clearTimeout(timeoutId);
    
          if (!response.ok) {
            if (response.status === 401) {
              localStorage.clear();
              sessionStorage.clear();
              window.location.href = '/login';
              return null;
            }
            throw new Error(`HTTP ${response.status}`);
          }
    
          const data = await response.json();
          return data;
        } catch (error) {
          if (retries > 0 && error.name !== 'AbortError') {
            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
            return apiRequest(url, options, retries - 1);
          }
          throw error;
        }
      }

      // Dark Mode Toggle
      const btnToggleDark = document.getElementById('btnToggleDark');
      const darkModeLabel = document.getElementById('darkModeLabel');
    
      function toggleDarkMode() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.theme = 'light';
          darkModeLabel.textContent = 'Dark Mode';
        } else {
          document.documentElement.classList.add('dark');
          localStorage.theme = 'dark';
          darkModeLabel.textContent = 'Light Mode';
        }
      }
    
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        darkModeLabel.textContent = 'Light Mode';
      }
    
      btnToggleDark.addEventListener('click', toggleDarkMode);

      // Sidebar Toggle
      const btnToggleMenu = document.getElementById('btnToggleMenu');
      const sidebar = document.querySelector('aside');
    
      btnToggleMenu.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        const icon = btnToggleMenu.querySelector('i');
        if (sidebar.classList.contains('collapsed')) {
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        } else {
          icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
        }
      });

      // Logout functionality
      document.getElementById('btnLogout').addEventListener('click', function() {
        showConfirmDialog('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', (confirmed) => {
          if (confirmed) {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/logout';
          }
        });
      });

      // Custom Confirmation Dialog
      function showConfirmDialog(message, callback) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    
        const dialog = document.createElement('div');
        dialog.className = 'bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4';
    
        const messageP = document.createElement('p');
        messageP.className = 'text-gray-900 dark:text-white mb-6';
        messageP.textContent = message;
    
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'flex justify-end space-x-3';
    
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-outline';
        cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
        cancelBtn.addEventListener('click', () => {
          modal.remove();
          if (callback) callback(false);
        });
    
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
        confirmBtn.addEventListener('click', () => {
          modal.remove();
          if (callback) callback(true);
        });
    
        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);
        dialog.appendChild(messageP);
        dialog.appendChild(buttonsDiv);
        modal.appendChild(dialog);
        document.body.appendChild(modal);
      }

      // Load employee profile
      async function loadEmployeeProfile() {
        try {
          const data = await apiRequest('/api/users/me');
          if (data && data.success && data.data) {
            document.getElementById('employeeName').textContent = sanitizeHTML(data.data.name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ Pattani');
            const photoElement = document.getElementById('employeePhoto');
            if (photoElement) {
              photoElement.src = data.data.photo || getAvatarPlaceholder(40);
              photoElement.onerror = function() {
                this.onerror = null;
                this.src = getAvatarPlaceholder(40);
              };
            }
          }
        } catch (error) {
          console.error('Error loading profile:', error);
          document.getElementById('employeeName').textContent = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ Pattani';
          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = getAvatarPlaceholder(40);
          }
        }
      }
    
      // Avatar placeholder function
      function getAvatarPlaceholder(size = 40) {
        return 'data:image/svg+xml;charset=UTF-8,%3Csvg width=\'' + size + '\' height=\'' + size + '\' viewBox=\'0 0 ' + size + ' ' + size + '\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Ccircle cx=\'' + (size/2) + '\' cy=\'' + (size/2) + '\' r=\'' + (size/2) + '\' fill=\'%23E5E7EB\'/%3E%3Cpath d=\'M' + (size/2) + ' ' + (size*0.3) + 'c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm0 14c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z\' fill=\'%236B7280\'/%3E%3C/svg%3E';
      }

      // Make functions globally available
      window.showToast = showToast;
      window.showLoading = showLoading;
      window.formatCurrency = formatCurrency;
      window.formatDate = formatDate;
      window.getAvatarPlaceholder = getAvatarPlaceholder;

      // Global contract data
      let allContracts = [];
      let currentFilter = 'all';


      // Load installment status from API
      async function loadInstallmentStatus() {
        const container = document.getElementById('installmentStatus');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
    
        // Show loading
        loadingState.classList.remove('hidden');
        emptyState.classList.add('hidden');
        container.innerHTML = '';
    
        try {
          // Try multiple possible API endpoints
          let data;
          const possibleEndpoints = [
            '/api/loan/installment/contracts',
            '/api/contracts',
            '/api/loan/contracts',
            '/api/loan/contracts',
            '/api/loan/status'
          ];
    
          for (const endpoint of possibleEndpoints) {
            try {
              console.log(`Trying endpoint: ${endpoint}`);
              data = await apiRequest(endpoint);
              if (data && (data.success || data.data)) {
                console.log(`‚úÖ Successfully loaded data from: ${endpoint}`);
                break;
              }
            } catch (endpointError) {
              console.log(`‚ùå Failed to load from ${endpoint}:`, endpointError.message);
              continue;
            }
          }
    
          // If no API endpoint worked, show empty state
          if (!data || (!data.success && !data.data)) {
            console.log('üìã No API endpoint available, showing empty state');
            allContracts = [];
            loadingState.classList.add('hidden');
            emptyState.classList.remove('hidden');
            updateStats();
            return;
          }
    
          if (data && data.success && Array.isArray(data.data)) {
            allContracts = data.data;
    
            if (allContracts.length === 0) {
              loadingState.classList.add('hidden');
              emptyState.classList.remove('hidden');
            } else {
              updateStats();
              filterContracts(currentFilter);
            }
          } else {
            throw new Error('Invalid data format');
          }
        } catch (error) {
          console.error('Error loading contracts:', error);
          loadingState.classList.add('hidden');
    
          // Show empty state instead of sample data
          console.log('üîÑ Showing empty state due to error');
          allContracts = [];
          emptyState.classList.remove('hidden');
          updateStats();
        }
      }

      // Update statistics
      function updateStats() {
        const stats = {
          total: allContracts.length,
          active: 0,
          overdue: 0,
          completed: 0
        };
    
        allContracts.forEach(contract => {
          const status = calculateStatus(contract);
          if (status.type === 'completed') stats.completed++;
          else if (status.type === 'overdue') stats.overdue++;
          else if (status.type === 'normal' || status.type === 'new') stats.active++;
        });
    
        document.getElementById('totalContracts').textContent = stats.total;
        document.getElementById('activeContracts').textContent = stats.active;
        document.getElementById('overdueContracts').textContent = stats.overdue;
        document.getElementById('completedContracts').textContent = stats.completed;
      }

      // Filter contracts
      function filterContracts(filter) {
        currentFilter = filter;
        const container = document.getElementById('installmentStatus');
        const loadingState = document.getElementById('loadingState');
    
        loadingState.classList.add('hidden');
        container.innerHTML = '';
    
        let filteredContracts = allContracts;
    
        if (filter !== 'all') {
          filteredContracts = allContracts.filter(contract => {
            const status = calculateStatus(contract);
            if (filter === 'active') return status.type === 'normal';
            if (filter === 'overdue') return status.type === 'overdue';
            if (filter === 'new') return status.type === 'new';
            if (filter === 'completed') return status.type === 'completed';
            return false;
          });
        }
    
        if (filteredContracts.length === 0) {
          container.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-800 p-8 rounded-lg text-center">
              <i class="bi bi-search text-4xl text-gray-400 mb-3"></i>
              <p class="text-gray-600 dark:text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
            </div>
          `;
        } else {
          filteredContracts.forEach(contract => {
            const card = createStatusCard(contract);
            container.appendChild(card);
          });
        }
      }

      // Create status card (secure version)
      function createStatusCard(contract) {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm mb-6';
    
        const status = calculateStatus(contract);
        const progress = calculateProgress(contract);
    
        // Main container
        const mainContainer = document.createElement('div');
        mainContainer.className = 'flex flex-col md:flex-row items-start md:items-center';
    
        // Product info section
        const productSection = document.createElement('div');
        productSection.className = 'flex items-center mb-4 md:mb-0 md:mr-6';
    
        const productImg = document.createElement('img');
        productImg.src = contract.productImage || '/api/placeholder/120/120';
        productImg.alt = sanitizeHTML(contract.productName);
        productImg.className = 'rounded-xl w-24 h-24 object-cover mr-4';
        productImg.onerror = function() {
          this.onerror = null;
          this.src = '/uploads/default-avatar.svg';
        };
    
        const productInfo = document.createElement('div');
        const productName = document.createElement('h3');
        productName.className = 'font-semibold text-lg';
        productName.textContent = contract.productName || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    
        const productDesc = document.createElement('p');
        productDesc.className = 'text-gray-600 dark:text-gray-400';
        productDesc.textContent = contract.productDescription || '';
    
        const productPrice = document.createElement('p');
        productPrice.className = 'text-primary-600 font-medium';
        productPrice.textContent = `‡∏ø${Math.max(0, contract.totalAmount || 0).toLocaleString('th-TH')}`;
    
        productInfo.appendChild(productName);
        productInfo.appendChild(productDesc);
        productInfo.appendChild(productPrice);
        productSection.appendChild(productImg);
        productSection.appendChild(productInfo);
    
        // Progress section
        const progressSection = document.createElement('div');
        progressSection.className = 'flex-1 w-full md:w-auto';
    
        // Status badge and description
        const statusDiv = document.createElement('div');
        statusDiv.className = 'flex items-center mb-2';
        statusDiv.innerHTML = getStatusBadge(status);
    
        const statusDesc = document.createElement('span');
        statusDesc.className = 'text-sm text-gray-600 dark:text-gray-400';
        statusDesc.textContent = getStatusDescription(status, contract);
        statusDiv.appendChild(statusDesc);
    
        // Progress bar
        const progressBar = document.createElement('div');
        progressBar.className = 'w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-1';
        const progressFill = document.createElement('div');
        progressFill.className = `${getProgressBarColor(status)} h-2.5 rounded-full`;
        progressFill.style.width = `${progress}%`;
        progressBar.appendChild(progressFill);
    
        // Progress text
        const progressText = document.createElement('div');
        progressText.className = 'flex justify-between text-sm';
        const paidText = document.createElement('span');
        paidText.textContent = `‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${contract.paidPeriods || 0} ‡∏á‡∏ß‡∏î`;
        const remainText = document.createElement('span');
        remainText.textContent = `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${contract.remainingPeriods || 0} ‡∏á‡∏ß‡∏î`;
        progressText.appendChild(paidText);
        progressText.appendChild(remainText);
    
        progressSection.appendChild(statusDiv);
        progressSection.appendChild(progressBar);
        progressSection.appendChild(progressText);
    
        mainContainer.appendChild(productSection);
        mainContainer.appendChild(progressSection);
        card.appendChild(mainContainer);
    
        // Add warning/info messages if needed
        if (status.type === 'overdue') {
          const warning = createWarningElement('overdue', contract);
          card.appendChild(warning);
        } else if (status.type === 'new') {
          const info = createWarningElement('new', contract);
          card.appendChild(info);
        }
    
        // Payment info grid
        const paymentGrid = createPaymentGrid(contract, status);
        card.appendChild(paymentGrid);
    
        return card;
      }

      // Create warning/info element
      function createWarningElement(type, contract) {
        const container = document.createElement('div');
    
        if (type === 'overdue') {
          container.className = 'bg-red-50 dark:bg-red-900/30 p-4 rounded-lg mt-4 mb-4';
          container.innerHTML = `
            <div class="flex items-start">
              <i class="bi bi-exclamation-triangle-fill text-red-600 dark:text-red-400 text-xl mr-3"></i>
              <div>
                <h4 class="font-medium text-red-700 dark:text-red-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h4>
                <p class="text-sm text-red-600 dark:text-red-300">
                  ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${sanitizeHTML(contract.overduePeriods || 1)} ‡∏á‡∏ß‡∏î 
                  ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${Math.max(0, contract.overdueAmount || 0).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó 
                  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö
                </p>
              </div>
            </div>
          `;
        } else if (type === 'new') {
          container.className = 'bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg mt-4 mb-4';
          const firstPaymentDate = contract.firstPaymentDate ?
            new Date(contract.firstPaymentDate).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          container.innerHTML = `
            <div class="flex items-start">
              <i class="bi bi-info-circle-fill text-amber-600 dark:text-amber-400 text-xl mr-3"></i>
              <div>
                <h4 class="font-medium text-amber-700 dark:text-amber-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å</h4>
                <p class="text-sm text-amber-600 dark:text-amber-300">
                  ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${sanitizeHTML(firstPaymentDate)}
                </p>
              </div>
            </div>
          `;
        }
    
        return container;
      }

      // Create payment info grid
      function createPaymentGrid(contract, status) {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-3 gap-6 mt-6';
    
        // Next payment card
        const nextPaymentCard = createPaymentCard(
          getNextPaymentTitle(status),
          getNextPaymentAmount(contract, status),
          getNextPaymentDate(contract, status),
          getAmountColor(status)
        );
    
        // Add payment button
        const paymentBtn = document.createElement('button');
        if (status.type === 'completed') {
          paymentBtn.className = 'btn btn-success btn-sm mt-2 w-full';
          paymentBtn.textContent = '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
          paymentBtn.disabled = true;
        } else {
          const buttonClass = status.type === 'overdue' ? 'btn-error' :
                            status.type === 'new' ? 'btn-warning' : 'btn-primary';
          const buttonText = status.type === 'overdue' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô' :
                           status.type === 'new' ? '‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å' : '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
    
          paymentBtn.className = `btn ${buttonClass} btn-sm mt-2 w-full`;
          paymentBtn.textContent = buttonText;
          paymentBtn.addEventListener('click', () => makePayment(contract.contractNo));
        }
        nextPaymentCard.appendChild(paymentBtn);
    
        // Paid amount card
        const paidCard = createPaymentCard(
          '‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß',
          `‡∏ø${Math.max(0, contract.paidAmount || 0).toLocaleString('th-TH')}`,
          `‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ø${Math.max(0, contract.totalAmount || 0).toLocaleString('th-TH')}`,
          'text-green-600 dark:text-green-400'
        );
    
        const historyBtn = document.createElement('button');
        historyBtn.className = 'btn btn-outline btn-sm mt-2 w-full';
        historyBtn.textContent = '‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞';
        historyBtn.disabled = !contract.paidAmount || contract.paidAmount === 0;
        historyBtn.addEventListener('click', () => viewPaymentHistory(contract.contractNo));
        paidCard.appendChild(historyBtn);
    
        // Remaining amount card
        const remainingCard = createPaymentCard(
          '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠',
          `‡∏ø${Math.max(0, contract.remainingAmount || 0).toLocaleString('th-TH')}`,
          `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${contract.remainingPeriods || 0} ‡∏á‡∏ß‡∏î (‡∏à‡∏≤‡∏Å ${contract.totalPeriods || 0} ‡∏á‡∏ß‡∏î)`,
          'text-gray-600 dark:text-gray-400'
        );
    
        const detailsBtn = document.createElement('button');
        detailsBtn.className = 'btn btn-outline btn-sm mt-2 w-full';
        detailsBtn.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
        detailsBtn.addEventListener('click', () => viewContractDetails(contract.contractNo));
        remainingCard.appendChild(detailsBtn);
    
        grid.appendChild(nextPaymentCard);
        grid.appendChild(paidCard);
        grid.appendChild(remainingCard);
    
        return grid;
      }

      // Create payment card element
      function createPaymentCard(title, amount, description, amountColor) {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg';
    
        const titleEl = document.createElement('h4');
        titleEl.className = 'text-sm text-gray-500 dark:text-gray-400 mb-1';
        titleEl.textContent = title;
    
        const amountEl = document.createElement('p');
        amountEl.className = `text-2xl font-bold ${amountColor}`;
        amountEl.textContent = amount;
    
        const descEl = document.createElement('p');
        descEl.className = 'text-sm text-gray-600 dark:text-gray-400';
        descEl.textContent = description;
    
        card.appendChild(titleEl);
        card.appendChild(amountEl);
        card.appendChild(descEl);
    
        return card;
      }

      // Calculate status
      function calculateStatus(contract) {
        if (!contract.firstPaymentDate || new Date(contract.firstPaymentDate) > new Date()) {
          return { type: 'new', severity: 'warning' };
        }
    
        if (contract.overdueAmount > 0) {
          const overdueDays = Math.floor((new Date() - new Date(contract.nextDueDate)) / (1000 * 60 * 60 * 24));
          return { type: 'overdue', severity: 'error', days: overdueDays };
        }
    
        if (contract.remainingAmount === 0) {
          return { type: 'completed', severity: 'success' };
        }
    
        return { type: 'normal', severity: 'success' };
      }

      // Calculate progress percentage
      function calculateProgress(contract) {
        const totalAmount = Math.max(0, contract.totalAmount || 0);
        const paidAmount = Math.max(0, contract.paidAmount || 0);
        if (totalAmount === 0) return 0;
        return Math.min(100, Math.round((paidAmount / totalAmount) * 100));
      }

      // Get status badge HTML
      function getStatusBadge(status) {
        const badges = {
          'new': '<span class="badge badge-warning py-1 px-2 mr-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞</span>',
          'normal': '<span class="badge badge-success py-1 px-2 mr-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>',
          'overdue': '<span class="badge badge-error py-1 px-2 mr-2">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>',
          'completed': '<span class="badge badge-info py-1 px-2 mr-2">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>'
        };
        return badges[status.type] || '';
      }

      // Get status description
      function getStatusDescription(status, contract) {
        switch (status.type) {
          case 'new':
            return contract.firstPaymentDate ?
              `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å: ${new Date(contract.firstPaymentDate).toLocaleDateString('th-TH')}` : '';
          case 'normal':
            return contract.nextDueDate ?
              `‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${new Date(contract.nextDueDate).toLocaleDateString('th-TH')}` : '';
          case 'overdue':
            return `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ ${status.days || 0} ‡∏ß‡∏±‡∏ô`;
          case 'completed':
            return '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏á‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß';
          default:
            return '';
        }
      }

      // Get progress bar color
      function getProgressBarColor(status) {
        const colors = {
          'new': 'bg-amber-600',
          'normal': 'bg-blue-600',
          'overdue': 'bg-red-600',
          'completed': 'bg-green-600'
        };
        return colors[status.type] || 'bg-gray-600';
      }

      // Helper functions for payment info
      function getNextPaymentTitle(status) {
        switch (status.type) {
          case 'new': return '‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å';
          case 'overdue': return '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
          case 'completed': return '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
          default: return '‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        }
      }

      function getAmountColor(status) {
        switch (status.type) {
          case 'new': return 'text-amber-600 dark:text-amber-400';
          case 'overdue': return 'text-red-600 dark:text-red-400';
          case 'completed': return 'text-green-600 dark:text-green-400';
          default: return 'text-blue-600 dark:text-blue-400';
        }
      }

      function getNextPaymentAmount(contract, status) {
        if (status.type === 'completed') return '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
        if (status.type === 'overdue') return `‡∏ø${Math.max(0, contract.overdueAmount || 0).toLocaleString('th-TH')}`;
        return `‡∏ø${Math.max(0, contract.monthlyPayment || 0).toLocaleString('th-TH')}`;
      }

      function getNextPaymentDate(contract, status) {
        if (status.type === 'completed') return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
        if (status.type === 'new' && contract.firstPaymentDate) {
          return `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${new Date(contract.firstPaymentDate).toLocaleDateString('th-TH')}`;
        }
        if (contract.nextDueDate) {
          return `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${new Date(contract.nextDueDate).toLocaleDateString('th-TH')}`;
        }
        return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }

      // Action functions
      function viewPaymentHistory(contractNo) {
        window.location.href = `/loan/installment_history.html?contract=${encodeURIComponent(contractNo)}`;
      }

      function viewContractDetails(contractNo) {
        window.location.href = `/loan/customerDetail.html?contract=${encodeURIComponent(contractNo)}`;
      }

      function makePayment(contractNo) {
        window.location.href = `/loan/repayment.html?contract=${encodeURIComponent(contractNo)}`;
      }

      // Filter tab event listeners
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab styling
          document.querySelectorAll('.filter-tab').forEach(t => {
            t.classList.remove('btn-primary');
            t.classList.add('btn-outline');
          });
          this.classList.remove('btn-outline');
          this.classList.add('btn-primary');
    
          // Filter contracts
          const filter = this.dataset.filter;
          filterContracts(filter);
        });
      });

      // Refresh button
      document.getElementById('btnRefresh').addEventListener('click', function() {
        showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
        loadInstallmentStatus();
      });

      // Help button
      document.getElementById('btnHelp').addEventListener('click', function() {
        showConfirmDialog(
          '‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n\n' +
          '‚Ä¢ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥\n' +
          '‚Ä¢ ‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞\n' +
          '‚Ä¢ ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞\n' +
          '‚Ä¢ ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô = ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
          () => {}
        );
      });

      // Initialize
      try {
        await loadEmployeeProfile();
        await loadInstallmentStatus();
      } catch (error) {
        console.error('Initialization error:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      }
    });
  </script>

  <script>
    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });
  </script>
</body>
</html>