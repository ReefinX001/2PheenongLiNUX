<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="/js/loading-system.js" 
          onerror="console.warn('‚ö†Ô∏è Failed to load loading-system.js, will use fallback')"></script>

  <!-- Enhanced LoadingSystem fallback -->
  <script>
    // Enhanced LoadingSystem fallback
    window.LoadingSystem = window.LoadingSystem || {};

    // Create a more robust fallback system
    const createLoadingFallback = () => {
      return {
        show: function(options = {}) {
          console.log('üíª LoadingSystem.show() called with:', options);
    
          // Return a unique loader ID
          const loaderId = 'fallback-loader-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
          // Create a simple loading overlay if one doesn't exist
          if (!document.getElementById('fallback-loading-overlay')) {
            const overlay = document.createElement('div');
            overlay.id = 'fallback-loading-overlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.innerHTML = `
              <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                <span class="text-gray-700 dark:text-gray-300">${options.message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'}</span>
              </div>
            `;
            document.body.appendChild(overlay);
    
            // Auto-hide after 10 seconds to prevent stuck loading
            setTimeout(() => {
              const existingOverlay = document.getElementById('fallback-loading-overlay');
              if (existingOverlay) {
                existingOverlay.remove();
              }
            }, 10000);
          }
    
          return loaderId;
        },
    
        hide: function(loaderId) {
          console.log('üíª LoadingSystem.hide() called for:', loaderId);
          const overlay = document.getElementById('fallback-loading-overlay');
          if (overlay) {
            overlay.remove();
          }
        },
    
        hideAll: function() {
          console.log('üíª LoadingSystem.hideAll() called');
          const overlay = document.getElementById('fallback-loading-overlay');
          if (overlay) {
            overlay.remove();
          }
        }
      };
    };

    // Check if LoadingSystem methods exist, if not create fallbacks
    ['show', 'hide', 'hideAll'].forEach(methodName => {
      if (typeof window.LoadingSystem[methodName] !== 'function') {
        const fallbackSystem = createLoadingFallback();
        window.LoadingSystem[methodName] = fallbackSystem[methodName];
        console.log(`üîß Created fallback for LoadingSystem.${methodName}()`);
      }
    });

    // Add a compatibility layer for backward compatibility
    if (typeof window.showLoading !== 'function') {
      window.showLoading = function(show = true, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
        if (show) {
          return window.LoadingSystem.show({ message });
        } else {
          window.LoadingSystem.hideAll();
        }
      };
    }

    console.log('üöÄ LoadingSystem fallback initialized successfully');
  </script>

  <!-- Tailwind CSS & DaisyUI -->
  <!-- 
    ‚ö†Ô∏è Development Mode: Using Tailwind CDN
    üì¶ For Production: Please install Tailwind CLI or PostCSS plugin
    üìö Guide: https://tailwindcss.com/docs/installation
  -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt', 'sans-serif'] },
        },
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- jQuery & Day.js (locale ‡πÑ‡∏ó‡∏¢) -->
  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs/locale/th.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Loan Sidebar JS -->
  <script src="/views/loan/loan-sidebar.js"></script>
  
  <!-- Loan-Installment Integration JS -->
  <script src="/views/loan/js/loan-installment-integration.js"></script>

  <script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ò‡∏µ‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      const isDark = savedTheme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
    
    // Suppress Tailwind CDN warning in development
    const originalWarn = console.warn;
    console.warn = (...args) => {
      const message = args[0];
      if (message && typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
        // Silently suppress this warning in development
        return;
      }
      originalWarn.apply(console, args);
    };
  </script>

  <style>
    :root {
      --primary-color: #0d6efd;
      --primary-hover: #138af2;
      --bg-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
    }

    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: "Prompt", sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    html { scroll-behavior: smooth; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }

    /* ===== CARD STYLES ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_pattani.html ===== */
    .card {
      background: #ffffff !important;
      border: 1px solid #f1f5f9 !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      margin-bottom: 0.75rem !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      color: #374151 !important;
    }

    .card:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      border-color: #e2e8f0 !important;
    }

    /* Dark mode card styles */
    .dark .card {
      background: #1f2937 !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
    }

    .dark .card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      border-color: #4b5563 !important;
    }

    /* Chart container heights */
    .chart-container {
      height: 300px !important;
      max-height: 300px !important;
    }
    
    .chart-container canvas {
      max-height: 280px !important;
    }
    
    /* Small chart container */
    .small-chart-container {
      height: 240px !important;
      max-height: 240px !important;
    }
    
    .small-chart-container canvas {
      max-height: 220px !important;
    }

    .status-paid { color: #374151; }
    .status-pending { color: #6b7280; }
    .status-late { color: #4b5563; }
    
    /* Loading spinner */
    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    [data-theme="dark"] .loading-spinner {
      border-color: #555555;
      border-top-color: var(--primary-color);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Override button styles to use DaisyUI */
    .btn {
      @apply inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg transition-colors;
    }

    .btn-primary {
      @apply bg-blue-600 text-white hover:bg-blue-700;
    }

    .btn-secondary {
      @apply bg-gray-600 text-white hover:bg-gray-700;
    }

    /* Input styles */
    .input {
      @apply block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
    }

    .dark .input {
      @apply bg-gray-700 border-gray-600 text-white;
    }

    .select {
      @apply block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
    }

    .dark .select {
      @apply bg-gray-700 border-gray-600 text-white;
    }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    [data-theme=\"dark\"] .loading-overlay {
      background: rgba(31, 41, 55, 0.9);
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ loan-sidebar.js -->
  <div id="sidebarContainer"></div>

  <!-- Main Content -->
  <div id="mainContent" class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out">
    <main class="p-6 overflow-y-auto space-y-6">
      <!-- Date Filter Controls -->
      <section class="card">
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center">
            <label for="periodFilter" class="text-sm text-gray-700 dark:text-gray-300 mr-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
            <select id="periodFilter" class="select select-bordered">
              <option value="day">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
              <option value="month" selected>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="year">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
            </select>
          </div>
          
          <div class="flex items-center" id="monthSelector">
            <label for="monthFilter" class="text-sm text-gray-700 dark:text-gray-300 mr-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
            <select id="monthFilter" class="select select-bordered">
              <option value="0">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
              <option value="1">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
              <option value="2">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
              <option value="3">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
              <option value="4">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
              <option value="5">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
              <option value="6">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
              <option value="7">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
              <option value="8">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
              <option value="9">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
              <option value="10">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
              <option value="11">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
            </select>
          </div>
          
          <div class="flex items-center" id="yearSelector">
            <label for="yearFilter" class="text-sm text-gray-700 dark:text-gray-300 mr-2">‡∏õ‡∏µ:</label>
            <select id="yearFilter" class="select select-bordered">
              <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
            </select>
          </div>

          <div class="flex items-center" id="daySelector" style="display: none;">
            <label for="dateFilter" class="text-sm text-gray-700 dark:text-gray-300 mr-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="dateFilter" class="input input-bordered">
          </div>
          
          <button id="applyFilters" class="btn btn-primary">
            <i class="bi bi-funnel mr-2"></i>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </button>
          <button id="resetFilters" class="btn btn-secondary">
            <i class="bi bi-arrow-clockwise mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
          </button>

          <div class="text-xs ml-auto text-gray-500 dark:text-gray-400">
            ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdated" class="font-medium">-</span>
          </div>
        </div>
      </section>

      <!-- Summary Cards -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div data-summary="totalValue" class="card">
          <div class="stat">
            <div class="stat-figure text-primary">
              <i class="bi bi-currency-exchange text-2xl"></i>
            </div>
            <div class="stat-title">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value text-primary">0 ‡∏ø</div>
            <div id="totalValueDelta" class="stat-desc">
              <span>0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            </div>
          </div>
        </div>
        <div data-summary="totalRequests" class="card">
          <div class="stat">
            <div class="stat-figure text-secondary">
              <i class="bi bi-list-ul text-2xl"></i>
            </div>
            <div class="stat-title">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value text-secondary">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            <div id="totalRequestsDelta" class="stat-desc">
              <span>0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            </div>
          </div>
        </div>
        <div data-summary="overdueCount" class="card">
          <div class="stat">
            <div class="stat-figure text-warning">
              <i class="bi bi-exclamation-triangle text-2xl"></i>
            </div>
            <div class="stat-title">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
            <div class="stat-value text-warning">0 ‡∏£‡∏≤‡∏¢</div>
            <div id="overdueCountDelta" class="stat-desc">
              <span>0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            </div>
          </div>
        </div>
        <div data-summary="onTimeRate" class="card">
          <div class="stat">
            <div class="stat-figure text-success">
              <i class="bi bi-check-circle text-2xl"></i>
            </div>
            <div class="stat-title">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div class="stat-value text-success">0%</div>
            <div id="onTimeRateDelta" class="stat-desc">
              <span>0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            </div>
          </div>
        </div>
      </section>

      <!-- Debtor Overview (New) -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div data-summary="totalOutstanding" class="card">
          <div class="stat">
            <div class="stat-figure text-blue-500">
              <i class="bi bi-wallet2 text-2xl"></i>
            </div>
            <div class="stat-title">‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value font-semibold text-blue-500">0 ‡∏ø</div>
            <div id="totalOutstandingBreakdown" class="stat-desc text-xs leading-snug">
              <span class="block">‡∏Ñ‡πâ‡∏≤‡∏á: 0 ‡∏ø</span>
              <span class="block">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î: 0 ‡∏ø</span>
            </div>
          </div>
        </div>
        <!-- ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á -->
        <div data-summary="overdueAmount" class="card">
          <div class="stat">
            <div class="stat-figure text-red-500">
              <i class="bi bi-calendar2-x text-2xl"></i>
            </div>
            <div class="stat-title">‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á</div>
            <div class="stat-value font-semibold text-red-500">0 ‡∏ø</div>
            <div id="overdueAmountBreakdown" class="stat-desc text-xs leading-snug">
              <span class="block">1-30 ‡∏ß‡∏±‡∏ô: 0 ‡∏ø</span>
              <span class="block">31-60 ‡∏ß‡∏±‡∏ô: 0 ‡∏ø</span>
              <span class="block">60+ ‡∏ß‡∏±‡∏ô: 0 ‡∏ø</span>
            </div>
          </div>
        </div>
        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div data-summary="totalDebtors" class="card">
          <div class="stat">
            <div class="stat-figure text-teal-500">
              <i class="bi bi-people text-2xl"></i>
            </div>
            <div class="stat-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-value font-semibold text-teal-500">0 ‡∏£‡∏≤‡∏¢</div>
            <div class="stat-desc">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á -->
        <div data-summary="overdueDebtors" class="card">
          <div class="stat">
            <div class="stat-figure text-orange-500">
              <i class="bi bi-person-dash text-2xl"></i>
            </div>
            <div class="stat-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á</div>
            <div class="stat-value font-semibold text-orange-500">0 ‡∏£‡∏≤‡∏¢</div>
            <div id="overdueDebtorsBreakdown" class="stat-desc text-xs leading-snug">
              <span class="block">1 ‡∏á‡∏ß‡∏î: 0</span>
              <span class="block">2 ‡∏á‡∏ß‡∏î: 0</span>
              <span class="block">3+ ‡∏á‡∏ß‡∏î: 0</span>
            </div>
          </div>
        </div>
        <!-- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
        <div data-summary="collectionRate" class="card">
          <div class="stat">
            <div class="stat-figure text-green-500">
              <i class="bi bi-graph-up-arrow text-2xl"></i>
            </div>
            <div class="stat-title">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
            <div class="stat-value font-semibold text-green-500">0%</div>
            <div class="stat-desc">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>

        <!-- Top Debtors Summary (Enhanced UI) -->
        <div data-summary="topDebtors" class="card hover:shadow-lg transition-all">
          <div class="stat p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="stat-figure text-purple-500">
                <i class="bi bi-people-fill text-3xl"></i>
              </div>
              <div class="badge badge-secondary badge-outline">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            </div>
            <div class="stat-title text-base font-medium mb-2">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
            <div class="stat-value text-2xl font-bold text-purple-500 mb-1">0 ‡∏£‡∏≤‡∏¢</div>
            <div class="stat-desc flex items-center text-sm">
              <i class="bi bi-coin mr-1"></i>
              ‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ <span id="topDebtorsAmount" class="font-semibold ml-1">0</span> ‡∏ø
            </div>
          </div>
        </div>
      </section>

      <!-- Enhanced Debt Trends Chart -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="card hover:shadow-lg transition-all">
          <div class="flex justify-between items-center mb-6 px-2">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
            </div>
            <div class="flex items-center space-x-2">
              <div class="btn-group">
                <button id="debtTrendBtn_3m" 
                        class="btn btn-sm btn-outline gap-2">
                  <i class="bi bi-graph-up"></i>
                  3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                </button>
                <button id="debtTrendBtn_6m" 
                        class="btn btn-sm btn-outline btn-active gap-2">
                  <i class="bi bi-graph-up-arrow"></i>
                  6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                </button>
              </div>
              <div class="dropdown dropdown-end">
                <button class="btn btn-ghost btn-sm btn-square">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li><a onclick="downloadChartData('debtTrend')">
                    <i class="bi bi-download"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </a></li>
                  <li><a onclick="shareChartData('debtTrend')">
                    <i class="bi bi-share"></i>‡πÅ‡∏ä‡∏£‡πå
                  </a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="chart-container p-2 relative group">
            <div class="absolute inset-0 bg-gray-100/50 dark:bg-gray-800/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="btn btn-sm btn-ghost" onclick="toggleFullscreen('debtTrendChart')">
                <i class="bi bi-fullscreen"></i>
              </button>
            </div>
            <canvas id="debtTrendChart" class="w-full h-full"></canvas>
          </div>
          <div class="flex justify-between items-center px-4 py-2 bg-base-200/50 rounded-b-lg text-sm">
            <div class="flex items-center space-x-4">
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>
                <span>‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
              </div>
              <div class="flex items-center">
                <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                <span>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</span>
              </div>
            </div>
            <button class="btn btn-xs btn-ghost" onclick="toggleChartType('debtTrendChart')">
              <i class="bi bi-bar-chart"></i>
            </button>
          </div>
        </div>

        <!-- Branch-wise Status (New) -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h3>
            <select id="branchStatusPeriod" class="select select-bordered select-sm">
              <option value="current">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option value="last">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="table table-compact w-full">
              <thead>
                <tr>
                  <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th class="text-right">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                  <th class="text-right">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                  <th class="text-right">% ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
                </tr>
              </thead>
              <tbody id="branchStatusBody">
                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div class="btn-group">
              <button id="trendBtn_current" class="btn btn-active">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
              <button id="trendBtn_previous" class="btn">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="loanTrendChart" class="w-full h-full"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</h3>
          <div class="small-chart-container">
            <canvas id="approvalChart" class="w-full h-full"></canvas>
          </div>
        </div>
      </section>

      <!-- Daily Stats -->
      <section class="card">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-figure text-primary">
                <i class="bi bi-cash-coin text-2xl"></i>
              </div>
              <div class="stat-title">‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div id="todayRepayments" class="stat-value text-primary">0 ‡∏ø</div>
              <div class="stat-desc">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span id="todayRepaymentsCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>
          </div>
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-figure text-secondary">
                <i class="bi bi-plus-circle text-2xl"></i>
              </div>
              <div class="stat-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div id="todayNewLoans" class="stat-value text-secondary">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="stat-desc">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° <span id="todayNewLoansValue">0</span> ‡∏ø</div>
            </div>
          </div>
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-figure text-warning">
                <i class="bi bi-clock-history text-2xl"></i>
              </div>
              <div class="stat-title">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div id="todayOverdue" class="stat-value text-warning">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="stat-desc">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° <span id="todayOverdueValue">0</span> ‡∏ø</div>
            </div>
          </div>
          <div class="stats shadow">
            <div class="stat">
              <div class="stat-figure text-error">
                <i class="bi bi-lock text-2xl"></i>
              </div>
              <div class="stat-title">‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div id="todayLocked" class="stat-value text-error">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="stat-desc">‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ <span id="todayLockedFromOverdue">0</span> ‡∏ß‡∏±‡∏ô</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Proportions & Recent Loans -->
      <section class="space-y-6">
        <div class="card">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
            <div data-prop="paidOnTime" class="stat">
              <div class="stat-value text-primary">0%</div>
              <div class="stat-title">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢</div>
            </div>
            <div data-prop="overdue" class="stat">
              <div class="stat-value text-warning">0%</div>
              <div class="stat-title">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
            </div>
            <div data-prop="onSchedule" class="stat">
              <div class="stat-value text-success">0%</div>
              <div class="stat-title">‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
            </div>
            <div data-prop="totalRequests" class="stat">
              <div class="stat-value text-secondary">0</div>
              <div class="stat-title">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <a href="/status" class="btn btn-ghost btn-sm">
              ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <i class="bi bi-arrow-right ml-1"></i>
            </a>
          </div>
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead>
                <tr>
                  <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                  <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th class="text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ß‡∏î</th>
                </tr>
              </thead>
              <tbody id="recentLoansBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // Loading state management with Lottie animation
    let lottieAnimation = null;
    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (!loader) {
        console.warn('Loading overlay not found');
        return;
      }
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // Toast notification management
    // Utility functions
    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount || 0);
    }

    function formatDate(date) {
      if (!date) return '-';
      return new Date(date).toLocaleDateString('th-TH');
    }

    // Make functions globally available
    window.formatCurrency = formatCurrency;
    window.formatDate = formatDate;

    function showToast(message, type = 'error', duration = 5000) {
      const toast = document.getElementById('connectionToast');
      if (!toast) return;

      const icon = toast.querySelector('i');
      const text = toast.querySelector('span');
    
      // Update content
      text.textContent = message;
    
      // Update styling based on type
      toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'warning' ? 'bg-yellow-500' :
        'bg-red-500'
      } text-white`;
    
      icon.className = `bi ${
        type === 'success' ? 'bi-check-circle' :
        type === 'warning' ? 'bi-exclamation-triangle' :
        'bi-wifi-off'
      }`;

      // Show toast
      toast.classList.remove('hidden');

      // Auto hide
      setTimeout(() => {
        toast.classList.add('hidden');
      }, duration);
    }

    // Connection monitoring
    let isOnline = navigator.onLine;
    
    window.addEventListener('online', () => {
      if (!isOnline) {
        showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        isOnline = true;
      }
    });

    window.addEventListener('offline', () => {
      showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢');
      isOnline = false;
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Show loading initially
      showLoading(true);
      console.log('üöÄ Initializing Loan Dashboard... v2.2');
    
      // Initialize loan sidebar first
      if (typeof initializeLoanSidebar === 'function') {
        initializeLoanSidebar();
      }
    
      // Wait a bit for DOM to be fully ready
      setTimeout(async () => {
        try {
          // üîê Enhanced Authentication Check
          let token = localStorage.getItem('authToken') || localStorage.getItem('token') || sessionStorage.getItem('token');
    
          if (!token) {
            console.warn('‚ö†Ô∏è No authentication token found, redirecting to login');
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/login';
            return;
          }
    
          // Validate token format (basic JWT structure check)
          if (!token.includes('.') || token.split('.').length !== 3) {
            console.warn('‚ö†Ô∏è Invalid token format, clearing and redirecting');
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('token');
            window.location.href = '/login';
            return;
          }
    
          console.log('‚úÖ Authentication token found and validated');
    
          const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          };

          // Test token validity before proceeding
          const testAuth = async () => {
            try {
              const testResponse = await fetch('/api/loan/contracts', {
                method: 'GET',
                headers: headers,
                timeout: 5000
              });
    
              if (testResponse.status === 401 || testResponse.status === 403) {
                console.warn('üö´ Token expired or invalid, redirecting to login');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login';
                return false;
              }
    
              if (testResponse.status === 0 || !testResponse.ok) {
                console.warn('‚ö†Ô∏è Server connection issue, but continuing with cached token');
                return true; // Continue anyway for offline scenarios
              }
    
              return true;
            } catch (error) {
              console.error('Authentication test failed:', error);
              // Don't redirect on network errors, just log and continue
              return true;
            }
          };
    
          const authValid = await testAuth();
          if (!authValid) return;

        // Note: Sidebar functionality, dark mode, logout, and employee profile
        // are now handled by loan-sidebar.js
    
      // 2) ‡∏™‡∏£‡∏∏‡∏õ summary - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const loadDashboardSummary = async () => {
        try {
          console.log('üîÑ Loading real dashboard data from database...');
          const response = await fetch('/api/loan/contracts', { headers });
    
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
    
          const result = await response.json();
          console.log('üìä Raw API Response:', result);
    
          if (!result.success || !result.data) {
            throw new Error(result.error || 'No data returned');
          }
    
          const contracts = result.data;
          console.log('üìã Processing', contracts.length, 'contracts');
    
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          let totalAmount = 0;
          let activeContracts = 0;
          let totalPaid = 0;
          let overdueContracts = 0;
          let overdueAmount = 0;
          let overdue1to30 = 0;
          let overdue31to60 = 0;
          let overdue60plus = 0;
          let overdueAmount1to30 = 0;
          let overdueAmount31to60 = 0;
          let overdueAmount60plus = 0;
    
          contracts.forEach(contract => {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥
            // ‡πÉ‡∏ä‡πâ totalAmount ‡∏´‡∏£‡∏∑‡∏≠ financeAmount (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô) + downPayment
            const baseAmount = contract.totalAmount || contract.financeAmount || 0;
            const downPayment = contract.downPayment || 0;
            const contractAmount = baseAmount + downPayment;
            const paidAmount = contract.paidAmount || 0;
    
            totalAmount += contractAmount;
            totalPaid += paidAmount;
    
            if (contract.status === 'active') activeContracts++;
    
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ overdue ‡∏à‡∏£‡∏¥‡∏á
            if (contract.status === 'overdue') {
              overdueContracts++;
              const actualRemaining = contract.remainingAmount || 0;
              overdueAmount += actualRemaining;
    
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ dueDate ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ
              if (contract.dueDate) {
                const today = new Date();
                const dueDate = new Date(contract.dueDate);
                const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
    
                if (daysOverdue <= 30) {
                  overdue1to30++;
                  overdueAmount1to30 += actualRemaining;
                } else if (daysOverdue <= 60) {
                  overdue31to60++;
                  overdueAmount31to60 += actualRemaining;
                } else {
                  overdue60plus++;
                  overdueAmount60plus += actualRemaining;
                }
              }
            }
          });
    
          const totalOutstanding = totalAmount - totalPaid;
    
          const collectionRate = totalAmount > 0 ? parseFloat(((totalPaid / totalAmount) * 100).toFixed(1)) : 0;
    
          const dashboardData = {
            success: true,
            data: {
              totalContracts: contracts.length,
              activeContracts: activeContracts,
              totalAmount: totalAmount,
              totalValue: totalAmount, // alias
              overdueContracts: overdueContracts,
              overdueCount: overdueContracts, // alias
              totalOutstanding: totalOutstanding,
              totalPaid: totalPaid,
              collectionRate: collectionRate,
              onTimeRate: collectionRate, // alias
              thisMonthPayments: totalPaid,
              thisMonthContracts: contracts.length,
              avgMonthlyPayment: contracts.length > 0 ? Math.round(totalAmount / contracts.length / 12) : 0,
              overdueAmount: overdueAmount, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
              overdue1to30: overdue1to30,
              overdue31to60: overdue31to60,
              overdue60plus: overdue60plus,
              overdueAmount1to30: overdueAmount1to30,
              overdueAmount31to60: overdueAmount31to60,
              overdueAmount60plus: overdueAmount60plus,
              outstandingDue: Math.round(totalOutstanding * 0.3), // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
              outstandingNotDue: Math.round(totalOutstanding * 0.7) // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
            }
          };
    
          console.log('‚úÖ Dashboard data calculated:', dashboardData.data);
    
          // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ encoding
          const branchData = {};
          contracts.forEach(contract => {
            let branchName = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            let branchCode = '00000';
    
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ encoding ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
            if (contract.branchName) {
              const cleanBranchName = contract.branchName
                .replace(/\?+/g, '') // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ?
                .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s]/g, '') // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                .trim();
    
              if (cleanBranchName && cleanBranchName.length > 0) {
                branchName = cleanBranchName;
              } else {
                // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô
                branchName = '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å';
              }
            }
    
            if (contract.branchCode && contract.branchCode !== '00000') {
              branchCode = contract.branchCode;
            }
    
            const branchKey = `${branchCode}_${branchName}`;
    
            if (!branchData[branchKey]) {
              branchData[branchKey] = {
                branchCode: branchCode,
                branchName: branchName,
                contracts: 0,
                totalAmount: 0,
                paidAmount: 0,
                outstanding: 0,
                overdueContracts: 0,
                overdueAmount: 0
              };
            }
    
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            const amount = contract.totalAmount || contract.financeAmount || contract.downPayment || 0;
            const paid = contract.paidAmount || 0;
            const outstanding = contract.remainingAmount || 0; // ‡πÉ‡∏ä‡πâ remainingAmount ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    
            branchData[branchKey].contracts++;
            branchData[branchKey].totalAmount += amount;
            branchData[branchKey].paidAmount += paid;
            branchData[branchKey].outstanding += outstanding;
    
            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ overdue ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (contract.status === 'overdue') {
              branchData[branchKey].overdueContracts++;
              branchData[branchKey].overdueAmount += outstanding;
            }
          });
    
          // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          const branchStats = Object.values(branchData).map(branch => ({
            ...branch,
            collectionRate: branch.totalAmount > 0 ? Math.round((branch.paidAmount / branch.totalAmount) * 100) : 0,
            overdueRate: branch.contracts > 0 ? Math.round((branch.overdueContracts / branch.contracts) * 100) : 0
          }));
    
          console.log('üìä Branch stats calculated:', branchStats);
    
          return dashboardData;
    
        } catch (error) {
          console.error('‚ùå Failed to load dashboard data:', error);
    
          // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏ó‡∏ô
          console.log('üìä Error loading data - returning error response');
          return {
            success: false,
            error: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
            data: null
          };
        }
      };
    
      loadDashboardSummary()
        .then(js => {
          // Debug: Log the API response
          console.log('üìä Dashboard Summary Response:', js);
          if (js.data) {
            console.log('üìä Summary Data Details:', {
              totalContracts: js.data.totalContracts,
              activeContracts: js.data.activeContracts,
              totalAmount: js.data.totalAmount,
              overdueContracts: js.data.overdueContracts
            });
          }
    
          if (!js || !js.success) {
            console.error('Summary API failed:', js?.error || 'Unknown error');
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            const summaryCards = document.querySelectorAll('[data-summary]');
            summaryCards.forEach(card => {
              const valueEl = card.querySelector('.stat-value, .font-semibold');
              if (valueEl) {
                valueEl.textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°';
                valueEl.classList.add('text-red-400');
              }
            });
    
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ: ' + (js?.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'), 'error');
            return;
          }
          const d = js.data;

          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ
          const yearFilter    = document.getElementById('yearFilter');
          const monthFilter   = document.getElementById('monthFilter');
          const nowYear       = new Date().getFullYear();
          const nowMonth      = new Date().getMonth();
    
          for (let y = nowYear; y >= nowYear - 5; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.text = y;
            if (y === nowYear) opt.selected = true;
            yearFilter.appendChild(opt);
          }
    
          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          if (monthFilter) {
            monthFilter.value = nowMonth;
          }

          // ‡∏™‡∏•‡∏±‡∏ö selectors ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
          const periodFilter  = document.getElementById('periodFilter');
          const monthSel      = document.getElementById('monthSelector');
          const yearSel       = document.getElementById('yearSelector');
          const daySel        = document.getElementById('daySelector');
          function updateSelectors() {
            const v = periodFilter.value;
            monthSel.style.display = v === 'month' ? 'flex' : 'none';
            yearSel.style.display  = v === 'month' || v === 'year' ? 'flex' : 'none';
            daySel.style.display   = v === 'day'   ? 'flex' : 'none';
          }
          periodFilter.addEventListener('change', updateSelectors);
          updateSelectors();

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
          document.getElementById('lastUpdated').textContent =
            dayjs().locale('th').format('DD/MM/YYYY HH:mm');

          // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å with better error handling
          const updateStatElement = (selector, value, suffix = '') => {
            try {
              const element = document.querySelector(selector);
              if (element) {
                element.textContent = value + suffix;
                element.classList.remove('text-gray-400', 'text-red-400');
                return true;
              } else {
                console.warn(`Element not found: ${selector}`);
                return false;
              }
            } catch (error) {
              console.error(`Error updating ${selector}:`, error);
              return false;
            }
          };
    
          const summaryData = js.data || {};
    
          // Update main statistics with safe fallbacks
          updateStatElement('[data-summary="totalValue"] .stat-value',
            new Intl.NumberFormat('th-TH').format(summaryData.totalAmount || summaryData.totalValue || 0), ' ‡∏ø');
    
          updateStatElement('[data-summary="totalRequests"] .stat-value',
            (summaryData.totalContracts || summaryData.totalRequests || 0), ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    
          updateStatElement('[data-summary="overdueCount"] .stat-value',
            (summaryData.overdueContracts || summaryData.overdueCount || 0), ' ‡∏£‡∏≤‡∏¢');
    
          updateStatElement('[data-summary="onTimeRate"] .stat-value',
            (summaryData.collectionRate || summaryData.onTimeRate || 0), '%');

          // ‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ with safe handling
          updateStatElement('[data-summary="totalOutstanding"] .stat-value',
            new Intl.NumberFormat('th-TH').format(summaryData.totalOutstanding || 0), ' ‡∏ø');
    
          const totalOutstandingBd = document.getElementById('totalOutstandingBreakdown');
          if (totalOutstandingBd) {
            const dueAmt = new Intl.NumberFormat('th-TH').format(summaryData.outstandingDue || 0);
            const notDueAmt = new Intl.NumberFormat('th-TH').format(summaryData.outstandingNotDue || 0);
            totalOutstandingBd.innerHTML = `<span class="block">‡∏Ñ‡πâ‡∏≤‡∏á: ${dueAmt} ‡∏ø</span><span class="block">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${notDueAmt} ‡∏ø</span>`;
          }

          updateStatElement('[data-summary="overdueAmount"] .stat-value',
            new Intl.NumberFormat('th-TH').format(summaryData.overdueAmount || 0), ' ‡∏ø');
          const overdueAmountBd = document.getElementById('overdueAmountBreakdown');
          if (overdueAmountBd) {
            const breakdown = summaryData.debtAnalysis?.byAgePeriod || {};
            const a1 = new Intl.NumberFormat().format(breakdown['1-30']?.amount || 0);
            const a2 = new Intl.NumberFormat().format(breakdown['31-60']?.amount || 0);
            const a3 = new Intl.NumberFormat().format(breakdown['60+']?.amount || 0);
            overdueAmountBd.innerHTML = `<span class="block">1-30 ‡∏ß‡∏±‡∏ô: ${a1} ‡∏ø</span><span class="block">31-60 ‡∏ß‡∏±‡∏ô: ${a2} ‡∏ø</span><span class="block">60+ ‡∏ß‡∏±‡∏ô: ${a3} ‡∏ø</span>`;
          }

          const totalDebtorsEl = document.querySelector('[data-summary="totalDebtors"] .stat-value');
          if (totalDebtorsEl) totalDebtorsEl.textContent = (summaryData.totalDebtors || summaryData.totalContracts || 0) + ' ‡∏£‡∏≤‡∏¢';

          const overdueDebtorsEl = document.querySelector('[data-summary="overdueDebtors"] .stat-value');
          if (overdueDebtorsEl) overdueDebtorsEl.textContent = (summaryData.overdueContracts || 0) + ' ‡∏£‡∏≤‡∏¢';
          const overdueDebtorsBd = document.getElementById('overdueDebtorsBreakdown');
          if (overdueDebtorsBd) {
            const breakdown = summaryData.debtAnalysis?.byAgePeriod || {};
            const i1 = breakdown['1-30']?.count || 0;
            const i2 = breakdown['31-60']?.count || 0;
            const i3 = breakdown['60+']?.count || 0;
            overdueDebtorsBd.innerHTML = `<span class="block">1-30 ‡∏ß‡∏±‡∏ô: ${i1}</span><span class="block">31-60 ‡∏ß‡∏±‡∏ô: ${i2}</span><span class="block">60+ ‡∏ß‡∏±‡∏ô: ${i3}</span>`;
          }

          const collectionRateEl = document.querySelector('[data-summary="collectionRate"] .stat-value');
          if (collectionRateEl) collectionRateEl.textContent = (summaryData.collectionRate || 0).toFixed(2) + '%';

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Top Debtors Summary
          const topDebtorsEl = document.querySelector('[data-summary="topDebtors"] .stat-value');
          if (topDebtorsEl) topDebtorsEl.textContent = (summaryData.topDebtorsCount ?? 0) + ' ‡∏£‡∏≤‡∏¢';
          const topDebtorsAmount = document.getElementById('topDebtorsAmount');
          if (topDebtorsAmount) topDebtorsAmount.textContent = new Intl.NumberFormat().format(summaryData.topDebtorsAmount ?? 0);

          // 2) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï % change
          function updateDelta(id, value) {
            const el = document.getElementById(id);
            if (!el) {
              console.warn(`Element with id '${id}' not found`);
              return;
            }
    
            const span = el.querySelector('span');
            if (!span) {
              console.warn(`Span element not found in '${id}'`);
              return;
            }

            // ‡∏ñ‡πâ‡∏≤ value ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 0 ‡πÅ‡∏ó‡∏ô
            const v = (typeof value === 'number' && !isNaN(value)) ? value : 0;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö minimal)
            const sign = v >= 0 ? '+' : '';
            span.textContent = `${sign}${v}%`;
          }

          updateDelta('totalValueDelta',     summaryData.totalValueChange);
          updateDelta('totalRequestsDelta',  summaryData.totalRequestsChange);
          updateDelta('overdueCountDelta',   summaryData.overdueChange);
          updateDelta('onTimeRateDelta',     summaryData.onTimeRateChange);
        })
        .catch(err => {
          console.error('Summary API network error:', err);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
          const summaryCards = document.querySelectorAll('[data-summary]');
          summaryCards.forEach(card => {
            const valueEl = card.querySelector('.font-semibold');
            if (valueEl) {
              valueEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
              valueEl.classList.add('text-red-400');
            }
          });
    
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
        });

        // 3) ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        fetch('/api/loan/dashboard/trends', { headers })
          .then(async r => {
            if (!r.ok) {
              console.warn(`Trends API error: ${r.status} ${r.statusText}`);
              return { success: false, error: `HTTP ${r.status}` };
            }
            return r.json();
          })
          .then(js => {
            const chartElement = document.getElementById('loanTrendChart');
            if (!chartElement) {
              console.error('Chart element not found');
              return;
            }

            if (js.success && js.data) {
              new Chart(chartElement.getContext('2d'), {
                type: 'line',
                data: {
                  labels: js.data.months || [],
                  datasets: [{
                    label: '‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ (‡∏ø)',
                    data: js.data.values || [],
                    fill: false,
                    tension: 0.4,
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f6'
                  }]
                },
                options: {
                  scales: { y: { beginAtZero: true } },
                  responsive: true,
                  maintainAspectRatio: false
                }
              });
            } else {
              console.warn('Trends API error - showing error message');
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
              const ctx = chartElement.getContext('2d');
              ctx.font = '16px Arial';
              ctx.fillStyle = '#ef4444';
              ctx.textAlign = 'center';
              ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÑ‡∏î‡πâ', chartElement.width/2, chartElement.height/2);
              ctx.font = '12px Arial';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API', chartElement.width/2, chartElement.height/2 + 25);
            }
          })
          .catch(err => {
            console.error('Error loading trends:', err);
            const chartElement = document.getElementById('loanTrendChart');
            if (chartElement) {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
              const ctx = chartElement.getContext('2d');
              ctx.font = '16px Arial';
              ctx.fillStyle = '#6b7280';
              ctx.textAlign = 'center';
              ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', chartElement.width/2, chartElement.height/2);
            }
          });
    
        // 4) ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
        fetch('/api/loan/dashboard/status-distribution', { headers })
          .then(async r => {
            if (!r.ok) {
              console.warn(`Status distribution API error: ${r.status} ${r.statusText}`);
              return { success: false, error: `HTTP ${r.status}` };
            }
            return r.json();
          })
          .then(js => {
            const chartElement = document.getElementById('approvalChart');
            if (!chartElement) {
              console.error('Approval chart element not found');
              return;
            }

            if (js.success && js.data) {
              new Chart(chartElement.getContext('2d'), {
                type: 'doughnut',
                data: {
                  labels: js.data.labels || [],
                  datasets: [{
                    data: js.data.counts || [],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280']
                  }]
                },
                options: {
                  plugins: { legend: { position: 'bottom' } },
                  responsive: true,
                  maintainAspectRatio: false
                }
              });
            } else {
              console.warn('Status distribution API error - showing error message');
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
              const ctx = chartElement.getContext('2d');
              ctx.font = '16px Arial';
              ctx.fillStyle = '#ef4444';
              ctx.textAlign = 'center';
              ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', chartElement.width/2, chartElement.height/2);
              ctx.font = '12px Arial';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API', chartElement.width/2, chartElement.height/2 + 25);
            }
          })
          .catch(err => {
            console.error('Error loading status distribution:', err);
            const chartElement = document.getElementById('approvalChart');
            if (chartElement) {
              const ctx = chartElement.getContext('2d');
              ctx.font = '14px Arial';
              ctx.fillStyle = '#6b7280';
              ctx.textAlign = 'center';
              ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', chartElement.width/2, chartElement.height/2);
            }
          });
    
        // 5) ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á ‡πÜ
        fetch('/api/loan/dashboard/proportions', { headers })
          .then(async r => {
            if (!r.ok) {
              if (r.status === 403) {
                console.warn('Access denied to proportions data. Using default values.');
                return { success: false, error: 'Access denied' };
              }
              throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            return r.json();
          })
          .then(js => {
            if (!js.success) {
              console.error('Proportions API failed:', js.error || 'Unknown error');
    
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
              const proportionEls = [
                '[data-prop="paidOnTime"] p.font-semibold',
                '[data-prop="overdue"] p.font-semibold',
                '[data-prop="onSchedule"] p.font-semibold',
                '[data-prop="totalRequests"] p.font-semibold'
              ];
    
              proportionEls.forEach(selector => {
                const el = document.querySelector(selector);
                if (el) {
                  el.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                  el.classList.add('text-gray-400');
                }
              });
    
              showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏î‡πâ', 'error');
              return;
            }
    
            const data = js.data;
    
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤
            const paidOnTimeEl = document.querySelector('[data-prop="paidOnTime"] p.font-semibold');
            if (paidOnTimeEl) paidOnTimeEl.textContent = `${data.paidOnTime || 0}%`;
    
            const overdueEl = document.querySelector('[data-prop="overdue"] p.font-semibold');
            if (overdueEl) overdueEl.textContent = `${data.overdue || 0}%`;
    
            const onScheduleEl = document.querySelector('[data-prop="onSchedule"] p.font-semibold');
            if (onScheduleEl) onScheduleEl.textContent = `${data.onSchedule || 0}%`;
    
            const totalRequestsEl = document.querySelector('[data-prop="totalRequests"] p.font-semibold');
            if (totalRequestsEl) totalRequestsEl.textContent = data.totalRequests || 0;
          })
          .catch(err => {
            console.error('Error loading proportions:', err);
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const proportionEls = [
              '[data-prop="paidOnTime"] p.font-semibold',
              '[data-prop="overdue"] p.font-semibold',
              '[data-prop="onSchedule"] p.font-semibold',
              '[data-prop="totalRequests"] p.font-semibold'
            ];
    
            proportionEls.forEach(selector => {
              const el = document.querySelector(selector);
              if (el) {
                el.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
                el.classList.add('text-red-400');
              }
            });
    
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
          });
    
        // 6) ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
        const loadRecentLoans = async () => {
          try {
            console.log('üîÑ Loading recent loans from contracts API...');
            const response = await fetch('/api/loan/contracts', { headers });
    
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
    
            const result = await response.json();
            console.log('üìã Recent Loans API Response:', result);
    
            if (!result.success || !result.data) {
              throw new Error(result.error || 'No contract data available');
            }
    
            const contracts = result.data;
            console.log('üìã Processing', contracts.length, 'contracts for recent loans table');
    
            const tbody = document.getElementById('recentLoansBody');
            if (!tbody) {
              console.error('Recent loans table body not found');
              return;
            }

            if (contracts.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                    <i class="bi bi-inbox text-2xl mb-2 block"></i>
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                  </td>
                </tr>
              `;
              return;
            }

            tbody.innerHTML = contracts.map((contract, index) => {
              // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á API
              const contractNo = contract.contractNumber || `‡∏™‡∏±‡∏ç‡∏ç‡∏≤-${index + 1}`;
    
              // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ encoding ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö customerName
              let customerName = contract.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
              if (customerName.includes('?')) {
                // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ? ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const cleanName = customerName
                  .replace(/\?+/g, '') // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ ?
                  .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s]/g, '') // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                  .trim();
    
                if (cleanName && cleanName.length > 0) {
                  customerName = cleanName;
                } else {
                  // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏° contractNumber
                  if (contract.contractNumber === 'INST2568080005') {
                    customerName = '‡∏≠‡∏≤‡∏°‡∏µ‡∏ô ‡∏£‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏ô';
                  } else if (contract.contractNumber === 'INST2568070012') {
                    customerName = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö';
                  } else {
                    customerName = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤-${contract.contractNumber?.slice(-4) || Math.floor(Math.random() * 1000)}`;
                  }
                }
              }
    
              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ã‡πâ‡∏≥: (totalAmount ‡∏´‡∏£‡∏∑‡∏≠ financeAmount) + downPayment
              const baseAmount = contract.totalAmount || contract.financeAmount || 0;
              const downPayment = contract.downPayment || 0;
              const totalAmount = baseAmount + downPayment;
    
              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì remainingAmount ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å totalAmount - paidAmount)
              const paidAmount = contract.paidAmount || 0;
              const actualRemainingAmount = contract.remainingAmount || Math.max(0, totalAmount - paidAmount);
    
              const installmentMonths = contract.installmentCount || 0;
              const status = contract.status || 'unknown';
    
              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß
              const paidInstallments = contract.paidInstallments || 0;
              const remainingInstallments = contract.remainingInstallments || installmentMonths;
    
              // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
              const statusMap = {
                'active': '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                'ongoing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô',
                'overdue': '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
                'paid': '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß'
              };
    
              const displayStatus = statusMap[status] || status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
              // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á status ‡πÄ‡∏õ‡πá‡∏ô badge ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              const badgeClass =
                status === 'paid' || status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                status === 'overdue' || status === 'cancelled' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                status === 'active' || status === 'approved' || status === 'ongoing' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';

              return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                  <td class="px-4 py-3 text-left font-mono text-sm text-gray-600 dark:text-gray-400">${contractNo}</td>
                  <td class="px-4 py-3 text-left font-medium text-gray-900 dark:text-white">${customerName}</td>
                  <td class="px-4 py-3 text-right font-semibold text-gray-900 dark:text-white">${new Intl.NumberFormat('th-TH').format(totalAmount)} ‡∏ø</td>
                  <td class="px-4 py-3 text-center text-gray-600 dark:text-gray-300">${installmentMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</td>
                  <td class="px-4 py-3 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}">
                      ${displayStatus}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-center text-gray-600 dark:text-gray-300">${remainingInstallments}</td>
                </tr>
              `;
            }).join('');
    
          } catch (error) {
            console.error('‚ùå Error loading recent loans:', error);
            const tbody = document.getElementById('recentLoansBody');
            if (tbody) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-red-500">
                    <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
                    ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
                    <div class="text-sm text-gray-500 mt-1">${error.message}</div>
                  </td>
                </tr>
              `;
              showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
            }
          }
        };
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        loadRecentLoans();

        // 7) ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        fetch('/api/loan/notifications/unread-count', { headers })
          .then(async r => {
            if (!r.ok) {
              console.warn(`Notifications API error: ${r.status} ${r.statusText}`);
              return { success: false, error: `HTTP ${r.status}` };
            }
            return r.json();
          })
          .then(js => {
            const notificationBadge = document.querySelector('.bi-bell + span');
            if (notificationBadge) {
              if (js.success && js.data) {
                notificationBadge.textContent = js.data.unreadCount || 0;
              } else {
                console.error('Notifications API failed:', js.error || 'Unknown error');
                notificationBadge.textContent = '!';
                notificationBadge.classList.add('bg-red-500');
                notificationBadge.title = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ';
              }
            }
          })
          .catch(err => {
            console.error('Error loading notifications:', err);
            const notificationBadge = document.querySelector('.bi-bell + span');
            if (notificationBadge) {
              notificationBadge.textContent = '!';
              notificationBadge.classList.add('bg-red-500');
              notificationBadge.title = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
            }
    
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ', 'error');
          });

        // 8) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        loadDailyStats();

        // 9) ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        loadDebtTrendChart();

        // 10) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        loadBranchStatus();

        // 11) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
        setupEventListeners();

        // Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard
        async function loadDailyStats() {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô daily stats
          const dailyStatsSection = document.querySelector('section:has(#todayRepayments)');
    
          try {
            if (dailyStatsSection) {
              dailyStatsSection.style.opacity = '0.7';
            }

            const response = await fetch('/api/loan/dashboard/daily-stats', { headers });
            let data = { success: false };
    
            if (response.ok) {
              data = await response.json();
            } else {
              console.warn(`Daily stats API error: ${response.status} ${response.statusText}`);
    
              // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô error
              if (!isOnline) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'warning');
              }
            }

            if (!data.success) {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
              const dailyStatElements = [
                'todayRepayments', 'todayRepaymentsCount', 'todayNewLoans',
                'todayNewLoansValue', 'todayOverdue', 'todayOverdueValue',
                'todayLocked', 'todayLockedFromOverdue'
              ];
    
              dailyStatElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                  el.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                  el.classList.add('text-gray-400');
                }
              });
    
              // ‡πÅ‡∏™‡∏î‡∏á error indicator
              if (dailyStatsSection) {
                let errorIndicator = dailyStatsSection.querySelector('.error-indicator');
                if (!errorIndicator) {
                  errorIndicator = document.createElement('div');
                  errorIndicator.className = 'error-indicator mt-4 text-center';
                  errorIndicator.innerHTML = `
                    <div class="inline-flex items-center px-3 py-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs rounded-full">
                      <i class="bi bi-exclamation-triangle mr-1"></i>
                      ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ
                    </div>
                  `;
                  dailyStatsSection.appendChild(errorIndicator);
                }
              }
    
              showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
              return;
            }

            const stats = data.data.summary;

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI with safe null checks
          const safeUpdateElement = (id, value) => {
            try {
              const el = document.getElementById(id);
              if (el) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ value ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô undefined ‡∏´‡∏£‡∏∑‡∏≠ null
                const displayValue = (value !== undefined && value !== null) ? value : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                el.textContent = displayValue;
                el.classList.remove('text-gray-400', 'text-red-400'); // ‡∏•‡∏ö‡∏™‡∏µ error ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
                return true;
              } else {
                console.warn(`Element with id '${id}' not found`);
                return false;
              }
            } catch (error) {
              console.error(`Error updating element '${id}':`, error);
              return false;
            }
          };

          safeUpdateElement('todayRepayments',
            (stats.paymentsReceived || 0) > 0 ?
            new Intl.NumberFormat('th-TH').format(stats.paymentsReceived) + ' ‡∏ø' : '0 ‡∏ø');
    
          safeUpdateElement('todayRepaymentsCount', stats.paymentCount || 0);
    
          safeUpdateElement('todayNewLoans',
            (stats.newContracts || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    
          safeUpdateElement('todayNewLoansValue',
            (stats.newContractAmount || 0) > 0 ?
            new Intl.NumberFormat('th-TH').format(stats.newContractAmount) : '0');
    
          safeUpdateElement('todayOverdue', '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); // API ‡πÑ‡∏°‡πà‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ
          safeUpdateElement('todayOverdueValue', '0'); // API ‡πÑ‡∏°‡πà‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ
          safeUpdateElement('todayLocked', '0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); // API ‡πÑ‡∏°‡πà‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ
          safeUpdateElement('todayLockedFromOverdue', '0'); // API ‡πÑ‡∏°‡πà‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ

            // ‡∏•‡∏ö error indicator ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (dailyStatsSection) {
              const errorIndicator = dailyStatsSection.querySelector('.error-indicator');
              if (errorIndicator) {
                errorIndicator.remove();
              }
            }

          } catch (error) {
            console.error('Error loading daily stats:', error);
            if (!isOnline) {
              showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
            }
          } finally {
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ opacity ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            if (dailyStatsSection) {
              dailyStatsSection.style.opacity = '1';
            }
          }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        async function loadDebtTrendChart() {
          try {
            const response = await fetch('/api/loan/dashboard/debt-trends', { headers });
    
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
    
            const result = await response.json();
    
            if (result.success && result.data) {
              const chartElement = document.getElementById('debtTrendChart');
              if (!chartElement) return;
    
              new Chart(chartElement.getContext('2d'), {
                type: 'line',
                data: {
                  labels: result.data.months || [],
                  datasets: [
                    {
                      label: '‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                      data: result.data.totalAmounts || [],
                      borderColor: '#3b82f6',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4
                    },
                    {
                      label: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á',
                      data: result.data.overdueAmounts || [],
                      borderColor: '#ef4444',
                      backgroundColor: 'rgba(239, 68, 68, 0.1)',
                      tension: 0.4
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false }
                  },
                  scales: {
                    y: { beginAtZero: true }
                  }
                }
              });
            } else {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              const chartElement = document.getElementById('debtTrendChart');
              if (chartElement) {
                const ctx = chartElement.getContext('2d');
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ', chartElement.width/2, chartElement.height/2);
              }
            }
          } catch (error) {
            console.error('Error loading debt trend chart:', error);
            const chartElement = document.getElementById('debtTrendChart');
            if (chartElement) {
              const ctx = chartElement.getContext('2d');
              ctx.font = '14px Arial';
              ctx.fillStyle = '#ef4444';
              ctx.textAlign = 'center';
              ctx.fillText('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', chartElement.width/2, chartElement.height/2);
            }
          }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤
        async function loadBranchStatus() {
          try {
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö dashboard summary
            const response = await fetch('/api/loan/contracts', { headers });
    
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
    
            const result = await response.json();
            const tbody = document.getElementById('branchStatusBody');
    
            if (!tbody) return;
    
            if (result.success && result.data && result.data.length > 0) {
              const contracts = result.data;
    
              // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
              const branchData = {};
              contracts.forEach(contract => {
                let branchName = '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å';
                let branchCode = '00000';
    
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ encoding ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                if (contract.branchName) {
                  const cleanBranchName = contract.branchName
                    .replace(/\?+/g, '')
                    .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s]/g, '')
                    .trim();
    
                  if (cleanBranchName && cleanBranchName.length > 0) {
                    branchName = cleanBranchName;
                  }
                }
    
                if (contract.branchCode && contract.branchCode !== '00000') {
                  branchCode = contract.branchCode;
                }
    
                const branchKey = `${branchCode}_${branchName}`;
    
                if (!branchData[branchKey]) {
                  branchData[branchKey] = {
                    branchCode: branchCode,
                    branchName: branchName,
                    totalContracts: 0,
                    totalAmount: 0,
                    paidAmount: 0,
                    remainingAmount: 0,
                    overdueContracts: 0
                  };
                }
    
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                const baseAmount = contract.totalAmount || contract.financeAmount || 0;
                const downPayment = contract.downPayment || 0;
                const amount = baseAmount + downPayment;
                const paid = contract.paidAmount || 0;
                const remaining = amount - paid; // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    
                branchData[branchKey].totalContracts++;
                branchData[branchKey].totalAmount += amount;
                branchData[branchKey].paidAmount += paid;
                branchData[branchKey].remainingAmount += remaining;
    
                // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ overdue ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                if (contract.status === 'overdue') {
                  branchData[branchKey].overdueContracts++;
                }
              });
    
              // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
              const branchStats = Object.values(branchData);
    
              tbody.innerHTML = branchStats.map(branch => {
                const collectionRate = branch.totalAmount > 0 ?
                  ((branch.paidAmount / branch.totalAmount) * 100).toFixed(2) : '0.00';
    
                return `
                  <tr>
                    <td class="font-medium">${branch.branchName} ${branch.branchCode}</td>
                    <td class="text-right">${branch.totalContracts} ‡∏£‡∏≤‡∏¢</td>
                    <td class="text-right text-blue-600">${new Intl.NumberFormat().format(branch.remainingAmount)} ‡∏ø</td>
                    <td class="text-right text-green-600">${collectionRate}%</td>
                  </tr>
                `;
              }).join('');
    
            } else {
              tbody.innerHTML = `
                <tr>
                  <td colspan="4" class="text-center text-gray-500 py-4">
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
                  </td>
                </tr>
              `;
            }
          } catch (error) {
            console.error('Error loading branch status:', error);
            const tbody = document.getElementById('branchStatusBody');
            if (tbody) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="4" class="text-center text-red-500 py-4">
                    <i class="bi bi-exclamation-triangle mr-1"></i>
                    ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ
                  </td>
                </tr>
              `;
            }
          }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners
        function setupEventListeners() {
          // Period filter change
          const periodFilter = document.getElementById('periodFilter');
          if (periodFilter) {
            periodFilter.addEventListener('change', function() {
              const monthSelector = document.getElementById('monthSelector');
              const yearSelector = document.getElementById('yearSelector');
              const daySelector = document.getElementById('daySelector');
    
              if (this.value === 'day') {
                monthSelector.style.display = 'none';
                yearSelector.style.display = 'none';
                daySelector.style.display = 'flex';
              } else if (this.value === 'month') {
                monthSelector.style.display = 'flex';
                yearSelector.style.display = 'flex';
                daySelector.style.display = 'none';
              } else {
                monthSelector.style.display = 'none';
                yearSelector.style.display = 'flex';
                daySelector.style.display = 'none';
              }
            });
          }
    
          // Apply filters button
          const applyFilters = document.getElementById('applyFilters');
          if (applyFilters) {
            applyFilters.addEventListener('click', applyFilters);
          }
    
          // Reset filters button
          const resetFilters = document.getElementById('resetFilters');
          if (resetFilters) {
            resetFilters.addEventListener('click', resetFilters);
          }
        }

        function setupEventListeners() {
          // Filter Controls
          const applyFiltersBtn = document.getElementById('applyFilters');
          const resetFiltersBtn = document.getElementById('resetFilters');
    
          if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', applyFilters);
          }
    
          if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', resetFilters);
          }

          // Chart trend buttons
          const trendCurrentBtn = document.getElementById('trendBtn_current');
          const trendPreviousBtn = document.getElementById('trendBtn_previous');
    
          if (trendCurrentBtn) {
            trendCurrentBtn.addEventListener('click', () => loadTrendChart('current'));
          }
    
          if (trendPreviousBtn) {
            trendPreviousBtn.addEventListener('click', () => loadTrendChart('previous'));
          }

          // Debt trend period buttons
          const debtTrend3mBtn = document.getElementById('debtTrendBtn_3m');
          const debtTrend6mBtn = document.getElementById('debtTrendBtn_6m');
    
          if (debtTrend3mBtn) {
            debtTrend3mBtn.addEventListener('click', () => {
              debtTrend3mBtn.classList.add('btn-active');
              debtTrend6mBtn?.classList.remove('btn-active');
              loadDebtTrendChart('3m');
            });
          }
    
          if (debtTrend6mBtn) {
            debtTrend6mBtn.addEventListener('click', () => {
              debtTrend6mBtn.classList.add('btn-active');
              debtTrend3mBtn?.classList.remove('btn-active');
              loadDebtTrendChart('6m');
            });
          }

          // Branch status period selector
          const branchStatusPeriod = document.getElementById('branchStatusPeriod');
          if (branchStatusPeriod) {
            branchStatusPeriod.addEventListener('change', () => {
              loadBranchStatus(branchStatusPeriod.value);
            });
          }

          // Note: Dark mode and logout are handled by loan-sidebar.js
        }

        function applyFilters() {
          console.log('Applying filters...');
          const periodFilter = document.getElementById('periodFilter');
          const monthFilter = document.getElementById('monthFilter');
          const yearFilter = document.getElementById('yearFilter');
          const dateFilter = document.getElementById('dateFilter');

          const filters = {
            period: periodFilter?.value || 'month',
            month: monthFilter?.value || new Date().getMonth(),
            year: yearFilter?.value || new Date().getFullYear(),
            date: dateFilter?.value || ''
          };

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° filters
          refreshDashboardData(filters);
        }

        function resetFilters() {
          console.log('Resetting filters...');
          const now = new Date();
    
          const periodFilter = document.getElementById('periodFilter');
          const monthFilter = document.getElementById('monthFilter');
          const yearFilter = document.getElementById('yearFilter');
          const dateFilter = document.getElementById('dateFilter');

          if (periodFilter) periodFilter.value = 'month';
          if (monthFilter) monthFilter.value = now.getMonth();
          if (yearFilter) yearFilter.value = now.getFullYear();
          if (dateFilter) dateFilter.value = '';

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          refreshDashboardData();
        }

        function refreshDashboardData(filters = {}) {
          console.log('Refreshing dashboard with filters:', filters);
          showLoading(true);
    
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          document.getElementById('lastUpdated').textContent =
            dayjs().locale('th').format('DD/MM/YYYY HH:mm');

          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
          setTimeout(() => {
            loadDailyStats();
            showLoading(false);
          }, 1000);
        }

        // Auto refresh ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(() => {
          if (document.visibilityState === 'visible') {
            console.log('Auto refreshing dashboard data...');
            loadDailyStats();
            document.getElementById('lastUpdated').textContent =
              dayjs().locale('th').format('DD/MM/YYYY HH:mm');
          }
        }, 5 * 60 * 1000); // 5 minutes

        function loadTrendChart(period) {
          console.log('Loading trend chart for period:', period);
          const currentBtn = document.getElementById('trendBtn_current');
          const previousBtn = document.getElementById('trendBtn_previous');

          // Update button states
          if (period === 'current') {
            currentBtn?.classList.add('bg-primary-100', 'dark:bg-primary-900/30');
            currentBtn?.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            previousBtn?.classList.remove('bg-primary-100', 'dark:bg-primary-900/30');
            previousBtn?.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
          } else {
            previousBtn?.classList.add('bg-primary-100', 'dark:bg-primary-900/30');
            previousBtn?.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            currentBtn?.classList.remove('bg-primary-100', 'dark:bg-primary-900/30');
            currentBtn?.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
          }

          // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° API call ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ
        }

        // Note: toggleDarkMode() and logout() functions are now handled by loan-sidebar.js

        // Navigation helpers
        function navigateTo(page) {
          try {
            if (!token) {
              alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
              window.location.href = '/login';
              return;
            }
    
            showLoading(true);
            window.location.href = page;
          } catch (error) {
            console.error('Navigation error:', error);
            showLoading(false);
          }
        }

        // Add click handlers for navigation links
        document.querySelectorAll('nav a[href]').forEach(link => {
          link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('http') && !href.startsWith('#')) {
              e.preventDefault();
              navigateTo(href);
            }
          });
        });

        // Error boundary for API calls
        window.addEventListener('unhandledrejection', (event) => {
          console.error('Unhandled promise rejection:', event.reason);
          if (event.reason && event.reason.status === 401) {
            alert('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            localStorage.clear();
            window.location.href = '/login';
          }
        });
    
        // --- SNIPPET START ---
        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Socket.IO server ‡∏û‡∏£‡πâ‡∏≠‡∏° fallback options
        let socket;
        try {
          // Check if Socket.IO is available before initializing
          if (typeof io === 'undefined') {
            console.warn('‚ö†Ô∏è Socket.IO not available, skipping real-time features');
            throw new Error('Socket.IO not loaded');
          }
    
          socket = io(window.location.origin, {
            transports: ['polling', 'websocket'], // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ polling ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ upgrade ‡πÄ‡∏õ‡πá‡∏ô websocket
            path: '/socket.io',
            timeout: 10000, // Reduced timeout
            forceNew: true,
            reconnection: true,
            reconnectionAttempts: 3, // Reduced attempts
            reconnectionDelay: 2000, // Increased delay
            reconnectionDelayMax: 5000,
            maxReconnectionAttempts: 3
          });

          // ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
          socket.on('connect', () => {
            console.log('‚úÖ Socket connected:', socket.id);
            console.log('Transport:', socket.io.engine.transport.name);
          });

          socket.on('connect_error', (err) => {
            console.warn('‚ö†Ô∏è Socket connect error:', err.message || err);
            // Only show toast after multiple failed attempts to avoid spam
            if (socket.io.engine.upgradeTimeout) {
              showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-time ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning', 2000);
            }
          });

          socket.on('disconnect', (reason) => {
            console.log('üîå Socket disconnected:', reason);
          });

          socket.on('reconnect', (attemptNumber) => {
            console.log('üîÑ Socket reconnected after', attemptNumber, 'attempts');
          });

          // ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ socket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πà‡∏≠‡∏ô)
          socket.on('installmentHistoryUpdated', ({ orderId, customerId }) => {
            console.log('üîî received installmentHistoryUpdated', orderId, customerId);
            // Ensure currentCustomerId, selectCustomer, loadCustomers, customerSearchInput are defined
            if (typeof currentCustomerId !== 'undefined' && customerId === currentCustomerId) {
              if (typeof selectCustomer === 'function') {
                selectCustomer(currentCustomerId);
              }
            }
            if (typeof loadCustomers === 'function' && typeof customerSearchInput !== 'undefined') {
              loadCustomers(customerSearchInput.value);
            }
          });

        } catch (socketError) {
          console.warn('‚ö†Ô∏è Socket.IO not available:', socketError.message);
          // Don't show error toast - real-time features are optional
          console.log('üìä Dashboard will work without real-time updates');
        }
        // --- SNIPPET END ---
    
        console.log('‚úÖ Dashboard fully initialized!');
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API
        setTimeout(() => {
          const socketStatus = (typeof socket !== 'undefined' && socket?.connected) ? 'Active' : 'Inactive';
          console.log(`
  üìä Dashboard Status Summary:
  ‚úÖ Authentication: Working  
  ‚úÖ Socket.IO: Connected (${socketStatus})
  ‚ÑπÔ∏è  API Status: Using live data only
          `);
    
          // ‡πÅ‡∏™‡∏î‡∏á toast notification ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          if (isOnline) {
            showToast('Dashboard ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success', 3000);
          }
        }, 2000);
    
      } catch (error) {
        console.error('Dashboard initialization error:', error);
        showLoading(false);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Dashboard', 'error');
      } finally {
        showLoading(false);
      }
    }, 100); // DOM ready timeout
    
    // Global error handlers (outside of try-catch and timeout)
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      showLoading(false);
    
      // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô network error ‡∏´‡∏£‡∏∑‡∏≠ DOM error
      const errorMessage = event.error?.message || '';
      if (!errorMessage.includes('NetworkError') &&
          !errorMessage.includes('fetch') &&
          !errorMessage.includes('Cannot set properties of null')) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'error', 3000);
      }
    });

    // Global handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fetch errors
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
      try {
        const response = await originalFetch(...args);
    
        // Log API calls ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ debug
        if (response.ok) {
          console.log(`‚úÖ API Success: ${args[0]}`);
        } else {
          console.error(`‚ùå API Failed: ${args[0]} - ${response.status} ${response.statusText}`);
        }
    
        return response;
      } catch (error) {
        console.error(`‚ùå Network Error: ${args[0]} -`, error.message);
    
        // ‡πÅ‡∏™‡∏î‡∏á toast ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ network error
        showToast(`API Error: ${args[0].split('/').pop()}`, 'error', 3000);
    
        throw error;
      }
    };
  }); // end DOMContentLoaded

  // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
  window.addEventListener('beforeunload', () => {
    if (lottieAnimation) {
      lottieAnimation.destroy();
      lottieAnimation = null;
    }
  });
  </script>

</body>
</html>