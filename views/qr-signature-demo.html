<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Signature Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 40px;
            font-size: 32px;
        }

        .demo-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .demo-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qr-display {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .qr-display.active {
            display: block;
        }

        #qr-canvas {
            max-width: 300px;
            width: 100%;
            margin: 0 auto;
            display: block;
        }

        .qr-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
        }

        .qr-info p {
            margin-bottom: 8px;
            color: #6c757d;
        }

        .qr-info p:last-child {
            margin-bottom: 0;
        }

        .status-box {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .status-box.waiting {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            display: block;
        }

        .status-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            display: block;
        }

        .status-box.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            display: block;
        }

        .status-box h3 {
            margin-bottom: 10px;
        }

        .signature-preview {
            margin-top: 20px;
            text-align: center;
        }

        .signature-preview img {
            max-width: 100%;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± QR Code Signature System Demo</h1>

        <div class="demo-section">
            <h2>üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ô‡∏≤‡∏°</h2>

            <div class="form-group">
                <label for="receipt-id">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</label>
                <input type="text" id="receipt-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô RC-2025-0001" value="RC-2025-TEST-001">
            </div>

            <div class="form-group">
                <label for="signature-type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:</label>
                <select id="signature-type">
                    <option value="employee">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Employee)</option>
                    <option value="customer">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)</option>
                    <option value="witness">‡∏û‡∏¢‡∏≤‡∏ô (Witness)</option>
                </select>
            </div>

            <button class="btn" id="btn-generate" onclick="generateQRCode()">
                üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
            </button>

            <div class="qr-display" id="qr-display">
                <canvas id="qr-canvas"></canvas>

                <div class="qr-info">
                    <p><strong>üìã ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</strong> <span id="display-receipt"></span></p>
                    <p><strong>‚úçÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> <span id="display-type"></span></p>
                    <p><strong>üîó Session ID:</strong> <code id="display-session"></code></p>
                </div>

                <div class="status-box waiting" id="status-waiting">
                    <h3>‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ô‡∏≤‡∏°...</h3>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏ß‡∏¢ iPad ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ô‡∏≤‡∏°</p>
                    <p style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                    </p>
                </div>

                <div class="status-box success" id="status-success">
                    <h3>‚úÖ ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                    <div class="signature-preview">
                        <img id="signature-image" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô">
                    </div>
                </div>

                <div class="status-box error" id="status-error">
                    <h3>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                    <p id="error-message"></p>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            <ol style="color: #495057; line-height: 2;">
                <li>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</li>
                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code"</li>
                <li>‡πÉ‡∏ä‡πâ iPad ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR Code</li>
                <li>‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤</li>
                <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô"</li>
                <li>‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô Socket.IO ‡∏´‡∏£‡∏∑‡∏≠ Polling</li>
            </ol>
        </div>

        <div class="demo-section">
            <h2>‚öôÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <ul style="color: #495057; line-height: 2;">
                <li>‚úÖ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Network ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</li>
                <li>‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iPad, iPhone, Android</li>
                <li>‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Browser ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á App</li>
                <li>‚úÖ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</li>
                <li>‚úÖ Real-time update ‡∏ú‡πà‡∏≤‡∏ô Socket.IO</li>
                <li>‚úÖ Fallback ‡πÄ‡∏õ‡πá‡∏ô Polling ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Socket.IO</li>
            </ul>
        </div>
    </div>

    <script>
        let currentSession = null;
        let pollingInterval = null;
        let socket = null;

        // Initialize Socket.IO
        function initSocket() {
            try {
                socket = io();

                socket.on('connect', () => {
                    console.log('‚úÖ Socket.IO connected');
                });

                socket.on('signature-saved', (data) => {
                    console.log('üì® Received signature via Socket.IO:', data);
                    if (currentSession && data.sessionId === currentSession.sessionId) {
                        stopPolling();
                        fetchSignature();
                    }
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå Socket.IO disconnected');
                });
            } catch (error) {
                console.warn('‚ö†Ô∏è Socket.IO not available, will use polling instead');
            }
        }

        // Generate QR Code
        async function generateQRCode() {
            const receiptId = document.getElementById('receipt-id').value;
            const signatureType = document.getElementById('signature-type').value;

            if (!receiptId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
                return;
            }

            try {
                document.getElementById('btn-generate').disabled = true;
                document.getElementById('btn-generate').innerHTML = '<span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';

                // Call API to create session
                const response = await fetch('/api/qr-signature/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
                    },
                    body: JSON.stringify({ receiptId, signatureType })
                });

                const result = await response.json();

                if (!result.success) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
                    return;
                }

                currentSession = result.data;

                // Display QR Code
                const qrCanvas = document.getElementById('qr-canvas');
                await QRCode.toCanvas(qrCanvas, result.data.signatureUrl, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });

                // Update UI
                document.getElementById('display-receipt').textContent = receiptId;
                const typeLabels = {
                    'employee': '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                    'customer': '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                    'witness': '‡∏û‡∏¢‡∏≤‡∏ô'
                };
                document.getElementById('display-type').textContent = typeLabels[signatureType];
                document.getElementById('display-session').textContent = result.data.sessionId;

                document.getElementById('qr-display').classList.add('active');
                document.getElementById('status-waiting').style.display = 'block';
                document.getElementById('status-success').style.display = 'none';
                document.getElementById('status-error').style.display = 'none';

                // Start polling for signature
                startPolling();

            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code');
            } finally {
                document.getElementById('btn-generate').disabled = false;
                document.getElementById('btn-generate').innerHTML = 'üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code';
            }
        }

        // Start polling for signature
        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/qr-signature/poll/${currentSession.sessionId}`);
                    const result = await response.json();

                    if (result.status === 'signed' && result.data.signatureData) {
                        stopPolling();
                        displaySignature(result.data.signatureData);
                    } else if (response.status === 404 || response.status === 410) {
                        stopPolling();
                        showError('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÉ‡∏´‡∏°‡πà');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Stop polling
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Fetch signature (called by Socket.IO)
        async function fetchSignature() {
            try {
                const response = await fetch(`/api/qr-signature/poll/${currentSession.sessionId}`);
                const result = await response.json();

                if (result.status === 'signed' && result.data.signatureData) {
                    displaySignature(result.data.signatureData);
                }
            } catch (error) {
                console.error('Fetch signature error:', error);
            }
        }

        // Display signature
        function displaySignature(signatureData) {
            document.getElementById('status-waiting').style.display = 'none';
            document.getElementById('status-success').style.display = 'block';
            document.getElementById('signature-image').src = signatureData;
        }

        // Show error
        function showError(message) {
            document.getElementById('status-waiting').style.display = 'none';
            document.getElementById('status-error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Initialize
        initSocket();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
            if (socket) socket.disconnect();
        });
    </script>
</body>
</html>