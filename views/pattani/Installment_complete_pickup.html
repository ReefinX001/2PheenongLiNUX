<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบผ่อน - ผ่อนหมดรับของ Pattani</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="../js/activity-tracker.js"></script>
  <!-- Sidebar Management -->
  <script src="/views/pattani/sidebar/sidebar.js" onerror="console.warn('Sidebar.js failed to load, will use fallback')"></script>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } }
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] }
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: all;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
    }

    .loading-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      min-width: 300px;
      max-width: 90%;
      color: #333;
    }

    .dark .loading-content {
      background: #1f2937;
      color: #f3f4f6;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: loading-spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }

    .dark .loading-text {
      color: #f3f4f6;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
      background-size: 200% 100%;
      animation: loading-progress 2s ease-in-out infinite;
      width: 0%;
      transition: width 0.3s ease;
    }

    @keyframes loading-progress {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .loading-theme-success .loading-spinner {
      border-top-color: #10b981;
    }
    .loading-theme-success .loading-progress-bar {
      background: linear-gradient(90deg, #10b981, #34d399, #10b981);
    }

    .loading-theme-warning .loading-spinner {
      border-top-color: #f59e0b;
    }
    .loading-theme-warning .loading-progress-bar {
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #f59e0b);
    }

    .loading-theme-error .loading-spinner {
      border-top-color: #ef4444;
    }
    .loading-theme-error .loading-progress-bar {
      background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
    }

    /* Auto-progress animation */
    .loading-auto-progress .loading-progress-bar {
      animation: loading-auto-fill 3s ease-out forwards;
    }

    @keyframes loading-auto-fill {
      from { width: 0%; }
      to { width: 100%; }
    }

    /* Responsive design */
    @media (max-width: 640px) {
      .loading-content {
        padding: 1.5rem;
        min-width: 280px;
      }
      
      .loading-text {
        font-size: 0.9rem;
      }
    }
  </style>

  <script>
    /**
     * LoadingSystem - ระบบแสดงสถานะการโหลดมาตรฐาน
     * Version: 2.0.0-inline
     */
    (function(window) {
      'use strict';

      // ตัวแปรสำหรับเก็บ loading instances
      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      // สร้าง container หลักสำหรับ loading overlays
      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }

        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      // สร้าง unique ID สำหรับ loader
      function generateLoaderId() {
        return 'loader-' + (++loaderCounter) + '-' + Date.now();
      }

      // สร้าง overlay element
      function createOverlay(options) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        // เพิ่ม theme class
        if (options.theme && options.theme !== 'default') {
          overlay.classList.add('loading-theme-' + options.theme);
        }

        const content = document.createElement('div');
        content.className = 'loading-content';

        // Spinner
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        content.appendChild(spinner);

        // Text
        const text = document.createElement('div');
        text.className = 'loading-text';
        text.textContent = options.message || 'กำลังโหลด...';
        content.appendChild(text);

        // Progress bar (if enabled)
        if (options.showProgress) {
          const progressContainer = document.createElement('div');
          progressContainer.className = 'loading-progress';
    
          const progressBar = document.createElement('div');
          progressBar.className = 'loading-progress-bar';
    
          if (options.autoProgress) {
            progressBar.classList.add('loading-auto-progress');
          }
    
          progressContainer.appendChild(progressBar);
          content.appendChild(progressContainer);
        }

        overlay.appendChild(content);
        return overlay;
      }

      // แสดง loading
      function show(options = {}) {
        const settings = {
          message: 'กำลังโหลด...',
          theme: 'default', // default, success, warning, error
          showProgress: false,
          autoProgress: false,
          timeout: 0,
          container: null,
          ...options
        };

        const loaderId = generateLoaderId();
        const container = settings.container || createDefaultContainer();
        const overlay = createOverlay(settings);
    
        overlay.setAttribute('data-loader-id', loaderId);
    
        // เก็บข้อมูล loader
        activeLoaders.set(loaderId, {
          overlay: overlay,
          container: container,
          settings: settings,
          startTime: Date.now()
        });

        // เพิ่มเข้า DOM
        container.appendChild(overlay);

        // แสดง overlay
        requestAnimationFrame(() => {
          overlay.classList.add('loading-visible');
        });

        // Auto timeout
        if (settings.timeout > 0) {
          setTimeout(() => {
            hide(loaderId);
          }, settings.timeout);
        }

        return loaderId;
      }

      // ซ่อน loading
      function hide(loaderId) {
        if (!loaderId || !activeLoaders.has(loaderId)) {
          return false;
        }

        const loader = activeLoaders.get(loaderId);
        const overlay = loader.overlay;

        overlay.classList.remove('loading-visible');
        overlay.classList.add('loading-hiding');

        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          activeLoaders.delete(loaderId);
        }, 300);

        return true;
      }

      // ซ่อน loading ทั้งหมด
      function hideAll() {
        const loaderIds = Array.from(activeLoaders.keys());
        loaderIds.forEach(id => hide(id));
        return loaderIds.length;
      }

      // อัปเดตข้อความ
      function updateMessage(loaderId, message) {
        if (!activeLoaders.has(loaderId)) return false;

        const loader = activeLoaders.get(loaderId);
        const textElement = loader.overlay.querySelector('.loading-text');
        if (textElement) {
          textElement.textContent = message;
        }
        return true;
      }

      // อัปเดต progress
      function updateProgress(loaderId, percent) {
        if (!activeLoaders.has(loaderId)) return false;

        const loader = activeLoaders.get(loaderId);
        const progressBar = loader.overlay.querySelector('.loading-progress-bar');
        if (progressBar) {
          progressBar.style.width = Math.min(100, Math.max(0, percent)) + '%';
        }
        return true;
      }

      // เสร็จสิ้น progress
      function completeProgress(loaderId) {
        if (!updateProgress(loaderId, 100)) return false;

        setTimeout(() => {
          hide(loaderId);
        }, 500);
        return true;
      }

      // ตรวจสอบสถานะ
      function isActive(loaderId) {
        return activeLoaders.has(loaderId);
      }

      // ล้างค่า (เมื่อออกจากหน้า)
      function destroy() {
        hideAll();
        if (defaultContainer && defaultContainer.parentNode) {
          defaultContainer.parentNode.removeChild(defaultContainer);
          defaultContainer = null;
        }
      }

      // Auto cleanup เมื่อออกจากหน้า
      if (typeof addEventListener === 'function') {
        addEventListener('beforeunload', destroy);
        addEventListener('unload', destroy);
      }

      // Export API
      window.LoadingSystem = {
        show: show,
        hide: hide,
        hideAll: hideAll,
        updateMessage: updateMessage,
        updateProgress: updateProgress,
        completeProgress: completeProgress,
        isActive: isActive,
        destroy: destroy,
        version: '2.0.0-inline'
      };

      console.log('✅ LoadingSystem v2.0.0-inline loaded successfully');

    })(window);
  </script>

  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@latest/dist/signature_pad.umd.min.js"></script>
  <!-- Added Socket.IO client library and global socket declaration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    if (typeof io === 'function') {
      socket = io();
      socket.on('connect_error', err => console.warn('Socket.IO connect error:', err));
    } else {
      console.warn('Socket.IO script ไม่ได้โหลด — โยนผ่านไป');
    }
  </script>

  <!-- Sidebar Component Script -->
  <script>
    class SidebarComponent {
      constructor(config = {}) {
        this.config = {
          containerSelector: '#sidebar-container',
          mainContentSelector: '#mainContent',
          ...config
        };

        this.menuItems = [
          { href: 'frontstore_pattani', icon: 'bi-cash-stack', color: 'blue-500', text: 'ซื้อสด' },
          { href: 'installment_Pattani', icon: 'bi-credit-card', color: 'indigo-500', text: 'ซื้อผ่อน' },
          { href: 'Addproduct_pattani', icon: 'bi-speedometer2', color: 'green-500', text: 'เพิ่มสินค้าใหม่' },
          { href: 'services', icon: 'bi-tools', color: 'orange-500', text: 'บริการ' },
          { href: 'receiptVoucher', icon: 'bi-receipt', color: 'red-500', text: 'ใบสำคัญรับเงิน' },
          { href: 'DepositReceipt', icon: 'bi-receipt-cutoff', color: 'teal-500', text: 'ใบรับเงินมัดจำ' },
          { href: 'Quotationn', icon: 'bi-file-earmark-text', color: 'purple-500', text: 'ใบเสนอราคา' },
          { href: 'Invoicee', icon: 'bi-receipt', color: 'fuchsia-500', text: 'ใบแจ้งหนี้' },
          { href: 'productTransfer', icon: 'bi-arrow-left-right', color: 'pink-500', text: 'โอนย้ายสินค้า' }
        ];
      }

      async render() {
        const container = document.querySelector(this.config.containerSelector);
        if (!container) {
          console.error('Sidebar container not found');
          return;
        }

        // สร้าง HTML
        container.innerHTML = this.generateHTML();

        // เพิ่ม CSS styles
        this.injectStyles();

        // Initialize events
        this.initializeEvents();

        // Load profile
        await this.loadEmployeeProfile();

        // Restore states
        this.restoreStates();

        // Highlight active menu
        this.highlightActiveMenu();
      }

      generateHTML() {
        const menuHTML = this.menuItems.map(item => {
          // สร้างชื่อคลาสสีแบบ static ให้ Tailwind คอมไพล์ออกมา
          const textColorClass = `text-${item.color}`;                         // เช่น text-blue-500
          const darkColorClass = `dark:text-${item.color.replace('500', '400')}`; // เช่น dark:text-blue-400

          return `
          <li class="my-px">
            <a href="${item.href}"
               class="flex flex-row items-center h-12 px-4 rounded-lg 
                      ${textColorClass} ${darkColorClass} 
                      hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg ${textColorClass} ${darkColorClass}">
                <i class="bi ${item.icon} text-xl"></i>
              </span>
              <span class="ml-3">${item.text}</span>
            </a>
          </li>
          `;
        }).join('');

        return `
          <!-- Toggle Button -->
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  aria-label="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <!-- Sidebar -->
          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
            
            <!-- Logo -->
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <!-- Menu Items -->
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                ${menuHTML}
                
                <!-- Divider -->
                <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                                 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
                    <span class="ml-3" id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <!-- Logout -->
                <li class="my-px">
                  <button id="btnLogout"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                                 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl"></i>
                    <span class="ml-3">ออกจากระบบ</span>
                  </button>
                </li>
                
                <!-- Profile -->
                <li class="my-px mt-2">
                  <div id="profile"
                       class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                        <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Profile" class="w-full h-full object-cover" />
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">Loading…</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;
      }

      injectStyles() {
        if (document.getElementById('sidebar-styles')) return;

        const styles = document.createElement('style');
        styles.id = 'sidebar-styles';
        styles.textContent = `
          /* Sidebar collapsed state */
          aside.collapsed {
            width: 5rem;
          }
          
          aside.collapsed .ml-3 {
            display: none;
          }
          
          aside.collapsed .Logo,
          aside.collapsed #employeeName,
          aside.collapsed .text-xs {
            display: none;
          }
          
          aside.collapsed .p-4 {
            padding: 0.5rem;
          }
          
          aside.collapsed a {
            justify-content: center;
          }
          
          /* Sidebar translate animation */
          aside {
            transition: transform 0.3s;
          }
          
          aside.-translate-x-full {
            transform: translateX(-100%);
          }
          
          /* Active sidebar item */
          #sidebar ul li a.active {
            background-color: var(--primary-color);
            color: #fff;
          }
          
          #sidebar ul li a.active i {
            color: #fff !important;
          }
        `;
        document.head.appendChild(styles);
      }

      initializeEvents() {
        // Toggle menu
        document.getElementById('btnToggleMenu').addEventListener('click', () => this.toggleMenu());

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => this.logout());

        // Dark mode toggle
        document.getElementById('btnToggleDark').addEventListener('click', () => this.toggleDarkMode());

        // Menu item clicks
        const menuLinks = document.querySelectorAll('#sidebar ul li a');
        menuLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Remove previous active
            menuLinks.forEach(l => l.classList.remove('active'));
            // Add active to clicked
            link.classList.add('active');
          });
        });
      }

      toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector(this.config.mainContentSelector);
        const icon = document.querySelector('#btnToggleMenu i');

        sidebar.classList.toggle('-translate-x-full');

        if (sidebar.classList.contains('-translate-x-full')) {
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          if (mainContent) mainContent.style.marginLeft = '14rem';
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }

        // Save state
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      }

      toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        // Update button text
        document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
      }

      logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.href = '/login';
      }

      async loadEmployeeProfile() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

          const user = js.data;
          document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';

          let img = user.imageUrl || user.photoUrl || user.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }

          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = img || '/static/images/avatar-placeholder.png';
          }
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      restoreStates() {
        // Restore sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.querySelector(this.config.mainContentSelector);
          const icon = document.querySelector('#btnToggleMenu i');

          sidebar.classList.add('-translate-x-full');
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }

        // Restore dark mode
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeLabel').textContent = 'Light Mode';
        }
      }

      highlightActiveMenu() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop();

        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPage || currentPath.includes(href)) {
            link.classList.add('active');
          }
        });
      }

      // Public methods
      show() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('-translate-x-full');
      }

      hide() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('-translate-x-full');
      }

      setActiveMenu(menuHref) {
        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === menuHref) {
            link.classList.add('active');
          }
        });
      }
    }

    // Export for use
    window.SidebarComponent = SidebarComponent;
  </script>

  <!-- Custom CSS -->
  <style>
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --info: #560bad;
      --light-bg: #f5f7fa;
      --dark-text: #212529;
    }


    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 0;
    }

    aside.collapsed .ml-3 {
      display: none;
    }

    /* ===== MINIMAL CARD STYLES - FINAL ATTEMPT ===== */
    body .card, 
    body div.card,
    body .card.p-4 {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 16px !important;
      padding: 1.5rem !important;
      margin-bottom: 1rem !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      color: #374151 !important;
      backdrop-filter: blur(10px) !important;
      min-height: 120px !important;
      overflow: visible !important;
    }
    
    body .card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }
    
    /* Dark mode card styles */
    .dark .card {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }
    
    .dark .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
    }
    
    /* Card text alignment */
    .card h6, .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }
    
    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }
    
    .dark .card p {
      color: #9ca3af !important;
    }
    
    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }
    
    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }
    
    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }
    
    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }
    
    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }
    
    .card:hover .status-icon {
      opacity: 1 !important;
    }
    
    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }
    
    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }
    
    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }
    
    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }
    
    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }
    
    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }
    
    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }
    
    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }
    
    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }
    
    .dark .warning-text {
      color: #fbbf24 !important;
    }
    
    .dark .emergency-text {
      color: #f87171 !important;
    }
    
    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }
    
    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      color: #212529;
    }

    .dark .card-header {
      background-color: #2a2a2a;
    }

    .card-header i {
      margin-right: 10px;
      color: var(--primary);
    }

    .card-body {
      padding: 20px;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    /* Stepper */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #e9ecef;
      color: #adb5bd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .step.active .step-icon {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .step.completed .step-icon {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .step-text {
      font-size: 12px;
      color: #6c757d;
    }

    .step.active .step-text {
      color: var(--primary);
      font-weight: 600;
    }

    .step.completed .step-text {
      color: var(--success);
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Product card */
    .product-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      transform: translateY(-7px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: #f5f7fa;
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* 🔥 Fire Icon Animation */
    /* 🔥 Fire Icon Animation */
    .promo-fire-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 32px;
      z-index: 30;
      animation: fireScaleGlow 1.5s ease-in-out infinite;
    }

    @keyframes fireScaleGlow {

      0%,
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
      }

      50% {
        transform: scale(1.3);
        filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1)) drop-shadow(0 0 35px rgba(255, 100, 0, 0.8)) drop-shadow(0 0 45px rgba(255, 69, 0, 0.6));
      }
    }

    /* Card with promotion */
    .card.has-promotion {
      position: relative;
      overflow: visible !important;
    }

    /* Override card overflow for promotion icons */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
    }

    /* Confetti styles */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 1000;
    }

    /* Remove the following CSS rules */

    /* สีปกติของลิงก์ใน sidebar */
    /* Removed: #sidebar ul li a { color: #333333 !important; } */

    /* เมื่อ hover */
    /* Removed: Dynamic color rules for sidebar hover */

    /* เมื่อ active - ต้องมี background สีน้ำเงินด้วย */
    /* Removed: Dynamic color rules for sidebar active state */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }

    /* remove plan2/plan3 styles */
    /* Plan2 detail */
    /* .plan2-detail { display: none; } */

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>
</head>

  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    <!-- Sidebar Container (will be populated by sidebar.js) -->
    <div id="sidebarContainer"></div>

    <!-- Sidebar Initialization Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for sidebar.js to load and initialize
        setTimeout(() => {
          if (typeof initializeSidebar === 'function') {
            console.log('✅ External sidebar.js loaded, initializing...');
            initializeSidebar('sidebarContainer', 'mainContent');
          } else {
            console.warn('⚠️ External sidebar.js not available, using fallback...');
            initializeFallbackSidebar();
          }
        }, 200);
      });

      function initializeFallbackSidebar() {
        const container = document.getElementById('sidebarContainer');
        if (!container) return;

        // Create inline sidebar with full functionality
        container.innerHTML = `
          <!-- Toggle Button -->
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  aria-label="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <!-- Sidebar -->
          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
            
            <!-- Logo -->
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <!-- Menu Items -->
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                <li class="my-px">
                  <a href="frontstore_pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-blue-500 dark:text-blue-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                      <i class="bi bi-cash-stack text-xl"></i>
                    </span>
                    <span class="ml-3">ซื้อสด</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="installment_Pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-indigo-500 dark:text-indigo-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-indigo-500 dark:text-indigo-400">
                      <i class="bi bi-credit-card text-xl"></i>
                    </span>
                    <span class="ml-3">ซื้อผ่อน</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Addproduct_pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-green-500 dark:text-green-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                      <i class="bi bi-speedometer2 text-xl"></i>
                    </span>
                    <span class="ml-3">เพิ่มสินค้าใหม่</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="services"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-orange-500 dark:text-orange-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                      <i class="bi bi-tools text-xl"></i>
                    </span>
                    <span class="ml-3">บริการ</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="receiptVoucher"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-red-500 dark:text-red-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                      <i class="bi bi-receipt text-xl"></i>
                    </span>
                    <span class="ml-3">ใบสำคัญรับเงิน</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="DepositReceipt"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-teal-500 dark:text-teal-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-teal-500 dark:text-teal-400">
                      <i class="bi bi-receipt-cutoff text-xl"></i>
                    </span>
                    <span class="ml-3">ใบรับเงินมัดจำ</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Quotationn"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-purple-500 dark:text-purple-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                      <i class="bi bi-file-earmark-text text-xl"></i>
                    </span>
                    <span class="ml-3">ใบเสนอราคา</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Invoicee"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-fuchsia-500 dark:text-fuchsia-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-fuchsia-500 dark:text-fuchsia-400">
                      <i class="bi bi-receipt text-xl"></i>
                    </span>
                    <span class="ml-3">ใบแจ้งหนี้</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="productTransfer"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-pink-500 dark:text-pink-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-pink-500 dark:text-pink-400">
                      <i class="bi bi-arrow-left-right text-xl"></i>
                    </span>
                    <span class="ml-3">โอนย้ายสินค้า</span>
                  </a>
                </li>
                
                <!-- Divider -->
                <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                                 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
                    <span class="ml-3" id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <!-- Logout -->
                <li class="my-px">
                  <button id="btnLogout"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                                 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl"></i>
                    <span class="ml-3">ออกจากระบบ</span>
                  </button>
                </li>
                
                <!-- Profile -->
                <li class="my-px mt-2">
                  <div id="profile"
                       class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                        <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Profile" class="w-full h-full object-cover" />
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">Loading…</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;

        // Initialize events for fallback sidebar
        setupFallbackSidebarEvents();
      }

      function setupFallbackSidebarEvents() {
        // Toggle menu
        const btnToggleMenu = document.getElementById('btnToggleMenu');
        if (btnToggleMenu) {
          btnToggleMenu.addEventListener('click', toggleSidebarMenu);
        }

        // Dark mode toggle
        const btnToggleDark = document.getElementById('btnToggleDark');
        if (btnToggleDark) {
          btnToggleDark.addEventListener('click', toggleDarkMode);
        }

        // Logout
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.addEventListener('click', handleLogout);
        }

        // Load employee profile
        loadEmployeeProfileFallback();

        // Restore states
        restoreSidebarStates();

        // Highlight active menu
        highlightActiveMenu();
      }

      function toggleSidebarMenu() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        if (!sidebar || !mainContent || !icon) return;

        sidebar.classList.toggle('-translate-x-full');

        if (sidebar.classList.contains('-translate-x-full')) {
          mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          mainContent.style.marginLeft = '14rem';
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }

        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      }

      function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        const label = document.getElementById('darkModeLabel');
        if (label) {
          label.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
      }

      function handleLogout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.href = '/login';
      }

      async function loadEmployeeProfileFallback() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

          const user = js.data;
          const nameEl = document.getElementById('employeeName');
          if (nameEl) {
            nameEl.textContent = user.name || '(ไม่พบชื่อ)';
          }

          let img = user.imageUrl || user.photoUrl || user.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }

          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = img || '/static/images/avatar-placeholder.png';
          }
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      function restoreSidebarStates() {
        // Restore sidebar state
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        if (isCollapsed && sidebar && mainContent && icon) {
          sidebar.classList.add('-translate-x-full');
          mainContent.style.marginLeft = '0';
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }

        // Restore dark mode
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
          document.documentElement.classList.add('dark');
          const label = document.getElementById('darkModeLabel');
          if (label) {
            label.textContent = 'Light Mode';
          }
        }
      }

      function highlightActiveMenu() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop();

        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPage || currentPath.includes(href)) {
            link.classList.add('active');
          }
        });
      }
    </script>

  <div id="mainContent" class="flex-1 flex flex-col ml-56 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800
                    border-b border-gray-200 dark:border-gray-700
                    flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">ระบบผ่อน - ผ่อนหมดรับของ Pattani</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          กำลังโหลดสาขา...
        </p>
      </div>

      <!-- ปุ่มใบเสร็จ/ใบกำกับภาษี + ผ่อนไปใช้ไป + ผ่อนหมดรับของ -->
      <div class="flex items-center gap-2">
        <a href="History_installment"
          class="btn btn-primary flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          <i class="bi bi-receipt text-lg"></i>
          <span>ใบเสร็จ/ใบกำกับภาษี</span>
        </a>
        <a href="Installment_on_use"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
          <span>ผ่อนไปใช้ไป</span>
        </a>
        <a href="Installment_complete_pickup"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <span>ผ่อนหมดรับของ</span>
        </a>
      </div>
    </header>

    <!-- Content -->
    <main class="p-4">
      <!-- Stepper -->
      <div class="stepper mb-4">
        <div class="step active" data-step="1">
          <div class="step-icon">1</div>
          <div class="step-text">เลือกสินค้า</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-icon">2</div>
          <div class="step-text">ข้อมูลลูกค้า</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-icon">3</div>
          <div class="step-text">เสร็จสิ้น</div>
        </div>
      </div>

      <!-- STEP 1 -->
      <div id="step1" class="step-content active">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- ซ้าย: Level1 + ค้นหา -->
          <div class="lg:col-span-2 space-y-4">
            <!-- Card ค้นหา -->
            <div class="card p-4">
              <div class="flex gap-2">
                <input id="productSearchQuery" class="input input-bordered w-full" placeholder="ค้นหาด้วยชื่อรุ่น..." />
                <button id="btnProductSearch" class="btn btn-primary">ค้นหา</button>
                <button id="btnProductReset" class="btn btn-secondary">รีเซ็ต</button>
              </div>
            </div>

            <!-- Container Level1 -->
            <div id="level1Container" class="card">
              <div class="card-header">
                <i class="bi bi-box-seam"></i> แบรนด์สินค้า (Level 1)
              </div>
              <div class="card-body">
                <div id="level1Grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- renderLevel1() -->
                </div>
              </div>
            </div>

            <!-- Container Level2 -->
            <div id="level2Container" class="card hidden">
              <div class="card-header flex justify-between items-center">
                <div>
                  <i class="bi bi-menu-button-wide"></i>
                  <span id="level2Title">รายการของ ...</span>
                </div>
                <button class="btn btn-sm" id="btnBackToLevel1">
                  <i class="bi bi-arrow-left mr-1"></i> ย้อนกลับ
                </button>
              </div>
              <div class="card-body">
                <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- renderLevel2() -->
                </div>
              </div>
            </div>

            <!-- Container Level3 -->
            <div id="level3Container" class="card hidden">
              <div class="card-header">
                <div>
                  <i class="bi bi-phone"></i>
                  <span id="level3Title">รายละเอียดสินค้า</span>
                </div>
              </div>
              <div class="card-body">
                <div id="level3Grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
              </div>
            </div>

            <!-- Container ผลลัพธ์การค้นหา -->
            <div id="imeiResultContainer" class="card hidden">
              <div class="card-header">
                <i class="bi bi-search"></i> ผลลัพธ์การค้นหา
              </div>
              <div class="card-body">
                <div id="imeiResultGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
              </div>
            </div>
          </div>

          <!-- ขวา: ตะกร้าสินค้า/สรุป/ไป Step2 -->
          <div>
            <div class="card">
              <div class="card-header">
                <i class="bi bi-cart"></i> สรุปรายการสินค้า
              </div>
              <div class="card-body">
                <div class="cart-summary">
                  <p class="text-gray-500">ยังไม่มีสินค้าในตะกร้า</p>
                </div>
                <hr class="my-3" />
                <button class="btn btn-primary w-full" id="btnStep1ToStep2">
                  <i class="bi bi-arrow-right mr-2"></i> ยืนยัน
                </button>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End STEP1 -->

      <!-- STEP 2 -->
      <div id="step2" class="step-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- ซ้าย: ฟอร์มข้อมูลลูกค้า -->
          <div class="lg:col-span-2">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-person"></i> ข้อมูลลูกค้า
              </div>
              <div class="card-body">
                <!-- ปุ่มอ่านบัตรประชาชน -->
                <button
                  id="btnReadCard"
                  class="btn btn-info w-full mb-4 flex items-center justify-center gap-2"
                >
                  <i class="bi bi-credit-card-2-front"></i> อ่านข้อมูลจากบัตรประชาชน
                </button>

                <!-- ส่วนค้นหาลูกค้าเก่า -->
                <div class="mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                  <label class="label">
                    <span class="label-text font-semibold">
                      <i class="bi bi-search"></i> ค้นหาลูกค้าเก่า
                    </span>
                  </label>
                  <div class="flex gap-2">
                    <input 
                      type="text" 
                      id="customerSearch" 
                      class="input input-bordered flex-1" 
                      placeholder="ค้นหาด้วยเลขบัตรประชาชน 13 หลัก"
                      maxlength="13"
                    />
                    <button 
                      id="btnSearchCustomer" 
                      class="btn btn-primary"
                      title="ค้นหาลูกค้า"
                    >
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    💡 <strong>เคล็ดลับ:</strong> พิมพ์ครบ 13 หลักจะค้นหาอัตโนมัติ | ระบบจำกัดการค้นหา 3 วินาที/ครั้ง
                  </div>
                  
                  <!-- ผลการค้นหา -->
                  <div id="customerSearchResults" class="mt-3 hidden">
                    <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                      <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Results will be inserted here -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ส่วนข้อมูลลูกค้าพื้นฐาน -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">คำนำหน้า</span></label>
                    <select id="customerPrefix" class="select select-bordered w-full">
                      <option value="">- เลือก -</option>
                      <option>นาย</option>
                      <option>นาง</option>
                      <option>นางสาว</option>
                    </select>
                  </div>
                  <div>
                    <label class="label"><span class="label-text">ชื่อ</span></label>
                    <input type="text" id="customerFirstName" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">นามสกุล</span></label>
                    <input type="text" id="customerLastName" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">เลขบัตรประชาชน</span></label>
                    <input type="text" id="customerIdCard" class="input input-bordered w-full" />
                  </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">เบอร์โทรศัพท์</span></label>
                    <input type="text" id="customerPhone" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">อีเมล</span></label>
                    <input type="email" id="customerEmail" class="input input-bordered w-full" />
                  </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">บ้านเลขที่</span></label>
                    <input type="text" id="houseNo" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">หมู่</span></label>
                    <input type="text" id="moo" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">ตำบล</span></label>
                    <input type="text" id="subDistrict" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">อำเภอ</span></label>
                    <input type="text" id="district" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">จังหวัด</span></label>
                    <input type="text" id="province" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">รหัสไปรษณีย์</span></label>
                    <input type="text" id="zipcode" class="input input-bordered w-full" />
                  </div>
                </div>
                <!-- Removed camera and signature related HTML from here if it existed -->
              </div>
            </div>
          </div>
          <!-- ขวา: สรุปรายการสินค้าและปุ่มนำทาง -->
          <div>
            <div class="card">
              <div class="card-header">
                <i class="bi bi-cart"></i> สรุปรายการสินค้า
              </div>
              <div class="card-body">
                <div class="cart-summary space-y-2 text-sm text-gray-600">
                  <p>ยังไม่มีสินค้าในตะกร้า</p>
                </div>





                <div class="mt-4 space-y-2">
                  <button type="button" class="btn btn-primary w-full" id="btnStep2OpenModal">
                    <i class="bi bi-save mr-2"></i> บันทึก
                  </button>
                  <button class="btn btn-outline-secondary w-full" id="btnStep2ToStep1">
                    <i class="bi bi-arrow-left mr-2"></i> ย้อนกลับ
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End STEP2 -->



  </div>
  </div>




  <div id="step3" class="step-content">
    <div class="flex flex-col justify-center items-center py-20">
      <div class="text-center">
        <div class="text-6xl mb-4">🎉</div>
        <h2 class="text-3xl font-bold text-green-600 mb-4">สำเร็จแล้ว!</h2>
        <p class="text-lg text-gray-600 mb-2">ระบบบันทึกข้อมูลผ่อนหมดรับของเรียบร้อยแล้ว</p>
        <p class="text-sm text-purple-600 mb-6">รอการอนุมัติจากผู้จัดการ หลังอนุมัติลูกค้าสามารถมารับสินค้าได้ทันที</p>
        
        <div class="bg-blue-50 p-4 rounded-lg max-w-md mx-auto">
          <h3 class="font-semibold text-blue-800 mb-2">ขั้นตอนต่อไป:</h3>
          <ul class="text-sm text-blue-600 text-left space-y-1">
            <li>• รอการอนุมัติจากผู้จัดการ</li>
            <li>• ลูกค้าจะได้รับการแจ้งเตือน</li>
            <li>• นำเอกสารมารับสินค้าได้เลย</li>
          </ul>
        </div>
        
        <p class="text-xs text-gray-500 mt-4">หน้านี้จะกลับไปหน้าแรกอัตโนมัติในอีก 5 วินาที</p>
      </div>
    </div>
  </div>
  <!-- End STEP4 -->








  </main>
  </div>
  </div>







  <!-- Script หลัก -->
  <script>
    // เพิ่มฟังก์ชันนี้เพื่อตรวจสอบข้อมูล
    async function checkSpecialBoxsets() {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/product-image', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
    
        console.log('All products:', data.data);
    
        // แสดงเฉพาะ boxset ทั้งหมด
        const allBoxsets = data.data.filter(item => item.productType === 'boxset');
        console.log('All boxsets:', allBoxsets);
    
        // แสดงเฉพาะ special boxset
        const specialBoxsets = allBoxsets.filter(item => item.boxsetType === 'special');
        console.log('Special boxsets:', specialBoxsets);
    
        return specialBoxsets;
      } catch (error) {
        console.error('Error checking boxsets:', error);
      }
    }

    // ฟังก์ชันตรวจสอบ token validity
    async function validateToken() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          console.warn('❌ No token found');
          return false;
        }

        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          console.error('❌ Token validation failed:', res.status);
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            showToast('❌ Token หมดอายุ กรุณาเข้าสู่ระบบใหม่', 'error');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
          }
          return false;
        }

        return true;
      } catch (err) {
        console.error('❌ Token validation error:', err);
        return false;
      }
    }

    // โหลดโปรไฟล์พนักงาน
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
    
        if (!res.ok) {
          if (res.status === 401) {
            console.error('❌ Token invalid during profile load');
            localStorage.removeItem('authToken');
            showToast('❌ Token หมดอายุ กรุณาเข้าสู่ระบบใหม่', 'error');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
          }
          return;
        }
    
        const js = await res.json();
        if (!js.success) throw new Error(js.error || js.message || res.status);
        const u = js.data;
        window.employeeId = u._id;
        window.employeeName = u.name;        // ← เก็บชื่อไว้ใช้ส่งขึ้น server
    
        // ตรวจสอบว่า element มีอยู่จริงก่อนใช้งาน
        const nameEl = document.getElementById('employeeName');
        if (nameEl) {
          nameEl.textContent = u.name || '(ไม่พบชื่อ)';
        }
    
        let img = u.imageUrl || u.photoUrl || u.image || '';
        if (img && !/^https?:\/\//.test(img)) {
          img = img.startsWith('/') ? img : '/uploads/' + img;
        }
    
        const photoElement = document.getElementById('employeePhoto');
        if (photoElement) {
          photoElement.src = img || '/static/images/avatar-placeholder.png';
        }
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }

    // ฟังก์ชันช่วยอัปโหลดไฟล์ทั่วไป (รับชื่อ field + ชื่อไฟล์ได้)
    async function uploadFile(file, uploadEndpoint, fieldName = 'file', filename = 'file', extras = {}) {
      const formData = new FormData();
      formData.append(fieldName, file, filename);
      // append ค่าอื่นๆ ถ้ามี
      Object.entries(extras).forEach(([key, val]) => {
        formData.append(key, val);
      });
      const res = await fetch(uploadEndpoint, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
      const js = await res.json();
      return js.url; // Assuming the server returns { success: true, url: '...' }
    }

    // ฟังก์ชันช่วยอัปโหลดลายเซ็น (Simplified: assumes pad and urlFieldId are valid if called)
    async function uploadSignature(pad, urlFieldId) {
      if (!pad || pad.isEmpty()) {
        // Consider removing alert or making it conditional if pad might not exist
        // return alert("กรุณาลงลายเซ็นก่อนบันทึก");
        console.warn('Signature pad is empty or not provided.');
        return;
      }
      const dataURL = pad.toDataURL('image/png');
      const blob = await (await fetch(dataURL)).blob();
      try {
        const url = await uploadFile(
          blob,
          '/api/upload/signature',
          'signature',
          'signature.png'
        );
        const urlInput = document.getElementById(urlFieldId);
        if (urlInput) {
          urlInput.value = url;
        } else {
          console.warn(`Input field with ID ${urlFieldId} not found for signature URL.`);
        }
      } catch (error) {
        console.error('Error uploading signature:', error);
        showToast('อัปโหลดลายเซ็นไม่สำเร็จ: ' + error.message, 'error');
      }
    }

    // —————————————— จบส่วนที่เพิ่ม ——————————————

    // =========================== A) GLOBAL CONSTANTS & VARS ===========================
    const BRANCH_CODE = '00000';
    let branchInstallments = [];
    let productImages = [];
    let activePromotions = [];
    let appliedPromotions = {};
    let level2Groups = {};
    let cartItems = [];   // เก็บสินค้าในตะกร้า
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];


    let signaturePad, empPad; // สำหรับลายเซ็น

    // ขยับมาด้านบนสุดของ <script> เลย
    if (!document.getElementById('toastContainer')) {
      const toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} shadow-lg`;
      alert.innerHTML = `<span>${message}</span>`;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }


    // A) โหลดสินค้าผ่อนจาก API (Level1)
    async function loadBranchInstallments() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const url = `/api/product-image`;
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error(res.status);
        const js = await res.json();

        console.log('Raw data from API:', js.data);

        // แก้ไข: แสดงทั้งสินค้าปกติและ special boxset
        productImages = (js.data || []).filter(item => {
          // แสดง special boxset
          if (item.productType === 'boxset' && item.boxsetType === 'special') {
            return true;
          }
          // แสดงสินค้าปกติ (ที่ไม่ใช่ boxset)
          if (!item.productType || item.productType !== 'boxset') {
            return true;
          }
          // ไม่แสดง boxset ธรรมดา (ที่ไม่ใช่ special)
          return false;
        });

        console.log('Filtered products (including normal products and special boxsets):', productImages);

      } catch (err) {
        console.error('loadBranchInstallments failed:', err);
        productImages = [];
      }
    }




    /**
   * numberToThaiText: แปลงตัวเลข (จำนวนเต็ม) เป็นข้อความภาษาไทย
   * รองรับจนถึงหลักล้าน (และวนกลับที่ "ล้าน")
   */
    function numberToThaiText(number) {
      const txtNum = ['ศูนย์', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
      const txtDigit = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
      if (isNaN(number)) return '';

      let n = Math.floor(Math.abs(number)).toString();
      let len = n.length;
      let result = '';

      for (let i = 0; i < len; i++) {
        const digit = parseInt(n.charAt(i), 10);
        const pos = len - i - 1;                // 0 = หน่วย, 1 = สิบ, 2 = ร้อย, ...
        const unit = pos % 6;                   // วนซ้ำทุก 6 ตำแหน่ง (ล้าน)
        const group = Math.floor(pos / 6);       // กำหนดกลุ่ม "ล้าน" ซ้ำ

        if (digit !== 0) {
          // หลักสิบ special: 1 → "สิบ", 2 → "ยี่สิบ"
          if (unit === 1) {
            if (digit === 1) result += 'สิบ';
            else if (digit === 2) result += 'ยี่สิบ';
            else result += txtNum[digit] + 'สิบ';
          }
          // หลักหน่วย special: 1 → "เอ็ด" เมื่อไม่ใช่เลขหลักเดียว
          else if (unit === 0 && digit === 1 && len > 1) {
            result += 'เอ็ด';
          }
          else {
            result += txtNum[digit] + txtDigit[unit];
          }
        }

        // ครบกลุ่มล้าน ให้เติมคำว่า "ล้าน"
        if (unit === 0 && group > 0 && digit !== 0) {
          result += 'ล้าน'.repeat(group);
        }
      }

      // ถ้าเป็น 0 ให้เติม "ศูนย์"
      if (result === '') result = txtNum[0];

      return result;
    }





    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch('/api/branch', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const js = await res.json();
        if (!js.success) throw new Error('ไม่พบข้อมูลสาขา');
        const data = js.data || [];
        const found = data.find(b => b.branch_code === BRANCH_CODE);
        if (found) {
          // เก็บ global
          window.currentBranchInfo = {
            code: found.branch_code,
            name: found.name,
            address: found.address,
            taxId: found.taxId || '-',
            tel: found.tel || '-',
          };
          document.getElementById('branchInfo').textContent =
            `${found.name} — ${found.address}`;
        } else {
          throw new Error(`ไม่พบสาขา ${BRANCH_CODE}`);
        }
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '(ไม่พบข้อมูลสาขา)';
        // ให้ default object ไว้กัน error
        window.currentBranchInfo = {
          code: BRANCH_CODE,
          name: 'Default Branch',
          address: '-',
          taxId: '-',
          tel: '-',
        };
      }
    }



    // =========================== D) LOAD/RENDER LEVEL1/2/3 ===========================
    async function loadLevel1() {
      // แสดงเฉพาะ Special Boxset
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
    
      // ตั้งชื่อ title
      document.getElementById('level3Title').textContent = '🌟 Special Boxset Collection - ผ่อนหมดรับของ';
    
      // กรองเฉพาะ Special Boxset เท่านั้น
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      console.log('📦 โหลด Special Boxsets สำหรับระบบผ่อนหมดรับของ:', specialBoxsets.length, 'รายการ');
    
      if (specialBoxsets.length === 0) {
        document.getElementById('level3Grid').innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="text-gray-500">
              <i class="bi bi-box-seam text-4xl mb-2"></i>
              <p>ไม่พบ Special Boxset สำหรับระบบผ่อนหมดรับของ</p>
              <p class="text-sm">กรุณาติดต่อผู้ดูแลระบบเพื่อเพิ่มสินค้า</p>
            </div>
          </div>
        `;
      } else {
        // แสดงเฉพาะ Special Boxset ใน level3
        renderLevel3(specialBoxsets);
      }
    }


    function renderLevel1(categories) {
      const grid = document.getElementById('level1Grid');
      grid.innerHTML = '';

      categories.forEach(cat => {
        const hasPromo = checkBrandHasPromotion(cat.key);
        const card = document.createElement('div');
    
        // --- REFACTORED ---
        // ใช้ class 'card' หลัก แล้วเพิ่ม class อื่นๆ ตามเงื่อนไข
        card.className = 'card cursor-pointer';
        if (hasPromo) {
          card.classList.add('has-promotion');
        }
        if (cat.isSpecial) {
          card.classList.add('border-purple-500', 'border-2');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
        const textColor = cat.isSpecial ? 'text-purple-600 font-bold' : (hasPromo ? 'text-red-600' : '');

        card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-semibold ${textColor}">${cat.label}</h6>
      <p class="text-sm text-gray-500 mt-2">มี ${cat.stock || 0} ชิ้น</p>
      ${cat.isSpecial ? '<span class="badge badge-purple mt-1">พิเศษ</span>' : ''}
    `;

        card.addEventListener('click', () => {
          if (cat.key === 'special-boxset') {
            loadSpecialBoxsets();
          } else {
            loadLevel2(cat.key, cat.label);
          }
        });
    
        grid.appendChild(card);
      });
    }

    // ฟังก์ชันแสดงเฉพาะ Special Boxsets
    function loadSpecialBoxsets() {
      // ซ่อน containers อื่น
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    
      // กรองเฉพาะ special boxsets
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      // แสดงใน Level3 โดยตรง
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = '🌟 Special Boxset Collection';
    
      renderLevel3(specialBoxsets);
    }

    // 2) แก้ loadLevel2 ให้กรองจาก allProductImages ตามแบรนด์ (parentKey) แล้วจัดกลุ่ม
    // 2) แก้ loadLevel2 ให้กรองจาก branchInstallments ตามแบรนด์ (parentKey) แล้วจัดกลุ่ม
    function loadLevel2(parentKey, parentLabel) {
      // ซ่อน / แสดง container
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `รายการของ ${parentLabel}`;

      // กรองเฉพาะสินค้าที่ brand หรือชื่อขึ้นต้นด้วย parentKey
      const filtered = productImages.filter(p => {
        const brand = p.brand || p.name.split(' ')[0];
        const key = brand.trim().toLowerCase();
        return key === parentKey;
      });

      // จัดกลุ่ม Level2 ตามสองคำแรกของชื่อสินค้า
      level2Groups = filtered.reduce((groups, p) => {
        const baseName = p.name.split(' ').slice(0, 2).join(' ');
        (groups[baseName] ||= []).push(p);
        return groups;
      }, {});

      // ถ้าไม่เจออะไรเลย ให้ย้อนกลับ
      if (!Object.keys(level2Groups).length) {
        showToast('ไม่พบสินค้าในแบรนด์นี้', 'warning');
        return document.getElementById('btnBackToLevel1').click();
      }

      renderLevel2(Object.keys(level2Groups));
    }


    // 3) renderLevel2 รับเป็น list ของชื่อกลุ่ม
    function renderLevel2(groupNames) {
      const grid = document.getElementById('level2Grid');
      grid.innerHTML = '';

      groupNames.forEach(baseName => {
        const items = level2Groups[baseName];
        const hasPromo = checkGroupHasPromotion(items);
        const count = items.length;

        const card = document.createElement('div');
        // --- REFACTORED ---
        card.className = 'card cursor-pointer';
        if (hasPromo) {
          card.classList.add('has-promotion');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';

        card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-medium ${hasPromo ? 'text-red-600' : ''}">${baseName}</h6>
      <p class="text-sm text-gray-500 mt-2">มี ${count} ชิ้น</p>
      ${hasPromo ? '<p class="text-xs text-red-500 mt-1 font-semibold animate-pulse">ลดราคาพิเศษ!</p>' : ''}
    `;

        card.addEventListener('click', () => showLevel3Group(baseName));
        grid.appendChild(card);
      });
    }

    // 4) showLevel3Group ดึงข้อมูลจาก level2Groups มาแสดง
    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `รายละเอียดสินค้า: ${baseName}`;

      // จัดการต่อแค่ renderLevel3 โดยตรง เพราะ rawItems คือรูป+ข้อมูลครบแล้ว
      renderLevel3(level2Groups[baseName]);
    }

    // 5) renderLevel3 แสดง card + ปุ่มหยิบใส่ตะกร้า
    function renderLevel3(items) {
      currentLevel3Items = items;
      const grid = document.getElementById('level3Grid');
      grid.innerHTML = '';

      const visible = items.filter(it => !hiddenProductIds.has(it._id));
      if (!visible.length) {
        return grid.innerHTML = `<div class="text-gray-500">ไม่พบสินค้า</div>`;
      }

      visible.forEach(it => {
        const hasPromo = checkPromotionForProduct(it._id);
        const col = document.createElement('div');
        // --- REFACTORED ---
        col.className = 'card';
        if (hasPromo) {
          col.classList.add('has-promotion');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
        const actualPayOffPrice = (it.price || 0) + 2590;

        // เพิ่มปุ่มดูรายละเอียดสำหรับ Boxset
        const viewDetailsBtn = it.productType === 'boxset' ? `
          <button class="btn btn-sm btn-info mb-2" onclick="showBoxsetItemsModal('${it._id}', '${it.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-eye"></i> ดูสินค้าใน Boxset
          </button>
        ` : '';

        col.innerHTML = `
          ${fireIcon}
          <img src="${it.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${it.name}" />
          <h6 class="font-medium text-sm mb-1">${it.name}</h6>
          <div class="text-sm font-semibold text-purple-600 mb-2">
            💰 ราคาผ่อนหมดรับของ: ฿${actualPayOffPrice.toLocaleString()}
          </div>
          <div class="text-xs text-gray-500 mb-4">
            ✨ จ่ายครบ 100% เก็บของได้ทันทีหลังอนุมัติ
          </div>
          ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
          ${viewDetailsBtn}
          <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
        `;

        col.querySelector('.btn-primary').addEventListener('click', () => addToCart(it));
        grid.appendChild(col);
      });
    }

    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
      const hasPromo = checkPromotionForProduct(item._id);

      // คำนวณ pricePayOff ที่ถูกต้อง
      const actualPayOffPrice = (item.price || 0) + 2590;

      const cartItem = {
        ...item,
        pricePayOff: actualPayOffPrice,  // ใช้ราคาที่คำนวณใหม่
        docFee: item.docFee || 0,
        taxRate: item.taxRate ?? 0,
        taxType: item.taxType ?? 'ไม่มี VAT'
      };

      // เพิ่มสินค้าเข้า cartItems
      cartItems.push(cartItem);
      hiddenProductIds.add(item._id);

      // รีเฟรช UI
      renderCart();
      renderLevel3(currentLevel3Items);

      // เรียกเช็คโปรโมชั่นเพียงครั้งเดียวที่นี่
      checkAvailablePromotions();

      // แสดง effect ถ้ามีโปรโมชั่น
      if (hasPromo) {
        const mainContent = document.getElementById('mainContent');
        createConfettiEffect(mainContent);
        showToast(`🎉 ยินดีด้วย! ${item.name} มีโปรโมชั่นพิเศษ!`, 'success');
      } else {
        showToast(`✅ เพิ่ม ${item.name} ลงในตะกร้าแล้ว`, 'success');
      }

      // Removed check for selectedPlan and initManualTerms()
    }

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    function renderCart() {
      const summaries = document.querySelectorAll('.cart-summary');
      if (!summaries.length) return;

      const currentStep = document.querySelector('.step-content.active')?.id;
      let html = '';

      if (cartItems.length === 0) {
        html = `<p class="text-gray-500">ยังไม่มีสินค้าในตะกร้า</p>`;
      } else if (currentStep === 'step3') {
        // ถ้าอยู่ใน step3 เราอาจดึงเนื้อหาใน #step3 .cart-summary มาโชว์
        html = document.querySelector('#step3 .cart-summary').innerHTML;
      } else {
        // แสดงรายการสินค้า + ปุ่มลบ
        html = cartItems.map((it, idx) => {
          // ตรวจสอบโปรโมชั่นสำหรับสินค้านี้
          const promo = appliedPromotions[it._id];

          const base = it.pricePayOff;

          // Calculate VAT amount based on tax type
          const rate = (it.taxRate || 0) / 100;
          let vatAmount = 0;
          if (it.taxType === 'แยกภาษี') {
            vatAmount = base * rate;
          } else if (it.taxType === 'รวมภาษี') {
            vatAmount = base - (base / (1 + rate));
          }

          // สร้าง HTML สำหรับโปรโมชั่น
          let promoHTML = '';
          if (promo) {
            const disc = promo.type === 'percentage'
              ? base * (promo.discount / 100)
              : promo.discount;
            const newPrice = base - disc;

            promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">฿${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">฿${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-฿${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
          }

          return `
  <div class="flex items-start gap-2 border-b py-2">
    <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />
    <div class="flex-1">
      <div class="font-semibold">${it.name}</div>
      <div class="text-sm text-primary">
        ราคา: ฿${it.pricePayOff.toLocaleString()}
      </div>
      ${promoHTML}
    </div>
    <button class="btn btn-sm btn-error" data-index="${idx}">ลบ</button>
  </div>
`;
        }).join('');
      }

      summaries.forEach(el => {
        el.innerHTML = html;
        // ผูกปุ่มลบ
        el.querySelectorAll('button.btn-error').forEach(btn => {
          btn.addEventListener('click', () => {
            removeFromCart(parseInt(btn.dataset.index, 10));
          });
        });
      });

      // เรียกเช็คโปรโมชั่นอีกครั้งหลังรีเฟรชตะกร้า (ถ้ามีสินค้า)
      if (cartItems.length > 0 && currentStep !== 'step3') {
        // ลบการเรียก checkAvailablePromotions() เพื่อป้องกัน infinite loop
        console.log('🛒 Cart rendered with', cartItems.length, 'items');
      }
    }

    /**
    * เอาผลลัพธ์ค้นหาไปแสดงในกล่อง imeiResultContainer
    */
    function renderSearchResult(items) {
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');

      const container = document.getElementById('imeiResultContainer');
      const grid = document.getElementById('imeiResultGrid');
      container.classList.remove('hidden');
      grid.innerHTML = '';

      if (!items.length) {
        grid.innerHTML = `<div class="text-gray-500 p-4">ไม่พบสินค้า</div>`;
        return;
      }

      items.forEach(item => {
        const hasPromo = checkPromotionForProduct(item._id);

        const card = document.createElement('div');
        card.className = 'card p-4 flex flex-col relative';

        if (hasPromo) {
          card.style.overflow = 'visible';
        }

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';

        const actualPayOffPrice = (item.price || 0) + 2590;

        card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  <div class="text-sm font-semibold text-purple-600 mb-2">
    💰 ราคาผ่อนหมดรับของ: ฿${actualPayOffPrice.toLocaleString()}
  </div>
  <div class="text-xs text-gray-500 mb-4">
    ✨ จ่ายครบ 100% เก็บของได้ทันทีหลังอนุมัติ
  </div>
  ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
`;

        card.querySelector('button').addEventListener('click', () => addToCart(item));
        grid.appendChild(card);
      });
    }

    // 1. ฟังก์ชันดึงข้อมูล Boxset จาก API
    async function getBoxsetDetails(boxsetId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch(`/api/product-image/boxset/${boxsetId}/details`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        if (!res.ok) {
          throw new Error('Failed to fetch boxset details');
        }
    
        const data = await res.json();
        return data.data;
      } catch (error) {
        console.error('Error fetching boxset details:', error);
        showToast('ไม่สามารถโหลดข้อมูล Boxset ได้', 'error');
        return null;
      }
    }

    /**
     * แสดง Modal รายละเอียดสินค้าใน Boxset
     */
async function showBoxsetItemsModal(boxsetId, boxsetName) {
  try {
    // แสดง loading
    showToast('กำลังโหลดข้อมูล...', 'info');
    
    // ดึงข้อมูล boxset จาก API
    const boxset = await getBoxsetDetails(boxsetId);
    
    if (!boxset) {
      showToast('ไม่พบข้อมูล Boxset', 'error');
      return;
    }
    
    // ตรวจสอบว่ามีสินค้าใน boxset หรือไม่
    if (!boxset.boxsetProducts || boxset.boxsetProducts.length === 0) {
      showToast('Boxset นี้ยังไม่มีสินค้า', 'warning');
      return;
    }

    // สร้าง Modal HTML
    const modal = document.createElement('div');
    modal.id = 'boxsetModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    
    // คำนวณราคารวมของสินค้าใน boxset
    const totalValue = boxset.boxsetProducts.reduce((sum, item) => {
      return sum + (item.price || 0);
    }, 0);
    
    // แสดง discount ถ้าเป็น payoff boxset
    let discountInfo = '';
    if (boxset.boxsetType === 'payoff' && boxset.payoffDiscount) {
      discountInfo = `
        <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg mb-4">
          <p class="text-green-800 dark:text-green-200 font-semibold">
            💰 ส่วนลดพิเศษ: ${boxset.payoffDiscount}% เมื่อผ่อนหมดรับของ
          </p>
        </div>
      `;
    }
    
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-lg font-semibold">🎁 สินค้าใน ${boxsetName}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              ประเภท: ${boxset.boxsetType === 'special' ? '🌟 Special Boxset' :
                        boxset.boxsetType === 'payoff' ? '💰 Payoff Boxset' :
                        '📦 Normal Boxset'}
            </p>
          </div>
          <button class="btn btn-sm btn-circle" onclick="closeBoxsetModal()">✕</button>
        </div>
        
        ${discountInfo}
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${boxset.boxsetProducts.map((item, index) => `
            <div class="card p-4 border">
              <img src="${item.image || '/uploads/default-product.png'}" 
                   class="w-full h-32 object-cover rounded mb-2" 
                   alt="${item.name}" />
              <h6 class="font-medium text-sm">${item.name}</h6>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                ${item.brand || 'ไม่ระบุแบรนด์'}
              </p>
              <p class="text-sm font-semibold text-primary mt-2">
                ราคา: ฿${(item.price || 0).toLocaleString()}
              </p>
            </div>
          `).join('')}
        </div>
        
        <div class="mt-6 border-t pt-4">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                จำนวนสินค้าทั้งหมด: ${boxset.boxsetProducts.length} รายการ
              </p>
              <p class="text-lg font-semibold">
                มูลค่ารวม: ฿${totalValue.toLocaleString()}
              </p>
            </div>
            <button class="btn btn-primary" onclick="closeBoxsetModal()">ปิด</button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    
    // เพิ่ม event listener สำหรับคลิกพื้นหลัง
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeBoxsetModal();
      }
    });
    
  } catch (error) {
    console.error('Error in showBoxsetItemsModal:', error);
    showToast('เกิดข้อผิดพลาดในการแสดงรายละเอียด Boxset', 'error');
  }
}

    /**
     * ปิด Modal รายละเอียด Boxset
     */
    function closeBoxsetModal() {
      const modal = document.getElementById('boxsetModal');
      if (modal) {
        modal.remove();
      }
    }


    // F) ค้นหาสินค้า (ชื่อรุ่น หรือ IMEI)
    async function searchItems() {
      const query = document.getElementById('productSearchQuery').value.trim();
      if (!query) {
        showToast('กรุณากรอกคำค้นหา', 'warning');
        return;
      }

      // ค้นหาเฉพาะจาก Special Boxset เท่านั้น
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      const results = specialBoxsets.filter(item =>
        item.name.toLowerCase().includes(query.toLowerCase())
      );

      if (results.length === 0) {
        showToast('ไม่พบ Special Boxset ที่ค้นหา', 'info');
      }

      renderSearchResult(results);
    }


    // ผูก event ให้ปุ่ม autoPrintYes
    // Removed event listener for btnAutoPrintYes

    // ผูก event ให้ปุ่ม "พิมพ์เอกสาร"
    // Removed event listener for btnPrintPdf


    function resetSearch() {
      document.getElementById('productSearchQuery').value = '';
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
    
      // แสดงเฉพาะ Special Boxset อีกครั้ง
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
      renderLevel3(specialBoxsets);
    }




    async function loadActivePromotions() {
      try {
        showToast('🔄 กำลังโหลดโปรโมชั่น...', 'info');
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/active', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const js = await res.json();
        if (js.status === 'success') {
          activePromotions = js.data.filter(p => {
            const now = new Date();
            const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
            const startOk = new Date(p.startDate) <= now;
            const endOk = new Date(p.endDate) >= now;
            const activeOk = p.isActive === true;
            const usageOk = !p.usageLimit || (p.usageCount < p.usageLimit);
            return branchOk && startOk && endOk && activeOk && usageOk;
          });
          showToast(`✅ โหลดโปรโมชั่นสำเร็จ: ${activePromotions.length} รายการ`, 'success');
        }
      } catch (err) {
        console.error('❌ Error loading promotions:', err);
        activePromotions = [];
      }
    }

    function checkPromotionForProduct(productId) {
      console.log('🔍 Checking promotion for product:', productId);

      // หาข้อมูลสินค้าจาก branchInstallments
      const stockItem = productImages.find(item => item._id === productId);
      if (!stockItem) {
        console.log('❌ Stock item not found');
        return false;
      }

      console.log('📦 Stock item found:', {
        _id: stockItem._id,
        name: stockItem.name,
        brand: stockItem.brand
      });

      const hasPromo = activePromotions.some(p => {
        // ถ้าไม่ระบุสินค้า = ใช้ได้กับทุกสินค้า
        const allProducts = !p.applicableProducts ||
          (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);

        if (allProducts) {
          console.log(`✅ Promotion "${p.name}" applies to all products`);
          return true;
        }

        // เช็คด้วยชื่อสินค้า
        let matchByName = false;
        if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
          matchByName = p.applicableProducts.some(prod => {
            const stockName = stockItem.name.trim().toLowerCase();
            const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
            return stockName === promoProductName;
          });
        }

        // เช็คด้วย Product ID (fallback)
        let matchById = false;
        if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
          matchById = p.applicableProducts.some(prod => {
            const prodId = typeof prod === 'string' ? prod : prod._id;
            return prodId === productId;
          });
        }

        return allProducts || matchByName || matchById;
      });

      console.log('🔥 Has promotion:', hasPromo);
      return hasPromo;
    }

    // ฟังก์ชันเช็คโปรโมชั่นระดับแบรนด์
    function checkBrandHasPromotion(brandKey) {
      const brandProducts = productImages.filter(p => {
        const brand = p.brand || p.name.split(' ')[0];
        const key = brand.trim().toLowerCase();
        return key === brandKey;
      });

      return brandProducts.some(product => checkPromotionForProduct(product._id));
    }

    // ฟังก์ชันเช็คโปรโมชั่นระดับกลุ่ม
    function checkGroupHasPromotion(groupItems) {
      return groupItems.some(item => checkPromotionForProduct(item._id));
    }

    // ฟังก์ชันสร้าง Confetti Effect
    function createConfettiEffect(element) {
      const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
      const confettiCount = 30;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.transition = 'all 1s ease-out';

        element.appendChild(confetti);

        setTimeout(() => {
          confetti.style.top = '100%';
          confetti.style.opacity = '0';
          confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
        }, 10);

        setTimeout(() => confetti.remove(), 1000);
      }
    }

    // เพิ่มตัวแปรป้องกัน infinite loop สำหรับ promotion check
    let isCheckingPromotions = false;
    let promotionCheckTimeout = null;

    async function checkAvailablePromotions() {
      if (!cartItems.length) {
        appliedPromotions = {};
        return;
      }

      // ป้องกัน infinite loop
      if (isCheckingPromotions) {
        console.log('🔄 Promotion check already in progress, skipping...');
        return;
      }

      // Debounce การเรียก API (รอ 500ms ก่อนเรียกจริง)
      if (promotionCheckTimeout) {
        clearTimeout(promotionCheckTimeout);
      }

      promotionCheckTimeout = setTimeout(async () => {
        try {
          isCheckingPromotions = true;
          console.log('🎯 Checking promotions for cart items...');
    
          const token = localStorage.getItem('authToken');
          if (!token) return;
    
          const ids = [...new Set(cartItems.map(i => i._id))];
          console.log('📦 Checking promotions for products:', ids);
    
          const res = await fetch('/api/promotion/check-available', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
          });
    
          if (!res.ok) {
            if (res.status === 429) {
              console.warn('⚠️ Rate limited on promotion check, will retry later');
              return; // ไม่ throw error เพื่อไม่ให้หยุดการทำงาน
            }
            throw new Error(`HTTP ${res.status}`);
          }
    
          const js = await res.json();
          if (js.status === 'success') {
            console.log('✅ Promotion check successful');
            displayAvailablePromotions(js.data);
          }
        } catch (err) {
          console.error('❌ Error checking promotions:', err);
          appliedPromotions = {}; // ล้างโปรโมชั่นเมื่อเกิดข้อผิดพลาด
        } finally {
          isCheckingPromotions = false;
        }
      }, 1000); // เพิ่มเป็น 1 วินาที เพื่อลด load บน server
    }

    function displayAvailablePromotions(data) {
      appliedPromotions = {};
      cartItems.forEach(item => {
        const promos = data[item._id] || [];
        if (promos.length) {
          const best = promos.reduce((b, p) => {
            const val = p.type === 'percentage'
              ? item.pricePayOff * (p.discount / 100)
              : p.type === 'fixed'
                ? p.discount
                : 0;
            const bval = b.type === 'percentage'
              ? item.pricePayOff * (b.discount / 100)
              : b.type === 'fixed'
                ? b.discount
                : 0;
            return val > bval ? p : b;
          });
          appliedPromotions[item._id] = best;
        }
      });
      // ลบการเรียก renderCart() เพื่อป้องกัน infinite loop
      console.log('🎁 Applied promotions updated:', appliedPromotions);
    }

    function calculatePromotionDiscount() {
      let totalDiscount = 0, details = [];
      Object.entries(appliedPromotions).forEach(([pid, promo]) => {
        const item = cartItems.find(i => i._id === pid);
        if (!item) return;
        const disc = promo.type === 'percentage'
          ? item.pricePayOff * (promo.discount / 100)
          : promo.type === 'fixed'
            ? promo.discount
            : 0;
        totalDiscount += disc;
        details.push({ name: promo.name, discount: disc, productName: item.name });
      });
      return { totalDiscount, details };
    }

    async function recordPromotionUsage(promotionId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/use', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ promotionId })
        });
        const js = await res.json();
        if (js.status !== 'success') {
          console.error('Failed to record promotion usage:', js.message);
        }
      } catch (err) {
        console.error('Error recording promotion usage:', err);
      }
    }





    // =========================== I) CAMERA & SIGNATURE ===========================
    function setupIDCamera() {
      const btnStart = document.getElementById('btnStartIdCamera');
      const btnCapture = document.getElementById('btnCaptureId');
      const btnRetake = document.getElementById('btnRetakeId');
      const container = document.getElementById('idCaptureContainer');
      const canvas = document.getElementById('idCanvas');
      // const inputData = document.getElementById("idImageData"); // Likely removed
      const inputUrl = document.getElementById('idCardImageUrl'); // Keep if still used for storing URL
      let idStream = null;

      // If essential elements are missing, don't proceed with setup
      if (!btnStart || !btnCapture || !btnRetake || !container || !canvas || !inputUrl) {
        console.warn('ID Camera elements not found, skipping setup.');
        return;
      }

      // เปิดกล้อง
      btnStart.addEventListener('click', async () => {
        try {
          idStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          const video = container.querySelector('video'); // Assuming video element is dynamically added or exists
          if (video) {
            video.srcObject = idStream;
            await video.play();
            btnCapture.disabled = false;
          } else {
            console.error('Video element for ID camera not found in container.');
            showToast('ไม่สามารถเตรียมกล้องบัตรประชาชน', 'error');
          }
        } catch (err) {
          console.error('ไม่สามารถเข้าถึงกล้อง:', err);
          showToast('ไม่สามารถเข้าถึงกล้องบัตรประชาชน', 'error');
        }
      });

      // ถ่ายรูปและอัปโหลด
      btnCapture.addEventListener('click', async () => {
        const video = container.querySelector('video');
        if (!video) {
          console.error('Video element for ID capture not found.');
          return;
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        // if (inputData) inputData.value = dataURL; // Keep if inputData exists

        // preview
        // Ensure container is robust enough or this part is conditional
        if (container.innerHTML.includes('<video')) { // Basic check
          container.innerHTML = `<img src="${dataURL}" class="w-full h-full object-contain rounded" alt="ID Preview"/>`;
        }
        if (idStream) idStream.getTracks().forEach(t => t.stop());
        btnStart.classList.add('hidden');
        btnCapture.classList.add('hidden');
        btnRetake.classList.remove('hidden');

        try {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const url = await uploadFile(
            blob,
            '/api/upload/id-card',
            'file',
            'id-card.jpg'
          );
          if (inputUrl) inputUrl.value = url;
          showToast('อัปโหลดบัตรประชาชนเรียบร้อย', 'success');
        } catch (err) {
          console.error('Upload ID card failed:', err);
          showToast('อัปโหลดบัตรประชาชนไม่สำเร็จ: ' + err.message, 'error');
        }
      });

      // ถ่ายใหม่
      btnRetake.addEventListener('click', () => {
        // This part heavily depends on the specific HTML structure for the video container
        // It's safer to make it conditional or ensure the elements exist
        const videoContainerHTML = `
          <video id="idVideo" autoplay playsinline muted
                 class="absolute inset-0 w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <img src="/uploads/บัตร.png"
                 class="w-full h-full object-contain pointer-events-none"
                 alt="ID template overlay"/>
          </div>`;
        // Check if container can be reset this way
        if (document.getElementById('idVideo')) { // Example check
          container.innerHTML = videoContainerHTML;
        } else {
          console.warn('Cannot reset ID camera view, video container structure might have changed.');
        }
        btnStart.classList.remove('hidden');
        btnCapture.classList.remove('hidden');
        btnRetake.classList.add('hidden');
      });
    }
    function setupSelfieCamera() {
      const btnStart = document.getElementById('btnStartSelfie');
      const btnCapture = document.getElementById('btnCaptureSelfie');
      const video = document.getElementById('selfieVideo');
      const canvas = document.getElementById('selfieCanvas');
      // const inputData = document.getElementById("selfieDataURL"); // Likely removed
      const inputUrl = document.getElementById('selfieUrl'); // Keep if used
      let selfieStream = null;

      if (!btnStart || !btnCapture || !video || !canvas || !inputUrl) {
        console.warn('Selfie camera elements not found, skipping setup.');
        return;
      }

      btnStart.addEventListener('click', async () => {
        try {
          selfieStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: 'environment' } }
          });
          video.srcObject = selfieStream;
          await video.play();
          video.classList.remove('hidden');
          btnCapture.disabled = false;
        } catch (err) {
          console.warn('ไม่สามารถเข้าถึงกล้องหลัง, ลองกล้องหน้า:', err);
          try {
            selfieStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = selfieStream;
            await video.play();
            video.classList.remove('hidden');
            btnCapture.disabled = false;
            showToast('สลับไปกล้องหน้า (fallback)', 'warning');
          } catch (err2) {
            console.error('ไม่สามารถเข้าถึงกล้องเซลฟี่:', err2);
            showToast('ไม่สามารถเข้าถึงกล้องเซลฟี่', 'error');
            btnStart.disabled = true;
          }
        }
      });

      btnCapture.addEventListener('click', async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
        // if(inputData) inputData.value = dataUrl;
        canvas.classList.remove('hidden');

        try {
          let blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
          // if (!blob && dataUrl) { // Fallback if toBlob returns null
          //   const res = await fetch(dataUrl);
          //   blob = await res.blob();
          // }
          if (blob) {
            const url = await uploadFile(
              blob,
              '/api/upload/selfie',
              'file',
              'selfie.jpg'
            );
            if (inputUrl) inputUrl.value = url;
            showToast('อัปโหลดเซลฟี่เรียบร้อย', 'success');
          } else {
            showToast('ไม่สามารถสร้าง blob จาก selfie canvas', 'error');
          }
        } catch (err) {
          console.error('Upload selfie failed:', err);
          showToast('อัปโหลดเซลฟี่ไม่สำเร็จ: ' + err.message, 'error');
        } finally {
          if (selfieStream) {
            selfieStream.getTracks().forEach(track => track.stop());
            selfieStream = null;
          }
          btnCapture.disabled = true;
          btnStart.disabled = false;
        }
      });
    }

    function setupSignaturePad() {
      const canvasEl = document.getElementById('signaturePad');
      if (canvasEl) {
        const ctx = canvasEl.getContext('2d');
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data = signaturePad ? signaturePad.toData() : []; // Check if signaturePad exists
          canvasEl.width = canvasEl.offsetWidth * ratio;
          canvasEl.height = canvasEl.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          if (signaturePad) {
            signaturePad.clear();
            signaturePad.fromData(data);
          }
        }
        window.addEventListener('resize', resizeCanvas);
        signaturePad = new SignaturePad(canvasEl, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeCanvas();
        const btnClearSignature = document.getElementById('btnClearSignature');
        if (btnClearSignature) btnClearSignature.addEventListener('click', () => signaturePad.clear());
      } else {
        console.warn('Customer signature pad canvas not found.');
      }

      const empCanvas = document.getElementById('employeeSignaturePad');
      if (empCanvas) {
        const empCtx = empCanvas.getContext('2d');
        function resizeEmpCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data2 = empPad ? empPad.toData() : []; // Check if empPad exists
          empCanvas.width = empCanvas.offsetWidth * ratio;
          empCanvas.height = empCanvas.offsetHeight * ratio;
          empCtx.scale(ratio, ratio);
          if (empPad) {
            empPad.clear();
            empPad.fromData(data2);
          }
        }
        window.addEventListener('resize', resizeEmpCanvas);
        empPad = new SignaturePad(empCanvas, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeEmpCanvas();
        const btnClearEmpSignature = document.getElementById('btnClearEmpSignature');
        if (btnClearEmpSignature) btnClearEmpSignature.addEventListener('click', () => empPad.clear());
      } else {
        console.warn('Employee signature pad canvas not found.');
      }
    }



    // =========================== J) MISC ACTIONS (Dark, ToggleMenu, Logout) ===========================
    function toggleDarkMode() {
      const htmlEl = document.documentElement;
      const label = document.getElementById('darkModeLabel');
      if (htmlEl.classList.contains('dark')) {
        htmlEl.classList.remove('dark');
        if (label) label.textContent = 'Dark Mode';
      } else {
        htmlEl.classList.add('dark');
        if (label) label.textContent = 'Light Mode';
      }
    }
    function logout() {
      // ลบ token และข้อมูล session ที่จำเป็น
      localStorage.removeItem('authToken');
      // สามารถลบข้อมูลอื่นๆ เพิ่มเติมได้ หากมีฆ
      // เปลี่ยนไปที่หน้า login
      window.location.href = '/login';
    }
    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      sb.classList.toggle('-translate-x-full');
      mc.classList.toggle('ml-64');
      mc.classList.toggle('ml-0');
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }
    function togglePlan2Detail() {
      const plan2Detail = document.querySelector('.plan2-detail');
      const plan2Radio = document.getElementById('plan2');
      if (plan2Detail && plan2Radio) {
        plan2Detail.style.display = plan2Radio.checked ? 'block' : 'none';
      }
    }



    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // โหลดข้อมูลพื้นฐาน
        await loadEmployeeProfile();
        await loadActivePromotions();
    
        // Setup dark mode
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
        }

        // Event listeners - ตรวจสอบ element ก่อนผูก event
        const btnToggleMenu = document.getElementById('btnToggleMenu');
        if (btnToggleMenu) {
          btnToggleMenu.addEventListener('click', toggleMenu);
        }
    
        const btnToggleDark = document.getElementById('btnToggleDark');
        if (btnToggleDark) {
          btnToggleDark.addEventListener('click', toggleDarkMode);
        }
    
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.addEventListener('click', logout);
        }

        // โหลดข้อมูลหลัก
        await loadBranchInstallments();
        await loadBranchInfo();
        loadLevel1(); // จะแสดงทั้งแบรนด์ปกติและ Special Boxset

        // Step navigation - ตรวจสอบ element ก่อนผูก event
        const btnStep1ToStep2 = document.getElementById('btnStep1ToStep2');
        if (btnStep1ToStep2) {
          btnStep1ToStep2.addEventListener('click', () => goToStep(2));
        }
    
        const btnStep2ToStep1 = document.getElementById('btnStep2ToStep1');
        if (btnStep2ToStep1) {
          btnStep2ToStep1.addEventListener('click', () => goToStep(1));
        }

        // Step clicking
        document.querySelectorAll('.step').forEach(el => {
          el.style.cursor = 'pointer';
          el.addEventListener('click', () => {
            const target = Number(el.getAttribute('data-step'));
            const current = Number(document.querySelector('.step.active').getAttribute('data-step'));
            if (target <= current) {
              goToStep(target);
            }
          });
        });


      // ฟังก์ชันตรวจสอบสต็อกหลังการขาย - ไม่ใช้งานสำหรับระบบผ่อนหมดรับของ
      async function checkStockAfterSale() {
        console.log('ระบบผ่อนหมดรับของ - ไม่ต้องตรวจสอบสต็อก');
        // ไม่ต้องตัดสต็อกเพราะลูกค้ายังไม่ได้รับของ
      }



      // แทรกลงไปในฟังก์ชัน goToStep หลังจากอัปเดตคลาส active/completed เสร็จ
      function goToStep(stepNumber) {
        // … existing code …
        // Update step-content
        document.querySelectorAll('.step-content').forEach(st => st.classList.remove('active'));
        const target = document.getElementById('step' + stepNumber);
        if (target) target.classList.add('active');
        // Update visual stepper
        document.querySelectorAll('.step').forEach(elem => {
          const s = Number(elem.getAttribute('data-step'));
          elem.classList.remove('active', 'completed');
          if (s < stepNumber) elem.classList.add('completed');
          else if (s === stepNumber) elem.classList.add('active');
        });

        // <<< เพิ่มตรงนี้ >>>
        if (stepNumber === 3) {
          // รอ 5 วินาที แล้วเลื่อนไป STEP1 อัตโนมัติ
          setTimeout(() => {
            cartItems = []; // Clear cart
            hiddenProductIds.clear();
            renderCart(); // Update cart display
            if (typeof resetSearch === 'function') resetSearch(); // Reset search if function exists
            goToStep(1);
          }, 5000);
        }
      }


      // Removed selectedManualOption setup

      // ปิด Order Success Modal
      // Removed event listener for btnCloseSuccessModal
    
      // เพิ่มตัวแปรป้องกัน rate limiting และการกดซ้ำ
      let isProcessing = false;
      let lastRequestTime = 0;
      const REQUEST_DELAY = 5000; // เพิ่มเป็น 5 วินาที
    
      // ตัวแปรสำหรับ debounce
      let submitTimeout = null;

        // Step2 -> สร้างสัญญาผ่อนหมดรับของ
        const btnStep2OpenModal = document.getElementById('btnStep2OpenModal');
        if (btnStep2OpenModal) {
          btnStep2OpenModal.addEventListener('click', async () => {
          try {
            // ป้องกันการกดซ้ำ
            if (isProcessing) {
              showToast('กรุณารอการประมวลผลให้เสร็จก่อน', 'warning');
              return;
            }

            // ตรวจสอบ rate limit
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_DELAY) {
              const waitTime = Math.ceil((REQUEST_DELAY - (now - lastRequestTime)) / 1000);
              showToast(`กรุณารอ ${waitTime} วินาที ก่อนส่งคำขออีกครั้ง`, 'warning');
              return;
            }

            // ตรวจสอบ token validity ก่อนทำอะไร
            const isTokenValid = await validateToken();
            if (!isTokenValid) {
              console.error('❌ Token validation failed, stopping process');
              return;
            }

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
              showToast('❌ ไม่พบ Token การยืนยันตัวตน กรุณาเข้าสู่ระบบใหม่', 'error');
              setTimeout(() => {
                window.location.href = '/login';
              }, 2000);
              return;
            }

            // ตรวจสอบข้อมูลเบื้องต้น
            if (cartItems.length === 0) {
              showToast('กรุณาเลือกสินค้าก่อน', 'warning');
              return;
            }

            // ล็อกการประมวลผล
            isProcessing = true;
            lastRequestTime = now;
    
            // แสดงสถานะการประมวลผล
            const btnModal = document.getElementById('btnStep2OpenModal');
            const originalText = btnModal.innerHTML;
            btnModal.disabled = true;
            btnModal.innerHTML = '<i class="bi bi-hourglass mr-2"></i> กำลังประมวลผล...';

            // อ่านข้อมูลลูกค้า
            const prefix = document.getElementById('customerPrefix').value || '';
            const firstName = document.getElementById('customerFirstName').value || '';
            const lastName = document.getElementById('customerLastName').value || '';
            const idCard = document.getElementById('customerIdCard').value || '';
            const phone = document.getElementById('customerPhone').value || '';
            const email = document.getElementById('customerEmail').value || '';

            // ตรวจสอบข้อมูลที่จำเป็น
            if (!firstName || !lastName || !idCard || !phone) {
              showToast('กรุณากรอกข้อมูลลูกค้าให้ครบถ้วน', 'warning');
              return;
            }

            // ที่อยู่
            const address = {
              houseNo: document.getElementById('houseNo').value || '',
              moo: document.getElementById('moo').value || '',
              subDistrict: document.getElementById('subDistrict').value || '',
              district: document.getElementById('district').value || '',
              province: document.getElementById('province').value || '',
              zipcode: document.getElementById('zipcode').value || ''
            };

            // คำนวณยอดรวม
            let subTotal = 0;
            const items = cartItems.map(item => {
              const payOffPrice = item.pricePayOff || ((item.price || 0) + 2590);
              const qty = 1;
              subTotal += payOffPrice * qty;
    
              return {
                productId: item._id,
                product_id: item._id,
                name: item.name,
                qty: qty,
                price: payOffPrice,
                model: item.model || '',
                imei: item.imei || '',
                pricePayOff: payOffPrice,
                // สำหรับ plan3 (ผ่อนหมดรับของ)
                downAmount: payOffPrice,
                downInstallmentCount: 1,
                downInstallment: payOffPrice,
                creditThreshold: 0,
                payUseInstallmentCount: 0,
                payUseInstallment: 0,
                itemDiscount: 0
              };
            });

            // คำนวณส่วนลดจากโปรโมชั่น
            const { totalDiscount, details } = calculatePromotionDiscount();
            const totalAmount = subTotal - totalDiscount;

            // สร้าง payload สำหรับ API /api/installment
            const payload = {
              // ข้อมูลสินค้า
              items: items,
    
              // ข้อมูลลูกค้า
              customer: {
                customerType: 'individual',
                individual: {
                  prefix: prefix,
                  firstName: firstName,
                  lastName: lastName,
                  phone: phone,
                  email: email,
                  taxId: idCard,
                  address: address,
                  socialContact: {
                    facebook: '',
                    line: '',
                    mapLocation: ''
                  }
                },
                name: `${prefix}${firstName} ${lastName}`.trim(),
                fullAddress: typeof address === 'string' ? address : `${address.houseNo} หมู่ ${address.moo} ต.${address.subDistrict} อ.${address.district} จ.${address.province} ${address.zipcode}`.trim()
              },
    
              // ข้อมูลพยาน (ถ้ามี)
              witness: {
                name: '',
                id_card: '',
                phone: '',
                relation: ''
              },
    
              // เอกสารแนบ (ถ้ามี)
              attachments: {
                id_card_image: '',
                income_slip: '',
                selfie_image: '',
                customer_signature: '',
                salesperson_signature: '',
                authorized_signature: ''
              },
    
              // ข้อมูลการผ่อน
              plan_type: 'plan3', // ผ่อนหมดรับของ
              down_payment: totalAmount, // จ่ายเต็มจำนวน
              installment_count: 1,
              installment_amount: 0,
              credit_amount: 0,
              payoff_amount: totalAmount,
              doc_fee: 0,
    
              // ข้อมูลใบเสนอราคา
              quotation_no: '',
              credit_term: 'ผ่อนหมดรับของ',
              sub_total: subTotal,
              total_amount: totalAmount,
              total_text: numberToThaiText(Math.floor(totalAmount)) + 'บาทถ้วน',
              quotation_terms: 'ผ่อนหมดรับของ',
    
              // ข้อมูลสาขา
              branch_code: BRANCH_CODE,
              salesperson_id: window.employeeId || '',
    
              // โปรโมชั่น
              appliedPromotions: Object.values(appliedPromotions).map(p => ({
                id: p._id,
                name: p.name,
                type: p.type,
                discount: p.discount
              })),
              promotionDiscount: totalDiscount,
    
              // ระบุว่าไม่ต้องตัดสต็อก เพราะเป็นระบบผ่อนหมดรับของ
              skipStockDeduction: true,
              payoffContract: true // สัญญาผ่อนหมดรับของ - ลูกค้าจะได้รับสินค้าเมื่อผ่อนหมดแล้ว
            };

            console.log('🚀 ส่งข้อมูลสัญญาผ่อนหมดรับของ - ไม่ตัดสต็อก:', payload);
            console.log('✅ skipStockDeduction = true - สินค้าจะถูกตัดสต็อกเมื่อลูกค้ามารับของเท่านั้น');

            // เรียก API สร้างสัญญาผ่อน (ไม่ตัดสต็อก)
            const res = await fetch('/api/installment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken
              },
              body: JSON.stringify(payload)
            });

            // ตรวจสอบ response status ก่อน parse JSON
            if (!res.ok) {
              const errorText = await res.text();
              console.error('Server response:', res.status, errorText);
    
              if (res.status === 401) {
                console.error('❌ 401 Unauthorized in installment API');
                showToast('❌ Token หมดอายุ กำลังเปลี่ยนไปหน้าเข้าสู่ระบบ', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
                return;
              } else if (res.status === 429) {
                throw new Error('ระบบมีการใช้งานหนาก กรุณาลองใหม่อีกครั้งในอีกสักครู่');
              } else if (res.status >= 500) {
                throw new Error('เกิดข้อผิดพลาดในระบบเซิร์ฟเวอร์ กรุณาติดต่อผู้ดูแลระบบ');
              } else {
                throw new Error(`เกิดข้อผิดพลาด (${res.status}): ${errorText}`);
              }
            }

            // พยายาม parse JSON
            let result;
            try {
              result = await res.json();
            } catch (parseError) {
              console.error('JSON parse error:', parseError);
              throw new Error('ได้รับข้อมูลจากเซิร์ฟเวอร์ในรูปแบบที่ไม่ถูกต้อง');
            }
    
            if (!result.success) {
              throw new Error(result.error || 'เกิดข้อผิดพลาดในการสร้างสัญญา');
            }

            // เก็บข้อมูลสำหรับใช้ต่อ
            window.currentContractNo = result.data.contractNo;
            window.currentOrderId = result.data.orderId;
    
            showToast('✅ สร้างสัญญาผ่อนหมดรับของสำเร็จ', 'success');
            console.log('📄 เลขที่สัญญา:', result.data.contractNo, '- รอการอนุมัติจากผู้จัดการ');
    
            // ส่งคำขออนุมัติไปยังระบบ
            try {
              // ✅ ตรวจสอบ token ก่อนส่ง
              const token = localStorage.getItem('authToken');
              if (!token) {
                showToast('❌ ไม่พบ token การยืนยันตัวตน กรุณาเข้าสู่ระบบใหม่', 'error');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 2000);
                return;
              }

              // ตรวจสอบความถูกต้องของ token ก่อนส่งคำขอ
              const tokenCheckRes = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
              });
    
              if (!tokenCheckRes.ok) {
                console.error('❌ Token validation failed:', tokenCheckRes.status);
                showToast('❌ Token หมดอายุ กำลังเปลี่ยนไปหน้าเข้าสู่ระบบ', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
                return;
              }

              const approvalPayload = {
                contractNo: result.data.contractNo,
                orderId: result.data.orderId,
                customerId: result.data.customerId,
                customerName: `${prefix}${firstName} ${lastName}`.trim(),
                items: items.map(item => ({
                  ...item,
                  productType: item.productType || 'product',
                  boxsetType: item.boxsetType || null
                })),
                totalAmount: totalAmount,
                branchCode: BRANCH_CODE
              };

              // ✅ ตรวจสอบข้อมูลที่จำเป็น
              if (!approvalPayload.contractNo || !approvalPayload.orderId || !approvalPayload.customerId) {
                showToast('❌ ข้อมูลสัญญาไม่ครบถ้วน ไม่สามารถส่งคำขออนุมัติได้', 'error');
                return;
              }

              if (!approvalPayload.customerName.trim()) {
                showToast('❌ ไม่พบชื่อลูกค้า ไม่สามารถส่งคำขออนุมัติได้', 'error');
                return;
              }

              if (!approvalPayload.items || approvalPayload.items.length === 0) {
                showToast('❌ ไม่มีรายการสินค้า ไม่สามารถส่งคำขออนุมัติได้', 'error');
                return;
              }

              console.log('📤 ส่งคำขออนุมัติ:', approvalPayload);

              const approvalRes = await fetch('/api/payoff-approval/request', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(approvalPayload)
              });

              console.log('🔍 Response status:', approvalRes.status);

              // ✅ ตรวจสอบ response status ก่อน parse JSON
              if (!approvalRes.ok) {
                const errorText = await approvalRes.text();
                console.error('❌ Approval request failed:', approvalRes.status, errorText);
    
                if (approvalRes.status === 401) {
                  console.error('❌ 401 Unauthorized - Token หมดอายุหรือไม่ถูกต้อง');
                  showToast('❌ Token หมดอายุ กำลังเปลี่ยนไปหน้าเข้าสู่ระบบ', 'error');
                  localStorage.removeItem('authToken');
                  setTimeout(() => {
                    window.location.href = '/login';
                  }, 1500);
                  return;
                } else if (approvalRes.status === 400) {
                  let errorMsg = 'ข้อมูลไม่ถูกต้อง';
                  try {
                    const errorJson = JSON.parse(errorText);
                    errorMsg = errorJson.error || errorMsg;
                  } catch (e) {
                    // ignore parse error
                  }
                  showToast(`❌ ${errorMsg}`, 'error');
                  return;
                } else {
                  showToast(`❌ เกิดข้อผิดพลาดในการส่งคำขออนุมัติ (${approvalRes.status})`, 'error');
                  return;
                }
              }

              const approvalResult = await approvalRes.json();
              console.log('✅ Approval result:', approvalResult);

              if (approvalResult.success) {
                showToast('✅ ส่งคำขออนุมัติเรียบร้อย กรุณาติดต่อผู้จัดการเพื่ออนุมัติ', 'success');
    
                // แจ้งให้ไปตรวจสอบที่ระบบสินเชื่อ
                setTimeout(() => {
                  if (confirm('ต้องการไปยังระบบสินเชื่อเพื่อตรวจสอบสถานะการอนุมัติหรือไม่?')) {
                    window.open(`/views/loan/repayment.html?contractNo=${result.data.contractNo}`, '_blank');
                  }
                }, 2000);
              } else {
                showToast('❌ เกิดข้อผิดพลาดในการส่งคำขออนุมัติ: ' + (approvalResult.error || 'ไม่ทราบสาเหตุ'), 'error');
              }
            } catch (approvalError) {
              console.error('❌ Approval request error:', approvalError);
    
              // ตรวจสอบว่าเป็นปัญหา network หรือ token
              if (approvalError.message.includes('Failed to fetch') || approvalError.message.includes('NetworkError')) {
                showToast('❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบอินเตอร์เน็ต', 'error');
              } else if (approvalError.message.includes('401') || approvalError.message.includes('Unauthorized')) {
                showToast('❌ Token หมดอายุ กำลังเปลี่ยนไปหน้าเข้าสู่ระบบ', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
              } else {
                showToast('❌ เกิดข้อผิดพลาดในการส่งคำขออนุมัติ: ' + approvalError.message, 'error');
              }
            }
    
            // ส่ง socket event เพื่อแจ้งระบบอื่น
            if (typeof socket !== 'undefined' && socket) {
              socket.emit('payoff-contract-created', {
                contractNo: result.data.contractNo,
                orderId: result.data.orderId,
                customerId: result.data.customerId,
                customerName: `${prefix}${firstName} ${lastName}`.trim(),
                items: items,
                totalAmount: totalAmount,
                branchCode: BRANCH_CODE,
                timestamp: new Date()
              });
            }
    
            // ไป step 3
            goToStep(3);
    
          } catch (err) {
            console.error('Error in main process:', err);
    
            // จัดการ error ตามประเภท
            if (err.message.includes('401') || err.message.includes('Unauthorized') || err.message.includes('Invalid token')) {
              showToast('❌ Token หมดอายุ กำลังเปลี่ยนไปหน้าเข้าสู่ระบบ', 'error');
              localStorage.removeItem('authToken');
              setTimeout(() => {
                window.location.href = '/login';
              }, 1500);
            } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
              showToast('❌ ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบอินเตอร์เน็ต', 'error');
            } else {
              showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
            }
          } finally {
            // ปลดล็อกการประมวลผล
            isProcessing = false;
    
            // คืนสถานะปุ่ม
            const btnModal = document.getElementById('btnStep2OpenModal');
            if (btnModal) {
              btnModal.disabled = false;
              btnModal.innerHTML = '<i class="bi bi-save mr-2"></i> บันทึก';
            }
          }
        });
        }



      // เมื่อกด "ยืนยัน" ใน modal ค่อยไป STEP3
      // Removed event listener for confirmPrintPrompt

      // สรุปในท้าย renderStep4Summary:
      // Removed totalDocFee, subTotal, grandTotal calculation as it's not used in this flow

      // ปุ่มพิมพ์ PDF
      // Removed event listener for btnPrintPdf (related to quotation)

      // ปุ่มยืนยัน (กลับหน้าแรก)
      // Removed event listener for btnConfirmFinish


      // Removed fetchNextQuotationNumber() function





      // ผูกปุ่มดาวน์โหลดหลัง DOM โหลดเสร็จ
      // Removed event listener for btnDownloadPdf (related to quotation)


      // ผูกปุ่มกับฟังก์ชันใหม่
      // Removed event listener for btnDownloadPdf (related to quotation)





        // Search events - ตรวจสอบ element ก่อนผูก event
        const btnProductSearch = document.getElementById('btnProductSearch');
        if (btnProductSearch) {
          btnProductSearch.addEventListener('click', searchItems);
        }
    
        const btnProductReset = document.getElementById('btnProductReset');
        if (btnProductReset) {
          btnProductReset.addEventListener('click', resetSearch);
        }

        // Back to Level1 button
        const btnBackToLevel1 = document.getElementById('btnBackToLevel1');
        if (btnBackToLevel1) {
          btnBackToLevel1.addEventListener('click', () => {
            document.getElementById('level1Container').classList.add('hidden');
            document.getElementById('level2Container').classList.add('hidden');
            document.getElementById('level3Container').classList.remove('hidden');
            // สำหรับระบบผ่อนหมดรับของแสดง Special Boxset โดยตรง
            const specialBoxsets = productImages.filter(item =>
              item.productType === 'boxset' && item.boxsetType === 'special'
            );
            renderLevel3(specialBoxsets);
          });
        }

        // Camera & Signature setup
        setupIDCamera();
        setupSelfieCamera();
        setupSignaturePad();

        // Optional: ตรวจสอบ special boxsets (สำหรับ debug)
        if (window.location.search.includes('debug=true')) {
          console.log('=== Checking Special Boxsets ===');
          const specialBoxsets = await checkSpecialBoxsets();
          console.table(specialBoxsets);
        }

      } catch (err) {
        console.error('Error in DOMContentLoaded:', err);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
      }
    });
  </script>

  <!-- Display Fixes Script -->
  <script>
    // 1. แก้ไข CSS สำหรับ step-content
    const fixStepContentCSS = () => {
      // ลบ CSS rule ที่ทำให้ step4 มี background แปลกๆ
      const style = document.createElement('style');
      style.textContent = `
        /* Reset step content styles */
        .step-content {
          display: none;
          background-color: transparent !important;
        }
        
        .step-content.active {
          display: block !important;
          min-height: auto;
        }
        
        /* ปรับ main content ให้ responsive */
        #mainContent {
          transition: margin-left 0.3s ease-in-out;
        }
        
        /* เมื่อ sidebar ถูกซ่อน */
        #mainContent.sidebar-collapsed {
          margin-left: 0 !important;
        }
        
        /* ลบพื้นที่สีเทาที่ไม่ต้องการ */
        main {
          background-color: transparent !important;
          min-height: calc(100vh - 80px); /* ลบความสูงของ header */
        }
        
        /* ปรับ card container */
        .card {
          background-color: #ffffff;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark .card {
          background-color: #2a2a2a;
          border-color: #555;
        }
      `;
      document.head.appendChild(style);
    };

    // 2. แก้ไขฟังก์ชัน toggleMenu ให้จัดการ margin ของ mainContent
    function fixToggleMenu() {
      const toggleMenu = () => {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        sidebar.classList.toggle('-translate-x-full');
        mainContent.classList.toggle('ml-64');
        mainContent.classList.toggle('ml-0');
        icon.classList.toggle('bi-chevron-left');
        icon.classList.toggle('bi-chevron-right');
      };

      // แทนที่ event listener เดิม
      const btnToggle = document.getElementById('btnToggleMenu');
      if (btnToggle) {
        btnToggle.removeEventListener('click', window.toggleMenu);
        btnToggle.addEventListener('click', toggleMenu);
        window.toggleMenu = toggleMenu;
      }
    }

    // 3. แก้ไขการ restore sidebar state
    function fixSidebarRestore() {
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      // ตรวจสอบว่า element มีอยู่จริงก่อนใช้งาน
      if (!sidebar || !mainContent || !icon) {
        console.info('ยังไม่พบ sidebar elements, จะ restore ภายหลัง');
        return;
      }

      if (sidebarCollapsed) {
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.add('sidebar-collapsed');
        mainContent.style.marginLeft = '0';
        icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
      } else {
        sidebar.classList.remove('-translate-x-full');
        mainContent.classList.remove('sidebar-collapsed');
        mainContent.style.marginLeft = '14rem';
        icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
      }
    }

    // 4. ฟังก์ชันตรวจสอบและแก้ไขการแสดงผลของ containers
    function fixContainerDisplay() {
      // ตรวจสอบว่า step content ที่ active แสดงผลถูกต้อง
      const activeStep = document.querySelector('.step-content.active');
      if (!activeStep) {
        // ถ้าไม่มี active step ให้เซ็ตเป็น step 1
        const step1 = document.getElementById('step1');
        if (step1) {
          step1.classList.add('active');
        }
      }

      // ตรวจสอบ level containers
      const level1Container = document.getElementById('level1Container');
      const level2Container = document.getElementById('level2Container');
      const level3Container = document.getElementById('level3Container');
      const imeiResultContainer = document.getElementById('imeiResultContainer');

      // ซ่อน containers ที่ไม่ควรแสดง
      if (level2Container && !level2Container.querySelector('#level2Grid').children.length) {
        level2Container.classList.add('hidden');
      }
      if (level3Container && !level3Container.querySelector('#level3Grid').children.length) {
        level3Container.classList.add('hidden');
      }
      if (imeiResultContainer && !imeiResultContainer.querySelector('#imeiResultGrid').children.length) {
        imeiResultContainer.classList.add('hidden');
      }
    }

    // 5. ฟังก์ชันหลักสำหรับแก้ไขทั้งหมด
    function applyFixes() {
      // 1. แก้ไข CSS
      fixStepContentCSS();

      // 2. แก้ไข toggle menu
      fixToggleMenu();

      // 3. Restore sidebar state อย่างถูกต้อง
      fixSidebarRestore();

      // 4. แก้ไขการแสดงผล containers
      fixContainerDisplay();

      // 5. ลบ background สีเทาที่อาจติดมาจาก CSS เก่า
      const main = document.querySelector('main');
      if (main) {
        main.style.backgroundColor = 'transparent';
        main.style.minHeight = 'calc(100vh - 80px)';
      }

      console.log('✅ Applied all display fixes');
    }

    // เรียกใช้งานเมื่อ DOM โหลดเสร็จ - รอให้ sidebar โหลดเสร็จก่อน
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // รอให้ sidebar มีโอกาสโหลดก่อน
        setTimeout(applyFixes, 500);
      });
    } else {
      // รอให้ sidebar มีโอกาสโหลดก่อน
      setTimeout(applyFixes, 500);
    }

    // Export สำหรับใช้งาน
    window.applyInstallmentFixes = applyFixes;
  </script>

  <!-- Customer Search & Card Reader Script -->
  <script>
    // ตัวแปรสำหรับการค้นหาลูกค้า
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 วินาที

    // ฟังก์ชันค้นหาลูกค้าเก่า
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');
    
      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('กรุณากรอกเลขบัตรประชาชน', 'warning');
        } else {
          alert('กรุณากรอกเลขบัตรประชาชน');
        }
        return;
      }

      // ตรวจสอบรูปแบบเลขบัตรประชาชน (13 หลัก)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก', 'warning');
        } else {
          alert('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาอยู่ กรุณารอสักครู่', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`กรุณารอ ${remaining} วินาที ก่อนค้นหาใหม่`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;

      try {
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาลูกค้า...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ตรวจสอบ status code ก่อน parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('🚫 คำขอเกินขีดจำกัด กรุณารอ 30 วินาที', 'error');
          }
          // เพิ่มเวลา cooldown เมื่อเจอ 429
          lastSearchTime = Date.now() + 27000; // บล็อกเพิ่มอีก 27 วินาที (รวม 30 วินาที)
    
          resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <p class="text-sm font-medium">คำขอเกินขีดจำกัด</p>
              <p class="text-xs text-gray-400 mt-1">กรุณารอ 30 วินาที ก่อนค้นหาใหม่</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // เจอลูกค้า - แสดงผลลัพธ์
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('พบข้อมูลลูกค้า', 'success');
          }
        } else {
          // ไม่เจอลูกค้า
          resultsList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              <i class="bi bi-person-x text-2xl mb-2 block"></i>
              <p class="text-sm">ไม่พบข้อมูลลูกค้าเก่า</p>
              <p class="text-xs text-gray-400">เลขบัตรประชาชน: ${searchValue}</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('ไม่พบข้อมูลลูกค้าเก่า', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);
    
        let errorMessage = 'เกิดข้อผิดพลาดในการค้นหา';
        if (error.message.includes('429')) {
          errorMessage = 'คำขอเกินขีดจำกัด กรุณารอสักครู่';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
        }

        resultsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
            <p class="text-sm font-medium">${errorMessage}</p>
            <p class="text-xs text-gray-400 mt-1">กรุณาลองใหม่อีกครั้ง</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
    
        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
      }
    }

    // แสดงผลลัพธ์การค้นหาลูกค้า
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');
    
      // แสดงข้อมูลลูกค้าที่พบ
      resultsList.innerHTML = `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
             onclick="selectCustomer('${customerData._id}', '${customerData.contactPhone || ''}')">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${customerData.displayName || 'ไม่ระบุชื่อ'}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <i class="bi bi-credit-card mr-1"></i>
                บัตรประชาชน: ${customerData.contactPhone || 'ไม่ระบุ'}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">
                <i class="bi bi-telephone mr-1"></i>
                โทร: ${customerData.contactPhone || 'ไม่ระบุ'}
              </p>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">
                  ${customerData.isNewCustomer ? 'ลูกค้าใหม่' : 'ลูกค้าเก่า'}
                </span>
                <span class="text-xs text-gray-500">
                  ซื้อมาแล้ว ${customerData.totalPurchases || 0} ครั้ง
                </span>
              </div>
            </div>
            <div class="text-right">
              <button class="btn btn-sm btn-primary">
                <i class="bi bi-check-circle mr-1"></i>
                เลือก
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // เลือกลูกค้าและกรอกข้อมูลลงในฟอร์ม
    async function selectCustomer(customerId, taxId) {
      try {
        if (typeof showToast === 'function') {
          showToast('กำลังโหลดข้อมูลลูกค้า...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/${customerId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success && result.data) {
          const customer = result.data;
    
          // กรอกข้อมูลลงในฟอร์ม
          fillCustomerForm(customer);
    
          // ซ่อนผลการค้นหา
          document.getElementById('customerSearchResults').classList.add('hidden');
          document.getElementById('customerSearch').value = '';
    
          if (typeof showToast === 'function') {
            showToast('โหลดข้อมูลลูกค้าเรียบร้อย', 'success');
          }
        } else {
          throw new Error(result.message || 'ไม่สามารถโหลดข้อมูลลูกค้าได้');
        }

      } catch (error) {
        console.error('Select customer error:', error);
        if (typeof showToast === 'function') {
          showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } else {
          alert('เกิดข้อผิดพลาด: ' + error.message);
        }
      }
    }

    // กรอกข้อมูลลูกค้าลงในฟอร์ม
    function fillCustomerForm(customer) {
      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;
    
        // ข้อมูลพื้นฐาน
        document.getElementById('customerPrefix').value = individual.prefix || '';
        document.getElementById('customerFirstName').value = individual.firstName || '';
        document.getElementById('customerLastName').value = individual.lastName || '';
        document.getElementById('customerIdCard').value = individual.taxId || individual.idCard || '';
        document.getElementById('customerPhone').value = individual.phone || '';
        document.getElementById('customerEmail').value = individual.email || '';
    
        // ที่อยู่
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || '';
        }
      }
    }

    // ฟังก์ชันตัดคำว่า "หมู่ที่", "หมู่", "ตำบล", "อำเภอ", "จังหวัด" ออก (ถ้ามี)
    function removeLocalityPrefix(str) {
      if (!str) return '';
      let result = str.trim();
      result = result.replace(/^หมู่ที่\s*/i, '').replace(/^หมู่\s*/i, '');
      result = result.replace(/^ตำบล\s*/i, '');
      result = result.replace(/^อำเภอ\s*/i, '');
      result = result.replace(/^จังหวัด\s*/i, '');
      return result.trim();
    }

    function removePrefixes(str) {
      if (!str) return '';
      return str.trim();
    }

    // อ่านบัตร ปชช.
    async function readCard() {
      console.log('readCard() ถูกเรียกแล้ว');
      try {
        const resp = await fetch('http://localhost:3999/read-card');
        const js = await resp.json();
        if (!resp.ok || !js.success) {
          if (typeof showToast === 'function') {
            showToast('ไม่สามารถอ่านข้อมูลบัตรได้: ' + (js.error || 'unknown'), 'error');
          } else {
            alert('ไม่สามารถอ่านข้อมูลบัตรได้: ' + (js.error || 'unknown'));
          }
          return;
        }
        const d = js.data;
        document.getElementById('customerPrefix').value = d.TitleTh || '';
        document.getElementById('customerFirstName').value = d.FirstNameTh || '';
        document.getElementById('customerLastName').value = d.LastNameTh || '';
        document.getElementById('customerIdCard').value = d.Citizenid || '';

        const addr = (d.Address || '').split('#').filter((a) => a.trim());
        document.getElementById('houseNo').value = removePrefixes(addr[0] || '');
        document.getElementById('moo').value = removeLocalityPrefix(addr[1] || '');
        document.getElementById('subDistrict').value = removeLocalityPrefix(addr[2] || '');
        document.getElementById('district').value = removeLocalityPrefix(addr[3] || '');
        document.getElementById('province').value = removeLocalityPrefix(addr[4] || '');
        document.getElementById('zipcode').value = removePrefixes(addr[5] || '');

        if (typeof showToast === 'function') {
          showToast('อ่านข้อมูลบัตรสำเร็จ', 'success');
        } else {
          alert('อ่านข้อมูลบัตรสำเร็จ');
        }
      } catch (err) {
        if (typeof showToast === 'function') {
          showToast(`Error: ${err.message}`, 'error');
        } else {
          alert(`Error: ${err.message}`);
        }
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ปุ่มค้นหาลูกค้า
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // ปุ่มอ่านบัตรประชาชน
      const btnReadCard = document.getElementById('btnReadCard');
      if (btnReadCard) {
        btnReadCard.addEventListener('click', readCard);
      }

      // ช่องค้นหาลูกค้า - กด Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ค้นหาอัตโนมัติเมื่อพิมพ์ครบ 13 หลัก
        customerSearch.addEventListener('input', function(e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // ซ่อนผลการค้นหาเมื่อพิมพ์ไม่ครบ 13 หลัก
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });
  </script>

  <script>
    // Lottie Loading Animation Function
    let lottieAnimation = null;

    function showLoading(message = 'กำลังโหลด...') {
      const overlay = document.getElementById('loadingOverlay');
      const container = document.getElementById('lottieContainer');

      if (overlay && container) {
        // Show overlay
        overlay.style.display = 'flex';
        overlay.classList.remove('animate__fadeOut');
        overlay.classList.add('animate__fadeIn');

        // Initialize Lottie animation if not already done
        if (!lottieAnimation && window.lottie) {
          lottieAnimation = window.lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets2.lottiefiles.com/packages/lf20_x62chJ.json'
          });
        }

        // Show message if provided
        if (message) {
          console.log('Loading:', message);
        }
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('animate__fadeIn');
        overlay.classList.add('animate__fadeOut');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 500);
      }
    }

    // Initialize loading on page load
    document.addEventListener('DOMContentLoaded', function() {
      showLoading('กำลังโหลดผ่อนหมดรับของ...');

      // Auto-hide loading after page is fully loaded
      window.addEventListener('load', function() {
        setTimeout(hideLoading, 1000);
      });
    });

    // Make functions globally available
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
  </script>
</body>