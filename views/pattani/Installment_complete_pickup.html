<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Pattani</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="../js/activity-tracker.js"></script>
  <!-- Sidebar Management -->
  <script src="/views/pattani/sidebar/sidebar.js" onerror="console.warn('Sidebar.js failed to load, will use fallback')"></script>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } }
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] }
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: all;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
    }

    .loading-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      min-width: 300px;
      max-width: 90%;
      color: #333;
    }

    .dark .loading-content {
      background: #1f2937;
      color: #f3f4f6;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: loading-spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }

    .dark .loading-text {
      color: #f3f4f6;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
      background-size: 200% 100%;
      animation: loading-progress 2s ease-in-out infinite;
      width: 0%;
      transition: width 0.3s ease;
    }

    @keyframes loading-progress {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .loading-theme-success .loading-spinner {
      border-top-color: #10b981;
    }
    .loading-theme-success .loading-progress-bar {
      background: linear-gradient(90deg, #10b981, #34d399, #10b981);
    }

    .loading-theme-warning .loading-spinner {
      border-top-color: #f59e0b;
    }
    .loading-theme-warning .loading-progress-bar {
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #f59e0b);
    }

    .loading-theme-error .loading-spinner {
      border-top-color: #ef4444;
    }
    .loading-theme-error .loading-progress-bar {
      background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
    }

    /* Auto-progress animation */
    .loading-auto-progress .loading-progress-bar {
      animation: loading-auto-fill 3s ease-out forwards;
    }

    @keyframes loading-auto-fill {
      from { width: 0%; }
      to { width: 100%; }
    }

    /* Responsive design */
    @media (max-width: 640px) {
      .loading-content {
        padding: 1.5rem;
        min-width: 280px;
      }
      
      .loading-text {
        font-size: 0.9rem;
      }
    }
  </style>

  <script>
    /**
     * LoadingSystem - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
     * Version: 2.0.0-inline
     */
    (function(window) {
      'use strict';

      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö loading instances
      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á container ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö loading overlays
      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }

        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á unique ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö loader
      function generateLoaderId() {
        return 'loader-' + (++loaderCounter) + '-' + Date.now();
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay element
      function createOverlay(options) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° theme class
        if (options.theme && options.theme !== 'default') {
          overlay.classList.add('loading-theme-' + options.theme);
        }

        const content = document.createElement('div');
        content.className = 'loading-content';

        // Spinner
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        content.appendChild(spinner);

        // Text
        const text = document.createElement('div');
        text.className = 'loading-text';
        text.textContent = options.message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        content.appendChild(text);

        // Progress bar (if enabled)
        if (options.showProgress) {
          const progressContainer = document.createElement('div');
          progressContainer.className = 'loading-progress';
    
          const progressBar = document.createElement('div');
          progressBar.className = 'loading-progress-bar';
    
          if (options.autoProgress) {
            progressBar.classList.add('loading-auto-progress');
          }
    
          progressContainer.appendChild(progressBar);
          content.appendChild(progressContainer);
        }

        overlay.appendChild(content);
        return overlay;
      }

      // ‡πÅ‡∏™‡∏î‡∏á loading
      function show(options = {}) {
        const settings = {
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
          theme: 'default', // default, success, warning, error
          showProgress: false,
          autoProgress: false,
          timeout: 0,
          container: null,
          ...options
        };

        const loaderId = generateLoaderId();
        const container = settings.container || createDefaultContainer();
        const overlay = createOverlay(settings);
    
        overlay.setAttribute('data-loader-id', loaderId);
    
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• loader
        activeLoaders.set(loaderId, {
          overlay: overlay,
          container: container,
          settings: settings,
          startTime: Date.now()
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ DOM
        container.appendChild(overlay);

        // ‡πÅ‡∏™‡∏î‡∏á overlay
        requestAnimationFrame(() => {
          overlay.classList.add('loading-visible');
        });

        // Auto timeout
        if (settings.timeout > 0) {
          setTimeout(() => {
            hide(loaderId);
          }, settings.timeout);
        }

        return loaderId;
      }

      // ‡∏ã‡πà‡∏≠‡∏ô loading
      function hide(loaderId) {
        if (!loaderId || !activeLoaders.has(loaderId)) {
          return false;
        }

        const loader = activeLoaders.get(loaderId);
        const overlay = loader.overlay;

        overlay.classList.remove('loading-visible');
        overlay.classList.add('loading-hiding');

        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          activeLoaders.delete(loaderId);
        }, 300);

        return true;
      }

      // ‡∏ã‡πà‡∏≠‡∏ô loading ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      function hideAll() {
        const loaderIds = Array.from(activeLoaders.keys());
        loaderIds.forEach(id => hide(id));
        return loaderIds.length;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      function updateMessage(loaderId, message) {
        if (!activeLoaders.has(loaderId)) return false;

        const loader = activeLoaders.get(loaderId);
        const textElement = loader.overlay.querySelector('.loading-text');
        if (textElement) {
          textElement.textContent = message;
        }
        return true;
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress
      function updateProgress(loaderId, percent) {
        if (!activeLoaders.has(loaderId)) return false;

        const loader = activeLoaders.get(loaderId);
        const progressBar = loader.overlay.querySelector('.loading-progress-bar');
        if (progressBar) {
          progressBar.style.width = Math.min(100, Math.max(0, percent)) + '%';
        }
        return true;
      }

      // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô progress
      function completeProgress(loaderId) {
        if (!updateProgress(loaderId, 100)) return false;

        setTimeout(() => {
          hide(loaderId);
        }, 500);
        return true;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      function isActive(loaderId) {
        return activeLoaders.has(loaderId);
      }

      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤)
      function destroy() {
        hideAll();
        if (defaultContainer && defaultContainer.parentNode) {
          defaultContainer.parentNode.removeChild(defaultContainer);
          defaultContainer = null;
        }
      }

      // Auto cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      if (typeof addEventListener === 'function') {
        addEventListener('beforeunload', destroy);
        addEventListener('unload', destroy);
      }

      // Export API
      window.LoadingSystem = {
        show: show,
        hide: hide,
        hideAll: hideAll,
        updateMessage: updateMessage,
        updateProgress: updateProgress,
        completeProgress: completeProgress,
        isActive: isActive,
        destroy: destroy,
        version: '2.0.0-inline'
      };

      console.log('‚úÖ LoadingSystem v2.0.0-inline loaded successfully');

    })(window);
  </script>

  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@latest/dist/signature_pad.umd.min.js"></script>
  <!-- Added Socket.IO client library and global socket declaration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    if (typeof io === 'function') {
      socket = io();
      socket.on('connect_error', err => console.warn('Socket.IO connect error:', err));
    } else {
      console.warn('Socket.IO script ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î ‚Äî ‡πÇ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ');
    }
  </script>

  <!-- Sidebar Component Script -->
  <script>
    class SidebarComponent {
      constructor(config = {}) {
        this.config = {
          containerSelector: '#sidebar-container',
          mainContentSelector: '#mainContent',
          ...config
        };

        this.menuItems = [
          { href: 'frontstore_pattani', icon: 'bi-cash-stack', color: 'blue-500', text: '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏î' },
          { href: 'installment_Pattani', icon: 'bi-credit-card', color: 'indigo-500', text: '‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≠‡∏ô' },
          { href: 'Addproduct_pattani', icon: 'bi-speedometer2', color: 'green-500', text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' },
          { href: 'services', icon: 'bi-tools', color: 'orange-500', text: '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' },
          { href: 'receiptVoucher', icon: 'bi-receipt', color: 'red-500', text: '‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' },
          { href: 'DepositReceipt', icon: 'bi-receipt-cutoff', color: 'teal-500', text: '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥' },
          { href: 'Quotationn', icon: 'bi-file-earmark-text', color: 'purple-500', text: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' },
          { href: 'Invoicee', icon: 'bi-receipt', color: 'fuchsia-500', text: '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' },
          { href: 'productTransfer', icon: 'bi-arrow-left-right', color: 'pink-500', text: '‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' }
        ];
      }

      async render() {
        const container = document.querySelector(this.config.containerSelector);
        if (!container) {
          console.error('Sidebar container not found');
          return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
        container.innerHTML = this.generateHTML();

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS styles
        this.injectStyles();

        // Initialize events
        this.initializeEvents();

        // Load profile
        await this.loadEmployeeProfile();

        // Restore states
        this.restoreStates();

        // Highlight active menu
        this.highlightActiveMenu();
      }

      generateHTML() {
        const menuHTML = this.menuItems.map(item => {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡πÅ‡∏ö‡∏ö static ‡πÉ‡∏´‡πâ Tailwind ‡∏Ñ‡∏≠‡∏°‡πÑ‡∏û‡∏•‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
          const textColorClass = `text-${item.color}`;                         // ‡πÄ‡∏ä‡πà‡∏ô text-blue-500
          const darkColorClass = `dark:text-${item.color.replace('500', '400')}`; // ‡πÄ‡∏ä‡πà‡∏ô dark:text-blue-400

          return `
          <li class="my-px">
            <a href="${item.href}"
               class="flex flex-row items-center h-12 px-4 rounded-lg 
                      ${textColorClass} ${darkColorClass} 
                      hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg ${textColorClass} ${darkColorClass}">
                <i class="bi ${item.icon} text-xl"></i>
              </span>
              <span class="ml-3">${item.text}</span>
            </a>
          </li>
          `;
        }).join('');

        return `
          <!-- Toggle Button -->
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  aria-label="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <!-- Sidebar -->
          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
            
            <!-- Logo -->
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <!-- Menu Items -->
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                ${menuHTML}
                
                <!-- Divider -->
                <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                                 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
                    <span class="ml-3" id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <!-- Logout -->
                <li class="my-px">
                  <button id="btnLogout"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                                 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl"></i>
                    <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                  </button>
                </li>
                
                <!-- Profile -->
                <li class="my-px mt-2">
                  <div id="profile"
                       class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                        <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Profile" class="w-full h-full object-cover" />
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">Loading‚Ä¶</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;
      }

      injectStyles() {
        if (document.getElementById('sidebar-styles')) return;

        const styles = document.createElement('style');
        styles.id = 'sidebar-styles';
        styles.textContent = `
          /* Sidebar collapsed state */
          aside.collapsed {
            width: 5rem;
          }
          
          aside.collapsed .ml-3 {
            display: none;
          }
          
          aside.collapsed .Logo,
          aside.collapsed #employeeName,
          aside.collapsed .text-xs {
            display: none;
          }
          
          aside.collapsed .p-4 {
            padding: 0.5rem;
          }
          
          aside.collapsed a {
            justify-content: center;
          }
          
          /* Sidebar translate animation */
          aside {
            transition: transform 0.3s;
          }
          
          aside.-translate-x-full {
            transform: translateX(-100%);
          }
          
          /* Active sidebar item */
          #sidebar ul li a.active {
            background-color: var(--primary-color);
            color: #fff;
          }
          
          #sidebar ul li a.active i {
            color: #fff !important;
          }
        `;
        document.head.appendChild(styles);
      }

      initializeEvents() {
        // Toggle menu
        document.getElementById('btnToggleMenu').addEventListener('click', () => this.toggleMenu());

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => this.logout());

        // Dark mode toggle
        document.getElementById('btnToggleDark').addEventListener('click', () => this.toggleDarkMode());

        // Menu item clicks
        const menuLinks = document.querySelectorAll('#sidebar ul li a');
        menuLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Remove previous active
            menuLinks.forEach(l => l.classList.remove('active'));
            // Add active to clicked
            link.classList.add('active');
          });
        });
      }

      toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector(this.config.mainContentSelector);
        const icon = document.querySelector('#btnToggleMenu i');

        sidebar.classList.toggle('-translate-x-full');

        if (sidebar.classList.contains('-translate-x-full')) {
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          if (mainContent) mainContent.style.marginLeft = '14rem';
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }

        // Save state
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      }

      toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        // Update button text
        document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
      }

      logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.href = '/login';
      }

      async loadEmployeeProfile() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

          const user = js.data;
          document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';

          let img = user.imageUrl || user.photoUrl || user.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }

          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = img || '/static/images/avatar-placeholder.png';
          }
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      restoreStates() {
        // Restore sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.querySelector(this.config.mainContentSelector);
          const icon = document.querySelector('#btnToggleMenu i');

          sidebar.classList.add('-translate-x-full');
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }

        // Restore dark mode
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeLabel').textContent = 'Light Mode';
        }
      }

      highlightActiveMenu() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop();

        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPage || currentPath.includes(href)) {
            link.classList.add('active');
          }
        });
      }

      // Public methods
      show() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('-translate-x-full');
      }

      hide() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('-translate-x-full');
      }

      setActiveMenu(menuHref) {
        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === menuHref) {
            link.classList.add('active');
          }
        });
      }
    }

    // Export for use
    window.SidebarComponent = SidebarComponent;
  </script>

  <!-- Custom CSS -->
  <style>
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --info: #560bad;
      --light-bg: #f5f7fa;
      --dark-text: #212529;
    }


    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 0;
    }

    aside.collapsed .ml-3 {
      display: none;
    }

    /* ===== MINIMAL CARD STYLES - FINAL ATTEMPT ===== */
    body .card, 
    body div.card,
    body .card.p-4 {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 16px !important;
      padding: 1.5rem !important;
      margin-bottom: 1rem !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      color: #374151 !important;
      backdrop-filter: blur(10px) !important;
      min-height: 120px !important;
      overflow: visible !important;
    }
    
    body .card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }
    
    /* Dark mode card styles */
    .dark .card {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }
    
    .dark .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
    }
    
    /* Card text alignment */
    .card h6, .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }
    
    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }
    
    .dark .card p {
      color: #9ca3af !important;
    }
    
    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }
    
    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }
    
    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }
    
    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }
    
    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }
    
    .card:hover .status-icon {
      opacity: 1 !important;
    }
    
    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }
    
    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }
    
    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }
    
    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }
    
    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }
    
    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }
    
    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }
    
    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }
    
    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }
    
    .dark .warning-text {
      color: #fbbf24 !important;
    }
    
    .dark .emergency-text {
      color: #f87171 !important;
    }
    
    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }
    
    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      color: #212529;
    }

    .dark .card-header {
      background-color: #2a2a2a;
    }

    .card-header i {
      margin-right: 10px;
      color: var(--primary);
    }

    .card-body {
      padding: 20px;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    /* Stepper */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #e9ecef;
      color: #adb5bd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .step.active .step-icon {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .step.completed .step-icon {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .step-text {
      font-size: 12px;
      color: #6c757d;
    }

    .step.active .step-text {
      color: var(--primary);
      font-weight: 600;
    }

    .step.completed .step-text {
      color: var(--success);
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Product card */
    .product-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      transform: translateY(-7px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: #f5f7fa;
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* üî• Fire Icon Animation */
    /* üî• Fire Icon Animation */
    .promo-fire-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 32px;
      z-index: 30;
      animation: fireScaleGlow 1.5s ease-in-out infinite;
    }

    @keyframes fireScaleGlow {

      0%,
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
      }

      50% {
        transform: scale(1.3);
        filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1)) drop-shadow(0 0 35px rgba(255, 100, 0, 0.8)) drop-shadow(0 0 45px rgba(255, 69, 0, 0.6));
      }
    }

    /* Card with promotion */
    .card.has-promotion {
      position: relative;
      overflow: visible !important;
    }

    /* Override card overflow for promotion icons */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
    }

    /* Confetti styles */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 1000;
    }

    /* Remove the following CSS rules */

    /* ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô sidebar */
    /* Removed: #sidebar ul li a { color: #333333 !important; } */

    /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
    /* Removed: Dynamic color rules for sidebar hover */

    /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ active - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ background ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ */
    /* Removed: Dynamic color rules for sidebar active state */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }

    /* remove plan2/plan3 styles */
    /* Plan2 detail */
    /* .plan2-detail { display: none; } */

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>
</head>

  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    <!-- Sidebar Container (will be populated by sidebar.js) -->
    <div id="sidebarContainer"></div>

    <!-- Sidebar Initialization Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for sidebar.js to load and initialize
        setTimeout(() => {
          if (typeof initializeSidebar === 'function') {
            console.log('‚úÖ External sidebar.js loaded, initializing...');
            initializeSidebar('sidebarContainer', 'mainContent');
          } else {
            console.warn('‚ö†Ô∏è External sidebar.js not available, using fallback...');
            initializeFallbackSidebar();
          }
        }, 200);
      });

      function initializeFallbackSidebar() {
        const container = document.getElementById('sidebarContainer');
        if (!container) return;

        // Create inline sidebar with full functionality
        container.innerHTML = `
          <!-- Toggle Button -->
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  aria-label="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <!-- Sidebar -->
          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
            
            <!-- Logo -->
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <!-- Menu Items -->
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                <li class="my-px">
                  <a href="frontstore_pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-blue-500 dark:text-blue-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                      <i class="bi bi-cash-stack text-xl"></i>
                    </span>
                    <span class="ml-3">‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏î</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="installment_Pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-indigo-500 dark:text-indigo-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-indigo-500 dark:text-indigo-400">
                      <i class="bi bi-credit-card text-xl"></i>
                    </span>
                    <span class="ml-3">‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≠‡∏ô</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Addproduct_pattani"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-green-500 dark:text-green-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                      <i class="bi bi-speedometer2 text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="services"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-orange-500 dark:text-orange-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                      <i class="bi bi-tools text-xl"></i>
                    </span>
                    <span class="ml-3">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="receiptVoucher"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-red-500 dark:text-red-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                      <i class="bi bi-receipt text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="DepositReceipt"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-teal-500 dark:text-teal-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-teal-500 dark:text-teal-400">
                      <i class="bi bi-receipt-cutoff text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Quotationn"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-purple-500 dark:text-purple-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                      <i class="bi bi-file-earmark-text text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="Invoicee"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-fuchsia-500 dark:text-fuchsia-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-fuchsia-500 dark:text-fuchsia-400">
                      <i class="bi bi-receipt text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span>
                  </a>
                </li>
                <li class="my-px">
                  <a href="productTransfer"
                     class="flex flex-row items-center h-12 px-4 rounded-lg 
                            text-pink-500 dark:text-pink-400 
                            hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <span class="flex items-center justify-center text-lg text-pink-500 dark:text-pink-400">
                      <i class="bi bi-arrow-left-right text-xl"></i>
                    </span>
                    <span class="ml-3">‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                  </a>
                </li>
                
                <!-- Divider -->
                <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                                 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
                    <span class="ml-3" id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <!-- Logout -->
                <li class="my-px">
                  <button id="btnLogout"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                                 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl"></i>
                    <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                  </button>
                </li>
                
                <!-- Profile -->
                <li class="my-px mt-2">
                  <div id="profile"
                       class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                        <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Profile" class="w-full h-full object-cover" />
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">Loading‚Ä¶</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;

        // Initialize events for fallback sidebar
        setupFallbackSidebarEvents();
      }

      function setupFallbackSidebarEvents() {
        // Toggle menu
        const btnToggleMenu = document.getElementById('btnToggleMenu');
        if (btnToggleMenu) {
          btnToggleMenu.addEventListener('click', toggleSidebarMenu);
        }

        // Dark mode toggle
        const btnToggleDark = document.getElementById('btnToggleDark');
        if (btnToggleDark) {
          btnToggleDark.addEventListener('click', toggleDarkMode);
        }

        // Logout
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.addEventListener('click', handleLogout);
        }

        // Load employee profile
        loadEmployeeProfileFallback();

        // Restore states
        restoreSidebarStates();

        // Highlight active menu
        highlightActiveMenu();
      }

      function toggleSidebarMenu() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        if (!sidebar || !mainContent || !icon) return;

        sidebar.classList.toggle('-translate-x-full');

        if (sidebar.classList.contains('-translate-x-full')) {
          mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          mainContent.style.marginLeft = '14rem';
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }

        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      }

      function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        const label = document.getElementById('darkModeLabel');
        if (label) {
          label.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
      }

      function handleLogout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.href = '/login';
      }

      async function loadEmployeeProfileFallback() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

          const user = js.data;
          const nameEl = document.getElementById('employeeName');
          if (nameEl) {
            nameEl.textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
          }

          let img = user.imageUrl || user.photoUrl || user.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }

          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = img || '/static/images/avatar-placeholder.png';
          }
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      function restoreSidebarStates() {
        // Restore sidebar state
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        if (isCollapsed && sidebar && mainContent && icon) {
          sidebar.classList.add('-translate-x-full');
          mainContent.style.marginLeft = '0';
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }

        // Restore dark mode
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
          document.documentElement.classList.add('dark');
          const label = document.getElementById('darkModeLabel');
          if (label) {
            label.textContent = 'Light Mode';
          }
        }
      }

      function highlightActiveMenu() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop();

        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPage || currentPath.includes(href)) {
            link.classList.add('active');
          }
        });
      }
    </script>

  <div id="mainContent" class="flex-1 flex flex-col ml-56 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800
                    border-b border-gray-200 dark:border-gray-700
                    flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Pattani</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ + ‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ + ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á -->
      <div class="flex items-center gap-2">
        <a href="History_installment"
          class="btn btn-primary flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          <i class="bi bi-receipt text-lg"></i>
          <span>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
        </a>
        <a href="Installment_on_use"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
          <span>‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</span>
        </a>
        <a href="Installment_complete_pickup"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <span>‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</span>
        </a>
      </div>
    </header>

    <!-- Content -->
    <main class="p-4">
      <!-- Stepper -->
      <div class="stepper mb-4">
        <div class="step active" data-step="1">
          <div class="step-icon">1</div>
          <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-icon">2</div>
          <div class="step-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-icon">3</div>
          <div class="step-text">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
        </div>
      </div>

      <!-- STEP 1 -->
      <div id="step1" class="step-content active">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- ‡∏ã‡πâ‡∏≤‡∏¢: Level1 + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
          <div class="lg:col-span-2 space-y-4">
            <!-- Card ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="card p-4">
              <div class="flex gap-2">
                <input id="productSearchQuery" class="input input-bordered w-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô..." />
                <button id="btnProductSearch" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button id="btnProductReset" class="btn btn-secondary">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
              </div>
            </div>

            <!-- Container Level1 -->
            <div id="level1Container" class="card">
              <div class="card-header">
                <i class="bi bi-box-seam"></i> ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Level 1)
              </div>
              <div class="card-body">
                <div id="level1Grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- renderLevel1() -->
                </div>
              </div>
            </div>

            <!-- Container Level2 -->
            <div id="level2Container" class="card hidden">
              <div class="card-header flex justify-between items-center">
                <div>
                  <i class="bi bi-menu-button-wide"></i>
                  <span id="level2Title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ...</span>
                </div>
                <button class="btn btn-sm" id="btnBackToLevel1">
                  <i class="bi bi-arrow-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </button>
              </div>
              <div class="card-body">
                <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- renderLevel2() -->
                </div>
              </div>
            </div>

            <!-- Container Level3 -->
            <div id="level3Container" class="card hidden">
              <div class="card-header">
                <div>
                  <i class="bi bi-phone"></i>
                  <span id="level3Title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                </div>
              </div>
              <div class="card-body">
                <div id="level3Grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
              </div>
            </div>

            <!-- Container ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div id="imeiResultContainer" class="card hidden">
              <div class="card-header">
                <i class="bi bi-search"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </div>
              <div class="card-body">
                <div id="imeiResultGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
              </div>
            </div>
          </div>

          <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏£‡∏∏‡∏õ/‡πÑ‡∏õ Step2 -->
          <div>
            <div class="card">
              <div class="card-header">
                <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </div>
              <div class="card-body">
                <div class="cart-summary">
                  <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                </div>
                <hr class="my-3" />
                <button class="btn btn-primary w-full" id="btnStep1ToStep2">
                  <i class="bi bi-arrow-right mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End STEP1 -->

      <!-- STEP 2 -->
      <div id="step2" class="step-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
          <div class="lg:col-span-2">
            <div class="card">
              <div class="card-header">
                <i class="bi bi-person"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
              </div>
              <div class="card-body">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô -->
                <button
                  id="btnReadCard"
                  class="btn btn-info w-full mb-4 flex items-center justify-center gap-2"
                >
                  <i class="bi bi-credit-card-2-front"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                </button>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ -->
                <div class="mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                  <label class="label">
                    <span class="label-text font-semibold">
                      <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
                    </span>
                  </label>
                  <div class="flex gap-2">
                    <input 
                      type="text" 
                      id="customerSearch" 
                      class="input input-bordered flex-1" 
                      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å"
                      maxlength="13"
                    />
                    <button 
                      id="btnSearchCustomer" 
                      class="btn btn-primary"
                      title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                    >
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                  </div>
                  
                  <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
                  <div id="customerSearchResults" class="mt-3 hidden">
                    <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                      <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Results will be inserted here -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</span></label>
                    <select id="customerPrefix" class="select select-bordered w-full">
                      <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
                      <option>‡∏ô‡∏≤‡∏¢</option>
                      <option>‡∏ô‡∏≤‡∏á</option>
                      <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                    </select>
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠</span></label>
                    <input type="text" id="customerFirstName" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span></label>
                    <input type="text" id="customerLastName" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span></label>
                    <input type="text" id="customerIdCard" class="input input-bordered w-full" />
                  </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span></label>
                    <input type="text" id="customerPhone" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></label>
                    <input type="email" id="customerEmail" class="input input-bordered w-full" />
                  </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="label"><span class="label-text">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span></label>
                    <input type="text" id="houseNo" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏´‡∏°‡∏π‡πà</span></label>
                    <input type="text" id="moo" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏ï‡∏≥‡∏ö‡∏•</span></label>
                    <input type="text" id="subDistrict" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</span></label>
                    <input type="text" id="district" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></label>
                    <input type="text" id="province" class="input input-bordered w-full" />
                  </div>
                  <div>
                    <label class="label"><span class="label-text">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span></label>
                    <input type="text" id="zipcode" class="input input-bordered w-full" />
                  </div>
                </div>
                <!-- Removed camera and signature related HTML from here if it existed -->
              </div>
            </div>
          </div>
          <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á -->
          <div>
            <div class="card">
              <div class="card-header">
                <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </div>
              <div class="card-body">
                <div class="cart-summary space-y-2 text-sm text-gray-600">
                  <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                </div>





                <div class="mt-4 space-y-2">
                  <button type="button" class="btn btn-primary w-full" id="btnStep2OpenModal">
                    <i class="bi bi-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                  </button>
                  <button class="btn btn-outline-secondary w-full" id="btnStep2ToStep1">
                    <i class="bi bi-arrow-left mr-2"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End STEP2 -->



  </div>
  </div>




  <div id="step3" class="step-content">
    <div class="flex flex-col justify-center items-center py-20">
      <div class="text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-3xl font-bold text-green-600 mb-4">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
        <p class="text-lg text-gray-600 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
        <p class="text-sm text-purple-600 mb-6">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        
        <div class="bg-blue-50 p-4 rounded-lg max-w-md mx-auto">
          <h3 class="font-semibold text-blue-800 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ:</h3>
          <ul class="text-sm text-blue-600 text-left space-y-1">
            <li>‚Ä¢ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</li>
            <li>‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</li>
            <li>‚Ä¢ ‡∏ô‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</li>
          </ul>
        </div>
        
        <p class="text-xs text-gray-500 mt-4">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
      </div>
    </div>
  </div>
  <!-- End STEP4 -->








  </main>
  </div>
  </div>







  <!-- Script ‡∏´‡∏•‡∏±‡∏Å -->
  <script>
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function checkSpecialBoxsets() {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/product-image', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
    
        console.log('All products:', data.data);
    
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ boxset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const allBoxsets = data.data.filter(item => item.productType === 'boxset');
        console.log('All boxsets:', allBoxsets);
    
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ special boxset
        const specialBoxsets = allBoxsets.filter(item => item.boxsetType === 'special');
        console.log('Special boxsets:', specialBoxsets);
    
        return specialBoxsets;
      } catch (error) {
        console.error('Error checking boxsets:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token validity
    async function validateToken() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          console.warn('‚ùå No token found');
          return false;
        }

        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          console.error('‚ùå Token validation failed:', res.status);
          if (res.status === 401) {
            localStorage.removeItem('authToken');
            showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
          }
          return false;
        }

        return true;
      } catch (err) {
        console.error('‚ùå Token validation error:', err);
        return false;
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
    
        if (!res.ok) {
          if (res.status === 401) {
            console.error('‚ùå Token invalid during profile load');
            localStorage.removeItem('authToken');
            showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
          }
          return;
        }
    
        const js = await res.json();
        if (!js.success) throw new Error(js.error || js.message || res.status);
        const u = js.data;
        window.employeeId = u._id;
        window.employeeName = u.name;        // ‚Üê ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô server
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const nameEl = document.getElementById('employeeName');
        if (nameEl) {
          nameEl.textContent = u.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
        }
    
        let img = u.imageUrl || u.photoUrl || u.image || '';
        if (img && !/^https?:\/\//.test(img)) {
          img = img.startsWith('/') ? img : '/uploads/' + img;
        }
    
        const photoElement = document.getElementById('employeePhoto');
        if (photoElement) {
          photoElement.src = img || '/static/images/avatar-placeholder.png';
        }
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ field + ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ)
    async function uploadFile(file, uploadEndpoint, fieldName = 'file', filename = 'file', extras = {}) {
      const formData = new FormData();
      formData.append(fieldName, file, filename);
      // append ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      Object.entries(extras).forEach(([key, val]) => {
        formData.append(key, val);
      });
      const res = await fetch(uploadEndpoint, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
      const js = await res.json();
      return js.url; // Assuming the server returns { success: true, url: '...' }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (Simplified: assumes pad and urlFieldId are valid if called)
    async function uploadSignature(pad, urlFieldId) {
      if (!pad || pad.isEmpty()) {
        // Consider removing alert or making it conditional if pad might not exist
        // return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        console.warn('Signature pad is empty or not provided.');
        return;
      }
      const dataURL = pad.toDataURL('image/png');
      const blob = await (await fetch(dataURL)).blob();
      try {
        const url = await uploadFile(
          blob,
          '/api/upload/signature',
          'signature',
          'signature.png'
        );
        const urlInput = document.getElementById(urlFieldId);
        if (urlInput) {
          urlInput.value = url;
        } else {
          console.warn(`Input field with ID ${urlFieldId} not found for signature URL.`);
        }
      } catch (error) {
        console.error('Error uploading signature:', error);
        showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message, 'error');
      }
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    // =========================== A) GLOBAL CONSTANTS & VARS ===========================
    const BRANCH_CODE = '00000';
    let branchInstallments = [];
    let productImages = [];
    let activePromotions = [];
    let appliedPromotions = {};
    let level2Groups = {};
    let cartItems = [];   // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];


    let signaturePad, empPad; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô

    // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á <script> ‡πÄ‡∏•‡∏¢
    if (!document.getElementById('toastContainer')) {
      const toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} shadow-lg`;
      alert.innerHTML = `<span>${message}</span>`;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }


    // A) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å API (Level1)
    async function loadBranchInstallments() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const url = `/api/product-image`;
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error(res.status);
        const js = await res.json();

        console.log('Raw data from API:', js.data);

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ special boxset
        productImages = (js.data || []).filter(item => {
          // ‡πÅ‡∏™‡∏î‡∏á special boxset
          if (item.productType === 'boxset' && item.boxsetType === 'special') {
            return true;
          }
          // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà boxset)
          if (!item.productType || item.productType !== 'boxset') {
            return true;
          }
          // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á boxset ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà special)
          return false;
        });

        console.log('Filtered products (including normal products and special boxsets):', productImages);

      } catch (err) {
        console.error('loadBranchInstallments failed:', err);
        productImages = [];
      }
    }




    /**
   * numberToThaiText: ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
   * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏≤‡∏ô (‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏•‡πâ‡∏≤‡∏ô")
   */
    function numberToThaiText(number) {
      const txtNum = ['‡∏®‡∏π‡∏ô‡∏¢‡πå', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
      const txtDigit = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];
      if (isNaN(number)) return '';

      let n = Math.floor(Math.abs(number)).toString();
      let len = n.length;
      let result = '';

      for (let i = 0; i < len; i++) {
        const digit = parseInt(n.charAt(i), 10);
        const pos = len - i - 1;                // 0 = ‡∏´‡∏ô‡πà‡∏ß‡∏¢, 1 = ‡∏™‡∏¥‡∏ö, 2 = ‡∏£‡πâ‡∏≠‡∏¢, ...
        const unit = pos % 6;                   // ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 6 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏•‡πâ‡∏≤‡∏ô)
        const group = Math.floor(pos / 6);       // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏ô" ‡∏ã‡πâ‡∏≥

        if (digit !== 0) {
          // ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö special: 1 ‚Üí "‡∏™‡∏¥‡∏ö", 2 ‚Üí "‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö"
          if (unit === 1) {
            if (digit === 1) result += '‡∏™‡∏¥‡∏ö';
            else if (digit === 2) result += '‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö';
            else result += txtNum[digit] + '‡∏™‡∏¥‡∏ö';
          }
          // ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ special: 1 ‚Üí "‡πÄ‡∏≠‡πá‡∏î" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          else if (unit === 0 && digit === 1 && len > 1) {
            result += '‡πÄ‡∏≠‡πá‡∏î';
          }
          else {
            result += txtNum[digit] + txtDigit[unit];
          }
        }

        // ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡πâ‡∏≤‡∏ô"
        if (unit === 0 && group > 0 && digit !== 0) {
          result += '‡∏•‡πâ‡∏≤‡∏ô'.repeat(group);
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° "‡∏®‡∏π‡∏ô‡∏¢‡πå"
      if (result === '') result = txtNum[0];

      return result;
    }





    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch('/api/branch', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const js = await res.json();
        if (!js.success) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
        const data = js.data || [];
        const found = data.find(b => b.branch_code === BRANCH_CODE);
        if (found) {
          // ‡πÄ‡∏Å‡πá‡∏ö global
          window.currentBranchInfo = {
            code: found.branch_code,
            name: found.name,
            address: found.address,
            taxId: found.taxId || '-',
            tel: found.tel || '-',
          };
          document.getElementById('branchInfo').textContent =
            `${found.name} ‚Äî ${found.address}`;
        } else {
          throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}`);
        }
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤)';
        // ‡πÉ‡∏´‡πâ default object ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô error
        window.currentBranchInfo = {
          code: BRANCH_CODE,
          name: 'Default Branch',
          address: '-',
          taxId: '-',
          tel: '-',
        };
      }
    }



    // =========================== D) LOAD/RENDER LEVEL1/2/3 ===========================
    async function loadLevel1() {
      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Special Boxset
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
    
      // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ title
      document.getElementById('level3Title').textContent = 'üåü Special Boxset Collection - ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á';
    
      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Special Boxset ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      console.log('üì¶ ‡πÇ‡∏´‡∏•‡∏î Special Boxsets ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á:', specialBoxsets.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    
      if (specialBoxsets.length === 0) {
        document.getElementById('level3Grid').innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="text-gray-500">
              <i class="bi bi-box-seam text-4xl mb-2"></i>
              <p>‡πÑ‡∏°‡πà‡∏û‡∏ö Special Boxset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</p>
              <p class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            </div>
          </div>
        `;
      } else {
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Special Boxset ‡πÉ‡∏ô level3
        renderLevel3(specialBoxsets);
      }
    }


    function renderLevel1(categories) {
      const grid = document.getElementById('level1Grid');
      grid.innerHTML = '';

      categories.forEach(cat => {
        const hasPromo = checkBrandHasPromotion(cat.key);
        const card = document.createElement('div');
    
        // --- REFACTORED ---
        // ‡πÉ‡∏ä‡πâ class 'card' ‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        card.className = 'card cursor-pointer';
        if (hasPromo) {
          card.classList.add('has-promotion');
        }
        if (cat.isSpecial) {
          card.classList.add('border-purple-500', 'border-2');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
        const textColor = cat.isSpecial ? 'text-purple-600 font-bold' : (hasPromo ? 'text-red-600' : '');

        card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-semibold ${textColor}">${cat.label}</h6>
      <p class="text-sm text-gray-500 mt-2">‡∏°‡∏µ ${cat.stock || 0} ‡∏ä‡∏¥‡πâ‡∏ô</p>
      ${cat.isSpecial ? '<span class="badge badge-purple mt-1">‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>' : ''}
    `;

        card.addEventListener('click', () => {
          if (cat.key === 'special-boxset') {
            loadSpecialBoxsets();
          } else {
            loadLevel2(cat.key, cat.label);
          }
        });
    
        grid.appendChild(card);
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Special Boxsets
    function loadSpecialBoxsets() {
      // ‡∏ã‡πà‡∏≠‡∏ô containers ‡∏≠‡∏∑‡πà‡∏ô
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    
      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ special boxsets
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Level3 ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = 'üåü Special Boxset Collection';
    
      renderLevel3(specialBoxsets);
    }

    // 2) ‡πÅ‡∏Å‡πâ loadLevel2 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å allProductImages ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå (parentKey) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    // 2) ‡πÅ‡∏Å‡πâ loadLevel2 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å branchInstallments ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå (parentKey) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    function loadLevel2(parentKey, parentLabel) {
      // ‡∏ã‡πà‡∏≠‡∏ô / ‡πÅ‡∏™‡∏î‡∏á container
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ${parentLabel}`;

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà brand ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ parentKey
      const filtered = productImages.filter(p => {
        const brand = p.brand || p.name.split(' ')[0];
        const key = brand.trim().toLowerCase();
        return key === parentKey;
      });

      // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Level2 ‡∏ï‡∏≤‡∏°‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      level2Groups = filtered.reduce((groups, p) => {
        const baseName = p.name.split(' ').slice(0, 2).join(' ');
        (groups[baseName] ||= []).push(p);
        return groups;
      }, {});

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      if (!Object.keys(level2Groups).length) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏ô‡∏µ‡πâ', 'warning');
        return document.getElementById('btnBackToLevel1').click();
      }

      renderLevel2(Object.keys(level2Groups));
    }


    // 3) renderLevel2 ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°
    function renderLevel2(groupNames) {
      const grid = document.getElementById('level2Grid');
      grid.innerHTML = '';

      groupNames.forEach(baseName => {
        const items = level2Groups[baseName];
        const hasPromo = checkGroupHasPromotion(items);
        const count = items.length;

        const card = document.createElement('div');
        // --- REFACTORED ---
        card.className = 'card cursor-pointer';
        if (hasPromo) {
          card.classList.add('has-promotion');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';

        card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-medium ${hasPromo ? 'text-red-600' : ''}">${baseName}</h6>
      <p class="text-sm text-gray-500 mt-2">‡∏°‡∏µ ${count} ‡∏ä‡∏¥‡πâ‡∏ô</p>
      ${hasPromo ? '<p class="text-xs text-red-500 mt-1 font-semibold animate-pulse">‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©!</p>' : ''}
    `;

        card.addEventListener('click', () => showLevel3Group(baseName));
        grid.appendChild(card);
      });
    }

    // 4) showLevel3Group ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å level2Groups ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${baseName}`;

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÅ‡∏Ñ‡πà renderLevel3 ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ rawItems ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏π‡∏õ+‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
      renderLevel3(level2Groups[baseName]);
    }

    // 5) renderLevel3 ‡πÅ‡∏™‡∏î‡∏á card + ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function renderLevel3(items) {
      currentLevel3Items = items;
      const grid = document.getElementById('level3Grid');
      grid.innerHTML = '';

      const visible = items.filter(it => !hiddenProductIds.has(it._id));
      if (!visible.length) {
        return grid.innerHTML = `<div class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
      }

      visible.forEach(it => {
        const hasPromo = checkPromotionForProduct(it._id);
        const col = document.createElement('div');
        // --- REFACTORED ---
        col.className = 'card';
        if (hasPromo) {
          col.classList.add('has-promotion');
        }
        // --- END REFACTORED ---

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
        const actualPayOffPrice = (it.price || 0) + 2590;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Boxset
        const viewDetailsBtn = it.productType === 'boxset' ? `
          <button class="btn btn-sm btn-info mb-2" onclick="showBoxsetItemsModal('${it._id}', '${it.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-eye"></i> ‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset
          </button>
        ` : '';

        col.innerHTML = `
          ${fireIcon}
          <img src="${it.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${it.name}" />
          <h6 class="font-medium text-sm mb-1">${it.name}</h6>
          <div class="text-sm font-semibold text-purple-600 mb-2">
            üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á: ‡∏ø${actualPayOffPrice.toLocaleString()}
          </div>
          <div class="text-xs text-gray-500 mb-4">
            ‚ú® ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö 100% ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </div>
          ${hasPromo ? '<p class="promotion-text">‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô!</p>' : ''}
          ${viewDetailsBtn}
          <button class="btn btn-primary mt-auto text-sm">‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
        `;

        col.querySelector('.btn-primary').addEventListener('click', () => addToCart(it));
        grid.appendChild(col);
      });
    }

    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
      const hasPromo = checkPromotionForProduct(item._id);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì pricePayOff ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      const actualPayOffPrice = (item.price || 0) + 2590;

      const cartItem = {
        ...item,
        pricePayOff: actualPayOffPrice,  // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
        docFee: item.docFee || 0,
        taxRate: item.taxRate ?? 0,
        taxType: item.taxType ?? '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'
      };

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ cartItems
      cartItems.push(cartItem);
      hiddenProductIds.add(item._id);

      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI
      renderCart();
      renderLevel3(currentLevel3Items);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      checkAvailablePromotions();

      // ‡πÅ‡∏™‡∏î‡∏á effect ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
      if (hasPromo) {
        const mainContent = document.getElementById('mainContent');
        createConfettiEffect(mainContent);
        showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ${item.name} ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©!`, 'success');
      } else {
        showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
      }

      // Removed check for selectedPlan and initManualTerms()
    }

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    function renderCart() {
      const summaries = document.querySelectorAll('.cart-summary');
      if (!summaries.length) return;

      const currentStep = document.querySelector('.step-content.active')?.id;
      let html = '';

      if (cartItems.length === 0) {
        html = `<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>`;
      } else if (currentStep === 'step3') {
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô step3 ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô #step3 .cart-summary ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
        html = document.querySelector('#step3 .cart-summary').innerHTML;
      } else {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        html = cartItems.map((it, idx) => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
          const promo = appliedPromotions[it._id];

          const base = it.pricePayOff;

          // Calculate VAT amount based on tax type
          const rate = (it.taxRate || 0) / 100;
          let vatAmount = 0;
          if (it.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
            vatAmount = base * rate;
          } else if (it.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
            vatAmount = base - (base / (1 + rate));
          }

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
          let promoHTML = '';
          if (promo) {
            const disc = promo.type === 'percentage'
              ? base * (promo.discount / 100)
              : promo.discount;
            const newPrice = base - disc;

            promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">‡∏ø${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">‡∏ø${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-‡∏ø${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
          }

          return `
  <div class="flex items-start gap-2 border-b py-2">
    <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />
    <div class="flex-1">
      <div class="font-semibold">${it.name}</div>
      <div class="text-sm text-primary">
        ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${it.pricePayOff.toLocaleString()}
      </div>
      ${promoHTML}
    </div>
    <button class="btn btn-sm btn-error" data-index="${idx}">‡∏•‡∏ö</button>
  </div>
`;
        }).join('');
      }

      summaries.forEach(el => {
        el.innerHTML = html;
        // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        el.querySelectorAll('button.btn-error').forEach(btn => {
          btn.addEventListener('click', () => {
            removeFromCart(parseInt(btn.dataset.index, 10));
          });
        });
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
      if (cartItems.length > 0 && currentStep !== 'step3') {
        // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkAvailablePromotions() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop
        console.log('üõí Cart rendered with', cartItems.length, 'items');
      }
    }

    /**
    * ‡πÄ‡∏≠‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á imeiResultContainer
    */
    function renderSearchResult(items) {
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');

      const container = document.getElementById('imeiResultContainer');
      const grid = document.getElementById('imeiResultGrid');
      container.classList.remove('hidden');
      grid.innerHTML = '';

      if (!items.length) {
        grid.innerHTML = `<div class="text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
        return;
      }

      items.forEach(item => {
        const hasPromo = checkPromotionForProduct(item._id);

        const card = document.createElement('div');
        card.className = 'card p-4 flex flex-col relative';

        if (hasPromo) {
          card.style.overflow = 'visible';
        }

        const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';

        const actualPayOffPrice = (item.price || 0) + 2590;

        card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  <div class="text-sm font-semibold text-purple-600 mb-2">
    üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á: ‡∏ø${actualPayOffPrice.toLocaleString()}
  </div>
  <div class="text-xs text-gray-500 mb-4">
    ‚ú® ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö 100% ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  </div>
  ${hasPromo ? '<p class="promotion-text">‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
`;

        card.querySelector('button').addEventListener('click', () => addToCart(item));
        grid.appendChild(card);
      });
    }

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Boxset ‡∏à‡∏≤‡∏Å API
    async function getBoxsetDetails(boxsetId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch(`/api/product-image/boxset/${boxsetId}/details`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        if (!res.ok) {
          throw new Error('Failed to fetch boxset details');
        }
    
        const data = await res.json();
        return data.data;
      } catch (error) {
        console.error('Error fetching boxset details:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Boxset ‡πÑ‡∏î‡πâ', 'error');
        return null;
      }
    }

    /**
     * ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset
     */
async function showBoxsetItemsModal(boxsetId, boxsetName) {
  try {
    // ‡πÅ‡∏™‡∏î‡∏á loading
    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• boxset ‡∏à‡∏≤‡∏Å API
    const boxset = await getBoxsetDetails(boxsetId);
    
    if (!boxset) {
      showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Boxset', 'error');
      return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô boxset ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!boxset.boxsetProducts || boxset.boxsetProducts.length === 0) {
      showToast('Boxset ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'warning');
      return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal HTML
    const modal = document.createElement('div');
    modal.id = 'boxsetModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô boxset
    const totalValue = boxset.boxsetProducts.reduce((sum, item) => {
      return sum + (item.price || 0);
    }, 0);
    
    // ‡πÅ‡∏™‡∏î‡∏á discount ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô payoff boxset
    let discountInfo = '';
    if (boxset.boxsetType === 'payoff' && boxset.payoffDiscount) {
      discountInfo = `
        <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg mb-4">
          <p class="text-green-800 dark:text-green-200 font-semibold">
            üí∞ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${boxset.payoffDiscount}% ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
          </p>
        </div>
      `;
    }
    
    modal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-lg font-semibold">üéÅ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô ${boxsetName}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${boxset.boxsetType === 'special' ? 'üåü Special Boxset' :
                        boxset.boxsetType === 'payoff' ? 'üí∞ Payoff Boxset' :
                        'üì¶ Normal Boxset'}
            </p>
          </div>
          <button class="btn btn-sm btn-circle" onclick="closeBoxsetModal()">‚úï</button>
        </div>
        
        ${discountInfo}
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${boxset.boxsetProducts.map((item, index) => `
            <div class="card p-4 border">
              <img src="${item.image || '/uploads/default-product.png'}" 
                   class="w-full h-32 object-cover rounded mb-2" 
                   alt="${item.name}" />
              <h6 class="font-medium text-sm">${item.name}</h6>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                ${item.brand || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå'}
              </p>
              <p class="text-sm font-semibold text-primary mt-2">
                ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${(item.price || 0).toLocaleString()}
              </p>
            </div>
          `).join('')}
        </div>
        
        <div class="mt-6 border-t pt-4">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${boxset.boxsetProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </p>
              <p class="text-lg font-semibold">
                ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ‡∏ø${totalValue.toLocaleString()}
              </p>
            </div>
            <button class="btn btn-primary" onclick="closeBoxsetModal()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeBoxsetModal();
      }
    });
    
  } catch (error) {
    console.error('Error in showBoxsetItemsModal:', error);
    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Boxset', 'error');
  }
}

    /**
     * ‡∏õ‡∏¥‡∏î Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Boxset
     */
    function closeBoxsetModal() {
      const modal = document.getElementById('boxsetModal');
      if (modal) {
        modal.remove();
      }
    }


    // F) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ IMEI)
    async function searchItems() {
      const query = document.getElementById('productSearchQuery').value.trim();
      if (!query) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'warning');
        return;
      }

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å Special Boxset ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
    
      const results = specialBoxsets.filter(item =>
        item.name.toLowerCase().includes(query.toLowerCase())
      );

      if (results.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö Special Boxset ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'info');
      }

      renderSearchResult(results);
    }


    // ‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° autoPrintYes
    // Removed event listener for btnAutoPrintYes

    // ‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
    // Removed event listener for btnPrintPdf


    function resetSearch() {
      document.getElementById('productSearchQuery').value = '';
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
    
      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Special Boxset ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      const specialBoxsets = productImages.filter(item =>
        item.productType === 'boxset' && item.boxsetType === 'special'
      );
      renderLevel3(specialBoxsets);
    }




    async function loadActivePromotions() {
      try {
        showToast('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô...', 'info');
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/active', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const js = await res.json();
        if (js.status === 'success') {
          activePromotions = js.data.filter(p => {
            const now = new Date();
            const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
            const startOk = new Date(p.startDate) <= now;
            const endOk = new Date(p.endDate) >= now;
            const activeOk = p.isActive === true;
            const usageOk = !p.usageLimit || (p.usageCount < p.usageLimit);
            return branchOk && startOk && endOk && activeOk && usageOk;
          });
          showToast(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${activePromotions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
        }
      } catch (err) {
        console.error('‚ùå Error loading promotions:', err);
        activePromotions = [];
      }
    }

    function checkPromotionForProduct(productId) {
      console.log('üîç Checking promotion for product:', productId);

      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å branchInstallments
      const stockItem = productImages.find(item => item._id === productId);
      if (!stockItem) {
        console.log('‚ùå Stock item not found');
        return false;
      }

      console.log('üì¶ Stock item found:', {
        _id: stockItem._id,
        name: stockItem.name,
        brand: stockItem.brand
      });

      const hasPromo = activePromotions.some(p => {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const allProducts = !p.applicableProducts ||
          (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);

        if (allProducts) {
          console.log(`‚úÖ Promotion "${p.name}" applies to all products`);
          return true;
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        let matchByName = false;
        if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
          matchByName = p.applicableProducts.some(prod => {
            const stockName = stockItem.name.trim().toLowerCase();
            const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
            return stockName === promoProductName;
          });
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Product ID (fallback)
        let matchById = false;
        if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
          matchById = p.applicableProducts.some(prod => {
            const prodId = typeof prod === 'string' ? prod : prod._id;
            return prodId === productId;
          });
        }

        return allProducts || matchByName || matchById;
      });

      console.log('üî• Has promotion:', hasPromo);
      return hasPromo;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
    function checkBrandHasPromotion(brandKey) {
      const brandProducts = productImages.filter(p => {
        const brand = p.brand || p.name.split(' ')[0];
        const key = brand.trim().toLowerCase();
        return key === brandKey;
      });

      return brandProducts.some(product => checkPromotionForProduct(product._id));
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
    function checkGroupHasPromotion(groupItems) {
      return groupItems.some(item => checkPromotionForProduct(item._id));
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Confetti Effect
    function createConfettiEffect(element) {
      const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
      const confettiCount = 30;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.transition = 'all 1s ease-out';

        element.appendChild(confetti);

        setTimeout(() => {
          confetti.style.top = '100%';
          confetti.style.opacity = '0';
          confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
        }, 10);

        setTimeout(() => confetti.remove(), 1000);
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö promotion check
    let isCheckingPromotions = false;
    let promotionCheckTimeout = null;

    async function checkAvailablePromotions() {
      if (!cartItems.length) {
        appliedPromotions = {};
        return;
      }

      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop
      if (isCheckingPromotions) {
        console.log('üîÑ Promotion check already in progress, skipping...');
        return;
      }

      // Debounce ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API (‡∏£‡∏≠ 500ms ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏£‡∏¥‡∏á)
      if (promotionCheckTimeout) {
        clearTimeout(promotionCheckTimeout);
      }

      promotionCheckTimeout = setTimeout(async () => {
        try {
          isCheckingPromotions = true;
          console.log('üéØ Checking promotions for cart items...');
    
          const token = localStorage.getItem('authToken');
          if (!token) return;
    
          const ids = [...new Set(cartItems.map(i => i._id))];
          console.log('üì¶ Checking promotions for products:', ids);
    
          const res = await fetch('/api/promotion/check-available', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
          });
    
          if (!res.ok) {
            if (res.status === 429) {
              console.warn('‚ö†Ô∏è Rate limited on promotion check, will retry later');
              return; // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            }
            throw new Error(`HTTP ${res.status}`);
          }
    
          const js = await res.json();
          if (js.status === 'success') {
            console.log('‚úÖ Promotion check successful');
            displayAvailablePromotions(js.data);
          }
        } catch (err) {
          console.error('‚ùå Error checking promotions:', err);
          appliedPromotions = {}; // ‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        } finally {
          isCheckingPromotions = false;
        }
      }, 1000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î load ‡∏ö‡∏ô server
    }

    function displayAvailablePromotions(data) {
      appliedPromotions = {};
      cartItems.forEach(item => {
        const promos = data[item._id] || [];
        if (promos.length) {
          const best = promos.reduce((b, p) => {
            const val = p.type === 'percentage'
              ? item.pricePayOff * (p.discount / 100)
              : p.type === 'fixed'
                ? p.discount
                : 0;
            const bval = b.type === 'percentage'
              ? item.pricePayOff * (b.discount / 100)
              : b.type === 'fixed'
                ? b.discount
                : 0;
            return val > bval ? p : b;
          });
          appliedPromotions[item._id] = best;
        }
      });
      // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderCart() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô infinite loop
      console.log('üéÅ Applied promotions updated:', appliedPromotions);
    }

    function calculatePromotionDiscount() {
      let totalDiscount = 0, details = [];
      Object.entries(appliedPromotions).forEach(([pid, promo]) => {
        const item = cartItems.find(i => i._id === pid);
        if (!item) return;
        const disc = promo.type === 'percentage'
          ? item.pricePayOff * (promo.discount / 100)
          : promo.type === 'fixed'
            ? promo.discount
            : 0;
        totalDiscount += disc;
        details.push({ name: promo.name, discount: disc, productName: item.name });
      });
      return { totalDiscount, details };
    }

    async function recordPromotionUsage(promotionId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/use', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ promotionId })
        });
        const js = await res.json();
        if (js.status !== 'success') {
          console.error('Failed to record promotion usage:', js.message);
        }
      } catch (err) {
        console.error('Error recording promotion usage:', err);
      }
    }





    // =========================== I) CAMERA & SIGNATURE ===========================
    function setupIDCamera() {
      const btnStart = document.getElementById('btnStartIdCamera');
      const btnCapture = document.getElementById('btnCaptureId');
      const btnRetake = document.getElementById('btnRetakeId');
      const container = document.getElementById('idCaptureContainer');
      const canvas = document.getElementById('idCanvas');
      // const inputData = document.getElementById("idImageData"); // Likely removed
      const inputUrl = document.getElementById('idCardImageUrl'); // Keep if still used for storing URL
      let idStream = null;

      // If essential elements are missing, don't proceed with setup
      if (!btnStart || !btnCapture || !btnRetake || !container || !canvas || !inputUrl) {
        console.warn('ID Camera elements not found, skipping setup.');
        return;
      }

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      btnStart.addEventListener('click', async () => {
        try {
          idStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          const video = container.querySelector('video'); // Assuming video element is dynamically added or exists
          if (video) {
            video.srcObject = idStream;
            await video.play();
            btnCapture.disabled = false;
          } else {
            console.error('Video element for ID camera not found in container.');
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'error');
          }
        } catch (err) {
          console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á:', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'error');
        }
      });

      // ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      btnCapture.addEventListener('click', async () => {
        const video = container.querySelector('video');
        if (!video) {
          console.error('Video element for ID capture not found.');
          return;
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        // if (inputData) inputData.value = dataURL; // Keep if inputData exists

        // preview
        // Ensure container is robust enough or this part is conditional
        if (container.innerHTML.includes('<video')) { // Basic check
          container.innerHTML = `<img src="${dataURL}" class="w-full h-full object-contain rounded" alt="ID Preview"/>`;
        }
        if (idStream) idStream.getTracks().forEach(t => t.stop());
        btnStart.classList.add('hidden');
        btnCapture.classList.add('hidden');
        btnRetake.classList.remove('hidden');

        try {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const url = await uploadFile(
            blob,
            '/api/upload/id-card',
            'file',
            'id-card.jpg'
          );
          if (inputUrl) inputUrl.value = url;
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('Upload ID card failed:', err);
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        }
      });

      // ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
      btnRetake.addEventListener('click', () => {
        // This part heavily depends on the specific HTML structure for the video container
        // It's safer to make it conditional or ensure the elements exist
        const videoContainerHTML = `
          <video id="idVideo" autoplay playsinline muted
                 class="absolute inset-0 w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <img src="/uploads/‡∏ö‡∏±‡∏ï‡∏£.png"
                 class="w-full h-full object-contain pointer-events-none"
                 alt="ID template overlay"/>
          </div>`;
        // Check if container can be reset this way
        if (document.getElementById('idVideo')) { // Example check
          container.innerHTML = videoContainerHTML;
        } else {
          console.warn('Cannot reset ID camera view, video container structure might have changed.');
        }
        btnStart.classList.remove('hidden');
        btnCapture.classList.remove('hidden');
        btnRetake.classList.add('hidden');
      });
    }
    function setupSelfieCamera() {
      const btnStart = document.getElementById('btnStartSelfie');
      const btnCapture = document.getElementById('btnCaptureSelfie');
      const video = document.getElementById('selfieVideo');
      const canvas = document.getElementById('selfieCanvas');
      // const inputData = document.getElementById("selfieDataURL"); // Likely removed
      const inputUrl = document.getElementById('selfieUrl'); // Keep if used
      let selfieStream = null;

      if (!btnStart || !btnCapture || !video || !canvas || !inputUrl) {
        console.warn('Selfie camera elements not found, skipping setup.');
        return;
      }

      btnStart.addEventListener('click', async () => {
        try {
          selfieStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: 'environment' } }
          });
          video.srcObject = selfieStream;
          await video.play();
          video.classList.remove('hidden');
          btnCapture.disabled = false;
        } catch (err) {
          console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á, ‡∏•‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤:', err);
          try {
            selfieStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = selfieStream;
            await video.play();
            video.classList.remove('hidden');
            btnCapture.disabled = false;
            showToast('‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ (fallback)', 'warning');
          } catch (err2) {
            console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà:', err2);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà', 'error');
            btnStart.disabled = true;
          }
        }
      });

      btnCapture.addEventListener('click', async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
        // if(inputData) inputData.value = dataUrl;
        canvas.classList.remove('hidden');

        try {
          let blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
          // if (!blob && dataUrl) { // Fallback if toBlob returns null
          //   const res = await fetch(dataUrl);
          //   blob = await res.blob();
          // }
          if (blob) {
            const url = await uploadFile(
              blob,
              '/api/upload/selfie',
              'file',
              'selfie.jpg'
            );
            if (inputUrl) inputUrl.value = url;
            showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          } else {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á blob ‡∏à‡∏≤‡∏Å selfie canvas', 'error');
          }
        } catch (err) {
          console.error('Upload selfie failed:', err);
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        } finally {
          if (selfieStream) {
            selfieStream.getTracks().forEach(track => track.stop());
            selfieStream = null;
          }
          btnCapture.disabled = true;
          btnStart.disabled = false;
        }
      });
    }

    function setupSignaturePad() {
      const canvasEl = document.getElementById('signaturePad');
      if (canvasEl) {
        const ctx = canvasEl.getContext('2d');
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data = signaturePad ? signaturePad.toData() : []; // Check if signaturePad exists
          canvasEl.width = canvasEl.offsetWidth * ratio;
          canvasEl.height = canvasEl.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          if (signaturePad) {
            signaturePad.clear();
            signaturePad.fromData(data);
          }
        }
        window.addEventListener('resize', resizeCanvas);
        signaturePad = new SignaturePad(canvasEl, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeCanvas();
        const btnClearSignature = document.getElementById('btnClearSignature');
        if (btnClearSignature) btnClearSignature.addEventListener('click', () => signaturePad.clear());
      } else {
        console.warn('Customer signature pad canvas not found.');
      }

      const empCanvas = document.getElementById('employeeSignaturePad');
      if (empCanvas) {
        const empCtx = empCanvas.getContext('2d');
        function resizeEmpCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data2 = empPad ? empPad.toData() : []; // Check if empPad exists
          empCanvas.width = empCanvas.offsetWidth * ratio;
          empCanvas.height = empCanvas.offsetHeight * ratio;
          empCtx.scale(ratio, ratio);
          if (empPad) {
            empPad.clear();
            empPad.fromData(data2);
          }
        }
        window.addEventListener('resize', resizeEmpCanvas);
        empPad = new SignaturePad(empCanvas, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeEmpCanvas();
        const btnClearEmpSignature = document.getElementById('btnClearEmpSignature');
        if (btnClearEmpSignature) btnClearEmpSignature.addEventListener('click', () => empPad.clear());
      } else {
        console.warn('Employee signature pad canvas not found.');
      }
    }



    // =========================== J) MISC ACTIONS (Dark, ToggleMenu, Logout) ===========================
    function toggleDarkMode() {
      const htmlEl = document.documentElement;
      const label = document.getElementById('darkModeLabel');
      if (htmlEl.classList.contains('dark')) {
        htmlEl.classList.remove('dark');
        if (label) label.textContent = 'Dark Mode';
      } else {
        htmlEl.classList.add('dark');
        if (label) label.textContent = 'Light Mode';
      }
    }
    function logout() {
      // ‡∏•‡∏ö token ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      localStorage.removeItem('authToken');
      // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ü
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ login
      window.location.href = '/login';
    }
    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      sb.classList.toggle('-translate-x-full');
      mc.classList.toggle('ml-64');
      mc.classList.toggle('ml-0');
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }
    function togglePlan2Detail() {
      const plan2Detail = document.querySelector('.plan2-detail');
      const plan2Radio = document.getElementById('plan2');
      if (plan2Detail && plan2Radio) {
        plan2Detail.style.display = plan2Radio.checked ? 'block' : 'none';
      }
    }



    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        await loadEmployeeProfile();
        await loadActivePromotions();
    
        // Setup dark mode
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
        }

        // Event listeners - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö element ‡∏Å‡πà‡∏≠‡∏ô‡∏ú‡∏π‡∏Å event
        const btnToggleMenu = document.getElementById('btnToggleMenu');
        if (btnToggleMenu) {
          btnToggleMenu.addEventListener('click', toggleMenu);
        }
    
        const btnToggleDark = document.getElementById('btnToggleDark');
        if (btnToggleDark) {
          btnToggleDark.addEventListener('click', toggleDarkMode);
        }
    
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.addEventListener('click', logout);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
        await loadBranchInstallments();
        await loadBranchInfo();
        loadLevel1(); // ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ Special Boxset

        // Step navigation - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö element ‡∏Å‡πà‡∏≠‡∏ô‡∏ú‡∏π‡∏Å event
        const btnStep1ToStep2 = document.getElementById('btnStep1ToStep2');
        if (btnStep1ToStep2) {
          btnStep1ToStep2.addEventListener('click', () => goToStep(2));
        }
    
        const btnStep2ToStep1 = document.getElementById('btnStep2ToStep1');
        if (btnStep2ToStep1) {
          btnStep2ToStep1.addEventListener('click', () => goToStep(1));
        }

        // Step clicking
        document.querySelectorAll('.step').forEach(el => {
          el.style.cursor = 'pointer';
          el.addEventListener('click', () => {
            const target = Number(el.getAttribute('data-step'));
            const current = Number(document.querySelector('.step.active').getAttribute('data-step'));
            if (target <= current) {
              goToStep(target);
            }
          });
        });


      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
      async function checkStockAfterSale() {
        console.log('‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å');
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
      }



      // ‡πÅ‡∏ó‡∏£‡∏Å‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô goToStep ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™ active/completed ‡πÄ‡∏™‡∏£‡πá‡∏à
      function goToStep(stepNumber) {
        // ‚Ä¶ existing code ‚Ä¶
        // Update step-content
        document.querySelectorAll('.step-content').forEach(st => st.classList.remove('active'));
        const target = document.getElementById('step' + stepNumber);
        if (target) target.classList.add('active');
        // Update visual stepper
        document.querySelectorAll('.step').forEach(elem => {
          const s = Number(elem.getAttribute('data-step'));
          elem.classList.remove('active', 'completed');
          if (s < stepNumber) elem.classList.add('completed');
          else if (s === stepNumber) elem.classList.add('active');
        });

        // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ >>>
        if (stepNumber === 3) {
          // ‡∏£‡∏≠ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ STEP1 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          setTimeout(() => {
            cartItems = []; // Clear cart
            hiddenProductIds.clear();
            renderCart(); // Update cart display
            if (typeof resetSearch === 'function') resetSearch(); // Reset search if function exists
            goToStep(1);
          }, 5000);
        }
      }


      // Removed selectedManualOption setup

      // ‡∏õ‡∏¥‡∏î Order Success Modal
      // Removed event listener for btnCloseSuccessModal
    
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô rate limiting ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
      let isProcessing = false;
      let lastRequestTime = 0;
      const REQUEST_DELAY = 5000; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debounce
      let submitTimeout = null;

        // Step2 -> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
        const btnStep2OpenModal = document.getElementById('btnStep2OpenModal');
        if (btnStep2OpenModal) {
          btnStep2OpenModal.addEventListener('click', async () => {
          try {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
            if (isProcessing) {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô', 'warning');
              return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö rate limit
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_DELAY) {
              const waitTime = Math.ceil((REQUEST_DELAY - (now - lastRequestTime)) / 1000);
              showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${waitTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`, 'warning');
              return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token validity ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
            const isTokenValid = await validateToken();
            if (!isTokenValid) {
              console.error('‚ùå Token validation failed, stopping process');
              return;
            }

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
              showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
              setTimeout(() => {
                window.location.href = '/login';
              }, 2000);
              return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            if (cartItems.length === 0) {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'warning');
              return;
            }

            // ‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            isProcessing = true;
            lastRequestTime = now;
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            const btnModal = document.getElementById('btnStep2OpenModal');
            const originalText = btnModal.innerHTML;
            btnModal.disabled = true;
            btnModal.innerHTML = '<i class="bi bi-hourglass mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const prefix = document.getElementById('customerPrefix').value || '';
            const firstName = document.getElementById('customerFirstName').value || '';
            const lastName = document.getElementById('customerLastName').value || '';
            const idCard = document.getElementById('customerIdCard').value || '';
            const phone = document.getElementById('customerPhone').value || '';
            const email = document.getElementById('customerEmail').value || '';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (!firstName || !lastName || !idCard || !phone) {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
              return;
            }

            // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            const address = {
              houseNo: document.getElementById('houseNo').value || '',
              moo: document.getElementById('moo').value || '',
              subDistrict: document.getElementById('subDistrict').value || '',
              district: document.getElementById('district').value || '',
              province: document.getElementById('province').value || '',
              zipcode: document.getElementById('zipcode').value || ''
            };

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
            let subTotal = 0;
            const items = cartItems.map(item => {
              const payOffPrice = item.pricePayOff || ((item.price || 0) + 2590);
              const qty = 1;
              subTotal += payOffPrice * qty;
    
              return {
                productId: item._id,
                product_id: item._id,
                name: item.name,
                qty: qty,
                price: payOffPrice,
                model: item.model || '',
                imei: item.imei || '',
                pricePayOff: payOffPrice,
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö plan3 (‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)
                downAmount: payOffPrice,
                downInstallmentCount: 1,
                downInstallment: payOffPrice,
                creditThreshold: 0,
                payUseInstallmentCount: 0,
                payUseInstallment: 0,
                itemDiscount: 0
              };
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
            const { totalDiscount, details } = calculatePromotionDiscount();
            const totalAmount = subTotal - totalDiscount;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API /api/installment
            const payload = {
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              items: items,
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
              customer: {
                customerType: 'individual',
                individual: {
                  prefix: prefix,
                  firstName: firstName,
                  lastName: lastName,
                  phone: phone,
                  email: email,
                  taxId: idCard,
                  address: address,
                  socialContact: {
                    facebook: '',
                    line: '',
                    mapLocation: ''
                  }
                },
                name: `${prefix}${firstName} ${lastName}`.trim(),
                fullAddress: typeof address === 'string' ? address : `${address.houseNo} ‡∏´‡∏°‡∏π‡πà ${address.moo} ‡∏ï.${address.subDistrict} ‡∏≠.${address.district} ‡∏à.${address.province} ${address.zipcode}`.trim()
              },
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
              witness: {
                name: '',
                id_card: '',
                phone: '',
                relation: ''
              },
    
              // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
              attachments: {
                id_card_image: '',
                income_slip: '',
                selfie_image: '',
                customer_signature: '',
                salesperson_signature: '',
                authorized_signature: ''
              },
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
              plan_type: 'plan3', // ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
              down_payment: totalAmount, // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
              installment_count: 1,
              installment_amount: 0,
              credit_amount: 0,
              payoff_amount: totalAmount,
              doc_fee: 0,
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              quotation_no: '',
              credit_term: '‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á',
              sub_total: subTotal,
              total_amount: totalAmount,
              total_text: numberToThaiText(Math.floor(totalAmount)) + '‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô',
              quotation_terms: '‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á',
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
              branch_code: BRANCH_CODE,
              salesperson_id: window.employeeId || '',
    
              // ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
              appliedPromotions: Object.values(appliedPromotions).map(p => ({
                id: p._id,
                name: p.name,
                type: p.type,
                discount: p.discount
              })),
              promotionDiscount: totalDiscount,
    
              // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
              skipStockDeduction: true,
              payoffContract: true // ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß
            };

            console.log('üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á - ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å:', payload);
            console.log('‚úÖ skipStockDeduction = true - ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)
            const res = await fetch('/api/installment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken
              },
              body: JSON.stringify(payload)
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response status ‡∏Å‡πà‡∏≠‡∏ô parse JSON
            if (!res.ok) {
              const errorText = await res.text();
              console.error('Server response:', res.status, errorText);
    
              if (res.status === 401) {
                console.error('‚ùå 401 Unauthorized in installment API');
                showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
                return;
              } else if (res.status === 429) {
                throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏≤‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
              } else if (res.status >= 500) {
                throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
              } else {
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${res.status}): ${errorText}`);
              }
            }

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON
            let result;
            try {
              result = await res.json();
            } catch (parseError) {
              console.error('JSON parse error:', parseError);
              throw new Error('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
    
            if (!result.success) {
              throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤');
            }

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
            window.currentContractNo = result.data.contractNo;
            window.currentOrderId = result.data.orderId;
    
            showToast('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            console.log('üìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤:', result.data.contractNo, '- ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£');
    
            // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            try {
              // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
              const token = localStorage.getItem('authToken');
              if (!token) {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 2000);
                return;
              }

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á token ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
              const tokenCheckRes = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
              });
    
              if (!tokenCheckRes.ok) {
                console.error('‚ùå Token validation failed:', tokenCheckRes.status);
                showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
                return;
              }

              const approvalPayload = {
                contractNo: result.data.contractNo,
                orderId: result.data.orderId,
                customerId: result.data.customerId,
                customerName: `${prefix}${firstName} ${lastName}`.trim(),
                items: items.map(item => ({
                  ...item,
                  productType: item.productType || 'product',
                  boxsetType: item.boxsetType || null
                })),
                totalAmount: totalAmount,
                branchCode: BRANCH_CODE
              };

              // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
              if (!approvalPayload.contractNo || !approvalPayload.orderId || !approvalPayload.customerId) {
                showToast('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
                return;
              }

              if (!approvalPayload.customerName.trim()) {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
                return;
              }

              if (!approvalPayload.items || approvalPayload.items.length === 0) {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
                return;
              }

              console.log('üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:', approvalPayload);

              const approvalRes = await fetch('/api/payoff-approval/request', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(approvalPayload)
              });

              console.log('üîç Response status:', approvalRes.status);

              // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response status ‡∏Å‡πà‡∏≠‡∏ô parse JSON
              if (!approvalRes.ok) {
                const errorText = await approvalRes.text();
                console.error('‚ùå Approval request failed:', approvalRes.status, errorText);
    
                if (approvalRes.status === 401) {
                  console.error('‚ùå 401 Unauthorized - Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                  showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                  localStorage.removeItem('authToken');
                  setTimeout(() => {
                    window.location.href = '/login';
                  }, 1500);
                  return;
                } else if (approvalRes.status === 400) {
                  let errorMsg = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                  try {
                    const errorJson = JSON.parse(errorText);
                    errorMsg = errorJson.error || errorMsg;
                  } catch (e) {
                    // ignore parse error
                  }
                  showToast(`‚ùå ${errorMsg}`, 'error');
                  return;
                } else {
                  showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${approvalRes.status})`, 'error');
                  return;
                }
              }

              const approvalResult = await approvalRes.json();
              console.log('‚úÖ Approval result:', approvalResult);

              if (approvalResult.success) {
                showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
    
                // ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                setTimeout(() => {
                  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    window.open(`/views/loan/repayment.html?contractNo=${result.data.contractNo}`, '_blank');
                  }
                }, 2000);
              } else {
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + (approvalResult.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
              }
            } catch (approvalError) {
              console.error('‚ùå Approval request error:', approvalError);
    
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ network ‡∏´‡∏£‡∏∑‡∏≠ token
              if (approvalError.message.includes('Failed to fetch') || approvalError.message.includes('NetworkError')) {
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
              } else if (approvalError.message.includes('401') || approvalError.message.includes('Unauthorized')) {
                showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                localStorage.removeItem('authToken');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 1500);
              } else {
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + approvalError.message, 'error');
              }
            }
    
            // ‡∏™‡πà‡∏á socket event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
            if (typeof socket !== 'undefined' && socket) {
              socket.emit('payoff-contract-created', {
                contractNo: result.data.contractNo,
                orderId: result.data.orderId,
                customerId: result.data.customerId,
                customerName: `${prefix}${firstName} ${lastName}`.trim(),
                items: items,
                totalAmount: totalAmount,
                branchCode: BRANCH_CODE,
                timestamp: new Date()
              });
            }
    
            // ‡πÑ‡∏õ step 3
            goToStep(3);
    
          } catch (err) {
            console.error('Error in main process:', err);
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            if (err.message.includes('401') || err.message.includes('Unauthorized') || err.message.includes('Invalid token')) {
              showToast('‚ùå Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
              localStorage.removeItem('authToken');
              setTimeout(() => {
                window.location.href = '/login';
              }, 1500);
            } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
              showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
            } else {
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
            }
          } finally {
            // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
            isProcessing = false;
    
            // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
            const btnModal = document.getElementById('btnStep2OpenModal');
            if (btnModal) {
              btnModal.disabled = false;
              btnModal.innerHTML = '<i class="bi bi-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            }
          }
        });
        }



      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÉ‡∏ô modal ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ STEP3
      // Removed event listener for confirmPrintPrompt

      // ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ renderStep4Summary:
      // Removed totalDocFee, subTotal, grandTotal calculation as it's not used in this flow

      // ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå PDF
      // Removed event listener for btnPrintPdf (related to quotation)

      // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
      // Removed event listener for btnConfirmFinish


      // Removed fetchNextQuotationNumber() function





      // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏á DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      // Removed event listener for btnDownloadPdf (related to quotation)


      // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
      // Removed event listener for btnDownloadPdf (related to quotation)





        // Search events - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö element ‡∏Å‡πà‡∏≠‡∏ô‡∏ú‡∏π‡∏Å event
        const btnProductSearch = document.getElementById('btnProductSearch');
        if (btnProductSearch) {
          btnProductSearch.addEventListener('click', searchItems);
        }
    
        const btnProductReset = document.getElementById('btnProductReset');
        if (btnProductReset) {
          btnProductReset.addEventListener('click', resetSearch);
        }

        // Back to Level1 button
        const btnBackToLevel1 = document.getElementById('btnBackToLevel1');
        if (btnBackToLevel1) {
          btnBackToLevel1.addEventListener('click', () => {
            document.getElementById('level1Container').classList.add('hidden');
            document.getElementById('level2Container').classList.add('hidden');
            document.getElementById('level3Container').classList.remove('hidden');
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á Special Boxset ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const specialBoxsets = productImages.filter(item =>
              item.productType === 'boxset' && item.boxsetType === 'special'
            );
            renderLevel3(specialBoxsets);
          });
        }

        // Camera & Signature setup
        setupIDCamera();
        setupSelfieCamera();
        setupSignaturePad();

        // Optional: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö special boxsets (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug)
        if (window.location.search.includes('debug=true')) {
          console.log('=== Checking Special Boxsets ===');
          const specialBoxsets = await checkSpecialBoxsets();
          console.table(specialBoxsets);
        }

      } catch (err) {
        console.error('Error in DOMContentLoaded:', err);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      }
    });
  </script>

  <!-- Display Fixes Script -->
  <script>
    // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö step-content
    const fixStepContentCSS = () => {
      // ‡∏•‡∏ö CSS rule ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ step4 ‡∏°‡∏µ background ‡πÅ‡∏õ‡∏•‡∏Å‡πÜ
      const style = document.createElement('style');
      style.textContent = `
        /* Reset step content styles */
        .step-content {
          display: none;
          background-color: transparent !important;
        }
        
        .step-content.active {
          display: block !important;
          min-height: auto;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö main content ‡πÉ‡∏´‡πâ responsive */
        #mainContent {
          transition: margin-left 0.3s ease-in-out;
        }
        
        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ sidebar ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô */
        #mainContent.sidebar-collapsed {
          margin-left: 0 !important;
        }
        
        /* ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        main {
          background-color: transparent !important;
          min-height: calc(100vh - 80px); /* ‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á header */
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö card container */
        .card {
          background-color: #ffffff;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark .card {
          background-color: #2a2a2a;
          border-color: #555;
        }
      `;
      document.head.appendChild(style);
    };

    // 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleMenu ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ margin ‡∏Ç‡∏≠‡∏á mainContent
    function fixToggleMenu() {
      const toggleMenu = () => {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');

        sidebar.classList.toggle('-translate-x-full');
        mainContent.classList.toggle('ml-64');
        mainContent.classList.toggle('ml-0');
        icon.classList.toggle('bi-chevron-left');
        icon.classList.toggle('bi-chevron-right');
      };

      // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà event listener ‡πÄ‡∏î‡∏¥‡∏°
      const btnToggle = document.getElementById('btnToggleMenu');
      if (btnToggle) {
        btnToggle.removeEventListener('click', window.toggleMenu);
        btnToggle.addEventListener('click', toggleMenu);
        window.toggleMenu = toggleMenu;
      }
    }

    // 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ restore sidebar state
    function fixSidebarRestore() {
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      if (!sidebar || !mainContent || !icon) {
        console.info('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö sidebar elements, ‡∏à‡∏∞ restore ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        return;
      }

      if (sidebarCollapsed) {
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.add('sidebar-collapsed');
        mainContent.style.marginLeft = '0';
        icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
      } else {
        sidebar.classList.remove('-translate-x-full');
        mainContent.classList.remove('sidebar-collapsed');
        mainContent.style.marginLeft = '14rem';
        icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
      }
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á containers
    function fixContainerDisplay() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ step content ‡∏ó‡∏µ‡πà active ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      const activeStep = document.querySelector('.step-content.active');
      if (!activeStep) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ active step ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô step 1
        const step1 = document.getElementById('step1');
        if (step1) {
          step1.classList.add('active');
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö level containers
      const level1Container = document.getElementById('level1Container');
      const level2Container = document.getElementById('level2Container');
      const level3Container = document.getElementById('level3Container');
      const imeiResultContainer = document.getElementById('imeiResultContainer');

      // ‡∏ã‡πà‡∏≠‡∏ô containers ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á
      if (level2Container && !level2Container.querySelector('#level2Grid').children.length) {
        level2Container.classList.add('hidden');
      }
      if (level3Container && !level3Container.querySelector('#level3Grid').children.length) {
        level3Container.classList.add('hidden');
      }
      if (imeiResultContainer && !imeiResultContainer.querySelector('#imeiResultGrid').children.length) {
        imeiResultContainer.classList.add('hidden');
      }
    }

    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function applyFixes() {
      // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS
      fixStepContentCSS();

      // 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç toggle menu
      fixToggleMenu();

      // 3. Restore sidebar state ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      fixSidebarRestore();

      // 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• containers
      fixContainerDisplay();

      // 5. ‡∏•‡∏ö background ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å CSS ‡πÄ‡∏Å‡πà‡∏≤
      const main = document.querySelector('main');
      if (main) {
        main.style.backgroundColor = 'transparent';
        main.style.minHeight = 'calc(100vh - 80px)';
      }

      console.log('‚úÖ Applied all display fixes');
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à - ‡∏£‡∏≠‡πÉ‡∏´‡πâ sidebar ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ sidebar ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(applyFixes, 500);
      });
    } else {
      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ sidebar ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô
      setTimeout(applyFixes, 500);
    }

    // Export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    window.applyInstallmentFixes = applyFixes;
  </script>

  <!-- Customer Search & Card Reader Script -->
  <script>
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');
    
      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'warning');
        } else {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
        }
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
        } else {
          alert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;

      try {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status code ‡∏Å‡πà‡∏≠‡∏ô parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('üö´ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', 'error');
          }
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ cooldown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ 429
          lastSearchTime = Date.now() + 27000; // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 27 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏£‡∏ß‡∏° 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    
          resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <p class="text-sm font-medium">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
              <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'success');
          }
        } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          resultsList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              <i class="bi bi-person-x text-2xl mb-2 block"></i>
              <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</p>
              <p class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${searchValue}</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);
    
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        if (error.message.includes('429')) {
          errorMessage = '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
        }

        resultsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
            <p class="text-sm font-medium">${errorMessage}</p>
            <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
    
        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');
    
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
      resultsList.innerHTML = `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
             onclick="selectCustomer('${customerData._id}', '${customerData.contactPhone || ''}')">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${customerData.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <i class="bi bi-credit-card mr-1"></i>
                ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">
                <i class="bi bi-telephone mr-1"></i>
                ‡πÇ‡∏ó‡∏£: ${customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
              </p>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">
                  ${customerData.isNewCustomer ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤'}
                </span>
                <span class="text-xs text-gray-500">
                  ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${customerData.totalPurchases || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </span>
              </div>
            </div>
            <div class="text-right">
              <button class="btn btn-sm btn-primary">
                <i class="bi bi-check-circle mr-1"></i>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    async function selectCustomer(customerId, taxId) {
      try {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/${customerId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success && result.data) {
          const customer = result.data;
    
          // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
          fillCustomerForm(customer);
    
          // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          document.getElementById('customerSearchResults').classList.add('hidden');
          document.getElementById('customerSearch').value = '';
    
          if (typeof showToast === 'function') {
            showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          }
        } else {
          throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
        }

      } catch (error) {
        console.error('Select customer error:', error);
        if (typeof showToast === 'function') {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        }
      }
    }

    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    function fillCustomerForm(customer) {
      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;
    
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        document.getElementById('customerPrefix').value = individual.prefix || '';
        document.getElementById('customerFirstName').value = individual.firstName || '';
        document.getElementById('customerLastName').value = individual.lastName || '';
        document.getElementById('customerIdCard').value = individual.taxId || individual.idCard || '';
        document.getElementById('customerPhone').value = individual.phone || '';
        document.getElementById('customerEmail').value = individual.email || '';
    
        // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || '';
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà", "‡∏´‡∏°‡∏π‡πà", "‡∏ï‡∏≥‡∏ö‡∏•", "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    function removeLocalityPrefix(str) {
      if (!str) return '';
      let result = str.trim();
      result = result.replace(/^‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà\s*/i, '').replace(/^‡∏´‡∏°‡∏π‡πà\s*/i, '');
      result = result.replace(/^‡∏ï‡∏≥‡∏ö‡∏•\s*/i, '');
      result = result.replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠\s*/i, '');
      result = result.replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î\s*/i, '');
      return result.trim();
    }

    function removePrefixes(str) {
      if (!str) return '';
      return str.trim();
    }

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.
    async function readCard() {
      console.log('readCard() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
      try {
        const resp = await fetch('http://localhost:3999/read-card');
        const js = await resp.json();
        if (!resp.ok || !js.success) {
          if (typeof showToast === 'function') {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ: ' + (js.error || 'unknown'), 'error');
          } else {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ: ' + (js.error || 'unknown'));
          }
          return;
        }
        const d = js.data;
        document.getElementById('customerPrefix').value = d.TitleTh || '';
        document.getElementById('customerFirstName').value = d.FirstNameTh || '';
        document.getElementById('customerLastName').value = d.LastNameTh || '';
        document.getElementById('customerIdCard').value = d.Citizenid || '';

        const addr = (d.Address || '').split('#').filter((a) => a.trim());
        document.getElementById('houseNo').value = removePrefixes(addr[0] || '');
        document.getElementById('moo').value = removeLocalityPrefix(addr[1] || '');
        document.getElementById('subDistrict').value = removeLocalityPrefix(addr[2] || '');
        document.getElementById('district').value = removeLocalityPrefix(addr[3] || '');
        document.getElementById('province').value = removeLocalityPrefix(addr[4] || '');
        document.getElementById('zipcode').value = removePrefixes(addr[5] || '');

        if (typeof showToast === 'function') {
          showToast('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } else {
          alert('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      } catch (err) {
        if (typeof showToast === 'function') {
          showToast(`Error: ${err.message}`, 'error');
        } else {
          alert(`Error: ${err.message}`);
        }
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
      const btnReadCard = document.getElementById('btnReadCard');
      if (btnReadCard) {
        btnReadCard.addEventListener('click', readCard);
      }

      // ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏î Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
        customerSearch.addEventListener('input', function(e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });
  </script>

  <script>
    // Lottie Loading Animation Function
    let lottieAnimation = null;

    function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
      const overlay = document.getElementById('loadingOverlay');
      const container = document.getElementById('lottieContainer');

      if (overlay && container) {
        // Show overlay
        overlay.style.display = 'flex';
        overlay.classList.remove('animate__fadeOut');
        overlay.classList.add('animate__fadeIn');

        // Initialize Lottie animation if not already done
        if (!lottieAnimation && window.lottie) {
          lottieAnimation = window.lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets2.lottiefiles.com/packages/lf20_x62chJ.json'
          });
        }

        // Show message if provided
        if (message) {
          console.log('Loading:', message);
        }
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('animate__fadeIn');
        overlay.classList.add('animate__fadeOut');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 500);
      }
    }

    // Initialize loading on page load
    document.addEventListener('DOMContentLoaded', function() {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á...');

      // Auto-hide loading after page is fully loaded
      window.addEventListener('load', function() {
        setTimeout(hideLoading, 1000);
      });
    });

    // Make functions globally available
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
  </script>
</body>