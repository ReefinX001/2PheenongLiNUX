<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="../js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } }
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] }
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />
  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@latest/dist/signature_pad.umd.min.js"></script>
  <!-- Added Socket.IO client library and global socket declaration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    if (typeof io === 'function') {
      socket = io();
      socket.on('connect_error', err => console.warn('Socket.IO connect error:', err));
    } else {
      console.warn('Socket.IO script à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹‚à¸«à¸¥à¸” â€” à¹‚à¸¢à¸™à¸œà¹ˆà¸²à¸™à¹„à¸›');
    }
  </script>


  
  <!-- Custom CSS -->
  <style>
    

@keyframes pulse { 
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --info: #560bad;
      --light-bg: #f5f7fa;
      --dark-text: #212529;
    }

    
    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 0;
    }

    aside.collapsed .ml-3 {
      display: none;
    }

    /* ===== MINIMAL CARD STYLES - FINAL ATTEMPT ===== */
    body .card, 
    body div.card,
    body .card.p-4 {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 16px !important;
      padding: 1.5rem !important;
      margin-bottom: 1rem !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      color: #374151 !important;
      backdrop-filter: blur(10px) !important;
      min-height: 120px !important;
      overflow: visible !important;
    }
    
    body .card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }
    
    /* Dark mode card styles */
    .dark .card {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }
    
    .dark .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
    }
    
    /* Card text alignment */
    .card h6, .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }
    
    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }
    
    .dark .card p {
      color: #9ca3af !important;
    }
    
    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }
    
    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }
    
    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }
    
    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }
    
    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }
    
    .card:hover .status-icon {
      opacity: 1 !important;
    }
    
    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }
    
    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }
    
    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }
    
    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }
    
    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }
    
    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }
    
    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }
    
    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }
    
    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }
    
    .dark .warning-text {
      color: #fbbf24 !important;
    }
    
    .dark .emergency-text {
      color: #f87171 !important;
    }
    
    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }
    
    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      color: #212529;
    }

    .dark .card-header {
      background-color: #2a2a2a;
    }

    .card-header i {
      margin-right: 10px;
      color: var(--primary);
    }

    .card-body {
      padding: 20px;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    /* Stepper */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #e9ecef;
      color: #adb5bd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .step.active .step-icon {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .step.completed .step-icon {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .step-text {
      font-size: 12px;
      color: #6c757d;
    }

    .step.active .step-text {
      color: var(--primary);
      font-weight: 600;
    }

    .step.completed .step-text {
      color: var(--success);
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Product card */
    .product-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      transform: translateY(-7px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: #f5f7fa;
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* ðŸ”¥ Fire Icon Animation */
/* ðŸ”¥ Fire Icon Animation */
.promo-fire-icon {
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 32px;
  z-index: 30;
  animation: fireScaleGlow 1.5s ease-in-out infinite;
}

@keyframes fireScaleGlow {
  0%, 100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
  }
  50% {
    transform: scale(1.3);
    filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1))
            drop-shadow(0 0 35px rgba(255, 100, 0, 0.8))
            drop-shadow(0 0 45px rgba(255, 69, 0, 0.6));
  }
}

/* Card with promotion */
.card.has-promotion {
  position: relative;
  overflow: visible !important;
}

/* Override card overflow for promotion icons */
#level1Grid .card,
#level2Grid .card,
#level3Grid .card {
  overflow: visible !important;
}

/* Confetti styles */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 1000;
}
    /* Remove the following CSS rules */
    
    /* à¸ªà¸µà¸›à¸à¸•à¸´à¸‚à¸­à¸‡à¸¥à¸´à¸‡à¸à¹Œà¹ƒà¸™ sidebar */
    /* Removed: #sidebar ul li a { color: #333333 !important; } */

    /* à¹€à¸¡à¸·à¹ˆà¸­ hover */
    /* Removed: Dynamic color rules for sidebar hover */

    /* à¹€à¸¡à¸·à¹ˆà¸­ active - à¸•à¹‰à¸­à¸‡à¸¡à¸µ background à¸ªà¸µà¸™à¹‰à¸³à¹€à¸‡à¸´à¸™à¸”à¹‰à¸§à¸¢ */
    /* Removed: Dynamic color rules for sidebar active state */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }
    /* remove plan2/plan3 styles */
    /* Plan2 detail */
    /* .plan2-detail { display: none; } */

    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- Loading System -->
  <link rel="stylesheet" href="/css/loading-components.css">
  <script src="/js/loading-system.js"></script>

  <!-- Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie.js for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Loading Overlay Styles -->
  <style>
    .installment-onuse-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .installment-onuse-loading-overlay.animate__fadeOut {
      opacity: 0;
      visibility: hidden;
    }

    .installment-onuse-loading-content {
      text-align: center;
      color: #374151;
    }

    .installment-onuse-lottie-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
    }

    .installment-onuse-loading-text {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .installment-onuse-loading-subtext {
      font-size: 0.875rem;
      opacity: 0.7;
    }

    @media (prefers-color-scheme: dark) {
      .installment-onuse-loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }

      .installment-onuse-loading-content {
        color: #f3f4f6;
      }
    }
  </style>
</head>

          <body class="flex flex-col min-h-screen">
  <!-- Loading Overlay -->
  <div id="installmentOnuseLoadingOverlay" class="installment-onuse-loading-overlay">
    <div class="installment-onuse-loading-content">
      <div id="installmentOnuseLottieContainer" class="installment-onuse-lottie-container"></div>
      <div class="installment-onuse-loading-text">กำลังโหลด...</div>
      <div class="installment-onuse-loading-subtext">กรุณารอสักครู่</div>
    </div>
  </div>
        </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800"
                     border-b border-gray-200 dark:border-gray-700"
                     flex items-center justify-between ml-56 transition-all duration-300"
                     id="mainHeader">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸ªà¸²à¸‚à¸²...
        </p>
      </div>
      
      <!-- à¸›à¸¸à¹ˆà¸¡à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ/à¹ƒà¸šà¸à¸³à¸à¸±à¸šà¸ à¸²à¸©à¸µ + à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸› + à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡ -->
      <div class="flex items-center gap-2">
        <a href="History_installment"
          class="btn btn-primary flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          <i class="bi bi-receipt text-lg"></i>
          <span>à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ/à¹ƒà¸šà¸à¸³à¸à¸±à¸šà¸ à¸²à¸©à¸µ</span>
        </a>
        <a href="Installment_on_use"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <span>à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›</span>
        </a>
        <a href="Installment_complete_pickup"
          class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
          <span>à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡</span>
        </a>
      </div>
    </header>
    
    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-56">

            <!-- Content -->
      <main class="p-4">
        <!-- Stepper -->
        <div class="stepper mb-4">
  <div class="step active" data-step="1">
    <div class="step-icon">1</div>
    <div class="step-text">à¹€à¸¥à¸·à¸­à¸à¸ªà¸´à¸™à¸„à¹‰à¸²</div>
  </div>
  <div class="step" data-step="2">
    <div class="step-icon">2</div>
    <div class="step-text">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²</div>
  </div>
  <div class="step" data-step="3">
    <div class="step-icon">3</div>
    <div class="step-text">à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™</div>
  </div>
</div>

        <!-- STEP 1 -->
        <div id="step1" class="step-content active">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- à¸‹à¹‰à¸²à¸¢: Level1 + à¸„à¹‰à¸™à¸«à¸² -->
            <div class="lg:col-span-2 space-y-4">
              <!-- Card à¸„à¹‰à¸™à¸«à¸² -->
              <div class="card p-4">
                <div class="flex gap-2">
                  <input id="productSearchQuery" class="input input-bordered w-full"
                    placeholder="à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™..." />
                  <button id="btnProductSearch" class="btn btn-primary">à¸„à¹‰à¸™à¸«à¸²</button>
                  <button id="btnProductReset" class="btn btn-secondary">à¸£à¸µà¹€à¸‹à¹‡à¸•</button>
                </div>
              </div>

              <!-- Container Level1 -->
              <div id="level1Container" class="card">
                <div class="card-header">
                  <i class="bi bi-box-seam"></i> à¹à¸šà¸£à¸™à¸”à¹Œà¸ªà¸´à¸™à¸„à¹‰à¸² (Level 1)
                </div>
                <div class="card-body">
                  <div id="level1Grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- renderLevel1() -->
                  </div>
                </div>
              </div>

              <!-- Container Level2 -->
              <div id="level2Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-menu-button-wide"></i>
                    <span id="level2Title">à¸£à¸²à¸¢à¸à¸²à¸£à¸‚à¸­à¸‡ ...</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel1">
                    <i class="bi bi-arrow-left mr-1"></i> à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š
                  </button>
                </div>
                <div class="card-body">
                  <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- renderLevel2() -->
                  </div>
                </div>
              </div>

              <!-- Container Level3 -->
              <div id="level3Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-phone"></i>
                    <span id="level3Title">à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel2">
                    <i class="bi bi-arrow-left mr-1"></i> à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š
                  </button>
                </div>
                <div class="card-body">
                  <div id="level3Grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                  </div>
                </div>
              </div>

              <!-- Container à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸² -->
              <div id="imeiResultContainer" class="card hidden">
                <div class="card-header">
                  <i class="bi bi-search"></i> à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²
                </div>
                <div class="card-body">
                  <div id="imeiResultGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  </div>
                </div>
              </div>
            </div>

            <!-- à¸‚à¸§à¸²: à¸•à¸°à¸à¸£à¹‰à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²/à¸ªà¸£à¸¸à¸›/à¹„à¸› Step2 -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²
                </div>
                <div class="card-body">
                  <div class="cart-summary">
                    <p class="text-gray-500">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²</p>
                  </div>
                  <hr class="my-3" />
                  <button class="btn btn-primary w-full" id="btnStep1ToStep2">
                    <i class="bi bi-arrow-right mr-2"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP1 -->

        <!-- STEP 2 -->
        <div id="step2" class="step-content">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- à¸‹à¹‰à¸²à¸¢: à¸Ÿà¸­à¸£à¹Œà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸² -->
            <div class="lg:col-span-2">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-person"></i> à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
                </div>
                <div class="card-body">
                  <!-- à¸›à¸¸à¹ˆà¸¡à¸­à¹ˆà¸²à¸™à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ -->
                  <button
                    id="btnReadCard"
                    class="btn btn-info w-full mb-4 flex items-center justify-center gap-2"
                  >
                    <i class="bi bi-credit-card-2-front"></i> à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™
                  </button>

                  <!-- à¸ªà¹ˆà¸§à¸™à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸² -->
                  <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <label class="label">
                      <span class="label-text font-semibold">
                        <i class="bi bi-search"></i> à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸²
                      </span>
                    </label>
                    <div class="flex gap-2">
                      <input 
                        type="text" 
                        id="customerSearch" 
                        class="input input-bordered flex-1" 
                        placeholder="à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ 13 à¸«à¸¥à¸±à¸"
                        maxlength="13"
                      />
                      <button 
                        id="btnSearchCustomer" 
                        class="btn btn-primary"
                        title="à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²"
                      >
                        <i class="bi bi-search"></i>
                      </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      ðŸ’¡ <strong>à¹€à¸„à¸¥à¹‡à¸”à¸¥à¸±à¸š:</strong> à¸žà¸´à¸¡à¸žà¹Œà¸„à¸£à¸š 13 à¸«à¸¥à¸±à¸à¸ˆà¸°à¸„à¹‰à¸™à¸«à¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ | à¸£à¸°à¸šà¸šà¸ˆà¸³à¸à¸±à¸”à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸² 3 à¸§à¸´à¸™à¸²à¸—à¸µ/à¸„à¸£à¸±à¹‰à¸‡
                    </div>
                    
                    <!-- à¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸² -->
                    <div id="customerSearchResults" class="mt-3 hidden">
                      <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                        <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                          <!-- Results will be inserted here -->
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- à¸ªà¹ˆà¸§à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸žà¸·à¹‰à¸™à¸à¸²à¸™ -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸²</span></label>
                      <select id="customerPrefix" class="select select-bordered w-full">
                        <option value="">- à¹€à¸¥à¸·à¸­à¸ -</option>
                        <option>à¸™à¸²à¸¢</option>
                        <option>à¸™à¸²à¸‡</option>
                        <option>à¸™à¸²à¸‡à¸ªà¸²à¸§</option>
                      </select>
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸Šà¸·à¹ˆà¸­</span></label>
                      <input type="text" id="customerFirstName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥</span></label>
                      <input type="text" id="customerLastName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™</span></label>
                      <input type="text" id="customerIdCard" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ</span></label>
                      <input type="text" id="customerPhone" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸­à¸µà¹€à¸¡à¸¥</span></label>
                      <input type="email" id="customerEmail" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">à¸šà¹‰à¸²à¸™à¹€à¸¥à¸‚à¸—à¸µà¹ˆ</span></label>
                      <input type="text" id="houseNo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸«à¸¡à¸¹à¹ˆ</span></label>
                      <input type="text" id="moo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸•à¸³à¸šà¸¥</span></label>
                      <input type="text" id="subDistrict" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸­à¸³à¹€à¸ à¸­</span></label>
                      <input type="text" id="district" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”</span></label>
                      <input type="text" id="province" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ</span></label>
                      <input type="text" id="zipcode" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="collapse collapse-arrow border rounded-box mb-4">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium">
                      à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸¢à¸²à¸™ (à¸–à¹‰à¸²à¸¡à¸µ)
                    </div>
                    <div class="collapse-content">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label class="label"><span class="label-text">à¸Šà¸·à¹ˆà¸­</span></label>
                          <input type="text" id="witnessName" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£ à¸›à¸Šà¸Š.</span></label>
                          <input type="text" id="witnessIdCard" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£</span></label>
                          <input type="text" id="witnessPhone" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œ</span></label>
                          <input type="text" id="witnessRelation" class="input input-bordered w-full"
                            placeholder="à¸à¸²à¸•à¸´/à¹€à¸žà¸·à¹ˆà¸­à¸™/à¸­à¸·à¹ˆà¸™à¹†" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸´à¸”à¸•à¹ˆà¸­à¹‚à¸‹à¹€à¸Šà¸µà¸¢à¸¥ -->
                  <div class="mt-4 p-4 bg-blue-50 dark:bg-gray-700 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-300">
                      <i class="bi bi-share"></i> à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-facebook text-blue-600"></i> Facebook
                          </span>
                        </label>
                        <input type="text" id="customerFacebook" 
                               class="input input-bordered w-full" 
                               placeholder="à¸Šà¸·à¹ˆà¸­ Facebook à¸«à¸£à¸·à¸­à¸¥à¸´à¸‡à¸à¹Œà¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ" />
                      </div>
                      <div>
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-line text-green-500"></i> Line ID
                          </span>
                        </label>
                        <input type="text" id="customerLine" 
                               class="input input-bordered w-full" 
                               placeholder="Line ID à¸«à¸£à¸·à¸­à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸à¸±à¸š Line" />
                      </div>
                      <div class="sm:col-span-2">
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-geo-alt-fill text-red-500"></i> Google Maps (à¸¥à¸´à¸‡à¸à¹Œà¸«à¸£à¸·à¸­à¸žà¸´à¸à¸±à¸”)
                          </span>
                        </label>
                        <input type="text" id="customerMapLocation" 
                               class="input input-bordered w-full" 
                               placeholder="à¸§à¸²à¸‡à¸¥à¸´à¸‡à¸à¹Œ Google Maps à¸«à¸£à¸·à¸­à¸žà¸´à¸à¸±à¸” GPS" />
                        <label class="label">
                          <span class="label-text-alt text-gray-500">
                            à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: https://goo.gl/maps/... à¸«à¸£à¸·à¸­ 13.7563, 100.5018
                          </span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />
                  <!-- à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™</span></label>
                    <div id="idCaptureContainer" class="relative w-full h-[480px] bg-gray-100 overflow-hidden rounded">
                      <video id="idVideo" autoplay playsinline muted
                        class="absolute inset-0 w-full h-full object-cover"></video>
                      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <img src="/uploads/à¸šà¸±à¸•à¸£.png" class="w-full h-full object-contain pointer-events-none"
                          alt="ID template overlay" />
                      </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                      <button id="btnStartIdCamera" class="btn btn-sm btn-primary flex-1">à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡</button>
                      <button id="btnCaptureId" class="btn btn-sm btn-success flex-1" disabled>à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›</button>
                      <button id="btnRetakeId" class="btn btn-sm btn-secondary flex-1 hidden">à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸žà¹ƒà¸«à¸¡à¹ˆ</button>
                    </div>
                    <canvas id="idCanvas" class="hidden"></canvas>
                    <input type="hidden" id="idImageData" name="idImageData" />
                  </div>
                  <!-- à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™ (à¸–à¹‰à¸²à¸¡à¸µ)</span></label>
                    <input type="file" id="incomeProof" class="file-input file-input-bordered w-full"
                      accept="image/*,application/pdf" />
                    <input type="hidden" id="salarySlipUrl" />
                  </div>
                  <!-- à¸¥à¸‡à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸¥à¸¹à¸à¸„à¹‰à¸² -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸¥à¸¹à¸à¸„à¹‰à¸²</span></label>
                    <canvas id="signaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                    <div class="flex justify-between mt-2">
                      <button id="btnClearSignature" class="btn btn-sm btn-warning">à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</button>
                      <button id="btnSaveSignature" class="btn btn-sm btn-success">à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</button>
                    </div>
                    <input type="hidden" id="customerSignatureData" name="customerSignature" />
                  </div>
                  <!-- à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆà¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™ -->
                  <div class="mb-4">
                    <label class="label">
                      <span class="label-text text-lg font-semibold">
                        <i class="bi bi-camera-fill text-blue-600"></i> à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆà¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™
                      </span>
                    </label>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-600">
                      <!-- à¸§à¸´à¸”à¸µà¹‚à¸­à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ -->
                      <video id="selfieVideo" class="w-full rounded hidden border-2 border-gray-300" autoplay playsinline muted style="max-height: 300px;"></video>

                      <!-- à¸›à¸¸à¹ˆà¸¡à¸„à¸§à¸šà¸„à¸¸à¸¡ -->
                      <div class="space-y-2 mt-3">
                        <button id="btnStartSelfie" class="btn btn-info w-full">
                          <i class="bi bi-camera-video-fill mr-2"></i> à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ
                        </button>
                        <button id="btnCaptureSelfie" class="btn btn-success w-full" disabled>
                          <i class="bi bi-camera-fill mr-2"></i> à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ
                        </button>
                      </div>

                      <!-- à¹à¸ªà¸”à¸‡à¸œà¸¥à¸£à¸¹à¸›à¸—à¸µà¹ˆà¸–à¹ˆà¸²à¸¢ -->
                      <canvas id="selfieCanvas" class="hidden border rounded w-full mt-3"></canvas>
                      
                      <!-- Hidden inputs à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ -->
                      <input type="hidden" id="selfieDataURL" />
                      <input type="hidden" id="selfieUrl" />
                    </div>
                  </div>

                  <!-- à¸Šà¸·à¹ˆà¸­à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢ (à¸‹à¹ˆà¸­à¸™) -->
                  <input type="hidden" id="salespersonName" />

                  <!-- à¸¥à¸‡à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢</span></label>
                    <canvas id="employeeSignaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                    <div class="flex justify-between mt-2">
                      <button id="btnClearEmpSignature" class="btn btn-sm btn-warning">à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</button>
                      <button id="btnSaveEmpSignature" class="btn btn-sm btn-success">à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</button>
                    </div>
                    <input type="hidden" id="employeeSignatureData" name="employeeSignature" />
                  </div>
                </div>
              </div>
            </div>
            <!-- à¸‚à¸§à¸²: à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸¥à¸°à¸›à¸¸à¹ˆà¸¡à¸™à¸³à¸—à¸²à¸‡ -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²
                </div>
                <div class="card-body">
                  <div class="cart-summary space-y-2 text-sm text-gray-600">
                    <p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²</p>
                  </div>

                  <!-- à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸² -->
                  <div class="mt-4 mb-4">
                    <label class="label"><span class="label-text text-sm font-medium">à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²</span></label>
                    <div class="flex gap-3">
                      <label class="flex items-center text-sm">
                        <input type="radio" name="pickupMethod" value="store" checked class="radio radio-sm radio-primary mr-2" /> 
                        à¸«à¸™à¹‰à¸²à¸£à¹‰à¸²à¸™
                      </label>
                      <label class="flex items-center text-sm">
                        <input type="radio" name="pickupMethod" value="online" class="radio radio-sm radio-primary mr-2" /> 
                        à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ
                      </label>
                    </div>
                  </div>

                  <!-- à¸„à¹ˆà¸²à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡ (à¸‹à¹ˆà¸­à¸™à¹„à¸§à¹‰à¸à¹ˆà¸­à¸™) -->
                  <div class="mb-3 hidden" id="shippingFeeContainer">
                    <label class="label"><span class="label-text text-sm">à¸„à¹ˆà¸²à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡ (à¸¿)</span></label>
                    <input type="number" id="shippingFee" class="input input-bordered input-sm w-full" value="0" min="0" />
                  </div>

                  <!-- à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¹€à¸­à¸à¸ªà¸²à¸£ -->
                  <div class="mb-3">
                    <label class="label"><span class="label-text text-sm">à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¹€à¸­à¸à¸ªà¸²à¸£ (à¸¿)</span></label>
                    <input type="number" id="documentFee" class="input input-bordered input-sm w-full" value="500" min="0" />
                  </div>

                  <!-- à¸ªà¹ˆà¸§à¸™à¸¥à¸” -->
                  <div class="mb-3">
                    <label class="label"><span class="label-text text-sm">à¸ªà¹ˆà¸§à¸™à¸¥à¸” (à¸¿)</span></label>
                    <input type="number" id="step2Discount" class="input input-bordered input-sm w-full" value="0" min="0" />
                  </div>

                  <!-- à¸§à¸´à¸˜à¸µà¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text text-sm font-medium">à¸§à¸´à¸˜à¸µà¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™</span></label>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="à¹€à¸‡à¸´à¸™à¸ªà¸”" checked class="radio radio-xs radio-primary mr-1" />
                        <span>à¹€à¸‡à¸´à¸™à¸ªà¸”</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="à¹€à¸Šà¹‡à¸„" class="radio radio-xs radio-primary mr-1" />
                        <span>à¹€à¸Šà¹‡à¸„</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™" class="radio radio-xs radio-primary mr-1" />
                        <span>à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="à¸­à¸·à¹ˆà¸™à¹†" class="radio radio-xs radio-primary mr-1" />
                        <span>à¸­à¸·à¹ˆà¸™à¹†</span>
                      </label>
                    </div>
                  </div>


                  <div class="mt-4 space-y-2">
                    <button type="button" class="btn btn-primary w-full" id="btnStep2OpenModal">
                      <i class="bi bi-save mr-2"></i> à¸šà¸±à¸™à¸—à¸¶à¸
                    </button>
                    <button class="btn btn-outline-secondary w-full" id="btnStep2ToStep1">
                      <i class="bi bi-arrow-left mr-2"></i> à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP2 -->

        <!-- Modal à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¹‰à¸žà¸´à¸¡à¸žà¹Œ PDF à¸à¹ˆà¸­à¸™à¹„à¸› Step3 -->
        <input type="checkbox" id="printPromptModal" class="modal-toggle" />
        <div class="modal">
          <div class="modal-box">
            <h3 class="font-bold text-lg">ðŸ“„ à¸žà¸´à¸¡à¸žà¹Œà¹„à¸Ÿà¸¥à¹Œ PDF</h3>
            <p class="py-4">
              à¸à¸£à¸¸à¸“à¸²à¸à¸”à¸›à¸¸à¹ˆà¸¡ "à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” PDF" à¹€à¸žà¸·à¹ˆà¸­à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¹„à¸Ÿà¸¥à¹Œ PDF à¸à¹ˆà¸­à¸™
              à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸à¸” "à¸¢à¸·à¸™à¸¢à¸±à¸™" à¹€à¸žà¸·à¹ˆà¸­à¹„à¸›à¸¢à¸±à¸‡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸–à¸±à¸”à¹„à¸›
            </p>
            <div class="modal-action">
              <!-- à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” PDF à¹ƒà¸šà¹€à¸ªà¸™à¸­à¸£à¸²à¸„à¸² -->
              <button type="button" id="btnStep2DownloadPdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf mr-2"></i> à¹ƒà¸šà¹€à¸ªà¸™à¸­à¸£à¸²à¸„à¸²
              </button>
              <!-- à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” PDF à¹ƒà¸šà¹à¸ˆà¹‰à¸‡à¸«à¸™à¸µà¹‰ -->
              <button type="button" id="btnStep2DownloadInvoicePdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf-fill mr-2"></i> à¹ƒà¸šà¹à¸ˆà¹‰à¸‡à¸«à¸™à¸µà¹‰
              </button>
              <!-- à¸›à¸¸à¹ˆà¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™ à¹€à¸žà¸·à¹ˆà¸­à¹„à¸› STEP3 -->
              <label for="printPromptModal" id="confirmPrintPrompt" class="btn btn-primary">
                à¸¢à¸·à¸™à¸¢à¸±à¸™
              </label>
            </div>
          </div>
        </div>

        


        <div id="step3" class="step-content">
  <div class="flex justify-center items-center py-20">
    <h2 class="text-3xl font-bold">à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£</h2>
    <p class="text-lg text-gray-600 mt-4">à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§</p>
  </div>
</div>
          <!-- End STEP4 -->







          
      </main>
    </div>
  </div>





  

  <!-- Script à¸«à¸¥à¸±à¸ -->
  <script>
  // à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸žà¸™à¸±à¸à¸‡à¸²à¸™
  async function loadEmployeeProfile() {
    try {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      const res = await fetch('/api/users/me', {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      const js = await res.json();
      if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);
      const u = js.data;
      window.employeeId = u._id;
      window.employeeName = u.name;        // â† à¹€à¸à¹‡à¸šà¸Šà¸·à¹ˆà¸­à¹„à¸§à¹‰à¹ƒà¸Šà¹‰à¸ªà¹ˆà¸‡à¸‚à¸¶à¹‰à¸™ server
      document.getElementById('employeeName').textContent = u.name || '(à¹„à¸¡à¹ˆà¸žà¸šà¸Šà¸·à¹ˆà¸­);
      let img = u.imageUrl || u.photoUrl || u.image || '';
      if (img && !/^https?:\/\//.test(img)) {
        img = img.startsWith('/') ? img : '/uploads/' + img;
      }
      document.getElementById('employeePhoto').src = img || '/static/images/avatar-placeholder.png'; // à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ fallback à¹€à¸›à¹‡à¸™ placeholder'
    } catch (err) {
      console.error('Load Employee Profile Error:', err);
    }
  }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸—à¸±à¹ˆà¸§à¹„à¸› (à¸£à¸±à¸šà¸Šà¸·à¹ˆà¸­ field + à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¹„à¸”à¹‰)
    async function uploadFile(file, uploadEndpoint, fieldName = 'file', filename = 'file', extras = {}) {
      const formData = new FormData();
      formData.append(fieldName, file, filename);
      // append à¸„à¹ˆà¸²à¸­à¸·à¹ˆà¸™à¹† à¸–à¹‰à¸²à¸¡à¸µ
      Object.entries(extras).forEach(([key, val]) => {
        formData.append(key, val);
      });
      const res = await fetch(uploadEndpoint, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
      const js = await res.json();
      return js.url; // Assuming the server returns { success: true, url: '...' }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™ (Simplified: assumes pad and urlFieldId are valid if called)
    async function uploadSignature(pad, urlFieldId) {
      if (!pad || pad.isEmpty()) {
        // Consider removing alert or making it conditional if pad might not exist
        // return alert("à¸à¸£à¸¸à¸“à¸²à¸¥à¸‡à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸à¹ˆà¸­à¸™à¸šà¸±à¸™à¸—à¸¶à¸"); 
        console.warn("Signature pad is empty or not provided.");
        return;
      }
      const dataURL = pad.toDataURL("image/png");
      const blob = await (await fetch(dataURL)).blob();
      try {
        const url = await uploadFile(
          blob,
          "/api/upload/signature",
          "signature",
          "signature.png"
        );
        const urlInput = document.getElementById(urlFieldId);
        if (urlInput) {
          urlInput.value = url;
        } else {
          console.warn(`Input field with ID ${urlFieldId} not found for signature URL.`);
        }
      } catch (error) {
        console.error("Error uploading signature:", error);
        showToast('à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + error.message, 'error');
      }
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” à¸ˆà¸šà¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹€à¸žà¸´à¹ˆà¸¡ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    // =========================== A) GLOBAL CONSTANTS & VARS ===========================
    // Function to show/hide loading overlay
        // à¸­à¹ˆà¸²à¸™ branch_code à¸ˆà¸²à¸ URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

    if (!BRANCH_CODE) {
      console.warn("Branch code not specified, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    console.log(`[Installment_on_use] Using branch code: ${BRANCH_CODE}`);

    // à¸­à¸±à¸žà¹€à¸”à¸— localStorage à¹à¸¥à¸° title
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸› - ${decodeURIComponent(urlParams.get('name'))}`;
    }
    let branchInstallments = [];
    let productImages = [];
    let activePromotions = [];
    let appliedPromotions = {};
    let level2Groups = {};
    let cartItems = [];   // à¹€à¸à¹‡à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];
  

    let signaturePad, empPad; // à¸ªà¸³à¸«à¸£à¸±à¸šà¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™

    // à¸‚à¸¢à¸±à¸šà¸¡à¸²à¸”à¹‰à¸²à¸™à¸šà¸™à¸ªà¸¸à¸”à¸‚à¸­à¸‡ <script> à¹€à¸¥à¸¢
    if (!document.getElementById('toastContainer')) {
      const toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} shadow-lg`;
      alert.innerHTML = `<span>${message}</span>`;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }


    // A) à¹‚à¸«à¸¥à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¸œà¹ˆà¸­à¸™à¸ˆà¸²à¸ API (Level1)
    async function loadBranchInstallments() {
  const loaderId = LoadingSystem.show({
        message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...',
        showProgress: true,
        autoProgress: true
      });
  try {
    const token = localStorage.getItem("authToken") || "";
    const url = `/api/product-image/pricing/installment`;
    const res = await fetch(url, { headers: { Authorization: "Bearer " + token } });
    if (!res.ok) throw new Error(res.status);
    const js = await res.json();
    
    // à¸à¸£à¸­à¸‡à¹€à¸‰à¸žà¸²à¸° mobile à¹à¸¥à¸°à¸¡à¸µ pricePayOff
    productImages = (js.data || []).filter(item => {
      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸«à¸¥à¸²à¸¢à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸–à¸·à¸­
      const isMobile = item.productType === 'mobile' || '
                       item.productType === 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ' ||
                       item.productType === 'à¸¡à¸·à¸­à¸–à¸·à¸­' ||
                       item.category === 'mobile' ||
                       item.category === 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ' ||
                       item.category === 'à¸¡à¸·à¸­à¸–à¸·à¸­';
      
      const hasPrice = item.pricePayOff > 0;
      
      // Debug log
      if (!isMobile && item.productType) {
        console.log(`ðŸš« Filtered out non-mobile: ${item.name} (type: ${item.productType})`);
      }
      
      return isMobile && hasPrice;
    });
    
    console.log(`âœ… Loaded ${productImages.length} mobile products`);
    console.log("Mobile products:", productImages.map(p => ({
      name: p.name,
      type: p.productType,
      category: p.category
    })));
    
  } catch (err) {
    console.error("loadBranchInstallments failed:", err);
    productImages = [];
  } finally {
    LoadingSystem.hide(loaderId);
  }
}

    /**
   * numberToThaiText: à¹à¸›à¸¥à¸‡à¸•à¸±à¸§à¹€à¸¥à¸‚ (à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡) à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
   * à¸£à¸­à¸‡à¸£à¸±à¸šà¸ˆà¸™à¸–à¸¶à¸‡à¸«à¸¥à¸±à¸à¸¥à¹‰à¸²à¸™ (à¹à¸¥à¸°à¸§à¸™à¸à¸¥à¸±à¸šà¸—à¸µà¹ˆ "à¸¥à¹‰à¸²à¸™")
   */
    function numberToThaiText(number) {
      const txtNum = ["à¸¨à¸¹à¸™à¸¢à¹Œ", "à¸«à¸™à¸¶à¹ˆà¸‡", "à¸ªà¸­à¸‡", "à¸ªà¸²à¸¡", "à¸ªà¸µà¹ˆ", "à¸«à¹‰à¸²", "à¸«à¸", "à¹€à¸ˆà¹‡à¸”", "à¹à¸›à¸”", "à¹€à¸à¹‰à¸²"];
      const txtDigit = ["", "à¸ªà¸´à¸š", "à¸£à¹‰à¸­à¸¢", "à¸žà¸±à¸™", "à¸«à¸¡à¸·à¹ˆà¸™", "à¹à¸ªà¸™", "à¸¥à¹‰à¸²à¸™"];
      if (isNaN(number)) return "";

      let n = Math.floor(Math.abs(number)).toString();
      let len = n.length;
      let result = "";

      for (let i = 0; i < len; i++) {
        const digit = parseInt(n.charAt(i), 10);
        const pos = len - i - 1;                // 0 = à¸«à¸™à¹ˆà¸§à¸¢, 1 = à¸ªà¸´à¸š, 2 = à¸£à¹‰à¸­à¸¢, ...
        const unit = pos % 6;                   // à¸§à¸™à¸‹à¹‰à¸³à¸—à¸¸à¸ 6 à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ (à¸¥à¹‰à¸²à¸™)
        const group = Math.floor(pos / 6);       // à¸à¸³à¸«à¸™à¸”à¸à¸¥à¸¸à¹ˆà¸¡ "à¸¥à¹‰à¸²à¸™" à¸‹à¹‰à¸³

        if (digit !== 0) {
          // à¸«à¸¥à¸±à¸à¸ªà¸´à¸š special: 1 â†’ "à¸ªà¸´à¸š", 2 â†’ "à¸¢à¸µà¹ˆà¸ªà¸´à¸š"
          if (unit === 1) {
            if (digit === 1) result += "à¸ªà¸´à¸š";
            else if (digit === 2) result += "à¸¢à¸µà¹ˆà¸ªà¸´à¸š";
            else result += txtNum[digit] + "à¸ªà¸´à¸š";
          }
          // à¸«à¸¥à¸±à¸à¸«à¸™à¹ˆà¸§à¸¢ special: 1 â†’ "à¹€à¸­à¹‡à¸”" à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹€à¸¥à¸‚à¸«à¸¥à¸±à¸à¹€à¸”à¸µà¸¢à¸§
          else if (unit === 0 && digit === 1 && len > 1) {
            result += "à¹€à¸­à¹‡à¸”";
          }
          else {
            result += txtNum[digit] + txtDigit[unit];
          }
        }

        // à¸„à¸£à¸šà¸à¸¥à¸¸à¹ˆà¸¡à¸¥à¹‰à¸²à¸™ à¹ƒà¸«à¹‰à¹€à¸•à¸´à¸¡à¸„à¸³à¸§à¹ˆà¸² "à¸¥à¹‰à¸²à¸™"
        if (unit === 0 && group > 0 && digit !== 0) {
          result += "à¸¥à¹‰à¸²à¸™".repeat(group);
        }
      }

      // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ 0 à¹ƒà¸«à¹‰à¹€à¸•à¸´à¸¡ "à¸¨à¸¹à¸™à¸¢à¹Œ"
      if (result === "") result = txtNum[0];

      return result;
    }





    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem("authToken") || "";
        const res = await fetch("/api/branch", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const js = await res.json();
        if (!js.success) throw new Error("à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²");
        const data = js.data || [];
        const found = data.find(b => b.branch_code === BRANCH_CODE);
        if (found) {
          // à¹€à¸à¹‡à¸š global
          window.currentBranchInfo = {
            code: found.branch_code,
            name: found.name,
            address: found.address,
            taxId: found.taxId || "-",
            tel: found.tel || "-",
          };
          document.getElementById("branchInfo").textContent =
            `${found.name} â€” ${found.address}`;
        } else {
          throw new Error(`à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸²à¸‚à¸² ${BRANCH_CODE}`);
        }
      } catch (err) {
        console.warn("loadBranchInfo error:", err);
        document.getElementById("branchInfo").textContent = "(à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²)";
        // à¹ƒà¸«à¹‰ default object à¹„à¸§à¹‰à¸à¸±à¸™ error
        window.currentBranchInfo = {
          code: BRANCH_CODE,
          name: "Default Branch",
          address: "-",
          taxId: "-",
          tel: "-",
        };
      }
    }



    // =========================== D) LOAD/RENDER LEVEL1/2/3 ===========================
    async function loadLevel1() {
  // à¹€à¸£à¸µà¸¢à¸à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¹ˆà¸­à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥
  validateMobileOnly();
  
  document.getElementById("level1Container").classList.remove("hidden");
  
  // à¸ªà¸£à¹‰à¸²à¸‡ brandCounts à¸ˆà¸²à¸ productImages à¸—à¸µà¹ˆà¸à¸£à¸­à¸‡à¹à¸¥à¹‰à¸§
  const brandCounts = productImages.reduce((acc, item) => {
    const brand = item.brand || item.name.split(" ")[0];
    const key = brand.trim().toLowerCase();
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
  
  const categories = Object.entries(brandCounts)
    .map(([key, stock]) => ({ key, label: key[0].toUpperCase() + key.slice(1), stock }))
    .filter(c => c.stock > 0)
    .sort((a, b) => a.label.localeCompare(b.label));
  
  // à¹à¸ªà¸”à¸‡à¹€à¸‰à¸žà¸²à¸°à¹à¸šà¸£à¸™à¸”à¹Œà¸¡à¸·à¸­à¸–à¸·à¸­
  const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
  const mobileCategories = categories.filter(cat => 
    mobileBrands.some(brand => cat.key.includes(brand))
  );
  
  if (mobileCategories.length === 0 && categories.length > 0) {
    // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸žà¸šà¹à¸šà¸£à¸™à¸”à¹Œà¸¡à¸·à¸­à¸–à¸·à¸­à¸—à¸µà¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸ à¹à¸•à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸² à¹ƒà¸«à¹‰à¹à¸ªà¸”à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    console.warn('âš ï¸ No recognized mobile brands found, showing all categories');
    renderLevel1(categories);
  } else {
    renderLevel1(mobileCategories);
  }
}

// à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸š debug
window.debugMobileProducts = function() {
  console.log('=== Mobile Products Debug ===');
  console.log(`Total products: ${productImages.length}`);
  
  // à¹à¸ªà¸”à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸šà¸šà¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸•à¸²à¸¡ productType
  const grouped = productImages.reduce((acc, item) => {
    const type = item.productType || 'unknown';
    if (!acc[type]) acc[type] = [];
    acc[type].push(item.name);
    return acc;
  }, {});
  
  console.table(grouped);
  
  // à¹à¸ªà¸”à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸¡à¸·à¸­à¸–à¸·à¸­
  const suspiciousItems = productImages.filter(item => {
    const name = item.name.toLowerCase();
    const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
    return !mobileBrands.some(brand => name.includes(brand));
  });
  
  if (suspiciousItems.length > 0) {
    console.log('âš ï¸ Suspicious non-mobile items:', suspiciousItems.map(i => ({
      name: i.name,
      type: i.productType,
      category: i.category
    })));
  }
};


    function renderLevel1(categories) {
  const grid = document.getElementById("level1Grid");
  grid.innerHTML = "";
  
  categories.forEach(cat => {
    const hasPromo = checkBrandHasPromotion(cat.key);
    const card = document.createElement("div");
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
    
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : '';
    
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-semibold ${hasPromo ? 'text-red-600' : ''}">${cat.label}</h6>'
      <p class="text-sm text-gray-500 mt-2">à¸¡à¸µ ${cat.stock || 0} à¸Šà¸´à¹‰à¸™</p>
    `;
    
    card.addEventListener("click", () => loadLevel2(cat.key, cat.label));
    grid.appendChild(card);
  });
}

    // 2) à¹à¸à¹‰ loadLevel2 à¹ƒà¸«à¹‰à¸à¸£à¸­à¸‡à¸ˆà¸²à¸ allProductImages à¸•à¸²à¸¡à¹à¸šà¸£à¸™à¸”à¹Œ (parentKey) à¹à¸¥à¹‰à¸§à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡
    // 2) à¹à¸à¹‰ loadLevel2 à¹ƒà¸«à¹‰à¸à¸£à¸­à¸‡à¸ˆà¸²à¸ branchInstallments à¸•à¸²à¸¡à¹à¸šà¸£à¸™à¸”à¹Œ (parentKey) à¹à¸¥à¹‰à¸§à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡
    function loadLevel2(parentKey, parentLabel) {
      // à¸‹à¹ˆà¸­à¸™ / à¹à¸ªà¸”à¸‡ container
      document.getElementById("level1Container").classList.add("hidden");
      document.getElementById("level3Container").classList.add("hidden");
      document.getElementById("imeiResultContainer").classList.add("hidden");
      document.getElementById("level2Container").classList.remove("hidden");
      document.getElementById("level2Title").textContent = `à¸£à¸²à¸¢à¸à¸²à¸£à¸‚à¸­à¸‡ ${parentLabel}`;

      // à¸à¸£à¸­à¸‡à¹€à¸‰à¸žà¸²à¸°à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆ brand à¸«à¸£à¸·à¸­à¸Šà¸·à¹ˆà¸­à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ parentKey
      const filtered = productImages.filter(p => {
    const brand = p.brand || p.name.split(" ")[0];
    const key = brand.trim().toLowerCase();
    return key === parentKey;
  });

      // à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡ Level2 à¸•à¸²à¸¡à¸ªà¸­à¸‡à¸„à¸³à¹à¸£à¸à¸‚à¸­à¸‡à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²
      level2Groups = filtered.reduce((groups, p) => {
        const baseName = p.name.split(" ").slice(0, 2).join(" ");
        (groups[baseName] ||= []).push(p);
        return groups;
      }, {});

      // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸­à¸°à¹„à¸£à¹€à¸¥à¸¢ à¹ƒà¸«à¹‰à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š
      if (!Object.keys(level2Groups).length) {
        showToast("à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¹à¸šà¸£à¸™à¸”à¹Œà¸™à¸µà¹‰", "warning");
        return document.getElementById("btnBackToLevel1").click();
      }

      renderLevel2(Object.keys(level2Groups));
    }


    // 3) renderLevel2 à¸£à¸±à¸šà¹€à¸›à¹‡à¸™ list à¸‚à¸­à¸‡à¸Šà¸·à¹ˆà¸­à¸à¸¥à¸¸à¹ˆà¸¡
    function renderLevel2(groupNames) {
  const grid = document.getElementById("level2Grid");
  grid.innerHTML = "";

  groupNames.forEach(baseName => {
    const items = level2Groups[baseName];
    const hasPromo = checkGroupHasPromotion(items);
    const count = items.length;
    
    const card = document.createElement("div");
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
    
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : '';
    
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-medium ${hasPromo ? 'text-red-600' : ''}">${baseName}</h6>'
      <p class="text-sm text-gray-500 mt-2">à¸¡à¸µ ${count} à¸Šà¸´à¹‰à¸™</p>
      ${hasPromo ? '<p class="text-xs text-red-500 mt-1 font-semibold animate-pulse">à¸¥à¸”à¸£à¸²à¸„à¸²à¸žà¸´à¹€à¸¨à¸©!</p>' : ''}
    `;
    
    card.addEventListener("click", () => showLevel3Group(baseName));
    grid.appendChild(card);
  });
}

    // 4) showLevel3Group à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ level2Groups à¸¡à¸²à¹à¸ªà¸”à¸‡
    function showLevel3Group(baseName) {
      document.getElementById("level2Container").classList.add("hidden");
      document.getElementById("level3Container").classList.remove("hidden");
      document.getElementById("level3Title").textContent = `à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²: ${baseName}`;

      // à¸ˆà¸±à¸”à¸à¸²à¸£à¸•à¹ˆà¸­à¹à¸„à¹ˆ renderLevel3 à¹‚à¸”à¸¢à¸•à¸£à¸‡ à¹€à¸žà¸£à¸²à¸° rawItems à¸„à¸·à¸­à¸£à¸¹à¸›+à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸šà¹à¸¥à¹‰à¸§
      renderLevel3(level2Groups[baseName]);
    }

    // à¹à¸à¹‰à¹„à¸‚à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ renderLevel3 - à¹€à¸­à¸²à¸ªà¹ˆà¸§à¸™à¹à¸ªà¸”à¸‡à¸£à¸²à¸„à¸²à¸­à¸­à¸
function renderLevel3(items) {
  currentLevel3Items = items;
  const grid = document.getElementById("level3Grid");
  grid.innerHTML = "";

  const visible = items.filter(it => !hiddenProductIds.has(it._id));
  if (!visible.length) {
    return grid.innerHTML = `<div class="text-gray-500">à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸´à¸™à¸„à¹‰à¸²</div>`;
  }

  visible.forEach(it => {
    const hasPromo = checkPromotionForProduct(it._id);
    
    const col = document.createElement("div");
    col.className = "card p-4 flex flex-col relative";
    
    if (hasPromo) {
      col.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : "";
    
    let payUseHTML = '';
    if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0 && it.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¹€à¸„à¸£à¸”à¸´à¸•:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">à¸¿${it.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸œà¹ˆà¸­à¸™:</span>
              <span class="font-semibold">à¸¿${it.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”:</span>
              <span class="font-semibold">${it.payUseInstallmentCount} à¸‡à¸§à¸”</span>
            </div>
          </div>
        </div>
      `;
    }
    
    col.innerHTML = `
      ${fireIcon}
      <img src="${it.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${it.name}" />'
      <h6 class="font-medium text-sm mb-1">${it.name}</h6>
      
      <!-- à¹à¸ªà¸”à¸‡à¸›à¸£à¸°à¹€à¸ à¸—à¸ªà¸´à¸™à¸„à¹‰à¸² -->
      <div class="text-xs text-gray-500 mb-2">
        <i class="bi bi-phone mr-1"></i>
        à¸›à¸£à¸°à¹€à¸ à¸—: à¸¡à¸·à¸­à¸–à¸·à¸­
      </div>
      
      ${payUseHTML}
      
      ${hasPromo ? '<p class="promotion-text">à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">à¸«à¸¢à¸´à¸šà¹ƒà¸ªà¹ˆà¸•à¸°à¸à¸£à¹‰à¸²</button>
    `;
    
    col.querySelector("button").addEventListener("click", () => addToCart(it));
    grid.appendChild(col);
  });
}

// à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸›à¸£à¸°à¹€à¸ à¸—à¸ªà¸´à¸™à¸„à¹‰à¸²
function validateMobileOnly() {
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸à¸£à¸­à¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸¡à¸·à¸­à¸–à¸·à¸­à¸­à¸­à¸à¸ˆà¸²à¸ productImages
  const beforeCount = productImages.length;
  
  productImages = productImages.filter(item => {
    // à¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸³à¸—à¸µà¹ˆà¸šà¹ˆà¸‡à¸šà¸­à¸à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸–à¸·à¸­
    const mobileKeywords = ['mobile', 'à¸¡à¸·à¸­à¸–à¸·à¸­', 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ', 'phone', 'smartphone'];
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š productType
    const typeCheck = mobileKeywords.some(keyword => 
      item.productType?.toLowerCase().includes(keyword)
    );
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š category
    const categoryCheck = mobileKeywords.some(keyword => 
      item.category?.toLowerCase().includes(keyword)
    );
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸² (à¹€à¸‰à¸žà¸²à¸°à¹à¸šà¸£à¸™à¸”à¹Œà¸¡à¸·à¸­à¸–à¸·à¸­à¸—à¸µà¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸)
    const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
    const nameCheck = mobileBrands.some(brand => 
      item.name?.toLowerCase().includes(brand)
    );
    
    return typeCheck || categoryCheck || nameCheck;
  });
  
  const afterCount = productImages.length;
  console.log(`ðŸ” Validated mobile products: ${afterCount} items (removed ${beforeCount - afterCount} non-mobile items)`);
}

// à¹à¸à¹‰à¹„à¸‚à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ renderSearchResult - à¹€à¸­à¸²à¸ªà¹ˆà¸§à¸™à¹à¸ªà¸”à¸‡à¸£à¸²à¸„à¸²à¸­à¸­à¸
function renderSearchResult(items) {
  document.getElementById("level1Container").classList.add("hidden");
  document.getElementById("level2Container").classList.add("hidden");
  document.getElementById("level3Container").classList.add("hidden");
  
  const container = document.getElementById("imeiResultContainer");
  const grid = document.getElementById("imeiResultGrid");
  container.classList.remove("hidden");
  grid.innerHTML = "";

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸´à¸™à¸„à¹‰à¸²</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
    
    const card = document.createElement("div");
    card.className = "card p-4 flex flex-col relative";
    
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : '';
    
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¹€à¸„à¸£à¸”à¸´à¸•:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">à¸¿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸œà¹ˆà¸­à¸™:</span>
              <span class="font-semibold">à¸¿${item.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} à¸‡à¸§à¸”</span>
            </div>
          </div>
        </div>
      `;
    }
    
    card.innerHTML = `
      ${fireIcon}
      <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />'
      <h6 class="font-medium text-sm mb-1">${item.name}</h6>
      
      ${payUseHTML}
      
      <!-- à¹€à¸­à¸²à¸ªà¹ˆà¸§à¸™à¹à¸ªà¸”à¸‡à¸£à¸²à¸„à¸²à¸­à¸­à¸à¹à¸¥à¹‰à¸§ -->
      
      ${hasPromo ? '<p class="promotion-text">à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">à¸«à¸¢à¸´à¸šà¹ƒà¸ªà¹ˆà¸•à¸°à¸à¸£à¹‰à¸²</button>
    `;
    
    card.querySelector("button").addEventListener("click", () => addToCart(item));
    grid.appendChild(card);
  });
}

    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
  // à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  const hasPromo = checkPromotionForProduct(item._id);
  
  // à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸³à¹€à¸™à¸² item à¸žà¸£à¹‰à¸­à¸¡à¹à¸™à¸šà¸„à¹ˆà¸² docFee à¹à¸¥à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
  const cartItem = {
    ...item,
    docFee: item.docFee || 0,
    taxRate: item.taxRate ?? 0,           
    taxType: item.taxType ?? 'à¹„à¸¡à¹ˆà¸¡à¸µ VAT',
    // ðŸ†• à¹€à¸žà¸´à¹ˆà¸¡ 3 à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰
    creditThreshold: item.creditThreshold || 0,
    payUseInstallmentCount: item.payUseInstallmentCount || 0,
    payUseInstallment: item.payUseInstallment || 0
  };

  // à¹€à¸žà¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸‚à¹‰à¸² cartItems
  cartItems.push(cartItem);
  hiddenProductIds.add(item._id);

  // à¸£à¸µà¹€à¸Ÿà¸£à¸Š UI
  renderCart();
  renderLevel3(currentLevel3Items);
  
  // à¹€à¸£à¸µà¸¢à¸à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  checkAvailablePromotions();
  
  // à¹à¸ªà¸”à¸‡ effect à¸–à¹‰à¸²à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  if (hasPromo) {
    const mainContent = document.getElementById('mainContent');
    createConfettiEffect(mainContent);
    showToast(`ðŸŽ‰ à¸¢à¸´à¸™à¸”à¸µà¸”à¹‰à¸§à¸¢! ${item.name} à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸žà¸´à¹€à¸¨à¸©!`, "success");
  } else {
    showToast(`âœ… à¹€à¸žà¸´à¹ˆà¸¡ ${item.name} à¸¥à¸‡à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²à¹à¸¥à¹‰à¸§`, "success");
  }

  // Removed check for selectedPlan and initManualTerms()
}

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    function renderCart() {
  console.log("=== renderCart called ===");"
  console.log("cartItems:", cartItems);
  
  const summaries = document.querySelectorAll(".cart-summary");
  if (!summaries.length) return;

  const currentStep = document.querySelector(".step-content.active")?.id;
  let html = "";

  if (cartItems.length === 0) {
    html = `<p class="text-gray-500">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²</p>`;
  } else if (currentStep === "step3") {
    html = document.querySelector("#step3 .cart-summary").innerHTML;
  } else {
    html = cartItems.map((it, idx) => {
      console.log(`Rendering item ${idx}:`, {
        name: it.name,
        creditThreshold: it.creditThreshold,
        pricePayOff: it.pricePayOff
      });
      
      const promo = appliedPromotions[it._id];
      const base = it.pricePayOff;
      
      let promoHTML = '';
      if (promo) {
        const disc = promo.type === 'percentage''
          ? base * (promo.discount / 100)
          : promo.discount;
        const newPrice = base - disc;
        
        promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">à¸¿${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">à¸¿${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-à¸¿${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
      }

      let payUseInfo = '';
      if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0) {
        payUseInfo = `
          <div class="text-xs text-blue-600 mt-1">
            <i class="bi bi-info-circle mr-1"></i>
            à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›: à¸¿${it.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™ x ${it.payUseInstallmentCount} à¸‡à¸§à¸”
          </div>
        `;
      }

      // à¹à¸ªà¸”à¸‡à¹€à¸„à¸£à¸”à¸´à¸•à¸«à¸£à¸·à¸­à¸£à¸²à¸„à¸²
      let priceDisplay = '';
      const displayPrice = it.creditThreshold > 0 ? it.creditThreshold : it.pricePayOff;
      const priceLabel = it.creditThreshold > 0 ? 'à¹€à¸„à¸£à¸”à¸´à¸•' : 'à¸£à¸²à¸„à¸²';
      
      // à¸„à¸³à¸™à¸§à¸“ VAT
      const rate = (it.taxRate || 7) / 100;
      const taxType = it.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ';
      let vatAmount = 0;
      
      if (taxType === 'à¹à¸¢à¸à¸ à¸²à¸©à¸µ') {
        vatAmount = displayPrice * rate;
      } else {
        vatAmount = displayPrice - (displayPrice / (1 + rate));
      }
      
      priceDisplay = `
        <div class="text-sm text-primary">${priceLabel}: à¸¿${displayPrice.toLocaleString()}</div>
        <div class="text-xs text-gray-500">VAT 7% ${taxType === 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ' ? '(à¸£à¸§à¸¡à¹à¸¥à¹‰à¸§) : ''}: à¸¿${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>'
      `;

      return `
        <div class="flex items-start gap-2 border-b py-2">
          <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />'
          <div class="flex-1">
            <div class="font-semibold">${it.name}</div>
            ${priceDisplay}
            ${payUseInfo}
            ${promoHTML}
          </div>
          <button class="btn btn-sm btn-error" data-index="${idx}">à¸¥à¸š</button>
        </div>
      `;
    }).join("");
  }
  
  console.log("HTML generated:", html.substring(0, 200) + "...");
  
  summaries.forEach(el => {
    el.innerHTML = html;
    el.querySelectorAll("button.btn-error").forEach(btn => {
      btn.addEventListener("click", () => {
        removeFromCart(parseInt(btn.dataset.index, 10));
      });
    });
  });
  
  // à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸£à¸¸à¸›à¸¢à¸­à¸”à¸–à¹‰à¸²à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ step 2
  if (currentStep === "step2") {
    updateStep2Summary();
  }
  
  if (cartItems.length > 0 && currentStep !== "step3") {
    checkAvailablePromotions();
  }
}

function calculateTotals() {
  let subtotal = 0;
  let totalVAT = 0;
  
  cartItems.forEach(item => {
    const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
    subtotal += itemPrice;
    
    const rate = (item.taxRate || 7) / 100;
    const taxType = item.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ';
    
    if (taxType === 'à¹à¸¢à¸à¸ à¸²à¸©à¸µ') {
      totalVAT += itemPrice * rate;
    } else {
      totalVAT += itemPrice - (itemPrice / (1 + rate));
    }
  });
  
  const shipping = parseFloat(document.getElementById('shippingFee')?.value || 0);
  const discount = parseFloat(document.getElementById('step2Discount')?.value || 0);
  const netTotal = subtotal - discount + shipping;
  
  const isInclusiveVAT = cartItems.every(item => !item.taxType || item.taxType === 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ');
  const grandTotal = isInclusiveVAT ? netTotal : netTotal + totalVAT;
  
  return {
    subtotal,
    discount,
    shipping,
    totalVAT,
    netTotal,
    grandTotal,
    isInclusiveVAT
  };
}

// à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸š input à¸•à¹ˆà¸²à¸‡à¹†
document.addEventListener('DOMContentLoaded', function() {
      const pageLoaderId = LoadingSystem.show({
        message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
  // à¸œà¸¹à¸ event à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸„à¹ˆà¸²
  ['shippingFee', 'step2Discount'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', updateStep2Summary);
    }
  });
  
  // à¸œà¸¹à¸ event à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²
  document.querySelectorAll('input[name="pickupMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const shippingContainer = document.getElementById('shippingFeeContainer');
      if (this.value === 'online') {
        shippingContainer?.classList.remove('hidden');
      } else {
        shippingContainer?.classList.add('hidden');
        const shippingInput = document.getElementById('shippingFee');
        if (shippingInput) {
          shippingInput.value = '0';
          updateStep2Summary();
        }
      }
    });
  });
});

// à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£ debug à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
function debugCartItems() {
  console.log("=== Debug Cart Items ===");"
  cartItems.forEach((item, idx) => {
    console.log(`Item ${idx}:`, {
      name: item.name,
      pricePayOff: item.pricePayOff,
      creditThreshold: item.creditThreshold,
      payUseInstallment: item.payUseInstallment,
      payUseInstallmentCount: item.payUseInstallmentCount
    });
  });
}

    /**
    * à¹€à¸­à¸²à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸„à¹‰à¸™à¸«à¸²à¹„à¸›à¹à¸ªà¸”à¸‡à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡ imeiResultContainer
    */
    function renderSearchResult(items) {
  document.getElementById("level1Container").classList.add("hidden");
  document.getElementById("level2Container").classList.add("hidden");
  document.getElementById("level3Container").classList.add("hidden");
  
  const container = document.getElementById("imeiResultContainer");
  const grid = document.getElementById("imeiResultGrid");
  container.classList.remove("hidden");
  grid.innerHTML = "";

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸´à¸™à¸„à¹‰à¸²</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
    
    const card = document.createElement("div");
    card.className = "card p-4 flex flex-col relative";
    
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : '';
    
    // à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¹€à¸„à¸£à¸”à¸´à¸•:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">à¸¿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸œà¹ˆà¸­à¸™:</span>
              <span class="font-semibold">à¸¿${item.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} à¸‡à¸§à¸”</span>
            </div>
          </div>
        </div>
      `;
    }
    
    card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />'
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  
  ${payUseHTML}
  
<div class="text-sm font-semibold text-primary mb-4">
  à¸¿${it.pricePayOff.toLocaleString()}
</div>
  ${hasPromo ? '<p class="promotion-text">à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">à¸«à¸¢à¸´à¸šà¹ƒà¸ªà¹ˆà¸•à¸°à¸à¸£à¹‰à¸²</button>
`;
    
    card.querySelector("button").addEventListener("click", () => addToCart(item));
    grid.appendChild(card);
  });
}


    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
  console.log("=== Adding to cart ===", {"
    name: item.name,
    pricePayOff: item.pricePayOff,
    creditThreshold: item.creditThreshold,
    payUseInstallmentCount: item.payUseInstallmentCount,
    payUseInstallment: item.payUseInstallment
  });
  
  // à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  const hasPromo = checkPromotionForProduct(item._id);
  
  // à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸³à¹€à¸™à¸² item à¸žà¸£à¹‰à¸­à¸¡à¹à¸™à¸šà¸„à¹ˆà¸² docFee à¹à¸¥à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
  const cartItem = {
    ...item,
    docFee: item.docFee || 0,
    taxRate: item.taxRate ?? 0,           
    taxType: item.taxType ?? 'à¹„à¸¡à¹ˆà¸¡à¸µ VAT',
    // *** à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸„à¹ˆà¸²à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¸–à¸¹à¸à¹€à¸à¹‡à¸š ***
    creditThreshold: item.creditThreshold || 0,
    payUseInstallmentCount: item.payUseInstallmentCount || 0,
    payUseInstallment: item.payUseInstallment || 0
  };

  console.log("=== Cart item created ===", cartItem);"

  // à¹€à¸žà¸´à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸‚à¹‰à¸² cartItems
  cartItems.push(cartItem);
  hiddenProductIds.add(item._id);

  // à¸£à¸µà¹€à¸Ÿà¸£à¸Š UI
  renderCart();
  renderLevel3(currentLevel3Items);
  
  // à¹€à¸£à¸µà¸¢à¸à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  checkAvailablePromotions();
  
  // à¹à¸ªà¸”à¸‡ effect à¸–à¹‰à¸²à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™
  if (hasPromo) {
    const mainContent = document.getElementById('mainContent');
    createConfettiEffect(mainContent);
    showToast(`ðŸŽ‰ à¸¢à¸´à¸™à¸”à¸µà¸”à¹‰à¸§à¸¢! ${item.name} à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸žà¸´à¹€à¸¨à¸©!`, "success");
  } else {
    showToast(`âœ… à¹€à¸žà¸´à¹ˆà¸¡ ${item.name} à¸¥à¸‡à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²à¹à¸¥à¹‰à¸§`, "success");
  }
}

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    // 1. à¹€à¸žà¸´à¹ˆà¸¡ console.log à¹€à¸žà¸·à¹ˆà¸­ debug
function renderCart() {
  console.log("=== renderCart called ===");"
  console.log("cartItems:", cartItems);
  
  const summaries = document.querySelectorAll(".cart-summary");
  if (!summaries.length) return;

  const currentStep = document.querySelector(".step-content.active")?.id;
  let html = "";

  if (cartItems.length === 0) {
    html = `<p class="text-gray-500">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸•à¸°à¸à¸£à¹‰à¸²</p>`;
  } else if (currentStep === "step3") {
    html = document.querySelector("#step3 .cart-summary").innerHTML;
  } else {
    html = cartItems.map((it, idx) => {
      console.log(`Rendering item ${idx}:`, {
        name: it.name,
        creditThreshold: it.creditThreshold,
        pricePayOff: it.pricePayOff
      });
      
      const promo = appliedPromotions[it._id];
      const base = it.pricePayOff;
      
      let promoHTML = '';
      if (promo) {
        const disc = promo.type === 'percentage''
          ? base * (promo.discount / 100)
          : promo.discount;
        const newPrice = base - disc;
        
        promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">à¸¿${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">à¸¿${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-à¸¿${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
      }

      let payUseInfo = '';
      if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0) {
        payUseInfo = `
          <div class="text-xs text-blue-600 mt-1">
            <i class="bi bi-info-circle mr-1"></i>
            à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›: à¸¿${it.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™ x ${it.payUseInstallmentCount} à¸‡à¸§à¸”
          </div>
        `;
      }

      // *** à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¹€à¸„à¸£à¸”à¸´à¸• ***
      let priceDisplay = '';
      if (it.creditThreshold && it.creditThreshold > 0) {
        console.log(`âœ… Using credit: ${it.creditThreshold}`);
        priceDisplay = `<div class="text-sm text-primary">à¹€à¸„à¸£à¸”à¸´à¸•: à¸¿${it.creditThreshold.toLocaleString()}</div>`;
      } else {
        console.log(`âŒ No credit, using price: ${it.pricePayOff}`);
        priceDisplay = `<div class="text-sm text-primary">à¸£à¸²à¸„à¸²: à¸¿${it.pricePayOff.toLocaleString()}</div>`;
      }

      return `
        <div class="flex items-start gap-2 border-b py-2">
          <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />'
          <div class="flex-1">
            <div class="font-semibold">${it.name}</div>
            ${priceDisplay}
            ${payUseInfo}
            ${promoHTML}
          </div>
          <button class="btn btn-sm btn-error" data-index="${idx}">à¸¥à¸š</button>
        </div>
      `;
    }).join("");
  }
  
  console.log("HTML generated:", html.substring(0, 200) + "...");
  
  summaries.forEach(el => {
    el.innerHTML = html;
    el.querySelectorAll("button.btn-error").forEach(btn => {
      btn.addEventListener("click", () => {
        removeFromCart(parseInt(btn.dataset.index, 10));
      });
    });
  });
  
  if (cartItems.length > 0 && currentStep !== "step3") {
    checkAvailablePromotions();
  }
}

// 2. à¸—à¸”à¸ªà¸­à¸šà¹‚à¸”à¸¢à¹€à¸£à¸µà¸¢à¸ renderCart à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡
setTimeout(() => {
  console.log("ðŸ”„ Force re-render cart after 2 seconds");
  renderCart();
}, 2000);

// 3. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸š debug cart items
window.debugCart = function() {
  console.table(cartItems.map(item => ({
    name: item.name,
    pricePayOff: item.pricePayOff,
    creditThreshold: item.creditThreshold,
    hasCredit: item.creditThreshold > 0
  })));
  renderCart();
};

    /**
    * à¹€à¸­à¸²à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸„à¹‰à¸™à¸«à¸²à¹„à¸›à¹à¸ªà¸”à¸‡à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡ imeiResultContainer
    */
    function renderSearchResult(items) {
  document.getElementById("level1Container").classList.add("hidden");
  document.getElementById("level2Container").classList.add("hidden");
  document.getElementById("level3Container").classList.add("hidden");
  
  const container = document.getElementById("imeiResultContainer");
  const grid = document.getElementById("imeiResultGrid");
  container.classList.remove("hidden");
  grid.innerHTML = "";

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸´à¸™à¸„à¹‰à¸²</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
    
    const card = document.createElement("div");
    card.className = "card p-4 flex flex-col relative";
    
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
    
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">ðŸ”¥</span>' : '';
    
    // à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¹€à¸„à¸£à¸”à¸´à¸•:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">à¸¿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸œà¹ˆà¸­à¸™:</span>
              <span class="font-semibold">à¸¿${item.payUseInstallment.toLocaleString()}/à¹€à¸”à¸·à¸­à¸™</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} à¸‡à¸§à¸”</span>
            </div>
          </div>
        </div>
      `;
    }
    
    card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />'
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  
  ${payUseHTML}
  
<div class="text-sm font-semibold text-primary mb-4">
  à¸¿${item.pricePayOff.toLocaleString()}
</div>
  ${hasPromo ? '<p class="promotion-text">à¸¡à¸µà¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">à¸«à¸¢à¸´à¸šà¹ƒà¸ªà¹ˆà¸•à¸°à¸à¸£à¹‰à¸²</button>
`;
    
    card.querySelector("button").addEventListener("click", () => addToCart(item));
    grid.appendChild(card);
  });
}


    // F) à¸„à¹‰à¸™à¸«à¸²à¸ªà¸´à¸™à¸„à¹‰à¸² (à¸Šà¸·à¹ˆà¸­à¸£à¸¸à¹ˆà¸™ à¸«à¸£à¸·à¸­ IMEI)
    async function searchItems() {
  const query = document.getElementById("productSearchQuery").value.trim();
  if (!query) {
    showToast("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸„à¸³à¸„à¹‰à¸™à¸«à¸²", "warning");
    return;
  }

  // à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸ productImages à¸—à¸µà¹ˆà¸à¸£à¸­à¸‡à¹€à¸‰à¸žà¸²à¸°à¸¡à¸·à¸­à¸–à¸·à¸­à¹à¸¥à¹‰à¸§
  const results = productImages.filter(item => {
    const matchName = item.name.toLowerCase().includes(query.toLowerCase());
    
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸–à¸·à¸­à¸ˆà¸£à¸´à¸‡à¹†
    const mobileKeywords = ['mobile', 'à¸¡à¸·à¸­à¸–à¸·à¸­', 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ', 'phone', 'smartphone'];
    const isMobile = mobileKeywords.some(keyword => 
      item.productType?.toLowerCase().includes(keyword) ||
      item.category?.toLowerCase().includes(keyword)
    );
    
    return matchName && isMobile;
  });

  if (results.length === 0) {
    showToast("à¹„à¸¡à¹ˆà¸žà¸šà¸¡à¸·à¸­à¸–à¸·à¸­à¸—à¸µà¹ˆà¸„à¹‰à¸™à¸«à¸²", "info");
  } else {
    showToast(`à¸žà¸šà¸¡à¸·à¸­à¸–à¸·à¸­ ${results.length} à¸£à¸¸à¹ˆà¸™`, "success");
  }

  renderSearchResult(results);
}


    // à¸œà¸¹à¸ event à¹ƒà¸«à¹‰à¸›à¸¸à¹ˆà¸¡ autoPrintYes
    // Removed event listener for btnAutoPrintYes

    // à¸œà¸¹à¸ event à¹ƒà¸«à¹‰à¸›à¸¸à¹ˆà¸¡ "à¸žà¸´à¸¡à¸žà¹Œà¹€à¸­à¸à¸ªà¸²à¸£"
    // Removed event listener for btnPrintPdf


    function resetSearch() {
      document.getElementById("productSearchQuery").value = "";
      document.getElementById("imeiResultContainer").classList.add("hidden");
      document.getElementById("level1Container").classList.remove("hidden");
      document.getElementById("level2Container").classList.add("hidden");
      document.getElementById("level3Container").classList.add("hidden");
    }

    async function loadActivePromotions() {
  try {
    showToast('ðŸ”„ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™...', 'info');
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/active', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const js = await res.json();
    if (js.status === 'success') {
      activePromotions = js.data.filter(p => {
        const now = new Date();
        const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
        const startOk  = new Date(p.startDate) <= now;
        const endOk    = new Date(p.endDate) >= now;
        const activeOk = p.isActive === true;
        const usageOk  = !p.usageLimit || (p.usageCount < p.usageLimit);
        return branchOk && startOk && endOk && activeOk && usageOk;
      });
      showToast(`âœ… à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${activePromotions.length} à¸£à¸²à¸¢à¸à¸²à¸£`, 'success');
    }
  } catch (err) {
    console.error('âŒ Error loading promotions:', err);
    activePromotions = [];
  }
}

function checkPromotionForProduct(productId) {
  console.log('ðŸ” Checking promotion for product:', productId);
  
  // à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²à¸ˆà¸²à¸ branchInstallments
  const stockItem = productImages.find(item => item._id === productId);
  if (!stockItem) {
    console.log('âŒ Stock item not found');
    return false;
  }
  
  console.log('ðŸ“¦ Stock item found:', {
    _id: stockItem._id,
    name: stockItem.name,
    brand: stockItem.brand
  });
  
  const hasPromo = activePromotions.some(p => {
    // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸ªà¸´à¸™à¸„à¹‰à¸² = à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸à¸±à¸šà¸—à¸¸à¸à¸ªà¸´à¸™à¸„à¹‰à¸²
    const allProducts = !p.applicableProducts || 
                       (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);
    
    if (allProducts) {
      console.log(`âœ… Promotion "${p.name}" applies to all products`);
      return true;
    }
    
    // à¹€à¸Šà¹‡à¸„à¸”à¹‰à¸§à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²
    let matchByName = false;
    if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchByName = p.applicableProducts.some(prod => {
        const stockName = stockItem.name.trim().toLowerCase();
        const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
        return stockName === promoProductName;
      });
    }
    
    // à¹€à¸Šà¹‡à¸„à¸”à¹‰à¸§à¸¢ Product ID (fallback)
    let matchById = false;
    if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchById = p.applicableProducts.some(prod => {
        const prodId = typeof prod === 'string' ? prod : prod._id;
        return prodId === productId;
      });
    }
    
    return allProducts || matchByName || matchById;
  });
  
  console.log('ðŸ”¥ Has promotion:', hasPromo);
  return hasPromo;
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸£à¸°à¸”à¸±à¸šà¹à¸šà¸£à¸™à¸”à¹Œ
function checkBrandHasPromotion(brandKey) {
  const brandProducts = productImages.filter(p => {
    const brand = p.brand || p.name.split(" ")[0];
    const key = brand.trim().toLowerCase();
    return key === brandKey;
  });
  
  return brandProducts.some(product => checkPromotionForProduct(product._id));
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸Šà¹‡à¸„à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸£à¸°à¸”à¸±à¸šà¸à¸¥à¸¸à¹ˆà¸¡
function checkGroupHasPromotion(groupItems) {
  return groupItems.some(item => checkPromotionForProduct(item._id));
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸£à¹‰à¸²à¸‡ Confetti Effect
function createConfettiEffect(element) {
  const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
  const confettiCount = 30;
  
  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-10px';
    confetti.style.opacity = '1';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    confetti.style.transition = 'all 1s ease-out';
    
    element.appendChild(confetti);
    
    setTimeout(() => {
      confetti.style.top = '100%';
      confetti.style.opacity = '0';
      confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
    }, 10);
    
    setTimeout(() => confetti.remove(), 1000);
  }
}

async function checkAvailablePromotions() {
  if (!cartItems.length) {
    appliedPromotions = {};
    return;
  }
  try {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    const ids = [...new Set(cartItems.map(i => i._id))];
    const res = await fetch('/api/promotion/check-available', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+token,Content-Type':'application/json' },
      body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    if (js.status === 'success') displayAvailablePromotions(js.data);
  } catch (err) {
    console.error('âŒ Error checking promotions:', err);
    appliedPromotions = {};
  }
}

function displayAvailablePromotions(data) {
  appliedPromotions = {};
  cartItems.forEach(item => {
    const promos = data[item._id] || [];
    if (promos.length) {
      const best = promos.reduce((b,p) => {
        const val = p.type === 'percentage''
          ? item.pricePayOff * (p.discount/100)
          : p.type === 'fixed''
            ? p.discount
            : 0;
        const bval = b.type === 'percentage''
          ? item.pricePayOff * (b.discount/100)
          : b.type === 'fixed''
            ? b.discount
            : 0;
        return val > bval ? p : b;
      });
      appliedPromotions[item._id] = best;
    }
  });
  renderCart();
}

function calculatePromotionDiscount() {
  let totalDiscount = 0, details = [];
  Object.entries(appliedPromotions).forEach(([pid,promo]) => {
    const item = cartItems.find(i=>i._id===pid);
    if (!item) return;
    const disc = promo.type === 'percentage''
      ? item.pricePayOff * (promo.discount/100)
      : promo.type === 'fixed''
        ? promo.discount
        : 0;
    totalDiscount += disc;
    details.push({ name: promo.name, discount: disc, productName: item.name });
  });
  return { totalDiscount, details };
}

async function recordPromotionUsage(promotionId) {
  try {
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/use', {
      method: 'POST',
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json' '
      },
      body: JSON.stringify({ promotionId })
    });
    const js = await res.json();
    if (js.status !== 'success') {
      console.error('Failed to record promotion usage:', js.message);
    }
  } catch (err) {
    console.error('Error recording promotion usage:', err);
  }
}

    // =========================== I) CAMERA & SIGNATURE ===========================
    function setupIDCamera() {
      const btnStart = document.getElementById("btnStartIdCamera");
      const btnCapture = document.getElementById("btnCaptureId");
      const btnRetake = document.getElementById("btnRetakeId");
      const container = document.getElementById("idCaptureContainer");
      const canvas = document.getElementById("idCanvas");
      // const inputData = document.getElementById("idImageData"); // Likely removed
      const inputUrl = document.getElementById("idCardImageUrl"); // Keep if still used for storing URL
      let idStream = null;

      // If essential elements are missing, don't proceed with setup'
      if (!btnStart || !btnCapture || !btnRetake || !container || !canvas || !inputUrl) {
        console.warn("ID Camera elements not found, skipping setup.");
        return;
      }

      // à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡
      btnStart.addEventListener("click", async () => {
        try {
          idStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          const video = container.querySelector("video"); // Assuming video element is dynamically added or exists
          if (video) {
            video.srcObject = idStream;
            await video.play();
            btnCapture.disabled = false;
          } else {
            console.error("Video element for ID camera not found in container.");
            showToast("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸•à¸£à¸µà¸¢à¸¡à¸à¸¥à¹‰à¸­à¸‡à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™", "error");
          }
        } catch (err) {
          console.error("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡:", err);
          showToast("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸•à¸£à¸µà¸¢à¸¡à¸à¸¥à¹‰à¸­à¸‡à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™", "error");
        }
      });

      // à¸–à¹ˆà¸²à¸¢à¸£à¸¹à¸›à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”
      btnCapture.addEventListener("click", async () => {
        const video = container.querySelector("video");
        if (!video) {
            console.error("Video element for ID capture not found.");
            return;
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL("image/jpeg", 0.9);
        // if (inputData) inputData.value = dataURL; // Keep if inputData exists

        // preview
        // Ensure container is robust enough or this part is conditional
        if (container.innerHTML.includes('<video')) { // Basic check'
            container.innerHTML = `<img src="${dataURL}" class="w-full h-full object-contain rounded" alt="ID Preview"/>`;
        }
        if(idStream) idStream.getTracks().forEach(t => t.stop());
        btnStart.classList.add("hidden");
        btnCapture.classList.add("hidden");
        btnRetake.classList.remove("hidden");

        try {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const url = await uploadFile(
            blob,
            '/api/upload/id-card',
            'file',
            'id-card.jpg''
          );
          if (inputUrl) inputUrl.value = url;
          showToast('à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
        } catch (err) {
          console.error("Upload ID card failed:", err);
          showToast('à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + err.message, 'error');
        }
      });

      // à¸–à¹ˆà¸²à¸¢à¹ƒà¸«à¸¡à¹ˆ
      btnRetake.addEventListener("click", () => {
        // This part heavily depends on the specific HTML structure for the video container
        // It's safer to make it conditional or ensure the elements exist'
        const videoContainerHTML = `
          <video id="idVideo" autoplay playsinline muted
                 class="absolute inset-0 w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <img src="/uploads/à¸šà¸±à¸•à¸£.png"
                 class="w-full h-full object-contain pointer-events-none"
                 alt="ID template overlay"/>
          </div>`;
        // Check if container can be reset this way
        if (document.getElementById('idVideo')) { // Example check'
            container.innerHTML = videoContainerHTML;
        } else {
            console.warn("Cannot reset ID camera view, video container structure might have changed.");
        }
        btnStart.classList.remove("hidden");
        btnCapture.classList.remove("hidden");
        btnRetake.classList.add("hidden");
      });
    }
    function setupSelfieCamera() {
      const btnStart = document.getElementById("btnStartSelfie");
      const btnCapture = document.getElementById("btnCaptureSelfie");
      const video = document.getElementById("selfieVideo");
      const canvas = document.getElementById("selfieCanvas");
      // const inputData = document.getElementById("selfieDataURL"); // Likely removed
      const inputUrl = document.getElementById("selfieUrl"); // Keep if used
      let selfieStream = null;

      if (!btnStart || !btnCapture || !video || !canvas || !inputUrl) {
        console.warn("Selfie camera elements not found, skipping setup.");
        return;
      }

      btnStart.addEventListener("click", async () => {
        try {
          selfieStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } }
          });
          video.srcObject = selfieStream;
          await video.play();
          video.classList.remove("hidden");
          btnCapture.disabled = false;
        } catch (err) {
          console.warn("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡à¸«à¸¥à¸±à¸‡, à¸¥à¸­à¸‡à¸à¸¥à¹‰à¸­à¸‡à¸«à¸™à¹‰à¸²:", err);
          try {
            selfieStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = selfieStream;
            await video.play();
            video.classList.remove("hidden");
            btnCapture.disabled = false;
            showToast("à¸ªà¸¥à¸±à¸šà¹„à¸›à¸à¸¥à¹‰à¸­à¸‡à¸«à¸™à¹‰à¸² (fallback)", "warning");
          } catch (err2) {
            console.error("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ:", err2);
            showToast("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ", "error");
            btnStart.disabled = true;
          }
        }
      });

      btnCapture.addEventListener("click", async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        // const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
        // if(inputData) inputData.value = dataUrl;
        canvas.classList.remove("hidden");

        try {
          let blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
          // if (!blob && dataUrl) { // Fallback if toBlob returns null
          //   const res = await fetch(dataUrl);
          //   blob = await res.blob();
          // }
          if (blob) {
            const url = await uploadFile(
              blob,
              '/api/upload/selfie',
              'file',
              'selfie.jpg''
            );
            if (inputUrl) inputUrl.value = url;
            showToast('à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
          } else {
            showToast('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¹‰à¸²à¸‡ blob à¸ˆà¸²à¸ selfie canvas', 'error');
          }
        } catch (err) {
          console.error("Upload selfie failed:", err);
          showToast('à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + err.message, 'error');
        } finally {
          if (selfieStream) {
            selfieStream.getTracks().forEach(track => track.stop());
            selfieStream = null;
          }
          btnCapture.disabled = true;
          btnStart.disabled = false;
        }
      });
    }

    function setupSignaturePad() {
      const canvasEl = document.getElementById("signaturePad");
      if (canvasEl) {
        const ctx = canvasEl.getContext("2d");
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data = signaturePad ? signaturePad.toData() : []; // Check if signaturePad exists
          canvasEl.width = canvasEl.offsetWidth * ratio;
          canvasEl.height = canvasEl.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          if (signaturePad) {
            signaturePad.clear();
            signaturePad.fromData(data);
          }
        }
        window.addEventListener("resize", resizeCanvas);
        signaturePad = new SignaturePad(canvasEl, {
          backgroundColor: "rgba(255,255,255,0)", penColor: "black",
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeCanvas();
        const btnClearSignature = document.getElementById("btnClearSignature");
        const btnSaveSignature = document.getElementById("btnSaveSignature");
        if (btnClearSignature) btnClearSignature.addEventListener("click", () => signaturePad.clear());
        if (btnSaveSignature) {
          btnSaveSignature.addEventListener("click", () => {
            if (!signaturePad.isEmpty()) {
              const signatureData = signaturePad.toDataURL();
              document.getElementById("customerSignatureData").value = signatureData;
              showToast("à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¹‰à¸§", "success");
            } else {
              showToast("à¸à¸£à¸¸à¸“à¸²à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸à¹ˆà¸­à¸™", "warning");
            }
          });
        }
      } else {
        console.warn("Customer signature pad canvas not found.");
      }
    }

    function setupEmployeeSignaturePad() {
      const empCanvas = document.getElementById("employeeSignaturePad");
      if (empCanvas) {
        const empCtx = empCanvas.getContext("2d");
        function resizeEmpCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data2 = empPad ? empPad.toData() : []; // Check if empPad exists
          empCanvas.width = empCanvas.offsetWidth * ratio;
          empCanvas.height = empCanvas.offsetHeight * ratio;
          empCtx.scale(ratio, ratio);
          if (empPad) {
            empPad.clear();
            empPad.fromData(data2);
          }
        }
        window.addEventListener("resize", resizeEmpCanvas);
        empPad = new SignaturePad(empCanvas, {
          backgroundColor: "rgba(255,255,255,0)", penColor: "black",
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeEmpCanvas();
        const btnClearEmpSignature = document.getElementById("btnClearEmpSignature");
        const btnSaveEmpSignature = document.getElementById("btnSaveEmpSignature");
        if (btnClearEmpSignature) btnClearEmpSignature.addEventListener("click", () => empPad.clear());
        if (btnSaveEmpSignature) {
          btnSaveEmpSignature.addEventListener("click", () => {
            if (!empPad.isEmpty()) {
              const empSignatureData = empPad.toDataURL();
              document.getElementById("employeeSignatureData").value = empSignatureData;
              showToast("à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§", "success");
            } else {
              showToast("à¸à¸£à¸¸à¸“à¸²à¹€à¸‹à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸à¹ˆà¸­à¸™", "warning");
            }
          });
        }
      } else {
        console.warn("Employee signature pad canvas not found.");
      }
    }



    // =========================== J) MISC ACTIONS (Dark, ToggleMenu, Logout) ===========================
    function toggleDarkMode() {
      const htmlEl = document.documentElement;
      const label = document.getElementById("darkModeLabel");
      if (htmlEl.classList.contains("dark")) {
        htmlEl.classList.remove("dark");
        if (label) label.textContent = "Dark Mode";
      } else {
        htmlEl.classList.add("dark");
        if (label) label.textContent = "Light Mode";
      }
    }
    function logout() {
    // à¸¥à¸š token à¹à¸¥à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ session à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
    localStorage.removeItem('authToken');
    // à¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¸·à¹ˆà¸™à¹† à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¹„à¸”à¹‰ à¸«à¸²à¸à¸¡à¸µà¸†
    // à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹„à¸›à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸² login
    window.location.href = '/login';
}
    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
      
      sb.classList.toggle('-translate-x-full');
      mc.classList.toggle('ml-64');
      mc.classList.toggle('ml-0');
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }
    function togglePlan2Detail() {
      const plan2Detail = document.querySelector(".plan2-detail");
      const plan2Radio = document.getElementById("plan2");
      if (plan2Detail && plan2Radio) {
        plan2Detail.style.display = plan2Radio.checked ? "block" : "none";
      }
    }



    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const pageLoaderId = LoadingSystem.show({
          message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
          showProgress: true,
          autoProgress: true,
          spinnerType: 'default'
        });
        
        // 1) à¸ªà¸£à¹‰à¸²à¸‡ Sidebar (à¸ˆà¸° inject à¸›à¸¸à¹ˆà¸¡ btnToggleMenu, btnLogout, btnToggleDark, #employeeName/#employeePhoto à¸¥à¸‡ DOM)
        // à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹‚à¸”à¸¢à¸•à¸£à¸‡
        await loadEmployeeProfile();
        await loadActivePromotions();

        // Dark mode setup
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
        }

        // Event listeners
        document.getElementById('btnToggleMenu').addEventListener('click', toggleMenu);
        document.getElementById('btnToggleDark').addEventListener('click', toggleDarkMode);
        document.getElementById('btnLogout').addEventListener('click', logout);

        // 2) à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸™à¸±à¸à¸‡à¸²à¸™ (à¸•à¸­à¸™à¸™à¸µà¹‰ Sidebar DOM à¸žà¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§)
        await loadEmployeeProfile();

        // 3) à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸·à¹ˆà¸™ à¹† à¹€à¸Šà¹ˆà¸™ à¹‚à¸«à¸¥à¸”à¸ªà¸•à¹‡à¸­à¸, branch, bind events...
        await loadBranchInstallments();
        await loadBranchInfo();
        loadLevel1();

       // 4) à¸œà¸¹à¸ Event à¸›à¸¸à¹ˆà¸¡à¸«à¸¥à¸±à¸ à¹†
       document.getElementById("btnToggleMenu")?.addEventListener("click", toggleMenu);
       document.getElementById("btnToggleDark")?.addEventListener("click", toggleDarkMode);
       document.getElementById("btnLogout")?.addEventListener("click", logout);
       document.getElementById('step2Discount').addEventListener('input', updateStep2Summary);
       document.querySelectorAll('input[name="pickupMethod"]').forEach(r => r.addEventListener('change', updateStep2Summary));

       // Step navigation
       document.getElementById("btnStep1ToStep2")?.addEventListener("click", () => goToStep(2));
       document.getElementById("btnStep2ToStep1")?.addEventListener("click", () => goToStep(1));
       
       // à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰ (à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸œà¸¹à¸à¹ƒà¸«à¹‰à¸„à¸¥à¸´à¸à¹à¸¥à¹‰à¸§à¹„à¸› step à¸—à¸µà¹ˆà¸•à¹ˆà¸³à¸à¸§à¹ˆà¸²à¹„à¸”à¹‰)
       document.querySelectorAll(".step").forEach(el => {
         el.style.cursor = "pointer";
         el.addEventListener("click", () => {
           const target = Number(el.getAttribute("data-step"));
           const current = Number(document.querySelector(".step.active").getAttribute("data-step"));
           if (target <= current) {
             goToStep(target);
           }
         });
       });

       // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸à¸«à¸¥à¸±à¸‡à¸à¸²à¸£à¸‚à¸²à¸¢
       async function checkStockAfterSale() {
         try {
           const token = localStorage.getItem("authToken");
           
           for (const item of cartItems) {
             const res = await fetch(`/api/branch-stock/${item._id}`, {
               headers: { "Authorization": "Bearer " + token }
             });
             
             const data = await res.json();
             
             if (data.success) {
               console.log(`à¸ªà¸•à¹‡à¸­à¸à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸‚à¸­à¸‡ ${item.name}:`, data.data?.stock_value || 0);
             }
           }
         } catch (err) {
           console.error("Error checking stock:", err);
         }
       }

        // Step2 -> à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸™à¸­à¸£à¸²à¸„à¸² à¹à¸¥à¸°à¹€à¸›à¸´à¸” modal
        document.getElementById("btnStep2OpenModal").addEventListener("click", async () => {
          try {
            // à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
            const prefix = document.getElementById("customerPrefix").value || "";
            const firstName = document.getElementById("customerFirstName").value || "";
            const lastName = document.getElementById("customerLastName").value || "";
            const customerName = `${prefix}${firstName} ${lastName}`.trim();
            
            // à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
            const address = {
              houseNo: document.getElementById("houseNo").value,
              moo: document.getElementById("moo").value,
              subDistrict: document.getElementById("subDistrict").value,
              district: document.getElementById("district").value,
              province: document.getElementById("province").value,
              zipcode: document.getElementById("zipcode").value
            };
            
            // à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸² - à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
            const items = cartItems.map(item => {
              const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
              return {
                product: item._id,
                description: item.name,
                quantity: 1,
                unitPrice: itemPrice,  // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
                totalPrice: itemPrice, // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
                taxRate: item.taxRate || 7,
                taxType: item.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ',
                // à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
                creditThreshold: item.creditThreshold || 0,
                payUseInstallmentCount: item.payUseInstallmentCount || 0,
                payUseInstallment: item.payUseInstallment || 0
              };
            });
            
            // à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸” - à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹ƒà¸™à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“
            const subtotal = items.reduce((sum, i) => sum + i.totalPrice, 0);
            const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
            const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
            
            // à¸ªà¸£à¹‰à¸²à¸‡ payload
            const payload = {
              type: "PAYOFF_RECEIPT",
              planType: "plan3",
              installmentType: "à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡",
              date: new Date().toISOString(),
              branchCode: BRANCH_CODE,
              customer: {
                customerType: 'individual',
                individual: {
                  prefix: prefix,
                  firstName: firstName,
                  lastName: lastName,
                  phone: document.getElementById("customerPhone").value,
                  email: document.getElementById("customerEmail").value,
                  taxId: document.getElementById("customerIdCard").value,
                  address: address,
                  socialContact: {
                    facebook: '',
                    line: '',
                    mapLocation: ''
                  }
                },
                name: customerName,
                fullAddress: `${address.houseNo} à¸«à¸¡à¸¹à¹ˆ ${address.moo} à¸•.${address.subDistrict} à¸­.${address.district} à¸ˆ.${address.province} ${address.zipcode}`.trim()
              },
              items: items,
              summary: {
                subtotal: subtotal,
                shipping: shipping,
                discount: discount,
                netTotal: subtotal + shipping - discount
              },
              pickupMethod: document.querySelector('input[name="pickupMethod"]:checked')?.value || 'store',
              paymentMethod: document.querySelector('input[name="payType"]:checked')?.value || 'à¹€à¸‡à¸´à¸™à¸ªà¸”',
              // à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™
              customerSignatureUrl: document.getElementById('customerSignatureUrl').value,
              salespersonSignatureUrl: document.getElementById('salespersonSignatureUrl').value,
              salespersonName: window.employeeName || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'
            };
            
            // à¹€à¸£à¸µà¸¢à¸ API à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ
            const res = await fetch('/api/receipt', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
              },
              body: JSON.stringify(payload)
            });
            
            const js = await res.json();
            if (!js.success) throw new Error(js.error || js.message);
            
            // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ
            window.currentInvoiceId = js.data._id;
            window.currentInvoiceNumber = js.data.invoiceNumber;
            
            showToast('à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'success');
            
            // à¹„à¸› step 3 (à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™)
            goToStep(3);
            
          } catch (err) {
            console.error('Error:', err);
            showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + err.message, 'error');
          }
        });

        // 4) à¸œà¸¹à¸ Event à¸„à¹‰à¸™à¸«à¸²
        document.getElementById("btnProductSearch")?.addEventListener("click", searchItems);
        document.getElementById("btnProductReset")?.addEventListener("click", resetSearch);

        // 5) à¸à¸¥à¹‰à¸­à¸‡ + à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™
        setupIDCamera();
        setupSelfieCamera();
        setupSignaturePad();
        setupEmployeeSignaturePad();

        // 6) à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™
        const incomeProofInput = document.getElementById('incomeProof');
        if (incomeProofInput) {
          incomeProofInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
              try {
                const url = await uploadFile(file, '/api/upload/income-proof', 'file', file.name);
                document.getElementById('salarySlipUrl').value = url;
                showToast('à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
              } catch (err) {
                console.error('Upload income proof failed:', err);
                showToast('à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + err.message, 'error');
              }
            }
          });
        }
        // à¸›à¸¸à¹ˆà¸¡ Back à¹ƒà¸™ Level2/3
        document.getElementById("btnBackToLevel1")?.addEventListener("click", () => {
          document.getElementById("level1Container").classList.remove("hidden");
          document.getElementById("level2Container").classList.add("hidden");
          document.getElementById("level3Container").classList.add("hidden");
        });
        document.getElementById("btnBackToLevel2")?.addEventListener("click", () => {
          document.getElementById("level2Container").classList.remove("hidden");
          document.getElementById("level3Container").classList.add("hidden");
        });

        // --- à¸ˆà¸±à¸”à¸à¸²à¸£à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸² à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸¢à¸­à¸”à¹ƒà¸™ STEP2 ---
        const step2SummaryEl = document.querySelector('#step2 .cart-summary');
        const pickupRadios = document.querySelectorAll('input[name="pickupMethod"]');
        const shippingFeeContainer = document.getElementById('shippingFeeContainer');
        const shippingFeeInput = document.getElementById('shippingFee');
        const documentFeeInput = document.getElementById('documentFee');

        function updateStep2Summary() {
          let totalPrice = 0;
          let totalVAT = 0;

          cartItems.forEach(item => {
            // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡ à¸–à¹‰à¸²à¸¡à¸µ
            const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
            totalPrice += itemPrice;
            
            // à¸„à¸³à¸™à¸§à¸“ VAT 7% (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ taxRate à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ 7% à¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™)
            const rate = (item.taxRate || 7) / 100;
            const taxType = item.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ';
            
            if (taxType === 'à¹à¸¢à¸à¸ à¸²à¸©à¸µ') {
              // à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸² + VAT
              totalVAT += itemPrice * rate;
            } else {
              // à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¸§à¸¡ VAT à¹à¸¥à¹‰à¸§ à¸•à¹‰à¸­à¸‡à¹à¸¢à¸ VAT à¸­à¸­à¸à¸¡à¸²
              totalVAT += itemPrice - (itemPrice / (1 + rate));
            }
          });

          const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
          const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
          
          // à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´
          const subtotal = totalPrice;
          const afterDiscount = subtotal - discount;
          const netTotal = afterDiscount + shipping;
          
          // à¸–à¹‰à¸²à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¸§à¸¡ VAT à¹à¸¥à¹‰à¸§ à¸¢à¸­à¸”à¸£à¸§à¸¡à¸„à¸·à¸­ netTotal
          // à¸–à¹‰à¸²à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸¢à¸ VAT à¸¢à¸­à¸”à¸£à¸§à¸¡à¸„à¸·à¸­ netTotal + totalVAT
          let grandTotal = netTotal;
          let vatDisplay = totalVAT;
          
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸£à¸²à¸„à¸²à¸£à¸§à¸¡ VAT à¸«à¸£à¸·à¸­à¹à¸¢à¸ VAT
          const isInclusiveVAT = cartItems.every(item => !item.taxType || item.taxType === 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ');
          
          if (!isInclusiveVAT) {
            // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸£à¸²à¸„à¸²à¹à¸¢à¸ VAT à¸•à¹‰à¸­à¸‡à¸šà¸§à¸ VAT à¹€à¸‚à¹‰à¸²à¹„à¸›
            grandTotal = netTotal + totalVAT;
          }

          const lines = [
            `<div class="flex justify-between"><span>à¸¢à¸­à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²:</span><span>à¸¿${subtotal.toLocaleString()}</span></div>`,
            discount > 0 ? `<div class="flex justify-between text-green-600"><span>à¸ªà¹ˆà¸§à¸™à¸¥à¸”:</span><span>-à¸¿${discount.toLocaleString()}</span></div>` : '',
            shipping > 0 ? `<div class="flex justify-between"><span>à¸„à¹ˆà¸²à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡:</span><span>à¸¿${shipping.toLocaleString()}</span></div>` : '',
            `<div class="flex justify-between"><span>à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´:</span><span>à¸¿${netTotal.toLocaleString()}</span></div>`,
            `<div class="flex justify-between text-sm text-gray-600"><span>VAT 7% ${isInclusiveVAT ? '(à¸£à¸§à¸¡à¹ƒà¸™à¸£à¸²à¸„à¸²à¹à¸¥à¹‰à¸§) : ''}:</span><span>à¸¿${vatDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`,
            `<hr class="my-2 border-gray-300">`,
            `<div class="flex justify-between font-bold text-lg"><span>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸ªà¸´à¹‰à¸™:</span><span class="text-blue-600">à¸¿${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`
          ].filter(line => line); // à¸à¸£à¸­à¸‡ line à¸—à¸µà¹ˆà¸§à¹ˆà¸²à¸‡à¸­à¸­à¸

          const el = document.querySelector('#step2 .cart-summary');
          if (el) {
            el.innerHTML = lines.join('');
          }
        }

      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }
    });

    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const pageLoaderId = LoadingSystem.show({
          message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
          showProgress: true,
          autoProgress: true,
          spinnerType: 'default'
        });
        
        // 1) à¸ªà¸£à¹‰à¸²à¸‡ Sidebar (à¸ˆà¸° inject à¸›à¸¸à¹ˆà¸¡ btnToggleMenu, btnLogout, btnToggleDark, #employeeName/#employeePhoto à¸¥à¸‡ DOM)
        // à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹‚à¸”à¸¢à¸•à¸£à¸‡
        await loadEmployeeProfile();
        await loadActivePromotions();

        // Dark mode setup
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
          document.documentElement.classList.add('dark');
        }

        // Event listeners
        document.getElementById('btnToggleMenu').addEventListener('click', toggleMenu);
        document.getElementById('btnToggleDark').addEventListener('click', toggleDarkMode);
        document.getElementById('btnLogout').addEventListener('click', logout);

        // 2) à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸™à¸±à¸à¸‡à¸²à¸™ (à¸•à¸­à¸™à¸™à¸µà¹‰ Sidebar DOM à¸žà¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§)
        await loadEmployeeProfile();

        // 3) à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸·à¹ˆà¸™ à¹† à¹€à¸Šà¹ˆà¸™ à¹‚à¸«à¸¥à¸”à¸ªà¸•à¹‡à¸­à¸, branch, bind events...
        await loadBranchInstallments();
        await loadBranchInfo();
        loadLevel1();

       // 4) à¸œà¸¹à¸ Event à¸›à¸¸à¹ˆà¸¡à¸«à¸¥à¸±à¸ à¹†
       document.getElementById("btnToggleMenu")?.addEventListener("click", toggleMenu);
       document.getElementById("btnToggleDark")?.addEventListener("click", toggleDarkMode);
       document.getElementById("btnLogout")?.addEventListener("click", logout);
       document.getElementById('step2Discount').addEventListener('input', updateStep2Summary);
       document.querySelectorAll('input[name="pickupMethod"]').forEach(r => r.addEventListener('change', updateStep2Summary));

       // Step navigation
       document.getElementById("btnStep1ToStep2")?.addEventListener("click", () => goToStep(2));
       document.getElementById("btnStep2ToStep1")?.addEventListener("click", () => goToStep(1));
       
       // à¸ªà¹ˆà¸§à¸™à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰ (à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸œà¸¹à¸à¹ƒà¸«à¹‰à¸„à¸¥à¸´à¸à¹à¸¥à¹‰à¸§à¹„à¸› step à¸—à¸µà¹ˆà¸•à¹ˆà¸³à¸à¸§à¹ˆà¸²à¹„à¸”à¹‰)
       document.querySelectorAll(".step").forEach(el => {
         el.style.cursor = "pointer";
         el.addEventListener("click", () => {
           const target = Number(el.getAttribute("data-step"));
           const current = Number(document.querySelector(".step.active").getAttribute("data-step"));
           if (target <= current) {
             goToStep(target);
           }
         });
       });

       // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸à¸«à¸¥à¸±à¸‡à¸à¸²à¸£à¸‚à¸²à¸¢
       async function checkStockAfterSale() {
         try {
           const token = localStorage.getItem("authToken");
           
           for (const item of cartItems) {
             const res = await fetch(`/api/branch-stock/${item._id}`, {
               headers: { "Authorization": "Bearer " + token }
             });
             
             const data = await res.json();
             
             if (data.success) {
               console.log(`à¸ªà¸•à¹‡à¸­à¸à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸‚à¸­à¸‡ ${item.name}:`, data.data?.stock_value || 0);
             }
           }
         } catch (err) {
           console.error("Error checking stock:", err);
         }
       }

        // Step2 -> à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸™à¸­à¸£à¸²à¸„à¸² à¹à¸¥à¸°à¹€à¸›à¸´à¸” modal
        document.getElementById("btnStep2OpenModal").addEventListener("click", async () => {
          try {
            // à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
            const prefix = document.getElementById("customerPrefix").value || "";
            const firstName = document.getElementById("customerFirstName").value || "";
            const lastName = document.getElementById("customerLastName").value || "";
            const customerName = `${prefix}${firstName} ${lastName}`.trim();
            
            // à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
            const address = {
              houseNo: document.getElementById("houseNo").value,
              moo: document.getElementById("moo").value,
              subDistrict: document.getElementById("subDistrict").value,
              district: document.getElementById("district").value,
              province: document.getElementById("province").value,
              zipcode: document.getElementById("zipcode").value
            };
            
            // à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸² - à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
            const items = cartItems.map(item => {
              const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
              return {
                product: item._id,
                description: item.name,
                quantity: 1,
                unitPrice: itemPrice,  // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
                totalPrice: itemPrice, // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡
                taxRate: item.taxRate || 7,
                taxType: item.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ',
                // à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›
                creditThreshold: item.creditThreshold || 0,
                payUseInstallmentCount: item.payUseInstallmentCount || 0,
                payUseInstallment: item.payUseInstallment || 0
              };
            });
            
            // à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸” - à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹ƒà¸™à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“
            const subtotal = items.reduce((sum, i) => sum + i.totalPrice, 0);
            const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
            const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
            
            // à¸ªà¸£à¹‰à¸²à¸‡ payload
            const payload = {
              type: "PAYOFF_RECEIPT",
              planType: "plan3",
              installmentType: "à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡",
              date: new Date().toISOString(),
              branchCode: BRANCH_CODE,
              customer: {
                customerType: 'individual',
                individual: {
                  prefix: prefix,
                  firstName: firstName,
                  lastName: lastName,
                  phone: document.getElementById("customerPhone").value,
                  email: document.getElementById("customerEmail").value,
                  taxId: document.getElementById("customerIdCard").value,
                  address: address,
                  socialContact: {
                    facebook: '',
                    line: '',
                    mapLocation: ''
                  }
                },
                name: customerName,
                fullAddress: `${address.houseNo} à¸«à¸¡à¸¹à¹ˆ ${address.moo} à¸•.${address.subDistrict} à¸­.${address.district} à¸ˆ.${address.province} ${address.zipcode}`.trim()
              },
              items: items,
              summary: {
                subtotal: subtotal,
                shipping: shipping,
                discount: discount,
                netTotal: subtotal + shipping - discount
              },
              pickupMethod: document.querySelector('input[name="pickupMethod"]:checked')?.value || 'store',
              paymentMethod: document.querySelector('input[name="payType"]:checked')?.value || 'à¹€à¸‡à¸´à¸™à¸ªà¸”',
              // à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™
              customerSignatureUrl: document.getElementById('customerSignatureUrl').value,
              salespersonSignatureUrl: document.getElementById('salespersonSignatureUrl').value,
              salespersonName: window.employeeName || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'
            };
            
            // à¹€à¸£à¸µà¸¢à¸ API à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ
            const res = await fetch('/api/receipt', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
              },
              body: JSON.stringify(payload)
            });
            
            const js = await res.json();
            if (!js.success) throw new Error(js.error || js.message);
            
            // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ
            window.currentInvoiceId = js.data._id;
            window.currentInvoiceNumber = js.data.invoiceNumber;
            
            showToast('à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'success');
            
            // à¹„à¸› step 3 (à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™)
            goToStep(3);
            
          } catch (err) {
            console.error('Error:', err);
            showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + err.message, 'error');
          }
        });

        // 4) à¸œà¸¹à¸ Event à¸„à¹‰à¸™à¸«à¸²
        document.getElementById("btnProductSearch")?.addEventListener("click", searchItems);
        document.getElementById("btnProductReset")?.addEventListener("click", resetSearch);

        // 5) à¸à¸¥à¹‰à¸­à¸‡ + à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™
        setupIDCamera();
        setupSelfieCamera();
        setupSignaturePad();
        setupEmployeeSignaturePad();

        // 6) à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™
        const incomeProofInput = document.getElementById('incomeProof');
        if (incomeProofInput) {
          incomeProofInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
              try {
                const url = await uploadFile(file, '/api/upload/income-proof', 'file', file.name);
                document.getElementById('salarySlipUrl').value = url;
                showToast('à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
              } catch (err) {
                console.error('Upload income proof failed:', err);
                showToast('à¸­à¸±à¸žà¹‚à¸«à¸¥à¸”à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + err.message, 'error');
              }
            }
          });
        }
        // à¸›à¸¸à¹ˆà¸¡ Back à¹ƒà¸™ Level2/3
        document.getElementById("btnBackToLevel1")?.addEventListener("click", () => {
          document.getElementById("level1Container").classList.remove("hidden");
          document.getElementById("level2Container").classList.add("hidden");
          document.getElementById("level3Container").classList.add("hidden");
        });
        document.getElementById("btnBackToLevel2")?.addEventListener("click", () => {
          document.getElementById("level2Container").classList.remove("hidden");
          document.getElementById("level3Container").classList.add("hidden");
        });

        // --- à¸ˆà¸±à¸”à¸à¸²à¸£à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸£à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸² à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸¢à¸­à¸”à¹ƒà¸™ STEP2 ---
        const step2SummaryEl = document.querySelector('#step2 .cart-summary');
        const pickupRadios = document.querySelectorAll('input[name="pickupMethod"]');
        const shippingFeeContainer = document.getElementById('shippingFeeContainer');
        const shippingFeeInput = document.getElementById('shippingFee');
        const documentFeeInput = document.getElementById('documentFee');

        function updateStep2Summary() {
          let totalPrice = 0;
          let totalVAT = 0;

          cartItems.forEach(item => {
            // à¹ƒà¸Šà¹‰à¹€à¸„à¸£à¸”à¸´à¸•à¹à¸—à¸™à¸£à¸²à¸„à¸²à¹€à¸•à¹‡à¸¡ à¸–à¹‰à¸²à¸¡à¸µ
            const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
            totalPrice += itemPrice;
            
            // à¸„à¸³à¸™à¸§à¸“ VAT 7% (à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ taxRate à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ 7% à¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™)
            const rate = (item.taxRate || 7) / 100;
            const taxType = item.taxType || 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ';
            
            if (taxType === 'à¹à¸¢à¸à¸ à¸²à¸©à¸µ') {
              // à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸² + VAT
              totalVAT += itemPrice * rate;
            } else {
              // à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¸§à¸¡ VAT à¹à¸¥à¹‰à¸§ à¸•à¹‰à¸­à¸‡à¹à¸¢à¸ VAT à¸­à¸­à¸à¸¡à¸²
              totalVAT += itemPrice - (itemPrice / (1 + rate));
            }
          });

          const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
          const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
          
          // à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´
          const subtotal = totalPrice;
          const afterDiscount = subtotal - discount;
          const netTotal = afterDiscount + shipping;
          
          // à¸–à¹‰à¸²à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¸£à¸§à¸¡ VAT à¹à¸¥à¹‰à¸§ à¸¢à¸­à¸”à¸£à¸§à¸¡à¸„à¸·à¸­ netTotal
          // à¸–à¹‰à¸²à¸£à¸²à¸„à¸²à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸¢à¸ VAT à¸¢à¸­à¸”à¸£à¸§à¸¡à¸„à¸·à¸­ netTotal + totalVAT
          let grandTotal = netTotal;
          let vatDisplay = totalVAT;
          
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸£à¸²à¸„à¸²à¸£à¸§à¸¡ VAT à¸«à¸£à¸·à¸­à¹à¸¢à¸ VAT
          const isInclusiveVAT = cartItems.every(item => !item.taxType || item.taxType === 'à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ');
          
          if (!isInclusiveVAT) {
            // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸£à¸²à¸„à¸²à¹à¸¢à¸ VAT à¸•à¹‰à¸­à¸‡à¸šà¸§à¸ VAT à¹€à¸‚à¹‰à¸²à¹„à¸›
            grandTotal = netTotal + totalVAT;
          }

          const lines = [
            `<div class="flex justify-between"><span>à¸¢à¸­à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²:</span><span>à¸¿${subtotal.toLocaleString()}</span></div>`,
            discount > 0 ? `<div class="flex justify-between text-green-600"><span>à¸ªà¹ˆà¸§à¸™à¸¥à¸”:</span><span>-à¸¿${discount.toLocaleString()}</span></div>` : '',
            shipping > 0 ? `<div class="flex justify-between"><span>à¸„à¹ˆà¸²à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡:</span><span>à¸¿${shipping.toLocaleString()}</span></div>` : '',
            `<div class="flex justify-between"><span>à¸¢à¸­à¸”à¸ªà¸¸à¸—à¸˜à¸´:</span><span>à¸¿${netTotal.toLocaleString()}</span></div>`,
            `<div class="flex justify-between text-sm text-gray-600"><span>VAT 7% ${isInclusiveVAT ? '(à¸£à¸§à¸¡à¹ƒà¸™à¸£à¸²à¸„à¸²à¹à¸¥à¹‰à¸§) : ''}:</span><span>à¸¿${vatDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`,
            `<hr class="my-2 border-gray-300">`,
            `<div class="flex justify-between font-bold text-lg"><span>à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸ªà¸´à¹‰à¸™:</span><span class="text-blue-600">à¸¿${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`
          ].filter(line => line); // à¸à¸£à¸­à¸‡ line à¸—à¸µà¹ˆà¸§à¹ˆà¸²à¸‡à¸­à¸­à¸

          const el = document.querySelector('#step2 .cart-summary');
          if (el) {
            el.innerHTML = lines.join('');
          }
        }

      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }
    });
</script>
  
  <!-- Display Fixes Script -->
  <script>
    // 1. à¹à¸à¹‰à¹„à¸‚ CSS à¸ªà¸³à¸«à¸£à¸±à¸š step-content
    const fixStepContentCSS = () => {
      // à¸¥à¸š CSS rule à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰ step4 à¸¡à¸µ background à¹à¸›à¸¥à¸à¹†
      const style = document.createElement('style');
      style.textContent = `
        /* Reset step content styles */
        .step-content {
          display: none;
          background-color: transparent !important;
        }
        
        .step-content.active {
          display: block !important;
          min-height: auto;
        }
        
        /* à¸›à¸£à¸±à¸š main content à¹ƒà¸«à¹‰ responsive */
        #mainContent {
          transition: margin-left 0.3s ease-in-out;
        }
        
        /* à¹€à¸¡à¸·à¹ˆà¸­ sidebar à¸–à¸¹à¸à¸‹à¹ˆà¸­à¸™ */
        #mainContent.sidebar-collapsed {
          margin-left: 0 !important;
        }
        
        /* à¸¥à¸šà¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸µà¹€à¸—à¸²à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ */
        main {
          background-color: transparent !important;
          min-height: calc(100vh - 80px); /* à¸¥à¸šà¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¸‚à¸­à¸‡ header */
        }
        
        /* à¸›à¸£à¸±à¸š card container */
        .card {
          background-color: #ffffff;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark .card {
          background-color: #2a2a2a;
          border-color: #555;
        }
      `;
      document.head.appendChild(style);
    };

    // 2. à¹à¸à¹‰à¹„à¸‚à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ toggleMenu à¹ƒà¸«à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£ margin à¸‚à¸­à¸‡ mainContent
    function fixToggleMenu() {
      const toggleMenu = () => {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');
        
        sidebar.classList.toggle('-translate-x-full');
        mainContent.classList.toggle('ml-64');
        mainContent.classList.toggle('ml-0');
        icon.classList.toggle('bi-chevron-left');
        icon.classList.toggle('bi-chevron-right');
      };
      
      // à¹à¸—à¸™à¸—à¸µà¹ˆ event listener à¹€à¸”à¸´à¸¡
      const btnToggle = document.getElementById('btnToggleMenu');
      if (btnToggle) {
        btnToggle.removeEventListener('click', window.toggleMenu);
        btnToggle.addEventListener('click', toggleMenu);
        window.toggleMenu = toggleMenu;
      }
    }

    // 3. à¹à¸à¹‰à¹„à¸‚à¸à¸²à¸£ restore sidebar state
    function fixSidebarRestore() {
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
      
      if (sidebarCollapsed) {
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.add('sidebar-collapsed');
        mainContent.style.marginLeft = '0';
        icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
      } else {
        sidebar.classList.remove('-translate-x-full');
        mainContent.classList.remove('sidebar-collapsed');
        mainContent.style.marginLeft = '14rem';
        icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
      }
    }

    // 4. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥à¸‚à¸­à¸‡ containers
    function fixContainerDisplay() {
      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² step content à¸—à¸µà¹ˆ active à¹à¸ªà¸”à¸‡à¸œà¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
      const activeStep = document.querySelector('.step-content.active');
      if (!activeStep) {
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ active step à¹ƒà¸«à¹‰à¹€à¸‹à¹‡à¸•à¹€à¸›à¹‡à¸™ step 1
        const step1 = document.getElementById('step1');
        if (step1) {
          step1.classList.add('active');
        }
      }
      
      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š level containers
      const level1Container = document.getElementById('level1Container');
      const level2Container = document.getElementById('level2Container');
      const level3Container = document.getElementById('level3Container');
      const imeiResultContainer = document.getElementById('imeiResultContainer');
      
      // à¸‹à¹ˆà¸­à¸™ containers à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸„à¸§à¸£à¹à¸ªà¸”à¸‡
      if (level2Container && !level2Container.querySelector('#level2Grid').children.length) {
        level2Container.classList.add('hidden');
      }
      if (level3Container && !level3Container.querySelector('#level3Grid').children.length) {
        level3Container.classList.add('hidden');
      }
      if (imeiResultContainer && !imeiResultContainer.querySelector('#imeiResultGrid').children.length) {
        imeiResultContainer.classList.add('hidden');
      }
    }

    // 5. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸à¹‰à¹„à¸‚à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    function applyFixes() {
      // 1. à¹à¸à¹‰à¹„à¸‚ CSS
      fixStepContentCSS();
      
      // 2. à¹à¸à¹‰à¹„à¸‚ toggle menu
      fixToggleMenu();
      
      // 3. Restore sidebar state à¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
      fixSidebarRestore();
      
      // 4. à¹à¸à¹‰à¹„à¸‚à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥ containers
      fixContainerDisplay();
      
      // 5. à¸¥à¸š background à¸ªà¸µà¹€à¸—à¸²à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸•à¸´à¸”à¸¡à¸²à¸ˆà¸²à¸ CSS à¹€à¸à¹ˆà¸²
      const main = document.querySelector('main');
      if (main) {
        main.style.backgroundColor = 'transparent';
        main.style.minHeight = 'calc(100vh - 80px);
      }
      
      console.log('âœ… Applied all display fixes');
    }

    // à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­ DOM à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyFixes);
    } else {
      const pageLoaderId = LoadingSystem.show({
        message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      });
      
      try {
      applyFixes();
    }

    // Export à¸ªà¸³à¸«à¸£à¸±à¸šà¹ƒà¸Šà¹‰à¸‡à¸²à¸™
    window.applyInstallmentFixes = applyFixes;
  
}</script>

  <!-- Customer Search & Card Reader Script -->
  <script>
    // à¸•à¸±à¸§à¹à¸›à¸£à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 à¸§à¸´à¸™à¸²à¸—à¸µ

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸²
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');
      
      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™', 'warning');
        } else {
          alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™');
        }
        return;
      }

      // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ (13 à¸«à¸¥à¸±à¸)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 13 à¸«à¸¥à¸±à¸', 'warning');
        } else {
          alert('à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 13 à¸«à¸¥à¸±à¸');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²à¸­à¸¢à¸¹à¹ˆ à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`à¸à¸£à¸¸à¸“à¸²à¸£à¸­ ${remaining} à¸§à¸´à¸™à¸²à¸—à¸µ à¸à¹ˆà¸­à¸™à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸«à¸¡à¹ˆ`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;

      try {
        if (typeof showToast === 'function') {
          showToast('à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json''
          }
        });

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š status code à¸à¹ˆà¸­à¸™ parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('ðŸš« à¸„à¸³à¸‚à¸­à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸” à¸à¸£à¸¸à¸“à¸²à¸£à¸­ 30 à¸§à¸´à¸™à¸²à¸—à¸µ', 'error');
          }
          // à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸§à¸¥à¸² cooldown à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸ˆà¸­ 429
          lastSearchTime = Date.now() + 27000; // à¸šà¸¥à¹‡à¸­à¸à¹€à¸žà¸´à¹ˆà¸¡à¸­à¸µà¸ 27 à¸§à¸´à¸™à¸²à¸—à¸µ (à¸£à¸§à¸¡ 30 à¸§à¸´à¸™à¸²à¸—à¸µ)
          
          resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <p class="text-sm font-medium">à¸„à¸³à¸‚à¸­à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸”</p>
              <p class="text-xs text-gray-400 mt-1">à¸à¸£à¸¸à¸“à¸²à¸£à¸­ 30 à¸§à¸´à¸™à¸²à¸—à¸µ à¸à¹ˆà¸­à¸™à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸«à¸¡à¹ˆ</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // à¹€à¸ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸² - à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');
          
          if (typeof showToast === 'function') {
            showToast('à¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²', 'success');
          }
        } else {
          // à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²
          resultsList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              <i class="bi bi-person-x text-2xl mb-2 block"></i>
              <p class="text-sm">à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸²</p>
              <p class="text-xs text-gray-400">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™: ${searchValue}</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          
          if (typeof showToast === 'function') {
            showToast('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸²', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);
        
        let errorMessage = 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²';
        if (error.message.includes('429')) {
          errorMessage = 'à¸„à¸³à¸‚à¸­à¹€à¸à¸´à¸™à¸‚à¸µà¸”à¸ˆà¸³à¸à¸±à¸” à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹„à¸”à¹‰';
        }

        resultsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
            <p class="text-sm font-medium">${errorMessage}</p>
            <p class="text-xs text-gray-400 mt-1">à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
        
        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
      }
    }

    // à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');
      
      // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸žà¸š
      resultsList.innerHTML = `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
             onclick="selectCustomer('${customerData._id}, '${customerData.contactPhone || ''})">'
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${customerData.displayName || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­'}</h4>'
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <i class="bi bi-credit-card mr-1"></i>
                à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™: ${customerData.contactPhone || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">
                <i class="bi bi-telephone mr-1"></i>
                à¹‚à¸—à¸£: ${customerData.contactPhone || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'}
              </p>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">'
                  ${customerData.isNewCustomer ? 'à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ' : 'à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¹ˆà¸²'}
                </span>
                <span class="text-xs text-gray-500">
                  à¸‹à¸·à¹‰à¸­à¸¡à¸²à¹à¸¥à¹‰à¸§ ${customerData.totalPurchases || 0} à¸„à¸£à¸±à¹‰à¸‡
                </span>
              </div>
            </div>
            <div class="text-right">
              <button class="btn btn-sm btn-primary">
                <i class="bi bi-check-circle mr-1"></i>
                à¹€à¸¥à¸·à¸­à¸
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // à¹€à¸¥à¸·à¸­à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¸°à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡
    async function selectCustomer(customerId, taxId) {
      try {
        if (typeof showToast === 'function') {
          showToast('à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/${customerId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json''
          }
        });

        const result = await response.json();

        if (result.success && result.data) {
          const customer = result.data;
          
          // à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡
          fillCustomerForm(customer);
          
          // à¸‹à¹ˆà¸­à¸™à¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²
          document.getElementById('customerSearchResults').classList.add('hidden');
          document.getElementById('customerSearch').value = '';
          
          if (typeof showToast === 'function') {
            showToast('à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
          }
        } else {
          throw new Error(result.message || 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰');
        }

      } catch (error) {
        console.error('Select customer error:', error);
        if (typeof showToast === 'function') {
          showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + error.message, 'error');
        } else {
          alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + error.message);
        }
      }
    }

    // à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸¥à¸‡à¹ƒà¸™à¸Ÿà¸­à¸£à¹Œà¸¡
    function fillCustomerForm(customer) {
      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;
        
        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸·à¹‰à¸™à¸à¸²à¸™
        document.getElementById('customerPrefix').value = individual.prefix || '';
        document.getElementById('customerFirstName').value = individual.firstName || '';
        document.getElementById('customerLastName').value = individual.lastName || '';
        document.getElementById('customerIdCard').value = individual.taxId || individual.idCard || '';
        document.getElementById('customerPhone').value = individual.phone || '';
        document.getElementById('customerEmail').value = individual.email || '';
        
        // à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || '';
        }
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸•à¸±à¸”à¸„à¸³à¸§à¹ˆà¸² "à¸«à¸¡à¸¹à¹ˆà¸—à¸µà¹ˆ", "à¸«à¸¡à¸¹à¹ˆ", "à¸•à¸³à¸šà¸¥", "à¸­à¸³à¹€à¸ à¸­", "à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”" à¸­à¸­à¸ (à¸–à¹‰à¸²à¸¡à¸µ)
    function removeLocalityPrefix(str) {
      if (!str) return "";
      let result = str.trim();
      result = result.replace(/^à¸«à¸¡à¸¹à¹ˆà¸—à¸µà¹ˆ\s*/i, "").replace(/^à¸«à¸¡à¸¹à¹ˆ\s*/i, "");
      result = result.replace(/^à¸•à¸³à¸šà¸¥\s*/i, "");
      result = result.replace(/^à¸­à¸³à¹€à¸ à¸­\s*/i, "");
      result = result.replace(/^à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”\s*/i, "");
      return result.trim();
    }

    function removePrefixes(str) {
      if (!str) return "";
      return str.trim();
    }

    // à¸­à¹ˆà¸²à¸™à¸šà¸±à¸•à¸£ à¸›à¸Šà¸Š.
    async function readCard() {
      console.log("readCard() à¸–à¸¹à¸à¹€à¸£à¸µà¸¢à¸à¹à¸¥à¹‰à¸§");
      try {
        const resp = await fetch("http://localhost:3999/read-card");
        const js = await resp.json();
        if (!resp.ok || !js.success) {
          if (typeof showToast === 'function') {
            showToast("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¹„à¸”à¹‰: " + (js.error || "unknown"), "error");
          } else {
            alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¹„à¸”à¹‰: " + (js.error || "unknown"));
          }
          return;
        }
        const d = js.data;
        document.getElementById("customerPrefix").value = d.TitleTh || "";
        document.getElementById("customerFirstName").value = d.FirstNameTh || "";
        document.getElementById("customerLastName").value = d.LastNameTh || "";
        document.getElementById("customerIdCard").value = d.Citizenid || "";

        const addr = (d.Address || "").split("#").filter((a) => a.trim());
        document.getElementById("houseNo").value = removePrefixes(addr[0] || "");
        document.getElementById("moo").value = removeLocalityPrefix(addr[1] || "");
        document.getElementById("subDistrict").value = removeLocalityPrefix(addr[2] || "");
        document.getElementById("district").value = removeLocalityPrefix(addr[3] || "");
        document.getElementById("province").value = removeLocalityPrefix(addr[4] || "");
        document.getElementById("zipcode").value = removePrefixes(addr[5] || "");

        if (typeof showToast === 'function') {
          showToast("à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");
        } else {
          alert("à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
        }
      } catch (err) {
        if (typeof showToast === 'function') {
          showToast(`Error: ${err.message}`, "error");
        } else {
          alert(`Error: ${err.message}`);
        }
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const pageLoaderId = LoadingSystem.show({
        message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
      // à¸›à¸¸à¹ˆà¸¡à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // à¸›à¸¸à¹ˆà¸¡à¸­à¹ˆà¸²à¸™à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™
      const btnReadCard = document.getElementById('btnReadCard');
      if (btnReadCard) {
        btnReadCard.addEventListener('click', readCard);
      }

      // à¸Šà¹ˆà¸­à¸‡à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¹à¸à¸„à¹‰à¸² - à¸à¸” Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // à¸„à¹‰à¸™à¸«à¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹€à¸¡à¸·à¹ˆà¸­à¸žà¸´à¸¡à¸žà¹Œà¸„à¸£à¸š 13 à¸«à¸¥à¸±à¸
        customerSearch.addEventListener('input', function(e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // à¸‹à¹ˆà¸­à¸™à¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¹€à¸¡à¸·à¹ˆà¸­à¸žà¸´à¸¡à¸žà¹Œà¹„à¸¡à¹ˆà¸„à¸£à¸š 13 à¸«à¸¥à¸±à¸
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });
  
}</script>
  </main>
  
  <!-- à¹€à¸žà¸´à¹ˆà¸¡ JavaScript à¸ªà¸³à¸«à¸£à¸±à¸šà¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸² -->
  <script>
    // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²
    async function loadBranchInfo() {
      try {
        const branchCode = BRANCH_CODE;
        const token = localStorage.getItem("authToken") || "";
        
        // à¹€à¸£à¸µà¸¢à¸ /api/branch à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡ list à¸ªà¸²à¸‚à¸²
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const js = await res.json();
        if (res.ok && js.success) {
          // à¸«à¸² record à¸—à¸µà¹ˆà¸•à¸£à¸‡à¸à¸±à¸š branch_code
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            document.getElementById("branchInfo").textContent =
              `${branch.name} â€” ${branch.address}`;
            // à¸­à¸±à¸žà¹€à¸”à¸— title à¸‚à¸­à¸‡à¸«à¸™à¹‰à¸²à¸”à¹‰à¸§à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸²à¸ˆà¸£à¸´à¸‡
            document.title = `à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸› - ${branch.name}`;
            document.getElementById("pageTitle").textContent = `à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸› - ${branch.name}`;
            return;
          }
        }
        throw new Error("à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²");
      } catch (err) {
        console.warn("loadBranchInfo error:", err);
        document.getElementById("branchInfo").textContent =
          "à¸ªà¸²à¸‚à¸²: (à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥)";
      }
    }
    
    // à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ loadBranchInfo à¹€à¸¡à¸·à¹ˆà¸­ DOM à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ
    document.addEventListener('DOMContentLoaded', function() {
      const pageLoaderId = LoadingSystem.show({
        message: 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š...',
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
      loadBranchInfo();
      
      // à¸­à¸±à¸žà¹€à¸”à¸— title à¸ˆà¸²à¸ URL parameter
      const branchName = urlParams.get('name');
      if (branchName) {
        document.title = `à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™ - à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸› - ${decodeURIComponent(branchName)}`;
      }
    });
  
}</script>

  <!-- Loading Animation Functions -->
  <script>
    let installmentOnuseLottieAnimation = null;

    function showInstallmentOnuseLoading() {
      try {
        const overlay = document.getElementById('installmentOnuseLoadingOverlay');
        const container = document.getElementById('installmentOnuseLottieContainer');

        if (!overlay || !container) {
          console.warn('[InstallmentOnuse] Loading elements not found');
          return;
        }

        overlay.classList.remove('animate__fadeOut');
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';

        // Initialize Lottie animation if not already done
        if (!installmentOnuseLottieAnimation) {
          installmentOnuseLottieAnimation = lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://lottie.host/4db68bbd-31f6-4cd8-b6a5-2cea9a7d3ec2/qBuDuHr0pB.json'
          });

          installmentOnuseLottieAnimation.addEventListener('error', () => {
            console.warn('[InstallmentOnuse] Lottie animation failed to load');
            container.innerHTML = '<div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>';
          });
        }

        console.log('[InstallmentOnuse] Loading overlay shown');
      } catch (error) {
        console.error('[InstallmentOnuse] Error showing loading:', error);
      }
    }

    function hideInstallmentOnuseLoading() {
      try {
        const overlay = document.getElementById('installmentOnuseLoadingOverlay');

        if (!overlay) {
          console.warn('[InstallmentOnuse] Loading overlay not found');
          return;
        }

        overlay.classList.add('animate__fadeOut');

        setTimeout(() => {
          overlay.style.display = 'none';
          overlay.style.opacity = '0';
          overlay.style.visibility = 'hidden';
        }, 300);

        console.log('[InstallmentOnuse] Loading overlay hidden');
      } catch (error) {
        console.error('[InstallmentOnuse] Error hiding loading:', error);
      }
    }

    // Auto-hide loading when page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[InstallmentOnuse] DOM Content Loaded');

      // Hide loading after a short delay to ensure all resources are loaded
      setTimeout(() => {
        hideInstallmentOnuseLoading();
      }, 1000);
    });

    // Show loading when navigating away
    window.addEventListener('beforeunload', function() {
      showInstallmentOnuseLoading();
    });

    // Initial loading state
    document.addEventListener('readystatechange', function() {
      if (document.readyState === 'complete') {
        setTimeout(() => {
          hideInstallmentOnuseLoading();
        }, 500);
      }
    });
  </script>
</body>


