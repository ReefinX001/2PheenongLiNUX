<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="/js/activity-tracker.js"></script>
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } }
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] }
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />
  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@latest/dist/signature_pad.umd.min.js"></script>
  <!-- Added Socket.IO client library and global socket declaration -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Sidebar Component -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <script>
    // ‚úÖ Enhanced Global Error Handling
    window.addEventListener('error', (event) => {
      console.error('üö® Global Error:', event.error);
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('üö® Unhandled Promise Rejection:', event.reason);
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
      }
      event.preventDefault();
    });

    // ‚úÖ Network Status Monitor - ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    let isOnline = navigator.onLine;
    
    function updateNetworkStatus(online) {
      isOnline = online;
      const networkStatus = document.getElementById('networkStatus');
    
      if (networkStatus) {
        if (online) {
          networkStatus.className = 'flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-700 transition-all duration-300';
          networkStatus.innerHTML = `
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-xs font-medium">Online</span>
          `;
        } else {
          networkStatus.className = 'flex items-center gap-2 px-3 py-1 rounded-full bg-red-100 text-red-700 transition-all duration-300';
          networkStatus.innerHTML = `
            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
            <span class="text-xs font-medium">Offline</span>
          `;
        }
      }
    }
    
    window.addEventListener('online', () => {
      updateNetworkStatus(true);
      if (typeof showToast === 'function') {
        showToast('üåê ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }
    });
    
    window.addEventListener('offline', () => {
      updateNetworkStatus(false);
      if (typeof showToast === 'function') {
        showToast('üì° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
      }
    });

    // ‚úÖ Enhanced Socket.IO Setup
    let socket;
    if (typeof io === 'function') {
      socket = io({
        timeout: 10000,
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 2000
      });

      socket.on('connect', () => {
        console.log('‚úÖ Socket.IO ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      });

      socket.on('connect_error', err => {
        console.warn('‚ö†Ô∏è Socket.IO connect error:', err);
        setTimeout(() => {
          if (!socket.connected && typeof showToast === 'function') {
            showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ real-time ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥', 'warning');
          }
        }, 5000);
      });

      // ================== REAL-TIME PRICE UPDATE LISTENER ==================
      socket.on('updatePricing', (data) => {
        console.log('üì° ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö real-time:', data);
    
        // ‡πÅ‡∏™‡∏î‡∏á notification
        if (typeof showToast === 'function') {
          showToast('üìã ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', 'info');
        }
    
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        setTimeout(async () => {
          console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà...');
    
          try {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
            await loadBranchInstallments();
    
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
            const currentStep = document.querySelector('.step-content.active');
            if (currentStep && currentStep.id === 'step1') {
              // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï step 1 ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
              const level1Container = document.getElementById('level1Container');
              const level2Container = document.getElementById('level2Container');
              const level3Container = document.getElementById('level3Container');
    
              if (!level1Container.classList.contains('hidden')) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Level 1
                await loadLevel1();
                console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Level 1 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
              } else if (!level2Container.classList.contains('hidden')) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Level 2 - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÄ‡∏î‡∏¥‡∏°
                const currentBrand = document.getElementById('level2Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ', '');
                const brandKey = currentBrand.toLowerCase();
                loadLevel2(brandKey, currentBrand);
                console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Level 2 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
              } else if (!level3Container.classList.contains('hidden')) {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Level 3 - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°
                const currentGroup = document.getElementById('level3Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ', '');
                if (window.level2Groups && window.level2Groups[currentGroup]) {
                  renderLevel3(window.level2Groups[currentGroup]);
                  console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Level 3 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
              }
            }
    
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (typeof updateCartPricing === 'function') {
              updateCartPricing();
            }
    
            console.log('üéØ Real-time price update ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
    
            if (typeof showToast === 'function') {
              showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
    
          } catch (error) {
            console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤:', error);
            if (typeof showToast === 'function') {
              showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
          }
        }, 500); // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ backend ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
      });
    
      console.log('üì° Real-time pricing update listener ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    } else {
      console.warn('Socket.IO script ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î ‚Äî ‡πÇ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ');
    }
  </script>


  
  <!-- Custom CSS -->
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --info: #560bad;
      --light-bg: #f5f7fa;
      --dark-text: #212529;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á Customer / Meta */
    .pdf-header-grid {
      display: flex;
      justify-content: space-between;
      background: #eaf7ff;
      padding: 8pt;
      margin-bottom: 12pt;
    }

    .pdf-box {
      width: 48%;
      border: 1pt solid #008cff;
      padding: 6pt;
      background: #ffffff;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .pdf-table th {
      background: #008cff;
      color: #ffffff;
    }

    /* Totals area */
    .pdf-totals-grid {
      display: flex;
      justify-content: space-between;
      background: #eaf7ff;
      padding: 8pt;
      margin-top: 12pt;
    }

    .pdf-amount-words {
      width: 60%;
      font-size: 12pt;
    }

    .pdf-grandbox {
      width: 35%;
      background: #cce8ff;
      padding: 6pt;
      text-align: right;
      font-size: 12pt;
    }

    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà signature */
    .pdf-sign-row .pdf-sign-box {
      border-top: 1pt dashed #000000;
      padding-top: 6pt;
      width: 30%;
      text-align: center;
    }


    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f5f7fa !important;
      margin: 0;
      padding: 0;
      color: #212529;
    }

    .dark body {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }

    aside.collapsed .ml-3 {
      display: none;
    }

    /* ===== MINIMAL CARD STYLES - WHITE/GRAY THEME ===== */
    .card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 16px !important;
      padding: 1.5rem !important;
      margin-bottom: 1rem !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      color: #374151 !important;
      backdrop-filter: blur(10px) !important;
      width: 100%;
      box-sizing: border-box;
    }

    .card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }

    /* Dark mode card styles */
    .dark .card {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }

    .dark .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
    }

    /* Card text alignment */
    .card h6,
    .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }

    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }

    .dark .card p {
      color: #9ca3af !important;
    }

    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      color: #212529;
    }

    .dark .card-header {
      background-color: #2a2a2a;
    }

    .card-header i {
      margin-right: 10px;
    }

    /* Enhanced styles for better UX */


    /* Error state for inputs */
    .input-error {
      border-color: #ef4444 !important;
      background-color: #fee !important;
      box-shadow: 0 0 0 1px #ef4444 !important;
    }

    /* Toast container */
    #toastContainer {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    /* Loading animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4361ee;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Better button states */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Improved focus styles */
    button:focus,
    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .card {
        padding: 1rem !important;
        border-radius: 12px !important;
      }

      .pdf-header-grid,
      .pdf-totals-grid {
        flex-direction: column;
        gap: 8pt;
      }

      .pdf-box,
      .pdf-amount-words,
      .pdf-grandbox {
        width: 100%;
      }
    }

    /* Print styles */
    @media print {
      .no-print {
        display: none !important;
      }

      .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
    }

    /* ========== STEPPER STYLES ========== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: #4361ee;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }

    .step.active .step-icon {
      background: #4361ee;
      color: white;
      transform: scale(1.1);
    }

    .step.completed .step-icon {
      background: #10b981;
      color: white;
    }

    .step-text {
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      text-align: center;
      transition: all 0.3s ease;
    }

    .step.active .step-text {
      color: #4361ee;
      font-weight: 600;
    }

    .step.completed .step-text {
      color: #10b981;
    }

    /* Step content */
    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Product card */
    .product-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      transform: translateY(-7px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: #f5f7fa;
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* üî• Fire Icon Animation */
/* üî• Fire Icon Animation */
.promo-fire-icon {
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 32px;
  z-index: 30;
  animation: fireScaleGlow 1.5s ease-in-out infinite;
}

@keyframes fireScaleGlow {
  0%, 100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
  }
  50% {
    transform: scale(1.3);
    filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1))
            drop-shadow(0 0 35px rgba(255, 100, 0, 0.8))
            drop-shadow(0 0 45px rgba(255, 69, 0, 0.6));
  }
}

/* Card with promotion */
.card.has-promotion {
  position: relative;
  overflow: visible !important;
}

/* Override card overflow for promotion icons */
#level1Grid .card,
#level2Grid .card,
#level3Grid .card {
  overflow: visible !important;
}

/* Confetti styles */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 1000;
}
    /* Remove the following CSS rules */
    
    /* ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô sidebar */
    /* Removed: #sidebar ul li a { color: #333333 !important; } */

    /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
    /* Removed: Dynamic color rules for sidebar hover */

    /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ active - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ background ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ */
    /* Removed: Dynamic color rules for sidebar active state */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }
    /* remove plan2/plan3 styles */
    /* Plan2 detail */
    /* .plan2-detail { display: none; } */

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>
</head>

          <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    <!-- Replace the sidebar container with static HTML -->
    <!-- Toggle Button -->
    <button id="btnToggleMenu" title="Toggle Menu" aria-label="Toggle Menu"
            class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 hover:bg-blue-700 transition">
      <i class="bi bi-chevron-left"></i>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar"
           class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
      <!-- Logo -->
      <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
        <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
      </a>
      
      <!-- Menu Items -->
      <div class="flex-1 p-4 overflow-y-auto">
        <ul class="flex flex-col w-full space-y-1">
          <li class="my-px">
            <a href="frontstore_pattani"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-blue-500 dark:text-blue-400">
                <i class="bi bi-cash-stack text-xl"></i>
              </span>
              <span class="ml-3">‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>
            </a>
          </li>
          <li class="my-px">
            <a href="installment_Pattani"
               class="flex flex-row items-center h-12 px-4 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all">
              <span class="flex items-center justify-center text-lg text-white">
                <i class="bi bi-credit-card text-xl"></i>
              </span>
              <span class="ml-3">‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>
            </a>
          </li>
           <li class="my-px">
            <a href="Quotationn" class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                <i class="bi bi-file-earmark-text text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
            </a>
          </li>

          <li class="my-px">
                          <a href="DepositReceipt" class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-teal-500 dark:text-teal-400">
                <i class="bi bi-receipt-cutoff text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            </a>
          </li>

          <li class="my-px">
            <a href="receiptVoucher" class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                <i class="bi bi-receipt text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
            </a>
          </li>
          
          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ -->
          <li class="my-px">
            <a href="payment_installments_Pattani" class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg text-amber-500 dark:text-amber-400">
                <i class="bi bi-cash-coin text-xl"></i>
              </span>
              <span class="ml-3">‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>
            </a>
          </li>
          <li class="my-px">
            <a href="Addproduct_pattani"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-green-500 dark:text-green-400">
                <i class="bi bi-speedometer2 text-xl"></i>
              </span>
              <span class="ml-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
            </a>
          </li>
          <li class="my-px">
            <a href="services"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-orange-500 dark:text-orange-400">
                <i class="bi bi-tools text-xl"></i>
              </span>
              <span class="ml-3">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
            </a>
          </li>
          <li class="my-px">
            <a href="receiptVoucher"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-red-500 dark:text-red-400">
                <i class="bi bi-receipt text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
            </a>
          </li>
          <li class="my-px">
            <a href="DepositReceipt"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-teal-500 dark:text-teal-400">
                <i class="bi bi-receipt-cutoff text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            </a>
          </li>
          <li class="my-px">
            <a href="Quotationn"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-purple-500 dark:text-purple-400">
                <i class="bi bi-file-earmark-text text-xl"></i>
              </span>
              <span class="ml-3">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
            </a>
          </li>
          
          <li class="my-px">
            <a href="productTransfer"
               class="flex flex-row items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <span class="flex items-center justify-center text-lg text-pink-500 dark:text-pink-400">
                <i class="bi bi-arrow-left-right text-xl"></i>
              </span>
              <span class="ml-3">‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </a>
          </li>
          
          <!-- Divider -->
          <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
            <button id="btnToggleDark"
                    class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                           hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
              <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
              <span class="ml-3" id="darkModeLabel">Dark Mode</span>
            </button>
          </li>
          
          <!-- Logout -->
          <li class="my-px">
            <button id="btnLogout"
                    class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                           hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
              <i class="bi bi-box-arrow-right text-xl"></i>
              <span class="ml-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </button>
          </li>
          
          <!-- Profile -->
          <li class="my-px mt-2">
            <div id="profile"
                 class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
              <div class="avatar mr-3">
                <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                  <img id="employeePhoto" src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff" alt="Profile" class="w-full h-full object-cover" />
                </div>
              </div>
              <div class="flex flex-col">
                <span class="text-sm font-medium" id="employeeName">Loading‚Ä¶</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </aside>

<div id="mainContent" class="flex-1 flex flex-col ml-56 transition-all duration-300 ease-in-out">
      <!-- Header -->
      <header class="p-4 bg-white dark:bg-gray-800
                    border-b border-gray-200 dark:border-gray-700
                    flex items-center justify-between">
          <div>
          <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô</h1>
          <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
          </p>
        </div>
        
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ + ‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ + ‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á -->
      <div class="flex items-center gap-2">
        <a href="History_installment" 
           class="btn btn-primary flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          <i class="bi bi-receipt text-lg"></i>
          <span>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
        </a>
        <a href="Installment_on_use" 
           class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
          <span>‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</span>
        </a>
        <a href="Installment_complete_pickup" 
           class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <span>‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</span>
        </a>
      </div>
      </header>

      <!-- Content -->
        <!-- Stepper -->
        <div class="stepper mb-4">
          <div class="step active" data-step="1">
            <div class="step-icon">1</div>
            <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-icon">2</div>
            <div class="step-text">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-icon">3</div>
            <div class="step-text">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
          </div>
          <div class="step" data-step="4">
            <div class="step-icon">4</div>
            <div class="step-text">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
          </div>
        </div>

          <!-- Step content -->
        <div id="step1" class="step-content active">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: Level1 + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="lg:col-span-2 space-y-4">
                <!-- Card ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ Barcode Scanner -->
              <div class="card p-4">
                  <div class="grid grid-cols-1 gap-4">
                    <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                <div class="flex gap-2">
                  <input id="productSearchQuery" class="input input-bordered w-full"
                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠ IMEI..." />
                  <button id="btnProductSearch" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                  <button id="btnProductReset" class="btn btn-secondary">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                    
                    <!-- Barcode Scanner -->
                    <div class="flex gap-2">
                      <input id="manualBarcodeInput" class="input input-bordered w-full"
                        placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." autocomplete="off" />
                      <button id="btnAddBarcode" class="btn btn-success">
                        <i class="bi bi-plus mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                      </button>
                    </div>
                </div>
              </div>

              <!-- Container Level1 -->
              <div id="level1Container" class="card">
                <div class="card-header">
                  <i class="bi bi-box-seam"></i> ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Level 1)
                </div>
                <div class="card-body">
                  <div id="level1Grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- renderLevel1() -->
                  </div>
                </div>
              </div>

              <!-- Container Level2 -->
              <div id="level2Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-menu-button-wide"></i>
                    <span id="level2Title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ...</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel1">
                    <i class="bi bi-arrow-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </div>
                <div class="card-body">
                  <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- renderLevel2() -->
                  </div>
                </div>
              </div>

              <!-- Container Level3 -->
              <div id="level3Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-phone"></i>
                    <span id="level3Title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel2">
                    <i class="bi bi-arrow-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </div>
                <div class="card-body">
                  <div id="level3Grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                  </div>
                </div>
              </div>

              <!-- Container ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
              <div id="imeiResultContainer" class="card hidden">
                <div class="card-header">
                  <i class="bi bi-search"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </div>
                <div class="card-body">
                  <div id="imeiResultGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  </div>
                </div>
              </div>
            </div>

            <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏£‡∏∏‡∏õ/‡πÑ‡∏õ Step2 -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </div>
                <div class="card-body">
                  <div class="cart-summary">
                    <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                  </div>
                  <hr class="my-3" />
                  <button class="btn btn-primary w-full" id="btnStep1ToStep2">
                    <i class="bi bi-arrow-right mr-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP1 -->

        <!-- STEP 2 -->
        <div id="step2" class="step-content">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô, ‡∏™‡∏•‡∏¥‡∏õ, ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô, ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà -->
            <div class="lg:col-span-2">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-person"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </div>
                <div class="card-body">
                    <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <label class="label"><span class="label-text font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)</span></label>
                      <div class="flex gap-2">
                        <input type="text" id="customerSearch" class="input input-bordered w-full" 
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13" />
                        <button id="btnSearchCustomer" class="btn btn-primary">
                          <i class="bi bi-search mr-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                        <button id="btnReadCard" class="btn btn-info">
                          <i class="bi bi-credit-card mr-1"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                        </button>
                      </div>
                      <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
                      <div id="customerSearchResults" class="mt-4 hidden">
                        <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                      </div>
                    </div>

                  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</span></label>
                      <select id="customerPrefix" class="select select-bordered w-full">
                        <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
                        <option>‡∏ô‡∏≤‡∏¢</option>
                        <option>‡∏ô‡∏≤‡∏á</option>
                        <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                      </select>
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠</span></label>
                      <input type="text" id="customerFirstName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span></label>
                      <input type="text" id="customerLastName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span></label>
                      <input type="text" id="customerIdCard" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span></label>
                      <input type="text" id="customerPhone" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></label>
                      <input type="email" id="customerEmail" class="input input-bordered w-full" />
                    </div>
                  </div>
                    
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label class="label"><span class="label-text">Facebook</span></label>
                        <input type="text" id="customerFacebook" class="input input-bordered w-full" 
                               placeholder="‡∏ä‡∏∑‡πà‡∏≠ Facebook ‡∏´‡∏£‡∏∑‡∏≠ URL" />
                      </div>
                      <div>
                        <label class="label"><span class="label-text">Line ID</span></label>
                        <input type="text" id="customerLine" class="input input-bordered w-full" 
                               placeholder="Line ID ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" />
                      </div>
                      <div>
                        <label class="label"><span class="label-text">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></label>
                        <input type="text" id="customerMapLocation" class="input input-bordered w-full" 
                               placeholder="Google Maps URL ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î" />
                      </div>
                    </div>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ -->
                    <div class="flex gap-2 mb-4">
                      <button id="btnSaveContact" class="btn btn-success btn-sm">
                        <i class="bi bi-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                      </button>
                      <button id="btnClearContact" class="btn btn-warning btn-sm">
                        <i class="bi bi-trash mr-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                      </button>
                      <button id="btnOpenLineChat" class="btn btn-sm" style="background: #00C300; color: white;">
                        <i class="bi bi-chat-dots mr-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î Line
                      </button>
                      <button id="btnOpenFacebook" class="btn btn-primary btn-sm">
                        <i class="bi bi-facebook mr-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î Facebook
                      </button>
                      <button id="btnShowMapPreview" class="btn btn-info btn-sm">
                        <i class="bi bi-geo-alt mr-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                      </button>
                    </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span></label>
                      <input type="text" id="houseNo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏´‡∏°‡∏π‡πà</span></label>
                      <input type="text" id="moo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏ï‡∏≥‡∏ö‡∏•</span></label>
                      <input type="text" id="subDistrict" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</span></label>
                      <input type="text" id="district" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></label>
                      <input type="text" id="province" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span></label>
                      <input type="text" id="zipcode" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="collapse collapse-arrow border rounded-box mb-4">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium">
                      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    </div>
                    <div class="collapse-content">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠</span></label>
                          <input type="text" id="witnessName" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</span></label>
                          <input type="text" id="witnessIdCard" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span></label>
                          <input type="text" id="witnessPhone" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</span></label>
                          <input type="text" id="witnessRelation" class="input input-bordered w-full"
                            placeholder="‡∏ç‡∏≤‡∏ï‡∏¥/‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ" />
                        </div>
                      </div>
                    </div>
                  </div>
                    
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ -->
                    <div class="mb-4">
                      <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</span></label>
                      <input type="text" id="salespersonName" class="input input-bordered w-full" 
                             placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢" />
                    </div>
                    
                  <hr class="my-4" />
                  <!-- ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span></label>
                    <div id="idCaptureContainer" class="relative w-full h-[480px] bg-gray-100 overflow-hidden rounded">
                      <video id="idVideo" autoplay playsinline muted
                        class="absolute inset-0 w-full h-full object-cover"></video>
                      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <img src="/uploads/‡∏ö‡∏±‡∏ï‡∏£.png" class="w-full h-full object-contain pointer-events-none"
                          alt="ID template overlay" />
                      </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                      <button id="btnStartIdCamera" class="btn btn-sm btn-primary flex-1">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                      <button id="btnCaptureId" class="btn btn-sm btn-success flex-1" disabled>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
                      <button id="btnRetakeId" class="btn btn-sm btn-secondary flex-1 hidden">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <canvas id="idCanvas" class="hidden"></canvas>
                    <input type="hidden" id="idImageData" name="idImageData" />
                  </div>
                  <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</span></label>
                    <input type="file" id="incomeProof" class="file-input file-input-bordered w-full"
                      accept="image/*,application/pdf" />
                  </div>
                  <!-- ‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></label>
                    <canvas id="signaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                    <div class="flex justify-between mt-2">
                      <button id="btnClearSignature" class="btn btn-sm btn-warning">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                      <button id="btnSaveSignature" class="btn btn-sm btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                    </div>
                    <input type="hidden" id="customerSignatureData" name="customerSignature" />
                  </div>
                  <!-- ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô) -->
                  <div class="collapse collapse-arrow border rounded-box">
                    <input type="checkbox" id="selfieCollapse" />
                    <label for="selfieCollapse" class="collapse-title text-lg font-medium cursor-pointer">
                      ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                    </label>
                    <div class="collapse-content space-y-4">
                      <!-- 1) ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô -->
                      <video id="selfieVideo" class="w-full rounded hidden" autoplay playsinline muted></video>

                      <!-- 2) ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
                      <button id="btnStartSelfie" class="btn btn-sm btn-secondary w-full">
                        <i class="bi bi-camera-video-fill mr-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                      </button>

                      <!-- 3) ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (disabled ‡∏à‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°) -->
                      <button id="btnCaptureSelfie" class="btn btn-primary w-full" disabled>
                        <i class="bi bi-camera-fill mr-2"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>

                      <!-- 4) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô canvas -->
                      <canvas id="selfieCanvas" class="hidden border rounded w-full"></canvas>
                      <input type="hidden" id="selfieDataURL" />
                    </div>


                    <!-- ‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ -->
                    <div class="mb-4">
                      <label class="label"><span class="label-text">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</span></label>
                      <canvas id="employeeSignaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                      <div class="flex justify-between mt-2">
                        <button id="btnClearEmpSignature" class="btn btn-sm btn-warning">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                        <button id="btnSaveEmpSignature" class="btn btn-sm btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                      </div>
                      <input type="hidden" id="employeeSignatureData" name="employeeSignature" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </div>
                <div class="card-body">
                  <div class="cart-summary space-y-2 text-sm text-gray-600">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                  </div>

                  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></label>
                    <div class="flex gap-4">
                      <label class="flex items-center">
                        <input type="radio" name="pickupMethod" value="store" checked class="mr-2" /> ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="pickupMethod" value="online" class="mr-2" /> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                      </label>
                    </div>
                  </div>

                  <!-- ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô) -->
                  <div class="mb-4 hidden" id="shippingFeeContainer">
                    <label class="label"><span class="label-text">‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ø)</span></label>
                    <input type="number" id="shippingFee" class="input input-bordered w-full" value="0" min="0" />
                  </div>

                  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
                  <div class="mb-4 mt-4">
                    <label class="label"><span class="label-text">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ø)</span></label>
                    <input type="number" id="documentFee" class="input input-bordered w-full" value="500" min="0" />
                  </div>

                  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ø)</span></label>
                    <input type="number" id="step2Discount" class="input input-bordered w-full" value="0" min="0" />
                  </div>

                  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span></label>
                    <div class="flex flex-wrap gap-4">
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" checked class="radio radio-primary mr-2" />
                        <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="‡πÄ‡∏ä‡πá‡∏Ñ" class="radio radio-primary mr-2" />
                        <span>‡πÄ‡∏ä‡πá‡∏Ñ</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="radio radio-primary mr-2" />
                        <span>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="radio radio-primary mr-2" />
                        <span>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                      </label>
                    </div>
                  </div>


                  <div class="mt-4 space-y-2">
                    <button type="button" class="btn btn-primary w-full" id="btnStep2OpenModal">
                      <i class="bi bi-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                    <button class="btn btn-outline-secondary w-full" id="btnStep2ToStep1">
                      <i class="bi bi-arrow-left mr-2"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP2 -->

        <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ Step3 -->
        <input type="checkbox" id="printPromptModal" class="modal-toggle" />
        <div class="modal">
          <div class="modal-box">
            <h3 class="font-bold text-lg">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ü‡∏•‡πå PDF</h3>
            <p class="py-4">
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô
              ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </p>
            <div class="modal-action">
              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
              <button type="button" id="btnStep2DownloadPdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf mr-2"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              </button>
              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
              <button type="button" id="btnStep2DownloadInvoicePdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf-fill mr-2"></i> ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
              </button>
              <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ STEP3 -->
              <label for="printPromptModal" id="confirmPrintPrompt" class="btn btn-primary">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
              </label>
            </div>

          </div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" class="step-content">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô (col-span-2) -->
            <div class="lg:col-span-2 space-y-4">

              <!-- container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: renderAutoPlans() ‡∏à‡∏∞ inject radio buttons ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
              <div id="autoPlans" class="card mt-4 hidden"></div>

              <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ú‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏™‡∏°‡∏≠) -->
              <div id="manualPlanCard" class="card mt-4">
                <div class="card-header">
                  <i class="bi bi-pencil"></i> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
                </div>
                <div class="card-body space-y-4">
                  <div data-type="plan1" class="manual-field">
                    <label class="label">‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå:</label>
                    <input type="number" id="manualDown" class="input input-bordered w-full" />
                  </div>
                  <div data-type="common" class="manual-field">
                    <label class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):</label>
                    <select id="manualTerms" class="select select-bordered w-full"></select>
                    <div class="mt-2">
                      <label class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                      <div id="manualInstallmentAmount" class="font-semibold">-</div>
                    </div>
                  </div>

                  <button id="btnConfirmManual" class="btn btn-success w-full">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏ú‡∏ô
                  </button>
                </div>
              </div>
            </div>

            <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <div class="lg:col-span-1">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </div>
                <div class="card-body">
                  <div class="cart-summary space-y-2 text-sm text-gray-600">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                  </div>
                  <div class="mt-4 space-y-2">
                    <button id="btnStep3Save" class="btn btn-primary w-full">
                      <i class="bi bi-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                    <button id="btnStep3ToStep2" class="btn btn-outline-secondary w-full">
                      <i class="bi bi-arrow-left mr-2"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End STEP3 -->


<!-- Modal ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ Step4 -->
<input type="checkbox" id="invoicePrintModal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h3>
    <p class="py-4">‚Ä¶</p>
    <div class="modal-action">
      <button id="btnModalDownloadInvoicePdf" class="btn btn-secondary">
        <i class="bi bi-file-earmark-pdf mr-2"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
      </button>
      <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å label ‡πÄ‡∏õ‡πá‡∏ô button ‡∏õ‡∏Å‡∏ï‡∏¥ -->
      <button type="button" id="btnStep3ToStep4" class="btn btn-primary">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      </button>
    </div>
  </div>
</div>


        <div id="step4" class="step-content">
  <!-- ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô STEP4 ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
  <div class="flex justify-center items-center py-20">
    <h2 class="text-3xl font-bold">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
  </div>
</div>
          <!-- End STEP4 -->







          
      </main>
      </div>
    </div>
  </div>



  <!-- Email Management Modal -->
  <input type="checkbox" id="emailModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h3>
      
      <!-- Email Options -->
      <div class="py-4">
        <div class="form-control">
          <label class="label cursor-pointer">
            <span class="label-text">‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
            <input type="checkbox" id="emailQuotation" class="checkbox" />
          </label>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer">
            <span class="label-text">‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span>
            <input type="checkbox" id="emailInvoice" class="checkbox" />
          </label>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer">
            <span class="label-text">‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
            <input type="checkbox" id="emailReceipt" class="checkbox" />
          </label>
        </div>
      </div>
      
      <!-- Email Preview -->
      <div class="mb-4">
        <label class="label"><span class="label-text">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></label>
        <textarea id="emailPreview" class="textarea textarea-bordered w-full h-32" readonly></textarea>
      </div>
      
      <!-- Email Status -->
      <div id="emailStatus" class="mb-4 hidden">
        <div class="alert"></div>
      </div>
      
      <div class="modal-action">
        <button id="btnPreviewEmail" class="btn btn-info">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        <button id="btnSendEmail" class="btn btn-success">‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
        <label for="emailModal" class="btn">‡∏õ‡∏¥‡∏î</label>
      </div>
    </div>
  </div>

  <!-- Map Preview Modal -->
  <input type="checkbox" id="mapModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-lg">‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</h3>
      <div class="py-4">
        <iframe id="mapFrame" class="w-full h-96 rounded" frameborder="0"></iframe>
      </div>
      <div class="modal-action">
        <label for="mapModal" class="btn">‡∏õ‡∏¥‡∏î</label>
      </div>
    </div>
  </div>

  <!-- Loading System Modal -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p id="loadingMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      <div id="loadingProgress" class="progress progress-primary w-full mt-2 hidden"></div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <!-- Screen Reader Announcement -->
  <div id="screenReaderAnnouncement" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <!-- Network Status Container -->
  <div id="networkStatus" class="flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-700 transition-all duration-300">
    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
    <span class="text-xs font-medium">Online</span>
  </div>

  <!-- ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡πÉ‡∏ô payload -->
  <input type="hidden" id="idCardImageUrl" name="idCardImageUrl" />
  <input type="hidden" id="salarySlipUrl" name="salarySlipUrl" />
  <input type="hidden" id="selfieUrl" name="selfieUrl" />
  <input type="hidden" id="customerSignatureUrl" name="customerSignatureUrl" />
  <input type="hidden" id="salespersonSignatureUrl" name="salespersonSignatureUrl" />

  <!-- Script ‡∏´‡∏•‡∏±‡∏Å -->
  <script>
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  async function loadEmployeeProfile() {
    try {
      const token = localStorage.getItem('authToken');
      if (!token) return;
      const res = await fetch('/api/users/me', {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      const js = await res.json();
      if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);
      const u = js.data;
      window.employeeId = u._id;
      window.employeeName = u.name;        // ‚Üê ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô server
      document.getElementById('employeeName').textContent = u.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
      let img = u.imageUrl || u.photoUrl || u.image || '';
      if (img && !/^https?:\/\//.test(img)) {
        img = img.startsWith('/') ? img : '/uploads/' + img;
      }
      document.getElementById('employeePhoto').src = img || '/static/images/avatar-placeholder.png'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô fallback ‡πÄ‡∏õ‡πá‡∏ô placeholder
    } catch (err) {
      console.error('Load Employee Profile Error:', err);
    }
  }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠ field + ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ)
    async function uploadFile(file, uploadEndpoint, fieldName = 'file', filename = 'file', extras = {}) {
      const formData = new FormData();
      formData.append(fieldName, file, filename);
      // append ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      Object.entries(extras).forEach(([key, val]) => {
        formData.append(key, val);
      });
      const res = await fetch(uploadEndpoint, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
      const js = await res.json();
      return js.url;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
    async function uploadSignature(pad, urlFieldId) {
      if (pad.isEmpty()) {
        return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      }
      // 1) ‡πÄ‡∏≠‡∏≤ DataURL ‚Üí Blob
      const dataURL = pad.toDataURL('image/png');
      const blob = await (await fetch(dataURL)).blob();
      // 2) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      const url = await uploadFile(
        blob,
        '/api/upload/signature',
        'signature',      // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö upload.single('signature')
        'signature.png'   // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
      );      // 3) ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÉ‡∏ô hidden input
      document.getElementById(urlFieldId).value = url;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    // =========================== A) GLOBAL CONSTANTS & VARS ===========================
    const BRANCH_CODE = '00000';
    let branchInstallments = [];
    let activePromotions = [];
    let appliedPromotions = {};
    let level2Groups = {};
    let cartItems = [];   // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];
    let selectedPlan = 'plan1'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô = plan1
    let standardPrice = 0;       // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
    let standardTerms = 12;      // ‡∏á‡∏ß‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    window._autoPlan = {
      down: 0, count: 0, perMonth: 0,
      credit: 0, useCount: 0, perMonthUse: 0,
      payoff: 0
    };

    let signaturePad, empPad; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô

    // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á <script> ‡πÄ‡∏•‡∏¢
    if (!document.getElementById('toastContainer')) {
      const toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} shadow-lg`;
      alert.innerHTML = `<span>${message}</span>`;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }


    // A) ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å API (Level1)
    async function loadBranchInstallments() {
      try {
        const token = localStorage.getItem('authToken') || '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏û‡∏£‡πâ‡∏≠‡∏° purchaseType=installment
        const url = `/api/branch-stock/taxType?branch_code=${BRANCH_CODE}&verified=true&purchaseType=installment`;
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error(res.status);
        const js = await res.json();
        // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ backend ‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà qty > 0
        branchInstallments = js.data || [];
        console.log('branchInstallments =', branchInstallments);
      } catch (err) {
        console.error('loadBranchInstallments failed:', err);
        branchInstallments = [];
      }
    }




    /**
   * numberToThaiText: ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
   * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏≤‡∏ô (‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏•‡πâ‡∏≤‡∏ô")
   */
    function numberToThaiText(number) {
      const txtNum = ['‡∏®‡∏π‡∏ô‡∏¢‡πå', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
      const txtDigit = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];
      if (isNaN(number)) return '';

      let n = Math.floor(Math.abs(number)).toString();
      let len = n.length;
      let result = '';

      for (let i = 0; i < len; i++) {
        const digit = parseInt(n.charAt(i), 10);
        const pos = len - i - 1;                // 0 = ‡∏´‡∏ô‡πà‡∏ß‡∏¢, 1 = ‡∏™‡∏¥‡∏ö, 2 = ‡∏£‡πâ‡∏≠‡∏¢, ...
        const unit = pos % 6;                   // ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 6 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏•‡πâ‡∏≤‡∏ô)
        const group = Math.floor(pos / 6);       // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏ô" ‡∏ã‡πâ‡∏≥

        if (digit !== 0) {
          // ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö special: 1 ‚Üí "‡∏™‡∏¥‡∏ö", 2 ‚Üí "‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö"
          if (unit === 1) {
            if (digit === 1) result += '‡∏™‡∏¥‡∏ö';
            else if (digit === 2) result += '‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö';
            else result += txtNum[digit] + '‡∏™‡∏¥‡∏ö';
          }
          // ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ special: 1 ‚Üí "‡πÄ‡∏≠‡πá‡∏î" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          else if (unit === 0 && digit === 1 && len > 1) {
            result += '‡πÄ‡∏≠‡πá‡∏î';
          }
          else {
            result += txtNum[digit] + txtDigit[unit];
          }
        }

        // ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡πâ‡∏≤‡∏ô"
        if (unit === 0 && group > 0 && digit !== 0) {
          result += '‡∏•‡πâ‡∏≤‡∏ô'.repeat(group);
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° "‡∏®‡∏π‡∏ô‡∏¢‡πå"
      if (result === '') result = txtNum[0];

      return result;
    }





    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch('/api/branch', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const js = await res.json();
        if (!js.success) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
        const data = js.data || [];
        const found = data.find(b => b.branch_code === BRANCH_CODE);
        if (found) {
          // ‡πÄ‡∏Å‡πá‡∏ö global
          window.currentBranchInfo = {
            code: found.branch_code,
            name: found.name,
            address: found.address,
            taxId: found.taxId || '-',
            tel: found.tel || '-',
          };
          document.getElementById('branchInfo').textContent =
            `${found.name} ‚Äî ${found.address}`;
        } else {
          throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}`);
        }
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤)';
        // ‡πÉ‡∏´‡πâ default object ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô error
        window.currentBranchInfo = {
          code: BRANCH_CODE,
          name: 'Default Branch',
          address: '-',
          taxId: '-',
          tel: '-',
        };
      }
    }



    // =========================== D) LOAD/RENDER LEVEL1/2/3 ===========================
    async function loadLevel1() {
      document.getElementById('level1Container').classList.remove('hidden');
      // ‚Ä¶‡∏ã‡πà‡∏≠‡∏ô container ‡∏≠‡∏∑‡πà‡∏ô‡πÜ‚Ä¶
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á brandCounts ‡∏à‡∏≤‡∏Å branchInstallments
      const brandCounts = branchInstallments.reduce((acc, item) => {
        const key = (item.brand || item.name.split(' ')[0]).trim().toLowerCase();
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const categories = Object.entries(brandCounts)
        .map(([key, stock]) => ({ key, label: key[0].toUpperCase() + key.slice(1), stock }))
        .filter(c => c.stock > 0)
        .sort((a, b) => a.label.localeCompare(b.label));
      renderLevel1(categories);
    }


    function renderLevel1(categories) {
  const grid = document.getElementById('level1Grid');
  grid.innerHTML = '';
  
  categories.forEach(cat => {
    const hasPromo = checkBrandHasPromotion(cat.key);
    const card = document.createElement('div');
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
  
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-semibold ${hasPromo ? 'text-red-600' : ''}">${cat.label}</h6>
      <p class="text-sm text-gray-500 mt-2">‡∏°‡∏µ ${cat.stock || 0} ‡∏ä‡∏¥‡πâ‡∏ô</p>
    `;
  
    card.addEventListener('click', () => loadLevel2(cat.key, cat.label));
    grid.appendChild(card);
  });
}

    // 2) ‡πÅ‡∏Å‡πâ loadLevel2 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å allProductImages ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå (parentKey) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    // 2) ‡πÅ‡∏Å‡πâ loadLevel2 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å branchInstallments ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå (parentKey) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    function loadLevel2(parentKey, parentLabel) {
      // ‡∏ã‡πà‡∏≠‡∏ô / ‡πÅ‡∏™‡∏î‡∏á container
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ${parentLabel}`;

      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà brand ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ parentKey
      const filtered = branchInstallments.filter(p => {
        const key = (p.brand || p.name.split(' ')[0]).trim().toLowerCase();
        return key === parentKey;
      });

      // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Level2 ‡∏ï‡∏≤‡∏°‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      level2Groups = filtered.reduce((groups, p) => {
        const baseName = p.name.split(' ').slice(0, 2).join(' ');
        (groups[baseName] ||= []).push(p);
        return groups;
      }, {});

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      if (!Object.keys(level2Groups).length) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏ô‡∏µ‡πâ', 'warning');
        return document.getElementById('btnBackToLevel1').click();
      }

      renderLevel2(Object.keys(level2Groups));
    }


    // 3) renderLevel2 ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°
    function renderLevel2(groupNames) {
  const grid = document.getElementById('level2Grid');
  grid.innerHTML = '';

  groupNames.forEach(baseName => {
    const items = level2Groups[baseName];
    const hasPromo = checkGroupHasPromotion(items);
    const count = items.length;
  
    const card = document.createElement('div');
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
  
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-medium ${hasPromo ? 'text-red-600' : ''}">${baseName}</h6>
      <p class="text-sm text-gray-500 mt-2">‡∏°‡∏µ ${count} ‡∏ä‡∏¥‡πâ‡∏ô</p>
      ${hasPromo ? '<p class="text-xs text-red-500 mt-1 font-semibold animate-pulse">‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©!</p>' : ''}
    `;
  
    card.addEventListener('click', () => showLevel3Group(baseName));
    grid.appendChild(card);
  });
}

    // 4) showLevel3Group ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å level2Groups ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${baseName}`;

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÅ‡∏Ñ‡πà renderLevel3 ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ rawItems ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏π‡∏õ+‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß
      renderLevel3(level2Groups[baseName]);
    }

    // 5) renderLevel3 ‡πÅ‡∏™‡∏î‡∏á card + ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function renderLevel3(items) {
  currentLevel3Items = items;
  const grid = document.getElementById('level3Grid');
  grid.innerHTML = '';

  const visible = items.filter(it => !hiddenProductIds.has(it._id));
  if (!visible.length) {
    return grid.innerHTML = `<div class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
  }

  visible.forEach(it => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasPromo = checkPromotionForProduct(it._id);
  
    const col = document.createElement('div');
    col.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      col.style.overflow = 'visible';
    }
  
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Fire Icon
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
  
    col.innerHTML = `
      ${fireIcon}
      <img src="${it.image}" class="product-img mb-2 rounded-md" alt="${it.name}" />
      <h6 class="font-medium text-sm mb-1">${it.name}</h6>
      <p class="text-xs text-gray-600 mb-1">IMEI: ${it.imei || '-'}</p>
      <div class="text-sm font-semibold text-primary mb-4">
        ‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${it.downAmount.toLocaleString()}
        <span class="mx-2">|</span>
        ‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${it.downInstallment.toLocaleString()} (x${it.downInstallmentCount} ‡∏á‡∏ß‡∏î)
      </div>
      ${hasPromo ? '<p class="promotion-text">‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    `;
  
    col.querySelector('button').addEventListener('click', () => addToCart(it));
    grid.appendChild(col);
  });
}

    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
  const hasPromo = checkPromotionForProduct(item._id);
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤ item ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö‡∏Ñ‡πà‡∏≤ docFee
  const cartItem = {
    ...item,
    docFee: item.docFee || 0,
    taxRate: item.taxRate ?? 0,
    taxType: item.taxType ?? '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ cartItems
  cartItems.push(cartItem);
  hiddenProductIds.add(item._id);

  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI
  renderCart();
  renderLevel3(currentLevel3Items);
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
  checkAvailablePromotions();
  
  // ‡πÅ‡∏™‡∏î‡∏á effect ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
  if (hasPromo) {
    const mainContent = document.getElementById('mainContent');
    createConfettiEffect(mainContent);
    showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ${item.name} ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©!`, 'success');
  } else {
    showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${item.name} ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
  }

  // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Step3 ‡πÉ‡∏´‡πâ re-init ‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà
  if (
    document.getElementById('step3').classList.contains('active') &&
    (selectedPlan === 'plan1' || selectedPlan === 'plan2')
  ) {
    initManualTerms();
  }
}

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      if (document.getElementById('step3').classList.contains('active')
        && selectedPlan === 'plan1') {
        initManualTerms();
      }
    }
    function renderCart() {
  const summaries = document.querySelectorAll('.cart-summary');
  if (!summaries.length) return;

  const currentStep = document.querySelector('.step-content.active')?.id;
  let html = '';

  if (cartItems.length === 0) {
    html = `<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>`;
  } else if (currentStep === 'step3') {
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô step3 ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô #step3 .cart-summary ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
    html = document.querySelector('#step3 .cart-summary').innerHTML;
  } else {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    html = cartItems.map((it, idx) => {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
      const promo = appliedPromotions[it._id];
  
      // Calculate base price
      const down = Number(it.downAmount) || 0;
      const inst = Number(it.downInstallment) || 0;
      const terms = Number(it.downInstallmentCount) || 0;
      const base = down + inst * terms;
  
      // Calculate VAT amount based on tax type
      const rate = (it.taxRate || 0) / 100;
      let vatAmount = 0;
      if (it.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
        vatAmount = base * rate;
      } else if (it.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
        vatAmount = base - (base / (1 + rate));
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
      let promoHTML = '';
      if (promo) {
        const disc = promo.type === 'percentage'
          ? base * (promo.discount / 100)
          : promo.discount;
        const newPrice = base - disc;
  
        promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">‡∏ø${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">‡∏ø${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-‡∏ø${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
      }

      return `
        <div class="flex items-start gap-2 border-b py-2">
          <img src="${it.image}" class="w-12 h-12 rounded" />
          <div class="flex-1">
            <div class="font-semibold">${it.name}</div>
            <div class="text-xs text-gray-500 mb-1">IMEI: ${it.imei}</div>
            <div class="text-xs text-gray-500">
              ‡∏†‡∏≤‡∏©‡∏µ: ${it.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ'} 
              ${vatAmount > 0 ? `(‡∏ø${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })})` : ''}
            </div>
            ${promoHTML}
          </div>
          <button class="btn btn-sm btn-error" data-index="${idx}">‡∏•‡∏ö</button>
        </div>
      `;
    }).join('');
  }
  
  summaries.forEach(el => {
    el.innerHTML = html;
    // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    el.querySelectorAll('button.btn-error').forEach(btn => {
      btn.addEventListener('click', () => {
        removeFromCart(parseInt(btn.dataset.index, 10));
      });
    });
  });
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
  if (cartItems.length > 0 && currentStep !== 'step3') {
    checkAvailablePromotions();
  }
}

    /**
    * ‡πÄ‡∏≠‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á imeiResultContainer
    */
    function renderSearchResult(items) {
  document.getElementById('level1Container').classList.add('hidden');
  document.getElementById('level2Container').classList.add('hidden');
  document.getElementById('level3Container').classList.add('hidden');
  
  const container = document.getElementById('imeiResultContainer');
  const grid = document.getElementById('imeiResultGrid');
  container.classList.remove('hidden');
  grid.innerHTML = '';

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
  
    const card = document.createElement('div');
    card.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
  
    card.innerHTML = `
      ${fireIcon}
      <img src="${item.image}" class="product-img mb-2 rounded-md" alt="${item.name}" />
      <h6 class="font-medium text-sm mb-1">${item.name}</h6>
      <p class="text-xs text-gray-600 mb-1">IMEI: ${item.imei || '-'}</p>
      <div class="text-sm font-semibold text-primary mb-4">
        ‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${item.downAmount.toLocaleString()}
        <span class="mx-2">|</span>
        ‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${item.downInstallment.toLocaleString()} (x${item.downInstallmentCount} ‡∏á‡∏ß‡∏î)
      </div>
      ${hasPromo ? '<p class="promotion-text">‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    `;
  
    card.querySelector('button').addEventListener('click', () => addToCart(item));
    grid.appendChild(card);
  });
}


    // F) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ IMEI)
    async function searchItems() {
      const raw = document.getElementById('productSearchQuery').value.trim();
      const token = localStorage.getItem('authToken') || '';
      const isImei = /^\d+$/.test(raw);

      let url =
        `/api/branch-stock/taxType` +
        `?branch_code=${BRANCH_CODE}` +
        `&verified=true` +
        `&purchaseType=installment` +
        (isImei ? `&imei=${encodeURIComponent(raw)}` : ``);

      const res = await fetch(url, {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) throw new Error(`searchItems ${res.status}`);
      const js = await res.json();

      // ‚îÄ‚îÄ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ qty > 0 ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚îÄ‚îÄ
      let stockList = js.data || [];

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà IMEI ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡∏ù‡∏±‡πà‡∏á client ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      if (!isImei && raw) {
        stockList = stockList.filter(s =>
          s.name.toLowerCase().includes(raw.toLowerCase())
        );
      }

      renderSearchResult(stockList);
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå iframe
    function printQuotationIframe() {
      const iframe = document.getElementById('quotationPdfViewer');
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      }
    }

    // ‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° autoPrintYes
    document.getElementById('btnAutoPrintYes')?.addEventListener('click', () => {
      document.getElementById('autoPrintModal').checked = false;
      printQuotationIframe();
    });

    // ‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
    document.getElementById('btnPrintPdf')?.addEventListener('click', () => {
      printQuotationIframe();
    });


    function resetSearch() {
      document.getElementById('productSearchQuery').value = '';
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level1Container').classList.remove('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }

    // =========================== G) PLAN & CALCULATION ===========================
    function updateStandardValues() {
      // ‡∏£‡∏ß‡∏° pricePayOff ‡πÉ‡∏ô cartItems
      standardPrice = cartItems.reduce((acc, it) => acc + it.pricePayOff, 0);

  
    }

    function renderAutoPlans() {
      // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Plan 1 (‡∏î‡∏≤‡∏ß‡∏ô‡πå + ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°) ‡∏à‡∏≤‡∏Å cartItems
      let totalDown = 0,
        totalDownInstCount = 0,
        totalDownInstAmt = 0,
        totalDocFee = 0;

      cartItems.forEach(it => {
        totalDown += it.downAmount;
        totalDownInstCount += it.downInstallmentCount;
        totalDownInstAmt += it.downInstallment;
        totalDocFee += (it.docFee || 0);
      });

      const plan1Down = totalDown + totalDocFee;
      const plan1Monthly = totalDownInstAmt;
      const plan1InstCount = totalDownInstCount;

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ autoPlan ‡∏Ç‡∏≠‡∏á Plan 1
      window._autoPlan = {
        down: plan1Down,
        count: plan1InstCount,
        perMonth: plan1Monthly,
        docFee: totalDocFee
      };

      // inject radio ‡∏Ç‡∏≠‡∏á Plan 1 ‡∏•‡∏á‡πÉ‡∏ô #autoPlans
      document.getElementById('autoPlans').innerHTML = `
    <label class="flex flex-col items-start mb-3">
      <div class="flex items-center">
        <input type="radio" name="paymentPlan" id="plan1" checked class="mr-2"/>
        <span>Plan 1 (‡∏î‡∏≤‡∏ß‡∏ô‡πå): ‡∏ø${plan1Down.toLocaleString()}</span>
      </div>
      <div class="ml-6">
        <span>‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î: (${plan1InstCount} x ${plan1Monthly.toLocaleString()})</span>
      </div>
    </label>
  `;

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á "‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå" ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° manual ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö plan1Down
      const manualDownInput = document.getElementById('manualDown');
      if (manualDownInput) {
        manualDownInput.value = plan1Down;
      }
    }

    function renderStep3Summary() {
  const cartEl = document.querySelector('#step3 .cart-summary');
  if (!cartEl) return;

  // 1) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á
  if (!cartItems.length) {
    cartEl.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
    return;
  }

  // 2) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT ‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  const subTotal = cartItems.reduce((sum, it) => {
    // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏î‡∏≤‡∏ß‡∏ô‡πå + ‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°)
    const down = Number(it.downAmount) || 0;
    const inst = Number(it.downInstallment) || 0;
    const terms = Number(it.downInstallmentCount) || 0;
    const total = down + (inst * terms);
    return sum + total;
  }, 0);

  // 3) ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å STEP2: ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á, ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°, ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
  const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
  const docFee = parseFloat(document.getElementById('documentFee').value) || 0;
  const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
  
  // 4) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
  const { totalDiscount: promotionDiscount, details: promoDetails } = calculatePromotionDiscount();
  
  // 5) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT
  let totalVAT = 0;
  cartItems.forEach(it => {
    const rate = (it.taxRate || 0) / 100;
    const down = Number(it.downAmount) || 0;
    const inst = Number(it.downInstallment) || 0;
    const terms = Number(it.downInstallmentCount) || 0;
    const base = down + (inst * terms);
  
    if (it.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      totalVAT += base * rate;
    } else if (it.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
      totalVAT += base - (base / (1 + rate));
    }
  });

  // 6) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
  const netTotal = subTotal + shipping + docFee - discount - promotionDiscount;
  const grandTotal = netTotal + totalVAT;

  // 7) ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  const itemsHtml = cartItems.map(it => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    const promo = appliedPromotions[it._id];
    const down = Number(it.downAmount) || 0;
    const inst = Number(it.downInstallment) || 0;
    const terms = Number(it.downInstallmentCount) || 0;
    const originalPrice = down + (inst * terms);
  
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    const rate = (it.taxRate || 0) / 100;
    let vatAmount = 0;
    if (it.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
      vatAmount = originalPrice * rate;
    } else if (it.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
      vatAmount = originalPrice - (originalPrice / (1 + rate));
    }
  
    // HTML ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    let promoHTML = '';
    if (promo) {
      const discAmount = promo.type === 'percentage'
        ? originalPrice * (promo.discount / 100)
        : promo.discount;
      const finalPrice = originalPrice - discAmount;
  
      promoHTML = `
        <div class="mt-2 p-2 bg-yellow-50 rounded">
          <span class="badge badge-error badge-sm">${promo.name}</span>
          <div class="text-xs mt-1">
            <span class="line-through text-gray-500">‡∏ø${originalPrice.toLocaleString()}</span>
            <span class="text-red-600 ml-2">‡∏ø${finalPrice.toLocaleString()}</span>
            <span class="text-green-600 ml-1">(-${promo.discount}${promo.type === 'percentage' ? '%' : '‡∏ø'})</span>
          </div>
        </div>
      `;
    }

    return `
      <div class="border-b pb-3 mb-3">
        <img src="${it.image}" 
             class="w-full h-auto mb-2 rounded-md" 
             alt="${it.name}" />
        <div class="font-semibold">${it.name}</div>
        <div class="text-xs text-gray-500 mb-1">IMEI: ${it.imei}</div>
        <div class="text-xs text-gray-500">
          ‡∏†‡∏≤‡∏©‡∏µ: ${it.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ'} 
          ${vatAmount > 0 ? `(‡∏ø${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })})` : ''}
        </div>
        <div class="text-sm text-primary mb-2">
          ‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${it.downAmount.toLocaleString()}
          <span class="mx-2">|</span>
          ‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${it.downInstallment.toLocaleString()} (x${it.downInstallmentCount} ‡∏á‡∏ß‡∏î)
        </div>
        ${promoHTML}
      </div>
    `;
  }).join('');

  // 8) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô
  const planSummary = getPlanSummaryText();

  // 9) ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const summaryHtml = `
    <div class="mt-4 p-3 bg-blue-50 space-y-1 text-sm">
      <div class="flex justify-between">
        <span>‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
        <span>‡∏ø${subTotal.toLocaleString()}</span>
      </div>
      <div class="flex justify-between">
        <span>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</span>
        <span>‡∏ø${shipping.toLocaleString()}</span>
      </div>
      <div class="flex justify-between">
        <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span>
        <span>‡∏ø${docFee.toLocaleString()}</span>
      </div>
      <div class="flex justify-between">
        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
        <span class="text-red-600">-‡∏ø${discount.toLocaleString()}</span>
      </div>
      ${promotionDiscount > 0 ? `
        <div class="flex justify-between">
          <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô:</span>
          <span class="text-red-600">-‡∏ø${promotionDiscount.toLocaleString()}</span>
        </div>
      ` : ''}
      <div class="flex justify-between">
        <span>‡∏†‡∏≤‡∏©‡∏µ VAT:</span>
        <span>‡∏ø${totalVAT.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
      </div>
      <hr class="my-2">
      <div class="flex justify-between font-semibold text-lg">
        <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
        <span class="text-blue-700">‡∏ø${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
      </div>
    </div>
    
    ${promoDetails.length > 0 ? `
      <div class="mt-3 p-3 bg-yellow-50 rounded">
        <div class="font-semibold text-sm mb-2">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</div>
        ${promoDetails.map(d =>
          `<div class="text-xs">‚Ä¢ ${d.name} (${d.productName}): -‡∏ø${d.discount.toLocaleString()}</div>`
        ).join('')}
      </div>
    ` : ''}
    
    <div class="mt-3 p-3 bg-gray-50 rounded">
      <div class="text-sm font-semibold">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô:</div>
      <div class="text-sm">${planSummary}</div>
    </div>
  `;

  // 10) ‡∏ô‡∏≥ itemsHtml + summaryHtml ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô
  cartEl.innerHTML = itemsHtml + summaryHtml;
}

// ‡∏ú‡∏π‡∏Å event listeners (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
const shippingField = document.getElementById('shippingFee');
if (shippingField) {
  shippingField.addEventListener('input', renderStep3Summary);
}
const docFeeField = document.getElementById('documentFee');
if (docFeeField) {
  docFeeField.addEventListener('input', renderStep3Summary);
}
const discountField = document.getElementById('step2Discount');
if (discountField) {
  discountField.addEventListener('input', renderStep3Summary);
}

document.querySelectorAll('#step3 input[name="manualOption"], #step3 input[name="paymentPlan"]').forEach(el => {
  el.addEventListener('change', renderStep3Summary);
});

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
renderStep3Summary();



    function renderStep4Summary(orderData) {

      // A) ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const prefix = document.getElementById('customerPrefix').value || '';
      const first = document.getElementById('customerFirstName').value || '';
      const last = document.getElementById('customerLastName').value || '-';
      const custName = `${prefix}${first} ${last}`.trim() || '-';
      document.getElementById('pdfCustomerName').textContent = custName;

      const taxId = document.getElementById('customerIdCard').value || '-';
      document.getElementById('pdfCustomerTaxId').textContent = taxId;

      const house = document.getElementById('houseNo').value || '';
      const moo = document.getElementById('moo').value || '';
      const subDist = document.getElementById('subDistrict').value || '';
      const dist = document.getElementById('district').value || '';
      const prov = document.getElementById('province').value || '';
      const zip = document.getElementById('zipcode').value || '';
      const address = `${house} ‡∏´‡∏°‡∏π‡πà ${moo} ‡∏ï.${subDist} ‡∏≠.${dist} ‡∏à.${prov} ${zip}`.trim() || '-';
      document.getElementById('pdfCustomerAddress').textContent = address;

      const phone = document.getElementById('customerPhone').value || '-';
      document.getElementById('pdfCustomerPhone').textContent = phone;

      const quotationNo = orderData.quotationNumber || '-';
      document.getElementById('pdfQuotationNo').textContent = quotationNo;

      // --- ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó + ‡∏™‡∏≤‡∏Ç‡∏≤ ---
      const compEl = document.getElementById('pdfCompanyInfo');
      const branch = window.currentBranchInfo || {};
      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ orderData.company ‡∏°‡∏≤‡∏à‡∏≤‡∏Å API ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
      const companyName = orderData.company?.name || '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î';
      compEl.innerHTML = `
  ${companyName} (${branch.name})<br/>
  ${branch.address}<br/>
  ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ ${branch.taxId} (‡∏™‡∏≤‡∏Ç‡∏≤ ${branch.code})<br/>
  ‡πÇ‡∏ó‡∏£: ${branch.tel}
`;

      // 2) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å (dd/mm/yyyy ‡∏û.‡∏®.)
      const today = new Date();
      const dd = String(today.getDate()).padStart(2, '0');
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const yyyyBath = today.getFullYear() + 543;
      const issueDate = `${dd}/${mm}/${yyyyBath}`;
      document.getElementById('pdfIssueDate').textContent = issueDate;

      // 3) ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å sidebar)
      const salesman = document.getElementById('employeeName').textContent.trim() || '-';
      document.getElementById('pdfSalesman').textContent = salesman;

      // 4) Credit Term (‡∏à‡∏≤‡∏Å orderData ‡∏´‡∏£‡∏∑‡∏≠ default ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡πÉ‡∏ô manualTerms)
      const creditTerm = orderData.creditTerm
        ? `${orderData.creditTerm} ‡∏á‡∏ß‡∏î`
        : `${document.getElementById('manualTerms').value} ‡∏á‡∏ß‡∏î`;
      document.getElementById('pdfCreditTerm').textContent = creditTerm;

      // ‚Äî‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢/‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Äî

      // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const customerSig = document.getElementById('customerSignatureData').value;
      if (customerSig) {
        document.getElementById('pdfCustomerSignature').src = customerSig;
        document.getElementById('pdfCustomerSignDate').textContent =
          new Date().toLocaleDateString('th-TH');
      }

      // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
      const empSig = document.getElementById('employeeSignatureData').value;
      if (empSig) {
        document.getElementById('pdfSalesSignature').src = empSig;
        document.getElementById('pdfSalesSignDate').textContent =
          new Date().toLocaleDateString('th-TH');
      }

      // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏à‡∏≤‡∏Å orderData (payload)
      if (orderData.authorized_signature) {
        document.getElementById('pdfAuthSignature').src = orderData.authorized_signature;
      } else {
        // fallback ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        document.getElementById('pdfAuthSignature').src = '/uploads/S__15892486-Photoroom.png';
      }
      document.getElementById('pdfAuthSignDate').textContent =
        new Date().toLocaleDateString('th-TH');

      // ‚Äî ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô ‡∏ú‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‚Äî

      // ‡∏Ñ‡πà‡∏≤ Fees ‡∏à‡∏≤‡∏Å payload ‡∏´‡∏£‡∏∑‡∏≠ fallback input
      const docFee = orderData.docFee != null
        ? orderData.docFee
        : (parseInt(document.getElementById('documentFee').value, 10) || 0);

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡πÅ‡∏ú‡∏ô
      const planType = selectedPlan === 'plan1' ? '‡∏î‡∏≤‡∏ß‡∏ô‡πå'
        : selectedPlan === 'plan2' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ú‡πà‡∏≤‡∏ô'
          : '‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö';
      const D = selectedPlan === 'plan1'
        ? Number(document.getElementById('manualDown').value)
        : Number(document.getElementById('manualCredit').value);
      const n = Number(document.getElementById('manualTerms').value) || 0;
      const totalForPlan = selectedPlan === 'plan3'
        ? cartItems.reduce((s, it) => s + it.pricePayOff, 0)
        : selectedPlan === 'plan1'
          ? window._autoPlan.down + window._autoPlan.perMonth * window._autoPlan.count
          : window._autoPlan.credit + window._autoPlan.perMonthUse * window._autoPlan.useCount;
      const inst = n > 0 ? Math.floor((totalForPlan - D) / n) : totalForPlan;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏ú‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const planItemsHtml = cartItems.map(it => `
    <div class="text-center mb-8">
      <img src="${it.image}" alt="${it.name}"
           class="w-50 h-50 object-cover rounded-lg shadow mb-4"/>
      <h2 class="text-3xl font-bold mb-2">${it.name}</h2>
      <p class="text-xl text-gray-600 mb-1">IMEI: ${it.imei}</p>
      <p class="text-xl text-primary">
        ‡πÅ‡∏ú‡∏ô: <span class="font-semibold">${planType}</span>
        ${planType !== '‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö'
          ? ` ${D.toLocaleString()} ‡∏ø ‚Ä¢ ${n} ‡∏á‡∏ß‡∏î ‚Ä¢ ‡∏á‡∏ß‡∏î‡∏•‡∏∞ ${inst.toLocaleString()} ‡∏ø`
          : ` ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${totalForPlan.toLocaleString()} ‡∏ø`
        }
      </p>
    </div>
  `).join('');

      // ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
      const summaryHtml = `
    <div class="mt-4 p-3 bg-blue-50 text-blue-700 font-semibold text-right">
      ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø${subTotal.toLocaleString()}
    </div>
  `;

      // ‡πÅ‡∏ó‡∏£‡∏Å into summaryPlan
      const summaryEl = document.getElementById('summaryPlan');
      summaryEl.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-6', 'justify-items-center');
      summaryEl.classList.add('mb-8', 'flex', 'flex-wrap', 'justify-center', 'items-center', 'gap-6');
      summaryEl.innerHTML = planItemsHtml;

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const tbody = document.getElementById('pdfItemsBody');
      tbody.innerHTML = cartItems.map((it, i) => {
        const unitPrice = (selectedPlan === 'plan3'
          ? it.pricePayOff
          : selectedPlan === 'plan1'
            ? it.downInstallment
            : it.payUseInstallment
        ).toLocaleString(undefined, { minimumFractionDigits: 2 });
        const amount = it.pricePayOff.toLocaleString(undefined, { minimumFractionDigits: 2 });
        return `
      <tr>
        <td>${i + 1}</td>
        <td style="text-align:left;">${it.name}</td>
        <td>1</td>
        <td>${unitPrice}</td>
        <td>0.00</td>
        <td>${amount}</td>
      </tr>
    `;
      }).join('');

      // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
      const subTotal = cartItems.reduce((sum, it) => sum + it.pricePayOff, 0);
      const grandTotal = subTotal + docFee;

      const pdfDocFeeEl = document.getElementById('pdfDocFee');
      const pdfSubTotalEl = document.getElementById('pdfSubTotal');
      const pdfGrandTotalEl = document.getElementById('pdfGrandTotal');

      if (docFee > 0) {
        pdfDocFeeEl.textContent = docFee.toLocaleString(undefined, { minimumFractionDigits: 2 });
      } else {
        document.getElementById('pdfDocFeeRow').classList.add('hidden');
      }
      pdfSubTotalEl.textContent = subTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
      pdfGrandTotalEl.textContent = grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element)
      const pdfAmountWordsEl = document.getElementById('pdfAmountWords');
      if (pdfAmountWordsEl) {
        pdfAmountWordsEl.textContent = numberToThaiText(Math.floor(grandTotal)) + '‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô';
      }
    }

    function getPlanSummaryText() {
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á Plan 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      return `‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${window._autoPlan.down.toLocaleString()} | ‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${window._autoPlan.perMonth.toLocaleString()} (x${window._autoPlan.count} ‡∏á‡∏ß‡∏î)`;
    }




    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Manual Plan
    function bindAutoPlanRadios() {

      const manualCard = document.getElementById('manualPlanCard');
      const fields = manualCard.querySelectorAll('.manual-field');

      document.querySelectorAll('input[name="paymentPlan"]').forEach(radio => {
        radio.addEventListener('change', () => {
          selectedPlan = radio.id; // (‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "plan1" ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡πÅ‡∏Ñ‡πà radio ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)

          // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plan1: ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á "‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå" = autoPlan.down
          if (selectedPlan === 'plan1') {
            document.getElementById('manualDown').value = window._autoPlan.down;
          }

          // ‡∏ã‡πà‡∏≠‡∏ô/‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå data-type="plan1" ‡∏Å‡∏±‡∏ö data-type="common"
          fields.forEach(f => {
            if (f.dataset.type === 'plan1' || f.dataset.type === 'common')
              f.classList.remove('hidden');
            else
              f.classList.add('hidden');
          });

          calculateManualPlan();
          renderStep3Summary();
          updatePlanSummaryDisplay();

          // ‡πÉ‡∏´‡πâ #autoPlans ‡πÅ‡∏•‡∏∞ #manualPlanCard ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠
          document.getElementById('autoPlans').classList.remove('hidden');
          manualCard.classList.remove('hidden');
        });
      });
    }

    async function loadActivePromotions() {
  try {
    showToast('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô...', 'info');
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/active', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const js = await res.json();
    if (js.status === 'success') {
      activePromotions = js.data.filter(p => {
        const now = new Date();
        const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
        const startOk  = new Date(p.startDate) <= now;
        const endOk    = new Date(p.endDate) >= now;
        const activeOk = p.isActive === true;
        const usageOk  = !p.usageLimit || (p.usageCount < p.usageLimit);
        return branchOk && startOk && endOk && activeOk && usageOk;
      });
      showToast(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${activePromotions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
    }
  } catch (err) {
    console.error('‚ùå Error loading promotions:', err);
    activePromotions = [];
  }
}

function checkPromotionForProduct(productId) {
  console.log('üîç Checking promotion for product:', productId);
  
  // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å branchInstallments
  const stockItem = branchInstallments.find(item => item._id === productId);
  if (!stockItem) {
    console.log('‚ùå Stock item not found');
    return false;
  }
  
  console.log('üì¶ Stock item found:', {
    _id: stockItem._id,
    name: stockItem.name,
    brand: stockItem.brand
  });
  
  const hasPromo = activePromotions.some(p => {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const allProducts = !p.applicableProducts ||
                       (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);
  
    if (allProducts) {
      console.log(`‚úÖ Promotion "${p.name}" applies to all products`);
      return true;
    }
  
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let matchByName = false;
    if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchByName = p.applicableProducts.some(prod => {
        const stockName = stockItem.name.trim().toLowerCase();
        const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
        return stockName === promoProductName;
      });
    }
  
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Product ID (fallback)
    let matchById = false;
    if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchById = p.applicableProducts.some(prod => {
        const prodId = typeof prod === 'string' ? prod : prod._id;
        return prodId === productId;
      });
    }
  
    return allProducts || matchByName || matchById;
  });
  
  console.log('üî• Has promotion:', hasPromo);
  return hasPromo;
}

function checkBrandHasPromotion(brandKey) {
  const brandProducts = branchInstallments.filter(p => {
    const key = (p.brand || p.name.split(' ')[0]).trim().toLowerCase();
    return key === brandKey;
  });
  
  return brandProducts.some(product => checkPromotionForProduct(product._id));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
function checkGroupHasPromotion(groupItems) {
  return groupItems.some(item => checkPromotionForProduct(item._id));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Confetti Effect
function createConfettiEffect(element) {
  const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
  const confettiCount = 30;
  
  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-10px';
    confetti.style.opacity = '1';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    confetti.style.transition = 'all 1s ease-out';
  
    element.appendChild(confetti);
  
    setTimeout(() => {
      confetti.style.top = '100%';
      confetti.style.opacity = '0';
      confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
    }, 10);
  
    setTimeout(() => confetti.remove(), 1000);
  }
}

function checkPromotionForProduct(productId) {
  console.log('üîç Checking promotion for product:', productId);
  
  // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å branchInstallments
  const stockItem = branchInstallments.find(item => item._id === productId);
  if (!stockItem) {
    console.log('‚ùå Stock item not found');
    return false;
  }
  
  console.log('üì¶ Stock item found:', {
    _id: stockItem._id,
    name: stockItem.name,
    brand: stockItem.brand
  });
  
  const hasPromo = activePromotions.some(p => {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const allProducts = !p.applicableProducts ||
                       (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);
  
    if (allProducts) {
      console.log(`‚úÖ Promotion "${p.name}" applies to all products`);
      return true;
    }
  
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    let matchByName = false;
    if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchByName = p.applicableProducts.some(prod => {
        const stockName = stockItem.name.trim().toLowerCase();
        const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
        return stockName === promoProductName;
      });
    }
  
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Product ID (fallback)
    let matchById = false;
    if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchById = p.applicableProducts.some(prod => {
        const prodId = typeof prod === 'string' ? prod : prod._id;
        return prodId === productId;
      });
    }
  
    return allProducts || matchByName || matchById;
  });
  
  console.log('üî• Has promotion:', hasPromo);
  return hasPromo;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
function checkBrandHasPromotion(brandKey) {
  const brandProducts = branchInstallments.filter(p => {
    const key = (p.brand || p.name.split(' ')[0]).trim().toLowerCase();
    return key === brandKey;
  });
  
  return brandProducts.some(product => checkPromotionForProduct(product._id));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
function checkGroupHasPromotion(groupItems) {
  return groupItems.some(item => checkPromotionForProduct(item._id));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Confetti Effect
function createConfettiEffect(element) {
  const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
  const confettiCount = 30;
  
  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-10px';
    confetti.style.opacity = '1';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    confetti.style.transition = 'all 1s ease-out';
  
    element.appendChild(confetti);
  
    setTimeout(() => {
      confetti.style.top = '100%';
      confetti.style.opacity = '0';
      confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
    }, 10);
  
    setTimeout(() => confetti.remove(), 1000);
  }
}

async function checkAvailablePromotions() {
  if (!cartItems.length) {
    appliedPromotions = {};
    return;
  }
  try {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    const ids = [...new Set(cartItems.map(i => i._id))];
    const res = await fetch('/api/promotion/check-available', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+token,'Content-Type':'application/json' },
      body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    if (js.status === 'success') displayAvailablePromotions(js.data);
  } catch (err) {
    console.error('‚ùå Error checking promotions:', err);
    appliedPromotions = {};
  }
}

function displayAvailablePromotions(data) {
  appliedPromotions = {};
  cartItems.forEach(item => {
    const promos = data[item._id] || [];
    if (promos.length) {
      const best = promos.reduce((b,p) => {
        const val = p.type === 'percentage'
          ? item.pricePayOff * (p.discount/100)
          : p.type === 'fixed'
            ? p.discount
            : 0;
        const bval = b.type === 'percentage'
          ? item.pricePayOff * (b.discount/100)
          : b.type === 'fixed'
            ? b.discount
            : 0;
        return val > bval ? p : b;
      });
      appliedPromotions[item._id] = best;
    }
  });
  renderCart();
}

function calculatePromotionDiscount() {
  let totalDiscount = 0, details = [];
  Object.entries(appliedPromotions).forEach(([pid,promo]) => {
    const item = cartItems.find(i=>i._id===pid);
    if (!item) return;
    const disc = promo.type === 'percentage'
      ? item.pricePayOff * (promo.discount/100)
      : promo.type === 'fixed'
        ? promo.discount
        : 0;
    totalDiscount += disc;
    details.push({ name: promo.name, discount: disc, productName: item.name });
  });
  return { totalDiscount, details };
}

async function recordPromotionUsage(promotionId) {
  try {
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/use', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ promotionId })
    });
    const js = await res.json();
    if (js.status !== 'success') {
      console.error('Failed to record promotion usage:', js.message);
    }
  } catch (err) {
    console.error('Error recording promotion usage:', err);
  }
}

    function updatePlanSummaryDisplay() {
      const planSummary = getPlanSummaryText();
      let display = document.getElementById('step3PlanSummaryDisplay');
      if (!display) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ div ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        display = document.createElement('div');
        display.id = 'step3PlanSummaryDisplay';
        display.className = 'p-3 rounded bg-blue-50 text-lg font-semibold text-blue-700 mb-3 text-center';
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        const cardBody = document.querySelector('#step3 .card-body');
        if (cardBody) cardBody.prepend(display);
      }
      display.textContent = planSummary;
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
      console.log('PlanSummaryDisplay:', planSummary);
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á renderAutoPlans/bindAutoPlanRadios
    document.querySelectorAll('input[name="paymentPlan"]').forEach(radio => {
      radio.addEventListener('change', updatePlanSummaryDisplay);
    });
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô load
    updatePlanSummaryDisplay();


    async function loadQuotationPdf(orderId) {
      try {
        const res = await fetch(`/api/quotation/${orderId}/pdf`, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
            'Accept': 'application/pdf'
          }
        });
        console.log('Fetch PDF status:', res.status);
        if (!res.ok) {
          const text = await res.text();
          console.error('PDF error body:', text);
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const blob = await res.blob();
        document.getElementById('quotationPdfViewer').src = URL.createObjectURL(blob);
      } catch (err) {
        console.error('loadQuotationPdf failed:', err);
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ PDF: ${err.message}`);
      }
    }













    function initManualTerms() {
      const max = getManualMaxTerms();
      const sel = document.getElementById('manualTerms');
      sel.innerHTML = Array.from({ length: max }, (_, i) =>
        `<option value="${i + 1}">${i + 1} ‡∏á‡∏ß‡∏î</option>`
      ).join('');
      sel.value = max;
      sel.removeEventListener('change', calculateManualPlan);
      sel.addEventListener('change', calculateManualPlan);
      calculateManualPlan();
    }
    function getManualMaxTerms() {
      if (!cartItems.length) return 0;
      // ‡∏Å‡∏£‡∏ì‡∏µ Plan1: ‡πÉ‡∏ä‡πâ‡∏á‡∏ß‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏à‡∏≤‡∏Å downInstallmentCount ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
      return Math.min(...cartItems.map(it => it.downInstallmentCount));
    }
// 2) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô calculateManualPlan
function calculateManualPlan() {
  // 1) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏° (autoPlan ‡∏Ç‡∏≠‡∏á Plan 1)
  const originalTotal = window._autoPlan.down + window._autoPlan.perMonth * window._autoPlan.count;

  // 2) ‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å input
  const D = Number(document.getElementById('manualDown').value) || 0;

  // 3) ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô STEP 2)
  const docFee = Number(document.getElementById('documentFee').value) || 0;

  // 4) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î
  const n = Number(document.getElementById('manualTerms').value) || 1;

  // 5) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = floor((originalTotal ‚àí D ‚àí docFee) / n)
  const base = n > 0
    ? Math.floor((originalTotal - D - docFee) / n)
    : (originalTotal - D - docFee);
  window._manualInst = base;

  // 6) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  document.getElementById('manualInstallmentAmount').textContent = base.toLocaleString();

  // 7) ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏£‡∏∏‡∏õ Plan 1
  renderManualPlanSummary();
}

// 3) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderManualPlanSummary ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ
function renderManualPlanSummary() {
  // 1) ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î (n) ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (baseDown)
  const n = Number(document.getElementById('manualTerms').value) || 1;
  const baseDown = Number(document.getElementById('manualDown').value) || 0;

  // 2) ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  const docFee = Number(document.getElementById('documentFee').value) || 0;

  // 3) ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ß‡πâ)
  const baseInstallment = window._manualInst || 0;

  // 4) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÉ‡∏ô cartItems
  //
  //    ‡∏™‡∏π‡∏ï‡∏£ VAT ‡∏ñ‡πâ‡∏≤ rate ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (0.07 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 7%) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô:
  //       VAT = amountInclusive * rate / (1 + rate)
  //
  let vatAmount = 0;        // ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î VAT ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  let displayDown = baseDown;           // ‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏á)
  let displayInstallment = baseInstallment; // ‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏á)

  cartItems.forEach(it => {
    // ‡∏´‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ VAT ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
    if (it.taxType === '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT') return;

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤ % ‡πÄ‡∏õ‡πá‡∏ô decimal ‡πÄ‡∏ä‡πà‡∏ô 7 ‚Üí 0.07
    const rate = (it.taxRate || 0) / 100;

    if (window.selectedManualOption === 'option1') {
      // **‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå**: ‡∏ô‡∏±‡∏ö VAT ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      //
      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ it.downAmount ‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏£‡∏ß‡∏° VAT ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å VAT ‡∏≠‡∏≠‡∏Å:
      //    vatDown = it.downAmount * rate / (1 + rate)
      //
      const downAmt = Number(it.downAmount) || 0;
      const vatDown = downAmt * rate / (1 + rate);
      vatAmount += vatDown;

    } else if (window.selectedManualOption === 'option2') {
      // **‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î**: ‡∏ô‡∏±‡∏ö VAT ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      //
      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ it.installmentAmount ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏£‡∏ß‡∏° VAT ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      // ‡πÅ‡∏•‡∏∞ it.termCount ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î
      //    totalInst = it.installmentAmount * it.termCount
      //    vatInst   = totalInst * rate / (1 + rate)
      //
      const instAmt = Number(it.installmentAmount) || 0;
      const termCnt = Number(it.termCount) || 0;
      const totalInst = instAmt * termCnt;
      const vatInst = totalInst * rate / (1 + rate);
      vatAmount += vatInst;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏°‡∏µ VAT" ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  });

  // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© VAT ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
  vatAmount = Math.round(vatAmount * 100) / 100;

  // 5) ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å VAT
  if (window.selectedManualOption === 'option1') {
    // ‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå:
    //   - ‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å VAT ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ it.downAmount ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏° VAT ‡πÅ‡∏•‡πâ‡∏ß)
    //   - ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡∏°‡∏°‡∏ï‡∏¥ originalTotal = baseDown + baseInstallment*n + docFee)
    //
    displayDown = baseDown; // baseDown ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏£‡∏ß‡∏° VAT ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö input ‡∏à‡∏£‡∏¥‡∏á)
    // ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏™‡∏î‡∏á "‡∏£‡∏ß‡∏° VAT" ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å vatAmount ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏ï‡πá‡∏°‡πÜ
    displayDown = baseDown + vatAmount;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö (‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà baseInstallment ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)
    const totalOriginal = baseDown + (baseInstallment * n) + docFee;
    // ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏° VAT = displayDown + docFee + (‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà * n)
    // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = (totalOriginal - displayDown - docFee) / n
    if (n > 0) {
      displayInstallment = (totalOriginal - displayDown - docFee) / n;
      // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
      displayInstallment = Math.round(displayInstallment * 100) / 100;
    } else {
      displayInstallment = 0;
    }

  } else if (window.selectedManualOption === 'option2') {
    // ‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î:
    //   - ‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (baseDown)
    //   - ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å VAT ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    //
    displayDown = baseDown;
    // VAT ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = vatAmount / n (‡∏´‡∏≤‡∏Å‡∏ô > 0)
    const vatPerMonth = n > 0 ? Math.round((vatAmount / n) * 100) / 100 : 0;
    displayInstallment = baseInstallment + vatPerMonth;

  } else {
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ VAT (option3 ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ):
    //   - ‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå = baseDown
    //   - ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î = baseInstallment
    displayDown = baseDown;
    displayInstallment = baseInstallment;
  }

  // 6) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ (before VAT ‡πÅ‡∏•‡∏∞ grand total)
  //    - totalBeforeVAT: ‡∏£‡∏ß‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå + (‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î) + ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°
  //    - grandTotal: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ VAT ‚Üí ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö totalBeforeVAT
  //                  ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ VAT ‚Üí ‡∏ö‡∏ß‡∏Å vatAmount ‡πÄ‡∏û‡∏¥‡πà‡∏°
  const totalBeforeVAT = displayDown + (displayInstallment * n) + docFee;
  const grandTotal = (window.selectedManualOption === 'option3')
    ? totalBeforeVAT
    : Math.round((totalBeforeVAT + vatAmount) * 100) / 100;

  // 7) ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô
  const summaryHtmlPart1 = `
    <div class="p-4 space-y-2 border rounded-lg bg-blue-50">
      <div>‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå${window.selectedManualOption === 'option1' ? ' (‡∏£‡∏ß‡∏° VAT)' : ''}: 
        <span class="font-medium">‡∏ø${displayDown.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
      </div>
      <div>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <span class="font-medium">‡∏ø${docFee.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span></div>
      <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î: <span class="font-medium">${n} ‡∏á‡∏ß‡∏î</span></div>
      <div>‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${window.selectedManualOption === 'option2' ? ' (‡∏£‡∏ß‡∏° VAT)' : ''}: 
        <span class="font-medium">‡∏ø${displayInstallment.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
      </div>
      <div>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏Å‡πà‡∏≠‡∏ô VAT): <span class="font-medium">‡∏ø${totalBeforeVAT.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span></div>
      ${
        window.selectedManualOption !== 'option3'
          ? `<div>‡∏†‡∏≤‡∏©‡∏µ 7%: <span class="font-medium">‡∏ø${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span></div>`
          : ``
      }
      <div class="mt-2 p-2 bg-white border rounded text-center">
        <strong>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</strong>
        <span class="font-bold text-2xl">‡∏ø${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
      </div>
    </div>
  `;

  const optionsHtmlPart2 = `
    <div class="mt-4 p-4 bg-yellow-50 rounded border border-yellow-200 space-y-3">
      <div class="font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ:</div>
      <label class="flex items-center">
        <input type="radio" name="manualOption" value="option1"
               ${window.selectedManualOption === 'option1' ? 'checked' : ''} class="mr-2" />
        <div>
          <strong>‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå</strong>
          <span class="text-sm text-gray-600 ml-2">(VAT ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå)</span>
        </div>
      </label>
      <label class="flex items-center">
        <input type="radio" name="manualOption" value="option2"
               ${window.selectedManualOption === 'option2' ? 'checked' : ''} class="mr-2" />
        <div>
          <strong>‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î</strong>
          <span class="text-sm text-gray-600 ml-2">(VAT ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>
        </div>
      </label>
      <label class="flex items-center">
        <input type="radio" name="manualOption" value="option3"
               ${window.selectedManualOption === 'option3' ? 'checked' : ''} class="mr-2" />
        <div>
          <strong>‡πÑ‡∏°‡πà‡∏°‡∏µ VAT</strong>
          <span class="text-sm text-gray-600 ml-2">(‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°)</span>
        </div>
      </label>
    </div>
  `;

  // 8) ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window._displayValues (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠)
  window._displayValues = {
    down: displayDown,
    installment: displayInstallment,
    vat: vatAmount,
    taxType: window.selectedManualOption
  };

  // 9) ‡πÄ‡∏≠‡∏≤ HTML ‡∏°‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô element .cart-summary
  const finalHtml = summaryHtmlPart1 + optionsHtmlPart2;
  document.querySelectorAll('#step3 .cart-summary').forEach(el => {
    el.innerHTML = finalHtml;
  });

// ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì inject finalHtml ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
document.querySelectorAll('input[name="manualOption"]').forEach(radio => {
  radio.addEventListener('change', e => {
    const val = e.target.value;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏µ‡πà taxType === '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasNoVat = cartItems.some(item => item.taxType === '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT');

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ VAT ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å option1 ‡∏´‡∏£‡∏∑‡∏≠ option2
    if (hasNoVat && val !== 'option3') {
      alert('‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏°‡∏µ VAT\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏°‡∏µ VAT" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ option3
      document.querySelector('input[name="manualOption"][value="option3"]').checked = true;
      window.selectedManualOption = 'option3';
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô ‡∏Å‡πá‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ val ‡πÑ‡∏î‡πâ
      window.selectedManualOption = val;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï property taxType ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô cartItems
    cartItems.forEach(item => {
      if (window.selectedManualOption === 'option1') {
        item.taxType = '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå';
      } else if (window.selectedManualOption === 'option2') {
        item.taxType = '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î';
      } else {
        item.taxType = '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT';
      }
    });

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà
    renderManualPlanSummary();
  });
});
}





    // =========================== I) CAMERA & SIGNATURE ===========================
    function setupIDCamera() {
      const btnStart = document.getElementById('btnStartIdCamera');
      const btnCapture = document.getElementById('btnCaptureId');
      const btnRetake = document.getElementById('btnRetakeId');
      const container = document.getElementById('idCaptureContainer');
      const canvas = document.getElementById('idCanvas');
      const inputData = document.getElementById('idImageData');
      const inputUrl = document.getElementById('idCardImageUrl');
      let idStream = null;

      if (!btnStart || !btnCapture || !btnRetake || !container || !canvas || !inputData || !inputUrl) return;

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      btnStart.addEventListener('click', async () => {
        try {
          idStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          const video = container.querySelector('video');
          video.srcObject = idStream;
          await video.play();
          btnCapture.disabled = false;
        } catch (err) {
          console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á:', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'error');
        }
      });

      // ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      btnCapture.addEventListener('click', async () => {
        const video = container.querySelector('video');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        // ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÑ‡∏ß‡πâ preview (‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö data ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback)
        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        inputData.value = dataURL;

        // preview
        container.innerHTML = `<img src="${dataURL}" class="w-full h-full object-contain rounded" alt="ID Preview"/>`;
        idStream.getTracks().forEach(t => t.stop());
        btnStart.classList.add('hidden');
        btnCapture.classList.add('hidden');
        btnRetake.classList.remove('hidden');

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        try {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const url = await uploadFile(
            blob,
            '/api/upload/id-card',
            'file',         // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö multer.single('file') ‡∏ö‡∏ô server
            'id-card.jpg'   // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
          );
          inputUrl.value = url;
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('Upload ID card failed:', err);
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        }
      });

      // ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
      btnRetake.addEventListener('click', () => {
        container.innerHTML = `
      <video id="idVideo" autoplay playsinline muted
             class="absolute inset-0 w-full h-full object-cover"></video>
      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <img src="/uploads/‡∏ö‡∏±‡∏ï‡∏£.png"
             class="w-full h-full object-contain pointer-events-none"
             alt="ID template overlay"/>
      </div>
    `;
        btnStart.classList.remove('hidden');
        btnCapture.classList.remove('hidden');
        btnRetake.classList.add('hidden');
      });
    }
    function setupSelfieCamera() {
      const btnStart = document.getElementById('btnStartSelfie');
      const btnCapture = document.getElementById('btnCaptureSelfie');
      const video = document.getElementById('selfieVideo');
      const canvas = document.getElementById('selfieCanvas');
      const inputData = document.getElementById('selfieDataURL');
      const inputUrl = document.getElementById('selfieUrl');

      let selfieStream = null;

      // 1) ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á -> ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á video
      btnStart.addEventListener('click', async () => {
        try {
          selfieStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: 'environment' } }
          });
          video.srcObject = selfieStream;
          await video.play();
          video.classList.remove('hidden');
          btnCapture.disabled = false;
        } catch (err) {
          console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á:', err);
          // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á fallback ‡πÑ‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
          try {
            selfieStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = selfieStream;
            await video.play();
            video.classList.remove('hidden');
            btnCapture.disabled = false;
            showToast('‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ (fallback)', 'warning');
          } catch (err2) {
            console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà:', err2);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà', 'error');
            btnStart.disabled = true;
          }
        }
      });

      // 2) ‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ -> capture, upload, ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      btnCapture.addEventListener('click', async () => {
        // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å video ‡∏•‡∏á canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡πÄ‡∏õ‡πá‡∏ô fallback
        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
        inputData.value = dataUrl;
        canvas.classList.remove('hidden');

        try {
          // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob (fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ null)
          let blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
          if (!blob) {
            const res = await fetch(dataUrl);
            blob = await res.blob();
          }
          // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
          const url = await uploadFile(
            blob,
            '/api/upload/selfie',
            'file',
            'selfie.jpg'
          );
          inputUrl.value = url;
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('Upload selfie failed:', err);
          showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
        } finally {
          // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
          if (selfieStream) {
            selfieStream.getTracks().forEach(track => track.stop());
            selfieStream = null;
          }
          btnCapture.disabled = true;
          btnStart.disabled = false;
        }
      });
    }

    function setupSignaturePad() {
      // ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Äî
      const canvasEl = document.getElementById('signaturePad');
      const ctx = canvasEl.getContext('2d');

      // ‡πÉ‡∏´‡πâ canvas ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏° DPI ‡∏à‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á
        const data = signaturePad.toData();
        canvasEl.width = canvasEl.offsetWidth * ratio;
        canvasEl.height = canvasEl.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
        signaturePad.clear();
        signaturePad.fromData(data);
      }
      window.addEventListener('resize', resizeCanvas);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á SignaturePad ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏≤-‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå
      signaturePad = new SignaturePad(canvasEl, {
        backgroundColor: 'rgba(255,255,255,0)',
        penColor: 'black',
        minWidth: 0.5,
        maxWidth: 2.5,
        velocityFilterWeight: 0.7
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      resizeCanvas();

      document.getElementById('btnClearSignature')
        .addEventListener('click', () => signaturePad.clear());

      // ‚Äî ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ ‚Äî
      const empCanvas = document.getElementById('employeeSignaturePad');
      const empCtx = empCanvas.getContext('2d');

      function resizeEmpCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const data2 = empPad.toData();
        empCanvas.width = empCanvas.offsetWidth * ratio;
        empCanvas.height = empCanvas.offsetHeight * ratio;
        empCtx.scale(ratio, ratio);
        empPad.clear();
        empPad.fromData(data2);
      }
      window.addEventListener('resize', resizeEmpCanvas);

      empPad = new SignaturePad(empCanvas, {
        backgroundColor: 'rgba(255,255,255,0)',
        penColor: 'black',
        minWidth: 0.5,
        maxWidth: 2.5,
        velocityFilterWeight: 0.7
      });
      resizeEmpCanvas();

      document.getElementById('btnClearEmpSignature')
        .addEventListener('click', () => empPad.clear());
    }



    // =========================== J) MISC ACTIONS (Dark, ToggleMenu, Logout) ===========================
    function toggleDarkMode() {
      const htmlEl = document.documentElement;
      const label = document.getElementById('darkModeLabel');
      if (htmlEl.classList.contains('dark')) {
        htmlEl.classList.remove('dark');
        if (label) label.textContent = 'Dark Mode';
      } else {
        htmlEl.classList.add('dark');
        if (label) label.textContent = 'Light Mode';
      }
    }
    function logout() {
    // ‡∏•‡∏ö token ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    localStorage.removeItem('authToken');
    // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ü
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ login
    window.location.href = '/login';
}
    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
  
      sb.classList.toggle('-translate-x-full');
      mc.classList.toggle('ml-64');
      mc.classList.toggle('ml-0');
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }
    function togglePlan2Detail() {
      const plan2Detail = document.querySelector('.plan2-detail');
      const plan2Radio = document.getElementById('plan2');
      if (plan2Detail && plan2Radio) {
        plan2Detail.style.display = plan2Radio.checked ? 'block' : 'none';
      }
    }

    // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
    async function downloadQuotationPdf() {
      const id = window.currentQuotationId || window.currentQuotationNumber;
      if (!id) {
        return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
      }
      const token = localStorage.getItem('authToken') || '';
      try {
        const res = await fetch(`/api/quotation/${id}/pdf`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error(res.error || `HTTP ${res.status}`);
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Quotation-${id}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Download failed:', err);
        alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + err.message);
      }
    }


    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á Sidebar (‡∏à‡∏∞ inject ‡∏õ‡∏∏‡πà‡∏° btnToggleMenu, btnLogout, btnToggleDark, #employeeName/#employeePhoto ‡∏•‡∏á DOM)
      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
await loadEmployeeProfile();
await loadActivePromotions();

// Dark mode setup
const darkMode = localStorage.getItem('darkMode');
if (darkMode === 'true') {
  document.documentElement.classList.add('dark');
}

// Event listeners
document.getElementById('btnToggleMenu').addEventListener('click', toggleMenu);
document.getElementById('btnToggleDark').addEventListener('click', toggleDarkMode);
document.getElementById('btnLogout').addEventListener('click', logout);

      // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Sidebar DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß)
      await loadEmployeeProfile();

      // 3) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å, branch, bind events...
      await loadBranchInstallments();
      await loadBranchInfo();
      loadLevel1();

     // 4) ‡∏ú‡∏π‡∏Å Event ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å ‡πÜ
     document.getElementById('btnToggleMenu')?.addEventListener('click', toggleMenu);
     document.getElementById('btnToggleDark')?.addEventListener('click', toggleDarkMode);
     document.getElementById('btnLogout')?.addEventListener('click', logout);
document.getElementById('step2Discount').addEventListener('input', updateStep2Summary);
document.querySelectorAll('input[name="pickupMethod"]').forEach(r => r.addEventListener('change', updateStep2Summary));

     // Step navigation
     document.getElementById('btnStep1ToStep2')?.addEventListener('click', () => goToStep(2));
     document.getElementById('btnStep2ToStep1')?.addEventListener('click', () => goToStep(1));
     document.getElementById('btnStep3ToStep2')?.addEventListener('click', () => goToStep(2));
     document.getElementById('btnStep4ToStep1')?.addEventListener('click', () => goToStep(1));

     // <<< ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ STEP4 >>>
document.getElementById('btnStep3ToStep4')?.addEventListener('click', async () => {
  // 1) ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
  document.getElementById('invoicePrintModal').checked = false;

  // 2) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç order_id/poNumber ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
  //    ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏ä‡∏∑‡πà‡∏≠ window.currentInvoiceId ‡πÅ‡∏•‡∏∞ window.currentInvoiceNumber
  if (!window.currentInvoiceId || !window.currentInvoiceNumber) {
    showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö order_id ‡∏´‡∏£‡∏∑‡∏≠ poNumber ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
    return;
  }

  try {
    // 3) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    for (const item of cartItems) {
      const payload = {
        branch_code: BRANCH_CODE,                      // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤
        poNumber: window.currentInvoiceNumber,         // ‡πÄ‡∏•‡∏Ç PO/‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Key ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
        order_id: window.currentInvoiceId,             // ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ (ObjectId ‡πÅ‡∏ö‡∏ö string)
        product_id: item._id.toString(),               // _id ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å (string 24 ‡∏´‡∏•‡∏±‡∏Å)
        qty: 1                                         // ‡∏•‡∏î‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô ‡∏Å‡πá‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô item.qty ‡πÑ‡∏î‡πâ)
      };

      const res = await fetch('/api/branch-stock/decrement', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (!js.success) {
        console.error('‚ùå ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', js.error);
        showToast('‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + js.error, 'error');
        return; // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÑ‡∏õ Step 4
      }
    }

    showToast('‚úÖ ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

  } catch (err) {
    console.error('Error during decrementStock:', err);
    showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
    return; // ‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡πÑ‡∏õ Step 4
  }

  // 4) ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡πÑ‡∏õ STEP 4
  goToStep(4);

  // 5) ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  setTimeout(() => {
    cartItems = [];
    hiddenProductIds.clear();
    renderCart();
    document.getElementById('customerFirstName').value = '';
    document.getElementById('customerLastName').value = '';
    document.getElementById('customerIdCard').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
    setTimeout(() => goToStep(1), 5000);
  }, 1000);
});

// ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ (‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ step ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ)
document.querySelectorAll('.step').forEach(el => {
  el.style.cursor = 'pointer';
  el.addEventListener('click', () => {
    const target = Number(el.getAttribute('data-step'));
    const current = Number(document.querySelector('.step.active').getAttribute('data-step'));
    if (target <= current) {
      goToStep(target);
    }
  });
});


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
async function checkStockAfterSale() {
  try {
    const token = localStorage.getItem('authToken');
  
    for (const item of cartItems) {
      const res = await fetch(`/api/branch-stock/${item._id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
  
      const data = await res.json();
  
      if (data.success) {
        console.log(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á ${item.name}:`, data.data?.stock_value || 0);
      }
    }
  } catch (err) {
    console.error('Error checking stock:', err);
  }
}



    // ‡πÅ‡∏ó‡∏£‡∏Å‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô goToStep ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™ active/completed ‡πÄ‡∏™‡∏£‡πá‡∏à
function goToStep(stepNumber) {
  // ‚Ä¶ existing code ‚Ä¶
  // Update step-content
  document.querySelectorAll('.step-content').forEach(st => st.classList.remove('active'));
  const target = document.getElementById('step' + stepNumber);
  if (target) target.classList.add('active');
  // Update visual stepper
  document.querySelectorAll('.step').forEach(elem => {
    const s = Number(elem.getAttribute('data-step'));
    elem.classList.remove('active', 'completed');
    if (s < stepNumber) elem.classList.add('completed');
    else if (s === stepNumber) elem.classList.add('active');
  });

  // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ >>>
  if (stepNumber === 4) {
    // ‡∏£‡∏≠ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ STEP1 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    setTimeout(() => goToStep(1), 5000);
  }
}

// 4) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡πÉ‡∏ô STEP3
document.getElementById('btnStep3Save')?.addEventListener('click', async () => {
  try {
    // ‚Äî 1) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ STEP 2 ‚Äî
    const shippingFee = parseInt(document.getElementById('shippingFee').value, 10) || 0;
    const docFee = parseInt(document.getElementById('documentFee').value, 10) || 0;
    const discountVal = parseInt(document.getElementById('step2Discount').value, 10) || 0;
    const planSummary = getPlanSummaryText();

    // ‚Äî 2) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ STEP 2‚ÄìCustomer ‚Äî
    const customer = {
      name: `${(document.getElementById('customerPrefix').value || '')}${document.getElementById('customerFirstName').value} ${document.getElementById('customerLastName').value}`.trim(),
      address: `${document.getElementById('houseNo').value} ‡∏´‡∏°‡∏π‡πà ${document.getElementById('moo').value} ` +
               `‡∏ï.${document.getElementById('subDistrict').value} ‡∏≠.${document.getElementById('district').value} ` +
               `‡∏à.${document.getElementById('province').value} ${document.getElementById('zipcode').value}`.trim(),
      taxId: document.getElementById('customerIdCard').value,
      phone: document.getElementById('customerPhone').value
    };

    // ‚Äî 3) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ STEP 3 (Manual Plan) ‚Äî
    const manualDown = window._displayValues?.down || Number(document.getElementById('manualDown').value) || 0;
    const manualTerms = Number(document.getElementById('manualTerms').value) || 0;
    const manualInstAmt = window._displayValues?.installment || Number(
      document.getElementById('manualInstallmentAmount')
        .textContent
        .replace(/,/g, '')
    ) || 0;

    // ‚Äî ‚ù∂ ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‚Äî
    const paymentMethod = document.querySelector('input[name="payType"]:checked')?.value || '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';

    // ‚Äî ‚ù∑ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î taxType ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî
    const selectedTaxType = window.selectedManualOption === 'option1'
                              ? '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå'
                            : window.selectedManualOption === 'option2'
                              ? '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î'
                              : '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT';

    // ‚Äî üÜï ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‚Äî
    const { totalDiscount: promotionDiscount, details: promoDetails } = calculatePromotionDiscount();
    const usedPromotions = Object.values(appliedPromotions).filter(p => p);

    // ‚Äî 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á array items ‚Äî
    const invoiceItems = cartItems.map(it => {
      // ‡πÅ‡∏õ‡∏•‡∏á _id ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string 24 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
      const rawId = (typeof it._id === 'string') ? it._id : it._id.toString();
      const productId = rawId.trim();
      if (!/^[0-9a-fA-F]{24}$/.test(productId)) {
        throw new Error(`"${productId}" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ObjectId ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (24 ‡∏´‡∏•‡∏±‡∏Å hex)`);
      }
  
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°: ‡∏î‡∏≤‡∏ß‡∏ô‡πå + (‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î)
      const basePrice = manualDown + manualInstAmt * manualTerms;
  
      // üÜï ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
      const promo = appliedPromotions[it._id];
      let itemDiscount = 0;
      if (promo) {
        itemDiscount = promo.type === 'percentage'
          ? basePrice * (promo.discount / 100)
          : promo.discount;
      }
  
      return {
        product: productId,
        description: it.name,
        imei: it.imei || '',
        quantity: 1,
        unitPrice: basePrice,
        discount: itemDiscount, // üÜï ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        downAmount: manualDown,
        termCount: manualTerms,
        installmentAmount: manualInstAmt,
        taxRate: it.taxRate || 7,
        taxType: selectedTaxType,
        totalPrice: basePrice - itemDiscount, // üÜï ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        promotion: promo ? { // üÜï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
          id: promo.id || promo._id,
          name: promo.name,
          type: promo.type,
          discount: promo.discount
        } : null
      };
    });

    // ‚Äî 5) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô (Subtotal) ‚Äî
    const subtotal = invoiceItems.reduce((sum, i) => sum + (i.unitPrice * i.quantity), 0);

    // ‚Äî 6) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî
    let vatTotal = 0;
    if (selectedTaxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå') {
      invoiceItems.forEach(i => {
        const vatDown = i.downAmount * i.taxRate / (100 + i.taxRate);
        vatTotal += vatDown;
      });
    } else if (selectedTaxType === '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î') {
      invoiceItems.forEach(i => {
        const totalInst = i.installmentAmount * i.termCount;
        const vatInst = totalInst * i.taxRate / (100 + i.taxRate);
        vatTotal += vatInst;
      });
    }
    vatTotal = Math.round(vatTotal * 100) / 100;

    // ‚Äî 7) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì beforeTax ‡πÅ‡∏•‡∏∞ netTotal ‚Äî
    const beforeTax = subtotal - discountVal - promotionDiscount + docFee + shippingFee; // üÜï ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    const netTotal = beforeTax + vatTotal;

    // ‚Äî 8) ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‚Äî
    const salespersonNameField = document.getElementById('salespersonName');
    const salespersonName = (salespersonNameField && salespersonNameField.value.trim())
                             ? salespersonNameField.value.trim()
                             : (window.employeeName || '').trim();

    console.log('[STEP3] Salesperson name that will be sent:', salespersonName);
  
    const salespersonSignatureUrl = document.getElementById('salespersonSignatureUrl')?.value || '';
    const authorizedSignatureUrl = document.getElementById('pdfAuthSignature')?.src || '';
    const customerSignatureUrl = document.getElementById('customerSignatureUrl')?.value || '';

    // ‚Äî 9) ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‚Äî
    const payload = {
      type: selectedTaxType !== '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT' ? 'TAX_INVOICE' : 'RECEIPT',
      date: new Date().toISOString(),
      branchCode: BRANCH_CODE,
      pickupMethod: document.querySelector('input[name="pickupMethod"]:checked')?.value || '',
      shippingFee,
      docFee,
      discount: discountVal,
      promotionDiscount: promotionDiscount, // üÜï ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
      planSummaryText: planSummary,
      customer,
      salespersonName: salespersonName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)',
      salespersonSignatureUrl: salespersonSignatureUrl,
      items: invoiceItems,
      summary: {
        financedTotal: invoiceItems.reduce((sum, i) => sum + (i.installmentAmount * i.termCount), 0),
        downTotal: invoiceItems.reduce((sum, i) => sum + (i.downAmount || 0), 0),
        subtotal: subtotal,
        discount: discountVal,
        promotionDiscount: promotionDiscount, // üÜï
        beforeTax: beforeTax,
        tax: vatTotal,
        netTotal: netTotal
      },
      appliedPromotions: usedPromotions, // üÜï ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
      customerSignatureUrl: customerSignatureUrl,
      authorizedSignatureUrl: authorizedSignatureUrl,
      paymentMethod: paymentMethod
    };

    // ‚Äî 10) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API /api/receipt (POST) ‚Äî
    const token = localStorage.getItem('authToken') || '';
    const res = await fetch('/api/receipt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(payload)
    });
    const js = await res.json();
    if (!js.success) throw new Error(js.error || js.message);

    // ‚Äî 11) ‡πÄ‡∏Å‡πá‡∏ö _id ‡∏Ç‡∏≠‡∏á Invoice ‡πÉ‡∏´‡∏°‡πà ‚Äî
    window.currentInvoiceId = js.data._id;
    window.currentInvoiceNumber = js.data.invoiceNumber;

    // ‚Äî üÜï 12) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‚Äî
    if (usedPromotions.length > 0) {
      for (const promo of usedPromotions) {
        await recordPromotionUsage(promo.id || promo._id);
      }
    }

    // ‚Äî 13) ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î Modal ‚Äî
    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ', 'success');
    document.getElementById('invoicePrintModal').checked = true;

    // ‚Äî üÜï 14) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚Äî
    appliedPromotions = {};

  } catch (err) {
    console.error('Error creating invoice:', err);
    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
  }
});

// 5) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å option1 (‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå)
if (!window.selectedManualOption) {
  window.selectedManualOption = 'option1';
}

// 2) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ" (btnModalDownloadInvoicePdf)
//    ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GET /api/receipt/:id/pdf (‡πÉ‡∏ä‡πâ window.currentInvoiceId) ‚Üí ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF
async function downloadInvoicePdf() {
  const id = window.currentInvoiceId;
  const invoiceNo = window.currentInvoiceNumber;
  if (!id) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Invoice ID ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }

  const token = localStorage.getItem('authToken') || '';
  try {
    const res = await fetch(`/api/receipt/${encodeURIComponent(id)}/pdf`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/pdf'
      }
    });
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        return window.location.href = '/login';
      }
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å invoiceNumber
    a.download = `${invoiceNo}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error('PDF download error:', err);
    alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
  }
}

// ‡∏ú‡∏π‡∏Å event ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal
document.getElementById('btnModalDownloadInvoicePdf')
  .addEventListener('click', async () => {
    await downloadInvoicePdf();
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ user ‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÄ‡∏≠‡∏á
  });


      // ‡∏õ‡∏¥‡∏î Order Success Modal
      document.getElementById('btnCloseSuccessModal')
        ?.addEventListener('click', () => {
          document.getElementById('orderSuccessModal').checked = false;
        });
      // 1) ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤
      branchCode: BRANCH_CODE,

        // Step2 -> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î modal
        document.getElementById('btnStep2OpenModal')
          .addEventListener('click', async () => {
            try {
              // 1) ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà
              const suggestedQuotationNumber = await fetchNextQuotationNumber();

              // 2) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
              const prefix = document.getElementById('customerPrefix').value || '';
              const firstName = document.getElementById('customerFirstName').value || '';
              const lastName = document.getElementById('customerLastName').value || '';
              const customerName = `${prefix}${firstName} ${lastName}`.trim();
              const addressString =
                `${document.getElementById('houseNo').value} ‡∏´‡∏°‡∏π‡πà ${document.getElementById('moo').value} ` +
                `‡∏ï.${document.getElementById('subDistrict').value} ‡∏≠.${document.getElementById('district').value} ` +
                `‡∏à.${document.getElementById('province').value} ${document.getElementById('zipcode').value}`.trim();

              // 3) ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á, ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°, ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
              const pickupMethod = document.querySelector('input[name="pickupMethod"]:checked').value;
              const shippingFee = parseInt(document.getElementById('shippingFee').value, 10) || 0;
              const documentFeeNum = parseInt(document.getElementById('documentFee').value, 10) || 0;
              const discountNum = parseInt(document.getElementById('step2Discount').value, 10) || 0;

              // 4) ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å STEP3)
              const planType = selectedPlan;
              const downPayment = Number(document.getElementById('manualDown').value) || 0;
              const installmentCount = Number(document.getElementById('manualTerms').value) || 0;
              const installmentAmount = Number(
                document.getElementById('manualInstallmentAmount').textContent.replace(/,/g, '')
              ) || 0;

              // 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (items) ‡∏à‡∏≤‡∏Å cartItems
              const items = cartItems.map(it => {
                const down = Number(it.downAmount) || 0;
                const perMonth = Number(it.downInstallment) || 0;
                const terms = Number(it.downInstallmentCount) || 0;
                const total = down + perMonth * terms;
                return {
                  product: it._id,
                  qty: 1,
                  unitPrice: total,
                  totalPrice: total,
                  imei: it.imei,
                  name: it.name,
                  taxRate: it.taxRate || 0,
                  taxType: it.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ VAT'
                };
              });

              // 6) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
              const subtotal = items.reduce((s, i) => s + i.totalPrice, 0);
              const taxTotal = items.reduce((s, i) => s + i.totalPrice * (i.taxRate / 100 || 0), 0);
              const discount = parseInt(document.getElementById('step2Discount').value, 10) || 0;  // ‚Üê use new id
              const netTotal = subtotal + taxTotal + shippingFee + documentFeeNum - discount;

              // 7) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              const quotationPayload = {
                branchCode: BRANCH_CODE,
                quotationNumber: suggestedQuotationNumber,
                date: new Date().toISOString(),
                customer: {
                  name: customerName,
                  firstName,
                  lastName,
                  phone: document.getElementById('customerPhone').value,
                  email: document.getElementById('customerEmail').value,
                  taxId: document.getElementById('customerIdCard').value,
                  address: addressString
                },
                items,
                summary: {
                  subtotal: subtotal,
                  beforeTax: subtotal,
                  shipping: shippingFee,
                  discount: discountNum,
                  tax: taxTotal,
                  afterTax: netTotal,
                  netTotal: netTotal
                },
                docFee: documentFeeNum,
                discount: discountNum,
                pickupMethod,
                shippingFee,
                customerSignatureUrl: document.getElementById('customerSignatureUrl').value,
                salespersonSignatureUrl: document.getElementById('salespersonSignatureUrl').value,
                planType,
                downPayment,
                installmentCount,
                installmentAmount
              };

              // 8) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (API: POST /api/quotation)
              const resQ = await fetch('/api/quotation', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                },
                body: JSON.stringify(quotationPayload)
              });
              const jsQ = await resQ.json();
              if (!jsQ.success) throw new Error(jsQ.error || jsQ.message);

              // 9) ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ ID ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              const actualQuotationNumber = jsQ.data.quotationNumber;
              window.currentQuotationId = jsQ.data._id || jsQ.data.id;
              window.currentQuotationNumber = actualQuotationNumber;

              // 10) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
              const invoicePayload = {
                date: new Date().toISOString(),
                shippingFee: shippingFee,
                docFee: documentFeeNum,
                discount: discountNum,
                planSummaryText: getPlanSummaryText(),
                summary: {
                  subtotal: subtotal,
                  beforeTax: subtotal,
                  shipping: shippingFee,
                  discount: discountNum,
                  tax: taxTotal,
                  afterTax: netTotal,
                  netTotal: netTotal
                }
              };

              // 11) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ (API: POST /api/quotation/:quotationNumber/invoice)
              const resI = await fetch(
                `/api/quotation/${encodeURIComponent(actualQuotationNumber)}/invoice`,
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                  },
                  body: JSON.stringify(invoicePayload)
                }
              );
              const jsI = await resI.json();
              if (!jsI.success) throw new Error(jsI.error || jsI.message);

              window.currentInvoiceNumber = jsI.data.invoiceNumber;

              // 12) ‡πÅ‡∏™‡∏î‡∏á toast ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
              showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
              document.getElementById('printPromptModal').checked = true;

            } catch (err) {
              console.error(err);
              alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
            }
          });



      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÉ‡∏ô modal ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ STEP3
      document.getElementById('confirmPrintPrompt')
        .addEventListener('click', () => {
          updateStandardValues();
          renderAutoPlans();
          bindAutoPlanRadios();
          initManualTerms();
          calculateManualPlan();
          renderStep3Summary();
          updatePlanSummaryDisplay();

          // ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏™‡∏°‡∏≠
          document.getElementById('autoPlans').classList.remove('hidden');
          document.getElementById('manualPlanCard').classList.remove('hidden');

          goToStep(3);
        });

      // ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ renderStep4Summary:
      const totalDocFee = cartItems.reduce((sum, it) => sum + (it.docFee || 0), 0);
      const subTotal = cartItems.reduce((sum, it) => sum + it.pricePayOff, 0);
      const grandTotal = subTotal + totalDocFee;


      // ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå PDF
      document.getElementById('btnPrintPdf')?.addEventListener('click', () => {
        const iframe = document.getElementById('quotationPdfViewer');
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        }
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
      document.getElementById('btnConfirmFinish')?.addEventListener('click', () => {
        goToStep(1);
      });

      async function fetchNextQuotationNumber() {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch(
          `/api/quotation/next-number?_=${Date.now()}`,  // ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ timestamp ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cache
          {
            method: 'GET',
            cache: 'no-store',                         // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ cache
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          }
        );
        const js = await res.json();
        console.log('GET next-number ‚Üí', js);
        if (!js.success) throw new Error(js.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ');
        return js.nextNumber || '';  // fallback ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ undefined ‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤‡∏≠‡∏µ‡∏Å
      }





      // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏á DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('btnDownloadPdf');
        if (btn) {
          btn.addEventListener('click', downloadQuotationPdf);
        }
      });


      // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
      document.getElementById('btnDownloadPdf')
        ?.addEventListener('click', downloadQuotationPdf);

  



      // 4) ‡∏ú‡∏π‡∏Å Event ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      document.getElementById('btnProductSearch')?.addEventListener('click', searchItems);
      document.getElementById('btnProductReset')?.addEventListener('click', resetSearch);

      // 5) ‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      setupIDCamera();
      setupSelfieCamera();
      setupSignaturePad();

      // ‡∏´‡∏•‡∏±‡∏á setupSignaturePad();
      const incomeInput = document.getElementById('incomeProof');
      if (incomeInput) {
        incomeInput.addEventListener('change', async e => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const url = await uploadFile(file, '/api/upload/salary-slip');
            document.getElementById('salarySlipUrl').value = url;
            showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          } catch (err) {
            showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
          }
        });
      }
      // ‡∏õ‡∏∏‡πà‡∏° Back ‡πÉ‡∏ô Level2/3
      document.getElementById('btnBackToLevel1')?.addEventListener('click', () => {
        document.getElementById('level1Container').classList.remove('hidden');
        document.getElementById('level2Container').classList.add('hidden');
        document.getElementById('level3Container').classList.add('hidden');
      });
      document.getElementById('btnBackToLevel2')?.addEventListener('click', () => {
        document.getElementById('level2Container').classList.remove('hidden');
        document.getElementById('level3Container').classList.add('hidden');
      });

      // ‡∏õ‡∏∏‡πà‡∏° manual
      document.getElementById('btnConfirmManual')?.addEventListener('click', () => {
        renderManualPlanSummary();
      });



      // ‚Äî‚Äî‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚Äî‚Äî‚Äî
      // ‡∏ú‡∏π‡∏Å event ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
      const manualDownInput = document.getElementById('manualDown');
      const manualCreditInput = document.getElementById('manualCredit');

      if (manualDownInput) {
        manualDownInput.addEventListener('input', calculateManualPlan);
      }
      if (manualCreditInput) {
        manualCreditInput.addEventListener('input', calculateManualPlan);
      }
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
      calculateManualPlan();
      // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

      // 1) ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Step2 ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏ó‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      document.getElementById('btnStep2OpenModal')
        .addEventListener('click', () => {
          document.getElementById('printPromptModal').checked = true;
        });



      // ‚Äî ADD these inside DOMContentLoaded, after signaturePad & empPad are set up ‚Äî
      document.getElementById('btnSaveSignature')?.addEventListener('click', async () => {
        await uploadSignature(signaturePad, 'customerSignatureUrl');
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      });
      document.getElementById('btnSaveEmpSignature')?.addEventListener('click', async () => {
        await uploadSignature(empPad, 'salespersonSignatureUrl');
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      });

      // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÉ‡∏ô STEP2 ---
      const step2SummaryEl = document.querySelector('#step2 .cart-summary');
      const pickupRadios = document.querySelectorAll('input[name="pickupMethod"]');
      const shippingFeeContainer = document.getElementById('shippingFeeContainer');
      const shippingFeeInput = document.getElementById('shippingFee');
      const documentFeeInput = document.getElementById('documentFee');

      function updateStep2Summary() {
        let totalLumpSum = 0;
        let totalVAT = 0;

        cartItems.forEach(item => {
          // ‚òÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Å‡πâ‡∏≠‡∏ô = ‡∏î‡∏≤‡∏ß‡∏ô‡πå + (‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î)
          const down = Number(item.downAmount) || 0;
          const perMonth = Number(item.downInstallment) || 0;
          const terms = Number(item.downInstallmentCount) || 0;
          const base = down + perMonth * terms;
          totalLumpSum += base;

          // ‚òÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å/‡∏£‡∏ß‡∏° VAT)
          const rate = (item.taxRate || 0) / 100;
          if (item.taxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
            totalVAT += base * rate;
          } else if (item.taxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
            const net = base / (1 + rate);
            totalVAT += base - net;
          }
        });

        const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
        const docFee = parseFloat(document.getElementById('documentFee').value) || 0;
        const discount = parseFloat(document.getElementById('step2Discount').value) || 0;  // ‚Üê use new id
        const netAll = totalLumpSum + shipping + docFee - discount;
        const grandTotal = netAll + totalVAT;

        const lines = [
          `‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT: ‡∏ø${totalLumpSum.toLocaleString()}`,
          `  ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ‡∏ø${shipping.toLocaleString()}`,
          `  ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: ‡∏ø${docFee.toLocaleString()}`,
          `  ‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ‡∏ø${discount.toLocaleString()}`,
          `VAT 7%: ‡∏ø${totalVAT.toLocaleString(undefined, { minimumFractionDigits: 2 })}`,
          `-----------------------------`,
          `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ‡∏ø${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`
        ];

        const el = document.querySelector('#step2 .cart-summary');
        el.innerHTML = lines.map(line =>
          /‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô/.test(line)
            ? `<div class="font-semibold">${line}</div>`
            : `<div>${line}</div>`
        ).join('');

        // debug log
        console.log('updateStep2Summary:', {
          totalLumpSum, shipping, docFee, discount, totalVAT, grandTotal
        });
      }

      // initial call
      updateStep2Summary();

      // Highlight sidebar links
      const sidebarLinks = document.querySelectorAll('aside a');
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πÄ‡∏Å‡πà‡∏≤
          sidebarLinks.forEach(l => {
            l.style.backgroundColor = '';
            l.style.color = '';
          });
          // ‡πÉ‡∏™‡πà‡∏™‡∏µ active
          this.style.backgroundColor = '#3b82f6';
          this.style.color = '#ffffff';
        });
      });

    });
  </script>
  
  <!-- Display Fixes Script -->
  <script>
    // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö step-content
    const fixStepContentCSS = () => {
      // ‡∏•‡∏ö CSS rule ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ step4 ‡∏°‡∏µ background ‡πÅ‡∏õ‡∏•‡∏Å‡πÜ
      const style = document.createElement('style');
      style.textContent = `
        /* Reset step content styles */
        .step-content {
          display: none;
          background-color: transparent !important;
        }
        
        .step-content.active {
          display: block !important;
          min-height: auto;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö main content ‡πÉ‡∏´‡πâ responsive */
        #mainContent {
          transition: margin-left 0.3s ease-in-out;
        }
        
        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ sidebar ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô */
        #mainContent.sidebar-collapsed {
          margin-left: 0 !important;
        }
        
        /* ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        main {
          background-color: transparent !important;
          min-height: calc(100vh - 80px); /* ‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á header */
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö card container */
        .card {
          background-color: #ffffff;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark .card {
          background-color: #2a2a2a;
          border-color: #555;
        }
      `;
      document.head.appendChild(style);
    };

    // 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleMenu ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ margin ‡∏Ç‡∏≠‡∏á mainContent
    function fixToggleMenu() {
      const toggleMenu = () => {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');
    
        sidebar.classList.toggle('-translate-x-full');
    
        if (sidebar.classList.contains('-translate-x-full')) {
          // Sidebar ‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô
          mainContent.classList.add('sidebar-collapsed');
          mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          // Sidebar ‡πÅ‡∏™‡∏î‡∏á
          mainContent.classList.remove('sidebar-collapsed');
          mainContent.style.marginLeft = '14rem'; // 56 * 0.25rem = 14rem
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }
    
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      };
    
      // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà event listener ‡πÄ‡∏î‡∏¥‡∏°
      const btnToggle = document.getElementById('btnToggleMenu');
      if (btnToggle) {
        btnToggle.removeEventListener('click', window.toggleMenu);
        btnToggle.addEventListener('click', toggleMenu);
        window.toggleMenu = toggleMenu;
      }
    }

    // 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ restore sidebar state
    function fixSidebarRestore() {
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
    
      if (sidebarCollapsed) {
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.add('sidebar-collapsed');
        mainContent.style.marginLeft = '0';
        icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
      } else {
        sidebar.classList.remove('-translate-x-full');
        mainContent.classList.remove('sidebar-collapsed');
        mainContent.style.marginLeft = '14rem';
        icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
      }
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á containers
    function fixContainerDisplay() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ step content ‡∏ó‡∏µ‡πà active ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      const activeStep = document.querySelector('.step-content.active');
      if (!activeStep) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ active step ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô step 1
        const step1 = document.getElementById('step1');
        if (step1) {
          step1.classList.add('active');
        }
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö level containers
      const level1Container = document.getElementById('level1Container');
      const level2Container = document.getElementById('level2Container');
      const level3Container = document.getElementById('level3Container');
      const imeiResultContainer = document.getElementById('imeiResultContainer');
    
      // ‡∏ã‡πà‡∏≠‡∏ô containers ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á
      if (level2Container && !level2Container.querySelector('#level2Grid').children.length) {
        level2Container.classList.add('hidden');
      }
      if (level3Container && !level3Container.querySelector('#level3Grid').children.length) {
        level3Container.classList.add('hidden');
      }
      if (imeiResultContainer && !imeiResultContainer.querySelector('#imeiResultGrid').children.length) {
        imeiResultContainer.classList.add('hidden');
      }
    }

    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function applyFixes() {
      // 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS
      fixStepContentCSS();
    
      // 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç toggle menu
      fixToggleMenu();
    
      // 3. Restore sidebar state ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      fixSidebarRestore();
    
      // 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• containers
      fixContainerDisplay();
    
      // 5. ‡∏•‡∏ö background ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å CSS ‡πÄ‡∏Å‡πà‡∏≤
      const main = document.querySelector('main');
      if (main) {
        main.style.backgroundColor = 'transparent';
        main.style.minHeight = 'calc(100vh - 80px)';
      }
    
      console.log('‚úÖ Applied all display fixes');
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyFixes);
    } else {
      applyFixes();
    }

    // Export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    window.applyInstallmentFixes = applyFixes;
  </script>

  <!-- =================== Contact Information Management =================== -->
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
  async function saveContactInfo() {
    try {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const customerIdCard = document.getElementById('customerIdCard').value;
      if (!customerIdCard) {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', 'warning');
        } else {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠');
        }
        return;
      }

      // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
      const contactData = {
        customerId: customerIdCard,
        facebook: document.getElementById('customerFacebook').value.trim(),
        line: document.getElementById('customerLine').value.trim(),
        mapLocation: document.getElementById('customerMapLocation').value.trim(),
        updateDate: new Date().toISOString()
      };

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
      localStorage.setItem(`contact_${customerIdCard}`, JSON.stringify(contactData));

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      const statusDiv = document.getElementById('contactSaveStatus');
      statusDiv.className = 'mt-2 p-2 rounded text-center bg-green-100 text-green-700';
      statusDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      statusDiv.classList.remove('hidden');

      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 2000);

      if (typeof showToast === 'function') {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }

    } catch (error) {
      console.error('Error saving contact info:', error);
      const statusDiv = document.getElementById('contactSaveStatus');
      statusDiv.className = 'mt-2 p-2 rounded text-center bg-red-100 text-red-700';
      statusDiv.innerHTML = '<i class="bi bi-x-circle-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      if (typeof showToast === 'function') {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message, 'error');
      } else {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
      }
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
  function clearContactInfo() {
    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
      document.getElementById('customerFacebook').value = '';
      document.getElementById('customerLine').value = '';
      document.getElementById('customerMapLocation').value = '';

      const statusDiv = document.getElementById('contactSaveStatus');
      statusDiv.className = 'mt-2 p-2 rounded text-center bg-gray-100 text-gray-700';
      statusDiv.innerHTML = '<i class="bi bi-info-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      statusDiv.classList.remove('hidden');

      setTimeout(() => {
        statusDiv.classList.add('hidden');
      }, 2000);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å localStorage
  function loadContactInfo(customerId) {
    try {
      const savedData = localStorage.getItem(`contact_${customerId}`);
      if (savedData) {
        const contactData = JSON.parse(savedData);
        document.getElementById('customerFacebook').value = contactData.facebook || '';
        document.getElementById('customerLine').value = contactData.line || '';
        document.getElementById('customerMapLocation').value = contactData.mapLocation || '';

        if (typeof showToast === 'function') {
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'info');
        }
      }
    } catch (error) {
      console.error('Error loading contact info:', error);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Line
  function openLineChat() {
    const lineId = document.getElementById('customerLine').value.trim();
    if (!lineId) {
      showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Line ID ‡∏Å‡πà‡∏≠‡∏ô', 'warning');
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠ Line ID
    if (/^\d+$/.test(lineId)) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
      window.open(`https://line.me/ti/p/${lineId}`, '_blank');
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Line ID
      window.open(`https://line.me/ti/p/~${lineId}`, '_blank');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Facebook
  function openFacebook() {
    const fbValue = document.getElementById('customerFacebook').value.trim();
    if (!fbValue) {
      showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Facebook ‡∏Å‡πà‡∏≠‡∏ô', 'warning');
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î URL ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    if (fbValue.includes('facebook.com') || fbValue.includes('fb.com')) {
      window.open(fbValue, '_blank');
    } else {
      window.open(`https://facebook.com/${fbValue}`, '_blank');
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  function openMapLocation() {
    const mapValue = document.getElementById('customerMapLocation').value.trim();
    if (!mapValue) {
      showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning');
      return;
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
    if (mapValue.includes('maps.google.com') || mapValue.includes('goo.gl')) {
      window.open(mapValue, '_blank');
    } else {
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapValue)}`, '_blank');
    }
  }

  // ===================== Customer Search Functions ======================
  
  let searchTimeout = null;
  let selectedCustomer = null;
  let isSearching = false;
  let lastSearchTime = 0;
  const searchCooldown = 3000; // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
  async function searchExistingCustomer() {
    const searchValue = document.getElementById('customerSearch').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    const resultsList = document.getElementById('customerResultsList');

    if (!searchValue) {
      if (typeof showToast === 'function') {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'warning');
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
      }
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)
    if (!/^[0-9]{13}$/.test(searchValue)) {
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
      } else {
        alert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å');
      }
      return;
    }

    // Rate limiting
    const now = Date.now();
    if (isSearching) {
      if (typeof showToast === 'function') {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'info');
      }
      return;
    }

    if (now - lastSearchTime < searchCooldown) {
      const remainingTime = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
      if (typeof showToast === 'function') {
        showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remainingTime} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà`, 'info');
      }
      return;
    }

    isSearching = true;
    lastSearchTime = now;

    try {
      // Loading UI
      resultsContainer.classList.remove('hidden');
      resultsList.innerHTML = `
        <div class="p-4 text-center">
          <div class="loading-spinner mx-auto mb-2"></div>
          <div class="text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...</div>
        </div>
      `;

      const token = localStorage.getItem('authToken');
      const response = await fetch(`/api/customers/search?idCard=${encodeURIComponent(searchValue)}`, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const result = await response.json();
      console.log('üîç Customer search result:', result);

      if (result.success && result.data && result.data.length > 0) {
        displayCustomerResults(result.data);
      } else {
        displayNoResults();
      }

    } catch (error) {
      console.error('Search error:', error);
      resultsList.innerHTML = `
        <div class="p-4 text-center text-red-600">
          <i class="bi bi-exclamation-triangle mb-2"></i>
          <div>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
          <div class="text-sm mt-1">${error.message}</div>
        </div>
      `;
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
      }
    } finally {
      isSearching = false;
    }
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  function displayCustomerResults(customers) {
    const resultsList = document.getElementById('customerResultsList');

    resultsList.innerHTML = '';

    customers.forEach(customer => {
      const item = document.createElement('div');
      item.className = 'p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors border-b border-gray-200 dark:border-gray-600';

      const isNewCustomer = customer.isNewCustomer ?
        '<span class="badge badge-success badge-sm">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>' :
        '<span class="badge badge-info badge-sm">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</span>';

      item.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div class="font-medium">${customer.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
            <div class="text-sm text-gray-500">
              ${customer.taxId || '-'} | ${customer.phone || '-'}
            </div>
            <div class="text-xs text-gray-400 mt-1">
              ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${customer.totalPurchases || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </div>
          </div>
          <div>
            ${isNewCustomer}
          </div>
        </div>
      `;

      item.addEventListener('click', () => selectCustomer(customer._id));
      resultsList.appendChild(item);
    });
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  function displayNoResults() {
    const resultsList = document.getElementById('customerResultsList');
    resultsList.innerHTML = `
      <div class="p-4 text-center text-gray-500">
        <i class="bi bi-person-x mb-2 text-lg"></i>
        <div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        <div class="text-sm mt-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
      </div>
    `;
  }

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  async function selectCustomer(customerId) {
    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch(`/api/customer/${customerId}`, {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();
      console.log('üìä API Response:', result);

      if (result.success && result.data) {
        const customer = result.data;
        console.log('üë§ Customer Data:', customer);

        // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        fillCustomerForm(customer);

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        document.getElementById('customerSearchResults').classList.add('hidden');
        document.getElementById('customerSearch').value = '';

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const taxId = customer.taxId || customer.contactPhone;
        if (taxId) {
          loadContactInfo(taxId);
        }

        if (typeof showToast === 'function') {
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        }
      } else {
        throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
      }

    } catch (error) {
      console.error('Select customer error:', error);
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      } else {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }
  }

  // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  function fillCustomerForm(customer) {
    if (customer.customerType === 'individual') {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
      document.getElementById('customerPrefix').value = customer.prefix || '';
      document.getElementById('customerFirstName').value = customer.firstName || '';
      document.getElementById('customerLastName').value = customer.lastName || '';
      document.getElementById('customerIdCard').value = customer.taxId || '';
      document.getElementById('customerPhone').value = customer.phone || '';
      document.getElementById('customerEmail').value = customer.email || '';
    } else {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
      document.getElementById('customerPrefix').value = '';
      document.getElementById('customerFirstName').value = customer.contactPerson || customer.companyName || '';
      document.getElementById('customerLastName').value = '';
      document.getElementById('customerIdCard').value = customer.companyTaxId || '';
      document.getElementById('customerPhone').value = customer.corporatePhone || '';
      document.getElementById('customerEmail').value = customer.email || '';
    }
  }
   // ====================== Barcode Functions ======================

   // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î barcode modal
   function toggleBarcodeModal() {
     const modal = document.getElementById('barcodeModal');
     if (modal.classList.contains('hidden')) {
       openBarcodeModal();
     } else {
       closeBarcodeModal();
     }
   }

   // ‡πÄ‡∏õ‡∏¥‡∏î barcode modal
   function openBarcodeModal() {
     const modal = document.getElementById('barcodeModal');
     modal.classList.remove('hidden');
     
     // Focus ‡∏ó‡∏µ‡πà input field
     setTimeout(() => {
       const input = document.getElementById('barcodeInput');
       if (input) {
         input.focus();
         input.value = '';
       }
     }, 100);

     // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô barcode scanner
     startBarcodeScanner();
   }

   // ‡∏õ‡∏¥‡∏î barcode modal
   function closeBarcodeModal() {
     const modal = document.getElementById('barcodeModal');
     modal.classList.add('hidden');
     
     // ‡∏´‡∏¢‡∏∏‡∏î scanner
     stopBarcodeScanner();
   }

   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô barcode scanner
   function startBarcodeScanner() {
     console.log('üîç Starting barcode scanner...');
     
     // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö keyboard input
     const input = document.getElementById('barcodeInput');
     if (input) {
       input.addEventListener('keypress', handleBarcodeInput);
       input.addEventListener('input', handleBarcodeInputChange);
     }
   }

   // ‡∏´‡∏¢‡∏∏‡∏î barcode scanner
   function stopBarcodeScanner() {
     console.log('‚èπÔ∏è Stopping barcode scanner...');
     
     const input = document.getElementById('barcodeInput');
     if (input) {
       input.removeEventListener('keypress', handleBarcodeInput);
       input.removeEventListener('input', handleBarcodeInputChange);
     }
   }

   // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ barcode input
   function handleBarcodeInput(e) {
     if (e.key === 'Enter') {
       e.preventDefault();
       const barcode = e.target.value.trim();
       if (barcode) {
         searchProductByBarcode(barcode);
       }
     }
   }

   // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á input
   function handleBarcodeInputChange(e) {
     const barcode = e.target.value.trim();
     
     // Auto search ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 12-13 ‡∏´‡∏•‡∏±‡∏Å
     if (barcode.length >= 12 && barcode.length <= 13) {
       setTimeout(() => {
         if (e.target.value.trim() === barcode) {
           searchProductByBarcode(barcode);
         }
       }, 500);
     }
   }

   // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢ barcode
   async function searchProductByBarcode(barcode) {
     try {
       console.log('üîç Searching product by barcode:', barcode);
       
       // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô branchInstallments
       const product = branchInstallments.find(item => 
         item.barcode === barcode || 
         item.serialNumber === barcode || 
         item.imei === barcode
       );

       if (product) {
         console.log('‚úÖ Product found:', product);
         
         // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
         addToCart(product);
         
         // ‡∏õ‡∏¥‡∏î modal
         closeBarcodeModal();
         
         // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
         if (typeof showToast === 'function') {
           showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${product.name} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
         }
       } else {
         console.log('‚ùå Product not found for barcode:', barcode);
         
         // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
         if (typeof showToast === 'function') {
           showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ', 'warning');
         }
         
         // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå input ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
         document.getElementById('barcodeInput').value = '';
         document.getElementById('barcodeInput').focus();
       }

     } catch (error) {
       console.error('Error searching product by barcode:', error);
       if (typeof showToast === 'function') {
         showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
       }
     }
   }

   // ====================== Email Modal Functions ======================

   // ‡πÄ‡∏õ‡∏¥‡∏î email modal
   function openEmailModal() {
     const modal = document.getElementById('emailModal');
     modal.classList.remove('hidden');
     
     // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
     setupEmailModal();
   }

   // ‡∏õ‡∏¥‡∏î email modal
   function closeEmailModal() {
     const modal = document.getElementById('emailModal');
     modal.classList.add('hidden');
   }

   // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ email modal
   function setupEmailModal() {
     // ‡∏î‡∏∂‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
     const customerEmail = document.getElementById('customerEmail').value;
     if (customerEmail) {
       document.getElementById('recipientEmail').value = customerEmail;
     }
     
     // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
     const subject = `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô - ${new Date().toLocaleDateString('th-TH')}`;
     document.getElementById('emailSubject').value = subject;
   }

   // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
   async function sendEmail() {
     try {
       const recipientEmail = document.getElementById('recipientEmail').value.trim();
       const subject = document.getElementById('emailSubject').value.trim();
       const message = document.getElementById('emailMessage').value.trim();

       if (!recipientEmail) {
         showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö', 'warning');
         return;
       }

       if (!subject) {
         showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•', 'warning');
         return;
       }

       // ‡πÅ‡∏™‡∏î‡∏á loading
       const sendBtn = document.querySelector('#emailModal .btn-primary');
       const originalText = sendBtn.textContent;
       sendBtn.disabled = true;
       sendBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

       const token = localStorage.getItem('authToken');
       const response = await fetch('/api/email/send-document', {
         method: 'POST',
         headers: {
           'Authorization': 'Bearer ' + token,
           'Content-Type': 'application/json'
         },
         body: JSON.stringify({
           to: recipientEmail,
           subject: subject,
           message: message,
           attachments: [] // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° attachments ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
         })
       });

       const result = await response.json();

       if (result.success) {
         showToast('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
         closeEmailModal();
       } else {
         throw new Error(result.message || '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
       }

     } catch (error) {
       console.error('Send email error:', error);
       showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
     } finally {
       // Reset button
       const sendBtn = document.querySelector('#emailModal .btn-primary');
       sendBtn.disabled = false;
       sendBtn.textContent = '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
     }
   }

   // ====================== Map Modal Functions ======================

   // ‡πÄ‡∏õ‡∏¥‡∏î map modal
   function openMapModal() {
     const modal = document.getElementById('mapModal');
     modal.classList.remove('hidden');
     
     // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
     loadMapPreview();
   }

   // ‡∏õ‡∏¥‡∏î map modal
   function closeMapModal() {
     const modal = document.getElementById('mapModal');
     modal.classList.add('hidden');
   }

   // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà preview
   function loadMapPreview() {
     const mapLocation = document.getElementById('customerMapLocation').value.trim();
     const mapPreview = document.getElementById('mapPreview');
     
     if (!mapLocation) {
       mapPreview.innerHTML = `
         <div class="flex items-center justify-center h-64 bg-gray-100 text-gray-500">
           <div class="text-center">
             <i class="bi bi-geo-alt text-4xl mb-2"></i>
             <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
           </div>
         </div>
       `;
       return;
     }

     // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Google Maps URL ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô iframe
     if (mapLocation.includes('maps.google.com') || mapLocation.includes('goo.gl')) {
       const embedUrl = mapLocation.replace('/maps/', '/maps/embed?pb=');
       const iframeSrc = embedUrl || 'about:blank';
       mapPreview.innerHTML = `
         <iframe 
           src="${iframeSrc}" 
           width="100%" 
           height="300" 
           style="border:0;" 
           allowfullscreen="" 
           loading="lazy">
         </iframe>
       `;
     } else {
       // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô text ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô Google Maps search
       const searchUrl = `https://www.google.com/maps/embed/v1/search?key=YOUR_API_KEY&q=${encodeURIComponent(mapLocation)}`;
       mapPreview.innerHTML = `
         <div class="bg-gray-100 p-4 rounded text-center">
           <i class="bi bi-geo-alt text-2xl text-blue-600 mb-2"></i>
           <div class="font-medium">${mapLocation}</div>
           <div class="text-sm text-gray-600 mt-2">
             <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapLocation)}" 
                target="_blank" 
                class="text-blue-600 hover:underline">
               <i class="bi bi-box-arrow-up-right mr-1"></i>
               ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
             </a>
           </div>
         </div>
       `;
     }
   }

   // ====================== Loading System ======================

   // ‡πÅ‡∏™‡∏î‡∏á loading overlay
   function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
     const overlay = document.getElementById('loadingOverlay');
     const messageEl = document.getElementById('loadingMessage');
     
     if (messageEl) {
       messageEl.textContent = message;
     }
     
     overlay.classList.remove('hidden');
   }

   // ‡∏ã‡πà‡∏≠‡∏ô loading overlay
   function hideLoading() {
     const overlay = document.getElementById('loadingOverlay');
     overlay.classList.add('hidden');
   }

   // ====================== Card Reader Functions ======================

   // ‡πÄ‡∏õ‡∏¥‡∏î card reader modal
   function openCardReader() {
     if (confirm('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
       showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£...', 'info');
       // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö card reader API
       setTimeout(() => {
         showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 'warning');
       }, 2000);
     }
   }

   // ====================== Email Event Listeners ======================
   
   // Setup email functionality
   document.addEventListener('DOMContentLoaded', function() {
     // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkbox ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
     const emailQuotation = document.getElementById('emailQuotation');
     const emailInvoice = document.getElementById('emailInvoice');
     const emailReceipt = document.getElementById('emailReceipt');
     
     if (emailQuotation) emailQuotation.addEventListener('change', window.InstallmentAPI?.handleEmailDocumentChange || function() {});
     if (emailInvoice) emailInvoice.addEventListener('change', window.InstallmentAPI?.handleEmailDocumentChange || function() {});
     if (emailReceipt) emailReceipt.addEventListener('change', window.InstallmentAPI?.handleEmailDocumentChange || function() {});
     
     // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
     const btnPreviewEmail = document.getElementById('btnPreviewEmail');
     const btnSendEmail = document.getElementById('btnSendEmail');
     
     if (btnPreviewEmail) {
       btnPreviewEmail.addEventListener('click', function() {
         if (window.InstallmentAPI && window.InstallmentAPI.previewEmail) {
           window.InstallmentAPI.previewEmail();
         } else {
           console.error('InstallmentAPI.previewEmail not found');
         }
       });
     }
     
     if (btnSendEmail) {
       btnSendEmail.addEventListener('click', function() {
         if (window.InstallmentAPI && window.InstallmentAPI.sendInstallmentEmail) {
           window.InstallmentAPI.sendInstallmentEmail();
         } else {
           console.error('InstallmentAPI.sendInstallmentEmail not found');
         }
       });
     }
     
     // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö email field ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï status
     const customerEmailField = document.getElementById('customerEmail');
     if (customerEmailField) {
       customerEmailField.addEventListener('input', function() {
         if (window.InstallmentAPI && window.InstallmentAPI.handleEmailDocumentChange) {
           window.InstallmentAPI.handleEmailDocumentChange();
         }
       });
     }
     
     console.log('‚úÖ Email event listeners initialized');
   });

  </script>

  <script>
    // Lottie Loading Animation Function
    let lottieAnimation = null;

    function showLoading(message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
      const overlay = document.getElementById('loadingOverlay');
      const container = document.getElementById('lottieContainer');

      if (overlay && container) {
        // Show overlay
        overlay.style.display = 'flex';
        overlay.classList.remove('animate__fadeOut');
        overlay.classList.add('animate__fadeIn');

        // Initialize Lottie animation if not already done
        if (!lottieAnimation && window.lottie) {
          lottieAnimation = window.lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets2.lottiefiles.com/packages/lf20_x62chJ.json'
          });
        }

        // Show message if provided
        if (message) {
          console.log('Loading:', message);
        }
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('animate__fadeIn');
        overlay.classList.add('animate__fadeOut');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 500);
      }
    }

    // Initialize loading on page load
    document.addEventListener('DOMContentLoaded', function() {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô...');

      // Auto-hide loading after page is fully loaded
      window.addEventListener('load', function() {
        setTimeout(hideLoading, 1000);
      });
    });

    // Make functions globally available
    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
  </script>
</body>