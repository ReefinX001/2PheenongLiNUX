<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

  <!-- 1. Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- 2. Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- 3. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt', 'sans-serif'] },
          colors: {
            primary: {50:'#f0f9ff',100:'#e0f2fe',500:'#0ea5e9',600:'#0284c7'}
          }
        }
      }
    };
  </script>

  <!-- 4. Sidebar Management Script -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>

  <!-- Modular Notification System -->
  <link rel="stylesheet" href="/css/notification-modules.css">
  <script src="/js/notification-modules.js"></script>

  <!-- Firebase v9 SDKs -->
  <script>
    // Global Branch Configuration - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL parameters
    function getBranchFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const branchFromURL = urlParams.get('branch');
      const branchNameFromURL = urlParams.get('name');

      if (branchFromURL) {
        console.log('üè¢ Branch Code from URL:', branchFromURL);
        console.log('üè¢ Branch Name from URL:', branchNameFromURL);

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô
        localStorage.setItem('activeBranch', branchFromURL);
        localStorage.setItem('activeBranchName', branchNameFromURL || '');

        return branchFromURL;
      } else {
        // fallback ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        const storedBranch = localStorage.getItem('activeBranch');
        if (storedBranch) {
          console.log('üè¢ Branch Code from localStorage:', storedBranch);
          return storedBranch;
        } else {
          console.log('üè¢ Using default branch code: 00001');
          return '00001'; // default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        }
      }
    }

    window.BRANCH_CODE = getBranchFromURL();
    console.log('üè¢ Final Branch Code initialized:', window.BRANCH_CODE);
  </script>
  <script type="module">
    // Import Firebase v9 SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      off, 
      serverTimestamp, 
      onDisconnect, 
      remove 
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase Configuration - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Make Firebase functions globally available
    window.Firebase = {
      app,
      database,
      ref,
      set,
      get,
      push,
      onValue,
      off,
      serverTimestamp,
      onDisconnect,
      remove
    };

    console.log('üî• Firebase initialized successfully for deposit receipt system');
  </script>

  <!-- Enhanced Firebase Realtime Database + Socket.IO Integration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== FIREBASE REALTIME DATABASE + SOCKET.IO INTEGRATION ====================
    
    // Enhanced Socket.IO Configuration - ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Deposit Receipt
    var depositReceiptSocket;
    let socketConnected = false;
    let firebaseConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;
    let onlineUsers = 0;

    // Make depositReceiptSocket globally accessible
    window.depositReceiptSocket = null;

    // Current session data (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)
    const currentSession = {
      branchCode: '',
      sessionId: '',
      staffId: localStorage.getItem('userId') || 'anonymous',
      staffName: localStorage.getItem('userName') || 'Unknown',
      timestamp: Date.now(),
      page: 'deposit-receipt'
    };
    
    // Validate login data
    if (!currentSession.staffId || currentSession.staffId === 'anonymous') {
      console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà');
    } else {
      console.log(`‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${currentSession.staffName} (ID: ${currentSession.staffId})`);
    }

    // Firebase References
    let firebaseRefs = {};

    // Initialize Enhanced Socket.IO with robust error handling
    function initializeEnhancedSocket() {
      if (typeof io === 'function') {
        try {
          depositReceiptSocket = io({
            timeout: 15000,
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 2000,
            reconnectionDelayMax: 10000,
            randomizationFactor: 0.5,
            forceNew: true,
            upgrade: true,
            transports: ['websocket', 'polling']
          });

          // Make it globally accessible
          window.depositReceiptSocket = depositReceiptSocket;

          // Connection Events
          depositReceiptSocket.on('connect', () => {
            console.log('üîó Socket.IO connected for deposit receipt:', depositReceiptSocket.id);
            socketConnected = true;
            reconnectAttempts = 0;

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showConnectionStatus('connected');

            // Join deposit receipt specific rooms
            depositReceiptSocket.emit('join_branch', {
              branchCode: currentSession.branchCode,
              page: 'deposit-receipt',
              staffId: currentSession.staffId,
              staffName: currentSession.staffName,
              timestamp: new Date().toISOString()
            });

            depositReceiptSocket.emit('join_notification_room', {
              branchCode: currentSession.branchCode,
              page: 'deposit-receipt'
            });

            // Start heartbeat
            startHeartbeat();
    
            // ‡∏õ‡∏¥‡∏î fallback mode
            window.socketIOFallbackMode = false;
    
            // Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô queue
            setTimeout(() => syncLocalQueue(), 1000);
          });

          depositReceiptSocket.on('disconnect', (reason) => {
            console.log('‚ùå Socket.IO disconnected:', reason);
            socketConnected = false;
            stopHeartbeat();
    
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            showConnectionStatus('disconnected', reason);
    
            if (reason === 'io server disconnect') {
              depositReceiptSocket.connect();
            }
          });

          depositReceiptSocket.on('reconnect', (attemptNumber) => {
            console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
            socketConnected = true;
            reconnectAttempts = 0;
            console.log('üîÑ Deposit Receipt: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showConnectionStatus('reconnected');
    
            // ‡∏õ‡∏¥‡∏î fallback mode
            window.socketIOFallbackMode = false;
    
            // Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô queue
            setTimeout(() => syncLocalQueue(), 1000);
          });

          depositReceiptSocket.on('reconnect_attempt', (attemptNumber) => {
            console.log(`üîÑ Socket.IO reconnect attempt ${attemptNumber}`);
            reconnectAttempts = attemptNumber;
            showConnectionStatus('reconnecting', null, attemptNumber);
          });

          depositReceiptSocket.on('reconnect_error', (error) => {
            console.error('‚ùå Socket.IO reconnect error:', error);
            showConnectionStatus('reconnect_error', error.message);
          });

          depositReceiptSocket.on('reconnect_failed', () => {
            console.error('‚ùå Socket.IO reconnection failed - giving up');
            showConnectionStatus('failed');
    
            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô fallback mode
            enableFallbackMode();
          });

        // Enhanced Event Handlers for Deposit Receipt System
        depositReceiptSocket.on('deposit_receipt_created', (data) => {
          console.log('üí∞ Deposit receipt created:', data);
          console.log(`üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          // Add to notification system
          if (window.posNotificationSystem) {
            window.posNotificationSystem.addNotification('pos', {
              title: 'üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÉ‡∏´‡∏°‡πà',
              message: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || '‡πÉ‡∏´‡∏°‡πà'} ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }

          // Send to Firebase
          sendDepositReceiptToFirebase(data);
        });

        depositReceiptSocket.on('deposit_receipt_updated', (data) => {
          console.log('üìù Deposit receipt updated:', data);
          console.log(`üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          if (window.posNotificationSystem) {
            window.posNotificationSystem.addNotification('pos', {
              title: 'üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥',
              message: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó`,
              type: 'info',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        depositReceiptSocket.on('deposit_receipt_approved', (data) => {
          console.log('‚úÖ Deposit receipt approved:', data);
          console.log(`‚úÖ ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`);
    
          if (window.posNotificationSystem) {
            window.posNotificationSystem.addNotification('pos', {
              title: '‚úÖ ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
              message: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        depositReceiptSocket.on('deposit_receipt_cancelled', (data) => {
          console.log('‚ùå Deposit receipt cancelled:', data);
          console.log(`‚ùå ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`);
    
          if (window.posNotificationSystem) {
            window.posNotificationSystem.addNotification('pos', {
              title: '‚ùå ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
              message: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${data.receiptNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ${data.reason || ''}`,
              type: 'warning',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        // Branch and system notifications
        depositReceiptSocket.on('branch_notification', (data) => {
          console.log('üîî Branch notification:', data);
    
          if (window.posNotificationSystem && data.message) {
            window.posNotificationSystem.addNotification('pos', {
              title: 'üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤',
              message: data.message,
              type: data.type || 'info',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        depositReceiptSocket.on('system_notification', (data) => {
    
          if (window.posNotificationSystem && data.message) {
            window.posNotificationSystem.addNotification('pos', {
              title: 'üîß ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
              message: data.message,
              type: data.type || 'info',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        // Enhanced Error handling
        depositReceiptSocket.on('connect_error', (error) => {
          console.error('‚ùå Socket.IO connect error:', error);
          socketConnected = false;
    
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏ï‡∏≤‡∏° type
          handleSocketIOError(error);
        });

        depositReceiptSocket.on('error', (error) => {
          console.error('‚ùå Socket.IO error:', error);
          console.log('üî• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO');
    
          handleSocketIOError(error);
        });

        console.log('‚úÖ Enhanced Socket.IO initialized for deposit receipt system');
    
        } catch (error) {
          console.error('‚ùå Failed to initialize Socket.IO:', error);
          showConnectionStatus('init_error', error.message);
          enableFallbackMode();
        }
      } else {
        console.warn('‚ö†Ô∏è Socket.IO script not loaded for deposit receipt system');
        showConnectionStatus('no_script');
        enableFallbackMode();
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
    function showConnectionStatus(status, message = null, attemptNumber = null) {
      const statusMessages = {
        'connected': 'üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'disconnected': '‚ùå ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
        'reconnected': 'üîÑ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'reconnecting': `üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà... (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${attemptNumber || 'N/A'})`,
        'reconnect_error': '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        'failed': '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå',
        'init_error': '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ',
        'no_script': '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Socket.IO - ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'
      };

      const statusMessage = statusMessages[status] || '';
      const fullMessage = message ? `${statusMessage}: ${message}` : statusMessage;
    
      console.log(`üì° Connection Status: ${fullMessage}`);

      // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô notification system (‡∏ñ‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
      if (window.posNotificationSystem && ['disconnected', 'reconnect_error', 'failed', 'init_error'].includes(status)) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'üì° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
          message: fullMessage,
          type: status === 'failed' ? 'error' : 'warning',
          timestamp: new Date().toISOString(),
          read: false
        });
      } else if (window.posNotificationSystem && status === 'connected') {
        window.posNotificationSystem.addNotification('pos', {
          title: 'üì° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
          message: fullMessage,
          type: 'success',
          timestamp: new Date().toISOString(),
          read: false
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI indicator (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      updateConnectionIndicator(status);
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Socket.IO errors ‡πÅ‡∏ö‡∏ö robust
    function handleSocketIOError(error) {
      const errorType = error.type || 'unknown';
      const errorMessage = error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
    
      console.error(`‚ùå Socket.IO Error Type: ${errorType}, Message: ${errorMessage}`);

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏ï‡∏≤‡∏° type
      switch(errorType) {
        case 'TransportError':
          if (errorMessage.includes('502')) {
            console.error('‚ùå Server Gateway Error (502) - ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Socket.IO ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ');
            showConnectionStatus('failed', '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ (502)');
          } else {
            console.error('‚ùå Transport Error - ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            showConnectionStatus('reconnect_error', '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
          }
          break;
        case 'timeout':
          console.error('‚ùå Connection timeout');
          showConnectionStatus('reconnect_error', '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
          break;
        default:
          console.error('‚ùå Unknown Socket.IO error');
          showConnectionStatus('reconnect_error', errorMessage);
      }

      // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô fallback mode ‡∏´‡∏≤‡∏Å error ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á
      if (errorType === 'TransportError' && errorMessage.includes('502')) {
        enableFallbackMode();
      }
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô fallback mode (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)
    function enableFallbackMode() {
      console.log('üîÑ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Fallback Mode - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
    
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback mode
      window.socketIOFallbackMode = true;
    
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'üì¥ ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå',
          message: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ',
          type: 'info',
          timestamp: new Date().toISOString(),
          read: false
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
      updateConnectionIndicator('offline');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï connection indicator ‡πÉ‡∏ô UI
    function updateConnectionIndicator(status) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á indicator ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
      let indicator = document.getElementById('connection-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'connection-indicator';
        indicator.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          padding: 5px 10px;
          border-radius: 15px;
          font-size: 12px;
          font-weight: bold;
          z-index: 1000;
          transition: all 0.3s ease;
          cursor: pointer;
          user-select: none;
        `;
        document.body.appendChild(indicator);
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      switch(status) {
        case 'connected':
          indicator.textContent = 'üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
          indicator.style.backgroundColor = '#10b981';
          indicator.style.color = 'white';
          indicator.style.cursor = 'default';
          indicator.onclick = null;
          setTimeout(() => indicator.style.opacity = '0', 3000);
          break;
        case 'disconnected':
        case 'reconnect_error':
          indicator.textContent = '‚ùå ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)';
          indicator.style.backgroundColor = '#ef4444';
          indicator.style.color = 'white';
          indicator.style.opacity = '1';
          indicator.style.cursor = 'pointer';
          indicator.onclick = () => {
            manualRetryConnection();
          };
          break;
        case 'reconnecting':
          indicator.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
          indicator.style.backgroundColor = '#f59e0b';
          indicator.style.color = 'white';
          indicator.style.opacity = '1';
          indicator.style.cursor = 'default';
          indicator.onclick = null;
          break;
        case 'offline':
        case 'failed':
          indicator.textContent = 'üì¥ ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)';
          indicator.style.backgroundColor = '#6b7280';
          indicator.style.color = 'white';
          indicator.style.opacity = '1';
          indicator.style.cursor = 'pointer';
          indicator.onclick = () => {
            resetConnection();
          };
          break;
        default:
          indicator.style.opacity = '0';
          indicator.onclick = null;
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info with current branch
        currentSession.branchCode = window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'default';
        currentSession.sessionId = `deposit-receipt-${currentSession.staffId}-${Date.now()}`;

        console.log('üî• Setting up Firebase listeners for branch:', currentSession.branchCode);

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          depositReceiptUpdates: ref(database, `pos/${currentSession.branchCode}/depositReceiptUpdates`),
          depositReceipts: ref(database, `pos/${currentSession.branchCode}/depositReceipts`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          activityHistory: ref(database, `pos/${currentSession.branchCode}/activityHistory`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? 'üî• Firebase connected' : '‚ùå Firebase disconnected');
          firebaseConnected = connected;
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
    
            console.log('üî• Firebase connection established for deposit receipt');
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                console.log('üîî New notification:', notification.message);
    
                // Show in notification system if available
                if (window.posNotificationSystem && notification.message) {
                  window.posNotificationSystem.addNotification('pos', {
                    title: 'üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà',
                    message: notification.message,
                    type: notification.type || 'info',
                    timestamp: new Date().toISOString(),
                    read: false
                  });
                }
              }
            });
          }
        });

        // Listen for deposit receipt updates
        onValue(firebaseRefs.depositReceiptUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('üí∞ Deposit receipt update:', update);
                console.log(`üí∞ ${update.message || '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥'}`);
    
                // Trigger UI updates if available
                if (window.loadDepositReceipts && typeof window.loadDepositReceipts === 'function') {
                  window.loadDepositReceipts();
                }
              }
            });
          }
        });

        // Listen for new deposit receipts
        onValue(firebaseRefs.depositReceipts, (snapshot) => {
          const depositReceipts = snapshot.val();
          if (depositReceipts) {
            const latestReceipts = Object.entries(depositReceipts)
              .filter(([key, receipt]) => receipt.timestamp > currentSession.timestamp)
              .sort((a, b) => b[1].timestamp - a[1].timestamp);
    
            if (latestReceipts.length > 0) {
              console.log(`üí∞ ${latestReceipts.length} new deposit receipt(s) detected`);
    
              // Trigger reload if available
              if (window.loadDepositReceipts && typeof window.loadDepositReceipts === 'function') {
                window.loadDepositReceipts();
              }
            }
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
          console.log(`üë• Online users in deposit receipt: ${count}`);
        });

        console.log('üî• Firebase listeners setup successfully for deposit receipt');
      } catch (error) {
        console.error('‚ùå Firebase setup error:', error);
        firebaseConnected = false;
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'deposit-receipt',
          timestamp: serverTimestamp()
        });

        console.log('üìù Deposit receipt session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('‚ùå Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const { push } = window.Firebase;
        push(firebaseRefs.activityHistory, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'deposit-receipt',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('‚ùå Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'deposit-receipt'
        });
        console.log('üîî Notification sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send notification:', error);
      }
    }

    // Send deposit receipt data to Firebase
    function sendDepositReceiptToFirebase(receiptData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        const receiptRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/depositReceipts`);
        push(receiptRef, {
          ...receiptData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'deposit-receipt'
        });
        console.log('üí∞ Deposit receipt data sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send deposit receipt data:', error);
      }
    }

    // Heartbeat system
    function startHeartbeat() {
      heartbeatInterval = setInterval(() => {
        if (depositReceiptSocket && socketConnected) {
          depositReceiptSocket.emit('ping', {
            branchCode: currentSession.branchCode,
            page: 'deposit-receipt',
            timestamp: Date.now()
          });
        }
    
        // Update Firebase activity
        updateActivity('heartbeat');
      }, 30000); // 30 seconds
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // Enhanced Socket.IO Functions with Fallback Support
    function emitDepositReceiptUpdate(data) {
      const payload = {
        branchCode: currentSession.branchCode,
        ...data,
        timestamp: Date.now()
      };

      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° emit ‡∏ú‡πà‡∏≤‡∏ô Socket.IO ‡∏Å‡πà‡∏≠‡∏ô
      if (depositReceiptSocket && socketConnected) {
        try {
          depositReceiptSocket.emit('deposit_receipt_update', payload);
          console.log('‚úÖ Deposit receipt update sent via Socket.IO');
        } catch (error) {
          console.error('‚ùå Failed to emit via Socket.IO:', error);
        }
      } else {
        console.log('‚ö†Ô∏è Socket.IO not connected - using fallback');
      }
    
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Firebase ‡πÄ‡∏õ‡πá‡∏ô fallback
      sendDepositReceiptToFirebase(payload);
    
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô local storage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sync ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
      saveToLocalQueue('deposit_receipt_update', payload);
    }

    function emitDepositReceiptCreated(data) {
      const payload = {
        branchCode: currentSession.branchCode,
        ...data,
        timestamp: Date.now()
      };

      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° emit ‡∏ú‡πà‡∏≤‡∏ô Socket.IO ‡∏Å‡πà‡∏≠‡∏ô
      if (depositReceiptSocket && socketConnected) {
        try {
          depositReceiptSocket.emit('deposit_receipt_created', payload);
          console.log('‚úÖ Deposit receipt created sent via Socket.IO');
        } catch (error) {
          console.error('‚ùå Failed to emit via Socket.IO:', error);
        }
      } else {
        console.log('‚ö†Ô∏è Socket.IO not connected - using fallback');
      }
    
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Firebase ‡πÄ‡∏õ‡πá‡∏ô fallback
      sendDepositReceiptToFirebase(payload);
    
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô local storage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sync ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
      saveToLocalQueue('deposit_receipt_created', payload);
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô local storage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sync ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
    function saveToLocalQueue(type, data) {
      try {
        const queueKey = 'deposit_receipt_queue';
        const queue = JSON.parse(localStorage.getItem(queueKey) || '[]');
    
        queue.push({
          type: type,
          data: data,
          timestamp: Date.now(),
          synced: false
        });
    
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (queue.length > 100) {
          queue.splice(0, queue.length - 100);
        }
    
        localStorage.setItem(queueKey, JSON.stringify(queue));
        console.log(`üíæ Saved ${type} to local queue`);
      } catch (error) {
        console.error('‚ùå Failed to save to local queue:', error);
      }
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô queue ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
    function syncLocalQueue() {
      try {
        const queueKey = 'deposit_receipt_queue';
        const queue = JSON.parse(localStorage.getItem(queueKey) || '[]');
        const unsyncedItems = queue.filter(item => !item.synced);
    
        if (unsyncedItems.length === 0) return;
    
        console.log(`üîÑ Syncing ${unsyncedItems.length} items from local queue`);
    
        unsyncedItems.forEach(item => {
          if (depositReceiptSocket && socketConnected) {
            try {
              depositReceiptSocket.emit(item.type, item.data);
              item.synced = true;
              console.log(`‚úÖ Synced ${item.type} from queue`);
            } catch (error) {
              console.error(`‚ùå Failed to sync ${item.type}:`, error);
            }
          }
        });
    
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï queue
        localStorage.setItem(queueKey, JSON.stringify(queue));
    
        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà sync ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
        const cleanQueue = queue.filter(item => !item.synced && item.timestamp > dayAgo);
        localStorage.setItem(queueKey, JSON.stringify(cleanQueue));
    
      } catch (error) {
        console.error('‚ùå Failed to sync local queue:', error);
      }
    }

    // Get connection status
    function getConnectionStatus() {
      return {
        firebase: firebaseConnected,
        socket: socketConnected,
        combined: firebaseConnected && socketConnected,
        onlineUsers: onlineUsers,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode
      };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
    function manualRetryConnection() {
      console.log('üîÑ Manual retry connection requested');
    
      if (depositReceiptSocket) {
        if (socketConnected) {
          console.log('‚úÖ Already connected');
          showConnectionStatus('connected');
          return true;
        }
    
        try {
          depositReceiptSocket.connect();
          showConnectionStatus('reconnecting');
          console.log('üîÑ Attempting to reconnect...');
          return true;
        } catch (error) {
          console.error('‚ùå Manual retry failed:', error);
          showConnectionStatus('reconnect_error', error.message);
          return false;
        }
      } else {
        console.log('üîÑ Reinitializing Socket.IO...');
        initializeEnhancedSocket();
        return true;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function resetConnection() {
      console.log('üîÑ Reset all connections');
    
      // Stop heartbeat
      stopHeartbeat();
    
      // Disconnect Socket.IO
      if (depositReceiptSocket) {
        depositReceiptSocket.disconnect();
        depositReceiptSocket = null;
        window.depositReceiptSocket = null;
      }
    
      // Reset states
      socketConnected = false;
      reconnectAttempts = 0;
      window.socketIOFallbackMode = false;
    
      // Reinitialize after a short delay
      setTimeout(() => {
        initializeEnhancedSocket();
      }, 1000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    function checkSystemHealth() {
      console.log('üè• System Health Check');
    
      const health = {
        socketIO: {
          connected: socketConnected,
          socketId: depositReceiptSocket?.id || null,
          attempts: reconnectAttempts
        },
        firebase: {
          connected: firebaseConnected,
          session: currentSession.sessionId
        },
        fallbackMode: window.socketIOFallbackMode || false,
        localQueue: JSON.parse(localStorage.getItem('deposit_receipt_queue') || '[]').length,
        timestamp: new Date().toISOString()
      };
    
      console.table(health);
      return health;
    }

    // Global functions for deposit receipt system
    window.DepositReceiptConnection = {
      emitDepositReceiptUpdate,
      emitDepositReceiptCreated,
      sendNotificationToFirebase,
      sendDepositReceiptToFirebase,
      updateActivity,
      getConnectionStatus,
      syncLocalQueue,
      manualRetryConnection,
      resetConnection,
      checkSystemHealth,
      currentSession,
      firebaseRefs
    };

    // Show/Hide Loading with Lottie animation
    let lottieAnimation = null;
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // Initialize both systems when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Initializing Firebase + Socket.IO for deposit receipt system...');

      // Set branch code from global variable
      if (window.BRANCH_CODE) {
        currentSession.branchCode = window.BRANCH_CODE;
      }
    
      initializeEnhancedSocket();
      initializeFirebase();
    
      // Wait for Alpine.js to be ready (if available)
      setTimeout(() => {
        const alpineApp = document.querySelector('[x-data="app"]')?.__x;
        if (alpineApp) {
          console.log('üéØ Alpine.js detected, integration ready');
        }
      }, 1000);

      // Load deposit receipts after DOM is ready
      setTimeout(() => {
        if (typeof loadDepositReceipts === 'function') {
          loadDepositReceipts();
        } else {
          console.warn('‚ö†Ô∏è loadDepositReceipts function not found yet');
        }
      }, 100);

      // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
      setTimeout(() => {
        console.log('üõí Auto-loading branch products on page load...');
        if (typeof loadOnlineDepositProducts === 'function') {
          loadOnlineDepositProducts().then(() => {
            console.log('‚úÖ Branch products loaded automatically');
          }).catch(error => {
            console.error('‚ùå Error auto-loading products:', error);
          });
        }
      }, 500);

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥
      const createNewDepositBtn = document.getElementById('createNewDepositReceipt');
      if (createNewDepositBtn) {
        createNewDepositBtn.addEventListener('click', function() {
          console.log('‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß');
          openDepositReceiptModal();
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal
      const closeModalBtn = document.getElementById('closeDepositReceiptModal');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          console.log('üî¥ ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å');
          closeDepositReceiptModal();
        });
      } else {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal (#closeDepositReceiptModal)');
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      const cancelBtn = document.getElementById('cancelDepositReceipt');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          console.log('üî¥ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å');
          closeDepositReceiptModal();
        });
      } else {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (#cancelDepositReceipt)');
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdown button
      const dropdownToggle = document.getElementById('depositDropdownToggle');
      if (dropdownToggle) {
        dropdownToggle.addEventListener('click', function() {
          const dropdown = document.getElementById('depositDropdown');
          if (dropdown) {
            dropdown.classList.toggle('hidden');
          }
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡πà‡∏≤
      const createBlankBtn = document.getElementById('createBlankDeposit');
      if (createBlankBtn) {
        createBlankBtn.addEventListener('click', function() {
          console.log('üìÑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡πà‡∏≤');
          openDepositReceiptModal();
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      const editBtns = document.querySelectorAll('.edit-deposit-btn');
      editBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          console.log('‚úèÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
          // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        });
      });

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå
      const printBtns = document.querySelectorAll('.print-deposit-btn');
      printBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          console.log('üñ®Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
          // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
        });
      });

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
      const modal = document.getElementById('newDepositReceiptModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            console.log('üî¥ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal');
            closeDepositReceiptModal();
            document.body.style.overflow = '';
          }
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sale modal)
      const saleModal = document.getElementById('saleRedirectModal');
      if (saleModal) {
        saleModal.addEventListener('click', function(e) {
          if (e.target === saleModal) {
            console.log('üî¥ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Sale Modal');
            closeSaleModal();
            document.body.style.overflow = '';
          }
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
      // ‚úÖ FIX: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ setTimeout ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢)
      setTimeout(() => {
        if (typeof setupAgeCalculation === 'function') {
          setupAgeCalculation();
        }
      }, 100);

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      setTimeout(() => {
        if (typeof setupCustomerDataHandlers === 'function') {
          setupCustomerDataHandlers();
        }
      }, 100);

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      const saleTypeCash = document.getElementById('saleTypeCash');
      const saleTypeInstallment = document.getElementById('saleTypeInstallment');

      if (saleTypeCash) {
        saleTypeCash.addEventListener('change', updatePriceDisplay);
      }
      if (saleTypeInstallment) {
        saleTypeInstallment.addEventListener('change', updatePriceDisplay);
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏Ç‡∏≤‡∏¢‡∏™‡∏î)
      const set30PercentBtn = document.getElementById('set30Percent');
      const set50PercentBtn = document.getElementById('set50Percent');
      const setFullPriceBtn = document.getElementById('setFullPrice');
      const customDepositAmountInput = document.getElementById('customDepositAmount');

      if (set30PercentBtn) {
        set30PercentBtn.addEventListener('click', function() {
          const selectedProduct = window.selectedProductData;
          if (selectedProduct && selectedProduct.price && customDepositAmountInput) {
            const depositAmount = Math.round(selectedProduct.price * 0.3);
            customDepositAmountInput.value = depositAmount;
            console.log('üìä ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ 30%:', depositAmount);
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            updateAmountDisplay();
          } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
          }
        });
      }

      if (set50PercentBtn) {
        set50PercentBtn.addEventListener('click', function() {
          const selectedProduct = window.selectedProductData;
          if (selectedProduct && selectedProduct.price && customDepositAmountInput) {
            const depositAmount = Math.round(selectedProduct.price * 0.5);
            customDepositAmountInput.value = depositAmount;
            console.log('üìä ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ 50%:', depositAmount);
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            updateAmountDisplay();
          } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
          }
        });
      }

      if (setFullPriceBtn) {
        setFullPriceBtn.addEventListener('click', function() {
          const selectedProduct = window.selectedProductData;
          if (selectedProduct && selectedProduct.price && customDepositAmountInput) {
            const depositAmount = selectedProduct.price;
            customDepositAmountInput.value = depositAmount;
            console.log('üìä ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤:', depositAmount);
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            updateAmountDisplay();
          } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
          }
        });
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up deposit receipt connections...');
      stopHeartbeat();
    
      if (window.Firebase && firebaseRefs.sessions) {
        window.Firebase.remove(firebaseRefs.sessions);
      }
    
      if (depositReceiptSocket && socketConnected) {
        depositReceiptSocket.disconnect();
      }
    });

          console.log('üî• Firebase Realtime Database + Socket.IO integration loaded for deposit receipt');
    
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô periodic health check (‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
      setInterval(() => {
        if (!socketConnected && !window.socketIOFallbackMode) {
          console.warn('‚ö†Ô∏è Socket.IO disconnected for extended period.');
        }
      }, 30000);
  </script>


  <!-- 4. Custom styles (consolidated; removed duplicate #mainContent) -->
  <style>
    :root { 
      --primary-color: #0ea5e9; 
      --primary-light: #0ea5e9;
      --primary-dark: #0284c7;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #3b82f6;
      --border-radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    html, body { margin:0; padding:0; height:100%; overflow-x:hidden; }
    body { display:flex; flex-direction:column; font-family: 'Prompt', sans-serif; }
    #mainContent { flex:1; margin-left:16rem; transition: margin-left .3s ease; }
    
    .bubble h6 {
      font-size: 0.875rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }
    
    .dark body {
      background-color: #0f172a;
      color: #f8fafc;
    }
    
    /* Enhanced Card Styles */
    .deposit-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .deposit-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }
    
    .deposit-card:active {
      transform: translateY(0);
      box-shadow: var(--shadow-md);
    }
    
    .dark .deposit-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-color: #475569;
    }
    
    .dark .deposit-card:hover {
      border-color: #38bdf8;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }
    
    /* Card Header */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .dark .card-header {
      border-bottom-color: #475569;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }
    
    .dark .card-title {
      color: #f8fafc;
    }
    
    /* Status Badge Enhanced */
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-color: #f59e0b;
    }
    
    .status-completed {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-color: #10b981;
    }
    
    .status-cancelled {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border-color: #ef4444;
    }
    
    .dark .status-pending {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
      color: #fbbf24;
    }
    
    .dark .status-completed {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
      color: #6ee7b7;
    }
    
    .dark .status-cancelled {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
      color: #fca5a5;
    }
    
    /* Card Content */
    .card-content {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #e2e8f0;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      flex-shrink: 0;
    }
    
    .dark .product-image {
      border-color: #475569;
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
    }
    
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .deposit-card:hover .product-image img {
      transform: scale(1.05);
    }
    
    .card-info {
      flex: 1;
      min-width: 0;
    }
    
    .info-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.875rem;
    }
    
    .info-row:last-child {
      margin-bottom: 0;
    }
    
    .info-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .info-text {
      color: #64748b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .dark .info-text {
      color: #94a3b8;
    }
    
    /* Card Footer */
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }
    
    .dark .card-footer {
      border-top-color: #475569;
    }
    
    .amount-section {
      display: flex;
      gap: 24px;
      align-items: center;
      flex: 1;
    }
    
    .amount-item {
      text-align: center;
      min-width: 80px;
    }
    
    .amount-label {
      font-size: 0.7rem;
      color: #64748b;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .dark .amount-label {
      color: #94a3b8;
    }
    
    .amount-value {
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .amount-total {
      color: #1e293b;
    }
    
    .amount-deposit {
      color: var(--primary-color);
    }
    
    .amount-remaining {
      color: #ea580c;
    }
    
    .dark .amount-total {
      color: #f8fafc;
    }
    
    .dark .amount-deposit {
      color: #38bdf8;
    }
    
    .dark .amount-remaining {
      color: #fb923c;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .deposit-card:hover .quick-actions {
      opacity: 1;
    }
    
    .action-btn {
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s ease;
      border: 1px solid;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-btn-edit {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1d4ed8;
      border-color: #3b82f6;
    }
    
    .action-btn-edit:hover {
      background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
      transform: translateY(-1px);
    }
    
    .action-btn-delete {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #dc2626;
      border-color: #ef4444;
    }
    
    .action-btn-delete:hover {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      transform: translateY(-1px);
    }
    
    /* Cards Container */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      padding: 0;
    }
    
    @media (max-width: 768px) {
      .cards-container {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .amount-section {
        gap: 16px;
      }
      
      .amount-item {
        min-width: 60px;
      }
    }
    
    /* Enhanced Modal */
    .modal-overlay {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-xl);
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    
    .dark .modal-content {
      background: #1e293b;
      border: 1px solid #475569;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(20px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    /* Detail Modal Content */
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }
    
    @media (max-width: 768px) {
      .detail-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }
    
    .detail-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
    }
    
    .dark .detail-section {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      border-color: #64748b;
    }
    
    .detail-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dark .detail-title {
      color: #f8fafc;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .dark .detail-item {
      border-bottom-color: #475569;
    }
    
    .detail-label {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 500;
    }
    
    .detail-value {
      font-size: 0.875rem;
      color: #1e293b;
      font-weight: 600;
    }
    
    .dark .detail-label {
      color: #94a3b8;
    }
    
    .dark .detail-value {
      color: #f8fafc;
    }
    
    /* Enhanced Empty State */
    .empty-state {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px dashed #cbd5e1;
      border-radius: var(--border-radius);
      padding: 48px 24px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .dark .empty-state {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-color: #475569;
    }
    
    .empty-state:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    
    .empty-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .dark .empty-title {
      color: #f8fafc;
    }
    
    .empty-text {
      font-size: 1rem;
      color: #64748b;
      margin-bottom: 24px;
    }
    
    .dark .empty-text {
      color: #94a3b8;
    }
    
    /* Enhanced Buttons */
    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, #0369a1 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
      border-color: #64748b;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 100%);
      transform: translateY(-1px);
    }
    
    .btn-outline {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
      border-color: #d1d5db;
      backdrop-filter: blur(10px);
    }
    
    .btn-outline:hover {
      background: rgba(249, 250, 251, 0.9);
      border-color: #9ca3af;
    }
    
    .dark .btn-outline {
      background: rgba(30, 41, 59, 0.8);
      color: #f8fafc;
      border-color: #475569;
    }
    
    .dark .btn-outline:hover {
      background: rgba(51, 65, 85, 0.9);
      border-color: #64748b;
    }
    
    /* Loading State */
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
      .card-content {
        flex-direction: column;
        gap: 12px;
      }
      
      .product-image {
        width: 100%;
        height: 120px;
      }
      
      .amount-section {
        flex-direction: column;
        gap: 12px;
      }
      
      .amount-item {
        min-width: auto;
      }
    }
    
    /* Additional existing styles... */
    .breadcrumb-item {
      color: #6c757d;
    }
    
    .breadcrumb-item a {
      color: #0ea5e9;
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .dark .card {
      background-color: #2d3748;
      border-color: #4a5568;
    }
    
    .form-control {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      width: 100%;
    }
    
    .dark .form-control {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .btn-rounded {
      border-radius: 30px;
    }
    
    .btn-outline-primary {
      border: 1px solid #0ea5e9;
      color: #0ea5e9;
      background-color: white;
    }
    
    .btn-outline-primary:hover {
      background-color: #f0f9ff;
    }
    
    .dark .btn-outline-primary {
      color: #38bdf8;
      border-color: #38bdf8;
      background-color: transparent;
    }
    
    .dark .btn-outline-primary:hover {
      background-color: rgba(56, 189, 248, 0.1);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 1px solid #eee;
    }
    
    .dark .table th {
      background-color: #2d3748;
      color: #d1d5db;
      border-bottom-color: #4a5568;
    }
    
    .table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    
    .dark .table td {
      border-bottom-color: #4a5568;
      color: #f8f9fa;
    }
    
    .text-right {
      text-align: right;
    }
    
    .page-link {
      min-width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      margin: 0 2px;
    }
    
    .dark .page-link {
      border-color: #4a5568;
      color: #d1d5db;
    }
    
    .page-link:hover {
      background-color: #f9f9fb;
    }
    
    .dark .page-link:hover {
      background-color: #374151;
    }
    
    .page-link.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    
    .dropdown-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      color: #333;
    }
    
    .dark .dropdown-select {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .account-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .account-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .dark .account-list li {
      border-bottom-color: #4a5568;
    }
    
    .account-list li:hover {
      background-color: #f9f9fb;
    }
    
    .dark .account-list li:hover {
      background-color: #374151;
    }
    
    .account-list li.active {
      background-color: #f0f9ff;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .dark .account-list li.active {
      background-color: #1a4971;
      color: #38bdf8;
    }
    
    .date-range {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dark .date-range {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .date-range:focus {
      border-color: #0ea5e9;
      outline: none;
    }
    
    .negative-value {
      color: #ef4444;
    }
    
    .dark .negative-value {
      color: #f87171;
    }
    
    .navbar {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 30;
    }
    
    .dark .navbar {
      background-color: #1e293b;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .flex-1 {
      flex: 1;
    }
    
    .flex-none {
      flex: none;
    }
    
    .btn-fancy {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
    }
    
    .btn-fancy:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 1s;
    }
    
    .btn-fancy:active:after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Dropdown menu styling */
    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
    }
    
    .menu-horizontal {
      display: flex;
      flex-direction: row;
    }
    
    .dropdown {
      position: relative;
    }
    
    .dropdown > a {
      display: flex;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    
    .dropdown ul {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
      z-index: 50;
      padding: 0.5rem;
    }
    
    .dark .dropdown ul {
      background-color: #1e293b;
    }
    
    .dropdown:focus-within ul {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .dropdown ul li {
      list-style: none;
    }
    
    .dropdown ul li a {
      display: block;
      padding: 0.5rem 1rem;
      color: #374151;
      text-decoration: none;
      border-radius: 0.25rem;
    }
    
    .dark .dropdown ul li a {
      color: #d1d5db;
    }
    
    .dropdown ul li a:hover {
      background-color: #f3f4f6;
    }
    
    .dark .dropdown ul li a:hover {
      background-color: #374151;
    }
    
    .submenu-item {
      transition: background-color 0.2s, padding-left 0.2s;
      border-left: 3px solid transparent;
      margin-bottom: 2px;
    }
    
    .submenu-item:hover {
      border-left-color: #0ea5e9;
      padding-left: 0.25rem;
    }

    /* Active Sidebar Link */
    .sidebar-link-active {
      background-color: #e0f2fe; /* primary-100 */
      color: #0ea5e9; /* primary-500 */
      font-weight: 500;
    }
    .dark .sidebar-link-active {
      background-color: #0284c7; /* primary-600 */
      color: white;
    }
    
    /* User badge */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: rgba(14, 165, 233, 0.1);
      border-radius: 30px;
    }
    
    .user-avatar {
      background-color: #0ea5e9;
      color: white;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }
    
    .dark .user-avatar {
      background-color: #38bdf8;
      color: #1a202c;
    }
    
    /* Loader */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0ea5e9;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Tab active styling */
    .tab-active {
      background-color: #e0f2fe;
      color: #0ea5e9;
      font-weight: 500;
    }

    .dark .tab-active {
      background-color: #0284c7;
      color: white;
    }

    /* Badge styling */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-warning {
      background-color: #fef3c7;
      color: #d97706;
    }

    .badge-success {
      background-color: #d1fae5;
      color: #059669;
    }

    .badge-counter {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 9999px;
    }

    .badge-gray {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    .badge-orange {
      background-color: #ffedd5;
      color: #ea580c;
    }

    .badge-blue {
      background-color: #dbeafe;
      color: #2563eb;
    }

    .badge-green {
      background-color: #d1fae5;
      color: #059669;
    }

    .dark .badge-warning {
      background-color: rgba(217, 119, 6, 0.2);
      color: #fcd34d;
    }

    .dark .badge-success {
      background-color: rgba(5, 150, 105, 0.2);
      color: #6ee7b7;
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô style tag */
    .badge-error {
      background-color: #fee2e2;
      color: #dc2626;
    }

    .badge-info {
      background-color: #dbeafe;
      color: #2563eb;
    }

    .dark .badge-error {
      background-color: rgba(220, 38, 38, 0.2);
      color: #fca5a5;
    }

    .dark .badge-info {
      background-color: rgba(37, 99, 235, 0.2);
      color: #93bbfe;
    }

    /* Empty state */
    .empty-state-container {
      display: none;
      padding: 3rem;
      text-align: center;
    }

    .hover-scale:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease-in-out;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tablecustom */
    .table-custom {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-custom thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 16px;
      font-weight: 500;
      text-align: left;
      color: #4b5563;
      background-color: #f9fafb;
    }

    .dark .table-custom thead th {
      background-color: #1f2937;
      border-bottom: 1px solid #374151;
      color: #d1d5db;
    }

    .table-custom tbody td {
      padding: 12px 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e5e7eb;
      color: #1f2937;
    }

    .dark .table-custom tbody td {
      border-bottom: 1px solid #374151;
      color: #e5e7eb;
    }

    .quotation-table-container {
      overflow-x: auto;
      border-radius: 8px;
      max-width: 100%;
      margin-bottom: 20px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
    }

    .modal-container {
      max-height: 90vh;
      overflow-y: auto;
    }

    /* New CSS for Sidebar & Layout */
    #btnToggleMenu { 
    }
    aside.collapsed {
      width: 5rem;
    }
    aside.collapsed .ml-3 {
      display: none;
    }
    /* Main content adjustment */
    #mainContent {
      transition: margin-left 0.3s ease-in-out;
    }
    .main-content {
      margin-left: 16rem;
      transition: margin-left 0.3s;
    }
    /* Active sidebar item */
    #sidebar ul li a.active {
      background-color: #0ea5e9 !important;
      color: #fff !important;
    }
    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #fff !important;
    }
    .dark #sidebar ul li a.active {
      background-color: #0284c7 !important;
    }
    /* Hover for non-active */
    #sidebar ul li a:not(.active):hover {
      background-color: #f3f4f6;
    }
    #sidebar ul li a {
      color: #333333 !important;
    }

    /* Main content margin - ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö sidebar.js */
    #mainContent {
      margin-left: 16rem; /* 14rem -> 16rem for w-64 sidebar */
      transition: margin-left 0.3s ease;
    }
    #mainContent.sidebar-closed {
      margin-left: 0;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ sidebar.js -->
  <div id="sidebarContainer"></div>

  <!-- Main Content -->
  <div id="mainContent" class="flex-1 p-6">
    <!-- Header ‡∏™‡∏≤‡∏Ç‡∏≤ -->
    <header class="mb-6 p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 rounded-lg">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥</h1>
          <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
          </p>
        </div>
        <div class="flex items-center gap-3">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
          <button
            id="createNewDepositReceipt"
            class="btn btn-primary btn-sm gap-2 btn-fancy hover-scale shadow-md"
          >
            <i class="bi bi-plus-lg"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥
          </button>

          <!-- Quick Actions Menu ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
          <div class="relative">
            <button id="quickActionsBtn" class="btn btn-outline btn-sm flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300">
              <i class="bi bi-list text-lg"></i>
              <span class="hidden md:inline">‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
              <i class="bi bi-chevron-down text-sm ml-1"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
              <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between">
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</span>
                <span id="dropdownBranchInfo" class="text-xs text-gray-400">‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</span>
              </div>
              
              <!-- ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
              <a href="/DepositReceiptInvoice" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors duration-200">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                  <i class="bi bi-receipt text-green-600"></i>
                </div>
                <div>
                  <div class="font-medium">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</div>
                  <div class="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
                </div>
              </a>

              <!-- ‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ -->
              <a href="/CreditNoteSimple" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-200">
                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                  <i class="bi bi-file-earmark-minus text-orange-600"></i>
                </div>
                <div>
                  <div class="font-medium">‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ</div>
                  <div class="text-xs text-gray-500">‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
                </div>
              </a>

              
              <!-- Footer with shortcuts -->
              <div class="px-4 py-2 border-t border-gray-100 mt-2">
                <div class="flex items-center justify-between text-xs text-gray-400">
                  <span>‡∏Å‡∏î Alt+M ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
                  <span>v1.0.0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Modular Notifications -->
          <div class="flex items-center gap-4">
            <!-- POS Notification Bell -->
            <div class="notification-bell pos-module" id="posNotificationBell">
              <button class="notification-toggle" title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" id="posNotificationCount">0</span>
              </button>
              
              <!-- Dropdown Notifications -->
              <div class="notification-dropdown" id="posNotificationDropdown">
                <div class="notification-header">
                  <h3><i class="bi bi-shop-window"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS</h3>
                  <div class="notification-actions">
                    <button class="mark-all-read" onclick="markAllAsRead('pos')">
                      <i class="bi bi-check-all"></i>
                    </button>
                    <button class="clear-all" onclick="clearAllNotifications('pos')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="notification-list" id="posNotificationList">
                  <!-- Notifications will be inserted here -->
                </div>
              </div>
            </div>
          </div>

          <div class="flex items-center">
            <i class="bi bi-receipt-cutoff text-3xl text-teal-500"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Toast Notification Container for POS Module -->
    <div id="posToastContainer" class="toast-container pos-module"></div>

    <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
    <div class="text-sm breadcrumbs mb-4">
      <ul>
        
      </ul>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .deposit-card {
            transition: all 0.3s ease;
        }
        
        .deposit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-image img {
            transition: transform 0.3s ease;
        }
        
        .product-image img:hover {
            transform: scale(1.05);
        }
        
        .status-badge {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        
        .amount-value {
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .quick-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .deposit-card:hover .quick-actions {
            opacity: 1;
        }
        
        /* Enhanced dropdown styling for product selection */
        #productDropdownSelect option[disabled] {
            font-weight: bold;
            color: #333 !important;
            background-color: #e3f2fd !important;
        }
        
        #productDropdownSelect option:not([disabled]) {
            padding-left: 20px;
        }

        /* Enhanced styling for sale type radio buttons */
        .sale-type-option {
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 12px 16px;
            border: 2px solid transparent;
        }

        .sale-type-option:hover {
            background-color: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .sale-type-option.disabled {
            opacity: 0.4;
            background-color: rgba(156, 163, 175, 0.1);
            cursor: not-allowed;
            pointer-events: none;
        }

        .sale-type-option.disabled input[type="radio"] {
            cursor: not-allowed;
        }

        .sale-type-option.disabled .sale-type-label {
            color: #9ca3af !important;
        }

        /* Enhanced validation feedback */
        .stock-validation {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Product info card enhancements */
        #selectedProductInfo .installment-details {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Enhanced Animation Keyframes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        /* Card Animation Classes */
        .card-enter {
            animation: slideInUp 0.5s ease-out forwards;
        }
        
        .card-enter-stagger {
            animation: slideInUp 0.5s ease-out forwards;
            animation-delay: var(--stagger-delay, 0ms);
        }
        
        /* Hover Animations */
        .hover-lift:hover {
            transform: translateY(-4px);
            transition: transform 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transition: box-shadow 0.3s ease;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            backdrop-filter: blur(12px);
        }
    </style>


    <!-- Enhanced Deposit Receipts Cards Container -->
    <div class="mb-8">
      <!-- Section Header -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
              <i class="bi bi-receipt-cutoff text-white text-xl"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>
          </div>
          
          <!-- Quick Stats -->
          <div class="flex flex-wrap lg:flex-nowrap items-center gap-3">
            <div class="text-center px-4 py-3 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 rounded-xl border border-blue-200 dark:border-blue-700">
              <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="todayCount">0</div>
              <div class="text-xs font-medium text-blue-700 dark:text-blue-300">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            <div class="text-center px-4 py-3 bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/30 dark:to-emerald-800/30 rounded-xl border border-emerald-200 dark:border-emerald-700">
              <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400" id="monthCount">0</div>
              <div class="text-xs font-medium text-emerald-700 dark:text-emerald-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            <div class="text-center px-4 py-3 bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/30 rounded-xl border border-amber-200 dark:border-amber-700">
              <div class="text-2xl font-bold text-amber-600 dark:text-amber-400" id="pendingCount">0</div>
              <div class="text-xs font-medium text-amber-700 dark:text-amber-300">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards Grid with Enhanced Layout -->
      <div id="depositReceiptsContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      <!-- Cards will be dynamically loaded here -->
      </div>
    </div>

    <!-- Modern Enhanced Empty State -->
    <div id="emptyState" class="empty-state-container hidden">
      <div class="empty-state relative">
        <!-- Background decorations -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-teal-50 dark:from-gray-800 dark:to-gray-700 rounded-3xl"></div>
        <div class="absolute top-4 right-4 w-20 h-20 bg-gradient-to-br from-blue-200/30 to-teal-200/30 rounded-full blur-xl"></div>
        <div class="absolute bottom-4 left-4 w-16 h-16 bg-gradient-to-br from-purple-200/30 to-pink-200/30 rounded-full blur-lg"></div>
        
        <!-- Content -->
        <div class="relative z-10 text-center py-16 px-8">
          <!-- Animated icon -->
          <div class="empty-icon mb-8 relative">
            <div class="w-24 h-24 mx-auto bg-gradient-to-br from-blue-100 to-teal-100 dark:from-blue-900/50 dark:to-teal-900/50 rounded-2xl flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
              <i class="bi bi-receipt-cutoff text-4xl text-blue-500 dark:text-blue-400"></i>
            </div>
            <!-- Floating animation -->
            <div class="absolute -top-2 -right-2 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg animate-bounce">
              <span class="text-sm">üí∞</span>
            </div>
          </div>
          
          
          <!-- Action button with enhanced design -->
          <button id="btnCreateFromEmpty" class="group relative px-8 py-4 bg-gradient-to-r from-blue-500 to-teal-500 text-white font-semibold rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105 active:scale-95">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-teal-600 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="relative flex items-center gap-3">
              <i class="bi bi-plus-circle-fill text-xl"></i>
              <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            </div>
            <!-- Shine effect -->
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></div>
        </button>
          
        </div>
      </div>
    </div>

    <!-- Enhanced Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
    <div id="depositReceiptDetailModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50">
      <div class="modal-content w-11/12 max-w-4xl p-6">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200 dark:border-gray-600">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
            <i class="bi bi-receipt-cutoff text-primary-500"></i>
            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
          </h2>
          <button id="closeDepositReceiptDetailModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>
        <div id="depositReceiptDetailContent" class="mb-6">
          <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
          <button id="btnEditReceipt" class="btn btn-primary">
            <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          </button>
          <button id="btnPrintReceipt" class="btn btn-outline">
            <i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå
          </button>
          <button id="btnLoadPDF" class="btn btn-outline">
            <i class="bi bi-file-earmark-pdf"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF
          </button>
          <button id="btnCloseDetail" class="btn btn-outline">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
    
    <!-- Pagination -->
    <!-- Simple Pagination -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mt-6">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
          <span>‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-50" disabled>
            <i class="bi bi-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
          </button>
          <span class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg">1</span>
          <button class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg border border-gray-300 dark:border-gray-600">
            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for creating a new deposit receipt -->
  <div id="newDepositReceiptModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-4xl p-6 modal-container">
      <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
        <h2 id="modalTitle" class="text-xl font-semibold dark:text-white">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
        <button id="closeDepositReceiptModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="overflow-y-auto">
        <form id="depositReceiptForm">
          <!-- Salesperson Section -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</h3>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</label>
                <div class="relative">
                  <select id="salespersonSelect" name="salesperson" class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 pr-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white appearance-none" disabled>
                    <!-- Options will be populated by JavaScript -->
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-600">
                    <i class="bi bi-person-check"></i>
                  </div>
                </div>
                <p class="mt-2 text-sm text-blue-600 dark:text-blue-400 flex items-center">
                  <i class="bi bi-info-circle mr-2"></i>
                  ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                </p>
              </div>
            </div>
          </div>

          <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥</h3>
            <div class="flex gap-4">
              <label class="inline-flex items-center">
                <input type="radio" name="depositType" value="preorder" class="form-radio h-5 w-5 text-blue-600">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Pre-order (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="depositType" value="online" checked class="form-radio h-5 w-5 text-blue-600">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)</span>
              </label>
            </div>
          </div>

          <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="sale-type-option cursor-pointer hover:shadow-sm" id="cashSaleOption">
                <div class="flex items-center">
                  <input type="radio" name="saleType" value="cash" checked class="form-radio h-5 w-5 text-blue-600 mr-3" id="saleTypeCashRadio">
                  <div class="flex items-center">
                    <i class="bi bi-cash text-green-500 mr-2 text-lg"></i>
                    <div>
                      <span class="sale-type-label text-sm font-medium text-gray-700 dark:text-gray-300">‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
                    </div>
                  </div>
                </div>
              </label>
              <label class="sale-type-option cursor-pointer hover:shadow-sm" id="installmentSaleOption">
                <div class="flex items-center">
                  <input type="radio" name="saleType" value="installment" class="form-radio h-5 w-5 text-blue-600 mr-3" id="saleTypeInstallmentRadio">
                  <div class="flex items-center">
                    <i class="bi bi-credit-card text-blue-500 mr-2 text-lg"></i>
                    <div>
                      <span class="sale-type-label text-sm font-medium text-gray-700 dark:text-gray-300">‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                    </div>
                  </div>
                </div>
              </label>
            </div>

            <!-- Sale Type Validation Status -->
            <div id="saleTypeValidationStatus" class="mt-3 text-sm hidden">
              <!-- Validation messages will be displayed here -->
            </div>

            <!-- Conditional navigation buttons -->
            <div id="cashSaleButtonContainer" class="mt-4">
              <button type="button" id="btnCashSaleNavigate" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center gap-2">
                <i class="bi bi-cash text-xl"></i>
                <span>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</span>
              </button>
            </div>
            <div id="installmentSaleButtonContainer" class="mt-4 hidden">
              <button type="button" id="btnInstallmentSaleNavigate" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center justify-center gap-2">
                <i class="bi bi-credit-card text-xl"></i>
                <span>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô</span>
              </button>
            </div>


          </div>

          <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</label>
                <input type="date" id="depositDate" name="depositDate" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required />
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  <i class="bi bi-calendar mr-1"></i>
                  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" id="depositTime" name="depositTime" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required />
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  <i class="bi bi-clock mr-1"></i>
                  ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                </p>
              </div>
            </div>
          </div>

          <!-- Customer Section -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
              <i class="bi bi-person-badge"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </h3>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
            <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
              </label>
              <div class="flex gap-2">
                <input type="text" id="customerSearchInput" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13" />
                <button id="btnSearchCustomer" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>
            </div>

            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
              <select id="customerType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                <option value="individual">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
                <option value="corporate">‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
              </select>
            </div>

            <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -->
            <div id="personalFields" class="grid grid-cols-2 lg:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                <select id="customerPrefix" name="customerPrefix" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
                  <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                  <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                  <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô.‡∏™.</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                <input type="text" id="customerFirstName" name="customerFirstName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="customerLastName" name="customerLastName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                <input type="text" id="customerPhone" name="customerPhone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î
                  <span class="text-xs text-gray-500">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                </label>
                <input type="date" id="customerBirthDate" name="customerBirthDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" 
                       title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏</label>
                <input type="number" id="customerAge" name="customerAge" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" min="0" max="150" readonly />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                <input type="text" id="houseNo" name="houseNo" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏´‡∏°‡∏π‡πà</label>
                <input type="text" id="moo" name="moo" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏´‡∏°‡∏π‡πà" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                <div class="relative">
                  <input type="text" id="province" name="province" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" autocomplete="off" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                <div class="relative">
                  <input type="text" id="district" name="district" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" autocomplete="off" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ï‡∏≥‡∏ö‡∏•</label>
                <div class="relative">
                  <input type="text" id="subDistrict" name="subDistrict" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ï‡∏≥‡∏ö‡∏•" autocomplete="off" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                <div class="relative">
                  <input type="text" id="zipcode" name="zipcode" 
                    class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" 
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" 
                    maxlength="5" 
                    pattern="[0-9]{5}"
                    title="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" />
                  <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <i class="bi bi-geo-alt text-gray-400"></i>
                  </div>
                </div>
              </div>
              <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="customerEmailPersonal" name="customerEmail" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
              </div>
              <div class="lg:col-span-3">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label>
                <input type="text" id="customerTaxId" name="customerTaxId" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" maxlength="13" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (13 ‡∏´‡∏•‡∏±‡∏Å)" />
              </div>
            </div>

            <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) -->
            <div id="corporateFields" class="grid grid-cols-2 gap-3 hidden">
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                <input type="text" id="companyName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</label>
                <input type="text" id="companyTaxId" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" />
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å</label>
                <input type="text" id="contactPerson" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</label>
                <input type="text" id="corporatePhone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</label>
                <input type="email" id="corporateEmail" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                <input type="text" id="companyAddress" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
              </div>
            </div>
          </div>

          <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            
            <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order -->
            <div id="preorderFields" class="hidden">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Pre-order)</label>
                <div class="mt-2">
                  <select id="preorderProductSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order...</option>
                  </select>
                  <p class="mt-1 text-sm text-orange-500 dark:text-orange-400">
                    <i class="bi bi-info-circle mr-1"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)
                  </p>
                </div>
                <div id="selectedPreorderProductInfo" class="mt-3 p-4 bg-orange-50 dark:bg-gray-700 rounded-lg border border-orange-200 dark:border-gray-600 hidden">
                  <!-- Selected pre-order product details will go here -->
                </div>
              </div>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</label>
                  <input type="date" id="expectedDate" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                  <input type="text" id="preorderNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ, ‡∏£‡∏∏‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
              </div>
            </div>
            
            <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå -->
            <div id="onlineFields">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <div class="mt-2">
                  <select id="productDropdownSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</option>
                  </select>
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
                </div>
                <div id="selectedProductInfo" class="mt-3 p-4 bg-blue-50 dark:bg-gray-700 rounded-lg border border-blue-200 dark:border-gray-600 hidden">
                  <!-- Selected product details will go here -->
                </div>
              </div>

              <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
              <div class="mb-4">
                <h4 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3">
                  <i class="bi bi-wallet2 text-green-600 mr-2"></i>
                  ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                </h4>
                
                <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î -->
                <div id="cashDepositSection" class="mb-4 p-4 bg-green-50 dark:bg-gray-700 rounded-lg border border-green-200 dark:border-gray-600">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="bi bi-cash-coin text-green-600 mr-1"></i>
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏Ç‡∏≤‡∏¢‡∏™‡∏î)
                  </label>
                  <div class="flex items-center gap-3">
                    <input 
                      type="number" 
                      id="customDepositAmount" 
                      name="customDepositAmount" 
                      min="0" 
                      step="0.01" 
                      class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white" 
                      placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥"
                    >
                    <span class="text-sm text-gray-500 dark:text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                  </div>
                  <div class="mt-2 flex items-center gap-2">
                    <button type="button" id="set30Percent" class="btn btn-outline btn-xs text-xs px-2 py-1 border border-green-300 text-green-600 hover:bg-green-50">
                      30% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
                    </button>
                    <button type="button" id="set50Percent" class="btn btn-outline btn-xs text-xs px-2 py-1 border border-green-300 text-green-600 hover:bg-green-50">
                      50% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
                    </button>
                    <button type="button" id="setFullPrice" class="btn btn-outline btn-xs text-xs px-2 py-1 border border-green-300 text-green-600 hover:bg-green-50">
                      ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤
                    </button>
                  </div>
                  <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    <i class="bi bi-info-circle mr-1"></i>
                    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                  </p>
                </div>

                <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô -->
                <div id="installmentDepositSection" class="mb-4 p-4 bg-blue-50 dark:bg-gray-700 rounded-lg border border-blue-200 dark:border-gray-600 hidden">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="bi bi-credit-card text-blue-600 mr-1"></i>
                    ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô)
                  </label>
                  <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-gray-600 dark:text-gray-400">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span>
                      <span id="downAmountDisplay" class="font-medium text-blue-600">‡∏ø0</span>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                      <i class="bi bi-info-circle mr-1"></i>
                      ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô: ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                    </div>
                  </div>

                  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ -->
                  <div id="installmentDetailsSection" class="mt-3 bg-white dark:bg-gray-800 p-3 rounded border hidden">
                    <div class="mb-2">
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞:</span>
                    </div>
                    <div class="space-y-2">
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥):</span>
                        <span id="minimumDownAmount" class="font-medium text-green-600">‡∏ø0</span>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">‡∏á‡∏ß‡∏î:</span>
                        <span id="installmentPeriods" class="font-medium text-blue-600">0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                        <span id="monthlyPayment" class="font-medium text-orange-600">‡∏ø0</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏±‡∏î‡∏à‡∏≥ -->
                <div id="depositSummary" class="mt-3 p-3 bg-yellow-50 dark:bg-gray-700 rounded-lg border border-yellow-200 dark:border-gray-600 hidden">
                  <div class="text-sm">
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-gray-600 dark:text-gray-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
                      <span id="productPriceDisplay" class="font-medium">‡∏ø0</span>
                    </div>
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-gray-600 dark:text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
                      <span id="finalDepositDisplay" class="font-bold text-green-600">‡∏ø0</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-1 mt-1">
                      <span class="text-gray-600 dark:text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                      <span id="remainingAmountDisplay" class="font-medium text-orange-600">‡∏ø0</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  <i class="bi bi-file-earmark-text text-blue-600 mr-1"></i>
                  ‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </label>
                <input
                  type="number"
                  id="docFee"
                  name="docFee"
                  value="0"
                  min="0"
                  step="0.01"
                  class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  placeholder="0.00"
                >
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  <i class="bi bi-info-circle mr-1"></i>
                  ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏≤‡∏Å‡∏°‡∏µ (‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
                </p>
              </div>

              <!-- ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  <i class="bi bi-truck text-orange-600 mr-1"></i>
                  ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                </label>
                <input
                  type="number"
                  id="shippingCost"
                  name="shippingCost"
                  value="0"
                  min="0"
                  step="0.01"
                  class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  placeholder="0.00"
                >
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  <i class="bi bi-info-circle mr-1"></i>
                  ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏´‡∏≤‡∏Å‡∏°‡∏µ
                </p>
              </div>
            </div>
          </div>
          
          <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">
              <i class="bi bi-calculator text-blue-600 mr-2"></i>
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ
            </h3>
            <div class="space-y-3">
              <label class="inline-flex items-center">
                <input type="radio" name="taxType" value="none" class="form-radio h-4 w-4 text-blue-600" onchange="handleTaxTypeChange()">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-x-circle text-gray-500 mr-2"></i>
                  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ
                </span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="taxType" value="inclusive" class="form-radio h-4 w-4 text-blue-600" onchange="handleTaxTypeChange()">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-check-circle text-green-500 mr-2"></i>
                  ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ
                </span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="taxType" value="exclusive" checked class="form-radio h-4 w-4 text-blue-600" onchange="handleTaxTypeChange()">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-plus-circle text-blue-500 mr-2"></i>
                  ‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ
                </span>
              </label>
            </div>

            <!-- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ) -->
            <div id="taxRateSection" class="mt-4 p-3 bg-blue-50 dark:bg-gray-700/50 rounded-lg border border-blue-200 dark:border-gray-600">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="bi bi-percent text-blue-600 mr-1"></i>
                ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ (%)
              </label>
              <div class="flex items-center gap-3">
                <input
                  type="number"
                  id="taxRateInput"
                  name="taxRate"
                  value="7"
                  min="0"
                  max="100"
                  step="0.01"
                  class="w-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  onchange="handleTaxRateChange()"
                />
                <span class="text-sm text-gray-600 dark:text-gray-400">%</span>
                <button
                  type="button"
                  class="px-3 py-2 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-md hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors"
                  onclick="document.getElementById('taxRateInput').value = 7; handleTaxRateChange();"
                >
                  ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 7%
                </button>
              </div>
              <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                <i class="bi bi-info-circle mr-1"></i>
                ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠ 7% ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              </p>
            </div>

            <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">
              <i class="bi bi-info-circle mr-1"></i>
              <span id="taxTypeDescription">‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </p>
          </div>

          <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h3>
            <div class="space-y-3">
              <label class="inline-flex items-center">
                <input type="radio" name="documentChoice" value="receipt" class="form-radio h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-receipt text-green-500 mr-2"></i>
                  ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                </span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="documentChoice" value="tax_invoice" class="form-radio h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-file-earmark-text text-blue-500 mr-2"></i>
                  ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
                </span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="documentChoice" value="both" checked class="form-radio h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 flex items-center">
                  <i class="bi bi-files text-purple-500 mr-2"></i>
                  ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
                </span>
              </label>
            </div>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
              <i class="bi bi-info-circle mr-1"></i>
              ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
            </p>
          </div>

          <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
          <div class="mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/30">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">
              <i class="bi bi-credit-card text-green-600 mr-2"></i>
              ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î -->
              <label class="payment-method-option cursor-pointer p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-green-500 hover:bg-green-50 dark:hover:bg-gray-700 transition-all duration-200" id="cashPaymentOption">
                <div class="flex items-center">
                  <input type="radio" name="paymentMethod" value="cash" class="form-radio h-5 w-5 text-green-600 mr-3" id="paymentMethodCash">
                  <div class="flex items-center">
                    <i class="bi bi-cash-coin text-green-500 mr-3 text-2xl"></i>
                    <div>
                      <span class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    </div>
                  </div>
                </div>
              </label>

              <!-- ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
              <label class="payment-method-option cursor-pointer p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-gray-700 transition-all duration-200" id="transferPaymentOption">
                <div class="flex items-center">
                  <input type="radio" name="paymentMethod" value="transfer" class="form-radio h-5 w-5 text-blue-600 mr-3" id="paymentMethodTransfer">
                  <div class="flex items-center">
                    <i class="bi bi-bank text-blue-500 mr-3 text-2xl"></i>
                    <div>
                      <span class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    </div>
                  </div>
                </div>
              </label>

              <!-- ‡∏ú‡∏™‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô) -->
              <label class="payment-method-option cursor-pointer p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-gray-700 transition-all duration-200" id="mixedPaymentOption">
                <div class="flex items-center">
                  <input type="radio" name="paymentMethod" value="mixed" class="form-radio h-5 w-5 text-purple-600 mr-3" id="paymentMethodMixed">
                  <div class="flex items-center">
                    <i class="bi bi-shuffle text-purple-500 mr-3 text-2xl"></i>
                    <div>
                      <span class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ú‡∏™‡∏°</span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                    </div>
                  </div>
                </div>
              </label>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° -->
            <div id="mixedPaymentDetails" class="mt-4 p-4 bg-purple-50 dark:bg-gray-700 rounded-lg border border-purple-200 dark:border-gray-600 hidden">
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-3">
                <i class="bi bi-calculator text-purple-600 mr-2"></i>
                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="bi bi-cash-coin text-green-600 mr-1"></i>
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                  </label>
                  <div class="flex items-center">
                    <input type="number" id="cashAmount" name="cashAmount" min="0" step="0.01"
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white"
                           placeholder="0.00">
                    <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="bi bi-bank text-blue-600 mr-1"></i>
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏≠‡∏ô
                  </label>
                  <div class="flex items-center">
                    <input type="number" id="transferAmount" name="transferAmount" min="0" step="0.01"
                           class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white"
                           placeholder="0.00" readonly>
                    <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">‡∏ö‡∏≤‡∏ó</span>
                  </div>
                  <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    <i class="bi bi-info-circle mr-1"></i>
                    ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                  </p>
                </div>
              </div>

              <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ -->
              <div class="mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg border">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-gray-600 dark:text-gray-400">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span>
                  <span id="totalPayableAmount" class="font-medium">‡∏ø0</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-1">
                  <span class="text-gray-600 dark:text-gray-400">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span>
                  <span id="displayCashAmount" class="text-green-600">‡∏ø0</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-1">
                  <span class="text-gray-600 dark:text-gray-400">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                  <span id="displayTransferAmount" class="text-blue-600">‡∏ø0</span>
                </div>
                <hr class="my-2">
                <div class="flex justify-between items-center text-sm font-medium">
                  <span class="text-gray-700 dark:text-gray-300">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                  <span id="displayTotalAmount" class="text-purple-600">‡∏ø0</span>
                </div>
              </div>
            </div>

            <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">
              <i class="bi bi-info-circle mr-1"></i>
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </p>
          </div>

          <!-- Hidden fields for selected product -->
          <input type="hidden" name="productId" id="productId">
          <input type="hidden" name="productNameHidden" id="productNameHidden">
          <input type="hidden" name="productPrice" id="productPrice">
          <input type="hidden" name="totalAmount" id="totalAmount">
          <input type="hidden" name="depositAmount" id="depositAmount">
          <input type="hidden" name="customerSearch" id="customerSearch">
          <input type="hidden" name="customerName" id="customerName">
          <input type="hidden" name="customerAddress" id="customerAddress">

          <!-- Action Buttons -->
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" id="cancelDepositReceipt" class="btn btn-outline btn-sm px-4 py-2 border border-gray-300 hover:bg-gray-100 rounded-md text-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" id="submitDepositReceiptBtn" class="btn btn-primary btn-sm px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Show/hide sale buttons based on saleType selection
    document.addEventListener('DOMContentLoaded', function() {
      const saleTypeCashRadio = document.getElementById('saleTypeCashRadio');
      const saleTypeInstallmentRadio = document.getElementById('saleTypeInstallmentRadio');
      const cashSaleButtonContainer = document.getElementById('cashSaleButtonContainer');
      const installmentSaleButtonContainer = document.getElementById('installmentSaleButtonContainer');
    
      function updateSaleButtons() {
        if (saleTypeCashRadio.checked) {
          cashSaleButtonContainer.classList.remove('hidden');
          installmentSaleButtonContainer.classList.add('hidden');
        } else if (saleTypeInstallmentRadio.checked) {
          cashSaleButtonContainer.classList.add('hidden');
          installmentSaleButtonContainer.classList.remove('hidden');
        }
        updateAmountDisplay();
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô dropdown ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        if (typeof updateProductDropdownPrices === 'function') {
          updateProductDropdownPrices();
        }
      }
    
      if (saleTypeCashRadio) {
        saleTypeCashRadio.addEventListener('change', updateSaleButtons);
      }
      if (saleTypeInstallmentRadio) {
        saleTypeInstallmentRadio.addEventListener('change', updateSaleButtons);
      }
    
      updateSaleButtons();
    });
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateAmountDisplay - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function updateAmountDisplay() {
      try {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ
        const productPrice = parseFloat(document.getElementById('productPrice')?.value || 0);
        const depositPercent = parseFloat(document.getElementById('depositPercent')?.value || 30); // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 30%
        const docFee = parseFloat(document.getElementById('docFee')?.value || 0);
        const shippingCost = parseFloat(document.getElementById('shippingCost')?.value || 0);
        const customDepositAmount = parseFloat(document.getElementById('customDepositAmount')?.value || 0);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        const saleTypeCash = document.getElementById('saleTypeCashRadio')?.checked;
        const saleTypeInstallment = document.getElementById('saleTypeInstallmentRadio')?.checked;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        const cashDepositSection = document.getElementById('cashDepositSection');
        const installmentDepositSection = document.getElementById('installmentDepositSection');

        if (saleTypeCash) {
          // ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î - ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
          if (cashDepositSection) cashDepositSection.classList.remove('hidden');
          if (installmentDepositSection) installmentDepositSection.classList.add('hidden');

          // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
          const installmentDetailsSection = document.getElementById('installmentDetailsSection');
          if (installmentDetailsSection) installmentDetailsSection.classList.add('hidden');

          const finalDeposit = customDepositAmount + shippingCost;
          const remainingAmount = productPrice - customDepositAmount;

          updateDisplayElements(productPrice, finalDeposit, remainingAmount, '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î');
          updateHiddenFields(productPrice, finalDeposit);

        } else if (saleTypeInstallment) {
          // ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô - ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå)
          if (cashDepositSection) cashDepositSection.classList.add('hidden');
          if (installmentDepositSection) installmentDepositSection.classList.remove('hidden');

          const downPayment = (productPrice * depositPercent) / 100;
          const finalDeposit = downPayment + shippingCost;
          const remainingAmount = productPrice - downPayment;

          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô installment
          const downAmountDisplay = document.getElementById('downAmountDisplay');
          if (downAmountDisplay) {
            downAmountDisplay.textContent = `‡∏ø${downPayment.toLocaleString()}`;
          }

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
          const selectedProductData = window.selectedProductData || null;
          updateInstallmentDetails(productPrice, downPayment, selectedProductData);

          updateDisplayElements(productPrice, finalDeposit, remainingAmount, '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');
          updateHiddenFields(productPrice, finalDeposit);
        }

        console.log('üí∞ Amount display updated:', {
          saleType: saleTypeCash ? 'cash' : 'installment',
          productPrice,
          depositPercent,
          customDepositAmount,
          shippingCost,
          finalDeposit: saleTypeCash ? customDepositAmount + shippingCost : (productPrice * depositPercent) / 100 + shippingCost,
          customDepositElement: document.getElementById('customDepositAmount')?.value,
          finalDepositElement: document.getElementById('finalDepositDisplay')?.textContent
        });

      } catch (error) {
        console.error('‚ùå Error updating amount display:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï display elements
    function updateDisplayElements(productPrice, finalDeposit, remainingAmount, saleTypeText) {
      const productPriceDisplay = document.getElementById('productPriceDisplay');
      const finalDepositDisplay = document.getElementById('finalDepositDisplay');
      const remainingAmountDisplay = document.getElementById('remainingAmountDisplay');

      if (productPriceDisplay) {
        productPriceDisplay.textContent = `‡∏ø${productPrice.toLocaleString()} (${saleTypeText})`;
      }

      if (finalDepositDisplay) {
        finalDepositDisplay.textContent = `‡∏ø${finalDeposit.toLocaleString()}`;
      }

      if (remainingAmountDisplay) {
        remainingAmountDisplay.textContent = `‡∏ø${remainingAmount.toLocaleString()}`;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï hidden fields
    function updateHiddenFields(productPrice, finalDeposit) {
      const totalAmountField = document.getElementById('totalAmount');
      const depositAmountField = document.getElementById('depositAmount');

      if (totalAmountField) {
        totalAmountField.value = productPrice;
      }

      if (depositAmountField) {
        depositAmountField.value = finalDeposit;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
    function updateInstallmentDetails(productPrice, downPayment, productData = null) {
      const installmentDetailsSection = document.getElementById('installmentDetailsSection');
      const minimumDownAmount = document.getElementById('minimumDownAmount');
      const installmentPeriods = document.getElementById('installmentPeriods');
      const monthlyPayment = document.getElementById('monthlyPayment');

      if (!installmentDetailsSection) return;

      // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      let minimumDown, installmentCount, monthlyInstallment;

      if (productData && productData.downAmount && productData.downInstallmentCount && productData.downInstallment) {
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ProductImage
        minimumDown = productData.downAmount;
        installmentCount = productData.downInstallmentCount;
        monthlyInstallment = productData.downInstallment;

        console.log('üéØ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', {
          downAmount: minimumDown,
          periods: installmentCount,
          monthlyPayment: monthlyInstallment
        });
      } else {
        // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const defaultPeriods = 12;
        const minimumDownPercent = 30; // ‡πÉ‡∏ä‡πâ 30% ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô depositPercent

        minimumDown = (productPrice * minimumDownPercent) / 100;
        installmentCount = defaultPeriods;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå
        const remainingAmount = productPrice - downPayment;
        monthlyInstallment = remainingAmount / defaultPeriods;

        console.log('üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', {
          productPrice,
          downPayment,
          minimumDown,
          remainingAmount,
          periods: defaultPeriods,
          monthlyPayment: monthlyInstallment
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      if (minimumDownAmount) {
        minimumDownAmount.textContent = `‡∏ø${minimumDown.toLocaleString()}`;
      }

      if (installmentPeriods) {
        installmentPeriods.textContent = `${installmentCount} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
      }

      if (monthlyPayment) {
        monthlyPayment.textContent = `‡∏ø${monthlyInstallment.toLocaleString()}`;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
      installmentDetailsSection.classList.remove('hidden');

      console.log('üí≥ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const productPriceField = document.getElementById('productPrice');
      if (productPriceField) {
        productPriceField.addEventListener('input', updateAmountDisplay);
      }

      // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏°‡∏±‡∏î‡∏à‡∏≥
      const depositPercentField = document.getElementById('depositPercent');
      if (depositPercentField) {
        depositPercentField.addEventListener('input', updateAmountDisplay);
      }

      // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      const docFeeField = document.getElementById('docFee');
      if (docFeeField) {
        docFeeField.addEventListener('input', updateAmountDisplay);
      }

      // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
      const shippingCostField = document.getElementById('shippingCost');
      if (shippingCostField) {
        shippingCostField.addEventListener('input', updateAmountDisplay);
      }

      // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î)
      const customDepositAmountField = document.getElementById('customDepositAmount');
      if (customDepositAmountField) {
        customDepositAmountField.addEventListener('input', updateAmountDisplay);
      }

      // Radio buttons ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      const saleTypeCashRadio = document.getElementById('saleTypeCashRadio');
      const saleTypeInstallmentRadio = document.getElementById('saleTypeInstallmentRadio');

      if (saleTypeCashRadio) {
        saleTypeCashRadio.addEventListener('change', function() {
          updateAmountDisplay();
          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô dropdown ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
          if (typeof updateProductDropdownPrices === 'function') {
            updateProductDropdownPrices();
          }
        });
      }

      if (saleTypeInstallmentRadio) {
        saleTypeInstallmentRadio.addEventListener('change', function() {
          updateAmountDisplay();
          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô dropdown ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
          if (typeof updateProductDropdownPrices === 'function') {
            updateProductDropdownPrices();
          }
        });
      }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å API (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_pattani.html)
    async function loadBranchInfo() {
      try {
        const BRANCH_CODE = window.BRANCH_CODE || '00001';
        const token = localStorage.getItem('authToken') || '';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ localStorage ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const branchNameFromStorage = localStorage.getItem('activeBranchName');
        const urlParams = new URLSearchParams(window.location.search);
        const branchNameFromURL = urlParams.get('name');

        console.log('üè¢ Loading branch info for code:', BRANCH_CODE);
        console.log('üè¢ Branch name from URL:', branchNameFromURL);
        console.log('üè¢ Branch name from storage:', branchNameFromStorage);

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ localStorage ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
        const branchName = branchNameFromURL || branchNameFromStorage;

        if (branchName && BRANCH_CODE) {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          document.getElementById('branchInfo').textContent = `${branchName} (${BRANCH_CODE})`;
          document.title = `‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ - ${branchName}`;
          document.getElementById('pageTitle').textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ - ${branchName}`;

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown ‡∏î‡πâ‡∏ß‡∏¢
          const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
          if (dropdownBranchInfo) {
            dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branchName}`;
          }

          console.log('‚úÖ Branch info loaded from cache:', branchName);
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const js = await res.json();
        if (res.ok && js.success) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === BRANCH_CODE);
          if (branch) {
            const fullBranchInfo = `${branch.name} ‚Äî ${branch.address}`;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
            document.getElementById('branchInfo').textContent = fullBranchInfo;
            document.title = `‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ - ${branch.name}`;
            document.getElementById('pageTitle').textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ - ${branch.name}`;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï localStorage ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            localStorage.setItem('activeBranchName', branch.name);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown ‡∏î‡πâ‡∏ß‡∏¢
            const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
            if (dropdownBranchInfo) {
              dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branch.name}`;
            }

            console.log('‚úÖ Branch info updated from API:', branch.name);
            return;
          }
        }

        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        // ‡∏ñ‡πâ‡∏≤ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL/localStorage ‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
        if (!document.getElementById('branchInfo').textContent) {
          document.getElementById('branchInfo').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ';
        }
      }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ updateAmountDisplay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏à‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    setTimeout(async () => {
      updateAmountDisplay();
      await loadBranchInfo();
    }, 500);
    
    // Cash sale button click handler
    const btnCashSaleNavigate = document.getElementById('btnCashSaleNavigate');
    if (btnCashSaleNavigate) {
      btnCashSaleNavigate.addEventListener('click', async function() {
        let receiptId = window.currentReceiptId || '';
        if (!receiptId) {
          receiptId = document.querySelector('[name="receiptId"]')?.value || '';
        }
        if (!receiptId) {
          return;
        }
        await navigateToSale(receiptId, 'cash');
      });
    }
    
    // Installment sale button click handler
    const btnInstallmentSaleNavigate = document.getElementById('btnInstallmentSaleNavigate');
    if (btnInstallmentSaleNavigate) {
      btnInstallmentSaleNavigate.addEventListener('click', async function() {
        let receiptId = window.currentReceiptId || '';
        if (!receiptId) {
          receiptId = document.querySelector('[name="receiptId"]')?.value || '';
        }
        if (!receiptId) {
          return;
        }
        await navigateToSale(receiptId, 'installment');
      });
    }
  </script>

  <script>
    // Global variables
    let depositReceipts = [];
    let currentGroupedProducts = {};
    let receiptAvailabilityData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• availability ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö‡∏£‡∏±‡∏ö

    // Load deposit receipts on page load
    async function loadDepositReceipts() {
      try {
        showLoading(true);
    
        const token = localStorage.getItem('authToken');
        const headers = {
          'Content-Type': 'application/json'
        };
    
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
    
        // ‡πÉ‡∏ä‡πâ Global BRANCH_CODE
        const BRANCH_CODE = window.BRANCH_CODE || '00001';

        const response = await fetch(`/api/deposit-receipts?branchCode=${BRANCH_CODE}&limit=50&_t=${Date.now()}`, {
          headers: headers,
          cache: 'no-cache'
        });
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const result = await response.json();
    
        if (result.success && result.data) {
          depositReceipts = result.data;
          // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
          window.depositReceipts = depositReceipts;
          displayDepositReceipts(depositReceipts);
        } else {
          console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
          depositReceipts = [];
          window.depositReceipts = [];
          displayDepositReceipts(depositReceipts);
        }
    
      } catch (error) {
        console.error('‚ùå Error loading deposit receipts:', error);
    
        // ‡πÅ‡∏™‡∏î‡∏á empty state ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        depositReceipts = [];
        displayDepositReceipts(depositReceipts);
    
        // ‡πÅ‡∏™‡∏î‡∏á notification error
        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
            message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
            type: 'error'
          });
        }
      } finally {
        showLoading(false);
      }
    }

    // Display deposit receipts as cards with enhanced animations
    async function displayDepositReceipts(receipts) {
      const container = document.getElementById('depositReceiptsContainer');
      const emptyState = document.getElementById('emptyState');
    
      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ credited, cancelled ‡∏´‡∏£‡∏∑‡∏≠ completed ‡∏≠‡∏≠‡∏Å (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á)
      const activeReceipts = receipts ? receipts.filter(receipt => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (receipt.status === 'credited' || receipt.status === 'cancelled' || receipt.status === 'completed') {
          console.log(`üì¶ Archived receipt ${receipt.receiptNumber || receipt.documentNumber}: Status = ${receipt.status}`);
          return false;
        }

        return true;
      }) : [];
    
      if (!activeReceipts || activeReceipts.length === 0) {
        if (container) container.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        updateQuickStats(receipts); // ‡∏™‡πà‡∏á receipts ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        return;
      }
    
      if (emptyState) emptyState.style.display = 'none';
    
      if (container) {
        // Clear existing content
        container.innerHTML = '';
    
        // Create cards with staggered animation (async)
        for (let index = 0; index < activeReceipts.length; index++) {
          const receipt = activeReceipts[index];
          const cardElement = document.createElement('div');
          cardElement.className = 'opacity-0 transform translate-y-4';

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ö‡∏ö async
          try {
            const cardHTML = await createDepositReceiptCard(receipt);
            cardElement.innerHTML = cardHTML;
            container.appendChild(cardElement);

            // Animate in with delay
            setTimeout(() => {
              cardElement.classList.remove('opacity-0', 'transform', 'translate-y-4');
              cardElement.classList.add('opacity-100', 'transition-all', 'duration-500', 'ease-out');
            }, index * 100); // 100ms delay between each card
          } catch (error) {
            console.error('‚ùå Error creating deposit receipt card:', error);
            // Create fallback card without availability checking
            const fallbackHTML = createFallbackDepositReceiptCard(receipt);
            cardElement.innerHTML = fallbackHTML;
            container.appendChild(cardElement);

            setTimeout(() => {
              cardElement.classList.remove('opacity-0', 'transform', 'translate-y-4');
              cardElement.classList.add('opacity-100', 'transition-all', 'duration-500', 'ease-out');
            }, index * 100);
          }
        }
    
        // Update statistics with active receipts only
        updateQuickStats(activeReceipts);
    
        console.log(`‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${receipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏° Animation`);
      } else {
        console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö depositReceiptsContainer!');
      }
    }

    // Update quick statistics
    function updateQuickStats(receipts) {
      if (!receipts || receipts.length === 0) {
        document.getElementById('todayCount').textContent = '0';
        document.getElementById('monthCount').textContent = '0';
        document.getElementById('pendingCount').textContent = '0';
        return;
      }

      const today = new Date();
      const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

      // Count receipts for today
      const todayCount = receipts.filter(receipt => {
        const receiptDate = new Date(receipt.createdAt || receipt.depositDate);
        return receiptDate >= startOfToday;
      }).length;

      // Count receipts for this month
      const monthCount = receipts.filter(receipt => {
        const receiptDate = new Date(receipt.createdAt || receipt.depositDate);
        return receiptDate >= startOfMonth;
      }).length;

      // Count pending receipts
      const pendingCount = receipts.filter(receipt =>
        receipt.status === 'pending' || receipt.status === 'confirmed'
      ).length;

      // Animate counter updates
      animateCounter('todayCount', todayCount);
      animateCounter('monthCount', monthCount);
      animateCounter('pendingCount', pendingCount);
    }

    // Animate counter with counting effect
    function animateCounter(elementId, targetValue) {
      const element = document.getElementById(elementId);
      if (!element) return;

      const startValue = parseInt(element.textContent) || 0;
      const duration = 1000; // 1 second
      const startTime = Date.now();

      function updateCounter() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
    
        element.textContent = currentValue;
    
        if (progress < 1) {
          requestAnimationFrame(updateCounter);
        }
      }
    
      updateCounter();
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    async function openDepositReceiptModal() {
      const modal = document.getElementById('newDepositReceiptModal');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        console.log('üìã ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î modal
        try {
          console.log('üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°...');

          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login
          await loadSalespersonDataFromLogin();

          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          await loadProductData();

          // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          await loadCustomerTypes();

          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          setupProductSelectionListeners();

          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö radio buttons ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
          setupSaleTypeListeners();

          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö radio buttons ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
          setupDepositTypeListeners();

          console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        } catch (error) {
          console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', error);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ click outside modal
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            console.log('üî¥ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Modal - ‡∏õ‡∏¥‡∏î Modal');
            closeDepositReceiptModal();
          }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ESC key
        document.addEventListener('keydown', function escapeHandler(e) {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            console.log('üî¥ ‡∏Å‡∏î ESC - ‡∏õ‡∏¥‡∏î Modal');
            closeDepositReceiptModal();
            document.removeEventListener('keydown', escapeHandler);
          }
        });
      } else {
        console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Modal (#newDepositReceiptModal)');
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
    function closeDepositReceiptModal() {
      const modal = document.getElementById('newDepositReceiptModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        console.log('‚ùå ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
      }
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML card ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    async function createDepositReceiptCard(receipt) {
      // ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤ tracking object ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      receipt = ensureTrackingObject(receipt);
      const statusColor = {
        'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'confirmed': 'bg-blue-100 text-blue-800 border-blue-200',
        'completed': 'bg-green-100 text-green-800 border-green-200',
        'cancelled': 'bg-red-100 text-red-800 border-red-200'
      };

      const statusText = {
        'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      };

      const customerName = receipt.customer?.name || '';
      const productName = receipt.product?.name || '';
      const depositAmount = (receipt.amounts?.depositAmount || 0).toLocaleString();
      const status = receipt.status || 'pending';

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      const saleType = receipt.saleType || 'preorder';
      console.log('üîç DEBUG - Receipt ID:', receipt._id);
      console.log('üîç DEBUG - saleType:', saleType);
      console.log('üîç DEBUG - depositType:', receipt.depositType);

      let availabilityInfo = '';
      let actionButtons = '';

      if (saleType === 'preorder' && receipt.product) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö availability ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global variable ‡∏Å‡πà‡∏≠‡∏ô
        const receiptId = receipt.id || receipt.receiptNumber;
        let availability = receiptAvailabilityData[receiptId];

        if (!availability) {
          try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤
            console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:', receiptId);
            availability = await checkProductAvailabilityInBranch(
              receipt.product._id || receipt.product.id,
              receipt.product.name,
              receipt.product.brand || '',
              receipt.product.model || ''
            );

            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ tracking.stockChecked ‡πÄ‡∏õ‡πá‡∏ô true
            if (availability.available) {
              console.log('‚úÖ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó tracking status');
              await updateTrackingStatus(receiptId, 'stockChecked', true);
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö availability:', error);
            availability = { available: false };
          }
        } else {
          console.log('üì¶ ‡πÉ‡∏ä‡πâ availability ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:', receiptId, availability);
        }

        if (availability.available) {
            availabilityInfo = `
              <div class="flex items-center gap-2 p-2 bg-green-50 border border-green-200 rounded-md mb-3">
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                <span class="text-xs text-green-700 font-medium">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (${availability.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)</span>
              </div>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ï‡∏≤‡∏° saleType ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
            const currentSaleType = receipt.saleType || 'cash';
            const buttonClass = currentSaleType === 'installment' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-emerald-500 hover:bg-emerald-600';
            const buttonText = currentSaleType === 'installment' ? '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';

            actionButtons = `
              <div class="mt-2">
                <button onclick="navigateToDirectSale('${receipt._id}', '${availability.branchStockId}', '${currentSaleType}')"
                        class="w-full ${buttonClass} text-white text-sm px-4 py-2 rounded-md transition-colors font-medium">
                  ${buttonText}
                </button>
              </div>
            `;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà confirmed
            if (status !== 'confirmed') {
              actionButtons += `
                <div class="text-xs text-orange-600 mt-1 text-center">
                  üí° ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
                </div>
              `;
            }
          } else {
            availabilityInfo = `
              <div class="flex items-center gap-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md mb-3">
                <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                <span class="text-xs text-yellow-700 font-medium">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (Pre-order)</span>
              </div>
            `;
          }
      } else if (receipt.depositType === 'online') {
        availabilityInfo = `
          <div class="flex items-center gap-2 p-2 bg-blue-50 border border-blue-200 rounded-md mb-3">
            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
            <span class="text-xs text-blue-700 font-medium">‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
          </div>
        `;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏™‡∏°‡∏≠)
        console.log('üîç DEBUG - Online deposit receipt:', receipt._id);
        console.log('üîç DEBUG - receipt.product:', receipt.product);
        console.log('üîç DEBUG - receipt.saleType:', receipt.saleType);

        const productRef = receipt.product?.branchStockId || // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î - BranchStock ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                          receipt.product?._id ||
                          receipt.product?.id ||
                          receipt.productId ||
                          receipt.product?.productId ||
                          receipt.product?.product_id ||
                          receipt.product?.stockId;

        console.log('üîç DEBUG - productRef:', productRef);
        console.log('üîç DEBUG - product.name:', receipt.product?.name);

        if (receipt.product && productRef) {
          console.log('‚úÖ DEBUG - Condition 1: ‡∏°‡∏µ productRef');
          // ‡∏°‡∏µ productRef - ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏î‡πâ‡∏ß‡∏¢ productId
          const onlineSaleType = receipt.saleType || 'cash';
          const onlineButtonClass = onlineSaleType === 'installment' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-emerald-500 hover:bg-emerald-600';
          const onlineButtonText = onlineSaleType === 'installment' ? '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';

          actionButtons = `
            <div class="mt-2">
              <button onclick="navigateToDirectSale('${receipt._id}', '${productRef}', '${onlineSaleType}')"
                      class="w-full ${onlineButtonClass} text-white text-sm px-4 py-2 rounded-md transition-colors font-medium">
                ${onlineButtonText}
              </button>
            </div>
          `;

          console.log('‚úÖ DEBUG - actionButtons ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à:', actionButtons.substring(0, 100));

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà confirmed
          if (status !== 'confirmed') {
            actionButtons += `
              <div class="text-xs text-blue-600 mt-1 text-center">
                üí° ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
              </div>
            `;
          }
        } else if (receipt.product && receipt.product.name) {
          console.log('‚úÖ DEBUG - Condition 2: ‡∏°‡∏µ product.name ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ productRef');
          // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
          const onlineSaleType = receipt.saleType || 'cash';
          const onlineButtonClass = onlineSaleType === 'installment' ? 'bg-orange-400 hover:bg-orange-500' : 'bg-emerald-400 hover:bg-emerald-500';
          const onlineButtonText = onlineSaleType === 'installment' ? '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';

          actionButtons = `
            <div class="mt-2">
              <button onclick="navigateToSaleWithProductName('${receipt._id}', '${receipt.product.name || ''}', '${onlineSaleType}')" class="w-full ${onlineButtonClass} text-white text-sm px-4 py-2 rounded-md transition-colors font-medium">
                ${onlineButtonText}
              </button>
            </div>
            <div class="text-xs text-orange-600 mt-1 text-center">
              üîç ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            </div>
          `;

          console.log('‚úÖ DEBUG - actionButtons ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à:', actionButtons.substring(0, 100));
        } else {
          console.log('‚ö†Ô∏è DEBUG - Condition 3: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
          // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
          actionButtons = `
            <button onclick="convertToSale('${receipt._id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
              ‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ç‡∏≤‡∏¢
            </button>
          `;
        }

        console.log('üéØ DEBUG - Final actionButtons:', actionButtons);
      }

      console.log('üì¶ DEBUG - Before return - actionButtons:', actionButtons);
      console.log('üì¶ DEBUG - actionButtons truthy?:', !!actionButtons);

      return `
        <div data-receipt-id="${receipt._id || receipt.id || receipt.receiptNumber}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-4 hover:shadow-lg transition-all duration-300">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">${receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">${new Date(receipt.depositDate || receipt.createdAt).toLocaleDateString('th-TH')}</p>
            </div>
            <span class="px-3 py-1 text-xs font-medium rounded-full border ${statusColor[status] || statusColor['pending']}">
              ${statusText[status] || statusText['pending']}
            </span>
          </div>

          ${availabilityInfo}

          <div class="space-y-2 mb-4">
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${customerName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${productName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
              <span class="text-sm font-bold text-green-600 dark:text-green-400">‡∏ø${depositAmount}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${receipt.salesperson?.name || ''}</span>
            </div>
          </div>

          <!-- Tracking Status Summary -->
          ${receipt.tracking ? `
          <div class="flex items-center justify-center space-x-3 py-2 mb-2 bg-gray-50 dark:bg-gray-700 rounded-md">
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.stockChecked ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.stockChecked ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.notificationSent ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.notificationSent ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.customerContacted ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.customerContacted ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
            </div>
          </div>
          ` : ''}

          <div class="flex gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
            <button onclick="viewDepositDetails('${receipt._id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
            <button onclick="loadDepositDocument('${receipt._id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
              ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            </button>
            <button onclick="createCreditNote('${receipt._id}')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-2 rounded-md transition-colors" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ">
              ‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ
            </button>
            <button onclick="deleteDeposit('${receipt._id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
              ‡∏•‡∏ö
            </button>
          </div>

          <!-- Navigation buttons section (conditional based on product availability) -->
          ${actionButtons ? `
          <div class="flex gap-2 pt-2">
            ${actionButtons}
          </div>
          ` : ''}
        </div>
      `;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î fallback ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏î‡πâ
    function createFallbackDepositReceiptCard(receipt) {
      const statusColor = {
        'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'confirmed': 'bg-blue-100 text-blue-800 border-blue-200',
        'completed': 'bg-green-100 text-green-800 border-green-200',
        'cancelled': 'bg-red-100 text-red-800 border-red-200'
      };

      const statusText = {
        'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      };

      const customerName = receipt.customer?.name || '';
      const productName = receipt.product?.name || '';
      const depositAmount = (receipt.amounts?.depositAmount || 0).toLocaleString();
      const status = receipt.status || 'pending';

      return `
        <div data-receipt-id="${receipt._id || receipt.id || receipt.receiptNumber}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 p-4 hover:shadow-lg transition-all duration-300">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">${receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">${new Date(receipt.depositDate || receipt.createdAt).toLocaleDateString('th-TH')}</p>
            </div>
            <span class="px-3 py-1 text-xs font-medium rounded-full border ${statusColor[status] || statusColor['pending']}">
              ${statusText[status] || statusText['pending']}
            </span>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${customerName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${productName}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
              <span class="text-sm font-bold text-green-600 dark:text-green-400">‡∏ø${depositAmount}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${receipt.salesperson?.name || ''}</span>
            </div>
          </div>

          <!-- Tracking Status Summary -->
          ${receipt.tracking ? `
          <div class="flex items-center justify-center space-x-3 py-2 mb-2 bg-gray-50 dark:bg-gray-700 rounded-md">
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.stockChecked ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.stockChecked ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.notificationSent ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.notificationSent ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="text-xs ${receipt.tracking.customerContacted ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.customerContacted ? '‚úÖ' : '‚ùå'}</span>
              <span class="text-xs text-gray-600 dark:text-gray-400">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
            </div>
          </div>
          ` : ''}

          <div class="flex gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
            <button onclick="viewDepositDetails('${receipt._id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
            ${status === 'confirmed' ? `
              <button onclick="convertToSale('${receipt._id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-2 rounded-md transition-colors">
                ‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ç‡∏≤‡∏¢
              </button>
            ` : ''}
            <button onclick="createCreditNote('${receipt._id}')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-2 rounded-md transition-colors" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ">
              ‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ
            </button>
          </div>
        </div>
      `;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    function navigateToDirectSale(receiptId, branchStockId, saleType) {
      console.log(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢: ${saleType}`, {
        receiptId,
        branchStockId,
        saleType,
        currentUrl: window.location.href,
        branchCode: window.BRANCH_CODE || '00000'
      });

      try {
        console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ:', { receiptId, branchStockId, saleType });

        if (saleType === 'cash') {
          // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î - ‡πÉ‡∏ä‡πâ relative path
          const cashUrl = `./frontstore_pattani?branch=${window.BRANCH_CODE || '00000'}&product=${branchStockId}&receipt=${receiptId}`;
          console.log('üéØ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ Cash Sale:', cashUrl);
          window.location.href = cashUrl;
        } else if (saleType === 'installment') {
          // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô - ‡πÉ‡∏ä‡πâ relative path
          const installmentUrl = `./installment/step2/step2.html?branch=${window.BRANCH_CODE || '00000'}&product=${branchStockId}&receipt=${receiptId}`;
          console.log('üéØ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ Installment Sale:', installmentUrl);
          window.location.href = installmentUrl;
        }
      } catch (error) {
        console.error('‚ùå Error in navigateToDirectSale:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ productId)
    function navigateToSaleWithProductName(receiptId, productName, saleType) {
      console.log('üîç Navigating to sale with product name:', { receiptId, productName, saleType });

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
      localStorage.setItem('fromDepositReceipt', receiptId);
      localStorage.setItem('searchProductName', productName);

      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢',
          message: `üîç ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: "${productName}" ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢`,
          type: 'info',
          duration: 3000
        });
      }

      if (saleType === 'cash') {
        // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        window.location.href = `/views/pattani/frontstore_pattani.html?branch=${window.BRANCH_CODE || '00000'}&search=${encodeURIComponent(productName)}&receipt=${receiptId}`;
      } else if (saleType === 'installment') {
        // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        window.location.href = `/views/pattani/installment/step2/step2.html?branch=${window.BRANCH_CODE || '00000'}&search=${encodeURIComponent(productName)}&receipt=${receiptId}`;
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° form submit handler
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      function getPaymentDetails(formData) {
        const paymentMethod = formData.get('paymentMethod');
        const paymentDetails = {
          method: paymentMethod
        };

        if (paymentMethod === 'mixed') {
          const cashAmount = parseFloat(formData.get('cashAmount')) || 0;
          const transferAmount = parseFloat(formData.get('transferAmount')) || 0;

          paymentDetails.cash = cashAmount;
          paymentDetails.transfer = transferAmount;
          paymentDetails.total = cashAmount + transferAmount;

          console.log('üí≥ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°:', paymentDetails);
        }

        return paymentDetails;
      }

      const depositForm = document.querySelector('#depositReceiptForm');
      if (depositForm) {
        console.log('‚úÖ ‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° depositReceiptForm ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° event listener');
        depositForm.addEventListener('submit', async function(e) {
          console.log('üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ñ‡∏π‡∏Å submit');
          e.preventDefault();

          const formData = new FormData(depositForm);
          const submitBtn = document.getElementById('submitDepositReceiptBtn');

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å select
            const salespersonSelect = document.getElementById('salespersonSelect');
            const selectedSalesperson = salespersonSelect.selectedOptions[0];
            const salespersonId = salespersonSelect.value;
            const salespersonName = selectedSalesperson ? selectedSalesperson.textContent : '';

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const selectedDepositType = formData.get('depositType') || 'online';
            const selectedSaleType = formData.get('saleType') || 'installment';

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å global variables ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
            let productData = null;
            if (selectedDepositType === 'online') {
              // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å branchStockRoutes.js
              productData = window.selectedProductData || null;
            } else if (selectedDepositType === 'preorder') {
              // Pre-order - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å productImageRoutes.js
              productData = window.selectedProductData || null;
            }

            const depositAmount = parseFloat(formData.get('depositAmount') || 0);
            const totalAmount = parseFloat(formData.get('totalAmount') || 0);
            const remainingAmount = totalAmount - depositAmount;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            const paymentMethod = formData.get('paymentMethod');
            if (!paymentMethod) {
              throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
            if (paymentMethod === 'mixed') {
              const cashAmount = parseFloat(formData.get('cashAmount')) || 0;
              const transferAmount = parseFloat(formData.get('transferAmount')) || 0;
              const totalPayment = cashAmount + transferAmount;

              if (cashAmount <= 0) {
                throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°');
              }

              if (Math.abs(totalPayment - depositAmount) > 0.01) {
                throw new Error(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (${totalPayment.toLocaleString()}) ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (${depositAmount.toLocaleString()})`);
              }

              console.log('‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°‡∏ú‡πà‡∏≤‡∏ô:', {
                cash: cashAmount,
                transfer: transferAmount,
                total: totalPayment,
                deposit: depositAmount
              });
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const lastValidation = window.lastStockValidationResult;
            const hasRecentValidation = lastValidation &&
              lastValidation.productId === (productData?.id || formData.get('productId')) &&
              lastValidation.depositType === selectedDepositType &&
              (new Date() - new Date(lastValidation.validationTime)) < 300000; // ‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ tracking ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            let initialStockChecked = false;
            let initialValidationResult = null;

            if (hasRecentValidation && selectedDepositType === 'online') {
              // ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏° sale type
              const validationResult = selectedSaleType === 'cash' ? lastValidation.cashResult : lastValidation.installmentResult;
              if (validationResult && validationResult.valid) {
                initialStockChecked = true;
                initialValidationResult = validationResult;
              }
            } else if (selectedDepositType === 'preorder') {
              // Pre-order ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              initialStockChecked = true;
              initialValidationResult = {
                valid: true,
                message: 'Pre-order ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å',
                supportsCash: true,
                supportsInstallment: true
              };
            }

            const depositData = {
              customer: {
                name: formData.get('customerName'),
                firstName: formData.get('customerFirstName'),
                lastName: formData.get('customerLastName'),
                prefix: formData.get('customerPrefix'),
                phone: formData.get('customerPhone'),
                email: formData.get('customerEmail'),
                idCard: formData.get('customerTaxId'), // ‡πÉ‡∏ä‡πâ customerTaxId ‡πÄ‡∏õ‡πá‡∏ô idCard
                taxId: formData.get('customerTaxId'),
                gender: formData.get('customerGender'),
                age: formData.get('customerAge') ? parseInt(formData.get('customerAge')) : null,
                birthDate: formData.get('customerBirthDate'),
                customerType: 'individual',
                address: formData.get('customerAddress') ? {
                  fullAddress: formData.get('customerAddress'),
                  houseNo: formData.get('houseNo'),
                  moo: formData.get('moo'),
                  subDistrict: formData.get('subDistrict'),
                  district: formData.get('district'),
                  province: formData.get('province'),
                  zipcode: formData.get('zipcode')
                } : null
              },
              product: {
                id: productData?.id || productData?._id || formData.get('productId'),
                _id: productData?._id || productData?.id || formData.get('productId'),
                branchStockId: productData?.branchStockId || productData?._id || productData?.id || formData.get('productId'), // ‡πÄ‡∏Å‡πá‡∏ö BranchStock ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
                name: formData.get('productName') || productData?.name || '',
                brand: productData?.brand || '',
                model: productData?.model || '',
                price: parseFloat(formData.get('productPrice') || productData?.price || 0),
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
                ...(selectedSaleType === 'installment' && productData ? {
                  downAmount: productData.downAmount || 0,
                  downInstallment: productData.downInstallment || 0,
                  downInstallmentCount: productData.downInstallmentCount || 12
                } : {})
              },
              amounts: {
                depositAmount: depositAmount,
                totalAmount: totalAmount,
                remainingAmount: remainingAmount,
                docFee: parseFloat(formData.get('docFee') || 0),
                shippingFee: parseFloat(formData.get('shippingCost') || 0)
              },
              branch: {
                code: window.BRANCH_CODE || '00001',
                name: localStorage.getItem('activeBranchName') || '‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'
              },
              salesperson: {
                id: salespersonId,
                name: salespersonName.replace(/\s*\([^)]*\)\s*$/, '').trim() // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô (role) ‡∏≠‡∏≠‡∏Å
              },
              saleType: selectedSaleType,
              paymentMethod: formData.get('paymentMethod'),
              paymentDetails: getPaymentDetails(formData),
              depositType: selectedDepositType, // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              depositDate: new Date().toISOString(),
              depositTime: new Date().toTimeString().slice(0, 5),
              documentChoice: 'receipt',
              status: 'pending',
              // ‡πÄ‡∏û‡∏¥‡πà‡∏° tracking object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
              tracking: {
                stockChecked: initialStockChecked,
                notificationSent: false,
                customerContacted: false,
                stockCheckDate: initialStockChecked ? new Date().toISOString() : null,
                notificationDate: null,
                contactDate: null,
                stockValidationResult: initialValidationResult
              }
            };

            console.log('üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á:', {
              id: salespersonId,
              name: salespersonName,
              originalText: selectedSalesperson?.textContent,
              cleanedName: salespersonName.replace(/\s*\([^)]*\)\s*$/, '').trim()
            });

            console.log('üìä ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', {
              hasRecentValidation: hasRecentValidation,
              depositType: selectedDepositType,
              saleType: selectedSaleType,
              initialStockChecked: initialStockChecked,
              initialValidationResult: initialValidationResult
            });

            // üîç Frontend Encoding Debug
            console.log('üîç [FRONTEND ENCODING DEBUG] Form data encoding:');
            console.log('üìã Raw customerName from form:', formData.get('customerName'));
            console.log('üìã Raw customerAddress from form:', formData.get('customerAddress'));
            console.log('üìã Raw salesperson name:', salespersonName);

            // Check character encoding on frontend
            const customerNameFromForm = formData.get('customerName');
            if (customerNameFromForm) {
              console.log('üîç Customer name character codes:', customerNameFromForm.split('').map(char => char.charCodeAt(0)));
              console.log('üîç Customer name UTF-16 codes:', customerNameFromForm.split('').map(char => '\\u' + char.charCodeAt(0).toString(16).padStart(4, '0')).join(''));
            }

            console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ API:', depositData);

            const response = await fetch('/api/deposit-receipts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify(depositData)
            });

            if (response.ok) {
              const result = await response.json();

              // ‡∏õ‡∏¥‡∏î modal
              closeDepositReceiptModal();

              // ‡πÅ‡∏™‡∏î‡∏á notification
              if (window.posNotificationSystem) {
                window.posNotificationSystem.addNotification('pos', {
                  title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                  message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${result.data.receiptNumber} ‡πÅ‡∏•‡πâ‡∏ß`,
                  type: 'success'
                });
              }

              // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ï‡∏≤‡∏° Flow
              try {
                const createResult = await createQuotationAndReceipts(result.data);
                console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', createResult);
              } catch (docError) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:', docError);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                let errorMessage = '‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
                if (docError.message) {
                  errorMessage += ': ' + docError.message;
                }

                if (window.posNotificationSystem) {
                  window.posNotificationSystem.addNotification('pos', {
                    title: '‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                    message: errorMessage,
                    type: 'warning',
                    duration: 10000 // ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                  });
                }
              }

              // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ cache)
              setTimeout(() => {
                loadDepositReceipts();
              }, 500);

              // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
              depositForm.reset();

            } else {
              const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
              console.error('API Error Response:', errorData);
              throw new Error(errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ');
            }

          } catch (error) {
            console.error('Error creating deposit receipt:', error);

            if (window.posNotificationSystem) {
              window.posNotificationSystem.addNotification('pos', {
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                message: error.message,
                type: 'error'
              });
            }

          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ
    function createCreditNote(receiptId) {
      try {
        console.log('üèóÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö receiptId:', receiptId);

        const receipt = depositReceipts.find(r => r._id === receiptId);
        if (!receipt) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (receipt.status === 'cancelled') {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
          return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á confirmation dialog
        const confirmed = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${receipt.receiptNumber} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø${(receipt.amounts?.depositAmount || 0).toLocaleString()}`);

        if (!confirmed) {
          return;
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ CreditNoteSimple.html
        const creditNoteData = {
          originalReceiptId: receipt._id,
          originalReceiptNumber: receipt.receiptNumber,
          customer: {
            name: receipt.customer?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            phone: receipt.customer?.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            address: receipt.customer?.address?.fullAddress || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            taxId: receipt.customer?.taxId || ''
          },
          product: {
            name: receipt.product?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            brand: receipt.product?.brand || '',
            model: receipt.product?.model || ''
          },
          amounts: {
            originalAmount: receipt.amounts?.depositAmount || 0,
            creditAmount: receipt.amounts?.depositAmount || 0, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
            totalAmount: receipt.amounts?.totalAmount || 0
          },
          branchCode: receipt.branchCode || window.BRANCH_CODE || '00000',
          salesperson: {
            name: receipt.salesperson?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
          },
          reason: 'no_product_available', // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          createdDate: new Date().toISOString()
        };

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
        localStorage.setItem('creditNoteData', JSON.stringify(creditNoteData));

        // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ CreditNoteSimple.html
        const url = `/CreditNoteSimple?receiptId=${receiptId}&branchCode=${creditNoteData.branchCode}`;
        window.open(url, '_blank');

        console.log('‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

      } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ:', error);
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    async function viewDepositDetails(receiptId) {
      try {
        console.log('View deposit details:', receiptId);
        console.log('Available depositReceipts:', depositReceipts);
        console.log('Available window.depositReceipts:', window.depositReceipts);

        // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡∏≤‡∏Å array ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å window.depositReceipts ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ fallback ‡πÑ‡∏õ local variable
        const receiptsArray = window.depositReceipts || depositReceipts || [];
        const receipt = receiptsArray.find(r => r._id === receiptId || r.id === receiptId);

        if (!receipt) {
          console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ID:', receiptId);
          console.error('Available IDs from window:', window.depositReceipts?.map(r => r._id));
          console.error('Available IDs from local:', depositReceipts?.map(r => r._id));

          // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API
          console.log('üîÑ ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API...');
          const token = localStorage.getItem('authToken') || '';
          const response = await fetch(`/api/deposit-receipts/${receiptId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
            const data = await response.json();
            const apiReceipt = data.data || data;
            console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', apiReceipt);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô arrays
            if (window.depositReceipts) {
              window.depositReceipts.push(apiReceipt);
            }
            if (depositReceipts) {
              depositReceipts.push(apiReceipt);
            }

            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            return viewDepositDetailsWithReceipt(apiReceipt);
          } else {
            showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', 'error');
            return;
          }
        }

        viewDepositDetailsWithReceipt(receipt);
      } catch (error) {
        console.error('‚ùå Error in viewDepositDetails:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'error');
      }
    }

    // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
    function viewDepositDetailsWithReceipt(receipt) {
      try {

        // ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤ tracking object ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        ensureTrackingObject(receipt);

        console.log('Found receipt:', receipt);

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const formatDate = (dateString) => {
          if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          try {
            return new Date(dateString).toLocaleDateString('th-TH', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } catch (error) {
            return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          }
        };

        const formatDateTime = (dateString) => {
          if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          try {
            return new Date(dateString).toLocaleString('th-TH', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch (error) {
            return '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          }
        };

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        const detailHTML = `
          <div class="space-y-6">
            <!-- Header -->
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">${receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏£‡∏±‡∏ö'}</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">${formatDate(receipt.depositDate)}</p>
              </div>
              <span class="px-3 py-1 text-sm font-medium rounded-full ${getStatusClass(receipt.status)}">
                ${getStatusText(receipt.status)}
              </span>
            </div>

            <!-- Customer Info -->
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div><span class="font-medium">‡∏ä‡∏∑‡πà‡∏≠:</span> ${receipt.customer?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span> ${receipt.customer?.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div class="md:col-span-2"><span class="font-medium">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> ${receipt.customer?.address?.fullAddress || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                ${receipt.customer?.email ? `<div><span class="font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span> ${receipt.customer.email}</div>` : ''}
                ${receipt.customer?.taxId ? `<div><span class="font-medium">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:</span> ${receipt.customer.taxId}</div>` : ''}
                <div><span class="font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span> ${receipt.customer?.customerType === 'individual' ? '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤' : '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'}</div>
              </div>
            </div>

            <!-- Product Info -->
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="md:col-span-2"><span class="font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span> ${receipt.product?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</span> ${receipt.product?.brand || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏£‡∏∏‡πà‡∏ô:</span> ${receipt.product?.model || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤:</span> ‡∏ø${(receipt.product?.price || 0).toLocaleString()}</div>
                <div><span class="font-medium">‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span> ${receipt.product?.condition === 'new' ? '‡πÉ‡∏´‡∏°‡πà' : receipt.product?.condition === 'used' ? '‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                ${receipt.product?.imei ? `<div><span class="font-medium">IMEI:</span> ${receipt.product.imei}</div>` : ''}
                <div><span class="font-medium">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å:</span> ${receipt.product?.inStock ? '‡∏°‡∏µ' : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
              </div>
            </div>

            <!-- Amount Info -->
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div><span class="font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> ‡∏ø${(receipt.amounts?.totalAmount || 0).toLocaleString()}</div>
                <div><span class="font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:</span> ‡∏ø${(receipt.amounts?.depositAmount || 0).toLocaleString()}</div>
                <div><span class="font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á:</span> ‡∏ø${(receipt.amounts?.remainingAmount || 0).toLocaleString()}</div>
                <div><span class="font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</span> ${receipt.saleType === 'cash' ? '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î' : receipt.saleType === 'installment' ? '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:</span> ${
                  receipt.paymentMethod === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' :
                  receipt.paymentMethod === 'transfer' ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' :
                  receipt.paymentMethod === 'mixed' ? '‡∏ú‡∏™‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô)' :
                  '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                }</div>
                <div><span class="font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥:</span> ${receipt.depositTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              </div>
            </div>

            <!-- Other Info -->
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div><span class="font-medium">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:</span> ${receipt.salesperson?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏™‡∏≤‡∏Ç‡∏≤:</span> ${receipt.branch?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</span> ${receipt.company?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏±‡∏î‡∏à‡∏≥:</span> ${receipt.depositType === 'online' ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : receipt.depositType === 'preorder' ? '‡∏û‡∏£‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><span class="font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á:</span> ${formatDateTime(receipt.createdAt)}</div>
                <div><span class="font-medium">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</span> ${formatDateTime(receipt.expiryDate)}</div>
                ${receipt.notes ? `<div class="md:col-span-2"><span class="font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ${receipt.notes}</div>` : ''}
              </div>
            </div>

            <!-- Tracking Info -->
            ${receipt.tracking ? `
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
              <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h4>
              <div class="space-y-3">
                <!-- Stock Check Status - ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß -->
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-900 dark:text-white">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å:</span>
                    <span class="${receipt.tracking.stockChecked ? 'text-green-600' : 'text-gray-500'}">${receipt.tracking.stockChecked ? '‚úÖ ‡πÅ‡∏•‡πâ‡∏ß' : 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'}</span>
                    ${receipt.tracking.stockCheckDate ? `<span class="text-xs text-gray-500">(${formatDateTime(receipt.tracking.stockCheckDate)})</span>` : ''}
                  </div>
                  <div class="text-xs text-blue-600">
                    ü§ñ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                  </div>
                </div>

                <!-- Notification Status -->
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-900 dark:text-white">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</span>
                    <span class="${receipt.tracking.notificationSent ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.notificationSent ? '‚úÖ ‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'}</span>
                    ${receipt.tracking.notificationDate ? `<span class="text-xs text-gray-500">(${formatDateTime(receipt.tracking.notificationDate)})</span>` : ''}
                  </div>
                  <button onclick="sendNotification('${receipt.id || receipt.receiptNumber}')"
                          class="btn btn-sm px-3 py-1 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded-md transition-colors ${receipt.tracking.notificationSent ? 'opacity-50 cursor-not-allowed' : ''}"
                          ${receipt.tracking.notificationSent ? 'disabled' : ''}>
                    ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                  </button>
                </div>

                <!-- Customer Contact Status -->
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-900 dark:text-white">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
                    <span class="${receipt.tracking.customerContacted ? 'text-green-600' : 'text-red-600'}">${receipt.tracking.customerContacted ? '‚úÖ ‡πÅ‡∏•‡πâ‡∏ß' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'}</span>
                    ${receipt.tracking.contactDate ? `<span class="text-xs text-gray-500">(${formatDateTime(receipt.tracking.contactDate)})</span>` : ''}
                  </div>
                  <button onclick="markCustomerContacted('${receipt.id || receipt.receiptNumber}')"
                          class="btn btn-sm px-3 py-1 text-xs bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors ${receipt.tracking.customerContacted ? 'opacity-50 cursor-not-allowed' : ''}"
                          ${receipt.tracking.customerContacted ? 'disabled' : ''}>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                  </button>
                </div>

                <!-- Stock Validation Result Display -->
                ${receipt.tracking.stockValidationResult ? `
                <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div class="text-sm">
                    <span class="font-medium text-gray-900 dark:text-white">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                    <span class="${receipt.tracking.stockValidationResult.valid ? 'text-green-600' : 'text-red-600'} ml-2">
                      ${receipt.tracking.stockValidationResult.message}
                    </span>
                    ${receipt.tracking.stockValidationResult.warnings && receipt.tracking.stockValidationResult.warnings.length > 0 ? `
                      <div class="mt-1 text-xs text-yellow-600">
                        ‚ö†Ô∏è ${receipt.tracking.stockValidationResult.warnings.join(', ')}
                      </div>
                    ` : ''}
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}
          </div>
        `;

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô modal
        showDetailModal('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', detailHTML);

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° PDF ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà modal ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß
        setTimeout(() => {
          const pdfButton = document.getElementById('btnLoadPDF');
          if (pdfButton) {
            console.log('‚úÖ PDF button found in modal, attaching event listener');

            // Remove existing listeners to avoid duplicates
            pdfButton.replaceWith(pdfButton.cloneNode(true));
            const newPdfButton = document.getElementById('btnLoadPDF');

            newPdfButton.addEventListener('click', function(e) {
              e.preventDefault();
              console.log('üñ±Ô∏è PDF button clicked in modal!');
              loadDepositReceiptPDF();
            });
          } else {
            console.log('‚ùå PDF button not found in modal after timeout');
          }
        }, 100);

      } catch (error) {
        console.error('‚ùå Error viewing deposit details:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    function showDetailModal(title, content) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
      let modal = document.getElementById('depositDetailModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'depositDetailModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        modal.innerHTML = `
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
              <h2 id="modalTitle" class="text-xl font-semibold text-gray-900 dark:text-white"></h2>
              <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <i class="bi bi-x-lg text-xl"></i>
              </button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å modal
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeDetailModal();
          }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ESC key
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeDetailModal();
            document.removeEventListener('keydown', escHandler);
          }
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalContent').innerHTML = content;

      // ‡πÅ‡∏™‡∏î‡∏á modal
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î modal
    function closeDetailModal() {
      const modal = document.getElementById('depositDetailModal');
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    // Helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    function getStatusClass(status) {
      const statusClasses = {
        'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'confirmed': 'bg-blue-100 text-blue-800 border-blue-200',
        'completed': 'bg-green-100 text-green-800 border-green-200',
        'cancelled': 'bg-red-100 text-red-800 border-red-200',
        'credited': 'bg-purple-100 text-purple-800 border-purple-200'
      };
      return statusClasses[status] || 'bg-gray-100 text-gray-800 border-gray-200';
    }

    function getStatusText(status) {
      const statusText = {
        'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        'credited': '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'
      };
      return statusText[status] || status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô navigateToSale - ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î/‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
    async function navigateToSale(receiptId, saleType) {
      try {
        console.log('üîÑ Navigating to sale:', { receiptId, saleType });

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
        const response = await fetch(`/api/deposit-receipts/${receiptId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ');
        }

        const result = await response.json();
        const depositReceipt = result.data;

        console.log('üì¶ Deposit receipt data for navigation:', depositReceipt);

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
        const navigationData = {
          depositReceiptId: depositReceipt._id,
          receiptNumber: depositReceipt.receiptNumber,
          customer: {
            name: depositReceipt.customer?.name,
            prefix: depositReceipt.customer?.prefix,
            firstName: depositReceipt.customer?.firstName,
            lastName: depositReceipt.customer?.lastName,
            phone: depositReceipt.customer?.phone,
            birthDate: depositReceipt.customer?.birthDate,
            taxId: depositReceipt.customer?.taxId,
            address: depositReceipt.customer?.address,
            houseNo: depositReceipt.customer?.houseNo,
            moo: depositReceipt.customer?.moo,
            subDistrict: depositReceipt.customer?.subDistrict,
            district: depositReceipt.customer?.district,
            province: depositReceipt.customer?.province,
            zipcode: depositReceipt.customer?.zipcode
          },
          product: {
            _id: depositReceipt.product?._id || depositReceipt.product?.id,
            name: depositReceipt.product?.name,
            price: depositReceipt.product?.price,
            imei: depositReceipt.product?.imei,
            model: depositReceipt.product?.model,
            brand: depositReceipt.product?.brand,
            category: depositReceipt.product?.category
          },
          amounts: {
            depositAmount: depositReceipt.amounts?.depositAmount || 0,
            totalAmount: depositReceipt.amounts?.totalAmount || 0,
            remainingAmount: (depositReceipt.amounts?.totalAmount || 0) - (depositReceipt.amounts?.depositAmount || 0)
          },
          saleType: saleType,
          branch: depositReceipt.branch || { code: 'pattani' },
          hasStockReservation: depositReceipt.hasStockReservation || false,
          stockReservation: depositReceipt.stockReservation || null
        };

        console.log('üöÄ Navigation data prepared:', navigationData);

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô sessionStorage
        sessionStorage.setItem('depositNavigationData', JSON.stringify(navigationData));

        // ‡πÄ‡∏ã‡πá‡∏ï flag ‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å DepositReceipt
        sessionStorage.setItem('checkoutSource', 'deposit');

        // ‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        let targetUrl;
        if (saleType === 'cash') {
          targetUrl = '/views/pattani/frontstore_pattani.html';
          console.log('üí≥ Navigating to cash sale page (‡∏Ç‡∏≤‡∏¢‡∏™‡∏î) - ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á');
        } else if (saleType === 'installment') {
          targetUrl = '/views/pattani/installment/step2/step2.html';
          console.log('üìÖ Navigating to installment page (‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô)');
        } else {
          throw new Error('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        // ‡πÅ‡∏™‡∏î‡∏á notification ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ
        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ç‡∏≤‡∏¢...',
            message: `‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${depositReceipt.receiptNumber} -> ${saleType === 'cash' ? '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î' : '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô'}`,
            type: 'info'
          });
        }

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
        setTimeout(() => {
          window.location.href = targetUrl;
        }, 500);

      } catch (error) {
        console.error('‚ùå Error navigating to sale:', error);

        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
            message: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
            type: 'error'
          });
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô card button)
    function convertToSale(receiptId) {
      // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
      const modalHtml = `
        <div id="saleTypeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <div class="space-y-3">
              <button onclick="navigateToSale('${receiptId}', 'cash'); closeSaleTypeModal()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                <i class="bi bi-cash-coin"></i>
                ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
              </button>
              <button onclick="navigateToSale('${receiptId}', 'installment'); closeSaleTypeModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                <i class="bi bi-calendar-month"></i>
                ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
              </button>
              <button onclick="closeSaleTypeModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function closeSaleTypeModal() {
      const modal = document.getElementById('saleTypeModal');
      if (modal) {
        modal.remove();
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡πÉ‡∏ä‡πâ localStorage ‡πÅ‡∏ó‡∏ô API)
    async function loadDepositDocument(receiptId) {
      try {
        console.log('üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥:', receiptId);

        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage ‡πÅ‡∏ó‡∏ô API
        const receipt = depositReceipts.find(r => r._id === receiptId);

        if (!receipt) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
        }

        console.log('‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', receipt.receiptNumber);

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF
        currentReceiptForPDF = receipt;

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô PDF ‡πÉ‡∏´‡∏°‡πà
        loadDepositReceiptPDF();

        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${receipt.receiptNumber} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß`,
            type: 'success'
          });
        }

      } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:', error);

        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ: ${error.message}`,
            type: 'error'
          });
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ï‡∏≤‡∏° Flow ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
    async function createQuotationAndReceipts(depositData) {
      const token = localStorage.getItem('authToken');
      console.log('üîê Tax Invoice API - Token check:', {
        hasToken: !!token,
        tokenLength: token ? token.length : 0,
        tokenType: typeof token
      });

      if (!token) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      }

      // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
      console.log('üîç [DEBUG] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô createQuotationAndReceipts:', {
        depositData: depositData,
        hasAmounts: !!depositData.amounts,
        depositAmount: depositData.amounts?.depositAmount,
        amountsKeys: depositData.amounts ? Object.keys(depositData.amounts) : 'no amounts'
      });

      // Input validation
      if (!depositData || !depositData._id) {
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
      if (!depositData.customer || !depositData.customer.name) {
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
      if (!depositData.product || !depositData.product.name) {
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á number ‡πÅ‡∏•‡∏∞ string
      const depositAmount = depositData.amounts?.depositAmount;
      const parsedDepositAmount = typeof depositAmount === 'string' ? parseFloat(depositAmount) : depositAmount;

      if (!depositData.amounts || !depositAmount || isNaN(parsedDepositAmount) || parsedDepositAmount <= 0) {
        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:', {
          amounts: depositData.amounts,
          depositAmount: depositAmount,
          parsedDepositAmount: parsedDepositAmount,
          type: typeof depositAmount
        });
        throw new Error('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }

      console.log('üìÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏° Flow:', {
        step1: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏¢‡∏≠‡∏î‡∏Å‡πâ‡∏≠‡∏ô + ‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)',
        step2: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥)',
        depositData: depositData
      });

      // Debug product data for Tax Invoice
      console.log('üîç [TAX INVOICE DEBUG] Product data:', {
        'depositData.product': depositData.product,
        'depositData.product.id': depositData.product?.id,
        'depositData.product._id': depositData.product?._id,
        'window.selectedProductData': window.selectedProductData
      });

      // Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏¢‡∏≠‡∏î‡∏Å‡πâ‡∏≠‡∏ô + ‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const quotationData = {
        date: new Date().toISOString(),
        branchCode: depositData.branchCode || window.BRANCH_CODE || '00000',
        salesperson: depositData.salesperson?.id || null,
        salespersonName: depositData.salesperson?.name || '',
        customer: {
          name: depositData.customer.name || depositData.customer.firstName + ' ' + (depositData.customer.lastName || ''),
          address: depositData.customer.address?.fullAddress || depositData.customer.address || '',
          phone: depositData.customer.phone || '',
          taxId: depositData.customer.taxId || '',
          individual: {
            prefix: depositData.customer.prefix,
            firstName: depositData.customer.firstName,
            lastName: depositData.customer.lastName,
            phone: depositData.customer.phone,
            taxId: depositData.customer.taxId,
            address: depositData.customer.address?.fullAddress || depositData.customer.address
          }
        },
        items: [{
          description: depositData.product.name || '',
          name: depositData.product.name,
          brand: depositData.product.brand,
          model: depositData.product.model,
          imei: depositData.product.imei,
          quantity: 1,
          unitPrice: depositData.amounts.totalAmount,
          discount: 0,
          totalPrice: depositData.amounts.totalAmount,
          downAmount: depositData.amounts.depositAmount,
          termCount: depositData.saleType === 'installment' ? 12 : 0,
          installmentAmount: depositData.saleType === 'installment' ? Math.round((depositData.amounts.totalAmount - depositData.amounts.depositAmount) / 12) : 0
        }],
        summary: {
          subtotal: depositData.amounts.totalAmount,
          beforeTax: depositData.amounts.totalAmount,
          tax: depositData.amounts.vatAmount || 0,
          netTotal: depositData.amounts.totalAmount
        },
        planType: depositData.saleType === 'installment' ? 'installment' : 'full_payment',
        downPayment: depositData.amounts.depositAmount,
        installmentCount: depositData.saleType === 'installment' ? 12 : 0,
        installmentAmount: depositData.saleType === 'installment' ? Math.round((depositData.amounts.totalAmount - depositData.amounts.depositAmount) / 12) : 0,
        docFee: depositData.amounts.docFee || 0,
        pickupMethod: 'store',
        shippingFee: depositData.amounts.shippingFee || 0,
        currency: 'THB',
        creditTerm: '30 ‡∏ß‡∏±‡∏ô',
        vatInclusive: true
      };

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
      console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:', quotationData);
      const quotationResponse = await fetch('/api/quotation', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(quotationData)
      });

      console.log('üì• Quotation API response status:', quotationResponse.status, quotationResponse.statusText);

      if (!quotationResponse.ok) {
        const errorText = await quotationResponse.text();
        console.error('‚ùå Quotation API Error Response:', errorText);

        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { error: errorText };
        }

        console.error('‚ùå Quotation API Error:', {
          status: quotationResponse.status,
          statusText: quotationResponse.statusText,
          errorData,
          hasToken: !!token,
          tokenLength: token ? token.length : 0
        });

        throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ: ${errorData.error || errorData.message || quotationResponse.statusText}`);
      }

      const quotationResult = await quotationResponse.json();
      console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', quotationResult.data?.quotationNumber || quotationResult.data?.number || 'Unknown number');

      // Step 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥)
      const taxInvoiceData = {
        customer: {
          name: depositData.customer.name || depositData.customer.firstName + ' ' + (depositData.customer.lastName || ''),
          fullName: depositData.customer.name || depositData.customer.firstName + ' ' + (depositData.customer.lastName || ''),
          prefix: depositData.customer.prefix,
          first_name: depositData.customer.firstName,
          last_name: depositData.customer.lastName,
          taxId: depositData.customer.taxId,
          phone: depositData.customer.phone,
          email: depositData.customer.email,
          address: depositData.customer.address?.fullAddress || depositData.customer.address
        },
        items: [{
          product: depositData.product.id || depositData.product._id || window.selectedProductData?.id || window.selectedProductData?._id || 'unknown',
          name: depositData.product.name,
          brand: depositData.product.brand,
          imei: depositData.product.imei,
          model: depositData.product.model,
          quantity: 1,
          unitPrice: depositData.amounts.depositAmount,
          totalPrice: depositData.amounts.depositAmount,
          description: `‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${depositData.product.name}`,
          taxType: 'inclusive'
        }],
        quotationNumber: quotationResult.data?.quotationNumber || quotationResult.data?.number,
        downPaymentAmount: depositData.amounts.depositAmount,
        paymentMethod: depositData.paymentMethod,
        branchCode: depositData.branchCode || window.BRANCH_CODE,
        employeeName: depositData.salesperson?.name,
        notes: `‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${depositData.contractNumber || ''}`
      };

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
      console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ:', taxInvoiceData);
      const taxInvoiceResponse = await fetch('/api/taxinvoice/create', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(taxInvoiceData)
      });

      console.log('üì• Tax Invoice API response status:', taxInvoiceResponse.status, taxInvoiceResponse.statusText);

      if (!taxInvoiceResponse.ok) {
        const errorText = await taxInvoiceResponse.text();
        console.error('‚ùå Tax Invoice API Error Response:', errorText);

        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { error: errorText };
        }

        console.error('‚ùå Tax Invoice API Error:', {
          status: taxInvoiceResponse.status,
          statusText: taxInvoiceResponse.statusText,
          errorData
        });

        throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ: ${errorData.error || errorData.message || taxInvoiceResponse.statusText}`);
      }

      const taxInvoiceResult = await taxInvoiceResponse.json();
      console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', {
        invoiceNumber: taxInvoiceResult.data.invoiceNumber
      });

      // ‡πÅ‡∏™‡∏î‡∏á notification ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á 2 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ + ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
          message: `‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${quotationResult.data.quotationNumber || quotationResult.data.number}\n‚úÖ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ${taxInvoiceResult.data.invoiceNumber}`,
          type: 'success',
          duration: 8000
        });
      }

      return {
        quotation: quotationResult.data,
        taxInvoice: taxInvoiceResult.data
      };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ frontstore_pattani.html ‡∏´‡∏£‡∏∑‡∏≠ installment/step4/step4.html)
    async function createDeliveryNote(deliveryData) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
      }

      console.log('üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á:', deliveryData);

      const deliveryNoteData = {
        branchCode: deliveryData.branchCode || window.BRANCH_CODE || '00000',
        branchName: deliveryData.branchName || '‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
        customer: {
          name: deliveryData.customer.name || deliveryData.customer.firstName + ' ' + (deliveryData.customer.lastName || ''),
          address: deliveryData.customer.address?.fullAddress || deliveryData.customer.address || '',
          taxId: deliveryData.customer.taxId,
          phone: deliveryData.customer.phone,
          email: deliveryData.customer.email
        },
        delivery: {
          address: deliveryData.deliveryAddress || deliveryData.customer.address?.fullAddress || deliveryData.customer.address || '',
          contactPerson: deliveryData.receiverName || deliveryData.customer.name || deliveryData.customer.firstName,
          contactPhone: deliveryData.receiverPhone || deliveryData.customer.phone,
          deliveryDate: new Date(),
          deliveryTime: new Date().toLocaleTimeString('th-TH'),
          specialInstructions: deliveryData.specialInstructions || ''
        },
        items: [{
          productId: deliveryData.product?._id,
          name: deliveryData.product?.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
          brand: deliveryData.product?.brand,
          model: deliveryData.product?.model,
          imei: deliveryData.product?.imei,
          serialNumber: deliveryData.product?.serialNumber,
          quantity: 1,
          unitPrice: deliveryData.amounts?.totalAmount || 0,
          totalPrice: deliveryData.amounts?.totalAmount || 0,
          description: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${deliveryData.receiptNumber || ''}`
        }],
        relatedDocuments: {
          depositReceiptId: deliveryData.depositReceiptId,
          quotationId: deliveryData.quotationId,
          invoiceId: deliveryData.receiptId
        },
        summary: {
          subtotal: deliveryData.amounts?.totalAmount || 0,
          taxAmount: deliveryData.amounts?.taxAmount || 0,
          totalAmount: deliveryData.amounts?.totalAmount || 0,
          depositApplied: deliveryData.amounts?.depositAmount || 0
        },
        sourceType: 'deposit_receipt',
        createdBy: deliveryData.salesperson?.name || 'Admin'
      };

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á
      const deliveryResponse = await fetch('/api/delivery-notes', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(deliveryNoteData)
      });

      if (!deliveryResponse.ok) {
        const errorData = await deliveryResponse.json().catch(() => ({ error: 'Unknown error' }));
        console.error('‚ùå Delivery Note API Error:', errorData);
        throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${errorData.error || errorData.message || deliveryResponse.statusText}`);
      }

      const deliveryResult = await deliveryResponse.json();
      console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', deliveryResult.data.deliveryNumber);

      // ‡πÅ‡∏™‡∏î‡∏á notification
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          message: `‚úÖ ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á ${deliveryResult.data.deliveryNumber} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${deliveryData.customer.name}`,
          type: 'success',
          duration: 5000
        });
      }

      return deliveryResult.data;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏π‡∏ó‡∏¥‡∏•‡∏¥‡∏ï‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏±‡∏î‡∏à‡∏≥
    window.prepareDeliveryDataFromDeposit = async function(depositReceiptId, saleType) {
      try {
        const token = localStorage.getItem('authToken');

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡πÉ‡∏ä‡πâ API ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        const response = await fetch(`/api/deposit-receipts/${depositReceiptId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ');
        }

        const depositData = await response.json();
        const deposit = depositData.data || depositData;

        return {
          depositReceiptId: deposit._id,
          customer: deposit.customer,
          product: deposit.product,
          amounts: deposit.amounts,
          saleType: saleType,
          salesperson: deposit.salesperson,
          branchCode: deposit.branchCode,
          references: {
            depositReceiptNumber: deposit.receiptNumber
          }
        };
      } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á:', error);
        throw error;
      }
    };

    // ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á global scope ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    window.createDeliveryNote = createDeliveryNote;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥
    async function deleteDeposit(receiptId) {
      try {
        // ‡πÅ‡∏™‡∏î‡∏á confirmation dialog
        const confirmed = confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ');
        if (!confirmed) {
          return;
        }

        console.log('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥:', receiptId);

        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
        }

        const response = await fetch(`/api/deposit-receipts/${receiptId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ: ${response.status}`);
        }

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
        await loadDepositReceipts();

        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
            type: 'success'
          });
        }

      } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥:', error);

        if (window.posNotificationSystem) {
          window.posNotificationSystem.addNotification('pos', {
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ: ${error.message}`,
            type: 'error'
          });
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    function markAllAsRead(type) {
      console.log(`üìã ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${type}`);
      if (window.posNotificationSystem) {
        window.posNotificationSystem.markAllAsRead(type);
      }
    }

    function clearAllNotifications(type) {
      console.log(`üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${type}`);
      if (window.posNotificationSystem) {
        window.posNotificationSystem.clearAll(type);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function navigateToSale(receiptId, saleType) {
      console.log(`üõí ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ${saleType} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö ${receiptId}`);

      const baseUrl = saleType === 'cash'
        ? '/views/pattani/frontstore_pattani.html'
        : '/views/pattani/installment/step2/step2.html';

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
      localStorage.setItem('depositReceiptId', receiptId);
      localStorage.setItem('saleType', saleType);

      // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
      window.location.href = `${baseUrl}?depositId=${receiptId}&saleType=${saleType}`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login
    async function loadSalespersonDataFromLogin() {
      try {
        const salespersonSelect = document.getElementById('salespersonSelect');

        if (salespersonSelect) {
          // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login
          const currentUserId = localStorage.getItem('userId');
          const currentUserName = localStorage.getItem('userName');
          const currentUserRole = localStorage.getItem('userRole') || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
          const currentBranchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE;

          console.log('üë• [loadSalespersonData] ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login:');
          console.log('üë• User ID:', currentUserId, typeof currentUserId);
          console.log('üë• User Name:', currentUserName, typeof currentUserName);
          console.log('üë• User Role:', currentUserRole, typeof currentUserRole);
          console.log('üë• Branch Code:', currentBranchCode, typeof currentBranchCode);

          // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ options
          salespersonSelect.innerHTML = '';

          if (currentUserName && currentUserId) {
            const option = document.createElement('option');
            option.value = currentUserId;
            option.textContent = `${currentUserName} (${currentUserRole})`;
            option.selected = true;
            salespersonSelect.appendChild(option);

            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login
            salespersonSelect.disabled = true;

            console.log(`‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login: ${currentUserName}`);
          } else {
            // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '';
            salespersonSelect.appendChild(option);

            console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ login - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
          }
        }
      } catch (error) {
        console.error('‚ùå Error loading salesperson data:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏Å‡πà‡∏≤ - ‡∏™‡∏≥‡∏£‡∏≠‡∏á)
    async function loadSalespersonData() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const branchCode = window.BRANCH_CODE || '00000';

        console.log('üë• [loadSalespersonData] Using branch code:', branchCode);
        console.log('üë• [loadSalespersonData] window.BRANCH_CODE:', window.BRANCH_CODE);

        const response = await fetch(`/api/users?branch=${branchCode}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('üìã User data received:', data);

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const users = Array.isArray(data) ? data : (data.users || data.data || []);

          const salespersonSelect = document.getElementById('salespersonSelect');

          if (salespersonSelect && Array.isArray(users)) {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå options ‡πÄ‡∏î‡∏¥‡∏°
            salespersonSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢...</option>';

            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
            const salespeople = users.filter(user =>
              user.role === 'salesperson' ||
              user.role === 'sales' ||
              user.role === 'staff' ||
              user.department === 'sales'
            );

            salespeople.forEach(person => {
              const option = document.createElement('option');
              option.value = person.id || person._id;
              option.textContent = `${person.name || person.username} (${person.role || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'})`;

              // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
              if (person.email) {
                option.dataset.email = person.email;
              }
              if (person.phone) {
                option.dataset.phone = person.phone;
              }

              salespersonSelect.appendChild(option);
            });


            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentUserId = localStorage.getItem('userId');
            const currentUserName = localStorage.getItem('userName');

            if (currentUserId) {
              salespersonSelect.value = currentUserId;

              // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
              if (salespersonSelect.value === '' && currentUserName) {
                for (let option of salespersonSelect.options) {
                  if (option.textContent.includes(currentUserName)) {
                    salespersonSelect.value = option.value;
                    break;
                  }
                }
              }
            }

            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢: ${salespeople.length} ‡∏Ñ‡∏ô`);
          } else {
            console.warn('‚ö†Ô∏è No valid user data found or salespersonSelect not found');
          }
        } else {
          console.error('‚ùå Failed to load user data:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('‚ùå Error loading salesperson data:', error);
      }
    }

    // Old sync functions removed - now using separate loadOnlineDepositProducts() and loadPreOrderProducts()

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
    async function loadProductData() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

        console.log('üì¶ [loadProductData] Using branch code:', branchCode);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
        const selectedDepositType = document.querySelector('input[name="depositType"]:checked')?.value || 'online';

        if (selectedDepositType === 'online') {
          // ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å branchStockRoutes.js
          console.log('üè™ Loading ONLINE DEPOSIT products from branchStockRoutes.js');
          await loadOnlineDepositProducts();
        } else if (selectedDepositType === 'preorder') {
          // Pre-order - ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å productImageRoutes.js
          console.log('üìù Loading PRE-ORDER products from productImageRoutes.js');
          await loadPreOrderProducts();
        }

      } catch (error) {
        console.error('‚ùå Error loading product data:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)
    async function loadOnlineDepositProducts() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

        console.log('üè™ [loadOnlineDepositProducts] Loading from /api/branch-stock ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤:', branchCode);

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏≤‡∏Å branchStockRoutes.js
        const response = await fetch(`/api/branch-stock?branch_code=${branchCode}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`Failed to load branch stock: ${response.status}`);
        }

        const data = await response.json();
        const stockProducts = data.data || data;

        console.log('üì¶ Branch stock products loaded:', stockProducts.length);
        console.log('üì¶ Products branch codes:', [...new Set(stockProducts.map(p => p.branch_code))].join(', '));

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô global variable
        window.onlineDepositProducts = stockProducts;

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        await populateOnlineDepositProducts(stockProducts);

        // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        setTimeout(() => updateProductDropdownPrices(), 100);

      } catch (error) {
        console.error('‚ùå Error loading online deposit products:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)
    async function loadPreOrderProducts() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

        console.log('üìù [loadPreOrderProducts] Loading from /api/product-image/not-in-stock');

        // ‡πÉ‡∏ä‡πâ API ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
        const response = await fetch(`/api/product-image/not-in-stock?branchCode=${branchCode}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`Failed to load pre-order products: ${response.status}`);
        }

        const result = await response.json();
        const preorderProducts = result.data || [];

        console.log('üìù Pre-order products (not in stock):', preorderProducts.length);
        console.log('üìù API message:', result.message);

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pre-order ‡πÄ‡∏õ‡πá‡∏ô global variable
        window.preorderProducts = preorderProducts;

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        await populatePreOrderProducts(preorderProducts);

        // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        setTimeout(() => updateProductDropdownPrices(), 100);

      } catch (error) {
        console.error('‚ùå Error loading pre-order products:', error);
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)
    async function populateOnlineDepositProducts(stockProducts) {
      try {
        const productSelect = document.getElementById('productDropdownSelect');
        const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

        if (productSelect && Array.isArray(stockProducts)) {
          productSelect.innerHTML = '<option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)...</option>';

          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢
          const availableProducts = stockProducts.filter(item => {
            const hasQuantity = (item.stock_value || 0) > 0;
            const isVerified = item.verified === true; // API ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ verified=true ‡πÅ‡∏•‡πâ‡∏ß
            const isPendingFalse = item.pending === false; // pending=false = ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            const isMobile = (item.productType === 'mobile') ||
                           (item.category_name && item.category_name.toLowerCase().includes('mobile'));
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)
            const isCurrentBranch = item.branch_code === branchCode;

            if (!hasQuantity || !isVerified || !isPendingFalse || !isMobile || !isCurrentBranch) {
              console.log(`üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å: ${item.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'} | ‡∏™‡∏≤‡∏Ç‡∏≤: ${item.branch_code} (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ${branchCode}) | stock_value: ${item.stock_value || 0} | pending: ${item.pending} | ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: ${item.verified} | ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${item.productType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`);
            }

            return hasQuantity && isVerified && isPendingFalse && isMobile && isCurrentBranch;
          });

          console.log(`‚úÖ ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${availableProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${stockProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`);

          // ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
          const groupedProducts = {};

          availableProducts.forEach(item => {
            const productName = item.name || item.product_id?.name || '';
            const brand = item.brand || '';
            const model = item.model || '';
            const displayName = `${productName} ${brand} ${model}`.trim();

            if (!groupedProducts[displayName]) {
              groupedProducts[displayName] = {
                name: productName,
                brand: brand,
                model: model,
                displayName: displayName,
                totalQuantity: 0,
                items: [],
                price: item.price || 0,
                pricePayOff: item.pricePayOff || item.price || 0,
                downAmount: item.downAmount || 0,
                downInstallmentCount: item.downInstallmentCount || 12,
                downInstallment: item.downInstallment || 0,
                creditThreshold: item.creditThreshold || 0,
                payUseInstallmentCount: item.payUseInstallmentCount || 0,
                payUseInstallment: item.payUseInstallment || 0,
                docFee: item.docFee || 0,
                purchaseType: item.purchaseType || ['cash', 'installment']
              };
            }

            groupedProducts[displayName].totalQuantity += (item.stock_value || 0);
            groupedProducts[displayName].items.push(item);
          });

          // ‡πÄ‡∏Å‡πá‡∏ö groupedProducts ‡πÄ‡∏õ‡πá‡∏ô global variable
          currentGroupedProducts = groupedProducts;

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß
          Object.values(groupedProducts).forEach(group => {
            const firstItem = group.items[0];
            if (!firstItem) return; // ‡∏Ç‡πâ‡∏≤‡∏° group ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ items

            const option = document.createElement('option');
            // ‡πÉ‡∏ä‡πâ _id ‡∏à‡∏≤‡∏Å BranchStock record
            const productId = firstItem._id || firstItem.id;
            option.value = productId;
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            const currentSaleType = getSelectedSaleType();
            const displayPrice = currentSaleType === 'cash' ? group.price : (group.pricePayOff || group.price);

            let optionText = '';
            if (currentSaleType === 'cash') {
              optionText = `${group.displayName} - ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î ‡∏ø${displayPrice.toLocaleString()} (${group.totalQuantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
            } else {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô: ‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô)
              const downAmount = group.downAmount || 0;
              const downInstallment = group.downInstallment || 0;
              const downInstallmentCount = group.downInstallmentCount || 12;
              const installmentInfo = `‡∏î‡∏≤‡∏ß‡∏ô‡πå ‡∏ø${downAmount.toLocaleString()} (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏ø${downInstallment.toLocaleString()}/${downInstallmentCount}‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ ‡∏ø${downInstallment.toLocaleString()})`;
              optionText = `${group.displayName} - ${installmentInfo} (${group.totalQuantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
            }

            option.textContent = optionText;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° data attributes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
            option.dataset.price = group.price;           // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
            option.dataset.pricePayOff = group.pricePayOff || group.price; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
            option.dataset.quantity = group.totalQuantity;
            option.dataset.name = group.name;
            option.dataset.brand = group.brand;
            option.dataset.model = group.model;
            option.dataset.productType = 'online';    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            option.dataset.branchCode = branchCode;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
            option.dataset.downAmount = group.downAmount;
            option.dataset.downInstallment = group.downInstallment;
            option.dataset.downInstallmentCount = group.downInstallmentCount;

            console.log('üîç Created option with productId:', productId, 'for:', group.name);

            productSelect.appendChild(option);
          });

          console.log(`üì¶ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å (${branchCode}): ${availableProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${stockProducts.length})`);
          console.log(`üì± ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: productType='mobile' ‡∏´‡∏£‡∏∑‡∏≠ category_name ‡∏°‡∏µ 'mobile'`);
          console.log(`üîó ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥: ${Object.keys(groupedProducts).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${availableProducts.length})`);

          // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß
          if (Object.keys(groupedProducts).length > 0) {
            const firstGroup = Object.values(groupedProducts)[0];
            console.log('üîç ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß:', {
              displayName: firstGroup.displayName,
              totalQuantity: firstGroup.totalQuantity,
              itemCount: firstGroup.items.length,
              price: firstGroup.price,
              purchaseType: firstGroup.purchaseType
            });
          }
        }
      } catch (error) {
        console.error('‚ùå Error populating online deposit products:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function updateProductDropdownPrices() {
      const productSelect = document.getElementById('productDropdownSelect');
      if (!productSelect || !currentGroupedProducts) return;

      const currentSaleType = getSelectedSaleType();
      console.log('üîÑ Updating dropdown prices for sale type:', currentSaleType);

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏∏‡∏Å option ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô option ‡πÅ‡∏£‡∏Å (placeholder)
      Array.from(productSelect.options).slice(1).forEach(option => {
        const cashPrice = parseFloat(option.dataset.price) || 0;
        const installmentPrice = parseFloat(option.dataset.pricePayOff) || cashPrice;
        const quantity = option.dataset.quantity || 0;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
        const downAmount = parseFloat(option.dataset.downAmount) || 0;
        const downInstallment = parseFloat(option.dataset.downInstallment) || 0;
        const downInstallmentCount = parseInt(option.dataset.downInstallmentCount) || 12;

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        const displayPrice = currentSaleType === 'cash' ? cashPrice : installmentPrice;

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô option
        const productName = option.dataset.name || '';
        const brand = option.dataset.brand || '';
        const model = option.dataset.model || '';
        const productType = option.dataset.productType || '';
        const displayName = `${productName} ${brand} ${model}`.trim();

        let optionText = '';

        if (currentSaleType === 'cash') {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
          const saleTypeText = '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';
          if (productType === 'preorder') {
            optionText = `${displayName} (Pre-order - ${saleTypeText} ‡∏ø${displayPrice.toLocaleString()})`;
          } else {
            optionText = `${displayName} - ${saleTypeText} ‡∏ø${displayPrice.toLocaleString()} (${quantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
          }
        } else {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô: ‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô)
          const installmentInfo = `‡∏î‡∏≤‡∏ß‡∏ô‡πå ‡∏ø${downAmount.toLocaleString()} (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏ø${downInstallment.toLocaleString()}/${downInstallmentCount}‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ ‡∏ø${downInstallment.toLocaleString()})`;

          if (productType === 'preorder') {
            optionText = `${displayName} (Pre-order - ${installmentInfo})`;
          } else {
            optionText = `${displayName} - ${installmentInfo} (${quantity} ‡∏ä‡∏¥‡πâ‡∏ô)`;
          }
        }

        option.textContent = optionText;
      });

      console.log(`‚úÖ Updated ${productSelect.options.length - 1} product options for ${currentSaleType} sale type`);
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pre-order (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å) - ‡πÉ‡∏ä‡πâ productImageRoutes.js
    async function populatePreOrderProducts(preorderProducts) {
      try {
        const productSelect = document.getElementById('productDropdownSelect'); // ‡πÉ‡∏ä‡πâ dropdown ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

        if (productSelect && Array.isArray(preorderProducts)) {
          productSelect.innerHTML = '<option value="">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order...</option>';

          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤)
          const mobileProducts = preorderProducts.filter(item => {
            const isMobile = (item.productType === 'mobile') ||
                           (item.category_name && item.category_name.toLowerCase().includes('mobile'));
            return isMobile;
          });

          console.log(`üì± ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ Pre-order: ${mobileProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${preorderProducts.length})`);

          mobileProducts.forEach(item => {
            const option = document.createElement('option');
            option.value = item._id;

            const productName = item.name || '';
            const brand = item.brand || '';
            const displayName = productName; // Pre-order ‡∏à‡∏≤‡∏Å ProductImage ‡πÑ‡∏°‡πà‡∏°‡∏µ model ‡πÅ‡∏¢‡∏Å

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order
            const currentSaleType = getSelectedSaleType();
            const cashPrice = item.price || 0;
            const installmentPrice = item.pricePayOff || cashPrice;

            let optionText = '';
            if (currentSaleType === 'cash') {
              const displayPrice = cashPrice;
              optionText = `${displayName} (Pre-order - ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î ‡∏ø${displayPrice.toLocaleString()})`;
            } else {
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô: ‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô)
              const downAmount = item.downAmount || 0;
              const downInstallment = item.downInstallment || 0;
              const downInstallmentCount = item.downInstallmentCount || 12;
              const installmentInfo = `‡∏î‡∏≤‡∏ß‡∏ô‡πå ‡∏ø${downAmount.toLocaleString()} (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡∏ø${downInstallment.toLocaleString()}/${downInstallmentCount}‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ ‡∏ø${downInstallment.toLocaleString()})`;
              optionText = `${displayName} (Pre-order - ${installmentInfo})`;
            }

            option.textContent = optionText;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order products ‡∏à‡∏≤‡∏Å ProductImage API
            option.dataset.price = cashPrice;                    // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
            option.dataset.pricePayOff = installmentPrice;       // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
            option.dataset.name = productName;
            option.dataset.brand = brand;
            option.dataset.productType = 'preorder';
            option.dataset.branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order
            option.dataset.downAmount = item.downAmount || 0;
            option.dataset.downInstallmentCount = item.downInstallmentCount || 12;
            option.dataset.downInstallment = item.downInstallment || 0;
            option.dataset.creditThreshold = item.creditThreshold || 0;
            option.dataset.payUseInstallmentCount = item.payUseInstallmentCount || 0;
            option.dataset.payUseInstallment = item.payUseInstallment || 0;
            option.dataset.docFee = item.docFee || 0;
            option.dataset.pricePayOff = item.pricePayOff || item.price || 0;

            productSelect.appendChild(option);
          });

          console.log(`üì¶ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pre-order: ${mobileProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        }
      } catch (error) {
        console.error('‚ùå Error populating preorder products:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á options ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÉ‡∏´‡∏°‡πà - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync)
    // Function removed - now using separate loadOnlineDepositProducts() and loadPreOrderProducts()

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function getSelectedSaleType() {
      const cashRadio = document.getElementById('saleTypeCashRadio');
      const installmentRadio = document.getElementById('saleTypeInstallmentRadio');

      if (cashRadio && cashRadio.checked) {
        return 'cash';
      } else if (installmentRadio && installmentRadio.checked) {
        return 'installment';
      }
      return 'installment'; // default
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡∏à‡∏≤‡∏Å productImageRoutes.js
    async function loadCashSaleProducts(productSelect) {
      try {
        const token = localStorage.getItem('authToken') || '';

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API /api/product-image/pricing/cash ‡∏à‡∏≤‡∏Å productImageRoutes.js
        const response = await fetch('/api/product-image/pricing/cash', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          const cashProducts = data.data || [];
          console.log('üíµ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡∏à‡∏≤‡∏Å ProductImage:', cashProducts);

          // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
          const mobileProducts = cashProducts.filter(item => {
            return (item.productType === 'mobile') ||
                   (item.category_name && item.category_name.toLowerCase().includes('mobile'));
          });

          // ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          const groupedCashProducts = {};
          mobileProducts.forEach(item => {
            const displayName = `${item.name} ${item.brand || ''} ${item.model || ''}`.trim();

            if (!groupedCashProducts[displayName]) {
              groupedCashProducts[displayName] = {
                ...item,
                displayName: displayName,
                totalQuantity: 1, // ProductImage ‡πÑ‡∏°‡πà‡∏°‡∏µ stock_value ‡∏à‡∏∂‡∏á‡πÉ‡∏ä‡πâ 1
                items: [item]
              };
            } else {
              groupedCashProducts[displayName].totalQuantity += 1;
              groupedCashProducts[displayName].items.push(item);
            }
          });

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
          Object.values(groupedCashProducts).forEach(group => {
            const option = document.createElement('option');
            option.value = `${group._id}|cash`;

            const cashPrice = group.price || 0; // ProductImage ‡πÉ‡∏ä‡πâ price ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
            option.textContent = `${group.displayName} - ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î ‡∏ø${cashPrice.toLocaleString()} - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢: ${group.totalQuantity}`;

            option.dataset.price = cashPrice;
            option.dataset.saleType = 'cash';
            option.dataset.quantity = group.totalQuantity;
            option.dataset.name = group.name;
            option.dataset.brand = group.brand || '';
            option.dataset.model = group.model || '';
            option.dataset.productType = 'cash'; // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            option.dataset.pricePayOff = cashPrice;

            productSelect.appendChild(option);
          });

          console.log(`üíµ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î: ${Object.keys(groupedCashProducts).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        } else {
          console.error('‚ùå Failed to load cash sale products:', response.status);
        }
      } catch (error) {
        console.error('‚ùå Error loading cash sale products:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function setupSaleTypeListeners() {
      const cashRadio = document.getElementById('saleTypeCashRadio');
      const installmentRadio = document.getElementById('saleTypeInstallmentRadio');

      if (cashRadio && installmentRadio) {
        cashRadio.addEventListener('change', async function() {
          if (this.checked) {
            console.log('üéØ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏™‡∏î');
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
            // ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          }
        });

        installmentRadio.addEventListener('change', async function() {
          if (this.checked) {
            console.log('üéØ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô stock validation ‡πÅ‡∏•‡πâ‡∏ß
            // ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          }
        });
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
    function setupDepositTypeListeners() {
      const onlineRadio = document.querySelector('input[name="depositType"][value="online"]');
      const preorderRadio = document.querySelector('input[name="depositType"][value="preorder"]');
      const saleTypeSection = document.querySelector('.mb-6:has(#saleTypeCashRadio)');
      const cashRadio = document.getElementById('saleTypeCashRadio');
      const installmentRadio = document.getElementById('saleTypeInstallmentRadio');

      if (onlineRadio && preorderRadio) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå" - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏î/‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
        onlineRadio.addEventListener('change', async function() {
          if (this.checked) {
            console.log('üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            if (saleTypeSection) {
              saleTypeSection.style.display = '';
              saleTypeSection.style.opacity = '1';
            }

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
            const cashSaleOption = document.getElementById('cashSaleOption');
            const installmentSaleOption = document.getElementById('installmentSaleOption');

            if (cashRadio && cashSaleOption) {
              cashRadio.disabled = false;
              cashSaleOption.classList.remove('disabled');
            }
            if (installmentRadio && installmentSaleOption) {
              installmentRadio.disabled = false;
              installmentSaleOption.classList.remove('disabled');
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
            await loadOnlineDepositProducts();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            updateDepositTypeHelperText('online');

            console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå');
          }
        });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Pre-order" - ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏î/‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
        preorderRadio.addEventListener('change', async function() {
          if (this.checked) {
            console.log('üìù ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pre-order - ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢');

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Pre-order ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô)
            if (saleTypeSection) {
              saleTypeSection.style.display = '';
              saleTypeSection.style.opacity = '1';
            }

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const cashSaleOption = document.getElementById('cashSaleOption');
            const installmentSaleOption = document.getElementById('installmentSaleOption');

            if (cashRadio && cashSaleOption) {
              cashRadio.disabled = false;
              cashSaleOption.classList.remove('disabled');
            }
            if (installmentRadio && installmentSaleOption) {
              installmentRadio.disabled = false;
              installmentSaleOption.classList.remove('disabled');
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pre-order
            await loadPreOrderProducts();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            updateDepositTypeHelperText('preorder');

            console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order');
          }
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        if (onlineRadio.checked) {
          onlineRadio.dispatchEvent(new Event('change'));
        } else if (preorderRadio.checked) {
          preorderRadio.dispatchEvent(new Event('change'));
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
    function updateDepositTypeHelperText(type) {
      const helperTextElement = document.querySelector('.mb-6:has(input[name="depositType"]) .text-sm.text-gray-500');

      if (helperTextElement) {
        if (type === 'online') {
          helperTextElement.textContent = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°';
          helperTextElement.className = 'text-sm text-green-600 dark:text-green-400 mt-2';
        } else if (type === 'preorder') {
          helperTextElement.textContent = 'Pre-order ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥';
          helperTextElement.className = 'text-sm text-blue-600 dark:text-blue-400 mt-2';
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    async function validateProductStock(productId, depositType, saleType) {
      console.log('üì¶ validateProductStock ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå:', {
        productId,
        depositType,
        saleType
      });

      if (depositType !== 'online') {
        console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å');
        return { valid: true, message: 'Pre-order ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å' };
      }

      try {
        const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';
        const token = localStorage.getItem('authToken');

        console.log('üè™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API call:', {
          branchCode,
          productId,
          depositType,
          saleType,
          hasToken: !!token
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (!branchCode || !productId || !depositType || !saleType) {
          console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:', {
            branchCode: !!branchCode,
            productId: !!productId,
            depositType: !!depositType,
            saleType: !!saleType
          });
          return {
            valid: false,
            message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ'
          };
        }

        const requestBody = {
          branchCode,
          productId,
          depositType,
          saleType,
          quantity: 1
        };

        console.log('üì§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ API:', requestBody);

        const response = await fetch('/api/branch-stock/validate-deposit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(requestBody)
        });

        const result = await response.json();
        console.log('üì¶ Stock validation result:', result);

        if (!result.success) {
          // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ - ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
          return {
            valid: false,
            message: result.errors ? result.errors.join(', ') : '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
            warnings: result.warnings || []
          };
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        const productData = result.productData;
        const supportsCash = true; // ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const supportsInstallment = productData && (productData.downAmount > 0 || productData.downInstallment > 0);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á availability object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
        const availability = {
          available: true,
          quantity: result.stockAvailable ? (productData?.stock_value || 1) : 0,
          branchStockId: productData?._id || productData?.id || productId,
          productData: productData
        };

        return {
          valid: true,
          message: '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
          supportsCash,
          supportsInstallment,
          productData,
          availability,  // ‡πÄ‡∏û‡∏¥‡πà‡∏° availability object
          warnings: result.warnings || []
        };

      } catch (error) {
        console.error('‚ùå Error validating stock:', error);
        return {
          valid: false,
          message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å: ' + error.message
        };
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
    async function updateTrackingStatus(receiptId, trackingField, value, additionalData = {}) {
      try {
        console.log(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ${trackingField} = ${value} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö ${receiptId}`);

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        const token = localStorage.getItem('authToken') || '';
        const response = await fetch(`/api/deposit-receipts/${receiptId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ID: ${receiptId}`);
          return false;
        }

        const data = await response.json();
        const receipt = data.data || data;
        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', receipt);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á tracking object ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if (!receipt.tracking) {
          receipt.tracking = {
            stockChecked: false,
            notificationSent: false,
            customerContacted: false,
            stockCheckDate: null,
            notificationDate: null,
            contactDate: null,
            stockValidationResult: null
          };
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô tracking
        receipt.tracking[trackingField] = value;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        if (trackingField === 'stockChecked' && value === true) {
          receipt.tracking.stockCheckDate = new Date().toISOString();
          if (additionalData.validationResult) {
            receipt.tracking.stockValidationResult = additionalData.validationResult;
          }
        } else if (trackingField === 'notificationSent' && value === true) {
          receipt.tracking.notificationDate = new Date().toISOString();
        } else if (trackingField === 'customerContacted' && value === true) {
          receipt.tracking.contactDate = new Date().toISOString();
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const updateResponse = await fetch(`/api/deposit-receipts/${receiptId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ tracking: receipt.tracking })
        });

        if (!updateResponse.ok) {
          console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ');
          return false;
        }

        console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${trackingField} = ${value}`);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô window.depositReceipts ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        if (window.depositReceipts) {
          const index = window.depositReceipts.findIndex(r =>
            r._id === receiptId || r.id === receiptId || r.receiptNumber === receiptId
          );
          if (index !== -1) {
            window.depositReceipts[index].tracking = receipt.tracking;
          }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô depositReceipts ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (depositReceipts) {
          const index = depositReceipts.findIndex(r =>
            r._id === receiptId || r.id === receiptId || r.receiptNumber === receiptId
          );
          if (index !== -1) {
            depositReceipts[index].tracking = receipt.tracking;
          }
        }

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        if (window.location.hash.includes('view') || document.querySelector('.modal.show')) {
          refreshReceiptList();
        }

        return true;

      } catch (error) {
        console.error('‚ùå Error updating tracking status:', error);
        return false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
    function updateSaleButtonsForReceipt(receiptId, availability) {
      try {
        console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', receiptId);
        console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• availability:', availability);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô modal ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const modal = document.querySelector('.modal.show');

        if (modal) {
          console.log('üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á modal - ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal');

          // ‡∏´‡∏≤ modal body ‡∏´‡∏£‡∏∑‡∏≠ content ‡∏ó‡∏µ‡πà‡∏°‡∏µ space-y-6
          let modalBody = modal.querySelector('.space-y-6');

          if (!modalBody) {
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å modal-content
            modalBody = modal.querySelector('[class*="modal-content"]');
          }

          if (!modalBody) {
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å div ‡∏ó‡∏µ‡πà‡∏°‡∏µ class ‡∏°‡∏µ space
            modalBody = modal.querySelector('div[class*="space"]');
          }

          if (!modalBody) {
            console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö modal body');
            console.log('Modal structure:', modal.innerHTML.substring(0, 500));
            return;
          }

          console.log('‚úÖ ‡∏û‡∏ö modal body:', modalBody);

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á section ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
          let saleButtonsSection = modal.querySelector('.sale-buttons-modal-section');
          if (!saleButtonsSection) {
            saleButtonsSection = document.createElement('div');
            saleButtonsSection.className = 'sale-buttons-modal-section bg-green-50 dark:bg-green-900/20 p-4 rounded-lg';
            modalBody.appendChild(saleButtonsSection);
            console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á sale buttons section ‡πÉ‡∏´‡∏°‡πà');
          } else {
            console.log('‚úÖ ‡∏û‡∏ö sale buttons section ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
          }

          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ saleType
          const receiptsArray = window.depositReceipts || depositReceipts || [];
          const receipt = receiptsArray.find(r => r._id === receiptId || r.id === receiptId || r.receiptNumber === receiptId);
          const saleType = receipt?.saleType || 'cash';

          console.log('üéØ saleType ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', saleType);

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° saleType
          let buttonClass = '';
          let buttonText = '';

          if (saleType === 'installment') {
            buttonClass = 'bg-orange-500 hover:bg-orange-600';
            buttonText = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô';
          } else {
            buttonClass = 'bg-emerald-500 hover:bg-emerald-600';
            buttonText = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';
          }

          const saleButtons = `
            <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h4>
            <div class="flex flex-col gap-2 w-full">
              <div class="text-sm text-green-600 dark:text-green-400 text-center font-medium">
                ‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (${availability.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)
              </div>
              <button onclick="console.log('üîß ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°${buttonText}'); navigateToDirectSale('${receiptId}', '${availability.branchStockId}', '${saleType}')"
                      class="w-full ${buttonClass} text-white text-base px-6 py-3 rounded-lg transition-colors font-semibold shadow-lg hover:shadow-xl">
                ${buttonText} ‚Üí
              </button>
            </div>
          `;

          saleButtonsSection.innerHTML = saleButtons;
          console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô modal ‡πÉ‡∏´‡πâ‡∏´‡∏≤ container ‡∏à‡∏≤‡∏Å data-receipt-id ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        // ‚úÖ FIX: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ receiptNumber ‡∏´‡∏£‡∏∑‡∏≠ id ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const receiptsArray = window.depositReceipts || depositReceipts || [];
        const receipt = receiptsArray.find(r => r._id === receiptId || r.id === receiptId || r.receiptNumber === receiptId);

        // ‡πÉ‡∏ä‡πâ receipt.id ‡∏´‡∏£‡∏∑‡∏≠ receipt.receiptNumber ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö data-receipt-id ‡πÉ‡∏ô HTML)
        const searchId = receipt?.id || receipt?.receiptNumber || receiptId;

        let receiptContainer = document.querySelector(`[data-receipt-id="${searchId}"]`);
        console.log('üéØ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ container ‡∏î‡πâ‡∏ß‡∏¢ searchId:', searchId);
        console.log('üìã ‡∏û‡∏ö container:', receiptContainer);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ID pattern ‡∏ï‡πà‡∏≤‡∏á‡πÜ
        if (!receiptContainer) {
          console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö container ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', receiptId, '‡∏´‡∏£‡∏∑‡∏≠', searchId);

          // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
          const allContainers = document.querySelectorAll('[data-receipt-id]');
          console.log('üîç containers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ data-receipt-id:', Array.from(allContainers).map(el => el.getAttribute('data-receipt-id')));

          // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ï‡∏≤‡∏° pattern ‡∏ï‡πà‡∏≤‡∏á‡πÜ
          for (const container of allContainers) {
            const containerId = container.getAttribute('data-receipt-id');
            if (containerId === receiptId ||
                containerId === searchId ||
                containerId.includes(receiptId) ||
                receiptId.includes(containerId)) {
              receiptContainer = container;
              console.log('‚úÖ ‡∏û‡∏ö container ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà pattern:', containerId);
              break;
            }
          }

          if (!receiptContainer) {
            console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤ container ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ - ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠');
            return;
          }
        }

        // ‡∏´‡∏≤ section ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î)
        let cardContent = receiptContainer.querySelector('.bg-white') || receiptContainer;
        console.log('üìã Card content found:', cardContent);

        // ‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
        let saleButtonsSection = receiptContainer.querySelector('.sale-buttons-section');
        if (!saleButtonsSection) {
          saleButtonsSection = document.createElement('div');
          saleButtonsSection.className = 'sale-buttons-section mt-3 border-t border-gray-200 dark:border-gray-600 pt-3';

          // ‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢ card content ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
          cardContent.appendChild(saleButtonsSection);

          console.log('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏£‡∏Å‡∏õ‡∏∏‡πà‡∏°:', saleButtonsSection.parentNode);
        } else {
          console.log('üìç ‡∏û‡∏ö sale buttons section ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß - ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤');
        }

        // ‡πÉ‡∏ä‡πâ receipt ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ saleType (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà)
        const saleType = receipt?.saleType || 'cash';

        console.log('üéØ saleType ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', saleType);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏° saleType ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ
        let buttonHTML = '';
        let buttonClass = '';
        let buttonText = '';

        if (saleType === 'installment') {
          buttonClass = 'bg-orange-500 hover:bg-orange-600';
          buttonText = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô';
        } else {
          buttonClass = 'bg-emerald-500 hover:bg-emerald-600';
          buttonText = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏î';
        }

        const saleButtons = `
          <div class="flex flex-col gap-2 w-full">
            <div class="text-xs text-green-600 text-center">
              ‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (${availability.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)
            </div>
            <button onclick="console.log('üîß ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°${buttonText}'); navigateToDirectSale('${receiptId}', '${availability.branchStockId}', '${saleType}')"
                    class="w-full ${buttonClass} text-white text-sm px-4 py-2 rounded-md transition-colors font-medium">
              ${buttonText}
            </button>
          </div>
        `;

        saleButtonsSection.innerHTML = saleButtons;
        console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.log('üéØ ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡πÉ‡∏ô element:', saleButtonsSection);

      } catch (error) {
        console.error('‚ùå Error updating sale buttons:', error);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡∏ô‡∏ô‡∏ß‡∏•
    async function manualStockCheck(receiptId) {
      try {
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
        let receipt = null;

        // 1. ‡∏´‡∏≤‡∏à‡∏≤‡∏Å global variable depositReceipts
        if (window.depositReceipts && Array.isArray(window.depositReceipts)) {
          receipt = window.depositReceipts.find(r =>
            r.id === receiptId ||
            r._id === receiptId ||
            r.receiptNumber === receiptId
          );
        }

        // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å localStorage
        if (!receipt) {
          const localReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
          receipt = localReceipts.find(r =>
            r.id === receiptId ||
            r._id === receiptId ||
            r.receiptNumber === receiptId
          );
        }

        // 3. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API
        if (!receipt) {
          console.log('üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô cache, ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API...');
          const token = localStorage.getItem('authToken') || '';
          const branchCode = localStorage.getItem('branchCode') || window.BRANCH_CODE || '00000';

          const response = await fetch(`/api/deposit-receipts/${receiptId}`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            receipt = data.data || data;
          }
        }

        if (!receipt) {
          console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', receiptId);
          showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', 'error');
          return false;
        }

        console.log('‚úÖ ‡∏û‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', receipt.receiptNumber);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        console.log('üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• receipt.product:', receipt.product);

        // ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á productId
        let productId = receipt.product?._id ||
                       receipt.product?.id ||
                       receipt.productId ||
                       receipt.product?.productId ||
                       receipt.product?.product_id;

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å product object ‡∏ï‡∏£‡∏á‡πÜ
        if (!productId && receipt.product) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å key ‡πÉ‡∏ô product object
          console.log('üîç Keys ‡πÉ‡∏ô product object:', Object.keys(receipt.product));

          // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ reference ‡∏≠‡∏∑‡πà‡∏ô
          productId = receipt.product.branchStockId ||
                     receipt.product.stockId ||
                     receipt.product.referenceId;
        }

        console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å:', {
          productId,
          depositType: receipt.depositType,
          saleType: receipt.saleType,
          productData: receipt.product,
          allReceiptKeys: Object.keys(receipt)
        });

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ productId ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å
        if (!productId && receipt.product?.name) {
          console.log('üîç ‡πÑ‡∏°‡πà‡∏°‡∏µ productId ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å');

          // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkProductAvailabilityInBranch ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
          const availability = await checkProductAvailabilityInBranch(
            null, // ‡πÑ‡∏°‡πà‡∏°‡∏µ productImageId
            receipt.product.name,
            receipt.product.brand || '',
            receipt.product.model || ''
          );

          const validationResult = {
            valid: availability.available,
            message: availability.available
              ? `‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (${availability.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)`
              : '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î',
            warnings: availability.available ? [] : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤']
          };

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
          const success = updateTrackingStatus(receiptId, 'stockChecked', true, {
            validationResult: validationResult,
            checkedAt: new Date().toISOString(),
            availability: availability
          });

          if (success) {
            console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)');

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• availability ‡πÉ‡∏ô global variable
            if (availability.available) {
              receiptAvailabilityData[receiptId] = availability;
              console.log('üíæ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• availability ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', receiptId, availability);

              // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
              updateSaleButtonsForReceipt(receiptId, availability);

              // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß
              console.log('‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
            } else {
              // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡∏Å‡πá‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              const updatedReceipts = await loadDepositReceipts();
              // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å displayDepositReceipts ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
            }
          }

          return success;
        } else if (!productId) {
          console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö productId ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ - ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å');

          const fallbackValidationResult = {
            valid: true,
            message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
            warnings: ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å']
          };

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
          const success = updateTrackingStatus(receiptId, 'stockChecked', true, {
            validationResult: fallbackValidationResult
          });

          if (success) {
            showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ productId', 'warning');

            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            if (document.querySelector('.modal.show')) {
              viewDepositDetails(receiptId);
            }
          }

          return true; // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ú‡πà‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        }

        const validationResult = await validateProductStock(
          productId,
          receipt.depositType,
          receipt.saleType
        );

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
        const success = await updateTrackingStatus(receiptId, 'stockChecked', validationResult.valid, {
          validationResult: validationResult
        });

        if (success) {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          const message = validationResult.valid
            ? `‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ${validationResult.message}`
            : `‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${validationResult.message}`;

          showNotification(message, validationResult.valid ? 'success' : 'error');

          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
          if (validationResult.valid && validationResult.availability) {
            console.log('üéØ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateSaleButtonsForReceipt with availability:', validationResult.availability);
            updateSaleButtonsForReceipt(receiptId, validationResult.availability);
          }

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          if (document.querySelector('.modal.show')) {
            viewDepositDetails(receiptId);
          }
        }

        return validationResult.valid;

      } catch (error) {
        console.error('‚ùå Error in manual stock check:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å', 'error');
        return false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    async function sendNotification(receiptId) {
      try {
        // TODO: ‡πÉ‡∏ä‡πâ Socket.IO ‡∏´‡∏£‡∏∑‡∏≠ API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const success = updateTrackingStatus(receiptId, 'notificationSent', true);

        if (success) {
          showNotification('‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          if (document.querySelector('.modal.show')) {
            viewDepositDetails(receiptId);
          }
        }

        return success;

      } catch (error) {
        console.error('‚ùå Error sending notification:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 'error');
        return false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    async function markCustomerContacted(receiptId) {
      try {
        const success = updateTrackingStatus(receiptId, 'customerContacted', true);

        if (success) {
          showNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          if (document.querySelector('.modal.show')) {
            viewDepositDetails(receiptId);
          }
        }

        return success;

      } catch (error) {
        console.error('‚ùå Error marking customer contacted:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', 'error');
        return false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤ tracking object ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    function ensureTrackingObject(receipt) {
      if (!receipt.tracking) {
        receipt.tracking = {
          stockChecked: false,
          notificationSent: false,
          customerContacted: false,
          stockCheckDate: null,
          notificationDate: null,
          contactDate: null,
          stockValidationResult: null
        };
      }
      return receipt;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    function showNotification(message, type = 'info') {
      // ‡πÉ‡∏ä‡πâ window.posNotificationSystem ‡∏´‡∏≤‡∏Å‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ fallback ‡πÄ‡∏õ‡πá‡∏ô alert
      if (window.posNotificationSystem && typeof window.posNotificationSystem.add === 'function') {
        window.posNotificationSystem.add(message, type);
      } else if (window.createNotification && typeof window.createNotification === 'function') {
        window.createNotification(message, type);
      } else {
        // Fallback - ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô console ‡πÅ‡∏•‡∏∞ alert ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        console.log(`${type.toUpperCase()}: ${message}`);
        if (type === 'error') {
          alert(`‚ùå Error: ${message}`);
        } else if (type === 'success') {
          console.log(`‚úÖ Success: ${message}`);
        }
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    async function loadCustomerTypes() {
      try {
        const customerTypeSelect = document.getElementById('customerType');
        const customerPrefixSelect = document.getElementById('customerPrefix');

        if (customerTypeSelect) {
          customerTypeSelect.innerHTML = `
            <option value="individual">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
            <option value="company">‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
          `;
        }

        if (customerPrefixSelect) {
          customerPrefixSelect.innerHTML = `
            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
            <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
            <option value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
            <option value="‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô">‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô</option>
          `;
        }

        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
      } catch (error) {
        console.error('‚ùå Error loading customer types:', error);
      }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    function setupProductSelectionListeners() {
      // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Enhanced with stock validation)
      const productSelect = document.getElementById('productDropdownSelect');
      if (productSelect) {
        productSelect.addEventListener('change', async function() {
          const selectedOption = this.options[this.selectedIndex];
          const productInfo = document.getElementById('selectedProductInfo');
          const cashRadio = document.getElementById('saleTypeCashRadio');
          const installmentRadio = document.getElementById('saleTypeInstallmentRadio');

          if (selectedOption.value && productInfo) {
            // ‡πÉ‡∏ä‡πâ productId ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å value (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å saleType)
            const productId = selectedOption.value;

            const price = selectedOption.dataset.price;
            const quantity = selectedOption.dataset.quantity;
            const name = selectedOption.dataset.name;
            const brand = selectedOption.dataset.brand;
            const model = selectedOption.dataset.model;
            const branchCode = selectedOption.dataset.branchCode;

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
            window.selectedProductData = {
              id: productId,
              _id: productId, // BranchStock ID
              branchStockId: productId, // ‡πÄ‡∏Å‡πá‡∏ö BranchStock ID ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢
              name: name,
              brand: brand,
              model: model,
              price: parseFloat(price) || 0,
              quantity: parseInt(quantity) || 0,
              inStock: true,
              productType: 'online',
              branchCode: branchCode
            };

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const depositType = document.querySelector('input[name="depositType"]:checked')?.value || 'online';

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏î/‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
            if (depositType === 'online') {
              console.log('üì¶ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå:', { productId, name });

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Parallel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á cash ‡πÅ‡∏•‡∏∞ installment
              const [cashValidation, installmentValidation] = await Promise.allSettled([
                validateProductStock(productId, depositType, 'cash'),
                validateProductStock(productId, depositType, 'installment')
              ]);

              // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
              const cashResult = cashValidation.status === 'fulfilled' ? cashValidation.value : { valid: false };
              const installmentResult = installmentValidation.status === 'fulfilled' ? installmentValidation.value : { valid: false };

              // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global variable ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
              window.lastStockValidationResult = {
                productId: productId,
                depositType: depositType,
                cashResult: cashResult,
                installmentResult: installmentResult,
                validationTime: new Date().toISOString(),
                valid: cashResult.valid || installmentResult.valid
              };

              // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢‡∏™‡∏î/‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
              const cashSaleOption = document.getElementById('cashSaleOption');
              const installmentSaleOption = document.getElementById('installmentSaleOption');

              if (cashRadio && cashSaleOption) {
                const isDisabled = !cashResult.valid || !cashResult.supportsCash;
                cashRadio.disabled = isDisabled;

                if (isDisabled) {
                  cashSaleOption.classList.add('disabled');
                  cashRadio.checked = false;
                } else {
                  cashSaleOption.classList.remove('disabled');
                }
              }

              if (installmentRadio && installmentSaleOption) {
                const isDisabled = !installmentResult.valid || !installmentResult.supportsInstallment;
                installmentRadio.disabled = isDisabled;

                if (isDisabled) {
                  installmentSaleOption.classList.add('disabled');
                  installmentRadio.checked = false;
                } else {
                  installmentSaleOption.classList.remove('disabled');
                }
              }

              // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Sale Type Validation Status
              const saleTypeValidationStatus = document.getElementById('saleTypeValidationStatus');
              if (saleTypeValidationStatus) {
                let statusHTML = '';
                if (!cashResult.valid && !installmentResult.valid) {
                  statusHTML = `
                    <div class="stock-validation p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
                      <div class="flex items-center">
                        <i class="bi bi-exclamation-triangle text-red-500 mr-2"></i>
                        <p class="text-sm text-red-700 dark:text-red-400 font-medium">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</p>
                      </div>
                      <p class="text-xs text-red-600 dark:text-red-300 mt-1 ml-6">${cashResult.message || installmentResult.message}</p>
                    </div>
                  `;
                } else {
                  const availableOptions = [];
                  const unavailableOptions = [];

                  if (cashResult.valid && cashResult.supportsCash) {
                    availableOptions.push('üíµ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î');
                  } else {
                    unavailableOptions.push('üíµ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î');
                  }

                  if (installmentResult.valid && installmentResult.supportsInstallment) {
                    availableOptions.push('üìÖ ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');
                  } else {
                    unavailableOptions.push('üìÖ ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');
                  }

                  statusHTML = `
                    <div class="stock-validation space-y-2">
                      ${availableOptions.length > 0 ? `
                        <div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md">
                          <div class="flex items-center">
                            <i class="bi bi-check-circle text-green-500 mr-2"></i>
                            <p class="text-sm text-green-700 dark:text-green-400 font-medium">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                          </div>
                          <p class="text-xs text-green-600 dark:text-green-300 mt-1 ml-6">${availableOptions.join(', ')}</p>
                        </div>
                      ` : ''}
                      ${unavailableOptions.length > 0 ? `
                        <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                          <div class="flex items-center">
                            <i class="bi bi-info-circle text-yellow-500 mr-2"></i>
                            <p class="text-sm text-yellow-700 dark:text-yellow-400 font-medium">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>
                          </div>
                          <p class="text-xs text-yellow-600 dark:text-yellow-300 mt-1 ml-6">${unavailableOptions.join(', ')} (${cashResult.message || installmentResult.message || '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'})</p>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }

                saleTypeValidationStatus.innerHTML = statusHTML;
                saleTypeValidationStatus.classList.remove('hidden');
              }

              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏Å‡πà‡∏≤)
              let validationInfo = '';
              if (!cashResult.valid && !installmentResult.valid) {
                validationInfo = `
                  <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                    <p class="text-sm text-red-700 font-medium">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</p>
                    <p class="text-xs text-red-600 mt-1">${cashResult.message || installmentResult.message}</p>
                  </div>
                `;
              } else {
                const availableOptions = [];
                if (cashResult.valid && cashResult.supportsCash) availableOptions.push('üíµ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î');
                if (installmentResult.valid && installmentResult.supportsInstallment) availableOptions.push('üìÖ ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');

                validationInfo = `
                  <div class="p-3 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-sm text-green-700 font-medium">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</p>
                    <p class="text-xs text-green-600 mt-1">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ${availableOptions.join(', ')}</p>
                  </div>
                `;
              }

              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              const saleType = document.querySelector('input[name="saleType"]:checked')?.value;

              // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
              if (saleType === 'installment' && installmentResult.valid) {
                window.selectedProductData.downAmount = parseFloat(selectedOption.dataset.downAmount) || 0;
                window.selectedProductData.downInstallmentCount = parseInt(selectedOption.dataset.downInstallmentCount) || 12;
                window.selectedProductData.downInstallment = parseFloat(selectedOption.dataset.downInstallment) || 0;
                window.selectedProductData.creditThreshold = parseFloat(selectedOption.dataset.creditThreshold) || 0;
                window.selectedProductData.payUseInstallmentCount = parseInt(selectedOption.dataset.payUseInstallmentCount) || 0;
                window.selectedProductData.payUseInstallment = parseFloat(selectedOption.dataset.payUseInstallment) || 0;
                window.selectedProductData.docFee = parseFloat(selectedOption.dataset.docFee) || 0;
              } else if (saleType === 'cash' && cashResult.valid) {
                window.selectedProductData.pricePayOff = parseFloat(selectedOption.dataset.pricePayOff) || parseFloat(price);
              }

              productInfo.innerHTML = `
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-md space-y-3">
                  <div>
                    <h4 class="font-semibold text-blue-900">${name} ${brand} ${model}</h4>
                    <p class="text-sm text-blue-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô | ‡∏™‡∏≤‡∏Ç‡∏≤: ${branchCode}</p>
                    <p class="text-lg font-bold text-blue-700">‡∏ø${parseFloat(price).toLocaleString()}</p>
                  </div>
                  ${validationInfo}
                </div>
              `;

            } else {
              // Pre-order - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å
              productInfo.innerHTML = `
                <div class="p-3 bg-orange-50 border border-orange-200 rounded-md space-y-3">
                  <div>
                    <h4 class="font-semibold text-orange-900">${name} ${brand} ${model}</h4>
                    <p class="text-sm text-orange-600">Pre-order - ‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</p>
                    <p class="text-lg font-bold text-orange-700">‡∏ø${parseFloat(price).toLocaleString()}</p>
                  </div>
                </div>
              `;

              // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order
              const saleTypeValidationStatus = document.getElementById('saleTypeValidationStatus');
              if (saleTypeValidationStatus) {
                saleTypeValidationStatus.classList.add('hidden');
              }
            }

            productInfo.classList.remove('hidden');

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå
            const productPriceField = document.getElementById('productPrice');
            if (productPriceField) {
              productPriceField.value = price;
              updateAmountDisplay();
            }

          } else if (productInfo) {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            productInfo.classList.add('hidden');

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const cashSaleOption = document.getElementById('cashSaleOption');
            const installmentSaleOption = document.getElementById('installmentSaleOption');
            const saleTypeValidationStatus = document.getElementById('saleTypeValidationStatus');

            if (cashRadio && cashSaleOption) {
              cashRadio.disabled = false;
              cashSaleOption.classList.remove('disabled');
            }
            if (installmentRadio && installmentSaleOption) {
              installmentRadio.disabled = false;
              installmentSaleOption.classList.remove('disabled');
            }

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            if (saleTypeValidationStatus) {
              saleTypeValidationStatus.classList.add('hidden');
            }
          }
        });
      }

      // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pre-order
      const preorderSelect = document.getElementById('preorderProductSelect');
      if (preorderSelect) {
        preorderSelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const productInfo = document.getElementById('selectedPreorderProductInfo');

          if (selectedOption.value && productInfo) {
            const price = selectedOption.dataset.price;
            const name = selectedOption.dataset.name;
            const brand = selectedOption.dataset.brand;
            const model = selectedOption.dataset.model;

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö preorder
            window.selectedProductData = {
              price: parseFloat(price) || 0,
              downAmount: parseFloat(selectedOption.dataset.downAmount) || 0,
              downInstallmentCount: parseInt(selectedOption.dataset.downInstallmentCount) || 12,
              downInstallment: parseFloat(selectedOption.dataset.downInstallment) || 0,
              name: name,
              brand: brand,
              model: model
            };

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            checkProductAvailabilityInBranch(selectedOption.value, name, brand, model)
              .then(availability => {
                const statusColor = availability.available ? 'text-green-600' : 'text-orange-600';
                const statusBg = availability.available ? 'bg-green-50' : 'bg-orange-50';
                const statusText = availability.available
                  ? `‚úÖ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ (${availability.quantity} ‡∏ä‡∏¥‡πâ‡∏ô)`
                  : '‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå';

                productInfo.innerHTML = `
                  <div class="flex items-center justify-between">
                    <div>
                      <h4 class="font-semibold text-orange-900 dark:text-orange-100">${name}</h4>
                      <p class="text-sm text-orange-600 dark:text-orange-400">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${brand || '-'} | ‡∏£‡∏∏‡πà‡∏ô: ${model || '-'}</p>
                      <p class="text-sm text-orange-600 dark:text-orange-400">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${Number(price).toLocaleString()}</p>
                      <p class="text-sm ${statusColor} font-medium">${statusText}</p>
                      ${availability.available ?
                        `<div class="mt-2 flex gap-2">
                          <button onclick="navigateToSale('preorder-${selectedOption.value}', 'cash')"
                                  class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">
                            ‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
                          </button>
                          <button onclick="navigateToSale('preorder-${selectedOption.value}', 'installment')"
                                  class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            ‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
                          </button>
                        </div>` : ''
                      }
                    </div>
                    <div class="text-right">
                      <span class="text-lg font-bold text-orange-600">‡∏ø${Number(price).toLocaleString()}</span>
                    </div>
                  </div>
                `;
                productInfo.classList.remove('hidden');
              })
              .catch(error => {
                console.error('Error checking product availability:', error);
                // Fallback display
                productInfo.innerHTML = `
                  <div class="flex items-center justify-between">
                    <div>
                      <h4 class="font-semibold text-orange-900 dark:text-orange-100">${name}</h4>
                      <p class="text-sm text-orange-600 dark:text-orange-400">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${brand || '-'} | ‡∏£‡∏∏‡πà‡∏ô: ${model || '-'}</p>
                      <p class="text-sm text-orange-600 dark:text-orange-400">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${Number(price).toLocaleString()}</p>
                      <p class="text-sm text-orange-600 dark:text-orange-400">‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</p>
                    </div>
                    <div class="text-right">
                      <span class="text-lg font-bold text-orange-600">‡∏ø${Number(price).toLocaleString()}</span>
                    </div>
                  </div>
                `;
                productInfo.classList.remove('hidden');
              });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå
            const productPriceField = document.getElementById('productPrice');
            if (productPriceField) {
              productPriceField.value = price;
              updateAmountDisplay();
            }
          } else if (productInfo) {
            productInfo.classList.add('hidden');
          }
        });
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pre-order
    async function checkProductAvailabilityInBranch(productImageId, productName, brand, model) {
      try {
        const token = localStorage.getItem('authToken') || '';
        const branchCode = window.BRANCH_CODE || '00000';

        console.log(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤: ${productName} ${brand} ${model}`);
        console.log(`üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:`, {
          productImageId,
          productName,
          brand,
          model,
          branchCode
        });

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå ‡πÅ‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô
        const response = await fetch(`/api/branch-stock?branch_code=${branchCode}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const stockData = await response.json();
          const stockProducts = stockData.success ? stockData.data : [];

          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
          console.log(`üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${stockProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

          const matchedProduct = stockProducts.find(item => {
            const itemName = (item.name || item.product_id?.name || '').toLowerCase();
            const itemBrand = (item.brand || '').toLowerCase();
            const itemModel = (item.model || '').toLowerCase();

            const searchName = (productName || '').toLowerCase();
            const searchBrand = (brand || '').toLowerCase();
            const searchModel = (model || '').toLowerCase();

            console.log(`üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:`, {
              item: { name: itemName, brand: itemBrand, model: itemModel, stock_value: item.stock_value, verified: item.verified },
              search: { name: searchName, brand: searchBrand, model: searchModel }
            });

            const nameMatch = itemName.includes(searchName);
            const brandMatch = !searchBrand || itemBrand.includes(searchBrand);
            const modelMatch = !searchModel || itemModel.includes(searchModel);
            const hasStock = (item.stock_value || 0) > 0;
            const isVerified = item.verified === true;

            console.log(`üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:`, { nameMatch, brandMatch, modelMatch, hasStock, isVerified });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ verified)
            // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÑ‡∏î‡πâ
            return nameMatch && brandMatch && modelMatch && hasStock;
          });

          if (matchedProduct) {
            console.log(`‚úÖ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤:`, matchedProduct);
            return {
              available: true,
              quantity: matchedProduct.stock_value || 0,
              branchStockId: matchedProduct._id,
              price: matchedProduct.price
            };
          } else {
            console.log(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå ‡∏£‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å`);
            console.log(`üîç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:`, stockProducts.map(item => ({
              name: item.name,
              brand: item.brand,
              model: item.model,
              stock_value: item.stock_value,
              verified: item.verified
            })));
            return {
              available: false,
              quantity: 0
            };
          }
        } else {
          console.error('‚ùå Failed to check branch stock:', response.status);
          return { available: false, quantity: 0 };
        }

      } catch (error) {
        console.error('‚ùå Error checking product availability:', error);
        return { available: false, quantity: 0 };
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå hidden
    function updateCustomerName() {
      const firstName = document.getElementById('customerFirstName')?.value || '';
      const lastName = document.getElementById('customerLastName')?.value || '';
      const prefix = document.getElementById('customerPrefix')?.value || '';

      let fullName = '';
      if (prefix && (firstName || lastName)) {
        fullName = prefix + (firstName ? firstName : '') + (lastName ? ' ' + lastName : '');
      } else if (firstName || lastName) {
        fullName = (firstName ? firstName : '') + (lastName ? ' ' + lastName : '');
      }
      fullName = fullName.trim();

      const customerNameField = document.getElementById('customerName');
      if (customerNameField) {
        customerNameField.value = fullName;
        console.log('üè∑Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:', fullName);
      }
    }

    function updateCustomerAddress() {
      const houseNo = document.getElementById('houseNo')?.value || '';
      const moo = document.getElementById('moo')?.value || '';
      const subDistrict = document.getElementById('subDistrict')?.value || '';
      const district = document.getElementById('district')?.value || '';
      const province = document.getElementById('province')?.value || '';
      const zipcode = document.getElementById('zipcode')?.value || '';

      let addressParts = [];
      if (houseNo) addressParts.push(houseNo);
      if (moo) addressParts.push('‡∏´‡∏°‡∏π‡πà ' + moo);
      if (subDistrict) addressParts.push('‡∏ï‡∏≥‡∏ö‡∏•' + subDistrict);
      if (district) addressParts.push('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' + district);
      if (province) addressParts.push('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' + province);
      if (zipcode) addressParts.push(zipcode);

      const fullAddress = addressParts.join(' ');
      const customerAddressField = document.getElementById('customerAddress');
      if (customerAddressField) {
        customerAddressField.value = fullAddress;
        console.log('üè† ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:', fullAddress);
      }
    }

    function setupCustomerDataHandlers() {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠
      const customerFirstName = document.getElementById('customerFirstName');
      const customerLastName = document.getElementById('customerLastName');
      const customerPrefix = document.getElementById('customerPrefix');

      if (customerFirstName) {
        customerFirstName.addEventListener('input', updateCustomerName);
      }
      if (customerLastName) {
        customerLastName.addEventListener('input', updateCustomerName);
      }
      if (customerPrefix) {
        customerPrefix.addEventListener('change', updateCustomerName);
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
      const addressFields = ['houseNo', 'moo', 'subDistrict', 'district', 'province', 'zipcode'];
      addressFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', updateCustomerAddress);
        }
      });

      console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    function setupAgeCalculation() {
      const birthDateInput = document.getElementById('customerBirthDate');
      const ageInput = document.getElementById('customerAge');

      if (birthDateInput && ageInput) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
        birthDateInput.addEventListener('change', function() {
          const birthDate = new Date(this.value);
          const today = new Date();

          if (this.value && birthDate <= today) {
            const age = calculateAge(birthDate, today);
            ageInput.value = age;
            console.log(`üéÇ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏: ${age} ‡∏õ‡∏µ (‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${this.value})`);
          } else {
            ageInput.value = '';
            if (this.value && birthDate > today) {
              console.warn('‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ');
              // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              if (window.posNotificationSystem) {
                window.posNotificationSystem.addNotification('pos', {
                  title: '‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                  message: '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ',
                  type: 'warning'
                });
              }
            }
          }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ input ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (real-time)
        birthDateInput.addEventListener('input', function() {
          if (this.value) {
            const birthDate = new Date(this.value);
            const today = new Date();

            if (birthDate <= today) {
              const age = calculateAge(birthDate, today);
              ageInput.value = age;
            }
          } else {
            ageInput.value = '';
          }
        });

        console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } else {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö input field ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏');
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function calculatePricesBySaleType(basePrice, productName) {
      try {
        // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å API pricing
        if (window.productPricing && window.productPricing.length > 0) {
          const pricingData = window.productPricing.find(item =>
            item.name && item.name.toLowerCase() === productName.toLowerCase()
          );

          if (pricingData) {
            return {
              cashPrice: pricingData.cashPrice || basePrice,
              installmentPrice: pricingData.installmentPrice || basePrice
            };
          }
        }

        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        return {
          cashPrice: basePrice,
          installmentPrice: basePrice
        };
      } catch (error) {
        console.error('‚ùå Error calculating prices:', error);
        return {
          cashPrice: basePrice,
          installmentPrice: basePrice
        };
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    function updatePriceDisplay() {
      const saleTypeCash = document.getElementById('saleTypeCash')?.checked;
      const saleTypeInstallment = document.getElementById('saleTypeInstallment')?.checked;

      if (window.selectedProductData) {
        const currentPrice = saleTypeCash ?
          window.selectedProductData.cashPrice :
          window.selectedProductData.installmentPrice;

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ
        const productPriceField = document.getElementById('productPrice');
        if (productPriceField) {
          productPriceField.value = currentPrice;
        }

        console.log(`üí∞ Updated price display: ${saleTypeCash ? 'Cash' : 'Installment'} = ‡∏ø${currentPrice.toLocaleString()}`);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
    function calculateAge(birthDate, currentDate = new Date()) {
      let age = currentDate.getFullYear() - birthDate.getFullYear();
      const monthDiff = currentDate.getMonth() - birthDate.getMonth();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (monthDiff < 0 || (monthDiff === 0 && currentDate.getDate() < birthDate.getDate())) {
        age--;
      }

      return age;
    }

    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });

    // ==================== PDF FUNCTIONALITY ====================

    // Global variable to store current receipt data for PDF
    let currentReceiptForPDF = null;

    // Event listener for PDF button - using DOMContentLoaded to ensure elements exist
    document.addEventListener('DOMContentLoaded', function() {

      const pdfButton = document.getElementById('btnLoadPDF');
      if (pdfButton) {
        console.log('‚úÖ PDF button found, attaching event listener');

        pdfButton.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('üñ±Ô∏è PDF button clicked!');
          loadDepositReceiptPDF();
        });
      } else {
        console.log('‚ùå PDF button not found during DOMContentLoaded');
      }

      // Also add a backup global click listener
      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'btnLoadPDF') {
          e.preventDefault();
          console.log('üñ±Ô∏è PDF button clicked via global listener!');
          loadDepositReceiptPDF();
        }
      });
    });

    // Function to load deposit receipt PDF
    function loadDepositReceiptPDF() {
      try {
        if (!currentReceiptForPDF) {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£', 'error');
          return;
        }

        console.log('üìÑ Loading PDF for receipt:', currentReceiptForPDF.receiptNumber);
        console.log('üìã Receipt data to PDF:', currentReceiptForPDF);

        // Store receipt data in localStorage for PDF to access
        localStorage.setItem('currentDepositReceipt', JSON.stringify(currentReceiptForPDF));

        // Also store in depositReceipts array if not exists
        const existingReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
        const receiptExists = existingReceipts.find(r => r._id === currentReceiptForPDF._id);

        if (!receiptExists) {
          existingReceipts.push(currentReceiptForPDF);
          localStorage.setItem('depositReceipts', JSON.stringify(existingReceipts));
          console.log('üíæ Added receipt to localStorage depositReceipts');
        }

        // Simple PDF loading - try direct path first
        const pdfUrl = 'DepositReceiptPDF';

        console.log('üìç Current page URL:', window.location.href);
        console.log('üéØ Opening PDF at:', pdfUrl);

        const pdfWindow = window.open(pdfUrl, '_blank');

        if (pdfWindow) {
          showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', 'success');
          console.log('‚úÖ PDF window opened successfully');
          console.log('üíæ localStorage data:', localStorage.getItem('currentDepositReceipt'));

          // Check if the window closed immediately (might indicate 404)
          setTimeout(() => {
            try {
              if (pdfWindow.closed) {
                console.log('‚ö†Ô∏è PDF window closed quickly, trying alternative URL...');
                const fallbackUrl = 'PDF/DepositReceiptPDF.html';
                console.log('üîÑ Trying fallback URL:', fallbackUrl);
                window.open(fallbackUrl, '_blank');
              }
            } catch (e) {
              // Cross-origin check might fail, but that's normal
              console.log('‚ÑπÔ∏è Cannot check window status (normal for cross-origin)');
            }
          }, 1000);
        } else {
          showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Popup Blocker', 'error');
          console.log('‚ùå Failed to open popup window');

          // Try opening in same tab as last resort
          console.log('üîÑ Trying to open in same tab...');
          window.location.href = pdfUrl;
        }

      } catch (error) {
        console.error('‚ùå Error loading PDF:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF', 'error');
      }
    }

    // Function to set current receipt data (called when viewing details)
    function setCurrentReceiptForPDF(receipt) {
      currentReceiptForPDF = receipt;
      console.log('üìã Set current receipt for PDF:', receipt.receiptNumber);
    }

    // Override the existing viewDepositDetails function to set current receipt data
    const originalViewDepositDetails = viewDepositDetails;
    viewDepositDetails = async function(receiptId) {
      try {
        // Find the receipt data
        const receipt = depositReceipts.find(r => r._id === receiptId);
        if (receipt) {
          // Set current receipt for PDF
          setCurrentReceiptForPDF(receipt);
        }

        // Call original function
        return await originalViewDepositDetails(receiptId);
      } catch (error) {
        console.error('Error in modified viewDepositDetails:', error);
        return await originalViewDepositDetails(receiptId);
      }
    };

    // Alternative PDF loading with receipt ID parameter (‡πÉ‡∏ä‡πâ localStorage ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    function loadDepositReceiptPDFById(receiptId) {
      try {
        const receipt = depositReceipts.find(r => r._id === receiptId);
        if (!receipt) {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', 'error');
          return;
        }

        console.log('üìÑ Loading PDF by ID for receipt:', receipt.receiptNumber);

        // Store receipt data in localStorage for PDF to access
        localStorage.setItem('currentDepositReceipt', JSON.stringify(receipt));

        // Also ensure it's in depositReceipts array
        const existingReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
        const receiptExists = existingReceipts.find(r => r._id === receipt._id);

        if (!receiptExists) {
          existingReceipts.push(receipt);
          localStorage.setItem('depositReceipts', JSON.stringify(existingReceipts));
        }

        // Open PDF WITHOUT ID parameter (‡πÉ‡∏ä‡πâ localStorage ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        const pdfUrl = 'PDF/DepositReceiptPDF.html';
        const pdfWindow = window.open(pdfUrl, '_blank');

        if (pdfWindow) {
          showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥', 'success');
        } else {
          showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Popup Blocker', 'error');
        }

      } catch (error) {
        console.error('‚ùå Error loading PDF by ID:', error);
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF', 'error');
      }
    }

    // Make functions globally accessible for testing
    window.testPDFFunction = function() {
      console.log('Current receipt data:', currentReceiptForPDF);

      if (!currentReceiptForPDF) {
        console.log('‚ùå No current receipt data. Try opening a receipt detail first.');
        return false;
      }

      loadDepositReceiptPDF();
      return true;
    };

    window.checkPDFButton = function() {
      const pdfButton = document.getElementById('btnLoadPDF');
      console.log('üîç PDF Button check:', {
        exists: !!pdfButton,
        visible: pdfButton ? pdfButton.offsetParent !== null : false,
        enabled: pdfButton ? !pdfButton.disabled : false,
        className: pdfButton ? pdfButton.className : 'N/A'
      });
      return pdfButton;
    };

    window.forcePDFLoad = function() {
      console.log('üöÄ Force loading PDF...');

      // Create sample data if no current receipt
      if (!currentReceiptForPDF) {
        currentReceiptForPDF = {
          _id: 'test-id',
          receiptNumber: 'TEST-001',
          customer: { name: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö', phone: '0xx-xxx-xxxx' },
          product: { name: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö', price: 1000 },
          amounts: { totalAmount: 1000, depositAmount: 300, remainingAmount: 700 }
        };
        console.log('üìù Created sample data for testing');
      }

      loadDepositReceiptPDF();
    };

    // Add simple click test function
    window.clickPDFButton = function() {
      console.log('üñ±Ô∏è Manually triggering PDF button click...');
      const pdfButton = document.getElementById('btnLoadPDF');
      if (pdfButton) {
        console.log('‚úÖ Found PDF button, triggering click event');
        pdfButton.click();
        return true;
      } else {
        console.log('‚ùå PDF button not found!');
        return false;
      }
    };

    // Add function to manually trigger the event
    window.triggerPDFEvent = function() {
      console.log('‚ö° Manually triggering PDF load event...');
      const pdfButton = document.getElementById('btnLoadPDF');
      if (pdfButton) {
        const event = new Event('click', { bubbles: true });
        pdfButton.dispatchEvent(event);
        console.log('‚úÖ Event dispatched');
        return true;
      }
      return false;
    };

    // Complete debug function to test everything
    window.debugPDFIssue = function() {
      console.log('üîç === PDF DEBUGGING REPORT ===');

      // Check if button exists
      const pdfButton = document.getElementById('btnLoadPDF');
      console.log('1. Button exists:', !!pdfButton);

      if (pdfButton) {
        console.log('2. Button visible:', pdfButton.offsetParent !== null);
        console.log('3. Button enabled:', !pdfButton.disabled);
        console.log('4. Button HTML:', pdfButton.outerHTML);

        // Check if button is in modal
        const modal = document.querySelector('.modal.show');
        console.log('5. Modal open:', !!modal);

        if (modal) {
          const buttonInModal = modal.querySelector('#btnLoadPDF');
          console.log('6. Button in modal:', !!buttonInModal);
        }
      }

      // Check current receipt data
      console.log('7. Current receipt data:', !!currentReceiptForPDF);
      if (currentReceiptForPDF) {
        console.log('   Receipt ID:', currentReceiptForPDF._id);
        console.log('   Receipt Number:', currentReceiptForPDF.receiptNumber);
      }

      // Test PDF function directly
      console.log('8. Testing PDF function directly...');
      try {
        if (!currentReceiptForPDF) {
          console.log('   Creating test data...');
          currentReceiptForPDF = {
            _id: 'debug-test-id',
            receiptNumber: 'DEBUG-001',
            customer: { name: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Debug', phone: '0xx-xxx-xxxx' },
            product: { name: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö Debug', price: 1000 },
            amounts: { totalAmount: 1000, depositAmount: 300, remainingAmount: 700 }
          };
        }

        loadDepositReceiptPDF();
        console.log('‚úÖ PDF function executed successfully');
        return true;
      } catch (error) {
        console.error('‚ùå PDF function failed:', error);
        return false;
      }
    };

    console.log('‚úÖ PDF functionality initialized');
    console.log('üõ†Ô∏è Testing functions available:');
    console.log('  - testPDFFunction() - Test PDF with current data');
    console.log('  - checkPDFButton() - Check PDF button status');
    console.log('  - forcePDFLoad() - Force load PDF with sample data');
    console.log('  - clickPDFButton() - Manually click the PDF button');
    console.log('  - triggerPDFEvent() - Manually trigger PDF click event');

    // ===== ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô =====
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      let currentDepositAmount = 0;

      // Elements
      const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
      const mixedPaymentDetails = document.getElementById('mixedPaymentDetails');
      const cashAmountInput = document.getElementById('cashAmount');
      const transferAmountInput = document.getElementById('transferAmount');

      // Display elements
      const totalPayableAmount = document.getElementById('totalPayableAmount');
      const displayCashAmount = document.getElementById('displayCashAmount');
      const displayTransferAmount = document.getElementById('displayTransferAmount');
      const displayTotalAmount = document.getElementById('displayTotalAmount');

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          handlePaymentMethodChange(this.value);
        });
      });

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
      if (cashAmountInput) {
        cashAmountInput.addEventListener('input', function() {
          calculateMixedPayment();
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      function handlePaymentMethodChange(method) {
        console.log('üí≥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:', method);

        // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
        if (method === 'mixed') {
          mixedPaymentDetails.classList.remove('hidden');
          updateMixedPaymentDisplay();
        } else {
          mixedPaymentDetails.classList.add('hidden');
          clearMixedPaymentInputs();
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        updatePaymentMethodStyles(method);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      function calculateMixedPayment() {
        const cashAmount = parseFloat(cashAmountInput.value) || 0;
        const remainingAmount = Math.max(0, currentDepositAmount - cashAmount);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        transferAmountInput.value = remainingAmount.toFixed(2);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        updateMixedPaymentDisplay();

        console.log('üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°:', {
          totalDeposit: currentDepositAmount,
          cash: cashAmount,
          transfer: remainingAmount
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      function updateMixedPaymentDisplay() {
        const cashAmount = parseFloat(cashAmountInput.value) || 0;
        const transferAmount = parseFloat(transferAmountInput.value) || 0;
        const totalAmount = cashAmount + transferAmount;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        if (totalPayableAmount) totalPayableAmount.textContent = `‡∏ø${currentDepositAmount.toLocaleString()}`;
        if (displayCashAmount) displayCashAmount.textContent = `‡∏ø${cashAmount.toLocaleString()}`;
        if (displayTransferAmount) displayTransferAmount.textContent = `‡∏ø${transferAmount.toLocaleString()}`;
        if (displayTotalAmount) displayTotalAmount.textContent = `‡∏ø${totalAmount.toLocaleString()}`;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const isValid = Math.abs(totalAmount - currentDepositAmount) < 0.01;
        const summaryDiv = document.querySelector('#mixedPaymentDetails .bg-white.dark\\:bg-gray-800');
        if (summaryDiv) {
          if (isValid) {
            summaryDiv.classList.remove('border-red-300');
            summaryDiv.classList.add('border-green-300');
          } else {
            summaryDiv.classList.remove('border-green-300');
            summaryDiv.classList.add('border-red-300');
          }
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      function updatePaymentMethodStyles(selectedMethod) {
        const options = document.querySelectorAll('.payment-method-option');
        options.forEach(option => {
          const input = option.querySelector('input[type="radio"]');
          if (input && input.value === selectedMethod) {
            option.classList.add('border-2', 'shadow-md');
            if (selectedMethod === 'cash') {
              option.classList.add('border-green-500', 'bg-green-50');
            } else if (selectedMethod === 'transfer') {
              option.classList.add('border-blue-500', 'bg-blue-50');
            } else if (selectedMethod === 'mixed') {
              option.classList.add('border-purple-500', 'bg-purple-50');
            }
          } else {
            option.classList.remove('border-2', 'shadow-md', 'border-green-500', 'bg-green-50',
                                   'border-blue-500', 'bg-blue-50', 'border-purple-500', 'bg-purple-50');
          }
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      function clearMixedPaymentInputs() {
        if (cashAmountInput) cashAmountInput.value = '';
        if (transferAmountInput) transferAmountInput.value = '';
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
      window.updateDepositAmountForPayment = function(amount) {
        currentDepositAmount = amount;
        console.log('üí∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:', amount);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (selectedMethod && selectedMethod.value === 'mixed') {
          calculateMixedPayment();
        }
      };

      // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      const depositAmountInputs = document.querySelectorAll('#customDepositAmount, #downAmountDisplay');
      depositAmountInputs.forEach(input => {
        if (input.tagName === 'INPUT') {
          input.addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            window.updateDepositAmountForPayment(amount);
          });
        }
      });

      console.log('üí≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    });

  </script>

  <script>
    // ========== QUICK ACTIONS MENU ==========
    document.addEventListener('DOMContentLoaded', function() {
      const quickActionsBtn = document.getElementById('quickActionsBtn');
      const quickActionsDropdown = document.getElementById('quickActionsDropdown');

      if (quickActionsBtn && quickActionsDropdown) {
        // Toggle dropdown on button click
        quickActionsBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          const isHidden = quickActionsDropdown.classList.contains('hidden');

          if (isHidden) {
            // Show dropdown
            quickActionsDropdown.classList.remove('hidden');
            quickActionsBtn.querySelector('.bi-chevron-down').style.transform = 'rotate(180deg)';
            console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô');
          } else {
            // Hide dropdown
            quickActionsDropdown.classList.add('hidden');
            quickActionsBtn.querySelector('.bi-chevron-down').style.transform = 'rotate(0deg)';
            console.log('‚ùå ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô');
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!quickActionsBtn.contains(e.target) && !quickActionsDropdown.contains(e.target)) {
            quickActionsDropdown.classList.add('hidden');
            quickActionsBtn.querySelector('.bi-chevron-down').style.transform = 'rotate(0deg)';
          }
        });

        // Keyboard shortcut (Alt+M)
        document.addEventListener('keydown', function(e) {
          if (e.altKey && e.key === 'm') {
            e.preventDefault();
            quickActionsBtn.click();
            console.log('‚å®Ô∏è ‡πÉ‡∏ä‡πâ keyboard shortcut Alt+M');
          }
        });

        // Update branch info in dropdown
        const updateBranchInfo = () => {
          const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
          const branchName = localStorage.getItem('activeBranchName') || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà';

          if (dropdownBranchInfo) {
            dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branchName}`;
          }
        };

        // Initialize branch info
        updateBranchInfo();

        // Listen for branch changes
        window.addEventListener('storage', function(e) {
          if (e.key === 'activeBranchName') {
            updateBranchInfo();
          }
        });

        console.log('‚úÖ ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      } else {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô');
      }
    });
  </script>

  <script>
    // ========== TAX TYPE MANAGEMENT ==========
    /**
     * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ
     */
    function handleTaxTypeChange() {
      const taxType = document.querySelector('input[name="taxType"]:checked')?.value;
      const taxRateSection = document.getElementById('taxRateSection');
      const taxTypeDescription = document.getElementById('taxTypeDescription');

      console.log('üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ:', taxType);

      if (taxType === 'none') {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ - ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ
        taxRateSection.style.display = 'none';
        taxTypeDescription.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ (‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)';
      } else if (taxType === 'inclusive') {
        // ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ
        taxRateSection.style.display = 'block';
        taxTypeDescription.textContent = '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
      } else if (taxType === 'exclusive') {
        // ‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ
        taxRateSection.style.display = 'block';
        taxTypeDescription.textContent = '‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      handleTaxRateChange();
    }

    /**
     * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ
     */
    function handleTaxRateChange() {
      const taxRateInput = document.getElementById('taxRateInput');
      const taxRate = parseFloat(taxRateInput.value) || 0;

      // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ
      if (taxRate < 0) {
        taxRateInput.value = 0;
      } else if (taxRate > 100) {
        taxRateInput.value = 100;
      }

      console.log('üìä ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ:', taxRate + '%');

      // TODO: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      handleTaxTypeChange();
      console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    });
  </script>

</body>
</html>
