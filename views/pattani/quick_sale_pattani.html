<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô - ‡∏™‡∏≤‡∏Ç‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/js/activity-tracker.js"></script>
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    /* CSS Variables for Theme System */
    :root {
      /* Light Mode Colors */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-accent: #e2e8f0;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-tertiary: #718096;
      --text-inverse: #ffffff;
      --border-color: #e2e8f0;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --shadow-strong: rgba(0, 0, 0, 0.15);
      --emergency-primary: #ff3838;
      --emergency-secondary: #ff5555;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #3b82f6;
    }

    [data-theme="dark"] {
      /* Dark Mode Colors */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-accent: #475569;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --text-inverse: #0f172a;
      --border-color: #475569;
      --shadow-light: rgba(0, 0, 0, 0.3);
      --shadow-medium: rgba(0, 0, 0, 0.4);
      --shadow-strong: rgba(0, 0, 0, 0.6);
      --emergency-primary: #ff4757;
      --emergency-secondary: #ff6b7a;
      --success-color: #2dd4bf;
      --warning-color: #fbbf24;
      --error-color: #f87171;
      --info-color: #60a5fa;
    }

    /* Theme Toggle Button Styles */
    .theme-toggle-btn {
      position: relative;
      width: 40px;
      height: 40px;
      border: 2px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 18px;
    }

    .theme-toggle-btn:hover {
      background: var(--bg-tertiary);
      transform: scale(1.1);
      box-shadow: 0 4px 12px var(--shadow-medium);
    }

    [data-theme="dark"] .theme-icon-light {
      display: none;
    }

    [data-theme="dark"] .theme-icon-dark {
      display: block !important;
    }

    body {
      font-family: "Prompt", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* ===== CARD STYLES (‡∏à‡∏≤‡∏Å frontstore_pattani) ===== */
    .card {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      margin-bottom: 0.75rem !important;
      box-shadow: 0 1px 3px var(--shadow-light) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      color: var(--text-primary) !important;
    }

    .card:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 8px var(--shadow-medium) !important;
      border-color: var(--border-color) !important;
    }

    .emergency-header {
      background: var(--bg-secondary);
      backdrop-filter: blur(10px);
      border-bottom: 3px solid var(--emergency-primary);
      box-shadow: 0 2px 10px var(--shadow-light);
      transition: all 0.3s ease;
    }
    
    .quick-sale-form {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px var(--shadow-light);
      transition: all 0.2s ease;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      transition: all 0.2s ease;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-control:focus {
      border-color: var(--info-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Dark mode placeholder text */
    .form-control::placeholder {
      color: var(--text-tertiary);
    }
    
    .product-select-container {
      position: relative;
    }
    
    .product-select-container select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    
    .btn-emergency {
      background: linear-gradient(135deg, var(--info-color) 0%, #1d4ed8 100%);
      color: var(--text-inverse);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
    }

    .btn-emergency:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: var(--text-secondary);
      color: var(--text-inverse);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: var(--text-tertiary);
      transform: translateY(-1px);
    }
    
    .hidden { display: none !important; }

    /* Tab Styles */
    .tab-button {
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
    }

    .tab-button.active {
      border-bottom-color: var(--info-color);
      color: var(--info-color);
      background-color: var(--bg-tertiary);
    }

    .tab-button:hover {
      color: var(--text-primary);
      background-color: var(--bg-accent);
    }
    
    .tab-button:not(.active):hover {
      color: #374151;
      background-color: #f9fafb;
    }
    
    .tab-content {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .product-card {
      transition: all 0.2s ease;
      border-left: 4px solid #e5e7eb;
    }
    
    .product-card:hover {
      border-left-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .product-card.selected {
      border-left-color: #10b981;
      background-color: #f0fdf4;
    }

    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- LoadingSystem v2.0.0-inline -->
  <style>
    /* LoadingSystem v2.0.0-inline CSS */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    .loading-system-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-system-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-system-content {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .loading-system-overlay.active .loading-system-content {
      transform: scale(1);
    }

    [data-theme="dark"] .loading-system-content {
      background: #1a1a1a;
      color: white;
    }

    .loading-system-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #ff6b6b;
      border-radius: 50%;
      animation: loading-spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-system-spinner.dots {
      display: flex;
      gap: 4px;
      width: auto;
      height: auto;
      border: none;
      margin: 0 auto 1rem;
    }

    .loading-system-spinner.dots::before,
    .loading-system-spinner.dots::after,
    .loading-system-spinner.dots {
      content: '';
      width: 8px;
      height: 8px;
      background: #ff6b6b;
      border-radius: 50%;
      animation: loading-dots 1.4s ease-in-out infinite both;
    }

    .loading-system-spinner.dots::before { animation-delay: -0.32s; }
    .loading-system-spinner.dots::after { animation-delay: -0.16s; }

    .loading-system-spinner.pulse {
      border: none;
      background: #ff6b6b;
      animation: loading-pulse 2s ease-in-out infinite;
    }

    .loading-system-message {
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    [data-theme="dark"] .loading-system-message {
      color: #e5e7eb;
    }

    .loading-system-submessage {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    [data-theme="dark"] .loading-system-submessage {
      color: #9ca3af;
    }

    .loading-system-progress {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading-system-progress.visible {
      opacity: 1;
    }

    .loading-system-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #ee5a24);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .loading-system-progress-bar.animated {
      background: linear-gradient(90deg, #ff6b6b, #ee5a24, #ff6b6b);
      background-size: 200% 100%;
      animation: loading-progress 2s linear infinite;
    }

    @keyframes loading-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes loading-dots {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes loading-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes loading-progress {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Button Loading States */
    .btn.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
      cursor: not-allowed;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: loading-spin 1s linear infinite;
      color: white;
    }

    .btn.loading.loading-dots::after {
      display: none;
    }

    .btn.loading.loading-dots::before {
      content: '‚óè‚óè‚óè';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      animation: loading-pulse 1.5s ease-in-out infinite;
    }

    /* Emergency button loading enhancement */
    .btn-emergency.loading {
      background: linear-gradient(135deg, #ff9999 0%, #ff7777 100%);
    }
  </style>

  <script>
    // LoadingSystem v2.0.0-inline
    window.LoadingSystem = (function() {
      let activeLoadings = new Map();
      let globalConfig = {
        defaultSpinner: 'default',
        defaultDuration: 0,
        showProgress: false,
        autoProgress: false,
        theme: 'auto'
      };

      function generateId() {
        return 'loading_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      function createOverlay(options) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-system-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-system-content';
    
        // Spinner
        const spinner = document.createElement('div');
        spinner.className = `loading-system-spinner ${options.spinnerType || globalConfig.defaultSpinner}`;
        content.appendChild(spinner);
    
        // Message
        if (options.message) {
          const message = document.createElement('div');
          message.className = 'loading-system-message';
          message.textContent = options.message;
          content.appendChild(message);
        }
    
        // Sub message
        if (options.subMessage) {
          const subMessage = document.createElement('div');
          subMessage.className = 'loading-system-submessage';
          subMessage.textContent = options.subMessage;
          content.appendChild(subMessage);
        }
    
        // Progress bar
        if (options.showProgress) {
          const progressContainer = document.createElement('div');
          progressContainer.className = 'loading-system-progress';
    
          const progressBar = document.createElement('div');
          progressBar.className = 'loading-system-progress-bar';
    
          if (options.autoProgress) {
            progressBar.className += ' animated';
          }
    
          progressContainer.appendChild(progressBar);
          content.appendChild(progressContainer);
    
          // Show progress container
          setTimeout(() => {
            progressContainer.classList.add('visible');
          }, 100);
        }
    
        overlay.appendChild(content);
        return overlay;
      }

      function show(options = {}) {
        const id = generateId();
        const config = { ...globalConfig, ...options };
    
        const overlay = createOverlay(config);
        overlay.setAttribute('data-loading-id', id);
    
        document.body.appendChild(overlay);
    
        // Trigger animation
        setTimeout(() => {
          overlay.classList.add('active');
        }, 10);
    
        // Store reference
        activeLoadings.set(id, {
          overlay: overlay,
          startTime: Date.now(),
          config: config
        });
    
        // Auto hide if duration is set
        if (config.duration > 0) {
          setTimeout(() => {
            hide(id);
          }, config.duration);
        }
    
        return id;
      }

      function hide(id) {
        if (!activeLoadings.has(id)) {
          console.warn('LoadingSystem: Trying to hide non-existent loading with id:', id);
          return false;
        }
    
        const loading = activeLoadings.get(id);
        const overlay = loading.overlay;
    
        overlay.classList.remove('active');
    
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          activeLoadings.delete(id);
        }, 300);
    
        return true;
      }

      function updateMessage(id, newMessage, newSubMessage = null) {
        if (!activeLoadings.has(id)) {
          console.warn('LoadingSystem: Trying to update non-existent loading with id:', id);
          return false;
        }
    
        const loading = activeLoadings.get(id);
        const overlay = loading.overlay;
    
        const messageEl = overlay.querySelector('.loading-system-message');
        if (messageEl && newMessage) {
          messageEl.textContent = newMessage;
        }
    
        const subMessageEl = overlay.querySelector('.loading-system-submessage');
        if (subMessageEl && newSubMessage) {
          subMessageEl.textContent = newSubMessage;
        }
    
        return true;
      }

      function updateProgress(id, percentage) {
        if (!activeLoadings.has(id)) {
          console.warn('LoadingSystem: Trying to update progress for non-existent loading with id:', id);
          return false;
        }
    
        const loading = activeLoadings.get(id);
        const overlay = loading.overlay;
        const progressBar = overlay.querySelector('.loading-system-progress-bar');
    
        if (progressBar) {
          progressBar.style.width = Math.min(100, Math.max(0, percentage)) + '%';
          return true;
        }
    
        return false;
      }

      function completeProgress(id) {
        return new Promise((resolve) => {
          if (updateProgress(id, 100)) {
            setTimeout(() => {
              hide(id);
              resolve(true);
            }, 500);
          } else {
            hide(id);
            resolve(false);
          }
        });
      }

      function hideAll() {
        const ids = Array.from(activeLoadings.keys());
        ids.forEach(id => hide(id));
        return ids.length;
      }

      function isActive(id) {
        return activeLoadings.has(id);
      }

      function getActiveCount() {
        return activeLoadings.size;
      }

      function configure(newConfig) {
        globalConfig = { ...globalConfig, ...newConfig };
      }

      // Button loading helpers
      function showButtonLoading(buttonElement, options = {}) {
        if (!buttonElement) return null;
    
        const config = {
          spinnerType: options.spinnerType || 'default',
          preserveWidth: options.preserveWidth !== false,
          ...options
        };
    
        // Store original state
        const originalText = buttonElement.textContent;
        const originalHTML = buttonElement.innerHTML;
        const originalDisabled = buttonElement.disabled;
        const originalWidth = buttonElement.offsetWidth;
    
        // Apply loading state
        buttonElement.classList.add('loading');
        if (config.spinnerType === 'dots') {
          buttonElement.classList.add('loading-dots');
        }
    
        buttonElement.disabled = true;
    
        if (config.preserveWidth && originalWidth) {
          buttonElement.style.width = originalWidth + 'px';
        }
    
        const id = generateId();
        activeLoadings.set(id, {
          type: 'button',
          element: buttonElement,
          originalText,
          originalHTML,
          originalDisabled,
          originalWidth,
          config
        });
    
        return id;
      }

      function hideButtonLoading(id) {
        if (!activeLoadings.has(id)) {
          console.warn('LoadingSystem: Trying to hide non-existent button loading with id:', id);
          return false;
        }
    
        const loading = activeLoadings.get(id);
        if (loading.type !== 'button') {
          console.warn('LoadingSystem: ID does not correspond to button loading:', id);
          return false;
        }
    
        const element = loading.element;
    
        // Restore original state
        element.classList.remove('loading', 'loading-dots');
        element.disabled = loading.originalDisabled;
        element.style.width = '';
    
        activeLoadings.delete(id);
        return true;
      }

      // Public API
      return {
        show,
        hide,
        updateMessage,
        updateProgress,
        completeProgress,
        hideAll,
        isActive,
        getActiveCount,
        configure,
        showButtonLoading,
        hideButtonLoading,
        version: '2.0.0-inline'
      };
    })();

    // Safe Wrapper Functions
    function safeShowLoading(options = {}) {
      try {
        if (typeof window.LoadingSystem !== 'undefined' && typeof LoadingSystem.show === 'function') {
          return LoadingSystem.show(options);
        } else {
          console.warn('LoadingSystem not available, skipping loading display');
          return null;
        }
      } catch (error) {
        console.error('Error showing loading:', error);
        return null;
      }
    }

    function safeHideLoading(id) {
      try {
        if (id && typeof window.LoadingSystem !== 'undefined' && typeof LoadingSystem.hide === 'function') {
          return LoadingSystem.hide(id);
        }
        return false;
      } catch (error) {
        console.error('Error hiding loading:', error);
        return false;
      }
    }

    function safeUpdateMessage(id, message, subMessage = null) {
      try {
        if (id && typeof window.LoadingSystem !== 'undefined' && typeof LoadingSystem.updateMessage === 'function') {
          return LoadingSystem.updateMessage(id, message, subMessage);
        }
        return false;
      } catch (error) {
        console.error('Error updating loading message:', error);
        return false;
      }
    }

    function safeUpdateProgress(id, percentage) {
      try {
        if (id && typeof window.LoadingSystem !== 'undefined' && typeof LoadingSystem.updateProgress === 'function') {
          return LoadingSystem.updateProgress(id, percentage);
        }
        return false;
      } catch (error) {
        console.error('Error updating loading progress:', error);
        return false;
      }
    }

    function safeCompleteProgress(id) {
      try {
        if (id && typeof window.LoadingSystem !== 'undefined' && typeof LoadingSystem.completeProgress === 'function') {
          return LoadingSystem.completeProgress(id);
        }
        return Promise.resolve(false);
      } catch (error) {
        console.error('Error completing loading progress:', error);
        return Promise.resolve(false);
      }
    }

    // Enhanced button loading with multiple states
    function enhanceButtonWithLoading(buttonElement, options = {}) {
      if (!buttonElement) return;
    
      const originalClickHandler = buttonElement.onclick;
      let loadingId = null;
    
      buttonElement.onclick = async function(event) {
        if (loadingId) return; // Prevent double-click
    
        // Show loading
        loadingId = LoadingSystem.showButtonLoading(buttonElement, {
          spinnerType: options.spinnerType || 'default'
        });
    
        try {
          // Call original handler if it exists
          if (originalClickHandler) {
            await originalClickHandler.call(this, event);
          }
    
          // Show success state briefly
          if (options.showSuccess !== false) {
            safeUpdateMessage(loadingId, options.successMessage || '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            await new Promise(resolve => setTimeout(resolve, 800));
          }
    
        } catch (error) {
          console.error('Button action failed:', error);
    
          // Show error state briefly
          if (options.showError !== false) {
            safeUpdateMessage(loadingId, options.errorMessage || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            await new Promise(resolve => setTimeout(resolve, 1200));
          }
        } finally {
          // Hide loading
          if (loadingId) {
            LoadingSystem.hideButtonLoading(loadingId);
            loadingId = null;
          }
        }
      };
    }

    // ===============================
    // THEME MANAGEMENT SYSTEM
    // ===============================

    class ThemeManager {
      constructor() {
        this.currentTheme = this.getStoredTheme() || this.getSystemTheme();
        this.init();
      }

      init() {
        this.applyTheme(this.currentTheme);
        this.updateThemeIcon();
        // Listen for system theme changes
        if (window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (this.getStoredTheme() === null) {
              this.currentTheme = e.matches ? 'dark' : 'light';
              this.applyTheme(this.currentTheme);
              this.updateThemeIcon();
            }
          });
        }
      }

      getSystemTheme() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      }

      getStoredTheme() {
        try {
          return localStorage.getItem('theme-preference');
        } catch (e) {
          return null;
        }
      }

      setStoredTheme(theme) {
        try {
          if (theme === null) {
            localStorage.removeItem('theme-preference');
          } else {
            localStorage.setItem('theme-preference', theme);
          }
        } catch (e) {
          console.warn('Could not save theme preference');
        }
      }

      applyTheme(theme) {
        // üî• Apply theme to both html and body
        const htmlEl = document.documentElement;
        const bodyEl = document.body;

        if (theme === 'dark') {
          htmlEl.classList.add('dark');
          if (bodyEl) bodyEl.classList.add('dark');
        } else {
          htmlEl.classList.remove('dark');
          if (bodyEl) bodyEl.classList.remove('dark');
        }

        htmlEl.setAttribute('data-theme', theme);

        // Update meta theme-color for mobile browsers
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (metaThemeColor) {
          metaThemeColor.setAttribute('content', theme === 'dark' ? '#1e293b' : '#ffffff');
        } else {
          const meta = document.createElement('meta');
          meta.name = 'theme-color';
          meta.content = theme === 'dark' ? '#1e293b' : '#ffffff';
          document.head.appendChild(meta);
        }

        // Dispatch theme change event
        window.dispatchEvent(new CustomEvent('themeChanged', {
          detail: { theme, previousTheme: this.currentTheme, source: 'main' }
        }));
      }

      updateThemeIcon() {
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          const lightIcon = themeToggle.querySelector('.theme-icon-light');
          const darkIcon = themeToggle.querySelector('.theme-icon-dark');

          if (this.currentTheme === 'dark') {
            lightIcon?.classList.add('hidden');
            darkIcon?.classList.remove('hidden');
          } else {
            lightIcon?.classList.remove('hidden');
            darkIcon?.classList.add('hidden');
          }
        }
      }

      toggle() {
        const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        this.currentTheme = newTheme;
        this.setStoredTheme(newTheme);
        this.applyTheme(newTheme);
        this.updateThemeIcon();

        // üî• Sync with sidebar dark mode state
        this.syncWithSidebar();

        // Show toast notification
        if (typeof showToast === 'function') {
          const themeText = newTheme === 'dark' ? '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
          showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô${themeText}‡πÅ‡∏•‡πâ‡∏ß`, 'info');
        }
      }

      // üî• Sync theme with sidebar
      syncWithSidebar() {
        const isDark = this.currentTheme === 'dark';

        // Sync localStorage key that sidebar uses
        localStorage.setItem('darkMode', isDark.toString());

        // üî• Force update sidebar classes
        const htmlEl = document.documentElement;
        const bodyEl = document.body;
        if (isDark) {
          htmlEl.classList.add('dark');
          bodyEl.classList.add('dark');
        } else {
          htmlEl.classList.remove('dark');
          bodyEl.classList.remove('dark');
        }

        // Update sidebar button text if available
        const sidebarDarkModeLabel = document.getElementById('darkModeLabel');
        if (sidebarDarkModeLabel) {
          sidebarDarkModeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }

        // Update sidebar state if available
        if (typeof window.sidebarManager !== 'undefined' && window.sidebarManager.getSidebarState) {
          const sidebarState = window.sidebarManager.getSidebarState();
          sidebarState.isDarkMode = isDark;
        }

        // üî• Log for debugging
        console.log('üîÑ Main theme synced with sidebar:', isDark ? 'dark' : 'light');
      }

      getCurrentTheme() {
        return this.currentTheme;
      }
    }

    // Initialize theme manager
    window.themeManager = new ThemeManager();

    // Global theme toggle function
    function toggleTheme() {
      window.themeManager.toggle();

      // üî• Sync with sidebar theme if available
      if (typeof window.sidebarManager !== 'undefined') {
        const isDark = window.themeManager.currentTheme === 'dark';
        const sidebarDarkModeLabel = document.getElementById('darkModeLabel');
        if (sidebarDarkModeLabel) {
          sidebarDarkModeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
      }
    }

    // Auto theme function for system preference
    function setAutoTheme() {
      window.themeManager.currentTheme = window.themeManager.getSystemTheme();
      window.themeManager.setStoredTheme(null);
      window.themeManager.applyTheme(window.themeManager.currentTheme);
      window.themeManager.updateThemeIcon();
    }

    // üî• Listen for theme changes from sidebar
    window.addEventListener('themeChanged', function(event) {
      // Only update if the change came from sidebar
      if (event.detail && event.detail.source === 'sidebar') {
        const newTheme = event.detail.theme;
        console.log('üì° Main theme received sidebar change:', newTheme);

        if (window.themeManager.currentTheme !== newTheme) {
          console.log('üîÑ Updating main theme to:', newTheme);
          window.themeManager.currentTheme = newTheme;
          window.themeManager.setStoredTheme(newTheme);
          window.themeManager.applyTheme(newTheme);
          window.themeManager.updateThemeIcon();
        }
      }
    });

    console.log('üé® Theme Management System v2.0 initialized');
  </script>

</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <div id="toast" class="fixed top-4 right-4 p-4 rounded-lg text-white z-50 hidden"></div>

  <div id="sidebarContainer"></div>

  <header class="emergency-header p-4 flex items-center justify-between ml-56" id="mainHeader">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="btn btn-sm btn-ghost">
        <i class="bi bi-list text-xl" id="toggleIcon"></i>
      </button>
      <div class="relative">
        <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">LIVE</div>
        <h1 class="text-xl font-bold text-red-600 dark:text-red-400">
          <i class="bi bi-lightning-charge-fill"></i>
          ‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
        </h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤...</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <button id="themeToggle" class="theme-toggle-btn" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°">
        <i class="bi bi-sun-fill theme-icon-light"></i>
        <i class="bi bi-moon-fill theme-icon-dark hidden"></i>
      </button>
      <div class="text-right">
        <p class="text-sm font-medium" id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        <p class="text-xs text-gray-500 dark:text-gray-400" id="userRole">-</p>
      </div>
      <button onclick="goBack()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg">‡∏Å‡∏•‡∏±‡∏ö</button>
      <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>

  <div id="mainContent" class="ml-56 px-6 py-8 min-h-screen">
    <div class="container mx-auto max-w-4xl">
      <!-- Emergency Info Card -->
      <div class="card mb-6">
        <div class="text-center">
          <div class="text-4xl mb-4">‚ö°</div>
          <h2 class="text-xl font-semibold text-blue-600 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h2>
          <p class="text-gray-600 text-sm">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏≤‡∏ô PO ‡∏Å‡πà‡∏≠‡∏ô</p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏∞‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Product Image ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Backdated PO</p>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="card mb-6">
        <div class="flex border-b border-gray-200 dark:border-gray-700">
          <button id="addProductTab" class="tab-button flex-1 px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400" onclick="switchTab('addProduct')">
            <i class="bi bi-plus-circle mr-2"></i>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
          </button>
          <button id="approveProductTab" class="tab-button flex-1 px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" onclick="switchTab('approveProduct')">
            <i class="bi bi-check-circle mr-2"></i>
            ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span id="pendingCount" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
          </button>
        </div>
      </div>

      <!-- Add Product Tab Content -->
      <div id="addProductContent" class="tab-content">
      <div class="card">
        <div class="text-center mb-6">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô</h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>

        <form id="quickSaleForm">
          <div class="space-y-6">
            <!-- üî• Backdated Options -->
            <div class="mb-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
              <label class="flex items-center mb-3">
                <input type="checkbox" id="isBackdated" class="mr-2" onchange="toggleBackdatedOptions()">
                <span class="text-sm font-semibold text-yellow-700">
                  <i class="bi bi-clock-history text-yellow-600 mr-1"></i>
                  ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Backdated Entry)
                </span>
              </label>
              
              <div id="backdatedOptions" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">
                      <i class="bi bi-calendar-date text-yellow-600 mr-1"></i>
                      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                    </label>
                    <input type="date" id="backdatedDate" class="form-control" onchange="updateBackdatedInfo()">
                    <small class="text-yellow-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PO Number ‡πÅ‡∏•‡∏∞ Document Number</small>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">
                      <i class="bi bi-info-circle text-yellow-600 mr-1"></i>
                      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                    </label>
                    <div id="backdatedInfo" class="p-2 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded text-sm">
                      <div><strong>PO Number:</strong> <span id="previewPONumber">-</span></div>
                      <div><strong>Document Number:</strong> <span id="previewDocNumber">-</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">
                <i class="bi bi-upc-scan text-orange-500 mr-1"></i>
                IMEI/Serial Number <span class="text-red-500">*</span>
              </label>
              <input type="text" id="quickSaleIMEI" name="imei" class="form-control" required placeholder="123456789012345">
              <small class="text-gray-500 dark:text-gray-400">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (IMEI ‡∏´‡∏£‡∏∑‡∏≠ Serial Number)</small>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">
                <i class="bi bi-list-check text-blue-500 mr-1"></i>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß
              </label>
              <div class="product-select-container">
                <select id="registeredProductSelect" class="form-control mb-3">
                  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà --</option>
                </select>
              </div>
              <small class="text-gray-500 dark:text-gray-400">
                <i class="bi bi-info-circle mr-1"></i>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
              </small>
            </div>

            <!-- Divider -->
            <div class="flex items-center my-6">
              <div class="flex-1 border-t border-gray-300 dark:border-gray-600"></div>
              <span class="px-4 text-sm text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-900">‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</span>
              <div class="flex-1 border-t border-gray-300 dark:border-gray-600"></div>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">
                <i class="bi bi-tag text-green-500 mr-1"></i>
                ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input type="text" id="quickSaleProductName" name="productName" class="form-control" required placeholder="iPhone 15 Pro Max 256GB" autocomplete="off">
                <div id="productSuggestions" class="absolute top-full left-0 right-0 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-60 overflow-y-auto z-50 hidden shadow-lg"></div>
              </div>
              <small class="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏ß‡∏°‡∏£‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)</small>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">
                <i class="bi bi-award text-purple-500 mr-1"></i>
                ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå <span class="text-red-500">*</span>
              </label>
              <input type="text" id="quickSaleBrand" name="brand" class="form-control" required placeholder="Apple, Samsung, Huawei">
              <small class="text-gray-500">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-semibold mb-2">
                <i class="bi bi-collection text-blue-500 mr-1"></i>
                ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span>
              </label>
              <select id="quickSaleCategoryGroup" name="categoryGroup" class="form-control" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
              </select>
              <small class="text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
            </div>

            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">
                <i class="bi bi-sticky text-indigo-500 mr-1"></i>
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
              </label>
              <textarea id="quickSaleNote" name="note" class="form-control" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ"></textarea>
              <small class="text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
            </div>

            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å ProductImage (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
            <div id="productInfoSection" class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg hidden">
              <h4 class="font-medium text-blue-800 dark:text-blue-300 mb-2">
                <i class="bi bi-info-circle mr-1"></i>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
              </h4>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <strong class="text-green-600">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏î:</strong>
                  <span id="displayCashPrice" class="ml-2">-</span>
                </div>
                <div>
                  <strong class="text-purple-600">üì± ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô:</strong>
                  <span id="displayInstallmentPrice" class="ml-2">-</span>
                </div>
              </div>
              <div class="mt-2 text-xs text-blue-600">
                <i class="bi bi-lightbulb mr-1"></i>
                ‡∏£‡∏≤‡∏Ç‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö POS ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Backdated PO
              </div>
            </div>
          </div>

          <div class="flex gap-4">
            <button type="button" onclick="goBack()" class="flex-1 btn-secondary">
              <i class="bi bi-arrow-left mr-2"></i>
              ‡∏Å‡∏•‡∏±‡∏ö
            </button>
            <button type="submit" class="btn-emergency flex-1" id="submitBtn">
              <i class="bi bi-lightning-charge-fill mr-2"></i>
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
            </button>
          </div>
        </form>
      </div>
      </div> <!-- End Add Product Tab Content -->

      <!-- Approve Product Tab Content -->
      <div id="approveProductContent" class="tab-content hidden">
        <div class="card">
          <div class="text-center mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
              <i class="bi bi-check-circle text-green-500 mr-2"></i>
              ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô
            </h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
          </div>

          <!-- Search and Filter -->
          <div class="mb-4 flex gap-4">
            <div class="flex-1">
              <input type="text" id="approveSearchInput" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ IMEI ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
            </div>
            <button onclick="loadPendingProducts()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
              <i class="bi bi-arrow-clockwise mr-1"></i>
              ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
            <button onclick="debugPendingProducts()" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition">
              <i class="bi bi-bug mr-1"></i>
              Debug
            </button>
          </div>

          <!-- Debug Information -->
          <div id="debugInfo" class="hidden mb-4 p-4 bg-gray-100 dark:bg-gray-800 border dark:border-gray-600 rounded-lg">
            <h4 class="font-semibold mb-2">üîç Debug Information</h4>
            <div id="debugDetails" class="text-sm space-y-2 font-mono"></div>
          </div>

          <!-- Pending Products List -->
          <div id="pendingProductsList" class="space-y-4">
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="bi bi-hourglass-split text-4xl mb-2 block"></i>
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...
            </div>
          </div>

          <!-- Bulk Actions -->
          <div id="bulkActionsContainer" class="hidden mt-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <input type="checkbox" id="selectAllProducts" class="mr-2" onchange="toggleSelectAll()">
                <label for="selectAllProducts" class="text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                <span id="selectedCount" class="ml-4 text-sm text-gray-600 dark:text-gray-400">(0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
              </div>
              <div class="flex gap-2">
                <button onclick="bulkApprove()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition disabled:opacity-50" disabled>
                  <i class="bi bi-check-circle mr-1"></i>
                  ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
                <button onclick="bulkReject()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition disabled:opacity-50" disabled>
                  <i class="bi bi-x-circle mr-1"></i>
                  ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="hidden card mt-6">
        <div class="text-center">
          <div class="text-4xl text-green-500 mb-4">‚úÖ</div>
          <h3 class="text-lg font-semibold text-green-700 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
          <p class="text-green-600 mb-4 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
          <div class="flex gap-3 justify-center flex-wrap">
            <button onclick="resetForm()" class="px-4 py-2 btn-emergency text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å</button>
            <button onclick="goToBackdatedPO()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PO</button>
            <button onclick="goToPOS()" class="px-4 py-2 btn-secondary text-sm">‡πÑ‡∏õ POS</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global Variables
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');
    let registeredProducts = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß

    if (!BRANCH_CODE) {
      console.warn("Branch code not specified, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    console.log(`[quick_sale_pattani] Using branch code: ${BRANCH_CODE}`);

    // Utility Functions
    function generateCSRFToken() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      const token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      localStorage.setItem('csrfToken', token);
      return token;
    }

    function getCSRFToken() {
      return localStorage.getItem('csrfToken') || generateCSRFToken();
    }

    // Tab Management Functions
    function switchTab(tabName) {
      // Check permission for approve tab
      if (tabName === 'approveProduct') {
        const userRole = localStorage.getItem('userRole');
        if (!checkApproveTabPermission(userRole)) {
          showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
          return;
        }
      }
    
      // Hide all tab contents
      document.getElementById('addProductContent').classList.add('hidden');
      document.getElementById('approveProductContent').classList.add('hidden');
    
      // Remove active class from all tab buttons
      document.getElementById('addProductTab').classList.remove('active');
      document.getElementById('approveProductTab').classList.remove('active');
    
      // Show selected tab content and activate button
      if (tabName === 'addProduct') {
        document.getElementById('addProductContent').classList.remove('hidden');
        document.getElementById('addProductTab').classList.add('active');
      } else if (tabName === 'approveProduct') {
        document.getElementById('approveProductContent').classList.remove('hidden');
        document.getElementById('approveProductTab').classList.add('active');
        loadPendingProducts(); // Load pending products when switching to approve tab
      }
    }

    // Pending Products Management
    let pendingProducts = [];
    let selectedProducts = new Set();
    let recentlyProcessedProducts = new Set(); // üî• ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥

    async function loadPendingProducts() {
      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...',
        spinnerType: 'default'
      });

      try {
        const token = localStorage.getItem('authToken');
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API pending ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô branchStockRoutes.js
        const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }

        const data = await response.json();
        console.log('üì¶ Raw pending data:', data.data?.length || 0, 'items');
        console.log('üìã All products status check:', data.data.map(p => ({
          id: p._id,
          name: p.name,
          status: p.status,
          pending: p.pending,
          verified: p.verified
        })));
        console.log('üîç Current recentlyProcessedProducts cache:', Array.from(recentlyProcessedProducts));
    
        // üî• Enhanced filtering for Quick Sale products - ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debugging
        pendingProducts = data.data.filter(product => {
          // üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (recentlyProcessedProducts.has(product._id)) {
            console.log(`‚è≠Ô∏è Skipping recently processed product: ${product.name}`);
            return false;
          }
    
          const hasValidPO = product.poNumber && product.poNumber.startsWith('PO-');
          const hasValidDoc = (product.documentNumber === '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô' ||
                              (product.documentNumber && product.documentNumber.includes('‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô')) ||
                              product.documentNumber === '' || product.documentNumber === null);
          const isPending = product.pending === true || product.pending === undefined;
          const isNotVerified = product.verified === false || product.verified === undefined;
          const isCorrectBranch = product.branch_code === BRANCH_CODE;
          const isQuickSale = product.type === 'quick_sale' || product.urgentSale === true;
    
          // üî• ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ PO ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
          const isNotSentToPO = product.status !== 'sent_to_po' &&
                               product.status !== 'approved' &&
                               product.status !== 'completed' &&
                               product.pending !== false;
    
          // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PO Number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ PO
          const basicCriteria = hasValidPO && isCorrectBranch && isNotSentToPO;
    
          // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á
          const additionalCriteria = hasValidDoc || isPending || isNotVerified || isQuickSale;
    
          const passes = basicCriteria && additionalCriteria;
    
          console.log(`${passes ? '‚úÖ' : '‚ùå'} Product ${product.name}:`, {
            id: product._id,
            poNumber: product.poNumber,
            documentNumber: product.documentNumber,
            pending: product.pending,
            verified: product.verified,
            status: product.status,  // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏° status
            branch_code: product.branch_code,
            type: product.type,
            urgentSale: product.urgentSale,
            hasValidPO,
            hasValidDoc,
            isPending,
            isNotVerified,
            isCorrectBranch,
            isQuickSale,
            isNotSentToPO,  // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏° isNotSentToPO
            passes
          });
    
          return passes;
        });
    
        console.log(`üéØ Filtered ${pendingProducts.length} pending quick sale products for branch ${BRANCH_CODE}`);

        displayPendingProducts(pendingProducts);
        updatePendingCount(pendingProducts.length);

      } catch (error) {
        console.error('Error loading pending products:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        document.getElementById('pendingProductsList').innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="bi bi-exclamation-triangle text-4xl mb-2 block"></i>
            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </div>
        `;
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }

    function displayPendingProducts(products) {
      const container = document.getElementById('pendingProductsList');
    
      if (products.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="bi bi-check-circle text-4xl mb-2 block text-green-500"></i>
            <p class="text-lg font-medium">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
            <p class="text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
          </div>
        `;
        document.getElementById('bulkActionsContainer').classList.add('hidden');
        return;
      }

      container.innerHTML = products.map(product => {
        // üî• Enhanced display for backdated entries
        const isBackdated = product.documentNumber && product.documentNumber.includes('‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á');
        const backdatedClass = isBackdated ? 'border-l-yellow-500 bg-yellow-50' : 'border-l-blue-500';
        const backdatedIcon = isBackdated ? 'üïí' : '‚ö°';
    
        return `
        <div class="product-card card ${backdatedClass}" data-product-id="${product._id}">
          <div class="flex items-start gap-4">
            <input type="checkbox" class="product-checkbox mt-2" onchange="updateSelection('${product._id}', this.checked)">
            
            <div class="flex-1">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-semibold text-lg text-gray-800 dark:text-gray-200">
                    ${backdatedIcon} ${product.name}
                    ${isBackdated ? '<span class="ml-2 px-2 py-1 bg-yellow-200 text-yellow-800 text-xs rounded-full">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</span>' : ''}
                  </h4>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2 text-sm">
                    <div><strong>IMEI:</strong> ${product.imei}</div>
                    <div><strong>‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå:</strong> ${product.brand}</div>
                    <div><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ‡∏ø${product.price?.toLocaleString() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div><strong>PO:</strong> ${product.poNumber}</div>
                  </div>
                  <div class="mt-2 text-sm">
                    <div><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</strong> 
                      <span class="${isBackdated ? 'text-yellow-700 font-medium' : 'text-blue-700 font-medium'}">
                        ${product.documentNumber || '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô'}
                      </span>
                    </div>
                  </div>
                  <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(product.createdAt).toLocaleString('th-TH')}
                    ${product.quickSaleDate && product.quickSaleDate !== product.createdAt ?
                      `<br/>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${new Date(product.quickSaleDate).toLocaleString('th-TH')}` : ''}
                  </div>
                </div>
                
                <div class="flex gap-2 ml-4">
                  <button onclick="approveProduct('${product._id}')" 
                          class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition">
                    <i class="bi bi-check mr-1"></i>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                  </button>
                  <button onclick="rejectProduct('${product._id}')" 
                          class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition">
                    <i class="bi bi-x mr-1"></i>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      }).join('');

      document.getElementById('bulkActionsContainer').classList.remove('hidden');
    }

    function updatePendingCount(count) {
      const badge = document.getElementById('pendingCount');
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function updateSelection(productId, isSelected) {
      if (isSelected) {
        selectedProducts.add(productId);
      } else {
        selectedProducts.delete(productId);
      }
    
      updateSelectedCount();
      updateBulkActionButtons();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllProducts');
      const productCheckboxes = document.querySelectorAll('.product-checkbox');
    
      productCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const productId = checkbox.closest('.product-card').dataset.productId;
        if (selectAllCheckbox.checked) {
          selectedProducts.add(productId);
        } else {
          selectedProducts.delete(productId);
        }
      });
    
      updateSelectedCount();
      updateBulkActionButtons();
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = `(${selectedProducts.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    }

    function updateBulkActionButtons() {
      const hasSelection = selectedProducts.size > 0;
      document.querySelector('[onclick="bulkApprove()"]').disabled = !hasSelection;
      document.querySelector('[onclick="bulkReject()"]').disabled = !hasSelection;
    }

    async function approveProduct(productId) {
      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ PO System...',
        spinnerType: 'default'
      });

      try {
        const token = localStorage.getItem('authToken');
    
        // üî• ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ PO System
        const response = await fetch(`/api/branch-stock/${productId}/send-to-po`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCSRFToken()
          },
          body: JSON.stringify({
            approvedBy: localStorage.getItem('userId'),
            approvedByName: localStorage.getItem('userName'),
            approvedAt: new Date().toISOString(),
            note: '‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á PO (‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô)'
          })
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ PO ‡πÑ‡∏î‡πâ');
        }

        const result = await response.json();
        console.log(`‚úÖ [approveProduct] API Response:`, result);
    
        // üî• ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
        recentlyProcessedProducts.add(productId);
        console.log(`‚úÖ [approveProduct] Added ${productId} to recentlyProcessedProducts cache`);
        console.log(`üìä [approveProduct] Current cache size: ${recentlyProcessedProducts.size}`);
    
        showToast('‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ PO System ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
    
        // üî• ‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡πÅ‡∏Ñ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        showToast(
          `üìã PO Number: ${result.data?.poNumber || 'N/A'}\n` +
          `üìÑ Document: ${result.data?.documentNumber || 'N/A'}\n` +
          `üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤: ${result.data?.branch_code || BRANCH_CODE}\n` +
          `‚úÖ ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠`,
          'info',
          5000
        );
    
        // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const productCard = document.querySelector(`[data-product-id="${productId}"]`);
        if (productCard) {
          productCard.style.transition = 'opacity 0.3s, transform 0.3s';
          productCard.style.opacity = '0';
          productCard.style.transform = 'scale(0.9)';
          setTimeout(() => productCard.remove(), 300);
        }
    
        // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å selectedProducts
        if (selectedProducts.has(productId)) {
          selectedProducts.delete(productId);
          updateSelectedCount();
          updateBulkActionButtons();
        }
    
        // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó array ‡πÅ‡∏•‡∏∞ count
        pendingProducts = pendingProducts.filter(p => p._id !== productId);
        loadPendingProductsCount();
    
        // üî• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
        if (pendingProducts.length === 0) {
          document.getElementById('pendingProductsList').innerHTML = `
            <div class="text-center py-12">
              <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
              <p class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `;
        }
    
        // üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        setTimeout(async () => {
          console.log('[approveProduct] Verifying product status after approval...');
    
          try {
            const verifyResponse = await fetch(`/api/branch-stock/${productId}`, {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            });
    
            if (verifyResponse.ok) {
              const verifyData = await verifyResponse.json();
              console.log(`üîç [approveProduct] Product ${productId} current status:`, {
                pending: verifyData.data?.pending,
                verified: verifyData.data?.verified,
                status: verifyData.data?.status
              });
    
              // ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô pending: true ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              if (verifyData.data?.pending === true) {
                console.error('‚ö†Ô∏è [approveProduct] Product still shows as pending! Database update may have failed.');
                showToast('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
              }
            }
          } catch (error) {
            console.error('Error verifying product status:', error);
          }
    
          loadPendingProductsCount(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        }, 2000);
    
        // üî• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          recentlyProcessedProducts.delete(productId);
          console.log(`[approveProduct] Cleared cache for product ${productId}`);
        }, 5000);

      } catch (error) {
        console.error('Error sending product to PO:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ PO: ' + error.message, 'error');
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }

    async function rejectProduct(productId) {
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) {
        return;
      }

      const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...',
        spinnerType: 'default'
      });

      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/${productId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-CSRF-Token': getCSRFToken()
          }
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
        }

        // üî• ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß
        recentlyProcessedProducts.add(productId);
    
        showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    
        // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const productCard = document.querySelector(`[data-product-id="${productId}"]`);
        if (productCard) {
          productCard.style.transition = 'opacity 0.3s, transform 0.3s';
          productCard.style.opacity = '0';
          productCard.style.transform = 'scale(0.9)';
          setTimeout(() => productCard.remove(), 300);
        }
    
        // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏à‡∏≤‡∏Å selectedProducts
        if (selectedProducts.has(productId)) {
          selectedProducts.delete(productId);
          updateSelectedCount();
          updateBulkActionButtons();
        }
    
        // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó array ‡πÅ‡∏•‡∏∞ count
        pendingProducts = pendingProducts.filter(p => p._id !== productId);
        loadPendingProductsCount();
    
        // üî• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
        if (pendingProducts.length === 0) {
          document.getElementById('pendingProductsList').innerHTML = `
            <div class="text-center py-12">
              <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
              <p class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `;
        }
    
        // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        setTimeout(() => {
          console.log('[rejectProduct] Updating pending count after 1 second delay...');
          loadPendingProductsCount(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        }, 1000);
    
        // üî• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          recentlyProcessedProducts.delete(productId);
          console.log(`[rejectProduct] Cleared cache for product ${productId}`);
        }, 5000);

      } catch (error) {
        console.error('Error rejecting product:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ' + error.message, 'error');
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }

    async function bulkApprove() {
      if (selectedProducts.size === 0) return;
    
      if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${selectedProducts.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        return;
      }

      const loaderId = LoadingSystem.show({
        message: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${selectedProducts.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`,
        spinnerType: 'default'
      });

      let successCount = 0;
      let errorCount = 0;

      try {
        const token = localStorage.getItem('authToken');
    
        for (const productId of selectedProducts) {
          try {
            const response = await fetch(`/api/branch-stock/${productId}/send-to-po`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCSRFToken()
              },
              body: JSON.stringify({
                approvedBy: localStorage.getItem('userId'),
                approvedByName: localStorage.getItem('userName'),
                approvedAt: new Date().toISOString(),
                note: '‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á PO (‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô - Bulk)'
              })
            });

            if (response.ok) {
              successCount++;
              // üî• ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß
              recentlyProcessedProducts.add(productId);
              // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              const productCard = document.querySelector(`[data-product-id="${productId}"]`);
              if (productCard) {
                productCard.style.transition = 'opacity 0.3s, transform 0.3s';
                productCard.style.opacity = '0';
                productCard.style.transform = 'scale(0.9)';
                setTimeout(() => productCard.remove(), 300);
              }
              // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó array
              pendingProducts = pendingProducts.filter(p => p._id !== productId);
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error sending product ${productId} to PO:`, error);
            errorCount++;
          }
        }

        selectedProducts.clear();
        document.getElementById('selectAllProducts').checked = false;
        updateSelectedCount();
        updateBulkActionButtons();
    
        if (successCount > 0) {
          showToast(`‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ PO System ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
        }
        if (errorCount > 0) {
          showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ PO ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
        }
    
        // üî• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
        if (pendingProducts.length === 0) {
          document.getElementById('pendingProductsList').innerHTML = `
            <div class="text-center py-12">
              <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
              <p class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `;
        }
    
        // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        setTimeout(() => {
          console.log('[bulkApprove] Updating pending count after 1 second delay...');
          loadPendingProductsCount(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        }, 1000);
    
        // üî• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          selectedProducts.forEach(id => recentlyProcessedProducts.delete(id));
          console.log(`[bulkApprove] Cleared cache for processed products`);
        }, 5000);

      } catch (error) {
        console.error('Error in bulk send to PO:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ PO System', 'error');
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }

    async function bulkReject() {
      if (selectedProducts.size === 0) return;
    
      if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${selectedProducts.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
        return;
      }

      const loaderId = LoadingSystem.show({
        message: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${selectedProducts.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`,
        spinnerType: 'default'
      });

      let successCount = 0;
      let errorCount = 0;

      try {
        const token = localStorage.getItem('authToken');
    
        for (const productId of selectedProducts) {
          try {
            const response = await fetch(`/api/branch-stock/${productId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${token}`,
                'X-CSRF-Token': getCSRFToken()
              }
            });

            if (response.ok) {
              successCount++;
              // üî• ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß
              recentlyProcessedProducts.add(productId);
              // üî• ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              const productCard = document.querySelector(`[data-product-id="${productId}"]`);
              if (productCard) {
                productCard.style.transition = 'opacity 0.3s, transform 0.3s';
                productCard.style.opacity = '0';
                productCard.style.transform = 'scale(0.9)';
                setTimeout(() => productCard.remove(), 300);
              }
              // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó array
              pendingProducts = pendingProducts.filter(p => p._id !== productId);
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error rejecting product ${productId}:`, error);
            errorCount++;
          }
        }

        selectedProducts.clear();
        document.getElementById('selectAllProducts').checked = false;
        updateSelectedCount();
        updateBulkActionButtons();
    
        if (successCount > 0) {
          showToast(`‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
        }
        if (errorCount > 0) {
          showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
        }
    
        // üî• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
        if (pendingProducts.length === 0) {
          document.getElementById('pendingProductsList').innerHTML = `
            <div class="text-center py-12">
              <i class="bi bi-check-circle text-6xl text-green-500 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
              <p class="text-gray-500 dark:text-gray-400">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `;
        }
    
        // üî• ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        setTimeout(() => {
          console.log('[bulkReject] Updating pending count after 1 second delay...');
          loadPendingProductsCount(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        }, 1000);
    
        // üî• ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå cache ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          selectedProducts.forEach(id => recentlyProcessedProducts.delete(id));
          console.log(`[bulkReject] Cleared cache for processed products`);
        }, 5000);

      } catch (error) {
        console.error('Error in bulk reject:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', 'error');
      } finally {
        LoadingSystem.hide(loaderId);
      }
    }

    // Load pending products count only (for badge)
    async function loadPendingProductsCount() {
      // Check if user has permission to view approve tab
      const userRole = localStorage.getItem('userRole');
      if (!checkApproveTabPermission(userRole)) {
        // Don't load count if user doesn't have permission
        updatePendingCount(0);
        return;
      }
    
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          // üî• Enhanced filter for Quick Sale products - ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö loadPendingProducts
          const quickSaleCount = data.data.filter(product => {
            // üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (recentlyProcessedProducts.has(product._id)) {
              return false;
            }
    
            const hasValidPO = product.poNumber && product.poNumber.startsWith('PO-');
            const hasValidDoc = (product.documentNumber === '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô' ||
                                (product.documentNumber && product.documentNumber.includes('‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô')) ||
                                product.documentNumber === '' || product.documentNumber === null);
            const isPending = product.pending === true || product.pending === undefined;
            const isNotVerified = product.verified === false || product.verified === undefined;
            const isCorrectBranch = product.branch_code === BRANCH_CODE;
            const isQuickSale = product.type === 'quick_sale' || product.urgentSale === true;
    
            // üî• ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ PO ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            const isNotSentToPO = product.status !== 'sent_to_po' &&
                                 product.status !== 'approved' &&
                                 product.status !== 'completed' &&
                                 product.pending !== false;
    
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PO Number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ PO
            const basicCriteria = hasValidPO && isCorrectBranch && isNotSentToPO;
    
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á
            const additionalCriteria = hasValidDoc || isPending || isNotVerified || isQuickSale;
    
            return basicCriteria && additionalCriteria;
          }).length;

          updatePendingCount(quickSaleCount);
        }
      } catch (error) {
        console.error('Error loading pending products count:', error);
      }
    }

    // üîç Debug function for troubleshooting pending products
    async function debugPendingProducts() {
      const debugInfo = document.getElementById('debugInfo');
      const debugDetails = document.getElementById('debugDetails');
    
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }

        const data = await response.json();
        const allProducts = data.data || [];
    
        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const totalProducts = allProducts.length;
        const branchProducts = allProducts.filter(p => p.branch_code === BRANCH_CODE);
        const pendingProducts = allProducts.filter(p => p.pending === true);
        const unverifiedProducts = allProducts.filter(p => p.verified === false);
        const quickSaleProducts = allProducts.filter(p =>
          (p.type === 'quick_sale' || p.urgentSale === true) ||
          (p.documentNumber && p.documentNumber.includes('‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô'))
        );
        const poProducts = allProducts.filter(p => p.poNumber && p.poNumber.startsWith('PO-'));
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const recentProducts = allProducts
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 3);

        debugDetails.innerHTML = `
          <div class="grid grid-cols-2 gap-4">
            <div>
              <h5 class="font-semibold text-blue-600">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
              <div>‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalProducts} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div>‚Ä¢ ‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}: ${branchProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div>‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ pending: ${pendingProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div>‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà verified: ${unverifiedProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div>‚Ä¢ ‡∏°‡∏µ PO Number: ${poProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div>‚Ä¢ Quick Sale: ${quickSaleProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>
            
            <div>
              <h5 class="font-semibold text-green-600">üéØ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Filter</h5>
              <div>‚Ä¢ poNumber.startsWith('PO-'): ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ</div>
              <div>‚Ä¢ documentNumber includes '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô': ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ</div>
              <div>‚Ä¢ pending === true: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ</div>
              <div>‚Ä¢ verified === false: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ</div>
              <div>‚Ä¢ branch_code === '${BRANCH_CODE}': ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ</div>
            </div>
          </div>
          
          <div class="mt-4">
            <h5 class="font-semibold text-purple-600">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h5>
            ${recentProducts.map((product, index) => `
              <div class="mt-2 p-2 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded text-xs">
                <strong>#${index + 1}: ${product.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</strong><br/>
                <span class="text-gray-600 dark:text-gray-400">
                  IMEI: ${product.imei || '‡πÑ‡∏°‡πà‡∏°‡∏µ'} | 
                  PO: ${product.poNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ'} | 
                  Doc: ${product.documentNumber || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}<br/>
                  Branch: ${product.branch_code || '‡πÑ‡∏°‡πà‡∏°‡∏µ'} | 
                  Pending: ${product.pending} | 
                  Verified: ${product.verified} | 
                  Type: ${product.type || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}<br/>
                  Created: ${product.createdAt ? new Date(product.createdAt).toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}
                </span>
              </div>
            `).join('')}
          </div>
        `;
    
        debugInfo.classList.remove('hidden');
        showToast(`Debug: ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalProducts} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}: ${branchProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'info');
    
      } catch (error) {
        console.error('Debug error:', error);
        debugDetails.innerHTML = `<div class="text-red-600">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
        debugInfo.classList.remove('hidden');
      }
    }

    // Search function for approve tab
    function searchPendingProducts() {
      const searchTerm = document.getElementById('approveSearchInput').value.toLowerCase().trim();
    
      if (!searchTerm) {
        displayPendingProducts(pendingProducts);
        return;
      }
    
      const filtered = pendingProducts.filter(product =>
        product.imei.toLowerCase().includes(searchTerm) ||
        product.name.toLowerCase().includes(searchTerm) ||
        product.brand.toLowerCase().includes(searchTerm) ||
        product.poNumber.toLowerCase().includes(searchTerm)
      );
    
      displayPendingProducts(filtered);
    }

    // Setup search input listener
        function setupSearchListener() {
            const searchInput = document.getElementById('approveSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', searchPendingProducts);
            }
        }

        // Toggle advance options
        function toggleAdvanceOptions() {
            const advanceSection = document.getElementById('advanceOptions');
            const toggleButton = document.querySelector('[onclick="toggleAdvanceOptions()"]');
    
            if (advanceSection) {
                const isHidden = advanceSection.style.display === 'none';
                advanceSection.style.display = isHidden ? 'block' : 'none';
    
                if (toggleButton) {
                    toggleButton.textContent = isHidden ? 'üîΩ Advance Options' : 'üîº Advance Options';
                }
            }
        }

        // IMEI validation helper
        function validateIMEI(imei) {
            // Remove any non-digit characters
            const cleanIMEI = imei.replace(/\D/g, '');
    
            // Check length (15 digits for IMEI)
            if (cleanIMEI.length !== 15) {
                return false;
            }
    
            // Luhn algorithm validation
            let sum = 0;
            for (let i = 0; i < 14; i++) {
                let digit = parseInt(cleanIMEI[i]);
                if (i % 2 === 1) {
                    digit *= 2;
                    if (digit > 9) {
                        digit = Math.floor(digit / 10) + (digit % 10);
                    }
                }
                sum += digit;
            }
    
            const checkDigit = (10 - (sum % 10)) % 10;
            return checkDigit === parseInt(cleanIMEI[14]);
        }

        // Format IMEI for display
        function formatIMEI(imei) {
            const cleanIMEI = imei.replace(/\D/g, '');
            if (cleanIMEI.length === 15) {
                return cleanIMEI.replace(/(\d{6})(\d{2})(\d{6})(\d{1})/, '$1-$2-$3-$4');
            }
            return imei;
        }

        // Reset add product form
        function resetQuickSaleForm() {
            const form = document.getElementById('quickSaleForm');
            if (form) {
                form.reset();
    
                // Reset advance options to hidden
                const advanceSection = document.getElementById('advanceOptions');
                const toggleButton = document.querySelector('[onclick="toggleAdvanceOptions()"]');
    
                if (advanceSection) {
                    advanceSection.style.display = 'none';
                }
                if (toggleButton) {
                    toggleButton.textContent = 'üîº Advance Options';
                }
    
                // Clear any error messages
                const errorElements = form.querySelectorAll('.text-error');
                errorElements.forEach(el => el.textContent = '');
            }
        }

        // Utility function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB'
            }).format(amount);
        }

        // Utility function to format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // üî• Backdated Options Management
        function toggleBackdatedOptions() {
          const isBackdated = document.getElementById('isBackdated').checked;
          const backdatedOptions = document.getElementById('backdatedOptions');
          const backdatedDate = document.getElementById('backdatedDate');
    
          if (isBackdated) {
            backdatedOptions.classList.remove('hidden');
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            backdatedDate.value = todayString;
    
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            updateBackdatedInfo();
    
            showToast('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£', 'info');
          } else {
            backdatedOptions.classList.add('hidden');
            backdatedDate.value = '';
    
            // Clear preview
            document.getElementById('previewPONumber').textContent = '-';
            document.getElementById('previewDocNumber').textContent = '-';
    
            showToast('‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á - ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', 'info');
          }
        }

        // üî• Update backdated preview information
        async function updateBackdatedInfo() {
          const isBackdated = document.getElementById('isBackdated').checked;
          const backdatedDate = document.getElementById('backdatedDate').value;
    
          if (!isBackdated || !backdatedDate) {
            document.getElementById('previewPONumber').textContent = '-';
            document.getElementById('previewDocNumber').textContent = '-';
            return;
          }
    
          try {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á preview PO Number
            const selectedDate = new Date(backdatedDate);
            const buddhistYear = (selectedDate.getFullYear() + 543).toString().slice(-2);
            const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
            const day = selectedDate.getDate().toString().padStart(2, '0');
            const datePrefix = `${buddhistYear}${month}${day}`;
    
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PO Number ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
    
            let sequenceNumber = 1;
            if (response.ok) {
              const data = await response.json();
              const targetDatePOs = data.data.filter(product =>
                product.poNumber &&
                product.poNumber.startsWith(`PO-${datePrefix}-`)
              );
    
              if (targetDatePOs.length > 0) {
                const maxSequence = Math.max(...targetDatePOs.map(product => {
                  const parts = product.poNumber.split('-');
                  return parseInt(parts[2]) || 0;
                }));
                sequenceNumber = maxSequence + 1;
              }
            }
    
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á preview
            const previewPO = `PO-${datePrefix}-${sequenceNumber.toString().padStart(3, '0')}`;
            const previewDoc = `‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${buddhistYear}/${month}/${day}`;
    
            document.getElementById('previewPONumber').textContent = previewPO;
            document.getElementById('previewDocNumber').textContent = previewDoc;
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            showToast(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate.toLocaleDateString('th-TH')}`, 'success');
    
          } catch (error) {
            console.error('Error updating backdated info:', error);
            document.getElementById('previewPONumber').textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            document.getElementById('previewDocNumber').textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          }
        }

        // üî• Validation for backdated entries
        function validateBackdatedEntry() {
          const isBackdated = document.getElementById('isBackdated').checked;
          const backdatedDate = document.getElementById('backdatedDate').value;
    
          if (isBackdated) {
            if (!backdatedDate) {
              throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á');
            }
    
            const selectedDate = new Date(backdatedDate);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today
    
            if (selectedDate > today) {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ');
            }
    
            // Check if date is too far back (more than 1 year)
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    
            if (selectedDate < oneYearAgo) {
              const confirm = window.confirm('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏µ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
              if (!confirm) {
                throw new Error('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á');
              }
            }
          }
    
          return true;
        }

        // Clean up when page unloads
        window.addEventListener('beforeunload', function() {
            // Clean up any ongoing operations
            if (window.LoadingSystem) {
                window.LoadingSystem.hide();
            }
        });

    </script>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300 dark:bg-gray-800 text-base-content dark:text-gray-300 mt-8">
        <div>
            <p>¬© 2024 Quick Sale Management System - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô</p>
        </div>
    </footer>

    <script>
        // Toast notification function
        function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      toast.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${colors[type] || colors.info}`;
      toast.innerHTML = message;
      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    // Authentication
    async function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
        return false;
      }

      try {
        const response = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        const data = await response.json();
        if (data.success) {
          localStorage.setItem('userId', data.data._id);
          localStorage.setItem('userName', data.data.name);
          localStorage.setItem('userRole', data.data.role);
        
          document.getElementById('userName').textContent = data.data.name;
          document.getElementById('userRole').textContent = data.data.role;
        
          // Check role permissions for approve tab
          checkApproveTabPermission(data.data.role);
        
          return true;
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        localStorage.clear();
        window.location.href = '/login';
        return false;
      }
    }

    // Role-based access control for approve product tab
    function checkApproveTabPermission(userRole) {
      const allowedRoles = [
        'Admin',
        'admin',
        '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô',
        'Store Manager',
        '‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤',
        'Developer',
        'CEO',
        'Super Admin',
        'SuperAdmin',
        'super admin'
      ];

      const hasPermission = allowedRoles.some(role =>
        userRole.toLowerCase() === role.toLowerCase()
      );

      const approveTab = document.getElementById('approveProductTab');
      const approveContent = document.getElementById('approveProductContent');

      if (approveTab) {
        if (!hasPermission) {
          // Hide the tab if user doesn't have permission
          approveTab.style.display = 'none';
        
          // If approve tab is currently active, switch to add product tab
          if (approveTab.classList.contains('border-blue-500')) {
            switchTab('addProduct');
          }
        } else {
          // Show the tab if user has permission
          approveTab.style.display = 'block';
        }
      }

      // Also hide content if no permission
      if (approveContent && !hasPermission) {
        approveContent.style.display = 'none';
      }

      return hasPermission;
    }



    // üî• Enhanced PO Number Generator - ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ
    async function generatePONumber(customDate = null) {
      try {
        // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const targetDate = customDate ? new Date(customDate) : new Date();
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 2 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡πâ‡∏≤‡∏¢
        const buddhistYear = (targetDate.getFullYear() + 543).toString().slice(-2);
        
        // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô (‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10)
        const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
        const day = targetDate.getDate().toString().padStart(2, '0');
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á prefix ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const datePrefix = `${buddhistYear}${month}${day}`;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PO Number ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        let sequenceNumber = 1;
        let maxRetries = 5;
        
        if (response.ok) {
          const data = await response.json();
          // ‡∏´‡∏≤ PO Number ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PO-YYMMDD-xxx ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
          const targetDatePOs = data.data.filter(product =>
            product.poNumber &&
            product.poNumber.startsWith(`PO-${datePrefix}-`)
          );
        
          if (targetDatePOs.length > 0) {
            // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° 1
            const maxSequence = Math.max(...targetDatePOs.map(product => {
              const parts = product.poNumber.split('-');
              return parseInt(parts[2]) || 0;
            }));
            sequenceNumber = maxSequence + 1;
          }
        }
        
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î duplicate ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PO Number
        for (let retry = 0; retry < maxRetries; retry++) {
          const poNumber = `PO-${datePrefix}-${sequenceNumber.toString().padStart(3, '0')}`;
        
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ PO Number ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const duplicateCheck = await checkPONumberExists(poNumber);
          if (!duplicateCheck) {
            console.log(`üìã Generated PO Number: ${poNumber} (Date: ${targetDate.toDateString()})`);
            return poNumber;
          }
        
          sequenceNumber++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥
        }
        
        // Fallback with timestamp if all retries failed
        throw new Error('Unable to generate unique PO Number after retries');
        
      } catch (error) {
        console.error('Error generating PO Number:', error);
        // Enhanced fallback - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ PO Number
        const timestamp = Date.now().toString().slice(-8);
        const fallbackPO = `PO-EMERGENCY-${timestamp}`;
        console.warn(`Using emergency PO Number: ${fallbackPO}`);
        return fallbackPO;
      }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ PO Number ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÉ‡∏ä‡πâ pending API ‡πÅ‡∏ó‡∏ô)
    async function checkPONumberExists(poNumber) {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/pending?branch_code=${BRANCH_CODE}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const exists = data.data.some(product => product.poNumber === poNumber);
          console.log(`üîç Checking PO ${poNumber}: ${exists ? 'EXISTS' : 'NOT EXISTS'}`);
          return exists;
        }
        return false;
      } catch (error) {
        console.error('Error checking PO Number:', error);
        // Fallback - assume doesn't exist ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
        return false;
      }
    }

    // üî• Enhanced Document Number Generator - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
    function generateDocumentNumber(customDate = null, isBackdated = false) {
      try {
        const targetDate = customDate ? new Date(customDate) : new Date();
        const buddhistYear = (targetDate.getFullYear() + 543).toString().slice(-2);
        const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
        const day = targetDate.getDate().toString().padStart(2, '0');
        
        if (isBackdated) {
          return `‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${buddhistYear}/${month}/${day}`;
        } else {
          return `‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô ${buddhistYear}/${month}/${day}`;
        }
      } catch (error) {
        console.error('Error generating Document Number:', error);
        return '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô';
      }
    }

    // Quick Sale Functions
    async function handleQuickSale(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const originalHTML = submitBtn.innerHTML;
      let loadingId = null;
      let buttonLoadingId = null;

      try {
        // Enhanced loading with LoadingSystem v2.0.0
        loadingId = safeShowLoading({
          message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô...',
          subMessage: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö',
          showProgress: true,
          spinnerType: 'default'
        });
        
        buttonLoadingId = LoadingSystem.showButtonLoading(submitBtn, {
          spinnerType: 'default'
        });
        
        // Get current user info
        const currentUser = {
          id: localStorage.getItem('userId'),
          name: localStorage.getItem('userName') || '‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
          role: localStorage.getItem('userRole') || 'staff'
        };

        const formData = {
          imei: document.getElementById('quickSaleIMEI').value.trim(),
          name: document.getElementById('quickSaleProductName').value.trim(),
          brand: document.getElementById('quickSaleBrand').value.trim(),
          categoryGroup: document.getElementById('quickSaleCategoryGroup').value,
          note: document.getElementById('quickSaleNote').value.trim(),
          createdBy: currentUser,
          createdAt: new Date().toISOString()
        };
        
        // Enhanced Validation with progress tracking
        safeUpdateMessage(loadingId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        safeUpdateProgress(loadingId, 20);
        
        if (!formData.imei || !formData.name || !formData.brand || !formData.categoryGroup) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (IMEI, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå, ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)');
        }
        
        if (formData.imei.length < 5) {
          throw new Error('IMEI/Serial Number ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
        }

        // üî• Validate backdated entry
        safeUpdateMessage(loadingId, '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á...', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á');
        validateBackdatedEntry();
        
        safeUpdateProgress(loadingId, 40);
        safeUpdateMessage(loadingId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á...', '‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
        
        // Call API ‡πÑ‡∏õ‡∏ó‡∏µ‡πà branchStockRoutes.js
        const token = localStorage.getItem('authToken');
        
        // üî• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Backdated ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const isBackdated = document.getElementById('isBackdated').checked;
        const backdatedDate = isBackdated ? document.getElementById('backdatedDate').value : null;
        
        let targetDate = null;
        if (isBackdated && backdatedDate) {
          targetDate = backdatedDate;
          console.log(`üïí Using backdated entry for date: ${backdatedDate}`);
        }

        // üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PO Number - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)
        safeUpdateMessage(loadingId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PO Number...', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PO');
        safeUpdateProgress(loadingId, 60);
        
        const uniquePoNumber = await generatePONumber(targetDate);
        if (!uniquePoNumber || uniquePoNumber.length < 5) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PO Number ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }

        // üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Document Number ‡πÅ‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ
        const documentNumber = generateDocumentNumber(targetDate, isBackdated);
        if (!documentNumber) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Document Number ‡πÑ‡∏î‡πâ');
        }

        console.log(`üìã Final Numbers - PO: ${uniquePoNumber}, Doc: ${documentNumber}, Backdated: ${isBackdated}`);

        safeUpdateMessage(loadingId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö...', `PO: ${uniquePoNumber}`);
        safeUpdateProgress(loadingId, 80);
        
        const response = await fetch('/api/branch-stock', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token,
            'X-CSRF-Token': getCSRFToken()
          },
          body: JSON.stringify({
            // Basic product info
            imei: formData.imei,
            name: formData.name,
            brand: formData.brand,
            category: formData.categoryGroup,
            note: formData.note,
        
            // System info
            branch_code: BRANCH_CODE,
            urgentSale: true,
            type: 'quick_sale', // ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quick sale
            status: 'active', // Use valid enum value
        
            // User info
            createdBy: formData.createdBy.id,
            addedBy: formData.createdBy.id,
            addedByName: formData.createdBy.name,
        
            // Additional fields for compatibility
            taxType: '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ',
            stockType: 'imei',
            productType: 'mobile',
            verified: false,
            pending: true, // ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            supplier: null, // ‡πÑ‡∏°‡πà‡∏°‡∏µ supplier ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quick Sale
        
            // üî• Enhanced Quick Sale specific fields - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ
            poNumber: uniquePoNumber, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
            documentNumber: documentNumber, // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ
            stock_value: 1, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            price: 0, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            cost: 0, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            purchasePrice: 0, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tracking
            quickSaleDate: new Date().toISOString(),
            requiresPONumber: true // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏µ PO Number
          })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô IMEI ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          if (result.code === 'DUPLICATE_IMEI_IN_BRANCH' && result.existingProduct) {
            const existingInfo = result.existingProduct;
            const confirmMsg = `IMEI ${formData.imei} ‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß:\n\n` +
                              `‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${existingInfo.name}\n` +
                              `‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${existingInfo.brand}\n` +
                              `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${existingInfo.status}\n\n` +
                              `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö POS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
        
            if (confirm(confirmMsg)) {
              // ‡∏ô‡∏≥‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ POS ‡πÇ‡∏î‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ
              const posUrl = `/views/pattani/frontstore_pattani.html?branch=${BRANCH_CODE}&search=${formData.imei}`;
              window.location.href = posUrl;
              return;
            }
          }
        
          // üî• Enhanced error handling for PO Number issues
          if (result.error && result.error.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö PurchaseOrder')) {
            const errorMessage = `
              ‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Backend Configuration:
              
              Backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Quick Sale ‡πÉ‡∏´‡∏°‡πà
              ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PurchaseOrder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PO Number: ${uniquePoNumber}
              
              üîß ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
              1. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Backend ‡πÉ‡∏´‡πâ skip validation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quick Sale
              2. ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á PO ‡πÉ‡∏ô Backdated PO ‡∏Å‡πà‡∏≠‡∏ô
              
              üìã PO Number ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: ${uniquePoNumber}
              üìÑ Document Number: ${documentNumber}
            `;
        
            console.error('üö® Backend Configuration Issue:', {
              poNumber: uniquePoNumber,
              documentNumber: documentNumber,
              error: result.error,
              solution: 'Backend needs to skip PO validation for Quick Sale'
            });
        
            throw new Error(errorMessage);
          }
        
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
        }
        
        // Success with enhanced feedback
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô Backdated PO', 'success');
        document.getElementById('quickSaleForm').style.display = 'none';
        document.getElementById('successMessage').classList.remove('hidden');
        
        // Update pending count after adding new product
        await loadPendingProductsCount();
        
        // Update success message with enhanced info
        const successMsg = document.querySelector('#successMessage h3');
        if (successMsg) {
          successMsg.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        }
        const successDesc = document.querySelector('#successMessage p');
        if (successDesc) {
          successDesc.innerHTML = `
            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß<br>
            <strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong> ‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PO ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå<br>
            <small class="text-blue-500">ÔøΩ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏à‡∏∞‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Product Image</small>
          `;
        }
        
        // Add success animation delay
        await new Promise(resolve => setTimeout(resolve, 800));
        
              } catch (err) {
          console.error('Quick sale error:', err);
          safeUpdateMessage(loadingId, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
          await new Promise(resolve => setTimeout(resolve, 1500));
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        } finally {
          // Hide both loading states
          if (buttonLoadingId) {
            LoadingSystem.hideButtonLoading(buttonLoadingId);
          }
          if (loadingId) {
            safeHideLoading(loadingId);
          }
        }
    }

    function resetForm() {
      document.getElementById('quickSaleForm').reset();
      document.getElementById('registeredProductSelect').value = '';
      document.getElementById('quickSaleForm').style.display = 'block';
      document.getElementById('successMessage').classList.add('hidden');

      // ‡∏ã‡πà‡∏≠‡∏ô product info section
      document.getElementById('productInfoSection').classList.add('hidden');
      // ‡∏ã‡πà‡∏≠‡∏ô product suggestions
      document.getElementById('productSuggestions').classList.add('hidden');

      // üî• Reset backdated options
      document.getElementById('isBackdated').checked = false;
      document.getElementById('backdatedOptions').classList.add('hidden');
      document.getElementById('backdatedDate').value = '';
      document.getElementById('previewPONumber').textContent = '-';
      document.getElementById('previewDocNumber').textContent = '-';

      showToast('‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', 'info');
    }

    // Navigation Functions
    function goBack() {
      const branchCode = urlParams.get('branch') || localStorage.getItem('branchCode') || 'PATTANI';
      const branchName = urlParams.get('name') || '';
      const url = new URL('Addproduct_pattani.html', window.location.href);
      url.searchParams.set('branch', branchCode);
      if (branchName) {
        url.searchParams.set('name', branchName);
      }
      window.location.href = url.toString();
    }

    function goToPOS() {
      const branchCode = urlParams.get('branch') || localStorage.getItem('branchCode') || 'PATTANI';
      window.location.href = `/views/pattani/frontstore_pattani.html?branch=${branchCode}`;
    }

    function goToBackdatedPO() {
      // ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ backdated purchase order ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PO
      const branchCode = urlParams.get('branch') || localStorage.getItem('branchCode') || 'PATTANI';
      window.location.href = `/views/Stock/backdated_purchase_order.html?branch=${branchCode}&from=quick_sale`;
    }



    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const mainHeader = document.getElementById('mainHeader');
      const toggleIcon = document.getElementById('toggleIcon');

      if (sidebar) {
        sidebar.classList.toggle('-translate-x-full');
        mainContent.classList.toggle('sidebar-collapsed');
        mainHeader.classList.toggle('sidebar-collapsed');
        
        if (sidebar.classList.contains('-translate-x-full')) {
          toggleIcon.classList.remove('bi-x');
          toggleIcon.classList.add('bi-list');
        } else {
          toggleIcon.classList.remove('bi-list');
          toggleIcon.classList.add('bi-x');
        }
      }
    }

    async function logout() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login';
    }

    // Load Registered Products
    async function loadRegisteredProducts() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        console.log('üîç Loading registered products from ProductImage...');
        
        const response = await fetch('/api/product-image?limit=1000', {
          headers: {
            'Authorization': 'Bearer ' + token,
            'X-CSRF-Token': getCSRFToken()
          }
        });

        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
          registeredProducts = result.data.filter(product =>
            product.name && product.brand &&
            (product.productType === 'mobile' || product.productType === 'accessory' ||
             product.productType === 'gift' || !product.productType)
          );

          console.log(`üì± Loaded ${registeredProducts.length} registered products`);
        
          // Populate dropdown
          const select = document.getElementById('registeredProductSelect');
          select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà --</option>';
        
          // Group by brand and sort
          const brandGroups = {};
          registeredProducts.forEach(product => {
            const brand = product.brand || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå';
            if (!brandGroups[brand]) {
              brandGroups[brand] = [];
            }
            brandGroups[brand].push(product);
          });

          // Sort brands (Apple first, then Samsung, then alphabetical)
          const sortedBrands = Object.keys(brandGroups).sort((a, b) => {
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
        
            // Apple ‡∏Å‡πà‡∏≠‡∏ô
            if (aLower.includes('apple') || aLower.includes('iphone') || aLower.includes('ipad')) {
              if (!(bLower.includes('apple') || bLower.includes('iphone') || bLower.includes('ipad'))) return -1;
            }
            if (bLower.includes('apple') || bLower.includes('iphone') || bLower.includes('ipad')) {
              if (!(aLower.includes('apple') || aLower.includes('iphone') || aLower.includes('ipad'))) return 1;
            }
        
            // Samsung ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á
            if (aLower.includes('samsung') && !bLower.includes('samsung') &&
                !(bLower.includes('apple') || bLower.includes('iphone') || bLower.includes('ipad'))) return -1;
            if (bLower.includes('samsung') && !aLower.includes('samsung') &&
                !(aLower.includes('apple') || aLower.includes('iphone') || aLower.includes('ipad'))) return 1;
        
            return a.localeCompare(b, 'th');
          });

          // Create optgroups
          sortedBrands.forEach(brand => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = `${brand} (${brandGroups[brand].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        
            brandGroups[brand]
              .sort((a, b) => a.name.localeCompare(b.name, 'th'))
              .forEach(product => {
                const option = document.createElement('option');
                option.value = product._id;
                option.textContent = product.name;
                option.dataset.brand = product.brand;
                option.dataset.name = product.name;
                optgroup.appendChild(option);
              });
        
            select.appendChild(optgroup);
          });

        } else {
          console.warn('‚ö†Ô∏è Failed to load registered products:', result);
        }
      } catch (err) {
        console.error('‚ùå Error loading registered products:', err);
      }
    }

    // Handle registered product selection
    function handleRegisteredProductSelection() {
      const select = document.getElementById('registeredProductSelect');
      const productNameInput = document.getElementById('quickSaleProductName');
      const brandInput = document.getElementById('quickSaleBrand');

      select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (this.value && selectedOption.dataset.name && selectedOption.dataset.brand) {
          // Fill in the form with selected product data
          productNameInput.value = selectedOption.dataset.name;
          brandInput.value = selectedOption.dataset.brand;
        
          // Visual feedback
          productNameInput.style.backgroundColor = '#f0f9ff';
          brandInput.style.backgroundColor = '#f0f9ff';
        
          setTimeout(() => {
            productNameInput.style.backgroundColor = '';
            brandInput.style.backgroundColor = '';
          }, 1000);
        
          showToast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${selectedOption.dataset.name}`, 'success');
        }
      });

      // Clear selection if user modifies the inputs
      [productNameInput, brandInput].forEach(input => {
        input.addEventListener('input', function() {
          if (select.value) {
            select.value = '';
          }
        });
      });
    }
    // Branch Functions
    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        
        const res = await fetch(`/api/branch`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-CSRF-Token': getCSRFToken()
          }
        });
        
        const js = await res.json();
        if (res.ok && js.success) {
          const branch = js.data.find(b => b.branch_code === BRANCH_CODE);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} ‚Äî ${branch.address}`;
            document.title = `‡∏Ç‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô - ${branch.name}`;

            localStorage.setItem('branchCode', branch.branch_code);
            localStorage.setItem('branchName', branch.name);
        
            return;
          }
        }
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤');
      } catch (err) {
        console.error('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
      }
    }

    // üî• ProductImage Autocomplete Functionality
    let productImageData = [];
    let searchTimeout;

    async function loadProductImages() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/product-image?limit=1000', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        const result = await response.json();
        if (result.status === 'success') {
          productImageData = result.data || [];
          console.log(`Loaded ${productImageData.length} ProductImages for autocomplete`);
        }
      } catch (err) {
        console.error('Error loading ProductImages:', err);
      }
    }

    // Load category groups from API
    async function loadCategoryGroups() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/category-group', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (response.ok) {
          const result = await response.json();
          const categoryGroups = result.data || [];
        
          const selectElement = document.getElementById('quickSaleCategoryGroup');
          selectElement.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        
          categoryGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group._id;
            option.textContent = group.name;
            selectElement.appendChild(option);
          });
        
          console.log(`[quick_sale_pattani] Loaded ${categoryGroups.length} category groups`);
        }
      } catch (error) {
        console.error('Error loading category groups:', error);
        // Add default options if API fails
        const selectElement = document.getElementById('quickSaleCategoryGroup');
        selectElement.innerHTML = `
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
          <option value="‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠">‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</option>
          <option value="‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
          <option value="‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°">‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        `;
      }
    }

    function setupProductAutocomplete() {
      const productNameInput = document.getElementById('quickSaleProductName');
      const brandInput = document.getElementById('quickSaleBrand');
      const suggestions = document.getElementById('productSuggestions');

      productNameInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const query = this.value.trim().toLowerCase();
        
          if (query.length < 2) {
            suggestions.classList.add('hidden');
            return;
          }
        
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ProductImage ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          const matches = productImageData.filter(item =>
            item.name.toLowerCase().includes(query) ||
            item.brand.toLowerCase().includes(query)
          ).slice(0, 10); // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
        
          if (matches.length === 0) {
            suggestions.classList.add('hidden');
            return;
          }
        
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á suggestion list ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
          suggestions.innerHTML = matches.map(item => {
            const cashPrice = item.price || 0;
            const installmentPrice = item.pricePayOff || (cashPrice + 2590);
            const purchaseTypeStr = Array.isArray(item.purchaseType) ? item.purchaseType.join(', ') : '';
            const purchaseTypeJson = JSON.stringify(item.purchaseType || []).replace(/"/g, '&quot;');
        
            // Safely escape all text values for HTML
            const safeName = (item.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeBrand = (item.brand || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeProductType = (item.productType || 'N/A').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeStockType = (item.stockType || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
            return `
            <div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0" 
                 onclick="selectProduct('${item._id}', '${safeName}', '${safeBrand}', ${cashPrice}, ${installmentPrice}, '${purchaseTypeJson}', '${safeProductType}', '${safeStockType}')">
              <div class="font-semibold text-gray-800 dark:text-gray-200">${item.name || ''}</div>
              <div class="text-sm text-gray-600">
                <span class="mr-4">üè∑Ô∏è ${item.brand || 'N/A'}</span>
                <span class="mr-4">üí∞ ‡∏™‡∏î: ${cashPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                <span class="mr-4">üì± ‡∏ú‡πà‡∏≠‡∏ô: ${installmentPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                <span class="mr-4">üì± ${item.productType || 'N/A'}</span>
                <span class="text-green-600">${purchaseTypeStr}</span>
              </div>
            </div>
          `;
          }).join('');
        
          suggestions.classList.remove('hidden');
        }, 300);
      });

      // ‡∏ã‡πà‡∏≠‡∏ô suggestions ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
      document.addEventListener('click', function(e) {
        if (!productNameInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.classList.add('hidden');
        }
      });
    }

    function selectProduct(id, name, brand, cashPrice, installmentPrice, purchaseTypeJson, productType, stockType) {
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('quickSaleProductName').value = name;
      document.getElementById('quickSaleBrand').value = brand;

      // Parse purchaseType from JSON string
      let purchaseType = [];
      try {
        purchaseType = JSON.parse(purchaseTypeJson.replace(/&quot;/g, '"')) || [];
      } catch (e) {
        console.warn('Failed to parse purchaseType:', e);
      }

      // ‡∏ã‡πà‡∏≠‡∏ô suggestions
      document.getElementById('productSuggestions').classList.add('hidden');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô Product Info Section
      const productSection = document.getElementById('productInfoSection');
      const cashPriceDisplay = document.getElementById('displayCashPrice');
      const installmentPriceDisplay = document.getElementById('displayInstallmentPrice');

      if (cashPrice > 0 || installmentPrice > 0) {
        cashPriceDisplay.textContent = cashPrice > 0 ? `${cashPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó` : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
        installmentPriceDisplay.textContent = installmentPrice > 0 ? `${installmentPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó` : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
        productSection.classList.remove('hidden');
      } else {
        productSection.classList.add('hidden');
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Toast
      showToast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${name} (${brand})<br/>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏î: ${cashPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br/>üì± ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô: ${installmentPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó`, 'success');

      console.log('Selected ProductImage:', {
        id, name, brand,
        cashPrice,
        installmentPrice,
        purchaseType,
        productType,
        stockType
      });
    }

    // Initialization
    document.addEventListener('DOMContentLoaded', async function() {
      showLoading(true);

      try {
        if (!localStorage.getItem('csrfToken')) {
          generateCSRFToken();
        }
        
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;
        
        await loadBranchInfo();
        
        // Load category groups for dropdown
        await loadCategoryGroups();
        
        // Load registered products for dropdown
        await loadRegisteredProducts();
        
        // üî• Load ProductImages for autocomplete
        await loadProductImages();
        
        // Setup registered product selection handler
        handleRegisteredProductSelection();
        
        // üî• Setup ProductImage autocomplete
        setupProductAutocomplete();
        
        // Setup form listener
        document.getElementById('quickSaleForm').addEventListener('submit', handleQuickSale);
        
        // Load pending products count for the badge
        await loadPendingProductsCount();
        
        // Setup search listener for approve tab
        setupSearchListener();
        
        if (typeof initializeSidebar === 'function') {
          initializeSidebar();
        }
        
      } catch (err) {
        console.error('Initialization error:', err);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + err.message, 'error');
      } finally {
        setTimeout(() => showLoading(false), 800);
      }
    });

    // Show/Hide Loading with Lottie animation
    let lottieAnimation = null;
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Lottie animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });

    </script>

</body>
</html>
