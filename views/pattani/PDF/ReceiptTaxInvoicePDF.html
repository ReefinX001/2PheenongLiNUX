<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Language" content="th">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <title>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</title>

    <!-- Force UTF-8 encoding for all text content -->
    <script>
        document.documentElement.setAttribute('lang', 'th');
        if (document.characterSet !== 'UTF-8') {
            console.warn('Document charset is not UTF-8:', document.characterSet);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', 'Noto Sans Thai', 'TH Sarabun New', 'THSarabun', sans-serif;
            background: #FFFFFF;
            padding: 40px;
            color: #000000;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: #FFFFFF;
            margin: 0 auto;
            padding: 0;
            box-shadow: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            position: relative;
        }

        .logo {
            width: 145px;
            height: auto;
        }

        .company-info {
            flex: 1;
            text-align: left;
            padding: 0 20px;
        }

        .company-name {
            font-size: 14px;
            font-weight: bold;
            color: #222222;
            margin-bottom: 8px;
        }

        .company-details {
            font-size: 10px;
            color: #222222;
            line-height: 1.4;
        }

        .document-title {
            position: absolute;
            top: 30px;
            right: 0;
            text-align: right;
            color: #3498DB;
        }

        .document-title h1 {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .info-column label {
            display: block;
            font-size: 10px;
            color: #555555;
            margin-bottom: 5px;
        }

        .info-column .value {
            font-size: 10px;
            color: #000000;
            font-weight: 500;
        }

        .items-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .items-table thead {
            background: #3498DB;
            color: #FFFFFF;
        }

        .items-table th {
            padding: 8px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            border-bottom: 1px solid #CCCCCC;
        }

        .items-table td {
            padding: 8px;
            border-bottom: 1px solid #E0E0E0;
            font-size: 10px;
            color: #000000;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .summary-box {
            width: 200px;
            margin-left: auto;
            margin-top: 20px;
            border: 1px solid #E0E0E0;
            padding: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 10px;
            color: #000000;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 10px;
            padding-top: 8px;
            border-top: 1px solid #CCCCCC;
        }

        /* Hide VAT-related elements for receipts */
        .receipt-mode .vat-row {
            display: none !important;
        }

        /* Show VAT elements only for tax invoices */
        .taxinvoice-mode .vat-row {
            display: flex !important;
        }

        .amount-words {
            border: 1px solid #E0E0E0;
            padding: 10px;
            margin: 20px 0;
            font-size: 10px;
            color: #000000;
        }

        .signatures {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 40px 0 20px 0;
        }

        .signature-box {
            text-align: center;
        }

        .signature-area {
            height: 70px;
            position: relative;
            margin: 0 20px;
            border-bottom: 1px solid #888888;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .signature-on-line {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            border: none !important;
            background: transparent;
            z-index: 2;
        }

        .signature-placeholder-on-line {
            font-size: 12px;
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 5px;
            background-color: rgba(249, 249, 249, 0.8);
            border: 1px dashed #ccc;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }

        .signature-placeholder-on-line:hover {
            background-color: rgba(240, 240, 240, 0.9);
        }

        .signature-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .signature-btn, .fingerprint-btn, .qr-signature-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            color: #333;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 120px;
        }

        .signature-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .qr-signature-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .qr-signature-btn:hover {
            background: linear-gradient(135deg, #5568d3, #6a3f8f);
            transform: translateY(-1px);
        }

        .fingerprint-btn:hover {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .fingerprint-scanning {
            background: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724;
        }

        .signature-line {
            margin: 10px 20px;
            padding-top: 8px;
            position: relative;
            text-align: center;
        }

        .authorized-stamp {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: auto;
            z-index: 10;
        }

        .signature-label {
            font-size: 10px;
            font-weight: 600;
            color: #555555;
        }

        .signature-sublabel {
            font-size: 10px;
            color: #555555;
            margin-top: 3px;
        }

        .terms {
            font-size: 10px;
            color: #555555;
            line-height: 1.4;
            margin-top: 20px;
            padding: 10px;
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
        }

        @media print {
            body {
                background: #FFFFFF;
                padding: 40px;
                -webkit-font-smoothing: auto;
                -moz-osx-font-smoothing: auto;
            }
            .a4-page {
                box-shadow: none;
                margin: 0;
            }
            .no-print {
                display: none;
            }

            /* Print-specific font settings for Thai */
            * {
                font-family: 'Sarabun', 'Noto Sans Thai', 'TH Sarabun New', 'THSarabun', 'Arial Unicode MS', sans-serif !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }

        /* Font fallback for Thai characters */
        h1, h2, h3, h4, h5, h6, p, div, span, label, td, th {
            font-family: 'Sarabun', 'Noto Sans Thai', 'TH Sarabun New', 'THSarabun', 'Arial Unicode MS', sans-serif !important;
        }

        /* Ensure proper Thai text rendering */
        .thai-text {
            font-family: 'Sarabun', 'Noto Sans Thai', 'TH Sarabun New', 'THSarabun', 'Arial Unicode MS', sans-serif;
            text-rendering: optimizeLegibility;
            -webkit-font-feature-settings: "liga";
            font-feature-settings: "liga";
        }

        .no-print {
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Sarabun', sans-serif;
        }

        .btn-primary {
            background: #3498DB;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background: #2980B9;
        }

        .btn-secondary {
            background: #555555;
            color: #FFFFFF;
        }

        .btn-secondary:hover {
            background: #333333;
        }
    </style>
</head>
<body>
    <div class="a4-page" id="receiptDocument">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="../../uploads/Logo2.png" alt="Company Logo" style="width: 100%;">
            </div>

            <div class="company-info">
                <div class="company-name thai-text">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
                <div class="company-details thai-text">
                    ‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ 00000<br>
                    148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000<br>
                    ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≤‡∏Å‡∏£ 0945566000616<br>
                    ‡πÇ‡∏ó‡∏£: 09-2427-0769
                </div>
            </div>

            <div class="document-title">
                <h1 id="docType" class="thai-text">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h1>
                <h2 id="docTypeEn" style="font-size: 14px; margin-top: 5px; color: #666;">TAX INVOICE/RECEIPT</h2>
            </div>
        </div>

        <!-- Customer & Deposit Info -->
        <div class="info-section">
            <div class="info-column">
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ Invoice No.</label>
                    <div class="value thai-text" id="invoiceNumber">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à Invoice Date</label>
                    <div class="value thai-text" id="invoiceDate">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡πÄ‡∏ß‡∏•‡∏≤ Time</label>
                    <div class="value thai-text" id="invoiceTime">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ Sale Type</label>
                    <div class="value thai-text" id="saleType">-</div>
                </div>
                <div>
                    <label class="thai-text">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô Payment Method</label>
                    <div class="value thai-text" id="paymentMethod">-</div>
                </div>
                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° -->
                <div id="mixedPaymentDetails" class="thai-text" style="display: none; margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; border-left: 3px solid #3498DB;">
                    <div class="thai-text" style="font-size: 9px; font-weight: 600; color: #3498DB; margin-bottom: 5px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:</div>
                    <div style="font-size: 8px; margin-bottom: 2px;">
                        <span class="thai-text" style="color: #27ae60;">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span>
                        <span id="mixedCashAmount" class="thai-text">‡∏ø0</span>
                    </div>
                    <div style="font-size: 8px;">
                        <span class="thai-text" style="color: #2980b9;">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                        <span id="mixedTransferAmount" class="thai-text">‡∏ø0</span>
                    </div>
                </div>
            </div>

            <div class="info-column">
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô Customer Name</label>
                    <div class="value thai-text" id="customerName">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå Phone Number</label>
                    <div class="value thai-text" id="customerPhone">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà Address</label>
                    <div class="value thai-text" id="customerAddress">-</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label class="thai-text">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ Tax ID</label>
                    <div class="value thai-text" id="customerTaxId">-</div>
                </div>
                <div>
                    <label class="thai-text">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ Salesperson</label>
                    <div class="value thai-text" id="salespersonName">-</div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 50px;" class="thai-text">‡∏•‡∏≥‡∏î‡∏±‡∏ö<br><small>No</small></th>
                    <th class="thai-text">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£<br><small>Product/Service Details</small></th>
                    <th style="width: 80px;" class="text-center thai-text">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô<br><small>Qty</small></th>
                    <th style="width: 100px;" class="text-right thai-text">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢<br><small>Unit Price</small></th>
                    <th style="width: 100px;" class="text-right thai-text">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô<br><small>Amount</small></th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                <tr>
                    <td class="text-center thai-text">1</td>
                    <td id="productName" class="thai-text">-</td>
                    <td class="text-center thai-text" id="productQuantity">1</td>
                    <td class="text-right thai-text" id="productPrice">0.00</td>
                    <td class="text-right thai-text" id="productTotal">0.00</td>
                </tr>
            </tbody>
        </table>

        <!-- Installment Info (for installment sales) -->
        <div id="installmentInfo" class="thai-text" style="background: #FFFFFF; border: 1px solid #3498DB; border-left: 3px solid #3498DB; padding: 12px; margin: 15px 0; font-size: 10px; color: #000000; display: none;">
            <strong>üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞:</strong><br>
            <div style="margin-top: 8px;">
                <div style="margin-bottom: 5px;">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: <strong id="downAmount" class="thai-text">-</strong></div>
                <div style="margin-bottom: 5px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î: <strong id="installmentCount" class="thai-text">-</strong> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <div>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <strong id="monthlyPayment" class="thai-text">-</strong></div>
            </div>
        </div>

        <!-- Tax Summary -->
        <div class="summary-box">
            <div class="thai-text" style="font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid #E0E0E0; padding-bottom: 5px; font-size: 10px; color: #000000;">
                ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
            </div>
            <div class="summary-row">
                <span class="thai-text">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</span>
                <span id="subtotalAmount" class="thai-text">0.00</span>
            </div>
            <div class="summary-row">
                <span class="thai-text">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                <span id="discountAmount" class="thai-text">0.00</span>
            </div>
            <div class="summary-row vat-row">
                <span class="thai-text">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ:</span>
                <span id="beforeTaxAmount" class="thai-text">0.00</span>
            </div>
            <div class="summary-row vat-row" id="taxRow">
                <span class="thai-text">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (<span id="taxRateDisplay">7</span>%):</span>
                <span id="vatAmount" class="thai-text">0.00</span>
            </div>
            <div class="summary-row vat-row" id="taxTypeDescRow" style="display: none; font-size: 8px; color: #666;">
                <span class="thai-text" id="taxTypeDescription">‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ</span>
                <span></span>
            </div>
            <div class="summary-row total" style="color: #e74c3c; border-top: 1px solid #E0E0E0; padding-top: 8px; margin-top: 8px;">
                <span class="thai-text">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                <span id="totalAmount" class="thai-text">0.00</span>
            </div>
        </div>

        <!-- Amount in Words -->
        <div class="amount-words thai-text">
            <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠):</strong> <span id="amountWords" class="thai-text">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô</span>
        </div>

        <!-- Signatures -->
        <div class="signatures">
            <div class="signature-box">
                <div class="signature-area">
                    <canvas id="customerSignatureDisplay" width="200" height="60" style="display: none;" class="signature-on-line"></canvas>
                    <img id="customerFingerprintDisplay" width="77.76" height="97.2" style="display: none;" class="signature-on-line" />
                    <div id="customerSignaturePlaceholder" class="signature-placeholder-on-line">
                        <div class="signature-options">
                            <button onclick="openSignatureModal('customer')" class="signature-btn">
                                ‚úçÔ∏è ‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                            </button>
                            <button onclick="scanFingerprint('customer')" class="fingerprint-btn">
                                üëÜ ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
                            </button>
                            <button onclick="openQRSignatureModal('customer')" class="qr-signature-btn">
                                üì± QR Code
                            </button>
                            <button id="loginBtn" onclick="redirectToLogin()" class="fingerprint-btn" style="font-size: 12px; margin-left: 5px; display: none; background: #dc3545; color: white;">
                                üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    </div>
                </div>
                <div class="signature-line">
                    <div class="signature-label thai-text">‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                    <div class="signature-sublabel">Customer Signature / Fingerprint</div>
                </div>
            </div>
            <div class="signature-box">
                <div class="signature-area">
                    <canvas id="cashierSignatureDisplay" width="200" height="60" style="display: none;" class="signature-on-line"></canvas>
                    <div id="cashierSignaturePlaceholder" class="signature-placeholder-on-line">
                        <div class="signature-options">
                            <button onclick="openSignatureModal('cashier')" class="signature-btn">
                                ‚úçÔ∏è ‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                            </button>
                            <button onclick="openQRSignatureModal('cashier')" class="qr-signature-btn">
                                üì± QR Code
                            </button>
                        </div>
                    </div>
                </div>
                <div class="signature-line">
                    <div class="signature-label thai-text">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                    <div class="signature-sublabel">Seller Signature</div>
                </div>
            </div>
            <div class="signature-box">
                <div class="signature-line">
                    <img src="../../uploads/S__15892486-Photoroom.png" alt="‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö" class="authorized-stamp">
                    <div class="signature-label thai-text">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                    <div class="signature-sublabel">Authorized Signature</div>
                </div>
            </div>
        </div>

        <!-- Terms -->
        <div class="terms thai-text">
            <strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong><br>
            1. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô<br>
            2. ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï<br>
            3. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>
            4. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤<br>
            5. ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏°‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="no-print">
        <button class="btn btn-primary thai-text" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</button>
        <button class="btn btn-secondary thai-text" onclick="loadInvoiceData().catch(console.error)">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
        <button class="btn btn-secondary" onclick="fixAllThaiEncoding()" style="background: #e74c3c; color: white;">üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</button>
        <button class="btn btn-secondary" onclick="debugEncoding()" style="background: #9b59b6; color: white;">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Encoding</button>
    </div>

    <script>
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á HTML entities ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ encoding
        function decodeHTMLEntities(text) {
            if (!text) return '';
            try {
                const textArea = document.createElement('textarea');
                textArea.innerHTML = text;
                let decoded = textArea.value;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á encoding ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                if (decoded.includes('&') || decoded.includes('&#')) {
                    textArea.innerHTML = decoded;
                    decoded = textArea.value;
                }

                return decoded;
            } catch (e) {
                console.error('Error decoding text:', e);
                return text;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ text ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function setThaiText(element, text) {
            if (element && text !== undefined && text !== null) {
                try {
                    // ‡πÅ‡∏õ‡∏•‡∏á text ‡πÄ‡∏õ‡πá‡∏ô string ‡∏Å‡πà‡∏≠‡∏ô
                    let textStr = String(text);

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á encoding
                    let decodedText = decodeHTMLEntities(textStr);

                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ ??? ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
                    if (decodedText.includes('???') || decodedText.includes('????')) {
                        // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ escape sequences
                        decodedText = textStr.replace(/\\u([0-9a-fA-F]{4})/g, (match, hex) => {
                            return String.fromCharCode(parseInt(hex, 16));
                        });
                    }

                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ text
                    element.textContent = decodedText;

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Thai text rendering
                    if (!element.classList.contains('thai-text')) {
                        element.classList.add('thai-text');
                    }

                    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ browser ‡∏£‡∏µ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
                    element.style.fontFamily = 'Sarabun, "Noto Sans Thai", "TH Sarabun New", "THSarabun", "Arial Unicode MS", sans-serif';

                    console.log('Set Thai text:', decodedText, 'for element:', element.id || element.className);
                } catch (e) {
                    console.error('Error setting Thai text:', e);
                    element.textContent = text;
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function numberToThaiWords(number) {
            const ones = ['', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
            const places = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];
        
            if (number === 0) return '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô';
            if (number < 0) return '‡∏•‡∏ö' + numberToThaiWords(-number);
        
            const [intPart, decPart] = number.toString().split('.');
            let result = '';
        
            if (intPart && parseInt(intPart) > 0) {
                result += convertIntegerToThaiWords(parseInt(intPart)) + '‡∏ö‡∏≤‡∏ó';
            }
        
            if (decPart && parseInt(decPart) > 0) {
                const satang = parseInt(decPart.padEnd(2, '0').substr(0, 2));
                result += convertIntegerToThaiWords(satang) + '‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå';
            } else {
                result += '‡∏ñ‡πâ‡∏ß‡∏ô';
            }
        
            return result;
        }

        function convertIntegerToThaiWords(number) {
            if (number === 0) return '';
        
            const ones = ['', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
            let result = '';
            const digits = number.toString().split('').reverse();
        
            for (let i = 0; i < digits.length; i++) {
                const digit = parseInt(digits[i]);
                if (digit === 0) continue;
        
                if (i === 1) {
                    if (digit === 1) result = '‡∏™‡∏¥‡∏ö' + result;
                    else if (digit === 2) result = '‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö' + result;
                    else result = ones[digit] + '‡∏™‡∏¥‡∏ö' + result;
                } else if (i === 0) {
                    if (digits[1] && parseInt(digits[1]) > 0 && digit === 1) {
                        result = '‡πÄ‡∏≠‡πá‡∏î' + result;
                    } else {
                        result = ones[digit] + result;
                    }
                } else {
                    const places = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];
                    result = ones[digit] + places[i] + result;
                }
            }
        
            return result;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        function updateDocumentTitle(docType) {
            const docTypeElement = document.getElementById('docType');
            const docTypeEnElement = document.getElementById('docTypeEn');

            // Remove existing document type classes
            document.body.classList.remove('receipt-mode', 'taxinvoice-mode');

            if (docType === 'taxinvoice') {
                setThaiText(docTypeElement, '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
                setThaiText(docTypeEnElement, 'TAX INVOICE');
                document.title = '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';
                document.body.classList.add('taxinvoice-mode');
            } else if (docType === 'receipt') {
                setThaiText(docTypeElement, '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
                setThaiText(docTypeEnElement, 'RECEIPT');
                document.title = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';
                document.body.classList.add('receipt-mode');
            } else {
                // Default - ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility)
                setThaiText(docTypeElement, '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
                setThaiText(docTypeEnElement, 'TAX INVOICE/RECEIPT');
                document.title = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';
                document.body.classList.add('taxinvoice-mode'); // Show VAT by default for mixed documents
            }

            console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:', docType || 'default', '- CSS mode:', docType ? `${docType}-mode` : 'taxinvoice-mode');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏≤‡∏Å URL parameter ‡∏´‡∏£‡∏∑‡∏≠ localStorage
        async function loadInvoiceData() {
            try {
                console.log('üîç Loading invoice data...');

                const urlParams = new URLSearchParams(window.location.search);
                const receiptId = urlParams.get('id');
                const docType = urlParams.get('type'); // ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å URL

                console.log('üìã URL receipt ID:', receiptId);
                console.log('üìã Document type:', docType);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage
                const currentReceiptData = localStorage.getItem('currentDepositReceipt');
                const currentPDFData = localStorage.getItem('currentPDFData');

                console.log('üíæ currentDepositReceipt data:', currentReceiptData ? 'Found' : 'Not found');
                console.log('üíæ currentPDFData data:', currentPDFData ? 'Found' : 'Not found');

                if (currentReceiptData) {
                    console.log('üìÑ Receipt data preview:', currentReceiptData.substring(0, 200) + '...');
                }

                // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                updateDocumentTitle(docType);

                // Priority 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å downloadPDF function)
                const storedData = localStorage.getItem('currentDepositReceipt');
                const pdfData = localStorage.getItem('currentPDFData');

                console.log('üîç Checking localStorage data:', {
                    hasStoredData: !!storedData,
                    hasPdfData: !!pdfData,
                    receiptId: receiptId
                });

                if (pdfData) {
                    console.log('‚úÖ Priority 1: Found PDF data in localStorage - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å downloadPDF');
                    try {
                        const receiptData = JSON.parse(pdfData);
                        console.log('üìÑ PDF Receipt data loaded successfully:', {
                            receiptNumber: receiptData.receiptNumber,
                            customer: receiptData.customer?.name,
                            product: receiptData.product?.name,
                            docType: receiptData.docType
                        });

                        // If we have tax invoice data and docType is taxinvoice, use that data
                        if (docType === 'taxinvoice' && receiptData.taxInvoiceData) {
                            console.log('üßæ Using tax invoice data for display');
                            populateTaxInvoiceData(receiptData.taxInvoiceData, receiptData);
                        } else {
                            console.log('üìã Using regular receipt data for display');
                            populateInvoiceData(receiptData);
                        }

                        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        setTimeout(() => loadSignaturesFromDatabase(), 1000);
                        return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    } catch (error) {
                        console.error('‚ùå Error parsing PDF data from localStorage:', error);
                    }
                }

                if (storedData) {
                    console.log('‚úÖ Priority 2: Found data in localStorage - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å currentDepositReceipt');
                    try {
                        const receiptData = JSON.parse(storedData);
                        console.log('üìÑ Receipt data loaded successfully:', {
                            receiptNumber: receiptData.receiptNumber,
                            customer: receiptData.customer?.name,
                            product: receiptData.product?.name
                        });

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° docType ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                        if (!receiptData.docType) {
                            receiptData.docType = docType;
                        }

                        // If we have tax invoice data and docType is taxinvoice, use that data
                        if (docType === 'taxinvoice' && receiptData.taxInvoiceData) {
                            console.log('üßæ Using tax invoice data for display');
                            populateTaxInvoiceData(receiptData.taxInvoiceData, receiptData);
                        } else {
                            populateInvoiceData(receiptData);
                        }

                        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        setTimeout(() => loadSignaturesFromDatabase(), 1000);
                        return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    } catch (error) {
                        console.error('‚ùå Error parsing stored data from localStorage:', error);
                    }
                }

                // Priority 3: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å URL parameter
                if (receiptId) {
                    console.log('üåê Priority 3: Loading from URL parameter...');
                    console.log('üîç Searching for receipt ID:', receiptId);

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô localStorage
                    const localReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
                    console.log('üì¶ Available receipts in localStorage:', localReceipts.map(r => ({
                        id: r._id || r.id,
                        receiptNumber: r.receiptNumber,
                        customer: r.customer?.name
                    })));

                    const found = loadDepositReceiptFromStorage(receiptId);
                    if (!found) {
                        console.log('‚ö†Ô∏è Receipt not found by ID in storage');
                        console.log('üîÑ Trying to load receipt data from API...');
                        try {
                            const apiResult = await loadReceiptFromAPI(receiptId);
                            if (apiResult) {
                                return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            }
                        } catch (error) {
                            console.error('‚ùå API loading failed:', error);
                        }
                        console.log('‚ùå Could not load from API either');
                    } else {
                        return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    }
                }

                // Priority 4: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏£‡∏Å
                console.log('‚ö†Ô∏è Priority 4: No specific data found, trying to load first available receipt');
                const success = loadFirstAvailableReceipt();
                if (success) {
                    return; // ‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                }

                // Priority 5: ‡πÉ‡∏ä‡πâ sample data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏•‡∏¢)
                console.log('‚ùå Priority 5: No real data available - using sample data for demo purposes');
                const sampleData = createSampleDepositReceiptData();
                populateInvoiceData(sampleData);
            } catch (error) {
                console.error('‚ùå Error loading invoice data:', error);
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Prompt', sans-serif;">
                        <div style="text-align: center; padding: 40px; border: 2px solid #f44336; border-radius: 8px; background: #ffebee;">
                            <h2 style="color: #d32f2f; margin-bottom: 20px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
                            <p style="color: #666; margin-bottom: 20px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ</p>
                            <p style="color: #666; font-size: 14px;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        async function loadReceiptFromAPI(receiptId) {
            try {
                console.log('üåê Loading receipt from API:', receiptId);
                const token = localStorage.getItem('authToken');
                const branchCode = localStorage.getItem('activeBranch') || '00000';

                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`/api/deposit-receipts?branchCode=${branchCode}&receiptId=${receiptId}`, {
                    headers: headers
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        const receipt = result.data[0];
                        console.log('‚úÖ Found receipt from API:', receipt.receiptNumber);
                        populateInvoiceData(receipt);
                        setTimeout(() => loadSignaturesFromDatabase(), 1000);
                        return true;
                    }
                }

                console.log('‚ö†Ô∏è Receipt not found in API');
                return false;
            } catch (error) {
                console.error('‚ùå Error loading from API:', error);
                return false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        function loadFirstAvailableReceipt() {
            try {
                const localReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
                console.log('üîç loadFirstAvailableReceipt - found receipts:', localReceipts.length);

                if (localReceipts.length > 0) {
                    const firstReceipt = localReceipts[0];
                    console.log('‚úÖ Using first available receipt:', {
                        receiptNumber: firstReceipt.receiptNumber,
                        customer: firstReceipt.customer?.name,
                        product: firstReceipt.product?.name,
                        hasAmounts: !!firstReceipt.amounts
                    });

                    populateInvoiceData(firstReceipt);
                    setTimeout(() => loadSignaturesFromDatabase(), 1000);
                    return true;
                } else {
                    console.log('‚ö†Ô∏è No receipts available in localStorage');

                    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å currentDepositReceipt ‡∏´‡∏£‡∏∑‡∏≠ currentPDFData
                    const currentReceipt = localStorage.getItem('currentDepositReceipt');
                    const currentPDFData = localStorage.getItem('currentPDFData');

                    if (currentPDFData) {
                        console.log('üîÑ Trying currentPDFData...');
                        const pdfData = JSON.parse(currentPDFData);
                        populateInvoiceData(pdfData);
                        return true;
                    } else if (currentReceipt) {
                        console.log('üîÑ Trying currentDepositReceipt...');
                        const receipt = JSON.parse(currentReceipt);
                        populateInvoiceData(receipt);
                        return true;
                    }

                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading first receipt:', error);
                return false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API)
        function loadDepositReceiptFromStorage(receiptId) {
            try {
                console.log('üîç Searching for receipt ID:', receiptId);

                // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const localReceipts = JSON.parse(localStorage.getItem('depositReceipts') || '[]');
                console.log('üì¶ Available receipts in localStorage:', localReceipts.length);

                // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡πà‡∏≤‡∏á‡πÜ
                let receipt = localReceipts.find(r =>
                    r._id === receiptId ||
                    r.id === receiptId ||
                    r.receiptNumber === receiptId
                );

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö partial match
                if (!receipt) {
                    receipt = localReceipts.find(r =>
                        (r.receiptNumber && r.receiptNumber.includes(receiptId)) ||
                        (r._id && r._id.toString().includes(receiptId))
                    );
                }

                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ receipt ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ
                if (!receipt && localReceipts.length > 0) {
                    console.log('‚ö†Ô∏è Using first available receipt as fallback');
                    receipt = localReceipts[0];
                }

                if (receipt) {
                    console.log('‚úÖ Found receipt in localStorage:', {
                        receiptNumber: receipt.receiptNumber || 'No receipt number',
                        id: receipt._id || receipt.id,
                        customer: receipt.customer?.name,
                        hasProduct: !!receipt.product,
                        hasAmounts: !!receipt.amounts
                    });

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                    if (!receipt.customer && !receipt.product) {
                        console.warn('‚ö†Ô∏è Receipt data is incomplete, but attempting to display');
                    }

                    populateInvoiceData(receipt);

                    // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    setTimeout(() => loadSignaturesFromDatabase(), 1000);
                    return true;
                }

                console.log('‚ùå Receipt not found in localStorage');
                console.log('Available IDs:', localReceipts.map(r => ({
                    id: r._id || r.id,
                    receiptNumber: r.receiptNumber
                })));

                return false;

            } catch (error) {
                console.error('‚ùå Error loading receipt from storage:', error);
                return false;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏≤‡∏Å API
        function populateTaxInvoiceData(taxInvoiceData, originalReceiptData) {
            console.log('üßæ populateTaxInvoiceData called with:', taxInvoiceData);

            if (!taxInvoiceData) {
                console.error('‚ùå No tax invoice data provided');
                showNoDataMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
                return;
            }

            // ‡πÄ‡∏Å‡πá‡∏ö invoice ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
            if (taxInvoiceData._id) {
                window.currentReceiptId = taxInvoiceData._id;
                console.log('üíæ Stored tax invoice ID:', taxInvoiceData._id);
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            setThaiText(document.getElementById('invoiceNumber'), taxInvoiceData.taxInvoiceNumber || '-');
            setThaiText(document.getElementById('invoiceDate'), taxInvoiceData.issueDate ?
                new Date(taxInvoiceData.issueDate).toLocaleDateString('th-TH') : '-');
            setThaiText(document.getElementById('invoiceTime'), taxInvoiceData.issueTime || '-');

            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            setThaiText(document.getElementById('saleType'),
                taxInvoiceData.saleType === 'cash' ? '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î' : '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');

            let paymentMethodText = '';
            if (taxInvoiceData.paymentMethod === 'cash') {
                paymentMethodText = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            } else if (taxInvoiceData.paymentMethod === 'transfer') {
                paymentMethodText = '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
            } else {
                paymentMethodText = taxInvoiceData.paymentMethod || '-';
            }
            setThaiText(document.getElementById('paymentMethod'), paymentMethodText);

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            if (taxInvoiceData.customer) {
                console.log('üéØ Tax invoice customer details:', taxInvoiceData.customer);
                setThaiText(document.getElementById('customerName'), taxInvoiceData.customer.fullName || taxInvoiceData.customer.name || '-');
                setThaiText(document.getElementById('customerPhone'), taxInvoiceData.customer.phone || taxInvoiceData.customer.phone_number || '-');
                setThaiText(document.getElementById('customerAddress'), taxInvoiceData.customer.address || '-');
                setThaiText(document.getElementById('customerTaxId'), taxInvoiceData.customer.taxId || taxInvoiceData.customer.tax_id || '-');
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            setThaiText(document.getElementById('salespersonName'), taxInvoiceData.employeeName || '-');

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            if (taxInvoiceData.items && taxInvoiceData.items.length > 0) {
                const firstItem = taxInvoiceData.items[0];
                console.log('üéØ Tax invoice product details:', firstItem);
                setThaiText(document.getElementById('productName'), firstItem.name || '-');
                setThaiText(document.getElementById('productQuantity'), firstItem.quantity || 1);
                setThaiText(document.getElementById('productPrice'),
                    (firstItem.unitPrice || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('productTotal'),
                    (firstItem.totalPrice || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));

                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                if (taxInvoiceData.items.length > 1) {
                    const itemsBody = document.getElementById('itemsBody');
                    itemsBody.innerHTML = '';

                    taxInvoiceData.items.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="text-center thai-text">${index + 1}</td>
                            <td class="thai-text">${item.name || '-'}<br><small class="text-gray-500">${item.description || ''}</small></td>
                            <td class="text-center thai-text">${item.quantity || 1}</td>
                            <td class="text-right thai-text">${(item.unitPrice || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                            <td class="text-right thai-text">${(item.totalPrice || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                        `;
                        itemsBody.appendChild(row);
                    });
                }
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å original receipt
                if (originalReceiptData && originalReceiptData.product) {
                    setThaiText(document.getElementById('productName'), originalReceiptData.product.name || '-');
                    setThaiText(document.getElementById('productQuantity'), originalReceiptData.product.quantity || 1);

                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°
                    const isDepositReceipt = originalReceiptData.depositType || originalReceiptData.amounts?.depositAmount;
                    if (isDepositReceipt && originalReceiptData.amounts?.depositAmount) {
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                        setThaiText(document.getElementById('productPrice'),
                            (originalReceiptData.product.price || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                        setThaiText(document.getElementById('productTotal'),
                            (originalReceiptData.amounts.depositAmount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                    } else {
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
                        setThaiText(document.getElementById('productPrice'),
                            (originalReceiptData.product.price || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                        setThaiText(document.getElementById('productTotal'),
                            ((originalReceiptData.product.price || 0) * (originalReceiptData.product.quantity || 1)).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                    }
                }
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            if (taxInvoiceData.calculation || taxInvoiceData.summary) {
                const calc = taxInvoiceData.calculation || taxInvoiceData.summary;

                console.log('üí∞ Tax invoice amount calculations:', calc);

                setThaiText(document.getElementById('subtotalAmount'),
                    (calc.subtotal || calc.beforeTax || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('discountAmount'), '0.00'); // Usually no discount in tax invoices
                setThaiText(document.getElementById('beforeTaxAmount'),
                    (calc.beforeTax || calc.subtotal || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('vatAmount'),
                    (calc.vatAmount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('totalAmount'),
                    (calc.totalAmount || calc.totalWithTax || calc.total || 0).toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('amountWords'),
                    numberToThaiWords(calc.totalAmount || calc.totalWithTax || calc.total || 0));
            } else if (originalReceiptData && originalReceiptData.amounts) {
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å original receipt ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
                const amounts = originalReceiptData.amounts;
                const taxInfo = originalReceiptData.tax || {};
                const taxType = taxInfo.taxType || 'exclusive';
                const taxRate = taxInfo.taxRate || 7;

                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const displayAmount = amounts.depositAmount || 0; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥

                let subtotal, vatAmount, totalAmount;

                if (taxType === 'none') {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ
                    subtotal = displayAmount;
                    vatAmount = 0;
                    totalAmount = displayAmount;
                    document.getElementById('taxRow').style.display = 'none';
                    document.getElementById('taxTypeDescRow').style.display = 'none';
                    // ‡∏ã‡πà‡∏≠‡∏ô vat-row ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    document.querySelectorAll('.vat-row').forEach(el => el.style.display = 'none');
                } else if (taxType === 'inclusive') {
                    // ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ
                    totalAmount = displayAmount;
                    subtotal = Math.round(displayAmount / (1 + taxRate / 100) * 100) / 100;
                    vatAmount = totalAmount - subtotal;
                    document.getElementById('taxRow').style.display = 'flex';
                    document.getElementById('taxTypeDescRow').style.display = 'flex';
                    document.getElementById('taxTypeDescription').textContent = '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡πâ‡∏ß';
                    document.getElementById('taxRateDisplay').textContent = taxRate;
                } else {
                    // ‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ (exclusive)
                    subtotal = displayAmount;
                    vatAmount = Math.round(displayAmount * (taxRate / 100) * 100) / 100;
                    totalAmount = subtotal + vatAmount;
                    document.getElementById('taxRow').style.display = 'flex';
                    document.getElementById('taxTypeDescRow').style.display = 'flex';
                    document.getElementById('taxTypeDescription').textContent = '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ';
                    document.getElementById('taxRateDisplay').textContent = taxRate;
                }

                setThaiText(document.getElementById('subtotalAmount'),
                    subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('discountAmount'), '0.00');
                setThaiText(document.getElementById('beforeTaxAmount'),
                    subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('vatAmount'), vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('totalAmount'), totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('amountWords'), numberToThaiWords(totalAmount));

                console.log('üí∞ Tax calculation (Receipt/TaxInvoice):', {taxType, taxRate, subtotal, vatAmount, totalAmount});
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            updateBranchAndCompanyInfo(taxInvoiceData);

            console.log('‚úÖ Tax invoice data populated successfully');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        function createSampleDepositReceiptData() {
            const now = new Date();
            const thaiDate = now.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return {
                receiptNumber: `DR-${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-001`,
                invoiceNumber: `TX-${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-001`,
                depositDate: now.toISOString(),
                depositTime: now.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }),
                docType: 'receipt', // or 'taxinvoice'
                depositType: 'online',
                saleType: 'cash',
                status: 'active',
                customer: {
                    name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                    customerType: 'corporate',
                    phone: '02-123-4567',
                    email: 'customer@example.com',
                    taxId: '0123456789012',
                    address: {
                        fullAddress: '123/45 ‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110'
                    }
                },
                product: {
                    name: 'iPhone 15 Pro Max 256GB - Natural Titanium',
                    brand: 'Apple',
                    model: 'iPhone 15 Pro Max',
                    price: 52900,
                    color: 'Natural Titanium',
                    storage: '256GB',
                    condition: 'new',
                    imei: '123456789012345'
                },
                amounts: {
                    totalAmount: 52900,
                    depositAmount: 15000,
                    remainingAmount: 37900,
                    subTotal: 49439.25,
                    vatAmount: 3460.75,
                    grandTotal: 52900
                },
                paymentMethod: 'transfer',
                transferInfo: {
                    bankName: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û',
                    accountNumber: '123-4-56789-0',
                    accountName: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                    transferDate: now.toISOString(),
                    transferTime: now.toLocaleTimeString('th-TH'),
                    referenceNumber: 'TXN123456789'
                },
                salesperson: {
                    name: '‡∏Ñ‡∏∏‡∏ì‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á',
                    employeeId: 'EMP001',
                    department: '‡∏Ç‡∏≤‡∏¢'
                },
                branch: {
                    name: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà',
                    code: '00000',
                    address: '148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000',
                    phone: '09-2427-0769',
                    taxId: '0945566000616'
                },
                company: {
                    name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                    address: '148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000',
                    taxId: '0945566000616',
                    phone: '09-2427-0769'
                },
                notes: '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ iPhone 15 Pro Max',
                // Tax Invoice specific data
                taxInvoiceData: {
                    taxInvoiceNumber: `TX-${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-001`,
                    issueDate: now.toISOString(),
                    paymentDate: now.toISOString(),
                    paymentMethod: 'transfer',
                    saleType: 'cash',
                    vatRate: 7,
                    company: {
                        name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                        address: '148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000',
                        taxId: '0945566000616',
                        phone: '09-2427-0769'
                    },
                    customer: {
                        fullName: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                        name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
                        address: '123/45 ‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110',
                        phone: '02-123-4567',
                        taxId: '0123456789012',
                        email: 'customer@example.com'
                    },
                    items: [{
                        name: 'iPhone 15 Pro Max 256GB - Natural Titanium',
                        description: 'Apple iPhone 15 Pro Max 256GB ‡∏™‡∏µ Natural Titanium',
                        quantity: 1,
                        unitPrice: 49439.25,
                        totalPrice: 49439.25
                    }],
                    calculation: {
                        beforeTax: 49439.25,
                        vatAmount: 3460.75,
                        totalAmount: 52900,
                        vatRate: 7
                    },
                    summary: {
                        beforeTax: 49439.25,
                        vatAmount: 3460.75,
                        totalWithTax: 52900,
                        total: 52900
                    },
                    employeeName: '‡∏Ñ‡∏∏‡∏ì‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á',
                    branchCode: '00000',
                    quotationNumber: 'QT-671001-001'
                }
            };
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
        function populateInvoiceData(invoiceData) {
            console.log('üìù populateInvoiceData called with:', invoiceData);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
            if (!invoiceData) {
                console.error('‚ùå No invoice data provided');
                showNoDataMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à');
                return;
            }

            console.log('üîç [POPULATE] Starting to populate with data:', {
                hasCustomer: !!invoiceData.customer,
                customerName: invoiceData.customer?.name,
                hasProduct: !!invoiceData.product,
                productName: invoiceData.product?.name,
                hasAmounts: !!invoiceData.amounts,
                receiptNumber: invoiceData.receiptNumber,
                invoiceNumber: invoiceData.invoiceNumber,
                docType: invoiceData.docType
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå
            if (!invoiceData.customer || !invoiceData.customer.name) {
                console.warn('‚ö†Ô∏è Limited customer data, using available fields');
            }

            if (!invoiceData.product || !invoiceData.product.name) {
                console.warn('‚ö†Ô∏è Limited product data, using available fields');
            }

            if (!invoiceData.amounts) {
                console.warn('‚ö†Ô∏è No amounts data, will use default values');
            }

            // ‡πÄ‡∏Å‡πá‡∏ö invoice ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
            if (invoiceData._id) {
                window.currentReceiptId = invoiceData._id;
                console.log('üíæ Stored invoice ID:', invoiceData._id);
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• docType)
            if (invoiceData.docType) {
                updateDocumentTitle(invoiceData.docType);
            }

            console.log('üéØ Customer data:', invoiceData.customer);
            console.log('üéØ Product data:', invoiceData.product);
            console.log('üéØ Receipt number:', invoiceData.receiptNumber);
            console.log('üéØ Invoice number:', invoiceData.invoiceNumber);
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            setThaiText(document.getElementById('invoiceNumber'), invoiceData.invoiceNumber || invoiceData.receiptNumber || '-');
            setThaiText(document.getElementById('invoiceDate'), invoiceData.invoiceDate || invoiceData.depositDate ?
                new Date(invoiceData.invoiceDate || invoiceData.depositDate).toLocaleDateString('th-TH') : '-');
            setThaiText(document.getElementById('invoiceTime'), invoiceData.invoiceTime || invoiceData.depositTime || '-');

            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            setThaiText(document.getElementById('saleType'),
                invoiceData.saleType === 'cash' ? '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î' : '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô');
            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            let paymentMethodText = '';
            if (invoiceData.paymentMethod === 'cash') {
                paymentMethodText = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            } else if (invoiceData.paymentMethod === 'transfer') {
                paymentMethodText = '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
            } else if (invoiceData.paymentMethod === 'mixed') {
                paymentMethodText = '‡∏ú‡∏™‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô)';
            } else {
                paymentMethodText = invoiceData.paymentMethod || '-';
            }
            setThaiText(document.getElementById('paymentMethod'), paymentMethodText);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
            const mixedPaymentDetails = document.getElementById('mixedPaymentDetails');
            if (invoiceData.paymentMethod === 'mixed' && invoiceData.paymentDetails) {
                mixedPaymentDetails.style.display = 'block';

                const cashAmount = parseFloat(invoiceData.paymentDetails.cash) || 0;
                const transferAmount = parseFloat(invoiceData.paymentDetails.transfer) || 0;

                setThaiText(document.getElementById('mixedCashAmount'), `‡∏ø${cashAmount.toLocaleString()}`);
                setThaiText(document.getElementById('mixedTransferAmount'), `‡∏ø${transferAmount.toLocaleString()}`);
            } else {
                mixedPaymentDetails.style.display = 'none';
            }
            setThaiText(document.getElementById('depositType'),
                invoiceData.depositType === 'online' ? '‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : 'Pre-order');

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            if (invoiceData.customer) {
                console.log('üéØ Customer details:', {
                    name: invoiceData.customer.name,
                    phone: invoiceData.customer.phone,
                    address: invoiceData.customer.address,
                    taxId: invoiceData.customer.taxId
                });
                setThaiText(document.getElementById('customerName'), invoiceData.customer.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                setThaiText(document.getElementById('customerPhone'), invoiceData.customer.phone || '-');

                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
                let customerAddress = '-';
                if (invoiceData.customer.address) {
                    if (typeof invoiceData.customer.address === 'object') {
                        customerAddress = [
                            invoiceData.customer.address.street,
                            invoiceData.customer.address.district,
                            invoiceData.customer.address.province,
                            invoiceData.customer.address.postalCode
                        ].filter(Boolean).join(', ');
                    } else {
                        customerAddress = invoiceData.customer.address;
                    }
                }
                setThaiText(document.getElementById('customerAddress'), customerAddress);
                setThaiText(document.getElementById('customerTaxId'), invoiceData.customer.taxId || '-');
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                console.log('‚ö†Ô∏è No customer data - using defaults');
                setThaiText(document.getElementById('customerName'), '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                setThaiText(document.getElementById('customerPhone'), '-');
                setThaiText(document.getElementById('customerAddress'), '-');
                setThaiText(document.getElementById('customerTaxId'), '-');
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            if (invoiceData.salesperson) {
                setThaiText(document.getElementById('salespersonName'), invoiceData.salesperson.name || '-');
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            if (invoiceData.product) {
                console.log('üéØ Product details:', {
                    name: invoiceData.product.name,
                    quantity: invoiceData.product.quantity,
                    price: invoiceData.product.price,
                    depositAmount: invoiceData.amounts?.depositAmount
                });

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                const urlParams = new URLSearchParams(window.location.search);
                const docType = urlParams.get('type') || invoiceData.docType || 'receipt';

                setThaiText(document.getElementById('productName'), invoiceData.product.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                setThaiText(document.getElementById('productQuantity'), invoiceData.product.quantity || 1);

                if (docType === 'receipt') {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                    const depositAmount = invoiceData.amounts?.depositAmount || 0;
                    setThaiText(document.getElementById('productPrice'),
                        `${depositAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})} (‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥)`);
                    setThaiText(document.getElementById('productTotal'),
                        depositAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                } else {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°
                    const depositAmount = invoiceData.amounts?.depositAmount || 0;
                    // ‡πÅ‡∏ï‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ
                    if (docType === 'taxinvoice') {
                        const beforeTaxAmount = Math.round((depositAmount / 1.07) * 100) / 100;
                        setThaiText(document.getElementById('productPrice'),
                            `${beforeTaxAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})} (‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥)`);
                        setThaiText(document.getElementById('productTotal'),
                            beforeTaxAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                    } else {
                        setThaiText(document.getElementById('productPrice'),
                            `${depositAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})} (‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥)`);
                        setThaiText(document.getElementById('productTotal'),
                            depositAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è No product data found in invoice data - using defaults');
                setThaiText(document.getElementById('productName'), '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                setThaiText(document.getElementById('productQuantity'), '1');
                setThaiText(document.getElementById('productPrice'), '0.00');
                setThaiText(document.getElementById('productTotal'), '0.00');
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
            if (invoiceData.saleType === 'installment' && invoiceData.product?.downAmount) {
                const installmentInfo = document.getElementById('installmentInfo');
                installmentInfo.style.display = 'block';

                setThaiText(document.getElementById('downAmount'),
                    `‡∏ø${(invoiceData.product.downAmount || 0).toLocaleString('th-TH')}`);
                setThaiText(document.getElementById('installmentCount'),
                    invoiceData.product.downInstallmentCount || '-');
                setThaiText(document.getElementById('monthlyPayment'),
                    `‡∏ø${(invoiceData.product.downInstallment || 0).toLocaleString('th-TH')}`);
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô - ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            if (invoiceData.amounts || invoiceData.product) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ invoiceData
                const urlParams = new URLSearchParams(window.location.search);
                const docType = urlParams.get('type') || invoiceData.docType || 'receipt';

                let subtotal, discount, beforeTax, vatAmount, totalAmount;

                if (docType === 'taxinvoice') {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ - ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ 11,250 ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å VAT ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
                    const totalWithVat = invoiceData.amounts?.depositAmount || invoiceData.amounts?.subtotal || 0;
                    discount = invoiceData.amounts?.discount || 0;
                    totalAmount = totalWithVat - discount; // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô
                    beforeTax = Math.round((totalAmount / 1.07) * 100) / 100; // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ
                    vatAmount = totalAmount - beforeTax; // VAT 7%
                    subtotal = beforeTax + discount; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                    console.log('üßæ TAX INVOICE - Amount includes VAT, extracting VAT for display');
                } else {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ VAT
                    subtotal = invoiceData.amounts?.depositAmount || 0; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                    discount = 0; // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                    beforeTax = subtotal;
                    vatAmount = 0; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á VAT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                    totalAmount = subtotal; // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° = ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢
                    console.log('üìÑ RECEIPT - Showing deposit amount only, no VAT');
                }

                console.log('üí∞ Amount calculations:', {
                    docType: docType,
                    subtotal: subtotal,
                    discount: discount,
                    beforeTax: beforeTax,
                    vatAmount: vatAmount,
                    totalAmount: totalAmount
                });

                setThaiText(document.getElementById('subtotalAmount'),
                    subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('discountAmount'),
                    discount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('beforeTaxAmount'),
                    beforeTax.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('vatAmount'),
                    vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('totalAmount'),
                    totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2}));
                setThaiText(document.getElementById('amountWords'), numberToThaiWords(totalAmount));
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
            updateBranchAndCompanyInfo(invoiceData);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
        function updateBranchAndCompanyInfo(invoiceData) {
            try {
                console.log('üè¢ Updating branch and company info...');

                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å invoiceData
                const branchInfo = invoiceData.branch;
                const companyInfo = invoiceData.company;

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô receiptData ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage (‡∏à‡∏≤‡∏Å DepositReceipt.html)
                const branchCode = branchInfo?.code ||
                                  localStorage.getItem('activeBranch') ||
                                  window.BRANCH_CODE || '00000';

                const branchName = branchInfo?.name ||
                                  localStorage.getItem('activeBranchName') ||
                                  '‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';

                console.log('üè¢ Branch Code:', branchCode);
                console.log('üè¢ Branch Name:', branchName);

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
                const companyDetailsElement = document.querySelector('.company-details');
                if (companyDetailsElement) {
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏ß‡πâ
                    const companyName = companyInfo?.name || '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î';
                    const taxId = companyInfo?.taxId || '0945566000616';
                    const phone = companyInfo?.phone || '09-2427-0769';

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏° branch code
                    let address = '';
                    if (branchCode === '00000') {
                        address = '148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000';
                    } else if (branchCode === '00001') {
                        address = branchInfo?.address || '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà';
                    } else {
                        address = branchInfo?.address || `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName}`;
                    }

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï company name
                    const companyNameElement = document.querySelector('.company-name');
                    if (companyNameElement) {
                        setThaiText(companyNameElement, companyName);
                    }

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï company details ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    const companyDetailsHTML = `
                        ‡∏™‡∏≤‡∏Ç‡∏≤: ${branchName} ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}<br>
                        ${address}<br>
                        ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≤‡∏Å‡∏£ ${taxId}<br>
                        ‡πÇ‡∏ó‡∏£: ${phone}
                    `;
                    companyDetailsElement.innerHTML = companyDetailsHTML;
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° thai-text class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö element ‡∏ô‡∏µ‡πâ
                    companyDetailsElement.classList.add('thai-text');

                    console.log('‚úÖ Updated company details with branch info');
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï title ‡∏Ç‡∏≠‡∏á PDF ‡∏î‡πâ‡∏ß‡∏¢
                document.title = `‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ - ${branchName}`;

            } catch (error) {
                console.error('‚ùå Error updating branch info:', error);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ mock data)
        function showNoDataAvailable() {
            console.log('‚ö†Ô∏è No real data available');

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡πÉ‡∏ô UI
            const debugInfo = {
                localStorage_keys: Object.keys(localStorage).filter(k => k.includes('Deposit') || k.includes('PDF') || k.includes('receipt')),
                url_params: Object.fromEntries(new URLSearchParams(window.location.search)),
                timestamp: new Date().toLocaleString('th-TH')
            };

            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; font-family: 'Prompt', sans-serif;">
                    <div style="text-align: center; padding: 40px; border: 2px solid #ff9800; border-radius: 8px; background: #fff3e0; max-width: 600px;">
                        <h2 style="color: #f57c00; margin-bottom: 20px;">üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h2>
                        <p style="color: #666; margin-bottom: 20px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</p>
                        <p style="color: #666; margin-bottom: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å DepositReceipt.html ‡∏Å‡πà‡∏≠‡∏ô</p>

                        <details style="margin: 20px 0; text-align: left;">
                            <summary style="cursor: pointer; color: #f57c00; font-weight: bold;">üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Debug</summary>
                            <div style="background: #f5f5f5; padding: 15px; margin-top: 10px; border-radius: 4px; font-size: 12px;">
                                <pre style="white-space: pre-wrap; margin: 0;">${JSON.stringify(debugInfo, null, 2)}</pre>
                            </div>
                        </details>

                        <div style="margin-top: 20px;">
                            <button onclick="window.close()" style="background: #f57c00; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                            <button onclick="window.location.reload()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showNoDataMessage(message = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à') {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Prompt', sans-serif;">
                    <div style="text-align: center; padding: 40px; border: 2px solid #f44336; border-radius: 8px; background: #ffebee;">
                        <h2 style="color: #d32f2f; margin-bottom: 20px;">${message}</h2>
                        <p style="color: #666; margin-bottom: 20px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                        <p style="color: #666;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å DepositReceipt.html ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    </div>
                </div>
            `;
        }

        // Prevent most API calls by overriding fetch, BUT allow signature-related APIs
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            // Allow signature-related API calls
            if (typeof url === 'string' && (url.includes('/signature') || url.includes('/signatures'))) {
                console.log('‚úÖ Allowing signature API call to:', url);
                return originalFetch.apply(this, arguments);
            }

            // Block other API calls to deposit-receipts endpoint
            if (typeof url === 'string' && url.includes('/api/deposit-receipts/')) {
                console.log('üö´ Blocked API call to:', url);
                return Promise.reject(new Error('API calls blocked - using localStorage only'));
            }
            return originalFetch.apply(this, arguments);
        };

        // Dictionary ‡∏Ç‡∏≠‡∏á text ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback
        const thaiTextFallbacks = {
            'docType': '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ',
            'company-name': '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
            'company-details': '‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ 00000<br>148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6 ‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ 94000<br>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏≤‡∏Å‡∏£ 0945566000616<br>‡πÇ‡∏ó‡∏£: 09-2427-0769'
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ UTF-8 encoding
        function forceUTF8Encoding() {
            if (document.characterSet !== 'UTF-8') {
                console.warn('‚ö†Ô∏è Document charset is not UTF-8:', document.characterSet);

                // ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö encoding
                const metaCharset = document.querySelector('meta[charset]');
                if (metaCharset) {
                    metaCharset.setAttribute('charset', 'UTF-8');
                }
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ document encoding properties
            document.documentElement.lang = 'th';
            document.documentElement.setAttribute('data-encoding', 'UTF-8');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç encoding ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
        function fixAllThaiEncoding() {
            console.log('üîß Fixing all Thai encoding...');

            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö UTF-8 ‡∏Å‡πà‡∏≠‡∏ô
            forceUTF8Encoding();

            // ‡∏´‡∏≤ elements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ class thai-text ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            const thaiElements = document.querySelectorAll('.thai-text, label, th, td, .signature-label, .terms');

            thaiElements.forEach(element => {
                const currentText = element.textContent || element.innerText;
                if (currentText && (currentText.includes('???') || currentText.includes('????') || currentText.includes('ÔøΩ'))) {
                    console.log('üîç Found broken encoding in:', element.id || element.className || element.tagName, 'text:', currentText);

                    // ‡∏•‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£ re-encode
                    let fixedText = currentText;
                    let fixed = false;

                    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ fallback text ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
                    if (element.id && thaiTextFallbacks[element.id]) {
                        fixedText = thaiTextFallbacks[element.id];
                        fixed = true;
                        console.log('üîß Using fallback text for:', element.id);
                    } else if (element.className.includes('company-name') && thaiTextFallbacks['company-name']) {
                        fixedText = thaiTextFallbacks['company-name'];
                        fixed = true;
                        console.log('üîß Using fallback text for company name');
                    }

                    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏•‡∏≠‡∏á decode URLs
                    if (!fixed) {
                        try {
                            fixedText = decodeURIComponent(escape(currentText));
                            if (!fixedText.includes('???') && !fixedText.includes('????')) {
                                fixed = true;
                                console.log('üîß Fixed using decodeURIComponent for:', element.id);
                            }
                        } catch (e) {
                            console.log('Method 1 failed for:', element.id || element.className);
                        }
                    }

                    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ TextDecoder
                    if (!fixed && window.TextDecoder) {
                        try {
                            const encoder = new TextEncoder();
                            const decoder = new TextDecoder('utf-8');
                            const encoded = encoder.encode(currentText);
                            fixedText = decoder.decode(encoded);
                            if (!fixedText.includes('???') && !fixedText.includes('????')) {
                                fixed = true;
                                console.log('üîß Fixed using TextDecoder for:', element.id);
                            }
                        } catch (e) {
                            console.log('Method 2 failed for:', element.id || element.className);
                        }
                    }

                    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 4: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ rewrite HTML
                    if (!fixed) {
                        if (element.innerHTML.includes('???') || element.innerHTML.includes('????')) {
                            console.log('üîß Attempting innerHTML fix for:', element.id || element.className);
                            // ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡πÉ‡∏´‡∏°‡πà
                            const newElement = document.createElement(element.tagName);
                            newElement.className = element.className;
                            newElement.id = element.id;

                            // ‡πÉ‡∏™‡πà text ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÅ‡∏ó‡∏ô
                            if (element.id === 'docType') {
                                newElement.textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';
                            } else if (element.className.includes('company-name')) {
                                newElement.textContent = '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î';
                            }

                            if (newElement.textContent && !newElement.textContent.includes('???')) {
                                element.parentNode.replaceChild(newElement, element);
                                fixed = true;
                                console.log('‚úÖ Replaced element for:', element.id || element.className);
                            }
                        }
                    }

                    // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                    if (fixed && fixedText !== currentText && !fixedText.includes('???')) {
                        if (element.innerHTML.includes('<br>') && fixedText.includes('<br>')) {
                            element.innerHTML = fixedText;
                        } else {
                            element.textContent = fixedText;
                        }

                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ font
                        element.style.fontFamily = 'Sarabun, "Noto Sans Thai", "TH Sarabun New", "THSarabun", "Arial Unicode MS", sans-serif';
                        element.style.fontDisplay = 'swap';

                        console.log('‚úÖ Fixed encoding for:', element.id || element.className, 'new text:', fixedText.substring(0, 50));
                    }
                }
            });

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç static labels ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            const labelMappings = [
                { selector: 'label', patterns: ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏ß‡∏¥‡∏ò‡∏µ', '‡∏ä‡∏∑‡πà‡∏≠', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] },
                { selector: 'th', patterns: ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] }
            ];

            labelMappings.forEach(mapping => {
                const elements = document.querySelectorAll(mapping.selector);
                elements.forEach(element => {
                    const text = element.textContent;
                    if (text && (text.includes('???') || text.includes('????'))) {
                        console.log('üîß Trying to fix label:', text);
                        // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ original HTML text
                        const originalText = element.getAttribute('data-original') || element.innerHTML;
                        if (originalText && !originalText.includes('???')) {
                            element.innerHTML = originalText;
                            console.log('‚úÖ Fixed label using original HTML');
                        }
                    }
                });
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = function() {
            console.log('üöÄ Tax Invoice/Receipt PDF Template loaded');
            console.log('üì¶ Current localStorage keys:', Object.keys(localStorage));

            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô localStorage
            console.log('üìã localStorage contents:');
            for (let key of Object.keys(localStorage)) {
                if (key.includes('Deposit') || key.includes('PDF') || key.includes('receipt')) {
                    try {
                        const value = localStorage.getItem(key);
                        console.log(`  ${key}:`, value ? value.substring(0, 200) + '...' : 'null');
                    } catch (e) {
                        console.log(`  ${key}: Error parsing`);
                    }
                }
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ branch code ‡∏à‡∏≤‡∏Å localStorage (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô DepositReceipt.html)
            const storedBranchCode = localStorage.getItem('activeBranch');
            const storedBranchName = localStorage.getItem('activeBranchName');

            if (storedBranchCode) {
                window.BRANCH_CODE = storedBranchCode;
                console.log('üè¢ Branch Code from localStorage:', storedBranchCode);
                console.log('üè¢ Branch Name from localStorage:', storedBranchName);
            } else {
                window.BRANCH_CODE = '00000'; // default
                console.log('üè¢ Using default branch code: 00000');
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication status
            console.log('üîê Checking authentication status...');
            if (checkAuthToken()) {
                console.log('‚úÖ Authentication valid - fingerprint features available');
                hideLoginButton();
            } else {
                console.log('‚ùå Authentication invalid - showing login button');
                showLoginButton();
            }

            const currentReceipt = localStorage.getItem('currentDepositReceipt');
            const currentPDFData = localStorage.getItem('currentPDFData');
            const allReceipts = localStorage.getItem('depositReceipts');

            console.log('üìÑ currentDepositReceipt data:', currentReceipt ? 'Found' : 'Not found');
            console.log('üìÑ currentPDFData data:', currentPDFData ? 'Found' : 'Not found');
            console.log('üìä depositReceipts count:', allReceipts ? JSON.parse(allReceipts).length : 0);

            // Debug: ‡πÅ‡∏™‡∏î‡∏á URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            console.log('üîó URL Parameters:', {
                type: urlParams.get('type'),
                id: urlParams.get('id'),
                _t: urlParams.get('_t')
            });

            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            if (currentPDFData) {
                try {
                    const pdfData = JSON.parse(currentPDFData);
                    console.log('üìã PDF Data preview:', {
                        docType: pdfData.docType,
                        receiptNumber: pdfData.receiptNumber,
                        hasTaxInvoiceData: !!pdfData.taxInvoiceData,
                        taxInvoiceNumber: pdfData.taxInvoiceData?.taxInvoiceNumber
                    });
                } catch (e) {
                    console.error('‚ùå Error parsing currentPDFData:', e);
                }
            }

            if (currentReceipt) {
                try {
                    const parsed = JSON.parse(currentReceipt);
                    console.log('‚úÖ Current receipt:', parsed.receiptNumber || 'No receipt number');
                    console.log('üè¢ Receipt branch info:', parsed.branch || 'No branch info');
                    console.log('üßæ Has tax invoice data:', !!parsed.taxInvoiceData);
                } catch (e) {
                    console.error('‚ùå Error parsing currentDepositReceipt:', e);
                }
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            if (!currentReceipt && !currentPDFData && (!allReceipts || JSON.parse(allReceipts || '[]').length === 0)) {
                console.log('‚ö†Ô∏è No data found anywhere - showing no data message');
                setTimeout(() => {
                    showNoDataAvailable();
                }, 100);
            } else {
                console.log('‚úÖ Found data, loading invoice...');
                loadInvoiceData().catch(console.error);
            }

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç encoding ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
            setTimeout(() => {
                fixAllThaiEncoding();
            }, 500);
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• encoding
        function debugEncoding() {
            console.log('üîç =================================');
            console.log('üîç ENCODING DEBUG INFORMATION');
            console.log('üîç =================================');
            console.log('üìÑ Document charset:', document.characterSet);
            console.log('üìÑ Document encoding:', document.inputEncoding);
            console.log('üåê Page language:', document.documentElement.lang);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö elements ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            const problemElements = [];
            const allElements = document.querySelectorAll('*');

            allElements.forEach(element => {
                const text = element.textContent || element.innerText;
                if (text && (text.includes('???') || text.includes('????') || text.includes('ÔøΩ'))) {
                    problemElements.push({
                        element: element,
                        id: element.id || 'no-id',
                        className: element.className || 'no-class',
                        tagName: element.tagName,
                        text: text.substring(0, 100),
                        innerHTML: element.innerHTML.substring(0, 100)
                    });
                }
            });

            console.log('üî¥ Found', problemElements.length, 'elements with encoding issues:');
            problemElements.forEach((item, index) => {
                console.log(`${index + 1}. ${item.tagName}#${item.id}.${item.className}`);
                console.log(`   Text: "${item.text}"`);
                console.log(`   HTML: "${item.innerHTML}"`);
                console.log('   ---');
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ fonts ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
            if (document.fonts) {
                document.fonts.ready.then(() => {
                    console.log('‚úÖ Loaded fonts:');
                    for (let font of document.fonts) {
                        console.log(`   - ${font.family} (${font.style}, ${font.weight})`);
                    }
                });
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô UI ‡∏î‡πâ‡∏ß‡∏¢
            alert(`Encoding Debug Info:
Document Charset: ${document.characterSet}
Document Language: ${document.documentElement.lang}
Elements with encoding issues: ${problemElements.length}

${problemElements.length > 0 ? 'Check console for detailed information.' : 'No encoding issues found!'}`);

            return problemElements;
        }

        // ===== SIGNATURE MANAGEMENT =====
        let currentSignatureType = null;
        let isDrawing = false;
        let signatureCanvas = null;
        let signatureCtx = null;
        let signatures = {
            customer: null,
            cashier: null
        };

        function openSignatureModal(type) {
            currentSignatureType = type;
            const modal = document.getElementById('signatureModal');
            const title = document.getElementById('signatureModalTitle');

            if (type === 'customer') {
                title.textContent = '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            } else if (type === 'cashier') {
                title.textContent = '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';
            }

            modal.style.display = 'flex';
            initSignatureCanvas();
        }

        function closeSignatureModal() {
            const modal = document.getElementById('signatureModal');
            modal.style.display = 'none';
            currentSignatureType = null;
        }

        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');

            // Set canvas background to white
            signatureCtx.fillStyle = '#ffffff';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);

            // Set drawing style
            signatureCtx.strokeStyle = '#000000';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Add event listeners
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            signatureCanvas.addEventListener('touchstart', handleTouch);
            signatureCanvas.addEventListener('touchmove', handleTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                signatureCtx.beginPath();
                isDrawing = false;
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            signatureCtx.fillStyle = '#ffffff';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        async function saveSignature() {
            if (!currentSignatureType) return;

            try {
                // Get signature as base64 data URL
                const signatureDataURL = signatureCanvas.toDataURL('image/png');

                // Store signature locally
                signatures[currentSignatureType] = signatureDataURL;

                // Update display canvas
                updateSignatureDisplay(currentSignatureType, signatureDataURL);

                // Save to backend
                await saveSignatureToBackend(currentSignatureType, signatureDataURL);

                closeSignatureModal();

                console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ${currentSignatureType} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        function updateSignatureDisplay(type, dataURL) {
            const displayCanvas = document.getElementById(`${type}SignatureDisplay`);
            const placeholder = document.getElementById(`${type}SignaturePlaceholder`);

            if (displayCanvas && placeholder) {
                const ctx = displayCanvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    // Clear canvas with transparent background for on-line signature
                    ctx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);

                    // Draw signature on transparent background
                    ctx.drawImage(img, 0, 0, displayCanvas.width, displayCanvas.height);

                    // Show canvas, hide placeholder
                    displayCanvas.style.display = 'block';
                    placeholder.style.display = 'none';
                };

                img.src = dataURL;
            }
        }

        async function saveSignatureToBackend(type, signatureData) {
            const receiptId = getCurrentReceiptId();
            if (!receiptId) {
                console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Receipt ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô');
                return;
            }

            const response = await fetch(`/api/deposit-receipts/${receiptId}/signature`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({
                    signatureType: type,
                    signatureData: signatureData
                })
            });

            if (!response.ok) {
                throw new Error(`Failed to save signature: ${response.statusText}`);
            }

            const result = await response.json();
            console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result);
        }

        function getCurrentReceiptId() {
            // Extract receipt ID from URL parameters or global variable
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || window.currentReceiptId;
        }

        // ===== FINGERPRINT SCANNING =====
        let fingerprintService = {
            isInitialized: false,
            isConnected: false
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ authentication
        async function authenticatedFetch(url, options = {}) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication ‡∏Å‡πà‡∏≠‡∏ô
            if (!checkAuthToken()) {
                throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            const token = localStorage.getItem('authToken');
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const fetchOptions = {
                ...options,
                headers: headers,
                credentials: 'include'
            };

            const response = await fetch(url, fetchOptions);

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('authToken'); // ‡∏•‡∏ö token ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                    throw new Error('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                } else if (response.status === 403) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ');
                } else {
                    throw new Error(`HTTP ${response.status}: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠`);
                }
            }

            return response;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        function showLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.style.display = 'inline-block';
            }
        }

        function hideLoginButton() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.style.display = 'none';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
        function redirectToLogin() {
            const confirmRedirect = confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ');
            if (confirmRedirect) {
                // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                localStorage.removeItem('authToken');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                window.location.href = '/login';
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        async function initializeFingerprintService() {
            try {
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠...');

                const response = await authenticatedFetch('/api/fingerprint/initialize', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    fingerprintService.isInitialized = true;
                    console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

                    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
                    await connectFingerprintDevice();
                } else {
                    throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ');
                }

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠:', error);
                fingerprintService.isInitialized = false;

                // ‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
                if (error.message.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö') || error.message.includes('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏')) {
                    showLoginButton();
                    alert('‚ùå ' + error.message + '\n\n‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                }

                throw error;
            }
        }

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        async function connectFingerprintDevice() {
            try {
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠...');

                const headers = {
                    'Content-Type': 'application/json'
                };

                const token = localStorage.getItem('authToken');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/fingerprint/connect', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        deviceIP: '100.106.108.57'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    fingerprintService.isConnected = true;
                    console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô:', error);
                fingerprintService.isConnected = false;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
                if (error.message.includes('Failed to fetch') || error.message.includes('ECONNREFUSED')) {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ\n\nüìç IP: 100.106.108.57:8890 (Tailscale)\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n‚úÖ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà IP 100.106.108.57 ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà\n‚úÖ Windows ZKTeco Service ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥\n‚úÖ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ZK9500 ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ USB ‡πÅ‡∏•‡πâ‡∏ß\n‚úÖ Tailscale ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥\n‚úÖ Port 8890 ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà');
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠');
                    // ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                } else {
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:\n' + error.message);
                }

                throw error;
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö authentication token
        function checkAuthToken() {
            // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å key ‡πÉ‡∏ô localStorage
            console.log('üîç All localStorage keys:', Object.keys(localStorage));
            console.log('üîç localStorage contents:', {
                authToken: localStorage.getItem('authToken'),
                token: localStorage.getItem('token'),
                jwt: localStorage.getItem('jwt'),
                userToken: localStorage.getItem('userToken'),
                accessToken: localStorage.getItem('accessToken')
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á authToken ‡πÅ‡∏•‡∏∞ token ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡πá‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á
            let token = localStorage.getItem('authToken') || localStorage.getItem('token');
            console.log('üîê Checking auth token:', token ? 'Found' : 'Not found');
            console.log('üîê Token source:', localStorage.getItem('authToken') ? 'authToken' :
                                           localStorage.getItem('token') ? 'token' : 'none');

            if (!token) {
                console.log('‚ùå No auth token found');
                return false;
            }

            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô JWT)
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]));
                    const now = Date.now() / 1000;

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö expiry ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ exp field
                    if (payload.exp && payload.exp < now) {
                        console.log('‚ùå Auth token expired');
                        localStorage.removeItem('authToken');
                        return false;
                    }

                    console.log('‚úÖ Auth token valid (JWT format)');
                    return true;
                } else {
                    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JWT format ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
                    console.log('‚úÖ Auth token valid (non-JWT format)');
                    return true;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Cannot decode token, assume valid:', error.message);
                return true; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ decode ‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        async function testFingerprintConnection() {
            const testBtn = event.target;
            const originalText = testBtn.innerHTML;

            try {
                testBtn.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
                testBtn.disabled = true;

                console.log('üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠...');

                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API status
                console.log('1Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API Status...');
                const statusResponse = await authenticatedFetch('/api/fingerprint/status');
                const statusResult = await statusResponse.json();
                console.log('‚úÖ API Status OK:', statusResult);

                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                console.log('2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
                await connectFingerprintDevice();

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                const deviceStatus = statusResult.data;
                const statusText = `
üéØ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:

üì° API Server: ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
üñ•Ô∏è Target IP: ${deviceStatus.host || '100.106.108.57'}:${deviceStatus.port || '8890'}
üîå Service Status: ${deviceStatus.serviceRunning ? '‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'}
üéÆ Device Connected: ${deviceStatus.deviceConnected ? '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' : '‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'}
‚ö° Initialized: ${deviceStatus.isInitialized ? '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'}

${deviceStatus.deviceConnected ?
    'üéâ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!' :
    '‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ USB ‡πÅ‡∏•‡∏∞ Windows Service'}
                `;

                alert(statusText);

            } catch (error) {
                console.error('‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);

                let errorMessage = '‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\n\n';

                if (error.message.includes('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')) {
                    showLoginButton();
                    errorMessage += 'üîê ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö\nüí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('ECONNREFUSED')) {
                    errorMessage += `üåê ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
üìç IP: 100.106.108.57:8890 (Tailscale)

üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà IP 100.106.108.57 ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Windows ZKTeco Service ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ZK9500 ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ USB
‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Tailscale ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥`;
                } else {
                    errorMessage += 'üêõ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                }

                alert(errorMessage);
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Global variables for fingerprint scanning
        let currentFingerprintScan = {
            signatureType: null,
            receiptId: null,
            isScanning: false,
            result: null
        };

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        function scanFingerprint(signatureType) {
            const receiptId = getCurrentReceiptId();
            if (!receiptId) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà');
                return;
            }

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
            currentFingerprintScan = {
                signatureType: signatureType,
                receiptId: receiptId,
                isScanning: false,
                result: null
            };

            // ‡πÄ‡∏õ‡∏¥‡∏î modal
            openFingerprintModal(signatureType);
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î Fingerprint Modal
        function openFingerprintModal(signatureType) {
            const modal = document.getElementById('fingerprintModal');
            const title = document.getElementById('fingerprintModalTitle');

            // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ modal ‡∏ï‡∏≤‡∏° signature type
            const typeNames = {
                'customer': '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                'seller': '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢',
                'witness': '‡∏û‡∏¢‡∏≤‡∏ô'
            };

            title.textContent = `‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠${typeNames[signatureType] || ''}`;

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï modal state
            resetFingerprintModal();

            // ‡πÅ‡∏™‡∏î‡∏á modal
            modal.style.display = 'flex';
        }

        // ‡∏õ‡∏¥‡∏î Fingerprint Modal
        function closeFingerprintModal() {
            const modal = document.getElementById('fingerprintModal');
            modal.style.display = 'none';

            // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏¢‡∏π‡πà
            if (currentFingerprintScan.isScanning) {
                currentFingerprintScan.isScanning = false;
            }

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï state
            resetFingerprintModal();
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Modal State
        function resetFingerprintModal() {
            // ‡πÅ‡∏™‡∏î‡∏á placeholder
            document.querySelector('.fingerprint-placeholder').style.display = 'block';
            document.getElementById('fingerprintImage').style.display = 'none';

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï status
            updateFingerprintStatus('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°');
            hideProgress();
            hideScanning();

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï buttons
            showButton('startScanBtn');
            hideButton('retryBtn');
            hideButton('saveFingerBtn');
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Status Text
        function updateFingerprintStatus(text) {
            document.getElementById('fingerprintStatusText').textContent = text;
        }

        // ‡πÅ‡∏™‡∏î‡∏á Progress Bar
        function showProgress(percentage = 0) {
            const progressBar = document.getElementById('fingerprintProgress');
            const progressFill = progressBar.querySelector('.progress-fill');

            progressBar.style.display = 'block';
            progressFill.style.width = percentage + '%';
        }

        // ‡∏ã‡πà‡∏≠‡∏ô Progress Bar
        function hideProgress() {
            document.getElementById('fingerprintProgress').style.display = 'none';
        }

        // ‡πÅ‡∏™‡∏î‡∏á Scanning Animation
        function showScanning() {
            document.getElementById('scanningAnimation').style.display = 'block';
        }

        // ‡∏ã‡πà‡∏≠‡∏ô Scanning Animation
        function hideScanning() {
            const scanningElement = document.getElementById('scanningAnimation');
            if (scanningElement) {
                scanningElement.style.display = 'none';
            }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°
        function showButton(buttonId) {
            const buttonElement = document.getElementById(buttonId);
            if (buttonElement) {
                buttonElement.style.display = 'inline-block';
            }
        }

        function hideButton(buttonId) {
            const buttonElement = document.getElementById(buttonId);
            if (buttonElement) {
                buttonElement.style.display = 'none';
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        async function startFingerprintScan() {
            if (currentFingerprintScan.isScanning) return;

            currentFingerprintScan.isScanning = true;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI
            updateFingerprintStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
            hideButton('startScanBtn');
            showProgress(10);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            if (!fingerprintService.isInitialized || !fingerprintService.isConnected) {
                updateFingerprintStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
                showProgress(30);

                await initializeFingerprintService();

                if (!fingerprintService.isConnected) {
                    updateFingerprintStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ');
                    hideProgress();
                    showButton('retryBtn');
                    currentFingerprintScan.isScanning = false;
                    return;
                }
            }

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏£‡∏¥‡∏á
            updateFingerprintStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô...');
            showProgress(50);
            showScanning();

            try {
                console.log(`üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${currentFingerprintScan.signatureType}...`);

                const response = await fetch('/api/fingerprint/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        receiptId: currentFingerprintScan.receiptId,
                        signatureType: currentFingerprintScan.signatureType,
                        timeout: 30000,
                        quality: 'high'
                    })
                });

                if (!currentFingerprintScan.isScanning) return; // ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', result.data);

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Base64 > HTTP URL > Status Message
                    if (result.data.imageData) {
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Base64 data
                        console.log('üì∑ ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Base64 data:', result.data.imageData.length, 'chars');
                        const base64Image = `data:image/jpeg;base64,${result.data.imageData}`;
                        showFingerprintPreview(base64Image);
                    } else if (result.data.imageUrl && result.data.imageUrl.startsWith('http')) {
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å HTTP URL
                        console.log('üì∑ ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å HTTP URL:', result.data.imageUrl);
                        showFingerprintPreview(result.data.imageUrl);
                    } else if (result.data.imageNote && result.data.imageNote.includes('access restricted')) {
                        showFingerprintMessage('‚úÖ ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>üì∑ ‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Windows<br>üîí ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢');
                    } else {
                        showFingerprintMessage('‚úÖ ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>üì∑ ‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    }

                    updateFingerprintStatus(`‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û: ${result.data.quality || '‡∏î‡∏µ'}`);
                    showProgress(100);
                    hideScanning();

                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    currentFingerprintScan.result = result.data;

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    hideButton('startScanBtn');
                    showButton('saveFingerBtn');

                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠:', error);

                updateFingerprintStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                hideProgress();
                hideScanning();
                showButton('retryBtn');
            } finally {
                currentFingerprintScan.isScanning = false;
            }
        }

        // ‡∏•‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        function retryFingerprintScan() {
            resetFingerprintModal();
            setTimeout(() => startFingerprintScan(), 500);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û preview
        function showFingerprintPreview(imageUrl) {
            const placeholder = document.querySelector('.fingerprint-placeholder');
            const imageElement = document.getElementById('fingerprintImage');

            placeholder.style.display = 'none';
            imageElement.src = imageUrl;
            imageElement.style.display = 'block';
        }

        function showFingerprintMessage(message) {
            const placeholder = document.querySelector('.fingerprint-placeholder');
            const imageElement = document.getElementById('fingerprintImage');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            if (imageElement) imageElement.style.display = 'none';

            if (placeholder) {
                placeholder.innerHTML = `<div style="padding: 20px; text-align: center; color: #2e7d32; font-size: 14px; line-height: 1.6;">${message}</div>`;
                placeholder.style.display = 'block';
                placeholder.style.backgroundColor = '#e8f5e8';
                placeholder.style.border = '2px dashed #4caf50';
                placeholder.style.borderRadius = '8px';
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        function saveFingerprintResult() {
            if (!currentFingerprintScan.result) return;

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å - ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á imageUrl ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á local file access
            if (currentFingerprintScan.result.imageUrl) {
                updateFingerprintDisplay(
                    currentFingerprintScan.signatureType,
                    currentFingerprintScan.result.imageUrl
                );
            } else {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ imageUrl
                const placeholder = document.getElementById(`${currentFingerprintScan.signatureType}SignaturePlaceholder`);
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div style="padding: 15px; text-align: center; color: #2e7d32; font-size: 12px;">
                            ‚úÖ ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        </div>
                    `;
                    placeholder.style.display = 'block';
                }
            }

            // ‡∏õ‡∏¥‡∏î modal
            closeFingerprintModal();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
        function updateFingerprintDisplay(type, imageUrl) {
            const fingerprintDisplay = document.getElementById(`${type}FingerprintDisplay`);
            const placeholder = document.getElementById(`${type}SignaturePlaceholder`);
            const signatureDisplay = document.getElementById(`${type}SignatureDisplay`);

            if (fingerprintDisplay && placeholder && imageUrl && imageUrl !== 'null') {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á imageUrl ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                if (imageUrl.startsWith('data:image/')) {
                    // Base64 data URL - ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    console.log('üì∑ Display Base64 image for', type);
                    fingerprintDisplay.src = imageUrl;
                    fingerprintDisplay.style.display = 'block';
                    placeholder.style.display = 'none';
                } else if (imageUrl.startsWith('http')) {
                    // HTTP/HTTPS URL - ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    console.log('üì∑ Display HTTP image for', type, ':', imageUrl);
                    fingerprintDisplay.src = imageUrl;
                    fingerprintDisplay.style.display = 'block';
                    placeholder.style.display = 'none';
                } else if (imageUrl.startsWith('D:') || imageUrl.startsWith('file:') || imageUrl.includes('ZKT3')) {
                    // Local file path - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
                    console.log('üîí Local file path detected for', type, ', showing message instead');
                    placeholder.innerHTML = `
                        <div style="padding: 15px; text-align: center; color: #2e7d32; font-size: 12px; line-height: 1.4;">
                            ‚úÖ ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß<br>
                            üì∑ ‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå<br>
                            üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                        </div>
                    `;
                    placeholder.style.display = 'block';
                    placeholder.style.backgroundColor = '#e8f5e8';
                    placeholder.style.border = '2px dashed #4caf50';
                    placeholder.style.borderRadius = '8px';
                    fingerprintDisplay.style.display = 'none';
                } else {
                    // URL ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (relative path ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô)
                    fingerprintDisplay.src = imageUrl;
                    fingerprintDisplay.style.display = 'block';
                    placeholder.style.display = 'none';
                }

                // ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (signatureDisplay) {
                    signatureDisplay.style.display = 'none';
                }

                console.log(`‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠ ${type} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        async function loadSignaturesFromDatabase() {
            const receiptId = getCurrentReceiptId();
            if (!receiptId) {
                console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Receipt ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô');
                return;
            }

            try {
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

                const response = await fetch(`/api/deposit-receipts/${receiptId}/signatures`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('üìÑ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏µ‡πâ');
                        return;
                    }
                    throw new Error(`Failed to load signatures: ${response.statusText}`);
                }

                const result = await response.json();
                const signaturesData = result.data.signatures;
                const fingerprintsData = result.data.fingerprints;

                if (signaturesData) {
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    if (signaturesData.customerSignature && signaturesData.customerSignature.data) {
                        signatures.customer = signaturesData.customerSignature.data;
                        updateSignatureDisplay('customer', signaturesData.customerSignature.data);
                        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    }

                    // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    if (signaturesData.cashierSignature && signaturesData.cashierSignature.data) {
                        signatures.cashier = signaturesData.cashierSignature.data;
                        updateSignatureDisplay('cashier', signaturesData.cashierSignature.data);
                        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    }
                }

                // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
                if (fingerprintsData) {
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    if (fingerprintsData.customerFingerprint) {
                        if (fingerprintsData.customerFingerprint.imageUrl) {
                            updateFingerprintDisplay('customer', fingerprintsData.customerFingerprint.imageUrl);
                        } else {
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û
                            const placeholder = document.getElementById('customerSignaturePlaceholder');
                            if (placeholder) {
                                placeholder.innerHTML = `
                                    <div style="padding: 15px; text-align: center; color: #2e7d32; font-size: 12px;">
                                        ‚úÖ ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                                    </div>
                                `;
                                placeholder.style.display = 'block';
                            }
                        }
                        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    }

                    // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    if (fingerprintsData.cashierFingerprint) {
                        if (fingerprintsData.cashierFingerprint.imageUrl) {
                            updateFingerprintDisplay('cashier', fingerprintsData.cashierFingerprint.imageUrl);
                        } else {
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û
                            const placeholder = document.getElementById('cashierSignaturePlaceholder');
                            if (placeholder) {
                                placeholder.innerHTML = `
                                    <div style="padding: 15px; text-align: center; color: #2e7d32; font-size: 12px;">
                                        ‚úÖ ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                                    </div>
                                `;
                                placeholder.style.display = 'block';
                            }
                        }
                        console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    }
                }

                if (!signaturesData && !fingerprintsData) {
                    console.log('üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                }

            } catch (error) {
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:', error);
                // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á alert ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
            }
        }
    </script>

    <!-- Signature Modal -->
    <div id="signatureModal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content">
            <div class="signature-modal-header">
                <h3 id="signatureModalTitle" class="thai-text">‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠</h3>
                <button onclick="closeSignatureModal()" class="modal-close">&times;</button>
            </div>
            <div class="signature-modal-body">
                <canvas id="signatureCanvas" width="400" height="200"></canvas>
                <div class="signature-controls">
                    <button onclick="clearSignature()" class="btn-clear thai-text">‡∏•‡πâ‡∏≤‡∏á</button>
                    <button onclick="saveSignature()" class="btn-save thai-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="closeSignatureModal()" class="btn-cancel thai-text">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fingerprint Scanning Modal -->
    <div id="fingerprintModal" class="fingerprint-modal" style="display: none;">
        <div class="fingerprint-modal-content">
            <div class="fingerprint-modal-header">
                <h3 id="fingerprintModalTitle" class="thai-text">‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</h3>
                <button onclick="closeFingerprintModal()" class="modal-close">&times;</button>
            </div>
            <div class="fingerprint-modal-body">
                <div class="fingerprint-preview-container">
                    <div id="fingerprintPreview" class="fingerprint-preview">
                        <div class="fingerprint-placeholder">
                            <span class="fingerprint-icon">üëÜ</span>
                            <p class="thai-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</p>
                            <div class="scanning-animation" id="scanningAnimation" style="display: none;">
                                <div class="scanning-line"></div>
                            </div>
                        </div>
                        <img id="fingerprintImage" style="display: none;" alt="Fingerprint Preview">
                    </div>
                    <div class="fingerprint-status">
                        <div id="fingerprintStatusText" class="status-text thai-text">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
                        <div id="fingerprintProgress" class="progress-bar" style="display: none;">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="fingerprint-controls">
                    <button id="startScanBtn" onclick="startFingerprintScan()" class="btn-scan thai-text">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
                    <button id="retryBtn" onclick="retryFingerprintScan()" class="btn-retry thai-text" style="display: none;">‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                    <button id="saveFingerBtn" onclick="saveFingerprintResult()" class="btn-save thai-text" style="display: none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="closeFingerprintModal()" class="btn-cancel thai-text">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Signature Modal -->
    <div id="qrSignatureModal" class="signature-modal" style="display: none;">
        <div class="signature-modal-content" style="max-width: 450px;">
            <div class="signature-modal-header">
                <h3 id="qrSignatureModalTitle" class="thai-text">üì± ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô QR Code</h3>
                <button onclick="closeQRSignatureModal()" class="modal-close">&times;</button>
            </div>
            <div class="signature-modal-body" style="text-align: center;">
                <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px;">
                    <p class="thai-text" style="margin-bottom: 15px; color: #6c757d; font-size: 13px;">
                        ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ iPad ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ô‡∏≤‡∏°
                    </p>
                    <div style="background: white; padding: 15px; border-radius: 8px; display: inline-block;">
                        <div id="qrSignatureCanvas" style="width: 150px; height: 150px;"></div>
                    </div>
                    <div id="qrSignatureStatus" class="qr-status" style="margin-top: 15px; font-size: 12px; color: #6c757d;">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...
                    </div>
                </div>
                <div style="padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                    <p class="thai-text" style="font-size: 12px; color: #856404; margin: 0;">
                        ‚è±Ô∏è QR Code ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
                    </p>
                </div>
                <div id="qrSignaturePreview" style="display: none; margin-top: 20px;">
                    <p class="thai-text" style="color: #28a745; font-weight: 600; margin-bottom: 10px;">
                        ‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                    </p>
                    <img id="qrSignatureImage" style="max-width: 100%; border: 2px solid #28a745; border-radius: 8px;" alt="Signature">
                </div>
                <button onclick="closeQRSignatureModal()" class="btn-cancel thai-text" style="margin-top: 15px;">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <style>
        .signature-placeholder {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
            text-align: center;
            padding: 10px;
            border: 1px dashed #ccc;
            background-color: #f9f9f9;
        }

        .signature-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .signature-modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .signature-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .signature-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #000;
        }

        #signatureCanvas {
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }

        .signature-controls {
            margin-top: 15px;
            text-align: center;
        }

        .signature-controls button {
            margin: 0 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-clear {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-clear:hover {
            background-color: #e0e0e0;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #c82333;
        }

        /* Fingerprint Modal Styles */
        .fingerprint-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fingerprint-modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .fingerprint-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 15px;
        }

        .fingerprint-modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1976d2;
            font-weight: 600;
        }

        .fingerprint-preview-container {
            margin-bottom: 20px;
        }

        .fingerprint-preview {
            position: relative;
            width: 100%;
            height: 280px;
            border: 3px dashed #2196f3;
            border-radius: 12px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .fingerprint-placeholder {
            text-align: center;
            color: #1976d2;
        }

        .fingerprint-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .fingerprint-placeholder p {
            font-size: 16px;
            margin: 10px 0;
            font-weight: 500;
        }

        .scanning-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(33, 150, 243, 0.1);
        }

        .scanning-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #2196f3, transparent);
            animation: scan 2s infinite;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: calc(100% - 3px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        #fingerprintImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .fingerprint-status {
            margin-top: 15px;
            text-align: center;
        }

        .status-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1976d2;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #2196f3);
            width: 0%;
            transition: width 0.3s ease;
            animation: progressPulse 1.5s infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fingerprint-controls {
            margin-top: 20px;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .fingerprint-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-scan {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-retry {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-retry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        .btn-save {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        /* QR Signature Styles */
        .qr-signature-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        .qr-signature-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qr-signature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .qr-signature-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .qr-signature-label {
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .qr-canvas-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .qr-canvas {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        .btn-qr {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-qr:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .qr-status {
            font-size: 10px;
            color: #6c757d;
            margin-top: 8px;
        }

        .qr-status.success {
            color: #28a745;
            font-weight: 600;
        }

        .signature-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-top: 10px;
        }

        @media print {
            .qr-signature-section {
                page-break-inside: avoid;
            }
        }
    </style>

    <!-- Socket.IO for Real-time Updates -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // QR Code Signature System
        const QRSignatureManager = {
            sessions: {},
            socket: null,

            init() {
                try {
                    this.socket = io();
                    this.socket.on('connect', () => {
                        console.log('‚úÖ Socket.IO connected for QR signatures');
                    });

                    this.socket.on('signature-saved', (data) => {
                        console.log('üì® Received signature:', data);
                        this.handleSignatureReceived(data);
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Socket.IO not available, using polling');
                }
            },

            async createQRSignature(receiptId, signatureType, canvasId, statusId) {
                try {
                    // Get token from multiple possible sources
                    const token = localStorage.getItem('authToken') ||
                                  localStorage.getItem('token') ||
                                  localStorage.getItem('jwt') ||
                                  localStorage.getItem('userToken');

                    if (!token) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    }

                    console.log('üîë Creating QR signature with token:', {
                        receiptId,
                        signatureType,
                        hasToken: !!token,
                        tokenLength: token.length,
                        tokenPreview: token.substring(0, 20) + '...'
                    });

                    const response = await fetch('/api/qr-signature/create-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ receiptId, signatureType })
                    });

                    const result = await response.json();

                    console.log('üì° QR Signature API Response:', {
                        status: response.status,
                        ok: response.ok,
                        result
                    });

                    if (!response.ok || !result.success) {
                        throw new Error(result.message || `HTTP Error: ${response.status}`);
                    }

                    // Store session
                    this.sessions[result.data.sessionId] = {
                        canvasId,
                        statusId,
                        signatureType,
                        receiptId
                    };

                    // Generate QR Code
                    const canvas = document.getElementById(canvasId);

                    // Wait for QRCode library to load
                    if (typeof QRCode === 'undefined') {
                        console.log('‚è≥ Waiting for QRCode library to load...');
                        try {
                            await loadQRCodeLibrary();
                        } catch (error) {
                            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î QRCode library ‡πÑ‡∏î‡πâ: ' + error.message);
                        }
                    }

                    if (typeof QRCode === 'undefined') {
                        throw new Error('QRCode library ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    }

                    console.log('‚úÖ QRCode library loaded, generating QR...');
                    console.log('üìç Canvas element:', canvas);
                    console.log('üîó QR URL:', result.data.signatureUrl);

                    // Clear element first
                    if (canvas) {
                        canvas.innerHTML = '';

                        // Create QR Code (using QRCode.js library)
                        const qr = new QRCode(canvas, {
                            text: result.data.signatureUrl,
                            width: 150,
                            height: 150,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        console.log('‚úÖ QR Code generated successfully:', qr);
                    } else {
                        console.error('‚ùå Canvas element not found');
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á QR Code');
                    }

                    // Update status
                    this.updateStatus(statusId, '‚è≥ ‡∏£‡∏≠‡∏•‡∏á‡∏ô‡∏≤‡∏°...', false);

                    // Start polling if no Socket.IO
                    if (!this.socket || !this.socket.connected) {
                        this.startPolling(result.data.sessionId);
                    }

                    return result.data;
                } catch (error) {
                    console.error('Error creating QR signature:', error);
                    this.updateStatus(statusId, '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', false);
                    throw error;
                }
            },

            startPolling(sessionId, interval = 2000) {
                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/qr-signature/poll/${sessionId}`);
                        const result = await response.json();

                        if (result.status === 'signed' && result.data.signatureData) {
                            clearInterval(pollInterval);
                            this.handleSignatureReceived({
                                sessionId,
                                receiptId: result.data.receiptId,
                                signatureType: result.data.signatureType,
                                signatureData: result.data.signatureData
                            });
                        } else if (response.status === 404 || response.status === 410) {
                            clearInterval(pollInterval);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, interval);
            },

            handleSignatureReceived(data) {
                const session = this.sessions[data.sessionId];
                if (!session) {
                    console.warn('‚ö†Ô∏è Session not found:', data.sessionId);
                    return;
                }

                console.log(`‚úÖ Processing signature for ${data.signatureType}`);

                // Update status
                this.updateStatus(session.statusId, '‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß', true);

                // Display signature on the receipt
                const canvasId = data.signatureType === 'customer' ? 'customerSignatureDisplay' : 'cashierSignatureDisplay';
                const canvas = document.getElementById(canvasId);

                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.style.display = 'block';
                        console.log(`‚úÖ Signature displayed on ${canvasId}`);
                    };
                    img.src = data.signatureData;
                } else {
                    console.error(`‚ùå Canvas not found: ${canvasId}`);
                }

                // Store signature data (can be saved to database here)
                this.saveSignatureToReceipt(data.receiptId, data.signatureType, data.signatureData);

                // Close modal after 1.5 seconds
                setTimeout(() => {
                    closeQRSignatureModal();
                }, 1500);

                // Cleanup session
                delete this.sessions[data.sessionId];
            },

            updateStatus(statusId, message, success) {
                const statusEl = document.getElementById(statusId);
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = success ? 'qr-status success' : 'qr-status';
                }
            },

            async saveSignatureToReceipt(receiptId, signatureType, signatureData) {
                console.log(`üíæ Saving ${signatureType} signature for receipt ${receiptId}`);
                // TODO: Implement actual save to database
                // This should call your receipt update API
            }
        };

        // Load QRCode library dynamically if not loaded
        function loadQRCodeLibrary() {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (typeof QRCode !== 'undefined') {
                    console.log('‚úÖ QRCode library already loaded');
                    resolve();
                    return;
                }

                // Try loading from local file first
                const script = document.createElement('script');
                script.src = '/js/qrcode.min.js';
                script.async = false; // Load synchronously

                script.onload = () => {
                    console.log('‚úÖ QRCode library loaded from local file');
                    resolve();
                };

                script.onerror = () => {
                    console.warn('‚ö†Ô∏è Failed to load local QRCode library, trying CDN...');
                    // Fallback to CDN
                    const cdnScript = document.createElement('script');
                    cdnScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                    cdnScript.async = false;

                    cdnScript.onload = () => {
                        console.log('‚úÖ QRCode library loaded from CDN');
                        resolve();
                    };

                    cdnScript.onerror = () => {
                        console.error('‚ùå Failed to load QRCode library from all sources');
                        reject(new Error('Cannot load QRCode library'));
                    };

                    document.head.appendChild(cdnScript);
                };

                document.head.appendChild(script);
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            QRSignatureManager.init();

            // Load QRCode library
            try {
                await loadQRCodeLibrary();
                console.log('‚úÖ QRCode library is ready for use');
            } catch (error) {
                console.error('‚ö†Ô∏è QRCode library load error:', error);
            }
        });

        // Helper function to generate QR for signature
        function generateSignatureQR(signatureType) {
            // Get receipt ID from page (you'll need to add this)
            const receiptId = 'RECEIPT-ID'; // TODO: Get actual receipt ID

            const canvasId = `qr-canvas-${signatureType}`;
            const statusId = `qr-status-${signatureType}`;

            QRSignatureManager.createQRSignature(receiptId, signatureType, canvasId, statusId);
        }

        // Open QR Signature Modal
        let currentQRSignatureType = null;
        let currentQRSession = null;

        async function openQRSignatureModal(signatureType) {
            const modal = document.getElementById('qrSignatureModal');
            const title = document.getElementById('qrSignatureModalTitle');
            const canvas = document.getElementById('qrSignatureCanvas');
            const status = document.getElementById('qrSignatureStatus');
            const preview = document.getElementById('qrSignaturePreview');

            currentQRSignatureType = signatureType;

            // Set title
            const titles = {
                'customer': 'üì± ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô QR Code - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                'employee': 'üì± ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô QR Code - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                'cashier': 'üì± ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô QR Code - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
            };
            title.textContent = titles[signatureType] || 'üì± ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô QR Code';

            // Show modal
            modal.style.display = 'flex';
            preview.style.display = 'none';

            // Get receipt ID
            const receiptId = getCurrentReceiptId();
            if (!receiptId) {
                status.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à';
                status.style.color = '#dc3545';
                return;
            }

            // Create QR Code
            try {
                status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code...';
                status.style.color = '#6c757d';

                const sessionData = await QRSignatureManager.createQRSignature(
                    receiptId,
                    signatureType === 'cashier' ? 'employee' : signatureType,
                    'qrSignatureCanvas',
                    'qrSignatureStatus'
                );

                currentQRSession = sessionData;

                // Listen for signature
                if (QRSignatureManager.socket && QRSignatureManager.socket.connected) {
                    QRSignatureManager.socket.on('signature-saved', handleQRSignatureReceived);
                }

            } catch (error) {
                console.error('Error creating QR signature:', error);
                status.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                status.style.color = '#dc3545';
            }
        }

        function handleQRSignatureReceived(data) {
            if (!currentQRSession || data.sessionId !== currentQRSession.sessionId) {
                return;
            }

            console.log('‚úÖ Signature received via Socket.IO:', data);

            // Use signature data directly from Socket.IO
            if (data.signatureData) {
                displayQRSignatureResult(data.signatureData);
            } else {
                console.warn('‚ö†Ô∏è No signatureData in Socket.IO event, falling back to polling');
                // Fallback: fetch the signature data via polling
                fetch(`/api/qr-signature/poll/${data.sessionId}`)
                    .then(res => res.json())
                    .then(result => {
                        if (result.success && result.data && result.data.signatureData) {
                            displayQRSignatureResult(result.data.signatureData);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching signature:', error);
                    });
            }
        }

        function displayQRSignatureResult(signatureData) {
            const preview = document.getElementById('qrSignaturePreview');
            const image = document.getElementById('qrSignatureImage');
            const status = document.getElementById('qrSignatureStatus');

            // Show preview
            image.src = signatureData;
            preview.style.display = 'block';
            status.textContent = '‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
            status.style.color = '#28a745';

            // Save signature to receipt display
            // Use the original signature type that was requested by user
            const displayType = currentQRSignatureType;
            console.log(`üíæ Saving signature to ${displayType}SignatureDisplay (original type: ${currentQRSignatureType})`);
            saveQRSignatureToDisplay(displayType, signatureData);

            // Auto close after 2 seconds
            setTimeout(() => {
                closeQRSignatureModal();
            }, 2000);
        }

        function saveQRSignatureToDisplay(type, signatureData) {
            const canvas = document.getElementById(`${type}SignatureDisplay`);
            const placeholder = document.getElementById(`${type}SignaturePlaceholder`);

            console.log(`üé® saveQRSignatureToDisplay: type=${type}, canvas=${canvas?.id}, placeholder=${placeholder?.id}`);

            if (canvas && placeholder) {
                // Draw signature on canvas
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.style.display = 'block';
                    placeholder.style.display = 'none';
                    console.log(`‚úÖ Signature displayed on canvas, placeholder hidden`);
                };
                img.onerror = function() {
                    console.error('‚ùå Failed to load signature image');
                };
                img.src = signatureData;

                // Save to backend
                signatures[type] = signatureData;
                console.log(`üíæ Calling saveSignatureToBackend for ${type}`);
                saveSignatureToBackend(type, signatureData).catch(error => {
                    console.error('‚ùå Error saving signature to backend:', error);
                });
            } else {
                console.error(`‚ùå Canvas or placeholder not found: canvas=${!!canvas}, placeholder=${!!placeholder}`);
            }
        }

        function closeQRSignatureModal() {
            const modal = document.getElementById('qrSignatureModal');
            modal.style.display = 'none';

            // Cleanup
            if (QRSignatureManager.socket) {
                QRSignatureManager.socket.off('signature-saved', handleQRSignatureReceived);
            }
            currentQRSignatureType = null;
            currentQRSession = null;
        }

        // Helper function to get receipt ID from URL or page
        function getCurrentReceiptId() {
            // Try to get from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            let receiptId = urlParams.get('id') || urlParams.get('receiptId');

            // If not in URL, try to get from page element
            if (!receiptId) {
                const receiptElement = document.querySelector('[data-receipt-id]');
                if (receiptElement) {
                    receiptId = receiptElement.getAttribute('data-receipt-id');
                }
            }

            // If still not found, try to get from receipt number display
            if (!receiptId) {
                const receiptNumberElement = document.querySelector('.receipt-number, .document-number, [id*="receipt"]');
                if (receiptNumberElement) {
                    receiptId = receiptNumberElement.textContent.trim();
                }
            }

            return receiptId;
        }
    </script>
</body>
</html>