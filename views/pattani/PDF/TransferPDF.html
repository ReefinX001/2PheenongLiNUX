<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบโอนสินค้า Transfer Slip</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <!-- Print optimization -->
    <style type="text/css" media="print">
        @page {
            size: A4;
            margin: 0.5in;
        }
        
        @page {
            margin-top: 0.3in;
            margin-bottom: 0.3in;
        }
    </style>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 20px;
        }
        
        /* Common utility classes */
        .font-10 { font-size: 10px; }
        .font-11 { font-size: 11px; }
        .font-12 { font-size: 12px; }
        .font-14 { font-size: 14px; }
        .border-black { border: 1px solid black; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: bold; }
        .margin-bottom-15 { margin-bottom: 15px; }
        .margin-bottom-10 { margin-bottom: 10px; }
        .margin-bottom-5 { margin-bottom: 5px; }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .company-logo {
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .logo-image {
            height: 80px;
            width: auto;
            max-width: 80px;
        }
        
        .company-info {
            flex: 1;
        }
        
        .company-name {
            line-height: 1.4;
        }
        
        .voucher-box {
            background: black;
            color: white;
            padding: 10px;
            width: 200px;
        }
        
        .voucher-no {
            background: white;
            color: black;
            padding: 5px;
            margin-top: 5px;
        }
        
        /* Info Box */
        .info-box {
            padding: 10px;
        }
        
        .info-table {
            width: 100%;
        }
        
        .info-table td {
            padding: 5px;
            vertical-align: top;
        }
        
        .label-en {
            color: #666;
        }
        
        /* Branch Info */
        .branch-section {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
        }
        
        .branch-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
        }
        
        .branch-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
            color: #000;
            text-transform: uppercase;
        }
        
        .branch-value {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 3px;
            color: #333;
        }
        
        .branch-value.branch-name {
            font-size: 14px;
            font-weight: bold;
            color: #000;
        }
        
        .branch-value.sender-receiver {
            font-weight: bold;
            color: #2563eb;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        th {
            background: black;
            color: white;
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            font-size: 10px;
        }
        
        td {
            border: 1px solid black;
            padding: 5px;
            font-size: 11px;
        }
        
        /* Status Section */
        .status-section {
            margin: 10px 0;
        }
        
        .status-title {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 10px;
        }
        
        .status-options {
            display: flex;
            gap: 30px;
            margin-bottom: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }
        
        .checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid black;
            display: inline-block;
            position: relative;
        }
        
        .checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 1px;
            font-weight: bold;
        }
        
        .checkbox-label {
            font-size: 10px;
        }
        
        .status-details {
            font-size: 10px;
            line-height: 1.6;
            margin: 10px 0;
        }
        
        .status-summary {
            text-align: right;
            font-size: 10px;
            margin-top: 10px;
        }
        
        /* Signature */
        .signature-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: space-around;
        }
        
        .signature-box {
            flex: 0 1 45%;
            border: 1px solid black;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        
        .signature-line {
            border-bottom: 1px solid black;
            margin: 20px 15px 8px;
        }
        
        .signature-stamp {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            opacity: 0.8;
            z-index: 1;
        }
        
        .signature-label {
            font-size: 10px;
        }
        
        /* Footer */
        .footer {
            background: black;
            color: white;
            text-align: center;
            padding: 8px;
            margin-top: 15px;
            font-size: 10px;
        }
        
        /* Print-specific styles */
        @media print {
            body {
                margin: 0;
                padding: 10px;
                font-size: 12px !important;
                line-height: 1.2;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                overflow: hidden;
            }
            
            html, body {
                height: 100vh !important;
                max-height: 100vh !important;
                overflow: hidden !important;
            }
            
            .container {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            
            .logo-image {
                height: 80px !important;
                width: auto !important;
                max-width: 80px !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .voucher-box {
                background: #0066CC !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .voucher-no {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            th {
                background: #0066CC !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .footer {
                background: #0066CC !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .border-black,
            table,
            th,
            td,
            .checkbox,
            .signature-box {
                border: 1px solid black !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .margin-bottom-15 { margin-bottom: 15px !important; }
            .margin-bottom-10 { margin-bottom: 10px !important; }
            .margin-bottom-5 { margin-bottom: 5px !important; }
            
            .font-10 { font-size: 10px !important; }
            .font-11 { font-size: 11px !important; }
            .font-12 { font-size: 12px !important; }
            .font-14 { font-size: 14px !important; }
            
            .container {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }
            
            .header,
            .info-box,
            .signature-section,
            table {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }
            
            tr {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .margin-bottom-15 { margin-bottom: 6px !important; }
            .margin-bottom-10 { margin-bottom: 4px !important; }
            .signature-section { margin-top: 10px !important; }
            
            table { margin-bottom: 8px !important; }
            .status-section { margin: 8px 0 !important; }
            
            /* Enhanced text styling for print */
            .branch-title {
                font-weight: bold !important;
                font-size: 12px !important;
                color: #000 !important;
                text-transform: uppercase !important;
            }
            
            .branch-value {
                font-size: 12px !important;
                font-weight: 500 !important;
                color: #333 !important;
            }
            
            .branch-value.branch-name {
                font-size: 14px !important;
                font-weight: bold !important;
                color: #000 !important;
            }
            
            .branch-value.sender-receiver {
                font-weight: bold !important;
                color: #000 !important;
            }
            
            .signature-line {
                border-bottom: 1px solid black !important;
                margin: 15px 10px 6px !important;
            }
            
            .checkbox {
                width: 12px !important;
                height: 12px !important;
                border: 1px solid black !important;
                display: inline-block !important;
            }
            
            .checkbox.checked::after {
                content: '✓' !important;
                font-size: 10px !important;
                font-weight: bold !important;
                position: absolute;
                top: -2px;
                left: 1px;
            }
            
            /* Signature styles for print */
            .signature-area {
                page-break-inside: avoid !important;
            }
            
            canvas[id$="Signature"] {
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .signature-placeholder {
                display: none !important;
            }
            
            #signatureModal {
                display: none !important;
            }
        }

        .loading-overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100vw; height: 100vh;
          background: rgba(255, 255, 255, 0.9);
          display: flex; justify-content: center; align-items: center;
          z-index: 9999;
          backdrop-filter: blur(12px);
        }
    </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

    <div class="container">
        <!-- Header -->
        <div class="header margin-bottom-15">
            <div class="company-logo">
                <img src="../../Logo/Logo2png.png" alt="Company Logo" class="logo-image" style="width: 80px; height: 80px; object-fit: contain;">
            </div>
            <div class="company-info">
                <div class="company-name font-14 font-bold margin-bottom-5">บริษัท 2 พี่น้อง โมบาย จำกัด</div>
                <div class="font-10">
                    สำนักงานใหญ่<br>
                    148/91 หมู่ที่ 6 ตำบลรูสะมิแล อำเภอปัตตานี จังหวัดปัตตานี 94000<br>
                    เลขที่ผู้เสียภาษี 0945566000616 | (00000)<br>
                    โทร: 09-2427-0769
                </div>
            </div>
            <div class="voucher-box text-center">
                <div class="font-14 font-bold">ใบโอนสินค้า</div>
                <div class="font-12 margin-bottom-5">Transfer Slip</div>
                <div class="voucher-no">
                    <div class="font-10">เลขที่เอกสาร / No.</div>
                    <div class="font-11 font-bold">DO-250819-001</div>
                </div>
            </div>
        </div>
        
        <!-- Info Box with only outer border -->
        <div class="info-box border-black margin-bottom-15">
            <table class="info-table">
                <tr>
                    <td style="width: 12%;">
                        <div class="font-11 font-bold">วันที่โอน</div>
                        <div class="label-en font-10">Transfer Date</div>
                    </td>
                    <td style="width: 20%;">
                        <div class="font-11">19 สิงหาคม 2568</div>
                    </td>
                    <td style="width: 12%;">
                        <div class="font-11 font-bold">เวลา</div>
                        <div class="label-en font-10">Time</div>
                    </td>
                    <td style="width: 20%;">
                        <div class="font-11">14:30 น.</div>
                    </td>
                    <td style="width: 12%;">
                        <div class="font-11 font-bold">สถานะ</div>
                        <div class="label-en font-10">Status</div>
                    </td>
                    <td style="width: 24%;">
                        <div class="font-11">รออนุมัติรับสินค้า</div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="font-11 font-bold">ประเภท</div>
                        <div class="label-en font-10">Type</div>
                    </td>
                    <td>
                        <div class="font-11">โอนระหว่างสาขา</div>
                    </td>
                    <td>
                        <div class="font-11 font-bold">อ้างอิง</div>
                        <div class="label-en font-10">Reference</div>
                    </td>
                    <td>
                        <div class="font-11">REQ-2568-0819</div>
                    </td>
                    <td>
                        <div class="font-11 font-bold">ผู้ขอโอน</div>
                        <div class="label-en font-10">Requested By</div>
                    </td>
                    <td>
                        <div class="font-11">สาขาสายมอ</div>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Branch Info -->
        <div class="branch-section">
            <div class="branch-box" id="fromBranchBox">
                <div class="branch-title">สาขาต้นทาง (FROM)</div>
                <div class="branch-value branch-name" id="fromBranchName">สำนักงานใหญ่</div>
                <div class="branch-value" id="fromBranchCode">รหัสสาขา: -</div>
                <div class="branch-value" id="fromBranchAddress">ที่อยู่: -</div>
                <div class="branch-value sender-receiver" id="fromBranchSender">ผู้ส่ง: -</div>
            </div>
            <div style="display: flex; align-items: center; padding: 0 20px;">
                <div style="font-size: 28px; color: #2563eb; font-weight: bold;">→</div>
            </div>
            <div class="branch-box" id="toBranchBox">
                <div class="branch-title">สาขาปลายทาง (TO)</div>
                <div class="branch-value branch-name" id="toBranchName">สาขาสายมอ</div>
                <div class="branch-value" id="toBranchCode">รหัสสาขา: -</div>
                <div class="branch-value" id="toBranchAddress">ที่อยู่: -</div>
                <div class="branch-value sender-receiver" id="toBranchReceiver">ผู้รับ: -</div>
            </div>
        </div>
        
        <!-- Main Table -->
        <table>
            <thead>
                <tr>
                    <th style="width: 5%;">ลำดับ<br>No.</th>
                    <th style="width: 15%;">รหัสสินค้า<br>Item Code</th>
                    <th style="width: 30%;">รายการสินค้า<br>Description</th>
                    <th style="width: 20%;">IMEI/Serial</th>
                    <th style="width: 10%;">จำนวน<br>Qty</th>
                    <th style="width: 10%;">หน่วย<br>Unit</th>
                    <th style="width: 10%;">หมายเหตุ<br>Remark</th>
                </tr>
            </thead>
            <tbody id="itemsTableBody">
                <!-- Items will be populated dynamically -->
                <tr>
                    <td class="text-center">1</td>
                    <td class="text-center">-</td>
                    <td>-</td>
                    <td class="text-center">-</td>
                    <td class="text-center">1</td>
                    <td class="text-center">ชิ้น</td>
                    <td class="text-center">-</td>
                </tr>
                <!-- Minimal empty rows for A4 optimization -->
                <tr style="height: 25px;"><td colspan="7">&nbsp;</td></tr>
                <tr style="height: 25px;"><td colspan="7">&nbsp;</td></tr>
                <tr style="height: 25px;"><td colspan="7">&nbsp;</td></tr>
                <tr>
                    <td colspan="4" class="text-right font-bold">รวมทั้งหมด (Total):</td>
                    <td class="text-center font-bold" id="totalQuantity">1</td>
                    <td class="text-center font-bold">รายการ</td>
                    <td></td>
                </tr>
            </tbody>
        </table>
        
        <!-- Status Section -->
        <div class="status-section">
            <div class="status-title">สถานะการโอน / Transfer Status</div>
            <div class="status-options">
                <div class="checkbox-item">
                    <div class="checkbox checked"></div>
                    <div class="checkbox-label">
                        <div class="font-bold">รอโอน</div>
                        <div class="font-10">Pending</div>
                    </div>
                </div>
                <div class="checkbox-item">
                    <div class="checkbox"></div>
                    <div class="checkbox-label">
                        <div class="font-bold">กำลังจัดส่ง</div>
                        <div class="font-10">In Transit</div>
                    </div>
                </div>
                <div class="checkbox-item">
                    <div class="checkbox"></div>
                    <div class="checkbox-label">
                        <div class="font-bold">รับแล้ว</div>
                        <div class="font-10">Received</div>
                    </div>
                </div>
                <div class="checkbox-item">
                    <div class="checkbox"></div>
                    <div class="checkbox-label">
                        <div class="font-bold">ยกเลิก</div>
                        <div class="font-10">Cancelled</div>
                    </div>
                </div>
            </div>
            <div class="status-details" id="statusDetails">
                <strong>หมายเหตุ</strong> <span id="remarkText">-</span><br>
                <strong>Remark</strong> <span id="remarkTextEn">-</span><br>
                <strong>วิธีการจัดส่ง</strong> <span id="deliveryMethod">รถขนส่งของบริษัท</span><br>
                <strong>Delivery Method</strong> <span id="deliveryMethodEn">Company Transport</span>
            </div>
            <div class="status-summary">
                <div class="margin-bottom-5">
                    <strong>จำนวนรายการ</strong> <span id="totalItems">0</span> รายการ<br>
                    <span class="font-10">Total Items</span>
                </div>
                <div>
                    <strong>จำนวนชิ้นรวม</strong> <span id="totalQuantityDisplay">0</span> ชิ้น<br>
                    <span class="font-10">Total Quantity</span>
                </div>
            </div>
        </div>
        
        <!-- Signature Section (2 signatures only) -->
        <div class="signature-section" style="justify-content: space-around;">
            <div class="signature-box" style="flex: 0 1 40%;">
                <div class="signature-area" id="preparedSignatureArea" onclick="openSignatureModal('prepared')" style="min-height: 80px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; margin: 10px 0; background: #fff; position: relative; cursor: pointer;">
                    <canvas id="preparedSignatureCanvas" width="200" height="60" style="display: block;"></canvas>
                    <span id="preparedSignaturePlaceholder" style="color: #999; font-size: 12px; position: absolute; pointer-events: none;">คลิกเพื่อเซ็นชื่อ</span>
                </div>
                <div class="signature-label">
                    <strong>ผู้จัดเตรียม / Prepared By</strong><br>
                    วันที่ / Date <span id="preparedDate">___/___/_____</span>
                </div>
            </div>
            <div class="signature-note" style="flex: 0 1 15%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666;">
                เฉพาะผู้รับเท่านั้น
            </div>
            <div class="signature-box" style="flex: 0 1 40%;">
                <div class="signature-area" id="receivedSignatureArea" onclick="openSignatureModal('received')" style="min-height: 80px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; margin: 10px 0; background: #fff; position: relative; cursor: pointer;">
                    <canvas id="receivedSignatureCanvas" width="200" height="60" style="display: block;"></canvas>
                    <span id="receivedSignaturePlaceholder" style="color: #999; font-size: 12px; position: absolute; pointer-events: none;">คลิกเพื่อเซ็นชื่อ</span>
                </div>
                <div class="signature-label">
                    <strong>ผู้รับสินค้า / Received By</strong><br>
                    วันที่ / Date <span id="receivedDate">___/___/_____</span>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            148/91 หมู่ที่ 6 ตำบลรูสะมิแล อำเภอปัตตานี จังหวัดปัตตานี 94000 | โทร: 09-2427-0769
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; text-align: center;">เซ็นชื่อ</h3>
            <p style="text-align: center; color: #666; margin: 10px 0;">กรุณาเซ็นชื่อในกรอบด้านล่าง</p>
            
            <div style="border: 2px solid #ddd; margin: 20px 0; background: #f9f9f9;">
                <canvas id="signatureCanvas" width="400" height="150" style="display: block; cursor: crosshair; background: white;"></canvas>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="clearSignature()" style="padding: 8px 16px; margin: 0 5px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ล้าง</button>
                <button onclick="saveSignature()" style="padding: 8px 16px; margin: 0 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">บันทึก</button>
                <button onclick="closeSignatureModal()" style="padding: 8px 16px; margin: 0 5px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        let isDrawing = false;
        let currentSignatureType = '';
        let signatureCanvas = null;
        let signatureCtx = null;
        let currentUserId = null;
        let transferData = null;

        // Initialize signature functionality when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
        
            // Get current user ID from multiple sources
            if (window.currentUserId) {
                currentUserId = window.currentUserId;
            } else if (window.opener && window.opener.localStorage) {
                currentUserId = window.opener.localStorage.getItem('userId');
            } else if (localStorage.getItem('userId')) {
                currentUserId = localStorage.getItem('userId');
            }
        
            console.log('🔍 Initializing PDF with user ID:', currentUserId);
            console.log('🔍 Available localStorage keys:', Object.keys(localStorage));
            console.log('🔍 Available window.opener:', !!window.opener);
        
            // Set up canvas drawing
            setupCanvasDrawing();
        
            // Wait for transfer data to be set by parent window
            setTimeout(() => {
                if (window.transferData) {
                    transferData = window.transferData;
                    populateTransferData();
                }
                checkSignaturePermissions();
            }, 500);
        });

        // Function to populate transfer data into the PDF
        function populateTransferData() {
            if (!transferData) {
                console.log('No transfer data available');
                return;
            }

            console.log('Populating transfer data:', transferData);
            console.log('Branch data:', {
                fromBranch: transferData.fromBranch,
                toBranch: transferData.toBranch,
                sender: transferData.sender,
                receiver: transferData.receiver,
                senderName: transferData.senderName,
                receiverName: transferData.receiverName
            });

            // Update document number
            const docNoElement = document.querySelector('.voucher-no .font-bold');
            if (docNoElement) {
                docNoElement.textContent = transferData.transferNo || `DO-${(transferData._id || '').slice(-8)}`;
            }

            // Update date and time
            const transferDate = new Date(transferData.transferDate || transferData.createdAt);
            const infoTableCells = document.querySelectorAll('.info-table td');
        
            if (infoTableCells[1]) {
                const year = transferDate.getFullYear() + 543; // Buddhist Era
                const thaiDate = transferDate.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'long'
                });
                infoTableCells[1].innerHTML = `<div class="font-11">${thaiDate} ${year}</div>`;
            }
        
            if (infoTableCells[3]) {
                const transferTime = transferDate.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                infoTableCells[3].innerHTML = `<div class="font-11">${transferTime} น.</div>`;
            }

            // Update status
            if (infoTableCells[5]) {
                const statusMap = {
                    'pending': 'รออนุมัติ',
                    'pending-receive': 'รอรับสินค้า',
                    'completed': 'เสร็จสิ้น',
                    'cancelled': 'ยกเลิก'
                };
                infoTableCells[5].innerHTML = `<div class="font-11">${statusMap[transferData.status] || transferData.status}</div>`;
            }

            // Update reference and requested by
            if (infoTableCells[9]) {
                const refNo = transferData.referenceNo || transferData.requestNo || `REQ-${new Date().getFullYear() + 543}-${(transferData._id || '').slice(-4).toUpperCase()}`;
                infoTableCells[9].innerHTML = `<div class="font-11">${refNo}</div>`;
            }

            if (infoTableCells[11]) {
                const requestedBy = transferData.requestedBy || transferData.toBranch?.name || 'ไม่ระบุ';
                infoTableCells[11].innerHTML = `<div class="font-11">${requestedBy}</div>`;
            }

            // Update branch information
            updateBranchInfo();
        
            // Update items table
            updateItemsTable();
        
            // Update status checkboxes
            updateStatusCheckboxes();
        
            // Update status details and summary
            updateStatusDetails();
        
            // Display signatures
            displaySignatures();
        }

        // Function to display signatures
        function displaySignatures() {
            if (!transferData) return;
        
            console.log('🖊️ Displaying signatures:', {
                preparedSignature: !!transferData.preparedSignature,
                receiverSignature: !!transferData.receiverSignature,
                preparedAt: transferData.preparedAt,
                receivedAt: transferData.receivedAt
            });
        
            // Display prepared signature
            let preparedSignatureData = null;
            if (transferData.preparedSignature) {
                // Handle both string (new format) and object (old format)
                if (typeof transferData.preparedSignature === 'string') {
                    preparedSignatureData = transferData.preparedSignature;
                } else if (transferData.preparedSignature && transferData.preparedSignature.data) {
                    preparedSignatureData = transferData.preparedSignature.data;
                }
            }
        
            if (preparedSignatureData) {
                const preparedCanvas = document.getElementById('preparedSignatureCanvas');
                const preparedPlaceholder = document.getElementById('preparedSignaturePlaceholder');
                const preparedDate = document.getElementById('preparedDate');
        
                if (preparedCanvas && preparedPlaceholder) {
                    const ctx = preparedCanvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, preparedCanvas.width, preparedCanvas.height);
                        ctx.drawImage(img, 0, 0, preparedCanvas.width, preparedCanvas.height);
                        preparedPlaceholder.style.display = 'none';
                    };
                    img.src = preparedSignatureData;
                }
        
                if (preparedDate && transferData.preparedAt) {
                    const date = new Date(transferData.preparedAt);
                    preparedDate.textContent = date.toLocaleDateString('th-TH');
                }
            }
        
            // Display received signature
            let receiverSignatureData = null;
            if (transferData.receiverSignature) {
                // Handle both string (new format) and object (old format)
                if (typeof transferData.receiverSignature === 'string') {
                    receiverSignatureData = transferData.receiverSignature;
                } else if (transferData.receiverSignature && transferData.receiverSignature.data) {
                    receiverSignatureData = transferData.receiverSignature.data;
                }
            }
        
            if (receiverSignatureData) {
                const receivedCanvas = document.getElementById('receivedSignatureCanvas');
                const receivedPlaceholder = document.getElementById('receivedSignaturePlaceholder');
                const receivedDate = document.getElementById('receivedDate');
        
                if (receivedCanvas && receivedPlaceholder) {
                    const ctx = receivedCanvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);
                        ctx.drawImage(img, 0, 0, receivedCanvas.width, receivedCanvas.height);
                        receivedPlaceholder.style.display = 'none';
                    };
                    img.src = receiverSignatureData;
                }
        
                if (receivedDate && transferData.receivedAt) {
                    const date = new Date(transferData.receivedAt);
                    receivedDate.textContent = date.toLocaleDateString('th-TH');
                }
            }
        
            console.log('✅ Signatures displayed');
        }

        // Function to fetch branch data from API
        async function fetchBranchData(branchId) {
            try {
                console.log('🔍 Fetching branch data for ID:', branchId);
                const response = await fetch(`/api/branch/${branchId}`);
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Branch data fetched:', result.data);
                    return result.data;
                } else {
                    console.warn('⚠️ Failed to fetch branch data:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('❌ Error fetching branch data:', error);
                return null;
            }
        }

        async function updateBranchInfo() {
            if (!transferData) return;
        
            console.log('🔍 Debug - Full transferData for branch info:', transferData);
        
            // Update FROM branch information
            if (transferData.fromBranch) {
                console.log('📍 FROM Branch data:', transferData.fromBranch);
        
                const fromBranchName = document.getElementById('fromBranchName');
                const fromBranchCode = document.getElementById('fromBranchCode');
                const fromBranchAddress = document.getElementById('fromBranchAddress');
                const fromBranchSender = document.getElementById('fromBranchSender');
        
                // Check if we need to fetch complete branch data
                let branchData = transferData.fromBranch;
                const branchId = transferData.fromBranch._id || transferData.fromBranch;
        
                // If we only have ObjectId or incomplete data, fetch from API
                if (typeof branchData === 'string' || !branchData.address || !branchData.branch_code) {
                    console.log('🔄 Fetching complete FROM branch data...');
                    const fetchedBranch = await fetchBranchData(branchId);
                    if (fetchedBranch) {
                        branchData = fetchedBranch;
                    }
                }
        
                // Branch Name (update with fetched data)
                const branchName = branchData.name ||
                                 branchData.branch_name ||
                                 branchData.branchName ||
                                 'ไม่ระบุ';
                if (fromBranchName) fromBranchName.textContent = branchName;
        
                // Branch Code - use actual branch_code from database
                const branchCode = branchData.branch_code ||
                                 branchData.code ||
                                 branchData.branchCode ||
                                 '-';
                if (fromBranchCode) fromBranchCode.textContent = `รหัสสาขา: ${branchCode}`;
        
                // Address - use actual address from database (no fallback)
                const address = branchData.address ||
                              branchData.location ||
                              branchData.addr ||
                              '-';
                if (fromBranchAddress) fromBranchAddress.textContent = `ที่อยู่: ${address}`;
        
                // Sender Name - handle all possible formats
                let senderName = 'ไม่ระบุผู้ส่ง';
        
                if (transferData.senderName) {
                    senderName = transferData.senderName;
                } else if (transferData.sender) {
                    if (typeof transferData.sender === 'object') {
                        // If sender is populated object
                        senderName = transferData.sender.employee?.name ||
                                   transferData.sender.fullName ||
                                   (transferData.sender.firstName && transferData.sender.lastName ?
                                    `${transferData.sender.firstName} ${transferData.sender.lastName}` : '') ||
                                   transferData.sender.firstName ||
                                   transferData.sender.username ||
                                   transferData.sender.name ||
                                   'ไม่ระบุผู้ส่ง';
                    } else if (typeof transferData.sender === 'string') {
                        // If sender is just an ID string, we can't display name
                        senderName = 'รหัสผู้ส่ง: ' + transferData.sender.substring(0, 8) + '...';
                    }
                } else if (transferData.senderId) {
                    // Fallback to senderId if exists
                    senderName = 'รหัสผู้ส่ง: ' + transferData.senderId.substring(0, 8) + '...';
                }
        
                console.log('Sender data:', {
                    sender: transferData.sender,
                    senderType: typeof transferData.sender,
                    senderName: senderName
                });
        
                if (fromBranchSender) fromBranchSender.textContent = `ผู้ส่ง: ${senderName}`;
        
                console.log('✅ FROM Branch updated:', { branchName, branchCode, address, senderName });
            }
        
            // Update TO branch information
            if (transferData.toBranch) {
                console.log('📍 TO Branch data:', transferData.toBranch);
        
                const toBranchName = document.getElementById('toBranchName');
                const toBranchCode = document.getElementById('toBranchCode');
                const toBranchAddress = document.getElementById('toBranchAddress');
                const toBranchReceiver = document.getElementById('toBranchReceiver');
        
                // Check if we need to fetch complete branch data
                let branchData = transferData.toBranch;
                const branchId = transferData.toBranch._id || transferData.toBranch;
        
                // If we only have ObjectId or incomplete data, fetch from API
                if (typeof branchData === 'string' || !branchData.address || !branchData.branch_code) {
                    console.log('🔄 Fetching complete TO branch data...');
                    const fetchedBranch = await fetchBranchData(branchId);
                    if (fetchedBranch) {
                        branchData = fetchedBranch;
                    }
                }
        
                // Branch Name
                const branchName = branchData.name ||
                                 branchData.branch_name ||
                                 branchData.branchName ||
                                 'ไม่ระบุ';
                if (toBranchName) toBranchName.textContent = branchName;
        
                // Branch Code - use actual branch_code from database
                const branchCode = branchData.branch_code ||
                                 branchData.code ||
                                 branchData.branchCode ||
                                 '-';
                if (toBranchCode) toBranchCode.textContent = `รหัสสาขา: ${branchCode}`;
        
                // Address - use actual address from database (no fallback)
                const address = branchData.address ||
                              branchData.location ||
                              branchData.addr ||
                              '-';
                if (toBranchAddress) toBranchAddress.textContent = `ที่อยู่: ${address}`;
        
                // Receiver Name - handle all possible formats
                let receiverName = 'ไม่ระบุผู้รับ';
        
                if (transferData.receiverName) {
                    receiverName = transferData.receiverName;
                } else if (transferData.receiver) {
                    if (typeof transferData.receiver === 'object') {
                        // If receiver is populated object
                        receiverName = transferData.receiver.employee?.name ||
                                     transferData.receiver.fullName ||
                                     (transferData.receiver.firstName && transferData.receiver.lastName ?
                                      `${transferData.receiver.firstName} ${transferData.receiver.lastName}` : '') ||
                                     transferData.receiver.firstName ||
                                     transferData.receiver.username ||
                                     transferData.receiver.name ||
                                     'ไม่ระบุผู้รับ';
                    } else if (typeof transferData.receiver === 'string') {
                        // If receiver is just an ID string, we can't display name
                        receiverName = 'รหัสผู้รับ: ' + transferData.receiver.substring(0, 8) + '...';
                    }
                } else if (transferData.receiverId) {
                    // Fallback to receiverId if exists
                    receiverName = 'รหัสผู้รับ: ' + transferData.receiverId.substring(0, 8) + '...';
                }
        
                console.log('Receiver data:', {
                    receiver: transferData.receiver,
                    receiverType: typeof transferData.receiver,
                    receiverName: receiverName
                });
        
                if (toBranchReceiver) toBranchReceiver.textContent = `ผู้รับ: ${receiverName}`;
        
                console.log('✅ TO Branch updated:', { branchName, branchCode, address, receiverName });
            }
        
            // If branch data is missing, try to get from other sources
            if (!transferData.fromBranch || !transferData.toBranch) {
                console.log('⚠️ Missing branch data, checking alternative sources...');
                console.log('Available keys in transferData:', Object.keys(transferData));
            }
        }

        function updateItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            if (!tbody || !transferData.items || !transferData.items.length) {
                console.log('No items to display or tbody not found', {
                    tbody: !!tbody,
                    items: transferData?.items,
                    itemsLength: transferData?.items?.length
                });
                return;
            }

            console.log('Updating items table with data:', transferData.items);

            let totalQty = 0;
            let rows = '';

            // Generate item rows
            transferData.items.forEach((item, index) => {
                const quantity = parseInt(item.quantity) || 1;
                totalQty += quantity;
        
                // Get item code from various possible fields
                const itemCode = item.sku ||
                               item.product_code ||
                               item.code ||
                               item.SKU ||
                               item.productCode ||
                               item._id?.slice(-6) ||
                               '-';
        
                // Get item name from various possible fields
                const itemName = item.name ||
                               item.product_name ||
                               item.itemName ||
                               item.productName ||
                               item.description ||
                               '-';
        
                // Get IMEI from various possible fields
                const imei = item.imei ||
                           item.IMEI ||
                           item.serialNumber ||
                           item.serial ||
                           '-';
        
                rows += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${itemCode}</td>
                        <td>${itemName}</td>
                        <td class="text-center">${imei}</td>
                        <td class="text-center">${quantity}</td>
                        <td class="text-center">${item.unit || 'ชิ้น'}</td>
                        <td class="text-center">${item.note || item.remark || '-'}</td>
                    </tr>
                `;
            });

            // Add minimal empty rows for A4 optimization (maximum 5 items per page)
            const maxItemsPerPage = 5;
            const emptyRowsNeeded = Math.max(0, Math.min(maxItemsPerPage - transferData.items.length, 3));
        
            for (let i = 0; i < emptyRowsNeeded; i++) {
                rows += '<tr style="height: 25px;"><td colspan="7">&nbsp;</td></tr>';
            }

            // Add total row
            rows += `
                <tr>
                    <td colspan="4" class="text-right font-bold">รวมทั้งหมด (Total):</td>
                    <td class="text-center font-bold">${totalQty}</td>
                    <td class="text-center font-bold">รายการ</td>
                    <td></td>
                </tr>
            `;

            tbody.innerHTML = rows;
        
            // Update total quantity in summary
            const totalQuantityElement = document.getElementById('totalQuantity');
            if (totalQuantityElement) {
                totalQuantityElement.textContent = totalQty;
            }
        }

        function updateStatusCheckboxes() {
            const checkboxes = document.querySelectorAll('.checkbox');
            checkboxes.forEach(cb => cb.classList.remove('checked'));
        
            if (transferData.status === 'pending') {
                if (checkboxes[0]) checkboxes[0].classList.add('checked');
            } else if (transferData.status === 'pending-receive') {
                if (checkboxes[1]) checkboxes[1].classList.add('checked');
            } else if (transferData.status === 'completed') {
                if (checkboxes[2]) checkboxes[2].classList.add('checked');
            } else if (transferData.status === 'cancelled') {
                if (checkboxes[3]) checkboxes[3].classList.add('checked');
            }
        }

        function updateStatusDetails() {
            if (!transferData) return;

            // Update remark/note
            const remarkText = document.getElementById('remarkText');
            const remarkTextEn = document.getElementById('remarkTextEn');
            const deliveryMethod = document.getElementById('deliveryMethod');
            const deliveryMethodEn = document.getElementById('deliveryMethodEn');
            const totalItems = document.getElementById('totalItems');
            const totalQuantityDisplay = document.getElementById('totalQuantityDisplay');

            // Set remark text
            const remark = transferData.note || transferData.remark || 'โอนสินค้าระหว่างสาขา';
            if (remarkText) remarkText.textContent = remark;
            if (remarkTextEn) remarkTextEn.textContent = transferData.noteEn || remark;

            // Set delivery method
            const delivery = transferData.deliveryMethod || transferData.shippingMethod || 'รถขนส่งของบริษัท';
            if (deliveryMethod) deliveryMethod.textContent = delivery;
            if (deliveryMethodEn) deliveryMethodEn.textContent = transferData.deliveryMethodEn || 'Company Transport';

            // Calculate totals
            let itemCount = 0;
            let totalQty = 0;

            if (transferData.items && transferData.items.length > 0) {
                itemCount = transferData.items.length;
                totalQty = transferData.items.reduce((sum, item) => {
                    return sum + (parseInt(item.quantity) || 1);
                }, 0);
            }

            if (totalItems) totalItems.textContent = itemCount;
            if (totalQuantityDisplay) totalQuantityDisplay.textContent = totalQty;

            console.log('Status details updated:', {
                remark: remark,
                delivery: delivery,
                itemCount: itemCount,
                totalQty: totalQty
            });
        }

        function setupCanvasDrawing() {
            if (!signatureCanvas || !signatureCtx) return;

            // Set line properties
            signatureCtx.strokeStyle = '#000';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            signatureCanvas.addEventListener('touchstart', handleTouch);
            signatureCanvas.addEventListener('touchmove', handleTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        
            // Automatically update the date when user starts signing
            updateSignatureDate(currentSignatureType);
        }

        function draw(e) {
            if (!isDrawing) return;
        
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        
            // Update date when touch starts (for mobile devices)
            if (e.type === 'touchstart') {
                updateSignatureDate(currentSignatureType);
            }
        }

        function openSignatureModal(type) {
            console.log('🖊️ Opening signature modal for type:', type);
        
            // Check permissions before opening modal
            if (!checkSignaturePermission(type)) {
                alert('คุณไม่มีสิทธิ์เซ็นในส่วนนี้');
                return;
            }
        
            currentSignatureType = type;
            console.log('✅ currentSignatureType set to:', currentSignatureType);
            document.getElementById('signatureModal').style.display = 'block';
            clearSignature();
        }
        
        function checkSignaturePermission(type) {
            // If no user ID or transfer data, deny permission
            if (!currentUserId || !transferData) {
                return false;
            }
        
            // Check permission based on signature type
            if (type === 'prepared') {
                // Only sender can sign "Prepared By"
                return transferData.sender === currentUserId ||
                       transferData.sender?._id === currentUserId ||
                       transferData.senderId === currentUserId;
            } else if (type === 'received') {
                // Only receiver can sign "Received By"
                return transferData.receiver === currentUserId ||
                       transferData.receiver?._id === currentUserId ||
                       transferData.receiverId === currentUserId;
            }
        
            return false;
        }
        
        function checkSignaturePermissions() {
            // Disable signature boxes based on user permissions
            const preparedBox = document.getElementById('preparedSignatureArea');
            const receivedBox = document.getElementById('receivedSignatureArea');
        
            if (!checkSignaturePermission('prepared') && preparedBox) {
                preparedBox.style.opacity = '0.5';
                preparedBox.style.pointerEvents = 'none';
                preparedBox.style.cursor = 'not-allowed';
                preparedBox.title = 'คุณไม่มีสิทธิ์เซ็นในส่วนนี้ - เฉพาะผู้ส่งเท่านั้น';
        
                // Update placeholder text
                const placeholder = document.getElementById('preparedSignaturePlaceholder');
                if (placeholder) {
                    placeholder.textContent = 'เฉพาะผู้ส่งเท่านั้น';
                    placeholder.style.color = '#999';
                }
            }
        
            if (!checkSignaturePermission('received') && receivedBox) {
                receivedBox.style.opacity = '0.5';
                receivedBox.style.pointerEvents = 'none';
                receivedBox.style.cursor = 'not-allowed';
                receivedBox.title = 'คุณไม่มีสิทธิ์เซ็นในส่วนนี้ - เฉพาะผู้รับเท่านั้น';
        
                // Update placeholder text
                const placeholder = document.getElementById('receivedSignaturePlaceholder');
                if (placeholder) {
                    placeholder.textContent = 'เฉพาะผู้รับเท่านั้น';
                    placeholder.style.color = '#999';
                }
            }
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            currentSignatureType = '';
        }

        function clearSignature() {
            if (signatureCtx) {
                signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }
        }

        async function saveSignature() {
            if (!currentSignatureType) return;

            // Get signature data
            const signatureData = signatureCanvas.toDataURL();
        
            // Check if canvas is empty
            const isCanvasEmpty = isCanvasBlank(signatureCanvas);
            if (isCanvasEmpty) {
                alert('กรุณาเซ็นชื่อก่อนบันทึก');
                return;
            }

            // Save to appropriate canvas
            const targetCanvas = document.getElementById(currentSignatureType + 'SignatureCanvas');
            const targetCtx = targetCanvas.getContext('2d');
        
            // Clear target canvas
            targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
        
            // Create image from signature data
            const img = new Image();
            img.onload = async function() {
                // Scale and draw the signature
                targetCtx.drawImage(img, 0, 0, targetCanvas.width, targetCanvas.height);
        
                // Show the canvas and hide placeholder
                targetCanvas.style.display = 'block';
                const placeholder = document.getElementById(currentSignatureType + 'SignaturePlaceholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
        
                // Update signature date
                updateSignatureDate(currentSignatureType);
        
                // Save signature to backend and update transfer status
                console.log('🔍 About to save signature:', {
                    currentSignatureType: currentSignatureType,
                    signatureDataLength: signatureData ? signatureData.length : 0
                });
                await saveSignatureToBackend(currentSignatureType, signatureData);
        
                // Close modal after successful save
                closeSignatureModal();
            };
            img.src = signatureData;
        }

        // Function to save signature to backend
        async function saveSignatureToBackend(signatureType, signatureData) {
            if (!transferData || !transferData._id) {
                console.error('No transfer data available');
                alert('ไม่พบข้อมูลการโอนสินค้า กรุณารีเฟรชหน้าและลองใหม่');
                return;
            }

            // Validate transfer ID format
            if (typeof transferData._id !== 'string' || transferData._id.length < 10) {
                console.error('Invalid transfer ID:', transferData._id);
                alert('รหัสการโอนสินค้าไม่ถูกต้อง');
                return;
            }

            // Validate signature data
            if (!signatureData || signatureData.length < 100) {
                console.error('Invalid signature data:', signatureData ? signatureData.length : 'null');
                alert('ข้อมูลลายเซ็นไม่ถูกต้อง กรุณาเซ็นชื่อใหม่');
                return;
            }

            // Validate signature type
            const validTypes = ['prepared', 'received'];
            if (!validTypes.includes(signatureType)) {
                console.error('Invalid signature type:', signatureType);
                alert('ประเภทลายเซ็นไม่ถูกต้อง');
                return;
            }

            try {
                const token = localStorage.getItem('authToken') ||
                             (window.opener && window.opener.localStorage.getItem('authToken'));
        
                if (!token) {
                    console.error('No auth token available');
                    alert('กรุณาเข้าสู่ระบบใหม่');
                    return;
                }

                console.log('🔑 Using token:', token ? 'Token available' : 'No token');
                console.log('👤 Current user ID:', currentUserId);

                // Prepare signature update data - match backend expectations
                let updateData = {};
        
                // Map frontend signature types to backend expected types
                let backendSignatureType = signatureType;
                if (signatureType === 'prepared') {
                    backendSignatureType = 'prepared';  // ผู้จัดเตรียม
                } else if (signatureType === 'received') {
                    backendSignatureType = 'receiver';  // ผู้รับสินค้า - ใช้ 'receiver' ตาม backend
                }
        
                // Always use the generic format that backend's saveSignature expects
                updateData = {
                    signatureType: backendSignatureType,  // 'prepared', 'receiver', or 'sender'
                    signatureData: signatureData,  // Base64 string
                    signedAt: new Date().toISOString(),
                    signedBy: currentUserId
                };
        
                // Add status updates based on signature type
                if (signatureType === 'prepared') {
                    updateData.status = 'in-transit';
                } else if (signatureType === 'received') {
                    updateData.status = 'completed';
                    updateData.receivedAt = new Date().toISOString();
                    updateData.receivedBy = currentUserId;
                }

                console.log('🖊️ Saving signature to backend:', {
                    transferId: transferData._id,
                    originalSignatureType: signatureType,
                    backendSignatureType: backendSignatureType,
                    updateDataKeys: Object.keys(updateData),
                    signatureDataLength: signatureData ? signatureData.length : 0
                });
        
                console.log('📋 Request payload details:', {
                    payloadType: signatureType === 'prepared' ? 'Direct preparedSignature' : 'Generic signature format',
                    updateDataKeys: Object.keys(updateData),
                    hasSignature: !!(updateData.preparedSignature || updateData.signatureData),
                    signatureLength: (updateData.preparedSignature || updateData.signatureData || '').length,
                    status: updateData.status
                });

                const apiUrl = `/api/transfers/${transferData._id}/signature`;
                console.log('📡 API URL:', apiUrl);
                console.log('📡 Full URL:', window.location.origin + apiUrl);

                // Test server connectivity first
                try {
                    const healthCheck = await fetch('/api/health', { method: 'GET' });
                    console.log('🏥 Health check status:', healthCheck.status);
                } catch (healthError) {
                    console.error('❌ Server connectivity test failed:', healthError);
                    throw new Error('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่อ');
                }

                // Send signature to backend - try PUT first, then POST if 404
                let response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                // If PUT returns 404, try POST method
                if (response.status === 404) {
                    console.log('🔄 PUT method returned 404, trying POST method...');
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                }

                console.log('📥 Response status:', response.status);
                console.log('📥 Response headers:', Object.fromEntries(response.headers.entries()));

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                console.log('📋 Content-Type:', contentType);
        
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('❌ Non-JSON response (first 500 chars):', responseText.substring(0, 500));
                    console.error('❌ Response URL:', response.url);
                    console.error('❌ Response redirected:', response.redirected);
        
                    // Check if it's a login page or error page
                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        if (responseText.includes('login') || responseText.includes('Login')) {
                            throw new Error('กรุณาเข้าสู่ระบบใหม่ - Session หมดอายุ');
                        } else if (responseText.includes('404') || responseText.includes('Not Found')) {
                            throw new Error('ไม่พบ API endpoint - กรุณาตรวจสอบการตั้งค่า server');
                        } else {
                            throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
                        }
                    } else {
                        throw new Error(`Server returned non-JSON response. Status: ${response.status}`);
                    }
                }

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('✅ Signature saved successfully:', result);
        
                    // Update local transfer data
                    if (signatureType === 'prepared') {
                        transferData.preparedSignature = signatureData;
                        transferData.preparedAt = updateData.signedAt;
                        transferData.preparedBy = currentUserId;
                        transferData.status = 'in-transit';
                    } else if (signatureType === 'received') {
                        transferData.receiverSignature = signatureData;
                        transferData.receivedAt = updateData.signedAt;
                        transferData.receivedBy = currentUserId;
                        transferData.status = 'completed';
        
                        // Show success message for completed transfer
                        alert('🎉 รับสินค้าเรียบร้อยแล้ว!\n\nสินค้าได้เข้าสู่สาขาปลายทางแล้ว');
        
                        // Update status checkboxes
                        updateStatusCheckboxes();
                    }

                    // Notify parent window if available
                    if (window.opener && window.opener.loadTransferHistory) {
                        window.opener.loadTransferHistory();
                    }

                } else {
                    console.error('❌ Failed to save signature:', result);
                    console.error('❌ Error details:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: result.error,
                        message: result.message,
                        code: result.code
                    });
        
                    const errorMessage = result.error || result.message || 'Unknown error';
                    alert('เกิดข้อผิดพลาดในการบันทึกลายเซ็น: ' + errorMessage);
                }

            } catch (error) {
                console.error('❌ Error saving signature:', error);
        
                // Provide more specific error messages
                let errorMessage = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
        
                if (error.message.includes('HTML instead of JSON')) {
                    errorMessage = 'เซิร์ฟเวอร์ส่งกลับข้อมูลไม่ถูกต้อง กรุณาเข้าสู่ระบบใหม่';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    errorMessage = 'กรุณาเข้าสู่ระบบใหม่';
                } else {
                    errorMessage = error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
                }
        
                alert(errorMessage);
            }
        }

        function updateSignatureDate(type) {
            const dateElement = document.getElementById(type + 'Date');
            if (dateElement) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('th-TH', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                dateElement.textContent = dateStr;
            }
        }

        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        // Print-friendly styles for signatures
        window.addEventListener('beforeprint', function() {
            const signatures = document.querySelectorAll('[id$="Signature"]');
            signatures.forEach(canvas => {
                if (canvas.style.display === 'block') {
                    canvas.style.border = '1px solid #000';
                }
            });
        });

        // Global function to manually populate data (for debugging)
        window.manualPopulateData = function() {
            console.log('Manual populate called, transferData:', window.transferData);
            if (window.transferData) {
                transferData = window.transferData;
                populateTransferData();
            }
        };

        // Debug function to test API connectivity
        window.testAPIConnectivity = async function() {
            console.log('🧪 Testing API connectivity...');
        
            const token = localStorage.getItem('authToken') ||
                         (window.opener && window.opener.localStorage.getItem('authToken'));
        
            if (!token) {
                console.error('❌ No token available');
                return;
            }

            try {
                // Test health endpoint
                const healthResponse = await fetch('/api/health');
                console.log('🏥 Health check:', healthResponse.status, healthResponse.statusText);

                // Test transfers endpoint
                const transfersResponse = await fetch('/api/transfers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('📦 Transfers endpoint:', transfersResponse.status, transfersResponse.statusText);

                // Test specific transfer if available
                if (transferData && transferData._id) {
                    const specificTransferResponse = await fetch(`/api/transfers/${transferData._id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    console.log('🎯 Specific transfer:', specificTransferResponse.status, specificTransferResponse.statusText);

                    // Test signature endpoints
                    console.log('🧪 Testing signature endpoints...');
        
                    // Test PUT method
                    const putTestResponse = await fetch(`/api/transfers/${transferData._id}/signature`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ signatureType: 'test', signatureData: 'test' })
                    });
                    console.log('🔧 PUT signature endpoint:', putTestResponse.status, putTestResponse.statusText);

                    // Test POST method
                    const postTestResponse = await fetch(`/api/transfers/${transferData._id}/signature`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ signatureType: 'test', signatureData: 'test' })
                    });
                    console.log('📮 POST signature endpoint:', postTestResponse.status, postTestResponse.statusText);
                }

                console.log('✅ API connectivity test completed');
            } catch (error) {
                console.error('❌ API connectivity test failed:', error);
            }
        };

        // Auto-populate when transferData is set
        Object.defineProperty(window, 'transferData', {
            set: function(value) {
                console.log('transferData setter called with:', value);
                transferData = value;
                if (value) {
                    setTimeout(() => {
                        populateTransferData();
                    }, 100);
                }
            },
            get: function() {
                return transferData;
            }
        });

        // Show/Hide Loading with Lottie animation
        let lottieAnimation = null;
        function showLoading(show) {
          const loader = document.getElementById('loadingOverlay');
          if (show) {
            loader.style.display = 'flex';
            loader.classList.remove('animate__fadeOut');
            loader.classList.add('animate__fadeIn');

            if (!lottieAnimation) {
              console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
              fetch('/Loading/Loading.json')
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
                })
                .then(animationData => {
                  lottieAnimation = lottie.loadAnimation({
                    container: document.getElementById('lottieContainer'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    animationData: animationData
                  });
                  console.log('✅ Lottie animation loaded successfully');
                })
                .catch(error => {
                  console.error('❌ Error loading Lottie animation:', error);
                  document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
                });
            } else {
              lottieAnimation.play();
            }
          } else {
            if (lottieAnimation) {
              lottieAnimation.pause();
            }
            loader.classList.remove('animate__fadeIn');
            loader.classList.add('animate__fadeOut');
            setTimeout(() => { loader.style.display = 'none'; }, 600);
          }
        }

        document.addEventListener('DOMContentLoaded', async () => {
          showLoading(true);
          // existing code...
          setTimeout(() => showLoading(false), 800);
        });

        window.addEventListener('beforeunload', () => {
          if (lottieAnimation) {
            lottieAnimation.destroy();
            lottieAnimation = null;
          }
        });

    </script>
</body>
</html>