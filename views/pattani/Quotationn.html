<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

    <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Modular Notification System -->
  <link rel="stylesheet" href="/css/notification-modules.css">
  <script src="/js/notification-modules.js"></script>

  <!-- Firebase v9 SDKs -->
  <script type="module">
    // Import Firebase v9 SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      off, 
      serverTimestamp, 
      onDisconnect, 
      remove 
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase Configuration - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Make Firebase functions globally available
    window.Firebase = {
      app,
      database,
      ref,
      set,
      get,
      push,
      onValue,
      off,
      serverTimestamp,
      onDisconnect,
      remove
    };

    console.log('üî• Firebase initialized successfully for quotation system');
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <script src="../js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif']
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7'
            }
          }
        }
      }
    };
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    #mainContent {
      flex: 1;
    }
    .dark body {
      background-color: #1a202c;
      color: #f8f9fa;
    }
    
    .breadcrumb-item {
      color: #6c757d;
    }
    
    .breadcrumb-item a {
      color: #0ea5e9;
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .dark .card {
      background-color: #2d3748;
      border-color: #4a5568;
    }
    
    .form-control {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      width: 100%;
    }
    
    .dark .form-control {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
      transition: all 0.2s;
    }
    
    .btn-rounded {
      border-radius: 30px;
    }
    
    .btn-outline-primary {
      border: 1px solid #0ea5e9;
      color: #0ea5e9;
      background-color: white;
    }
    
    .btn-outline-primary:hover {
      background-color: #f0f9ff;
    }
    
    .dark .btn-outline-primary {
      color: #38bdf8;
      border-color: #38bdf8;
      background-color: transparent;
    }
    
    .dark .btn-outline-primary:hover {
      background-color: rgba(56, 189, 248, 0.1);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 1px solid #eee;
    }
    
    .dark .table th {
      background-color: #2d3748;
      color: #d1d5db;
      border-bottom-color: #4a5568;
    }
    
    .table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    
    .dark .table td {
      border-bottom-color: #4a5568;
      color: #f8f9fa;
    }
    
    .text-right {
      text-align: right;
    }
    
    .page-link {
      min-width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      margin: 0 2px;
    }
    
    .dark .page-link {
      border-color: #4a5568;
      color: #d1d5db;
    }
    
    .page-link:hover {
      background-color: #f9f9fb;
    }
    
    .dark .page-link:hover {
      background-color: #374151;
    }
    
    .page-link.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    
    .dropdown-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      color: #333;
    }
    
    .dark .dropdown-select {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .account-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .account-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .dark .account-list li {
      border-bottom-color: #4a5568;
    }
    
    .account-list li:hover {
      background-color: #f9f9fb;
    }
    
    .dark .account-list li:hover {
      background-color: #374151;
    }
    
    .account-list li.active {
      background-color: #f0f9ff;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .dark .account-list li.active {
      background-color: #1a4971;
      color: #38bdf8;
    }
    
    .date-range {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dark .date-range {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .date-range:focus {
      border-color: #0ea5e9;
      outline: none;
    }
    
    .negative-value {
      color: #ef4444;
    }
    
    .dark .negative-value {
      color: #f87171;
    }
    
    .navbar {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 30;
    }
    
    .dark .navbar {
      background-color: #1e293b;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .flex-1 {
      flex: 1;
    }
    
    .flex-none {
      flex: none;
    }
    
    .btn-fancy {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
    }
    
    .btn-fancy:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 1s;
    }
    
    .btn-fancy:active:after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Dropdown menu styling */
    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
    }
    
    .menu-horizontal {
      display: flex;
      flex-direction: row;
    }
    
    .dropdown {
      position: relative;
    }
    
    .dropdown > a {
      display: flex;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    
    .dropdown ul {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
      z-index: 50;
      padding: 0.5rem;
    }
    
    .dark .dropdown ul {
      background-color: #1e293b;
    }
    
    .dropdown:focus-within ul {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .dropdown ul li {
      list-style: none;
    }
    
    .dropdown ul li a {
      display: block;
      padding: 0.5rem 1rem;
      color: #374151;
      text-decoration: none;
      border-radius: 0.25rem;
    }
    
    .dark .dropdown ul li a {
      color: #d1d5db;
    }
    
    .dropdown ul li a:hover {
      background-color: #f3f4f6;
    }
    
    .dark .dropdown ul li a:hover {
      background-color: #374151;
    }
    
    .submenu-item {
      transition: background-color 0.2s, padding-left 0.2s;
      border-left: 3px solid transparent;
      margin-bottom: 2px;
    }
    
    .submenu-item:hover {
      border-left-color: #0ea5e9;
      padding-left: 0.25rem;
    }
    
    /* User badge */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: rgba(14, 165, 233, 0.1);
      border-radius: 30px;
    }
    
    .user-avatar {
      background-color: #0ea5e9;
      color: white;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }
    
    .dark .user-avatar {
      background-color: #38bdf8;
      color: #1a202c;
    }
    
    /* Loader */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0ea5e9;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Tab active styling */
    .tab-active {
      background-color: #e0f2fe;
      color: #0ea5e9;
      font-weight: 500;
    }

    .dark .tab-active {
      background-color: #0284c7;
      color: white;
    }

    /* Badge styling */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-warning {
      background-color: #fef3c7;
      color: #d97706;
    }

    .badge-success {
      background-color: #d1fae5;
      color: #059669;
    }

    .badge-counter {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 9999px;
    }

    .badge-gray {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    /* Loading State CSS */
        .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    [data-theme="dark"]     [data-theme="dark"] .loading-spinner {
      border-color: #555;
      border-top-color: #3498db;
    }

    .badge-orange {
      background-color: #ffedd5;
      color: #ea580c;
    }

    .badge-blue {
      background-color: #dbeafe;
      color: #2563eb;
    }

    .badge-green {
      background-color: #d1fae5;
      color: #059669;
    }

    .dark .badge-warning {
      background-color: rgba(217, 119, 6, 0.2);
      color: #fcd34d;
    }

    .dark .badge-success {
      background-color: rgba(5, 150, 105, 0.2);
      color: #6ee7b7;
    }

    /* Empty state */
    .empty-state-container {
      display: none;
      padding: 3rem;
      text-align: center;
    }

    .hover-scale:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease-in-out;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tablecustom */
    .table-custom {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-custom thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #e2e8f0;
      padding: 12px 16px;
      font-weight: 500;
      text-align: left;
      color: #4b5563;
      background-color: #f9fafb;
    }

    .dark .table-custom thead th {
      background-color: #1f2937;
      border-bottom: 1px solid #374151;
      color: #d1d5db;
    }

    .table-custom tbody td {
      padding: 12px 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e5e7eb;
      color: #1f2937;
    }

    .dark .table-custom tbody td {
      border-bottom: 1px solid #374151;
      color: #e5e7eb;
    }

    .quotation-table-container {
      overflow-x: auto;
      border-radius: 8px;
      max-width: 100%;
      margin-bottom: 20px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ */
    .summary-box {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 1rem;
      background-color: #fff; /* dark:bg-gray-800 ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î */
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
    .summary-box p,
    .summary-box p strong,
    .summary-box p span {
      color: #111;
    }

    .dark .summary-box p,
    .dark .summary-box p strong,
    .dark .summary-box p span {
      color: #e5e7eb;
    }

    /* ---- ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡∏™‡πÑ‡∏ï‡∏•‡πå Sidebar & Layout (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á "‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤") ---- */
    :root {
      --primary-color: #0d6efd;
      --primary-hover: #138af2;
      --bg-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --transition-speed: 0.3s;
    }
    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }
    body {
      font-family: "Prompt", sans-serif;
      /* margin: 0; */ /* Existing body style already has margin: 0 */
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #btnToggleMenu { /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° */ }
    aside.collapsed {
      width: 5rem;
    }
    aside.collapsed .ml-3 {
      display: none;
    }
    aside.collapsed .Logo,
    aside.collapsed #employeeName,
    aside.collapsed .text-xs {
      display: none;
    }
    aside.collapsed .p-4 {
      padding: 0.5rem;
    }
    aside.collapsed a {
      justify-content: center;
    }
    /* Bubble style (‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Sidebar) */
    .bubble {
      width: 110px;
      height: 130px;
      border-radius: 0.75rem;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: transform var(--transition-speed);
      background-color: var(--primary-color);
      position: relative;
    }
    .bubble:hover {
      transform: scale(1.05);
      background-color: var(--primary-hover);
    }
    .bubble h6 {
      font-size: 0.875rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }
    .stock-count {
      position: absolute;
      bottom: 0.5rem;
      font-size: 0.75rem;
    }
    /* .card style from template - note existing .card style might conflict or be overridden */
    .card {
      background-color: var(--bg-color) !important;
      color: var(--text-color) !important;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .lightOnly { display: block; }
    .darkOnly { display: none; }
    .dark .lightOnly { display: none !important; }
    .dark .darkOnly { display: block !important; }
    .dark .dark-bg { background-color: var(--bg-color); }
    .dark .dark-text { color: var(--primary-color); }
    /* Main content margin */
    #mainContent {
      transition: margin-left 0.3s ease-in-out;
    }
    .main-content { /* This class might be used on the mainContent div if not directly using ID for margin */
      margin-left: 14rem;
      transition: margin-left 0.3s;
    }
    .main-content.collapsed {
      margin-left: 0;
    }
    aside {
      transition: transform 0.3s;
    }
    aside.-translate-x-full {
      transform: translateX(-100%);
    }
    #sidebar ul li a.active {
      background-color: var(--primary-color);
      color: #fff;
    }
    #sidebar ul li a.active i {
      color: #fff !important;
    }
    #sidebar ul li a {
  color: #333333 !important; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
}
    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #fff !important;
    }
    /* ---- ‡∏à‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå Sidebar & Layout ---- */
    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>



  <!-- Enhanced Firebase Realtime Database + Socket.IO Integration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== FIREBASE REALTIME DATABASE + SOCKET.IO INTEGRATION ====================
    
    // Enhanced Socket.IO Configuration
    let socket;
    let socketConnected = false;
    let firebaseConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;
    let onlineUsers = 0;

    // Current session data
    const currentSession = {
      branchCode: '',
      sessionId: '',
      staffId: localStorage.getItem('userId') || 'anonymous',
      staffName: localStorage.getItem('userName') || 'Unknown',
      timestamp: Date.now(),
      page: 'quotation'
    };

    // Firebase References
    let firebaseRefs = {};

    // Initialize Enhanced Socket.IO
    function initializeEnhancedSocket() {
      if (typeof io === 'function') {
        socket = io({
          timeout: 10000,
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          randomizationFactor: 0.5
        });

        // Connection Events
        socket.on('connect', () => {
          console.log('üîó Socket.IO connected for quotation:', socket.id);
          socketConnected = true;
          reconnectAttempts = 0;
          updateSocketStatus(true);

          // Join quotation-specific rooms
          socket.emit('join_branch', {
            branchCode: currentSession.branchCode,
            page: 'quotation',
            staffId: currentSession.staffId,
            staffName: currentSession.staffName,
            timestamp: new Date().toISOString()
          });

          socket.emit('join_notification_room', {
            branchCode: currentSession.branchCode,
            page: 'quotation'
          });

          // Start heartbeat
          startHeartbeat();
        });

        socket.on('disconnect', (reason) => {
          console.log('‚ùå Socket.IO disconnected:', reason);
          socketConnected = false;
          updateSocketStatus(false);
          stopHeartbeat();
    
          if (reason === 'io server disconnect') {
            socket.connect();
          }
        });

        socket.on('reconnect', (attemptNumber) => {
          console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
          socketConnected = true;
          reconnectAttempts = 0;
          updateSocketStatus(true);
          showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        });

        socket.on('reconnect_attempt', (attemptNumber) => {
          console.log('üîÑ Socket.IO reconnect attempt:', attemptNumber);
          reconnectAttempts = attemptNumber;
        });

        socket.on('reconnect_error', (error) => {
          console.error('‚ùå Socket.IO reconnect error:', error);
        });

        socket.on('reconnect_failed', () => {
          console.error('‚ùå Socket.IO reconnect failed after maximum attempts');
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
        });

        // Enhanced Event Handlers for Quotation System
        socket.on('quotation_created', (data) => {
          console.log('üìã Quotation created:', data);
          showToast(`üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    
          // Add to notification system
          if (typeof posNotificationSystem !== 'undefined' && posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: 'üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || '‡πÉ‡∏´‡∏°‡πà'} ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        socket.on('quotation_approved', (data) => {
          console.log('‚úÖ Quotation approved:', data);
          showToast(`‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, 'success');
    
          if (typeof posNotificationSystem !== 'undefined' && posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: '‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        socket.on('quotation_rejected', (data) => {
          console.log('‚ùå Quotation rejected:', data);
          showToast(`‚ùå ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, 'error');
    
          if (typeof posNotificationSystem !== 'undefined' && posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: '‚ùå ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ${data.reason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'}`,
              type: 'error',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        socket.on('invoice_generated', (data) => {
          console.log('üßæ Invoice generated:', data);
          showToast(`üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ${data.invoiceNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    
          if (typeof posNotificationSystem !== 'undefined' && posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: 'üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
              message: `‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ${data.invoiceNumber || ''} ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''}`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        socket.on('quotation_updated', (data) => {
          console.log('üìù Quotation updated:', data);
          showToast(`üìù ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç`, 'info');
    
          if (typeof posNotificationSystem !== 'undefined' && posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: 'üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${data.quotationNumber || ''} ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`,
              type: 'info',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        });

        // Branch and system notifications
        socket.on('branch_notification', (data) => {
          console.log('üîî Branch notification:', data);
          showToast(data.message || 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', data.type || 'info');
        });

        socket.on('system_notification', (data) => {
          console.log('üîß System notification:', data);
          showToast(`üîß ${data.message}`, data.type || 'warning');
        });

        // Error handling
        socket.on('connect_error', (error) => {
          console.error('‚ùå Socket.IO connect error:', error);
          socketConnected = false;
          updateSocketStatus(false);
        });

        socket.on('error', (error) => {
          console.error('‚ùå Socket.IO error:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
        });

        console.log('‚úÖ Enhanced Socket.IO initialized for quotation system');
      } else {
        console.warn('‚ö†Ô∏è Socket.IO script not loaded for quotation system');
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info - ‡πÉ‡∏ä‡πâ BRANCH_CODE ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
        currentSession.branchCode = BRANCH_CODE;
        currentSession.sessionId = `quotation-${currentSession.staffId}-${Date.now()}`;

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          quotationUpdates: ref(database, `pos/${currentSession.branchCode}/quotationUpdates`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? 'üî• Firebase connected' : '‚ùå Firebase disconnected');
          firebaseConnected = connected;
          updateFirebaseStatus(connected);
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                showToast(notification.message, notification.type || 'info');
              }
            });
          }
        });

        // Listen for quotation updates
        onValue(firebaseRefs.quotationUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('üìã Quotation update:', update);
                showToast(`üìã ${update.message || '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'}`, update.type || 'info');
    
                // Reload quotations if needed
                if (update.action === 'reload' && typeof loadQuotations === 'function') {
                  setTimeout(() => loadQuotations(), 1000);
                }
              }
            });
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
          updateOnlineCount(count);
        });

        console.log('üî• Firebase listeners setup successfully for quotation');
      } catch (error) {
        console.error('‚ùå Firebase setup error:', error);
        updateFirebaseStatus(false);
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'quotation',
          timestamp: serverTimestamp()
        });

        console.log('üìù Session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('‚ùå Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const activityHistoryRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/activityHistory`);
        const { push } = window.Firebase;
        push(activityHistoryRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'quotation',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('‚ùå Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'quotation'
        });
        console.log('üîî Notification sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send notification:', error);
      }
    }

    // Send quotation data to Firebase
    function sendQuotationToFirebase(quotationData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        const quotationRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/quotations`);
        push(quotationRef, {
          ...quotationData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'quotation'
        });
        console.log('üìã Quotation data sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send quotation data:', error);
      }
    }

    // Heartbeat system
    function startHeartbeat() {
      heartbeatInterval = setInterval(() => {
        if (socket && socketConnected) {
          socket.emit('ping', {
            branchCode: currentSession.branchCode,
            page: 'quotation',
            timestamp: Date.now()
          });
        }
    
        // Update Firebase activity
        updateActivity('heartbeat');
      }, 30000); // 30 seconds
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // UI Update Functions
    function updateFirebaseStatus(connected) {
      const firebaseStatusEl = document.getElementById('firebaseStatus');
      if (firebaseStatusEl) {
        firebaseStatusEl.classList.toggle('connected', connected);
        firebaseStatusEl.classList.toggle('disconnected', !connected);
      }
      updateConnectionStatus();
    }

    function updateSocketStatus(connected) {
      const socketStatusEl = document.getElementById('socketStatus');
      if (socketStatusEl) {
        socketStatusEl.classList.toggle('connected', connected);
        socketStatusEl.classList.toggle('disconnected', !connected);
      }
      updateConnectionStatus();
    }

    function updateOnlineCount(count) {
      const onlineCountEl = document.getElementById('onlineCount');
      if (onlineCountEl) {
        onlineCountEl.textContent = count;
      }
    }

    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      const textEl = document.getElementById('connectionText');
    
      if (!statusEl || !textEl) return;

      // Remove all status classes
      statusEl.classList.remove('online', 'partial', 'offline', 'connecting');
    
      if (firebaseConnected && socketConnected) {
        statusEl.classList.add('online');
        textEl.textContent = 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
      } else if (firebaseConnected || socketConnected) {
        statusEl.classList.add('partial');
        textEl.textContent = 'üü° ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
      } else {
        statusEl.classList.add('offline');
        textEl.textContent = 'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
      }
    }

    // Enhanced Socket.IO Functions
    function emitQuotationUpdate(data) {
      if (socket && socketConnected) {
        socket.emit('quotation_update', {
          branchCode: currentSession.branchCode,
          ...data,
          timestamp: Date.now()
        });
      }
    }

    function emitInvoiceUpdate(invoiceData) {
      if (socket && socketConnected) {
        socket.emit('invoice_update', {
          branchCode: currentSession.branchCode,
          ...invoiceData,
          timestamp: Date.now()
        });
      }
    }

    // Get connection status
    function getConnectionStatus() {
      return {
        firebase: firebaseConnected,
        socket: socketConnected,
        combined: firebaseConnected && socketConnected,
        onlineUsers: onlineUsers,
        sessionId: currentSession.sessionId
      };
    }

    // Global functions for quotation system
    window.QuotationConnection = {
      emitQuotationUpdate,
      emitInvoiceUpdate,
      sendNotificationToFirebase,
      sendQuotationToFirebase,
      updateActivity,
      getConnectionStatus,
      currentSession
    };

    // Initialize both systems when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Initializing Firebase + Socket.IO for quotation system...');
      initializeEnhancedSocket();
      initializeFirebase();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopHeartbeat();
      if (window.Firebase && firebaseRefs.sessions) {
        window.Firebase.remove(firebaseRefs.sessions);
      }
    });

    console.log('üî• Firebase Realtime Database + Socket.IO integration loaded for quotation');
  </script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script>
    // New Lottie Loading State with State Management (same as frontstore_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

        </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between ml-56 transition-all duration-300" id="mainHeader">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
        
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 mt-1">
          <div id="connectionStatus" class="connection-status">
            <span id="connectionText" class="connection-text">üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            <div class="connection-details">
              <span id="firebaseStatus" class="status-dot firebase" title="Firebase Realtime Database">‚óè</span>
              <span id="socketStatus" class="status-dot socket" title="Socket.IO">‚óè</span>
              <span id="onlineCount" class="online-count" title="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modular Notifications -->
      <div class="flex items-center gap-4">
        <!-- POS Notification Bell -->
        <div class="notification-bell pos-module" id="posNotificationBell">
          <button class="notification-toggle" title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS">
            <i class="bi bi-bell"></i>
            <span class="notification-badge" id="posNotificationCount">0</span>
          </button>
          
          <!-- Dropdown Notifications -->
          <div class="notification-dropdown" id="posNotificationDropdown">
            <div class="notification-header">
              <h3><i class="bi bi-shop-window"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS</h3>
              <div class="notification-actions">
                <button class="mark-all-read" onclick="markAllAsRead('pos')">
                  <i class="bi bi-check-all"></i>
                </button>
                <button class="clear-all" onclick="clearAllNotifications('pos')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            <div class="notification-list" id="posNotificationList">
              <!-- Notifications will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Toast Notification Container for POS Module -->
    <div id="posToastContainer" class="toast-container pos-module"></div>
    
    <!-- Main Content -->
    <div id="mainContent" class="flex-1 p-6 ml-56">
      <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
      <div class="text-sm breadcrumbs mb-4">
        <ul>
          
        </ul>
      </div>
      
<div class="flex justify-between items-center mb-6 flex-wrap gap-4">
  <div class="flex items-center">
    <i class="bi bi-file-earmark-text text-4xl mr-3 text-green-500"></i>
    <h1 class="text-2xl font-semibold dark:text-white">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
  </div>
  <div class="flex gap-3">
    <div class="dropdown dropdown-end">
      <label tabindex="0"
             class="btn btn-primary btn-sm gap-2 btn-fancy hover-scale shadow-md">
        <i class="bi bi-plus-lg"></i>
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
        <i class="bi bi-chevron-down text-xs"></i>
      </label>
      <ul tabindex="0"
          class="dropdown-content menu p-2 shadow bg-base-100 dark:bg-gray-700 rounded-box w-52">
        <li>
          <a id="createNewQuotation"
             class="flex items-center gap-2 px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded">
            <i class="bi bi-file-earmark-plus"></i>
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Add missing buttons -->
    <button id="btnDisplaySettings"
            class="btn btn-sm btn-outline flex items-center gap-1">
      <i class="bi bi-gear text-sm"></i>
      ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    </button>
    
    <button id="btnPrintReport"
            class="btn btn-sm btn-outline flex items-center gap-1">
      <i class="bi bi-printer text-sm"></i>
      ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    </button>
    
    <a href="Invoicee"
       class="btn btn-sm btn-outline-primary flex items-center gap-1">
      <i class="bi bi-receipt text-sm"></i>
      ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
    </a>
  </div>
</div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
        <div class="quotation-table-container overflow-x-auto">
          <table class="table w-full table-custom">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="w-12"><input type="checkbox" class="rounded border-gray-300" /></th>
                <th class="cursor-pointer"><div class="flex items-center">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
                <th><div class="flex items-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div></th>
                <th class="cursor-pointer"><div class="flex items-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
                <th><div class="flex items-center">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ/‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</div></th>
                <th><div class="flex items-center">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div></th>
                <th><div class="flex items-center">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></th>
                <th class="cursor-pointer text-right"><div class="flex items-center justify-end">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
                <th class="cursor-pointer text-right"><div class="flex items-center justify-end">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
                <th><div class="flex items-center">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div></th>
              </tr>
            </thead>
            <tbody id="quotationList">
              <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢ loadQuotations() -->
            </tbody>
          </table>
        </div>  <!-- ‡∏õ‡∏¥‡∏î quotation-table-container -->

        <!-- === Pagination ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÉ‡∏ï‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á === -->
        <div id="pagination" class="mt-4 px-4 py-3 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">‡πÅ‡∏™‡∏î‡∏á</span>
            <select id="pageSize" class="dropdown-select">
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
            <span class="text-sm text-gray-600 dark:text-gray-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="prevPage" class="btn btn-xs btn-outline disabled:opacity-50">
              <i class="bi bi-chevron-left"></i>
            </button>
            <span class="text-sm dark:text-gray-400">‡∏´‡∏ô‡πâ‡∏≤</span>
            <input id="currentPage" type="text" value="1" class="input input-xs input-bordered w-12 text-center" />
            <button id="nextPage" class="btn btn-xs btn-outline">
              <i class="bi bi-chevron-right text-blue-500"></i>
            </button>
          </div>
        </div>

        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -->
        <div class="empty-state-container bg-white dark:bg-gray-800 p-8 rounded-lg text-center">
          <svg class="w-48 h-48 mx-auto mb-4 opacity-60" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
          <p class="text-gray-500 dark:text-gray-400 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
          <button id="btnCreateFromEmpty" class="btn btn-primary px-6 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white flex items-center gap-2 mx-auto">
            <i class="bi bi-plus-lg"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Modal for creating a new installment quotation -->
  <div id="newQuotationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-4xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold dark:text-white">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
        <div class="flex items-center gap-2">
          <label for="quotationDate" class="text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</label>
          <input
   type="datetime-local"
   id="quotationDate"
   readonly
   class="block w-60 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 cursor-not-allowed"
 />
        </div>
        <button id="closeQuotationModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="overflow-y-auto max-h-[80vh]">
        <form id="quotationForm">
          <input type="hidden" id="quotationNumber" name="quotationNumber" />
          <!-- Salesperson Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ / ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≤‡∏¢</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label>
                <select id="salesChannel" class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="store">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</option>
                  <option value="online">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                  <option value="online-deposit">‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                  <option value="pre-order">Pre-order (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å)</option>
                </select>
              </div>
              <div>
                <label for="salespersonName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</label>
                <input
                  type="text"
                  id="salespersonName"
                  class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  readonly
                />
              </div>
            </div>
            <!-- Additional fields for online sales -->
            <div id="onlineFields" class="mt-4 hidden">
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                  <textarea id="shippingAddress" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
                  <input type="text" id="recipientPhone" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
                </div>
              </div>
            </div>
          </div>

          <!-- Customer Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                <input id="customerName" type="text" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                <textarea id="customerAddress" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label>
                <input id="customerTaxId" type="text" maxlength="13" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (13 ‡∏´‡∏•‡∏±‡∏Å)" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
              </div>
            </div>
            
         
          </div>

          <!-- Pricing Conditions Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</label>
                <select class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                  <option>30 ‡∏ß‡∏±‡∏ô</option>
                  <option>60 ‡∏ß‡∏±‡∏ô</option>
                </select>
              </div>

              <!-- VAT -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (%)</label>
                <input
                  type="number"
                  id="vatRate"
                  class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                  value="7"
                  min="0"
                  step="0.01"
                />
              </div>
              <!-- Discount -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                <input
                  type="number"
                  id="discountValue"
                  class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                  value="0"
                  min="0"
                  step="0.01"
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"
                />
              </div>
            </div>
          </div>

          <!-- Product Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</p>
            <div class="overflow-x-auto">
              <table class="table w-full table-custom">
                <thead>
                  <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI -->
                  <tr>
                    <td colspan="5" class="p-2">
                      <div class="relative">
                        <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input
                          type="text"
                          id="imeiSearch"
                          placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç IMEI ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter"
                          class="pl-10 pr-4 py-2 border rounded w-full"
                        />
                      </div>
                    </td>
                  </tr>
                  <!-- ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà -->
                  <tr>
                    <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå)</th>
                    <th>‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</th>
                    <th class="w-12 text-center"></th> <!-- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö -->
                  </tr>
                </thead>
                <tbody id="quotationItems">
                  <!-- ‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
                  <tr>
                    <td>
                      <select class="product-select block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                      </select>
                    </td>
                    <td>
                      <input type="number" value="0.00" class="unit-price block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
                    </td>
                    <td>
                      <input type="number" value="500" class="doc-fee block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
                    </td>
                    <td>
                      <input type="number" value="0.00" disabled class="total-price block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-gray-100 dark:bg-gray-600 text-gray-500" />
                    </td>
                    <td class="text-center">
                      <button type="button" class="btn-remove text-red-500 hover:text-red-700">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="flex gap-3 mt-4">
              <button type="button" id="addNewItem" class="btn btn-sm btn-primary px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md flex items-center gap-1">
                <i class="bi bi-plus-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </button>
            </div>
            <div class="mt-6 summary-box">
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏™‡∏£‡∏∏‡∏õ</h4>
              <div class="grid grid-cols-2 gap-4">
                <p class="text-sm"><strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°:</strong> <span id="summarySubtotal" class="font-semibold">0.00</span></p>
                <p class="text-sm"><strong>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> <span id="summaryShipping" class="font-semibold">0.00</span></p>
                <p class="text-sm"><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°:</strong> <span id="summaryDiscount" class="font-semibold">0.00</span></p>
                <p class="text-sm"><strong>‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°:</strong> <span id="summaryTax" class="font-semibold">0.00</span></p>
                <p class="text-sm"><strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ:</strong> <span id="summaryBeforeTax" class="font-semibold">0.00</span></p>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" id="cancelQuotation" class="btn btn-outline btn-sm px-4 py-2 border border-gray-300 hover:bg-gray-100 rounded-md text-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-primary btn-sm px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Modal for Display Settings -->
  <div id="displaySettingsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold dark:text-white">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h2>
        <button id="closeDisplaySettingsModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <form>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</h3>
          <div class="grid grid-cols-2 gap-4">
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisMonth" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="lastMonth" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisAndLastMonth" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" checked />
              <span class="text-gray-700 dark:text-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisQuarter" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="lastQuarter" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisAndLastQuarter" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisYear" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="lastYear" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issueDate" value="thisAndLastYear" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
          </div>
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°</h3>
          <div class="grid grid-cols-1 gap-4">
            <label class="flex items-center">
              <input type="radio" name="sortBy" value="issueDate" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="sortBy" value="creationDate" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" checked />
              <span class="text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="sortBy" value="documentNumber" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
            </label>
          </div>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelDisplaySettings" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="px-4 py-2 bg-blue-500 border border-blue-500 rounded-md text-white hover:bg-blue-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Modal for Printing Report -->
  <div id="printReportModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold dark:text-white">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
        <button id="closePrintReportModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <form>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
          <input type="text" placeholder="01/04/2025 - 31/05/2025" class="block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
          <div class="grid grid-cols-2 gap-4">
            <label class="flex items-center">
              <input type="radio" name="reportType" value="basic" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" checked />
              <span class="text-gray-700 dark:text-gray-300">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="reportType" value="detailed" class="mr-2 text-blue-500 focus:ring-blue-500 border-gray-300 dark:border-gray-600" />
              <span class="text-gray-700 dark:text-gray-300">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
            </label>
          </div>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelPrintReport" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="px-4 py-2 bg-blue-500 border border-blue-500 rounded-md text-white hover:bg-blue-600">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // Function to show/hide loading overlay
        // Get branch code from URL parameter (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_pattani.html)
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

    if (!BRANCH_CODE) {
      console.warn("Branch not found in URL or localStorage, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    window.BRANCH_CODE = BRANCH_CODE; // Make it globally accessible
    console.log(`[Quotationn] Using branch code: ${BRANCH_CODE}`);

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó localStorage ‡πÅ‡∏•‡∏∞ title
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ${decodeURIComponent(urlParams.get('name'))}`;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    let loggedInUser = { id: null, name: '', photoUrl: '' };

    // Global notification system instance
    let posNotificationSystem = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å API
    async function fetchLoggedInUser() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const res = await fetch('/api/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.error || 'Load profile failed');

        const u = json.data;
        loggedInUser.id       = u._id;
        loggedInUser.name     = u.name;
        loggedInUser.photoUrl = u.photoUrl || '/uploads/default-avatar.png';

        // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô sidebar
        document.getElementById('employeeName').textContent = loggedInUser.name;
        document.getElementById('employeePhoto').src        = loggedInUser.photoUrl;
      } catch (e) {
        console.error('fetchLoggedInUser error:', e);
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å API (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å frontstore_index.html)
    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        if (!token) {
          console.warn('‚ùå No auth token for loading branch info');
          document.getElementById('branchInfo').textContent = '‡∏™‡∏≤‡∏Ç‡∏≤: (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö)';
          return;
        }
    
        console.log('üîç Loading branch info for BRANCH_CODE:', BRANCH_CODE);
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_index.html)
        const res = await fetch('/api/branch', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        console.log('üì° Branch API response status:', res.status);
    
        const brJson = await res.json();
        console.log('üìã Branch API response:', brJson);
    
        if (!res.ok || !brJson.success) {
          throw new Error(brJson.error || 'Cannot load branches');
        }
    
        const BRANCHES = brJson.data;
        console.log('üìã Available branches:', BRANCHES.map(b => `${b.name} (${b.branch_code})`));
        console.log('üìã Available branch codes:', BRANCHES.map(b => b.branch_code));
    
        // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
        let branch = BRANCHES.find(b => b.branch_code === BRANCH_CODE);
    
        if (!branch) {
          console.warn('‚ö†Ô∏è Direct branch code match not found, trying alternative matching...');
    
          // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (case-insensitive)
          branch = BRANCHES.find(b =>
            b.name.toLowerCase().includes(BRANCH_CODE.toLowerCase()) ||
            BRANCH_CODE.toLowerCase().includes(b.name.toLowerCase())
          );
    
          if (!branch) {
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ "pattani"
            branch = BRANCHES.find(b =>
              b.name.toLowerCase().includes('‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ') ||
              b.name.toLowerCase().includes('pattani') ||
              b.address.toLowerCase().includes('‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ') ||
              b.address.toLowerCase().includes('pattani')
            );
          }
    
          if (branch) {
            console.log('‚úÖ Found alternative branch match:', branch.name, '(', branch.branch_code, ')');
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó BRANCH_CODE ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            BRANCH_CODE = branch.branch_code;
            window.currentBranchCode = BRANCH_CODE;
            window.BRANCH_CODE = BRANCH_CODE;
            console.log('üîÑ Updated BRANCH_CODE to:', BRANCH_CODE);
          }
        }
    
        if (branch) {
          console.log('‚úÖ Found matching branch:', branch.name);
          document.getElementById('branchInfo').textContent =
            `${branch.name} ‚Äî ${branch.address}`;
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
          document.title = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ${branch.name}`;
          document.getElementById('pageTitle').textContent = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ${branch.name}`;
          return;
        } else {
          console.error('‚ùå Branch not found:', BRANCH_CODE);
          console.error('‚ùå Available branch codes:', BRANCHES.map(b => b.branch_code));
          throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${BRANCH_CODE}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
        }
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent =
          '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        document.getElementById('pageTitle').textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
    
        // ‡πÅ‡∏™‡∏î‡∏á error ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö
        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ: ${err.message}`);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
    
      try {
        // Show loading animation
        showLoading(true);
    
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏ï‡∏≤‡∏° branch name
        const urlParams = new URLSearchParams(window.location.search);
        const branchName = urlParams.get('name');
        if (branchName) {
          document.title = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ${decodeURIComponent(branchName)}`;
        }
    
        // Initialize Modular Notification System
        if (typeof ModularNotificationSystem !== 'undefined') {
          posNotificationSystem = new ModularNotificationSystem();
          console.log('üîî POS Notification System initialized');
    
          // Add welcome notification
          posNotificationSystem.addNotification('pos', {
            title: '‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
            message: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}`,
            type: 'success',
            icon: 'üìã',
            actions: [
              {
                label: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
                action: 'primary',
                callback: () => {
                  console.log('üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
                  document.getElementById('createNewQuotation')?.click();
                }
              }
            ]
          });
        } else {
          console.warn('‚ö†Ô∏è ModularNotificationSystem not available');
        }
    
        fetchLoggedInUser();
    
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Ñ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_pattani.html)
        await loadBranchInfo();

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        let branchProducts = [];
    
        // 1) ‡πÇ‡∏´‡∏•‡∏î stock ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏° field imei ‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡∏°‡πà
        async function loadBranchProducts() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              console.warn('‚ùå No auth token for loading products');
              return;
            }
    
            // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å URL parameter (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_pattani.html)
            let branchCode = window.currentBranchCode || BRANCH_CODE;
    
            if (!branchCode) {
              console.warn('‚ö†Ô∏è No branch code available, cannot load products');
              branchProducts = [];
              return;
            }
    
            console.log('üîç Loading products for branch:', branchCode);
    
            const res = await fetch(`/api/branch-stock/taxType?branch_code=${encodeURIComponent(branchCode)}`, {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
    
            if (res.status === 404) {
              console.error('‚ùå Products API not found (404)');
              branchProducts = [];
              return;
            }
    
            if (res.status === 401) {
              console.error('‚ùå Unauthorized access to products API');
              setTimeout(() => {
                window.location.href = '/login';
              }, 2000);
              return;
            }
    
            const body = await res.json();
            if (body.success) {
              branchProducts = body.data;
              console.log('‚úÖ Products loaded:', branchProducts.length, 'items');
            } else {
              console.error('‚ùå Load products failed:', body.error);
              branchProducts = [];
            }
          } catch (err) {
            console.error('‚ùå Fetch products error:', err);
            branchProducts = [];
          }
        }
    
        // helper ‡∏™‡∏£‡πâ‡∏≤‡∏á <option>
        function createProductOptions() {
          let html = '<option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>';
          branchProducts.forEach(p => {
            // Handle both BranchStock format (with imei) and ProductImage format (without imei)
            const displayText = p.imei ? `${p.name} (${p.imei})` : p.name;
            html += `<option value="${p._id}">${displayText}</option>`;
          });
          return html;
        }
    
        // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤
        loadBranchProducts();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
        async function loadProductsBasedOnChannel(channel) {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              console.warn('‚ùå No auth token for loading products');
              return;
            }

            let branchCode = window.currentBranchCode || BRANCH_CODE;
            if (!branchCode) {
              console.warn('‚ö†Ô∏è No branch code available');
              return;
            }

            let apiUrl;
            let products = [];

            switch (channel) {
              case 'store':
              case 'online':
              case 'online-deposit':
                // ‡πÉ‡∏ä‡πâ branchStockRoutes API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
                apiUrl = `/api/branch-stock/taxType?branch_code=${encodeURIComponent(branchCode)}`;
                break;
              case 'pre-order':
                // ‡πÉ‡∏ä‡πâ productImageRoutes API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
                apiUrl = `/api/product-image/not-in-stock?branchCode=${encodeURIComponent(branchCode)}`;
                break;
              default:
                apiUrl = `/api/branch-stock/taxType?branch_code=${encodeURIComponent(branchCode)}`;
            }

            console.log('üîç Loading products for channel:', channel, 'URL:', apiUrl);

            const res = await fetch(apiUrl, {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });

            if (res.ok) {
              const body = await res.json();
              if (body.success && Array.isArray(body.data)) {
                branchProducts = body.data;
                console.log('‚úÖ Products loaded:', branchProducts.length, 'items for channel:', channel);

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                updateAllProductDropdowns();

              } else {
                console.error('‚ùå Invalid response format:', body);
                branchProducts = [];
              }
            } else {
              console.error('‚ùå Failed to load products:', res.status);
              branchProducts = [];
            }
          } catch (err) {
            console.error('‚ùå Error loading products for channel:', channel, err);
            branchProducts = [];
          }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function updateAllProductDropdowns() {
          const selects = document.querySelectorAll('select.product-select');
          selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = createProductOptions();

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° restore ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
              select.value = currentValue;
            }
          });
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö interval
        let dateTimeInterval;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô input quotationDate
        function updateQuotationDate() {
          const now = new Date();
          const offsetMs = now.getTimezoneOffset() * 60000;
          const localISO = new Date(now - offsetMs).toISOString().slice(0,16);
          document.getElementById('quotationDate').value = localISO;
        }

        // Open new quotation modal
        document.getElementById('createNewQuotation').addEventListener('click', function () {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç QYYYYMMDD-XXX
          const now   = new Date();
          const y     = now.getFullYear();
          const m     = String(now.getMonth()+1).padStart(2,'0');
          const d     = String(now.getDate()).padStart(2,'0');
          const seq   = Math.floor(Math.random()*900+100);
          const qnum  = `Q${y}${m}${d}-${seq}`;
          document.getElementById('quotationNumber').value = qnum;

          // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å sidebar ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÉ‡∏ô input readonly
          document.getElementById('salespersonName').value = loggedInUser.name || '';

          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏° timer
          updateQuotationDate();
          clearInterval(dateTimeInterval);
          dateTimeInterval = setInterval(updateQuotationDate, 30 * 1000);

          // ‡πÄ‡∏õ‡∏¥‡∏î modal
          document.getElementById('newQuotationModal').classList.remove('hidden');

          // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
          const tbody = document.getElementById('quotationItems');
          tbody.innerHTML = '';
          document.getElementById('addNewItem').click();
        });

        // Close new quotation modal
        document.getElementById('closeQuotationModal').addEventListener('click', function () {
          clearInterval(dateTimeInterval);
          document.getElementById('newQuotationModal').classList.add('hidden');
        });
    
        // Add btnCreateFromEmpty event listener
        const btnCreateFromEmpty = document.getElementById('btnCreateFromEmpty');
        if (btnCreateFromEmpty) {
          btnCreateFromEmpty.addEventListener('click', function() {
            document.getElementById('createNewQuotation').click();
          });
        }
    
        // Open display settings modal (guard in case element is missing)
        const btnDisplaySettings = document.getElementById('btnDisplaySettings');
        if (btnDisplaySettings) {
          btnDisplaySettings.addEventListener('click', function () {
            document.getElementById('displaySettingsModal').classList.remove('hidden');
          });
        }
    
        // Close display settings modal
        document.getElementById('closeDisplaySettingsModal').addEventListener('click', function () {
          document.getElementById('displaySettingsModal').classList.add('hidden');
        });
    
        // Open print report modal (guard in case element is missing)
        const btnPrintReport = document.getElementById('btnPrintReport');
        if (btnPrintReport) {
          btnPrintReport.addEventListener('click', function () {
            document.getElementById('printReportModal').classList.remove('hidden');
          });
        }
    
        // Close print report modal
        document.getElementById('closePrintReportModal').addEventListener('click', function () {
          document.getElementById('printReportModal').classList.add('hidden');
        });
    
        // Add new item row in quotation modal
        document.getElementById('addNewItem').addEventListener('click', function () {
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>
              <select class="product-select block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                ${createProductOptions()}
              </select>
            </td>
            <td>
              <input type="number" value="0.00" class="unit-price block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
            </td>
            <td>
              <input type="number" value="500" class="doc-fee block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
            </td>
            <td>
              <input type="number" value="0.00" disabled class="total-price block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-gray-100 dark:bg-gray-600 text-gray-500" />
            </td>
            <td class="text-center">
              <button type="button" class="btn-remove text-red-500 hover:text-red-700">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          document.getElementById('quotationItems').appendChild(newRow);
          calculateTotals();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° unit-price + doc-fee
        function calculateTotals() {
          document.querySelectorAll('#quotationItems tr').forEach(row => {
            const up = parseFloat(row.querySelector('input.unit-price').value) || 0;
            const df = parseFloat(row.querySelector('input.doc-fee').value) || 0;
            row.querySelector('input.total-price').value = (up + df).toFixed(2);
          });
          updateSummary();  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        }

        // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞ VAT
        function updateSummary() {
          const prices = Array.from(document.querySelectorAll('#quotationItems .total-price'))
            .map(el => parseFloat(el.value) || 0);
          const subtotal = prices.reduce((a,b) => a + b, 0);
          const shipping = 0;    // ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å input ‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          const discount = 0;    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          const beforeTax = subtotal + shipping - discount;
          const tax = beforeTax * 0.07;
          document.getElementById('summarySubtotal').textContent   = subtotal.toFixed(2);
          document.getElementById('summaryShipping').textContent  = shipping.toFixed(2);
          document.getElementById('summaryDiscount').textContent  = discount.toFixed(2);
          document.getElementById('summaryBeforeTax').textContent = beforeTax.toFixed(2);
          document.getElementById('summaryTax').textContent       = tax.toFixed(2);
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ unit-price ‡∏´‡∏£‡∏∑‡∏≠ doc-fee
        document.getElementById('quotationItems').addEventListener('input', function (e) {
          if (e.target.matches('.unit-price, .doc-fee')) calculateTotals();
        });

        // Auto-calc down payment ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const itemsTbody = document.getElementById('quotationItems');
        itemsTbody.addEventListener('change', e => {
          if (!e.target.matches('.product-select')) return;
          const sel = e.target;
          const row = sel.closest('tr');
          const upInput = row.querySelector('.unit-price');
          const prod = branchProducts.find(p => p._id === sel.value);
          if (!prod) return;

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå
          let down = 0;
          if (Array.isArray(prod.purchaseType) && prod.purchaseType.includes('installment')) {
            down = prod.downInstallment * prod.downInstallmentCount;
          } else {
            down = prod.downAmount;
          }

          upInput.value = down.toFixed(2);
          calculateTotals();
        });
    
        // Cancel quotation button in modal
        document.getElementById('cancelQuotation').addEventListener('click', function () {
          document.getElementById('newQuotationModal').classList.add('hidden');
        });
    
        // Print report button in modal
        document.getElementById('printReportModal').addEventListener('submit', function (e) {
          e.preventDefault();
          // Perform print action here
          alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');
          document.getElementById('printReportModal').classList.add('hidden');
        });
    
        // Display settings form submission
        document.getElementById('displaySettingsModal').addEventListener('submit', function (e) {
          e.preventDefault();
          // Perform settings save action here
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.getElementById('displaySettingsModal').classList.add('hidden');
        });

        // Add IMEI search handler
        const imeiSearch = document.getElementById('imeiSearch');
        if (imeiSearch) {
          imeiSearch.addEventListener('keydown', async e => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            const imei = e.target.value.trim();
            if (!imei) return;

            try {
              const token = localStorage.getItem('authToken');
              if (!token) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI');
                return;
              }
    
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° imei ‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
              let branchCode = window.currentBranchCode || BRANCH_CODE;
    
              if (!branchCode) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
                return;
              }
    
              console.log('üîç Searching IMEI:', imei, 'in branch:', branchCode);
    
              const res = await fetch(`/api/branch-stock/taxType?branch_code=${encodeURIComponent(branchCode)}&imei=${encodeURIComponent(imei)}`, {
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/json'
                }
              });
    
              if (res.status === 404) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
                return;
              }
    
              if (res.status === 401) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà');
                setTimeout(() => {
                  window.location.href = '/login';
                }, 2000);
                return;
              }
    
              const body = await res.json();
              if (body.success && body.data.length > 0) {
                const prod = body.data[0];
                const sel = document.querySelector('#quotationItems tr:first-child select.product-select');
                if (sel) {
                  // ‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                  if (!Array.from(sel.options).some(o => o.value === prod._id)) {
                    const opt = document.createElement('option');
                    opt.value = prod._id;
                    opt.textContent = `${prod.name} (${prod.imei})`;
                    sel.appendChild(opt);
                  }
                  sel.value = prod._id;
                  sel.dispatchEvent(new Event('change'));
                  console.log('‚úÖ Found and selected product:', prod.name);

                  // POS Notification - IMEI found
                  if (posNotificationSystem) {
                    posNotificationSystem.showToast('pos', {
                      title: '‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI',
                      message: `${prod.name} (${prod.imei}) ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß`,
                      type: 'success',
                      icon: 'üîç',
                      duration: 3000
                    });
                  }
                }
              } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å');
                console.log('‚ùå No product found for IMEI:', imei);

                // POS Notification - IMEI not found
                if (posNotificationSystem) {
                  posNotificationSystem.showToast('pos', {
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI',
                    message: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ${imei} ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤`,
                    type: 'warning',
                    icon: 'üîç‚ùå',
                    duration: 4000
                  });
    
                  posNotificationSystem.addNotification('pos', {
                    title: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI ‡πÑ‡∏°‡πà‡∏û‡∏ö',
                    message: `IMEI ${imei} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ${BRANCH_CODE}`,
                    type: 'warning',
                    icon: 'üì±',
                    metadata: {
                      searchedIMEI: imei,
                      branchCode: BRANCH_CODE,
                      timestamp: new Date().toLocaleString('th-TH')
                    }
                  });
                }
              }
            } catch (err) {
              console.error('‚ùå IMEI search error:', err);
              alert('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');

              // POS Notification - IMEI search error
              if (posNotificationSystem) {
                posNotificationSystem.showToast('pos', {
                  title: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                  message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI: ${err.message}`,
                  type: 'error',
                  icon: 'üîç‚ö†Ô∏è',
                  duration: 5000
                });
    
                posNotificationSystem.addNotification('pos', {
                  title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI',
                  message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI ${imei} ‡πÑ‡∏î‡πâ: ${err.message}`,
                  type: 'error',
                  icon: 'üö®',
                  metadata: {
                    searchedIMEI: imei,
                    error: err.message,
                    timestamp: new Date().toLocaleString('th-TH')
                  }
                });
              }
            } finally {
              e.target.value = '';
            }
          });
        }

        // Toggle additional fields for online sales
        const salesChannel = document.getElementById('salesChannel');
        const onlineFields = document.getElementById('onlineFields');

        salesChannel.addEventListener('change', function () {
          const value = salesChannel.value;

          // Show/hide online fields
          if (value === 'online' || value === 'online-deposit' || value === 'pre-order') {
            onlineFields.classList.remove('hidden');
          } else {
            onlineFields.classList.add('hidden');
          }

          // Load appropriate products based on selection
          loadProductsBasedOnChannel(value);
        });

        // Event delegation for removing rows
        document.getElementById('quotationItems').addEventListener('click', function(e) {
          if (e.target.closest('.btn-remove')) {
            e.target.closest('tr').remove();
            calculateTotals();
          }
        });
    
        // Handle missing resources
        try {
          const defaultAvatar = '/uploads/Logo2.png'; // Use existing logo as default avatar
          // Empty state SVG is inline, no need for external image

          // Fallback for avatar image
          const employeePhoto = document.getElementById('employeePhoto');
          if (employeePhoto) {
            employeePhoto.onerror = function () {
              this.src = defaultAvatar;
            };
          }

          // Fallback for empty state image
          const emptyStateImg = document.querySelector('.empty-state-container img');
          if (emptyStateImg) {
            emptyStateImg.onerror = function () {
              this.src = defaultAvatar; // Use default avatar as fallback
            };
          }
        } catch (error) {
          console.error('Resource error:', error);
        }
    
        // === PAGINATION SETUP (moved from second DOMContentLoaded) ===
        // Initialize quotation data
        await loadQuotations();
    
        // Setup pagination
        let allQuotations = [];
        let currentPage = 1;
        let pageSize = 10;

        const tbody = document.getElementById('quotationList');
        const inpPage = document.getElementById('currentPage');
        const btnPrev = document.getElementById('prevPage');
        const btnNext = document.getElementById('nextPage');
        const selPageSize = document.getElementById('pageSize');

        // Enhanced loadQuotations to support pagination
        window.loadQuotationsWithPagination = async function() {
    
          try {
            showLoading(true);
    
            const token = localStorage.getItem('authToken');
            if (!token) {
              console.warn('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
              return;
            }
            const res = await fetch('/api/quotation', {
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              }
            });
            if (res.status === 401) {
              console.error('Unauthorized: token invalid or expired');
              return;
            }
            const body = await res.json();
            if (!body.success) throw new Error(body.error);
            allQuotations = body.data;
            renderTable();
            renderPaginationControls();
          } catch (err) {
            console.error(err);
            alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
          } finally {
            showLoading(false);
          }
        };

        function renderTable() {
          tbody.innerHTML = '';
          const start = (currentPage - 1) * pageSize;
          allQuotations
            .slice(start, start + pageSize)
            .forEach(q => {
              const customerName = q.customer?.name || '‚Äî';
              const itemsArray = Array.isArray(q.items) ? q.items : [];
              const itemsHtml = itemsArray
                .map(i => {
                  if (i.product && typeof i.product === 'object' && i.product.name) {
                    return i.product.name;
                  }
                  if (typeof i.product === 'string') {
                    return i.product;
                  }
                  return '‚Äî';
                })
                .join('<br>');

              const statusClass = q.status === 'confirmed'
                ? 'badge-success'
                : q.status === 'sent'
                ? 'badge-warning'
                : 'badge-gray';

              const dateStr = new Date(q.date).toLocaleDateString('th-TH');
              let invNum = '';
              if (q.invoiceRef) {
                if (typeof q.invoiceRef === 'object' && q.invoiceRef.invoiceNumber) {
                  invNum = q.invoiceRef.invoiceNumber;
                } else {
                  invNum = q.invoiceRef;
                }
    
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ INV- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà QT-)
                if (invNum && invNum.startsWith('QT-')) {
                  // ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å QT- ‡πÄ‡∏õ‡πá‡∏ô INV-
                  invNum = invNum.replace('QT-', 'INV-');
                }
              }
    
              const invoiceLink = invNum
                ? `<a href="Invoicee?invoice=${invNum}" class="text-blue-500 hover:underline">${invNum}</a>`
                : '‚Äî';
              const net = (q.summary?.netTotal != null
                ? parseFloat(q.summary.netTotal)
                : 0
              ).toFixed(2);

              const tr = document.createElement('tr');
              tr.classList.add('hover:bg-gray-50','dark:hover:bg-gray-600');
              tr.innerHTML = `
                <td><input type="checkbox" class="rounded border-gray-300" /></td>
                <td>${q.quotationNumber}</td>
                <td><span class="badge ${statusClass}">${q.status}</span></td>
                <td>${dateStr}</td>
                <td>${invoiceLink}</td>
                <td>${customerName}</td>
                <td>${itemsHtml}</td>
                <td class="text-right">‡∏ø${net}</td>
                <td class="text-right">‡∏ø${net}</td>
                <td>
                  <div class="flex space-x-2">
                    <a href="#"
                       data-id="${q.quotationNumber}"
                       class="download-pdf-link text-blue-500 hover:text-blue-700" 
                       data-url="/api/quotation/${q.quotationNumber}/pdf">
                      <i class="bi bi-download"></i>
                    </a>
                    <button class="btn-delete-quotation text-red-500 hover:text-red-700" data-id="${q.quotationNumber}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              `;
              tbody.appendChild(tr);
            });
        }

        function renderPaginationControls() {
          const total = Math.ceil(allQuotations.length / pageSize) || 1;
          inpPage.value = currentPage;
          btnPrev.disabled = currentPage <= 1;
          btnNext.disabled = currentPage >= total;
        }

        // Pagination event listeners
        if (btnPrev) {
          btnPrev.addEventListener('click', () => {
            if (currentPage > 1) currentPage--;
            renderTable(); renderPaginationControls();
          });
        }
        if (btnNext) {
          btnNext.addEventListener('click', () => {
            const total = Math.ceil(allQuotations.length / pageSize);
            if (currentPage < total) currentPage++;
            renderTable(); renderPaginationControls();
          });
        }
        if (inpPage) {
          inpPage.addEventListener('change', () => {
            const total = Math.ceil(allQuotations.length / pageSize);
            let p = parseInt(inpPage.value) || 1;
            currentPage = Math.max(1, Math.min(p, total));
            renderTable(); renderPaginationControls();
          });
        }
        if (selPageSize) {
          selPageSize.addEventListener('change', () => {
            pageSize = parseInt(selPageSize.value);
            currentPage = 1;
            renderTable(); renderPaginationControls();
          });
        }

      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        showLoading(false);
      }
    });

    async function loadQuotations() {
    try {
      const token = localStorage.getItem('authToken');
      if (!token) {
        console.warn('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
        return;
      }
    
      console.log('üîç Loading quotations...');
    
        const res  = await fetch('/api/quotation', {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
    
      if (res.status === 401) {
        console.error('‚ùå Unauthorized: token invalid or expired');
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
        return;
      }
    
      if (res.status === 404) {
        console.error('‚ùå Quotation API not found (404)');
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
        return;
      }
    
      const body = await res.json();
      if (!body.success) throw new Error(body.error || 'Fetch failed');

      console.log('‚úÖ Quotations loaded:', body.data.length, 'items');

      // POS Notification - Data loaded successfully
      if (posNotificationSystem && body.data.length > 0) {
        posNotificationSystem.addNotification('pos', {
          title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
          message: `‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${body.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`,
          type: 'info',
          icon: 'üìä',
          metadata: {
            totalQuotations: body.data.length,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }

      const tbody = document.getElementById('quotationList');
      tbody.innerHTML = '';

      if (body.data.length === 0) {
        // ‡πÅ‡∏™‡∏î‡∏á empty state
        const emptyState = document.querySelector('.empty-state-container');
        if (emptyState) {
          emptyState.style.display = 'block';
        }

        // POS Notification - No data found
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
            message: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢',
            type: 'info',
            icon: 'üìã',
            duration: 4000
          });
        }
        return;
      } else {
        // ‡∏ã‡πà‡∏≠‡∏ô empty state
        const emptyState = document.querySelector('.empty-state-container');
        if (emptyState) {
          emptyState.style.display = 'none';
        }
      }

      body.data.forEach(q => {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ customer ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        const customerName = q.customer?.name || '‚Äî';

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ items ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô array ‡πÄ‡∏™‡∏°‡∏≠
        const itemsArray = Array.isArray(q.items) ? q.items : [];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á .name
        const itemsHtml = itemsArray
          .map(i => {
            if (i.product && typeof i.product === 'object' && i.product.name) {
              return i.product.name;
            }
            if (typeof i.product === 'string') {
              return i.product;
            }
            return '‚Äî';
          })
          .join('<br>');

        const statusClass = q.status === 'confirmed'
          ? 'badge-success'
          : q.status === 'sent'
          ? 'badge-warning'
          : 'badge-gray';

        const dateStr = new Date(q.date).toLocaleDateString('th-TH');
        // Create invoice link if available
        let invNum = '';
        if (q.invoiceRef) {
          // ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ .populate('invoiceRef','invoiceNumber')'
          if (typeof q.invoiceRef === 'object' && q.invoiceRef.invoiceNumber) {
            invNum = q.invoiceRef.invoiceNumber;
          } else {
            // fallback ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô string id ‡πÄ‡∏î‡∏¥‡∏°
            invNum = q.invoiceRef;
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ INV- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà QT-)
          if (invNum && invNum.startsWith('QT-')) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å QT- ‡πÄ‡∏õ‡πá‡∏ô INV-
            invNum = invNum.replace('QT-', 'INV-');
          }
        }
    
        const invoiceLink = invNum
          ? `<a href="Invoicee?invoice=${invNum}" class="text-blue-500 hover:underline">${invNum}</a>`
          : '‚Äî';
        const net = (q.summary?.netTotal != null
          ? parseFloat(q.summary.netTotal)
          : 0
        ).toFixed(2);

        const tr = document.createElement('tr');
        tr.classList.add('hover:bg-gray-50','dark:hover:bg-gray-600');
        tr.innerHTML = `
          <td><input type="checkbox" class="rounded border-gray-300" /></td>
          <td>${q.quotationNumber}</td>
          <td><span class="badge ${statusClass}">${q.status}</span></td>
          <td>${dateStr}</td>
          <td>${invoiceLink}</td>
          <td>${customerName}</td>
          <td>${itemsHtml}</td>
          <td class="text-right">‡∏ø${net}</td>
          <td class="text-right">‡∏ø${net}</td>
          <td>
            <div class="flex space-x-2">
              <!-- ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF -->
              <a href="#"
                 data-id="${q.quotationNumber}"
                 class="download-pdf-link text-blue-500 hover:text-blue-700"
                 data-url="/api/quotation/${q.quotationNumber}/pdf">
                <i class="bi bi-download"></i>
              </a>
              <!-- ‡∏•‡∏ö -->
              <button class="btn-delete-quotation text-red-500 hover:text-red-700" data-id="${q.quotationNumber}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error('‚ùå loadQuotations error:', err);
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ: ' + err.message);
    
      // POS Notification - Load error
      if (posNotificationSystem) {
        posNotificationSystem.showToast('pos', {
          title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ: ${err.message}`,
          type: 'error',
          icon: 'üìã‚ùå',
          duration: 6000
        });
    
        posNotificationSystem.addNotification('pos', {
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          message: `‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`,
          type: 'error',
          icon: 'üö®',
          actions: [
            {
              label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
              action: 'primary',
              callback: () => {
                console.log('üîÑ Retry loading quotations');
                loadQuotations();
              }
            },
            {
              label: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤',
              action: 'secondary',
              callback: () => {
                window.location.reload();
              }
            }
          ],
          metadata: {
            error: err.message,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    
      // ‡πÅ‡∏™‡∏î‡∏á empty state ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      const emptyState = document.querySelector('.empty-state-container');
      if (emptyState) {
        emptyState.style.display = 'block';
      }
    }
  }

  // Removed duplicate DOMContentLoaded handler - functionality merged into main handler above

  // ‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
  document.addEventListener('click', async e => {
    const btn = e.target.closest('.btn-delete-quotation');
    if (!btn) return;
    const num = btn.dataset.id;
    if (!confirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num}?`)) return;
    
    
    try {
      showLoading(true);
      const res = await fetch(`/api/quotation/${num}`, { method: 'DELETE' });
      const body = await res.json();
      if (body.success) {
        btn.closest('tr').remove();
        alert(`‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);

        // POS Notification - Quotation deleted successfully
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
            message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`,
            type: 'warning',
            icon: 'üóëÔ∏è',
            duration: 4000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
            message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${num} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`,
            type: 'warning',
            icon: 'üóÇÔ∏è',
            metadata: {
              deletedQuotation: num,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      } else {
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + body.error);

        // POS Notification - Delete failed
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num} ‡πÑ‡∏î‡πâ: ${body.error}`,
            type: 'error',
            icon: '‚ùå',
            duration: 6000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ',
            message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num}: ${body.error}`,
            type: 'error',
            icon: 'üö´',
            metadata: {
              quotationNumber: num,
              error: body.error,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }
    } catch (err) {
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö');

      // POS Notification - Delete error
      if (posNotificationSystem) {
        posNotificationSystem.showToast('pos', {
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
          message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤: ${err.message}`,
          type: 'error',
          icon: '‚ö†Ô∏è',
          duration: 6000
        });
    
        posNotificationSystem.addNotification('pos', {
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
          message: `‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`,
          type: 'error',
          icon: 'üî•',
          actions: [
            {
              label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
              action: 'primary',
              callback: () => {
                console.log('üîÑ Retry deleting quotation');
                // Refresh the page to retry
                window.location.reload();
              }
            }
          ],
          metadata: {
            error: err.message,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    } finally {
      showLoading(false);
    }
  });

  // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏û‡∏£‡πâ‡∏≠‡∏° token
  document.addEventListener('click', async e => {
    const link = e.target.closest('.download-pdf-link');
    if (!link) return;
    e.preventDefault();
    const num = link.dataset.id;
    const token = localStorage.getItem('authToken');
    if (!token) {
      return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
    }
    
    
    try {
      showLoading(true);
      const res = await fetch(`/api/quotation/${num}/pdf`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/pdf'
        }
      });
      if (res.status === 401) {
        const err = await res.json();
        return alert(`Unauthorized: ${err.error||err.message||'No credentials'}`);
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${num}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // POS Notification - PDF download success
      if (posNotificationSystem) {
        posNotificationSystem.showToast('pos', {
          title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          message: `‡πÑ‡∏ü‡∏•‡πå ${num}.pdf ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'success',
          icon: 'üìÑ',
          duration: 3000
        });
    
        posNotificationSystem.addNotification('pos', {
          title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF',
          message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num} ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô PDF ‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'info',
          icon: 'üì•',
          metadata: {
            quotationNumber: num,
            filename: `${num}.pdf`,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    } catch (err) {
      console.error('PDF download error:', err);
      alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);

      // POS Notification - PDF download error
      if (posNotificationSystem) {
        posNotificationSystem.showToast('pos', {
          title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${num} ‡πÑ‡∏î‡πâ`,
          type: 'error',
          icon: 'üìÑ‚ùå',
          duration: 6000
        });
    
        posNotificationSystem.addNotification('pos', {
          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF',
          message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${num}.pdf ‡πÑ‡∏î‡πâ: ${err.message}`,
          type: 'error',
          icon: 'üö®',
          actions: [
            {
              label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
              action: 'primary',
              callback: () => {
                console.log('üîÑ Retry PDF download');
                const retryBtn = document.querySelector(`[data-id="${num}"]`);
                if (retryBtn) retryBtn.click();
              }
            }
          ],
          metadata: {
            quotationNumber: num,
            error: err.message,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    } finally {
      showLoading(false);
    }
  });

</script>

  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° submit handler ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <script>
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    document.getElementById('quotationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const quotationNumber = document.getElementById('quotationNumber').value;
      const date = document.getElementById('quotationDate').value;
      const salesperson = loggedInUser.id;

      const customer = {
        name: document.getElementById('customerName').value.trim(),
        address: document.getElementById('customerAddress').value.trim(),
        taxId: document.getElementById('customerTaxId').value.trim()
      };
      if (!customer.name || !customer.taxId) {
        return alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ)');
      }

      const items = Array.from(document.querySelectorAll('#quotationItems tr')).map(row => ({
        product: row.querySelector('select.product-select').value,
        imei: row.querySelector('select.product-select').selectedOptions[0]?.text.match(/\((.*)\)/)?.[1] || '',
        unitPrice: parseFloat(row.querySelector('input.unit-price').value) || 0,
        docFee: parseFloat(row.querySelector('input.doc-fee').value) || 0,
        totalPrice: parseFloat(row.querySelector('input.total-price').value) || 0
      }));

      const summary = {
        subtotal: parseFloat(document.getElementById('summarySubtotal').textContent),
        shipping: parseFloat(document.getElementById('summaryShipping').textContent),
        discount: parseFloat(document.getElementById('summaryDiscount').textContent),
        beforeTax: parseFloat(document.getElementById('summaryBeforeTax').textContent),
        tax: parseFloat(document.getElementById('summaryTax').textContent),
        netTotal: parseFloat(document.getElementById('summaryBeforeTax').textContent)
                  + parseFloat(document.getElementById('summaryTax').textContent)
      };

      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤');
          return;
        }
    
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å URL parameter
        let branchCode = window.currentBranchCode || BRANCH_CODE;
    
        if (!branchCode) {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
          return;
        }
    
        console.log('üíæ Saving quotation for branch:', branchCode);
    
        const res = await fetch('/api/quotation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ quotationNumber, date, branchCode, salesperson, customer, items, summary })
        });
    
        if (res.status === 401) {
          alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
          return;
        }
    
        const body = await res.json();
        if (body.success) {
          const { quotationNumber: qnum, invoiceNumber: inum } = body.data;
          alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤: ${qnum}\n‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ: ${inum}`);
          document.getElementById('newQuotationModal').classList.add('hidden');
          loadQuotations();  // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô invoiceRef ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          console.log('‚úÖ Quotation saved successfully:', qnum);

          // Send to Firebase ‡πÅ‡∏•‡∏∞ emit Socket event
          if (typeof sendQuotationToFirebase === 'function') {
            sendQuotationToFirebase({
              quotationNumber: qnum,
              invoiceNumber: inum,
              customer: customer,
              items: items,
              summary: summary,
              action: 'created'
            });
          }

          if (typeof emitQuotationUpdate === 'function') {
            emitQuotationUpdate({
              quotationNumber: qnum,
              invoiceNumber: inum,
              customer: customer.name,
              action: 'created'
            });
          }

          if (typeof sendNotificationToFirebase === 'function') {
            sendNotificationToFirebase({
              type: 'success',
              message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${qnum} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
              title: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà',
              quotationNumber: qnum,
              invoiceNumber: inum
            });
          }

          // POS Notification - Quotation created successfully
          if (posNotificationSystem) {
            posNotificationSystem.showToast('pos', {
              title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${qnum} | ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ${inum}`,
              type: 'success',
              icon: 'üìã',
              duration: 5000
            });
    
            posNotificationSystem.addNotification('pos', {
              title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà',
              message: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${qnum} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customer.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
              type: 'success',
              icon: '‚úÖ',
              actions: [
                {
                  label: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF',
                  action: 'primary',
                  callback: () => {
                    // Trigger PDF download
                    const downloadBtn = document.querySelector(`[data-id="${qnum}"]`);
                    if (downloadBtn) downloadBtn.click();
                  }
                },
                {
                  label: '‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
                  action: 'secondary',
                  callback: () => {
                    window.open(`Invoicee?invoice=${inum}`, '_blank');
                  }
                }
              ],
              metadata: {
                quotationNumber: qnum,
                invoiceNumber: inum,
                customerName: customer.name,
                netTotal: summary.netTotal,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          }
        } else {
          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + body.error);
          console.error('‚ùå Save failed:', body.error);

          // POS Notification - Quotation creation failed
          if (posNotificationSystem) {
            posNotificationSystem.showToast('pos', {
              title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${body.error}`,
              type: 'error',
              icon: '‚ùå',
              duration: 6000
            });
    
            posNotificationSystem.addNotification('pos', {
              title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
              message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ: ${body.error}`,
              type: 'error',
              icon: 'üö®',
              metadata: {
                error: body.error,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          }
        }
      } catch (err) {
        console.error('‚ùå Quotation save error:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);

        // POS Notification - Save error
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ: ${err.message}`,
            type: 'error',
            icon: '‚ö†Ô∏è',
            duration: 8000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            message: `‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`,
            type: 'error',
            icon: 'üî•',
            actions: [
              {
                label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                action: 'primary',
                callback: () => {
                  console.log('üîÑ Retry saving quotation');
                  document.getElementById('quotationForm').dispatchEvent(new Event('submit'));
                }
              }
            ],
            metadata: {
              error: err.message,
              stack: err.stack,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }
    });
  </script>

  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showLoading ‡πÅ‡∏•‡∏∞ loadBranchInfo -->
  <script>
    // Loading state function (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å frontstore_index.html)
    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        if (!token) {
          console.warn('‚ùå No auth token for loading branch info');
          document.getElementById('branchInfo').textContent = '‡∏™‡∏≤‡∏Ç‡∏≤: (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö)';
          return;
        }
    
        console.log('üîç Loading branch info for BRANCH_CODE:', BRANCH_CODE);
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_index.html)
        const res = await fetch('/api/branch', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        console.log('üì° Branch API response status:', res.status);
    
        const brJson = await res.json();
        console.log('üìã Branch API response:', brJson);
    
        if (!res.ok || !brJson.success) {
          throw new Error(brJson.error || 'Cannot load branches');
        }
    
        const BRANCHES = brJson.data;
        console.log('üìã Available branches:', BRANCHES.map(b => `${b.name} (${b.branch_code})`));
        console.log('üìã Available branch codes:', BRANCHES.map(b => b.branch_code));
    
        // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
        let branch = BRANCHES.find(b => b.branch_code === BRANCH_CODE);
    
        if (!branch) {
          console.warn('‚ö†Ô∏è Direct branch code match not found, trying alternative matching...');
    
          // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (case-insensitive)
          branch = BRANCHES.find(b =>
            b.name.toLowerCase().includes(BRANCH_CODE.toLowerCase()) ||
            BRANCH_CODE.toLowerCase().includes(b.name.toLowerCase())
          );
    
          if (!branch) {
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ" ‡∏´‡∏£‡∏∑‡∏≠ "pattani"
            branch = BRANCHES.find(b =>
              b.name.toLowerCase().includes('‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ') ||
              b.name.toLowerCase().includes('pattani') ||
              b.address.toLowerCase().includes('‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ') ||
              b.address.toLowerCase().includes('pattani')
            );
          }
    
          if (branch) {
            console.log('‚úÖ Found alternative branch match:', branch.name, '(', branch.branch_code, ')');
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó BRANCH_CODE ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            BRANCH_CODE = branch.branch_code;
            window.currentBranchCode = BRANCH_CODE;
            window.BRANCH_CODE = BRANCH_CODE;
            console.log('üîÑ Updated BRANCH_CODE to:', BRANCH_CODE);
          }
        }
    
        if (branch) {
          console.log('‚úÖ Found matching branch:', branch.name);
          document.getElementById('branchInfo').textContent =
            `${branch.name} ‚Äî ${branch.address}`;
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
          document.title = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ${branch.name}`;
          document.getElementById('pageTitle').textContent = `‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ - ${branch.name}`;
          return;
        } else {
          console.error('‚ùå Branch not found:', BRANCH_CODE);
          console.error('‚ùå Available branch codes:', BRANCHES.map(b => b.branch_code));
          throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${BRANCH_CODE}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
        }
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent =
          '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        document.getElementById('pageTitle').textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
    
        // ‡πÅ‡∏™‡∏î‡∏á error ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö
        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ: ${err.message}`);
      }
    }
    
    // Toast Notification System
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toast-container');
      if (!container) {
        console.warn('Toast container not found');
        return;
      }
    
      const toast = document.createElement('div');
      toast.className = `bg-white dark:bg-gray-800 border-l-4 rounded-lg shadow-lg p-4 transform translate-x-full transition-transform duration-300 max-w-sm`;
    
      // Set border color and background based on type
      let borderColor = '';
      let icon = '';
      switch (type) {
        case 'success':
          borderColor = 'border-green-500';
          icon = '<i class="bi bi-check-circle-fill text-green-600"></i>';
          break;
        case 'error':
          borderColor = 'border-red-500';
          icon = '<i class="bi bi-x-circle-fill text-red-600"></i>';
          break;
        case 'info':
          borderColor = 'border-blue-500';
          icon = '<i class="bi bi-info-circle-fill text-blue-600"></i>';
          break;
        default:
          borderColor = 'border-gray-500';
          icon = '<i class="bi bi-info-circle text-gray-600"></i>';
      }
    
      toast.classList.add(borderColor);
    
      toast.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0 mt-0.5">
            ${icon}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${message}</p>
          </div>
          <button type="button" class="flex-shrink-0 ml-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="this.parentNode.parentNode.remove()">
            <i class="bi bi-x text-lg"></i>
          </button>
        </div>
      `;
    
      container.appendChild(toast);
    
      // Show toast with animation
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
        toast.classList.add('translate-x-0');
      }, 100);
    
      // Auto remove after duration
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // =================== POS NOTIFICATION GLOBAL FUNCTIONS ===================
    
    // Global functions for external use
    window.showPOSToast = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.showToast('pos', {
          title,
          message,
          type,
          icon: options.icon || 'üìã',
          duration: options.duration || 4000,
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
        showToast(`${title}: ${message}`, type);
      }
    };

    window.addPOSNotification = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.addNotification('pos', {
          title,
          message,
          type,
          icon: options.icon || 'üìã',
          actions: options.actions || [],
          metadata: options.metadata || {},
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
      }
    };

    // =================== QUOTATION DEBUG FUNCTIONS ===================
    
    // Global debug helper for quotation system
    window.QuotationDebug = {
      connectionStatus: () => {
        if (typeof getConnectionStatus === 'function') {
          return getConnectionStatus();
        } else {
          return { error: 'Connection functions not available' };
        }
      },
      firebaseTest: () => {
        console.log('üß™ Testing Firebase integration for quotation system...');
    
        // Test notification
        if (typeof sendNotificationToFirebase === 'function') {
          sendNotificationToFirebase({
            type: 'success',
            message: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase Notification ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            title: 'Test Firebase Quotation'
          });
        }
    
        // Test quotation data
        if (typeof sendQuotationToFirebase === 'function') {
          sendQuotationToFirebase({
            quotationNumber: 'TEST-Q' + Date.now(),
            customer: { name: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö' },
            action: 'test'
          });
        }
    
        // Test activity
        if (typeof updateActivity === 'function') {
          updateActivity('firebase_test_quotation');
        }
    
        console.log('Firebase quotation tests completed');
      },
      socketTest: () => {
        console.log('üß™ Testing Socket.IO for quotation system...');
    
        if (typeof emitQuotationUpdate === 'function') {
          emitQuotationUpdate({
            quotationNumber: 'TEST-Q' + Date.now(),
            action: 'test',
            message: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Socket.IO'
          });
        }
    
        if (typeof emitInvoiceUpdate === 'function') {
          emitInvoiceUpdate({
            invoiceNumber: 'TEST-I' + Date.now(),
            action: 'test',
            message: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Invoice Update'
          });
        }
    
        console.log('Socket.IO quotation tests completed');
      },
      testConnections: () => {
        const status = QuotationDebug.connectionStatus();
        console.log('üîó Connection Status:', status);
    
        showToast('Firebase: ' + (status.firebase ? '‚úÖ' : '‚ùå'), status.firebase ? 'success' : 'error');
        setTimeout(() => {
          showToast('Socket.IO: ' + (status.socket ? '‚úÖ' : '‚ùå'), status.socket ? 'success' : 'error');
        }, 1000);
    
        return status;
      },
      testNotifications: () => {
        console.log('üß™ Testing quotation notifications...');
    
        const notifications = [
          { title: 'üìã ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', message: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', type: 'success' },
          { title: '‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', message: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', type: 'success' },
          { title: 'üßæ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ', message: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', type: 'info' },
          { title: '‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', message: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', type: 'error' }
        ];
    
        notifications.forEach((notif, index) => {
          setTimeout(() => {
            showToast(notif.message, notif.type);
    
            if (posNotificationSystem) {
              posNotificationSystem.addNotification('pos', {
                title: notif.title,
                message: notif.message,
                type: notif.type,
                icon: 'üìã',
                timestamp: new Date().toISOString(),
                read: false
              });
            }
          }, index * 1000);
        });
    
        console.log('‚úÖ Quotation notification tests completed');
      },
      branchCode: () => BRANCH_CODE,
      session: () => {
        if (typeof currentSession !== 'undefined') {
          return currentSession;
        } else {
          return { error: 'Session not available' };
        }
      },
      version: '2.0.0-quotation'
    };

    // Test functions for debugging
    window.testPOSNotifications = function() {
      console.log('üß™ Testing POS notifications...');
    
      showPOSToast('‡∏ó‡∏î‡∏™‡∏≠‡∏ö Toast', '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 'info');
    
      addPOSNotification('‡∏ó‡∏î‡∏™‡∏≠‡∏ö Notification', '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 'success', {
        icon: 'üß™',
        actions: [
          {
            label: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Action',
            action: 'primary',
            callback: () => console.log('‚úÖ Test action clicked!')
          }
        ]
      });
    
      console.log('‚úÖ POS notifications test completed');
    };

    // Initialize toast system when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ Toast notification system initialized');
    
      // Use POS notification instead of old toast system
      setTimeout(() => {
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
            message: '‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
            type: 'success',
            icon: 'üéâ',
            duration: 3000
          });
        } else {
          showToast('‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success', 3000);
        }
      }, 1000);
    });

// Old loading system removed - using new Lottie loading from head section
  </script>
</body>
</html>
