<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>ใบสำคัญรับเงิน</title>

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- LoadingSystem v2.0.0 - Inline Implementation -->
  <style>
    /* LoadingSystem v2.0.0 - Inline CSS */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .loading-overlay.active {
      opacity: 1;
    }

    .loading-overlay.dark {
      background: rgba(0, 0, 0, 0.9);
    }

    .loading-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 320px;
      min-width: 280px;
      position: relative;
      overflow: hidden;
    }

    .loading-container.dark {
      background: #1f2937;
      color: white;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-dots {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin: 0 auto 1rem;
    }

    .loading-dots .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffffff;
      animation: dot-bounce 1.4s infinite both;
    }

    .loading-dots .dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots .dot:nth-child(2) { animation-delay: -0.16s; }

    .loading-pulse {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      margin: 0 auto 1rem;
      animation: pulse 2s infinite;
    }

    .loading-progress {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
      position: relative;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
      position: relative;
    }

    .loading-progress-bar.auto {
      width: 0%;
      animation: auto-progress 3s ease-in-out infinite;
    }

    .loading-message {
      font-size: 1rem;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .loading-submessage {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.3;
    }

    .loading-spinner.success {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    .loading-spinner.warning {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    .loading-spinner.error {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes dot-bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
    }

    @keyframes auto-progress {
      0% { width: 0%; }
      70% { width: 90%; }
      100% { width: 100%; }
    }

    @media (max-width: 640px) {
      .loading-container {
        margin: 1rem;
        padding: 1.5rem;
        min-width: auto;
      }
      
      .loading-message {
        font-size: 0.9rem;
      }
      
      .loading-submessage {
        font-size: 0.8rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .loading-spinner {
        animation: none;
      }
      
      .loading-dots .dot {
        animation: none;
      }
      
      .loading-pulse {
        animation: none;
      }
      
      .loading-progress-bar.auto {
        animation: none;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .loading-overlay {
        background: rgba(0, 0, 0, 0.9);
      }
      
      .loading-container {
        background: #1f2937;
        color: white;
      }
    }

    .dark .loading-overlay {
      background: rgba(0, 0, 0, 0.9);
    }

    .dark .loading-container {
      background: #1f2937;
      color: white;
    }

    [data-theme="dark"] .loading-overlay {
      background: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .loading-container {
      background: #1f2937;
      color: white;
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline JavaScript
    window.LoadingSystem = (function() {
      let activeLoaders = new Map();
      let loaderCounter = 0;

      // Detect dark mode
      function isDarkMode() {
        return document.documentElement.classList.contains('dark') ||
               document.documentElement.getAttribute('data-theme') === 'dark' ||
               (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      }

      // Create loading overlay
      function createOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = `loading-overlay ${isDarkMode() ? 'dark' : ''}`;
    
        const container = document.createElement('div');
        container.className = `loading-container ${isDarkMode() ? 'dark' : ''}`;
    
        // Create spinner based on type
        let spinnerHTML = '';
        switch (options.type) {
          case 'dots':
            spinnerHTML = '<div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            break;
          case 'pulse':
            spinnerHTML = '<div class="loading-pulse"></div>';
            break;
          default:
            spinnerHTML = `<div class="loading-spinner ${options.variant || ''}"></div>`;
        }
    
        container.innerHTML = spinnerHTML;
    
        // Add message
        if (options.message) {
          const messageEl = document.createElement('div');
          messageEl.className = 'loading-message';
          messageEl.textContent = options.message;
          container.appendChild(messageEl);
        }
    
        // Add submessage
        if (options.submessage) {
          const submessageEl = document.createElement('div');
          submessageEl.className = 'loading-submessage';
          submessageEl.textContent = options.submessage;
          container.appendChild(submessageEl);
        }
    
        // Add progress bar
        if (options.progress !== undefined || options.autoProgress) {
          const progressContainer = document.createElement('div');
          progressContainer.className = 'loading-progress';
    
          const progressBar = document.createElement('div');
          progressBar.className = `loading-progress-bar ${options.autoProgress ? 'auto' : ''}`;
    
          if (options.progress !== undefined) {
            progressBar.style.width = `${Math.max(0, Math.min(100, options.progress))}%`;
          }
    
          progressContainer.appendChild(progressBar);
          container.appendChild(progressContainer);
        }
    
        overlay.appendChild(container);
        return overlay;
      }

      // Public API
      return {
        show: function(options = {}) {
          try {
            const loaderId = `loader-${++loaderCounter}-${Date.now()}`;
    
            // Default options
            const defaultOptions = {
              message: 'กำลังโหลด...',
              type: 'spinner',
              variant: '',
              timeout: 30000,
              autoProgress: false
            };
    
            const config = { ...defaultOptions, ...options };
    
            // Create overlay
            const overlay = createOverlay(config);
            overlay.setAttribute('data-loader-id', loaderId);
    
            // Add to DOM
            document.body.appendChild(overlay);
    
            // Force reflow and show
            overlay.offsetHeight;
            overlay.classList.add('active');
    
            // Store reference
            activeLoaders.set(loaderId, {
              overlay: overlay,
              options: config,
              startTime: Date.now()
            });
    
            // Auto-hide after timeout
            if (config.timeout > 0) {
              setTimeout(() => {
                this.hide(loaderId);
              }, config.timeout);
            }
    
            return loaderId;
          } catch (error) {
            console.error('LoadingSystem.show error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const overlay = loader.overlay;
            if (overlay && overlay.parentNode) {
              overlay.classList.remove('active');
              setTimeout(() => {
                if (overlay.parentNode) {
                  overlay.parentNode.removeChild(overlay);
                }
              }, 300);
            }
    
            activeLoaders.delete(loaderId);
          } catch (error) {
            console.error('LoadingSystem.hide error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(id => this.hide(id));
          } catch (error) {
            console.error('LoadingSystem.hideAll error:', error);
          }
        },

        updateMessage: function(loaderId, message, submessage) {
          try {
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const overlay = loader.overlay;
            const messageEl = overlay.querySelector('.loading-message');
            const submessageEl = overlay.querySelector('.loading-submessage');
    
            if (messageEl && message) {
              messageEl.textContent = message;
            }
    
            if (submessageEl && submessage) {
              submessageEl.textContent = submessage;
            } else if (submessage && !submessageEl) {
              const newSubmessage = document.createElement('div');
              newSubmessage.className = 'loading-submessage';
              newSubmessage.textContent = submessage;
              overlay.querySelector('.loading-container').appendChild(newSubmessage);
            }
          } catch (error) {
            console.error('LoadingSystem.updateMessage error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          try {
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const progressBar = loader.overlay.querySelector('.loading-progress-bar');
            if (progressBar) {
              progressBar.classList.remove('auto');
              progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
            }
          } catch (error) {
            console.error('LoadingSystem.updateProgress error:', error);
          }
        },

        completeProgress: function(loaderId, hideAfter = 1000) {
          try {
            this.updateProgress(loaderId, 100);
            if (hideAfter > 0) {
              setTimeout(() => this.hide(loaderId), hideAfter);
            }
          } catch (error) {
            console.error('LoadingSystem.completeProgress error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveLoaders: function() {
          return Array.from(activeLoaders.keys());
        }
      };
    })();

    // Backward compatibility
    window.showLoading = function(show = true, message = 'กำลังโหลด...') {
      if (show) {
        return window.LoadingSystem.show({ message });
      } else {
        window.LoadingSystem.hideAll();
      }
    };

    console.log('✅ LoadingSystem v2.0.0 initialized successfully');
  </script>

  <script src="../js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <!-- Security & Audit Enhancement -->
  <script src="../js/security-manager.js"></script>
  <script src="../js/audit-logger.js"></script>
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- (1) โหลด Tailwind CSS CDN ก่อน - สำหรับ Development เท่านั้น -->
  <!-- TODO: ใน Production ควรใช้ Tailwind CLI หรือ PostCSS plugin แทน -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js for better interactions -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>

  <!-- Animation library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- (2) กำหนดค่า Tailwind และ DaisyUI -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
          },
          boxShadow: {
            'card': '0 4px 20px -2px rgba(0,0,0,0.1)',
          }
        },
      },
      daisyui: {
        themes: [
          {
            light: {
              primary: '#0ea5e9',
              'primary-focus': '#0284c7',
              'primary-content': '#ffffff',
              secondary: '#f3f4f6',
              accent: '#10b981',
              neutral: '#374151',
              'base-100': '#ffffff',
              'base-200': '#f9fafb',
              'base-300': '#d1d5db',
              info: '#3abff8',
              success: '#36d399',
              warning: '#fbbd23',
              error: '#f87272',
            },
          },
          'dark',
          'corporate'
        ],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />

  <!-- Firebase v9 SDKs -->
  <script type="module">
    // Import Firebase v9 SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      off, 
      serverTimestamp, 
      onDisconnect, 
      remove 
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase Configuration - อัพเดทให้ตรงกับระบบหลัก
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Make Firebase functions globally available
    window.Firebase = {
      app,
      database,
      ref,
      set,
      get,
      push,
      onValue,
      off,
      serverTimestamp,
      onDisconnect,
      remove
    };

    console.log('🔥 Firebase initialized successfully for receipt voucher system');
  </script>

  <!-- Enhanced Firebase Realtime Database + Socket.IO Integration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== FIREBASE REALTIME DATABASE + SOCKET.IO INTEGRATION ====================
    
    // Enhanced Socket.IO Configuration - ใช้ Global Socket
    let receiptVoucherSocket;
    let socketConnected = false;
    let firebaseConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;
    let onlineUsers = 0;

    // Make receiptVoucherSocket globally accessible
    window.receiptVoucherSocket = null;

    // Current session data
    const currentSession = {
      branchCode: '',
      sessionId: '',
      staffId: localStorage.getItem('userId') || 'anonymous',
      staffName: localStorage.getItem('userName') || 'Unknown',
      timestamp: Date.now(),
      page: 'receipt-voucher'
    };

    // Firebase References
    let firebaseRefs = {};

    // Initialize Enhanced Socket.IO
    function initializeEnhancedSocket() {
      if (typeof io === 'function') {
        socket = io({
          timeout: 10000,
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          randomizationFactor: 0.5
        });

        // Connection Events
        receiptVoucherSocket.on('connect', () => {
          console.log('🔗 Socket.IO connected for receipt voucher:', receiptVoucherSocket.id);
          socketConnected = true;
          reconnectAttempts = 0;

          // Join receipt voucher specific rooms
          receiptVoucherSocket.emit('join_branch', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher',
            staffId: currentSession.staffId,
            staffName: currentSession.staffName,
            timestamp: new Date().toISOString()
          });

          receiptVoucherSocket.emit('join_notification_room', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher'
          });

          // Start heartbeat
          startHeartbeat();
        });

        receiptVoucherSocket.on('disconnect', (reason) => {
          console.log('❌ Socket.IO disconnected:', reason);
          socketConnected = false;
          stopHeartbeat();
    
          if (reason === 'io server disconnect') {
            receiptVoucherSocket.connect();
          }
        });

        // Enhanced Event Handlers for Receipt Voucher System
        receiptVoucherSocket.on('receipt_voucher_created', (data) => {
          console.log('💰 Receipt voucher created:', data);
          console.log(`💰 สร้างใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`);
    
          // Integration with Alpine.js
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(`💰 สร้างใบสำคัญรับเงิน ${data.documentNumber || 'ใหม่'} สำเร็จ`, 'success');
    
            // Reload receipts data
            if (typeof alpineApp.loadReceipts === 'function') {
              alpineApp.loadReceipts();
            }
    
            // Update dashboard stats
            if (typeof alpineApp.updateDashboardStats === 'function') {
              alpineApp.updateDashboardStats();
            }
          }

          // Send to Firebase
          sendReceiptVoucherToFirebase(data);
        });

        receiptVoucherSocket.on('receipt_voucher_updated', (data) => {
          console.log('📝 Receipt voucher updated:', data);
          console.log(`📝 อัพเดทใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`📝 อัพเดทใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`, 'info');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_approved', (data) => {
          console.log('✅ Receipt voucher approved:', data);
          console.log(`✅ ใบสำคัญรับเงิน ${data.documentNumber || ''} ได้รับการอนุมัติ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`✅ ใบสำคัญรับเงิน ${data.documentNumber || ''} ได้รับการอนุมัติ`, 'success');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_cancelled', (data) => {
          console.log('❌ Receipt voucher cancelled:', data);
          console.log(`❌ ใบสำคัญรับเงิน ${data.documentNumber || ''} ถูกยกเลิก`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`❌ ใบสำคัญรับเงิน ${data.documentNumber || ''} ถูกยกเลิก`, 'warning');
            alpineApp.loadReceipts?.();
          }
        });

        // Auto Creation Events
        receiptVoucherSocket.on('auto_creation_started', (data) => {
          console.log('🚀 Auto creation started:', data);
          console.log(`🚀 เริ่มสร้างใบสำคัญรับเงินอัตโนมัติ ${data.total || 0} รายการ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showAutoCreateToast = true;
            alpineApp.autoCreateMessage = `เริ่มสร้างอัตโนมัติ ${data.total || 0} รายการ`;
            alpineApp.autoCreateProgress = 0;
          }
        });

        receiptVoucherSocket.on('auto_creation_progress', (data) => {
          console.log('⚡ Auto creation progress:', data);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            // Update progress modal if open
            if (alpineApp.showAutoProgressModal) {
              alpineApp.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || 'กำลังประมวลผล...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            // Update toast if showing
            if (alpineApp.showAutoCreateToast) {
              alpineApp.autoCreateMessage = `ประมวลผล ${data.processed || 0}/${data.total || 0}`;
              alpineApp.autoCreateProgress = data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0;
            }
          }
        });

        receiptVoucherSocket.on('auto_creation_completed', (data) => {
          console.log('🎉 Auto creation completed:', data);
          console.log(`🎉 สร้างใบสำคัญรับเงินอัตโนมัติเสร็จสิ้น - สำเร็จ: ${data.success}, ล้มเหลว: ${data.failed}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            const message = data.failed > 0
              ? `สร้างอัตโนมัติเสร็จสิ้น - สำเร็จ ${data.success} รายการ, ล้มเหลว ${data.failed} รายการ`
              : `สร้างอัตโนมัติสำเร็จ ${data.success} รายการ`;
            const type = data.failed > 0 ? 'warning' : 'success';
    
            alpineApp.showNotification?.(message, type);
            alpineApp.loadReceipts?.();
            alpineApp.updateDashboardStats?.();
    
            // Hide progress modal if open
            if (alpineApp.showAutoProgressModal) {
              setTimeout(() => {
                alpineApp.showAutoProgressModal = false;
                if (typeof alpineApp.cancelAutoCreation === 'function') {
                  alpineApp.cancelAutoCreation();
                }
              }, 2000);
            }
    
            // Hide toast
            alpineApp.showAutoCreateToast = false;
          }
        });

        // System Events
        receiptVoucherSocket.on('branch_notification', (data) => {
          console.log('🔔 Branch notification:', data);
          console.log(data.message || '📢 แจ้งเตือนจากระบบ');
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        receiptVoucherSocket.on('system_notification', (data) => {
          console.log('🔧 System notification:', data);
          console.log(`🔧 ${data.message}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        // Error handling
        receiptVoucherSocket.on('connect_error', (error) => {
          console.error('❌ Socket.IO connect error:', error);
          socketConnected = false;
        });

        receiptVoucherSocket.on('error', (error) => {
          console.error('❌ Socket.IO error:', error);
          console.log('🔥 เกิดข้อผิดพลาดในการเชื่อมต่อ Socket.IO');
        });

        console.log('✅ Enhanced Socket.IO initialized for receipt voucher system');
      } else {
        console.warn('⚠️ Socket.IO script not loaded for receipt voucher system');
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info with current branch
        currentSession.branchCode = window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'default';
        currentSession.sessionId = `receipt-voucher-${currentSession.staffId}-${Date.now()}`;

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          receiptVoucherUpdates: ref(database, `pos/${currentSession.branchCode}/receiptVoucherUpdates`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? '🔥 Firebase connected' : '❌ Firebase disconnected');
          firebaseConnected = connected;
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                console.log(notification.message);
              }
            });
          }
        });

        // Listen for receipt voucher updates
        onValue(firebaseRefs.receiptVoucherUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('💰 Receipt voucher update:', update);
                console.log(`💰 ${update.message || 'อัพเดทข้อมูลใบสำคัญรับเงิน'}`);
    
                // Trigger Alpine.js updates if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp && typeof alpineApp.loadReceipts === 'function') {
                  alpineApp.loadReceipts();
                }
              }
            });
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
        });

        console.log('🔥 Firebase listeners setup successfully for receipt voucher');
      } catch (error) {
        console.error('❌ Firebase setup error:', error);
        firebaseConnected = false;
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });

        console.log('📝 Session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('❌ Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const activityHistoryRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/activityHistory`);
        const { push } = window.Firebase;
        push(activityHistoryRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('❌ Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'receipt-voucher'
        });
        console.log('🔔 Notification sent to Firebase');
      } catch (error) {
        console.error('❌ Failed to send notification:', error);
      }
    }

    // Send receipt voucher data to Firebase
    function sendReceiptVoucherToFirebase(receiptData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        const receiptRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/receiptVouchers`);
        push(receiptRef, {
          ...receiptData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'receipt-voucher'
        });
        console.log('💰 Receipt voucher data sent to Firebase');
      } catch (error) {
        console.error('❌ Failed to send receipt voucher data:', error);
      }
    }

         // Heartbeat system
     function startHeartbeat() {
       heartbeatInterval = setInterval(() => {
         if (receiptVoucherSocket && socketConnected) {
           receiptVoucherSocket.emit('ping', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher',
             timestamp: Date.now()
           });
         }
    
         // Update Firebase activity
         updateActivity('heartbeat');
       }, 30000); // 30 seconds
     }

     function stopHeartbeat() {
       if (heartbeatInterval) {
         clearInterval(heartbeatInterval);
         heartbeatInterval = null;
       }
     }

     // Enhanced Socket.IO Functions
     function emitReceiptVoucherUpdate(data) {
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.emit('receipt_voucher_update', {
           branchCode: currentSession.branchCode,
           ...data,
           timestamp: Date.now()
         });
       }
    
       // Also send to Firebase
       sendReceiptVoucherToFirebase(data);
     }

     function emitReceiptVoucherCreated(data) {
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.emit('receipt_voucher_created', {
           branchCode: currentSession.branchCode,
           ...data,
           timestamp: Date.now()
         });
       }
    
       // Send to Firebase
       sendReceiptVoucherToFirebase(data);
     }

         // Get connection status
     function getConnectionStatus() {
       return {
         firebase: firebaseConnected,
         socket: socketConnected,
         combined: firebaseConnected && socketConnected,
         onlineUsers: onlineUsers,
         sessionId: currentSession.sessionId,
         branchCode: currentSession.branchCode
       };
     }

     // Global functions for receipt voucher system
     window.ReceiptVoucherConnection = {
       emitReceiptVoucherUpdate,
       emitReceiptVoucherCreated,
       sendNotificationToFirebase,
       sendReceiptVoucherToFirebase,
       updateActivity,
       getConnectionStatus,
       currentSession,
       firebaseRefs
     };

     // Test functions for debugging
     window.testReceiptVoucherConnection = function() {
       console.log('🧪 Testing Receipt Voucher connections...');
       const status = getConnectionStatus();
       console.log('📊 Connection Status:', status);
    
       // Test Firebase
       if (status.firebase) {
         console.log('✅ Firebase: Connected');
         updateActivity('connection_test');
       } else {
         console.log('❌ Firebase: Disconnected');
       }
    
       // Test Socket.IO
       if (status.socket) {
         console.log('✅ Socket.IO: Connected');
         receiptVoucherSocket.emit('test_receipt_voucher', { message: 'Test from receipt voucher page' });
       } else {
         console.log('❌ Socket.IO: Disconnected');
       }
    
       return status;
     };

     // Initialize both systems when page loads
     document.addEventListener('DOMContentLoaded', () => {
       console.log('🚀 Initializing Firebase + Socket.IO for receipt voucher system...');
    
       // Set branch code from global variable
       if (window.BRANCH_CODE) {
         currentSession.branchCode = window.BRANCH_CODE;
       }
    
       initializeEnhancedSocket();
       initializeFirebase();
    
       // Wait for Alpine.js to be ready
       setTimeout(() => {
         const alpineApp = document.querySelector('[x-data="app"]')?.__x;
         if (alpineApp) {
           console.log('🎯 Alpine.js detected, integration ready');
         }
       }, 1000);
     });

     // Cleanup on page unload
     window.addEventListener('beforeunload', () => {
       console.log('🧹 Cleaning up receipt voucher connections...');
       stopHeartbeat();
    
       if (window.Firebase && firebaseRefs.sessions) {
         window.Firebase.remove(firebaseRefs.sessions);
       }
    
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.disconnect();
       }
     });

    console.log('🔥 Firebase Realtime Database + Socket.IO integration loaded for receipt voucher');
  </script>

  <!-- Duplicate Firebase + Socket.IO scripts removed to prevent double initialization -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== ADDITIONAL FIREBASE + SOCKET.IO FUNCTIONS ====================

    // Initialize Enhanced Socket.IO for Receipt Voucher
    function initializeEnhancedSocket() {
       if (typeof io === 'function') {
         receiptVoucherSocket = io({
           timeout: 10000,
           reconnection: true,
           reconnectionAttempts: 5,
           reconnectionDelay: 1000,
           reconnectionDelayMax: 5000,
           randomizationFactor: 0.5
         });

         // Make it globally accessible
         window.receiptVoucherSocket = receiptVoucherSocket;

         // Connection Events
         receiptVoucherSocket.on('connect', () => {
           console.log('🔗 Socket.IO connected for receipt voucher:', receiptVoucherSocket.id);
           socketConnected = true;
           reconnectAttempts = 0;

           // Join receipt voucher specific rooms
           receiptVoucherSocket.emit('join_branch', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher',
             staffId: currentSession.staffId,
             staffName: currentSession.staffName,
             timestamp: new Date().toISOString()
           });

           receiptVoucherSocket.emit('join_notification_room', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher'
           });

           // Start heartbeat
           startHeartbeat();
         });

         receiptVoucherSocket.on('disconnect', (reason) => {
           console.log('❌ Socket.IO disconnected:', reason);
           socketConnected = false;
           stopHeartbeat();
    
           if (reason === 'io server disconnect') {
             receiptVoucherSocket.connect();
           }
         });

         receiptVoucherSocket.on('reconnect', (attemptNumber) => {
           console.log('🔄 Socket.IO reconnected after', attemptNumber, 'attempts');
           socketConnected = true;
           reconnectAttempts = 0;
           console.log('🔄 Receipt Voucher: เชื่อมต่อใหม่สำเร็จ');
         });

        // Enhanced Event Handlers for Receipt Voucher System
        receiptVoucherSocket.on('receipt_voucher_created', (data) => {
          console.log('💰 Receipt voucher created:', data);
          console.log(`💰 สร้างใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`);
    
          // Integration with Alpine.js
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(`💰 สร้างใบสำคัญรับเงิน ${data.documentNumber || 'ใหม่'} สำเร็จ`, 'success');
    
            // Reload receipts data
            if (typeof alpineApp.loadReceipts === 'function') {
              alpineApp.loadReceipts();
            }
    
            // Update dashboard stats
            if (typeof alpineApp.updateDashboardStats === 'function') {
              alpineApp.updateDashboardStats();
            }
          }

          // Send to Firebase
          sendReceiptVoucherToFirebase(data);
        });

        receiptVoucherSocket.on('receipt_voucher_updated', (data) => {
          console.log('📝 Receipt voucher updated:', data);
          console.log(`📝 อัพเดทใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`📝 อัพเดทใบสำคัญรับเงิน ${data.documentNumber || ''} สำเร็จ`, 'info');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_approved', (data) => {
          console.log('✅ Receipt voucher approved:', data);
          console.log(`✅ ใบสำคัญรับเงิน ${data.documentNumber || ''} ได้รับการอนุมัติ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`✅ ใบสำคัญรับเงิน ${data.documentNumber || ''} ได้รับการอนุมัติ`, 'success');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_cancelled', (data) => {
          console.log('❌ Receipt voucher cancelled:', data);
          console.log(`❌ ใบสำคัญรับเงิน ${data.documentNumber || ''} ถูกยกเลิก`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`❌ ใบสำคัญรับเงิน ${data.documentNumber || ''} ถูกยกเลิก`, 'warning');
            alpineApp.loadReceipts?.();
          }
        });

        // Auto Creation Events
        receiptVoucherSocket.on('auto_creation_started', (data) => {
          console.log('🚀 Auto creation started:', data);
          console.log(`🚀 เริ่มสร้างใบสำคัญรับเงินอัตโนมัติ ${data.total || 0} รายการ`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showAutoCreateToast = true;
            alpineApp.autoCreateMessage = `เริ่มสร้างอัตโนมัติ ${data.total || 0} รายการ`;
            alpineApp.autoCreateProgress = 0;
          }
        });

        receiptVoucherSocket.on('auto_creation_progress', (data) => {
          console.log('⚡ Auto creation progress:', data);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            // Update progress modal if open
            if (alpineApp.showAutoProgressModal) {
              alpineApp.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || 'กำลังประมวลผล...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            // Update toast if showing
            if (alpineApp.showAutoCreateToast) {
              alpineApp.autoCreateMessage = `ประมวลผล ${data.processed || 0}/${data.total || 0}`;
              alpineApp.autoCreateProgress = data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0;
            }
          }
        });

        receiptVoucherSocket.on('auto_creation_completed', (data) => {
          console.log('🎉 Auto creation completed:', data);
          console.log(`🎉 สร้างใบสำคัญรับเงินอัตโนมัติเสร็จสิ้น - สำเร็จ: ${data.success}, ล้มเหลว: ${data.failed}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            const message = data.failed > 0
              ? `สร้างอัตโนมัติเสร็จสิ้น - สำเร็จ ${data.success} รายการ, ล้มเหลว ${data.failed} รายการ`
              : `สร้างอัตโนมัติสำเร็จ ${data.success} รายการ`;
            const type = data.failed > 0 ? 'warning' : 'success';
    
            alpineApp.showNotification?.(message, type);
            alpineApp.loadReceipts?.();
            alpineApp.updateDashboardStats?.();
    
            // Hide progress modal if open
            if (alpineApp.showAutoProgressModal) {
              setTimeout(() => {
                alpineApp.showAutoProgressModal = false;
                if (typeof alpineApp.cancelAutoCreation === 'function') {
                  alpineApp.cancelAutoCreation();
                }
              }, 2000);
            }
    
            // Hide toast
            alpineApp.showAutoCreateToast = false;
          }
        });

        // System Events
        receiptVoucherSocket.on('branch_notification', (data) => {
          console.log('🔔 Branch notification:', data);
          console.log(data.message || '📢 แจ้งเตือนจากระบบ');
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        receiptVoucherSocket.on('system_notification', (data) => {
          console.log('🔧 System notification:', data);
          console.log(`🔧 ${data.message}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        // Error handling
        receiptVoucherSocket.on('connect_error', (error) => {
          console.error('❌ Socket.IO connect error:', error);
          socketConnected = false;
        });

        receiptVoucherSocket.on('error', (error) => {
          console.error('❌ Socket.IO error:', error);
          console.log('🔥 เกิดข้อผิดพลาดในการเชื่อมต่อ Socket.IO');
        });

        console.log('✅ Enhanced Socket.IO initialized for receipt voucher system');
      } else {
        console.warn('⚠️ Socket.IO script not loaded for receipt voucher system');
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners for Receipt Voucher
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info with current branch
        currentSession.branchCode = window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'default';
        currentSession.sessionId = `receipt-voucher-${currentSession.staffId}-${Date.now()}`;

        console.log('🔥 Setting up Firebase listeners for branch:', currentSession.branchCode);

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          receiptVoucherUpdates: ref(database, `pos/${currentSession.branchCode}/receiptVoucherUpdates`),
          receiptVouchers: ref(database, `pos/${currentSession.branchCode}/receiptVouchers`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          activityHistory: ref(database, `pos/${currentSession.branchCode}/activityHistory`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? '🔥 Firebase connected' : '❌ Firebase disconnected');
          firebaseConnected = connected;
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
    
            console.log('🔥 Firebase connection established for receipt voucher');
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                console.log('🔔 New notification:', notification.message);
    
                // Show in Alpine.js if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp && notification.message) {
                  alpineApp.showNotification?.(notification.message, notification.type || 'info');
                }
              }
            });
          }
        });

        // Listen for receipt voucher updates
        onValue(firebaseRefs.receiptVoucherUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('💰 Receipt voucher update:', update);
                console.log(`💰 ${update.message || 'อัพเดทข้อมูลใบสำคัญรับเงิน'}`);
    
                // Trigger Alpine.js updates if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp) {
                  if (typeof alpineApp.loadReceipts === 'function') {
                    alpineApp.loadReceipts();
                  }
                  if (typeof alpineApp.updateDashboardStats === 'function') {
                    alpineApp.updateDashboardStats();
                  }
                }
              }
            });
          }
        });

        // Listen for new receipt vouchers
        onValue(firebaseRefs.receiptVouchers, (snapshot) => {
          const receiptVouchers = snapshot.val();
          if (receiptVouchers) {
            const latestReceipts = Object.entries(receiptVouchers)
              .filter(([key, receipt]) => receipt.timestamp > currentSession.timestamp)
              .sort((a, b) => b[1].timestamp - a[1].timestamp);
    
            if (latestReceipts.length > 0) {
              console.log(`💰 ${latestReceipts.length} new receipt voucher(s) detected`);
    
              // Trigger reload in Alpine.js
              const alpineApp = document.querySelector('[x-data="app"]')?.__x;
              if (alpineApp && typeof alpineApp.loadReceipts === 'function') {
                alpineApp.loadReceipts();
              }
            }
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
          console.log(`👥 Online users in receipt voucher: ${count}`);
        });

        console.log('🔥 Firebase listeners setup successfully for receipt voucher');
      } catch (error) {
        console.error('❌ Firebase setup error:', error);
        firebaseConnected = false;
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });

        console.log('📝 Receipt voucher session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('❌ Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const { push } = window.Firebase;
        push(firebaseRefs.activityHistory, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('❌ Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'receipt-voucher'
        });
        console.log('🔔 Notification sent to Firebase');
      } catch (error) {
        console.error('❌ Failed to send notification:', error);
      }
    }

    // Send receipt voucher data to Firebase
    function sendReceiptVoucherToFirebase(receiptData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.receiptVouchers, {
          ...receiptData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'receipt-voucher'
        });
        console.log('💰 Receipt voucher data sent to Firebase');
      } catch (error) {
        console.error('❌ Failed to send receipt voucher data:', error);
      }
    }

    // Heartbeat system
    function startHeartbeat() {
      heartbeatInterval = setInterval(() => {
        if (receiptVoucherSocket && socketConnected) {
          receiptVoucherSocket.emit('ping', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher',
            timestamp: Date.now()
          });
        }
    
        // Update Firebase activity
        updateActivity('heartbeat');
      }, 30000); // 30 seconds
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // Enhanced Socket.IO Functions
    function emitReceiptVoucherUpdate(data) {
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.emit('receipt_voucher_update', {
          branchCode: currentSession.branchCode,
          ...data,
          timestamp: Date.now()
        });
      }
    
      // Also send to Firebase
      sendReceiptVoucherToFirebase(data);
    }

    function emitReceiptVoucherCreated(data) {
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.emit('receipt_voucher_created', {
          branchCode: currentSession.branchCode,
          ...data,
          timestamp: Date.now()
        });
      }
    
      // Send to Firebase
      sendReceiptVoucherToFirebase(data);
    }

    // Get connection status
    function getConnectionStatus() {
      return {
        firebase: firebaseConnected,
        socket: socketConnected,
        combined: firebaseConnected && socketConnected,
        onlineUsers: onlineUsers,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode
      };
    }

    // Global functions for receipt voucher system
    window.ReceiptVoucherConnection = {
      emitReceiptVoucherUpdate,
      emitReceiptVoucherCreated,
      sendNotificationToFirebase,
      sendReceiptVoucherToFirebase,
      updateActivity,
      getConnectionStatus,
      currentSession,
      firebaseRefs
    };

    // Test functions for debugging
    window.testReceiptVoucherConnection = function() {
      console.log('🧪 Testing Receipt Voucher connections...');
      const status = getConnectionStatus();
      console.log('📊 Connection Status:', status);
    
      // Test Firebase
      if (status.firebase) {
        console.log('✅ Firebase: Connected');
        updateActivity('connection_test');
      } else {
        console.log('❌ Firebase: Disconnected');
      }
    
      // Test Socket.IO
      if (status.socket) {
        console.log('✅ Socket.IO: Connected');
        receiptVoucherSocket.emit('test_receipt_voucher', { message: 'Test from receipt voucher page' });
      } else {
        console.log('❌ Socket.IO: Disconnected');
      }
    
      return status;
    };

            // Global guard to prevent duplicate initialization
        if (window.receiptVoucherSocketInitialized) {
          console.log('🛑 Firebase + Socket.IO already initialized globally, skipping');
        } else {
          window.receiptVoucherSocketInitialized = true;
    
          // Initialize both systems when page loads
          document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Initializing Firebase + Socket.IO for receipt voucher system...');
    
            // Set branch code from global variable
            if (window.BRANCH_CODE) {
              currentSession.branchCode = window.BRANCH_CODE;
            }
    
            initializeEnhancedSocket();
            initializeFirebase();
    
            // Wait for Alpine.js to be ready
            setTimeout(() => {
              const alpineApp = document.querySelector('[x-data="app"]')?.__x;
              if (alpineApp) {
                console.log('🎯 Alpine.js detected, integration ready');
              }
            }, 1000);
          });
        }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      console.log('🧹 Cleaning up receipt voucher connections...');
      stopHeartbeat();
    
      if (window.Firebase && firebaseRefs.sessions) {
        window.Firebase.remove(firebaseRefs.sessions);
      }
    
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.disconnect();
      }
    });

    console.log('🔥 Firebase Realtime Database + Socket.IO integration loaded for receipt voucher');
  </script>

  <!-- Page Styles -->
    <link rel="stylesheet" href="/views/pattani/receiptVoucher.css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

</head>

<body x-data="app" x-init="init()">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container - จะถูกเติมด้วย sidebar.js -->
  <div id="sidebarContainer"></div>

  <div id="mainContent" class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header
      class="p-4 bg-white dark:bg-gray-800
             border-b border-gray-200 dark:border-gray-700
             flex items-center justify-between"
    >
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">ใบสำคัญรับเงิน</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          กำลังโหลดสาขา...
        </p>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="flex-1 p-6 bg-gray-50 dark:bg-gray-900">
      <div class="container mx-auto max-w-6xl">
        <!-- หัวข้อหลัก -->
      <div class="receipt-header flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div class="mb-4 md:mb-0">
          <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-1">ใบสำคัญรับเงิน</h1>
          <p class="text-gray-500 dark:text-gray-400">จัดการและบันทึกรายการรับเงินทุกประเภท</p>

        </div>

        <div class="flex space-x-3">
          <!-- Add Receipt Button -->
          <button id="btnAddReceipt" @click="openAddReceiptModal()"
            class="btn btn-primary btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors">
            <i class="bi bi-plus-lg text-white"></i>
            <span class="text-white">เพิ่มใบสำคัญรับเงิน</span>
          </button>

          <!-- Create from Receipt Button -->
          <button @click="checkPendingItems()"
            class="btn btn-success btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors">
            <i class="bi bi-receipt text-white"></i>
            <span class="text-white">จากใบเสร็จ</span>
            <span x-show="summary.pendingReceiptCount > 0" 
                  class="ml-1 px-2 py-1 bg-white text-green-600 rounded-full text-xs font-bold"
                  x-text="summary.pendingReceiptCount"></span>
          </button>
          
          <!-- Auto Create Button -->
          <button @click="triggerAutoCreation()"
            class="btn btn-warning btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors"
            :disabled="isAutoCreating">
            <i class="bi bi-magic text-white" :class="{'animate-spin': isAutoCreating}"></i>
            <span class="text-white" x-text="isAutoCreating ? 'กำลังสร้าง...' : 'สร้างอัตโนมัติ'">สร้างอัตโนมัติ</span>
          </button>

          <!-- Filter button -->
          <div class="dropdown dropdown-end">
            <button
              class="btn btn-ghost btn-sm normal-case border border-gray-300 dark:border-gray-600 flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
              <i class="bi bi-funnel text-gray-500 dark:text-gray-400"></i>
              <span class="text-gray-700 dark:text-gray-300">กรอง</span>
            </button>
            <div tabindex="0"
              class="dropdown-content menu p-4 shadow bg-white dark:bg-gray-800 rounded-box w-64 mt-1 border border-gray-200 dark:border-gray-700">
              <div class="mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">ช่วงวันที่</label>
                <div class="flex space-x-2 mt-1">
                  <input type="date"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                  <input type="date"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                </div>
              </div>
              <div class="mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">บัญชี</label>
                <select class="w-full mt-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                  <option value="">ทั้งหมด</option>
                  <option>เงินสด</option>
                  <option>บัญชีธนาคาร</option>
                </select>
              </div>
              <div class="flex justify-end">
                <button
                  class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded transition">นำไปใช้</button>
              </div>
            </div>
          </div>

          <!-- Export PDF button -->
          <div class="dropdown dropdown-end">
            <button
              class="btn btn-ghost btn-sm normal-case border border-gray-300 dark:border-gray-600 flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
              <i class="bi bi-file-earmark-pdf text-red-500"></i>
              <span class="text-gray-700 dark:text-gray-300">Export PDF</span>
            </button>
            <div tabindex="0"
              class="dropdown-content menu p-4 shadow bg-white dark:bg-gray-800 rounded-box w-56 mt-1 border border-gray-200 dark:border-gray-700">
              <button @click="exportSelectedPDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-check2-square mr-2"></i>รายการที่เลือก
              </button>
              <button @click="exportCurrentPagePDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-file-earmark mr-2"></i>หน้าปัจจุบัน
              </button>
              <button @click="exportAllPDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-files mr-2"></i>ทั้งหมด
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- ส่วนการ์ดสรุปที่ปรับปรุงแล้ว -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
        <!-- Card 1: รับเงินทั้งหมด -->
        <div @click="changeTimeRange('amount')"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in cursor-pointer hover:shadow-lg transition-shadow">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                รับเงินทั้งหมด <span class="text-xs">(<span x-text="timeRangeText.amount"></span>)</span>
              </p>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1"
                x-text="summary.totalAmountFormatted">฿0.00</h3>
            </div>
            <div class="p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
              <i class="bi bi-cash-stack text-green-500 dark:text-green-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-center text-sm">
            <span
              :class="summary.amountComparisonPercentage >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'"
              class="flex items-center">
              <i :class="summary.amountComparisonPercentage >= 0 ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi mr-1"></i>
              <span x-text="Math.abs(summary.amountComparisonPercentage)">0</span>%
            </span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">เทียบกับช่วงที่แล้ว</span>
          </div>
        </div>

        <!-- Card 2: จำนวนรายการ -->
        <div @click="changeTimeRange('count')"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in cursor-pointer hover:shadow-lg transition-shadow"
          style="animation-delay: 0.1s">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                จำนวนรายการ <span class="text-xs">(<span x-text="timeRangeText.count"></span>)</span>
              </p>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1" x-text="summary.totalCount">0</h3>
            </div>
            <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
              <i class="bi bi-receipt text-blue-500 dark:text-blue-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-center text-sm">
            <span
              :class="summary.countComparisonPercentage >= 0 ? 'text-blue-500 dark:text-blue-400' : 'text-red-500 dark:text-red-400'"
              class="flex items-center">
              <i :class="summary.countComparisonPercentage >= 0 ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi mr-1"></i>
              <span x-text="Math.abs(summary.countComparisonPercentage)">0</span>%
            </span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">เทียบกับช่วงที่แล้ว</span>
          </div>
        </div>

        <!-- Card 3: แก้ไขเป็น Auto Creation Status -->
        <div @click="showAutoCreationStats()"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in relative overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"
          style="animation-delay: 0.2s">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-5">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="currentColor" stroke-width="0.5" />
              </pattern>
              <rect width="100" height="100" fill="url(#grid)" />
            </svg>
          </div>

          <div class="relative">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">สถานะระบบ Auto</p>
                <div class="flex items-center mt-2 space-x-2">
                  <div id="autoStatusIcon" class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                  </div>
                  <span id="autoStatusText"
                    class="text-lg font-semibold text-green-600 dark:text-green-400">ทำงานอัตโนมัติ</span>
                </div>
              </div>
              <div class="p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
                <i class="bi bi-robot text-green-500 dark:text-green-400 text-xl"></i>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm">
              <span class="text-gray-500 dark:text-gray-400">สร้างวันนี้:</span>
              <span class="font-medium text-green-600 dark:text-green-400" id="todayAutoCount"
                x-text="summary.todayAutoCreatedCount || 0">0</span>
            </div>
          </div>
        </div>

        <!-- Card 4: รอดำเนินการ -->
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in"
          style="animation-delay: 0.3s">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">ใบเสร็จรอสร้างใบสำคัญ</p>
              <h3 class="text-2xl font-bold mt-1" id="pendingCount">
                <span class="text-amber-600 dark:text-amber-400" x-text="summary.pendingReceiptCount || 0">0</span>
              </h3>
            </div>
            <div class="p-2 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
              <i class="bi bi-receipt text-amber-500 dark:text-amber-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3">
            <button @click="checkPendingItems()"
              class="text-sm text-amber-600 hover:text-amber-700 dark:text-amber-400 dark:hover:text-amber-300 flex items-center">
              <span>ดูใบเสร็จที่รอดำเนินการ</span>
              <i class="bi bi-arrow-right ml-1"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- แสดงข้อมูลใบสำคัญรับเงิน -->
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6 mb-8 border border-gray-100 dark:border-gray-700 fade-in">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
          <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3 md:mb-0">
            รายการใบสำคัญรับเงิน
          </h2>

          <div class="flex items-center space-x-2">
            <!-- Filter by Creation Type -->
            <div
              class="flex space-x-1 border border-gray-300 dark:border-gray-600 rounded-lg p-0.5 bg-gray-50 dark:bg-gray-700">
              <button @click="filterByCreationType('all')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'all' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                ทั้งหมด
              </button>
              <button @click="filterByCreationType('auto')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'auto' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                <i class="bi bi-robot mr-1"></i> Auto
              </button>
              <button @click="filterByCreationType('manual')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'manual' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                <i class="bi bi-person mr-1"></i> สร้างเอง
              </button>
            </div>

            <div class="relative">
              <input type="text" placeholder="ค้นหารายการ..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="bi bi-search text-gray-400"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="table w-full receipt-table">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="px-4 py-3 text-left">รหัสบัญชี</th>
                <th class="px-4 py-3 text-left">ชื่อบัญชี</th>
                <th class="px-4 py-3 text-left">ประเภท</th>
                <th class="px-4 py-3 text-left">วันที่รับเงิน</th>
                <th class="px-4 py-3 text-right">จำนวนเงิน</th>
                <th class="px-4 py-3 text-center">สถานะ</th>
                <th class="px-4 py-3 text-center">จัดการ</th>
              </tr>
            </thead>
            <tbody id="receiptTableBody">
              <!-- ลบทุก <tr> ที่มีข้อมูลตัวอย่างออก -->
            </tbody>
            <tfoot>
              <tr class="font-semibold">
                <td colspan="4" class="px-4 py-4 text-right text-gray-800 dark:text-gray-200">รวมเงินทั้งหมด:</td>
                <td class="px-4 py-4 text-right receipt-total">฿0.00</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Pagination -->
        <div class="mt-6 flex items-center justify-between">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            แสดง <span x-text="paginationStart"></span> ถึง <span x-text="paginationEnd"></span>
            จาก <span x-text="totalReceipts"></span> รายการ
          </div>
          <div class="flex space-x-1" id="paginationButtons">
            <!-- ปุ่ม pagination จะถูกสร้างโดย JavaScript -->
          </div>
        </div>
      </div>

      <!-- Confirmation Dialog for Delete -->
      <div id="deleteConfirmDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        x-show="showDeleteModal" x-cloak @click.self="showDeleteModal = false"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
          <div class="text-center">
            <div
              class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
              <i class="bi bi-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">ยืนยันการลบรายการ</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">คุณแน่ใจหรือไม่ที่ต้องการลบรายการนี้?
              การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-center space-x-3">
              <button @click="showDeleteModal = false"
                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                ยกเลิก
              </button>
              <button @click="deleteReceipt()"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                ลบรายการ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal สำหรับเพิ่ม/แก้ไขใบสำคัญรับเงิน -->
      <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        x-show="showModal" x-cloak @click.self="showModal = false" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-3xl w-full mx-4"
          @click.outside="showModal = false">
          <!-- Add scrollable container -->
          <div class="max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200" id="modalTitle"
                x-text="receiptId ? 'แก้ไขใบสำคัญรับเงิน' : 'เพิ่มใบสำคัญรับเงิน'">เพิ่มใบสำคัญรับเงิน</h3>
              <button @click="showModal = false" id="closeModal"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            <form id="receiptForm" class="receipt-form p-6" @submit.prevent="submitForm">
              <!-- Document Information Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">ข้อมูลเอกสาร</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-group">
                    <div class="form-floating">
                      <input type="text" id="documentNumber" name="documentNumber" required placeholder=" " class="peer"
                        x-bind:value="receiptId ? 'RV' + receiptId.substring(2) : generateDocumentId()">
                      <label for="documentNumber" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        เลขที่เอกสาร <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="form-floating">
                      <input type="date" id="paymentDate" name="paymentDate" required placeholder=" " class="peer"
                        x-bind:value="new Date().toISOString().substr(0, 10)">
                      <label for="paymentDate" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        วันที่รับเงิน <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Account Information Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">ข้อมูลบัญชี</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                  <div class="form-group">
                    <label for="debitAccountCode" class="text-gray-500 dark:text-gray-400">บัญชีเดบิต (รับเงิน) <span
                        class="text-red-500">*</span></label>
                    <select id="debitAccountCode" name="debitAccountCode" required class="mt-1 peer"
                      onchange="updateAccountName(this, 'debitAccountName')">
                      <option value="">เลือกบัญชี</option>
                      <template x-for="acc in debitAccounts" :key="acc.code">
                        <option :value="acc.code + '|' + acc.name" x-text="acc.code + ' - ' + acc.name"></option>
                      </template>
                      <option value="" x-show="debitAccounts.length === 0">กรุณาตั้งค่าผังบัญชีก่อน</option>
                    </select>
                    <input type="hidden" id="debitAccountName" name="debitAccountName">
                  </div>

                  <div class="form-group">
                    <label for="creditAccountCode" class="text-gray-500 dark:text-gray-400">บัญชีเครดิต <span
                        class="text-red-500">*</span></label>
                    <select id="creditAccountCode" name="creditAccountCode" required class="mt-1 peer"
                      onchange="updateAccountName(this, 'creditAccountName')">
                      <option value="">เลือกบัญชี</option>
                      <template x-for="acc in creditAccounts" :key="acc.code">
                        <option :value="acc.code + '|' + acc.name" x-text="acc.code + ' - ' + acc.name"></option>
                      </template>
                      <!-- Fallback/Example if API fails or for initial render -->
                      <option value="" x-show="creditAccounts.length === 0">กรุณาตั้งค่าผังบัญชีก่อน</option>
                    </select>
                    <input type="hidden" id="creditAccountName" name="creditAccountName">
                  </div>

                  <div class="form-group col-span-2">
                    <div class="form-floating">
                      <input type="text" id="receivedFrom" name="receivedFrom" required placeholder=" " class="peer">
                      <label for="receivedFrom" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        รับเงินจาก <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="receiptType" class="text-gray-500 dark:text-gray-400">ประเภทการรับเงิน <span
                        class="text-red-500">*</span></label>
                    <select id="receiptType" name="receiptType" required class="mt-1 peer">
                      <option value="cash_sale">ขายสินค้า</option>
                      <option value="credit_sale">ขายเชื่อ</option>
                      <option value="debt_payment">รับชำระหนี้</option>
                      <option value="deposit">รับเงินมัดจำ</option>
                      <option value="return">รับคืนสินค้า</option>
                    </select>

                  </div>

                  <div class="form-group">
                    <label for="paymentMethod" class="text-gray-500 dark:text-gray-400">วิธีการชำระ <span
                        class="text-red-500">*</span></label>
                    <select id="paymentMethod" name="paymentMethod" required class="mt-1 peer"
                      onchange="togglePaymentDetails(this.value)">
                      <option value="cash">เงินสด</option>
                      <option value="transfer">โอนเงิน</option>
                      <option value="cheque">เช็ค</option>
                      <option value="credit_card">บัตรเครดิต</option>
                    </select>
                  </div>

                  <!-- Bank Details (conditionally shown) -->
                  <div id="bankDetails" style="display:none;" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                      <label for="bankAccount" class="text-gray-500 dark:text-gray-400">บัญชีธนาคาร</label>
                      <select id="bankAccount" name="bankAccount" class="mt-1 peer">
                        <option value="">เลือกบัญชี</option>
                        <!-- บัญชีธนาคารจะถูกโหลดจาก API -->
                      </select>
                    </div>
                    <!-- Add Cheque Info fields here if needed, similar conditional display -->
                  </div>

                </div>
              </div>

              <!-- Transaction Details Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">รายละเอียดรายการ</h4>

                <!-- Transaction details container -->
                <div id="transactionDetailsContainer" class="space-y-4">
                  <!-- Individual detail rows -->
                  <div class="transaction-detail-entry grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-7">
                      <div class="form-floating">
                        <input type="text" name="transactionDetail[]" required placeholder=" " class="peer" value="">
                        <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                          รายการ <span class="text-red-500">*</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-span-4">
                      <div class="form-floating relative">
                        <input type="number" step="0.01" name="detailAmount[]" required placeholder=" "
                          class="peer pl-8" value="0" oninput="updateTransactionTotal()">
                        <div
                          class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">
                          ฿
                        </div>
                        <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                          จำนวนเงิน <span class="text-red-500">*</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-span-1 flex justify-center">
                      <button type="button" class="text-gray-400 hover:text-red-500 focus:outline-none"
                        onclick="removeTransactionDetail(this)">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </div>
                  </div>

                  <button type="button" id="addTransactionDetail" @click="addTransactionDetailEntry()"
                    class="mt-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center text-sm font-medium">
                    <i class="bi bi-plus-circle mr-1"></i> เพิ่มรายการ
                  </button>

                  <!-- Transaction total -->
                  <div class="mt-4 flex justify-end">
                    <div class="bg-blue-50 dark:bg-blue-900/20 px-4 py-2 rounded-lg">
                      <span class="text-gray-600 dark:text-gray-300 mr-2">ยอดรวมทั้งหมด:</span>
                      <span id="transactionTotal" class="font-bold text-blue-600 dark:text-blue-400"
                        x-text="'฿0.00'">฿0.00</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Notes Section -->
              <div class="form-group mb-6">
                <label for="notes" class="block mb-2 text-gray-700 dark:text-gray-300">หมายเหตุ</label>
                <textarea id="notes" name="notes" rows="3"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  x-bind:value="receiptId ? 'บันทึกเพิ่มเติมสำหรับ ' + receiptId : ''"></textarea>
              </div>

              <div class="flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" @click="showModal = false" id="cancelBtn"
                  class="px-4 py-2 mr-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                  ยกเลิก
                </button>
                <button type="submit"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="bi bi-check2 mr-1"></i> บันทึก
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Notification Toast -->
      <div id="notification" x-show="notification.show" x-cloak x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50"
        :class="notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
        <span x-text="notification.message"></span>
      </div>

      <!-- Toast Notification สำหรับ Auto Creation -->
      <div x-show="showAutoCreateToast" x-cloak x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-x-0"
        x-transition:leave-end="opacity-0 transform translate-x-full" class="fixed top-20 right-4 max-w-sm w-full z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl border-l-4 border-green-500 p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                <i class="bi bi-check-circle-fill text-green-500"></i>
              </div>
            </div>
            <div class="ml-3 flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
                สร้างใบสำคัญรับเงินอัตโนมัติ
              </p>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" x-text="autoCreateMessage">
                กำลังประมวลผล...
              </p>
            </div>
            <button @click="showAutoCreateToast = false" class="ml-4 text-gray-400 hover:text-gray-600">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <!-- Progress bar -->
          <div class="mt-3 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
            <div class="bg-green-500 h-1.5 rounded-full transition-all duration-300"
              :style="`width: ${autoCreateProgress}%`"></div>
          </div>
        </div>
      </div>

      </div> <!-- End container -->
    </div> <!-- End Main Content Container -->
  </div> <!-- End Main Content -->

  <!-- Auto Configuration Modal -->
    <div id="autoConfigModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
      x-show="showAutoConfigModal" x-cloak @click.self="showAutoConfigModal = false"
      x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-90"
        x-transition:enter-end="opacity-100 transform scale-100">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
            <i class="bi bi-gear mr-2"></i>ตั้งค่าการสร้างใบสำคัญรับเงินอัตโนมัติ
          </h3>
          <button @click="showAutoConfigModal = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- Content -->
        <div class="p-6">
          <!-- Enable/Disable Toggle -->
          <div class="mb-6">
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-gray-700 dark:text-gray-300 font-medium">
                เปิดใช้งานการสร้างอัตโนมัติ
              </span>
              <div class="relative">
                <input type="checkbox" x-model="autoConfig.enabled" class="sr-only">
                <div class="w-11 h-6 bg-gray-200 rounded-full shadow-inner"
                  :class="autoConfig.enabled ? 'bg-blue-600' : 'bg-gray-200'"></div>
                <div class="absolute w-4 h-4 bg-white rounded-full shadow top-1 transition-transform duration-200"
                  :class="autoConfig.enabled ? 'translate-x-6' : 'translate-x-1'"></div>
              </div>
            </label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              เมื่อเปิดใช้งาน ระบบจะสร้างใบสำคัญรับเงินอัตโนมัติตามประเภทที่เลือก
            </p>
          </div>

          <!-- Transaction Types -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              ประเภทรายการที่ต้องการสร้างอัตโนมัติ
            </h4>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.cashSale"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">ขายสินค้า</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.creditSale"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">ขายเชื่อ</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.debtPayment"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">รับชำระหนี้</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.deposit"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">รับเงินมัดจำ</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.return"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">รับคืนสินค้า</span>
              </label>
            </div>

          </div>

          <!-- Timing Options -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              เวลาในการสร้าง
            </h4>
            <div class="space-y-3">
              <label class="flex items-center">
                <input type="radio" x-model="autoConfig.timing" value="immediate"
                  class="text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">สร้างทันทีเมื่อมีรายการใหม่</span>
              </label>
              <label class="flex items-center">
                <input type="radio" x-model="autoConfig.timing" value="scheduled"
                  class="text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">สร้างตามเวลาที่กำหนด</span>
              </label>

              <div x-show="autoConfig.timing === 'scheduled'" class="ml-6 mt-2">
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">เวลาที่ต้องการให้สร้าง</label>
                <input type="time" x-model="autoConfig.scheduledTime"
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>

          <!-- Notifications -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              การแจ้งเตือน
            </h4>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.success"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">แจ้งเตือนเมื่อสร้างสำเร็จ</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.error"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">แจ้งเตือนเมื่อมีข้อผิดพลาด</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.summary"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">สรุปผลประจำวัน</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t border-gray-200 dark:border-gray-700">
          <button @click="showAutoConfigModal = false"
            class="px-4 py-2 mr-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition">
            ยกเลิก
          </button>
          <button @click="saveAutoConfig()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition">
            <i class="bi bi-check2 mr-1"></i> บันทึกการตั้งค่า
          </button>
        </div>
      </div>
    </div>

    <!-- Auto Creation Progress Modal -->
    <div id="autoProgressModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
      x-show="showAutoProgressModal" x-cloak>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full mx-4"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-90"
        x-transition:enter-end="opacity-100 transform scale-100">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
            <i class="bi bi-arrow-repeat animate-spin mr-2"></i>กำลังสร้างใบสำคัญรับเงินอัตโนมัติ
          </h3>
        </div>

        <!-- Content -->
        <div class="p-6">
          <!-- Current Item -->
          <div class="mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">กำลังประมวลผล:</p>
            <p class="font-medium text-gray-800 dark:text-gray-200" x-text="autoProgress.currentItem">
              กำลังเตรียมข้อมูล...</p>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
              <span>ความคืบหน้า</span>
              <span><span x-text="autoProgress.percentage">0</span>%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
              <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300"
                :style="`width: ${autoProgress.percentage}%`"></div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              ประมวลผล <span x-text="autoProgress.current">0</span> จาก <span x-text="autoProgress.total">0</span>
              รายการ
            </p>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="autoProgress.success">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">สำเร็จ</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" x-text="autoProgress.skipped">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">ข้ามไป</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-red-600 dark:text-red-400" x-text="autoProgress.failed">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">ล้มเหลว</div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t border-gray-200 dark:border-gray-700">
          <button @click="cancelAutoCreation(); showAutoProgressModal = false"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg mr-2"
            x-show="autoCreationJob && autoProgress.percentage < 100">
            <i class="bi bi-x-circle mr-1"></i> ยกเลิก
          </button>
          <button @click="showAutoProgressModal = false"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">
            ปิด
          </button>
        </div>
      </div>
    </div>

  </div> <!-- End Main Content container -->

  <!-- Footer -->
  <footer class="mt-auto text-center text-sm text-gray-500 dark:text-gray-400 py-4">
    © 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์.
  </footer>

  <script>

    // -----------------------------
    // 1) JavaScript Logic - Branch Configuration
    // -----------------------------
    const API_ROOT = '/api';
    
    // ✅ ปรับปรุงการกำหนด BRANCH_CODE ให้ถูกต้อง
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch') || localStorage.getItem('branchId');

    // ถ้าไม่มี BRANCH_CODE ให้โหลดจาก user profile
    if (!BRANCH_CODE) {
      console.warn('⚠️ Branch not found in URL or localStorage, will load from user profile');
    }

    // Make BRANCH_CODE globally accessible
    window.currentBranchCode = BRANCH_CODE;
    window.BRANCH_CODE = BRANCH_CODE;
    
    console.log('🏢 Initial Branch Code:', BRANCH_CODE);

    // อัพเดท localStorage และ title ถ้ามี branch ใน URL
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
      localStorage.setItem('branchId', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `ใบสำคัญรับเงิน - ${decodeURIComponent(urlParams.get('name'))}`;
    }

    // Note: Sidebar initialization is now handled by sidebar.js

    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });

        const js = await res.json();
        if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

        const user = js.data;
        document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';

        let img = user.imageUrl || user.photoUrl || user.image || '';
        if (img && !/^https?:\/\//.test(img)) {
          img = img.startsWith('/') ? img : '/uploads/' + img;
        }

        const photoElement = document.getElementById('employeePhoto');
        if (photoElement) {
          photoElement.src = img || '/static/images/avatar-placeholder.png';
        }
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }

    // Note: State restoration is now handled by sidebar.js

    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
    
        if (!token) {
          throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
        }
    
        console.log('🔄 Loading branch info for BRANCH_CODE:', BRANCH_CODE);
    
        // เรียก /api/branch เพื่อดึง list สาขา
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
    
        if (!res.ok) {
          throw new Error(`API Error: ${res.status} - ${res.statusText}`);
        }
    
        const js = await res.json();
    
        if (!js.success || !js.data) {
          throw new Error('API ส่งข้อมูลไม่ถูกต้อง');
        }
    
        console.log('📋 Available branches:', js.data.map(b => ({ id: b._id, code: b.branch_code, name: b.name })));
    
        let targetBranch = null;
    
        // ถ้า BRANCH_CODE ไม่มี ให้ใช้ current branch จาก Alpine
        const alpineApp = document.querySelector('[x-data="app"]')?.__x;
        const currentBranchId = alpineApp?.currentBranch || BRANCH_CODE;
    
        console.log('🔍 Searching for branch with ID/Code:', currentBranchId);
    
        if (currentBranchId) {
          // หา record ที่ตรงกับ currentBranchId (ลองทั้ง _id และ branch_code)
          targetBranch = js.data.find(b =>
            b._id === currentBranchId ||
            b.branch_code === currentBranchId ||
            String(b._id) === String(currentBranchId) ||
            String(b.branch_code) === String(currentBranchId)
          );
        }
    
        if (targetBranch) {
          // อัพเดท global BRANCH_CODE ให้ตรงกับ branch ที่เจอ
          window.BRANCH_CODE = targetBranch._id;
          window.currentBranchCode = targetBranch._id;
          localStorage.setItem('branchId', targetBranch._id);
          localStorage.setItem('activeBranch', targetBranch.branch_code);
    
          document.getElementById('branchInfo').textContent =
            `${targetBranch.name} — ${targetBranch.address || targetBranch.branch_code}`;
          document.title = `ใบสำคัญรับเงิน - ${targetBranch.name}`;
          document.getElementById('pageTitle').textContent = `ใบสำคัญรับเงิน - ${targetBranch.name}`;
    
          console.log(`✅ โหลดข้อมูลสาขาสำเร็จ: ${targetBranch.name} (ID: ${targetBranch._id})`);
    
          // อัพเดท Alpine currentBranch
          if (alpineApp) {
            alpineApp.currentBranch = targetBranch._id;
          }
    
          return targetBranch;
        }
    
        // ถ้าไม่เจอสาขาที่ตรงกับ BRANCH_CODE ใช้สาขาแรก
        const firstBranch = js.data[0];
        if (firstBranch) {
          // อัพเดท global BRANCH_CODE
          window.BRANCH_CODE = firstBranch._id;
          window.currentBranchCode = firstBranch._id;
          localStorage.setItem('branchId', firstBranch._id);
          localStorage.setItem('activeBranch', firstBranch.branch_code);
    
          document.getElementById('branchInfo').textContent =
            `${firstBranch.name} — ${firstBranch.address || firstBranch.branch_code}`;
          document.title = `ใบสำคัญรับเงิน - ${firstBranch.name}`;
          document.getElementById('pageTitle').textContent = `ใบสำคัญรับเงิน - ${firstBranch.name}`;
    
          console.warn(`⚠️ ไม่พบสาขา ${currentBranchId} ใช้สาขา ${firstBranch.name} แทน`);
    
          // อัพเดท Alpine currentBranch
          if (alpineApp) {
            alpineApp.currentBranch = firstBranch._id;
          }
    
          return firstBranch;
        }
    
        throw new Error('ไม่พบข้อมูลสาขาในระบบ');
    
      } catch (err) {
        console.error('❌ loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลสาขา';
    
        // แสดง error notification ให้ผู้ใช้ทราบ
        const errorMessage = `ไม่สามารถโหลดข้อมูลสาขาได้: ${err.message}`;
        console.error(errorMessage);
    
        // ถ้ามี Alpine instance ให้แสดง notification
        setTimeout(() => {
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(errorMessage, 'error');
          }
        }, 1000);
    
        throw err; // Re-throw เพื่อให้ caller รู้ว่าเกิด error
      }
    }

    // Alpine.js component data and functions
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // Properties
        sidebarOpen: window.innerWidth >= 1024,
        darkMode: localStorage.getItem('theme') === 'dark',
        showModal: false,
        showDeleteModal: false,
        receiptId: null,
        receiptIdToDelete: null,
        receipts: [],
        filteredReceipts: [],
        currentFilter: 'all',

        // ✅ แก้ไข: ลบ property ที่ซ้ำออก
        currentPage: 1,
        itemsPerPage: 10,
        totalPages: 1,
        paginationStart: 1,
        paginationEnd: 10,
        totalReceipts: 0,

        debitAccounts: [],
        creditAccounts: [],
        notification: {
          show: false,
          message: '',
          type: 'success'
        },
        showAutoCreateToast: false,
        autoCreateMessage: 'กำลังประมวลผล...',
        autoCreateProgress: 0,
        summary: {
          totalAmountFormatted: '฿0.00',
          totalAmountMonth: 0,
          amountComparisonPercentage: 0, // ✅ เพิ่ม property ที่ขาด
          monthlyComparisonPercentage: 0,
          totalCount: 0, // ✅ เพิ่ม property ที่ขาด
          totalCountMonth: 0,
          countComparisonPercentage: 0,
          todayAutoCreatedCount: 0,
          pendingReceiptCount: 0
        },
        currentBranch: null, // จะถูกตั้งค่าใน loadCurrentBranch()
        timeRange: {
          amount: 'month',
          count: 'month'
        },
        timeRangeText: {
          amount: 'เดือนนี้',
          count: 'เดือนนี้'
        },
        autoConfig: {
          enabled: true,
          types: {
            cashSale: true,
            creditSale: true,
            debtPayment: true,
            deposit: true,
            return: true
          },
          timing: 'immediate',
          scheduledTime: '18:00',
          notifications: {
            success: true,
            error: true,
            summary: false
          }
        },
        autoProgress: {
          current: 0,
          total: 0,
          percentage: 0,
          currentItem: 'กำลังเตรียมข้อมูล...',
          success: 0,
          skipped: 0,
          failed: 0
        },
        showAutoConfigModal: false,
        showAutoProgressModal: false,
        autoCreationJob: null,

        // Methods - ย้ายมาไว้ข้างนอก init()
        getReceiptTypeDisplay(receipt) {
          if (receipt.receiptType) {
            const typeMap = {
              'cash_sale': 'ขายสินค้า',
              'credit_sale': 'ขายเชื่อ',
              'debt_payment': 'รับชำระหนี้',
              'deposit': 'รับเงินมัดจำ',
              'return': 'รับคืนสินค้า'
            };
            return typeMap[receipt.receiptType] || 'ขายสินค้า';
          }

          const reason = (receipt.reason || '').toLowerCase();

          if (reason.includes('ขายเชื่อ') || reason.includes('credit')) {
            return 'ขายเชื่อ';
          }
          if (reason.includes('ชำระหนี้') || reason.includes('รับชำระ') || reason.includes('payment')) {
            return 'รับชำระหนี้';
          }
          if (reason.includes('มัดจำ') || reason.includes('deposit')) {
            return 'รับเงินมัดจำ';
          }
          if (reason.includes('คืน') || reason.includes('return')) {
            return 'รับคืนสินค้า';
          }

          return 'ขายสินค้า';
        },

        getReceiptTypeConfig(type) {
          const configs = {
            'cash_sale': { icon: 'bi bi-cash-stack', color: 'text-green-500' },
            'credit_sale': { icon: 'bi bi-credit-card', color: 'text-blue-500' },
            'debt_payment': { icon: 'bi bi-wallet2', color: 'text-purple-500' },
            'deposit': { icon: 'bi bi-piggy-bank', color: 'text-pink-500' },
            'return': { icon: 'bi bi-arrow-return-left', color: 'text-orange-500' }
          };
          return configs[type] || { icon: 'bi bi-cash-stack', color: 'text-green-500' }; // ✅ แก้ closing bracket
        },

        // เพิ่มใน Alpine.js methods
        async exportCurrentPagePDF() {
          let loaderId = null;
          try {
            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            const pageReceipts = this.filteredReceipts.slice(startIndex, endIndex);

            if (pageReceipts.length === 0) {
              this.showNotification('ไม่มีรายการในหน้านี้', 'warning');
              return;
            }

            loaderId = LoadingSystem.show({
              message: 'กำลังสร้างไฟล์ PDF...',
              type: 'spinner'
            });

            // เรียก API export
            const response = await fetch('/api/receipt-vouchers/export/pdf', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify({
                receiptIds: pageReceipts.map(r => r._id),
                format: 'merged' // หรือ 'separate' สำหรับแยกไฟล์
              })
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `receipts_page_${this.currentPage}.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);

              // ซ่อน loading และแสดงความสำเร็จ
              if (loaderId) {
                LoadingSystem.hide(loaderId);
                loaderId = null;
              }
              this.showNotification('Export PDF สำเร็จ', 'success');
            } else {
              throw new Error('Export failed');
            }
          } catch (error) {
            console.error('Export error:', error);
            this.showNotification('ไม่สามารถ Export PDF ได้', 'error');
          } finally {
            // ซ่อน loading ในกรณีที่เกิด error
            if (loaderId) {
              LoadingSystem.hide(loaderId);
            }
          }
        },

        async exportAllPDF() {
          let loaderId = null;
          try {
            if (this.filteredReceipts.length === 0) {
              this.showNotification('ไม่มีรายการให้ Export', 'warning');
              return;
            }

            loaderId = LoadingSystem.show({
              message: 'กำลังสร้างไฟล์ PDF ทั้งหมด...',
              type: 'spinner'
            });

            // เรียก API export
            const response = await fetch('/api/receipt-vouchers/export/pdf', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify({
                receiptIds: this.filteredReceipts.map(r => r._id),
                format: 'merged'
              })
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `all_receipts.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);

              if (loaderId) {
                LoadingSystem.hide(loaderId);
                loaderId = null;
              }
              this.showNotification('Export PDF ทั้งหมดสำเร็จ', 'success');
            } else {
              throw new Error('Export failed');
            }
          } catch (error) {
            console.error('Export all PDF error:', error);
            this.showNotification('ไม่สามารถ Export PDF ทั้งหมดได้', 'error');
          } finally {
            if (loaderId) {
              LoadingSystem.hide(loaderId);
            }
          }
        },

        async editReceipt(id) {
  this.receiptId = id;
  try {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
      throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
    }

    // ✅ ลองเรียก API หลายเส้นทาง
    let endpoints = [];
    if (/^[0-9a-fA-F]{24}$/.test(id)) {
      // ถ้าเป็น ObjectId
      endpoints = [
        `/api/receipt-voucher/${id}`,         // endpoint หลักที่ทำงานได้
        `/api/receipt-vouchers/${id}`,        // backup
        `/api/receiptVoucher/${id}`,          // camelCase
        `/api/receiptVouchers/${id}`          // camelCase backup
      ];
    } else {
      // ถ้าเป็น documentNumber
      endpoints = [
        `/api/receipt-voucher/document/${id}`,         // endpoint หลักที่ทำงานได้
        `/api/receipt-vouchers/document/${id}`,        // backup
        `/api/receiptVoucher/document/${id}`,          // camelCase
        `/api/receiptVouchers/document/${id}`          // camelCase backup
      ];
    }

    let response = null;
    let foundEndpoint = null;

    for (const endpoint of endpoints) {
      try {
        console.log(`🔍 ลองแก้ไขจาก: ${endpoint}`);
        response = await fetch(endpoint, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.status !== 404) {
          foundEndpoint = endpoint;
          break;
        }
      } catch (err) {
        console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
      }
    }

    if (!foundEndpoint || !response) {
      throw new Error('ไม่พบระบบแก้ไขใบสำคัญรับเงิน - API endpoints ไม่พร้อมใช้งาน');
    }
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Token หมดอายุ กรุณาเข้าสู่ระบบใหม่');
      } else if (response.status === 404) {
        throw new Error('ไม่พบรายการที่ต้องการแก้ไข');
      } else if (response.status === 403) {
        throw new Error('ไม่มีสิทธิ์แก้ไขรายการนี้');
      } else {
        throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}`);
      }
    }

    const result = await response.json();
    
    if (!result.success || !result.data) {
      throw new Error(result.message || 'API ส่งข้อมูลไม่ถูกต้อง');
    }

    this.populateEditForm(result.data);

  } catch (error) {
    console.error('Error editing receipt:', error);
    this.showNotification(error.message, 'error');
    
    // ถ้าเป็น token expired ให้ redirect ไป login
    if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
      setTimeout(() => {
        localStorage.removeItem('authToken');
        window.location.href = '/login';
      }, 3000);
    }
  }
},

// แยก method สำหรับ populate form
populateEditForm(data) {
  document.getElementById('modalTitle').textContent = 'แก้ไขใบสำคัญรับเงิน';

  // Populate form fields
  document.getElementById('documentNumber').value = data.documentNumber;
  document.getElementById('paymentDate').value = new Date(data.paymentDate).toISOString().substr(0, 10);

  const debitSelect = document.getElementById('debitAccountCode');
  // Ensure the value matches the format "CODE|NAME" if options are structured that way, or just "CODE"
  let debitValueToSet = data.debitAccount.code;
  if (Array.from(debitSelect.options).some(opt => opt.value.includes('|'))) {
    debitValueToSet = `${data.debitAccount.code}|${data.debitAccount.name}`;
  }
  debitSelect.value = debitValueToSet;
  updateAccountName(debitSelect, 'debitAccountName'); // Update hidden name field

  const creditSelect = document.getElementById('creditAccountCode');
  let creditValueToSet = data.creditAccount.code;
  if (Array.from(creditSelect.options).some(opt => opt.value.includes('|'))) {
    creditValueToSet = `${data.creditAccount.code}|${data.creditAccount.name}`;
  }
  creditSelect.value = creditValueToSet;
  updateAccountName(creditSelect, 'creditAccountName'); // Update hidden name field

  document.getElementById('receivedFrom').value = data.receivedFrom;
  document.querySelector('select[name="receiptType"]').value = data.receiptType;

  const paymentMethodSelect = document.querySelector('select[name="paymentMethod"]');
  paymentMethodSelect.value = data.paymentMethod;
  togglePaymentDetails(data.paymentMethod); // Show/hide bank details based on payment method

  if (data.bankAccount && (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque')) {
    // Assuming bankAccount field stores the value expected by the select options
    document.querySelector('select[name="bankAccount"]').value = data.bankAccount;
  }

  document.getElementById('notes').value = data.notes || '';

  // Populate transaction details
  const detailsContainer = document.getElementById('transactionDetailsContainer');
  // Clear existing dynamic detail entries before adding new ones
  detailsContainer.querySelectorAll('.transaction-detail-entry').forEach(entry => entry.remove());

  if (data.details && data.details.length > 0) {
    data.details.forEach((detail) => {
      // Pass false for clearContainerFirst as we've already cleared it
      this.addTransactionDetailEntry(detail.description, detail.amount, false);
    });
  } else {
    // Add a blank row if no details exist, ensuring clearContainerFirst is false
    this.addTransactionDetailEntry('', 0, false);
  }

  this.updateTransactionTotal(); // Recalculate total
  this.showModal = true; // Show the modal
},

        removeTransactionDetail(buttonEl) {
          const detailEntry = buttonEl.closest('.transaction-detail-entry');
          const detailRows = document.querySelectorAll('#transactionDetailsContainer .transaction-detail-entry');

          if (detailRows.length > 1 && detailEntry) {
            detailEntry.remove();
            this.updateTransactionTotal();
          } else if (detailEntry) {
            // If it's the last row, clear its fields instead of removing it
            detailEntry.querySelectorAll('input[name="transactionDetail[]"]').forEach(input => input.value = '');
            detailEntry.querySelectorAll('input[name="detailAmount[]"]').forEach(input => input.value = '0');
            this.updateTransactionTotal();
          }
        },

        addTransactionDetailEntry(description = '', amount = 0, clearContainerFirst = false) {
          const container = document.getElementById('transactionDetailsContainer');
          if (!container) {
            console.error('Transaction details container not found.');
            return;
          }

          if (clearContainerFirst) {
            container.querySelectorAll('.transaction-detail-entry').forEach(entry => entry.remove());
          }

          const templateHtml = `
                <div class="transaction-detail-entry grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-7">
                        <div class="form-floating">
                            <input type="text" name="transactionDetail[]" required placeholder=" " class="peer" value="${description}">
                            <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">รายการ <span class="text-red-500">*</span></label>
                        </div>
                    </div>
                    <div class="col-span-4">
                        <div class="form-floating relative">
                            <input type="number" step="0.01" name="detailAmount[]" required placeholder=" " class="peer pl-8" value="${amount}" oninput="updateTransactionTotal()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">฿</div>
                            <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">จำนวนเงิน <span class="text-red-500">*</span></label>
                        </div>
                    </div>
                    <div class="col-span-1 flex justify-center">
                        <button type="button" class="text-gray-400 hover:text-red-500 focus:outline-none" onclick="removeTransactionDetail(this)">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>`;

          // The "Add Item" button and "Total" section should ideally be outside the container that gets cleared,
          // or they need to be re-added if they are part of it.
          // For simplicity, let's assume they are outside or re-added if needed.
          // The addTransactionDetail button is now Alpine managed with @click.
          // The total section is static HTML.
          const addButtonElement = document.getElementById('addTransactionDetail');
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = templateHtml.trim();
          const newRow = tempDiv.firstChild;

          if (addButtonElement) {
            // Insert the new row before the "Add Item" button's PARENT or the button itself if it's structured that way.
            // If addTransactionDetail is a button that's a direct child of `container`, this works.
            // If it's wrapped, adjust accordingly. Let's assume it's a direct child or we insert before its wrapper.
            container.insertBefore(newRow, addButtonElement);
          } else {
            // Fallback: if the add button isn't found or structure is different, append to container.
            // This might place it after the total, so ensure HTML structure is robust.
            container.appendChild(newRow);
            console.log('#addTransactionDetail button not found, appending new row. Check structure.');
          }
          // Ensure oninput handlers for new amount fields also call the Alpine instance's updateTransactionTotal
          // This is handled by the oninput="updateTransactionTotal()" in the template, which calls the global helper.
          this.updateTransactionTotal(); // Recalculate total after adding a row
        },

        collectDetails() {
          const details = [];
          const detailDescriptionInputs = document.querySelectorAll('#receiptForm input[name="transactionDetail[]"]');
          const detailAmountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');

          detailDescriptionInputs.forEach((descInput, index) => {
            const amountInput = detailAmountInputs[index];
            if (descInput.value.trim() !== '' && amountInput && amountInput.value.trim() !== '') {
              details.push({
                description: descInput.value,
                amount: parseFloat(amountInput.value) || 0
              });
            }
          });
          return details;
        },

        calculateTotal() {
          const details = this.collectDetails();
          return details.reduce((total, item) => total + item.amount, 0);
        },

        autoCreationInterval: null,

        startAutoCreationInterval() {
          console.log('💡 Starting auto creation interval monitoring');
          // หยุด interval เดิม
          if (this.autoCreationInterval) {
            console.log('💡 Clearing existing interval');
            clearInterval(this.autoCreationInterval);
          }
    
          // ตรวจสอบสถานะทุก 120 วินาที (ลดเพิ่มเติมเพื่อลด API calls)
          this.autoCreationInterval = setInterval(async () => {
            console.log('⏰ [interval] Periodic status check at', new Date().toLocaleTimeString());
            // อัพเดทสถิติเท่านั้น ไม่สร้างเอง
            try {
              await this.updateDashboardStats();
            } catch (error) {
              console.log('Error in periodic status check:', error.message);
            }
          }, 120000); // ทุก 120 วินาที (2 นาที)
    
          console.log('✅ Auto creation interval monitoring started');
          // เรียกครั้งแรกทันที
          this.updateDashboardStats();
        },

        stopAutoCreationInterval() {
          if (this.autoCreationInterval) {
            clearInterval(this.autoCreationInterval);
            this.autoCreationInterval = null;
            console.log('⏹️ หยุดระบบสร้างใบสำคัญรับเงินอัตโนมัติ');
          }
        },

        scheduleAutoCreation() {
          const scheduledTime = this.autoConfig.scheduledTime; // เช่น "18:00"
          if (!scheduledTime) {
            console.warn('⚠️ ไม่ได้ตั้งเวลาสำหรับ scheduled auto creation.');
            return;
          }
          const [hours, minutes] = scheduledTime.split(':').map(Number);

          const checkTime = () => {
            const now = new Date();
            if (now.getHours() === hours && now.getMinutes() === minutes) {
              this.runAutoCreation();
              // Optionally, run only once per day or clear interval after running
            }
          };

          // ตรวจสอบทุกนาที
          // Consider clearing this interval if the schedule changes or auto creation is disabled
          setInterval(checkTime, 60000);
          console.log(`🗓️ ตั้งเวลาระบบสร้างใบสำคัญรับเงินอัตโนมัติสำหรับ ${scheduledTime}`);
        },

        // ฟังก์ชันสำหรับ Auto Creation
        async triggerAutoCreation() {
          if (this.isAutoCreating) {
            console.log('🚫 Auto creation is already running');
            return;
          }

          this.isAutoCreating = true;

          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // แสดง Loading
            const loaderId = LoadingSystem.show({
              message: 'กำลังเริ่มต้นระบบสร้างใบสำคัญรับเงินอัตโนมัติ...',
              type: 'spinner'
            });

            console.log('🚀 Starting auto creation process...');
    
            // เรียก API สร้างใบสำคัญรับเงินอัตโนมัติ
            const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                limit: 100,
                paymentMethod: 'cash',
                branchCode: branchCode
              })
            });

            LoadingSystem.hide(loaderId);

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token หมดอายุ กรุณาเข้าสู่ระบบใหม่');
              } else if (response.status === 403) {
                throw new Error('ไม่มีสิทธิ์ใช้งานระบบ Auto Creation');
              } else {
                throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || 'เกิดข้อผิดพลาดในการสร้างอัตโนมัติ');
            }

            const created = result.data.created || [];
            const failed = result.data.failed || [];
            const summary = result.data.summary || {};

            // แสดงผลลัพธ์
            const message = failed.length > 0
              ? `สร้างอัตโนมัติเสร็จสิ้น - สำเร็จ ${created.length} รายการ, ล้มเหลว ${failed.length} รายการ`
              : `สร้างอัตโนมัติสำเร็จ ${created.length} รายการ`;
    
            const type = failed.length > 0 ? 'warning' : 'success';
    
            this.showNotification(message, type);
    
            // อัพเดทข้อมูลในหน้า
            await this.loadReceipts();
            await this.updateDashboardStats();
    
            // ส่งข้อมูลไปยัง Firebase และ Socket.IO
            if (window.ReceiptVoucherConnection) {
              window.ReceiptVoucherConnection.emitReceiptVoucherCreated({
                type: 'auto_creation',
                created: created.length,
                failed: failed.length,
                summary: summary
              });
            }

            console.log('✅ Auto creation completed successfully');
            console.log('📊 Summary:', summary);
            console.log('✅ Created:', created.length, 'items');
            console.log('❌ Failed:', failed.length, 'items');

          } catch (error) {
            console.error('❌ Auto creation error:', error);
            this.showNotification(error.message, 'error');
    
            // ถ้าเป็น token expired ให้ redirect ไป login
            if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          } finally {
            this.isAutoCreating = false;
          }
        },

        // ฟังก์ชันสำหรับตรวจสอบสถานะ Auto Creation - Updated to use UI API
        async checkAutoCreationStatus() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            // ป้องกันการเรียกซ้ำเร็วเกินไป (throttling)
            const now = Date.now();
            if (this.lastAutoStatusCheck && now - this.lastAutoStatusCheck < 15000) {
              console.log('🚫 Auto status check throttled (less than 15 seconds ago)');
              return;
            }
            this.lastAutoStatusCheck = now;

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // ✅ ใช้ API endpoint เดียวกับ UI เพื่อความสอดคล้อง
            const endpoint = `/api/receipt-voucher/pending-receipts`;

            try {
              const response = await fetch(endpoint, {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                const result = await response.json();
                console.log('📊 Auto creation status from UI API:', result);
    
                if (result.success && result.data) {
                  const pendingItems = result.data || [];
    
                  // แยกประเภทตาม source
                  const posPending = pendingItems.filter(item =>
                    item.source === 'pos' || item.source === 'cash_sale'
                  ).length;
    
                  const installmentPending = pendingItems.filter(item =>
                    item.source === 'installment' || item.source === 'installment_payment'
                  ).length;
    
                  const totalPending = pendingItems.length;
    
                  // อัพเดทข้อมูลในการ์ด
                  this.summary.pendingReceiptCount = totalPending;
                  this.summary.todayAutoCreatedCount = 0; // TODO: เพิ่ม API นับรายการที่สร้างวันนี้
    
                  // อัพเดทสถานะ Auto System
                  const statusIcon = document.getElementById('autoStatusIcon');
                  const statusText = document.getElementById('autoStatusText');
    
                  if (statusIcon && statusText) {
                    if (totalPending > 0) {
                      statusIcon.innerHTML = `
                        <div class="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-amber-400 rounded-full animate-ping"></div>
                      `;
                      statusText.textContent = `รอสร้าง ${totalPending} รายการ`;
                      statusText.className = 'text-lg font-semibold text-amber-600 dark:text-amber-400';
    
                      // แสดงรายละเอียดใน tooltip
                      statusText.title = `POS: ${posPending} รายการ, ผ่อน: ${installmentPending} รายการ`;
                    } else {
                      statusIcon.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                      `;
                      statusText.textContent = 'ทำงานอัตโนมัติ';
                      statusText.className = 'text-lg font-semibold text-green-600 dark:text-green-400';
                      statusText.title = 'ไม่มีรายการรอดำเนินการ';
                    }
                  }
    
                  if (todayAutoCount) {
                    todayAutoCount.textContent = data.todayAutoCreated || 0;
                  }
    
                  console.log('✅ Auto creation status updated successfully');
                  console.log(`📊 Details: POS Pending: ${data.pendingPosReceipts}, Installment Pending: ${data.pendingInstallmentReceipts}, Total: ${data.totalPending}, Today Created: ${data.todayAutoCreated}`);
    
                  if (data.warning) {
                    console.log(`⚠️ Warning: ${data.warning}`);
                  }
    
                  return; // Success, exit function
                }
              }
            } catch (err) {
              // Network error, use default status
              console.log('❌ Auto creation status API error:', err.message);
            }
    
            // ถ้าไม่มี API ใดทำงานได้ ใช้ default status
            console.log('📊 Auto creation status API not available, using default status');
            this.updateAutoStatus(true, 'ทำงานอัตโนมัติ');
    
          } catch (error) {
            console.log('Could not check auto creation status:', error.message);
            this.updateAutoStatus(true, 'ทำงานอัตโนมัติ');
          }
        },

        // ฟังก์ชันสำหรับแสดงสถิติ Auto Creation
        async showAutoCreationStats() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // ✅ ใช้ endpoint เดียวกันกับ checkAutoCreationStatus() (ไม่มี 's')
            const response = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                const data = result.data;
    
                const modalHtml = `
                  <div id="autoStatsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4">
                      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">
                          สถิติระบบ Auto Creation
                        </h3>
                      </div>
                      <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">ใบเสร็จ POS ที่รอ:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${data.pendingPosReceipts} รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">ค่าดาวน์ที่รอ:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${data.pendingInstallmentReceipts} รายการ</span>
                        </div>
                        <div class="flex justify-between items-center border-t pt-4">
                          <span class="text-gray-600 dark:text-gray-400">รวมทั้งหมด:</span>
                          <span class="font-bold text-lg text-blue-600 dark:text-blue-400">${data.totalPending} รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">สร้างไปแล้ววันนี้:</span>
                          <span class="font-semibold text-green-600 dark:text-green-400">${data.todayAutoCreated} รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">ตรวจสอบล่าสุด:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${new Date(data.lastCheck).toLocaleTimeString('th-TH')}</span>
                        </div>
                      </div>
                      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button onclick="document.getElementById('autoStatsModal').remove()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                          ปิด
                        </button>
                      </div>
                    </div>
                  </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);
              }
            }
          } catch (error) {
            console.error('Error showing auto creation stats:', error);
            this.showNotification('ไม่สามารถดูสถิติได้', 'error');
          }
        },

        // เพิ่ม property สำหรับ Auto Creation status
        isAutoCreating: false,
        lastAutoStatusCheck: null,
        lastStatsUpdate: null,

        async runAutoCreation() {
          try {
            console.log('🤖 ตรวจสอบสถานะการสร้างอัตโนมัติ...');
            // แค่อัพเดทสถิติ ไม่สร้างเอง เพราะ Backend ทำให้แล้ว
            await this.updateDashboardStats();
            // แสดงสถานะ
            const pendingCheck = await fetch('/api/receipt-vouchers/pending-count', {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              }
            });
            if (pendingCheck.ok) {
              const result = await pendingCheck.json();
              const pending = result.data?.totalPending || 0;
              if (pending === 0) {
                this.updateAutoStatus(true, 'ทำงานอัตโนมัติ');
              } else {
                this.updateAutoStatus(true, `กำลังประมวลผล ${pending} รายการ`);
              }
            }
          } catch (error) {
            console.error('❌ Error checking status:', error);
            this.updateAutoStatus(false, 'เกิดข้อผิดพลาด');
          }
        },

        // เพิ่มฟังก์ชันอัพเดตสถานะ
        updateAutoStatus(isSuccess, message = '') {
          const statusIcon = document.getElementById('autoStatusIcon');
          const statusText = document.getElementById('autoStatusText');

          if (statusIcon && statusText) {
            if (isSuccess) {
              statusIcon.innerHTML = `
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
      `;
              statusText.textContent = message || 'ทำงานอัตโนมัติ';
              statusText.className = 'text-lg font-semibold text-green-600 dark:text-green-400';
            } else {
              statusIcon.innerHTML = `
        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
      `;
              statusText.textContent = message || 'มีข้อผิดพลาด';
              statusText.className = 'text-lg font-semibold text-red-600 dark:text-red-400';
            }
          }
        },
                async submitForm() {
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            const formElement = document.getElementById('receiptForm');
            const formData = new FormData(formElement);

            // ตรวจสอบและแปลง branch ให้เป็น string ที่ถูกต้อง
            const branchValue = String(this.currentBranch || BRANCH_CODE || '00000');
            console.log('📍 Branch value for submission:', branchValue);

            const data = {
              receiptNumber: formData.get('documentNumber'),
              receiptDate: formData.get('paymentDate'),
              receiptType: formData.get('receiptType'),
              customer: {
                name: formData.get('receivedFrom'),
                // เพิ่มข้อมูลลูกค้าอื่นๆ ตามต้องการ
              },
              paymentMethod: formData.get('paymentMethod'),
              branchCode: branchValue,
              accounts: {
                debit: {
                  code: formData.get('debitAccountCode').split('|')[0],
                  name: formData.get('debitAccountName')
                },
                credit: {
                  code: formData.get('creditAccountCode').split('|')[0],
                  name: formData.get('creditAccountName')
                }
              },
              items: this.collectDetails(),
              totalAmount: this.calculateTotal(),
              notes: formData.get('notes')
            };

            if (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque') {
              data.bankDetails = {
                bankAccount: formData.get('bankAccount'),
                reference: formData.get('transferReference') || formData.get('chequeNumber')
              };
            }

            // เพิ่ม summary ข้อมูลสำหรับ Receipt API
            data.summary = {
              subtotal: data.totalAmount,
              vatAmount: 0, // คำนวณ VAT ตามต้องการ
              totalWithTax: data.totalAmount
            };

            let url = '/api/receipt';
            let method = 'POST';

            if (this.receiptId) {
              url += `/${this.receiptId}`;
              method = 'PUT';
            }
            data.documentNumber = formData.get('documentNumber');

            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
            });

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token หมดอายุ กรุณาเข้าสู่ระบบใหม่');
              } else if (response.status === 404) {
                throw new Error('ระบบใบสำคัญรับเงินยังไม่พร้อมใช้งาน - API ไม่พบ');
              } else if (response.status === 403) {
                throw new Error('ไม่มีสิทธิ์ในการดำเนินการนี้');
              } else if (response.status >= 400 && response.status < 500) {
                const errorData = await response.json().catch(() => ({ message: 'ข้อมูลไม่ถูกต้อง' }));
                throw new Error(errorData.message || 'ข้อมูลไม่ถูกต้อง');
              } else {
                throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || 'การดำเนินการล้มเหลว');
            }

            this.showNotification(method === 'POST' ? 'สร้างใบสำคัญรับเงินสำเร็จ' : 'อัพเดทใบสำคัญรับเงินสำเร็จ', 'success');
            this.showModal = false;
            await this.loadReceipts();

          } catch (error) {
            console.error('Submit form error:', error);
            this.showNotification(error.message, 'error');
    
            // ถ้าเป็น token expired ให้ redirect ไป login
            if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        async loadReceipts() {
          console.log('🔄 กำลังโหลดข้อมูลใบสำคัญรับเงิน...');
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ กรุณาเข้าสู่ระบบใหม่');
            }

            // ✅ ใช้ Receipt Voucher API ที่ถูกต้อง
            let response;
            let apiEndpoints = [
              '/api/receipt-voucher',            // endpoint หลักที่ทำงานได้
              '/api/receipt-vouchers',           // endpoint สำรอง
              '/api/receipt-vouchers/list'       // endpoint backup
            ];

            let lastError = null;
            let foundEndpoint = null;

            for (const endpoint of apiEndpoints) {
              try {
                console.log(`🔍 ลองเรียก: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  console.log(`✅ ใช้ endpoint: ${endpoint}`);
                  break;
                } else if (response.status !== 404) {
                  // ถ้าไม่ใช่ 404 แปลว่า endpoint มีอยู่แต่มีปัญหาอื่น
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                lastError = err;
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้:`, err.message);
              }
            }

            if (!foundEndpoint) {
              throw new Error('ไม่สามารถเชื่อมต่อกับ API ได้');
            }

            const data = await response.json();
            console.log('📦 ข้อมูลที่ได้รับ:', data);

            // ✅ จัดการข้อมูลตาม Receipt API structure
            let receipts = [];
            if (data && Array.isArray(data.data)) {
              receipts = data.data;
            } else if (data && Array.isArray(data)) {
              receipts = data;
            } else if (data && data.receipts && Array.isArray(data.receipts)) {
              receipts = data.receipts;
            }

            console.log(`✅ โหลดข้อมูลสำเร็จ จำนวน: ${receipts.length} รายการ`);
    
            // ✅ Debug: แสดงข้อมูลตัวอย่างเพื่อตรวจสอบ structure
            if (receipts.length > 0) {
              console.log('🔍 Sample receipt data structure:', receipts[0]);
              console.log('🔍 Receipt keys:', Object.keys(receipts[0]));
            }

            // ✅ แปลงข้อมูลให้รองรับทั้ง Receipt API และ receipt-voucher
            this.receipts = receipts.map(receipt => {
              // ✅ เก็บข้อมูลเดิมทั้งหมด และเพิ่มเฉพาะที่จำเป็น
              const baseReceipt = {
                ...receipt, // เก็บข้อมูลต้นฉบับทั้งหมด
    
                // เพิ่ม fallback fields สำหรับการแสดงผล
                documentNumber: receipt.documentNumber || receipt.voucherNumber || receipt.receiptNumber || 'ไม่ระบุ',
                paymentDate: receipt.paymentDate || receipt.date || receipt.receiptDate || receipt.createdAt,
                totalAmount: receipt.totalAmount || receipt.summary?.totalAmount || 0,
                receivedFrom: receipt.receivedFrom || receipt.customer?.name || receipt.customerName || 'ไม่ระบุ',
                status: receipt.status || 'completed', // default status
                receiptType: receipt.receiptType || receipt.type || 'cash_sale',
    
                // สำหรับ backward compatibility
                voucherNumber: receipt.documentNumber || receipt.voucherNumber || receipt.receiptNumber || 'ไม่ระบุ',
                date: receipt.paymentDate || receipt.date || receipt.receiptDate || receipt.createdAt,
                customer: {
                  name: receipt.receivedFrom || receipt.customer?.name || receipt.customerName || 'ไม่ระบุ',
                  address: receipt.customer?.address || receipt.customerAddress || '',
                  taxId: receipt.customer?.taxId || receipt.customerTaxId || ''
                },
                note: receipt.notes || receipt.note || receipt.description || ''
              };
    
              return baseReceipt;
            });

            this.totalReceipts = this.receipts.length;

            // ✅ เพิ่มการเรียงลำดับตามวันที่ล่าสุด
            this.receipts.sort((a, b) => new Date(b.date) - new Date(a.date));

            // ✅ เพิ่มการตรวจสอบหน้าปัจจุบัน
            const maxPages = Math.ceil(this.receipts.length / this.itemsPerPage);
            if (this.currentPage > maxPages && maxPages > 0) {
              this.currentPage = 1;
            }
            this.filterByCreationType(this.currentFilter);

            // โหลดข้อมูลสรุปตามช่วงเวลาที่เลือก
            await this.loadSummaryByTimeRange();

            // โหลดข้อมูลสถิติเพิ่มเติม
            await this.updateDashboardStats();

            if (this.receipts.length === 0) {
              console.log(`✅ โหลดระบบใบสำคัญรับเงินสำเร็จ - ยังไม่มีข้อมูล`);
              this.showNotification('ระบบพร้อมใช้งาน - ยังไม่มีข้อมูลใบสำคัญรับเงิน กรุณาเพิ่มรายการใหม่', 'info');
            } else {
              console.log(`✅ โหลดใบสำคัญรับเงินสำเร็จ: ${this.receipts.length} รายการ`);
            }

          } catch (error) {
            console.error('❌ Load receipts error:', error);
    
            // แสดง error message ให้ผู้ใช้เห็น
            this.showNotification(error.message, 'error');
    
            // ล้างข้อมูลเดิม
            this.receipts = [];
            this.totalReceipts = 0;
            this.filterByCreationType(this.currentFilter);
    
            // ถ้าเป็น token expired ให้ redirect ไป login
            if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        async loadAutoConfig() {
          try {
            // ✅ ใช้ API endpoint ที่อาจทำงานได้
            const endpoints = [
              '/api/receipt-voucher/config/auto-creation',          // endpoint หลักที่คาดว่าจะทำงานได้
              '/api/receipt-vouchers/config/auto-creation',         // backup
              '/api/receiptVoucher/config/auto-creation',           // camelCase
              '/api/receiptVouchers/config/auto-creation',          // camelCase backup
              '/api/config/receipt-voucher-auto',                   // alternative
              '/api/settings/auto-receipt-creation'                 // generic
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`🔍 ลองโหลด auto config จาก: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  break;
                } else if (response.status !== 404) {
                  // ถ้าไม่ใช่ 404 อาจมี endpoint แต่มีปัญหาอื่น
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (foundEndpoint && response && response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                Object.assign(this.autoConfig, result.data);
                console.log('✅ โหลด auto config จาก API สำเร็จ');
                return;
              }
            }

            // ถ้าไม่มี API ลองโหลดจาก localStorage
            console.log('📂 Auto config API ไม่พร้อมใช้งาน ลองโหลดจาก localStorage');
            const savedConfig = localStorage.getItem('autoConfig');
            if (savedConfig) {
              Object.assign(this.autoConfig, JSON.parse(savedConfig));
              console.log('✅ โหลด auto config จาก localStorage สำเร็จ');
            } else {
              console.log('ℹ️ ใช้การตั้งค่า auto config เริ่มต้นต้องใช้');
              // ใช้ค่า default ที่มีอยู่แล้ว
            }

          } catch (error) {
            console.log('❌ Error loading auto config:', error.message);
            // ลองโหลดจาก localStorage
            const savedConfig = localStorage.getItem('autoConfig');
            if (savedConfig) {
              try {
                Object.assign(this.autoConfig, JSON.parse(savedConfig));
                console.log('📂 ใช้ auto config จาก localStorage fallback');
              } catch (parseError) {
                console.log('⚠️ Error parsing saved config, ใช้ค่า default');
              }
            }
          }
        },

        async saveAutoConfig() {
          try {
            // ✅ บันทึกผ่าน API endpoint ที่อาจทำงานได้
            const endpoints = [
              '/api/receipt-voucher/config/auto-creation',          // endpoint หลักที่คาดว่าจะทำงานได้
              '/api/receipt-vouchers/config/auto-creation',         // backup
              '/api/receiptVoucher/config/auto-creation',           // camelCase
              '/api/receiptVouchers/config/auto-creation',          // camelCase backup
              '/api/config/receipt-voucher-auto'                    // alternative
            ];

            let success = false;

            for (const endpoint of endpoints) {
              try {
                const response = await fetch(endpoint, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                  },
                  body: JSON.stringify(this.autoConfig)
                });

                if (response.ok) {
                  const result = await response.json();
                  if (result.success) {
                    console.log(`✅ บันทึก auto config ผ่าน ${endpoint} สำเร็จ`);
                    success = true;
                    break;
                  }
                } else if (response.status !== 404) {
                  // ถ้าไม่ใช่ 404 ลองอีกรอบ
                  continue;
                }
              } catch (err) {
                console.log(`❌ ไม่สามารถบันทึกผ่าน ${endpoint}`);
              }
            }

            if (success) {
              this.showNotification('บันทึกการตั้งค่าสำเร็จ', 'success');
            } else {
              // ถ้า API ไม่สำเร็จ บันทึกใน localStorage แทน
              localStorage.setItem('autoConfig', JSON.stringify(this.autoConfig));
              this.showNotification('บันทึกการตั้งค่าในเครื่องสำเร็จ (API ยังไม่พร้อม)', 'info');
            }

            this.showAutoConfigModal = false;

            // รีสตาร์ท Auto Creation ตามการตั้งค่าใหม่
            this.stopAutoCreationInterval();
            if (this.autoConfig.enabled) {
              if (this.autoConfig.timing === 'immediate') {
                this.startAutoCreationInterval();
              } else if (this.autoConfig.timing === 'scheduled') {
                this.scheduleAutoCreation();
              }
            }

          } catch (error) {
            console.log('❌ Error saving auto config:', error.message);
            // Fallback: บันทึกใน localStorage
            localStorage.setItem('autoConfig', JSON.stringify(this.autoConfig));
            this.showNotification('บันทึกการตั้งค่าในเครื่องสำเร็จ', 'warning');
            this.showAutoConfigModal = false;
          }
        },

        async submitForm() {
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            const formElement = document.getElementById('receiptForm');
            const formData = new FormData(formElement);

            // ตรวจสอบและแปลง branch ให้เป็น string ที่ถูกต้อง
            const branchValue = String(this.currentBranch || BRANCH_CODE || '00000');
            console.log('📍 Branch value for submission:', branchValue);

            const data = {
              paymentDate: formData.get('paymentDate'),
              debitAccount: {
                code: formData.get('debitAccountCode').split('|')[0],
                name: formData.get('debitAccountName')
              },
              creditAccount: {
                code: formData.get('creditAccountCode').split('|')[0],
                name: formData.get('creditAccountName')
              },
              receivedFrom: formData.get('receivedFrom'),
              receiptType: formData.get('receiptType'),
              paymentMethod: formData.get('paymentMethod'),
              details: this.collectDetails(),
              notes: formData.get('notes'),
              branch: branchValue
            };

            if (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque') {
              data.bankAccount = formData.get('bankAccount');
            }

            // ✅ ใช้ API endpoint ที่ทำงานได้จริง
            let endpoints = [
              '/api/receipt-voucher',            // endpoint หลักที่ทำงานได้
              '/api/receipt-vouchers',           // backup
              '/api/receiptVoucher',             // camelCase
              '/api/receiptVouchers'             // camelCase backup
            ];

            let url = '';
            let method = 'POST';

            if (this.receiptId) {
              endpoints = endpoints.map(ep => `${ep}/${this.receiptId}`);
              method = 'PUT';
            }
            data.documentNumber = formData.get('documentNumber');

            let response = null;
            let lastError = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`🔍 ลองส่งข้อมูลไปยัง: ${endpoint}`);
                response = await fetch(endpoint, {
                  method: method,
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(data)
                });

                if (response.status !== 404) {
                  // ถ้าไม่ใช่ 404 แสดงว่าเจอ endpoint แล้ว
                  url = endpoint;
                  break;
                }
              } catch (err) {
                lastError = err;
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (!response || response.status === 404) {
              // ถ้าไม่เจอ endpoint ใดเลย
              throw new Error('ระบบใบสำคัญรับเงินยังไม่พร้อมใช้งาน - API endpoints ไม่พบ');
            }

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token หมดอายุ กรุณาเข้าสู่ระบบใหม่');
              } else if (response.status === 403) {
                throw new Error('ไม่มีสิทธิ์ในการดำเนินการนี้');
              } else if (response.status >= 400 && response.status < 500) {
                const errorData = await response.json().catch(() => ({ message: 'ข้อมูลไม่ถูกต้อง' }));
                throw new Error(errorData.message || 'ข้อมูลไม่ถูกต้อง');
              } else {
                throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || 'การดำเนินการล้มเหลว');
            }

            this.showNotification(method === 'POST' ? '✅ สร้างใบสำคัญรับเงินสำเร็จ' : '✅ อัพเดทใบสำคัญรับเงินสำเร็จ', 'success');
            this.showModal = false;
            await this.loadReceipts();

          } catch (error) {
            console.error('Submit form error:', error);
            this.showNotification(error.message, 'error');
    
            // ถ้าเป็น token expired ให้ redirect ไป login
            if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        filterByCreationType(type = 'all') {
          this.currentFilter = type;
          this.currentPage = 1; // Reset to first page when filtering
          this.updatePagination(); // อัพเดท pagination หลังจาก filter
          this.updateTable();
          if (type === 'auto') {
            this.filteredReceipts = this.receipts.filter(r =>
              r.notes && r.notes.toLowerCase().includes('สร้างอัตโนมัติ')
            );
          } else if (type === 'manual') {
            this.filteredReceipts = this.receipts.filter(r =>
              !r.notes || !r.notes.toLowerCase().includes('สร้างอัตโนมัติ')
            );
          } else {
            this.filteredReceipts = [...this.receipts];
          }
          this.updateTable();
          // this.updateStats(); // Assuming updateStats is a method you might have for other stats
        },

        updateTable() {
          const tbody = document.getElementById('receiptTableBody');
          tbody.innerHTML = '';

          const receiptsToDisplay = this.filteredReceipts;

          if (!receiptsToDisplay || receiptsToDisplay.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500 dark:text-gray-400">ไม่พบข้อมูล${this.currentFilter !== 'all' ? ` (${this.currentFilter === 'auto' ? 'สร้างอัตโนมัติ' : 'สร้างเอง'})` : ''}</td></tr>`;
            this.updateTableFooterTotal();
            return;
          }

          const startIndex = (this.currentPage - 1) * this.itemsPerPage;
          const endIndex = startIndex + this.itemsPerPage;
          const pageReceipts = receiptsToDisplay.slice(startIndex, endIndex);

          pageReceipts.forEach(receipt => {
            const newRow = document.createElement('tr');
            newRow.className = 'receipt-item hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-800';

            // ✅ ปรับปรุงการแสดงวันที่ให้รองรับ null/undefined
            let formattedDate = 'N/A';
            if (receipt.paymentDate) {
              try {
                const paymentDate = new Date(receipt.paymentDate);
                if (!isNaN(paymentDate.getTime())) {
                  formattedDate = `${String(paymentDate.getDate()).padStart(2, '0')}/${String(paymentDate.getMonth() + 1).padStart(2, '0')}/${paymentDate.getFullYear()}`;
                }
              } catch (e) {
                console.warn('Date parsing error:', e);
                formattedDate = 'Invalid Date';
              }
            }

            // ✅ ปรับปรุงการแสดงรหัสบัญชีและชื่อบัญชี
            const accountDisplayCode = receipt.documentNumber ||
                                     receipt.debitAccount?.code ||
                                     receipt.accountCode ||
                                     receipt.receiptNumber ||
                                     'N/A';
    
            const accountDisplayName = receipt.debitAccount?.name ||
                                     receipt.creditAccount?.name ||
                                     receipt.accountName ||
                                     receipt.receivedFrom ||
                                     'N/A';

            const isAutoCreated = receipt.notes && receipt.notes.toLowerCase().includes('สร้างอัตโนมัติ');
            const autoCreatedBadge = isAutoCreated
              ? `<span class="ml-2 badge badge-info badge-xs" title="สร้างอัตโนมัติ"><i class="bi bi-robot"></i> Auto</span>`
              : '';

            // ✅ ย้ายการประกาศตัวแปรมาไว้ก่อน innerHTML
            const displayType = this.getReceiptTypeDisplay(receipt);
            const typeConfig = this.getReceiptTypeConfig(receipt.receiptType || 'cash_sale');

            newRow.innerHTML = `
      <td class="px-4 py-3 text-gray-800 dark:text-gray-200">${accountDisplayCode}${autoCreatedBadge}</td>
      <td class="px-4 py-3 text-gray-800 dark:text-gray-200">${accountDisplayName}</td>
      <td class="px-4 py-3">
        <div class="flex items-center space-x-2">
          <i class="${typeConfig.icon} ${typeConfig.color}"></i>
          <span>${displayType}</span>
        </div>
      </td>
      <td class="px-4 py-3 text-gray-600 dark:text-gray-300">${formattedDate}</td>
      <td class="px-4 py-3 text-right font-medium text-gray-900 dark:text-gray-100">฿${(receipt.totalAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      <td class="px-4 py-3 text-center">
        <span class="badge ${receipt.status === 'completed' ? 'badge-success' : receipt.status === 'cancelled' ? 'badge-error' : 'badge-warning'}">${this.getStatusText(receipt.status)}</span>
      </td>
      <td class="px-4 py-3 text-center">
  <div class="flex items-center justify-center space-x-2">
    <button class="btn-action btn-pdf" title="ดาวน์โหลด PDF">
      <i class="bi bi-file-earmark-pdf"></i>
    </button>
    <button class="btn-action btn-edit" title="แก้ไข">
      <i class="bi bi-pencil-square"></i>
    </button>
    <button class="btn-action btn-delete" title="ยกเลิก">
      <i class="bi bi-trash"></i>
    </button>
  </div>
</td>
    `;

            tbody.appendChild(newRow);

            newRow.querySelector('.btn-edit').addEventListener('click', () => {
              this.editReceipt(receipt._id);
            });

            newRow.querySelector('.btn-delete').addEventListener('click', () => {
              this.confirmDelete(receipt._id);
            });

            newRow.querySelector('.btn-pdf').addEventListener('click', () => {
  // ✅ ส่ง _id แทน documentNumber
  this.downloadPDF(receipt._id, receipt.documentNumber);
});

          });


          this.updateTableFooterTotal();
        },

        updateTableFooterTotal() {
          let total = 0;
          const receiptsToSum = this.filteredReceipts || this.receipts; // Sum based on filtered or all
          if (receiptsToSum && receiptsToSum.length > 0) {
            // Sum only non-cancelled receipts for the footer total
            total = receiptsToSum
              .filter(r => r.status !== 'cancelled')
              .reduce((sum, receipt) => sum + (receipt.totalAmount || 0), 0);
          }
          const totalElement = document.querySelector('tfoot td.receipt-total');
          if (totalElement) {
            totalElement.textContent = `฿${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          }
        },

        updateSummary(summaryDataFromLoadReceipts) {
          // This function is called after loadReceipts.
          // It should primarily update the first two cards if summaryDataFromLoadReceipts is provided.
          // The other cards (Auto Status, Pending) are updated by updateDashboardStats.

          if (!summaryDataFromLoadReceipts) {
            if (this.receipts && this.receipts.length > 0) {
              const now = new Date();
              const currentMonth = now.getMonth();
              const currentYear = now.getFullYear();

              const monthlyReceipts = this.receipts.filter(r => {
                const d = new Date(r.paymentDate);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear && r.status !== 'cancelled';
              });

              summaryDataFromLoadReceipts = {
                totalAmountMonth: monthlyReceipts.reduce((sum, r) => sum + r.totalAmount, 0),
                totalCountMonth: monthlyReceipts.length,
                // today related stats are now part of updateDashboardStats
              };
            } else {
              summaryDataFromLoadReceipts = { totalAmountMonth: 0, totalCountMonth: 0 };
            }
          }

          this.summary.totalAmountMonthFormatted = `฿${(summaryDataFromLoadReceipts.totalAmountMonth || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          this.summary.totalCountMonth = summaryDataFromLoadReceipts.totalCountMonth || 0;

          // Placeholder for comparison percentages - these would ideally come from backend or be calculated with more data
          this.summary.monthlyComparisonPercentage = summaryDataFromLoadReceipts.monthlyComparisonPercentage || 0;
          this.summary.countComparisonPercentage = summaryDataFromLoadReceipts.countComparisonPercentage || 0;

          // Call updateDashboardStats to refresh auto-creation related stats as well,
          // as loadReceipts might change the overall picture.
          this.updateDashboardStats();
        },

        // Call this method to show a notification with fallback handling
        showFallbackNotification(message, type = 'info') {
          const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500'
          };

          const notificationHtml = `
                <div id="fallbackNotification" class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight" style="animation-duration: 0.5s;">
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.closest('#fallbackNotification').remove()" class="ml-4 text-white hover:text-gray-200 focus:outline-none">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;

          // Remove existing notification
          const existing = document.getElementById('fallbackNotification');
          if (existing) existing.remove();

          // Add new notification
          document.body.insertAdjacentHTML('beforeend', notificationHtml);

          // Auto remove after 3-5 seconds
          setTimeout(() => {
            const notification = document.getElementById('fallbackNotification');
            if (notification) {
              notification.classList.remove('animate__fadeInRight');
              notification.classList.add('animate__fadeOutRight');
              setTimeout(() => notification.remove(), 500); // Wait for fadeOut animation
            }
          }, type === 'error' ? 5000 : 3000);
        },

        getStatusText(status) {
          const statuses = {
            'draft': 'แบบร่าง',
            'completed': 'สมบูรณ์',
            'cancelled': 'ยกเลิก',
            'pending': 'รอยืนยัน'
          };
    
          // Check if status is undefined or null
          if (!status || typeof status !== 'string') {
            return 'ไม่ระบุสถานะ';
          }
    
          return statuses[status] || status.charAt(0).toUpperCase() + status.slice(1);
        },



        async triggerAutoCreation() {
          try {
            this.showAutoProgressModal = true;
            this.autoProgress = { current: 0, total: 0, percentage: 0, currentItem: 'กำลังเตรียมข้อมูล...', success: 0, skipped: 0, failed: 0 };
    
            // ✅ เรียก API endpoint ที่อาจทำงานได้
            const endpoints = [
              '/api/receipt-voucher/trigger-auto-creation',          // endpoint หลักที่คาดว่าจะทำงานได้
              '/api/receipt-vouchers/trigger-auto-creation',         // backup
              '/api/receiptVoucher/trigger-auto-creation',           // camelCase
              '/api/receiptVouchers/trigger-auto-creation',          // camelCase backup
              '/api/auto-creation/receipt-vouchers',                 // alternative
              '/api/auto-creation/trigger'                           // generic
            ];

            const requestBody = {
              types: this.autoConfig.types,
              limit: 50,
              branch: String(this.currentBranch || BRANCH_CODE || '00000')
            };

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`🔍 ลองเริ่มการสร้างอัตโนมัติผ่าน: ${endpoint}`);
                response = await fetch(endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                  },
                  body: JSON.stringify(requestBody)
                });

                if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (!foundEndpoint || !response) {
              throw new Error('ฟีเจอร์สร้างอัตโนมัติยังไม่พร้อมใช้งาน - API endpoints ไม่พบ');
            }

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                // ✅ หาก API return jobId ให้ monitor progress
                if (result.data && result.data.jobId) {
                  this.monitorAutoCreationProgress(result.data.jobId);
                }
                // ✅ หาก API return ผลลัพธ์ตรงๆ (ไม่มี jobId) แสดงผลทันที
                else if (result.data && (result.data.created !== undefined || result.data.summary)) {
                  const created = result.data.created || [];
                  const failed = result.data.failed || [];
                  const summary = result.data.summary || {};
    
                  // แสดงผลลัพธ์
                  const message = failed.length > 0
                    ? `สร้างอัตโนมัติเสร็จสิ้น - สำเร็จ ${created.length} รายการ, ล้มเหลว ${failed.length} รายการ`
                    : `สร้างอัตโนมัติสำเร็จ ${created.length} รายการ`;
    
                  const type = failed.length > 0 ? 'warning' : 'success';
    
                  this.showNotification(message, type);
                  this.loadReceipts();
                  this.updateDashboardStats();
                  this.showAutoProgressModal = false;
    
                  console.log('✅ Auto creation completed:', summary);
                } else {
                  // ✅ กรณีที่มี message แต่ไม่มีโครงสร้างข้อมูลมาตรฐาน
                  this.showNotification(result.message || 'สร้างอัตโนมัติสำเร็จ', 'success');
                  this.loadReceipts();
                  this.updateDashboardStats();
                  this.showAutoProgressModal = false;
                }
              } else {
                throw new Error(result.message || 'การดำเนินการล้มเหลว');
              }
            } else if (response.status === 404) {
              throw new Error('ฟีเจอร์สร้างอัตโนมัติยังไม่พร้อมใช้งาน');
            } else {
              throw new Error('Failed to trigger auto creation');
            }
          } catch (e) {
            console.log('❌ Error triggering auto creation:', e.message);
            this.showNotification('ไม่สามารถเริ่มสร้างอัตโนมัติได้: ' + e.message, 'error');
            this.showAutoProgressModal = false;
          }
        },

        monitorAutoCreationProgress(jobId) {
          if (this.autoCreationJob) clearInterval(this.autoCreationJob);
          this.autoCreationJob = setInterval(async () => {
            try {
              const res = await fetch(`/api/receipt-voucher/auto-create/progress/${jobId}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
              });
              if (res.ok) {
                const result = await res.json();
                if (result.success && result.data) {
                  const p = result.data;
                  this.autoProgress = {
                    current: p.processed || 0,
                    total: p.total || 0,
                    percentage: p.total > 0 ? Math.round((p.processed || 0) / p.total * 100) : 0,
                    currentItem: p.currentItem || 'กำลังประมวลผล...',
                    success: p.success || 0,
                    skipped: p.skipped || 0,
                    failed: p.failed || 0
                  };
                  if (p.status === 'completed' || (p.total > 0 && p.processed >= p.total)) {
                    this.cancelAutoCreation();
                    this.showNotification(`สร้างสำเร็จ ${this.autoProgress.success} รายการ`, 'success');
                    this.loadReceipts();
                    this.updateDashboardStats();
                    setTimeout(() => this.showAutoProgressModal = false, 2000);
                  }
                }
              } else if (res.status === 404) {
                // API ไม่มีอยู่ หยุด monitoring
                this.cancelAutoCreation();
                this.showNotification('ไม่สามารถติดตามความคืบหน้าได้', 'warning');
                setTimeout(() => this.showAutoProgressModal = false, 2000);
              }
            } catch (e) {
              console.log('Error monitoring progress:', e.message);
              // ถ้าเกิด error หลายครั้ง ให้หยุด monitoring
            }
          }, 1000);
        },

        cancelAutoCreation() {
          if (this.autoCreationJob) {
            clearInterval(this.autoCreationJob);
            this.autoCreationJob = null;
          }
        },

        async viewAutoHistory() {
          try {
            const res = await fetch('/api/receipt-voucher/auto-creation-history', {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            });
            if (res.ok) {
              const result = await res.json();
              if (result.success && result.data) this.showAutoHistoryModal(result.data);
            } else if (res.status === 404) {
              this.showNotification('ฟีเจอร์ประวัติการสร้างอัตโนมัติยังไม่พร้อมใช้งาน', 'info');
            } else {
              throw new Error('Failed to fetch history');
            }
          } catch (e) {
            console.log('Error fetching auto history:', e.message);
            this.showNotification('ไม่สามารถโหลดประวัติได้', 'error');
          }
        },

        showAutoHistoryModal(historyData) {
          const modalHtml = `
              <div id="autoHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto">
                  <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-semibold">ประวัติการสร้างอัตโนมัติ</h3>
                    <button onclick="document.getElementById('autoHistoryModal').remove()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-200">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="p-4 space-y-3">${historyData.map(item => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                      <div class="flex justify-between">
                        <span>${new Date(item.createdAt).toLocaleString('th-TH')}</span>
                        <span class="badge ${item.status === 'completed' ? 'badge-success' : 'badge-warning'}">${item.status}</span>
                      </div>
                      <div class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                        สำเร็จ: ${item.success} | ข้าม: ${item.skipped} | ล้มเหลว: ${item.failed}
                      </div>
                    </div>`).join('')}</div>
                </div>
              </div>`;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
        },

        setupEnhancedSocketListeners() {
          // ใช้ global receiptVoucherSocket แทน this.socket
          if (!window.receiptVoucherSocket) {
            console.log('⚠️ receiptVoucherSocket not available for Alpine.js');
            return;
          }
    
          // Setup Socket.IO listeners for Alpine.js
          window.receiptVoucherSocket.on('autoCreationProgress', (data) => {
            console.log('📊 Alpine.js: Auto creation progress received:', data);
    
            if (this.showAutoProgressModal) {
              this.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || 'กำลังประมวลผล...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            if (this.showAutoCreateToast) {
              this.autoCreateMessage = `ประมวลผล ${data.processed || 0}/${data.total || 0}`;
              this.autoCreateProgress = this.autoProgress.percentage;
            }
          });
    
          window.receiptVoucherSocket.on('autoCreationCompleted', (data) => {
            console.log('🎉 Alpine.js: Auto creation completed:', data);
    
            this.showNotification(`สร้างอัตโนมัติสำเร็จ ${data.success} รายการ`, data.failed > 0 ? 'warning' : 'success');
            this.loadReceipts();
            this.updateDashboardStats();
    
            if (this.showAutoProgressModal) {
              setTimeout(() => {
                this.showAutoProgressModal = false;
                if (typeof this.cancelAutoCreation === 'function') {
                this.cancelAutoCreation();
                }
              }, 2000);
            }
          });
    
          console.log('🎯 Alpine.js Socket.IO listeners setup completed');
        },

        // ตรวจสอบการตั้งค่า Auto Creation ที่ Backend
        async checkBackendAutoConfig() {
          try {
            // ✅ ไม่เรียก API ที่ไม่มีอยู่ ใช้การตั้งค่า default แทน
            console.log('📊 Using local Auto Config (backend API not available)');
    
            // ใช้การตั้งค่าจาก local autoConfig ที่โหลดมาจาก loadAutoConfig()
            if (this.autoConfig.enabled) {
              console.log('✅ Local Auto Creation: ENABLED');
              this.updateAutoStatus(true, 'ทำงานอัตโนมัติ');
            } else {
              console.log('⚠️ Local Auto Creation: DISABLED');
              this.updateAutoStatus(false, 'ปิดใช้งาน');
            }

          } catch (error) {
            console.log('Error in checkBackendAutoConfig, using defaults:', error.message);
            // ใช้ค่า default
            this.updateAutoStatus(true, 'ทำงานอัตโนมัติ');
          }
        },

        // Missing methods that are referenced in the template
        showNotification(message, type = 'success') {
          this.notification.message = message;
          this.notification.type = type;
          this.notification.show = true;
    
          // Auto hide after 3 seconds
          setTimeout(() => {
            this.notification.show = false;
          }, type === 'error' ? 5000 : 3000);
        },

        openAddReceiptModal() {
          this.receiptId = null;
          this.showModal = true;
    
          // Reset form
          const form = document.getElementById('receiptForm');
          if (form) form.reset();
    
          // Set default date
          const dateInput = document.getElementById('paymentDate');
          if (dateInput) {
            dateInput.value = new Date().toISOString().substr(0, 10);
          }
    
          // Generate new document ID
          const docInput = document.getElementById('documentNumber');
          if (docInput) {
            docInput.value = this.generateDocumentId();
          }
        },

        generateDocumentId() {
          const now = new Date();
          const year = now.getFullYear().toString().substr(-2);
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
          return `RV${year}${month}${day}${time}`;
        },

        confirmDelete(id) {
          this.receiptIdToDelete = id;
          this.showDeleteModal = true;
        },

        async deleteReceipt() {
          if (!this.receiptIdToDelete) return;
    
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            const endpoints = [
              `/api/receipt/${this.receiptIdToDelete}`,          // Receipt API หลัก
              `/api/receipt-voucher/${this.receiptIdToDelete}`,
              `/api/receipt-vouchers/${this.receiptIdToDelete}`,
              `/api/receiptVoucher/${this.receiptIdToDelete}`,
              `/api/receiptVouchers/${this.receiptIdToDelete}`
            ];

            let response = null;
            for (const endpoint of endpoints) {
              try {
                response = await fetch(endpoint, {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });
                if (response.status !== 404) break;
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (!response || response.status === 404) {
              throw new Error('ไม่พบระบบลบใบสำคัญรับเงิน');
            }

            if (response.ok) {
              this.showNotification('ลบรายการสำเร็จ', 'success');
              await this.loadReceipts();
            } else {
              throw new Error('ไม่สามารถลบรายการได้');
            }
          } catch (error) {
            console.error('Delete error:', error);
            this.showNotification(error.message, 'error');
          } finally {
            this.showDeleteModal = false;
            this.receiptIdToDelete = null;
          }
        },

        async downloadPDF(receiptId, documentNumber) {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            const endpoints = [
              `/api/receipt-voucher/${receiptId}/pdf`,
              `/api/receipt-vouchers/${receiptId}/pdf`,
              `/api/receiptVoucher/${receiptId}/pdf`,
              `/api/receiptVouchers/${receiptId}/pdf`
            ];

            let response = null;
            for (const endpoint of endpoints) {
              try {
                response = await fetch(endpoint, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status !== 404) break;
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (!response || response.status === 404) {
              throw new Error('ฟีเจอร์ดาวน์โหลด PDF ยังไม่พร้อมใช้งาน');
            }

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${documentNumber || receiptId}.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);
              this.showNotification('ดาวน์โหลด PDF สำเร็จ', 'success');
            } else {
              throw new Error('ไม่สามารถดาวน์โหลด PDF ได้');
            }
          } catch (error) {
            console.error('Download PDF error:', error);
            this.showNotification(error.message, 'warning');
          }
        },

        updateTransactionTotal() {
          const amountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');
          let total = 0;
          amountInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
          });
          const totalElement = document.getElementById('transactionTotal');
          if (totalElement) {
            totalElement.textContent = `฿${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          }
        },

        updatePagination() {
          this.totalReceipts = this.filteredReceipts.length;
          this.totalPages = Math.ceil(this.totalReceipts / this.itemsPerPage);
    
          if (this.currentPage > this.totalPages && this.totalPages > 0) {
            this.currentPage = 1;
          }
    
          this.paginationStart = Math.min((this.currentPage - 1) * this.itemsPerPage + 1, this.totalReceipts);
          this.paginationEnd = Math.min(this.currentPage * this.itemsPerPage, this.totalReceipts);
    
          // Update pagination buttons
          this.updatePaginationButtons();
        },

        updatePaginationButtons() {
          const container = document.getElementById('paginationButtons');
          if (!container) return;
    
          container.innerHTML = '';
    
          // Previous button
          if (this.currentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded mr-1';
            prevBtn.textContent = '‹';
            prevBtn.onclick = () => {
              this.currentPage--;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(prevBtn);
          }
    
          // Page numbers
          const startPage = Math.max(1, this.currentPage - 2);
          const endPage = Math.min(this.totalPages, this.currentPage + 2);
    
          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `px-3 py-1 text-sm rounded mr-1 ${i === this.currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => {
              this.currentPage = i;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(pageBtn);
          }
    
          // Next button
          if (this.currentPage < this.totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.className = 'px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded mr-1';
            nextBtn.textContent = '›';
            nextBtn.onclick = () => {
              this.currentPage++;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(nextBtn);
          }
        },

        async updateDashboardStats() {
          try {
            // ป้องกันการเรียกซ้ำเร็วเกินไป (throttling)
            const now = Date.now();
            if (this.lastStatsUpdate && now - this.lastStatsUpdate < 10000) {
              console.log('🚫 Stats update throttled (less than 10 seconds ago)');
              return;
            }
            this.lastStatsUpdate = now;
    
            console.log('📊 Updating dashboard stats...');
    
            // Update today's auto created count
            const today = new Date().toISOString().split('T')[0];
            const todayAutoCount = this.receipts.filter(r => {
              const receiptDate = new Date(r.paymentDate).toISOString().split('T')[0];
              return receiptDate === today && r.notes && r.notes.toLowerCase().includes('สร้างอัตโนมัติ');
            }).length;
    
            this.summary.todayAutoCreatedCount = todayAutoCount;
            console.log('📊 Today auto created count:', todayAutoCount);
    
            // ✅ ใช้ API endpoint เดียวกับ Modal (ไม่ส่ง branchCode)
            await this.updatePendingReceiptsCount();
    
            console.log('📊 Dashboard stats updated. Pending count:', this.summary.pendingReceiptCount);
    
          } catch (error) {
            console.log('Error updating dashboard stats:', error.message);
          }
        },

        async updatePendingReceiptsCount() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              this.summary.pendingReceiptCount = 0;
              return;
            }

            // ✅ ใช้ API endpoint เดียวกับ Modal (ไม่ส่ง branchCode)
            const endpoints = [
              '/api/receipt-voucher/pending-receipts',
              '/api/receipt-vouchers/pending-receipts'
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`🔍 ลองดึง pending receipts จาก: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  break;
                } else if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            if (foundEndpoint && response && response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                this.summary.pendingReceiptCount = result.data.length;
                console.log(`📊 Found ${result.data.length} pending receipts for voucher creation`);
                return;
              }
            }

            // ถ้าไม่มี API ใดทำงานได้ ใช้ค่าเริ่มต้น
            console.log('📊 No pending receipts API available, using default value 0');
            this.summary.pendingReceiptCount = 0;

          } catch (error) {
            console.log('Could not update pending receipts count:', error.message);
            this.summary.pendingReceiptCount = 0;
          }
        },

        async loadSummaryByTimeRange() {
          try {
            const now = new Date();
            let startDate, endDate;
    
            // Calculate date ranges based on timeRange settings
            if (this.timeRange.amount === 'month') {
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (this.timeRange.amount === 'week') {
              startDate = new Date(now.setDate(now.getDate() - now.getDay()));
              endDate = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            } else { // today
              startDate = new Date(now.setHours(0, 0, 0, 0));
              endDate = new Date(now.setHours(23, 59, 59, 999));
            }
    
            // Filter receipts by date range
            const rangeReceipts = this.receipts.filter(r => {
              const receiptDate = new Date(r.paymentDate);
              return receiptDate >= startDate && receiptDate <= endDate && r.status !== 'cancelled';
            });
    
            // Calculate totals
            const totalAmount = rangeReceipts.reduce((sum, r) => sum + (r.totalAmount || 0), 0);
            const totalCount = rangeReceipts.length;
    
            // Update summary
            this.summary.totalAmountFormatted = `฿${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            this.summary.totalCount = totalCount;
    
          } catch (error) {
            console.log('Error loading summary by time range:', error.message);
          }
        },

        changeTimeRange(type) {
          // Cycle through time ranges: today -> week -> month
          const ranges = ['today', 'week', 'month'];
          const texts = ['วันนี้', 'สัปดาห์นี้', 'เดือนนี้'];
    
          const currentIndex = ranges.indexOf(this.timeRange[type]);
          const nextIndex = (currentIndex + 1) % ranges.length;
    
          this.timeRange[type] = ranges[nextIndex];
          this.timeRangeText[type] = texts[nextIndex];
    
          // Reload summary with new time range
          this.loadSummaryByTimeRange();
        },

        async checkPendingItems() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
            }

            // แสดง loading
            let loaderId = LoadingSystem.show({
              message: 'กำลังโหลดรายการใบเสร็จที่รอดำเนินการ...',
              type: 'spinner'
            });

            // ✅ เรียก API เพื่อดึงรายการใบเสร็จที่ยังไม่มีใบสำคัญรับเงิน
            const endpoints = [
              '/api/receipt-voucher/pending-receipts',
              '/api/receipt-vouchers/pending-receipts'
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`🔍 ลองดึงรายการรอดำเนินการจาก: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
              }
            }

            LoadingSystem.hide(loaderId);

            if (!foundEndpoint || !response) {
              throw new Error('ไม่พบระบบดึงรายการใบเสร็จ - API endpoints ไม่พร้อมใช้งาน');
            }

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token หมดอายุ กรุณาเข้าสู่ระบบใหม่');
              } else {
                throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || 'API ส่งข้อมูลไม่ถูกต้อง');
            }

            const pendingReceipts = result.data || [];
    
            // แสดง modal พร้อมรายการใบเสร็จ
            this.showPendingReceiptsModal(pendingReceipts);

          } catch (error) {
            console.error('Error checking pending receipts:', error);
            this.showNotification(error.message, 'error');
    
            // ถ้าเป็น token expired ให้ redirect ไป login
            if (error.message.includes('Token หมดอายุ') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },

        showPendingReceiptsModal(pendingReceipts) {
          const hasReceipts = pendingReceipts && pendingReceipts.length > 0;
    
          let tableContent = '';
          if (hasReceipts) {
            tableContent = `
              <div class="overflow-x-auto">
                <table class="w-full table-auto">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">เลขที่ใบเสร็จ</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">วันที่</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">ลูกค้า</th>
                      <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 dark:text-gray-300">จำนวนเงิน</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">ประเภท</th>
                      <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 dark:text-gray-300">จัดการ</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            pendingReceipts.forEach(receipt => {
              const receiptDate = new Date(receipt.saleDate || receipt.createdAt);
              const formattedDate = receiptDate.toLocaleDateString('th-TH');
              const amount = receipt.totalAmount || receipt.netAmount || 0;
              const customerName = receipt.customerName || receipt.customer?.name || 'ลูกค้าทั่วไป';
              const receiptType = this.getReceiptSourceDisplay(receipt.source);

              tableContent += `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                    ${receipt.receiptNumber || receipt.documentNumber || receipt._id}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                    ${formattedDate}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                    ${customerName}
                  </td>
                  <td class="px-4 py-3 text-sm text-right font-medium text-gray-900 dark:text-gray-100">
                    ฿${amount.toLocaleString('th-TH', { minimumFractionDigits: 2 })}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                      ${receiptType}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <button 
                      onclick="createReceiptVoucherFromReceipt('${receipt._id}', '${receipt.receiptNumber || receipt.documentNumber}', ${amount}, '${customerName.replace(/'/g, "\\'")}', '${receipt.source || 'pos'}')"
                      class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
                      title="สร้างใบสำคัญรับเงินจากใบเสร็จนี้">
                      <i class="bi bi-plus-circle mr-1"></i>
                      สร้าง
                    </button>
                  </td>
                </tr>
              `;
            });

            tableContent += `
                  </tbody>
                </table>
              </div>
            `;
          } else {
            tableContent = `
              <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                <i class="bi bi-check-circle text-5xl mb-4 text-green-500"></i>
                <h3 class="text-lg font-medium mb-2">ไม่มีรายการที่รอดำเนินการ</h3>
                <p class="text-sm">ใบเสร็จรับเงิน/ใบกำกับภาษีทั้งหมดมีใบสำคัญรับเงินแล้ว</p>
              </div>
            `;
          }

          const modalHtml = `
            <div id="pendingItemsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
              <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-6xl w-full mx-4 max-h-[85vh] overflow-hidden">
                
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                  <div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
                      ใบเสร็จรับเงิน/ใบกำกับภาษีที่รอสร้างใบสำคัญรับเงิน
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                      ${hasReceipts ? `พบ ${pendingReceipts.length} รายการที่ยังไม่มีใบสำคัญรับเงิน` : 'ไม่มีรายการที่รอดำเนินการ'}
                    </p>
                  </div>
                  <button onclick="document.getElementById('pendingItemsModal').remove()" 
                          class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                    <i class="bi bi-x-lg text-xl"></i>
                  </button>
                </div>

                <!-- Content -->
                <div class="overflow-y-auto max-h-[60vh] p-6">
                  ${tableContent}
                </div>

                <!-- Footer -->
                ${hasReceipts ? `
                  <div class="flex justify-between items-center p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      รวม ${pendingReceipts.length} รายการ • 
                      ยอดรวม ฿${pendingReceipts.reduce((sum, r) => sum + (r.totalAmount || r.netAmount || 0), 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}
                    </div>
                    <div class="flex space-x-3">
                      <button onclick="document.getElementById('pendingItemsModal').remove()" 
                              class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                        ปิด
                      </button>
                      <button onclick="createBatchReceiptVouchersFromReceipts()" 
                              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition-all focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="bi bi-stack mr-2"></i>สร้างทั้งหมด
                      </button>
                    </div>
                  </div>
                ` : `
                  <div class="flex justify-end p-6 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="document.getElementById('pendingItemsModal').remove()" 
                            class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                      ปิด
                    </button>
                  </div>
                `}

              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        },

        getReceiptSourceDisplay(source) {
          const sourceMap = {
            'pos': 'POS/ขายหน้าร้าน',
            'frontstore': 'ขายหน้าร้าน',
            'cash_sale': 'ขายสด',
            'credit_sale': 'ขายเชื่อ',
            'installment': 'ขายผ่อน',
            'installment_down_payment': 'ค่าดาวน์ผ่อน',
            'service': 'บริการ',
            'online': 'ขายออนไลน์',
            'wholesale': 'ขายส่ง',
            'branch_stock_history': 'ประวัติสต็อก'
          };
          return sourceMap[source] || 'ขายสินค้า';
        },

                 // Initialize methods
        async init() {
          try {
            // Load branch info first and set current branch
            const branchInfo = await loadBranchInfo();
            if (branchInfo) {
              this.currentBranch = branchInfo._id;
            }
    
            // Load chart of accounts
            await this.loadChartOfAccounts();
    
            // Load auto config
            await this.loadAutoConfig();
    
            // Load receipts
            await this.loadReceipts();
    
            // Setup auto creation if enabled
            await this.checkBackendAutoConfig();
            if (this.autoConfig.enabled && this.autoConfig.timing === 'immediate') {
              this.startAutoCreationInterval();
            }
    
            console.log('✅ Receipt Voucher System initialized successfully');
    
          } catch (error) {
            console.error('❌ Error initializing receipt voucher system:', error);
            this.showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message, 'error');
          }
        },

        async loadChartOfAccounts() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            // Load debit accounts (cash, bank accounts)
            this.debitAccounts = [
              { code: '11101', name: 'เงินสด' },
              { code: '11201', name: 'บัญชีเงินฝากธนาคาร' },
              { code: '11202', name: 'บัญชีออมทรัพย์' }
            ];

            // Load credit accounts (revenue, liability accounts)
            this.creditAccounts = [
              { code: '41101', name: 'รายได้จากการขาย' },
              { code: '41201', name: 'รายได้จากบริการ' },
              { code: '21101', name: 'เจ้าหนี้การค้า' },
              { code: '21201', name: 'เงินรับล่วงหน้า' }
            ];

          } catch (error) {
            console.log('Error loading chart of accounts:', error.message);
            // Use default accounts if loading fails
            this.debitAccounts = [{ code: '11101', name: 'เงินสด' }];
            this.creditAccounts = [{ code: '41101', name: 'รายได้จากการขาย' }];
          }
        }
      }));
    });


    // ✅ เพิ่ม utility function สำหรับการเรียก API แบบ fallback
    window.apiUtils = {
      async callMultipleEndpoints(endpoints, options = {}) {
        const { method = 'GET', headers = {}, body = null, description = 'API call' } = options;
    
        let response = null;
        let foundEndpoint = null;
        let lastError = null;

        for (const endpoint of endpoints) {
          try {
            console.log(`🔍 ลอง${description}จาก: ${endpoint}`);
    
            const fetchOptions = { method, headers };
            if (body && method !== 'GET') {
              fetchOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
            }
    
            response = await fetch(endpoint, fetchOptions);

            if (response.status !== 404) {
              foundEndpoint = endpoint;
              console.log(`✅ สำเร็จ${description}จาก: ${endpoint}`);
              break;
            }
          } catch (err) {
            lastError = err;
            console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้:`, err.message);
          }
        }

        return { response, foundEndpoint, lastError };
      }
    };

    // Global function for removing transaction details (for onclick handler)
    function removeTransactionDetail(button) { // Renamed from app.removeTransactionDetail for global onclick
      const alpineInstance = document.querySelector('[x-data="app"]').__x;
      if (alpineInstance) {
        alpineInstance.removeTransactionDetail(button);
      }
    }

    // Global function for updating transaction total (for oninput handler)
    function updateTransactionTotal() {
      const alpineInstance = document.querySelector('[x-data="app"]').__x;
      if (alpineInstance && typeof alpineInstance.updateTransactionTotal === 'function') { // Check if method exists
        alpineInstance.updateTransactionTotal();
      } else { // Fallback if Alpine not ready or direct call, or method not on instance
        const amountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');
        let total = 0;
        amountInputs.forEach(input => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        const totalElement = document.getElementById('transactionTotal');
        if (totalElement) {
          totalElement.textContent = `฿${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
      }
    }

    function togglePaymentDetails(paymentMethodValue) {
      const bankDetailsDiv = document.getElementById('bankDetails');
      if (!bankDetailsDiv) return;
      if (paymentMethodValue === 'transfer' || paymentMethodValue === 'cheque') {
        bankDetailsDiv.style.display = 'grid'; // Assuming it's a grid
      } else {
        bankDetailsDiv.style.display = 'none';
      }
    }


    function updateAccountName(selectElement, hiddenInputId) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const hiddenInput = document.getElementById(hiddenInputId);
      if (selectedOption && selectedOption.value && hiddenInput) {
        const parts = selectedOption.value.split('|');
        if (parts.length > 1) {
          hiddenInput.value = parts[1]; // Name is after |
        } else {
          // Fallback: try to parse from text like "CODE - NAME"
          const textParts = selectedOption.text.split(' - ');
          hiddenInput.value = textParts.length > 1 ? textParts[1] : selectedOption.text;
        }
      } else if (hiddenInput) {
        hiddenInput.value = '';
      }
    }

    // ==================== SYNC INTEGRATION FUNCTIONS ====================
    
    /**
     * สร้างใบสำคัญรับเงินจากใบเสร็จที่ sync มาจากระบบอื่น
     */
    async function createReceiptVoucherFromReceipt(receiptId, receiptNumber, amount, customerName, source) {
      try {
        console.log('🧾 Creating receipt voucher from synced receipt:', {
          receiptId, receiptNumber, amount, customerName, source
        });

        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
        }

        // แสดง loading
        let loaderId = LoadingSystem.show({
          message: `กำลังสร้างใบสำคัญรับเงินจาก${getSourceDisplayName(source)}...`,
          type: 'spinner'
        });

        // เตรียมข้อมูล sync สำหรับใบสำคัญรับเงิน
        const receiptVoucherData = {
          // Sync API fields
          source: source,
          sourceId: receiptId,
          documentNumber: `RV-AUTO-${receiptNumber}-${Date.now()}`,
          customerName: customerName,
          totalAmount: amount,
          paymentMethod: getDefaultPaymentMethod(source),
          description: `รับเงินจาก${getSourceDisplayName(source)} ${receiptNumber}`,
          notes: `สร้างอัตโนมัติจาก${getSourceDisplayName(source)} ${receiptNumber}`,
    
          // Additional metadata
          metadata: {
            sourceReceiptNumber: receiptNumber,
            autoGenerated: true,
            createdBy: 'manual_sync_system',
            originalReceiptId: receiptId
          }
        };

        // ส่งไปยัง Sync API
        const response = await fetch('/api/receipt-vouchers/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(receiptVoucherData)
        });

        LoadingSystem.hide(loaderId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`ไม่สามารถสร้างใบสำคัญรับเงินได้: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
    
        if (result.success) {
          console.log('✅ Receipt voucher created successfully:', result.data.documentNumber);
    
          // แสดงการแจ้งเตือนสำเร็จ
          if (window.showToast) {
            window.showToast(
              `💰 สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`,
              'success',
              'สำเร็จ',
              4000
            );
          }

          // รีเฟรชข้อมูล
          const alpineInstance = document.querySelector('[x-data="app"]').__x;
          if (alpineInstance && alpineInstance.loadReceipts) {
            alpineInstance.loadReceipts();
          }

          // ปิด modal และรีเฟรช pending list
          document.getElementById('pendingItemsModal')?.remove();
          if (alpineInstance && alpineInstance.checkPendingItems) {
            setTimeout(() => alpineInstance.checkPendingItems(), 1000);
          }

          return result.data;
        } else {
          throw new Error(result.message || 'Failed to create receipt voucher');
        }

      } catch (error) {
        console.error('❌ Error creating receipt voucher from receipt:', error);
    
        if (window.showToast) {
          window.showToast(
            `⚠️ ไม่สามารถสร้างใบสำคัญรับเงินได้: ${error.message}`,
            'error',
            'เกิดข้อผิดพลาด',
            6000
          );
        }
    
        throw error;
      }
    }

    /**
     * สร้างใบสำคัญรับเงินแบบกลุ่มจากหลายใบเสร็จ
     */
    async function createBatchReceiptVouchersFromReceipts() {
      try {
        console.log('🧾 Creating batch receipt vouchers...');

        const modal = document.getElementById('pendingItemsModal');
        if (!modal) return;

        // ดึงข้อมูลทั้งหมดจาก modal (สมมติว่าเก็บไว้ในข้อมูลของ modal)
        const alpineInstance = document.querySelector('[x-data="app"]').__x;
        if (!alpineInstance) return;

        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
        }

        // ดึงรายการ pending receipts ใหม่
        const endpoints = [
          '/api/receipt-vouchers/pending-receipts',
          '/api/receipt-voucher/pending-receipts',
          '/api/pos/receipts/pending-vouchers'
        ];

        const { response, foundEndpoint } = await window.apiUtils.callMultipleEndpoints(
          endpoints,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            description: 'ดึงรายการสำหรับสร้างแบบกลุ่ม'
          }
        );

        if (!response || !response.ok) {
          throw new Error('ไม่สามารถดึงรายการใบเสร็จได้');
        }

        const result = await response.json();
        const pendingReceipts = result.data || [];

        if (pendingReceipts.length === 0) {
          if (window.showToast) {
            window.showToast('ไม่มีรายการที่ต้องสร้างใบสำคัญรับเงิน', 'info', 'แจ้งเตือน');
          }
          return;
        }

        // แสดง loading
        let loaderId = LoadingSystem.show({
          message: `กำลังสร้างใบสำคัญรับเงิน ${pendingReceipts.length} รายการ...`,
          type: 'spinner',
          showProgress: true
        });

        let successCount = 0;
        let errorCount = 0;
        const errors = [];

        // สร้างใบสำคัญรับเงินทีละรายการ
        for (let i = 0; i < pendingReceipts.length; i++) {
          const receipt = pendingReceipts[i];
    
          try {
            // อัพเดท progress
            const progress = ((i + 1) / pendingReceipts.length) * 100;
            LoadingSystem.updateProgress(loaderId, progress);
            LoadingSystem.updateMessage(loaderId,
              `กำลังสร้างใบสำคัญรับเงิน ${i + 1}/${pendingReceipts.length}...`,
              `${receipt.receiptNumber || receipt.documentNumber || receipt._id}`
            );

            await createReceiptVoucherFromReceipt(
              receipt._id,
              receipt.receiptNumber || receipt.documentNumber || receipt._id,
              receipt.totalAmount || receipt.netAmount || 0,
              receipt.customerName || receipt.customer?.name || 'ลูกค้าทั่วไป',
              receipt.source || 'pos'
            );

            successCount++;
    
            // หน่วงเวลาเล็กน้อยเพื่อไม่ให้เซิร์ฟเวอร์ล้น
            await new Promise(resolve => setTimeout(resolve, 500));

          } catch (error) {
            console.error(`❌ Error creating receipt voucher for ${receipt.receiptNumber}:`, error);
            errorCount++;
            errors.push({
              receiptNumber: receipt.receiptNumber || receipt._id,
              error: error.message
            });
          }
        }

        LoadingSystem.hide(loaderId);

        // แสดงผลสรุป
        const message = `สร้างใบสำคัญรับเงินสำเร็จ ${successCount} รายการ` +
                       (errorCount > 0 ? `, ล้มเหลว ${errorCount} รายการ` : '');
    
        if (window.showToast) {
          window.showToast(
            message,
            errorCount > 0 ? 'warning' : 'success',
            'สรุปผลการสร้าง',
            6000
          );
        }

        // รีเฟรชข้อมูล
        if (alpineInstance && alpineInstance.loadReceipts) {
          alpineInstance.loadReceipts();
        }

        // ปิด modal
        document.getElementById('pendingItemsModal')?.remove();

        // แสดงรายละเอียด error หากมี
        if (errors.length > 0) {
          console.warn('Batch creation errors:', errors);
        }

      } catch (error) {
        console.error('❌ Error in batch receipt voucher creation:', error);
    
        if (window.showToast) {
          window.showToast(
            `⚠️ ไม่สามารถสร้างใบสำคัญรับเงินแบบกลุ่มได้: ${error.message}`,
            'error',
            'เกิดข้อผิดพลาด',
            6000
          );
        }
      }
    }

    // Helper functions สำหรับการ mapping ข้อมูลตาม source
    function getSourceDisplayName(source) {
      const nameMap = {
        'pos': 'ระบบ POS',
        'frontstore': 'ระบบขายหน้าร้าน',
        'installment': 'ระบบขายผ่อน',
        'cash_sale': 'ระบบขายสด',
        'branch_stock_history': 'ประวัติสต็อก'
      };
      return nameMap[source] || 'ระบบขาย';
    }

    function getSourceDebitAccount(source) {
      // ส่วนใหญ่จะรับเงินสด หรือเงินในธนาคาร
      return { code: '11101', name: 'เงินสด' };
    }

    function getSourceCreditAccount(source) {
      const accountMap = {
        'installment': { code: '41102', name: 'รายได้จากการขายผ่อน' },
        'installment_down_payment': { code: '41102', name: 'รายได้จากการขายผ่อน' },
        'frontstore': { code: '41101', name: 'รายได้จากการขาย' },
        'pos': { code: '41101', name: 'รายได้จากการขาย' },
        'cash_sale': { code: '41101', name: 'รายได้จากการขาย' }
      };
      return accountMap[source] || { code: '41101', name: 'รายได้จากการขาย' };
    }

    function getReceiptType(source) {
      const typeMap = {
        'installment': 'installment_down_payment',
        'installment_down_payment': 'installment_down_payment',
        'frontstore': 'sale',
        'pos': 'sale',
        'cash_sale': 'sale'
      };
      return typeMap[source] || 'sale';
    }

    function getDefaultPaymentMethod(source) {
      // ส่วนใหญ่จะเป็นเงินสด ยกเว้นระบบ POS ที่อาจมีวิธีอื่น
      return 'cash';
    }

    // Add x-cloak style to hide elements before Alpine initializes
    document.head.insertAdjacentHTML('beforeend', `
        <style>
          [x-cloak] { display: none !important; }
          
          /* Custom button styles */
          .btn-action {
            @apply w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200;
          }
          
          .btn-pdf {
            @apply text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30;
          }
          
          .btn-edit {
            @apply text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30;
          }
          
          .btn-delete {
            @apply text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30;
          }
          
          /* Receipt table styles */
          .receipt-table {
            @apply w-full table-auto;
          }
          
          .receipt-table th {
            @apply text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50;
          }
          
          .receipt-table td {
            @apply text-sm;
          }
          
          /* Badge styles */
          .badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
          }
          
          .badge-success {
            @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400;
          }
          
          .badge-warning {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400;
          }
          
          .badge-error {
            @apply bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400;
          }
          
          .badge-info {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400;
          }
          
          .badge-xs {
            @apply text-xs px-1 py-0.5;
          }
          
          .badge-sm {
            @apply text-sm px-2 py-1;
          }
          
          /* Form floating styles */
          .form-group {
            @apply relative mb-4;
          }
          
          .form-floating {
            @apply relative;
          }
          
          .form-floating input,
          .form-floating select,
          .form-floating textarea {
            @apply w-full px-3 pt-6 pb-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors;
          }
          
          .form-floating label {
            @apply absolute left-3 top-2 text-sm transition-all duration-200 pointer-events-none;
          }
          
          .form-floating input:focus ~ label,
          .form-floating input:not(:placeholder-shown) ~ label,
          .form-floating select:focus ~ label,
          .form-floating select:not([value=""]) ~ label,
          .form-floating .peer:focus ~ label,
          .form-floating .peer:not(:placeholder-shown) ~ label {
            @apply text-xs top-1 text-blue-600 dark:text-blue-400;
          }
          
          /* Animation classes */
          .slide-in {
            animation: slideIn 0.5s ease-out forwards;
          }
          
          .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
          }
          
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          @keyframes fadeIn {
            from {
              opacity: 0;
            }
            to {
              opacity: 1;
            }
          }
          
          /* Receipt form specific styles */
          .receipt-form input[type="text"],
          .receipt-form input[type="number"],
          .receipt-form input[type="date"],
          .receipt-form select,
          .receipt-form textarea {
            @apply transition-all duration-200;
          }
          
          .receipt-form input:focus,
          .receipt-form select:focus,
          .receipt-form textarea:focus {
            @apply ring-2 ring-blue-500 border-blue-500;
          }
          
          /* Pending receipts modal styles */
          .pending-receipts-table {
            @apply w-full table-auto;
          }
          
          .pending-receipts-table th {
            @apply text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700;
          }
          
          .pending-receipts-table td {
            @apply text-sm;
          }
          
          .pending-receipts-table tr:hover {
            @apply bg-gray-50 dark:bg-gray-700;
          }
          
          /* Receipt source badge */
          .receipt-source-badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
          }
          
          .receipt-source-badge.pos {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400;
          }
          
          .receipt-source-badge.installment {
            @apply bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400;
          }
          
          .receipt-source-badge.service {
            @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400;
          }
          
          /* Create button animation */
          .create-voucher-btn {
            @apply transition-all duration-200 transform hover:scale-105;
          }
          
          .create-voucher-btn:hover {
            @apply shadow-lg;
          }
          
          .create-voucher-btn:disabled {
            @apply opacity-60 cursor-not-allowed transform-none;
          }
          
          /* Pending count badge animation */
          .pending-count-badge {
            @apply animate-pulse;
            animation-duration: 1.5s;
          }
          
          /* Receipt modal scrollbar */
          .receipt-modal-content::-webkit-scrollbar {
            width: 6px;
          }
          
          .receipt-modal-content::-webkit-scrollbar-track {
            @apply bg-gray-100 dark:bg-gray-700;
          }
          
          .receipt-modal-content::-webkit-scrollbar-thumb {
            @apply bg-gray-300 dark:bg-gray-600 rounded-full;
          }
          
          .receipt-modal-content::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-400 dark:bg-gray-500;
          }
        </style>
      `);

    // Load employee data (in real app, this would be from an API)
    window.onload = async function () {
      try {
        // document.getElementById('employeeName').textContent = 'สมชาย ใจดี'; // Now handled by loadEmployeeProfile
        // document.getElementById('employeePhoto').src = 'https://randomuser.me/api/portraits/men/32.jpg'; // Now handled by loadEmployeeProfile

        // Alpine init should handle this now.
        // const app = document.querySelector('[x-data]')?.__x?.data;
        // if (app) {
        //   app.showModal = false;
        //   app.showDeleteModal = false;
        //   // await app.loadReceipts(); // Moved to Alpine init
        // }
      } catch (error) {
        console.error('Error during page initialization:', error);
      }
    };

    // Handle errors gracefully
    window.addEventListener('error', function (e) {
      console.error('Page error:', e.error);
      // Prevent modals from showing on error
      const app = document.querySelector('[x-data]')?.__x;
      if (app) {
        app.$data.showModal = false;
        app.$data.showDeleteModal = false;
      }
    });

    // เพิ่ม global functions สำหรับสร้างใบสำคัญรับเงินจากใบเสร็จ

// ✅ สร้างใบสำคัญรับเงินจากใบเสร็จเดี่ยว (ใช้ Standard API)
window.createReceiptVoucherFromReceipt = async (receiptId, receiptNumber, amount, customerName, source) => {
  // ✅ ประกาศ btn ไว้ใน function scope ด้านบน
  let btn = null;
  let originalText = '<i class="bi bi-plus-circle mr-1"></i>สร้าง';

  try {
    // แสดง loading
    btn = event?.target;
    if (btn) {
      originalText = btn.innerHTML;
      btn.originalText = originalText; // เก็บไว้ใน property
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> กำลังสร้าง...';
    }

    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
    }

    console.log('📄 Creating receipt voucher from receipt:', {
      receiptId,
      receiptNumber,
      amount,
      customerName,
      source
    });

    // ✅ ใช้ Standard Receipt Voucher API format
    const requestBody = {
      documentNumber: `RV-${receiptNumber}-${Date.now()}`,
      paymentDate: new Date().toISOString().split('T')[0],
      debitAccount: {
        code: '11101',
        name: 'เงินสด'
      },
      creditAccount: {
        code: source === 'installment' ? '41102' : '41101',
        name: source === 'installment' ? 'รายได้จากการขายผ่อน' : 'รายได้จากการขาย'
      },
      receivedFrom: customerName,
      receiptType: source === 'installment' ? 'installment_down_payment' : 'cash_sale',
      paymentMethod: 'cash',
      details: [{
        description: `รับเงินจากใบเสร็จ ${receiptNumber} - ${customerName}`,
        amount: amount
      }],
      totalAmount: amount,
      netAmount: amount,
      vatAmount: 0,
      notes: `สร้างอัตโนมัติจากใบเสร็จ ${receiptNumber}`,
    
      // ✅ เพิ่ม branchStockHistoryId ที่ backend ต้องการ
      branchStockHistoryId: source === 'branch_stock_history' ? receiptId : null,
    
      // Enhanced metadata for tracking
      metadata: {
        sourceType: source || 'pos',
        sourceId: receiptId,
        autoGenerated: true,
        sourceReceiptNumber: receiptNumber,
        originalReceiptId: receiptId
      }
    };

    console.log('📤 Request body for standard API:', JSON.stringify(requestBody, null, 2));

    // ✅ ใช้ Standard API endpoint
    const response = await fetch('/api/receipt-vouchers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ไม่สามารถสร้างใบสำคัญรับเงินได้: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('📥 Response from standard API:', result);

    if (result.success) {
      // ปิด modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      // แสดงผลสำเร็จ
      const alpineApp = document.querySelector('[x-data="app"]').__x;
      if (alpineApp) {
        alpineApp.showNotification(`สร้างใบสำคัญรับเงิน ${result.data.documentNumber} จากใบเสร็จ ${receiptNumber} สำเร็จ`, 'success');
        await alpineApp.loadReceipts();
        await alpineApp.updateDashboardStats();
      } else {
        window.showFallbackNotification(`สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`, 'success');
      }
    } else {
      // คืนค่าปุ่ม
      if (btn && typeof btn === 'object' && btn.disabled !== undefined) {
        btn.disabled = false;
        btn.innerHTML = btn.originalText || originalText || '<i class="bi bi-plus-circle mr-1"></i>สร้าง';
      }
    
      let errorMessage = 'ไม่สามารถสร้างใบสำคัญรับเงินได้: ';
    
      if (result.errors && Array.isArray(result.errors)) {
        errorMessage += result.errors.join(', ');
      } else if (result.message) {
        errorMessage += result.message;
      } else {
        errorMessage += 'Unknown error';
      }
    
      console.error('❌ Create receipt voucher error:', errorMessage);
      console.log('🔍 Debug - Full result:', result);
    
      const alpineApp = document.querySelector('[x-data="app"]').__x;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating receipt voucher from receipt:', error);
    console.log('🔍 Debug - btn variable:', btn);
    console.log('🔍 Debug - btn type:', typeof btn);
    
    // ✅ คืนค่าปุ่มอย่างปลอดภัย - ใช้ตัวแปร btn ที่ประกาศไว้ด้านบน
    if (btn && typeof btn === 'object' && btn.disabled !== undefined) {
      btn.disabled = false;
      btn.innerHTML = btn.originalText || originalText || '<i class="bi bi-plus-circle mr-1"></i>สร้าง';
    }
    
    const errorMessage = `เกิดข้อผิดพลาดในการสร้างใบสำคัญรับเงิน: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// สร้างใบสำคัญรับเงินจากใบเสร็จแบบกลุ่ม
window.createBatchReceiptVouchersFromReceipts = async () => {
  if (!confirm('ต้องการสร้างใบสำคัญรับเงินจากใบเสร็จทั้งหมดที่แสดงใช่หรือไม่?')) {
    return;
  }

  try {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> กำลังประมวลผล...';

    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
    }

    // ดึง alpine instance เพื่อใช้ข้อมูล branch
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('ไม่พบข้อมูลสาขา กรุณาตั้งค่าสาขาในระบบก่อน');
    }

    console.log('📦 Creating batch receipt vouchers with branch:', branchCode);

    // เตรียมข้อมูลสำหรับสร้างแบบกลุ่ม
    const requestBody = {
      paymentMethod: 'cash',
      limit: 100,
      branch: branchCode,
      source: 'all' // ดึงจากทุกแหล่ง
    };

    // ✅ ใช้ Auto Creation API endpoint ที่ทำงานได้
    console.log('🔍 Creating batch receipt vouchers via auto-creation API...');
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ไม่สามารถเริ่มสร้างแบบกลุ่มได้: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('📥 Response from batch create:', result);

    if (result.success) {
      // ปิด modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      const successCount = result.data?.successful?.length || result.data?.success || 0;
      const failedCount = result.data?.failed?.length || result.data?.failed || 0;
    
      let successMessage = `เริ่มสร้างใบสำคัญรับเงินแบบกลุ่มแล้ว`;
      if (successCount > 0) {
        successMessage = `สร้างใบสำคัญรับเงินสำเร็จ ${successCount} รายการ`;
        if (failedCount > 0) {
          successMessage += `, ล้มเหลว ${failedCount} รายการ`;
        }
      } else if (result.data?.total) {
        successMessage = `เริ่มประมวลผล ${result.data.total} รายการแล้ว โปรดตรวจสอบสถานะ`;
      }
    
      if (alpineApp) {
        alpineApp.showNotification(successMessage, successCount > 0 ? 'success' : 'info');
        setTimeout(async () => {
          await alpineApp.loadReceipts();
          await alpineApp.updateDashboardStats();
        }, 2000);
      } else {
        window.showFallbackNotification(successMessage, 'success');
      }
    } else {
      // คืนค่าปุ่ม
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorMessage = `ไม่สามารถเริ่มสร้างแบบกลุ่มได้: ${result.message || 'Unknown error'}`;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating batch receipt vouchers:', error);
    
    // คืนค่าปุ่ม
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-stack mr-2"></i>สร้างทั้งหมด';
    }
    
    const errorMessage = `เกิดข้อผิดพลาดในการสร้างแบบกลุ่ม: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// เพิ่ม global functions สำหรับ button handlers (legacy)
window.createReceiptForItem = async (historyId) => {
  try {
    // แสดง loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> กำลังสร้าง...';

    // ดึง branch ID ที่ถูกต้อง
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('ไม่พบข้อมูลสาขา กรุณาตั้งค่าสาขาในระบบก่อน');
    }

    console.log('📍 Creating receipt with branch:', branchCode);
    console.log('📦 Creating from history ID:', historyId);

    // ✅ ดึงข้อมูลจากแถวในตาราง (ถ้ามี)
    let amount = 0;
    let customerName = 'ลูกค้าทั่วไป';
    let invoiceNo = '';
    
    // หาข้อมูลจากแถวในตาราง
    const rows = document.querySelectorAll('#pendingItemsModal tbody tr');
    for (const row of rows) {
      const button = row.querySelector(`button[onclick*="${historyId}"]`);
      if (button) {
        // ดึงจำนวนเงินจากคอลัมน์ที่ 4 (index 3)
        const amountCell = row.cells[3];
        if (amountCell) {
          const amountText = amountCell.textContent.replace(/[^\d.-]/g, '');
          amount = parseFloat(amountText) || 0;
        }
    
        // ดึงชื่อลูกค้าจากคอลัมน์ที่ 3 (index 2)
        const customerCell = row.cells[2];
        if (customerCell) {
          customerName = customerCell.textContent.trim() || 'ลูกค้าทั่วไป';
        }
    
        // ดึงเลขที่ใบเสร็จจากคอลัมน์ที่ 1 (index 0)
        const invoiceCell = row.cells[0];
        if (invoiceCell) {
          invoiceNo = invoiceCell.textContent.trim() || '';
        }
    
        break;
      }
    }

    console.log('💰 Amount from table:', amount);
    console.log('👤 Customer:', customerName);
    console.log('📄 Invoice No:', invoiceNo);

    // ถ้ายังไม่มีจำนวนเงิน ให้ใช้ค่า default
    if (amount <= 0) {
      amount = 100; // หรือค่า default ที่เหมาะสม
    }

    // ✅ สร้าง request body พร้อมจำนวนเงินที่ถูกต้อง
    const requestBody = {
      branchStockHistoryId: historyId,
      paymentMethod: 'cash',
    
      paymentDate: new Date().toISOString().split('T')[0],
      debitAccount: {
        code: '11101',
        name: 'เงินสด'
      },
      creditAccount: {
        code: '41101',
        name: 'รายได้จากการขาย'
      },
      receiptType: 'cash_sale',
      receivedFrom: customerName,
      details: [{
        description: `รับเงินจากการขายสินค้า${invoiceNo ? ' - ใบเสร็จเลขที่ ' + invoiceNo : ''}`,
        amount: amount
      }],
      notes: `สร้างอัตโนมัติจากประวัติการขาย${invoiceNo ? ' ใบเสร็จเลขที่ ' + invoiceNo : ''}`,
      totalAmount: amount // เพิ่ม totalAmount
    };

    console.log('📤 Request body:', JSON.stringify(requestBody, null, 2));

    const response = await fetch('/api/receipt-vouchers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(requestBody)
    });

    const result = await response.json();
    console.log('📥 Response:', result);

    if (result.success) {
      // ปิด modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      // แสดงผลสำเร็จ
      if (alpineApp) {
        alpineApp.showNotification(`สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`, 'success');
        await alpineApp.loadReceipts();
        await alpineApp.updateDashboardStats();
      } else {
        window.showFallbackNotification(`สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`, 'success');
      }
    } else {
      // คืนค่าปุ่ม
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      let errorMessage = 'ไม่สามารถสร้างใบสำคัญรับเงินได้: ';
    
      if (result.errors && Array.isArray(result.errors)) {
        errorMessage += result.errors.join(', ');
      } else if (result.message) {
        errorMessage += result.message;
      } else {
        errorMessage += 'Unknown error';
      }
    
      console.error('❌ Full error:', errorMessage);
    
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating receipt:', error);
    // คืนค่าปุ่ม
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = 'สร้าง';
    }
    
    const errorMessage = `เกิดข้อผิดพลาดในการสร้างใบสำคัญรับเงิน: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

window.createBatchFromPending = async () => {
  if (!confirm('ต้องการสร้างใบสำคัญรับเงินทั้งหมดที่รอดำเนินการใช่หรือไม่?')) {
    return;
  }

  try {
    // แสดง loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> กำลังประมวลผล...';

    // ✅ แก้ไข: ดึง branch ID ที่ถูกต้องจาก Alpine instance หรือ localStorage
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format (MongoDB ObjectId = 24 hex characters)
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      // ลองดึง branch จาก user data
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    // ตรวจสอบอีกครั้ง
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('ไม่พบข้อมูลสาขา กรุณาตั้งค่าสาขาในระบบก่อน');
    }

    console.log('📍 Creating batch with branch:', branchCode);

    // ✅ ใช้ Auto Creation API endpoint ที่แก้ไขแล้ว
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify({
        paymentMethod: 'cash',
        limit: 100,
        branchCode: branchCode // ใช้ค่าที่ validate แล้ว
      })
    });

    if (!response.ok) {
      // คืนค่าปุ่ม
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorText = await response.text();
      throw new Error(`Auto creation API error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('📥 Auto creation response:', result);

    if (result.success) {
      // ปิด modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      const created = result.data?.summary?.successful || result.data?.created?.length || 0;
      const failed = result.data?.summary?.failed || result.data?.failed?.length || 0;
      const processed = result.data?.summary?.processed || 0;
    
      let successMessage = '';
      if (created > 0) {
        successMessage = `สร้างใบสำคัญรับเงินอัตโนมัติสำเร็จ ${created} รายการ`;
        if (failed > 0) {
          successMessage += `, ล้มเหลว ${failed} รายการ`;
        }
        if (processed > 0) {
          successMessage += ` (ประมวลผลทั้งหมด ${processed} รายการ)`;
        }
      } else if (processed > 0) {
        successMessage = `ประมวลผลเสร็จสิ้น ${processed} รายการ แต่ไม่มีรายการใหม่ที่ต้องสร้าง`;
      } else {
        successMessage = `ไม่พบรายการที่ต้องสร้างใบสำคัญรับเงิน`;
      }
    
      if (alpineApp) {
        alpineApp.showNotification(successMessage, created > 0 ? 'success' : 'info');
        setTimeout(async () => {
          await alpineApp.loadReceipts();
          await alpineApp.updateDashboardStats();
        }, 2000);
      } else {
        window.showFallbackNotification(successMessage, 'success');
      }
    } else {
      // คืนค่าปุ่ม
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorMessage = `ไม่สามารถเริ่มสร้างแบบกลุ่มได้: ${result.message || 'Unknown error'}`;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating batch:', error);
    // คืนค่าปุ่ม
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-stack mr-2"></i>สร้างทั้งหมด';
    }
    
    const errorMessage = `เกิดข้อผิดพลาดในการสร้างแบบกลุ่ม: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// เพิ่มฟังก์ชัน showFallbackNotification
window.showFallbackNotification = function(message, type = 'info') {
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };

  const notificationHtml = `
    <div id="fallbackNotification" class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight">
      <div class="flex items-center justify-between">
        <span>${message}</span>
        <button onclick="this.closest('#fallbackNotification').remove()" class="ml-4 text-white hover:text-gray-200">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  `;

  // Remove existing notification
  const existing = document.getElementById('fallbackNotification');
  if (existing) existing.remove();

  // Add new notification
  document.body.insertAdjacentHTML('beforeend', notificationHtml);

  // Auto remove after 3 seconds
  setTimeout(() => {
    const notification = document.getElementById('fallbackNotification');
    if (notification) {
      notification.classList.remove('animate__fadeInRight');
      notification.classList.add('animate__fadeOutRight');
      setTimeout(() => notification.remove(), 500);
    }
  }, type === 'error' ? 5000 : 3000);
};

// ✅ Debug helpers for browser console - Updated to use same API as UI
window.checkAutoCreation = async () => {
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';
  console.log('🔍 Checking auto creation using UI API for branch:', branchCode);

  // ✅ ใช้ API endpoint เดียวกับ UI
  const response = await fetch('/api/receipt-voucher/pending-receipts', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('authToken')}`
    }
  });

  if (response.ok) {
    const result = await response.json();
    console.log('📊 Auto Creation Status API Response:', result);
    
    if (result.success && result.data) {
      const pendingItems = result.data || [];
    
      // แยกประเภทตาม source
      const posPending = pendingItems.filter(item => item.source === 'pos' || item.source === 'cash_sale').length;
      const installmentPending = pendingItems.filter(item => item.source === 'installment' || item.source === 'installment_payment').length;
      const otherPending = pendingItems.filter(item => !['pos', 'cash_sale', 'installment', 'installment_payment'].includes(item.source)).length;
    
      console.log('📊 รายการรอสร้างทั้งหมด:', pendingItems.length);
      console.log('📊 รายการ POS ที่รอ:', posPending);
      console.log('📊 รายการผ่อนที่รอ:', installmentPending);
      console.log('📊 รายการอื่นๆ ที่รอ:', otherPending);
      console.log('📊 สร้างไปแล้ววันนี้:', 0); // TODO: ต้องเพิ่ม API สำหรับนับรายการที่สร้างวันนี้
    
      if (pendingItems.length > 0) {
        console.table(pendingItems.slice(0, 10).map(item => ({
          id: item._id || item.id,
          type: item.source || item.type,
          amount: item.totalAmount || item.netAmount || item.amount,
          date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH'),
          customer: item.customerName || item.customer || 'ไม่ระบุ'
        })));
      }
    
      return {
        totalPending: pendingItems.length,
        pendingPosReceipts: posPending,
        pendingInstallmentReceipts: installmentPending,
        pendingOtherReceipts: otherPending,
        todayAutoCreated: 0,
        pendingItems: pendingItems,
        status: pendingItems.length > 0 ? 'pending' : 'up_to_date',
        lastCheck: new Date().toISOString(),
        branchCode: branchCode
      };
    }
    return null;
  } else {
    console.error('❌ API Error:', response.status, response.statusText);
    return null;
  }
};

// Test pending receipts API
window.checkPendingReceipts = async () => {
  console.log('🔍 Checking pending receipts...');

  const response = await fetch('/api/receipt-voucher/pending-receipts', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('authToken')}`
    }
  });

  if (response.ok) {
    const result = await response.json();
    console.log('📊 Pending Receipts API Response:', result);
    
    if (result.success && result.data) {
      console.log('📊 รายการใบเสร็จที่รอสร้างใบสำคัญ:', result.data.length);
    
      if (result.data.length > 0) {
        console.table(result.data.slice(0, 10).map(item => ({
          id: item._id,
          number: item.receiptNumber || item.documentNumber,
          amount: item.totalAmount || item.netAmount,
          customer: item.customerName || 'ไม่ระบุ',
          source: item.source || 'ไม่ระบุ',
          date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH')
        })));
      }
    }
    return result.data;
  } else {
    console.error('❌ Pending Receipts API Error:', response.status, response.statusText);
    return null;
  }
};

// Debug Alpine.js state
window.debugAlpineState = () => {
  const alpineApp = document.querySelector('[x-data="app"]')?.__x;
  if (alpineApp) {
    console.log('🎯 Alpine.js Summary State:');
    console.log('   - pendingReceiptCount:', alpineApp.summary.pendingReceiptCount);
    console.log('   - todayAutoCreatedCount:', alpineApp.summary.todayAutoCreatedCount);
    console.log('   - currentBranch:', alpineApp.currentBranch);
    console.log('   - lastStatsUpdate:', alpineApp.lastStatsUpdate ? new Date(alpineApp.lastStatsUpdate).toLocaleTimeString() : 'Never');
    return alpineApp.summary;
  } else {
    console.log('❌ Alpine.js app not found');
    return null;
  }
};

// 🔧 Compare both pending systems
window.comparePendingSystems = async () => {
  console.log('🔄 เปรียบเทียบระบบ pending items...');
  console.log('');

  // เรียกทั้งสอง APIs
  const autoCreationData = await checkAutoCreation();
  const pendingReceiptsData = await checkPendingReceipts();
  const alpineData = debugAlpineState();

  console.log('📊 === การเปรียบเทียบระบบ ===');
  console.log('');

  console.log('🤖 Auto Creation System:');
  console.log('   - API: /api/receipt-voucher/auto-creation-status');
  console.log('   - Total Pending:', autoCreationData?.totalPending || 0);
  console.log('   - POS Receipts:', autoCreationData?.pendingPosReceipts || 0);
  console.log('   - Installment Receipts:', autoCreationData?.pendingInstallmentReceipts || 0);
  console.log('   - Status:', autoCreationData?.status || 'unknown');
  console.log('');

  console.log('👥 UI Pending System:');
  console.log('   - API: /api/receipt-voucher/pending-receipts');
  console.log('   - Total Items:', pendingReceiptsData?.length || 0);
  console.log('');

  console.log('🎯 Alpine.js State:');
  console.log('   - UI Displayed Count:', alpineData?.pendingReceiptCount || 0);
  console.log('   - Today Auto Created:', alpineData?.todayAutoCreatedCount || 0);
  console.log('');

  const autoTotal = autoCreationData?.totalPending || 0;
  const apiTotal = pendingReceiptsData?.length || 0;
  const uiTotal = alpineData?.pendingReceiptCount || 0;

  if (autoTotal !== apiTotal || autoTotal !== uiTotal || apiTotal !== uiTotal) {
    console.log('⚠️  พบความแตกต่าง!');
    console.log('   Auto Creation API แสดง:', autoTotal, 'รายการ');
    console.log('   Pending Receipts API แสดง:', apiTotal, 'รายการ');
    console.log('   UI แสดง:', uiTotal, 'รายการ');
    console.log('');
    console.log('🔧 สาเหตุที่เป็นไปได้:');
    console.log('   1. ใช้ data source ที่แตกต่างกัน');
    console.log('   2. API filter criteria ต่างกัน');
    console.log('   3. Branch code ไม่ตรงกัน');
    console.log('   4. Cache หรือ state ไม่ sync กัน');
  } else {
    console.log('✅ ข้อมูลจากทุกระบบตรงกัน');
  }

  return {
    autoCreation: autoCreationData,
    pendingReceipts: pendingReceiptsData,
    alpineState: alpineData,
    totals: { autoTotal, apiTotal, uiTotal },
    isAllMatching: autoTotal === apiTotal && apiTotal === uiTotal
  };
};

// Test Sync API
window.testSyncAPI = async (receiptId = 'test123', amount = 1000) => {
  console.log('🧪 Testing Sync API...');

  const requestBody = {
    source: 'pos',
    sourceId: receiptId,
    documentNumber: `RV-TEST-${Date.now()}`,
    customerName: 'ลูกค้าทดสอบ',
    totalAmount: amount,
    paymentMethod: 'cash',
    description: 'ทดสอบการสร้างใบสำคัญรับเงิน',
    notes: 'สร้างสำหรับทดสอบระบบ',
    metadata: {
      sourceReceiptNumber: 'TEST001',
      autoGenerated: false,
      createdBy: 'test_user'
    }
  };

  try {
    const response = await fetch('/api/receipt-vouchers/sync', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('📊 Sync API Response Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('✅ Sync API Success:', result);
      return result;
    } else {
      const errorText = await response.text();
      console.error('❌ Sync API Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('❌ Network Error:', error);
    return { error: error.message };
  }
};

// ✅ Test Batch Creation API
window.testBatchCreation = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('📦 Testing Batch Creation API...');

  const requestBody = {
    paymentMethod: 'cash',
    limit: 100,
    branchCode: branchCode
  };

  try {
    // Test both endpoints
    console.log('🧪 Testing /api/receipt-vouchers/batch...');
    let response = await fetch('/api/receipt-vouchers/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('📊 Batch API Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('✅ Batch API Success:', result);
      return result;
    } else {
      console.log('❌ Batch API failed, trying auto-create-from-receipts...');
    
      // Try alternative endpoint
      response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestBody)
      });
    
      console.log('📊 Auto Creation API Status:', response.status);
    
      if (response.ok) {
        const result = await response.json();
        console.log('✅ Auto Creation API Success:', result);
        return result;
      } else {
        const errorText = await response.text();
        console.error('❌ Both APIs failed:', errorText);
        return { error: errorText, status: response.status };
      }
    }
  } catch (error) {
    console.error('❌ Network Error:', error);
    return { error: error.message };
  }
};

// ✅ Debug function ตรวจสอบ API responses
window.debugReceiptVoucherAPIs = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🔍 Testing Receipt Voucher APIs...');

  // Test auto-creation-status
  try {
    const statusResponse = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const statusData = await statusResponse.json();
    console.log('✅ Auto Creation Status:', statusData);
  } catch (err) {
    console.log('❌ Auto Creation Status error:', err.message);
  }

  // Test pending-receipts
  try {
    const pendingResponse = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const pendingData = await pendingResponse.json();
    console.log('✅ Pending Receipts:', pendingData);
  } catch (err) {
    console.log('❌ Pending Receipts error:', err.message);
  }

  // Test standard receipt voucher endpoint
  try {
    const voucherResponse = await fetch('/api/receipt-vouchers?limit=1', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const voucherData = await voucherResponse.json();
    console.log('✅ Standard Receipt Vouchers:', voucherData);
  } catch (err) {
    console.log('❌ Standard Receipt Vouchers error:', err.message);
  }

  console.log('🏁 API testing completed');
};

// ✅ Test Trigger Auto Creation API
window.testTriggerAutoCreation = async (limit = 5) => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🚀 Testing Trigger Auto Creation API...');

  const requestBody = {
    limit: limit,
    branchCode: branchCode
  };

  try {
    const response = await fetch('/api/receipt-voucher/trigger-auto-creation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('📊 Trigger Auto Creation Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('✅ Trigger Auto Creation Success:', result);
    
      if (result.data) {
        console.log(`📈 Summary: ${result.data.summary.successful} สำเร็จ, ${result.data.summary.failed} ล้มเหลว`);
    
        if (result.data.created.length > 0) {
          console.table(result.data.created.map(item => ({
            documentNumber: item.documentNumber,
            amount: item.amount,
            customer: item.customer,
            source: item.source
          })));
        }
    
        if (result.data.failed.length > 0) {
          console.log('❌ Failed items:');
          console.table(result.data.failed);
        }
      }
    
      return result;
    } else {
      const errorText = await response.text();
      console.error('❌ Trigger Auto Creation Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('❌ Network Error:', error);
    return { error: error.message };
  }
};

// ✅ Test Auto Creation API
window.testAutoCreation = async (limit = 5) => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🤖 Testing Auto Creation API...');

  const requestBody = {
    limit: limit,
    paymentMethod: 'cash',
    branchCode: branchCode
  };

  try {
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('📊 Auto Creation Response Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('✅ Auto Creation Success:', result);
    
      if (result.data) {
        console.log(`📈 Summary: ${result.data.summary.successful} สำเร็จ, ${result.data.summary.failed} ล้มเหลว`);
    
        if (result.data.created.length > 0) {
          console.table(result.data.created.map(item => ({
            documentNumber: item.documentNumber,
            amount: item.amount,
            customer: item.customer,
            source: item.source
          })));
        }
    
        if (result.data.failed.length > 0) {
          console.log('❌ Failed items:');
          console.table(result.data.failed);
        }
      }
    
      return result;
    } else {
      const errorText = await response.text();
      console.error('❌ Auto Creation Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('❌ Network Error:', error);
    return { error: error.message };
  }
};

// ✅ Debug function เปรียบเทียบ API responses
window.compareReceiptAPIs = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🔍 Comparing Receipt APIs...');
  console.log('📍 Using branchCode:', branchCode);

  const results = {};

  // 1. Test auto-creation-status API
  try {
    console.log('\n1️⃣ Testing auto-creation-status API...');
    const statusResponse = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (statusResponse.ok) {
      const statusData = await statusResponse.json();
      results.autoCreationStatus = statusData;
      console.log('✅ Auto Creation Status Data:', statusData);
      console.log('📊 Total Pending (Status API):', statusData.data?.totalPending || 0);
    } else {
      console.error('❌ Auto Creation Status API failed:', statusResponse.status);
      results.autoCreationStatus = { error: statusResponse.status };
    }
  } catch (err) {
    console.error('❌ Auto Creation Status error:', err);
    results.autoCreationStatus = { error: err.message };
  }

  // 2. Test pending-receipts API
  try {
    console.log('\n2️⃣ Testing pending-receipts API...');
    const pendingResponse = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}&limit=50`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (pendingResponse.ok) {
      const pendingData = await pendingResponse.json();
      results.pendingReceipts = pendingData;
      console.log('✅ Pending Receipts Data:', pendingData);
      console.log('📊 Total Pending (Receipts API):', pendingData.data?.length || 0);
    
      if (pendingData.data && pendingData.data.length > 0) {
        console.log('📝 Sample pending items:');
        console.table(pendingData.data.slice(0, 5).map(item => ({
          id: item._id,
          receiptNumber: item.receiptNumber,
          amount: item.totalAmount,
          customer: item.customerName,
          source: item.source
        })));
      }
    } else {
      console.error('❌ Pending Receipts API failed:', pendingResponse.status);
      results.pendingReceipts = { error: pendingResponse.status };
    }
  } catch (err) {
    console.error('❌ Pending Receipts error:', err);
    results.pendingReceipts = { error: err.message };
  }

  // 3. Test Alpine.js dashboard state
  try {
    console.log('\n3️⃣ Checking Alpine.js Dashboard State...');
    const alpineApp = document.querySelector('[x-data="app"]')?.__x;
    if (alpineApp) {
      console.log('✅ Alpine Summary State:', alpineApp.summary);
      results.alpineState = alpineApp.summary;
    } else {
      console.log('❌ Alpine.js app not found');
      results.alpineState = { error: 'Alpine app not found' };
    }
  } catch (err) {
    console.error('❌ Alpine state error:', err);
    results.alpineState = { error: err.message };
  }

  // 4. Compare results
  console.log('\n🔍 COMPARISON RESULTS:');
  console.log('='.repeat(50));

  const statusPending = results.autoCreationStatus?.data?.totalPending || 0;
  const receiptsPending = results.pendingReceipts?.data?.length || 0;
  const alpinePending = results.alpineState?.pendingReceiptCount || 0;

  console.log(`📊 Auto Creation Status API: ${statusPending} รายการ`);
  console.log(`📊 Pending Receipts API:     ${receiptsPending} รายการ`);
  console.log(`📊 Alpine Dashboard:         ${alpinePending} รายการ`);

  if (statusPending !== receiptsPending) {
    console.log('⚠️  APIs ให้ข้อมูลไม่ตรงกัน!');
    console.log('   - อาจใช้ query conditions ต่างกัน');
    console.log('   - อาจใช้ models ต่างกัน');
    console.log('   - อาจมี cache หรือ timing issues');
  }

  if (alpinePending !== receiptsPending) {
    console.log('⚠️  Dashboard ไม่ sync กับ API!');
    console.log('   - ต้อง refresh dashboard data');
    console.log('   - อาจมี throttling issues');
  }

  // 5. Suggestions
  console.log('\n💡 SUGGESTIONS:');
  if (statusPending !== receiptsPending) {
    console.log('🔧 Run: await refreshDashboard() เพื่อ sync ข้อมูล');
  }
  if (alpinePending === 0 && receiptsPending > 0) {
    console.log('🔧 Run: await updateDashboardStats() เพื่ออัปเดต dashboard');
  }

  return results;
};

// ✅ Test Modal API (จำลองการทำงานของปุ่ม "ดูใบเสร็จที่รอดำเนินการ")
window.testModalAPI = async () => {
  const token = localStorage.getItem('authToken');

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🔍 Testing Modal API (exact same as button)...');

  // ใช้ endpoints เหมือนกับ modal ทุกประการ
  const endpoints = [
    '/api/receipt-voucher/pending-receipts',
    '/api/receipt-vouchers/pending-receipts'
  ];

  let response = null;
  let foundEndpoint = null;

  for (const endpoint of endpoints) {
    try {
      console.log(`🔍 ลองดึงรายการรอดำเนินการจาก: ${endpoint}`);
      response = await fetch(endpoint, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.status !== 404) {
        foundEndpoint = endpoint;
        break;
      }
    } catch (err) {
      console.log(`❌ ${endpoint} ไม่สามารถเชื่อมต่อได้`);
    }
  }

  if (!foundEndpoint || !response) {
    console.error('❌ ไม่พบระบบดึงรายการใบเสร็จ - API endpoints ไม่พร้อมใช้งาน');
    return { error: 'No endpoint found' };
  }

  if (!response.ok) {
    const errorText = await response.text();
    console.error(`❌ API Error: ${response.status} - ${errorText}`);
    return { error: `${response.status} - ${errorText}` };
  }

  const result = await response.json();

  console.log('✅ Modal API Response:', result);

  if (result.success) {
    const pendingReceipts = result.data || [];
    console.log(`📊 Modal API Found: ${pendingReceipts.length} รายการ`);
    
    if (pendingReceipts.length > 0) {
      console.log('📝 Sample modal items:');
      console.table(pendingReceipts.slice(0, 10).map(item => ({
        id: item._id,
        receiptNumber: item.receiptNumber || item.documentNumber,
        amount: item.totalAmount || item.netAmount,
        customer: item.customerName,
        source: item.source,
        date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH')
      })));
    }
  } else {
    console.error('❌ API Success false:', result.message);
  }

  return result;
};

// ✅ เปรียบเทียบ API ที่ใช้ branchCode กับไม่ใช้
window.compareBranchCodeEffect = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('❌ No auth token found');
    return;
  }

  console.log('🔍 Comparing API with and without branchCode...');
  console.log('📍 Current branchCode:', branchCode);

  const results = {};

  // 1. Test WITHOUT branchCode (like modal)
  try {
    console.log('\n1️⃣ Testing WITHOUT branchCode (like modal)...');
    const response1 = await fetch('/api/receipt-voucher/pending-receipts', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response1.ok) {
      const data1 = await response1.json();
      results.withoutBranchCode = data1;
      console.log('✅ WITHOUT branchCode:', data1.data?.length || 0, 'รายการ');
    } else {
      console.error('❌ WITHOUT branchCode failed:', response1.status);
      results.withoutBranchCode = { error: response1.status };
    }
  } catch (err) {
    console.error('❌ WITHOUT branchCode error:', err);
    results.withoutBranchCode = { error: err.message };
  }

  // 2. Test WITH branchCode (like debug function)
  try {
    console.log('\n2️⃣ Testing WITH branchCode (like debug function)...');
    const response2 = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response2.ok) {
      const data2 = await response2.json();
      results.withBranchCode = data2;
      console.log('✅ WITH branchCode:', data2.data?.length || 0, 'รายการ');
    } else {
      console.error('❌ WITH branchCode failed:', response2.status);
      results.withBranchCode = { error: response2.status };
    }
  } catch (err) {
    console.error('❌ WITH branchCode error:', err);
    results.withBranchCode = { error: err.message };
  }

  // 3. Test with different branchCode
  try {
    console.log('\n3️⃣ Testing with different branchCode formats...');
    
    // Test with "default"
    const response3 = await fetch('/api/receipt-voucher/pending-receipts?branchCode=default', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response3.ok) {
      const data3 = await response3.json();
      results.withDefaultBranch = data3;
      console.log('✅ WITH branchCode=default:', data3.data?.length || 0, 'รายการ');
    }

    // Test with "all"
    const response4 = await fetch('/api/receipt-voucher/pending-receipts?branchCode=all', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response4.ok) {
      const data4 = await response4.json();
      results.withAllBranch = data4;
      console.log('✅ WITH branchCode=all:', data4.data?.length || 0, 'รายการ');
    }
  } catch (err) {
    console.error('❌ Different branchCode test error:', err);
  }

  // 4. Compare results
  console.log('\n🔍 COMPARISON RESULTS:');
  console.log('='.repeat(60));

  const withoutBranch = results.withoutBranchCode?.data?.length || 0;
  const withBranch = results.withBranchCode?.data?.length || 0;
  const withDefault = results.withDefaultBranch?.data?.length || 0;
  const withAll = results.withAllBranch?.data?.length || 0;

  console.log(`📊 WITHOUT branchCode (modal):     ${withoutBranch} รายการ`);
  console.log(`📊 WITH branchCode (${branchCode}): ${withBranch} รายการ`);
  console.log(`📊 WITH branchCode=default:        ${withDefault} รายการ`);
  console.log(`📊 WITH branchCode=all:            ${withAll} รายการ`);

  // Find which API gives the expected 13 results
  const results13 = [];
  if (withoutBranch === 13) results13.push('WITHOUT branchCode (modal)');
  if (withBranch === 13) results13.push('WITH current branchCode');
  if (withDefault === 13) results13.push('WITH branchCode=default');
  if (withAll === 13) results13.push('WITH branchCode=all');

  if (results13.length > 0) {
    console.log('\n🎯 APIs ที่ให้ผลลัพธ์ 13 รายการ:');
    results13.forEach(api => console.log(`   ✅ ${api}`));
  } else {
    console.log('\n⚠️  ไม่มี API ใดที่ให้ผลลัพธ์ 13 รายการ');
    console.log('   - อาจเป็นเพราะข้อมูลเปลี่ยนแปลงไปแล้ว');
    console.log('   - หรืออาจมี caching issues');
  }

  // Show sample data if found
  if (withoutBranch > 0 && results.withoutBranchCode.data) {
    console.log('\n📝 Sample data (WITHOUT branchCode):');
    console.table(results.withoutBranchCode.data.slice(0, 5).map(item => ({
      id: item._id,
      receiptNumber: item.receiptNumber,
      amount: item.totalAmount,
      source: item.source
    })));
  }

  return results;
};

// ✅ Function สำหรับ refresh dashboard
window.refreshDashboard = async () => {
  console.log('🔄 Refreshing dashboard...');

  const alpineApp = document.querySelector('[x-data="app"]')?.__x;
  if (alpineApp) {
    try {
      // Force update stats (bypass throttling)
      alpineApp.lastStatsUpdate = 0;
    
      console.log('📊 Updating dashboard stats...');
      await alpineApp.updateDashboardStats();
    
      console.log('📊 Loading receipts...');
      await alpineApp.loadReceipts();
    
      console.log('✅ Dashboard refreshed successfully');
    
      // Show current state
      console.log('📊 Current dashboard state:');
      console.log('   - pendingReceiptCount:', alpineApp.summary.pendingReceiptCount);
      console.log('   - todayAutoCreatedCount:', alpineApp.summary.todayAutoCreatedCount);
    
      return { success: true, data: alpineApp.summary };
    } catch (error) {
      console.error('❌ Error refreshing dashboard:', error);
      return { success: false, error: error.message };
    }
  } else {
    console.log('❌ Alpine.js app not found');
    return { success: false, error: 'Alpine app not found' };
  }
};

// ✅ Quick function สำหรับสร้างใบสำคัญรับเงินจากใบเสร็จที่รอดำเนินการ - Updated
window.quickCreateReceiptVouchers = async (limit = 10) => {
  console.log('🚀 เริ่มสร้างใบสำคัญรับเงินจากใบเสร็จที่รอดำเนินการ...');

  try {
    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
    }

    // 1. ดึงข้อมูล pending receipts จาก API เดียวกับ UI
    console.log('1️⃣ ดึงข้อมูล pending receipts...');
    const pendingResponse = await fetch('/api/receipt-voucher/pending-receipts', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!pendingResponse.ok) {
      throw new Error(`ไม่สามารถดึงข้อมูล pending receipts ได้: ${pendingResponse.status}`);
    }

    const pendingResult = await pendingResponse.json();
    if (!pendingResult.success || !pendingResult.data) {
      throw new Error('ไม่พบข้อมูล pending receipts');
    }

    const pendingReceipts = pendingResult.data.slice(0, limit);
    console.log(`📦 พบ ${pendingReceipts.length} รายการที่จะสร้าง (จาก ${pendingResult.data.length} รายการทั้งหมด)`);

    // ✅ แสดงรายการ receipts ที่พบ
    console.log('📋 รายการ receipts ที่พบ:');
    pendingResult.data.forEach((receipt, index) => {
      console.log(`   ${index + 1}. ${receipt.receiptNumber} (${receipt._id}) - ฿${receipt.totalAmount}`);
    });

    if (pendingReceipts.length === 0) {
      console.log('✅ ไม่มีรายการที่รอสร้าง');
      return { success: true, message: 'ไม่มีรายการที่รอสร้าง', created: 0 };
    }

    // 2. สร้าง receipt vouchers สำหรับแต่ละรายการ
    console.log('2️⃣ เริ่มสร้าง receipt vouchers...');
    let created = 0;
    let errors = [];

    for (const receipt of pendingReceipts) {
      try {
        console.log(`🔄 สร้าง receipt voucher สำหรับ: ${receipt.receiptNumber || receipt._id}`);
    
        // ✅ Debug: แสดงข้อมูล receipt ที่มี
        console.log('📋 Receipt object keys:', Object.keys(receipt));
        console.log('📋 Receipt data:', {
          _id: receipt._id,
          branchStockHistoryId: receipt.branchStockHistoryId,
          receiptNumber: receipt.receiptNumber,
          totalAmount: receipt.totalAmount,
          source: receipt.source
        });
    
        // แปลงข้อมูล receipt เป็น format ที่ API รองรับ
        const totalAmount = receipt.totalAmount || receipt.netAmount || 0;
    
        // ตรวจสอบจำนวนเงิน
        if (totalAmount <= 0) {
          console.warn(`⚠️ ข้าม receipt ${receipt.receiptNumber}: จำนวนเงิน ${totalAmount} ไม่ถูกต้อง`);
          errors.push(`${receipt.receiptNumber}: จำนวนเงินไม่ถูกต้อง (${totalAmount})`);
          continue;
        }

        // ✅ ใช้ format เหมือน submitForm() ทุกประการ + เพิ่ม totalAmount + branchStockHistoryId
        // ✅ ไม่ส่ง documentNumber ให้ API สร้างเอง เพื่อหลีกเลี่ยง duplicate key error
        const voucherData = {
          // documentNumber: `RV-AUTO-${Date.now()}-${created + 1}`, // ✅ ให้ API สร้างเอง
          paymentDate: new Date().toISOString(),
          debitAccount: {
            code: '11101',  // เงินสด
            name: 'เงินสด'
          },
          creditAccount: {
            code: '41101',  // รายได้จากการขาย
            name: 'รายได้จากการขาย'
          },
          receivedFrom: receipt.customerName || receipt.customer?.name || 'ลูกค้าทั่วไป',
          receiptType: receipt.source || 'cash_sale',
          paymentMethod: receipt.paymentMethod || 'cash',
          totalAmount: totalAmount,  // ✅ เพิ่ม totalAmount ที่ root level
          branchStockHistoryId: receipt._id,  // ✅ ใช้ _id เป็น branchStockHistoryId สำหรับ branch_stock_history
          details: [
            {
              description: `รายได้จากใบเสร็จ ${receipt.receiptNumber || receipt._id}`,
              amount: totalAmount
            }
          ],
          notes: `สร้างอัตโนมัติจากใบเสร็จ: ${receipt.receiptNumber || receipt._id}`,
          branch: localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || '00000'
        };

        // ✅ Debug: แสดงข้อมูลที่จะส่งไป API
        console.log('📦 Request data:', voucherData);
        console.log('🔍 Amount check:', {
          totalAmount: totalAmount,
          detailsAmount: voucherData.details[0]?.amount,
          details: voucherData.details
        });
        console.log('🏢 branchStockHistoryId:', voucherData.branchStockHistoryId);

        // เรียก API สร้าง receipt voucher
        console.log('📤 Sending request to API...');
        const createResponse = await fetch('/api/receipt-voucher', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(voucherData)
        });

        console.log('📥 API Response status:', createResponse.status);
        console.log('📥 API Response headers:', Object.fromEntries(createResponse.headers.entries()));

        if (createResponse.ok) {
          const createResult = await createResponse.json();
          if (createResult.success) {
            created++;
            console.log(`✅ สร้างสำเร็จ: ${createResult.data?.documentNumber || 'Unknown'}`);
          } else {
            console.error(`❌ API returned error for ${receipt.receiptNumber}:`, createResult);
            errors.push(`${receipt.receiptNumber}: ${createResult.message || 'Unknown error'} ${createResult.errors ? JSON.stringify(createResult.errors) : ''}`);
          }
        } else {
          const errorText = await createResponse.text();
          console.error(`❌ HTTP Error ${createResponse.status} for ${receipt.receiptNumber}:`, errorText);
    
          // ✅ ตรวจสอบว่าเป็น duplicate key error หรือไม่
          if (errorText.includes('E11000 duplicate key error') || errorText.includes('duplicate')) {
            console.log(`⚠️ Receipt ${receipt.receiptNumber} อาจถูกสร้างแล้ว - ข้าม`);
            errors.push(`${receipt.receiptNumber}: Already processed (duplicate)`);
          } else {
            errors.push(`${receipt.receiptNumber}: HTTP ${createResponse.status} - ${errorText}`);
          }
        }

        // หน่วงเวลาเล็กน้อยเพื่อไม่ให้ server เกิด load มาก
        await new Promise(resolve => setTimeout(resolve, 100));

      } catch (itemError) {
        console.error(`❌ Error creating voucher for ${receipt.receiptNumber}:`, itemError);
        errors.push(`${receipt.receiptNumber}: ${itemError.message}`);
      }
    }

    // 3. สรุปผลลัพธ์
    console.log(`📊 สรุปผลการสร้าง:`);
    console.log(`   ✅ สร้างสำเร็จ: ${created} รายการ`);
    console.log(`   ❌ มีข้อผิดพลาด: ${errors.length} รายการ`);

    if (errors.length > 0) {
      console.log('❌ รายการที่มีข้อผิดพลาด:', errors);
    }

    // 4. รีเฟรช UI
    const alpineApp = document.querySelector('[x-data="app"]')?.__x;
    if (alpineApp) {
      console.log('🔄 รีเฟรช UI...');
      await alpineApp.loadReceipts();
      await alpineApp.checkAutoCreationStatus();
    }

    const result = {
      success: true,
      created: created,
      errors: errors.length,
      errorDetails: errors.length > 0 ? errors : undefined,
      message: `สร้างใบสำคัญรับเงินสำเร็จ ${created} รายการ${errors.length > 0 ? ` (มีข้อผิดพลาด ${errors.length} รายการ)` : ''}`
    };

    console.log('✅ เสร็จสิ้นการสร้าง receipt vouchers:', result);
    return result;

  } catch (error) {
    console.error('❌ สร้างใบสำคัญรับเงินไม่สำเร็จ:', error);
    
    // แสดงการแจ้งเตือน
    if (window.showFallbackNotification) {
      window.showFallbackNotification(`สร้างใบสำคัญรับเงินไม่สำเร็จ: ${error.message}`, 'error');
    }
    
    return {
      success: false,
      error: error.message,
      created: 0
    };
  }
};

// ✅ ฟังก์ชันสำหรับทดสอบระบบสร้างใบสำคัญรับเงิน - ใช้ในคอนโซล
window.testReceiptVoucherCreation = async () => {
  console.log('🧪 ทดสอบระบบสร้างใบสำคัญรับเงิน...');

  // 1. ตรวจสอบ pending receipts
  console.log('\n1️⃣ ตรวจสอบใบเสร็จที่รอดำเนินการ...');
  const pendingResult = await window.checkPendingReceipts();

  if (pendingResult && pendingResult.data && pendingResult.data.length > 0) {
    console.log(`📋 พบใบเสร็จที่รอดำเนินการ: ${pendingResult.data.length} รายการ`);
    
    // 2. ลองสร้างใบสำคัญรับเงิน
    console.log('\n2️⃣ เริ่มสร้างใบสำคัญรับเงิน...');
    const createResult = await window.quickCreateReceiptVouchers(Math.min(5, pendingResult.data.length));
    
    if (createResult && createResult.success) {
      console.log('🎉 ทดสอบสำเร็จ! ระบบทำงานได้ปกติ');
    } else {
      console.log('⚠️ ทดสอบไม่สำเร็จ แต่ข้อมูลโหลดได้');
    }
    
    return createResult;
  } else {
    console.log('ℹ️ ไม่มีใบเสร็จที่รอดำเนินการ หรือระบบทำงานไว้แล้ว');
    return { message: 'No pending receipts found' };
  }
};

// Show/Hide Loading with Lottie animation
let lottieAnimation = null;
function showLoading(show) {
  const loader = document.getElementById('loadingOverlay');
  if (show) {
    loader.style.display = 'flex';
    loader.classList.remove('animate__fadeOut');
    loader.classList.add('animate__fadeIn');

    if (!lottieAnimation) {
      console.log('=🔄 Loading Lottie animation from /Loading/Loading.json');
      fetch('/Loading/Loading.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(animationData => {
          lottieAnimation = lottie.loadAnimation({
            container: document.getElementById('lottieContainer'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            animationData: animationData
          });
          console.log('✅ Lottie animation loaded successfully');
        })
        .catch(error => {
          console.error('❌ Error loading Lottie animation:', error);
          document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
        });
    } else {
      lottieAnimation.play();
    }
  } else {
    if (lottieAnimation) {
      lottieAnimation.pause();
    }
    loader.classList.remove('animate__fadeIn');
    loader.classList.add('animate__fadeOut');
    setTimeout(() => { loader.style.display = 'none'; }, 600);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  showLoading(true);
  // existing code continues to run...
  setTimeout(() => showLoading(false), 800);
});

window.addEventListener('beforeunload', () => {
  if (lottieAnimation) {
    lottieAnimation.destroy();
    lottieAnimation = null;
  }
});
</script>

</body>
</html>