<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</title>

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- LoadingSystem v2.0.0 - Inline Implementation -->
  <style>
    /* LoadingSystem v2.0.0 - Inline CSS */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .loading-overlay.active {
      opacity: 1;
    }

    .loading-overlay.dark {
      background: rgba(0, 0, 0, 0.9);
    }

    .loading-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 320px;
      min-width: 280px;
      position: relative;
      overflow: hidden;
    }

    .loading-container.dark {
      background: #1f2937;
      color: white;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-dots {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin: 0 auto 1rem;
    }

    .loading-dots .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffffff;
      animation: dot-bounce 1.4s infinite both;
    }

    .loading-dots .dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots .dot:nth-child(2) { animation-delay: -0.16s; }

    .loading-pulse {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      margin: 0 auto 1rem;
      animation: pulse 2s infinite;
    }

    .loading-progress {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
      position: relative;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
      position: relative;
    }

    .loading-progress-bar.auto {
      width: 0%;
      animation: auto-progress 3s ease-in-out infinite;
    }

    .loading-message {
      font-size: 1rem;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .loading-submessage {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.3;
    }

    .loading-spinner.success {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    .loading-spinner.warning {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    .loading-spinner.error {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes dot-bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
    }

    @keyframes auto-progress {
      0% { width: 0%; }
      70% { width: 90%; }
      100% { width: 100%; }
    }

    @media (max-width: 640px) {
      .loading-container {
        margin: 1rem;
        padding: 1.5rem;
        min-width: auto;
      }
      
      .loading-message {
        font-size: 0.9rem;
      }
      
      .loading-submessage {
        font-size: 0.8rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .loading-spinner {
        animation: none;
      }
      
      .loading-dots .dot {
        animation: none;
      }
      
      .loading-pulse {
        animation: none;
      }
      
      .loading-progress-bar.auto {
        animation: none;
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .loading-overlay {
        background: rgba(0, 0, 0, 0.9);
      }
      
      .loading-container {
        background: #1f2937;
        color: white;
      }
    }

    .dark .loading-overlay {
      background: rgba(0, 0, 0, 0.9);
    }

    .dark .loading-container {
      background: #1f2937;
      color: white;
    }

    [data-theme="dark"] .loading-overlay {
      background: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .loading-container {
      background: #1f2937;
      color: white;
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline JavaScript
    window.LoadingSystem = (function() {
      let activeLoaders = new Map();
      let loaderCounter = 0;

      // Detect dark mode
      function isDarkMode() {
        return document.documentElement.classList.contains('dark') ||
               document.documentElement.getAttribute('data-theme') === 'dark' ||
               (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      }

      // Create loading overlay
      function createOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = `loading-overlay ${isDarkMode() ? 'dark' : ''}`;
    
        const container = document.createElement('div');
        container.className = `loading-container ${isDarkMode() ? 'dark' : ''}`;
    
        // Create spinner based on type
        let spinnerHTML = '';
        switch (options.type) {
          case 'dots':
            spinnerHTML = '<div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
            break;
          case 'pulse':
            spinnerHTML = '<div class="loading-pulse"></div>';
            break;
          default:
            spinnerHTML = `<div class="loading-spinner ${options.variant || ''}"></div>`;
        }
    
        container.innerHTML = spinnerHTML;
    
        // Add message
        if (options.message) {
          const messageEl = document.createElement('div');
          messageEl.className = 'loading-message';
          messageEl.textContent = options.message;
          container.appendChild(messageEl);
        }
    
        // Add submessage
        if (options.submessage) {
          const submessageEl = document.createElement('div');
          submessageEl.className = 'loading-submessage';
          submessageEl.textContent = options.submessage;
          container.appendChild(submessageEl);
        }
    
        // Add progress bar
        if (options.progress !== undefined || options.autoProgress) {
          const progressContainer = document.createElement('div');
          progressContainer.className = 'loading-progress';
    
          const progressBar = document.createElement('div');
          progressBar.className = `loading-progress-bar ${options.autoProgress ? 'auto' : ''}`;
    
          if (options.progress !== undefined) {
            progressBar.style.width = `${Math.max(0, Math.min(100, options.progress))}%`;
          }
    
          progressContainer.appendChild(progressBar);
          container.appendChild(progressContainer);
        }
    
        overlay.appendChild(container);
        return overlay;
      }

      // Public API
      return {
        show: function(options = {}) {
          try {
            const loaderId = `loader-${++loaderCounter}-${Date.now()}`;
    
            // Default options
            const defaultOptions = {
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
              type: 'spinner',
              variant: '',
              timeout: 30000,
              autoProgress: false
            };
    
            const config = { ...defaultOptions, ...options };
    
            // Create overlay
            const overlay = createOverlay(config);
            overlay.setAttribute('data-loader-id', loaderId);
    
            // Add to DOM
            document.body.appendChild(overlay);
    
            // Force reflow and show
            overlay.offsetHeight;
            overlay.classList.add('active');
    
            // Store reference
            activeLoaders.set(loaderId, {
              overlay: overlay,
              options: config,
              startTime: Date.now()
            });
    
            // Auto-hide after timeout
            if (config.timeout > 0) {
              setTimeout(() => {
                this.hide(loaderId);
              }, config.timeout);
            }
    
            return loaderId;
          } catch (error) {
            console.error('LoadingSystem.show error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const overlay = loader.overlay;
            if (overlay && overlay.parentNode) {
              overlay.classList.remove('active');
              setTimeout(() => {
                if (overlay.parentNode) {
                  overlay.parentNode.removeChild(overlay);
                }
              }, 300);
            }
    
            activeLoaders.delete(loaderId);
          } catch (error) {
            console.error('LoadingSystem.hide error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(id => this.hide(id));
          } catch (error) {
            console.error('LoadingSystem.hideAll error:', error);
          }
        },

        updateMessage: function(loaderId, message, submessage) {
          try {
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const overlay = loader.overlay;
            const messageEl = overlay.querySelector('.loading-message');
            const submessageEl = overlay.querySelector('.loading-submessage');
    
            if (messageEl && message) {
              messageEl.textContent = message;
            }
    
            if (submessageEl && submessage) {
              submessageEl.textContent = submessage;
            } else if (submessage && !submessageEl) {
              const newSubmessage = document.createElement('div');
              newSubmessage.className = 'loading-submessage';
              newSubmessage.textContent = submessage;
              overlay.querySelector('.loading-container').appendChild(newSubmessage);
            }
          } catch (error) {
            console.error('LoadingSystem.updateMessage error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          try {
            const loader = activeLoaders.get(loaderId);
            if (!loader) return;
    
            const progressBar = loader.overlay.querySelector('.loading-progress-bar');
            if (progressBar) {
              progressBar.classList.remove('auto');
              progressBar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
            }
          } catch (error) {
            console.error('LoadingSystem.updateProgress error:', error);
          }
        },

        completeProgress: function(loaderId, hideAfter = 1000) {
          try {
            this.updateProgress(loaderId, 100);
            if (hideAfter > 0) {
              setTimeout(() => this.hide(loaderId), hideAfter);
            }
          } catch (error) {
            console.error('LoadingSystem.completeProgress error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveLoaders: function() {
          return Array.from(activeLoaders.keys());
        }
      };
    })();

    // Backward compatibility
    window.showLoading = function(show = true, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
      if (show) {
        return window.LoadingSystem.show({ message });
      } else {
        window.LoadingSystem.hideAll();
      }
    };

    console.log('‚úÖ LoadingSystem v2.0.0 initialized successfully');
  </script>

  <script src="../js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <!-- Security & Audit Enhancement -->
  <script src="../js/security-manager.js"></script>
  <script src="../js/audit-logger.js"></script>
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Development ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô -->
  <!-- TODO: ‡πÉ‡∏ô Production ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ Tailwind CLI ‡∏´‡∏£‡∏∑‡∏≠ PostCSS plugin ‡πÅ‡∏ó‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js for better interactions -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>

  <!-- Animation library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
          },
          boxShadow: {
            'card': '0 4px 20px -2px rgba(0,0,0,0.1)',
          }
        },
      },
      daisyui: {
        themes: [
          {
            light: {
              primary: '#0ea5e9',
              'primary-focus': '#0284c7',
              'primary-content': '#ffffff',
              secondary: '#f3f4f6',
              accent: '#10b981',
              neutral: '#374151',
              'base-100': '#ffffff',
              'base-200': '#f9fafb',
              'base-300': '#d1d5db',
              info: '#3abff8',
              success: '#36d399',
              warning: '#fbbd23',
              error: '#f87272',
            },
          },
          'dark',
          'corporate'
        ],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />

  <!-- Firebase v9 SDKs -->
  <script type="module">
    // Import Firebase v9 SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      off, 
      serverTimestamp, 
      onDisconnect, 
      remove 
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase Configuration - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo0",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Make Firebase functions globally available
    window.Firebase = {
      app,
      database,
      ref,
      set,
      get,
      push,
      onValue,
      off,
      serverTimestamp,
      onDisconnect,
      remove
    };

    console.log('üî• Firebase initialized successfully for receipt voucher system');
  </script>

  <!-- Enhanced Firebase Realtime Database + Socket.IO Integration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== FIREBASE REALTIME DATABASE + SOCKET.IO INTEGRATION ====================
    
    // Enhanced Socket.IO Configuration - ‡πÉ‡∏ä‡πâ Global Socket
    let receiptVoucherSocket;
    let socketConnected = false;
    let firebaseConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;
    let onlineUsers = 0;

    // Make receiptVoucherSocket globally accessible
    window.receiptVoucherSocket = null;

    // Current session data
    const currentSession = {
      branchCode: '',
      sessionId: '',
      staffId: localStorage.getItem('userId') || 'anonymous',
      staffName: localStorage.getItem('userName') || 'Unknown',
      timestamp: Date.now(),
      page: 'receipt-voucher'
    };

    // Firebase References
    let firebaseRefs = {};

    // Initialize Enhanced Socket.IO
    function initializeEnhancedSocket() {
      if (typeof io === 'function') {
        socket = io({
          timeout: 10000,
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          randomizationFactor: 0.5
        });

        // Connection Events
        receiptVoucherSocket.on('connect', () => {
          console.log('üîó Socket.IO connected for receipt voucher:', receiptVoucherSocket.id);
          socketConnected = true;
          reconnectAttempts = 0;

          // Join receipt voucher specific rooms
          receiptVoucherSocket.emit('join_branch', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher',
            staffId: currentSession.staffId,
            staffName: currentSession.staffName,
            timestamp: new Date().toISOString()
          });

          receiptVoucherSocket.emit('join_notification_room', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher'
          });

          // Start heartbeat
          startHeartbeat();
        });

        receiptVoucherSocket.on('disconnect', (reason) => {
          console.log('‚ùå Socket.IO disconnected:', reason);
          socketConnected = false;
          stopHeartbeat();
    
          if (reason === 'io server disconnect') {
            receiptVoucherSocket.connect();
          }
        });

        // Enhanced Event Handlers for Receipt Voucher System
        receiptVoucherSocket.on('receipt_voucher_created', (data) => {
          console.log('üí∞ Receipt voucher created:', data);
          console.log(`üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          // Integration with Alpine.js
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(`üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || '‡πÉ‡∏´‡∏°‡πà'} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    
            // Reload receipts data
            if (typeof alpineApp.loadReceipts === 'function') {
              alpineApp.loadReceipts();
            }
    
            // Update dashboard stats
            if (typeof alpineApp.updateDashboardStats === 'function') {
              alpineApp.updateDashboardStats();
            }
          }

          // Send to Firebase
          sendReceiptVoucherToFirebase(data);
        });

        receiptVoucherSocket.on('receipt_voucher_updated', (data) => {
          console.log('üìù Receipt voucher updated:', data);
          console.log(`üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'info');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_approved', (data) => {
          console.log('‚úÖ Receipt voucher approved:', data);
          console.log(`‚úÖ ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`‚úÖ ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, 'success');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_cancelled', (data) => {
          console.log('‚ùå Receipt voucher cancelled:', data);
          console.log(`‚ùå ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`‚ùå ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`, 'warning');
            alpineApp.loadReceipts?.();
          }
        });

        // Auto Creation Events
        receiptVoucherSocket.on('auto_creation_started', (data) => {
          console.log('üöÄ Auto creation started:', data);
          console.log(`üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.total || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showAutoCreateToast = true;
            alpineApp.autoCreateMessage = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.total || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            alpineApp.autoCreateProgress = 0;
          }
        });

        receiptVoucherSocket.on('auto_creation_progress', (data) => {
          console.log('‚ö° Auto creation progress:', data);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            // Update progress modal if open
            if (alpineApp.showAutoProgressModal) {
              alpineApp.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            // Update toast if showing
            if (alpineApp.showAutoCreateToast) {
              alpineApp.autoCreateMessage = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${data.processed || 0}/${data.total || 0}`;
              alpineApp.autoCreateProgress = data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0;
            }
          }
        });

        receiptVoucherSocket.on('auto_creation_completed', (data) => {
          console.log('üéâ Auto creation completed:', data);
          console.log(`üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.success}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${data.failed}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            const message = data.failed > 0
              ? `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${data.failed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
              : `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            const type = data.failed > 0 ? 'warning' : 'success';
    
            alpineApp.showNotification?.(message, type);
            alpineApp.loadReceipts?.();
            alpineApp.updateDashboardStats?.();
    
            // Hide progress modal if open
            if (alpineApp.showAutoProgressModal) {
              setTimeout(() => {
                alpineApp.showAutoProgressModal = false;
                if (typeof alpineApp.cancelAutoCreation === 'function') {
                  alpineApp.cancelAutoCreation();
                }
              }, 2000);
            }
    
            // Hide toast
            alpineApp.showAutoCreateToast = false;
          }
        });

        // System Events
        receiptVoucherSocket.on('branch_notification', (data) => {
          console.log('üîî Branch notification:', data);
          console.log(data.message || 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        receiptVoucherSocket.on('system_notification', (data) => {
          console.log('üîß System notification:', data);
          console.log(`üîß ${data.message}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        // Error handling
        receiptVoucherSocket.on('connect_error', (error) => {
          console.error('‚ùå Socket.IO connect error:', error);
          socketConnected = false;
        });

        receiptVoucherSocket.on('error', (error) => {
          console.error('‚ùå Socket.IO error:', error);
          console.log('üî• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO');
        });

        console.log('‚úÖ Enhanced Socket.IO initialized for receipt voucher system');
      } else {
        console.warn('‚ö†Ô∏è Socket.IO script not loaded for receipt voucher system');
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info with current branch
        currentSession.branchCode = window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'default';
        currentSession.sessionId = `receipt-voucher-${currentSession.staffId}-${Date.now()}`;

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          receiptVoucherUpdates: ref(database, `pos/${currentSession.branchCode}/receiptVoucherUpdates`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? 'üî• Firebase connected' : '‚ùå Firebase disconnected');
          firebaseConnected = connected;
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                console.log(notification.message);
              }
            });
          }
        });

        // Listen for receipt voucher updates
        onValue(firebaseRefs.receiptVoucherUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('üí∞ Receipt voucher update:', update);
                console.log(`üí∞ ${update.message || '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô'}`);
    
                // Trigger Alpine.js updates if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp && typeof alpineApp.loadReceipts === 'function') {
                  alpineApp.loadReceipts();
                }
              }
            });
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
        });

        console.log('üî• Firebase listeners setup successfully for receipt voucher');
      } catch (error) {
        console.error('‚ùå Firebase setup error:', error);
        firebaseConnected = false;
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });

        console.log('üìù Session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('‚ùå Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const activityHistoryRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/activityHistory`);
        const { push } = window.Firebase;
        push(activityHistoryRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('‚ùå Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'receipt-voucher'
        });
        console.log('üîî Notification sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send notification:', error);
      }
    }

    // Send receipt voucher data to Firebase
    function sendReceiptVoucherToFirebase(receiptData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        const receiptRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/receiptVouchers`);
        push(receiptRef, {
          ...receiptData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'receipt-voucher'
        });
        console.log('üí∞ Receipt voucher data sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send receipt voucher data:', error);
      }
    }

         // Heartbeat system
     function startHeartbeat() {
       heartbeatInterval = setInterval(() => {
         if (receiptVoucherSocket && socketConnected) {
           receiptVoucherSocket.emit('ping', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher',
             timestamp: Date.now()
           });
         }
    
         // Update Firebase activity
         updateActivity('heartbeat');
       }, 30000); // 30 seconds
     }

     function stopHeartbeat() {
       if (heartbeatInterval) {
         clearInterval(heartbeatInterval);
         heartbeatInterval = null;
       }
     }

     // Enhanced Socket.IO Functions
     function emitReceiptVoucherUpdate(data) {
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.emit('receipt_voucher_update', {
           branchCode: currentSession.branchCode,
           ...data,
           timestamp: Date.now()
         });
       }
    
       // Also send to Firebase
       sendReceiptVoucherToFirebase(data);
     }

     function emitReceiptVoucherCreated(data) {
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.emit('receipt_voucher_created', {
           branchCode: currentSession.branchCode,
           ...data,
           timestamp: Date.now()
         });
       }
    
       // Send to Firebase
       sendReceiptVoucherToFirebase(data);
     }

         // Get connection status
     function getConnectionStatus() {
       return {
         firebase: firebaseConnected,
         socket: socketConnected,
         combined: firebaseConnected && socketConnected,
         onlineUsers: onlineUsers,
         sessionId: currentSession.sessionId,
         branchCode: currentSession.branchCode
       };
     }

     // Global functions for receipt voucher system
     window.ReceiptVoucherConnection = {
       emitReceiptVoucherUpdate,
       emitReceiptVoucherCreated,
       sendNotificationToFirebase,
       sendReceiptVoucherToFirebase,
       updateActivity,
       getConnectionStatus,
       currentSession,
       firebaseRefs
     };

     // Test functions for debugging
     window.testReceiptVoucherConnection = function() {
       console.log('üß™ Testing Receipt Voucher connections...');
       const status = getConnectionStatus();
       console.log('üìä Connection Status:', status);
    
       // Test Firebase
       if (status.firebase) {
         console.log('‚úÖ Firebase: Connected');
         updateActivity('connection_test');
       } else {
         console.log('‚ùå Firebase: Disconnected');
       }
    
       // Test Socket.IO
       if (status.socket) {
         console.log('‚úÖ Socket.IO: Connected');
         receiptVoucherSocket.emit('test_receipt_voucher', { message: 'Test from receipt voucher page' });
       } else {
         console.log('‚ùå Socket.IO: Disconnected');
       }
    
       return status;
     };

     // Initialize both systems when page loads
     document.addEventListener('DOMContentLoaded', () => {
       console.log('üöÄ Initializing Firebase + Socket.IO for receipt voucher system...');
    
       // Set branch code from global variable
       if (window.BRANCH_CODE) {
         currentSession.branchCode = window.BRANCH_CODE;
       }
    
       initializeEnhancedSocket();
       initializeFirebase();
    
       // Wait for Alpine.js to be ready
       setTimeout(() => {
         const alpineApp = document.querySelector('[x-data="app"]')?.__x;
         if (alpineApp) {
           console.log('üéØ Alpine.js detected, integration ready');
         }
       }, 1000);
     });

     // Cleanup on page unload
     window.addEventListener('beforeunload', () => {
       console.log('üßπ Cleaning up receipt voucher connections...');
       stopHeartbeat();
    
       if (window.Firebase && firebaseRefs.sessions) {
         window.Firebase.remove(firebaseRefs.sessions);
       }
    
       if (receiptVoucherSocket && socketConnected) {
         receiptVoucherSocket.disconnect();
       }
     });

    console.log('üî• Firebase Realtime Database + Socket.IO integration loaded for receipt voucher');
  </script>

  <!-- Duplicate Firebase + Socket.IO scripts removed to prevent double initialization -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ==================== ADDITIONAL FIREBASE + SOCKET.IO FUNCTIONS ====================

    // Initialize Enhanced Socket.IO for Receipt Voucher
    function initializeEnhancedSocket() {
       if (typeof io === 'function') {
         receiptVoucherSocket = io({
           timeout: 10000,
           reconnection: true,
           reconnectionAttempts: 5,
           reconnectionDelay: 1000,
           reconnectionDelayMax: 5000,
           randomizationFactor: 0.5
         });

         // Make it globally accessible
         window.receiptVoucherSocket = receiptVoucherSocket;

         // Connection Events
         receiptVoucherSocket.on('connect', () => {
           console.log('üîó Socket.IO connected for receipt voucher:', receiptVoucherSocket.id);
           socketConnected = true;
           reconnectAttempts = 0;

           // Join receipt voucher specific rooms
           receiptVoucherSocket.emit('join_branch', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher',
             staffId: currentSession.staffId,
             staffName: currentSession.staffName,
             timestamp: new Date().toISOString()
           });

           receiptVoucherSocket.emit('join_notification_room', {
             branchCode: currentSession.branchCode,
             page: 'receipt-voucher'
           });

           // Start heartbeat
           startHeartbeat();
         });

         receiptVoucherSocket.on('disconnect', (reason) => {
           console.log('‚ùå Socket.IO disconnected:', reason);
           socketConnected = false;
           stopHeartbeat();
    
           if (reason === 'io server disconnect') {
             receiptVoucherSocket.connect();
           }
         });

         receiptVoucherSocket.on('reconnect', (attemptNumber) => {
           console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
           socketConnected = true;
           reconnectAttempts = 0;
           console.log('üîÑ Receipt Voucher: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
         });

        // Enhanced Event Handlers for Receipt Voucher System
        receiptVoucherSocket.on('receipt_voucher_created', (data) => {
          console.log('üí∞ Receipt voucher created:', data);
          console.log(`üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          // Integration with Alpine.js
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(`üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || '‡πÉ‡∏´‡∏°‡πà'} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
    
            // Reload receipts data
            if (typeof alpineApp.loadReceipts === 'function') {
              alpineApp.loadReceipts();
            }
    
            // Update dashboard stats
            if (typeof alpineApp.updateDashboardStats === 'function') {
              alpineApp.updateDashboardStats();
            }
          }

          // Send to Firebase
          sendReceiptVoucherToFirebase(data);
        });

        receiptVoucherSocket.on('receipt_voucher_updated', (data) => {
          console.log('üìù Receipt voucher updated:', data);
          console.log(`üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`üìù ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'info');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_approved', (data) => {
          console.log('‚úÖ Receipt voucher approved:', data);
          console.log(`‚úÖ ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`‚úÖ ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, 'success');
            alpineApp.loadReceipts?.();
          }
        });

        receiptVoucherSocket.on('receipt_voucher_cancelled', (data) => {
          console.log('‚ùå Receipt voucher cancelled:', data);
          console.log(`‚ùå ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showNotification?.(`‚ùå ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${data.documentNumber || ''} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`, 'warning');
            alpineApp.loadReceipts?.();
          }
        });

        // Auto Creation Events
        receiptVoucherSocket.on('auto_creation_started', (data) => {
          console.log('üöÄ Auto creation started:', data);
          console.log(`üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.total || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            alpineApp.showAutoCreateToast = true;
            alpineApp.autoCreateMessage = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${data.total || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            alpineApp.autoCreateProgress = 0;
          }
        });

        receiptVoucherSocket.on('auto_creation_progress', (data) => {
          console.log('‚ö° Auto creation progress:', data);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            // Update progress modal if open
            if (alpineApp.showAutoProgressModal) {
              alpineApp.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            // Update toast if showing
            if (alpineApp.showAutoCreateToast) {
              alpineApp.autoCreateMessage = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${data.processed || 0}/${data.total || 0}`;
              alpineApp.autoCreateProgress = data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0;
            }
          }
        });

        receiptVoucherSocket.on('auto_creation_completed', (data) => {
          console.log('üéâ Auto creation completed:', data);
          console.log(`üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.success}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${data.failed}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp) {
            const message = data.failed > 0
              ? `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${data.failed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
              : `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            const type = data.failed > 0 ? 'warning' : 'success';
    
            alpineApp.showNotification?.(message, type);
            alpineApp.loadReceipts?.();
            alpineApp.updateDashboardStats?.();
    
            // Hide progress modal if open
            if (alpineApp.showAutoProgressModal) {
              setTimeout(() => {
                alpineApp.showAutoProgressModal = false;
                if (typeof alpineApp.cancelAutoCreation === 'function') {
                  alpineApp.cancelAutoCreation();
                }
              }, 2000);
            }
    
            // Hide toast
            alpineApp.showAutoCreateToast = false;
          }
        });

        // System Events
        receiptVoucherSocket.on('branch_notification', (data) => {
          console.log('üîî Branch notification:', data);
          console.log(data.message || 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        receiptVoucherSocket.on('system_notification', (data) => {
          console.log('üîß System notification:', data);
          console.log(`üîß ${data.message}`);
    
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && data.message) {
            alpineApp.showNotification?.(data.message, data.type || 'info');
          }
        });

        // Error handling
        receiptVoucherSocket.on('connect_error', (error) => {
          console.error('‚ùå Socket.IO connect error:', error);
          socketConnected = false;
        });

        receiptVoucherSocket.on('error', (error) => {
          console.error('‚ùå Socket.IO error:', error);
          console.log('üî• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO');
        });

        console.log('‚úÖ Enhanced Socket.IO initialized for receipt voucher system');
      } else {
        console.warn('‚ö†Ô∏è Socket.IO script not loaded for receipt voucher system');
      }
    }

    // Initialize Firebase Realtime Database
    function initializeFirebase() {
      // Wait for Firebase to be available
      const checkFirebase = setInterval(() => {
        if (window.Firebase && window.Firebase.database) {
          clearInterval(checkFirebase);
          setupFirebaseListeners();
        }
      }, 100);
    }

    // Setup Firebase Listeners for Receipt Voucher
    function setupFirebaseListeners() {
      try {
        const { database, ref, onValue, off } = window.Firebase;
    
        // Update session info with current branch
        currentSession.branchCode = window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'default';
        currentSession.sessionId = `receipt-voucher-${currentSession.staffId}-${Date.now()}`;

        console.log('üî• Setting up Firebase listeners for branch:', currentSession.branchCode);

        // Setup Firebase references
        firebaseRefs = {
          notifications: ref(database, `pos/${currentSession.branchCode}/notifications`),
          sessions: ref(database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`),
          receiptVoucherUpdates: ref(database, `pos/${currentSession.branchCode}/receiptVoucherUpdates`),
          receiptVouchers: ref(database, `pos/${currentSession.branchCode}/receiptVouchers`),
          onlineUsers: ref(database, `pos/${currentSession.branchCode}/onlineUsers`),
          activityHistory: ref(database, `pos/${currentSession.branchCode}/activityHistory`),
          connection: ref(database, '.info/connected')
        };

        // Register session
        registerSession();

        // Connection monitoring
        onValue(firebaseRefs.connection, (snapshot) => {
          const connected = snapshot.val();
          console.log(connected ? 'üî• Firebase connected' : '‚ùå Firebase disconnected');
          firebaseConnected = connected;
    
          if (connected) {
            // Setup onDisconnect handlers
            const { onDisconnect } = window.Firebase;
            onDisconnect(firebaseRefs.sessions).remove();
            onDisconnect(ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
    
            console.log('üî• Firebase connection established for receipt voucher');
          }
        });

        // Listen for notifications
        onValue(firebaseRefs.notifications, (snapshot) => {
          const notifications = snapshot.val();
          if (notifications) {
            Object.entries(notifications).forEach(([key, notification]) => {
              if (notification.timestamp > currentSession.timestamp && !notification.read) {
                console.log('üîî New notification:', notification.message);
    
                // Show in Alpine.js if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp && notification.message) {
                  alpineApp.showNotification?.(notification.message, notification.type || 'info');
                }
              }
            });
          }
        });

        // Listen for receipt voucher updates
        onValue(firebaseRefs.receiptVoucherUpdates, (snapshot) => {
          const updates = snapshot.val();
          if (updates) {
            Object.entries(updates).forEach(([key, update]) => {
              if (update.timestamp > currentSession.timestamp) {
                console.log('üí∞ Receipt voucher update:', update);
                console.log(`üí∞ ${update.message || '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô'}`);
    
                // Trigger Alpine.js updates if available
                const alpineApp = document.querySelector('[x-data="app"]')?.__x;
                if (alpineApp) {
                  if (typeof alpineApp.loadReceipts === 'function') {
                    alpineApp.loadReceipts();
                  }
                  if (typeof alpineApp.updateDashboardStats === 'function') {
                    alpineApp.updateDashboardStats();
                  }
                }
              }
            });
          }
        });

        // Listen for new receipt vouchers
        onValue(firebaseRefs.receiptVouchers, (snapshot) => {
          const receiptVouchers = snapshot.val();
          if (receiptVouchers) {
            const latestReceipts = Object.entries(receiptVouchers)
              .filter(([key, receipt]) => receipt.timestamp > currentSession.timestamp)
              .sort((a, b) => b[1].timestamp - a[1].timestamp);
    
            if (latestReceipts.length > 0) {
              console.log(`üí∞ ${latestReceipts.length} new receipt voucher(s) detected`);
    
              // Trigger reload in Alpine.js
              const alpineApp = document.querySelector('[x-data="app"]')?.__x;
              if (alpineApp && typeof alpineApp.loadReceipts === 'function') {
                alpineApp.loadReceipts();
              }
            }
          }
        });

        // Listen for online users count
        onValue(firebaseRefs.onlineUsers, (snapshot) => {
          const users = snapshot.val();
          const count = users ? Object.keys(users).length : 0;
          onlineUsers = count;
          console.log(`üë• Online users in receipt voucher: ${count}`);
        });

        console.log('üî• Firebase listeners setup successfully for receipt voucher');
      } catch (error) {
        console.error('‚ùå Firebase setup error:', error);
        firebaseConnected = false;
      }
    }

    // Register current session
    function registerSession() {
      try {
        const { set, serverTimestamp } = window.Firebase;
    
        // Register session
        set(firebaseRefs.sessions, {
          ...currentSession,
          timestamp: serverTimestamp(),
          lastActivity: serverTimestamp()
        });

        // Register as online user
        const onlineUserRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`);
        set(onlineUserRef, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });

        console.log('üìù Receipt voucher session registered:', currentSession.sessionId);
      } catch (error) {
        console.error('‚ùå Session registration error:', error);
      }
    }

    // Update activity
    function updateActivity(activity) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { set, serverTimestamp } = window.Firebase;
        const activityRef = window.Firebase.ref(window.Firebase.database, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`);
        set(activityRef, serverTimestamp());
    
        // Log activity
        const { push } = window.Firebase;
        push(firebaseRefs.activityHistory, {
          sessionId: currentSession.sessionId,
          staffId: currentSession.staffId,
          activity: activity,
          page: 'receipt-voucher',
          timestamp: serverTimestamp()
        });
      } catch (error) {
        console.error('‚ùå Activity update error:', error);
      }
    }

    // Send notification to Firebase
    function sendNotificationToFirebase(notification) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.notifications, {
          ...notification,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          source: 'receipt-voucher'
        });
        console.log('üîî Notification sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send notification:', error);
      }
    }

    // Send receipt voucher data to Firebase
    function sendReceiptVoucherToFirebase(receiptData) {
      if (!firebaseConnected || !window.Firebase) return;
    
      try {
        const { push, serverTimestamp } = window.Firebase;
        push(firebaseRefs.receiptVouchers, {
          ...receiptData,
          timestamp: serverTimestamp(),
          branchCode: currentSession.branchCode,
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          source: 'receipt-voucher'
        });
        console.log('üí∞ Receipt voucher data sent to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to send receipt voucher data:', error);
      }
    }

    // Heartbeat system
    function startHeartbeat() {
      heartbeatInterval = setInterval(() => {
        if (receiptVoucherSocket && socketConnected) {
          receiptVoucherSocket.emit('ping', {
            branchCode: currentSession.branchCode,
            page: 'receipt-voucher',
            timestamp: Date.now()
          });
        }
    
        // Update Firebase activity
        updateActivity('heartbeat');
      }, 30000); // 30 seconds
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // Enhanced Socket.IO Functions
    function emitReceiptVoucherUpdate(data) {
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.emit('receipt_voucher_update', {
          branchCode: currentSession.branchCode,
          ...data,
          timestamp: Date.now()
        });
      }
    
      // Also send to Firebase
      sendReceiptVoucherToFirebase(data);
    }

    function emitReceiptVoucherCreated(data) {
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.emit('receipt_voucher_created', {
          branchCode: currentSession.branchCode,
          ...data,
          timestamp: Date.now()
        });
      }
    
      // Send to Firebase
      sendReceiptVoucherToFirebase(data);
    }

    // Get connection status
    function getConnectionStatus() {
      return {
        firebase: firebaseConnected,
        socket: socketConnected,
        combined: firebaseConnected && socketConnected,
        onlineUsers: onlineUsers,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode
      };
    }

    // Global functions for receipt voucher system
    window.ReceiptVoucherConnection = {
      emitReceiptVoucherUpdate,
      emitReceiptVoucherCreated,
      sendNotificationToFirebase,
      sendReceiptVoucherToFirebase,
      updateActivity,
      getConnectionStatus,
      currentSession,
      firebaseRefs
    };

    // Test functions for debugging
    window.testReceiptVoucherConnection = function() {
      console.log('üß™ Testing Receipt Voucher connections...');
      const status = getConnectionStatus();
      console.log('üìä Connection Status:', status);
    
      // Test Firebase
      if (status.firebase) {
        console.log('‚úÖ Firebase: Connected');
        updateActivity('connection_test');
      } else {
        console.log('‚ùå Firebase: Disconnected');
      }
    
      // Test Socket.IO
      if (status.socket) {
        console.log('‚úÖ Socket.IO: Connected');
        receiptVoucherSocket.emit('test_receipt_voucher', { message: 'Test from receipt voucher page' });
      } else {
        console.log('‚ùå Socket.IO: Disconnected');
      }
    
      return status;
    };

            // Global guard to prevent duplicate initialization
        if (window.receiptVoucherSocketInitialized) {
          console.log('üõë Firebase + Socket.IO already initialized globally, skipping');
        } else {
          window.receiptVoucherSocketInitialized = true;
    
          // Initialize both systems when page loads
          document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Firebase + Socket.IO for receipt voucher system...');
    
            // Set branch code from global variable
            if (window.BRANCH_CODE) {
              currentSession.branchCode = window.BRANCH_CODE;
            }
    
            initializeEnhancedSocket();
            initializeFirebase();
    
            // Wait for Alpine.js to be ready
            setTimeout(() => {
              const alpineApp = document.querySelector('[x-data="app"]')?.__x;
              if (alpineApp) {
                console.log('üéØ Alpine.js detected, integration ready');
              }
            }, 1000);
          });
        }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      console.log('üßπ Cleaning up receipt voucher connections...');
      stopHeartbeat();
    
      if (window.Firebase && firebaseRefs.sessions) {
        window.Firebase.remove(firebaseRefs.sessions);
      }
    
      if (receiptVoucherSocket && socketConnected) {
        receiptVoucherSocket.disconnect();
      }
    });

    console.log('üî• Firebase Realtime Database + Socket.IO integration loaded for receipt voucher');
  </script>

  <!-- Page Styles -->
    <link rel="stylesheet" href="/views/pattani/receiptVoucher.css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

</head>

<body x-data="app" x-init="init()">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ sidebar.js -->
  <div id="sidebarContainer"></div>

  <div id="mainContent" class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header
      class="p-4 bg-white dark:bg-gray-800
             border-b border-gray-200 dark:border-gray-700
             flex items-center justify-between"
    >
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
      </div>
    </header>

    <!-- Main Content Container -->
    <div class="flex-1 p-6 bg-gray-50 dark:bg-gray-900">
      <div class="container mx-auto max-w-6xl">
        <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å -->
      <div class="receipt-header flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div class="mb-4 md:mb-0">
          <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-1">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>
          <p class="text-gray-500 dark:text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</p>

        </div>

        <div class="flex space-x-3">
          <!-- Add Receipt Button -->
          <button id="btnAddReceipt" @click="openAddReceiptModal()"
            class="btn btn-primary btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors">
            <i class="bi bi-plus-lg text-white"></i>
            <span class="text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
          </button>

          <!-- Create from Receipt Button -->
          <button @click="checkPendingItems()"
            class="btn btn-success btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors">
            <i class="bi bi-receipt text-white"></i>
            <span class="text-white">‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
            <span x-show="summary.pendingReceiptCount > 0" 
                  class="ml-1 px-2 py-1 bg-white text-green-600 rounded-full text-xs font-bold"
                  x-text="summary.pendingReceiptCount"></span>
          </button>
          
          <!-- Auto Create Button -->
          <button @click="triggerAutoCreation()"
            class="btn btn-warning btn-sm normal-case flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors"
            :disabled="isAutoCreating">
            <i class="bi bi-magic text-white" :class="{'animate-spin': isAutoCreating}"></i>
            <span class="text-white" x-text="isAutoCreating ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
          </button>

          <!-- Filter button -->
          <div class="dropdown dropdown-end">
            <button
              class="btn btn-ghost btn-sm normal-case border border-gray-300 dark:border-gray-600 flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
              <i class="bi bi-funnel text-gray-500 dark:text-gray-400"></i>
              <span class="text-gray-700 dark:text-gray-300">‡∏Å‡∏£‡∏≠‡∏á</span>
            </button>
            <div tabindex="0"
              class="dropdown-content menu p-4 shadow bg-white dark:bg-gray-800 rounded-box w-64 mt-1 border border-gray-200 dark:border-gray-700">
              <div class="mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <div class="flex space-x-2 mt-1">
                  <input type="date"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                  <input type="date"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                </div>
              </div>
              <div class="mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <select class="w-full mt-1 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded">
                  <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                  <option>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                </select>
              </div>
              <div class="flex justify-end">
                <button
                  class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded transition">‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ</button>
              </div>
            </div>
          </div>

          <!-- Export PDF button -->
          <div class="dropdown dropdown-end">
            <button
              class="btn btn-ghost btn-sm normal-case border border-gray-300 dark:border-gray-600 flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
              <i class="bi bi-file-earmark-pdf text-red-500"></i>
              <span class="text-gray-700 dark:text-gray-300">Export PDF</span>
            </button>
            <div tabindex="0"
              class="dropdown-content menu p-4 shadow bg-white dark:bg-gray-800 rounded-box w-56 mt-1 border border-gray-200 dark:border-gray-700">
              <button @click="exportSelectedPDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-check2-square mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              </button>
              <button @click="exportCurrentPagePDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-file-earmark mr-2"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
              </button>
              <button @click="exportAllPDF()"
                class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                <i class="bi bi-files mr-2"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
        <!-- Card 1: ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div @click="changeTimeRange('amount')"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in cursor-pointer hover:shadow-lg transition-shadow">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="text-xs">(<span x-text="timeRangeText.amount"></span>)</span>
              </p>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1"
                x-text="summary.totalAmountFormatted">‡∏ø0.00</h3>
            </div>
            <div class="p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
              <i class="bi bi-cash-stack text-green-500 dark:text-green-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-center text-sm">
            <span
              :class="summary.amountComparisonPercentage >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400'"
              class="flex items-center">
              <i :class="summary.amountComparisonPercentage >= 0 ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi mr-1"></i>
              <span x-text="Math.abs(summary.amountComparisonPercentage)">0</span>%
            </span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
          </div>
        </div>

        <!-- Card 2: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
        <div @click="changeTimeRange('count')"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in cursor-pointer hover:shadow-lg transition-shadow"
          style="animation-delay: 0.1s">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-xs">(<span x-text="timeRangeText.count"></span>)</span>
              </p>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1" x-text="summary.totalCount">0</h3>
            </div>
            <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
              <i class="bi bi-receipt text-blue-500 dark:text-blue-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3 flex items-center text-sm">
            <span
              :class="summary.countComparisonPercentage >= 0 ? 'text-blue-500 dark:text-blue-400' : 'text-red-500 dark:text-red-400'"
              class="flex items-center">
              <i :class="summary.countComparisonPercentage >= 0 ? 'bi-arrow-up' : 'bi-arrow-down'" class="bi mr-1"></i>
              <span x-text="Math.abs(summary.countComparisonPercentage)">0</span>%
            </span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</span>
          </div>
        </div>

        <!-- Card 3: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô Auto Creation Status -->
        <div @click="showAutoCreationStats()"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in relative overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"
          style="animation-delay: 0.2s">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-5">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="currentColor" stroke-width="0.5" />
              </pattern>
              <rect width="100" height="100" fill="url(#grid)" />
            </svg>
          </div>

          <div class="relative">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö Auto</p>
                <div class="flex items-center mt-2 space-x-2">
                  <div id="autoStatusIcon" class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                  </div>
                  <span id="autoStatusText"
                    class="text-lg font-semibold text-green-600 dark:text-green-400">‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                </div>
              </div>
              <div class="p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
                <i class="bi bi-robot text-green-500 dark:text-green-400 text-xl"></i>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm">
              <span class="text-gray-500 dark:text-gray-400">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
              <span class="font-medium text-green-600 dark:text-green-400" id="todayAutoCount"
                x-text="summary.todayAutoCreatedCount || 0">0</span>
            </div>
          </div>
        </div>

        <!-- Card 4: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-5 border border-gray-100 dark:border-gray-700 slide-in"
          style="animation-delay: 0.3s">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
              <h3 class="text-2xl font-bold mt-1" id="pendingCount">
                <span class="text-amber-600 dark:text-amber-400" x-text="summary.pendingReceiptCount || 0">0</span>
              </h3>
            </div>
            <div class="p-2 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
              <i class="bi bi-receipt text-amber-500 dark:text-amber-400 text-xl"></i>
            </div>
          </div>
          <div class="mt-3">
            <button @click="checkPendingItems()"
              class="text-sm text-amber-600 hover:text-amber-700 dark:text-amber-400 dark:hover:text-amber-300 flex items-center">
              <span>‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
              <i class="bi bi-arrow-right ml-1"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6 mb-8 border border-gray-100 dark:border-gray-700 fade-in">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
          <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3 md:mb-0">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
          </h2>

          <div class="flex items-center space-x-2">
            <!-- Filter by Creation Type -->
            <div
              class="flex space-x-1 border border-gray-300 dark:border-gray-600 rounded-lg p-0.5 bg-gray-50 dark:bg-gray-700">
              <button @click="filterByCreationType('all')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'all' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </button>
              <button @click="filterByCreationType('auto')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'auto' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                <i class="bi bi-robot mr-1"></i> Auto
              </button>
              <button @click="filterByCreationType('manual')" class="px-3 py-1 text-xs rounded-md focus:outline-none"
                :class="currentFilter === 'manual' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'">
                <i class="bi bi-person mr-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
              </button>
            </div>

            <div class="relative">
              <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                  bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="bi bi-search text-gray-400"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="table w-full receipt-table">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="px-4 py-3 text-left">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                <th class="px-4 py-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                <th class="px-4 py-3 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th class="px-4 py-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th class="px-4 py-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="receiptTableBody">
              <!-- ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å <tr> ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å -->
            </tbody>
            <tfoot>
              <tr class="font-semibold">
                <td colspan="4" class="px-4 py-4 text-right text-gray-800 dark:text-gray-200">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
                <td class="px-4 py-4 text-right receipt-total">‡∏ø0.00</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Pagination -->
        <div class="mt-6 flex items-center justify-between">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            ‡πÅ‡∏™‡∏î‡∏á <span x-text="paginationStart"></span> ‡∏ñ‡∏∂‡∏á <span x-text="paginationEnd"></span>
            ‡∏à‡∏≤‡∏Å <span x-text="totalReceipts"></span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </div>
          <div class="flex space-x-1" id="paginationButtons">
            <!-- ‡∏õ‡∏∏‡πà‡∏° pagination ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
          </div>
        </div>
      </div>

      <!-- Confirmation Dialog for Delete -->
      <div id="deleteConfirmDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        x-show="showDeleteModal" x-cloak @click.self="showDeleteModal = false"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
          <div class="text-center">
            <div
              class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
              <i class="bi bi-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?
              ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
            <div class="flex justify-center space-x-3">
              <button @click="showDeleteModal = false"
                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
              <button @click="deleteReceipt()"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
      <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
        x-show="showModal" x-cloak @click.self="showModal = false" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-3xl w-full mx-4"
          @click.outside="showModal = false">
          <!-- Add scrollable container -->
          <div class="max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200" id="modalTitle"
                x-text="receiptId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô'">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
              <button @click="showModal = false" id="closeModal"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            <form id="receiptForm" class="receipt-form p-6" @submit.prevent="submitForm">
              <!-- Document Information Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-group">
                    <div class="form-floating">
                      <input type="text" id="documentNumber" name="documentNumber" required placeholder=" " class="peer"
                        x-bind:value="receiptId ? 'RV' + receiptId.substring(2) : generateDocumentId()">
                      <label for="documentNumber" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="form-floating">
                      <input type="date" id="paymentDate" name="paymentDate" required placeholder=" " class="peer"
                        x-bind:value="new Date().toISOString().substr(0, 10)">
                      <label for="paymentDate" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Account Information Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                  <div class="form-group">
                    <label for="debitAccountCode" class="text-gray-500 dark:text-gray-400">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏ö‡∏¥‡∏ï (‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô) <span
                        class="text-red-500">*</span></label>
                    <select id="debitAccountCode" name="debitAccountCode" required class="mt-1 peer"
                      onchange="updateAccountName(this, 'debitAccountName')">
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                      <template x-for="acc in debitAccounts" :key="acc.code">
                        <option :value="acc.code + '|' + acc.name" x-text="acc.code + ' - ' + acc.name"></option>
                      </template>
                      <option value="" x-show="debitAccounts.length === 0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô</option>
                    </select>
                    <input type="hidden" id="debitAccountName" name="debitAccountName">
                  </div>

                  <div class="form-group">
                    <label for="creditAccountCode" class="text-gray-500 dark:text-gray-400">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï <span
                        class="text-red-500">*</span></label>
                    <select id="creditAccountCode" name="creditAccountCode" required class="mt-1 peer"
                      onchange="updateAccountName(this, 'creditAccountName')">
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                      <template x-for="acc in creditAccounts" :key="acc.code">
                        <option :value="acc.code + '|' + acc.name" x-text="acc.code + ' - ' + acc.name"></option>
                      </template>
                      <!-- Fallback/Example if API fails or for initial render -->
                      <option value="" x-show="creditAccounts.length === 0">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô</option>
                    </select>
                    <input type="hidden" id="creditAccountName" name="creditAccountName">
                  </div>

                  <div class="form-group col-span-2">
                    <div class="form-floating">
                      <input type="text" id="receivedFrom" name="receivedFrom" required placeholder=" " class="peer">
                      <label for="receivedFrom" class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                        ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å <span class="text-red-500">*</span>
                      </label>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="receiptType" class="text-gray-500 dark:text-gray-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô <span
                        class="text-red-500">*</span></label>
                    <select id="receiptType" name="receiptType" required class="mt-1 peer">
                      <option value="cash_sale">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                      <option value="credit_sale">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠</option>
                      <option value="debt_payment">‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</option>
                      <option value="deposit">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</option>
                      <option value="return">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    </select>

                  </div>

                  <div class="form-group">
                    <label for="paymentMethod" class="text-gray-500 dark:text-gray-400">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ <span
                        class="text-red-500">*</span></label>
                    <select id="paymentMethod" name="paymentMethod" required class="mt-1 peer"
                      onchange="togglePaymentDetails(this.value)">
                      <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                      <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                      <option value="cheque">‡πÄ‡∏ä‡πá‡∏Ñ</option>
                      <option value="credit_card">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                    </select>
                  </div>

                  <!-- Bank Details (conditionally shown) -->
                  <div id="bankDetails" style="display:none;" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                      <label for="bankAccount" class="text-gray-500 dark:text-gray-400">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                      <select id="bankAccount" name="bankAccount" class="mt-1 peer">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        <!-- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API -->
                      </select>
                    </div>
                    <!-- Add Cheque Info fields here if needed, similar conditional display -->
                  </div>

                </div>
              </div>

              <!-- Transaction Details Section -->
              <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-6">
                <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h4>

                <!-- Transaction details container -->
                <div id="transactionDetailsContainer" class="space-y-4">
                  <!-- Individual detail rows -->
                  <div class="transaction-detail-entry grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-7">
                      <div class="form-floating">
                        <input type="text" name="transactionDetail[]" required placeholder=" " class="peer" value="">
                        <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-red-500">*</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-span-4">
                      <div class="form-floating relative">
                        <input type="number" step="0.01" name="detailAmount[]" required placeholder=" "
                          class="peer pl-8" value="0" oninput="updateTransactionTotal()">
                        <div
                          class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">
                          ‡∏ø
                        </div>
                        <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">
                          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <span class="text-red-500">*</span>
                        </label>
                      </div>
                    </div>
                    <div class="col-span-1 flex justify-center">
                      <button type="button" class="text-gray-400 hover:text-red-500 focus:outline-none"
                        onclick="removeTransactionDetail(this)">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </div>
                  </div>

                  <button type="button" id="addTransactionDetail" @click="addTransactionDetailEntry()"
                    class="mt-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center text-sm font-medium">
                    <i class="bi bi-plus-circle mr-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </button>

                  <!-- Transaction total -->
                  <div class="mt-4 flex justify-end">
                    <div class="bg-blue-50 dark:bg-blue-900/20 px-4 py-2 rounded-lg">
                      <span class="text-gray-600 dark:text-gray-300 mr-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                      <span id="transactionTotal" class="font-bold text-blue-600 dark:text-blue-400"
                        x-text="'‡∏ø0.00'">‡∏ø0.00</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Notes Section -->
              <div class="form-group mb-6">
                <label for="notes" class="block mb-2 text-gray-700 dark:text-gray-300">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="notes" name="notes" rows="3"
                  class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  x-bind:value="receiptId ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ' + receiptId : ''"></textarea>
              </div>

              <div class="flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" @click="showModal = false" id="cancelBtn"
                  class="px-4 py-2 mr-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-gray-400">
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <i class="bi bi-check2 mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Notification Toast -->
      <div id="notification" x-show="notification.show" x-cloak x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50"
        :class="notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
        <span x-text="notification.message"></span>
      </div>

      <!-- Toast Notification ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto Creation -->
      <div x-show="showAutoCreateToast" x-cloak x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-x-0"
        x-transition:leave-end="opacity-0 transform translate-x-full" class="fixed top-20 right-4 max-w-sm w-full z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl border-l-4 border-green-500 p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                <i class="bi bi-check-circle-fill text-green-500"></i>
              </div>
            </div>
            <div class="ml-3 flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              </p>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" x-text="autoCreateMessage">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
              </p>
            </div>
            <button @click="showAutoCreateToast = false" class="ml-4 text-gray-400 hover:text-gray-600">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <!-- Progress bar -->
          <div class="mt-3 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
            <div class="bg-green-500 h-1.5 rounded-full transition-all duration-300"
              :style="`width: ${autoCreateProgress}%`"></div>
          </div>
        </div>
      </div>

      </div> <!-- End container -->
    </div> <!-- End Main Content Container -->
  </div> <!-- End Main Content -->

  <!-- Auto Configuration Modal -->
    <div id="autoConfigModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
      x-show="showAutoConfigModal" x-cloak @click.self="showAutoConfigModal = false"
      x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-90"
        x-transition:enter-end="opacity-100 transform scale-100">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
            <i class="bi bi-gear mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </h3>
          <button @click="showAutoConfigModal = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- Content -->
        <div class="p-6">
          <!-- Enable/Disable Toggle -->
          <div class="mb-6">
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-gray-700 dark:text-gray-300 font-medium">
                ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              </span>
              <div class="relative">
                <input type="checkbox" x-model="autoConfig.enabled" class="sr-only">
                <div class="w-11 h-6 bg-gray-200 rounded-full shadow-inner"
                  :class="autoConfig.enabled ? 'bg-blue-600' : 'bg-gray-200'"></div>
                <div class="absolute w-4 h-4 bg-white rounded-full shadow top-1 transition-transform duration-200"
                  :class="autoConfig.enabled ? 'translate-x-6' : 'translate-x-1'"></div>
              </div>
            </label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </p>
          </div>

          <!-- Transaction Types -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </h4>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.cashSale"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.creditSale"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.debtPayment"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.deposit"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.types.return"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
              </label>
            </div>

          </div>

          <!-- Timing Options -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á
            </h4>
            <div class="space-y-3">
              <label class="flex items-center">
                <input type="radio" x-model="autoConfig.timing" value="immediate"
                  class="text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
              </label>
              <label class="flex items-center">
                <input type="radio" x-model="autoConfig.timing" value="scheduled"
                  class="text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
              </label>

              <div x-show="autoConfig.timing === 'scheduled'" class="ml-6 mt-2">
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</label>
                <input type="time" x-model="autoConfig.scheduledTime"
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>

          <!-- Notifications -->
          <div class="mb-6" x-show="autoConfig.enabled">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </h4>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.success"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.error"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" x-model="autoConfig.notifications.summary"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-gray-700 dark:text-gray-300">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t border-gray-200 dark:border-gray-700">
          <button @click="showAutoConfigModal = false"
            class="px-4 py-2 mr-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button @click="saveAutoConfig()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition">
            <i class="bi bi-check2 mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
          </button>
        </div>
      </div>
    </div>

    <!-- Auto Creation Progress Modal -->
    <div id="autoProgressModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
      x-show="showAutoProgressModal" x-cloak>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full mx-4"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-90"
        x-transition:enter-end="opacity-100 transform scale-100">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
            <i class="bi bi-arrow-repeat animate-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </h3>
        </div>

        <!-- Content -->
        <div class="p-6">
          <!-- Current Item -->
          <div class="mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•:</p>
            <p class="font-medium text-gray-800 dark:text-gray-200" x-text="autoProgress.currentItem">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
              <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
              <span><span x-text="autoProgress.percentage">0</span>%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
              <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300"
                :style="`width: ${autoProgress.percentage}%`"></div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• <span x-text="autoProgress.current">0</span> ‡∏à‡∏≤‡∏Å <span x-text="autoProgress.total">0</span>
              ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </p>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="autoProgress.success">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" x-text="autoProgress.skipped">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-red-600 dark:text-red-400" x-text="autoProgress.failed">0</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end px-6 py-4 border-t border-gray-200 dark:border-gray-700">
          <button @click="cancelAutoCreation(); showAutoProgressModal = false"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg mr-2"
            x-show="autoCreationJob && autoProgress.percentage < 100">
            <i class="bi bi-x-circle mr-1"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button @click="showAutoProgressModal = false"
            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
      </div>
    </div>

  </div> <!-- End Main Content container -->

  <!-- Footer -->
  <footer class="mt-auto text-center text-sm text-gray-500 dark:text-gray-400 py-4">
    ¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.
  </footer>

  <script>

    // -----------------------------
    // 1) JavaScript Logic - Branch Configuration
    // -----------------------------
    const API_ROOT = '/api';
    
    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î BRANCH_CODE ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch') || localStorage.getItem('branchId');

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ BRANCH_CODE ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å user profile
    if (!BRANCH_CODE) {
      console.warn('‚ö†Ô∏è Branch not found in URL or localStorage, will load from user profile');
    }

    // Make BRANCH_CODE globally accessible
    window.currentBranchCode = BRANCH_CODE;
    window.BRANCH_CODE = BRANCH_CODE;
    
    console.log('üè¢ Initial Branch Code:', BRANCH_CODE);

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó localStorage ‡πÅ‡∏•‡∏∞ title ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ branch ‡πÉ‡∏ô URL
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
      localStorage.setItem('branchId', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ${decodeURIComponent(urlParams.get('name'))}`;
    }

    // Note: Sidebar initialization is now handled by sidebar.js

    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const res = await fetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });

        const js = await res.json();
        if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

        const user = js.data;
        document.getElementById('employeeName').textContent = user.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';

        let img = user.imageUrl || user.photoUrl || user.image || '';
        if (img && !/^https?:\/\//.test(img)) {
          img = img.startsWith('/') ? img : '/uploads/' + img;
        }

        const photoElement = document.getElementById('employeePhoto');
        if (photoElement) {
          photoElement.src = img || '/static/images/avatar-placeholder.png';
        }
      } catch (err) {
        console.error('Load Employee Profile Error:', err);
      }
    }

    // Note: State restoration is now handled by sidebar.js

    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
    
        if (!token) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        }
    
        console.log('üîÑ Loading branch info for BRANCH_CODE:', BRANCH_CODE);
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
    
        if (!res.ok) {
          throw new Error(`API Error: ${res.status} - ${res.statusText}`);
        }
    
        const js = await res.json();
    
        if (!js.success || !js.data) {
          throw new Error('API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
    
        console.log('üìã Available branches:', js.data.map(b => ({ id: b._id, code: b.branch_code, name: b.name })));
    
        let targetBranch = null;
    
        // ‡∏ñ‡πâ‡∏≤ BRANCH_CODE ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ current branch ‡∏à‡∏≤‡∏Å Alpine
        const alpineApp = document.querySelector('[x-data="app"]')?.__x;
        const currentBranchId = alpineApp?.currentBranch || BRANCH_CODE;
    
        console.log('üîç Searching for branch with ID/Code:', currentBranchId);
    
        if (currentBranchId) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö currentBranchId (‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á _id ‡πÅ‡∏•‡∏∞ branch_code)
          targetBranch = js.data.find(b =>
            b._id === currentBranchId ||
            b.branch_code === currentBranchId ||
            String(b._id) === String(currentBranchId) ||
            String(b.branch_code) === String(currentBranchId)
          );
        }
    
        if (targetBranch) {
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó global BRANCH_CODE ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö branch ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
          window.BRANCH_CODE = targetBranch._id;
          window.currentBranchCode = targetBranch._id;
          localStorage.setItem('branchId', targetBranch._id);
          localStorage.setItem('activeBranch', targetBranch.branch_code);
    
          document.getElementById('branchInfo').textContent =
            `${targetBranch.name} ‚Äî ${targetBranch.address || targetBranch.branch_code}`;
          document.title = `‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ${targetBranch.name}`;
          document.getElementById('pageTitle').textContent = `‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ${targetBranch.name}`;
    
          console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${targetBranch.name} (ID: ${targetBranch._id})`);
    
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Alpine currentBranch
          if (alpineApp) {
            alpineApp.currentBranch = targetBranch._id;
          }
    
          return targetBranch;
        }
    
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏£‡∏Å
        const firstBranch = js.data[0];
        if (firstBranch) {
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó global BRANCH_CODE
          window.BRANCH_CODE = firstBranch._id;
          window.currentBranchCode = firstBranch._id;
          localStorage.setItem('branchId', firstBranch._id);
          localStorage.setItem('activeBranch', firstBranch.branch_code);
    
          document.getElementById('branchInfo').textContent =
            `${firstBranch.name} ‚Äî ${firstBranch.address || firstBranch.branch_code}`;
          document.title = `‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ${firstBranch.name}`;
          document.getElementById('pageTitle').textContent = `‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ${firstBranch.name}`;
    
          console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${currentBranchId} ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤ ${firstBranch.name} ‡πÅ‡∏ó‡∏ô`);
    
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Alpine currentBranch
          if (alpineApp) {
            alpineApp.currentBranch = firstBranch._id;
          }
    
          return firstBranch;
        }
    
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
    
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤';
    
        // ‡πÅ‡∏™‡∏î‡∏á error notification ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö
        const errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ: ${err.message}`;
        console.error(errorMessage);
    
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Alpine instance ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á notification
        setTimeout(() => {
          const alpineApp = document.querySelector('[x-data="app"]')?.__x;
          if (alpineApp && typeof alpineApp.showNotification === 'function') {
            alpineApp.showNotification(errorMessage, 'error');
          }
        }, 1000);
    
        throw err; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ caller ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error
      }
    }

    // Alpine.js component data and functions
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // Properties
        sidebarOpen: window.innerWidth >= 1024,
        darkMode: localStorage.getItem('theme') === 'dark',
        showModal: false,
        showDeleteModal: false,
        receiptId: null,
        receiptIdToDelete: null,
        receipts: [],
        filteredReceipts: [],
        currentFilter: 'all',

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö property ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏≠‡∏≠‡∏Å
        currentPage: 1,
        itemsPerPage: 10,
        totalPages: 1,
        paginationStart: 1,
        paginationEnd: 10,
        totalReceipts: 0,

        debitAccounts: [],
        creditAccounts: [],
        notification: {
          show: false,
          message: '',
          type: 'success'
        },
        showAutoCreateToast: false,
        autoCreateMessage: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
        autoCreateProgress: 0,
        summary: {
          totalAmountFormatted: '‡∏ø0.00',
          totalAmountMonth: 0,
          amountComparisonPercentage: 0, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° property ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
          monthlyComparisonPercentage: 0,
          totalCount: 0, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° property ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
          totalCountMonth: 0,
          countComparisonPercentage: 0,
          todayAutoCreatedCount: 0,
          pendingReceiptCount: 0
        },
        currentBranch: null, // ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô loadCurrentBranch()
        timeRange: {
          amount: 'month',
          count: 'month'
        },
        timeRangeText: {
          amount: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',
          count: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'
        },
        autoConfig: {
          enabled: true,
          types: {
            cashSale: true,
            creditSale: true,
            debtPayment: true,
            deposit: true,
            return: true
          },
          timing: 'immediate',
          scheduledTime: '18:00',
          notifications: {
            success: true,
            error: true,
            summary: false
          }
        },
        autoProgress: {
          current: 0,
          total: 0,
          percentage: 0,
          currentItem: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
          success: 0,
          skipped: 0,
          failed: 0
        },
        showAutoConfigModal: false,
        showAutoProgressModal: false,
        autoCreationJob: null,

        // Methods - ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å init()
        getReceiptTypeDisplay(receipt) {
          if (receipt.receiptType) {
            const typeMap = {
              'cash_sale': '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
              'credit_sale': '‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠',
              'debt_payment': '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ',
              'deposit': '‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥',
              'return': '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
            };
            return typeMap[receipt.receiptType] || '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
          }

          const reason = (receipt.reason || '').toLowerCase();

          if (reason.includes('‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠') || reason.includes('credit')) {
            return '‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠';
          }
          if (reason.includes('‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ') || reason.includes('‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞') || reason.includes('payment')) {
            return '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ';
          }
          if (reason.includes('‡∏°‡∏±‡∏î‡∏à‡∏≥') || reason.includes('deposit')) {
            return '‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥';
          }
          if (reason.includes('‡∏Ñ‡∏∑‡∏ô') || reason.includes('return')) {
            return '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
          }

          return '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        },

        getReceiptTypeConfig(type) {
          const configs = {
            'cash_sale': { icon: 'bi bi-cash-stack', color: 'text-green-500' },
            'credit_sale': { icon: 'bi bi-credit-card', color: 'text-blue-500' },
            'debt_payment': { icon: 'bi bi-wallet2', color: 'text-purple-500' },
            'deposit': { icon: 'bi bi-piggy-bank', color: 'text-pink-500' },
            'return': { icon: 'bi bi-arrow-return-left', color: 'text-orange-500' }
          };
          return configs[type] || { icon: 'bi bi-cash-stack', color: 'text-green-500' }; // ‚úÖ ‡πÅ‡∏Å‡πâ closing bracket
        },

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Alpine.js methods
        async exportCurrentPagePDF() {
          let loaderId = null;
          try {
            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            const pageReceipts = this.filteredReceipts.slice(startIndex, endIndex);

            if (pageReceipts.length === 0) {
              this.showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'warning');
              return;
            }

            loaderId = LoadingSystem.show({
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF...',
              type: 'spinner'
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API export
            const response = await fetch('/api/receipt-vouchers/export/pdf', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify({
                receiptIds: pageReceipts.map(r => r._id),
                format: 'merged' // ‡∏´‡∏£‡∏∑‡∏≠ 'separate' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå
              })
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `receipts_page_${this.currentPage}.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);

              // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              if (loaderId) {
                LoadingSystem.hide(loaderId);
                loaderId = null;
              }
              this.showNotification('Export PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
              throw new Error('Export failed');
            }
          } catch (error) {
            console.error('Export error:', error);
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export PDF ‡πÑ‡∏î‡πâ', 'error');
          } finally {
            // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î error
            if (loaderId) {
              LoadingSystem.hide(loaderId);
            }
          }
        },

        async exportAllPDF() {
          let loaderId = null;
          try {
            if (this.filteredReceipts.length === 0) {
              this.showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Export', 'warning');
              return;
            }

            loaderId = LoadingSystem.show({
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...',
              type: 'spinner'
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API export
            const response = await fetch('/api/receipt-vouchers/export/pdf', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify({
                receiptIds: this.filteredReceipts.map(r => r._id),
                format: 'merged'
              })
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `all_receipts.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);

              if (loaderId) {
                LoadingSystem.hide(loaderId);
                loaderId = null;
              }
              this.showNotification('Export PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
              throw new Error('Export failed');
            }
          } catch (error) {
            console.error('Export all PDF error:', error);
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ', 'error');
          } finally {
            if (loaderId) {
              LoadingSystem.hide(loaderId);
            }
          }
        },

        async editReceipt(id) {
  this.receiptId = id;
  try {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    }

    // ‚úÖ ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    let endpoints = [];
    if (/^[0-9a-fA-F]{24}$/.test(id)) {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ObjectId
      endpoints = [
        `/api/receipt-voucher/${id}`,         // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        `/api/receipt-vouchers/${id}`,        // backup
        `/api/receiptVoucher/${id}`,          // camelCase
        `/api/receiptVouchers/${id}`          // camelCase backup
      ];
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô documentNumber
      endpoints = [
        `/api/receipt-voucher/document/${id}`,         // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        `/api/receipt-vouchers/document/${id}`,        // backup
        `/api/receiptVoucher/document/${id}`,          // camelCase
        `/api/receiptVouchers/document/${id}`          // camelCase backup
      ];
    }

    let response = null;
    let foundEndpoint = null;

    for (const endpoint of endpoints) {
      try {
        console.log(`üîç ‡∏•‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å: ${endpoint}`);
        response = await fetch(endpoint, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.status !== 404) {
          foundEndpoint = endpoint;
          break;
        }
      } catch (err) {
        console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
      }
    }

    if (!foundEndpoint || !response) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - API endpoints ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    }
    
    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      } else if (response.status === 404) {
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      } else if (response.status === 403) {
        throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
      } else {
        throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${response.status}`);
      }
    }

    const result = await response.json();
    
    if (!result.success || !result.data) {
      throw new Error(result.message || 'API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }

    this.populateEditForm(result.data);

  } catch (error) {
    console.error('Error editing receipt:', error);
    this.showNotification(error.message, 'error');
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
    if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
      setTimeout(() => {
        localStorage.removeItem('authToken');
        window.location.href = '/login';
      }, 3000);
    }
  }
},

// ‡πÅ‡∏¢‡∏Å method ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö populate form
populateEditForm(data) {
  document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';

  // Populate form fields
  document.getElementById('documentNumber').value = data.documentNumber;
  document.getElementById('paymentDate').value = new Date(data.paymentDate).toISOString().substr(0, 10);

  const debitSelect = document.getElementById('debitAccountCode');
  // Ensure the value matches the format "CODE|NAME" if options are structured that way, or just "CODE"
  let debitValueToSet = data.debitAccount.code;
  if (Array.from(debitSelect.options).some(opt => opt.value.includes('|'))) {
    debitValueToSet = `${data.debitAccount.code}|${data.debitAccount.name}`;
  }
  debitSelect.value = debitValueToSet;
  updateAccountName(debitSelect, 'debitAccountName'); // Update hidden name field

  const creditSelect = document.getElementById('creditAccountCode');
  let creditValueToSet = data.creditAccount.code;
  if (Array.from(creditSelect.options).some(opt => opt.value.includes('|'))) {
    creditValueToSet = `${data.creditAccount.code}|${data.creditAccount.name}`;
  }
  creditSelect.value = creditValueToSet;
  updateAccountName(creditSelect, 'creditAccountName'); // Update hidden name field

  document.getElementById('receivedFrom').value = data.receivedFrom;
  document.querySelector('select[name="receiptType"]').value = data.receiptType;

  const paymentMethodSelect = document.querySelector('select[name="paymentMethod"]');
  paymentMethodSelect.value = data.paymentMethod;
  togglePaymentDetails(data.paymentMethod); // Show/hide bank details based on payment method

  if (data.bankAccount && (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque')) {
    // Assuming bankAccount field stores the value expected by the select options
    document.querySelector('select[name="bankAccount"]').value = data.bankAccount;
  }

  document.getElementById('notes').value = data.notes || '';

  // Populate transaction details
  const detailsContainer = document.getElementById('transactionDetailsContainer');
  // Clear existing dynamic detail entries before adding new ones
  detailsContainer.querySelectorAll('.transaction-detail-entry').forEach(entry => entry.remove());

  if (data.details && data.details.length > 0) {
    data.details.forEach((detail) => {
      // Pass false for clearContainerFirst as we've already cleared it
      this.addTransactionDetailEntry(detail.description, detail.amount, false);
    });
  } else {
    // Add a blank row if no details exist, ensuring clearContainerFirst is false
    this.addTransactionDetailEntry('', 0, false);
  }

  this.updateTransactionTotal(); // Recalculate total
  this.showModal = true; // Show the modal
},

        removeTransactionDetail(buttonEl) {
          const detailEntry = buttonEl.closest('.transaction-detail-entry');
          const detailRows = document.querySelectorAll('#transactionDetailsContainer .transaction-detail-entry');

          if (detailRows.length > 1 && detailEntry) {
            detailEntry.remove();
            this.updateTransactionTotal();
          } else if (detailEntry) {
            // If it's the last row, clear its fields instead of removing it
            detailEntry.querySelectorAll('input[name="transactionDetail[]"]').forEach(input => input.value = '');
            detailEntry.querySelectorAll('input[name="detailAmount[]"]').forEach(input => input.value = '0');
            this.updateTransactionTotal();
          }
        },

        addTransactionDetailEntry(description = '', amount = 0, clearContainerFirst = false) {
          const container = document.getElementById('transactionDetailsContainer');
          if (!container) {
            console.error('Transaction details container not found.');
            return;
          }

          if (clearContainerFirst) {
            container.querySelectorAll('.transaction-detail-entry').forEach(entry => entry.remove());
          }

          const templateHtml = `
                <div class="transaction-detail-entry grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-7">
                        <div class="form-floating">
                            <input type="text" name="transactionDetail[]" required placeholder=" " class="peer" value="${description}">
                            <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-red-500">*</span></label>
                        </div>
                    </div>
                    <div class="col-span-4">
                        <div class="form-floating relative">
                            <input type="number" step="0.01" name="detailAmount[]" required placeholder=" " class="peer pl-8" value="${amount}" oninput="updateTransactionTotal()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 dark:text-gray-400">‡∏ø</div>
                            <label class="text-gray-500 dark:text-gray-400 peer-focus:text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô <span class="text-red-500">*</span></label>
                        </div>
                    </div>
                    <div class="col-span-1 flex justify-center">
                        <button type="button" class="text-gray-400 hover:text-red-500 focus:outline-none" onclick="removeTransactionDetail(this)">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>`;

          // The "Add Item" button and "Total" section should ideally be outside the container that gets cleared,
          // or they need to be re-added if they are part of it.
          // For simplicity, let's assume they are outside or re-added if needed.
          // The addTransactionDetail button is now Alpine managed with @click.
          // The total section is static HTML.
          const addButtonElement = document.getElementById('addTransactionDetail');
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = templateHtml.trim();
          const newRow = tempDiv.firstChild;

          if (addButtonElement) {
            // Insert the new row before the "Add Item" button's PARENT or the button itself if it's structured that way.
            // If addTransactionDetail is a button that's a direct child of `container`, this works.
            // If it's wrapped, adjust accordingly. Let's assume it's a direct child or we insert before its wrapper.
            container.insertBefore(newRow, addButtonElement);
          } else {
            // Fallback: if the add button isn't found or structure is different, append to container.
            // This might place it after the total, so ensure HTML structure is robust.
            container.appendChild(newRow);
            console.log('#addTransactionDetail button not found, appending new row. Check structure.');
          }
          // Ensure oninput handlers for new amount fields also call the Alpine instance's updateTransactionTotal
          // This is handled by the oninput="updateTransactionTotal()" in the template, which calls the global helper.
          this.updateTransactionTotal(); // Recalculate total after adding a row
        },

        collectDetails() {
          const details = [];
          const detailDescriptionInputs = document.querySelectorAll('#receiptForm input[name="transactionDetail[]"]');
          const detailAmountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');

          detailDescriptionInputs.forEach((descInput, index) => {
            const amountInput = detailAmountInputs[index];
            if (descInput.value.trim() !== '' && amountInput && amountInput.value.trim() !== '') {
              details.push({
                description: descInput.value,
                amount: parseFloat(amountInput.value) || 0
              });
            }
          });
          return details;
        },

        calculateTotal() {
          const details = this.collectDetails();
          return details.reduce((total, item) => total + item.amount, 0);
        },

        autoCreationInterval: null,

        startAutoCreationInterval() {
          console.log('üí° Starting auto creation interval monitoring');
          // ‡∏´‡∏¢‡∏∏‡∏î interval ‡πÄ‡∏î‡∏¥‡∏°
          if (this.autoCreationInterval) {
            console.log('üí° Clearing existing interval');
            clearInterval(this.autoCreationInterval);
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å 120 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î API calls)
          this.autoCreationInterval = setInterval(async () => {
            console.log('‚è∞ [interval] Periodic status check at', new Date().toLocaleTimeString());
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
            try {
              await this.updateDashboardStats();
            } catch (error) {
              console.log('Error in periodic status check:', error.message);
            }
          }, 120000); // ‡∏ó‡∏∏‡∏Å 120 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (2 ‡∏ô‡∏≤‡∏ó‡∏µ)
    
          console.log('‚úÖ Auto creation interval monitoring started');
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          this.updateDashboardStats();
        },

        stopAutoCreationInterval() {
          if (this.autoCreationInterval) {
            clearInterval(this.autoCreationInterval);
            this.autoCreationInterval = null;
            console.log('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
          }
        },

        scheduleAutoCreation() {
          const scheduledTime = this.autoConfig.scheduledTime; // ‡πÄ‡∏ä‡πà‡∏ô "18:00"
          if (!scheduledTime) {
            console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö scheduled auto creation.');
            return;
          }
          const [hours, minutes] = scheduledTime.split(':').map(Number);

          const checkTime = () => {
            const now = new Date();
            if (now.getHours() === hours && now.getMinutes() === minutes) {
              this.runAutoCreation();
              // Optionally, run only once per day or clear interval after running
            }
          };

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ
          // Consider clearing this interval if the schedule changes or auto creation is disabled
          setInterval(checkTime, 60000);
          console.log(`üóìÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${scheduledTime}`);
        },

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto Creation
        async triggerAutoCreation() {
          if (this.isAutoCreating) {
            console.log('üö´ Auto creation is already running');
            return;
          }

          this.isAutoCreating = true;

          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // ‡πÅ‡∏™‡∏î‡∏á Loading
            const loaderId = LoadingSystem.show({
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...',
              type: 'spinner'
            });

            console.log('üöÄ Starting auto creation process...');
    
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                limit: 100,
                paymentMethod: 'cash',
                branchCode: branchCode
              })
            });

            LoadingSystem.hide(loaderId);

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
              } else if (response.status === 403) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Auto Creation');
              } else {
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
            }

            const created = result.data.created || [];
            const failed = result.data.failed || [];
            const summary = result.data.summary || {};

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            const message = failed.length > 0
              ? `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failed.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
              : `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    
            const type = failed.length > 0 ? 'warning' : 'success';
    
            this.showNotification(message, type);
    
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            await this.loadReceipts();
            await this.updateDashboardStats();
    
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase ‡πÅ‡∏•‡∏∞ Socket.IO
            if (window.ReceiptVoucherConnection) {
              window.ReceiptVoucherConnection.emitReceiptVoucherCreated({
                type: 'auto_creation',
                created: created.length,
                failed: failed.length,
                summary: summary
              });
            }

            console.log('‚úÖ Auto creation completed successfully');
            console.log('üìä Summary:', summary);
            console.log('‚úÖ Created:', created.length, 'items');
            console.log('‚ùå Failed:', failed.length, 'items');

          } catch (error) {
            console.error('‚ùå Auto creation error:', error);
            this.showNotification(error.message, 'error');
    
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
            if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          } finally {
            this.isAutoCreating = false;
          }
        },

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Auto Creation - Updated to use UI API
        async checkAutoCreationStatus() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (throttling)
            const now = Date.now();
            if (this.lastAutoStatusCheck && now - this.lastAutoStatusCheck < 15000) {
              console.log('üö´ Auto status check throttled (less than 15 seconds ago)');
              return;
            }
            this.lastAutoStatusCheck = now;

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö UI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
            const endpoint = `/api/receipt-voucher/pending-receipts`;

            try {
              const response = await fetch(endpoint, {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                const result = await response.json();
                console.log('üìä Auto creation status from UI API:', result);
    
                if (result.success && result.data) {
                  const pendingItems = result.data || [];
    
                  // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≤‡∏° source
                  const posPending = pendingItems.filter(item =>
                    item.source === 'pos' || item.source === 'cash_sale'
                  ).length;
    
                  const installmentPending = pendingItems.filter(item =>
                    item.source === 'installment' || item.source === 'installment_payment'
                  ).length;
    
                  const totalPending = pendingItems.length;
    
                  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
                  this.summary.pendingReceiptCount = totalPending;
                  this.summary.todayAutoCreatedCount = 0; // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    
                  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Auto System
                  const statusIcon = document.getElementById('autoStatusIcon');
                  const statusText = document.getElementById('autoStatusText');
    
                  if (statusIcon && statusText) {
                    if (totalPending > 0) {
                      statusIcon.innerHTML = `
                        <div class="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-amber-400 rounded-full animate-ping"></div>
                      `;
                      statusText.textContent = `‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á ${totalPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                      statusText.className = 'text-lg font-semibold text-amber-600 dark:text-amber-400';
    
                      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô tooltip
                      statusText.title = `POS: ${posPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏ú‡πà‡∏≠‡∏ô: ${installmentPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    } else {
                      statusIcon.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                      `;
                      statusText.textContent = '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
                      statusText.className = 'text-lg font-semibold text-green-600 dark:text-green-400';
                      statusText.title = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                    }
                  }
    
                  if (todayAutoCount) {
                    todayAutoCount.textContent = data.todayAutoCreated || 0;
                  }
    
                  console.log('‚úÖ Auto creation status updated successfully');
                  console.log(`üìä Details: POS Pending: ${data.pendingPosReceipts}, Installment Pending: ${data.pendingInstallmentReceipts}, Total: ${data.totalPending}, Today Created: ${data.todayAutoCreated}`);
    
                  if (data.warning) {
                    console.log(`‚ö†Ô∏è Warning: ${data.warning}`);
                  }
    
                  return; // Success, exit function
                }
              }
            } catch (err) {
              // Network error, use default status
              console.log('‚ùå Auto creation status API error:', err.message);
            }
    
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ API ‡πÉ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ default status
            console.log('üìä Auto creation status API not available, using default status');
            this.updateAutoStatus(true, '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
    
          } catch (error) {
            console.log('Could not check auto creation status:', error.message);
            this.updateAutoStatus(true, '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
          }
        },

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Auto Creation
        async showAutoCreationStats() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            const branchCode = this.currentBranch || localStorage.getItem('activeBranch') || 'default';
    
            // ‚úÖ ‡πÉ‡∏ä‡πâ endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö checkAutoCreationStatus() (‡πÑ‡∏°‡πà‡∏°‡∏µ 's')
            const response = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                const data = result.data;
    
                const modalHtml = `
                  <div id="autoStatsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4">
                      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">
                          ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö Auto Creation
                        </h3>
                      </div>
                      <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à POS ‡∏ó‡∏µ‡πà‡∏£‡∏≠:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${data.pendingPosReceipts} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${data.pendingInstallmentReceipts} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="flex justify-between items-center border-t pt-4">
                          <span class="text-gray-600 dark:text-gray-400">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                          <span class="font-bold text-lg text-blue-600 dark:text-blue-400">${data.totalPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
                          <span class="font-semibold text-green-600 dark:text-green-400">${data.todayAutoCreated} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="flex justify-between items-center">
                          <span class="text-gray-600 dark:text-gray-400">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                          <span class="font-semibold text-gray-900 dark:text-gray-100">${new Date(data.lastCheck).toLocaleTimeString('th-TH')}</span>
                        </div>
                      </div>
                      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button onclick="document.getElementById('autoStatsModal').remove()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                          ‡∏õ‡∏¥‡∏î
                        </button>
                      </div>
                    </div>
                  </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);
              }
            }
          } catch (error) {
            console.error('Error showing auto creation stats:', error);
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
          }
        },

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° property ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Auto Creation status
        isAutoCreating: false,
        lastAutoStatusCheck: null,
        lastStatsUpdate: null,

        async runAutoCreation() {
          try {
            console.log('ü§ñ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...');
            // ‡πÅ‡∏Ñ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Backend ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
            await this.updateDashboardStats();
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const pendingCheck = await fetch('/api/receipt-vouchers/pending-count', {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              }
            });
            if (pendingCheck.ok) {
              const result = await pendingCheck.json();
              const pending = result.data?.totalPending || 0;
              if (pending === 0) {
                this.updateAutoStatus(true, '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
              } else {
                this.updateAutoStatus(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${pending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
              }
            }
          } catch (error) {
            console.error('‚ùå Error checking status:', error);
            this.updateAutoStatus(false, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }
        },

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        updateAutoStatus(isSuccess, message = '') {
          const statusIcon = document.getElementById('autoStatusIcon');
          const statusText = document.getElementById('autoStatusText');

          if (statusIcon && statusText) {
            if (isSuccess) {
              statusIcon.innerHTML = `
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <div class="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
      `;
              statusText.textContent = message || '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
              statusText.className = 'text-lg font-semibold text-green-600 dark:text-green-400';
            } else {
              statusIcon.innerHTML = `
        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
      `;
              statusText.textContent = message || '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
              statusText.className = 'text-lg font-semibold text-red-600 dark:text-red-400';
            }
          }
        },
                async submitForm() {
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            const formElement = document.getElementById('receiptForm');
            const formData = new FormData(formElement);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á branch ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const branchValue = String(this.currentBranch || BRANCH_CODE || '00000');
            console.log('üìç Branch value for submission:', branchValue);

            const data = {
              receiptNumber: formData.get('documentNumber'),
              receiptDate: formData.get('paymentDate'),
              receiptType: formData.get('receiptType'),
              customer: {
                name: formData.get('receivedFrom'),
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              },
              paymentMethod: formData.get('paymentMethod'),
              branchCode: branchValue,
              accounts: {
                debit: {
                  code: formData.get('debitAccountCode').split('|')[0],
                  name: formData.get('debitAccountName')
                },
                credit: {
                  code: formData.get('creditAccountCode').split('|')[0],
                  name: formData.get('creditAccountName')
                }
              },
              items: this.collectDetails(),
              totalAmount: this.calculateTotal(),
              notes: formData.get('notes')
            };

            if (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque') {
              data.bankDetails = {
                bankAccount: formData.get('bankAccount'),
                reference: formData.get('transferReference') || formData.get('chequeNumber')
              };
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° summary ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Receipt API
            data.summary = {
              subtotal: data.totalAmount,
              vatAmount: 0, // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              totalWithTax: data.totalAmount
            };

            let url = '/api/receipt';
            let method = 'POST';

            if (this.receiptId) {
              url += `/${this.receiptId}`;
              method = 'PUT';
            }
            data.documentNumber = formData.get('documentNumber');

            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(data)
            });

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
              } else if (response.status === 404) {
                throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - API ‡πÑ‡∏°‡πà‡∏û‡∏ö');
              } else if (response.status === 403) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
              } else if (response.status >= 400 && response.status < 500) {
                const errorData = await response.json().catch(() => ({ message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' }));
                throw new Error(errorData.message || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
              } else {
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }

            this.showNotification(method === 'POST' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            this.showModal = false;
            await this.loadReceipts();

          } catch (error) {
            console.error('Submit form error:', error);
            this.showNotification(error.message, 'error');
    
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
            if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        async loadReceipts() {
          console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô...');
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
            }

            // ‚úÖ ‡πÉ‡∏ä‡πâ Receipt Voucher API ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            let response;
            let apiEndpoints = [
              '/api/receipt-voucher',            // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
              '/api/receipt-vouchers',           // endpoint ‡∏™‡∏≥‡∏£‡∏≠‡∏á
              '/api/receipt-vouchers/list'       // endpoint backup
            ];

            let lastError = null;
            let foundEndpoint = null;

            for (const endpoint of apiEndpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  console.log(`‚úÖ ‡πÉ‡∏ä‡πâ endpoint: ${endpoint}`);
                  break;
                } else if (response.status !== 404) {
                  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 404 ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ endpoint ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                lastError = err;
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ:`, err.message);
              }
            }

            if (!foundEndpoint) {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö API ‡πÑ‡∏î‡πâ');
            }

            const data = await response.json();
            console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:', data);

            // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Receipt API structure
            let receipts = [];
            if (data && Array.isArray(data.data)) {
              receipts = data.data;
            } else if (data && Array.isArray(data)) {
              receipts = data;
            } else if (data && data.receipts && Array.isArray(data.receipts)) {
              receipts = data.receipts;
            }

            console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${receipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
            // ‚úÖ Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö structure
            if (receipts.length > 0) {
              console.log('üîç Sample receipt data structure:', receipts[0]);
              console.log('üîç Receipt keys:', Object.keys(receipts[0]));
            }

            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Receipt API ‡πÅ‡∏•‡∏∞ receipt-voucher
            this.receipts = receipts.map(receipt => {
              // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
              const baseReceipt = {
                ...receipt, // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° fallback fields ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                documentNumber: receipt.documentNumber || receipt.voucherNumber || receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                paymentDate: receipt.paymentDate || receipt.date || receipt.receiptDate || receipt.createdAt,
                totalAmount: receipt.totalAmount || receipt.summary?.totalAmount || 0,
                receivedFrom: receipt.receivedFrom || receipt.customer?.name || receipt.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                status: receipt.status || 'completed', // default status
                receiptType: receipt.receiptType || receipt.type || 'cash_sale',
    
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
                voucherNumber: receipt.documentNumber || receipt.voucherNumber || receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                date: receipt.paymentDate || receipt.date || receipt.receiptDate || receipt.createdAt,
                customer: {
                  name: receipt.receivedFrom || receipt.customer?.name || receipt.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                  address: receipt.customer?.address || receipt.customerAddress || '',
                  taxId: receipt.customer?.taxId || receipt.customerTaxId || ''
                },
                note: receipt.notes || receipt.note || receipt.description || ''
              };
    
              return baseReceipt;
            });

            this.totalReceipts = this.receipts.length;

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            this.receipts.sort((a, b) => new Date(b.date) - new Date(a.date));

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const maxPages = Math.ceil(this.receipts.length / this.itemsPerPage);
            if (this.currentPage > maxPages && maxPages > 0) {
              this.currentPage = 1;
            }
            this.filterByCreationType(this.currentFilter);

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            await this.loadSummaryByTimeRange();

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            await this.updateDashboardStats();

            if (this.receipts.length === 0) {
              console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
              this.showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà', 'info');
            } else {
              console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${this.receipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            }

          } catch (error) {
            console.error('‚ùå Load receipts error:', error);
    
            // ‡πÅ‡∏™‡∏î‡∏á error message ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
            this.showNotification(error.message, 'error');
    
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            this.receipts = [];
            this.totalReceipts = 0;
            this.filterByCreationType(this.currentFilter);
    
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
            if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        async loadAutoConfig() {
          try {
            // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            const endpoints = [
              '/api/receipt-voucher/config/auto-creation',          // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
              '/api/receipt-vouchers/config/auto-creation',         // backup
              '/api/receiptVoucher/config/auto-creation',           // camelCase
              '/api/receiptVouchers/config/auto-creation',          // camelCase backup
              '/api/config/receipt-voucher-auto',                   // alternative
              '/api/settings/auto-receipt-creation'                 // generic
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î auto config ‡∏à‡∏≤‡∏Å: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  break;
                } else if (response.status !== 404) {
                  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 404 ‡∏≠‡∏≤‡∏à‡∏°‡∏µ endpoint ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (foundEndpoint && response && response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                Object.assign(this.autoConfig, result.data);
                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î auto config ‡∏à‡∏≤‡∏Å API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                return;
              }
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ API ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
            console.log('üìÇ Auto config API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage');
            const savedConfig = localStorage.getItem('autoConfig');
            if (savedConfig) {
              Object.assign(this.autoConfig, JSON.parse(savedConfig));
              console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î auto config ‡∏à‡∏≤‡∏Å localStorage ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
              console.log('‚ÑπÔ∏è ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ auto config ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ');
              // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            }

          } catch (error) {
            console.log('‚ùå Error loading auto config:', error.message);
            // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
            const savedConfig = localStorage.getItem('autoConfig');
            if (savedConfig) {
              try {
                Object.assign(this.autoConfig, JSON.parse(savedConfig));
                console.log('üìÇ ‡πÉ‡∏ä‡πâ auto config ‡∏à‡∏≤‡∏Å localStorage fallback');
              } catch (parseError) {
                console.log('‚ö†Ô∏è Error parsing saved config, ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default');
              }
            }
          }
        },

        async saveAutoConfig() {
          try {
            // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡πà‡∏≤‡∏ô API endpoint ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            const endpoints = [
              '/api/receipt-voucher/config/auto-creation',          // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
              '/api/receipt-vouchers/config/auto-creation',         // backup
              '/api/receiptVoucher/config/auto-creation',           // camelCase
              '/api/receiptVouchers/config/auto-creation',          // camelCase backup
              '/api/config/receipt-voucher-auto'                    // alternative
            ];

            let success = false;

            for (const endpoint of endpoints) {
              try {
                const response = await fetch(endpoint, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                  },
                  body: JSON.stringify(this.autoConfig)
                });

                if (response.ok) {
                  const result = await response.json();
                  if (result.success) {
                    console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å auto config ‡∏ú‡πà‡∏≤‡∏ô ${endpoint} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    success = true;
                    break;
                  }
                } else if (response.status !== 404) {
                  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 404 ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
                  continue;
                }
              } catch (err) {
                console.log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡πà‡∏≤‡∏ô ${endpoint}`);
              }
            }

            if (success) {
              this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
              // ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô localStorage ‡πÅ‡∏ó‡∏ô
              localStorage.setItem('autoConfig', JSON.stringify(this.autoConfig));
              this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)', 'info');
            }

            this.showAutoConfigModal = false;

            // ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Auto Creation ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
            this.stopAutoCreationInterval();
            if (this.autoConfig.enabled) {
              if (this.autoConfig.timing === 'immediate') {
                this.startAutoCreationInterval();
              } else if (this.autoConfig.timing === 'scheduled') {
                this.scheduleAutoCreation();
              }
            }

          } catch (error) {
            console.log('‚ùå Error saving auto config:', error.message);
            // Fallback: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô localStorage
            localStorage.setItem('autoConfig', JSON.stringify(this.autoConfig));
            this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'warning');
            this.showAutoConfigModal = false;
          }
        },

        async submitForm() {
          try {
            const token = localStorage.getItem('authToken');
    
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            const formElement = document.getElementById('receiptForm');
            const formData = new FormData(formElement);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á branch ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const branchValue = String(this.currentBranch || BRANCH_CODE || '00000');
            console.log('üìç Branch value for submission:', branchValue);

            const data = {
              paymentDate: formData.get('paymentDate'),
              debitAccount: {
                code: formData.get('debitAccountCode').split('|')[0],
                name: formData.get('debitAccountName')
              },
              creditAccount: {
                code: formData.get('creditAccountCode').split('|')[0],
                name: formData.get('creditAccountName')
              },
              receivedFrom: formData.get('receivedFrom'),
              receiptType: formData.get('receiptType'),
              paymentMethod: formData.get('paymentMethod'),
              details: this.collectDetails(),
              notes: formData.get('notes'),
              branch: branchValue
            };

            if (data.paymentMethod === 'transfer' || data.paymentMethod === 'cheque') {
              data.bankAccount = formData.get('bankAccount');
            }

            // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
            let endpoints = [
              '/api/receipt-voucher',            // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
              '/api/receipt-vouchers',           // backup
              '/api/receiptVoucher',             // camelCase
              '/api/receiptVouchers'             // camelCase backup
            ];

            let url = '';
            let method = 'POST';

            if (this.receiptId) {
              endpoints = endpoints.map(ep => `${ep}/${this.receiptId}`);
              method = 'PUT';
            }
            data.documentNumber = formData.get('documentNumber');

            let response = null;
            let lastError = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á: ${endpoint}`);
                response = await fetch(endpoint, {
                  method: method,
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(data)
                });

                if (response.status !== 404) {
                  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 404 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠ endpoint ‡πÅ‡∏•‡πâ‡∏ß
                  url = endpoint;
                  break;
                }
              } catch (err) {
                lastError = err;
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (!response || response.status === 404) {
              // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ endpoint ‡πÉ‡∏î‡πÄ‡∏•‡∏¢
              throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - API endpoints ‡πÑ‡∏°‡πà‡∏û‡∏ö');
            }

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
              } else if (response.status === 403) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
              } else if (response.status >= 400 && response.status < 500) {
                const errorData = await response.json().catch(() => ({ message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' }));
                throw new Error(errorData.message || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
              } else {
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }

            this.showNotification(method === 'POST' ? '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            this.showModal = false;
            await this.loadReceipts();

          } catch (error) {
            console.error('Submit form error:', error);
            this.showNotification(error.message, 'error');
    
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
            if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },



        filterByCreationType(type = 'all') {
          this.currentFilter = type;
          this.currentPage = 1; // Reset to first page when filtering
          this.updatePagination(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó pagination ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å filter
          this.updateTable();
          if (type === 'auto') {
            this.filteredReceipts = this.receipts.filter(r =>
              r.notes && r.notes.toLowerCase().includes('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')
            );
          } else if (type === 'manual') {
            this.filteredReceipts = this.receipts.filter(r =>
              !r.notes || !r.notes.toLowerCase().includes('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')
            );
          } else {
            this.filteredReceipts = [...this.receipts];
          }
          this.updateTable();
          // this.updateStats(); // Assuming updateStats is a method you might have for other stats
        },

        updateTable() {
          const tbody = document.getElementById('receiptTableBody');
          tbody.innerHTML = '';

          const receiptsToDisplay = this.filteredReceipts;

          if (!receiptsToDisplay || receiptsToDisplay.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500 dark:text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${this.currentFilter !== 'all' ? ` (${this.currentFilter === 'auto' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á'})` : ''}</td></tr>`;
            this.updateTableFooterTotal();
            return;
          }

          const startIndex = (this.currentPage - 1) * this.itemsPerPage;
          const endIndex = startIndex + this.itemsPerPage;
          const pageReceipts = receiptsToDisplay.slice(startIndex, endIndex);

          pageReceipts.forEach(receipt => {
            const newRow = document.createElement('tr');
            newRow.className = 'receipt-item hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-800';

            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö null/undefined
            let formattedDate = 'N/A';
            if (receipt.paymentDate) {
              try {
                const paymentDate = new Date(receipt.paymentDate);
                if (!isNaN(paymentDate.getTime())) {
                  formattedDate = `${String(paymentDate.getDate()).padStart(2, '0')}/${String(paymentDate.getMonth() + 1).padStart(2, '0')}/${paymentDate.getFullYear()}`;
                }
              } catch (e) {
                console.warn('Date parsing error:', e);
                formattedDate = 'Invalid Date';
              }
            }

            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            const accountDisplayCode = receipt.documentNumber ||
                                     receipt.debitAccount?.code ||
                                     receipt.accountCode ||
                                     receipt.receiptNumber ||
                                     'N/A';
    
            const accountDisplayName = receipt.debitAccount?.name ||
                                     receipt.creditAccount?.name ||
                                     receipt.accountName ||
                                     receipt.receivedFrom ||
                                     'N/A';

            const isAutoCreated = receipt.notes && receipt.notes.toLowerCase().includes('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
            const autoCreatedBadge = isAutoCreated
              ? `<span class="ml-2 badge badge-info badge-xs" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"><i class="bi bi-robot"></i> Auto</span>`
              : '';

            // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô innerHTML
            const displayType = this.getReceiptTypeDisplay(receipt);
            const typeConfig = this.getReceiptTypeConfig(receipt.receiptType || 'cash_sale');

            newRow.innerHTML = `
      <td class="px-4 py-3 text-gray-800 dark:text-gray-200">${accountDisplayCode}${autoCreatedBadge}</td>
      <td class="px-4 py-3 text-gray-800 dark:text-gray-200">${accountDisplayName}</td>
      <td class="px-4 py-3">
        <div class="flex items-center space-x-2">
          <i class="${typeConfig.icon} ${typeConfig.color}"></i>
          <span>${displayType}</span>
        </div>
      </td>
      <td class="px-4 py-3 text-gray-600 dark:text-gray-300">${formattedDate}</td>
      <td class="px-4 py-3 text-right font-medium text-gray-900 dark:text-gray-100">‡∏ø${(receipt.totalAmount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      <td class="px-4 py-3 text-center">
        <span class="badge ${receipt.status === 'completed' ? 'badge-success' : receipt.status === 'cancelled' ? 'badge-error' : 'badge-warning'}">${this.getStatusText(receipt.status)}</span>
      </td>
      <td class="px-4 py-3 text-center">
  <div class="flex items-center justify-center space-x-2">
    <button class="btn-action btn-pdf" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF">
      <i class="bi bi-file-earmark-pdf"></i>
    </button>
    <button class="btn-action btn-edit" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
      <i class="bi bi-pencil-square"></i>
    </button>
    <button class="btn-action btn-delete" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">
      <i class="bi bi-trash"></i>
    </button>
  </div>
</td>
    `;

            tbody.appendChild(newRow);

            newRow.querySelector('.btn-edit').addEventListener('click', () => {
              this.editReceipt(receipt._id);
            });

            newRow.querySelector('.btn-delete').addEventListener('click', () => {
              this.confirmDelete(receipt._id);
            });

            newRow.querySelector('.btn-pdf').addEventListener('click', () => {
  // ‚úÖ ‡∏™‡πà‡∏á _id ‡πÅ‡∏ó‡∏ô documentNumber
  this.downloadPDF(receipt._id, receipt.documentNumber);
});

          });


          this.updateTableFooterTotal();
        },

        updateTableFooterTotal() {
          let total = 0;
          const receiptsToSum = this.filteredReceipts || this.receipts; // Sum based on filtered or all
          if (receiptsToSum && receiptsToSum.length > 0) {
            // Sum only non-cancelled receipts for the footer total
            total = receiptsToSum
              .filter(r => r.status !== 'cancelled')
              .reduce((sum, receipt) => sum + (receipt.totalAmount || 0), 0);
          }
          const totalElement = document.querySelector('tfoot td.receipt-total');
          if (totalElement) {
            totalElement.textContent = `‡∏ø${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          }
        },

        updateSummary(summaryDataFromLoadReceipts) {
          // This function is called after loadReceipts.
          // It should primarily update the first two cards if summaryDataFromLoadReceipts is provided.
          // The other cards (Auto Status, Pending) are updated by updateDashboardStats.

          if (!summaryDataFromLoadReceipts) {
            if (this.receipts && this.receipts.length > 0) {
              const now = new Date();
              const currentMonth = now.getMonth();
              const currentYear = now.getFullYear();

              const monthlyReceipts = this.receipts.filter(r => {
                const d = new Date(r.paymentDate);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear && r.status !== 'cancelled';
              });

              summaryDataFromLoadReceipts = {
                totalAmountMonth: monthlyReceipts.reduce((sum, r) => sum + r.totalAmount, 0),
                totalCountMonth: monthlyReceipts.length,
                // today related stats are now part of updateDashboardStats
              };
            } else {
              summaryDataFromLoadReceipts = { totalAmountMonth: 0, totalCountMonth: 0 };
            }
          }

          this.summary.totalAmountMonthFormatted = `‡∏ø${(summaryDataFromLoadReceipts.totalAmountMonth || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          this.summary.totalCountMonth = summaryDataFromLoadReceipts.totalCountMonth || 0;

          // Placeholder for comparison percentages - these would ideally come from backend or be calculated with more data
          this.summary.monthlyComparisonPercentage = summaryDataFromLoadReceipts.monthlyComparisonPercentage || 0;
          this.summary.countComparisonPercentage = summaryDataFromLoadReceipts.countComparisonPercentage || 0;

          // Call updateDashboardStats to refresh auto-creation related stats as well,
          // as loadReceipts might change the overall picture.
          this.updateDashboardStats();
        },

        // Call this method to show a notification with fallback handling
        showFallbackNotification(message, type = 'info') {
          const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500'
          };

          const notificationHtml = `
                <div id="fallbackNotification" class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight" style="animation-duration: 0.5s;">
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.closest('#fallbackNotification').remove()" class="ml-4 text-white hover:text-gray-200 focus:outline-none">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `;

          // Remove existing notification
          const existing = document.getElementById('fallbackNotification');
          if (existing) existing.remove();

          // Add new notification
          document.body.insertAdjacentHTML('beforeend', notificationHtml);

          // Auto remove after 3-5 seconds
          setTimeout(() => {
            const notification = document.getElementById('fallbackNotification');
            if (notification) {
              notification.classList.remove('animate__fadeInRight');
              notification.classList.add('animate__fadeOutRight');
              setTimeout(() => notification.remove(), 500); // Wait for fadeOut animation
            }
          }, type === 'error' ? 5000 : 3000);
        },

        getStatusText(status) {
          const statuses = {
            'draft': '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á',
            'completed': '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
            'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            'pending': '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
          };
    
          // Check if status is undefined or null
          if (!status || typeof status !== 'string') {
            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
          }
    
          return statuses[status] || status.charAt(0).toUpperCase() + status.slice(1);
        },



        async triggerAutoCreation() {
          try {
            this.showAutoProgressModal = true;
            this.autoProgress = { current: 0, total: 0, percentage: 0, currentItem: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', success: 0, skipped: 0, failed: 0 };
    
            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API endpoint ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            const endpoints = [
              '/api/receipt-voucher/trigger-auto-creation',          // endpoint ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
              '/api/receipt-vouchers/trigger-auto-creation',         // backup
              '/api/receiptVoucher/trigger-auto-creation',           // camelCase
              '/api/receiptVouchers/trigger-auto-creation',          // camelCase backup
              '/api/auto-creation/receipt-vouchers',                 // alternative
              '/api/auto-creation/trigger'                           // generic
            ];

            const requestBody = {
              types: this.autoConfig.types,
              limit: 50,
              branch: String(this.currentBranch || BRANCH_CODE || '00000')
            };

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô: ${endpoint}`);
                response = await fetch(endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                  },
                  body: JSON.stringify(requestBody)
                });

                if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (!foundEndpoint || !response) {
              throw new Error('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - API endpoints ‡πÑ‡∏°‡πà‡∏û‡∏ö');
            }

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                // ‚úÖ ‡∏´‡∏≤‡∏Å API return jobId ‡πÉ‡∏´‡πâ monitor progress
                if (result.data && result.data.jobId) {
                  this.monitorAutoCreationProgress(result.data.jobId);
                }
                // ‚úÖ ‡∏´‡∏≤‡∏Å API return ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏£‡∏á‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ jobId) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                else if (result.data && (result.data.created !== undefined || result.data.summary)) {
                  const created = result.data.created || [];
                  const failed = result.data.failed || [];
                  const summary = result.data.summary || {};
    
                  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                  const message = failed.length > 0
                    ? `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failed.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
                    : `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    
                  const type = failed.length > 0 ? 'warning' : 'success';
    
                  this.showNotification(message, type);
                  this.loadReceipts();
                  this.updateDashboardStats();
                  this.showAutoProgressModal = false;
    
                  console.log('‚úÖ Auto creation completed:', summary);
                } else {
                  // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ message ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                  this.showNotification(result.message || '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                  this.loadReceipts();
                  this.updateDashboardStats();
                  this.showAutoProgressModal = false;
                }
              } else {
                throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
              }
            } else if (response.status === 404) {
              throw new Error('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            } else {
              throw new Error('Failed to trigger auto creation');
            }
          } catch (e) {
            console.log('‚ùå Error triggering auto creation:', e.message);
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ' + e.message, 'error');
            this.showAutoProgressModal = false;
          }
        },

        monitorAutoCreationProgress(jobId) {
          if (this.autoCreationJob) clearInterval(this.autoCreationJob);
          this.autoCreationJob = setInterval(async () => {
            try {
              const res = await fetch(`/api/receipt-voucher/auto-create/progress/${jobId}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
              });
              if (res.ok) {
                const result = await res.json();
                if (result.success && result.data) {
                  const p = result.data;
                  this.autoProgress = {
                    current: p.processed || 0,
                    total: p.total || 0,
                    percentage: p.total > 0 ? Math.round((p.processed || 0) / p.total * 100) : 0,
                    currentItem: p.currentItem || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                    success: p.success || 0,
                    skipped: p.skipped || 0,
                    failed: p.failed || 0
                  };
                  if (p.status === 'completed' || (p.total > 0 && p.processed >= p.total)) {
                    this.cancelAutoCreation();
                    this.showNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${this.autoProgress.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                    this.loadReceipts();
                    this.updateDashboardStats();
                    setTimeout(() => this.showAutoProgressModal = false, 2000);
                  }
                }
              } else if (res.status === 404) {
                // API ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏¢‡∏∏‡∏î monitoring
                this.cancelAutoCreation();
                this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'warning');
                setTimeout(() => this.showAutoProgressModal = false, 2000);
              }
            } catch (e) {
              console.log('Error monitoring progress:', e.message);
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î monitoring
            }
          }, 1000);
        },

        cancelAutoCreation() {
          if (this.autoCreationJob) {
            clearInterval(this.autoCreationJob);
            this.autoCreationJob = null;
          }
        },

        async viewAutoHistory() {
          try {
            const res = await fetch('/api/receipt-voucher/auto-creation-history', {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            });
            if (res.ok) {
              const result = await res.json();
              if (result.success && result.data) this.showAutoHistoryModal(result.data);
            } else if (res.status === 404) {
              this.showNotification('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'info');
            } else {
              throw new Error('Failed to fetch history');
            }
          } catch (e) {
            console.log('Error fetching auto history:', e.message);
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', 'error');
          }
        },

        showAutoHistoryModal(historyData) {
          const modalHtml = `
              <div id="autoHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] overflow-auto">
                  <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
                    <button onclick="document.getElementById('autoHistoryModal').remove()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-200">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <div class="p-4 space-y-3">${historyData.map(item => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                      <div class="flex justify-between">
                        <span>${new Date(item.createdAt).toLocaleString('th-TH')}</span>
                        <span class="badge ${item.status === 'completed' ? 'badge-success' : 'badge-warning'}">${item.status}</span>
                      </div>
                      <div class="mt-1 text-sm text-gray-600 dark:text-gray-300">
                        ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${item.success} | ‡∏Ç‡πâ‡∏≤‡∏°: ${item.skipped} | ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${item.failed}
                      </div>
                    </div>`).join('')}</div>
                </div>
              </div>`;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
        },

        setupEnhancedSocketListeners() {
          // ‡πÉ‡∏ä‡πâ global receiptVoucherSocket ‡πÅ‡∏ó‡∏ô this.socket
          if (!window.receiptVoucherSocket) {
            console.log('‚ö†Ô∏è receiptVoucherSocket not available for Alpine.js');
            return;
          }
    
          // Setup Socket.IO listeners for Alpine.js
          window.receiptVoucherSocket.on('autoCreationProgress', (data) => {
            console.log('üìä Alpine.js: Auto creation progress received:', data);
    
            if (this.showAutoProgressModal) {
              this.autoProgress = {
                current: data.processed || 0,
                total: data.total || 0,
                percentage: data.total > 0 ? Math.round((data.processed || 0) / data.total * 100) : 0,
                currentItem: data.currentItem || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                success: data.success || 0,
                skipped: data.skipped || 0,
                failed: data.failed || 0
              };
            }
    
            if (this.showAutoCreateToast) {
              this.autoCreateMessage = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${data.processed || 0}/${data.total || 0}`;
              this.autoCreateProgress = this.autoProgress.percentage;
            }
          });
    
          window.receiptVoucherSocket.on('autoCreationCompleted', (data) => {
            console.log('üéâ Alpine.js: Auto creation completed:', data);
    
            this.showNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, data.failed > 0 ? 'warning' : 'success');
            this.loadReceipts();
            this.updateDashboardStats();
    
            if (this.showAutoProgressModal) {
              setTimeout(() => {
                this.showAutoProgressModal = false;
                if (typeof this.cancelAutoCreation === 'function') {
                this.cancelAutoCreation();
                }
              }, 2000);
            }
          });
    
          console.log('üéØ Alpine.js Socket.IO listeners setup completed');
        },

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Auto Creation ‡∏ó‡∏µ‡πà Backend
        async checkBackendAutoConfig() {
          try {
            // ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡πÅ‡∏ó‡∏ô
            console.log('üìä Using local Auto Config (backend API not available)');
    
            // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å local autoConfig ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å loadAutoConfig()
            if (this.autoConfig.enabled) {
              console.log('‚úÖ Local Auto Creation: ENABLED');
              this.updateAutoStatus(true, '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
            } else {
              console.log('‚ö†Ô∏è Local Auto Creation: DISABLED');
              this.updateAutoStatus(false, '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }

          } catch (error) {
            console.log('Error in checkBackendAutoConfig, using defaults:', error.message);
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
            this.updateAutoStatus(true, '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
          }
        },

        // Missing methods that are referenced in the template
        showNotification(message, type = 'success') {
          this.notification.message = message;
          this.notification.type = type;
          this.notification.show = true;
    
          // Auto hide after 3 seconds
          setTimeout(() => {
            this.notification.show = false;
          }, type === 'error' ? 5000 : 3000);
        },

        openAddReceiptModal() {
          this.receiptId = null;
          this.showModal = true;
    
          // Reset form
          const form = document.getElementById('receiptForm');
          if (form) form.reset();
    
          // Set default date
          const dateInput = document.getElementById('paymentDate');
          if (dateInput) {
            dateInput.value = new Date().toISOString().substr(0, 10);
          }
    
          // Generate new document ID
          const docInput = document.getElementById('documentNumber');
          if (docInput) {
            docInput.value = this.generateDocumentId();
          }
        },

        generateDocumentId() {
          const now = new Date();
          const year = now.getFullYear().toString().substr(-2);
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
          return `RV${year}${month}${day}${time}`;
        },

        confirmDelete(id) {
          this.receiptIdToDelete = id;
          this.showDeleteModal = true;
        },

        async deleteReceipt() {
          if (!this.receiptIdToDelete) return;
    
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            const endpoints = [
              `/api/receipt/${this.receiptIdToDelete}`,          // Receipt API ‡∏´‡∏•‡∏±‡∏Å
              `/api/receipt-voucher/${this.receiptIdToDelete}`,
              `/api/receipt-vouchers/${this.receiptIdToDelete}`,
              `/api/receiptVoucher/${this.receiptIdToDelete}`,
              `/api/receiptVouchers/${this.receiptIdToDelete}`
            ];

            let response = null;
            for (const endpoint of endpoints) {
              try {
                response = await fetch(endpoint, {
                  method: 'DELETE',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });
                if (response.status !== 404) break;
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (!response || response.status === 404) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô');
            }

            if (response.ok) {
              this.showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
              await this.loadReceipts();
            } else {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ');
            }
          } catch (error) {
            console.error('Delete error:', error);
            this.showNotification(error.message, 'error');
          } finally {
            this.showDeleteModal = false;
            this.receiptIdToDelete = null;
          }
        },

        async downloadPDF(receiptId, documentNumber) {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            const endpoints = [
              `/api/receipt-voucher/${receiptId}/pdf`,
              `/api/receipt-vouchers/${receiptId}/pdf`,
              `/api/receiptVoucher/${receiptId}/pdf`,
              `/api/receiptVouchers/${receiptId}/pdf`
            ];

            let response = null;
            for (const endpoint of endpoints) {
              try {
                response = await fetch(endpoint, {
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status !== 404) break;
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (!response || response.status === 404) {
              throw new Error('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${documentNumber || receiptId}.pdf`;
              a.click();
              window.URL.revokeObjectURL(url);
              this.showNotification('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏î‡πâ');
            }
          } catch (error) {
            console.error('Download PDF error:', error);
            this.showNotification(error.message, 'warning');
          }
        },

        updateTransactionTotal() {
          const amountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');
          let total = 0;
          amountInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
          });
          const totalElement = document.getElementById('transactionTotal');
          if (totalElement) {
            totalElement.textContent = `‡∏ø${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          }
        },

        updatePagination() {
          this.totalReceipts = this.filteredReceipts.length;
          this.totalPages = Math.ceil(this.totalReceipts / this.itemsPerPage);
    
          if (this.currentPage > this.totalPages && this.totalPages > 0) {
            this.currentPage = 1;
          }
    
          this.paginationStart = Math.min((this.currentPage - 1) * this.itemsPerPage + 1, this.totalReceipts);
          this.paginationEnd = Math.min(this.currentPage * this.itemsPerPage, this.totalReceipts);
    
          // Update pagination buttons
          this.updatePaginationButtons();
        },

        updatePaginationButtons() {
          const container = document.getElementById('paginationButtons');
          if (!container) return;
    
          container.innerHTML = '';
    
          // Previous button
          if (this.currentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.className = 'px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded mr-1';
            prevBtn.textContent = '‚Äπ';
            prevBtn.onclick = () => {
              this.currentPage--;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(prevBtn);
          }
    
          // Page numbers
          const startPage = Math.max(1, this.currentPage - 2);
          const endPage = Math.min(this.totalPages, this.currentPage + 2);
    
          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `px-3 py-1 text-sm rounded mr-1 ${i === this.currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => {
              this.currentPage = i;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(pageBtn);
          }
    
          // Next button
          if (this.currentPage < this.totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.className = 'px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded mr-1';
            nextBtn.textContent = '‚Ä∫';
            nextBtn.onclick = () => {
              this.currentPage++;
              this.updatePagination();
              this.updateTable();
            };
            container.appendChild(nextBtn);
          }
        },

        async updateDashboardStats() {
          try {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (throttling)
            const now = Date.now();
            if (this.lastStatsUpdate && now - this.lastStatsUpdate < 10000) {
              console.log('üö´ Stats update throttled (less than 10 seconds ago)');
              return;
            }
            this.lastStatsUpdate = now;
    
            console.log('üìä Updating dashboard stats...');
    
            // Update today's auto created count
            const today = new Date().toISOString().split('T')[0];
            const todayAutoCount = this.receipts.filter(r => {
              const receiptDate = new Date(r.paymentDate).toISOString().split('T')[0];
              return receiptDate === today && r.notes && r.notes.toLowerCase().includes('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
            }).length;
    
            this.summary.todayAutoCreatedCount = todayAutoCount;
            console.log('üìä Today auto created count:', todayAutoCount);
    
            // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Modal (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á branchCode)
            await this.updatePendingReceiptsCount();
    
            console.log('üìä Dashboard stats updated. Pending count:', this.summary.pendingReceiptCount);
    
          } catch (error) {
            console.log('Error updating dashboard stats:', error.message);
          }
        },

        async updatePendingReceiptsCount() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              this.summary.pendingReceiptCount = 0;
              return;
            }

            // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Modal (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á branchCode)
            const endpoints = [
              '/api/receipt-voucher/pending-receipts',
              '/api/receipt-vouchers/pending-receipts'
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á pending receipts ‡∏à‡∏≤‡∏Å: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.ok) {
                  foundEndpoint = endpoint;
                  break;
                } else if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            if (foundEndpoint && response && response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                this.summary.pendingReceiptCount = result.data.length;
                console.log(`üìä Found ${result.data.length} pending receipts for voucher creation`);
                return;
              }
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ API ‡πÉ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            console.log('üìä No pending receipts API available, using default value 0');
            this.summary.pendingReceiptCount = 0;

          } catch (error) {
            console.log('Could not update pending receipts count:', error.message);
            this.summary.pendingReceiptCount = 0;
          }
        },

        async loadSummaryByTimeRange() {
          try {
            const now = new Date();
            let startDate, endDate;
    
            // Calculate date ranges based on timeRange settings
            if (this.timeRange.amount === 'month') {
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (this.timeRange.amount === 'week') {
              startDate = new Date(now.setDate(now.getDate() - now.getDay()));
              endDate = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            } else { // today
              startDate = new Date(now.setHours(0, 0, 0, 0));
              endDate = new Date(now.setHours(23, 59, 59, 999));
            }
    
            // Filter receipts by date range
            const rangeReceipts = this.receipts.filter(r => {
              const receiptDate = new Date(r.paymentDate);
              return receiptDate >= startDate && receiptDate <= endDate && r.status !== 'cancelled';
            });
    
            // Calculate totals
            const totalAmount = rangeReceipts.reduce((sum, r) => sum + (r.totalAmount || 0), 0);
            const totalCount = rangeReceipts.length;
    
            // Update summary
            this.summary.totalAmountFormatted = `‡∏ø${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            this.summary.totalCount = totalCount;
    
          } catch (error) {
            console.log('Error loading summary by time range:', error.message);
          }
        },

        changeTimeRange(type) {
          // Cycle through time ranges: today -> week -> month
          const ranges = ['today', 'week', 'month'];
          const texts = ['‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ', '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'];
    
          const currentIndex = ranges.indexOf(this.timeRange[type]);
          const nextIndex = (currentIndex + 1) % ranges.length;
    
          this.timeRange[type] = ranges[nextIndex];
          this.timeRangeText[type] = texts[nextIndex];
    
          // Reload summary with new time range
          this.loadSummaryByTimeRange();
        },

        async checkPendingItems() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            }

            // ‡πÅ‡∏™‡∏î‡∏á loading
            let loaderId = LoadingSystem.show({
              message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...',
              type: 'spinner'
            });

            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            const endpoints = [
              '/api/receipt-voucher/pending-receipts',
              '/api/receipt-vouchers/pending-receipts'
            ];

            let response = null;
            let foundEndpoint = null;

            for (const endpoint of endpoints) {
              try {
                console.log(`üîç ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å: ${endpoint}`);
                response = await fetch(endpoint, {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                if (response.status !== 404) {
                  foundEndpoint = endpoint;
                  break;
                }
              } catch (err) {
                console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
              }
            }

            LoadingSystem.hide(loaderId);

            if (!foundEndpoint || !response) {
              throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - API endpoints ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }

            if (!response.ok) {
              if (response.status === 401) {
                throw new Error('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
              } else {
                throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${response.status}`);
              }
            }

            const result = await response.json();
    
            if (!result.success) {
              throw new Error(result.message || 'API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            const pendingReceipts = result.data || [];
    
            // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            this.showPendingReceiptsModal(pendingReceipts);

          } catch (error) {
            console.error('Error checking pending receipts:', error);
            this.showNotification(error.message, 'error');
    
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô token expired ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
            if (error.message.includes('Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') || error.message.includes('401')) {
              setTimeout(() => {
                localStorage.removeItem('authToken');
                window.location.href = '/login';
              }, 3000);
            }
          }
        },

        showPendingReceiptsModal(pendingReceipts) {
          const hasReceipts = pendingReceipts && pendingReceipts.length > 0;
    
          let tableContent = '';
          if (hasReceipts) {
            tableContent = `
              <div class="overflow-x-auto">
                <table class="w-full table-auto">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                      <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 dark:text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                      <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                      <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 dark:text-gray-300">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            pendingReceipts.forEach(receipt => {
              const receiptDate = new Date(receipt.saleDate || receipt.createdAt);
              const formattedDate = receiptDate.toLocaleDateString('th-TH');
              const amount = receipt.totalAmount || receipt.netAmount || 0;
              const customerName = receipt.customerName || receipt.customer?.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
              const receiptType = this.getReceiptSourceDisplay(receipt.source);

              tableContent += `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                    ${receipt.receiptNumber || receipt.documentNumber || receipt._id}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                    ${formattedDate}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                    ${customerName}
                  </td>
                  <td class="px-4 py-3 text-sm text-right font-medium text-gray-900 dark:text-gray-100">
                    ‡∏ø${amount.toLocaleString('th-TH', { minimumFractionDigits: 2 })}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                      ${receiptType}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <button 
                      onclick="createReceiptVoucherFromReceipt('${receipt._id}', '${receipt.receiptNumber || receipt.documentNumber}', ${amount}, '${customerName.replace(/'/g, "\\'")}', '${receipt.source || 'pos'}')"
                      class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
                      title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ">
                      <i class="bi bi-plus-circle mr-1"></i>
                      ‡∏™‡∏£‡πâ‡∏≤‡∏á
                    </button>
                  </td>
                </tr>
              `;
            });

            tableContent += `
                  </tbody>
                </table>
              </div>
            `;
          } else {
            tableContent = `
              <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                <i class="bi bi-check-circle text-5xl mb-4 text-green-500"></i>
                <h3 class="text-lg font-medium mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                <p class="text-sm">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
              </div>
            `;
          }

          const modalHtml = `
            <div id="pendingItemsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
              <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-6xl w-full mx-4 max-h-[85vh] overflow-hidden">
                
                <!-- Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                  <div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">
                      ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                      ${hasReceipts ? `‡∏û‡∏ö ${pendingReceipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
                    </p>
                  </div>
                  <button onclick="document.getElementById('pendingItemsModal').remove()" 
                          class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none">
                    <i class="bi bi-x-lg text-xl"></i>
                  </button>
                </div>

                <!-- Content -->
                <div class="overflow-y-auto max-h-[60vh] p-6">
                  ${tableContent}
                </div>

                <!-- Footer -->
                ${hasReceipts ? `
                  <div class="flex justify-between items-center p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      ‡∏£‡∏ß‡∏° ${pendingReceipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ 
                      ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡∏ø${pendingReceipts.reduce((sum, r) => sum + (r.totalAmount || r.netAmount || 0), 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })}
                    </div>
                    <div class="flex space-x-3">
                      <button onclick="document.getElementById('pendingItemsModal').remove()" 
                              class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                        ‡∏õ‡∏¥‡∏î
                      </button>
                      <button onclick="createBatchReceiptVouchersFromReceipts()" 
                              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm hover:shadow transition-all focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="bi bi-stack mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                      </button>
                    </div>
                  </div>
                ` : `
                  <div class="flex justify-end p-6 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="document.getElementById('pendingItemsModal').remove()" 
                            class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                      ‡∏õ‡∏¥‡∏î
                    </button>
                  </div>
                `}

              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);
        },

        getReceiptSourceDisplay(source) {
          const sourceMap = {
            'pos': 'POS/‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô',
            'frontstore': '‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô',
            'cash_sale': '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î',
            'credit_sale': '‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πà‡∏≠',
            'installment': '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô',
            'installment_down_payment': '‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ú‡πà‡∏≠‡∏ô',
            'service': '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
            'online': '‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            'wholesale': '‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á',
            'branch_stock_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å'
          };
          return sourceMap[source] || '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        },

                 // Initialize methods
        async init() {
          try {
            // Load branch info first and set current branch
            const branchInfo = await loadBranchInfo();
            if (branchInfo) {
              this.currentBranch = branchInfo._id;
            }
    
            // Load chart of accounts
            await this.loadChartOfAccounts();
    
            // Load auto config
            await this.loadAutoConfig();
    
            // Load receipts
            await this.loadReceipts();
    
            // Setup auto creation if enabled
            await this.checkBackendAutoConfig();
            if (this.autoConfig.enabled && this.autoConfig.timing === 'immediate') {
              this.startAutoCreationInterval();
            }
    
            console.log('‚úÖ Receipt Voucher System initialized successfully');
    
          } catch (error) {
            console.error('‚ùå Error initializing receipt voucher system:', error);
            this.showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message, 'error');
          }
        },

        async loadChartOfAccounts() {
          try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            // Load debit accounts (cash, bank accounts)
            this.debitAccounts = [
              { code: '11101', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' },
              { code: '11201', name: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£' },
              { code: '11202', name: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå' }
            ];

            // Load credit accounts (revenue, liability accounts)
            this.creditAccounts = [
              { code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' },
              { code: '41201', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' },
              { code: '21101', name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤' },
              { code: '21201', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' }
            ];

          } catch (error) {
            console.log('Error loading chart of accounts:', error.message);
            // Use default accounts if loading fails
            this.debitAccounts = [{ code: '11101', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' }];
            this.creditAccounts = [{ code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' }];
          }
        }
      }));
    });


    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° utility function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏ö‡∏ö fallback
    window.apiUtils = {
      async callMultipleEndpoints(endpoints, options = {}) {
        const { method = 'GET', headers = {}, body = null, description = 'API call' } = options;
    
        let response = null;
        let foundEndpoint = null;
        let lastError = null;

        for (const endpoint of endpoints) {
          try {
            console.log(`üîç ‡∏•‡∏≠‡∏á${description}‡∏à‡∏≤‡∏Å: ${endpoint}`);
    
            const fetchOptions = { method, headers };
            if (body && method !== 'GET') {
              fetchOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
            }
    
            response = await fetch(endpoint, fetchOptions);

            if (response.status !== 404) {
              foundEndpoint = endpoint;
              console.log(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à${description}‡∏à‡∏≤‡∏Å: ${endpoint}`);
              break;
            }
          } catch (err) {
            lastError = err;
            console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ:`, err.message);
          }
        }

        return { response, foundEndpoint, lastError };
      }
    };

    // Global function for removing transaction details (for onclick handler)
    function removeTransactionDetail(button) { // Renamed from app.removeTransactionDetail for global onclick
      const alpineInstance = document.querySelector('[x-data="app"]').__x;
      if (alpineInstance) {
        alpineInstance.removeTransactionDetail(button);
      }
    }

    // Global function for updating transaction total (for oninput handler)
    function updateTransactionTotal() {
      const alpineInstance = document.querySelector('[x-data="app"]').__x;
      if (alpineInstance && typeof alpineInstance.updateTransactionTotal === 'function') { // Check if method exists
        alpineInstance.updateTransactionTotal();
      } else { // Fallback if Alpine not ready or direct call, or method not on instance
        const amountInputs = document.querySelectorAll('#receiptForm input[name="detailAmount[]"]');
        let total = 0;
        amountInputs.forEach(input => {
          const value = parseFloat(input.value) || 0;
          total += value;
        });
        const totalElement = document.getElementById('transactionTotal');
        if (totalElement) {
          totalElement.textContent = `‡∏ø${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
      }
    }

    function togglePaymentDetails(paymentMethodValue) {
      const bankDetailsDiv = document.getElementById('bankDetails');
      if (!bankDetailsDiv) return;
      if (paymentMethodValue === 'transfer' || paymentMethodValue === 'cheque') {
        bankDetailsDiv.style.display = 'grid'; // Assuming it's a grid
      } else {
        bankDetailsDiv.style.display = 'none';
      }
    }


    function updateAccountName(selectElement, hiddenInputId) {
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const hiddenInput = document.getElementById(hiddenInputId);
      if (selectedOption && selectedOption.value && hiddenInput) {
        const parts = selectedOption.value.split('|');
        if (parts.length > 1) {
          hiddenInput.value = parts[1]; // Name is after |
        } else {
          // Fallback: try to parse from text like "CODE - NAME"
          const textParts = selectedOption.text.split(' - ');
          hiddenInput.value = textParts.length > 1 ? textParts[1] : selectedOption.text;
        }
      } else if (hiddenInput) {
        hiddenInput.value = '';
      }
    }

    // ==================== SYNC INTEGRATION FUNCTIONS ====================
    
    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà sync ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
     */
    async function createReceiptVoucherFromReceipt(receiptId, receiptNumber, amount, customerName, source) {
      try {
        console.log('üßæ Creating receipt voucher from synced receipt:', {
          receiptId, receiptNumber, amount, customerName, source
        });

        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        }

        // ‡πÅ‡∏™‡∏î‡∏á loading
        let loaderId = LoadingSystem.show({
          message: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å${getSourceDisplayName(source)}...`,
          type: 'spinner'
        });

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
        const receiptVoucherData = {
          // Sync API fields
          source: source,
          sourceId: receiptId,
          documentNumber: `RV-AUTO-${receiptNumber}-${Date.now()}`,
          customerName: customerName,
          totalAmount: amount,
          paymentMethod: getDefaultPaymentMethod(source),
          description: `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å${getSourceDisplayName(source)} ${receiptNumber}`,
          notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å${getSourceDisplayName(source)} ${receiptNumber}`,
    
          // Additional metadata
          metadata: {
            sourceReceiptNumber: receiptNumber,
            autoGenerated: true,
            createdBy: 'manual_sync_system',
            originalReceiptId: receiptId
          }
        };

        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sync API
        const response = await fetch('/api/receipt-vouchers/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(receiptVoucherData)
        });

        LoadingSystem.hide(loaderId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
    
        if (result.success) {
          console.log('‚úÖ Receipt voucher created successfully:', result.data.documentNumber);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          if (window.showToast) {
            window.showToast(
              `üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
              'success',
              '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              4000
            );
          }

          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const alpineInstance = document.querySelector('[x-data="app"]').__x;
          if (alpineInstance && alpineInstance.loadReceipts) {
            alpineInstance.loadReceipts();
          }

          // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä pending list
          document.getElementById('pendingItemsModal')?.remove();
          if (alpineInstance && alpineInstance.checkPendingItems) {
            setTimeout(() => alpineInstance.checkPendingItems(), 1000);
          }

          return result.data;
        } else {
          throw new Error(result.message || 'Failed to create receipt voucher');
        }

      } catch (error) {
        console.error('‚ùå Error creating receipt voucher from receipt:', error);
    
        if (window.showToast) {
          window.showToast(
            `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`,
            'error',
            '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            6000
          );
        }
    
        throw error;
      }
    }

    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
     */
    async function createBatchReceiptVouchersFromReceipts() {
      try {
        console.log('üßæ Creating batch receipt vouchers...');

        const modal = document.getElementById('pendingItemsModal');
        if (!modal) return;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å modal (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á modal)
        const alpineInstance = document.querySelector('[x-data="app"]').__x;
        if (!alpineInstance) return;

        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        }

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ pending receipts ‡πÉ‡∏´‡∏°‡πà
        const endpoints = [
          '/api/receipt-vouchers/pending-receipts',
          '/api/receipt-voucher/pending-receipts',
          '/api/pos/receipts/pending-vouchers'
        ];

        const { response, foundEndpoint } = await window.apiUtils.callMultipleEndpoints(
          endpoints,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            description: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°'
          }
        );

        if (!response || !response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ');
        }

        const result = await response.json();
        const pendingReceipts = result.data || [];

        if (pendingReceipts.length === 0) {
          if (window.showToast) {
            window.showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô', 'info', '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
          }
          return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á loading
        let loaderId = LoadingSystem.show({
          message: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${pendingReceipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`,
          type: 'spinner',
          showProgress: true
        });

        let successCount = 0;
        let errorCount = 0;
        const errors = [];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        for (let i = 0; i < pendingReceipts.length; i++) {
          const receipt = pendingReceipts[i];
    
          try {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress
            const progress = ((i + 1) / pendingReceipts.length) * 100;
            LoadingSystem.updateProgress(loaderId, progress);
            LoadingSystem.updateMessage(loaderId,
              `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${i + 1}/${pendingReceipts.length}...`,
              `${receipt.receiptNumber || receipt.documentNumber || receipt._id}`
            );

            await createReceiptVoucherFromReceipt(
              receipt._id,
              receipt.receiptNumber || receipt.documentNumber || receipt._id,
              receipt.totalAmount || receipt.netAmount || 0,
              receipt.customerName || receipt.customer?.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
              receipt.source || 'pos'
            );

            successCount++;
    
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏ô
            await new Promise(resolve => setTimeout(resolve, 500));

          } catch (error) {
            console.error(`‚ùå Error creating receipt voucher for ${receipt.receiptNumber}:`, error);
            errorCount++;
            errors.push({
              receiptNumber: receipt.receiptNumber || receipt._id,
              error: error.message
            });
          }
        }

        LoadingSystem.hide(loaderId);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ
        const message = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` +
                       (errorCount > 0 ? `, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '');
    
        if (window.showToast) {
          window.showToast(
            message,
            errorCount > 0 ? 'warning' : 'success',
            '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á',
            6000
          );
        }

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (alpineInstance && alpineInstance.loadReceipts) {
          alpineInstance.loadReceipts();
        }

        // ‡∏õ‡∏¥‡∏î modal
        document.getElementById('pendingItemsModal')?.remove();

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î error ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
        if (errors.length > 0) {
          console.warn('Batch creation errors:', errors);
        }

      } catch (error) {
        console.error('‚ùå Error in batch receipt voucher creation:', error);
    
        if (window.showToast) {
          window.showToast(
            `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${error.message}`,
            'error',
            '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            6000
          );
        }
      }
    }

    // Helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ mapping ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° source
    function getSourceDisplayName(source) {
      const nameMap = {
        'pos': '‡∏£‡∏∞‡∏ö‡∏ö POS',
        'frontstore': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô',
        'installment': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô',
        'cash_sale': '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î',
        'branch_stock_history': '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å'
      };
      return nameMap[source] || '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢';
    }

    function getSourceDebitAccount(source) {
      // ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
      return { code: '11101', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' };
    }

    function getSourceCreditAccount(source) {
      const accountMap = {
        'installment': { code: '41102', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' },
        'installment_down_payment': { code: '41102', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' },
        'frontstore': { code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' },
        'pos': { code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' },
        'cash_sale': { code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' }
      };
      return accountMap[source] || { code: '41101', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' };
    }

    function getReceiptType(source) {
      const typeMap = {
        'installment': 'installment_down_payment',
        'installment_down_payment': 'installment_down_payment',
        'frontstore': 'sale',
        'pos': 'sale',
        'cash_sale': 'sale'
      };
      return typeMap[source] || 'sale';
    }

    function getDefaultPaymentMethod(source) {
      // ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö POS ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô
      return 'cash';
    }

    // Add x-cloak style to hide elements before Alpine initializes
    document.head.insertAdjacentHTML('beforeend', `
        <style>
          [x-cloak] { display: none !important; }
          
          /* Custom button styles */
          .btn-action {
            @apply w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200;
          }
          
          .btn-pdf {
            @apply text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30;
          }
          
          .btn-edit {
            @apply text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30;
          }
          
          .btn-delete {
            @apply text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30;
          }
          
          /* Receipt table styles */
          .receipt-table {
            @apply w-full table-auto;
          }
          
          .receipt-table th {
            @apply text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50;
          }
          
          .receipt-table td {
            @apply text-sm;
          }
          
          /* Badge styles */
          .badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
          }
          
          .badge-success {
            @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400;
          }
          
          .badge-warning {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400;
          }
          
          .badge-error {
            @apply bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400;
          }
          
          .badge-info {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400;
          }
          
          .badge-xs {
            @apply text-xs px-1 py-0.5;
          }
          
          .badge-sm {
            @apply text-sm px-2 py-1;
          }
          
          /* Form floating styles */
          .form-group {
            @apply relative mb-4;
          }
          
          .form-floating {
            @apply relative;
          }
          
          .form-floating input,
          .form-floating select,
          .form-floating textarea {
            @apply w-full px-3 pt-6 pb-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors;
          }
          
          .form-floating label {
            @apply absolute left-3 top-2 text-sm transition-all duration-200 pointer-events-none;
          }
          
          .form-floating input:focus ~ label,
          .form-floating input:not(:placeholder-shown) ~ label,
          .form-floating select:focus ~ label,
          .form-floating select:not([value=""]) ~ label,
          .form-floating .peer:focus ~ label,
          .form-floating .peer:not(:placeholder-shown) ~ label {
            @apply text-xs top-1 text-blue-600 dark:text-blue-400;
          }
          
          /* Animation classes */
          .slide-in {
            animation: slideIn 0.5s ease-out forwards;
          }
          
          .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
          }
          
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          @keyframes fadeIn {
            from {
              opacity: 0;
            }
            to {
              opacity: 1;
            }
          }
          
          /* Receipt form specific styles */
          .receipt-form input[type="text"],
          .receipt-form input[type="number"],
          .receipt-form input[type="date"],
          .receipt-form select,
          .receipt-form textarea {
            @apply transition-all duration-200;
          }
          
          .receipt-form input:focus,
          .receipt-form select:focus,
          .receipt-form textarea:focus {
            @apply ring-2 ring-blue-500 border-blue-500;
          }
          
          /* Pending receipts modal styles */
          .pending-receipts-table {
            @apply w-full table-auto;
          }
          
          .pending-receipts-table th {
            @apply text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700;
          }
          
          .pending-receipts-table td {
            @apply text-sm;
          }
          
          .pending-receipts-table tr:hover {
            @apply bg-gray-50 dark:bg-gray-700;
          }
          
          /* Receipt source badge */
          .receipt-source-badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
          }
          
          .receipt-source-badge.pos {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400;
          }
          
          .receipt-source-badge.installment {
            @apply bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400;
          }
          
          .receipt-source-badge.service {
            @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400;
          }
          
          /* Create button animation */
          .create-voucher-btn {
            @apply transition-all duration-200 transform hover:scale-105;
          }
          
          .create-voucher-btn:hover {
            @apply shadow-lg;
          }
          
          .create-voucher-btn:disabled {
            @apply opacity-60 cursor-not-allowed transform-none;
          }
          
          /* Pending count badge animation */
          .pending-count-badge {
            @apply animate-pulse;
            animation-duration: 1.5s;
          }
          
          /* Receipt modal scrollbar */
          .receipt-modal-content::-webkit-scrollbar {
            width: 6px;
          }
          
          .receipt-modal-content::-webkit-scrollbar-track {
            @apply bg-gray-100 dark:bg-gray-700;
          }
          
          .receipt-modal-content::-webkit-scrollbar-thumb {
            @apply bg-gray-300 dark:bg-gray-600 rounded-full;
          }
          
          .receipt-modal-content::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-400 dark:bg-gray-500;
          }
        </style>
      `);

    // Load employee data (in real app, this would be from an API)
    window.onload = async function () {
      try {
        // document.getElementById('employeeName').textContent = '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ'; // Now handled by loadEmployeeProfile
        // document.getElementById('employeePhoto').src = 'https://randomuser.me/api/portraits/men/32.jpg'; // Now handled by loadEmployeeProfile

        // Alpine init should handle this now.
        // const app = document.querySelector('[x-data]')?.__x?.data;
        // if (app) {
        //   app.showModal = false;
        //   app.showDeleteModal = false;
        //   // await app.loadReceipts(); // Moved to Alpine init
        // }
      } catch (error) {
        console.error('Error during page initialization:', error);
      }
    };

    // Handle errors gracefully
    window.addEventListener('error', function (e) {
      console.error('Page error:', e.error);
      // Prevent modals from showing on error
      const app = document.querySelector('[x-data]')?.__x;
      if (app) {
        app.$data.showModal = false;
        app.$data.showDeleteModal = false;
      }
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° global functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (‡πÉ‡∏ä‡πâ Standard API)
window.createReceiptVoucherFromReceipt = async (receiptId, receiptNumber, amount, customerName, source) => {
  // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® btn ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô function scope ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  let btn = null;
  let originalText = '<i class="bi bi-plus-circle mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á';

  try {
    // ‡πÅ‡∏™‡∏î‡∏á loading
    btn = event?.target;
    if (btn) {
      originalText = btn.innerHTML;
      btn.originalText = originalText; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô property
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
    }

    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    }

    console.log('üìÑ Creating receipt voucher from receipt:', {
      receiptId,
      receiptNumber,
      amount,
      customerName,
      source
    });

    // ‚úÖ ‡πÉ‡∏ä‡πâ Standard Receipt Voucher API format
    const requestBody = {
      documentNumber: `RV-${receiptNumber}-${Date.now()}`,
      paymentDate: new Date().toISOString().split('T')[0],
      debitAccount: {
        code: '11101',
        name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'
      },
      creditAccount: {
        code: source === 'installment' ? '41102' : '41101',
        name: source === 'installment' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
      },
      receivedFrom: customerName,
      receiptType: source === 'installment' ? 'installment_down_payment' : 'cash_sale',
      paymentMethod: 'cash',
      details: [{
        description: `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${receiptNumber} - ${customerName}`,
        amount: amount
      }],
      totalAmount: amount,
      netAmount: amount,
      vatAmount: 0,
      notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${receiptNumber}`,
    
      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockHistoryId ‡∏ó‡∏µ‡πà backend ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      branchStockHistoryId: source === 'branch_stock_history' ? receiptId : null,
    
      // Enhanced metadata for tracking
      metadata: {
        sourceType: source || 'pos',
        sourceId: receiptId,
        autoGenerated: true,
        sourceReceiptNumber: receiptNumber,
        originalReceiptId: receiptId
      }
    };

    console.log('üì§ Request body for standard API:', JSON.stringify(requestBody, null, 2));

    // ‚úÖ ‡πÉ‡∏ä‡πâ Standard API endpoint
    const response = await fetch('/api/receipt-vouchers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('üì• Response from standard API:', result);

    if (result.success) {
      // ‡∏õ‡∏¥‡∏î modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      const alpineApp = document.querySelector('[x-data="app"]').__x;
      if (alpineApp) {
        alpineApp.showNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${receiptNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        await alpineApp.loadReceipts();
        await alpineApp.updateDashboardStats();
      } else {
        window.showFallbackNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
      }
    } else {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
      if (btn && typeof btn === 'object' && btn.disabled !== undefined) {
        btn.disabled = false;
        btn.innerHTML = btn.originalText || originalText || '<i class="bi bi-plus-circle mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á';
      }
    
      let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ';
    
      if (result.errors && Array.isArray(result.errors)) {
        errorMessage += result.errors.join(', ');
      } else if (result.message) {
        errorMessage += result.message;
      } else {
        errorMessage += 'Unknown error';
      }
    
      console.error('‚ùå Create receipt voucher error:', errorMessage);
      console.log('üîç Debug - Full result:', result);
    
      const alpineApp = document.querySelector('[x-data="app"]').__x;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating receipt voucher from receipt:', error);
    console.log('üîç Debug - btn variable:', btn);
    console.log('üîç Debug - btn type:', typeof btn);
    
    // ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ btn ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    if (btn && typeof btn === 'object' && btn.disabled !== undefined) {
      btn.disabled = false;
      btn.innerHTML = btn.originalText || originalText || '<i class="bi bi-plus-circle mr-1"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á';
    }
    
    const errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
window.createBatchReceiptVouchersFromReceipts = async () => {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    return;
  }

  try {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    }

    // ‡∏î‡∏∂‡∏á alpine instance ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• branch
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    }

    console.log('üì¶ Creating batch receipt vouchers with branch:', branchCode);

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
    const requestBody = {
      paymentMethod: 'cash',
      limit: 100,
      branch: branchCode,
      source: 'all' // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á
    };

    // ‚úÖ ‡πÉ‡∏ä‡πâ Auto Creation API endpoint ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    console.log('üîç Creating batch receipt vouchers via auto-creation API...');
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('üì• Response from batch create:', result);

    if (result.success) {
      // ‡∏õ‡∏¥‡∏î modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      const successCount = result.data?.successful?.length || result.data?.success || 0;
      const failedCount = result.data?.failed?.length || result.data?.failed || 0;
    
      let successMessage = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß`;
      if (successCount > 0) {
        successMessage = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        if (failedCount > 0) {
          successMessage += `, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
      } else if (result.data?.total) {
        successMessage = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${result.data.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞`;
      }
    
      if (alpineApp) {
        alpineApp.showNotification(successMessage, successCount > 0 ? 'success' : 'info');
        setTimeout(async () => {
          await alpineApp.loadReceipts();
          await alpineApp.updateDashboardStats();
        }, 2000);
      } else {
        window.showFallbackNotification(successMessage, 'success');
      }
    } else {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${result.message || 'Unknown error'}`;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating batch receipt vouchers:', error);
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-stack mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    }
    
    const errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏° global functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö button handlers (legacy)
window.createReceiptForItem = async (historyId) => {
  try {
    // ‡πÅ‡∏™‡∏î‡∏á loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';

    // ‡∏î‡∏∂‡∏á branch ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    }

    console.log('üìç Creating receipt with branch:', branchCode);
    console.log('üì¶ Creating from history ID:', historyId);

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let amount = 0;
    let customerName = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
    let invoiceNo = '';
    
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const rows = document.querySelectorAll('#pendingItemsModal tbody tr');
    for (const row of rows) {
      const button = row.querySelector(`button[onclick*="${historyId}"]`);
      if (button) {
        // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4 (index 3)
        const amountCell = row.cells[3];
        if (amountCell) {
          const amountText = amountCell.textContent.replace(/[^\d.-]/g, '');
          amount = parseFloat(amountText) || 0;
        }
    
        // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 3 (index 2)
        const customerCell = row.cells[2];
        if (customerCell) {
          customerName = customerCell.textContent.trim() || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
        }
    
        // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 1 (index 0)
        const invoiceCell = row.cells[0];
        if (invoiceCell) {
          invoiceNo = invoiceCell.textContent.trim() || '';
        }
    
        break;
      }
    }

    console.log('üí∞ Amount from table:', amount);
    console.log('üë§ Customer:', customerName);
    console.log('üìÑ Invoice No:', invoiceNo);

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
    if (amount <= 0) {
      amount = 100; // ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ default ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    }

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á request body ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const requestBody = {
      branchStockHistoryId: historyId,
      paymentMethod: 'cash',
    
      paymentDate: new Date().toISOString().split('T')[0],
      debitAccount: {
        code: '11101',
        name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'
      },
      creditAccount: {
        code: '41101',
        name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
      },
      receiptType: 'cash_sale',
      receivedFrom: customerName,
      details: [{
        description: `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤${invoiceNo ? ' - ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ' + invoiceNo : ''}`,
        amount: amount
      }],
      notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢${invoiceNo ? ' ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ' + invoiceNo : ''}`,
      totalAmount: amount // ‡πÄ‡∏û‡∏¥‡πà‡∏° totalAmount
    };

    console.log('üì§ Request body:', JSON.stringify(requestBody, null, 2));

    const response = await fetch('/api/receipt-vouchers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(requestBody)
    });

    const result = await response.json();
    console.log('üì• Response:', result);

    if (result.success) {
      // ‡∏õ‡∏¥‡∏î modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      if (alpineApp) {
        alpineApp.showNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
        await alpineApp.loadReceipts();
        await alpineApp.updateDashboardStats();
      } else {
        window.showFallbackNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
      }
    } else {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ';
    
      if (result.errors && Array.isArray(result.errors)) {
        errorMessage += result.errors.join(', ');
      } else if (result.message) {
        errorMessage += result.message;
      } else {
        errorMessage += 'Unknown error';
      }
    
      console.error('‚ùå Full error:', errorMessage);
    
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating receipt:', error);
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '‡∏™‡∏£‡πâ‡∏≤‡∏á';
    }
    
    const errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

window.createBatchFromPending = async () => {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    return;
  }

  try {
    // ‡πÅ‡∏™‡∏î‡∏á loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á branch ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å Alpine instance ‡∏´‡∏£‡∏∑‡∏≠ localStorage
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    let branchCode = alpineApp?.currentBranch || localStorage.getItem('branchId');
    
    // Validate branch ID format (MongoDB ObjectId = 24 hex characters)
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á branch ‡∏à‡∏≤‡∏Å user data
      const userResponse = await fetch('/api/users/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
      });
    
      if (userResponse.ok) {
        const userData = await userResponse.json();
        branchCode = userData.data?.branch?._id || userData.data?.branch || userData.data?.branchId;
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    if (!branchCode || !/^[0-9a-fA-F]{24}$/.test(branchCode)) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
    }

    console.log('üìç Creating batch with branch:', branchCode);

    // ‚úÖ ‡πÉ‡∏ä‡πâ Auto Creation API endpoint ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify({
        paymentMethod: 'cash',
        limit: 100,
        branchCode: branchCode // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà validate ‡πÅ‡∏•‡πâ‡∏ß
      })
    });

    if (!response.ok) {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorText = await response.text();
      throw new Error(`Auto creation API error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('üì• Auto creation response:', result);

    if (result.success) {
      // ‡∏õ‡∏¥‡∏î modal
      const modal = document.getElementById('pendingItemsModal');
      if (modal) modal.remove();

      const created = result.data?.summary?.successful || result.data?.created?.length || 0;
      const failed = result.data?.summary?.failed || result.data?.failed?.length || 0;
      const processed = result.data?.summary?.processed || 0;
    
      let successMessage = '';
      if (created > 0) {
        successMessage = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        if (failed > 0) {
          successMessage += `, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${failed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
        if (processed > 0) {
          successMessage += ` (‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        }
      } else if (processed > 0) {
        successMessage = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ${processed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á`;
      } else {
        successMessage = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô`;
      }
    
      if (alpineApp) {
        alpineApp.showNotification(successMessage, created > 0 ? 'success' : 'info');
        setTimeout(async () => {
          await alpineApp.loadReceipts();
          await alpineApp.updateDashboardStats();
        }, 2000);
      } else {
        window.showFallbackNotification(successMessage, 'success');
      }
    } else {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
      btn.disabled = false;
      btn.innerHTML = originalText;
    
      const errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${result.message || 'Unknown error'}`;
      if (alpineApp) {
        alpineApp.showNotification(errorMessage, 'error');
      } else {
        window.showFallbackNotification(errorMessage, 'error');
      }
    }
  } catch (error) {
    console.error('Error creating batch:', error);
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
    if (event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-stack mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    }
    
    const errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°: ${error.message}`;
    const alpineApp = document.querySelector('[x-data="app"]').__x;
    if (alpineApp) {
      alpineApp.showNotification(errorMessage, 'error');
    } else {
      window.showFallbackNotification(errorMessage, 'error');
    }
  }
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showFallbackNotification
window.showFallbackNotification = function(message, type = 'info') {
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };

  const notificationHtml = `
    <div id="fallbackNotification" class="fixed top-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight">
      <div class="flex items-center justify-between">
        <span>${message}</span>
        <button onclick="this.closest('#fallbackNotification').remove()" class="ml-4 text-white hover:text-gray-200">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  `;

  // Remove existing notification
  const existing = document.getElementById('fallbackNotification');
  if (existing) existing.remove();

  // Add new notification
  document.body.insertAdjacentHTML('beforeend', notificationHtml);

  // Auto remove after 3 seconds
  setTimeout(() => {
    const notification = document.getElementById('fallbackNotification');
    if (notification) {
      notification.classList.remove('animate__fadeInRight');
      notification.classList.add('animate__fadeOutRight');
      setTimeout(() => notification.remove(), 500);
    }
  }, type === 'error' ? 5000 : 3000);
};

// ‚úÖ Debug helpers for browser console - Updated to use same API as UI
window.checkAutoCreation = async () => {
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';
  console.log('üîç Checking auto creation using UI API for branch:', branchCode);

  // ‚úÖ ‡πÉ‡∏ä‡πâ API endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö UI
  const response = await fetch('/api/receipt-voucher/pending-receipts', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('authToken')}`
    }
  });

  if (response.ok) {
    const result = await response.json();
    console.log('üìä Auto Creation Status API Response:', result);
    
    if (result.success && result.data) {
      const pendingItems = result.data || [];
    
      // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≤‡∏° source
      const posPending = pendingItems.filter(item => item.source === 'pos' || item.source === 'cash_sale').length;
      const installmentPending = pendingItems.filter(item => item.source === 'installment' || item.source === 'installment_payment').length;
      const otherPending = pendingItems.filter(item => !['pos', 'cash_sale', 'installment', 'installment_payment'].includes(item.source)).length;
    
      console.log('üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', pendingItems.length);
      console.log('üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ POS ‡∏ó‡∏µ‡πà‡∏£‡∏≠:', posPending);
      console.log('üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠:', installmentPending);
      console.log('üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏£‡∏≠:', otherPending);
      console.log('üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:', 0); // TODO: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    
      if (pendingItems.length > 0) {
        console.table(pendingItems.slice(0, 10).map(item => ({
          id: item._id || item.id,
          type: item.source || item.type,
          amount: item.totalAmount || item.netAmount || item.amount,
          date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH'),
          customer: item.customerName || item.customer || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        })));
      }
    
      return {
        totalPending: pendingItems.length,
        pendingPosReceipts: posPending,
        pendingInstallmentReceipts: installmentPending,
        pendingOtherReceipts: otherPending,
        todayAutoCreated: 0,
        pendingItems: pendingItems,
        status: pendingItems.length > 0 ? 'pending' : 'up_to_date',
        lastCheck: new Date().toISOString(),
        branchCode: branchCode
      };
    }
    return null;
  } else {
    console.error('‚ùå API Error:', response.status, response.statusText);
    return null;
  }
};

// Test pending receipts API
window.checkPendingReceipts = async () => {
  console.log('üîç Checking pending receipts...');

  const response = await fetch('/api/receipt-voucher/pending-receipts', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('authToken')}`
    }
  });

  if (response.ok) {
    const result = await response.json();
    console.log('üìä Pending Receipts API Response:', result);
    
    if (result.success && result.data) {
      console.log('üìä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:', result.data.length);
    
      if (result.data.length > 0) {
        console.table(result.data.slice(0, 10).map(item => ({
          id: item._id,
          number: item.receiptNumber || item.documentNumber,
          amount: item.totalAmount || item.netAmount,
          customer: item.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
          source: item.source || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
          date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH')
        })));
      }
    }
    return result.data;
  } else {
    console.error('‚ùå Pending Receipts API Error:', response.status, response.statusText);
    return null;
  }
};

// Debug Alpine.js state
window.debugAlpineState = () => {
  const alpineApp = document.querySelector('[x-data="app"]')?.__x;
  if (alpineApp) {
    console.log('üéØ Alpine.js Summary State:');
    console.log('   - pendingReceiptCount:', alpineApp.summary.pendingReceiptCount);
    console.log('   - todayAutoCreatedCount:', alpineApp.summary.todayAutoCreatedCount);
    console.log('   - currentBranch:', alpineApp.currentBranch);
    console.log('   - lastStatsUpdate:', alpineApp.lastStatsUpdate ? new Date(alpineApp.lastStatsUpdate).toLocaleTimeString() : 'Never');
    return alpineApp.summary;
  } else {
    console.log('‚ùå Alpine.js app not found');
    return null;
  }
};

// üîß Compare both pending systems
window.comparePendingSystems = async () => {
  console.log('üîÑ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏ö‡∏ö pending items...');
  console.log('');

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á APIs
  const autoCreationData = await checkAutoCreation();
  const pendingReceiptsData = await checkPendingReceipts();
  const alpineData = debugAlpineState();

  console.log('üìä === ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏ö‡∏ö ===');
  console.log('');

  console.log('ü§ñ Auto Creation System:');
  console.log('   - API: /api/receipt-voucher/auto-creation-status');
  console.log('   - Total Pending:', autoCreationData?.totalPending || 0);
  console.log('   - POS Receipts:', autoCreationData?.pendingPosReceipts || 0);
  console.log('   - Installment Receipts:', autoCreationData?.pendingInstallmentReceipts || 0);
  console.log('   - Status:', autoCreationData?.status || 'unknown');
  console.log('');

  console.log('üë• UI Pending System:');
  console.log('   - API: /api/receipt-voucher/pending-receipts');
  console.log('   - Total Items:', pendingReceiptsData?.length || 0);
  console.log('');

  console.log('üéØ Alpine.js State:');
  console.log('   - UI Displayed Count:', alpineData?.pendingReceiptCount || 0);
  console.log('   - Today Auto Created:', alpineData?.todayAutoCreatedCount || 0);
  console.log('');

  const autoTotal = autoCreationData?.totalPending || 0;
  const apiTotal = pendingReceiptsData?.length || 0;
  const uiTotal = alpineData?.pendingReceiptCount || 0;

  if (autoTotal !== apiTotal || autoTotal !== uiTotal || apiTotal !== uiTotal) {
    console.log('‚ö†Ô∏è  ‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á!');
    console.log('   Auto Creation API ‡πÅ‡∏™‡∏î‡∏á:', autoTotal, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    console.log('   Pending Receipts API ‡πÅ‡∏™‡∏î‡∏á:', apiTotal, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    console.log('   UI ‡πÅ‡∏™‡∏î‡∏á:', uiTotal, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    console.log('');
    console.log('üîß ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:');
    console.log('   1. ‡πÉ‡∏ä‡πâ data source ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô');
    console.log('   2. API filter criteria ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô');
    console.log('   3. Branch code ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
    console.log('   4. Cache ‡∏´‡∏£‡∏∑‡∏≠ state ‡πÑ‡∏°‡πà sync ‡∏Å‡∏±‡∏ô');
  } else {
    console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
  }

  return {
    autoCreation: autoCreationData,
    pendingReceipts: pendingReceiptsData,
    alpineState: alpineData,
    totals: { autoTotal, apiTotal, uiTotal },
    isAllMatching: autoTotal === apiTotal && apiTotal === uiTotal
  };
};

// Test Sync API
window.testSyncAPI = async (receiptId = 'test123', amount = 1000) => {
  console.log('üß™ Testing Sync API...');

  const requestBody = {
    source: 'pos',
    sourceId: receiptId,
    documentNumber: `RV-TEST-${Date.now()}`,
    customerName: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
    totalAmount: amount,
    paymentMethod: 'cash',
    description: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
    notes: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
    metadata: {
      sourceReceiptNumber: 'TEST001',
      autoGenerated: false,
      createdBy: 'test_user'
    }
  };

  try {
    const response = await fetch('/api/receipt-vouchers/sync', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üìä Sync API Response Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('‚úÖ Sync API Success:', result);
      return result;
    } else {
      const errorText = await response.text();
      console.error('‚ùå Sync API Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('‚ùå Network Error:', error);
    return { error: error.message };
  }
};

// ‚úÖ Test Batch Creation API
window.testBatchCreation = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üì¶ Testing Batch Creation API...');

  const requestBody = {
    paymentMethod: 'cash',
    limit: 100,
    branchCode: branchCode
  };

  try {
    // Test both endpoints
    console.log('üß™ Testing /api/receipt-vouchers/batch...');
    let response = await fetch('/api/receipt-vouchers/batch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üìä Batch API Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('‚úÖ Batch API Success:', result);
      return result;
    } else {
      console.log('‚ùå Batch API failed, trying auto-create-from-receipts...');
    
      // Try alternative endpoint
      response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(requestBody)
      });
    
      console.log('üìä Auto Creation API Status:', response.status);
    
      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Auto Creation API Success:', result);
        return result;
      } else {
        const errorText = await response.text();
        console.error('‚ùå Both APIs failed:', errorText);
        return { error: errorText, status: response.status };
      }
    }
  } catch (error) {
    console.error('‚ùå Network Error:', error);
    return { error: error.message };
  }
};

// ‚úÖ Debug function ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API responses
window.debugReceiptVoucherAPIs = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üîç Testing Receipt Voucher APIs...');

  // Test auto-creation-status
  try {
    const statusResponse = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const statusData = await statusResponse.json();
    console.log('‚úÖ Auto Creation Status:', statusData);
  } catch (err) {
    console.log('‚ùå Auto Creation Status error:', err.message);
  }

  // Test pending-receipts
  try {
    const pendingResponse = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const pendingData = await pendingResponse.json();
    console.log('‚úÖ Pending Receipts:', pendingData);
  } catch (err) {
    console.log('‚ùå Pending Receipts error:', err.message);
  }

  // Test standard receipt voucher endpoint
  try {
    const voucherResponse = await fetch('/api/receipt-vouchers?limit=1', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const voucherData = await voucherResponse.json();
    console.log('‚úÖ Standard Receipt Vouchers:', voucherData);
  } catch (err) {
    console.log('‚ùå Standard Receipt Vouchers error:', err.message);
  }

  console.log('üèÅ API testing completed');
};

// ‚úÖ Test Trigger Auto Creation API
window.testTriggerAutoCreation = async (limit = 5) => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üöÄ Testing Trigger Auto Creation API...');

  const requestBody = {
    limit: limit,
    branchCode: branchCode
  };

  try {
    const response = await fetch('/api/receipt-voucher/trigger-auto-creation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üìä Trigger Auto Creation Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('‚úÖ Trigger Auto Creation Success:', result);
    
      if (result.data) {
        console.log(`üìà Summary: ${result.data.summary.successful} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ${result.data.summary.failed} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`);
    
        if (result.data.created.length > 0) {
          console.table(result.data.created.map(item => ({
            documentNumber: item.documentNumber,
            amount: item.amount,
            customer: item.customer,
            source: item.source
          })));
        }
    
        if (result.data.failed.length > 0) {
          console.log('‚ùå Failed items:');
          console.table(result.data.failed);
        }
      }
    
      return result;
    } else {
      const errorText = await response.text();
      console.error('‚ùå Trigger Auto Creation Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('‚ùå Network Error:', error);
    return { error: error.message };
  }
};

// ‚úÖ Test Auto Creation API
window.testAutoCreation = async (limit = 5) => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('ü§ñ Testing Auto Creation API...');

  const requestBody = {
    limit: limit,
    paymentMethod: 'cash',
    branchCode: branchCode
  };

  try {
    const response = await fetch('/api/receipt-vouchers/auto-create-from-receipts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üìä Auto Creation Response Status:', response.status);
    
    if (response.ok) {
      const result = await response.json();
      console.log('‚úÖ Auto Creation Success:', result);
    
      if (result.data) {
        console.log(`üìà Summary: ${result.data.summary.successful} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ${result.data.summary.failed} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`);
    
        if (result.data.created.length > 0) {
          console.table(result.data.created.map(item => ({
            documentNumber: item.documentNumber,
            amount: item.amount,
            customer: item.customer,
            source: item.source
          })));
        }
    
        if (result.data.failed.length > 0) {
          console.log('‚ùå Failed items:');
          console.table(result.data.failed);
        }
      }
    
      return result;
    } else {
      const errorText = await response.text();
      console.error('‚ùå Auto Creation Error:', response.status, errorText);
      return { error: errorText, status: response.status };
    }
  } catch (error) {
    console.error('‚ùå Network Error:', error);
    return { error: error.message };
  }
};

// ‚úÖ Debug function ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö API responses
window.compareReceiptAPIs = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üîç Comparing Receipt APIs...');
  console.log('üìç Using branchCode:', branchCode);

  const results = {};

  // 1. Test auto-creation-status API
  try {
    console.log('\n1Ô∏è‚É£ Testing auto-creation-status API...');
    const statusResponse = await fetch(`/api/receipt-voucher/auto-creation-status?branchCode=${branchCode}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (statusResponse.ok) {
      const statusData = await statusResponse.json();
      results.autoCreationStatus = statusData;
      console.log('‚úÖ Auto Creation Status Data:', statusData);
      console.log('üìä Total Pending (Status API):', statusData.data?.totalPending || 0);
    } else {
      console.error('‚ùå Auto Creation Status API failed:', statusResponse.status);
      results.autoCreationStatus = { error: statusResponse.status };
    }
  } catch (err) {
    console.error('‚ùå Auto Creation Status error:', err);
    results.autoCreationStatus = { error: err.message };
  }

  // 2. Test pending-receipts API
  try {
    console.log('\n2Ô∏è‚É£ Testing pending-receipts API...');
    const pendingResponse = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}&limit=50`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (pendingResponse.ok) {
      const pendingData = await pendingResponse.json();
      results.pendingReceipts = pendingData;
      console.log('‚úÖ Pending Receipts Data:', pendingData);
      console.log('üìä Total Pending (Receipts API):', pendingData.data?.length || 0);
    
      if (pendingData.data && pendingData.data.length > 0) {
        console.log('üìù Sample pending items:');
        console.table(pendingData.data.slice(0, 5).map(item => ({
          id: item._id,
          receiptNumber: item.receiptNumber,
          amount: item.totalAmount,
          customer: item.customerName,
          source: item.source
        })));
      }
    } else {
      console.error('‚ùå Pending Receipts API failed:', pendingResponse.status);
      results.pendingReceipts = { error: pendingResponse.status };
    }
  } catch (err) {
    console.error('‚ùå Pending Receipts error:', err);
    results.pendingReceipts = { error: err.message };
  }

  // 3. Test Alpine.js dashboard state
  try {
    console.log('\n3Ô∏è‚É£ Checking Alpine.js Dashboard State...');
    const alpineApp = document.querySelector('[x-data="app"]')?.__x;
    if (alpineApp) {
      console.log('‚úÖ Alpine Summary State:', alpineApp.summary);
      results.alpineState = alpineApp.summary;
    } else {
      console.log('‚ùå Alpine.js app not found');
      results.alpineState = { error: 'Alpine app not found' };
    }
  } catch (err) {
    console.error('‚ùå Alpine state error:', err);
    results.alpineState = { error: err.message };
  }

  // 4. Compare results
  console.log('\nüîç COMPARISON RESULTS:');
  console.log('='.repeat(50));

  const statusPending = results.autoCreationStatus?.data?.totalPending || 0;
  const receiptsPending = results.pendingReceipts?.data?.length || 0;
  const alpinePending = results.alpineState?.pendingReceiptCount || 0;

  console.log(`üìä Auto Creation Status API: ${statusPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  console.log(`üìä Pending Receipts API:     ${receiptsPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  console.log(`üìä Alpine Dashboard:         ${alpinePending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

  if (statusPending !== receiptsPending) {
    console.log('‚ö†Ô∏è  APIs ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô!');
    console.log('   - ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ query conditions ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô');
    console.log('   - ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ models ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô');
    console.log('   - ‡∏≠‡∏≤‡∏à‡∏°‡∏µ cache ‡∏´‡∏£‡∏∑‡∏≠ timing issues');
  }

  if (alpinePending !== receiptsPending) {
    console.log('‚ö†Ô∏è  Dashboard ‡πÑ‡∏°‡πà sync ‡∏Å‡∏±‡∏ö API!');
    console.log('   - ‡∏ï‡πâ‡∏≠‡∏á refresh dashboard data');
    console.log('   - ‡∏≠‡∏≤‡∏à‡∏°‡∏µ throttling issues');
  }

  // 5. Suggestions
  console.log('\nüí° SUGGESTIONS:');
  if (statusPending !== receiptsPending) {
    console.log('üîß Run: await refreshDashboard() ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }
  if (alpinePending === 0 && receiptsPending > 0) {
    console.log('üîß Run: await updateDashboardStats() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dashboard');
  }

  return results;
};

// ‚úÖ Test Modal API (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£")
window.testModalAPI = async () => {
  const token = localStorage.getItem('authToken');

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üîç Testing Modal API (exact same as button)...');

  // ‡πÉ‡∏ä‡πâ endpoints ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö modal ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
  const endpoints = [
    '/api/receipt-voucher/pending-receipts',
    '/api/receipt-vouchers/pending-receipts'
  ];

  let response = null;
  let foundEndpoint = null;

  for (const endpoint of endpoints) {
    try {
      console.log(`üîç ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å: ${endpoint}`);
      response = await fetch(endpoint, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.status !== 404) {
        foundEndpoint = endpoint;
        break;
      }
    } catch (err) {
      console.log(`‚ùå ${endpoint} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ`);
    }
  }

  if (!foundEndpoint || !response) {
    console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - API endpoints ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    return { error: 'No endpoint found' };
  }

  if (!response.ok) {
    const errorText = await response.text();
    console.error(`‚ùå API Error: ${response.status} - ${errorText}`);
    return { error: `${response.status} - ${errorText}` };
  }

  const result = await response.json();

  console.log('‚úÖ Modal API Response:', result);

  if (result.success) {
    const pendingReceipts = result.data || [];
    console.log(`üìä Modal API Found: ${pendingReceipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
    if (pendingReceipts.length > 0) {
      console.log('üìù Sample modal items:');
      console.table(pendingReceipts.slice(0, 10).map(item => ({
        id: item._id,
        receiptNumber: item.receiptNumber || item.documentNumber,
        amount: item.totalAmount || item.netAmount,
        customer: item.customerName,
        source: item.source,
        date: new Date(item.createdAt || item.saleDate).toLocaleDateString('th-TH')
      })));
    }
  } else {
    console.error('‚ùå API Success false:', result.message);
  }

  return result;
};

// ‚úÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö API ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ branchCode ‡∏Å‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ
window.compareBranchCodeEffect = async () => {
  const token = localStorage.getItem('authToken');
  const branchCode = localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || 'default';

  if (!token) {
    console.log('‚ùå No auth token found');
    return;
  }

  console.log('üîç Comparing API with and without branchCode...');
  console.log('üìç Current branchCode:', branchCode);

  const results = {};

  // 1. Test WITHOUT branchCode (like modal)
  try {
    console.log('\n1Ô∏è‚É£ Testing WITHOUT branchCode (like modal)...');
    const response1 = await fetch('/api/receipt-voucher/pending-receipts', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response1.ok) {
      const data1 = await response1.json();
      results.withoutBranchCode = data1;
      console.log('‚úÖ WITHOUT branchCode:', data1.data?.length || 0, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    } else {
      console.error('‚ùå WITHOUT branchCode failed:', response1.status);
      results.withoutBranchCode = { error: response1.status };
    }
  } catch (err) {
    console.error('‚ùå WITHOUT branchCode error:', err);
    results.withoutBranchCode = { error: err.message };
  }

  // 2. Test WITH branchCode (like debug function)
  try {
    console.log('\n2Ô∏è‚É£ Testing WITH branchCode (like debug function)...');
    const response2 = await fetch(`/api/receipt-voucher/pending-receipts?branchCode=${branchCode}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response2.ok) {
      const data2 = await response2.json();
      results.withBranchCode = data2;
      console.log('‚úÖ WITH branchCode:', data2.data?.length || 0, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    } else {
      console.error('‚ùå WITH branchCode failed:', response2.status);
      results.withBranchCode = { error: response2.status };
    }
  } catch (err) {
    console.error('‚ùå WITH branchCode error:', err);
    results.withBranchCode = { error: err.message };
  }

  // 3. Test with different branchCode
  try {
    console.log('\n3Ô∏è‚É£ Testing with different branchCode formats...');
    
    // Test with "default"
    const response3 = await fetch('/api/receipt-voucher/pending-receipts?branchCode=default', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response3.ok) {
      const data3 = await response3.json();
      results.withDefaultBranch = data3;
      console.log('‚úÖ WITH branchCode=default:', data3.data?.length || 0, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    }

    // Test with "all"
    const response4 = await fetch('/api/receipt-voucher/pending-receipts?branchCode=all', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response4.ok) {
      const data4 = await response4.json();
      results.withAllBranch = data4;
      console.log('‚úÖ WITH branchCode=all:', data4.data?.length || 0, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    }
  } catch (err) {
    console.error('‚ùå Different branchCode test error:', err);
  }

  // 4. Compare results
  console.log('\nüîç COMPARISON RESULTS:');
  console.log('='.repeat(60));

  const withoutBranch = results.withoutBranchCode?.data?.length || 0;
  const withBranch = results.withBranchCode?.data?.length || 0;
  const withDefault = results.withDefaultBranch?.data?.length || 0;
  const withAll = results.withAllBranch?.data?.length || 0;

  console.log(`üìä WITHOUT branchCode (modal):     ${withoutBranch} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  console.log(`üìä WITH branchCode (${branchCode}): ${withBranch} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  console.log(`üìä WITH branchCode=default:        ${withDefault} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  console.log(`üìä WITH branchCode=all:            ${withAll} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

  // Find which API gives the expected 13 results
  const results13 = [];
  if (withoutBranch === 13) results13.push('WITHOUT branchCode (modal)');
  if (withBranch === 13) results13.push('WITH current branchCode');
  if (withDefault === 13) results13.push('WITH branchCode=default');
  if (withAll === 13) results13.push('WITH branchCode=all');

  if (results13.length > 0) {
    console.log('\nüéØ APIs ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå 13 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:');
    results13.forEach(api => console.log(`   ‚úÖ ${api}`));
  } else {
    console.log('\n‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏°‡∏µ API ‡πÉ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå 13 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    console.log('   - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
    console.log('   - ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏°‡∏µ caching issues');
  }

  // Show sample data if found
  if (withoutBranch > 0 && results.withoutBranchCode.data) {
    console.log('\nüìù Sample data (WITHOUT branchCode):');
    console.table(results.withoutBranchCode.data.slice(0, 5).map(item => ({
      id: item._id,
      receiptNumber: item.receiptNumber,
      amount: item.totalAmount,
      source: item.source
    })));
  }

  return results;
};

// ‚úÖ Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö refresh dashboard
window.refreshDashboard = async () => {
  console.log('üîÑ Refreshing dashboard...');

  const alpineApp = document.querySelector('[x-data="app"]')?.__x;
  if (alpineApp) {
    try {
      // Force update stats (bypass throttling)
      alpineApp.lastStatsUpdate = 0;
    
      console.log('üìä Updating dashboard stats...');
      await alpineApp.updateDashboardStats();
    
      console.log('üìä Loading receipts...');
      await alpineApp.loadReceipts();
    
      console.log('‚úÖ Dashboard refreshed successfully');
    
      // Show current state
      console.log('üìä Current dashboard state:');
      console.log('   - pendingReceiptCount:', alpineApp.summary.pendingReceiptCount);
      console.log('   - todayAutoCreatedCount:', alpineApp.summary.todayAutoCreatedCount);
    
      return { success: true, data: alpineApp.summary };
    } catch (error) {
      console.error('‚ùå Error refreshing dashboard:', error);
      return { success: false, error: error.message };
    }
  } else {
    console.log('‚ùå Alpine.js app not found');
    return { success: false, error: 'Alpine app not found' };
  }
};

// ‚úÖ Quick function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ - Updated
window.quickCreateReceiptVouchers = async (limit = 10) => {
  console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');

  try {
    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    }

    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pending receipts ‡∏à‡∏≤‡∏Å API ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö UI
    console.log('1Ô∏è‚É£ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pending receipts...');
    const pendingResponse = await fetch('/api/receipt-voucher/pending-receipts', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!pendingResponse.ok) {
      throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pending receipts ‡πÑ‡∏î‡πâ: ${pendingResponse.status}`);
    }

    const pendingResult = await pendingResponse.json();
    if (!pendingResult.success || !pendingResult.data) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pending receipts');
    }

    const pendingReceipts = pendingResult.data.slice(0, limit);
    console.log(`üì¶ ‡∏û‡∏ö ${pendingReceipts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏à‡∏≤‡∏Å ${pendingResult.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`);

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ receipts ‡∏ó‡∏µ‡πà‡∏û‡∏ö
    console.log('üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ receipts ‡∏ó‡∏µ‡πà‡∏û‡∏ö:');
    pendingResult.data.forEach((receipt, index) => {
      console.log(`   ${index + 1}. ${receipt.receiptNumber} (${receipt._id}) - ‡∏ø${receipt.totalAmount}`);
    });

    if (pendingReceipts.length === 0) {
      console.log('‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á');
      return { success: true, message: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á', created: 0 };
    }

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á receipt vouchers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    console.log('2Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á receipt vouchers...');
    let created = 0;
    let errors = [];

    for (const receipt of pendingReceipts) {
      try {
        console.log(`üîÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á receipt voucher ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${receipt.receiptNumber || receipt._id}`);
    
        // ‚úÖ Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• receipt ‡∏ó‡∏µ‡πà‡∏°‡∏µ
        console.log('üìã Receipt object keys:', Object.keys(receipt));
        console.log('üìã Receipt data:', {
          _id: receipt._id,
          branchStockHistoryId: receipt.branchStockHistoryId,
          receiptNumber: receipt.receiptNumber,
          totalAmount: receipt.totalAmount,
          source: receipt.source
        });
    
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• receipt ‡πÄ‡∏õ‡πá‡∏ô format ‡∏ó‡∏µ‡πà API ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
        const totalAmount = receipt.totalAmount || receipt.netAmount || 0;
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
        if (totalAmount <= 0) {
          console.warn(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° receipt ${receipt.receiptNumber}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${totalAmount} ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
          errors.push(`${receipt.receiptNumber}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${totalAmount})`);
          continue;
        }

        // ‚úÖ ‡πÉ‡∏ä‡πâ format ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô submitForm() ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ + ‡πÄ‡∏û‡∏¥‡πà‡∏° totalAmount + branchStockHistoryId
        // ‚úÖ ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á documentNumber ‡πÉ‡∏´‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á duplicate key error
        const voucherData = {
          // documentNumber: `RV-AUTO-${Date.now()}-${created + 1}`, // ‚úÖ ‡πÉ‡∏´‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
          paymentDate: new Date().toISOString(),
          debitAccount: {
            code: '11101',  // ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
            name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'
          },
          creditAccount: {
            code: '41101',  // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
            name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'
          },
          receivedFrom: receipt.customerName || receipt.customer?.name || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
          receiptType: receipt.source || 'cash_sale',
          paymentMethod: receipt.paymentMethod || 'cash',
          totalAmount: totalAmount,  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° totalAmount ‡∏ó‡∏µ‡πà root level
          branchStockHistoryId: receipt._id,  // ‚úÖ ‡πÉ‡∏ä‡πâ _id ‡πÄ‡∏õ‡πá‡∏ô branchStockHistoryId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö branch_stock_history
          details: [
            {
              description: `‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${receipt.receiptNumber || receipt._id}`,
              amount: totalAmount
            }
          ],
          notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${receipt.receiptNumber || receipt._id}`,
          branch: localStorage.getItem('branchId') || localStorage.getItem('activeBranch') || '00000'
        };

        // ‚úÖ Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ API
        console.log('üì¶ Request data:', voucherData);
        console.log('üîç Amount check:', {
          totalAmount: totalAmount,
          detailsAmount: voucherData.details[0]?.amount,
          details: voucherData.details
        });
        console.log('üè¢ branchStockHistoryId:', voucherData.branchStockHistoryId);

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏™‡∏£‡πâ‡∏≤‡∏á receipt voucher
        console.log('üì§ Sending request to API...');
        const createResponse = await fetch('/api/receipt-voucher', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(voucherData)
        });

        console.log('üì• API Response status:', createResponse.status);
        console.log('üì• API Response headers:', Object.fromEntries(createResponse.headers.entries()));

        if (createResponse.ok) {
          const createResult = await createResponse.json();
          if (createResult.success) {
            created++;
            console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${createResult.data?.documentNumber || 'Unknown'}`);
          } else {
            console.error(`‚ùå API returned error for ${receipt.receiptNumber}:`, createResult);
            errors.push(`${receipt.receiptNumber}: ${createResult.message || 'Unknown error'} ${createResult.errors ? JSON.stringify(createResult.errors) : ''}`);
          }
        } else {
          const errorText = await createResponse.text();
          console.error(`‚ùå HTTP Error ${createResponse.status} for ${receipt.receiptNumber}:`, errorText);
    
          // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô duplicate key error ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (errorText.includes('E11000 duplicate key error') || errorText.includes('duplicate')) {
            console.log(`‚ö†Ô∏è Receipt ${receipt.receiptNumber} ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß - ‡∏Ç‡πâ‡∏≤‡∏°`);
            errors.push(`${receipt.receiptNumber}: Already processed (duplicate)`);
          } else {
            errors.push(`${receipt.receiptNumber}: HTTP ${createResponse.status} - ${errorText}`);
          }
        }

        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ server ‡πÄ‡∏Å‡∏¥‡∏î load ‡∏°‡∏≤‡∏Å
        await new Promise(resolve => setTimeout(resolve, 100));

      } catch (itemError) {
        console.error(`‚ùå Error creating voucher for ${receipt.receiptNumber}:`, itemError);
        errors.push(`${receipt.receiptNumber}: ${itemError.message}`);
      }
    }

    // 3. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    console.log(`üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á:`);
    console.log(`   ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${created} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    console.log(`   ‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

    if (errors.length > 0) {
      console.log('‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', errors);
    }

    // 4. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI
    const alpineApp = document.querySelector('[x-data="app"]')?.__x;
    if (alpineApp) {
      console.log('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI...');
      await alpineApp.loadReceipts();
      await alpineApp.checkAutoCreationStatus();
    }

    const result = {
      success: true,
      created: created,
      errors: errors.length,
      errorDetails: errors.length > 0 ? errors : undefined,
      message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${created} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${errors.length > 0 ? ` (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : ''}`
    };

    console.log('‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á receipt vouchers:', result);
    return result;

  } catch (error) {
    console.error('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', error);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (window.showFallbackNotification) {
      window.showFallbackNotification(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
    }
    
    return {
      success: false,
      error: error.message,
      created: 0
    };
  }
};

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô - ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•
window.testReceiptVoucherCreation = async () => {
  console.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô...');

  // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pending receipts
  console.log('\n1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...');
  const pendingResult = await window.checkPendingReceipts();

  if (pendingResult && pendingResult.data && pendingResult.data.length > 0) {
    console.log(`üìã ‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${pendingResult.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    
    // 2. ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
    console.log('\n2Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô...');
    const createResult = await window.quickCreateReceiptVouchers(Math.min(5, pendingResult.data.length));
    
    if (createResult && createResult.success) {
      console.log('üéâ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥');
    } else {
      console.log('‚ö†Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ');
    }
    
    return createResult;
  } else {
    console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß');
    return { message: 'No pending receipts found' };
  }
};

// Show/Hide Loading with Lottie animation
let lottieAnimation = null;
function showLoading(show) {
  const loader = document.getElementById('loadingOverlay');
  if (show) {
    loader.style.display = 'flex';
    loader.classList.remove('animate__fadeOut');
    loader.classList.add('animate__fadeIn');

    if (!lottieAnimation) {
      console.log('=üîÑ Loading Lottie animation from /Loading/Loading.json');
      fetch('/Loading/Loading.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(animationData => {
          lottieAnimation = lottie.loadAnimation({
            container: document.getElementById('lottieContainer'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            animationData: animationData
          });
          console.log('‚úÖ Lottie animation loaded successfully');
        })
        .catch(error => {
          console.error('‚ùå Error loading Lottie animation:', error);
          document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
        });
    } else {
      lottieAnimation.play();
    }
  } else {
    if (lottieAnimation) {
      lottieAnimation.pause();
    }
    loader.classList.remove('animate__fadeIn');
    loader.classList.add('animate__fadeOut');
    setTimeout(() => { loader.style.display = 'none'; }, 600);
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  showLoading(true);
  // existing code continues to run...
  setTimeout(() => showLoading(false), 800);
});

window.addEventListener('beforeunload', () => {
  if (lottieAnimation) {
    lottieAnimation.destroy();
    lottieAnimation = null;
  }
});
</script>

</body>
</html>