<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Inventory Dashboard (Tailwind + DaisyUI + Socket.IO) - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</title>

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="../js/activity-tracker.js"></script>
    <script src="/js/branch-navigation.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
    <!-- Content Security Policy (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) --><!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class','
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],'
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],'
        },
      }
    </script>
    <!-- DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Socket.IO (SRI) -->
    <script
      src="/socket.io.min.js"
      integrity="sha384-xWmNuOozkup5L7vb2ZFBg8dy0whlJd0gZAq3pvXuNa+5tSl/AjYqFNXN7kmjVTx2"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Icons (optional, ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö Tailwind) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

      <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

    <style>

      /* ‡∏ã‡πà‡∏≠‡∏ô input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Keyboard Wedge) */
      #barcodeInput {
        position: absolute;
        top: 0;
        left: 0;
        width: 1px;
        height: 1px;
        opacity: 0;
        border: none;
      }
      /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏¥‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI */
      .editable-imei {
        cursor: pointer;
      }
            .bubble h6 {
        font-size: 0.875rem;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
      }
      /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ brand ‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡πÅ‡∏ó‡∏ô supplier) */
      .brand-header button {
        font-weight: 700;
        font-size: 1rem;
      }
        /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

</head>

  <body class="flex flex-col min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800"
                     border-b border-gray-200 dark:border-gray-700
"
                     flex items-center justify-between ml-56 transition-all duration-300"
                     id="mainHeader">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">Inventory Dashboard</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
      </div>
    </header>
    
    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 p-6 overflow-y-auto transition-all duration-300 ml-56">
      <!-- Container -->
      <div class="max-w-5xl mx-auto">

      <h2 class="text-2xl font-bold mb-4">
        ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
      </h2>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <h5 class="text-base font-semibold mb-3 flex items-center">
          <i class="bi bi-building mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label
              for="branchSelect"
              class="block text-sm font-semibold mb-1 text-gray-600 dark:text-gray-200"
              >‡∏™‡∏≤‡∏Ç‡∏≤</label
            >
            <select
              id="branchSelect"
              class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"
            >
              <option value="">-- Loading --</option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              id="btnScanBarcode"
              class="btn btn-primary w-full"
            >
              <i class="bi bi-camera"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
            </button>
          </div>
        </div>
      </div>

      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å grouped by brand -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <h5 class="text-base font-semibold mb-3 flex items-center">
          <i class="bi bi-people mr-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å (Grouped by Brand)
        </h5>
        <div id="stockContainer"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400 py-4"
    >
      ¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.
    </footer>

    <!-- Hidden input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Keyboard Wedge) -->
    <input
      type="text"
      id="barcodeInput"
      autofocus
      lang="en"
      inputmode="latin"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
      style="ime-mode: disabled;"
    />

    <!-- Modal (DaisyUI) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô -->
    <!-- ‡πÉ‡∏ä‡πâ pattern ‡∏Ç‡∏≠‡∏á DaisyUI: modal + modal-box -->
    <input type="checkbox" id="barcodeModal" class="modal-toggle" />
    <div class="modal" id="barcodeModalWrapper">
      <div class="modal-box relative">
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal -->
        <label
          for="barcodeModal"
          class="btn btn-sm btn-circle absolute right-2 top-2"
        >‚úï</label>

        <h3 class="text-lg font-bold mb-3">
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô
        </h3>
        <div class="mb-3">
          <label for="scannedCodeModal" class="block text-sm font-semibold mb-1"
            >‡πÄ‡∏•‡∏Ç‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label
          >
          <input
            type="text"
            id="scannedCodeModal"
            readonly
            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"
          />
        </div>

        <div class="overflow-x-auto">
          <table class="table w-full border">
            <thead class="bg-gray-200 dark:bg-gray-700">
              <tr>
                <th class="p-2 border">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</th>
                <th class="p-2 border">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="p-2 border">Actions</th>
              </tr>
            </thead>
            <tbody id="scannedProductsTable"></tbody>
          </table>
        </div>

        <div class="modal-action">
          <label
            for="barcodeModal"
            class="btn"
            id="cancelManualEntry"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </label>
          <button class="btn btn-primary" id="confirmManualEntry">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>

    <!-- Socket.IO Connect Example (Optional) -->
    <script>
      const socket = io();
      socket.on('connect', () => {
        console.log('Socket.IO connected on inventory_dashboard page');
      });
      socket.on('disconnect', () => {
        console.warn('Socket.IO disconnected on inventory_dashboard page');
      });
    </script>

    <!-- JavaScript Logic (Tailwind + DaisyUI) -->
    <script>
      let lottieAnimation = null;
      let scannedProducts = [];
      
      // Show/Hide Loading Function (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô frontstore_index.html)
      function showLoading(show) {
        const loader = document.getElementById('loadingOverlay');
        if (show) {
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');
          
          // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
          if (!lottieAnimation) {
            console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
            fetch('/Loading/Loading.json')
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(animationData => {
                lottieAnimation = lottie.loadAnimation({
                  container: document.getElementById('lottieContainer'),
                  renderer: 'svg',
                  loop: true,
                  autoplay: true,
                  animationData: animationData
                });
                
                console.log('‚úÖ Lottie animation loaded successfully');
              })
              .catch(error => {
                console.error('‚ùå Error loading Lottie animation:', error);
                // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
              });
          } else {
            lottieAnimation.play();
          }
        } else {
          if (lottieAnimation) {
            lottieAnimation.pause();
          }
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');
          setTimeout(() => { loader.style.display = 'none'; }, 600);
        }
      }
      document.addEventListener("DOMContentLoaded", async () => {
      const pageLoaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...','
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
        const loaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...','
        showProgress: true,
        autoProgress: true
      });
        try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token
        const token = localStorage.getItem("authToken");
        if (!token) {
          alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ token");
          window.location.href = "../login.html";
          return;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        try {
          const res = await fetch("/api/users/me", {
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            throw new Error(data.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
          }
          const user = data.data;
          document.getElementById("loggedInUser").textContent = user.name
            ? `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${user.name}`
            : user.email
            ? `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${user.email}`
            : "Guest";

          const allowedPages = user.allowedPages || [];
          if (!allowedPages.includes("inventory")) {
            alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Inventory");
            window.location.href = "/login";
            return;
          }
        } catch (err) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
          window.location.href = "/login";
          return;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
        await loadBranches();

        // ‡∏õ‡∏∏‡πà‡∏° Logout
        document.getElementById("btnLogout").addEventListener("click", logout);

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ => ‡πÇ‡∏´‡∏•‡∏î stock
        document
          .getElementById("branchSelect")
          .addEventListener("change", loadStock);

        // ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î"
        document
          .getElementById("btnScanBarcode")
          .addEventListener("click", onScanBarcodeClick);

        // ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡πà‡∏≤‡∏ô keyboard wedge
        const barcodeInput = document.getElementById("barcodeInput");
        barcodeInput.focus();
        barcodeInput.addEventListener("keyup", (e) => {
          if (e.key === "Enter") {
            let code = e.target.value.trim();
            if (code) {
              console.log("üî∏ Barcode Received:", code);
              processBarcode(code);
            }
            e.target.value = "";
          }
        });

        // Modal: ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal
        document
          .getElementById("confirmManualEntry")
          .addEventListener("click", confirmScannedProducts);
        document
          .getElementById("cancelManualEntry")
          .addEventListener("click", cancelScannedProducts);

        // DaisyUI Modal ‡πÑ‡∏°‡πà‡∏°‡∏µ bootstrap.Modal.getInstance => ‡πÉ‡∏ä‡πâ input checkbox ‡πÅ‡∏ó‡∏ô
        } catch (error) {
          console.error('Initialization error:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤: ' + error.message);
        } finally {
          LoadingSystem.hide(loaderId);
        }
      });

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userEmail");
        window.location.href = "/login";
      }

      async function loadBranches() {
        try {
          const token = localStorage.getItem("authToken");
          const res = await fetch("/api/branch", {
            headers: { Authorization: "Bearer " + token },
          });
          const js = await res.json();
          if (!res.ok || !js.success) {
            throw new Error(js.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤");
          }

          const branchSelect = document.getElementById("branchSelect");
          branchSelect.innerHTML = "";
          const ptnBranches = js.data.filter((b) => b.branch_code === "00000");
          if (ptnBranches.length === 0) {
            branchSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ 00000</option>';
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ 00000");
            return;
          }
          // ‡πÉ‡∏™‡πà option
          ptnBranches.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b.branch_code;
            opt.textContent = `[${b.branch_code}] ${b.name}`;
            branchSelect.appendChild(opt);
          });
          // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ => disabled
          branchSelect.disabled = true;

          // ‡πÇ‡∏´‡∏•‡∏î stock ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          loadStock();
        } catch (err) {
          alert("Error loading branches: " + err.message);
        }
      }

      async function loadStock() {
        const branchId = document.getElementById("branchSelect").value;
        if (!branchId) return;
        try {
          const token = localStorage.getItem("authToken");
          const url = `/api/branch-stock?branch_code=${branchId}&include_unverified=1`;
          const res = await fetch(url, {
            headers: { Authorization: "Bearer " + token },
          });
          const json = await res.json();
          if (!res.ok || !json.success) {
            throw new Error(json.error || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å");
          }
          renderStocksGroupedByBrand(json.data);
        } catch (err) {
          alert("Error loading stock: " + err.message);
        }
      }

      function renderStocksGroupedByBrand(stocks) {
        const container = document.getElementById("stockContainer");
        container.innerHTML = "";

        // Group by brand
        const brandMap = {};
        stocks.forEach((st) => {
          const brandName = st.brand || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå";
          if (!brandMap[brandName]) {
            brandMap[brandName] = [];
          }
          brandMap[brandName].push(st);
        });

        // Render accordion (tailwind/daisyUI manual)
        Object.keys(brandMap).forEach((brandName) => {
          const brandArr = brandMap[brandName];

          // Brand Title
          const brandDiv = document.createElement("div");
          brandDiv.className = "mb-4";
          brandDiv.innerHTML = `
            <h6 class="text-lg font-bold mb-2">
              ${brandName} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${brandArr.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
            </h6>
          `;
          container.appendChild(brandDiv);

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
          const table = document.createElement("table");
          table.className = "table w-full border text-sm";
          table.innerHTML = `
            <thead class="bg-gray-200 dark:bg-gray-700">
              <tr>
                <th class="p-2 border">‡∏£‡∏π‡∏õ</th>
                <th class="p-2 border">‡∏£‡∏∏‡πà‡∏ô</th>
                <th class="p-2 border">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</th>
                <th class="p-2 border">‡∏™‡∏µ</th>
                <th class="p-2 border">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                <th class="p-2 border">IMEI</th>
                <th class="p-2 border">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          brandDiv.appendChild(table);
          const tbody = table.querySelector("tbody");

          brandArr.forEach((st) => {
            const imageUrl = st.image
              ? `/uploads/${st.image}`
              : "https://via.placeholder.com/100?text=No+Image";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="p-2 border">
                <img src="${imageUrl}" alt="${st.name || ""}" style="width:60px;" />
              </td>
              <td class="p-2 border">${st.model || "-"}</td>
              <td class="p-2 border">${st.price || 0}</td>
              <td class="p-2 border editable-imei" data-stock-id="${st._id}">
                ${st.imei || "-"}
              </td>
              <td class="p-2 border">
                <button class="btn btn-sm btn-error" onclick="removeStock('${"
                  st._id
"
                }')">'
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      }

      // Inline Editing IMEI
      document.addEventListener("click", (e) => {
        if (e.target && e.target.classList.contains("editable-imei")) {
          const cell = e.target;
          if (cell.querySelector("input")) return;
          const stockId = cell.getAttribute("data-stock-id");
          const currentIMEI =
            cell.textContent.trim() === "-" ? "" : cell.textContent.trim();
          enableIMEIEditing(cell, stockId, currentIMEI);
        }
      });

      async function enableIMEIEditing(cell, stockId, currentIMEI) {
        const input = document.createElement("input");
        input.type = "text";
        input.className = "input input-sm input-bordered w-24";
        input.value = currentIMEI;

        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-success ml-2";
        btn.textContent = "OK";

        cell.innerHTML = "";
        cell.appendChild(input);
        cell.appendChild(btn);

        btn.addEventListener("click", async () => {
          const newIMEI = input.value.trim();
          if (newIMEI === currentIMEI) {
            cell.textContent = currentIMEI || "-";
            return;
          }
          const token = localStorage.getItem("authToken");
          try {
            const res = await fetch(`/api/branch-stock/${stockId}`, {
              method: "PATCH",
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ imei: newIMEI }),
            });
            const json = await res.json();
            if (!res.ok || !json.success) {
              alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (json.error || "Error"));
              cell.textContent = currentIMEI || "-";
            } else {
              alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
              cell.textContent = newIMEI || "-";
            }
          } catch (err) {
            alert("Error updating IMEI: " + err.message);
            cell.textContent = currentIMEI || "-";
          }
        });
      }

      function onScanBarcodeClick() {
        const branchId = document.getElementById("branchSelect").value;
        if (!branchId) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
          return;
        }
        document.getElementById("barcodeInput").focus();
      }

      async function processBarcode(code) {
        console.log("üî∏ processBarcode =>", code);
        document.getElementById("scannedCodeModal").value = code;

        const branchId = document.getElementById("branchSelect").value;
        if (!branchId) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
          document.getElementById("barcodeInput").focus();
          return;
        }
        const token = localStorage.getItem("authToken");
        try {
          const res = await fetch(
            `/api/product/find-by-barcode?code=${encodeURIComponent(code)}`,
            {
              headers: { Authorization: "Bearer " + token },
            }
          );
          const findData = await res.json();
          let product = null;
          if (!res.ok || !findData.success || !findData.data || !findData.data._id) {
            if (
              confirm(
                `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î "${code}"\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
              )
            ) {
              product = null;
            } else {
              document.getElementById("barcodeInput").focus();
              return;
            }
          } else {
            product = findData.data;
          }
          addScannedProductRow(code, product);

          // ‡πÄ‡∏õ‡∏¥‡∏î modal DaisyUI => checkbox checked
          document.getElementById("barcodeModal").checked = true;
        } catch (err) {
          alert("Error scanning barcode: " + err.message);
        }
        document.getElementById("barcodeInput").focus();
      }

      function addScannedProductRow(code, product) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ SKU ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
        if (product && product.sku) {
          const isDuplicateSKU = scannedProducts.some(
            (item) => item.product && item.product.sku === product.sku
          );
          if (isDuplicateSKU) {
            alert(
              `SKU "${product.sku}" ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô SKU ‡∏ô‡∏µ‡πâ‡∏ã‡πâ‡∏≥`
            );
            return;
          }
        }
        const id = Date.now();
        scannedProducts.push({ id, code, product });
        updateScannedProductsTable();
      }

      function updateScannedProductsTable() {
        const tbody = document.getElementById("scannedProductsTable");
        tbody.innerHTML = "";
        scannedProducts.forEach((item) => {
          const tr = document.createElement("tr");
          const details = item.product
            ? `SKU: ${item.product.sku}, ‡∏ä‡∏∑‡πà‡∏≠: ${item.product.name}`
            : `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Manual entry)`;
          tr.innerHTML = `
            <td class="p-2 border">${item.code}</td>
            <td class="p-2 border">${details}</td>
            <td class="p-2 border">
              <button class="btn btn-sm btn-outline btn-error" onclick="deleteScannedProduct(${item.id})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function deleteScannedProduct(id) {
        scannedProducts = scannedProducts.filter((item) => item.id !== id);
        updateScannedProductsTable();
      }

      async function confirmScannedProducts() {
        if (scannedProducts.length === 0) {
          alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤");
          document.getElementById("barcodeInput").focus();
          return;
        }
        const token = localStorage.getItem("authToken");
        const branchId = document.getElementById("branchSelect").value;
        if (!branchId) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
          document.getElementById("barcodeInput").focus();
          return;
        }
        for (const item of scannedProducts) {
          let product = item.product;
          if (!product) {
            alert(
              `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ${item.code} ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Manual entry not implemented)`
            );
            continue;
          }
          if (!product.imei || product.imei === "-") {
            const newIMEI = prompt(
              "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç IMEI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ " + product.sku
            );
            if (newIMEI) {
              try {
                const res = await fetch(`/api/branch-stock/${product._id}`, {
                  method: "PATCH",
                  headers: {
                    Authorization: "Bearer " + token,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ imei: newIMEI }),
                });
                const json = await res.json();
                if (!res.ok || !json.success) {
                  alert(
                    "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (json.error || "Error")
                  );
                  continue;
                } else {
                  product.imei = newIMEI;
                  alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                }
              } catch (err) {
                alert("Error updating IMEI: " + err.message);
                continue;
              }
            }
          }
          // ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å
          try {
            const transferRes = await fetch(
              `/api/product/${product._id}/transfer`,
              {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ branch_code: branchId }),
              }
            );
            const transferData = await transferRes.json();
            if (!transferRes.ok || !transferData.success) {
              alert(
                `‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${product.sku} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${
                  transferData.error || "Error"
                }`
              );
              continue;
            }
            console.log(
              `‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${product.sku} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> branchStock ‡∏™‡∏≤‡∏Ç‡∏≤ ${branchId}`
            );
          } catch (err) {
            alert(`Error transferring product ${item.code}: ${err.message}`);
          }
        }
        alert("‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        scannedProducts = [];
        updateScannedProductsTable();

        // ‡∏õ‡∏¥‡∏î modal => daisyUI => checkbox = false
        document.getElementById("barcodeModal").checked = false;
        document.getElementById("barcodeInput").focus();
        loadStock();
      }

      function cancelScannedProducts() {
        if (confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
          scannedProducts = [];
          updateScannedProductsTable();
          document.getElementById("barcodeModal").checked = false;
        }
        document.getElementById("barcodeInput").focus();
      }

      async function removeStock(stockId, showAlert = true) {
        try {
          const token = localStorage.getItem("authToken");
          const res = await fetch(`/api/branch-stock/${stockId}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            throw new Error(data.error || "‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          }
          if (showAlert) alert("‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
          // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
          loadStock();
        } catch (err) {
          if (showAlert) alert("Error removing stock: " + err.message);
          else throw err;
        }
      }
    
}</script>
    </main>
    
    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ -->
    <script>
      // Get branch code from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');
      
      if (!BRANCH_CODE) {
        console.warn("Branch code not specified, defaulting to 'PATTANI'");
        BRANCH_CODE = 'PATTANI';
      }
      window.currentBranchCode = BRANCH_CODE;
      console.log(`[inventory_dashboard] Using branch code: ${BRANCH_CODE}`);
      
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
      async function loadBranchInfo() {
        try {
          const branchCode = BRANCH_CODE;
          const token = localStorage.getItem("authToken") || "";
          
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
          const res = await fetch(`/api/branch`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const js = await res.json();
          if (res.ok && js.success) {
            // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö branch_code
            const branch = js.data.find(b => b.branch_code === branchCode);
            if (branch) {
              document.getElementById("branchInfo").textContent =
                `${branch.name} ‚Äî ${branch.address}`;
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
              document.title = `Inventory Dashboard - ${branch.name}`;
              document.getElementById("pageTitle").textContent = `Inventory Dashboard - ${branch.name}`;
              return;
            }
          }
          throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤");
        } catch (err) {
          console.warn("loadBranchInfo error:", err);
          document.getElementById("branchInfo").textContent =
            "‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)";
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ loadBranchInfo ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      document.addEventListener('DOMContentLoaded', function() {'
      const pageLoaderId = LoadingSystem.show({
        message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...','
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
        loadBranchInfo();
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏à‡∏≤‡∏Å URL parameter
        const branchName = urlParams.get('name');
        if (branchName) {
          document.title = `Inventory Dashboard - ${decodeURIComponent(branchName)}`;
        }
      });
    
}</script>
  </body>
</html>
