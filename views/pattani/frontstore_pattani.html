<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>POS System</title>

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Old LoadingSystem v2.0.0 CSS removed - using new Lottie loading -->


  <!-- Error Boundaries and Network Error Handling -->
  <script>
    // ========== ERROR BOUNDARIES & NETWORK ERROR HANDLING ==========
    (function(window) {
      'use strict';

      console.log('üõ°Ô∏è Error Boundaries & Network Error Handling initializing...');

      // Global Error Boundaries
      window.addEventListener('unhandledrejection', function(event) {
        console.error('üö® Unhandled Promise Rejection:', event.reason);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (typeof showToast === 'function') {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }

        // Log error to backend if available
        if (window.auditLogger && typeof window.auditLogger.logEvent === 'function') {
          window.auditLogger.logEvent('ERROR', 'UNHANDLED_REJECTION', {
            reason: event.reason?.toString() || 'Unknown error',
            stack: event.reason?.stack || 'No stack trace'
          });
        }

        // Prevent default browser handling
        event.preventDefault();
      });

      window.addEventListener('error', function(event) {
        console.error('üö® Global Error:', event.error);

        if (typeof showToast === 'function') {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }

        // Log error to backend if available
        if (window.auditLogger && typeof window.auditLogger.logEvent === 'function') {
          window.auditLogger.logEvent('ERROR', 'GLOBAL_ERROR', {
            message: event.message || 'Unknown error',
            filename: event.filename || 'Unknown file',
            lineno: event.lineno || 0,
            colno: event.colno || 0,
            stack: event.error?.stack || 'No stack trace'
          });
        }
      });

      // Event Listener Management System to prevent memory leaks
      const eventListenerRegistry = {
        listeners: new Map(),
        timers: new Set(),
        observers: new Set(),

        /**
         * Add event listener with automatic cleanup tracking
         */
        add(element, event, handler, options = {}) {
          if (!element || typeof handler !== 'function') return;

          element.addEventListener(event, handler, options);

          const key = `${element.constructor.name}-${event}-${handler.name || 'anonymous'}`;
          if (!this.listeners.has(key)) {
            this.listeners.set(key, new Set());
          }
          this.listeners.get(key).add({ element, event, handler, options });

          return () => this.remove(element, event, handler);
        },

        /**
         * Remove specific event listener
         */
        remove(element, event, handler) {
          if (!element || !handler) return;

          element.removeEventListener(event, handler);

          const key = `${element.constructor.name}-${event}-${handler.name || 'anonymous'}`;
          const listeners = this.listeners.get(key);
          if (listeners) {
            for (const listener of listeners) {
              if (listener.element === element && listener.handler === handler) {
                listeners.delete(listener);
                break;
              }
            }
            if (listeners.size === 0) {
              this.listeners.delete(key);
            }
          }
        },

        /**
         * Track timers for automatic cleanup
         */
        addTimer(timerId) {
          this.timers.add(timerId);
          return timerId;
        },

        /**
         * Track observers for automatic cleanup
         */
        addObserver(observer) {
          this.observers.add(observer);
          return observer;
        },

        /**
         * Cleanup all tracked resources
         */
        cleanup() {
          console.log('üßπ Cleaning up event listeners and resources...');

          // Remove all event listeners
          for (const [key, listeners] of this.listeners.entries()) {
            for (const { element, event, handler } of listeners) {
              try {
                element.removeEventListener(event, handler);
              } catch (e) {
                console.warn(`Failed to remove listener for ${key}:`, e);
              }
            }
          }
          this.listeners.clear();

          // Clear all timers
          for (const timerId of this.timers) {
            try {
              clearTimeout(timerId);
              clearInterval(timerId);
            } catch (e) {
              console.warn('Failed to clear timer:', e);
            }
          }
          this.timers.clear();

          // Disconnect all observers
          for (const observer of this.observers) {
            try {
              if (observer.disconnect) observer.disconnect();
              if (observer.unobserve) observer.unobserve();
            } catch (e) {
              console.warn('Failed to disconnect observer:', e);
            }
          }
          this.observers.clear();
        }
      };

      // Auto cleanup on page unload
      window.addEventListener('beforeunload', () => {
        eventListenerRegistry.cleanup();
      });

      // Enhanced timer and animation management
      window.safeFunctions = {
        /**
         * Safe setTimeout with automatic cleanup tracking
         */
        setTimeout: (callback, delay, ...args) => {
          const timerId = setTimeout(() => {
            eventListenerRegistry.timers.delete(timerId);
            callback(...args);
          }, delay);
          return eventListenerRegistry.addTimer(timerId);
        },

        /**
         * Safe setInterval with automatic cleanup tracking
         */
        setInterval: (callback, interval, ...args) => {
          const timerId = setInterval(callback, interval, ...args);
          return eventListenerRegistry.addTimer(timerId);
        },

        /**
         * Safe requestAnimationFrame with automatic cleanup tracking
         */
        requestAnimationFrame: (callback) => {
          const animationId = requestAnimationFrame((timestamp) => {
            eventListenerRegistry.timers.delete(animationId);
            callback(timestamp);
          });
          return eventListenerRegistry.addTimer(animationId);
        },

        /**
         * Clear timer and remove from registry
         */
        clearTimer: (timerId) => {
          clearTimeout(timerId);
          clearInterval(timerId);
          cancelAnimationFrame(timerId);
          eventListenerRegistry.timers.delete(timerId);
        },

        /**
         * Add event listener with automatic cleanup
         */
        addEventListener: (element, event, handler, options) => {
          return eventListenerRegistry.add(element, event, handler, options);
        }
      };

      // API Response Cache System
      const apiCache = new Map();
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
      const MAX_CACHE_SIZE = 100;

      function getCacheKey(url, options = {}) {
        const method = options.method || 'GET';
        const body = options.body || '';
        return `${method}:${url}:${typeof body === 'string' ? body : JSON.stringify(body)}`;
      }

      function getCachedResponse(key) {
        const cached = apiCache.get(key);
        if (!cached) return null;

        const now = Date.now();
        if (now - cached.timestamp > CACHE_DURATION) {
          apiCache.delete(key);
          return null;
        }

        return cached.data;
      }

      function setCachedResponse(key, data) {
        // Implement LRU cache
        if (apiCache.size >= MAX_CACHE_SIZE) {
          const firstKey = apiCache.keys().next().value;
          apiCache.delete(firstKey);
        }

        apiCache.set(key, {
          data: data,
          timestamp: Date.now()
        });
      }

      // Circuit Breaker State Management
      const circuitBreakerState = {
        failures: 0,
        maxFailures: 5,
        timeout: 60000, // 1 minute
        lastFailureTime: null,
        state: 'CLOSED' // CLOSED, OPEN, HALF_OPEN
      };

      function shouldBypassCircuitBreaker() {
        if (circuitBreakerState.state === 'CLOSED') return true;
        if (circuitBreakerState.state === 'OPEN') {
          const timeSinceLastFailure = Date.now() - circuitBreakerState.lastFailureTime;
          if (timeSinceLastFailure > circuitBreakerState.timeout) {
            circuitBreakerState.state = 'HALF_OPEN';
            return true;
          }
          return false;
        }
        if (circuitBreakerState.state === 'HALF_OPEN') return true;
        return false;
      }

      function recordCircuitBreakerSuccess() {
        circuitBreakerState.failures = 0;
        circuitBreakerState.state = 'CLOSED';
        circuitBreakerState.lastFailureTime = null;
      }

      function recordCircuitBreakerFailure() {
        circuitBreakerState.failures++;
        circuitBreakerState.lastFailureTime = Date.now();

        if (circuitBreakerState.failures >= circuitBreakerState.maxFailures) {
          circuitBreakerState.state = 'OPEN';
          console.warn(`üö® Circuit breaker OPEN - too many failures (${circuitBreakerState.failures})`);
        }
      }

      // Safe Fetch with Error Handling and Retry
      async function safeFetch(url, options = {}) {
        const maxRetries = options.maxRetries || 3;
        const timeout = options.timeout || 30000; // 30 seconds default
        const useCache = options.useCache !== false;
        const bypassCircuitBreaker = options.bypassCircuitBreaker || false;
        let lastError;

        // Check circuit breaker
        if (!bypassCircuitBreaker && !shouldBypassCircuitBreaker()) {
          const error = new Error('Circuit breaker is OPEN - service temporarily unavailable');
          error.name = 'CircuitBreakerError';
          if (typeof showToast === 'function') {
            showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
          }
          throw error;
        }

        // Check cache first (for GET requests)
        if (useCache && (!options.method || options.method === 'GET')) {
          const cacheKey = getCacheKey(url, options);
          const cached = getCachedResponse(cacheKey);
          if (cached) {
            console.log('üìã Using cached response for:', url);
            return cached;
          }
        }

        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`üåê Network request attempt ${attempt}/${maxRetries}: ${url}`);

            // Create AbortController for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const fetchOptions = {
              ...options,
              signal: controller.signal
            };

            const response = await fetch(url, fetchOptions);
            clearTimeout(timeoutId);

            if (!response.ok) {
              const errorText = await response.text().catch(() => 'No response text');
              throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();

            // Cache successful GET responses
            if (useCache && (!options.method || options.method === 'GET')) {
              const cacheKey = getCacheKey(url, options);
              setCachedResponse(cacheKey, data);
            }

            console.log(`‚úÖ Network request successful: ${url}`);
            recordCircuitBreakerSuccess();
            return data;

          } catch (error) {
            lastError = error;
            console.error(`‚ùå Network request failed (attempt ${attempt}/${maxRetries}):`, error);

            // Don't retry on certain error types
            if (error.name === 'AbortError') {
              console.error('üïê Request timeout:', url);
              break;
            }

            if (error.message.includes('400') || error.message.includes('401') || error.message.includes('403')) {
              console.error('üö´ Client error - not retrying:', error.message);
              break;
            }

            // Wait before retry (exponential backoff)
            if (attempt < maxRetries) {
              const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
              console.log(`‚è≥ Waiting ${delay}ms before retry...`);
              await new Promise(resolve => setTimeout(resolve, delay));
            }
          }
        }

        // All retries failed
        console.error('üí• All network retries failed for:', url, lastError);
        recordCircuitBreakerFailure();

        // Show user-friendly error message
        if (typeof showToast === 'function') {
          if (lastError.name === 'AbortError') {
            showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
          } else if (lastError.message.includes('Failed to fetch')) {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          }
        }

        throw lastError;
      }

      // Input Validation Functions
      function validateCheckoutData(checkoutData) {
        const errors = [];

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (!checkoutData) {
          errors.push('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          return { isValid: false, errors };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (!checkoutData.items || !Array.isArray(checkoutData.items) || checkoutData.items.length === 0) {
          errors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
        } else {
          checkoutData.items.forEach((item, index) => {
            if (!item.id) {
              errors.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`);
            }
            if (!item.qty || item.qty <= 0) {
              errors.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
            }
            if (!item.price || item.price < 0) {
              errors.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
            }
          });
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        if (typeof checkoutData.totalAmount !== 'number' || checkoutData.totalAmount < 0) {
          errors.push('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        if (!checkoutData.paymentMethod) {
          errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)
        if (checkoutData.customer) {
          if (checkoutData.customer.email && !isValidEmail(checkoutData.customer.email)) {
            errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          }
          if (checkoutData.customer.phone && !isValidPhoneNumber(checkoutData.customer.phone)) {
            errors.push('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          }
        }

        return {
          isValid: errors.length === 0,
          errors: errors
        };
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function isValidPhoneNumber(phone) {
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏ó‡∏¢
        const phoneRegex = /^(\+66|66|0)?[0-9]{8,9}$/;
        return phoneRegex.test(phone.replace(/[-\s]/g, ''));
      }

      function sanitizeInput(input) {
        if (typeof input !== 'string') return input;

        // Remove potentially dangerous characters
        return input
          .replace(/[<>\"']/g, '')
          .trim()
          .substring(0, 1000); // Limit length
      }

      // Connection Status Monitoring
      let connectionStatus = {
        online: navigator.onLine,
        lastCheck: Date.now(),
        retryCount: 0
      };

      function updateConnectionStatus() {
        const wasOnline = connectionStatus.online;
        connectionStatus.online = navigator.onLine;
        connectionStatus.lastCheck = Date.now();

        if (wasOnline !== connectionStatus.online) {
          console.log('üåê Connection status changed:', connectionStatus.online ? 'Online' : 'Offline');

          if (typeof showToast === 'function') {
            if (connectionStatus.online) {
              showToast('‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
              connectionStatus.retryCount = 0;
            } else {
              showToast('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', 'warning');
            }
          }

          // Emit custom event for other parts of the app
          window.dispatchEvent(new CustomEvent('connectionchange', {
            detail: { online: connectionStatus.online }
          }));
        }
      }

      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);

      // Export functions to global scope
      window.safeFetch = safeFetch;
      window.validateCheckoutData = validateCheckoutData;
      window.sanitizeInput = sanitizeInput;
      window.connectionStatus = connectionStatus;

      console.log('‚úÖ Error Boundaries & Network Error Handling initialized successfully');

    })(window);
  </script>

  <script>
    // New Lottie Loading State with State Management (same as addNewProduct_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <script src="/js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <!-- Security & Audit Enhancement -->
  <script src="/js/security-manager.js"></script>
  <script src="/js/audit-logger.js"></script>
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <!-- TODO: ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î production ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏ó‡∏µ‡πà build ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô CDN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ -->
  <script src="https://cdn.tailwindcss.com"></script>


  <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(...args) {
      const message = args[0];
      if (message && typeof message === 'string') {
        // Suppress Tailwind CDN warnings
        if (message.includes('cdn.tailwindcss.com should not be used in production') ||
            message.includes('tailwindcss.com') ||
            message.includes('Tailwind CSS')) {
          return; // Suppress these warnings
        }
      }
      originalWarn.apply(console, args);
    };

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />

  <!-- Modular Notification System -->
  <link rel="stylesheet" href="/css/notification-modules.css">
  <script src="/js/notification-modules.js"></script>

  <!-- Socket.IO with SRI -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- ‚úÖ Multi-IP Card Reader Configuration -->
  <script src="/js/card-reader-config.js?v=1755165000"></script>
  <script src="/js/card-reader-service.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-color: #0d6efd;
      --primary-hover: #138af2;
      --bg-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
    }

    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: "Prompt", sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }



    .bubble {
      width: 110px;
      height: 130px;
      border-radius: 0.75rem;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background-color: var(--primary-color);
      position: relative;
    }

    .bubble:hover {
      background-color: var(--primary-hover);
    }

    .bubble h6 {
      font-size: 0.875rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }

    .stock-count {
      position: absolute;
      bottom: 0.5rem;
      font-size: 0.75rem;
    }

    /* ===== ULTRA MINIMAL CARD STYLES ===== */
    .card {
      background: #ffffff !important;
      border: 1px solid #f1f5f9 !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      margin-bottom: 0.75rem !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      color: #374151 !important;
    }

    .card:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      border-color: #e2e8f0 !important;
    }

    /* Dark mode card styles */
    .dark .card {
      background: #1f2937 !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
    }

    .dark .card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      border-color: #4b5563 !important;
    }

    /* Card text alignment */
    .card h6,
    .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }

    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }

    .dark .card p {
      color: #9ca3af !important;
    }

    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }

    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }

    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }

    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }

    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }

    .card:hover .status-icon {
      opacity: 1 !important;
    }

    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }

    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }

    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }

    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }

    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }

    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }

    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }

    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }

    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }

    .dark .warning-text {
      color: #fbbf24 !important;
    }

    .dark .emergency-text {
      color: #f87171 !important;
    }

    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }

    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .lightOnly {
      display: block;
    }

    .darkOnly {
      display: none;
    }

    .dark .lightOnly {
      display: none !important;
    }

    .dark .darkOnly {
      display: block !important;
    }

    .dark .dark-bg {
      background-color: var(--bg-color);
    }

    .dark .dark-text {
      color: var(--primary-color);
    }

    /* ===== Flip Card ===== */
    .flip-card {
      perspective: 1000px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 0.75rem;
      width: 200px;
      height: 420px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      padding: 0.5rem;
    }

    .flip-card-back {
      transform: rotateY(180deg);
      background-color: var(--bg-color);
    }

    .product-price-big {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    html,
    body {
      overflow-x: hidden;
    }

    #mainContent {
      overflow-y: auto;
    }

    /* ‡πÅ‡∏Å‡πâ card ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô */
    .card {
      max-height: none !important;
      overflow-y: visible !important;
    }

    .product-img {
      width: 200px;
      height: 200px;
      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* Stock type badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 0.375rem;
      line-height: 1;
    }

    .badge-info {
      background-color: #3b82f6;
      color: white;
    }

    .badge-success {
      background-color: #10b981;
      color: white;
    }

    .badge-primary {
      background-color: #8b5cf6;
      color: white;
    }

    .badge-sm {
      padding: 0.125rem 0.375rem;
      font-size: 0.6875rem;
    }

    /* Dark mode support for badges */
    .dark .badge-info {
      background-color: #2563eb;
    }

    .dark .badge-success {
      background-color: #059669;
    }

    .dark .badge-primary {
      background-color: #7c3aed;
    }

    /* Disabled button styles */
    .btn-disabled {
      background-color: #d1d5db !important;
      color: #6b7280 !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
      border: 1px solid #d1d5db !important;
    }

    .btn-disabled:hover {
      background-color: #d1d5db !important;
      color: #6b7280 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    .dark .btn-disabled {
      background-color: #4b5563 !important;
      color: #9ca3af !important;
      border: 1px solid #4b5563 !important;
    }

    .dark .btn-disabled:hover {
      background-color: #4b5563 !important;
      color: #9ca3af !important;
    }

    /* ===== OLD STYLES REMOVED - NOW USING MINIMAL DESIGN ===== */
    .product-name {
      position: absolute;
      top: 48%;
      left: 0.5rem;
      /* ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ left: 50%; transform: translateX(-50%) ‡∏Å‡πá‡πÑ‡∏î‡πâ */
      font-weight: 800;
    }

    h6 {
      white-space: normal;
      /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
      word-wrap: break-word;
      /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
      overflow: visible;
      /* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏ô‡∏µ‡πâ */
    .section-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 1.125rem;
    }

    .cart-table {
      border-collapse: collapse;
    }

    .cart-table th,
    .cart-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
    }



    /* Promotion styles */
    .promotion-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff3b30;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      z-index: 10;
    }

    .promotion-text {
      color: #ff3b30;
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    .price-original {
      text-decoration: line-through;
      color: #999;
      font-size: 14px;
    }

    .price-promo {
      color: #ff3b30;
      font-weight: bold;
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö promotion summary */
    #appliedPromotions {
      margin-top: 8px;
      padding: 8px;
      background: #fef3c7;
      border-radius: 6px;
      font-size: 12px;
    }

    .dark #appliedPromotions {
      background: #78350f;
      color: #fef3c7;
    }

    .promotion-text {
      color: #ff3b30;
      font-size: 12px;
      margin-top: 4px;
    }

    .price-original {
      text-decoration: line-through;
      color: #999;
      font-size: 14px;
    }

    .price-promo {
      color: #ff3b30;
      font-weight: bold;
    }

    /* ===== PROMOTION STYLES ===== */
    /* Badge styling ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤ */
    .promo-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ff3838 100%);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(255, 56, 56, 0.4);
      z-index: 20;
    }

    /* Promo Banner ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level Cards */
    .level-promo-banner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #ff6b6b 0%, #ff3838 50%, #ff6b6b 100%);
      background-size: 200% 100%;
      color: white;
      text-align: center;
      padding: 4px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 0.5rem 0.5rem 0 0;
    }

    /* Floating Promo Text */
    .floating-promo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 56, 56, 0.95);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 4px 15px rgba(255, 56, 56, 0.3);
    }

    /* Card with Promo Border */
    .card.has-promotion {
      position: relative;
      overflow: hidden;
    }

    .card.has-promotion::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ff6b6b, #ff3838, #ff6b6b, #ff3838);
      background-size: 400% 400%;
      border-radius: inherit;
      z-index: -1;
    }

    /* Promo Corner Ribbon */
    .promo-ribbon {
      position: absolute;
      top: 10px;
      right: -30px;
      background: linear-gradient(135deg, #ff3838 0%, #ff6b6b 100%);
      color: white;
      padding: 5px 40px;
      font-size: 11px;
      font-weight: 700;
      transform: rotate(45deg);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    /* Sparkle Effect */
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
    }

    /* Multiple sparkles with positioning */
    .sparkle:nth-child(1) {
      top: 10%;
      left: 20%;
    }

    .sparkle:nth-child(2) {
      top: 20%;
      right: 10%;
    }

    .sparkle:nth-child(3) {
      bottom: 15%;
      left: 15%;
    }

    .sparkle:nth-child(4) {
      bottom: 20%;
      right: 20%;
    }

    .sparkle:nth-child(5) {
      top: 50%;
      left: 50%;
    }

    /* Hot Deal Tag */
    .hot-deal-tag {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #ff3838;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    /* Promo Text */
    .promo-text-animated {
      background: linear-gradient(90deg, #ff3838, #ff6b6b, #ff3838);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      font-weight: 700;
    }

    /* Quick Actions Menu Dropdown Styles */
    .rotate-180 {
      transform: rotate(180deg);
    }

    .bi-chevron-down {
      transition: transform 0.2s ease;
    }

    #quickActionsDropdown {
      animation: dropdownFadeIn 0.2s ease-out;
      transform-origin: top right;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Dropdown hover effects */
    #quickActionsDropdown a {
      transition: all 0.2s ease;
      border-radius: 8px;
      margin: 2px 8px;
    }

    #quickActionsDropdown a:hover,
    #quickActionsDropdown a.bg-gray-100 {
      transform: translateX(4px);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #quickActionsDropdown a:active {
      transform: translateX(2px) scale(0.98);
    }

    /* Dark mode support for dropdown */
    .dark #quickActionsDropdown {
      background: #374151;
      border-color: #6b7280;
    }

    .dark #quickActionsDropdown .border-gray-100 {
      border-color: #6b7280;
    }

    .dark #quickActionsDropdown a {
      color: #e5e7eb;
    }

    .dark #quickActionsDropdown a:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
    }

    /* üî• Fire Icon */
    .promo-fire-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 32px;
      z-index: 30;
      filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
    }

    /* Override ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cards ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á overflow */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
    }

    /* Customer Search Styles */
    #customerSearchResults {
      z-index: 10;
    }

    .customer-result-item:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }

    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    [data-theme="dark"] .loading-spinner {
      border-color: #555555;
      border-top-color: var(--primary-color);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== CONNECTION STATUS STYLES ===== */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .connection-status.online {
      color: #10b981;
    }

    .connection-status.offline {
      color: #ef4444;
    }

    .connection-status.connecting {
      color: #f59e0b;
    }

    /* Status indicators */
    #firebaseStatus.connected {
      background-color: #10b981 !important;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
    }

    #firebaseStatus.disconnected {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    #socketStatus.connected {
      background-color: #3b82f6 !important;
      box-shadow: 0 0 4px rgba(59, 130, 246, 0.5);
    }

    #socketStatus.disconnected {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    /* Pulse animation for connecting state */
    .connection-status.connecting::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #f59e0b;
      margin-right: 4px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    /* Dark mode support */
    .dark .connection-status.online {
      color: #34d399;
    }

    .dark .connection-status.offline {
      color: #f87171;
    }

    .dark .connection-status.connecting {
      color: #fbbf24;
    }

    /* ===== PRINTER STATUS STYLES ===== */
    .printer-status-indicator {
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .printer-status-indicator.online {
      color: #10b981;
    }

    .printer-status-indicator.offline {
      color: #ef4444;
    }

    .printer-status-indicator.checking {
      color: #f59e0b;
    }

    .printer-status-indicator.error {
      color: #ef4444;
    }

    /* Printer status dot */
    #printerStatus.online {
      background-color: #10b981 !important;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
    }

    #printerStatus.offline {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    #printerStatus.checking {
      background-color: #f59e0b !important;
      box-shadow: 0 0 4px rgba(245, 158, 11, 0.5);
      animation: pulse 1.5s infinite;
    }



    /* Dark mode support for printer status */
    .dark .printer-status-indicator.online {
      color: #34d399;
    }

    .dark .printer-status-indicator.offline,
    .dark .printer-status-indicator.error {
      color: #f87171;
    }

    .dark .printer-status-indicator.checking {
      color: #fbbf24;
    }
  </style>

  <style>
    /* ===== Enhanced Province-District-Subdistrict Dropdown Styles ===== */
    .dropdown-content {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      animation: dropdownFadeIn 0.2s ease-out;
      font-family: 'Prompt', sans-serif;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover, .dropdown-item.selected {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .dropdown-item-main {
      font-weight: 500;
      font-size: 14px;
      color: #1f2937;
    }

    .dropdown-item-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .dropdown-loading {
      padding: 16px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .dropdown-no-results {
      padding: 16px;
      text-align: center;
      color: #9ca3af;
      font-size: 14px;
      font-style: italic;
    }

    /* Dark mode support for dropdown */
    .dark .dropdown-content {
      background: #374151;
      border-color: #6b7280;
      color: #e5e7eb;
    }

    .dark .dropdown-item {
      border-bottom-color: #4b5563;
    }

    .dark .dropdown-item:hover, .dark .dropdown-item.selected {
      background-color: #4338ca;
      color: #c7d2fe;
    }

    .dark .dropdown-item-main {
      color: #f9fafb;
    }

    .dark .dropdown-item-sub {
      color: #d1d5db;
    }

    .dark .dropdown-loading, .dark .dropdown-no-results {
      color: #9ca3af;
    }

    /* Enhanced Input Validation Styles */
    .input.border-green-500 {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.1);
    }
    
    .input.border-yellow-500 {
      border-color: #f59e0b !important;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.1);
    }
    
    .input.border-red-500 {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.1);
    }
    
    /* Zipcode input enhancements */
    #zipcode:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
    }
    
    #zipcode.border-green-500:focus {
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.15);
    }
    
    #zipcode.border-yellow-500:focus {
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }
    
    #zipcode.border-red-500:focus {
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.15);
    }

    /* Status message styling */
    .status-success {
      color: #10b981;
      background-color: rgba(16, 185, 129, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-warning {
      color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-error {
      color: #ef4444;
      background-color: rgba(239, 68, 68, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Dark mode for status messages */
    .dark .status-success {
      color: #34d399;
      background-color: rgba(52, 211, 153, 0.1);
    }

    .dark .status-warning {
      color: #fbbf24;
      background-color: rgba(251, 191, 36, 0.1);
    }

    .dark .status-error {
      color: #f87171;
      background-color: rgba(248, 113, 113, 0.1);
    }

    /* Input focus states */
    .input-enhanced:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Responsive dropdown */
    @media (max-width: 640px) {
      .dropdown-content {
        max-height: 150px;
      }
    }
  </style>

  <!-- Loading System - Remove problematic CSS link -->

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Loading Overlay CSS (Updated from addNewProduct_pattani.html) -->
  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <script>
    // Read depositNavigationData from sessionStorage and initialize page state
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const navDataRaw = sessionStorage.getItem('depositNavigationData');
        if (navDataRaw) {
          const navData = JSON.parse(navDataRaw);
          console.log('üîó depositNavigationData loaded for frontstore:', navData);
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
          if (navData.hasStockReservation && navData.stockReservation) {
            console.log('üîí Stock reservation detected:', navData.stockReservation);
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
            if (typeof showToast === 'function') {
              showToast(
                `‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${navData.stockReservation.productName} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${navData.stockReservation.customerName}`,
                'info'
              );
            }
          }
    
          // Auto-add product to cart if available
          if (navData.product && navData.product._id) {
            console.log('üì¶ Auto-adding product from deposit receipt:', navData.product);
    
            // Wait for cart system to be ready
            setTimeout(() => {
              try {
                // Create product object for adding to cart
                const productForCart = {
                  _id: navData.product._id,
                  name: navData.product.name,
                  brand: navData.product.brand,
                  model: navData.product.model,
                  price: navData.product.price,
                  imei: navData.product.imei,
                  category: navData.product.category,
                  quantity: 1,
                  fromDepositReceipt: true,
                  depositReceiptId: navData.depositReceiptId,
                  depositAmount: navData.amounts?.depositAmount || 0,
                  stockReservation: navData.stockReservation || null,
                  hasStockReservation: navData.hasStockReservation || false
                };
    
                // Add to cart if addToCart function exists
                if (typeof addToCart === 'function') {
                  // Call addToCart with correct parameters: (id, name, price, imei, taxType, model, poNumber, supplier)
                  addToCart(
                    navData.product._id,
                    navData.product.name,
                    navData.product.price,
                    navData.product.imei || '',
                    'inclusive', // Default tax type
                    navData.product.model || '',
                    '', // poNumber
                    '' // supplier
                  );
                  console.log('‚úÖ Product added to cart from deposit receipt');
                } else {
                  console.log('‚ö†Ô∏è addToCart function not yet available, storing for later');
                  // Store for later use when cart system is ready
                  window.pendingDepositProduct = {
                    id: navData.product._id,
                    name: navData.product.name,
                    price: navData.product.price,
                    imei: navData.product.imei || '',
                    taxType: 'inclusive',
                    model: navData.product.model || '',
                    poNumber: '',
                    supplier: '',
                    fromDepositReceipt: true,
                    depositReceiptId: navData.depositReceiptId,
                    depositAmount: navData.amounts?.depositAmount || 0
                  };
                }
    
                // Pre-fill customer information if available
                if (navData.customer) {
                  console.log('üë§ Pre-filling customer data:', navData.customer);

                  // Fill customer prefix (‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
                  const prefixInput = document.getElementById('customerPrefix');
                  if (prefixInput && navData.customer.prefix) {
                    prefixInput.value = navData.customer.prefix;
                    console.log('‚úÖ Customer prefix pre-filled:', navData.customer.prefix);
                  }

                  // Fill customer first name
                  const firstNameInput = document.getElementById('customerFirstName');
                  if (firstNameInput && navData.customer.firstName) {
                    firstNameInput.value = navData.customer.firstName;
                    console.log('‚úÖ Customer first name pre-filled:', navData.customer.firstName);
                  }

                  // Fill customer last name
                  const lastNameInput = document.getElementById('customerLastName');
                  if (lastNameInput && navData.customer.lastName) {
                    lastNameInput.value = navData.customer.lastName;
                    console.log('‚úÖ Customer last name pre-filled:', navData.customer.lastName);
                  }

                  // Fill customer phone
                  const phoneInput = document.getElementById('customerPhone');
                  if (phoneInput && navData.customer.phone) {
                    phoneInput.value = navData.customer.phone;
                    console.log('‚úÖ Customer phone pre-filled:', navData.customer.phone);
                  }

                  // Fill birth date (convert to yyyy-MM-dd format)
                  const birthDateInput = document.getElementById('customerBirthDate');
                  if (birthDateInput && navData.customer.birthDate) {
                    // Convert ISO string to yyyy-MM-dd format
                    const birthDate = new Date(navData.customer.birthDate);
                    const formattedDate = birthDate.toISOString().split('T')[0];
                    birthDateInput.value = formattedDate;
                    console.log('‚úÖ Customer birth date pre-filled:', formattedDate);
                  }

                  // Fill tax ID
                  const taxIdInput = document.getElementById('customerTaxId');
                  if (taxIdInput && navData.customer.taxId) {
                    taxIdInput.value = navData.customer.taxId;
                    console.log('‚úÖ Customer tax ID pre-filled:', navData.customer.taxId);
                  }

                  // Fill address details
                  const houseNoInput = document.getElementById('houseNo');
                  if (houseNoInput && navData.customer.houseNo) {
                    houseNoInput.value = navData.customer.houseNo;
                    console.log('‚úÖ Customer house no pre-filled:', navData.customer.houseNo);
                  }

                  const mooInput = document.getElementById('moo');
                  if (mooInput && navData.customer.moo) {
                    mooInput.value = navData.customer.moo;
                    console.log('‚úÖ Customer moo pre-filled:', navData.customer.moo);
                  }

                  const subDistrictInput = document.getElementById('subDistrict');
                  if (subDistrictInput && navData.customer.subDistrict) {
                    subDistrictInput.value = navData.customer.subDistrict;
                    console.log('‚úÖ Customer sub-district pre-filled:', navData.customer.subDistrict);
                  }

                  const districtInput = document.getElementById('district');
                  if (districtInput && navData.customer.district) {
                    districtInput.value = navData.customer.district;
                    console.log('‚úÖ Customer district pre-filled:', navData.customer.district);
                  }

                  const provinceInput = document.getElementById('province');
                  if (provinceInput && navData.customer.province) {
                    provinceInput.value = navData.customer.province;
                    console.log('‚úÖ Customer province pre-filled:', navData.customer.province);
                  }

                  const zipcodeInput = document.getElementById('zipcode');
                  if (zipcodeInput && navData.customer.zipcode) {
                    zipcodeInput.value = navData.customer.zipcode;
                    console.log('‚úÖ Customer zipcode pre-filled:', navData.customer.zipcode);
                  }
                }
    
                // Show success notification
                if (typeof showNotification === 'function') {
                  showNotification('success', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                }
    
                // Clear the session storage after use
                sessionStorage.removeItem('depositNavigationData');
                console.log('üßπ depositNavigationData cleared from sessionStorage');
    
              } catch (error) {
                console.error('‚ùå Error processing deposit navigation data:', error);
              }
            }, 1000); // Wait 1 second for page to fully load
          }
        } else {
          console.log('‚ÑπÔ∏è No depositNavigationData found in sessionStorage for frontstore');
        }
      } catch (err) {
        console.error('‚ùå Error loading depositNavigationData for frontstore:', err);
      }
    });
  </script>

  
  <!-- Sidebar Container - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ sidebar.js -->
  <div id="sidebarContainer"></div>

  <div id="mainContent" class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header
      class="p-4 bg-white dark:bg-gray-800
             border-b border-gray-200 dark:border-gray-700
             flex items-center justify-between"
    >
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
      </div>
      
      <!-- Modular Notifications & Actions -->
      <div class="flex items-center gap-4">
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-1">
            <span id="connectionStatus" class="connection-status offline text-xs font-medium">üî¥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            <div class="flex gap-1 ml-2">
              <div id="firebaseStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Firebase Status"></div>
              <div id="socketStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Socket.IO Status"></div>
              <div id="printerStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Printer Status"></div>
            </div>
          </div>
          <div id="onlineUserCount" class="text-xs text-gray-500" title="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">1</div>
        </div>

        <!-- Printer Status Badge -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-2">
            <span id="printer-status-badge" class="badge badge-warning text-xs">üü° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
            <div id="printer-status-indicator" class="printer-status-indicator checking text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</div>
          </div>
          <button id="manual-printer-check" class="btn btn-xs btn-ghost"
                  title="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå"
                  aria-label="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà"
                  aria-describedby="printer-status-indicator">
            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
          </button>
        </div>

        <!-- POS Notification Bell -->
        <div class="notification-bell pos-module" id="posNotificationBell">
          <button class="notification-toggle"
                  title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS"
                  aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö POS"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="posNotificationDropdown">
            <i class="bi bi-bell" aria-hidden="true"></i>
            <span class="notification-badge" id="posNotificationCount" aria-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà">0</span>
          </button>
          
          <!-- Dropdown Notifications -->
          <div class="notification-dropdown" id="posNotificationDropdown">
            <div class="notification-header">
              <h3><i class="bi bi-shop-window"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS</h3>
              <div class="notification-actions">
                <button class="mark-all-read" onclick="markAllAsRead('pos')">
                  <i class="bi bi-check-all"></i>
                </button>
                <button class="clear-all" onclick="clearAllNotifications('pos')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            <div class="notification-list" id="posNotificationList">
              <!-- Notifications will be inserted here -->
            </div>
          </div>
        </div>

                 <!-- Quick Actions Menu -->
         <div class="relative">
           <button id="quickActionsBtn" class="btn btn-outline flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300">
             <i class="bi bi-list text-lg"></i>
             <span class="hidden md:inline">‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
             <i class="bi bi-chevron-down text-sm ml-1"></i>
           </button>
           
           <!-- Dropdown Menu -->
           <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
             <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between">
               <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</span>
               <span id="dropdownBranchInfo" class="text-xs text-gray-400">‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</span>
             </div>
             
             <a href="HistoryReceipt" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200">
               <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                 <i class="bi bi-receipt text-blue-600"></i>
               </div>
               <div>
                 <div class="font-medium">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</div>
                 <div class="text-xs text-gray-500">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
               </div>
             </a>
             
             
            
             <!-- Footer with shortcuts -->
             <div class="px-4 py-2 border-t border-gray-100 mt-2">
               <div class="flex items-center justify-between text-xs text-gray-400">
                 <div class="flex flex-col">
                   <span>‚Üë‚Üì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Ä¢ Enter ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Ä¢ Esc ‡∏õ‡∏¥‡∏î</span>
                   <span class="mt-1">Alt+M ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+M ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π</span>
                 </div>
                 <span id="connectionStatusMenu" class="flex items-center gap-1">
                   <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                   ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                 </span>
               </div>
             </div>
           </div>
         </div>
      </div>
    </header>

    <!-- Toast Notification Container for POS Module -->
    <div id="posToastContainer" class="toast-container pos-module"></div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° container ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö content -->
    <div class="flex-1 flex gap-4 p-4 overflow-auto">
      <!-- Left Column: Product Grid -->
      <div class="flex-1">
        <!-- HTML ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡∏°‡πà -->
        <div class="card p-4"> <!-- This card might need padding adjustment if the global .card style adds 1rem -->
          <div class="flex gap-2">
            <input type="text" id="searchQuery" class="input input-bordered w-full"
              placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ IMEI..."
              aria-label="‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
              aria-describedby="search-help" />
            <button id="btnSearch" class="btn btn-primary hidden"
              aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
              <i class="bi bi-search" aria-hidden="true"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button id="btnReset" class="btn btn-secondary"
              aria-label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
              <i class="bi bi-x-circle" aria-hidden="true"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
            </button>
          </div>
        </div>

        <!-- Barcode Scanner Section -->
        <div class="card p-4">
          <h5 class="mb-3 font-semibold flex items-center gap-2" id="barcode-section-title">
            <i class="bi bi-upc-scan text-blue-600" aria-hidden="true"></i>
            ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
          </h5>
          <div class="flex gap-2" role="group" aria-labelledby="barcode-section-title">
            <input type="text" id="barcodeInput" class="input input-bordered flex-1"
              placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
              aria-label="‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
              aria-describedby="barcode-help" />
            <button id="btnAddBarcode" class="btn btn-primary"
              title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î"
              aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà">
              <i class="bi bi-plus-circle" aria-hidden="true"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
            <button id="btnClearBarcode" class="btn btn-secondary"
              title="‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î"
              aria-label="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
            </button>
          </div>
          <div class="text-xs text-gray-500 mt-2" id="barcode-help">
            üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter | ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </div>
          <!-- Hidden helper text for screen readers -->
          <div id="search-help" class="sr-only">
            ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç IMEI ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </div>
          
          <!-- Barcode Results -->
          <div id="barcodeResults" class="mt-3 hidden">
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-check-circle text-green-600"></i>
                <span class="text-sm font-semibold text-green-800 dark:text-green-200">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
              </div>
              <div id="barcodeProductInfo" class="text-sm text-green-700 dark:text-green-300 mt-1">
                <!-- Product info will be displayed here -->
              </div>
            </div>
          </div>
        </div>

        <script>
          // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('searchQuery').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            SecurityHelpers.safeSetContent(document.getElementById('imeiResultGrid'), '', ''); // ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            document.getElementById('imeiResultContainer').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            goBackToLevel1(); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Level 1
          });
        </script>

        <!-- Container ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
        <div id="imeiResultContainer" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <h5 class="mb-2 font-semibold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5>
          <div id="imeiResultGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 1 -->
        <div id="level1Container" class="card p-4"> <!-- This card might need padding adjustment -->
          <h5 class="mb-3">Level 1 ‚Äì ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
          <div id="level1Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 2 -->
        <div id="level2Container" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <div class="flex justify-between items-center mb-3">
            <h5 id="level2Title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ‚Ä¶</h5>
            <button id="btnGoBack" class="btn btn-sm">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          </div>
          <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 3 -->
        <div id="level3Container" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <div class="flex justify-between items-center mb-3">
            <h5 id="level3Title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
            <button id="btnGoBackToLevel2" class="btn btn-sm">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
          </div>
          <div id="level3Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          </div>
        </div>
      </div> <!-- End Left Column -->

      <!-- Right Column: Customer, Cart, Summary -->
      <div class="w-80 flex flex-col gap-4">
        <!-- Customer Info -->
        <div class="card p-4"> <!-- This card might need padding adjustment -->
          <h5 class="flex items-center gap-2 mb-3">
            <i class="bi bi-person-badge"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          </h5>

          <div class="flex gap-2 mb-4">
            <button id="btnReadCard" class="btn btn-info flex-1 flex items-center justify-center gap-2">
              <i class="bi bi-credit-card-2-front"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
            </button>
            <button id="btnTestCardReader" class="btn btn-outline btn-info flex items-center justify-center gap-1 px-3" title="‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£">
              <i class="bi bi-tools"></i>
            </button>
            <button id="btnTestFillData" class="btn btn-outline btn-success flex items-center justify-center gap-1 px-3" title="‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á (# delimiter format)">
              <i class="bi bi-check2-square"></i>
            </button>
          </div>

          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
          <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <label class="label">
              <span class="label-text font-semibold">
                <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
              </span>
            </label>
            <div class="flex gap-2">
              <input type="text" id="customerSearch" class="input input-bordered flex-1"
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13" />
              <button id="btnSearchCustomer" class="btn btn-primary" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </div>

            <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div id="customerSearchResults" class="mt-3 hidden">
              <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                  <!-- Results will be inserted here -->
                </div>
              </div>
            </div>
          </div>
          <!-- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->

          <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
          <div class="mb-4">
            <label class="label"><span class="label-text font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></label>
            <select id="customerType" class="select select-bordered w-full">
              <option value="individual">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
              <option value="corporate">‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option>
            </select>
          </div>

          <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -->
          <div id="personalFields" class="grid grid-cols-2 gap-3">
            <div>
              <label class="label"><span class="label-text">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</span></label>
              <select id="customerPrefix" class="select select-bordered w-full">
                <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô.‡∏™.</option>
              </select>
            </div>
            <div>
              <label class="label"><span class="label-text">‡πÄ‡∏û‡∏®</span></label>
              <select id="customerGender" class="select select-bordered w-full">
                <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏® -</option>
                <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
              </select>
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠</span></label>
              <input type="text" id="customerFirstName" class="input input-bordered w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span></label>
              <input type="text" id="customerLastName" class="input input-bordered w-full" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span></label>
              <input type="text" id="customerPhone" class="input input-bordered w-full" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</span></label>
              <select id="customerOccupation" class="select select-bordered w-full">
                <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ä‡∏µ‡∏û -</option>
                <option value="‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</option>
                <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</option>
                <option value="‡πÅ‡∏û‡∏ó‡∏¢‡πå">‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                <option value="‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£">‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£</option>
                <option value="‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°">‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                <option value="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</option>
                <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</option>
                <option value="‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô">‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏∞">‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏∞</option>
                <option value="‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢">‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß">‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û">‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö">‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏ú‡∏°">‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏ú‡∏°</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ">‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏õ‡∏≤">‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</option>
                <option value="‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á">‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏î‡∏ô‡∏ï‡∏£‡∏µ">‡∏ô‡∏±‡∏Å‡∏î‡∏ô‡∏ï‡∏£‡∏µ</option>
                <option value="‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á">‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á</option>
                <option value="‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô">‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤">‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤</option>
                <option value="‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß/‡πÅ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ß">‡∏û‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ß/‡πÅ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ß</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</option>
                <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°</option>
                <option value="‡πÑ‡∏Å‡∏î‡πå‡∏ô‡∏≥‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß">‡πÑ‡∏Å‡∏î‡πå‡∏ô‡∏≥‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß">‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                <option value="‡∏ô‡∏ß‡∏î‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢">‡∏ô‡∏ß‡∏î‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏´‡∏°‡∏≠‡∏ï‡∏≥‡πÅ‡∏¢">‡∏´‡∏°‡∏≠‡∏ï‡∏≥‡πÅ‡∏¢</option>
                <option value="‡∏¢‡∏≤‡∏°">‡∏¢‡∏≤‡∏°</option>
                <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà</option>
                <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
                <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á</option>
                <option value="‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á">‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
                <option value="‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô">‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
                <option value="‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏î‡πá‡∏Å">‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏î‡πá‡∏Å</option>
                <option value="‡∏Ñ‡∏ô‡∏™‡∏ß‡∏ô">‡∏Ñ‡∏ô‡∏™‡∏ß‡∏ô</option>
                <option value="‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                <option value="‡∏õ‡∏£‡∏∞‡∏°‡∏á">‡∏õ‡∏£‡∏∞‡∏°‡∏á</option>
                <option value="‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå">‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</option>
                <option value="‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                <option value="‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤">‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</option>
                <option value="‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå</option>
                <option value="‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î">‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
                <option value="‡πÄ‡∏ã‡∏•‡∏•‡πå">‡πÄ‡∏ã‡∏•‡∏•‡πå</option>
                <option value="‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≤‡∏¢">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≤‡∏¢</option>
                <option value="‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤">‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤</option>
                <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πàHR">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πàHR</option>
                <option value="‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£">‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£</option>
                <option value="‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå">‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                <option value="‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á">‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</option>
                <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</option>
                <option value="‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                <option value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                <option value="‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏">‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏</option>
                <option value="‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô">‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô</option>
                <option value="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
            <div>
              <label class="label">
                <span class="label-text">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</span>
                <span class="label-text-alt text-xs text-gray-500">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
              </label>
              <input type="date" id="customerBirthDate" class="input input-bordered w-full"
                     title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏≠‡∏≤‡∏¢‡∏∏</span></label>
              <input type="number" id="customerAge" class="input input-bordered w-full" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" min="0" max="150" readonly />
            </div>
            <div>
              <label class="label">
                <span class="label-text">‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                <span class="label-text-alt text-xs text-green-600">‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™!</span>
              </label>
              <input type="text" id="referralCode" class="input input-bordered w-full" 
                     placeholder="‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" 
                     title="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™" />
              <div id="referralStatus" class="text-xs mt-1 hidden">
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
              </div>
            </div>
            <div></div> <!-- Empty div for grid alignment -->
            <div>
              <label class="label"><span class="label-text">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span></label>
              <input type="text" id="houseNo" class="input input-bordered w-full" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏´‡∏°‡∏π‡πà</span></label>
              <input type="text" id="moo" class="input input-bordered w-full" placeholder="‡∏´‡∏°‡∏π‡πà" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span></label>
              <div class="relative">
                <input type="text" id="province" class="input input-bordered w-full" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" autocomplete="off" />
                <div id="provinceDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</span></label>
              <div class="relative">
                <input type="text" id="district" class="input input-bordered w-full" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" autocomplete="off" />
                <div id="districtDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏ï‡∏≥‡∏ö‡∏•</span></label>
              <div class="relative">
                <input type="text" id="subDistrict" class="input input-bordered w-full" placeholder="‡∏ï‡∏≥‡∏ö‡∏•" autocomplete="off" />
                <div id="subDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡∏ö‡∏•</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span></label>
              <div class="relative">
                <input type="text" id="zipcode" 
                  class="input input-bordered w-full pr-10" 
                  placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" 
                  maxlength="5" 
                  pattern="[0-9]{5}"
                  title="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <i class="bi bi-geo-alt text-gray-400"></i>
                </div>
                <div id="zipcodeStatus" class="mt-1 text-xs hidden">
                  <span id="zipcodeIcon"></span>
                  <span id="zipcodeMessage"></span>
                </div>
              </div>
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></label>
              <input type="email" id="customerEmailPersonal" class="input input-bordered w-full" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</span></label>
              <input type="text" id="customerTaxId" class="input input-bordered w-full" placeholder="" />
            </div>
          </div>

          <!-- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô) -->
          <div id="corporateFields" class="grid grid-cols-2 gap-3 hidden">
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span></label>
              <input type="text" id="companyName" class="input input-bordered w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span></label>
              <input type="text" id="companyTaxId" class="input input-bordered w-full"
                placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å</span></label>
              <input type="text" id="contactPerson" class="input input-bordered w-full"
                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</span></label>
              <input type="text" id="corporatePhone" class="input input-bordered w-full" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
            </div>
            <div>
              <label class="label"><span class="label-text">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)</span></label>
              <input type="email" id="corporateEmail" class="input input-bordered w-full" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span></label>
              <input type="text" id="companyAddress" class="input input-bordered w-full" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
            </div>
          </div>
        </div>

        <div class="card">
          <h5 class="section-title flex items-center gap-2">
            <i class="bi bi-cart4"></i> ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            <span class="text-sm font-normal text-gray-500">(<span id="cartCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </h5>


          <div class="overflow-y-auto max-h-96">
            <table class="table w-full border cart-table" id="cartTable">
              <thead>
                <tr>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô</th>
                  <th>‡∏£‡∏ß‡∏°</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- JS ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° <tr> ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á -->
              </tbody>
            </table>
          </div>
          <div class="flex justify-between mt-3 px-2 font-medium">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ):</span>
            <span id="subTotal" class="text-primary-color font-semibold">0.00 ‡∏ø</span>
          </div>
        </div>

        <div class="card">
          <h5 class="section-title flex items-center gap-2">
            <i class="bi bi-receipt-cutoff"></i> ‡∏†‡∏≤‡∏©‡∏µ, ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
          </h5>
          
          <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
          <!-- ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° -->
          <div id="mixedPaymentDetails" class="hidden mb-4 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
            <h6 class="font-semibold mb-3 flex items-center gap-2">
              <i class="bi bi-cash-coin text-yellow-600"></i>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°:
            </h6>
            <div class="grid grid-cols-2 gap-4 mb-3">
              <div>
                <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="mixedCashAmount" class="input input-bordered w-full" placeholder="0.00" onchange="updateMixedPayment()" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="mixedTransferAmount" class="input input-bordered w-full" placeholder="0.00" onchange="updateMixedPayment()" />
              </div>
            </div>
            <div class="text-sm">
              <span class="text-gray-600">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: </span>
              <span id="mixedTotalDisplay" class="font-medium text-yellow-700">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
          </div>

          <div class="mb-4 p-4 border border-blue-200 rounded-lg bg-blue-50">
            <h6 class="font-semibold mb-3 flex items-center gap-2">
              <i class="bi bi-file-text text-blue-600"></i>
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
            </h6>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div class="flex items-center gap-2 p-3 border border-gray-200 rounded bg-white">
                <i class="bi bi-check-circle-fill text-green-600"></i>
                <div>
                  <div class="font-medium">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                  <div class="text-xs text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà RE-YYMMDD-XXXX</div>
                </div>
              </div>
              <div class="flex items-center gap-2 p-3 border border-gray-200 rounded bg-white">
                <i class="bi bi-check-circle-fill text-green-600"></i>
                <div>
                  <div class="font-medium">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</div>
                  <div class="text-xs text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà TX-YYMMDD-XXXX</div>
                </div>
              </div>
            </div>
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle-fill"></i>
              <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</span>
            </div>
            
            <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á Email -->
            <div class="border-t pt-3">
              <h6 class="font-medium mb-2 text-gray-700">‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á Email:</h6>
              <div class="space-y-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="sendReceiptEmail" class="checkbox checkbox-sm" checked />
                  <span class="text-sm">‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="sendTaxInvoiceEmail" class="checkbox checkbox-sm" />
                  <span class="text-sm">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label"><span class="label-text font-semibold">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ (%)</span></label>
              <input type="number" id="vatRate" class="input input-bordered w-full" value="7" />
            </div>
            <div>
              <label class="label"><span class="label-text font-semibold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó/%)</span></label>
              <input type="text" id="discount" class="input input-bordered w-full" placeholder="100 ‡∏´‡∏£‡∏∑‡∏≠ 10%" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text font-semibold">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span></label>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">

                <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-cash" value="CASH" class="hidden peer" checked />
                  <label for="payment-cash" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-cash-coin text-2xl text-green-600 mb-1"></i>
                    <span class="text-sm">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
                  </label>
                </div>

                <!-- ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-credit" value="CARD" class="hidden peer" />
                  <label for="payment-credit" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-credit-card text-2xl text-blue-600 mb-1"></i>
                    <span class="text-sm">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
                  </label>
                </div>

                <!-- ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-transfer" value="TRANSFER" class="hidden peer" />
                  <label for="payment-transfer" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-bank text-2xl text-purple-600 mb-1"></i>
                    <span class="text-sm">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                  </label>
                </div>

                <!-- ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô) -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-mixed" value="MIXED" class="hidden peer" />
                  <label for="payment-mixed" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-cash-coin text-2xl text-purple-600 mb-1"></i>
                    <span class="text-sm">‡∏ú‡∏™‡∏°</span>
                  </label>
                </div>


              </div>
            </div>

          </div>


          <div class="bg-gray-50 rounded-lg p-3 mt-4">
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span>
              <span id="docTypeLabel" class="font-medium">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô + ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
            </div>
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (7%):</span>
              <span id="vatAmount" class="font-medium">0.00 ‡∏ø</span>
            </div>
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
              <span id="discountAmount" class="font-medium text-red-600">0.00 ‡∏ø</span>
            </div>
            <!-- promotions summary -->
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô:</span>
              <span id="promotionDiscount" class="font-medium text-red-600">0.00 ‡∏ø</span>
            </div>
            <div id="appliedPromotions" class="text-xs text-gray-500 mb-2"></div>
            <!-- deposit deduction -->
            <div id="depositDeductionRow" class="flex justify-between w-full mb-2" style="display: none;">
              <span class="text-gray-600">‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
              <span id="depositDeductionAmount" class="font-medium text-green-600">-0.00 ‡∏ø</span>
            </div>
            <div class="flex justify-between w-full pt-2 border-t border-gray-200">
              <span class="font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
              <span id="totalPrice" class="text-lg font-bold text-blue-700">0.00 ‡∏ø</span>
            </div>
          </div>


          <!-- Email Options -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mt-4">
            <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
              <i class="bi bi-envelope-at text-blue-600"></i> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
            </h6>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="sendEmailReceipt" class="checkbox checkbox-primary" checked />
              <label for="sendEmailReceipt" class="text-sm cursor-pointer flex-1">
                ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              </label>
              <button 
                type="button" 
                onclick="updateEmailServiceIndicator()" 
                class="btn btn-sm btn-ghost text-xs px-2 py-1 ml-1" 
                title="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div id="emailNote" class="text-xs text-gray-500 mt-2">
              <i class="bi bi-info-circle"></i> 
              <span id="emailNoteText">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
            </div>
          </div>

          <button class="btn btn-success w-full mt-4 py-3" id="btnSingleCheckout">
            <i class="bi bi-check-circle mr-2"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          </button>
        </div>
      </div> <!-- End Right Column -->
    </div> <!-- End Main Content two-column flex container -->
  </div> <!-- End Main Content -->
  </div> <!-- End Sidebar/Main Content flex container -->

  <!-- Footer -->
  <footer class="mt-auto text-center text-sm text-gray-500 dark:text-gray-400 py-4">
    ¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.
  </footer>

  <!-- JavaScript Logic -->
  <script>
    // -----------------------------
    // 1) ‡∏≠‡πà‡∏≤‡∏ô branch_code ‡∏à‡∏≤‡∏Å URL parameter
    // -----------------------------
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

    if (!BRANCH_CODE) {
      console.warn("Branch not found in URL or localStorage, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    window.BRANCH_CODE = BRANCH_CODE; // Make it globally accessible
    console.log(`[frontstore_pattani] Using branch code: ${BRANCH_CODE}`);

    // -----------------------------
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    // -----------------------------
    const productParam = urlParams.get('product');
    const receiptParam = urlParams.get('receipt');

    console.log('üìã URL Parameters:', {
      branch: BRANCH_CODE,
      product: productParam,
      receipt: receiptParam
    });

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö
    let fromDepositReceipt = false;
    let preSelectedProductId = null;
    let depositReceiptData = null;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    async function loadDepositReceiptData() {
      if (!receiptParam) return null;

      try {
        console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡∏≤‡∏Å API:', receiptParam);

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        const response = await fetch(`/api/deposit-receipts/${receiptParam}`);

        if (!response.ok) {
          console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API:', response.status);
          return null;
        }

        const response_json = await response.json();
        console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', response_json);

        // Extract actual receipt data from response
        const receipt = response_json.data || response_json;
        console.log('üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤:', receipt);
        console.log('üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å API:', receipt.customer);

        depositReceiptData = receipt;
        fromDepositReceipt = true;
        preSelectedProductId = productParam;

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        window.depositReceiptInfo = {
          receiptId: receipt._id || receipt.id,
          depositReceiptId: receipt._id || receipt.id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° depositReceiptId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ API
          receiptNumber: receipt.receiptNumber,
          depositAmount: receipt.amounts?.depositAmount || 0,
          remainingAmount: receipt.amounts?.remainingAmount || 0,
          totalAmount: receipt.amounts?.totalAmount || receipt.amounts?.totalPrice || 0
        };
        console.log('üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', window.depositReceiptInfo);

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        fillCustomerFormFromReceipt(receipt);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
        console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å displayDepositReceiptInfo...');
        displayDepositReceiptInfo(receipt);

        return receipt;
      } catch (error) {
        console.error('‚ùå Error loading deposit receipt from API:', error);
      }
      return null;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    function fillCustomerFormFromReceipt(receipt) {
      if (!receipt || !receipt.customer) {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö');
        return;
      }

      const customer = receipt.customer;
      console.log('üë§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:', customer);

      setTimeout(() => {
        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
        if (customer.phone) {
          const phoneInput = document.getElementById('customerPhone');
          if (phoneInput) {
            phoneInput.value = customer.phone;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:', customer.phone);
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
        if (customer.name) {
          const nameParts = customer.name.trim().split(' ');
          const firstName = nameParts[0] || '';
          const lastName = nameParts.slice(1).join(' ') || '';

          const firstNameInput = document.getElementById('customerFirstName');
          const lastNameInput = document.getElementById('customerLastName');

          if (firstNameInput && firstName) {
            firstNameInput.value = firstName;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠:', firstName);
          }

          if (lastNameInput && lastName) {
            lastNameInput.value = lastName;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:', lastName);
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà - ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÅ‡∏¢‡∏Å
        if (customer.address) {
          // ‡∏ñ‡πâ‡∏≤ address ‡πÄ‡∏õ‡πá‡∏ô object ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå
          if (typeof customer.address === 'object') {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
            if (customer.address.houseNo) {
              const houseNoInput = document.getElementById('houseNo');
              if (houseNoInput) {
                houseNoInput.value = customer.address.houseNo;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:', customer.address.houseNo);
              }
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà
            if (customer.address.village || customer.address.moo) {
              const mooInput = document.getElementById('moo');
              if (mooInput) {
                mooInput.value = customer.address.village || customer.address.moo || '';
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà:', customer.address.village || customer.address.moo);
              }
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            if (customer.address.province) {
              const provinceInput = document.getElementById('province');
              if (provinceInput) {
                provinceInput.value = customer.address.province;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:', customer.address.province);
              }
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
            if (customer.address.district) {
              const districtInput = document.getElementById('district');
              if (districtInput) {
                districtInput.value = customer.address.district;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:', customer.address.district);
              }
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏•
            if (customer.address.subDistrict) {
              const subDistrictInput = document.getElementById('subDistrict');
              if (subDistrictInput) {
                subDistrictInput.value = customer.address.subDistrict;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏•:', customer.address.subDistrict);
              }
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
            if (customer.address.zipcode) {
              const zipcodeInput = document.getElementById('zipcode');
              if (zipcodeInput) {
                zipcodeInput.value = customer.address.zipcode;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:', customer.address.zipcode);
              }
            }

            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          }
          // ‡∏ñ‡πâ‡∏≤ address ‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå customerAddress (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          else {
            const addressInput = document.getElementById('customerAddress');
            if (addressInput) {
              addressInput.value = customer.address;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:', customer.address);
            }
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        if (customer.email) {
          const emailInput = document.getElementById('customerEmail');
          if (emailInput) {
            emailInput.value = customer.email;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•:', customer.email);
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ
        if (customer.taxId) {
          const taxIdInput = document.getElementById('customerTaxId');
          if (taxIdInput) {
            taxIdInput.value = customer.taxId;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:', customer.taxId);
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
        if (customer.idCard) {
          const idCardInput = document.getElementById('customerIdCard');
          if (idCardInput) {
            idCardInput.value = customer.idCard;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', customer.idCard);
          }
        }

        console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      }, 500);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    function displayDepositReceiptInfo(receipt) {
      console.log('üìã ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', receipt);
      console.log('üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö:', receipt.customer);

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      if (receipt.customer) {
        const customer = receipt.customer;
        const address = customer.address || {};

        const customerInfo = `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h4 class="font-semibold text-blue-800 mb-3">
              <i class="bi bi-receipt"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${receipt.receiptNumber || receipt.id}
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-700">
              <div>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${customer.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${customer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${customer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${customer.idCard || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${customer.customerType === 'individual' ? '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤' : customer.customerType === 'business' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              </div>
              <div>
                <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${address.street || ''} ${address.subdistrict || ''} ${address.district || ''} ${address.province || ''} ${address.zipcode || ''}</p>
                <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${receipt.product?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°:</strong> ${(receipt.amounts?.totalAmount || receipt.amounts?.totalPrice || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                <p><strong>‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß:</strong> <span class="text-green-600 font-bold">${(receipt.amounts?.depositAmount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></p>
                <p><strong class="text-red-600">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</strong> <span class="text-red-600 font-bold text-lg">${(receipt.amounts?.remainingAmount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></p>
                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:</strong> ${receipt.saleType === 'installment' ? '‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô' : '‡∏Ç‡∏≤‡∏¢‡∏™‡∏î'}</p>
              </div>
            </div>
          </div>
        `;

        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
        const contentArea = document.querySelector('.container-fluid') || document.querySelector('main');
        if (contentArea) {
          const infoDiv = document.createElement('div');
          infoDiv.innerHTML = customerInfo;
          infoDiv.className = 'deposit-receipt-info';
          contentArea.insertBefore(infoDiv, contentArea.firstChild);
        }
      }

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
      fillCustomerForm(receipt.customer);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    function fillCustomerForm(customer) {
      if (!customer) {
        console.log('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
        return;
      }

      console.log('üìù ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥:', customer);

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
      const customerTypeField = document.getElementById('customerType');
      if (customerTypeField) {
        customerTypeField.value = 'individual';
        customerTypeField.dispatchEvent(new Event('change')); // Trigger change event
        console.log('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤');
      }

      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      setTimeout(() => {
        // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏≤‡∏Å customer.name
        const fullName = customer.name || '';
        const nameParts = fullName.trim().split(' ');
        let firstName = '', lastName = '';

        if (nameParts.length >= 2) {
          firstName = nameParts[0];
          lastName = nameParts.slice(1).join(' ');
        } else if (nameParts.length === 1) {
          firstName = nameParts[0];
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const fields = {
          'customerFirstName': firstName,
          'customerLastName': lastName,
          'customerPhone': customer.phone,
          'customerTaxId': customer.idCard || customer.taxId,
          'customerEmailPersonal': customer.email
        };

        Object.entries(fields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
            console.log(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${fieldId}: ${value}`);
          } else if (!field) {
            console.log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå ${fieldId}`);
          }
        });

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏≤‡∏Å‡∏°‡∏µ
        if (customer.address) {
          const addressField = document.getElementById('customerAddress');
          if (addressField) {
            let fullAddress = '';
            if (typeof customer.address === 'string') {
              fullAddress = customer.address;
            } else if (customer.address.fullAddress) {
              fullAddress = customer.address.fullAddress;
            } else {
              // ‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å object
              const addr = customer.address;
              fullAddress = [addr.street, addr.subdistrict, addr.district, addr.province, addr.zipcode]
                .filter(Boolean).join(' ');
            }
            addressField.value = fullAddress;
            console.log(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${fullAddress}`);
          }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÉ‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
        const additionalFields = {
          'customerPrefix': customer.prefix,
          'customerGender': customer.gender,
          'customerAge': customer.age,
          'customerBirthDate': customer.birthDate ? new Date(customer.birthDate).toISOString().split('T')[0] : null // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô yyyy-MM-dd
        };

        Object.entries(additionalFields).forEach(([fieldId, value]) => {
          if (value) {
            const field = document.getElementById(fieldId);
            if (field) {
              field.value = value;
              console.log(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${fieldId}: ${value}`);

              // Trigger change event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö customerPrefix ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ auto-fill ‡πÄ‡∏û‡∏®
              if (fieldId === 'customerPrefix') {
                field.dispatchEvent(new Event('change'));
              }
            } else {
              console.log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå ${fieldId}`);
            }
          }
        });

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏≤‡∏Å‡∏°‡∏µ
        if (customer.address && typeof customer.address === 'object' && customer.address.houseNo) {
          const addressFields = {
            'houseNo': customer.address.houseNo,
            'moo': customer.address.moo,
            'subDistrict': customer.address.subDistrict,
            'district': customer.address.district,
            'province': customer.address.province,
            'zipcode': customer.address.zipcode
          };

          Object.entries(addressFields).forEach(([fieldId, value]) => {
            if (value) {
              const field = document.getElementById(fieldId);
              if (field) {
                field.value = value;
                console.log(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ${fieldId}: ${value}`);
              }
            }
          });
        }

        console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
      }, 100); // ‡∏£‡∏≠ 100ms ‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    async function autoAddPreSelectedProduct() {
      if (!preSelectedProductId || !fromDepositReceipt) return;

      console.log('üõí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤:', preSelectedProductId);

      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ approvedStocks ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
      let attempts = 0;
      while ((!approvedStocks || approvedStocks.length === 0) && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (approvedStocks.length === 0) {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
        return;
      }

      // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å branchStockId ‡∏´‡∏£‡∏∑‡∏≠ product_id
      let product = approvedStocks.find(item => item._id === preSelectedProductId);

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å product_id
      if (!product) {
        product = approvedStocks.find(item =>
          item.product_id?._id === preSelectedProductId ||
          item.product_id === preSelectedProductId
        );
        if (product) {
          console.log('‚úÖ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å product_id:', product);
        }
      }

      if (product) {
        console.log('‚úÖ ‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:', product);

        try {
          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart
          const id = product._id || product.id;
          const name = product.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
          const price = product.price || 0;
          const imei = product.imei || '';
          const taxType = product.taxType || 'inclusive';
          const model = product.model || '';
          const poNumber = product.poNumber || '';
          const supplier = product.supplier || '';

          console.log('üõí Parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö addToCart:', {
            id, name, price, imei, taxType, model, poNumber, supplier
          });

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏™‡πà‡∏á parameters ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß)
          if (typeof addToCart === 'function') {
            addToCart(id, name, price, imei, taxType, model, poNumber, supplier);
          } else {
            console.error('‚ùå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart ‡πÑ‡∏°‡πà‡∏û‡∏ö');
          }

          // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          if (typeof showToast === 'function') {
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${product.name}" ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, 'success');
          }
        } catch (error) {
          console.error('‚ùå Error adding product to cart:', error);
          if (typeof showToast === 'function') {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á', 'error');
          }
        }
      } else {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏:', preSelectedProductId);
        console.warn('üìã Debug - Available stocks:', {
          totalStocks: approvedStocks.length,
          allStockIds: approvedStocks.map(s => ({
            _id: s._id,
            product_id: s.product_id?._id || s.product_id,
            name: s.name,
            imei: s.imei
          })),
          searchingFor: preSelectedProductId
        });

        // Debug: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
        const depositProductData = window.selectedProductData || depositReceiptData?.product;
        if (depositProductData) {
          console.warn('üîç Searching by product name from deposit:', depositProductData.name);
          const similarProducts = approvedStocks.filter(s =>
            s.name === depositProductData.name ||
            s.product_id?.name === depositProductData.name
          );
          console.warn('üîç Products with same name:', similarProducts.map(p => ({
            _id: p._id,
            product_id: p.product_id?._id || p.product_id,
            name: p.name,
            imei: p.imei
          })));
        }

        if (typeof showToast === 'function') {
          showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á', 'warning');
        }
      }
    }

    const API_ROOT = '/api';

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó localStorage ‡πÅ‡∏•‡∏∞ title
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `POS - ${decodeURIComponent(urlParams.get('name'))}`;
    }

    let cartItems = [];
    let staffName = 'Guest';
    let approvedStocks = [];   // ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà verified=true
    let activePromotions = []; // ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà active

    // ========== HELPER FUNCTIONS FOR PRODUCT CATEGORIZATION ==========
    // Helper functions for data transformation (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô step1.html)
    function extractBrand(productName) {
      if (!productName) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå';
    
      const brandKeywords = {
        'iPhone': 'Apple',
        'iPad': 'Apple',
        'MacBook': 'Apple',
        'AirPods': 'Apple',
        'Samsung': 'Samsung',
        'Galaxy': 'Samsung',
        'Huawei': 'Huawei',
        'Xiaomi': 'Xiaomi',
        'Oppo': 'Oppo',
        'Vivo': 'Vivo',
        'Realme': 'Realme',
        'OnePlus': 'OnePlus'
      };
    
      for (const [keyword, brand] of Object.entries(brandKeywords)) {
        if (productName.toLowerCase().includes(keyword.toLowerCase())) {
          return brand;
        }
      }
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
      const firstWord = productName.split(' ')[0];
      return firstWord || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå';
    }
    
    function extractProductName(productName) {
      if (!productName) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    
      const productKeywords = [
        'iPhone', 'iPad', 'MacBook', 'AirPods', 'Apple Watch', 'iMac', 'Mac', 'iPod',
        'Galaxy', 'Samsung', 'Note',
        'Huawei', 'Honor', 'Nova', 'Mate', 'P Series',
        'Xiaomi', 'Redmi', 'Mi', 'POCO',
        'Oppo', 'Find', 'Reno', 'A Series',
        'Vivo', 'X Series', 'Y Series', 'V Series',
        'Realme', 'OnePlus'
      ];
    
      const name = productName.toLowerCase();
    
      for (const keyword of productKeywords) {
        if (name.includes(keyword.toLowerCase())) {
          return keyword;
        }
      }
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å
      const words = productName.split(' ');
      if (words.length >= 2) {
        return words.slice(0, 2).join(' ');
      }
    
      return words[0] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    }
    
    function determineCategory(productName, productType, categoryGroup) {
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö categoryGroup ‡∏à‡∏≤‡∏Å API ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
      if (categoryGroup && categoryGroup.name) {
        return categoryGroup.name;
      }
    
      // ‚úÖ Fallback: ‡πÉ‡∏ä‡πâ productType ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (productType === 'mobile') return '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï';
      if (productType === 'accessory') return '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°';
      if (productType === 'boxset') return '‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      if (productType === 'gift') return '‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°';
    
      // ‚úÖ Enhanced keyword matching ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback)
      if (!productName) return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    
      const name = productName.toLowerCase();
    
      // ‡∏Ç‡∏¢‡∏≤‡∏¢ keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
      if (name.includes('iphone') || name.includes('samsung') || name.includes('galaxy') ||
          name.includes('huawei') || name.includes('xiaomi') || name.includes('oppo') ||
          name.includes('vivo') || name.includes('phone') || name.includes('‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠') ||
          name.includes('realme') || name.includes('oneplus') || name.includes('nokia')) {
        return '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠';
      }
    
      // ‡∏Ç‡∏¢‡∏≤‡∏¢ keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï
      if (name.includes('ipad') || name.includes('tablet') || name.includes('‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï')) {
        return '‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï';
      }
    
      // ‡∏Ç‡∏¢‡∏≤‡∏¢ keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå
      if (name.includes('macbook') || name.includes('laptop') || name.includes('‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå') ||
          name.includes('notebook') || name.includes('computer') || name.includes('pc')) {
        return '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå';
      }
    
      // ‡∏Ç‡∏¢‡∏≤‡∏¢ keyword ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°
      if (name.includes('airpods') || name.includes('headphone') || name.includes('earphone') ||
          name.includes('case') || name.includes('charger') || name.includes('‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à') ||
          name.includes('‡∏´‡∏π‡∏ü‡∏±‡∏á') || name.includes('‡πÄ‡∏Ñ‡∏™') || name.includes('powerbank') ||
          name.includes('cable') || name.includes('adapter') || name.includes('stand') ||
          name.includes('screen protector') || name.includes('‡∏ü‡∏¥‡∏•‡πå‡∏°')) {
        return '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°';
      }
    
      return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    }

    function getCategoryIcon(category) {
      const icons = {
        '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠': 'phone',
        '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï': 'phone',
        '‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï': 'tablet',
        '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': 'laptop',
        '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'headphones',
        '‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': 'boxes',
        '‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°': 'gift',
        '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'box'
      };
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô mapping ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô
      if (!icons[category] && category) {
        const lowerCategory = category.toLowerCase();
        if (lowerCategory.includes('‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠') || lowerCategory.includes('phone')) return 'phone';
        if (lowerCategory.includes('‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï') || lowerCategory.includes('tablet')) return 'tablet';
        if (lowerCategory.includes('‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå') || lowerCategory.includes('laptop') || lowerCategory.includes('computer')) return 'laptop';
        if (lowerCategory.includes('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå') || lowerCategory.includes('accessory')) return 'headphones';
        if (lowerCategory.includes('‡∏ä‡∏∏‡∏î') || lowerCategory.includes('boxset')) return 'boxes';
        if (lowerCategory.includes('‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°') || lowerCategory.includes('gift')) return 'gift';
      }
    
      return icons[category] || 'box';
    }

    function getProductIcon(productName) {
      const icons = {
        'iPhone': 'phone',
        'iPad': 'tablet',
        'MacBook': 'laptop',
        'Mac': 'laptop',
        'iMac': 'pc-display',
        'AirPods': 'headphones',
        'Apple Watch': 'smartwatch',
        'Galaxy': 'phone',
        'Samsung': 'phone',
        'Note': 'phone',
        'Huawei': 'phone',
        'Honor': 'phone',
        'Nova': 'phone',
        'Mate': 'phone',
        'P Series': 'phone',
        'Xiaomi': 'phone',
        'Redmi': 'phone',
        'Mi': 'phone',
        'POCO': 'phone',
        'Oppo': 'phone',
        'Find': 'phone',
        'Reno': 'phone',
        'A Series': 'phone',
        'Vivo': 'phone',
        'X Series': 'phone',
        'Y Series': 'phone',
        'V Series': 'phone',
        'Realme': 'phone',
        'OnePlus': 'phone'
      };
      return icons[productName] || 'phone';
    }

    // üîí Security & Audit Variables
    let sessionId = generateSessionId();
    let auditBuffer = [];
    let lastActionTime = Date.now();
    let actionCount = 0;
    let deviceFingerprint = null;

    // üîê Security Functions
    function generateSessionId() {
      return 'POS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getDeviceFingerprint() {
      if (deviceFingerprint) return deviceFingerprint;

      deviceFingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        cookieEnabled: navigator.cookieEnabled,
        timestamp: Date.now()
      };

      return deviceFingerprint;
    }

          // Show loading overlay
          // üîç Enhanced Audit Logger
    function logAuditEvent(action, details = {}, level = 'INFO') {
      const auditEvent = {
        id: generateAuditId(),
        sessionId: sessionId,
        timestamp: new Date().toISOString(),
        action: action,
        level: level,
        userId: localStorage.getItem('userId') || 'unknown',
        userName: localStorage.getItem('userName') || staffName || 'Guest',
        branchCode: BRANCH_CODE,
        ipAddress: 'client-side', // ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å server
        deviceInfo: getDeviceFingerprint(),
        details: {
          ...details,
          url: window.location.href,
          cartCount: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0)
        }
      };

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô buffer
      auditBuffer.push(auditEvent);

      // ‡∏™‡πà‡∏á‡πÑ‡∏õ server ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ batch ‡∏ó‡∏∏‡∏Å 5 events
      if (auditBuffer.length >= 5 || level === 'ERROR' || level === 'CRITICAL') {
        flushAuditBuffer();
      }

      console.log('üîç Audit:', auditEvent);
    }

    function generateAuditId() {
      return 'AUDIT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    }

    // üì§ Send Audit Events to Server
    async function flushAuditBuffer() {
      if (auditBuffer.length === 0) return;

      const events = [...auditBuffer];
      auditBuffer = [];

      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken') || '';
    
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡πÉ‡∏´‡πâ log ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ server
        if (!token) {
          console.warn('‚ö†Ô∏è No auth token available, audit events stored locally only');
          return;
        }

        const response = await fetch('/api/audit/log-events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ events })
        });

        if (!response.ok) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 401 ‡πÉ‡∏´‡πâ‡∏•‡∏ö token ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
          if (response.status === 401) {
            console.warn('‚ö†Ô∏è Auth token expired, removing invalid token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('accessToken');
            return; // ‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô events ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô buffer ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
          }
    
          console.error('‚ùå Failed to send audit events:', response.status);
          // ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
          auditBuffer.unshift(...events);
        }
      } catch (error) {
        console.error('‚ùå Audit logging error:', error);
        // ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô buffer
        auditBuffer.unshift(...events);
      }
    }

    // üõ°Ô∏è Rate Limiting
    function checkRateLimit(action, maxActions = 10, timeWindow = 60000) {
      const now = Date.now();
      const key = `rateLimit_${action}`;

      let actionLog = JSON.parse(localStorage.getItem(key) || '[]');
      actionLog = actionLog.filter(time => now - time < timeWindow);

      if (actionLog.length >= maxActions) {
        logAuditEvent('RATE_LIMIT_EXCEEDED', { action, count: actionLog.length }, 'WARNING');
        return false;
      }

      actionLog.push(now);
      localStorage.setItem(key, JSON.stringify(actionLog));
      return true;
    }

    // üîí Input Sanitization
    function sanitizeInput(input, type = 'text') {
      if (!input) return '';

      let sanitized = input.toString().trim();

      switch (type) {
        case 'taxId':
          sanitized = sanitized.replace(/[^0-9]/g, '').substring(0, 13);
          break;
        case 'phone':
          sanitized = sanitized.replace(/[^0-9-+]/g, '').substring(0, 20);
          break;
        case 'number':
          sanitized = sanitized.replace(/[^0-9.]/g, '');
          break;
        case 'text':
          sanitized = sanitized.replace(/[<>\"']/g, '');
          break;
      }

      return sanitized;
    }

    // üéÅ Referral Code Validation
    async function validateReferralCode(input) {
      const value = input.value.trim();
      const statusElement = document.getElementById('referralStatus');
    
      if (!value) {
        if (statusElement) {
          statusElement.classList.add('hidden');
        }
        return true;
      }
    
      try {
        // Show loading
        if (statusElement) {
          SecurityHelpers.safeSetHTML(statusElement, '<i class="bi bi-hourglass-split text-blue-500"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', true);
          statusElement.className = 'text-xs mt-1 text-blue-600';
          statusElement.classList.remove('hidden');
        }
    
        // Check if referral code exists
        const response = await fetch(`/api/points/members/search?q=${encodeURIComponent(value)}`);
        const result = await response.json();
    
        if (result.success && result.data.length > 0) {
          const referrer = result.data.find(member => member.memberCode === value);
    
          if (referrer) {
            if (statusElement) {
              // Safely create referrer status with proper sanitization
              SecurityHelpers.safeSetContent(statusElement, '', '');

              const icon = document.createElement('i');
              icon.className = 'bi bi-check-circle text-green-500';

              const text = document.createTextNode(` ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${referrer.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} (${referrer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'})`);

              statusElement.appendChild(icon);
              statusElement.appendChild(text);
              statusElement.className = 'text-xs mt-1 text-green-600';
              statusElement.classList.remove('hidden');
            }
            return true;
          }
        }
    
        // Invalid referral code
        if (statusElement) {
          SecurityHelpers.safeSetHTML(statusElement, '<i class="bi bi-x-circle text-red-500"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', true);
          statusElement.className = 'text-xs mt-1 text-red-500';
          statusElement.classList.remove('hidden');
        }
        return false;
    
      } catch (error) {
        console.error('Error validating referral code:', error);
        if (statusElement) {
          statusElement.innerHTML = '<i class="bi bi-exclamation-triangle text-yellow-500"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ';
          statusElement.className = 'text-xs mt-1 text-yellow-600';
          statusElement.classList.remove('hidden');
        }
        return true; // Allow form to proceed even if validation fails
      }
    }

    // üîê Session Management
    function validateSession() {
      const token = localStorage.getItem('authToken');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        logAuditEvent('SESSION_INVALID', {}, 'WARNING');
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
        setTimeout(() => window.location.href = '/login', 2000);
        return false;
      }

      return true;
    }

    // üîí Transaction Lock
    const transactionLocks = new Set();

    function acquireTransactionLock(lockId) {
      if (transactionLocks.has(lockId)) {
        logAuditEvent('TRANSACTION_LOCK_CONFLICT', { lockId }, 'WARNING');
        return false;
      }
      transactionLocks.add(lockId);
      return true;
    }

    function releaseTransactionLock(lockId) {
      transactionLocks.delete(lockId);
    }

    // -----------------------------
    // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å (cash) ‡πÅ‡∏•‡∏∞ boxsets ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á Level 1
    // -----------------------------
    // üìù Loading state management
    let isLoadingStocks = false; // Flag to prevent duplicate loading
    
    // Helper function to safely reload stocks
    function safeReloadStocks() {
      if (typeof loadApprovedStocks === 'function' && !isLoadingStocks) {
        return loadApprovedStocks().then(() => {
          if (typeof loadLevel1 === 'function') {
            loadLevel1();
          }
        });
      } else {
        console.log('‚ö†Ô∏è loadApprovedStocks skipped - already loading');
        return Promise.resolve();
      }
    }
    
    // Performance optimization: Cache mechanism for stocks
    let stocksCache = {
      data: null,
      timestamp: null,
      ttl: 5 * 60 * 1000, // 5 minutes cache TTL
      isValid() {
        return this.data && this.timestamp && (Date.now() - this.timestamp < this.ttl);
      },
      set(data) {
        this.data = data;
        this.timestamp = Date.now();
      },
      clear() {
        this.data = null;
        this.timestamp = null;
      }
    };

    // Performance optimization: Pagination configuration
    const STOCK_PAGINATION = {
      pageSize: 500, // Load 500 items at a time
      initialLoad: 250, // Load first 250 items immediately
      batchSize: 100 // Process in batches of 100 for filtering
    };

    /**
     * Performance optimization: Process large arrays in batches to prevent UI blocking
     * @param {Array} data - Array to process
     * @param {Function} filterFn - Filter function to apply
     * @returns {Promise<Array>} - Filtered results
     */
    async function processBatchFiltering(data, filterFn) {
      const results = [];
      const batchSize = STOCK_PAGINATION.batchSize;

      for (let i = 0; i < data.length; i += batchSize) {
        const batch = data.slice(i, i + batchSize);
        const batchResults = batch.filter(filterFn);
        results.push(...batchResults);

        // Yield control to prevent UI blocking
        if (i % (batchSize * 2) === 0) {
          await new Promise(resolve => setTimeout(resolve, 1));
        }
      }

      return results;
    }

    /**
     * Security helper functions to prevent XSS attacks
     */
    const SecurityHelpers = {
      /**
       * Sanitize text content to prevent XSS
       * @param {string} text - Text to sanitize
       * @returns {string} - Sanitized text
       */
      sanitizeText(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/[<>&"']/g, function(match) {
          const escapeChars = {
            '<': '&lt;',
            '>': '&gt;',
            '&': '&amp;',
            '"': '&quot;',
            "'": '&#39;'
          };
          return escapeChars[match];
        });
      },

      /**
       * Create safe text node
       * @param {string} text - Text content
       * @returns {Text} - Text node
       */
      createTextNode(text) {
        return document.createTextNode(text || '');
      },

      /**
       * Safely set innerHTML by creating elements
       * @param {HTMLElement} element - Target element
       * @param {string} className - CSS class name
       * @param {string} textContent - Text content
       */
      safeSetContent(element, className, textContent) {
        if (!element) return;
        // Clear element safely without innerHTML
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }
        if (className) element.className = className;
        if (textContent) element.appendChild(this.createTextNode(textContent));
      },

      /**
       * Safely set HTML content for trusted sources only
       * @param {HTMLElement} element - Target element
       * @param {string} htmlContent - HTML content (must be trusted)
       * @param {boolean} isTrusted - Flag to confirm content is trusted
       */
      safeSetHTML(element, htmlContent, isTrusted = false) {
        if (!element) return;
        if (!isTrusted) {
          console.warn('‚ö†Ô∏è Using safeSetHTML without trusted flag, falling back to text content');
          this.safeSetContent(element, '', htmlContent);
          return;
        }
        // Clear element safely
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }
        element.innerHTML = htmlContent;
      },

      /**
       * Create element safely with attributes
       * @param {string} tagName - HTML tag name
       * @param {Object} attributes - Attributes to set
       * @param {string|Node} content - Text content or child node
       * @returns {HTMLElement} - Created element
       */
      createElement(tagName, attributes = {}, content = '') {
        const element = document.createElement(tagName);

        // Set attributes safely
        for (const [key, value] of Object.entries(attributes)) {
          if (key === 'className' || key === 'class') {
            element.className = this.sanitizeText(value);
          } else if (key === 'id') {
            element.id = this.sanitizeText(value);
          } else if (key.startsWith('data-')) {
            element.setAttribute(key, this.sanitizeText(value));
          } else if (['src', 'href', 'action'].includes(key)) {
            // URL attributes need special validation
            if (this.isValidURL(value)) {
              element.setAttribute(key, value);
            }
          } else {
            element.setAttribute(key, this.sanitizeText(value));
          }
        }

        // Set content safely
        if (typeof content === 'string') {
          element.appendChild(this.createTextNode(content));
        } else if (content instanceof Node) {
          element.appendChild(content);
        }

        return element;
      },

      /**
       * Validate URL to prevent javascript: and other dangerous protocols
       * @param {string} url - URL to validate
       * @returns {boolean} - True if URL is safe
       */
      isValidURL(url) {
        if (!url || typeof url !== 'string') return false;
        const sanitized = url.trim().toLowerCase();
        const dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:', 'about:'];
        return !dangerousProtocols.some(protocol => sanitized.startsWith(protocol));
      },

      /**
       * Validate and sanitize numeric input
       * @param {any} value - Value to validate
       * @param {number} defaultValue - Default value if invalid
       * @returns {number} - Sanitized number
       */
      sanitizeNumber(value, defaultValue = 0) {
        const num = parseFloat(value);
        return isNaN(num) ? defaultValue : num;
      },

      /**
       * Validate Thai National ID
       * @param {string} id - Thai National ID to validate
       * @returns {boolean} - True if valid
       */
      validateThaiID(id) {
        if (!id || typeof id !== 'string') return false;

        // Remove all non-digits
        const cleanId = id.replace(/\D/g, '');

        // Must be exactly 13 digits
        if (cleanId.length !== 13) return false;

        // Calculate checksum using Thai ID algorithm
        let sum = 0;
        for (let i = 0; i < 12; i++) {
          sum += parseInt(cleanId.charAt(i)) * (13 - i);
        }

        const checkDigit = (11 - (sum % 11)) % 10;
        return checkDigit === parseInt(cleanId.charAt(12));
      },

      /**
       * Validate email format
       * @param {string} email - Email to validate
       * @returns {boolean} - True if valid
       */
      validateEmail(email) {
        if (!email || typeof email !== 'string') return false;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
      },

      /**
       * Validate Thai phone number
       * @param {string} phone - Phone number to validate
       * @returns {boolean} - True if valid
       */
      validateThaiPhone(phone) {
        if (!phone || typeof phone !== 'string') return false;
        const cleanPhone = phone.replace(/\D/g, '');

        // Thai mobile: 10 digits starting with 0[6-9]
        // Thai landline: 9-10 digits starting with 0[2-7]
        const mobileRegex = /^0[6-9]\d{8}$/;
        const landlineRegex = /^0[2-7]\d{7,8}$/;

        return mobileRegex.test(cleanPhone) || landlineRegex.test(cleanPhone);
      },

      /**
       * Sanitize and validate currency amount
       * @param {any} amount - Amount to validate
       * @param {number} maxDecimals - Maximum decimal places
       * @returns {number} - Validated amount
       */
      validateCurrency(amount, maxDecimals = 2) {
        const num = parseFloat(amount);
        if (isNaN(num) || num < 0) return 0;

        const multiplier = Math.pow(10, maxDecimals);
        return Math.round(num * multiplier) / multiplier;
      },

      /**
       * Validate and sanitize product code/SKU
       * @param {string} code - Product code to validate
       * @returns {string|null} - Sanitized code or null if invalid
       */
      validateProductCode(code) {
        if (!code || typeof code !== 'string') return null;

        // Allow alphanumeric, hyphens, underscores, and dots
        const sanitized = code.trim().replace(/[^a-zA-Z0-9\-_\.]/g, '');

        // Must be between 1 and 50 characters
        return (sanitized.length >= 1 && sanitized.length <= 50) ? sanitized : null;
      },

      /**
       * Validate date input
       * @param {string|Date} date - Date to validate
       * @returns {Date|null} - Valid Date object or null
       */
      validateDate(date) {
        if (!date) return null;

        const dateObj = date instanceof Date ? date : new Date(date);

        // Check if date is valid and not in the future beyond reasonable bounds
        const now = new Date();
        const maxFutureDate = new Date(now.getFullYear() + 10, 11, 31);
        const minPastDate = new Date(1900, 0, 1);

        if (isNaN(dateObj.getTime()) ||
            dateObj > maxFutureDate ||
            dateObj < minPastDate) {
          return null;
        }

        return dateObj;
      }
    };

    async function loadApprovedStocks(forceReload = false) {
      // Prevent duplicate loading
      if (isLoadingStocks) {
        console.log('‚ö†Ô∏è loadApprovedStocks already running, skipping...');
        return;
      }

      // Check cache first (unless forced reload)
      if (!forceReload && stocksCache.isValid()) {
        console.log('‚úÖ Using cached stock data');
        approvedStocks = stocksCache.data;

        logAuditEvent('LOAD_STOCKS_FROM_CACHE', {
          branchCode: BRANCH_CODE,
          stockCount: approvedStocks.length,
          cacheAge: Date.now() - stocksCache.timestamp
        }, 'INFO');

        return;
      }

      isLoadingStocks = true;
    
      try {
        // üîç Audit Log - Loading stocks
        logAuditEvent('LOAD_STOCKS_START', {
          branchCode: BRANCH_CODE,
          stockType: 'cash',
          requestType: 'approved_stocks_and_boxsets'
        }, 'INFO');

        console.log('üîÑ Loading approved stocks and boxsets...');
        console.log('üè¢ Current BRANCH_CODE:', BRANCH_CODE);
        console.log('üîë localStorage branchCode:', localStorage.getItem('branchCode'));
        const token = localStorage.getItem('authToken') || '';
    
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥
        const stockUrl = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}&verified=true&purchaseType=cash`;
        console.log('üì° Stock API URL:', stockUrl);

        const stockJs = await safeFetch(stockUrl, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 15000,
          maxRetries: 2
        });

        console.log('üìä Stock API Response:', stockJs);

        let regularStocks = [];
        if (stockJs && stockJs.success) {
          console.log('üìã Raw stock data from API:', stockJs.data.length, 'items');
          console.log('üîç Sample raw stock items:', stockJs.data.slice(0, 3));

          // Performance optimization: Batch process filtering for large datasets
          console.log('üöÄ Processing stock data with batch filtering for performance...');
          regularStocks = await processBatchFiltering(stockJs.data, (item) => {
            const hasStock = item.stock_value > 0;
            const isVerified = item.verified === true;

            // Reduced logging for performance - only log first few items
            if (regularStocks.length < 3) {
              console.log(`üîç Filtering stock item "${item.name}":`, {
                _id: item._id,
                purchaseType: item.purchaseType,
                stock_value: item.stock_value,
                hasStock,
                verified: item.verified,
                isVerified,
                passesFilter: hasStock && isVerified
              });
            }

            // Store original stock value for calculations
            if (hasStock && isVerified) {
              item.originalStockValue = item.stock_value;
            }

            return hasStock && isVerified;
          });
        } else {
          console.log('‚ùå Stock API Error:', stockJs);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• boxsets ‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡∏°‡πà
        const boxsetUrl = `${API_ROOT}/branch-stock/boxset/${currentBranchCode}`;
        console.log('üì° Boxset API URL:', boxsetUrl);

        const boxsetJs = await safeFetch(boxsetUrl, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 15000,
          maxRetries: 2
        });

        console.log('üìä Boxset API Response:', boxsetJs);

        let boxsets = [];
        if (boxsetJs && boxsetJs.success) {
          console.log('üìã Raw boxset data from API:', boxsetJs.data.length, 'items');
    
          // Performance optimization: Batch process boxsets filtering
          console.log('üöÄ Processing boxset data with batch filtering for performance...');
          boxsets = await processBatchFiltering(boxsetJs.data, (item) => {
            const hasCashSale = item.saleTypes && item.saleTypes.includes('cash');
            const hasStock = item.stock_value > 0;
            const isActive = item.status === 'active';

            // Reduced logging for performance - only log first few items
            if (boxsets.length < 3) {
              console.log(`üîç Filtering boxset item "${item.name}":`, {
                _id: item._id,
                saleTypes: item.saleTypes,
                stock_value: item.stock_value,
                status: item.status,
                hasCashSale,
                hasStock,
                isActive,
                passesFilter: hasCashSale && hasStock && isActive
              });
            }

            // Transform boxset format to match stock item for cash sale system
            if (hasCashSale && hasStock && isActive) {
              item.price = item.boxsetPrice;
              item.cost = item.totalCost;
              item.originalStockValue = item.stock_value;
              item.verified = true;
              item.productType = 'boxset';
              item.brand = 'Boxset';
              item.model = 'Standard';
              item.taxType = item.taxType || 'include';
              item.poNumber = '';
              item.supplier = '';
            }

            return hasCashSale && hasStock && isActive;
          });
    
          console.log('üì¶ Filtered boxsets:', boxsets.length, 'items');
          console.log('üîç Sample boxsets:', boxsets.slice(0, 3));
    
          // Remove duplicates based on _id to prevent duplicate display
          const uniqueBoxsets = [];
          const seenIds = new Set();
    
          boxsets.forEach(boxset => {
            if (!seenIds.has(boxset._id)) {
              seenIds.add(boxset._id);
              uniqueBoxsets.push(boxset);
            } else {
              console.log(`‚ö†Ô∏è Duplicate boxset detected and removed: ${boxset.name} (ID: ${boxset._id})`);
            }
          });
    
          boxsets = uniqueBoxsets;
          console.log('‚úÖ After duplicate removal:', boxsets.length, 'unique boxsets');
    
          // Debug: ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• boxset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          boxsets.forEach((boxset, index) => {
            console.log(`üéÅ Boxset ${index + 1} (${boxset.name}) structure:`, {
              _id: boxset._id,
              name: boxset.name,
              selectedProducts: boxset.selectedProducts,
              products: boxset.products,
              productList: boxset.productList,
              items: boxset.items,
              allKeys: Object.keys(boxset)
            });
    
            // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô boxset
            if (boxset.selectedProducts && Array.isArray(boxset.selectedProducts)) {
              console.log(`üìã Boxset "${boxset.name}" has selectedProducts:`, boxset.selectedProducts);
              boxset.selectedProducts.forEach((product, idx) => {
                console.log(`  - Product ${idx + 1}:`, {
                  name: product.name,
                  productName: product.productName,
                  quantity: product.quantity,
                  price: product.price,
                  allKeys: Object.keys(product)
                });
              });
            } else {
              console.log(`‚ö†Ô∏è Boxset "${boxset.name}" has NO selectedProducts or not an array`);
            }
    
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö field ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            ['products', 'productList', 'items'].forEach(field => {
              if (boxset[field]) {
                console.log(`üìã Boxset "${boxset.name}" has ${field}:`, boxset[field]);
              }
            });
          });
        } else {
          console.log('‚ùå Boxset API Error:', boxsetRes.status, boxsetJs);
        }

        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• stocks ‡πÅ‡∏•‡∏∞ boxsets with duplicate prevention
        const combinedStocks = [...regularStocks, ...boxsets];
    
        // Remove duplicates from final combined stocks based on _id
        const uniqueStocks = [];
        const seenStockIds = new Set();
    
        combinedStocks.forEach(item => {
          if (!seenStockIds.has(item._id)) {
            seenStockIds.add(item._id);
            uniqueStocks.push(item);
          } else {
            console.log(`‚ö†Ô∏è Duplicate stock item detected and removed: ${item.name} (ID: ${item._id})`);
          }
        });
    
        approvedStocks = uniqueStocks;

        // Performance optimization: Cache the processed data
        stocksCache.set(approvedStocks);

        console.log('‚úÖ Total approved stocks after filtering:', approvedStocks.length, 'items');
        console.log('üì¶ Regular stocks:', regularStocks.length, 'items');
        console.log('üì¶ Boxsets:', boxsets.length, 'items');
        console.log('üì¶ Combined data sample:', approvedStocks.slice(0, 3));
        console.log('üíæ Stock data cached for performance');

        // üîç Audit Log - Loading success
        logAuditEvent('LOAD_STOCKS_SUCCESS', {
          branchCode: BRANCH_CODE,
          stockCount: approvedStocks.length,
          regularStocksCount: regularStocks.length,
          boxsetsCount: boxsets.length,
          loadDuration: Date.now() - lastActionTime,
          cacheUpdated: true
        }, 'SUCCESS');

        // üß™ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô development)
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
          if (!document.getElementById('debugStockBtn')) {
            const debugBtn = document.createElement('button');
            debugBtn.id = 'debugStockBtn';
            debugBtn.textContent = 'üß™ Debug Stock Data';
            debugBtn.className = 'fixed top-2 right-2 z-50 bg-red-500 text-white px-3 py-1 rounded text-sm';
            debugBtn.onclick = () => {
              logAuditEvent('DEBUG_BUTTON_CLICKED', {
                branchCode: BRANCH_CODE,
                stockCount: approvedStocks.length
              }, 'INFO');
              console.log('=== STOCK DEBUG INFO ===');
              console.log('BRANCH_CODE:', BRANCH_CODE);
              console.log('approvedStocks.length:', approvedStocks.length);
              console.log('All approvedStocks:', approvedStocks);
              alert(`BRANCH_CODE: ${BRANCH_CODE}\nStock Count: ${approvedStocks.length}\nCheck console for details`);
            };
            document.body.appendChild(debugBtn);
          }
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Loading
          if (!document.getElementById('debugLoadingBtn')) {
            const loadingBtn = document.createElement('button');
            loadingBtn.id = 'debugLoadingBtn';
            loadingBtn.textContent = 'üîÑ Test Loading';
            loadingBtn.className = 'fixed top-2 right-40 z-50 bg-blue-500 text-white px-3 py-1 rounded text-sm';
            loadingBtn.onclick = () => {
              console.log('üîÑ Testing Loading...');
              showLoading(true);
              console.log('‚úÖ Test loading shown');

              // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
              setTimeout(() => {
                showLoading(false);
                console.log('‚úÖ Test loading hidden');
              }, 3000);
            };
            document.body.appendChild(loadingBtn);
          }

          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          if (!document.getElementById('debugStaffBtn')) {
            const staffBtn = document.createElement('button');
            staffBtn.id = 'debugStaffBtn';
            staffBtn.textContent = 'üë§ Debug Staff';
            staffBtn.className = 'fixed top-2 right-80 z-50 bg-green-500 text-white px-3 py-1 rounded text-sm';
            staffBtn.onclick = () => {
              const staffInfo = {
                globalStaffName: staffName,
                userNameFromStorage: localStorage.getItem('userName'),
                userIdFromStorage: localStorage.getItem('userId'),
                staffNameFromStorage: localStorage.getItem('staffName'),
                authToken: localStorage.getItem('authToken') ? 'Present' : 'Missing'
              };
    
              console.log('=== STAFF DEBUG INFO ===');
              console.log('Staff Info:', staffInfo);
    
              let message = 'üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:\n\n';
              message += `‡∏ä‡∏∑‡πà‡∏≠ (Global): ${staffInfo.globalStaffName}\n`;
              message += `‡∏ä‡∏∑‡πà‡∏≠ (localStorage): ${staffInfo.userNameFromStorage}\n`;
              message += `User ID: ${staffInfo.userIdFromStorage}\n`;
              message += `Auth Token: ${staffInfo.authToken}\n\n`;
    
              if (staffInfo.globalStaffName === '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' || staffInfo.globalStaffName === 'Guest') {
                message += '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ default!\n\n';
                message += '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á';
              } else {
                message += '‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
              }
    
              const result = confirm(message + '\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
              if (result) {
                console.log('üîÑ Reloading employee profile...');
                loadEmployeeProfile();
              }
            };
            document.body.appendChild(staffBtn);
          }
        }
      } catch (err) {
        console.error('‚ùå loadApprovedStocks error:', err);
        logAuditEvent('LOAD_STOCKS_FAILED', {
          branchCode: BRANCH_CODE,
          error: err.message,
          stack: err.stack
        }, 'ERROR');
        approvedStocks = [];
      } finally {
        // Reset loading flag
        isLoadingStocks = false;
      }
    }

    // (1) ‡πÅ‡∏Å‡πâ branch_codes ‚Üí applicableBranches, ‡πÄ‡∏û‡∏¥‡πà‡∏° loading state ‡πÅ‡∏•‡∏∞ toast
    async function loadActivePromotions() {
      try {
        showToast('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô...', 'info');
        const token = localStorage.getItem('authToken');
        const js = await safeFetch('/api/promotion/active', {
          headers: { 'Authorization': 'Bearer ' + token },
          timeout: 10000,
          maxRetries: 2
        });
        console.log('üì° API Response:', js); // DEBUG
        if (js.status === 'success') {
          activePromotions = js.data.filter(p => {
            const now = new Date();
            const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
            const startOk = new Date(p.startDate) <= now;
            const endOk = new Date(p.endDate) >= now;
            const activeOk = p.isActive === true;
            const usageOk = !p.usageLimit || (p.usageCount < p.usageLimit);
            console.log('üìã Promotion filter:', p.name, { branchOk, startOk, endOk, activeOk, usageOk }); // DEBUG
            return branchOk && startOk && endOk && activeOk && usageOk;
          });
          console.log('‚úÖ Filtered promotions:', activePromotions); // DEBUG
          showToast(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${activePromotions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
        }
      } catch (err) {
        console.error('‚ùå Error loading promotions:', err);
        activePromotions = [];
      }
    }

    // ========== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Animation ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ==========

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ)
    function checkPromotionForProduct(productId) {
      console.log('üîç Checking promotion for product:', productId);
      console.log('üìä Active promotions:', activePromotions.length);

      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å approvedStocks
      const stockItem = approvedStocks.find(item => item._id === productId);
      if (!stockItem) {
        console.log('‚ùå Stock item not found for productId:', productId);
        return false;
      }

      console.log('üì¶ Stock item found:', {
        _id: stockItem._id,
        name: stockItem.name,
        brand: stockItem.brand
      });

      const hasPromo = activePromotions.some(p => {
        console.log('üéØ Checking promotion:', p.name);
        console.log('üìã Promotion applicableProducts:', p.applicableProducts);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const allProducts = !p.applicableProducts ||
          (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);

        if (allProducts) {
          console.log(`‚úÖ Promotion "${p.name}" applies to all products`);
          return true;
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        let matchByName = false;
        if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
          console.log('üîó Checking by product name...');
          matchByName = p.applicableProducts.some(prod => {
            // Normalize ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
            const stockName = stockItem.name.trim().toLowerCase();
            const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
            const nameMatch = stockName === promoProductName;

            if (nameMatch) {
              console.log(`‚úÖ Name match: "${stockItem.name}" === "${prod.name}"`);
            } else {
              console.log(`‚ùå Name no match: "${stockItem.name}" !== "${prod.name}"`);
            }

            return nameMatch;
          });
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Product ID (fallback)
        let matchById = false;
        if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
          console.log('üîó Checking by product ID (fallback)...');
          matchById = p.applicableProducts.some(prod => {
            const prodId = typeof prod === 'string' ? prod : prod._id;
            const idMatch = prodId === productId;

            if (idMatch) {
              console.log(`‚úÖ ID match: ${prodId} === ${productId}`);
            }

            return idMatch;
          });
        }

        const match = allProducts || matchByName || matchById;

        console.log('üéØ Result for', p.name, ':', {
          allProducts,
          matchByName,
          matchById,
          match
        });

        return match;
      });

      console.log('üî• Final result:', hasPromo);
      return hasPromo;
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkBrandHasPromotion ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    function checkBrandHasPromotion(brandKey) {
      const brandProducts = approvedStocks.filter(p => {
        const key = (p.brand || p.name.split(' ')[0]).trim().toLowerCase();
        return key === brandKey;
      });

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏î‡πÉ‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      return brandProducts.some(product => {
        const hasPromo = activePromotions.some(promo => {
          // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          if (!promo.applicableProducts || promo.applicableProducts.length === 0) {
            return true;
          }

          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          return promo.applicableProducts.some(promoProd => {
            const stockName = product.name.trim().toLowerCase();
            const promoName = promoProd.name ? promoProd.name.trim().toLowerCase() : '';
            return stockName === promoName;
          });
        });

        return hasPromo;
      });
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkGroupHasPromotion ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    function checkGroupHasPromotion(groupItems) {
      return groupItems.some(item => {
        const hasPromo = activePromotions.some(promo => {
          // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          if (!promo.applicableProducts || promo.applicableProducts.length === 0) {
            return true;
          }

          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          return promo.applicableProducts.some(promoProd => {
            const stockName = item.name.trim().toLowerCase();
            const promoName = promoProd.name ? promoProd.name.trim().toLowerCase() : '';
            return stockName === promoName;
          });
        });

        return hasPromo;
      });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á confetti effect
    function createConfettiEffect(element) {
      const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
      const confettiCount = 30;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.transition = 'all 1s ease-out';
        confetti.style.zIndex = '1000';

        element.appendChild(confetti);

        setTimeout(() => {
          confetti.style.top = '100%';
          confetti.style.opacity = '0';
          confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
        }, 10);

        setTimeout(() => confetti.remove(), 1000);
      }
    }

    // ========== ‡∏à‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ==========

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
    function calculateAgeFromBirthDate() {
      const birthDateInput = document.getElementById('customerBirthDate');
      const ageInput = document.getElementById('customerAge');
    
      if (!birthDateInput || !ageInput || !birthDateInput.value) {
        return;
      }
    
      const birthDate = new Date(birthDateInput.value);
      const today = new Date();
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      if (birthDate > today) {
        showToast('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'warning');
        birthDateInput.value = '';
        ageInput.value = '';
        return;
      }
    
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
    
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏á 1
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
      if (age < 0 || age > 150) {
        showToast('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
        birthDateInput.value = '';
        ageInput.value = '';
        return;
      }
    
      ageInput.value = age;
      console.log(`üéÇ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${age} ‡∏õ‡∏µ`);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Global function)
    function updateEmailStatus() {
      try {
        const customerType = document.getElementById('customerType')?.value || 'individual';
        const emailPersonal = document.getElementById('customerEmailPersonal');
        const emailCorporate = document.getElementById('corporateEmail');
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        const emailNote = document.getElementById('emailNoteText');
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ elements ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!emailPersonal || !emailCorporate || !emailCheckbox || !emailNote) {
          console.warn('updateEmailStatus: Required elements not found');
          return;
        }
    
        const emailField = customerType === 'individual' ? emailPersonal : emailCorporate;
        const hasEmail = emailField && emailField.value.trim() !== '';
        const isChecked = emailCheckbox.checked;
    
        if (isChecked && !hasEmail) {
          emailNote.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
          emailNote.parentElement.classList.add('text-yellow-600');
          emailNote.parentElement.classList.remove('text-gray-500', 'text-green-600');
        } else if (isChecked && hasEmail) {
          emailNote.textContent = '‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏õ‡∏¢‡∏±‡∏á ' + emailField.value;
          emailNote.parentElement.classList.add('text-green-600');
          emailNote.parentElement.classList.remove('text-gray-500', 'text-yellow-600');
        } else {
          emailNote.textContent = '‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
          emailNote.parentElement.classList.add('text-gray-500');
          emailNote.parentElement.classList.remove('text-yellow-600', 'text-green-600');
        }
      } catch (error) {
        console.error('updateEmailStatus error:', error);
      }
    }


          // Global notification system instance
      let posNotificationSystem = null;

      // Quick Actions Menu JavaScript
      document.addEventListener('DOMContentLoaded', function() {
        const quickActionsBtn = document.getElementById('quickActionsBtn');
        const quickActionsDropdown = document.getElementById('quickActionsDropdown');
    
        if (quickActionsBtn && quickActionsDropdown) {
          const chevronIcon = quickActionsBtn.querySelector('.bi-chevron-down');
    
          // Toggle dropdown
          quickActionsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
    
            const isHidden = quickActionsDropdown.classList.contains('hidden');
    
            if (isHidden) {
              quickActionsDropdown.classList.remove('hidden');
              chevronIcon.classList.add('rotate-180');
            } else {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!quickActionsBtn.contains(e.target) && !quickActionsDropdown.contains(e.target)) {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Close dropdown on escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Keyboard navigation support
          const menuItems = quickActionsDropdown.querySelectorAll('a');
          let currentIndex = -1;
    
          document.addEventListener('keydown', (e) => {
            const isDropdownVisible = !quickActionsDropdown.classList.contains('hidden');
    
            if (!isDropdownVisible) return;
    
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              currentIndex = (currentIndex + 1) % menuItems.length;
              updateMenuFocus();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              currentIndex = currentIndex <= 0 ? menuItems.length - 1 : currentIndex - 1;
              updateMenuFocus();
            } else if (e.key === 'Enter' && currentIndex >= 0) {
              e.preventDefault();
              menuItems[currentIndex].click();
            }
          });
    
          function updateMenuFocus() {
            menuItems.forEach((item, index) => {
              if (index === currentIndex) {
                item.classList.add('bg-gray-100');
                item.focus();
              } else {
                item.classList.remove('bg-gray-100');
              }
            });
          }
    
          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // Alt+M or Ctrl+M to open menu
            if ((e.altKey || e.ctrlKey) && e.key.toLowerCase() === 'm') {
              e.preventDefault();
              quickActionsBtn.click();
            }
          });
        }
      });

      // Final safety check before DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
      // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® loaderId ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å try block
      let loaderId = null;
    
      try {
        // Initialize loading system
        console.log('üîç Testing Loading...');

        // Show loading overlay
        showLoading(true);
        console.log('‚úÖ Loading shown');
    
        // Initialize Modular Notification System
        if (typeof ModularNotificationSystem !== 'undefined') {
          posNotificationSystem = new ModularNotificationSystem();
          console.log('üîî POS Notification System initialized');
    
          // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á welcome notification - ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        } else {
          console.warn('‚ö†Ô∏è ModularNotificationSystem not available');
        }
    
        // üîç Audit Log - Page Load Start
        const pageLoadStart = Date.now();
        logAuditEvent('PAGE_LOAD_START', {
          url: window.location.href,
          branchCode: BRANCH_CODE,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        }, 'INFO');

        // Note: Sidebar initialization is now handled by sidebar.js

        // 2) Load employee profile, stocks, promotions, branch, level1
        await loadEmployeeProfile();     // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        await loadApprovedStocks();

        // 3) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        await loadDepositReceiptData();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Card Reader System
        checkCardReaderSystem();
        await loadActivePromotions();    // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        await loadBranchInfo();
        loadLevel1();

        // 4) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à)
        if (fromDepositReceipt) {
          setTimeout(() => {
            autoAddPreSelectedProduct();
          }, 1000); // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        }
        localStorage.removeItem('userEmail');

      // 3) Search & reset
      document.getElementById('btnSearch').addEventListener('click', searchItems);
      document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('searchQuery').value = '';
        SecurityHelpers.safeSetContent(document.getElementById('imeiResultGrid'), '', '');
        document.getElementById('imeiResultContainer').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        goBackToLevel1(); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Level 1
      });

      // 3.1) Barcode Scanner
      document.getElementById('btnAddBarcode').addEventListener('click', processBarcodeInput);
      document.getElementById('btnClearBarcode').addEventListener('click', () => {
        document.getElementById('barcodeInput').value = '';
        document.getElementById('barcodeResults').classList.add('hidden');
      });
    
      // Barcode input Enter key listener
      document.getElementById('barcodeInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          processBarcodeInput();
        }
      });

      // Auto-focus barcode input when Alt+B is pressed
      document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key === 'b') {
          e.preventDefault();
          document.getElementById('barcodeInput').focus();
        }
      });

      // 4) Level navigation
      document.getElementById('btnGoBack').addEventListener('click', goBackToLevel1);
      document.getElementById('btnGoBackToLevel2').addEventListener('click', goBackToLevel2);
    
      // 5) Customer gender auto-fill from prefix
      document.getElementById('customerPrefix').addEventListener('change', function() {
        const genderField = document.getElementById('customerGender');
        if (genderField) {
          const prefix = this.value;
          let gender = '';
    
          if (prefix === '‡∏ô‡∏≤‡∏¢') {
            gender = '‡∏ä‡∏≤‡∏¢';
          } else if (prefix === '‡∏ô‡∏≤‡∏á' || prefix === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß') {
            gender = '‡∏´‡∏ç‡∏¥‡∏á';
          }
    
          genderField.value = gender;
        }
      });
    
      // ‚úÖ 6) [‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥]

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ global scope ‡πÅ‡∏•‡πâ‡∏ß (window.fillCustomerDataFromCard)
      /*
      function fillCustomerDataFromCard(cardData) {
        console.log('üîÑ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£:', cardData);
        console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö properties:', Object.keys(cardData));
    
        try {
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô - ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÜ property name
          const citizenId = cardData.citizenId || cardData.Citizenid || cardData.CitizenId || cardData.id || '';
          const firstNameTh = cardData.firstNameTh || cardData.FirstNameTh || cardData.firstname || cardData.firstName || '';
          const lastNameTh = cardData.lastNameTh || cardData.LastNameTh || cardData.lastname || cardData.lastName || '';
          const titleTh = cardData.titleTh || cardData.TitleTh || cardData.title || cardData.prefix || '';
          const address = cardData.address || cardData.Address || cardData.addr || '';
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ property names
          const birthDate = cardData.birthDate || cardData.BirthdayEn || cardData.birthday ||
                           cardData.dateOfBirth || cardData.Birthday || cardData.BirthDate ||
                           cardData.birth_date || cardData.dob || '';
          const age = cardData.age || cardData.Age || cardData.AGE || '';
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢ (‡πÉ‡∏ä‡πâ # ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏¢‡∏Å)
          const district = cardData.district || cardData.District || '';
          const subDistrict = cardData.subDistrict || cardData.SubDistrict || cardData.tambon || '';
          const province = cardData.province || cardData.Province || cardData.changwat || '';
    
          // üîç Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ
          console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ:');
          console.log('  - ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', citizenId);
          console.log('  - ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:', titleTh);
          console.log('  - ‡∏ä‡∏∑‡πà‡∏≠:', firstNameTh);
          console.log('  - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:', lastNameTh);
          console.log('  - ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:', birthDate);
          console.log('  - ‡∏≠‡∏≤‡∏¢‡∏∏:', age);
          console.log('  - ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:', address);
          console.log('  - ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡∏î‡∏¥‡∏ö):', district);
          console.log('  - ‡∏ï‡∏≥‡∏ö‡∏• (‡∏î‡∏¥‡∏ö):', subDistrict);
          console.log('  - ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏î‡∏¥‡∏ö):', province);
    
          // üîç Debug ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î properties ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          console.log('üìÖ Debug ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î properties:');
          console.log('  - cardData.birthDate:', cardData.birthDate);
          console.log('  - cardData.BirthdayEn:', cardData.BirthdayEn);
          console.log('  - cardData.birthday:', cardData.birthday);
          console.log('  - cardData.Birthday:', cardData.Birthday);
          console.log('  - cardData.BirthDate:', cardData.BirthDate);
          console.log('  - cardData.birth_date:', cardData.birth_date);
          console.log('  - cardData.dateOfBirth:', cardData.dateOfBirth);
          console.log('  - cardData.dob:', cardData.dob);
    
          // üîç Debug ‡∏≠‡∏≤‡∏¢‡∏∏ properties ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          console.log('üë∂ Debug ‡∏≠‡∏≤‡∏¢‡∏∏ properties:');
          console.log('  - cardData.age:', cardData.age);
          console.log('  - cardData.Age:', cardData.Age);
          console.log('  - cardData.AGE:', cardData.AGE);
    
          // ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
          const prefixField = document.getElementById('customerPrefix');
          if (prefixField && titleTh) {
            prefixField.value = titleTh;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:', titleTh);
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠ field');
          }
    
          // ‡πÄ‡∏û‡∏® (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
          const genderField = document.getElementById('customerGender');
          if (genderField && titleTh) {
            let gender = '';
            if (titleTh === '‡∏ô‡∏≤‡∏¢') {
              gender = '‡∏ä‡∏≤‡∏¢';
            } else if (titleTh === '‡∏ô‡∏≤‡∏á' || titleTh === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß') {
              gender = '‡∏´‡∏ç‡∏¥‡∏á';
            }
    
            if (gender) {
              genderField.value = gender;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏® (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥):', gender);
            }
          }
    
          // ‡∏ä‡∏∑‡πà‡∏≠
          const firstNameField = document.getElementById('customerFirstName');
          if (firstNameField && firstNameTh) {
            firstNameField.value = firstNameTh;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠:', firstNameTh);
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ field');
          }
    
          // ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
          const lastNameField = document.getElementById('customerLastName');
          if (lastNameField && lastNameTh) {
            lastNameField.value = lastNameTh;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:', lastNameTh);
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠ field, lastNameTh =', lastNameTh);
          }
    
          // ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)
          const taxIdField = document.getElementById('customerTaxId');
          if (taxIdField && citizenId) {
            taxIdField.value = citizenId;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', citizenId);
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠ field');
          }
    
          // ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
          console.log('üéÇ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î...');
          const birthDateField = document.getElementById('customerBirthDate');
          console.log('  - ‡∏û‡∏ö birthDateField:', !!birthDateField);
          console.log('  - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:', birthDate);
          console.log('  - typeof birthDate:', typeof birthDate);
    
          if (birthDateField && birthDate && typeof birthDate === 'string' && birthDate.trim()) {
            let formattedDate = birthDate;
            console.log('  - ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', birthDate);
    
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            if (typeof birthDate === 'string') {
              // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY
              if (birthDate.includes('/')) {
                const parts = birthDate.split('/');
                console.log('  - ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:', parts);
                if (parts.length === 3) {
                  let year = parseInt(parts[2], 10);
                  const month = parts[1].padStart(2, '0');
                  const day = parts[0].padStart(2, '0');
    
                  // ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                  if (year > 2500) {
                    console.log(`  - ‡∏û‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®.: ${year}`);
                    year = year - 543;
                    console.log(`  - ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.: ${year}`);
                  }
    
                  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input[type="date"]
                  formattedDate = `${year}-${month}-${day}`;
                  console.log('  - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á:', formattedDate);
                }
              }
            }
    
            birthDateField.value = formattedDate;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', formattedDate);
    
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô field ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°
            setTimeout(() => {
              console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UI ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:', birthDateField.value);
            }, 100);
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏î‡πâ:');
            console.log('  - birthDateField:', !!birthDateField);
            console.log('  - birthDate:', birthDate);
            console.log('  - birthDate type:', typeof birthDate);
            console.log('  - birthDate.trim():', (birthDate && typeof birthDate === 'string') ? birthDate.trim() : 'N/A');
          }
    
          // ‡∏≠‡∏≤‡∏¢‡∏∏
          console.log('üë∂ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏¢‡∏∏...');
          const ageField = document.getElementById('customerAge');
          console.log('  - ‡∏û‡∏ö ageField:', !!ageField);
          console.log('  - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:', age);
          console.log('  - typeof age:', typeof age);
    
          if (ageField && age && age !== '') {
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string
            const ageValue = typeof age === 'string' ? parseInt(age, 10) : age;
            console.log('  - ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á:', ageValue);
    
            if (!isNaN(ageValue) && ageValue > 0) {
              ageField.value = ageValue;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', ageValue);
    
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô field ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°
              setTimeout(() => {
                console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UI ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏¢‡∏∏:', ageField.value);
                console.log('üîç ageField readonly:', ageField.readOnly);
                console.log('üîç ageField disabled:', ageField.disabled);
              }, 100);
            } else {
              console.log('‚ùå ‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:', ageValue);
            }
          } else {
            console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏î‡πâ:');
            console.log('  - ageField:', !!ageField);
            console.log('  - age:', age);
            console.log('  - age !== "":', age !== '');
          }
    
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢)
          console.log('üè† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...');
    
          // ‡∏´‡∏≤ field ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
          const houseNoField = document.getElementById('houseNo');
          const mooField = document.getElementById('moo');
          const provinceField = document.getElementById('province');
          const districtField = document.getElementById('district');
          const subDistrictField = document.getElementById('subDistrict');
          const zipcodeField = document.getElementById('zipcode');
    
          // 1. ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤)
    
          // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢)
          if (province && provinceField) {
            // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡πà‡∏≠‡∏ô #)
            const cleanProvince = province.split('#')[0].trim();
            provinceField.value = cleanProvince;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢):', cleanProvince);
          }
    
          // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢)
          if (district && districtField) {
            // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡πà‡∏≠‡∏ô #)
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏¢‡∏∞‡∏£‡∏±‡∏á#‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ" ‚Üí "‡∏¢‡∏∞‡∏£‡∏±‡∏á"
            const cleanDistrict = district.split('#')[0].trim();
            districtField.value = cleanDistrict;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢):', cleanDistrict);
          }
    
          // ‡∏ï‡∏≥‡∏ö‡∏• (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢)
          if (subDistrict && subDistrictField) {
            // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡πà‡∏≠‡∏ô #)
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "‡∏£‡∏∞‡πÅ‡∏ß‡πâ‡∏á#‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏¢‡∏∞‡∏£‡∏±‡∏á#‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ" ‚Üí "‡∏£‡∏∞‡πÅ‡∏ß‡πâ‡∏á"
            const cleanSubDistrict = subDistrict.split('#')[0].trim();
            subDistrictField.value = cleanSubDistrict;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏• (‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢):', cleanSubDistrict);
          }
    
          // 2. ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
          if (address && address.trim()) {
            console.log('üè† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°:', address);
    
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå (5 ‡∏´‡∏•‡∏±‡∏Å)
            let zipMatch = address.match(/(\d{5})(?:\s|$)/g);
            if (!zipMatch) zipMatch = address.match(/\s(\d{5})$/);
            if (zipMatch && zipcodeField) {
              const zipcode = zipMatch[zipMatch.length - 1].replace(/\s/g, '');
              zipcodeField.value = zipcode;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:', zipcode);
            }
    
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏π‡πà (‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            let mooMatch = address.match(/‡∏´‡∏°‡∏π‡πà\s*(\d+)/i) ||
                          address.match(/‡∏°\.(\d+)/i) ||
                          address.match(/‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà\s*(\d+)/i);
            if (mooMatch && mooField) {
              const moo = mooMatch[1];
              mooField.value = moo;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà:', moo);
            }
    
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á)
            let houseMatch = address.match(/^(\d+[\\/\d-]*)/);
            if (houseMatch && houseNoField) {
              const houseNo = houseMatch[1];
              houseNoField.value = houseNo;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:', houseNo);
            }
    
            // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°
            if (!province && provinceField) {
              let provinceMatch = address.match(/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î([^\s\d#]+)/i) ||
                                address.match(/‡∏à\.([^\s\d#]+)/i);
              if (provinceMatch) {
                const foundProvince = provinceMatch[1].trim();
                provinceField.value = foundProvince;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°):', foundProvince);
              }
            }
    
            if (!district && districtField) {
              let districtMatch = address.match(/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠([^\s\d#]+)/i) ||
                                address.match(/‡∏≠\.([^\s\d#]+)/i) ||
                                address.match(/‡πÄ‡∏Ç‡∏ï([^\s\d#]+)/i);
              if (districtMatch) {
                const foundDistrict = districtMatch[1].trim();
                districtField.value = foundDistrict;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°):', foundDistrict);
              }
            }
    
            if (!subDistrict && subDistrictField) {
              let subDistrictMatch = address.match(/‡∏ï‡∏≥‡∏ö‡∏•([^\s\d#]+)/i) ||
                                   address.match(/‡∏ï\.([^\s\d#]+)/i) ||
                                   address.match(/‡πÅ‡∏Ç‡∏ß‡∏á([^\s\d#]+)/i);
              if (subDistrictMatch) {
                const foundSubDistrict = subDistrictMatch[1].trim();
                subDistrictField.value = foundSubDistrict;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏• (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°):', foundSubDistrict);
              }
            }
    
          } else {
            console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°');
          }
    
          console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
    
          // Trigger change events ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
          const fieldsToUpdate = [
            prefixField, firstNameField, lastNameField, taxIdField,
            birthDateField, ageField,
            document.getElementById('houseNo'),
            document.getElementById('moo'),
            document.getElementById('province'),
            document.getElementById('district'),
            document.getElementById('subDistrict'),
            document.getElementById('zipcode')
          ].filter(field => field);
    
          fieldsToUpdate.forEach(field => {
            if (field && field.value) {
              field.dispatchEvent(new Event('change', { bubbles: true }));
              field.dispatchEvent(new Event('input', { bubbles: true }));
            }
          });
    
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
          if (birthDateField && birthDateField.value) {
            setTimeout(() => {
              if (typeof calculateAgeFromBirthDate === 'function') {
                calculateAgeFromBirthDate();
                console.log('üéÇ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß');
              }
            }, 100);
          }
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
          const filledFields = [];
          if (titleTh) filledFields.push('‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤');
          if (firstNameTh) filledFields.push('‡∏ä‡∏∑‡πà‡∏≠');
          if (lastNameTh) filledFields.push('‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
          if (citizenId) filledFields.push('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
    
          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const birthDateFilled = birthDateField && birthDateField.value;
          const ageFilled = ageField && ageField.value;
    
          if (birthDateFilled) filledFields.push('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î');
          if (ageFilled) filledFields.push('‡∏≠‡∏≤‡∏¢‡∏∏');
          if (address || district || subDistrict || province) filledFields.push('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà');
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏î‡πâ‡∏ß‡∏¢
          const missingFields = [];
          if (!titleTh) missingFields.push('‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤');
          if (!firstNameTh) missingFields.push('‡∏ä‡∏∑‡πà‡∏≠');
          if (!lastNameTh) missingFields.push('‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
          if (!citizenId) missingFields.push('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
          if (!birthDateFilled && !ageFilled) missingFields.push('‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î/‡∏≠‡∏≤‡∏¢‡∏∏');
          if (!address && !district && !subDistrict && !province) missingFields.push('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà');
    
          if (typeof showToast === 'function') {
            if (filledFields.length > 0) {
              showToast(
                `‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${filledFields.join(', ')}`,
                'success',
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
                4000
              );
            }
    
            if (missingFields.length > 0) {
              showToast(
                `‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö: ${missingFields.join(', ')}`,
                'warning',
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
                3000
              );
            }
          }
    
        } catch (error) {
          console.error('‚ùå Error filling customer data from card:', error);
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
          }
        }
      }
      */ // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡∏π‡∏Å comment ‡∏≠‡∏≠‡∏Å

      // 5) Card reader & checkout
      // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
      document.getElementById('btnTestCardReader').addEventListener('click', function(e) {
        e.preventDefault();
    
        console.log('üß™ Testing Card Reader System...');
        checkCardReaderSystem();
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô console
                 setTimeout(() => {
          console.log('üìä Card Reader System Status:');
          console.log('- CardReaderConfig:', typeof window.CardReaderConfig);
          console.log('- CardReaderService:', typeof window.CardReaderService);
          console.log('- fillCustomerDataFromCard:', typeof window.fillCustomerDataFromCard);
          console.log('- Branch Code:', BRANCH_CODE);
    
          if (window.CardReaderConfig) {
            const isEnabled = window.CardReaderConfig.isCardReaderEnabled(BRANCH_CODE);
            console.log('- Card Reader Enabled:', isEnabled);
    
            if (isEnabled) {
              const config = window.CardReaderConfig.getCardProxyUrls(BRANCH_CODE);
              console.log('- Available URLs:', config.all.map(u => u.http));
            }
          }
    
          // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          if (typeof window.fillCustomerDataFromCard === 'function') {
            console.log('üß™ Testing fillCustomerDataFromCard with EXACT real card data format...');
            window.testCardData = {
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á (case-sensitive)
              Citizenid: '1234567890123',
              Gender: '‡∏ä‡∏≤‡∏¢',
              TitleTh: '‡∏ô‡∏≤‡∏¢',
              FirstNameTh: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
              LastNameTh: '‡πÉ‡∏à‡∏î‡∏µ',
              Age: '35',
              BirthdayTh: '15/03/1989',
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö # delimiter (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á 100%)
              Address: '123/45#‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 7####‡∏ï‡∏≥‡∏ö‡∏•‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î#‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà#‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏á‡∏Ç‡∏•‡∏≤'
            };
            console.log('üìù EXACT real card data format available in window.testCardData');
            console.log('üí° Run: fillCustomerDataFromCard(testCardData) to test');
            console.log('üè† Address format: 123/45#‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 7####‡∏ï‡∏≥‡∏ö‡∏•‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î#‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà#‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏á‡∏Ç‡∏•‡∏≤');
            console.log('üîç This should fill all address fields including ‡∏´‡∏°‡∏π‡πà, ‡∏ï‡∏≥‡∏ö‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ with # delimiter parser');
          }
        }, 500);
      });
    
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á
    window.analyzeRealCardData = function(cardData) {
      console.log('üîç ===== REAL CARD DATA ANALYSIS =====');
      console.log('üìã Raw data:', cardData);
      console.log('üîë Available keys:', Object.keys(cardData));
    
      // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
      const addressKeys = Object.keys(cardData).filter(key =>
        key.toLowerCase().includes('address') ||
        key.toLowerCase().includes('district') ||
        key.toLowerCase().includes('province') ||
        key.toLowerCase().includes('tambon') ||
        key.toLowerCase().includes('amphoe') ||
        key.toLowerCase().includes('village') ||
        key.toLowerCase().includes('moo') ||
        key.toLowerCase().includes('house')
      );
    
      console.log('üè† Address-related keys found:', addressKeys);
    
      addressKeys.forEach(key => {
        console.log(`  üìç ${key}:`, cardData[key]);
    
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Address ‡πÅ‡∏•‡∏∞‡∏°‡∏µ # ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏î‡∏π
        if (key === 'Address' && cardData[key] && cardData[key].includes('#')) {
          const parts = cardData[key].split('#').filter(part => part.trim() !== '');
          console.log(`    üîç Split by # (${parts.length} parts):`, parts);
    
          parts.forEach((part, index) => {
            const cleanPart = part.trim();
            if (cleanPart) {
              console.log(`      ${index + 1}. "${cleanPart}"`);
            }
          });
        }
      });
    
      // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£ mapping
      console.log('üí° Mapping suggestions:');
      console.log('  - ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà: village, moo, Village, Moo (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Address: ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà X)');
      console.log('  - ‡∏ï‡∏≥‡∏ö‡∏•: subDistrict, tambon, SubDistrict, Tambon (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Address: ‡∏ï‡∏≥‡∏ö‡∏•XXX)');
      console.log('  - ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: district, amphoe, District, Amphoe (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Address: ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠XXX)');
      console.log('  - ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: province, changwat, Province, Changwat (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Address: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏îXXX)');
      console.log('  - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô: houseNumber, houseNo, HouseNumber, HouseNo (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Address: XXX/XX)');
      console.log('üîç ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö # delimiter format: ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏î‡πâ‡∏ß‡∏¢ split("#")');
    
      return {
        allKeys: Object.keys(cardData),
        addressKeys: addressKeys,
        addressData: addressKeys.reduce((obj, key) => {
          obj[key] = cardData[key];
          return obj;
        }, {})
      };
    };

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)
      document.getElementById('btnTestFillData').addEventListener('click', function(e) {
        e.preventDefault();
    
        console.log('üß™ Testing fillCustomerDataFromCard with realistic data...');
    
        if (typeof window.fillCustomerDataFromCard === 'function') {
                      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á (# delimiter format)
            const testData = {
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á
              Citizenid: '1234567890123',
              TitleTh: '‡∏ô‡∏≤‡∏¢',
              FirstNameTh: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
              LastNameTh: '‡πÉ‡∏à‡∏î‡∏µ',
              Age: '35',
              BirthdayTh: '15/03/1989',
    
              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö # delimiter (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á 100%)
              Address: '123/45#‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 7####‡∏ï‡∏≥‡∏ö‡∏•‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î#‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà#‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏á‡∏Ç‡∏•‡∏≤'
            };
    
                      console.log('üìù Using real card data format:', testData);
            const result = window.fillCustomerDataFromCard(testData);
    
            if (result) {
              console.log('‚úÖ Test data fill successful');
    
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              setTimeout(() => {
                const addressCheck = {
                  houseNo: document.getElementById('houseNo')?.value || '',
                  moo: document.getElementById('moo')?.value || '',
                  subDistrict: document.getElementById('subDistrict')?.value || '',
                  district: document.getElementById('district')?.value || '',
                  province: document.getElementById('province')?.value || ''
                };
    
                console.log('üè† Address fields after fill:', addressCheck);
    
                const filledAddressFields = Object.values(addressCheck).filter(v => v).length;
                const totalAddressFields = Object.keys(addressCheck).length;
    
                if (typeof showToast === 'function') {
                  if (filledAddressFields >= 3) {
                    showToast(
                      `‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ${filledAddressFields}/${totalAddressFields} ‡∏ä‡πà‡∏≠‡∏á`,
                      'success',
                      '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                      4000
                    );
                  } else {
                    showToast(
                      `‚ö†Ô∏è ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${filledAddressFields}/${totalAddressFields} ‡∏ä‡πà‡∏≠‡∏á`,
                      'warning',
                      '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                      4000
                    );
                  }
                }
              }, 500);
            } else {
              console.log('‚ùå Test data fill failed');
            }
        } else {
          console.error('‚ùå fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error', '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
          }
        }
      });
    
      // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á
      document.getElementById('btnReadCard').addEventListener('click', async function(e) {
        e.preventDefault();
    
        // ‡πÅ‡∏™‡∏î‡∏á loading state
        const btn = e.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£...';
        btn.disabled = true;
    
        try {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ CardReaderService ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
            throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
          }
    
          // ‡πÉ‡∏ä‡πâ retry mechanism ‡πÅ‡∏ó‡∏ô readCard() ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
          const result = await retryReadCard(1);
    
          if (result && result.success && result.data) {
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            const cardData = result.data;
    
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (typeof window.fillCustomerDataFromCard === 'function') {
              window.fillCustomerDataFromCard(cardData);
            } else {
              console.error('‚ùå fillCustomerDataFromCard function not available');
              if (typeof showToast === 'function') {
                showToast('‚ùå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
              }
            }
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            if (typeof showToast === 'function') {
              showToast(
                `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${cardData.titleTh || ''}${cardData.firstNameTh || ''} ${cardData.lastNameTh || ''}`,
                'success',
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
                5000
              );
            }
          } else {
            const errorMsg = result?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ';
            throw new Error(errorMsg);
          }
    
        } catch (error) {
          console.error('‚ùå Error reading card:', error);
    
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          let errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô error ‡∏à‡∏≤‡∏Å retry mechanism ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const isRetryError = errorMessage.includes('‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≠‡∏á') && errorMessage.includes('‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
          if (error.connectionErrors && error.connectionErrors.length > 0) {
            console.log('üîç Connection errors details:', error.connectionErrors);
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î endpoint ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
            const failedEndpoints = error.connectionErrors.map(err =>
              `${err.name}: ${err.error}`
            ).join('\n');
    
            console.log('üìã Failed endpoints summary:\n' + failedEndpoints);
          }
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
          const isAdmin = localStorage.getItem('userRole') === 'admin' || window.location.search.includes('debug=1');
    
          if (isAdmin && typeof showToast === 'function') {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            const adminMessage = `
              <div class="mb-3">‚ùå ${errorMessage}</div>
              <div class="mt-2 d-grid gap-2">
                <div class="d-flex gap-2">
                  <button onclick="runComprehensiveCardReaderDiagnostic()" class="btn btn-sm btn-primary flex-1">
                    üî¨ Full Diagnostic
                  </button>
                  <button onclick="testCardReaderConnection()" class="btn btn-sm btn-warning">
                    üîç Quick Test
                  </button>
                </div>
                <div class="d-flex gap-2">
                  <button onclick="debugCardReaderConfig()" class="btn btn-sm btn-info flex-1">
                    üîß Config
                  </button>
                  <button onclick="showSystemHealthStatus()" class="btn btn-sm btn-success flex-1">
                    üè• Health
                  </button>
                </div>
                <div class="d-flex gap-2">
                  <button onclick="showManualCustomerEntry()" class="btn btn-sm btn-secondary flex-1">
                    ‚úèÔ∏è Manual Entry
                  </button>
                  <button onclick="tryCardReaderAgain()" class="btn btn-sm btn-outline-warning flex-1">
                    üîÑ Retry
                  </button>
                </div>
              </div>
            `;
    
            showToast(adminMessage, 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (Admin Mode)', 15000);
          } else {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° Manual Entry ‡πÅ‡∏•‡∏∞ Retry
            if (typeof showToast === 'function') {
              const userMessage = `
                <div class="mb-3">‚ùå ${errorMessage}</div>
                <div class="mt-2 d-flex gap-2">
                  <button onclick="showManualCustomerEntry()" class="btn btn-sm btn-primary flex-1">
                    ‚úèÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
                  </button>
                  ${!isRetryError ? `
                    <button onclick="tryCardReaderAgain()" class="btn btn-sm btn-warning">
                      üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                  ` : ''}
                </div>
              `;
              showToast(userMessage, 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 15000);
            }
          }
        } finally {
          // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      });
      document.getElementById('btnSingleCheckout').addEventListener('click', singleCheckout);

      // 6) Vat & discount changes
      document.getElementById('vatRate').addEventListener('change', renderCart);
      document.getElementById('discount').addEventListener('change', renderCart);

      // 7) Customer type toggle
      const sel = document.getElementById('customerType');
      sel.addEventListener('change', () => {
        const personal = document.getElementById('personalFields');
        const corporate = document.getElementById('corporateFields');
        if (sel.value === 'individual') {
          personal.classList.remove('hidden');
          corporate.classList.add('hidden');
          corporate.querySelectorAll('input').forEach(i => i.value = '');
        } else {
          personal.classList.add('hidden');
          corporate.classList.remove('hidden');
          personal.querySelectorAll('input, select').forEach(f => f.value = '');
        }
        updateEmailStatus(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•
      });

      // 7.1) Email checkbox ‡πÅ‡∏•‡∏∞ field listeners
      const emailCheckbox = document.getElementById('sendEmailReceipt');
      const emailPersonal = document.getElementById('customerEmailPersonal');
      const emailCorporate = document.getElementById('corporateEmail');

      emailCheckbox.addEventListener('change', updateEmailStatus);
      emailPersonal.addEventListener('input', updateEmailStatus);
      emailCorporate.addEventListener('input', updateEmailStatus);
    
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      updateEmailStatus();
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
      updateEmailServiceIndicator();

      // 7.2) Birth date change listener - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const customerBirthDate = document.getElementById('customerBirthDate');
      if (customerBirthDate) {
        customerBirthDate.addEventListener('change', function() {
          calculateAgeFromBirthDate();
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
          if (this.value && typeof showToast === 'function') {
            showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
          }
        });
      }



      // 8) Load initial data and setup barcode listener
      await loadLevel1();
      setupLanguageIndependentBarcodeListener();

      // üîç Audit Log - Page Load Complete
        const pageLoadEnd = Date.now();
        logAuditEvent('PAGE_LOAD_COMPLETE', {
          url: window.location.href,
          branchCode: BRANCH_CODE,
          loadDuration: pageLoadEnd - pageLoadStart,
          stocksLoaded: approvedStocks.length,
          promotionsLoaded: activePromotions.length
        }, 'SUCCESS');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        setTimeout(() => {
          const currentStaffName = localStorage.getItem('userName') || staffName || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          const userId = localStorage.getItem('userId') || 'unknown';
    
          console.log('üë§ Final Staff Info Check:', {
            staffName: currentStaffName,
            userId: userId,
            globalStaffName: staffName,
            isDefaultName: currentStaffName === '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
          });
    
          if (currentStaffName === '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' || currentStaffName === 'Guest') {
            console.warn('‚ö†Ô∏è Still using default staff name after page load');
            if (typeof showToast === 'function') {
              showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
            }
    
            // POS Notification
            if (posNotificationSystem) {
              posNotificationSystem.addNotification('pos', {
                title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ login ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
                type: 'warning',
                icon: '‚ö†Ô∏è',
                actions: [
                  {
                    label: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    action: 'primary',
                    callback: () => {
                      console.log('üîç Manual staff info check');
                      loadEmployeeProfile();
                    }
                  }
                ]
              });
            }
          } else {
            console.log('‚úÖ Staff name loaded successfully:', currentStaffName);
            if (posNotificationSystem) {
              posNotificationSystem.showToast('pos', {
                title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                message: `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ô‡∏≤‡∏°: ${currentStaffName}`,
                type: 'success',
                icon: 'üë§',
                duration: 3000
              });
            }
          }
        }, 2000); // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    
      } catch (error) {
        console.error('Page initialization error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤', 'error');
      } finally {
        // Hide loading overlay
        showLoading(false);
      }
    });

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (Manual Entry)
    window.showManualCustomerEntry = function() {
      // ‡∏ã‡πà‡∏≠‡∏ô toast notifications
      if (typeof hideToast === 'function') {
        hideToast();
      }
    
      // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏´‡∏£‡∏∑‡∏≠ form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'manualCustomerModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">‚úèÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
              </div>
              
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="text-danger">*</span></label>
                  <input type="text" id="manualIdCard" class="form-control" 
                         placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13">
                </div>
                
                <div class="col-md-2 mb-3">
                  <label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                  <select id="manualTitle" class="form-control">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                    <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                    <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                    <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                  </select>
                </div>
                
                <div class="col-md-5 mb-3">
                  <label>‡∏ä‡∏∑‡πà‡∏≠ <span class="text-danger">*</span></label>
                  <input type="text" id="manualFirstName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
                </div>
                
                <div class="col-md-5 mb-3">
                  <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label>
                  <input type="text" id="manualLastName" class="form-control" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                
                <div class="col-md-12 mb-3">
                  <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                  <textarea id="manualAddress" class="form-control" rows="3" 
                            placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"></textarea>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                  <input type="tel" id="manualPhone" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                  <input type="email" id="manualEmail" class="form-control" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="button" class="btn btn-primary" onclick="saveManualCustomerData()">
                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
        </div>
      `;
    
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤
      document.body.appendChild(modal);
    
      // ‡πÅ‡∏™‡∏î‡∏á modal
      $('#manualCustomerModal').modal('show');
    
      // ‡∏•‡∏ö modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
      $('#manualCustomerModal').on('hidden.bs.modal', function() {
        $(this).remove();
      });
    
      // Focus ‡∏ó‡∏µ‡πà field ‡πÅ‡∏£‡∏Å
      setTimeout(() => {
        document.getElementById('manualIdCard').focus();
      }, 500);
    };

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
    window.saveManualCustomerData = function() {
      const idCard = document.getElementById('manualIdCard').value.trim();
      const title = document.getElementById('manualTitle').value;
      const firstName = document.getElementById('manualFirstName').value.trim();
      const lastName = document.getElementById('manualLastName').value.trim();
      const address = document.getElementById('manualAddress').value.trim();
      const phone = document.getElementById('manualPhone').value.trim();
      const email = document.getElementById('manualEmail').value.trim();
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      if (!idCard || !firstName || !lastName) {
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)', 'error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
        }
        return;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
      if (!/^\d{13}$/.test(idCard)) {
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        return;
      }
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£
      const customerData = {
        // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö card reader
        idCard: idCard,
        titleTh: title,
        firstNameTh: firstName,
        lastNameTh: lastName,
        address: address,
        phone: phone,
        email: email,
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° metadata
        source: 'manual_entry',
        timestamp: new Date().toISOString()
      };
    
      try {
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        if (typeof window.fillCustomerDataFromCard === 'function') {
          window.fillCustomerDataFromCard(customerData);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          if (typeof showToast === 'function') {
            showToast(
              '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + title + firstName + ' ' + lastName,
              'success',
              '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
              5000
            );
          }
    
          // ‡∏õ‡∏¥‡∏î modal
          $('#manualCustomerModal').modal('hide');
    
        } else {
          console.error('‚ùå fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'error', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }
        }
    
      } catch (error) {
        console.error('‚ùå Error saving manual customer data:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
      }
    };

    // ‚úÖ Global debugging functions for console use
    window.testCardReaderConnection = async function(branchCode) {
      console.log('üîç Running card reader connection test...');
    
      if (!window.CardReaderService || typeof window.CardReaderService.testConnection !== 'function') {
        console.error('‚ùå CardReaderService.testConnection not available');
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error', '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
        return;
      }
    
      try {
        const result = await window.CardReaderService.testConnection({ branchCode });
    
        if (result.results && result.results.length > 0) {
          console.table(result.results);
        }
        console.log('üìä Summary: ' + result.summary);
    
        if (typeof showToast === 'function') {
          showToast(result.summary, result.success ? 'success' : 'error', '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 8000);
        }
    
        return result;
      } catch (error) {
        console.error('‚ùå Test connection failed:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error', '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
      }
    };

    window.debugCardReaderConfig = function(branchCode) {
      const currentBranch = branchCode || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
      const config = window.CardReaderConfig?.getBranchConfig(currentBranch);
      const urls = window.CardReaderConfig?.getCardProxyUrls(currentBranch);
    
      console.log('üîß Card Reader Configuration:', {
        branchCode: currentBranch,
        config: config,
        urls: urls,
        enabled: window.CardReaderConfig?.isCardReaderEnabled(currentBranch)
      });
    
      if (typeof showToast === 'function') {
        const summary = '‡∏™‡∏≤‡∏Ç‡∏≤: ' + currentBranch + ', Endpoints: ' + (urls?.all?.length || 0) + ', ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (config?.enabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î');
        showToast('üîß ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Console: ' + summary, 'info', 'Card Reader Config', 5000);
      }
    
      return { branchCode: currentBranch, config, urls };
    };



    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà", "‡∏´‡∏°‡∏π‡πà", "‡∏ï‡∏≥‡∏ö‡∏•", "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    function removeLocalityPrefix(str) {
      if (!str) return '';
      let result = str.trim();
      result = result.replace(/^‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà\s*/i, '').replace(/^‡∏´‡∏°‡∏π‡πà\s*/i, '');
      result = result.replace(/^‡∏ï‡∏≥‡∏ö‡∏•\s*/i, '');
      result = result.replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠\s*/i, '');
      result = result.replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î\s*/i, '');
      return result.trim();
    }

    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      // ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô sidebar
      sb.classList.toggle('-translate-x-full');
      sb.classList.toggle('translate-x-0');

      // ‡∏™‡∏•‡∏±‡∏ö margin ‡∏Ç‡∏≠‡∏á mainContent
      mc.classList.toggle('ml-0');
      mc.classList.toggle('ml-64');

      // ‡∏™‡∏•‡∏±‡∏ö icon
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }

    function showToast(message, type = 'info') {
      // ‡πÄ‡∏î‡∏¥‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Console ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      // console.log(`[Toast: ${type}] ${message}`);

      // ‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Toast UI ‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ div ‡∏á‡πà‡∏≤‡∏¢‡πÜ)
      const toastContainer = document.body; // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ container ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
      const toast = document.createElement('div');
      let bgColor = 'bg-blue-500'; // default info
      if (type === 'success') bgColor = 'bg-green-500';
      if (type === 'warning') bgColor = 'bg-yellow-500';
      if (type === 'danger') bgColor = 'bg-red-500';

      toast.className = `fixed bottom-5 right-5 ${bgColor} text-white p-3 rounded-lg shadow-lg transition-opacity duration-300 z-[100]`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Toast ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300); // ‡∏£‡∏≠ transition ‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
      }, 3000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô format ‡∏£‡∏≤‡∏Ñ‡∏≤
    function formatPrice(num) {
      if (typeof num !== 'number') {
        num = parseFloat(num) || 0;
      }
      return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sanitizeImagePath ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ image path ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
    function sanitizeImagePath(originalPath) {
      if (!originalPath) return '';

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô full URL ‡∏´‡∏£‡∏∑‡∏≠ data URL ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
      if (originalPath.startsWith('http') || originalPath.startsWith('data:')) {
        return originalPath;
      }

      // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ /uploads/ ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
      if (originalPath.startsWith('/uploads/')) {
        return originalPath;
      }

      // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ uploads/ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
      if (originalPath.startsWith('uploads/')) {
        return '/' + originalPath;
      }

      // ‡∏ï‡∏±‡∏î path ‡πÄ‡∏ï‡πá‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á uploads
      let sanitized = originalPath.replace(/^.*uploads[\\/]/, '');
      sanitized = sanitized.replace(/\\/g, '/');

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° /uploads/ ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
      return `/uploads/${sanitized}`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á image URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    function getImageUrl(imagePath) {
      if (!imagePath) {
        console.log('üñºÔ∏è Image path is empty, using placeholder');
        return 'https://via.placeholder.com/150?text=No+Image';
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô full URL ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
      if (imagePath.startsWith('http') || imagePath.startsWith('data:')) {
        console.log('üñºÔ∏è Using full URL:', imagePath);
        return imagePath;
      }

      // ‡πÉ‡∏ä‡πâ sanitizeImagePath ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ path
      const sanitizedPath = sanitizeImagePath(imagePath);
      console.log('üñºÔ∏è Original path:', imagePath, '‚Üí Sanitized path:', sanitizedPath);
      return sanitizedPath;
    }

    // trim ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
    function removePrefixes(str) {
      if (!str) return '';
      return str.trim();
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          console.warn('‚ö†Ô∏è No auth token found for employee profile');
          return;
        }

        console.log('üë§ Loading employee profile...');
        const js = await safeFetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          timeout: 10000,
          maxRetries: 2
        });
        if (!js.success) throw new Error(js.error || js.message || 'API request failed');
        const u = js.data;

        // --- 1) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü userId ‡∏Å‡∏±‡∏ö userName ‡∏•‡∏á localStorage ---
        if (u._id) {
          localStorage.setItem('userId', u._id);
          console.log('‚úÖ User ID saved:', u._id);
        }
        if (u.name) {
          localStorage.setItem('userName', u.name);
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global staffName ‡∏î‡πâ‡∏ß‡∏¢
          staffName = u.name;
          console.log('‚úÖ Staff name updated:', u.name);
    
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô notification system
          if (posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
              message: `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ô‡∏≤‡∏°: ${u.name}`,
              type: 'info',
              icon: 'üë§',
              metadata: {
                staffId: u._id,
                staffName: u.name,
                role: u.role?.name || u.position || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
              }
            });
          }
        }
        // ---------------------------------------------------------------

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI elements (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const employeeNameEl = document.getElementById('employeeName');
        if (employeeNameEl) {
          employeeNameEl.textContent = u.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
        const roleElement = document.getElementById('employeeRole');
        if (roleElement) {
          const roleName = u.role?.name || u.position || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          roleElement.textContent = roleName;
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó employee photo (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element)
        const employeePhotoEl = document.getElementById('employeePhoto');
        if (employeePhotoEl) {
          let img = u.imageUrl || u.photoUrl || u.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }
          employeePhotoEl.src = img || 'https://via.placeholder.com/150x150/e5e7eb/9ca3af?text=Avatar';
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô console
        console.log('üë§ Employee Profile Loaded:', {
          id: u._id,
          name: u.name,
          role: u.role?.name || u.position || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
          email: u.email
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
        if (typeof showToast === 'function') {
          showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${u.name}`, 'success');
        }

      } catch (err) {
        console.error('‚ùå Load Employee Profile Error:', err);
    
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ fallback staff name
        const fallbackName = localStorage.getItem('userName') || localStorage.getItem('staffName') || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        staffName = fallbackName;
        console.log('‚ö†Ô∏è Using fallback staff name:', fallbackName);
    
        if (typeof showToast === 'function') {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'warning');
        }
      }
    }




    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // ‡πÉ‡∏ä‡πâ debounce ‡∏Å‡∏±‡∏ö loadLevel1
    const debouncedLoadLevel1 = debounce(loadLevel1, 1000);

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏ß‡∏î Level 1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    let isLoadingLevel1 = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

    // -----------------------------
    // 2) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / IMEI (cash)
    // -----------------------------
    async function searchItems() {
      // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® loaderId ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å try block
      let loaderId = null;
    
      try {
        // Show loading
        showLoading(true);
    
        const raw = document.getElementById('searchQuery').value.trim();
        const isImei = /^\d+$/.test(raw);
        const token = localStorage.getItem('authToken') || '';
        const grid = document.getElementById('imeiResultGrid');
        const container = document.getElementById('imeiResultContainer');

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Level1/2/3 ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Search
        ['level1Container', 'level2Container', 'level3Container']
          .forEach(id => document.getElementById(id).classList.add('hidden'));
        container.classList.remove('hidden');
        SecurityHelpers.safeSetContent(grid, '', '');

        let url = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}&verified=true&purchaseType=cash`;
        if (isImei) url += `&imei=${encodeURIComponent(raw)}`;

        const js = await safeFetch(url, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 10000,
          maxRetries: 2
        });
        let items = (js.success) ? js.data : [];

        // API taxType ‡∏û‡∏£‡πâ‡∏≠‡∏° purchaseType=cash ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡πÄ‡∏ä‡πá‡∏Ñ stock_value >0
        items = items.filter(it => it.stock_value > 0);

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà IMEI) ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô
        if (!isImei && raw) {
          const q = raw.toLowerCase();
          items = items.filter(st => st.name.toLowerCase().includes(q));
        }

        if (items.length === 0) {
          const noItemsText = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤${isImei ? ' (IMEI ‡∏ô‡∏µ‡πâ)' : ''}`;
          SecurityHelpers.safeSetContent(grid, 'text-gray-500 col-span-full', noItemsText);
          return;
        }
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ IMEI
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Level3
        if (isImei) {
          // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ IMEI ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞
          items.forEach(it => {
            const stockType = it.product_id?.stockType || it.stockType || 'imei';
            const stockTypeBadge = stockType === 'imei'
              ? '<span class="badge badge-info badge-sm">IMEI</span>'
              : '<span class="badge badge-success badge-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>';
            const imeiDisplay = stockType === 'imei'
              ? `<p class="text-xs text-gray-600 mb-1">IMEI: ${it.imei || '-'}</p>`
              : '';

            const col = document.createElement('div');
            col.className = 'card p-4 flex flex-col';
            col.innerHTML = `
          <img src="${getImageUrl(it.image)}"
               class="product-img mb-2 rounded-md" alt="${it.name}" />
          <div class="flex items-center gap-2 mb-1">
            <h6 class="font-medium text-sm">${it.name}</h6>
            ${stockTypeBadge}
          </div>
          ${imeiDisplay}
          <p class="product-price-big mb-2">‡∏ø${formatPrice(it.price)}</p>
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å -->
        `;
            // col.querySelector("button")... (‡∏•‡∏ö event listener ‡∏î‡πâ‡∏ß‡∏¢)
            grid.appendChild(col);
          });
        } else {
          // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
          const groupedSearchItems = items.reduce((groups, it) => {
            const stockType = it.product_id?.stockType || it.stockType || 'imei';
            const key = `${it.name}_${stockType}`;

            if (!groups[key]) {
              groups[key] = {
                name: it.name,
                stockType: stockType,
                items: [],
                image: it.image,
                price: it.price,
                taxType: it.taxType,
                model: it.model,
                poNumber: it.poNumber,
                supplier: it.supplier
              };
            }
            groups[key].items.push(it);
            return groups;
          }, {});

          Object.values(groupedSearchItems).forEach(group => {
            const stockTypeBadge = group.stockType === 'imei'
              ? '<span class="badge badge-info badge-sm">IMEI</span>'
              : '<span class="badge badge-success badge-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>';

            let quantityBadge = '';
            let imeiDisplay = '';

            if (group.stockType === 'imei') {
              const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));

              if (availableDevices.length === 0) {
                quantityBadge = `<span class="badge emergency-badge badge-sm">üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å! 0 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
              } else if (availableDevices.length >= 1 && availableDevices.length <= 3) {
                quantityBadge = `<span class="badge warning-badge badge-sm">‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢! ${availableDevices.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
              } else {
                quantityBadge = `<span class="badge badge-primary badge-sm">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${availableDevices.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
              }

              const availableDevice = availableDevices[0];
              if (availableDevice && availableDevice.imei) {
                imeiDisplay = `<div class="text-xs text-gray-600 mb-1">IMEI: ${availableDevice.imei}</div>`;
              } else {
                imeiDisplay = `<div class="text-xs emergency-text mb-1">üö® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠!</div>`;
              }
            } else {
              quantityBadge = `<span class="badge badge-primary badge-sm">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${group.items.length} ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
            }

            const itemToAdd = group.stockType === 'imei'
              ? group.items.find(item => !hiddenProductIds.has(item._id)) || group.items[0]
              : group.items[0];

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ stock ‡πÉ‡∏ô search results
            let isSearchOutOfStock = false;
            let isSearchLowStock = false;
            let searchCardClass = 'card p-4 flex flex-col';
            let searchStatusIcon = '';

            if (group.stockType === 'imei') {
              const searchAvailableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));
              isSearchOutOfStock = searchAvailableDevices.length === 0;
              isSearchLowStock = !isSearchOutOfStock && searchAvailableDevices.length >= 1 && searchAvailableDevices.length <= 3;
            } else {
              // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quantity: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
              const totalOriginalStock = group.items.reduce((sum, item) => {
                return sum + (item.originalStockValue || item.stock_value);
              }, 0);
              const cartQty = cartItems
                .filter(item => {
                  return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
                })
                .reduce((sum, item) => sum + item.qty, 0);
              const searchAvailableQty = Math.max(0, totalOriginalStock - cartQty);
              isSearchOutOfStock = searchAvailableQty === 0;
              isSearchLowStock = !isSearchOutOfStock && searchAvailableQty >= 1 && searchAvailableQty <= 3;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS classes ‡πÅ‡∏•‡∏∞ icons
            if (isSearchOutOfStock) {
              searchCardClass += ' out-of-stock-emergency';
              searchStatusIcon = '<span class="status-icon emergency-icon">üö®</span>';
            } else if (isSearchLowStock) {
              searchCardClass += ' low-stock-warning';
              searchStatusIcon = '<span class="status-icon warning-icon">‚ö†Ô∏è</span>';
            }

            const col = document.createElement('div');
            col.className = searchCardClass;
            col.innerHTML = `
          ${searchStatusIcon}
          <img src="${getImageUrl(group.image)}"
               class="product-img mb-2 rounded-md" alt="${group.name}" />
          <div class="flex flex-wrap items-center gap-1 mb-1">
            <h6 class="font-medium text-sm ${isSearchOutOfStock ? 'emergency-text' : isSearchLowStock ? 'warning-text' : ''}">${group.name}</h6>
            ${stockTypeBadge}
            ${quantityBadge}
          </div>
          ${imeiDisplay}
          <p class="product-price-big mb-2">‡∏ø${formatPrice(group.price)}</p>
          ${group.stockType !== 'imei' && !isSearchOutOfStock ? `
            <button class="btn btn-primary btn-sm w-full mt-2" onclick="addProductToCart('${itemToAdd._id}', '${group.name}', ${group.price}, '', '${itemToAdd.taxType || ''}', '${itemToAdd.model || ''}', '${itemToAdd.poNumber || ''}', '${itemToAdd.supplier || ''}')">
              <i class="bi bi-cart-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            </button>
          ` : ''}
        `;

            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å
            grid.appendChild(col);
          });
        }

      } catch (err) {
        console.error('searchItems failed:', err);
        const grid = document.getElementById('imeiResultGrid');

        // Safely create error message to prevent XSS
        grid.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-500 col-span-full';
        errorDiv.textContent = `Error: ${err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'}`;
        grid.appendChild(errorDiv);
      } finally {
        // Hide loading
        showLoading(false);
      }
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Level2 ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á Level3
    let level2Groups = {};
    let currentLevel3Items = [];
    const hiddenProductIds = new Set();



    // -----------------------------
    // Level 1 ‚Äì ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
    // -----------------------------
    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà renderLevel1 ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏ó‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå)
    function renderLevel1(categories) {
      const grid = document.getElementById('level1Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (categories.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 dark:text-gray-500">
              <i class="bi bi-box-seam text-6xl mb-4"></i>
              <h3 class="text-xl font-semibold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
              <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</p>
              <button onclick="loadLevel1()" class="btn btn-primary mt-4">
                <i class="bi bi-arrow-clockwise mr-2"></i>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>
        `;
        return;
      }

      categories.forEach(category => {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì stock ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ
        const categoryItems = approvedStocks.filter(item => {
          // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô determineCategory ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏™‡πà‡∏á categoryGroup ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢)
          const itemCategory = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
          return itemCategory === category;
        });

        const totalItems = categoryItems.length;
        const availableItems = categoryItems.filter(item => {
          const stockValue = item.originalStockValue || item.stock_value || 0;
          return stockValue > 0;
        }).length;
    
        const totalStock = categoryItems.reduce((sum, item) => {
          return sum + (item.originalStockValue || item.stock_value || 0);
        }, 0);

        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 20; // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà

        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">üö®</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">‚ö†Ô∏è</div>';
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const hasPromo = categoryItems.some(item => checkBrandHasPromotion(extractBrand(item.name)));

        const categoryCard = document.createElement('div');
        categoryCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';

        // Add stock alert classes
        if (isOutOfStock) {
          categoryCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          categoryCard.className += ' low-stock-warning';
        }

        if (hasPromo) {
          categoryCard.className += ' has-promotion';
          categoryCard.style.overflow = 'visible';
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Fire Icon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        const fireIcon = hasPromo ? '<div class="promo-fire-icon">üî•</div>' : '';

        categoryCard.innerHTML = `
          <div class="card-body p-4">
            ${fireIcon}
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${category}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">üö® ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>' : isLowStock ? '<span class="text-xs warning-text">‚ö†Ô∏è ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≥</span>' : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getCategoryIcon(category)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-primary">${totalItems} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
              ${isOutOfStock ? '<div class="badge badge-error ml-2">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</div>' : ''}
              ${hasPromo ? '<div class="badge badge-warning ml-2">üî• ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</div>' : ''}
            </div>
          </div>
        `;

        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (availableItems > 0) {
          categoryCard.addEventListener('click', () => loadLevel2(category, category));
        } else {
          categoryCard.classList.add('cursor-not-allowed', 'opacity-50');
          categoryCard.addEventListener('click', () => {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ', 'warning');
          });
        }

        grid.appendChild(categoryCard);
      });
    }

    // Create alias function for backward compatibility
    async function loadStockAndCategories() {
      return await loadLevel1();
    }

    async function loadLevel1() {
      // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
      document.getElementById('level1Container').classList.remove('hidden');
      ['level2Container', 'level3Container', 'imeiResultContainer']
        .forEach(id => document.getElementById(id).classList.add('hidden'));

      // ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô step1.html)
      const categoryCounts = {};

      approvedStocks.forEach(item => {
        const category = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
        const stockType = item.product_id?.stockType || item.stockType || 'imei';

        if (!categoryCounts[category]) {
          categoryCounts[category] = 0;
        }

        if (stockType === 'imei') {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI: ‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          if (!hiddenProductIds.has(item._id)) {
            categoryCounts[category]++;
          }
        } else {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quantity: ‡πÉ‡∏ä‡πâ stock_value
          if (item.stock_value > 0) {
            categoryCounts[category] += item.stock_value;
          }
        }
      });

      // ‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
      const allCategories = approvedStocks.reduce((acc, item) => {
        const category = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
        if (!acc.has(category)) {
          acc.add(category);
        }
        return acc;
      }, new Set());

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      allCategories.forEach(category => {
        if (!categoryCounts[category]) {
          categoryCounts[category] = 0;
        }
      });

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
      const categories = Array.from(allCategories).sort();
      renderLevel1(categories);
    }



    // -----------------------------
    // Level 2 ‚Äì ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å
    // -----------------------------
    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà renderLevel2 ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    function renderLevel2(productNames) {
      const grid = document.getElementById('level2Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      productNames.forEach(productName => {
        const productItems = level2Groups[productName];
    
        // Calculate total stock for this product name
        const totalStock = productItems.reduce((sum, item) => {
          return sum + (item.originalStockValue || item.stock_value || 0);
        }, 0);
        const availableItems = productItems.filter(item => {
          const stockValue = item.originalStockValue || item.stock_value || 0;
          return stockValue > 0;
        }).length;
    
        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 5;
    
        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">üö®</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">‚ö†Ô∏è</div>';
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        const hasPromo = productItems.some(item => checkBrandHasPromotion(extractBrand(item.name)));
    
        const productCard = document.createElement('div');
        productCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';
    
        // Add stock alert classes
        if (isOutOfStock) {
          productCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          productCard.className += ' low-stock-warning';
        }

        if (hasPromo) {
          productCard.className += ' has-promotion';
          productCard.style.overflow = 'visible';
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Fire Icon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        const fireIcon = hasPromo ? '<div class="promo-fire-icon">üî•</div>' : '';
    
        productCard.innerHTML = `
          <div class="card-body p-4">
            ${fireIcon}
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${productName}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${productItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">üö® ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : isLowStock ? '<span class="text-xs warning-text">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>' : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getProductIcon(productName)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-secondary">${productItems.length} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
              <div class="badge ${isOutOfStock ? 'emergency-badge' : isLowStock ? 'warning-badge' : 'badge-success'} ml-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${totalStock}</div>
              ${hasPromo ? '<div class="badge badge-warning ml-2">üî• ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</div>' : ''}
            </div>
          </div>
        `;
    
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (availableItems > 0) {
          productCard.addEventListener('click', () => showLevel3Group(productName));
        } else {
          productCard.classList.add('cursor-not-allowed', 'opacity-50');
          productCard.addEventListener('click', () => {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ', 'warning');
          });
        }
    
        grid.appendChild(productCard);
      });
    }

    function loadLevel2(category, parentLabel) {
      // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á
      document.getElementById('level1Container').classList.add('hidden');
      ['level3Container', 'imeiResultContainer'].forEach(id =>
        document.getElementById(id).classList.add('hidden'));
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ${parentLabel}`;

      // ‡∏Å‡∏£‡∏≠‡∏á stocks ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
      const filtered = approvedStocks.filter(p => {
        const itemCategory = determineCategory(p.name, p.product_id?.productType || p.productType, p.categoryGroup);
        return itemCategory === category;
      });
    
      // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô step1.html)
      level2Groups = filtered.reduce((groups, p) => {
        const productName = extractProductName(p.name);
        (groups[productName] ||= []).push(p);
        return groups;
      }, {});

      // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI
      window.level2Groups = level2Groups;

      if (!Object.keys(level2Groups).length) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ', 'warning');
        return goBackToLevel1();
      }
      renderLevel2(Object.keys(level2Groups));
    }

    // -----------------------------
    // Level 3 ‚Äì ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    // -----------------------------
    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà renderLevel3 ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    function renderLevel3(items) {
      const grid = document.getElementById('level3Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á:
      // - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö quantity: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ stock_value > 0
      // - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß)
      const visible = items.filter(it => {
        const stockType = it.product_id?.stockType || it.stockType || 'imei';

        if (stockType === 'imei') {
          // IMEI: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á stock_value)
          return true;
        } else {
          // Quantity: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ stock_value > 0 ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å hide
          return it.stock_value > 0 && !hiddenProductIds.has(it._id);
        }
      });

      if (!visible.length) {
        grid.innerHTML = `
      <div class="col-span-full text-center text-gray-500 py-8">
        <i class="bi bi-cart-check text-4xl mb-2 block"></i>
        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ</p>
        <p class="text-sm mt-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</p>
      </div>`;
        return;
      }

      // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: IMEI ‡πÅ‡∏•‡∏∞ Quantity ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡πá‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
      const groupedItems = visible.reduce((groups, it) => {
        const stockType = it.product_id?.stockType || it.stockType || 'imei';

        // ‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ + stockType ‡∏ó‡∏±‡πâ‡∏á IMEI ‡πÅ‡∏•‡∏∞ Quantity
        const key = `${it.name}_${stockType}`;

        if (!groups[key]) {
          groups[key] = {
            name: it.name,
            stockType: stockType,
            items: [],
            image: it.image,
            price: it.price,
            taxType: it.taxType,
            model: it.model,
            poNumber: it.poNumber,
            supplier: it.supplier
          };
        }
        groups[key].items.push(it);
        return groups;
      }, {});

      Object.values(groupedItems).forEach(group => {
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const hasPromo = activePromotions.some(p => {
          // 1. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          const allProducts = !p.applicableProducts || p.applicableProducts.length === 0;
          if (allProducts) return true;

          // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö checkPromotionForProduct)
          let matchByName = false;
          if (group.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
            matchByName = p.applicableProducts.some(prod => {
              const stockName = group.name.trim().toLowerCase();
              const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
              return stockName === promoProductName;
            });
          }

          // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Product ID (fallback)
          const matchById = p.applicableProducts &&
            p.applicableProducts.some(prod =>
              group.items.some(item => (typeof prod === 'string' ? prod : prod._id) === item._id)
            );

          // 4. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ Category
          const inCategory = p.applicableCategories &&
            p.applicableCategories.includes(group.items[0].productType);

          return matchByName || matchById || inCategory;
        });

        const col = document.createElement('div');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ stock
        let isOutOfStock = false;
        let isLowStock = false;
        let cardClass = 'card p-4 flex flex-col relative';

        if (group.stockType === 'imei') {
          const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));
          isOutOfStock = availableDevices.length === 0;
          isLowStock = !isOutOfStock && availableDevices.length >= 1 && availableDevices.length <= 3;
        } else {
          const totalOriginalStock = group.items.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);
          const cartQty = cartItems
            .filter(item => {
              return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);
          const availableQty = totalOriginalStock - cartQty;
          isOutOfStock = availableQty === 0;
          isLowStock = !isOutOfStock && availableQty >= 1 && availableQty <= 3;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS classes ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ stock
        if (isOutOfStock) {
          cardClass += ' out-of-stock-emergency';
        } else if (isLowStock) {
          cardClass += ' low-stock-warning';
        }

        col.className = cardClass;

        if (hasPromo) {
          col.style.overflow = 'visible';
        }

        // ‡πÉ‡∏ä‡πâ Fire Icon ‡πÅ‡∏•‡∏∞ Status Icon
        const fireIcon = hasPromo ? '<span class="promo-fire-icon">üî•</span>' : '';
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<span class="status-icon emergency-icon">üö®</span>';
        } else if (isLowStock) {
          statusIcon = '<span class="status-icon warning-icon">‚ö†Ô∏è</span>';
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á stock type badge ‡πÅ‡∏•‡∏∞ quantity/count badge
        const stockTypeBadge = group.stockType === 'imei'
          ? '<span class="badge badge-info badge-sm">IMEI</span>'
          : '<span class="badge badge-success badge-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>';

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠, ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quantity ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        let quantityBadge = '';
        if (group.stockType === 'imei') {
          // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));

          // Debug logging for IMEI
          console.log(`üîç IMEI calculation for ${group.name}:`, {
            totalDevices: group.items.length,
            hiddenDevices: group.items.filter(item => hiddenProductIds.has(item._id)).length,
            availableDevices: availableDevices.length,
            hiddenProductIds: Array.from(hiddenProductIds)
          });

          if (availableDevices.length === 0) {
            quantityBadge = `<span class="badge emergency-badge badge-sm">üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å! 0 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
          } else if (availableDevices.length >= 1 && availableDevices.length <= 3) {
            quantityBadge = `<span class="badge warning-badge badge-sm">‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢! ${availableDevices.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
          } else {
            quantityBadge = `<span class="badge badge-primary badge-sm">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${availableDevices.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>`;
          }
        } else {
          // ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
          const totalOriginalStock = group.items.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
          const cartQty = cartItems
            .filter(item => {
              // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ id ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
              return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          const availableQty = totalOriginalStock - cartQty;

          // Debug logging
          console.log(`üîç Quantity calculation for ${group.name}:`, {
            groupItems: group.items.length,
            totalOriginalStock,
            cartQty,
            availableQty
          });

          const finalQty = Math.max(0, availableQty);

          if (finalQty === 0) {
            quantityBadge = `<span class="badge emergency-badge badge-sm">üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å! 0 ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
          } else if (finalQty >= 1 && finalQty <= 3) {
            quantityBadge = `<span class="badge warning-badge badge-sm">‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢! ${finalQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
          } else {
            quantityBadge = `<span class="badge badge-primary badge-sm">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${finalQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>`;
          }
        }

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡πÅ‡∏™‡∏î‡∏á IMEI ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        let imeiDisplay = '';
        if (group.stockType === 'imei') {
          const availableDevice = group.items.find(item => !hiddenProductIds.has(item._id));
          if (availableDevice && availableDevice.imei) {
            imeiDisplay = `<div class="text-xs text-gray-600 mb-1">IMEI: ${availableDevice.imei}</div>`;
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
            imeiDisplay = `<div class="text-xs emergency-text mb-1">üö® ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠!</div>`;
          }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î styling
        let productOutOfStock = isOutOfStock;
        let productLowStock = isLowStock;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Boxset ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset
        const isBoxset = group.items[0] && group.items[0].productType === 'boxset';
        let boxsetProductsDisplay = '';
    
        if (isBoxset) {
          const boxsetItem = group.items[0];
    
          // Debug: ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• boxset item
          console.log('üéÅ Boxset item structure:', {
            _id: boxsetItem._id,
            name: boxsetItem.name,
            selectedProducts: boxsetItem.selectedProducts,
            products: boxsetItem.products,
            productList: boxsetItem.productList,
            items: boxsetItem.items,
            allKeys: Object.keys(boxsetItem)
          });
    
          // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ field ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ field ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
          let boxsetProducts = [];
          let sourceField = 'none';
    
          if (boxsetItem.selectedProducts && Array.isArray(boxsetItem.selectedProducts)) {
            boxsetProducts = boxsetItem.selectedProducts;
            sourceField = 'selectedProducts';
          } else if (boxsetItem.products && Array.isArray(boxsetItem.products)) {
            boxsetProducts = boxsetItem.products;
            sourceField = 'products';
          } else if (boxsetItem.productList && Array.isArray(boxsetItem.productList)) {
            boxsetProducts = boxsetItem.productList;
            sourceField = 'productList';
          } else if (boxsetItem.items && Array.isArray(boxsetItem.items)) {
            boxsetProducts = boxsetItem.items;
            sourceField = 'items';
          }
    
          console.log(`üéÅ Found boxset products from "${sourceField}":`, boxsetProducts);
          console.log(`üìä Boxset products count: ${boxsetProducts.length}`);
    
          if (boxsetProducts.length > 0) {
            console.log(`‚úÖ Rendering ${boxsetProducts.length} products for boxset "${boxsetItem.name}"`);
            boxsetProductsDisplay = `
              <div class="boxset-products mt-2 mb-2 p-2 bg-blue-50 rounded-md border border-blue-200">
                <div class="flex items-center gap-1 mb-2">
                  <span class="text-xs font-semibold text-blue-700">üéÅ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset:</span>
                  <span class="badge badge-info badge-xs">${boxsetProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="boxset-products-list text-xs space-y-1">
                  ${boxsetProducts.map((product, idx) => {
                    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ field
                    const productName = product.name || product.productName || product.itemName || product.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                    const productQty = product.quantity || product.qty || product.amount || 1;
                    const productPrice = product.price || product.unitPrice || 0;
    
                    console.log(`  üì¶ Product ${idx + 1}:`, {
                      name: productName,
                      quantity: productQty,
                      price: productPrice,
                      originalData: product
                    });
    
                    return `
                      <div class="flex items-center justify-between py-1 px-2 bg-white rounded border border-blue-100">
                        <div class="flex-1">
                          <span class="text-gray-700 font-medium">${productName}</span>
                          ${productPrice > 0 ? `<span class="text-xs text-gray-500 ml-1">(‡∏ø${productPrice})</span>` : ''}
                        </div>
                        <span class="badge badge-outline badge-xs text-blue-600">x${productQty}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          } else {
            console.log(`‚ö†Ô∏è No products found for boxset "${boxsetItem.name}"`);
            boxsetProductsDisplay = `
              <div class="boxset-products mt-2 mb-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                <span class="text-xs text-gray-500">üéÅ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset ‡∏ô‡∏µ‡πâ</span>
              </div>
            `;
          }
        }

        col.innerHTML = `
      ${fireIcon}
      ${statusIcon}
      <img src="${getImageUrl(group.image)}" class="product-img mb-2 rounded-md" alt="${group.name}" />
      <div class="flex flex-wrap items-center gap-1 mb-1">
        <h6 class="font-medium text-sm ${productOutOfStock ? 'emergency-text' : productLowStock ? 'warning-text' : ''}">${group.name}</h6>
        ${stockTypeBadge}
        ${quantityBadge}
        ${isBoxset ? '<span class="badge badge-secondary badge-sm ml-1">üì¶ Boxset</span>' : ''}
      </div>
      ${imeiDisplay}
      ${boxsetProductsDisplay}
      <p class="product-price-big mb-2">‡∏ø${formatPrice(group.price)}</p>
      ${hasPromo && !productOutOfStock ? '<p class="promotion-text">üéâ ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©!</p>' : ''}
      ${group.stockType !== 'imei' && !productOutOfStock ? `
        <button class="btn btn-primary btn-sm w-full mt-2" onclick="addProductToCart('${group.items[0]._id}', '${group.name}', ${group.price}, '', '${group.items[0].taxType || ''}', '${group.items[0].model || ''}', '${group.items[0].poNumber || ''}', '${group.items[0].supplier || ''}')">
          <i class="bi bi-cart-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        </button>
      ` : ''}
    `;
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å
        grid.appendChild(col);
      });
    }


    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${baseName}`;
      renderLevel3(level2Groups[baseName]);
    }





    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Level3 ‡πÑ‡∏õ Level2
    document.getElementById('btnGoBackToLevel2')
      .addEventListener('click', () => {
        document.getElementById('level3Container').classList.add('hidden');
        document.getElementById('level2Container').classList.remove('hidden');
      });


    // ----- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö -----
    function goBackToLevel1() {
      document.getElementById('level1Container').classList.remove('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }
    function goBackToLevel2() {
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }

    // ‚Äî ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ‚Äî
    document.getElementById('btnGoBack').addEventListener('click', () => {
      logAuditEvent('NAVIGATION_BACK_TO_LEVEL1', {
        fromLevel: 'level2',
        branchCode: BRANCH_CODE
      }, 'INFO');
      goBackToLevel1();
    });
    document.getElementById('btnGoBackToLevel2').addEventListener('click', () => {
      logAuditEvent('NAVIGATION_BACK_TO_LEVEL2', {
        fromLevel: 'level3',
        branchCode: BRANCH_CODE
      }, 'INFO');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
    });



    // -----------------------------
    // fetchTaxType ‡∏Å‡πá‡πÉ‡∏ä‡πâ cash ‡∏ï‡∏•‡∏≠‡∏î
    // -----------------------------
    async function fetchTaxType(imei) {
      const token = localStorage.getItem('authToken') || '';
      const url = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}` +
        `&verified=true&purchaseType=cash&imei=${encodeURIComponent(imei)}`;
      try {
        const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        const js = await resp.json();
        return (resp.ok && js.success && js.data.length) ? js.data[0].taxType : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ';
      } catch (err) {
        console.error('fetchTaxType failed:', err);
        return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ';
      }
    }




       async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const js = await res.json();
        if (res.ok && js.success) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === BRANCH_CODE);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} ‚Äî ${branch.address}`;
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
                          document.title = `POS - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏î - ${branch.name}`;
    
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown branch info ‡πÉ‡∏ô Receipt Menu
              const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
              if (dropdownBranchInfo) {
                dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branch.name}`;
              }
              return;
            }
        }
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent =
          '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
      }
    }





    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IMEI
    async function loadBranchVerified(branchId, imei = '') {
      const token = localStorage.getItem('authToken') || '';
      let url = `/api/branch-stock?branch_code=${branchId}&verified=true`;
      if (imei) url += `&imei=${encodeURIComponent(imei)}`;
      try {
        const res = await fetch(url, {
          headers: { Authorization: 'Bearer ' + token },
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ');
        }
        renderIMEISearchResult(data.data);
      } catch (err) {
        showToast('Error: ' + err.message, 'danger');
      }
    }

    function renderIMEISearchResult(stockItems) {
      const grid = document.getElementById('imeiResultGrid');
      SecurityHelpers.safeSetContent(grid, '', '');

      if (!stockItems || stockItems.length === 0) {
        SecurityHelpers.safeSetContent(grid, 'text-gray-500', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
        return;
      }

      stockItems.forEach(st => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stockType
        const stockType = st.product_id?.stockType || st.stockType || 'imei';

        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getImageUrl ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
        const imgUrl = getImageUrl(st.image);

        // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤ cash ‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å API
        const price = st.price || 0;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ stock
        let isOutOfStock = false;
        let isLowStock = false;
        let availableStock = 0;
        let stockBadgeText = '';
        let stockBadgeClass = '';
        let statusIcon = '';
        let buttonText = '‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤';
        let buttonClass = 'btn btn-primary mt-auto';
        let cardClass = 'product-card p-4 flex flex-col relative';

        if (stockType === 'imei') {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          isOutOfStock = hiddenProductIds.has(st._id);
          if (isOutOfStock) {
            stockBadgeText = 'üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å! 0 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
            stockBadgeClass = 'emergency-badge';
            statusIcon = '<span class="status-icon emergency-icon">üö®</span>';
            buttonText = 'üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å!';
            buttonClass = 'btn btn-error mt-auto emergency-text';
            cardClass += ' out-of-stock-emergency';
          } else {
            stockBadgeText = '‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
            stockBadgeClass = 'badge badge-info';
          }
        } else {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quantity: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì stock ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
          const totalOriginalStock = st.originalStockValue || st.stock_value || 0;
          const cartQty = cartItems
            .filter(item => item.id === st._id && !item.imei)
            .reduce((sum, item) => sum + item.qty, 0);
          availableStock = Math.max(0, totalOriginalStock - cartQty);

          if (availableStock === 0) {
            isOutOfStock = true;
            stockBadgeText = 'üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å! 0 ‡∏ä‡∏¥‡πâ‡∏ô';
            stockBadgeClass = 'emergency-badge';
            statusIcon = '<span class="status-icon emergency-icon">üö®</span>';
            buttonText = 'üö® ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å!';
            buttonClass = 'btn btn-error mt-auto emergency-text';
            cardClass += ' out-of-stock-emergency';
          } else if (availableStock <= 3) {
            isLowStock = true;
            stockBadgeText = `‚ö†Ô∏è ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢! ${availableStock} ‡∏ä‡∏¥‡πâ‡∏ô`;
            stockBadgeClass = 'warning-badge';
            statusIcon = '<span class="status-icon warning-icon">‚ö†Ô∏è</span>';
            buttonText = '‚ö†Ô∏è ‡∏´‡∏¢‡∏¥‡∏ö‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤';
            buttonClass = 'btn btn-warning mt-auto warning-text';
            cardClass += ' low-stock-warning';
          } else {
            stockBadgeText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${availableStock} ‡∏ä‡∏¥‡πâ‡∏ô`;
            stockBadgeClass = 'badge badge-info';
          }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á stock type badge
        const stockTypeBadge = stockType === 'imei'
          ? '<span class="badge badge-info badge-sm">IMEI</span>'
          : '<span class="badge badge-success badge-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>';

        // ‡πÅ‡∏™‡∏î‡∏á IMEI ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó IMEI
        const imeiDisplay = stockType === 'imei'
          ? `<div class="text-sm text-gray-500 mb-1">IMEI: ${st.imei || '-'}</div>`
          : '';

        const col = document.createElement('div');
        col.className = cardClass;
        col.innerHTML = `
      ${statusIcon}
      <img src="${imgUrl}" alt="${st.name}" class="product-img mb-2 rounded-md" />
      <div class="flex flex-col flex-grow">
        <div class="flex items-center gap-2 mb-1">
          <div class="product-name font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${st.name || '-'}</div>
          ${stockTypeBadge}
        </div>
        ${imeiDisplay}
        <div class="product-price-big mb-2">‡∏ø${formatPrice(price)}</div>
        <div class="mb-2">
          <span class="${stockBadgeClass} text-xs px-2 py-1 rounded">${stockBadgeText}</span>
        </div>
        ${stockType === 'quantity' && !isOutOfStock ? `
          <button class="btn btn-primary mt-auto" onclick="addProductToCart('${st._id}', '${st.name}', ${price}, '', '${st.taxType || ''}', '${st.model || ''}', '${st.poNumber || ''}', '${st.supplier || ''}')">
            <i class="bi bi-cart-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          </button>
        ` : `<button class="${buttonClass}" ${isOutOfStock ? 'disabled' : ''}>${buttonText}</button>`}
      </div>
    `;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó IMEI ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (stockType === 'imei' && !isOutOfStock) {
          const button = col.querySelector('button');
          if (button && !button.onclick) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ onclick handler
            button.addEventListener('click', async () => {
              const taxType = await fetchTaxType(st.imei);
              addToCart(
                st._id,
                st.name,
                price,
                st.imei, // ‡∏™‡πà‡∏á IMEI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó IMEI
                taxType,
                st.model || '',
                st.poNumber || '',
                st.supplier || ''
              );
            });
          }
        }

        grid.appendChild(col);
      });
    }




    // Cart operation lock to prevent race conditions
    const cartOperationLocks = new Map();

    function addToCart(id, name, price, imei, taxType, model, poNumber = '', supplier = '') {
      // üîê Security Checks
      if (!validateSession()) return;

      if (!checkRateLimit('addToCart', 20, 60000)) {
        showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'warning');
        return;
      }

      // üîí Race condition prevention - create unique lock key
      const lockKey = imei ? `${id}_${imei}` : `${id}_quantity`;

      if (cartOperationLocks.get(lockKey)) {
        console.log(`‚ö†Ô∏è Cart operation already in progress for ${lockKey}`);
        return;
      }

      // Set lock
      cartOperationLocks.set(lockKey, true);

      try {

      // üîí Input Sanitization
      name = sanitizeInput(name, 'text');
      price = parseFloat(sanitizeInput(price.toString(), 'number')) || 0;
      imei = sanitizeInput(imei, 'text');

      // üîç Audit Log - Start
      const auditDetails = {
        productId: id,
        productName: name,
        price: price,
        imei: imei,
        taxType: taxType,
        model: model,
        supplier: supplier
      };

      logAuditEvent('ADD_TO_CART_START', auditDetails, 'INFO');

      // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô approvedStocks ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stockType ‡πÅ‡∏•‡∏∞ stock_value
      const stockItem = approvedStocks.find(item => item._id === id);
      if (!stockItem) {
        logAuditEvent('ADD_TO_CART_FAILED', { ...auditDetails, reason: 'STOCK_NOT_FOUND' }, 'ERROR');
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
        cartOperationLocks.delete(lockKey);
        return;
      }

      const stockType = stockItem.product_id?.stockType || stockItem.stockType || 'imei';

      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó quantity (‡πÑ‡∏°‡πà‡∏°‡∏µ IMEI) ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å id ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó IMEI ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å id ‡πÅ‡∏•‡∏∞ imei
      const exist = imei
        ? cartItems.find((i) => i.id === id && i.imei === imei)
        : cartItems.find((i) => i.id === id && !i.imei);

      if (exist) {
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ quantity ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (stockType === 'quantity') {
          // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
          const sameNameItems = approvedStocks.filter(item => item.name === name);
          const totalOriginalStock = sameNameItems.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
          const currentCartQty = cartItems
            .filter(item => {
              return sameNameItems.some(sameItem => sameItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          if (currentCartQty >= totalOriginalStock) {
            logAuditEvent('ADD_TO_CART_FAILED', {
              ...auditDetails,
              reason: 'INSUFFICIENT_STOCK',
              available: totalOriginalStock - currentCartQty,
              requested: 1
            }, 'WARNING');
            showToast(`‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å ${name} ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${totalOriginalStock - currentCartQty} ‡∏ä‡∏¥‡πâ‡∏ô)`, 'warning');
            cartOperationLocks.delete(lockKey);
            return;
          }
        }

        exist.qty++;
        logAuditEvent('ADD_TO_CART_SUCCESS', {
          ...auditDetails,
          action: 'QUANTITY_INCREASED',
          newQuantity: exist.qty,
          previousQuantity: exist.qty - 1
        }, 'INFO');
        showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${name} ‡πÄ‡∏õ‡πá‡∏ô ${exist.qty} ‡∏ä‡∏¥‡πâ‡∏ô`, 'success');
    
        // POS Notification
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
            message: `${name} ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ ${exist.qty} ‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤`,
            type: 'info',
            icon: 'üìà'
          });
        }
      } else {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        if (stockType === 'quantity') {
          // ‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
          const sameNameItems = approvedStocks.filter(item => item.name === name);
          const totalOriginalStock = sameNameItems.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
          const currentCartQty = cartItems
            .filter(item => {
              return sameNameItems.some(sameItem => sameItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          if (currentCartQty >= totalOriginalStock) {
            showToast(`‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${name} ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å`, 'warning');
            return;
          }
        }

        cartItems.push({
          id,
          name,
          model,
          price: parseFloat(price),
          imei: imei || '', // ‡πÄ‡∏Å‡πá‡∏ö IMEI ‡∏´‡∏£‡∏∑‡∏≠ empty string
          taxType,
          poNumber,
          supplierId: supplier,
          qty: 1,
          stockType: stockType // ‡πÄ‡∏û‡∏¥‡πà‡∏° stockType ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        });

        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ quantity ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô
        if (imei) {
          hiddenProductIds.add(id);
        }

        showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${name} ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
        // POS Notification - New item added
        if (posNotificationSystem) {
          const stockText = stockType === 'imei' ? `IMEI: ${imei}` : '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 1 ‡∏ä‡∏¥‡πâ‡∏ô';
          posNotificationSystem.showToast('pos', {
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà',
            message: `${name} (${stockText}) ‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ø${formatPrice(price)}`,
            type: 'success',
            icon: 'üõí'
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤',
            message: `${name} - ‡∏ø${formatPrice(price)}`,
            type: 'info',
            icon: 'üõçÔ∏è',
            metadata: {
              productId: id,
              productName: name,
              price: price,
              stockType: stockType,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }

      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stock_value ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì real-time ‡πÉ‡∏ô renderLevel3

      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
      const lvl1 = document.getElementById('level1Container');
      const lvl2 = document.getElementById('level2Container');
      const lvl3 = document.getElementById('level3Container');

      if (!lvl1.classList.contains('hidden')) {
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 1
        loadLevel1();
      } else if (!lvl2.classList.contains('hidden')) {
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 2
        const parentLabel = document.getElementById('level2Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ', '');
        const parentKey = parentLabel.toLowerCase();
        renderLevel2(Object.keys(window.level2Groups || {}));
      } else if (!lvl3.classList.contains('hidden')) {
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 3
        const base = document.getElementById('level3Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ', '');
        renderLevel3(level2Groups[base]);
      }

      renderCart();

        // ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        checkAvailablePromotions();

      } catch (error) {
        console.error('‚ùå Error in addToCart:', error);
        logAuditEvent('ADD_TO_CART_ERROR', {
          productId: id,
          productName: name,
          error: error.message,
          lockKey: lockKey
        }, 'ERROR');
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      } finally {
        // Always release the lock
        cartOperationLocks.delete(lockKey);
      }
    }

    // Wrap ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° confetti
    const originalAddToCart = addToCart;
    window.addToCart = function (id, name, price, imei, taxType, model, poNumber, supplier) {
      // Note: The prompt changed checkItemHasPromotion to checkPromotionForProduct
      const hasPromo = checkPromotionForProduct(id);

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      originalAddToCart.call(this, id, name, price, imei, taxType, model, poNumber, supplier);

      if (hasPromo) {
        // ‡πÅ‡∏™‡∏î‡∏á confetti effect
        const mainContent = document.getElementById('mainContent');
        createConfettiEffect(mainContent);

        // ‡πÅ‡∏™‡∏î‡∏á toast ‡∏û‡∏¥‡πÄ‡∏®‡∏©
        showToast(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ${name} ‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©!`, 'success');
    
        // POS Notification - Promotion detected
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©! üéâ',
            message: `${name} ‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©!`,
            type: 'success',
            icon: 'üî•',
            duration: 6000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ',
            message: `${name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß`,
            type: 'success',
            icon: 'üéÅ',
            metadata: {
              productName: name,
              productId: id,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }
    };

    // Check if there's a pending deposit product to add to cart
    if (window.pendingDepositProduct) {
      console.log('üîÑ Processing pending deposit product:', window.pendingDepositProduct);
      const product = window.pendingDepositProduct;
    
      // Add to cart now that addToCart function is available
      addToCart(
        product.id,
        product.name,
        product.price,
        product.imei,
        product.taxType,
        product.model,
        product.poNumber,
        product.supplier
      );
    
      // Clear the pending product
      delete window.pendingDepositProduct;
      console.log('‚úÖ Pending deposit product added to cart and cleared');
    }

    function removeFromCart(index) {
      const removed = cartItems[index];
      cartItems.splice(index, 1);
      if (removed) {
        // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏±‡∏ö (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ quantity ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å)
        if (removed.imei) {
          hiddenProductIds.delete(removed.id);
        }

        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì real-time ‡∏à‡∏≤‡∏Å originalStockValue

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        const lvl1 = document.getElementById('level1Container');
        const lvl2 = document.getElementById('level2Container');
        const lvl3 = document.getElementById('level3Container');

        if (!lvl1.classList.contains('hidden')) {
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 1
          loadLevel1();
        } else if (!lvl2.classList.contains('hidden')) {
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 2
          renderLevel2(Object.keys(window.level2Groups || {}));
        } else if (!lvl3.classList.contains('hidden')) {
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 3
          const base = document.getElementById('level3Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ', '');
          renderLevel3(level2Groups[base]);
        }
      }
      renderCart();
      showToast(`üóëÔ∏è ‡∏•‡∏ö ${removed?.name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'info');
    
      // POS Notification - Item removed
      if (posNotificationSystem && removed) {
        posNotificationSystem.showToast('pos', {
          title: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤',
          message: `${removed.name} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'warning',
          icon: 'üóëÔ∏è'
        });
      }
    }

    /**
     * Clear all items from cart and reset related data
     * Implements proper cart clearing with audit logging and UI updates
     */
    function clearCart() {
      try {
        // Log audit event before clearing cart
        logAuditEvent('CART_CLEARED', {
          branchCode: BRANCH_CODE,
          sessionId: window.currentSession?.sessionId,
          itemCount: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
          staffId: staffName || 'unknown',
          timestamp: new Date().toISOString()
        }, 'INFO');

        // Clear IMEI products from hidden list
        cartItems.forEach(item => {
          if (item.imei) {
            hiddenProductIds.delete(item.id);
          }
        });

        // Clear cart array and related data
        cartItems = [];
        hiddenProductIds.clear();
        appliedPromotions = {};

        // Clear cached promotion data
        if (typeof promotionCache !== 'undefined' && promotionCache.clear) {
          promotionCache.clear();
        }

        // Update UI elements
        document.getElementById('cartCount').textContent = '0';

        // Update promotion display
        document.getElementById('promotionDiscount').textContent = '0.00 ‡∏ø';
        const appliedPromotionsEl = document.getElementById('appliedPromotions');
        if (appliedPromotionsEl) {
          appliedPromotionsEl.innerHTML = '';
          appliedPromotionsEl.classList.add('hidden');
        }

        // Update Firebase RTDB and Socket.IO
        if (window.updateCartCountToFirebase) {
          window.updateCartCountToFirebase(0);
        }

        // Emit cart update via Socket.IO
        if (window.emitCartUpdate) {
          window.emitCartUpdate([]);
        }

        // Refresh UI based on current level
        const lvl1 = document.getElementById('level1Container');
        const lvl2 = document.getElementById('level2Container');
        const lvl3 = document.getElementById('level3Container');

        if (lvl1 && !lvl1.classList.contains('hidden')) {
          loadLevel1();
        } else if (lvl2 && !lvl2.classList.contains('hidden')) {
          renderLevel2(Object.keys(window.level2Groups || {}));
        } else if (lvl3 && !lvl3.classList.contains('hidden')) {
          const base = document.getElementById('level3Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ', '');
          renderLevel3(level2Groups[base]);
        }

        // Render empty cart
        renderCart();

        // Show success message
        showToast('üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

        // POS Notification - Cart cleared
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
            type: 'success',
            icon: 'üßπ'
          });
        }

        console.log('‚úÖ Cart cleared successfully');

      } catch (error) {
        console.error('‚ùå Error clearing cart:', error);

        // Log error for audit
        logAuditEvent('CART_CLEAR_FAILED', {
          branchCode: BRANCH_CODE,
          error: error.message,
          stack: error.stack,
          staffId: staffName || 'unknown'
        }, 'ERROR');

        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', 'error');
      }
    }

    // ==================== PROMOTION FUNCTIONS ====================
    // ‚Äî ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà debounce+cache ‚Äî
    let checkPromotionsTimeout = null;
    let isCheckingPromotions = false;
    let lastCheckedProductIds = '';
    let promotionCache = new Map();
    const CACHE_DURATION = 5 * 60 * 1000; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
    const DEBOUNCE_DELAY = 1000; // 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    let appliedPromotions = {};

    // debounce wrapper
    async function checkAvailablePromotions() {
      if (!cartItems.length) {
        appliedPromotions = {};
        document.getElementById('promotionDiscount').textContent = '0.00 ‡∏ø';
        document.getElementById('appliedPromotions').classList.add('hidden');
        return;
      }
      if (checkPromotionsTimeout) clearTimeout(checkPromotionsTimeout);
      checkPromotionsTimeout = setTimeout(doCheckPromotions, DEBOUNCE_DELAY);
    }

    async function doCheckPromotions() {
      if (isCheckingPromotions) return;
      isCheckingPromotions = true;
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const ids = [...new Set(cartItems.map(i => i.id))].sort(); // These are branchStockIds

        // Log the branchStockIds being sent and other relevant info
        console.log('üîç Checking promotions for products (branchStockIds):', ids, 'for branchCode:', BRANCH_CODE);
        // The user's example also logged activePromotions.length, which might be relevant for context.'
        // console.log('üìä Active client-side promotions (for UI hints):', activePromotions.length);


        const cacheKey = ids.join(',');
        if (cacheKey === lastCheckedProductIds) return;
        const cached = promotionCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
          displayAvailablePromotions(cached.data);
          lastCheckedProductIds = cacheKey;
          return;
        }
        const res = await fetch('/api/promotion/check-available', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
        });
        if (res.status === 429) {
          if (cached) {
            displayAvailablePromotions(cached.data);
            lastCheckedProductIds = cacheKey;
          } else {
            setTimeout(() => { isCheckingPromotions = false; doCheckPromotions(); }, 10000);
          }
          return;
        }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const js = await res.json();

        // Log the API response
        console.log('üì¶ API Response from /api/promotion/check-available:', js);

        if (js.status === 'success') {
          promotionCache.set(cacheKey, { data: js.data || {}, timestamp: Date.now() });
          displayAvailablePromotions(js.data || {});
          lastCheckedProductIds = cacheKey;
        }
      } catch (err) {
        const ids = [...new Set(cartItems.map(i => i.id))].sort();
        const cacheKey = ids.join(',');
        const cached = promotionCache.get(cacheKey);
        if (cached) displayAvailablePromotions(cached.data);
        else {
          appliedPromotions = {};
          updatePromotionDisplay();
        }
        console.error('Error checking promotions:', err);
      } finally {
        isCheckingPromotions = false;
      }
    }

    function displayAvailablePromotions(data) {
      appliedPromotions = {};
      cartItems.forEach(item => {
        const promos = data[item.id] || [];
        if (promos.length) {
          const best = promos.reduce((b, p) => {
            const v = p.type === 'percentage' ? item.price * (p.discount / 100) : p.type === 'fixed' ? p.discount : 0;
            const bv = b.type === 'percentage' ? item.price * (b.discount / 100) : b.type === 'fixed' ? b.discount : 0;
            return v > bv ? p : b;
          });
          appliedPromotions[item.id] = best;
        }
      });
      updatePromotionDisplay();
    }

    function updatePromotionDisplay() {
      const rows = document.querySelectorAll('#cartTable tbody tr');
      cartItems.forEach((item, idx) => {
        const promo = appliedPromotions[item.id];
        const cell = rows[idx]?.cells[0];
        if (!cell) return;
        if (promo) {
          let discPerItem = 0;
          if (promo.type === 'percentage') {
            discPerItem = item.price * (promo.discount / 100);
          } else if (promo.type === 'fixed') {
            discPerItem = promo.discount;
          }
          const totalDisc = discPerItem * item.qty;
          const newPrice = (item.price * item.qty) - totalDisc;

          // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
          cell.innerHTML = `
        ${item.name}
        <span class="badge badge-error badge-sm ml-2">${promo.name}</span>
        <div class="text-xs">
          <span class="line-through">‡∏ø${formatPrice(item.price * item.qty)}</span>
          <span class="text-red-600 ml-2">‡∏ø${formatPrice(newPrice)}</span>
        </div>`;
        } else {
          cell.textContent = item.name;
        }
      });
      calculatePromotionDiscount();
      calcSummary();
    }

    function calculatePromotionDiscount() {
      let total = 0, details = [];
      Object.entries(appliedPromotions).forEach(([pid, p]) => {
        const it = cartItems.find(i => i.id === pid);
        if (!it) return;
        let discPerItem = 0;
        if (p.type === 'discount_percentage') {
          discPerItem = it.price * (p.discount / 100);
        } else if (p.type === 'discount_amount') {
          discPerItem = p.discount;
        }
        total += discPerItem * it.qty;
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        details.push({
          name: p.name,
          discount: discPerItem * it.qty,
          productName: it.name
        });
      });
      document.getElementById('promotionDiscount').textContent = '-‡∏ø' + formatPrice(total);
      const el = document.getElementById('appliedPromotions');
      if (Array.isArray(details) && details.length > 0) {
        // Safely create promotion details to prevent XSS
        SecurityHelpers.safeSetContent(el, '', '');

        details.forEach(d => {
          const detailDiv = document.createElement('div');
          detailDiv.className = 'text-xs';

          // Sanitize data before displaying
          const promotionName = (d.name || '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô').toString();
          const productName = (d.productName || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤').toString();
          const discount = formatPrice(d.discount || 0);

          detailDiv.textContent = `‚Ä¢ ${promotionName} (${productName}): -‡∏ø${discount}`;
          el.appendChild(detailDiv);
        });

        el.classList.remove('hidden');
      } else {
        SecurityHelpers.safeSetContent(el, '', '');
        el.classList.add('hidden');
      }
      return total;
    }

    async function recordPromotionUsage(promotionId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/use', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ promotionId }) });
        const js = await res.json();
        if (js.status !== 'success') console.error('Failed to record promotion usage:', js.message);
      } catch (err) {
        console.error('Error recording promotion usage:', err);
      }
    }

    function clearPromotionCache() {
      promotionCache.clear();
      lastCheckedProductIds = '';
      appliedPromotions = {};
      console.log('üßπ Promotion cache cleared');
    }

    // ==================== end PROMOTION FIX ====================

    // ‡πÅ‡∏Å‡πâ renderCart: ‡πÄ‡∏≠‡∏≤ checkAvailablePromotions ‡∏≠‡∏≠‡∏Å
    function renderCart() {
      // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      document.getElementById('cartCount').textContent = cartItems.length;

      // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firebase RTDB ‡πÅ‡∏•‡∏∞ Socket.IO
      if (window.updateCartCountToFirebase) {
        window.updateCartCountToFirebase(cartItems.length);
      }

      const tbody = document.querySelector('#cartTable tbody');
      tbody.innerHTML = '';

      // 3) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢
      if (cartItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-gray-500 py-6">
              <i class="bi bi-cart-x text-3xl mb-2 block"></i>
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            </td>
          </tr>`;
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        document.getElementById('subTotal').textContent = '0.00 ‡∏ø';
        document.getElementById('vatAmount').textContent = '0.00 ‡∏ø';
        document.getElementById('discountAmount').textContent = '0.00 ‡∏ø';
        document.getElementById('totalPrice').textContent = '0.00 ‡∏ø';
        // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ)
        const docEl = document.getElementById('docTypeLabel');
        if (docEl) docEl.textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';
        return;
      }

      // 4) ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥
      let subTotal = 0;
      cartItems.forEach((item, idx) => {
        const lineTotal = item.qty * item.price;
        subTotal += lineTotal;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á badge ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const promo = appliedPromotions[item.id];
        const promoHTML = promo
          ? `<span class="badge badge-error badge-sm ml-2">${promo.name}</span>`
          : '';

        const tr = document.createElement('tr');
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß
        let cellName;
        if (promo) {
          const disc = promo.type === 'percentage'
            ? item.price * (promo.discount / 100)
            : promo.discount;
          const newPrice = item.price - disc;
          cellName = `
          ${item.name}
          <span class="badge badge-error badge-sm ml-2">${promo.name}</span>
          <div class="text-xs">
            <span class="line-through">‡∏ø${formatPrice(item.price)}</span>
            <span class="text-red-600 ml-2">‡∏ø${formatPrice(newPrice)}</span>
          </div>
          ${item.imei ? `<div class="text-xs text-blue-600 font-mono mt-1">IMEI: ${item.imei}</div>` : ''}`;
        } else {
          cellName = `${item.name}
            <div class="text-xs text-gray-500">
              ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.qty}
              ${item.imei ? `<br>IMEI: <span class="font-mono text-blue-600">${item.imei}</span>` : ''}
            </div>`;
        }
        tr.innerHTML = `
        <td>${cellName}</td>
        <td>‡∏ø${formatPrice(item.price)}</td>
        <td>‡∏ø${formatPrice(lineTotal)}</td>
        <td>
          <button class="btn btn-sm btn-error" data-idx="${idx}">
            <i class="bi bi-trash"></i>
          </button>
        </td>`;
        tr.querySelector('button')
          .addEventListener('click', () => removeFromCart(idx));
        tbody.appendChild(tr);
      });

      // 5) ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≠
      document.getElementById('subTotal').textContent = formatPrice(subTotal);
      calcSummary();
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      if (cartItems.length > 0) checkAvailablePromotions();
    }



    // [‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß - ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô applyGlobalTaxType ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥]

    function calcSummary() {
      const vatRate = parseFloat(document.getElementById('vatRate').value) || 7;
      let subTotal = 0;
      let vatAmount = 0;
      let totalBeforeDiscount = 0;

      cartItems.forEach(item => {
        const line = item.price * item.qty;
        subTotal += line;

        // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
        const effectiveTaxType = item.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ';
    
        if (effectiveTaxType === '‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ') {
          // ‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏£‡∏≤‡∏Ñ‡∏≤ = ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ + ‡∏†‡∏≤‡∏©‡∏µ
          const netAmount = line / (1 + vatRate / 100);
          const taxAmount = line - netAmount;
          vatAmount += taxAmount;
          totalBeforeDiscount += line; // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ
        }
        else if (effectiveTaxType === '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ') {
          // ‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° = ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ + ‡∏†‡∏≤‡∏©‡∏µ
          const taxAmount = line * (vatRate / 100);
          vatAmount += taxAmount;
          totalBeforeDiscount += (line + taxAmount); // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ + ‡∏†‡∏≤‡∏©‡∏µ
        }
        else { // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ
          totalBeforeDiscount += line;
        }
      });

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
      const discountInput = document.getElementById('discount').value.trim();
      let discountVal = 0;
      if (discountInput.endsWith('%')) {
        const perc = parseFloat(discountInput);
        if (!isNaN(perc)) discountVal = (perc / 100) * totalBeforeDiscount;
      } else {
        const num = parseFloat(discountInput);
        if (!isNaN(num)) discountVal = num;
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
      const promoDisc = calculatePromotionDiscount();
      const totalDiscount = discountVal + promoDisc;
      let finalTotal = totalBeforeDiscount - totalDiscount;

      // üí∞ ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
      let depositAmountUsed = 0;
      if (window.depositReceiptInfo && window.depositReceiptInfo.depositAmount > 0) {
        depositAmountUsed = window.depositReceiptInfo.depositAmount;
        finalTotal = finalTotal - depositAmountUsed;
        console.log(`üí∞ ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${depositAmountUsed.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
        console.log(`üíµ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${finalTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
        const depositRow = document.getElementById('depositDeductionRow');
        const depositAmount = document.getElementById('depositDeductionAmount');
        if (depositRow && depositAmount) {
          depositRow.style.display = 'flex';
          depositAmount.textContent = `-${formatPrice(depositAmountUsed)}`;
        }
      } else {
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
        const depositRow = document.getElementById('depositDeductionRow');
        if (depositRow) {
          depositRow.style.display = 'none';
        }
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï DOM
      document.getElementById('subTotal').textContent = formatPrice(subTotal);
      document.getElementById('vatAmount').textContent = formatPrice(vatAmount);
      document.getElementById('discountAmount').textContent = formatPrice(discountVal);
      document.getElementById('totalPrice').textContent = formatPrice(finalTotal);

      // ‚úÖ Determine if tax invoice is needed
      // Tax invoice is needed if there's VAT amount or if customer type is business
      const customerType = document.getElementById('customerType')?.value || 'individual';
      const needTaxInvoice = vatAmount > 0 || customerType === 'business';
    
      // ‚úÖ Return calculated values for reuse in checkout
      return {
        subTotal,
        vatAmount,
        totalBeforeDiscount,
        finalTotal: finalTotal,
        needTaxInvoice,
        vatRate
      };
    }


    // ‚úÖ Enhanced: ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HistoryReceipt.html ‡∏ó‡∏µ‡πà integrate ‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // PrinterSystem ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å /js/printer-service.js ‡πÅ‡∏ó‡∏ô

    // ‚úÖ Enhanced: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ PrinterService ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HistoryReceipt.html
    async function printReceiptOnClient(receiptImage) {
      try {
        if (!receiptImage) {
          console.warn('‚ö†Ô∏è No receipt image provided for printing');
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå', 'warning');
          }
          return { success: false, error: 'No receipt image' };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ PrinterService ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (typeof window.PrinterService === 'undefined') {
          console.warn('‚ö†Ô∏è PrinterService not available, using fallback method');
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          }
          return { success: false, error: 'PrinterService not available' };
        }

        // ‚úÖ Fix: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const customerType = document.getElementById('customerType')?.value || 'individual';
        let customerName = '';
        let customerEmail = '';
        let customerTaxId = '';

        if (customerType === 'individual') {
          // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
          const prefix = document.getElementById('customerPrefix')?.value || '';
          const firstName = document.getElementById('customerFirstName')?.value || '';
          const lastName = document.getElementById('customerLastName')?.value || '';
          customerName = `${prefix}${firstName} ${lastName}`.trim();
          customerEmail = document.getElementById('customerEmailPersonal')?.value || '';
          customerTaxId = document.getElementById('customerTaxId')?.value || '';
        } else {
          // ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
          customerName = document.getElementById('companyName')?.value || '';
          customerEmail = document.getElementById('corporateEmail')?.value || '';
          customerTaxId = document.getElementById('companyTaxId')?.value || '';
        }

        const orderData = {
          items: cartItems.map(item => ({
            name: item.name,
            quantity: item.qty,
            price: item.price,
            total: item.qty * item.price,
            imei: item.imei
          })),
          total: cartItems.reduce((sum, item) => sum + (item.qty * item.price), 0),
          customerInfo: {
            type: customerType,
            taxId: customerTaxId,
            name: customerName,
            email: customerEmail
          },
          documentType: 'frontstore_receipt',
          timestamp: new Date().toISOString()
        };

        console.log('üñ®Ô∏è Print order data via PrinterService:', orderData);
    
        // üîç Audit Log - Print attempt
        logAuditEvent('PRINT_ATTEMPT', {
          customerType: customerType,
          customerName: customerName,
          totalAmount: orderData.total,
          itemCount: orderData.items.length,
          printMethod: 'PrinterService'
        }, 'INFO');
    
        // ‡πÉ‡∏ä‡πâ PrinterService.print() ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HistoryReceipt.html
        const result = await window.PrinterService.print(receiptImage, orderData);
    
        if (result && result.success) {
          // üîç Audit Log - Print success
          logAuditEvent('PRINT_SUCCESS', {
            customerType: customerType,
            customerName: customerName,
            totalAmount: orderData.total,
            printMethod: 'PrinterService'
          }, 'SUCCESS');
    
          if (typeof showToast === 'function') {
            showToast('‚úÖ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
          }
          return result;
        } else {
          throw new Error(result?.error || 'PrinterService failed');
        }
    
      } catch (error) {
        console.error('Error printing receipt via PrinterService:', error);
    
        // ‚úÖ Fix: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà error ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        const customerType = document.getElementById('customerType')?.value || 'individual';
        let customerName = '';
    
        if (customerType === 'individual') {
          const prefix = document.getElementById('customerPrefix')?.value || '';
          const firstName = document.getElementById('customerFirstName')?.value || '';
          const lastName = document.getElementById('customerLastName')?.value || '';
          customerName = `${prefix}${firstName} ${lastName}`.trim();
        } else {
          customerName = document.getElementById('companyName')?.value || '';
        }
    
        // üîç Audit Log - Print failure
        logAuditEvent('PRINT_FAILED', {
          customerType: customerType || 'unknown',
          customerName: customerName || 'unknown',
          totalAmount: cartItems?.reduce((sum, item) => sum + (item.qty * item.price), 0) || 0,
          error: error.message,
          printMethod: 'PrinterService',
          errorType: error.message.includes('CSP') ? 'CSP_VIOLATION' :
                     error.message.includes('Failed to fetch') ? 'NETWORK_ERROR' :
                     error.message.includes('‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') ? 'PRINTER_OFFLINE' : 'UNKNOWN'
        }, 'WARNING');
    
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏
        let userMessage = '';
        let toastType = 'warning';
    
        if (error.message.includes('CSP') || error.message.includes('Content Security Policy')) {
          userMessage = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          userMessage = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ (‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)';
        } else if (error.message.includes('‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')) {
          userMessage = '‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)';
        } else {
          userMessage = `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ: ${error.message} (‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)`;
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á error message ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (typeof showToast === 'function') {
          showToast(userMessage, toastType);
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
          setTimeout(() => {
            showToast('üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'info');
          }, 2000);
        }
    
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ error ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        return {
          success: false,
          error: error.message,
          userMessage: userMessage
        };
      }
    }
    function singleCheckout() {
      if (cartItems.length === 0) {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', 'warning');
        return;
      }
      const taxId = document.getElementById('customerTaxId').value.trim();
      if (!taxId) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ', 'warning');
        return;
      }
      customConfirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
        const btn = document.getElementById('btnSingleCheckout');
        btn.disabled = true;
        btn.classList.add('loading');
        doCheckout().finally(() => {
          btn.disabled = false;
          btn.classList.remove('loading');
        });
      });
    }


    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
    async function checkEmailServiceStatus() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/email/config', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          return {
            available: result.success && result.data?.serviceEnabled,
            details: result.data
          };
        }
        return { available: false, error: `HTTP ${response.status}` };
      } catch (error) {
        console.warn('Cannot check email service status:', error);
        return { available: false, error: error.message };
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô UI
    function updateEmailServiceIndicator() {
      checkEmailServiceStatus().then(status => {
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        const emailLabel = emailCheckbox?.parentElement;
    
        if (emailLabel) {
          // ‡∏•‡∏ö indicator ‡πÄ‡∏Å‡πà‡∏≤
          const oldIndicator = emailLabel.querySelector('.email-status-indicator');
          if (oldIndicator) oldIndicator.remove();
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° indicator ‡πÉ‡∏´‡∏°‡πà
          const indicator = document.createElement('span');
          indicator.className = 'email-status-indicator text-xs ml-2';
    
          if (status.available) {
            indicator.innerHTML = '<span class="text-green-600">üü¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
            emailCheckbox.disabled = false;
          } else {
            indicator.innerHTML = '<span class="text-orange-600">üü° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°</span>';
            emailCheckbox.checked = false;
            emailCheckbox.disabled = true;
          }
    
          emailLabel.appendChild(indicator);
        }
      }).catch(err => {
        console.warn('Failed to update email service indicator:', err);
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    async function sendReceiptEmail(emailData) {
      try {
        showToast('üìß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...', 'info');
    
        const token = localStorage.getItem('authToken');
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å doCheckout
        const orderId = emailData.orderId || emailData.documentId || emailData.document_id || emailData.order_id || emailData.invoiceId || emailData._id;
        const invoiceNo = emailData.invoiceNo || emailData.documentNumber || emailData.document_no || emailData.invoice_no || emailData.order_number;
        const docType = (emailData.documentType || '').toString().toUpperCase();
        const payload = {
          orderId: orderId,
          invoiceNo: invoiceNo,
          email: emailData.customerEmail,
          customerName: emailData.customerName,
          // ‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô receipt)
          type: docType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt',
          documents: {
            receipt: true,
            taxInvoice: docType === 'TAX_INVOICE' ? true : false
          }
        };

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô 400 ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
        if (!payload.email || !payload.orderId || !payload.invoiceNo) {
          throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ email, orderId, invoiceNo)');
        }

        const response = await fetch('/api/email/send-receipt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload),
          timeout: 10000 // 10 second timeout
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response status ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
        if (response.status === 503) {
          throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        }
    
        if (response.status === 500) {
          throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        }
    
        if (response.status === 404) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
        }

        const result = await response.json().catch(() => ({ success: false, message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ' }));

        if (response.ok && result.success) {
          showToast(`‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${emailData.customerEmail} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
          // üîç Audit Log - Email sent
          logAuditEvent('EMAIL_SENT_SUCCESS', {
            orderId: emailData.orderId,
            invoiceNo: emailData.invoiceNo,
            email: emailData.customerEmail,
            customerType: emailData.customerType
          }, 'SUCCESS');
        } else {
          throw new Error(result.message || `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (HTTP ${response.status})`);
        }

      } catch (error) {
        console.error('Send email error:', error);
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå
        let userMessage = '';
        if (error.message.includes('503') || error.message.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')) {
          userMessage = `‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° | ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•`;
          showToast(userMessage, 'warning');
          showToast('üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô Line, SMS ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'info');
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          userMessage = `üåê ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ | ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï`;
          showToast(userMessage, 'warning');
        } else {
          userMessage = `‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
          showToast(userMessage, 'warning');
        }
    
        // üîç Audit Log - Email failed with more details
        logAuditEvent('EMAIL_SENT_FAILED', {
          orderId: emailData.orderId,
          email: emailData.customerEmail,
          error: error.message,
          timestamp: new Date().toISOString(),
          suggestion: 'Manual delivery required'
        }, 'WARNING');
    
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        try {
          const failedEmails = JSON.parse(localStorage.getItem('failedEmails') || '[]');
          failedEmails.push({
            ...emailData,
            failedAt: new Date().toISOString(),
            error: error.message
          });
          localStorage.setItem('failedEmails', JSON.stringify(failedEmails.slice(-50))); // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          console.log('üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        } catch (storageError) {
          console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÑ‡∏î‡πâ:', storageError);
        }
    
        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ error ‡∏ô‡∏µ‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å
      }
    }

    async function doCheckout() {
      // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® loaderId ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å try block
      let loaderId = null;
    
      // üîê Transaction Lock
      const transactionId = `checkout_${Date.now()}`;
      if (!acquireTransactionLock(transactionId)) {
        showToast('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'warning');
        return;
      }

      try {
        // Show loading
        showLoading(true);
        // üîê Security Validation
        if (!validateSession()) {
          releaseTransactionLock(transactionId);
          return;
        }

        if (!checkRateLimit('checkout', 3, 300000)) { // 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
          logAuditEvent('CHECKOUT_RATE_LIMITED', { transactionId }, 'WARNING');
          showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 5 ‡∏ô‡∏≤‡∏ó‡∏µ', 'warning');
          releaseTransactionLock(transactionId);
          return;
        }

        const token = localStorage.getItem('authToken') || '';
        const staffId = localStorage.getItem('userId');
        const staffNameFromStorage = localStorage.getItem('userName');

        // üîç Audit Log - Checkout Start
        logAuditEvent('CHECKOUT_START', {
          transactionId,
          cartItems: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
          staffId,
          branchCode: BRANCH_CODE
        }, 'INFO');

        // (0) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ staffId ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!staffId) {
          logAuditEvent('CHECKOUT_FAILED', {
            transactionId,
            reason: 'NO_STAFF_ID'
          }, 'ERROR');
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        }

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
        const staffNameFromToken = localStorage.getItem('staffName');
        const staffNameFromUserProfile = (() => {
          try {
            const profile = localStorage.getItem('userProfile');
            return profile ? JSON.parse(profile).name : null;
          } catch (e) {
            return null;
          }
        })();
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å current session/API ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        let currentStaffName = null;
    
        // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage.userName ‡∏Å‡πà‡∏≠‡∏ô (‡∏ó‡∏µ‡πà loadEmployeeProfile() ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ)
        if (staffNameFromStorage && staffNameFromStorage !== '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' && staffNameFromStorage !== 'Guest') {
          currentStaffName = staffNameFromStorage;
          console.log('‚úÖ Using staff name from localStorage.userName:', currentStaffName);
        }
        // 2. ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ global staffName ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≤‡∏Å loadEmployeeProfile()
        else if (staffName && staffName !== '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' && staffName !== 'Guest') {
          currentStaffName = staffName;
          console.log('‚úÖ Using global staffName:', currentStaffName);
        }
        // 3. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å staffNameFromToken
        else if (staffNameFromToken && staffNameFromToken !== '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' && staffNameFromToken !== 'Guest') {
          currentStaffName = staffNameFromToken;
          console.log('‚úÖ Using staff name from token:', currentStaffName);
        }
        // 4. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å userProfile
        else if (staffNameFromUserProfile && staffNameFromUserProfile !== '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' && staffNameFromUserProfile !== 'Guest') {
          currentStaffName = staffNameFromUserProfile;
          console.log('‚úÖ Using staff name from user profile:', currentStaffName);
        }
        // 5. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        else {
          console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡πÉ‡∏î‡πÄ‡∏•‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API...');
          try {
            const token = localStorage.getItem('authToken');
            if (token) {
              const userResponse = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
              });
              const userData = await userResponse.json();
              if (userData.success && userData.data && userData.data.name) {
                currentStaffName = userData.data.name;
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó localStorage ‡πÅ‡∏•‡∏∞ global variable ‡∏î‡πâ‡∏ß‡∏¢
                localStorage.setItem('userName', currentStaffName);
                staffName = currentStaffName;
                console.log('‚úÖ Retrieved staff name from API:', currentStaffName);
              }
            }
          } catch (apiError) {
            console.error('‚ùå Failed to get staff name from API:', apiError);
          }
        }
    
        // Fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if (!currentStaffName) {
          currentStaffName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          console.warn('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ fallback:', currentStaffName);
        }
    
        // Debug log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        console.log('üîç Staff Name Debug - Final Check:', {
          currentStaffName: currentStaffName,
          staffNameFromStorage: staffNameFromStorage,
          globalStaffName: staffName,
          staffNameFromToken: staffNameFromToken,
          staffNameFromUserProfile: staffNameFromUserProfile,
          localStorage_userName: localStorage.getItem('userName'),
          localStorage_staffName: localStorage.getItem('staffName')
        });
    
        // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        console.log('üîç Staff Name Debug:', {
          staffId: staffId,
          staffNameFromStorage: staffNameFromStorage,
          staffNameFromToken: staffNameFromToken,
          staffNameFromUserProfile: staffNameFromUserProfile,
          globalStaffName: staffName,
          finalStaffName: currentStaffName,
          isDefaultName: currentStaffName === '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'
        });
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ default
        if (currentStaffName === '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô') {
          console.warn("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ default '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' - ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£ login");
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
          }
        } else {
          console.log('‚úÖ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', currentStaffName);
        }

        // ‚úÖ Fix: ‡πÄ‡∏û‡∏¥‡πà‡∏° null safety ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
        const customerTypeElement = document.getElementById('customerType');
        if (!customerTypeElement) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
        }
    
        const customerType = customerTypeElement.value;
        let customerInfo = {}, corporateInfo = {}, customerTaxId = '', companyTaxId = '';

        if (customerType === 'individual') {
          const taxIdElement = document.getElementById('customerTaxId');
          if (!taxIdElement) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
          }
    
          customerTaxId = sanitizeInput(taxIdElement.value, 'taxId');
          if (!customerTaxId || customerTaxId.length !== 13) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INVALID_TAX_ID',
              providedTaxId: customerTaxId?.length || 0
            }, 'WARNING');
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ 13 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          }

          // ‚úÖ Fix: ‡πÄ‡∏û‡∏¥‡πà‡∏° null safety ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå
          const getElementValue = (id, defaultValue = '') => {
            const element = document.getElementById(id);
            if (!element) {
              console.warn(`‚ö†Ô∏è Element with id '${id}' not found, using default value`);
              return defaultValue;
            }
            return element.value || defaultValue;
          };

          customerInfo = {
            prefix: sanitizeInput(getElementValue('customerPrefix'), 'text'),
            gender: sanitizeInput(getElementValue('customerGender'), 'text'),
            firstName: sanitizeInput(getElementValue('customerFirstName'), 'text'),
            lastName: sanitizeInput(getElementValue('customerLastName'), 'text'),
            phone: sanitizeInput(getElementValue('customerPhone'), 'phone'),
            phoneNumber: sanitizeInput(getElementValue('customerPhone'), 'phone'), // ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend
            email: sanitizeInput(getElementValue('customerEmailPersonal'), 'text'),
            age: parseInt(getElementValue('customerAge')) || null,
            birthDate: getElementValue('customerBirthDate') || null,
            occupation: {
              category: sanitizeInput(getElementValue('customerOccupation'), 'text')
            },
            address: {
              houseNo: sanitizeInput(getElementValue('houseNo'), 'text'),
              moo: sanitizeInput(getElementValue('moo'), 'text'),
              subDistrict: sanitizeInput(getElementValue('subDistrict'), 'text'),
              district: sanitizeInput(getElementValue('district'), 'text'),
              province: sanitizeInput(getElementValue('province'), 'text'),
              zipcode: sanitizeInput(getElementValue('zipcode'), 'number'),
            },
            taxId: customerTaxId
          };

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
          if (!customerInfo.firstName || !customerInfo.lastName) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INCOMPLETE_CUSTOMER_INFO',
              missingFields: ['firstName', 'lastName'].filter(field => !customerInfo[field])
            }, 'WARNING');
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
          }

        } else { // ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
          const companyTaxIdElement = document.getElementById('companyTaxId');
          if (!companyTaxIdElement) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
          }
    
          companyTaxId = sanitizeInput(companyTaxIdElement.value, 'taxId');
          if (!companyTaxId || companyTaxId.length !== 13) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INVALID_COMPANY_TAX_ID',
              providedTaxId: companyTaxId?.length || 0
            }, 'WARNING');
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• 13 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          }

          const companyName = sanitizeInput(getElementValue('companyName'), 'text');
          if (!companyName) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'MISSING_COMPANY_NAME'
            }, 'WARNING');
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
          }

          corporateInfo = {
            companyName: companyName,
            companyTaxId,
            contactPerson: sanitizeInput(getElementValue('contactPerson'), 'text'),
            corporatePhone: sanitizeInput(getElementValue('corporatePhone'), 'phone'),
            corporateEmail: sanitizeInput(getElementValue('corporateEmail'), 'text'),
            companyAddress: sanitizeInput(getElementValue('companyAddress'), 'text')
          };
        }

        // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô calcSummary() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ã‡πâ‡∏≥
        const calculationResult = calcSummary();
    
        if (!calculationResult) {
          throw new Error('‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
    
        const {
          subTotal: subTotalVal,
          vatAmount: vatAmountVal,
          totalBeforeDiscount,
          finalTotal,
          needTaxInvoice,
          vatRate
        } = calculationResult;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
        const promotionDiscount = calculatePromotionDiscount();
        const usedPromotions = Object.values(appliedPromotions).filter(p => p);
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î invoiceType - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠
        const invoiceType = 'BOTH_DOCUMENTS'; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        const saleType = 'cash'; // ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏™‡∏î

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô)
        const discountInputDoCheckout = document.getElementById('discount')?.value?.trim() || '';
        let discountVal = 0;
        if (discountInputDoCheckout.endsWith('%')) {
          const perc = parseFloat(discountInputDoCheckout);
          if (!isNaN(perc)) discountVal = (perc / 100) * totalBeforeDiscount;
        } else {
          const num = parseFloat(discountInputDoCheckout);
          if (!isNaN(num)) discountVal = num;
        }

        // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (finalTotal ‡∏à‡∏≤‡∏Å calcSummary() ‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á discount ‡πÅ‡∏•‡∏∞ promotion ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        const totalVal = finalTotal;

        // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ
        const netAmountVal = Math.max(totalVal - vatAmountVal, 0);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        const reservedItems = cartItems.filter(item => item.hasStockReservation);
        if (reservedItems.length > 0) {
          console.log('üîí Found reserved items in cart:', reservedItems);
    
          // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á
          for (const item of reservedItems) {
            if (typeof showToast === 'function') {
              showToast(
                `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á: ${item.name} (IMEI: ${item.imei})`,
                'info'
              );
            }
          }
        }

        // ‚úÖ Fix: ‡πÄ‡∏û‡∏¥‡πà‡∏° null safety ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö payment method
        const selectedPaymentElement = document.querySelector('input[name="paymentMethod"]:checked');
        console.log('üîç Debug payment selection:', {
          selectedElement: selectedPaymentElement,
          allPaymentMethods: document.querySelectorAll('input[name="paymentMethod"]').length,
          checkedCount: document.querySelectorAll('input[name="paymentMethod"]:checked').length
        });
    
        if (!selectedPaymentElement) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ radio buttons ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          const allPaymentInputs = document.querySelectorAll('input[name="paymentMethod"]');
          console.error('‚ùå Payment method selection debug:', {
            totalInputs: allPaymentInputs.length,
            inputsData: Array.from(allPaymentInputs).map(input => ({
              id: input.id,
              value: input.value,
              checked: input.checked,
              disabled: input.disabled
            }))
          });
    
          logAuditEvent('CHECKOUT_FAILED', {
            transactionId,
            reason: 'NO_PAYMENT_METHOD_SELECTED',
            debugInfo: {
              totalPaymentInputs: allPaymentInputs.length,
              checkedInputs: document.querySelectorAll('input[name="paymentMethod"]:checked').length
            }
          }, 'WARNING');
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ)');
        }
        const selectedPaymentMethod = selectedPaymentElement ? selectedPaymentElement.value : 'CASH';
        console.log('‚úÖ Selected payment method:', selectedPaymentMethod);

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î payment method ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö paymentInfo
        let paymentMethod = 'cash';
        if (selectedPaymentMethod === 'TRANSFER') {
          paymentMethod = 'transfer';
        } else if (selectedPaymentMethod === 'CARD') {
          paymentMethod = 'credit_card';
        } else if (selectedPaymentMethod === 'MIXED') {
          paymentMethod = 'mixed'; // ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà API ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        const formatAddress = (addr) => {
          if (!addr) return '';
          if (typeof addr === 'string') return addr;
          try {
            const parts = [
              addr.houseNo ? `‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${addr.houseNo}` : '',
              addr.moo ? `‡∏´‡∏°‡∏π‡πà ${addr.moo}` : '',
              addr.subDistrict ? `‡∏ï‡∏≥‡∏ö‡∏• ${addr.subDistrict}` : '',
              addr.district ? `‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${addr.district}` : '',
              addr.province ? `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${addr.province}` : '',
              addr.zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå ${addr.zipcode}` : ''
            ].filter(Boolean);
            return parts.join(' ').trim();
          } catch (e) {
            return '';
          }
        };

        const customerInfoForPayload = customerType === 'individual'
          ? { ...customerInfo, address: formatAddress(customerInfo.address) }
          : {};
        const corporateInfoForPayload = customerType === 'corporate'
          ? { ...corporateInfo, address: corporateInfo.companyAddress || '' }
          : {};

        // (3) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const basePayload = {
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö /api/taxinvoice/checkout)
          items: cartItems.map(item => ({
            id: item.id,
            name: item.name,
            qty: item.qty,
            price: item.price,
            total: item.qty * item.price,
            taxType: item.taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ',
            imei: item.imei || '',
            brand: item.brand || '',
            productCode: item.productCode || '',
            category: item.category || ''
          })),
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          customerType,
          customerInfo: customerInfoForPayload,
          ...(customerType === 'corporate' && { corporateInfo: corporateInfoForPayload }),
          customerTaxId,
          companyTaxId,
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
          subTotal: subTotalVal,
          vatAmount: vatAmountVal,
          netAmount: netAmountVal,
          discount: discountVal,
          promotionDiscount: promotionDiscount,
          total: totalVal,
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          paymentMethod: paymentMethod,
          paymentInfo: {
            received: true,
            method: paymentMethod,
            amount: totalVal,
            timestamp: new Date().toISOString()
          },
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô
          invoiceType: invoiceType,
          saleType: saleType, // ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏¢‡∏™‡∏î
          transactionType: 'sale',
          branch_code: BRANCH_CODE,
          staffId: staffId,
          staffName: currentStaffName,
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
          appliedPromotions: usedPromotions,
    
          // Timestamp
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        const now = new Date();
        const yearBE = now.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®.
        const yearShort = yearBE.toString().slice(-2); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 2 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const datePrefix = `${yearShort}${month}${day}`; // 680811
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        const documentNumberFormat = {
          receiptPrefix: 'RE',
          taxInvoicePrefix: 'TX',
          dateFormat: datePrefix,
          // backend ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô RE-680811-0001 ‡πÅ‡∏•‡∏∞ TX-680811-0001
        };
    
        // ‡πÉ‡∏ä‡πâ payload ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API /api/taxinvoice/checkout ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ
        const payload = {
          ...basePayload,
          documentNumberFormat: documentNumberFormat,
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° depositReceiptId ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏°‡∏±‡∏î‡∏à‡∏≥
          depositReceiptId: window.depositReceiptInfo?.depositReceiptId || null,
          // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchCode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API delivery-note (‡πÉ‡∏ä‡πâ camelCase)
          branchCode: BRANCH_CODE,
          branchName: localStorage.getItem('activeBranchName') || '‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å'
        };

        // (4) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API checkout ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ TaxInvoice/Receipt models
        console.log('üîß Staff Info Debug:', {
          staffId: staffId,
          staffNameFromStorage: staffNameFromStorage,
          globalStaffName: staffName,
          currentStaffName: currentStaffName
        });
    
        // Debug payload ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ staffName
        console.log('üìã Payload Debug - Staff Info:', {
          'payload.staffName': payload.staffName,
          'payload.staffId': payload.staffId,
          'typeof payload.staffName': typeof payload.staffName,
          'staffName isEmpty': !payload.staffName
        });
    
        console.log('üìã Document Number Format:', documentNumberFormat);
        console.log('Sending checkout payload:', JSON.stringify(payload, null, 2));

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å DepositReceipt ‡∏´‡∏£‡∏∑‡∏≠ frontstore ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        let rs;
        let apiEndpoint;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å sessionStorage ‡∏´‡∏£‡∏∑‡∏≠ URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const hasReceiptParam = urlParams.has('receipt'); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ receipt parameter ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å deposit
        const sourceFromSession = sessionStorage.getItem('checkoutSource');
        const sourceType = sourceFromSession || (hasReceiptParam ? 'deposit' : 'direct');

        console.log('üîç Checkout Source:', sourceType, '(from session:', sourceFromSession, ', has receipt param:', hasReceiptParam, ')');

        if (sourceType === 'deposit') {
          // ‡∏°‡∏≤‡∏à‡∏≤‡∏Å DepositReceipt ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å
          apiEndpoint = '/api/delivery-note/create-from-sale';
          console.log('üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô:', apiEndpoint);
        } else {
          // ‡∏°‡∏≤‡∏à‡∏≤‡∏Å frontstore ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
          apiEndpoint = '/api/taxinvoice/checkout';
          console.log('üßæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô:', apiEndpoint);
        }
    
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Authorization ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö middleware ‡∏Ç‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
        const requestHeaders = { 'Content-Type': 'application/json' };
        // ‡πÉ‡∏ä‡πâ Bearer token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å API endpoints
        requestHeaders.Authorization = 'Bearer ' + token;

        // Calculate cart total
        const cartTotal = cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0);

        // Validate checkout data before sending
        const validation = validateCheckoutData({
          items: cartItems,
          totalAmount: parseFloat(cartTotal),
          paymentMethod: selectedPaymentMethod,
          customer: selectedCustomer
        });

        if (!validation.isValid) {
          showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + validation.errors.join(', '), 'error');
          return;
        }

        const fetchResult = await safeFetch(apiEndpoint, {
          method: 'POST',
          headers: requestHeaders,
          body: JSON.stringify(payload),
          timeout: 30000,
          maxRetries: 2,
          useCache: false
        });

        const js = fetchResult;
        if (!js.success) {
          const errorMsg = sourceType === 'deposit' ? '‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          throw new Error(js.error || `${errorMsg} (Server Response)`);
        }

        // (5) ‡πÅ‡∏™‡∏î‡∏á success ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        console.log('üìã API Response:', js);
        console.log('üìã Response Keys:', Object.keys(js));
        if (js.data) {
          console.log('üìã Response Data Keys:', Object.keys(js.data));
        }

        let document_id, document_number, docTypeText, successMessage;
        let stockDeductions = [];
        let receiptData, taxInvoiceData, documentsCreated;

        if (sourceType === 'deposit') {
          // ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á
          const deliveryData = js.data || js;
          console.log('üì¶ Delivery Note Data:', deliveryData);

          const deliveryNote = deliveryData.deliveryNote;
          stockDeductions = deliveryData.stockDeductions || [];

          document_id = deliveryNote?.id;
          document_number = deliveryNote?.documentNumber || '';
          docTypeText = '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á';

          successMessage = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\nüì¶ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${document_number}\n`;
          if (stockDeductions.length > 0) {
            successMessage += `üîÑ ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${stockDeductions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
          }
        } else {
          // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
          const documentData = js.data || js;
          console.log('üìã Document Data:', documentData);

          receiptData = documentData.receipt;
          taxInvoiceData = documentData.taxInvoice;
          documentsCreated = documentData.documentsCreated || {};

          const primaryDoc = taxInvoiceData || receiptData;
          document_id = primaryDoc?.id;
          document_number = primaryDoc?.documentNumber || '';
          docTypeText = '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';

          successMessage = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n';
          if (documentsCreated.receiptNumber) {
            successMessage += `üìÑ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${documentsCreated.receiptNumber}\n`;
          }
          if (documentsCreated.taxInvoiceNumber) {
            successMessage += `üßæ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ: ${documentsCreated.taxInvoiceNumber}`;
          }

          if (!documentsCreated.receiptNumber && !documentsCreated.taxInvoiceNumber) {
            successMessage = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
          }
        }

        showToast(successMessage, 'success');

        // POS Notification - Checkout Success
        if (posNotificationSystem) {
          if (sourceType === 'deposit') {
            // ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á
            let notificationMessage = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n`;
            notificationMessage += `üì¶ ${document_number}\n`;

            if (stockDeductions.length > 0) {
              notificationMessage += `\nüîÑ ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${stockDeductions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            }

            notificationMessage += `üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡∏ø${formatPrice(totalVal)}`;

            posNotificationSystem.showToast('pos', {
              title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
              message: notificationMessage,
              type: 'success',
              icon: 'üì¶',
              duration: 5000
            });

            posNotificationSystem.addNotification('pos', {
              title: '‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å',
              message: `‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á ${document_number} - ‡∏ø${formatPrice(totalVal)} (${selectedPaymentMethod})`,
              type: 'success',
              icon: 'üì¶',
              actions: [
                {
                  label: '‡∏î‡∏π‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á',
                  action: 'primary',
                  callback: () => {
                    const viewUrl = `/DeliveryNotePDF?id=${document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                }
              ],
              metadata: {
                documentId: document_id,
                documentNumber: document_number,
                documentType: 'delivery_note',
                totalAmount: totalVal,
                paymentMethod: selectedPaymentMethod,
                itemCount: cartItems.length,
                stockDeductions: stockDeductions.length,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          } else {
            // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            let notificationMessage = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n';
            if (documentsCreated.receiptNumber) {
              notificationMessage += `üìÑ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${documentsCreated.receiptNumber}\n`;
            }
            if (documentsCreated.taxInvoiceNumber) {
              notificationMessage += `üßæ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ${documentsCreated.taxInvoiceNumber}\n`;
            }

            if (!documentsCreated.receiptNumber && !documentsCreated.taxInvoiceNumber) {
              notificationMessage = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n';
            }

            notificationMessage += `üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡∏ø${formatPrice(totalVal)}`;

            posNotificationSystem.showToast('pos', {
              title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
              message: notificationMessage,
              type: 'success',
              icon: 'üí∞',
              duration: 5000
            });

            posNotificationSystem.addNotification('pos', {
              title: '‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö',
              message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ - ‡∏ø${formatPrice(totalVal)} (${selectedPaymentMethod})`,
              type: 'success',
              icon: 'üßæ',
              actions: [
                {
                  label: '‡∏î‡∏π‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ',
                  action: 'primary',
                  callback: () => {
                    const viewUrl = `/api/pdf/a4-tax-invoice-fixed/${taxInvoiceData?.id || document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                },
                {
                  label: '‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
                  action: 'secondary',
                  callback: () => {
                    const viewUrl = `/api/pdf/a4-receipt/${receiptData?.id || document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                }
              ],
              metadata: {
                documentId: document_id,
                documentNumber: document_number,
                documentType: invoiceType,
                totalAmount: totalVal,
                paymentMethod: selectedPaymentMethod,
                itemCount: cartItems.length,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
        if (sourceType === 'deposit') {
          console.log('üì¶ Opening delivery note PDF...');
          const deliveryNoteUrl = `/DeliveryNotePDF?id=${document_id}`;
          window.open(deliveryNoteUrl, '_blank');
          console.log(`‚úÖ Delivery note opened: ${deliveryNoteUrl}`);
        } else {
          console.log('üñ®Ô∏è Opening tax invoice/receipt...');
          const primaryDoc = taxInvoiceData || receiptData;
          const receiptImage = primaryDoc?.receiptImage || primaryDoc?.taxInvoiceImage || js.data?.pdfFile;
          if (receiptImage) {
            const printResult = await printReceiptOnClient(receiptImage);
            if (printResult && printResult.success) {
              console.log(`‚úÖ ${docTypeText} printed successfully`);
            } else {
              console.warn(`‚ö†Ô∏è ${docTypeText} printing failed but saved to database:`, printResult?.error);
            }
          } else {
            console.warn('‚ö†Ô∏è No document image received from server');
            if (typeof showToast === 'function') {
              showToast(`‚ö†Ô∏è ${docTypeText}‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤`, 'warning');
            }
          }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (usedPromotions && usedPromotions.length > 0) {
          for (const promo of usedPromotions) {
            await recordPromotionUsage(promo.id);
          }
        }

        // (6) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å audit log
        if (sourceType === 'deposit') {
          logAuditEvent('DELIVERY_NOTE_CREATED', {
            transactionId,
            deliveryNoteId: document_id,
            documentNumber: document_number,
            documentType: 'delivery_note',
            totalAmount: totalVal,
            itemCount: cartItems.length,
            paymentMethod: selectedPaymentMethod,
            stockDeductions: stockDeductions.length,
            customerType: customerType,
            apiEndpoint: apiEndpoint
          }, 'SUCCESS');
        } else {
          logAuditEvent('DOCUMENT_SAVE_SUCCESS', {
            transactionId,
            documentId: document_id,
            documentNumber: document_number,
            documentType: invoiceType,
            totalAmount: totalVal,
            itemCount: cartItems.length,
            paymentMethod: selectedPaymentMethod,
            promotionsUsed: usedPromotions.length,
            customerType: customerType,
            apiEndpoint: apiEndpoint
          }, 'SUCCESS');
        }

        // ‡∏•‡πâ‡∏≤‡∏á sessionStorage checkoutSource
        sessionStorage.removeItem('checkoutSource');

        // (7) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        cartItems = [];
        hiddenProductIds.clear();
        appliedPromotions = {};
        clearPromotionCache();
        renderCart();

        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Level 3 ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        const lvl3 = document.getElementById('level3Container');
        if (!lvl3.classList.contains('hidden')) {
          const base = document.getElementById('level3Title').textContent.replace('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ', '');
          renderLevel3(level2Groups[base]);
        }

        // ‚úÖ Fix: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö null-safe
        const personalFields = document.getElementById('personalFields');
        if (personalFields) {
          personalFields.querySelectorAll('input, select').forEach(field => field.value = '');
          personalFields.classList.remove('hidden');
        }
    
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏
        const birthDateField = document.getElementById('customerBirthDate');
        const ageField = document.getElementById('customerAge');
        if (birthDateField) birthDateField.value = '';
        if (ageField) ageField.value = '';
    
        const corporateFields = document.getElementById('corporateFields');
        if (corporateFields) {
          corporateFields.querySelectorAll('input').forEach(input => input.value = '');
          corporateFields.classList.add('hidden');
        }
    
        const customerTypeSelect = document.getElementById('customerType');
        if (customerTypeSelect) {
          customerTypeSelect.value = 'individual';
        }
    
        const discountField = document.getElementById('discount');
        if (discountField) {
          discountField.value = '';
        }
    
        // ‚úÖ Fix: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï checkbox ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏ö‡∏ö null-safe
        const sendEmailCheckbox = document.getElementById('sendEmailReceipt');
        if (sendEmailCheckbox) {
          sendEmailCheckbox.checked = true;
        }
        updateEmailStatus();
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        updateEmailServiceIndicator();

      } catch (err) {
        logAuditEvent('CHECKOUT_FAILED', {
          transactionId,
          error: err.message,
          stack: err.stack
        }, 'ERROR');
        showToast(`‚ùå Error: ${err.message}`, 'danger');
        console.error('Checkout error:', err);
    
        // POS Notification - Checkout Error
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`,
            type: 'error',
            icon: '‚ùå',
            duration: 8000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
            message: err.message,
            type: 'error',
            icon: 'üö®',
            actions: [
              {
                label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                action: 'primary',
                callback: () => {
                  document.getElementById('btnSingleCheckout')?.click();
                }
              },
              {
                label: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠',
                action: 'secondary',
                callback: () => {
                  console.log('üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
                }
              }
            ],
            metadata: {
              error: err.message,
              transactionId: transactionId,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      } finally {
        // Hide loading
        showLoading(false);
        // üîì ‡∏õ‡∏•‡πà‡∏≠‡∏¢ transaction lock ‡πÄ‡∏™‡∏°‡∏≠
        releaseTransactionLock(transactionId);
      }
    }



    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (Global Scope) - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
    window.fillCustomerDataFromCard = function(cardData) {
      console.log('üîÑ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£:', cardData);
      console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö properties:', Object.keys(cardData));
    
      try {
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô - ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÜ property name
        const citizenId = cardData.citizenId || cardData.Citizenid || cardData.CitizenId || cardData.id || '';
        const firstNameTh = cardData.firstNameTh || cardData.FirstNameTh || cardData.firstname || cardData.firstName || '';
        const lastNameTh = cardData.lastNameTh || cardData.LastNameTh || cardData.lastname || cardData.lastName || '';
        const titleTh = cardData.titleTh || cardData.TitleTh || cardData.title || cardData.prefix || '';
    
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á
        const address = cardData.address || cardData.Address || cardData.addr || cardData.fullAddress || '';
        const district = cardData.district || cardData.District || cardData.amphoe || cardData.Amphoe || '';
        const subDistrict = cardData.subDistrict || cardData.SubDistrict || cardData.tambon || cardData.Tambon || '';
        const province = cardData.province || cardData.Province || cardData.changwat || cardData.Changwat || '';
        const village = cardData.village || cardData.Village || cardData.moo || cardData.Moo || '';
        const houseNumber = cardData.houseNumber || cardData.HouseNumber || cardData.houseNo || cardData.HouseNo || '';
    
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏
        const birthDate = cardData.birthDate || cardData.BirthdayEn || cardData.birthday ||
                         cardData.dateOfBirth || cardData.Birthday || cardData.BirthDate || '';
        const age = cardData.age || cardData.Age || cardData.AGE || '';
    
        console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á:');
        console.log('  - ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', citizenId);
        console.log('  - ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:', titleTh);
        console.log('  - ‡∏ä‡∏∑‡πà‡∏≠:', firstNameTh);
        console.log('  - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:', lastNameTh);
        console.log('  - ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:', birthDate);
        console.log('  - ‡∏≠‡∏≤‡∏¢‡∏∏:', age);
        console.log('  - ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°:', address);
        console.log('  - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô:', houseNumber);
        console.log('  - ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà:', village);
        console.log('  - ‡∏ï‡∏≥‡∏ö‡∏•:', subDistrict);
        console.log('  - ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:', district);
        console.log('  - ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:', province);
    
        // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£
        console.log('üîç Raw card data keys:', Object.keys(cardData));
        console.log('üîç Raw card data:', cardData);
    
        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (typeof window.analyzeRealCardData === 'function') {
          const analysis = window.analyzeRealCardData(cardData);
          console.log('üìä Address analysis result:', analysis);
        }
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        const basicFields = {
          'customerPrefix': titleTh,
          'customerFirstName': firstNameTh,
          'customerLastName': lastNameTh,
          'customerTaxId': citizenId,
          'customerAge': age
        };
    
        let filledCount = 0;
        Object.entries(basicFields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏° ${fieldId}:`, value);
          }
        });
    
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
        if (birthDate) {
          const birthDateField = document.getElementById('customerBirthDate');
          if (birthDateField) {
            let formattedDate = birthDate;
            if (birthDate.includes('/')) {
              const parts = birthDate.split('/');
              if (parts.length === 3) {
                formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
              }
            }
            birthDateField.value = formattedDate;
            birthDateField.dispatchEvent(new Event('input', { bubbles: true }));
            birthDateField.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:', formattedDate);
          }
        }
    
        // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        console.log('üè† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...');
    
        // ‡∏´‡∏≤ field ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const addressFields = {
          houseNo: document.getElementById('houseNo'),
          moo: document.getElementById('moo'),
          province: document.getElementById('province'),
          district: document.getElementById('district'),
          subDistrict: document.getElementById('subDistrict'),
          zipcode: document.getElementById('zipcode')
        };
    
        // 1. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤)
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô
        if (houseNumber && addressFields.houseNo && !addressFields.houseNo.value) {
          addressFields.houseNo.value = houseNumber;
          addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£):', houseNumber);
        }
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà
        if (village && addressFields.moo && !addressFields.moo.value) {
          // ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
          const mooNumber = village.toString().replace(/[^\d]/g, '');
          if (mooNumber) {
            addressFields.moo.value = mooNumber;
            addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£):', mooNumber);
          }
        }
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
        if (province && addressFields.province && !addressFields.province.value) {
          const cleanProvince = province.split('#')[0].trim().replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/, '');
          addressFields.province.value = cleanProvince;
          addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£):', cleanProvince);
        }
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
        if (district && addressFields.district && !addressFields.district.value) {
          const cleanDistrict = district.split('#')[0].trim().replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/, '');
          addressFields.district.value = cleanDistrict;
          addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£):', cleanDistrict);
        }
    
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏•
        if (subDistrict && addressFields.subDistrict && !addressFields.subDistrict.value) {
          const cleanSubDistrict = subDistrict.split('#')[0].trim().replace(/^‡∏ï‡∏≥‡∏ö‡∏•/, '');
          addressFields.subDistrict.value = cleanSubDistrict;
          addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏• (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£):', cleanSubDistrict);
        }
    
        // 2. ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢ ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°
        if (address && (!province || !district || !subDistrict || !village)) {
          console.log('üîç ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°:', address);
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ # ‡πÄ‡∏õ‡πá‡∏ô delimiter (‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏£‡∏¥‡∏á)
          if (address.includes('#')) {
            console.log('üîç ‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö # delimiter - ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©');
    
            // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ # ‡πÅ‡∏•‡∏∞‡∏•‡∏ö # ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
            const parts = address.split('#').filter(part => part.trim() !== '');
            console.log('üìç Parts after split:', parts);
    
            for (const part of parts) {
              const cleanPart = part.trim();
              if (!cleanPart) continue;
    
              // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
              if (/^\d+(?:\/\d+)?/.test(cleanPart) && addressFields.houseNo && !addressFields.houseNo.value) {
                addressFields.houseNo.value = cleanPart;
                addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
                filledCount++;
                console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô (# format):', cleanPart);
              }
    
              // ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà
              else if (cleanPart.includes('‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà') && addressFields.moo && !addressFields.moo.value) {
                const mooMatch = cleanPart.match(/‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà\s*(\d+)/);
                if (mooMatch) {
                  addressFields.moo.value = mooMatch[1];
                  addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (# format):', mooMatch[1]);
                }
              }
    
              // ‡∏ï‡∏≥‡∏ö‡∏•
              else if (cleanPart.includes('‡∏ï‡∏≥‡∏ö‡∏•') && addressFields.subDistrict && !addressFields.subDistrict.value) {
                const tambonName = cleanPart.replace('‡∏ï‡∏≥‡∏ö‡∏•', '').trim();
                if (tambonName) {
                  addressFields.subDistrict.value = tambonName;
                  addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏• (# format):', tambonName);
                }
              }
    
              // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
              else if (cleanPart.includes('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠') && addressFields.district && !addressFields.district.value) {
                const amphoeName = cleanPart.replace('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '').trim();
                if (amphoeName) {
                  addressFields.district.value = amphoeName;
                  addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (# format):', amphoeName);
                }
              }
    
              // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
              else if (cleanPart.includes('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î') && addressFields.province && !addressFields.province.value) {
                const provinceName = cleanPart.replace('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '').trim();
                if (provinceName) {
                  addressFields.province.value = provinceName;
                  addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (# format):', provinceName);
                }
              }
            }
          } else {
            // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ - ‡πÉ‡∏ä‡πâ regex ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            console.log('üîç ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö regex ‡∏õ‡∏Å‡∏ï‡∏¥');
    
            // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô
            const houseNoMatch = address.match(/^(\d+[\\/\d-]*)/);
            if (houseNoMatch && addressFields.houseNo && !addressFields.houseNo.value) {
              addressFields.houseNo.value = houseNoMatch[1];
              addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô:', houseNoMatch[1]);
            }
    
            // ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà
            const mooMatch = address.match(/‡∏´‡∏°‡∏π‡πà\s*(\d+)|‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà\s*(\d+)/);
            if (mooMatch && addressFields.moo && !addressFields.moo.value) {
              const mooNumber = mooMatch[1] || mooMatch[2];
              addressFields.moo.value = mooNumber;
              addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà:', mooNumber);
            }
    
            // ‡πÅ‡∏¢‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            const provinceMatch = address.match(/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î([‡∏Å-‡πô\s]+?)(?:\s|$)/);
            if (provinceMatch && addressFields.province && !addressFields.province.value) {
              const provinceName = provinceMatch[1].trim();
              addressFields.province.value = provinceName;
              addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:', provinceName);
            }
    
            // ‡πÅ‡∏¢‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
            const districtMatch = address.match(/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠([‡∏Å-‡πô\s]+?)(?:\s|‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î|$)/);
            if (districtMatch && addressFields.district && !addressFields.district.value) {
              const districtName = districtMatch[1].trim();
              addressFields.district.value = districtName;
              addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:', districtName);
            }
    
            // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≥‡∏ö‡∏•
            const subDistrictMatch = address.match(/‡∏ï‡∏≥‡∏ö‡∏•([‡∏Å-‡πô\s]+?)(?:\s|‡∏≠‡∏≥‡πÄ‡∏†‡∏≠|$)/);
            if (subDistrictMatch && addressFields.subDistrict && !addressFields.subDistrict.value) {
              const subDistrictName = subDistrictMatch[1].trim();
              addressFields.subDistrict.value = subDistrictName;
              addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≥‡∏ö‡∏•:', subDistrictName);
            }
          }
    
          // ‡πÅ‡∏¢‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
          const zipcodeMatch = address.match(/(\d{5})(?:\s|$)/);
          if (zipcodeMatch && addressFields.zipcode && !addressFields.zipcode.value) {
            addressFields.zipcode.value = zipcodeMatch[1];
            addressFields.zipcode.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:', zipcodeMatch[1]);
          }
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        if (typeof showToast === 'function') {
          if (filledCount > 0) {
            const addressCount = Object.values(addressFields).filter(field => field && field.value).length;
    
            if (addressCount >= 3) {
              // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö
              const message = `‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${filledCount} ‡∏ä‡πà‡∏≠‡∏á, ‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ${addressCount}/5 ‡∏ä‡πà‡∏≠‡∏á)`;
              showToast(message, 'success', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 4000);
            } else if (addressCount > 0) {
              // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
              const message = `‚ö†Ô∏è ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (${addressCount}/5 ‡∏ä‡πà‡∏≠‡∏á)`;
              showToast(message, 'warning', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 5000);
    
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
              setTimeout(() => {
                showToast('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug', 'info', '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', 3000);
              }, 1000);
            } else {
              // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏•‡∏¢
              const message = `‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${filledCount} ‡∏ä‡πà‡∏≠‡∏á) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà`;
              showToast(message, 'warning', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 4000);
    
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
              setTimeout(() => {
                showToast('üí° ‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console', 'info', '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', 4000);
              }, 1000);
            }
          } else {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ', 'warning', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 3000);
          }
        }
    
        return true;
    
      } catch (error) {
        console.error('‚ùå Error filling customer data from card:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
        }
        return false;
      }
    };

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
    function checkCardReaderSystem() {
      console.log('üîç Checking Card Reader System...');
    
      const branchCode = BRANCH_CODE || '00000';
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CardReaderConfig
      if (!window.CardReaderConfig) {
        console.warn('‚ùå CardReaderConfig not loaded');
        return;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö CardReaderService
      if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
        console.warn('‚ùå CardReaderService not loaded');
    
        // ‡πÅ‡∏™‡∏î‡∏á notification ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (typeof showToast === 'function') {
          showToast(
            '‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
            'warning',
            '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
            5000
          );
        }
        return;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isEnabled = window.CardReaderConfig.isCardReaderEnabled(branchCode);
      console.log(`üì± Card Reader for branch ${branchCode}: ${isEnabled ? 'ENABLED' : 'DISABLED'}`);
    
      if (isEnabled) {
        const config = window.CardReaderConfig.getCardProxyUrls(branchCode);
        console.log(`üì° Available endpoints: ${config.totalCount}`);
    
        if (typeof showToast === 'function') {
          showToast(
            `‚úÖ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (${config.totalCount} endpoints)`,
            'success',
            '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
            3000
          );
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const fillFunctionAvailable = typeof window.fillCustomerDataFromCard === 'function';
        console.log(`üìù fillCustomerDataFromCard available: ${fillFunctionAvailable}`);
    
        if (!fillFunctionAvailable) {
          console.warn('‚ö†Ô∏è fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast(
              '‚ö†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
              'warning',
              '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
              3000
            );
          }
        }
      } else {
        console.log(`‚ùå Card reader disabled for branch: ${branchCode}`);
    
        if (typeof showToast === 'function') {
          showToast(
            '‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ',
            'warning',
            '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
            5000
          );
        }
      }
    }

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. + removeLocalityPrefix()
    async function readCard() {
      console.log('readCard() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß');  // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® loaderId ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å try block
      let loaderId = null;
    
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡πà‡∏≠‡∏ô
        if (typeof showToast === 'function') {
          showToast('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô...', 'info');
        }
    
        // Show loading
        showLoading(true);
    
        // ‚úÖ ‡πÉ‡∏ä‡πâ Multi-IP Card Reader Service ‡πÉ‡∏´‡∏°‡πà
        const branchCode = BRANCH_CODE || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• endpoints ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏≠‡∏á
        if (window.CardReaderConfig?.isCardReaderEnabled(branchCode)) {
          const cardProxyConfig = window.CardReaderConfig.getCardProxyUrls(branchCode);
          const endpointCount = cardProxyConfig.totalCount + 1; // +1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Server API
    
          if (typeof showToast === 'function') {
            showToast(
              `üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (${endpointCount} endpoints)...`,
              'info',
              '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'
            );
          }
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ CardReaderService ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
          throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà');
        }
    
        // ‚úÖ ‡πÉ‡∏ä‡πâ CardReaderService ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏≤‡∏¢ IP
        const result = await window.CardReaderService.readCard({
          branchCode: branchCode,
          source: 'frontstore_pattani'
        });
    
        console.log('üîç Multi-IP card reader response:', result);
    
        if (!result.success) {
          throw new Error(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ');
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• endpoint ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        if (typeof showToast === 'function' && result.usedEndpoint) {
          const endpointInfo = result.usedEndpoint;
          let successMessage = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ú‡πà‡∏≤‡∏ô ${endpointInfo.name}`;
    
          if (endpointInfo.attemptNumber > 1) {
            successMessage += ` (‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${endpointInfo.attemptNumber}/${endpointInfo.totalAttempts})`;
          }
    
          showToast(successMessage, 'success', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 4000);
        }
    
                 // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (result.data) {
          if (typeof window.fillCustomerDataFromCard === 'function') {
            window.fillCustomerDataFromCard(result.data);
          } else {
            console.error('‚ùå fillCustomerDataFromCard function not available in readCard');
          }
    
              // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          const cardData = result.data;
          const customerName = `${cardData.titleTh || cardData.TitleTh || ''}${cardData.firstNameTh || cardData.FirstNameTh || ''} ${cardData.lastNameTh || cardData.LastNameTh || ''}`.trim();
    
                if (typeof showToast === 'function') {
            showToast(
              `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${customerName}`,
              'success',
              '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
              5000
            );
          }
        }
    
        return result;
    
      } catch (err) {
        console.error('‚ùå readCard() error:', err);
    
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error messages ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        let errorMessage = err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
    
        // ‡πÅ‡∏õ‡∏•‡∏á error messages ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
        if (errorMessage.includes('HTTP 500') || errorMessage.includes('Internal Server Error')) {
          errorMessage = '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Error 500)';
        } else if (errorMessage.includes('fetch')) {
          errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        } else if (errorMessage.includes('timeout')) {
          errorMessage = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        } else if (errorMessage.includes('SSL_PROTOCOL_ERROR') || errorMessage.includes('ERR_SSL')) {
          errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (SSL) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
        } else if (errorMessage.includes('CardReaderService')) {
          errorMessage = '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
        } else if (errorMessage.includes('‡∏•‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß 4 endpoint')) {
          errorMessage = '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
        }
    
        // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö monitoring (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (errorMessage.includes('HTTP 500') || errorMessage.includes('Internal Server Error')) {
          console.error('üö® CRITICAL: Card Reader Service HTTP 500 Error detected');
    
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• error ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö monitoring
          if (window.firebase && window.firebase.database) {
            try {
              const errorReport = {
                timestamp: new Date().toISOString(),
                error: 'Card Reader Service HTTP 500',
                branch: window.BRANCH_CODE || '00000',
                user: localStorage.getItem('userName') || 'unknown',
                details: err.message || 'Unknown HTTP 500 error'
              };
    
              window.firebase.database().ref('system-errors/card-reader').push(errorReport);
              console.log('üì° Error report sent to Firebase monitoring');
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Failed to send error report to Firebase:', firebaseError);
            }
          }
        }
    
        if (typeof showToast === 'function') {
          showToast(`‚ùå ${errorMessage}`, 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 8000);
        }
    
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á manual entry form ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Card Reader ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        if (errorMessage.includes('‡∏•‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß') ||
            errorMessage.includes('‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ') ||
            errorMessage.includes('HTTP 500') ||
            errorMessage.includes('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠')) {
    
          console.log('üè∑Ô∏è Showing manual entry form due to card reader failure');
    
          // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡πà‡∏≤‡∏ô error message ‡∏Å‡πà‡∏≠‡∏ô
          setTimeout(() => {
            if (typeof showManualCustomerEntry === 'function') {
              showManualCustomerEntry();
            }
          }, 3000);
        }
    
        return {
          success: false,
          error: errorMessage
        };
      } finally {
        // Hide loading
        showLoading(false);
      }
    }







    // =================== LANGUAGE-INDEPENDENT GLOBAL BARCODE SCANNER ===================
    function findAndAddToCartByBarcode(barcode) {
      console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß): ${barcode}`);

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!approvedStocks || approvedStocks.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
        return;
      }

      const product = approvedStocks.find(p => p.barcode === barcode || p.imei === barcode);
      if (product) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö IMEI)
        if (product.imei) {
          const inCart = cartItems.some(item => item.imei === product.imei);
          if (inCart) {
            showToast(`'${product.name}' (IMEI: ${product.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
            return;
          }
        } else {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Quantity ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          const inCart = cartItems.some(item => item.name === product.name && !item.imei);
          if (inCart) {
            showToast(`'${product.name}' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
            return;
          }
        }

        showToast(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.name}`, 'info');
        addToCart(product._id, product.name, product.price, product.imei, product.taxType, product.model, product.poNumber, product.supplier);
      } else {
        showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ: ${barcode}`, 'error');
      }
    }

    function setupLanguageIndependentBarcodeListener() {
      let barcodeBuffer = '';
      let lastKeyTime = Date.now();
      const keycodeToCharMap = {
        'Digit0': '0', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
        'Digit5': '5', 'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9',
        'Numpad0': '0', 'Numpad1': '1', 'Numpad2': '2', 'Numpad3': '3', 'Numpad4': '4',
        'Numpad5': '5', 'Numpad6': '6', 'Numpad7': '7', 'Numpad8': '8', 'Numpad9': '9',
        'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D', 'KeyE': 'E', 'KeyF': 'F',
        'KeyG': 'G', 'KeyH': 'H', 'KeyI': 'I', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
        'KeyM': 'M', 'KeyN': 'N', 'KeyO': 'O', 'KeyP': 'P', 'KeyQ': 'Q', 'KeyR': 'R',
        'KeyS': 'S', 'KeyT': 'T', 'KeyU': 'U', 'KeyV': 'V', 'KeyW': 'W', 'KeyX': 'X',
        'KeyY': 'Y', 'KeyZ': 'Z',
        'Minus': '-', 'Equal': '=',
      };
      document.addEventListener('keydown', (event) => {
        if (event.target.isContentEditable || ['INPUT', 'TEXTAREA'].includes(event.target.tagName)) {
          return;
        }
        const currentTime = Date.now();
        const timeDiff = currentTime - lastKeyTime;
        lastKeyTime = currentTime;
        if (timeDiff > 100) {
          barcodeBuffer = '';
        }
        if (event.code === 'Enter') {
          if (barcodeBuffer.length > 2) {
            event.preventDefault();
            findAndAddToCartByBarcode(barcodeBuffer);
          }
          barcodeBuffer = '';
          return;
        }
        const char = keycodeToCharMap[event.code];
        if (char) {
          event.preventDefault();
          barcodeBuffer += char;
        }
      });
      console.log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö Global Barcode Listener (‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

      // üîç Audit Log - Barcode listener setup
      logAuditEvent('BARCODE_LISTENER_SETUP', {
        branchCode: BRANCH_CODE,
        listenerType: 'global_keyboard'
      }, 'INFO');
    }

    // üîç Error Handling for Audit Logging
    window.addEventListener('error', (event) => {
      logAuditEvent('JAVASCRIPT_ERROR', {
        error: event.error?.message || 'Unknown error',
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        branchCode: BRANCH_CODE
      }, 'ERROR');
    });

    window.addEventListener('unhandledrejection', (event) => {
      logAuditEvent('UNHANDLED_PROMISE_REJECTION', {
        reason: event.reason?.message || event.reason,
        stack: event.reason?.stack,
        branchCode: BRANCH_CODE
      }, 'ERROR');
    });

    // üîç Visibility Change (when user switches tabs)
    document.addEventListener('visibilitychange', () => {
      logAuditEvent('VISIBILITY_CHANGE', {
        hidden: document.hidden,
        branchCode: BRANCH_CODE,
        timestamp: new Date().toISOString()
      }, 'INFO');
    });

    // üîç Page Unload
    window.addEventListener('beforeunload', () => {
      logAuditEvent('PAGE_UNLOAD', {
        branchCode: BRANCH_CODE,
        sessionDuration: Date.now() - lastActionTime,
        cartItems: cartItems.length
      }, 'INFO');

      // ‡∏™‡πà‡∏á audit logs ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å
      flushAuditBuffer();
    });

    // ======================= END OF SCANNER LOGIC =======================

    // ======================= PRODUCT TO CART HELPER FUNCTION =======================
    
    /**
     * Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° UI
     * @param {string} productId - ID ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     * @param {string} productName - ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     * @param {number} price - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     * @param {string} imei - ‡πÄ‡∏•‡∏Ç IMEI (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
     * @param {string} taxType - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏†‡∏≤‡∏©‡∏µ
     * @param {string} model - ‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     * @param {string} poNumber - ‡πÄ‡∏•‡∏Ç PO
     * @param {string} supplier - ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
     */
    async function addProductToCart(productId, productName, price, imei = '', taxType = '', model = '', poNumber = '', supplier = '') {
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (!productId || !productName || !price) {
          console.error('‚ùå Invalid product data:', { productId, productName, price });
          showToast('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
          return;
        }

        // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô approvedStocks ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö taxType ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const stockItem = approvedStocks.find(item => item._id === productId);
        if (!stockItem) {
          console.error('‚ùå Product not found in approved stocks:', productId);
          showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
          return;
        }

        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å stockItem ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
        const finalTaxType = stockItem.taxType || taxType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ';
        const finalModel = stockItem.model || model || '';
        const finalPoNumber = stockItem.poNumber || poNumber || '';
        const finalSupplier = stockItem.supplier || supplier || '';

        console.log('üõí Adding product to cart:', {
          productId,
          productName,
          price,
          imei: imei || '(no IMEI)',
          taxType: finalTaxType,
          stockType: stockItem.stockType || 'imei'
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addToCart() ‡∏´‡∏•‡∏±‡∏Å
        addToCart(
          productId,
          productName,
          price,
          imei,
          finalTaxType,
          finalModel,
          finalPoNumber,
          finalSupplier
        );

      } catch (error) {
        console.error('‚ùå Error in addProductToCart:', error);
        showToast(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
      }
    }

    // Make function globally available
    window.addProductToCart = addProductToCart;
    
    // ======== CARD READER RETRY MECHANISM ========
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ retry
    let cardReaderRetryCount = 0;
    const maxRetries = 3;
    
    /**
     * ‡∏•‡∏≠‡∏á readCard() ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° exponential backoff
     */
    async function retryReadCard(retryNumber = 1) {
      if (retryNumber > maxRetries) {
        throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≠‡∏á ${maxRetries} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`);
      }
    
      console.log(`üîÑ Card Reader Retry attempt ${retryNumber}/${maxRetries}`);
    
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      if (typeof showToast === 'function') {
        showToast(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${retryNumber}...`, 'info', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 3000);
      }
    
      // ‡∏£‡∏≠‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö exponential backoff (1s, 2s, 4s)
      const delay = Math.pow(2, retryNumber - 1) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    
      try {
        return await readCard();
      } catch (error) {
        console.warn(`‚ùå Retry ${retryNumber} failed:`, error.message);
    
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô HTTP 500 ‡∏´‡∏£‡∏∑‡∏≠ network error ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        if (error.message.includes('HTTP 500') ||
            error.message.includes('timeout') ||
            error.message.includes('Failed to fetch')) {
          return await retryReadCard(retryNumber + 1);
        }
    
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô error ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£ retry ‡πÉ‡∏´‡πâ throw ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        throw error;
      }
    }
    
    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö manual fallback ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Card Reader ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
     */
    function showManualCustomerEntry() {
      // ‡∏ã‡πà‡∏≠‡∏ô toast ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏´‡∏£‡∏∑‡∏≠ form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
      if (typeof showToast === 'function') {
        const manualForm = `
          <div class="manual-entry-form">
            <h6 class="mb-3">üè∑Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h6>
            <div class="form-group mb-2">
              <input type="text" id="manualTaxId" class="form-control" 
                     placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)" maxlength="13">
            </div>
            <div class="form-group mb-2">
              <input type="text" id="manualFirstName" class="form-control" 
                     placeholder="‡∏ä‡∏∑‡πà‡∏≠">
            </div>
            <div class="form-group mb-2">
              <input type="text" id="manualLastName" class="form-control" 
                     placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group mb-3">
              <input type="text" id="manualPhone" class="form-control" 
                     placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            </div>
            <div class="d-flex gap-2">
              <button onclick="submitManualEntry()" class="btn btn-success btn-sm flex-1">
                ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
              <button onclick="tryCardReaderAgain()" class="btn btn-warning btn-sm">
                üîÑ ‡∏•‡∏≠‡∏á Card Reader ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </button>
            </div>
          </div>
        `;
    
        showToast(manualForm, 'info', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 0); // 0 = ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
      }
    }
    
    /**
     * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
     */
    function submitManualEntry() {
      const taxId = document.getElementById('manualTaxId')?.value || '';
      const firstName = document.getElementById('manualFirstName')?.value || '';
      const lastName = document.getElementById('manualLastName')?.value || '';
      const phone = document.getElementById('manualPhone')?.value || '';
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
      if (!taxId || !firstName || !lastName) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error', '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 5000);
        return;
      }
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
      if (!/^\d{13}$/.test(taxId)) {
        showToast('‚ùå ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'error', '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 5000);
        return;
      }
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Card Reader
      const manualCardData = {
        taxId: taxId,
        firstNameTh: firstName,
        lastNameTh: lastName,
        titleTh: '‡∏ô‡∏≤‡∏¢/‡∏ô‡∏≤‡∏á/‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', // default
        phone: phone,
        source: 'manual_entry'
      };
    
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      if (typeof window.fillCustomerDataFromCard === 'function') {
        window.fillCustomerDataFromCard(manualCardData);
    
        // ‡∏ã‡πà‡∏≠‡∏ô toast
        if (typeof hideAllToasts === 'function') {
          hideAllToasts();
        }
    
        showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${firstName} ${lastName}`, 'success', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 5000);
      } else {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'error', '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 5000);
      }
    }
    
    /**
     * ‡∏•‡∏≠‡∏á Card Reader ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ retry mechanism
     */
    async function tryCardReaderAgain() {
      // ‡∏ã‡πà‡∏≠‡∏ô toast ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï retry counter
      cardReaderRetryCount = 0;
    
      try {
        const result = await retryReadCard(1);
    
        if (result && result.success && result.data) {
          const cardData = result.data;
    
          if (typeof window.fillCustomerDataFromCard === 'function') {
            window.fillCustomerDataFromCard(cardData);
          }
    
          showToast(
            `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${cardData.titleTh || ''}${cardData.firstNameTh || ''} ${cardData.lastNameTh || ''}`,
            'success',
            '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
            5000
          );
        }
      } catch (error) {
        console.error('‚ùå Card Reader retry failed:', error);
        showToast(`‚ùå ${error.message}`, 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 8000);
    
        // ‡πÅ‡∏™‡∏î‡∏á manual entry form ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        setTimeout(() => showManualCustomerEntry(), 2000);
      }
    }
    
    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Card Reader Service
     */
    async function checkCardReaderStatus() {
      console.log('üîç Checking Card Reader Service status...');
    
      try {
        const response = await fetch('/api/cardreader/status', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
          },
          timeout: 5000
        });
    
        if (response.ok) {
          const status = await response.json();
          console.log('‚úÖ Card Reader Service status:', status);
          return status;
        } else {
          console.warn('‚ö†Ô∏è Card Reader Service status check failed:', response.status);
          return { online: false, error: `HTTP ${response.status}` };
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Card Reader Service status check error:', error.message);
        return { online: false, error: error.message };
      }
    }
    
    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Card Reader ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
     */
    function updateCardReaderStatusDisplay(status) {
      const statusElement = document.getElementById('cardReaderStatus');
    
      if (!statusElement) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
        return;
      }
    
      if (status.online) {
        statusElement.innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          </div>
        `;
      } else {
        statusElement.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${status.error || 'Unknown error'}
            <br>
            <button onclick="checkCardReaderStatus().then(updateCardReaderStatusDisplay)" 
                    class="btn btn-sm btn-warning mt-2">
              üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        `;
      }
    }
    
    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Card Reader ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
     */
    async function initCardReaderStatusMonitoring() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      const status = await checkCardReaderStatus();
      updateCardReaderStatusDisplay(status);
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ
      setInterval(async () => {
        const status = await checkCardReaderStatus();
        updateCardReaderStatusDisplay(status);
      }, 120000); // 2 minutes
    }
    
    /**
     * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏¢‡∏π‡∏ó‡∏¥‡∏•‡∏¥‡∏ï‡∏µ‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
     */
    async function runComprehensiveCardReaderDiagnostic() {
      console.log('üîç ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Card Reader ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
    
      const results = {
        timestamp: new Date().toISOString(),
        branch: window.BRANCH_CODE || '00000',
        results: {}
      };
    
      // Show loading
      showLoading(true);
    
      try {
        // 1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ï‡πà‡∏•‡∏∞ endpoint
        console.log('1Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö individual endpoints...');
        if (window.cardReaderService && window.cardReaderService.getConfig) {
          const config = window.cardReaderService.getConfig(window.BRANCH_CODE || '00000');
          console.log('üì° Testing endpoints:', config.endpoints);
    
          for (let i = 0; i < config.endpoints.length; i++) {
            const endpoint = config.endpoints[i];
            console.log(`üîÑ Testing endpoint ${i + 1}:`, endpoint.name);
    
            try {
              const startTime = Date.now();
              // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ping endpoint (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ head request
              const testUrl = endpoint.url.includes('/read-card')
                ? endpoint.url.replace('/read-card', '/ping')
                : endpoint.url;
    
              // For connectivity tests, use raw fetch with timeout
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 3000);

              const response = await fetch(testUrl, {
                method: 'HEAD',
                signal: controller.signal
              });
              clearTimeout(timeoutId);
              const duration = Date.now() - startTime;
    
              results.results[endpoint.name] = {
                status: response.status,
                duration: `${duration}ms`,
                success: response.ok
              };
    
              console.log(`‚úÖ ${endpoint.name}: ${response.status} (${duration}ms)`);
            } catch (error) {
              results.results[endpoint.name] = {
                error: error.message,
                success: false
              };
              console.log(`‚ùå ${endpoint.name}: ${error.message}`);
            }
          }
        }
    
        // 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö network connectivity
        console.log('2Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö network connectivity...');
        try {
          const internetTest = await fetch('https://www.google.com/favicon.ico', {
            method: 'HEAD',
            timeout: 3000
          });
          results.internetConnectivity = internetTest.ok;
          console.log('üåê Internet connectivity:', internetTest.ok ? '‚úÖ' : '‚ùå');
        } catch (error) {
          results.internetConnectivity = false;
          console.log('üåê Internet connectivity: ‚ùå', error.message);
        }
    
        // 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö local server APIs
        console.log('3Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö local server APIs...');
        try {
          const serverTest = await fetch('/api/health', {
            method: 'GET',
            timeout: 3000
          });
          results.localServerHealth = {
            status: serverTest.status,
            success: serverTest.ok
          };
          console.log('üè† Local server health:', serverTest.ok ? '‚úÖ' : '‚ùå');
        } catch (error) {
          results.localServerHealth = {
            error: error.message,
            success: false
          };
          console.log('üè† Local server health: ‚ùå', error.message);
        }
    
        // 4. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö CardReader Service configuration
        console.log('4Ô∏è‚É£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö CardReader configuration...');
        try {
          results.cardReaderConfig = {
            available: typeof window.cardReaderService !== 'undefined',
            branch: window.BRANCH_CODE || '00000',
            configLoaded: window.cardReaderService?.getConfig ? true : false
          };
    
          if (window.cardReaderService?.getConfig) {
            const config = window.cardReaderService.getConfig(window.BRANCH_CODE || '00000');
            results.cardReaderConfig.endpointCount = config.endpoints?.length || 0;
            results.cardReaderConfig.enabled = config.enabled || false;
          }
        } catch (error) {
          results.cardReaderConfig = { error: error.message };
        }
    
        // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        console.log('üìã ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...');
    
        const successCount = Object.values(results.results).filter(r => r.success).length;
        const totalCount = Object.keys(results.results).length;
    
        const report = `Card Reader Diagnostic Report
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleString('th-TH')}
üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤: ${results.branch}
üåê ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï: ${results.internetConnectivity ? '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ' : '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'}
üè† ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${results.localServerHealth?.success ? '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥' : '‚ùå ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤'}
üì° Endpoints: ${successCount}/${totalCount} OK
üîß Configuration: ${results.cardReaderConfig?.available ? '‚úÖ' : '‚ùå'}

üìä Endpoint Details:
${Object.entries(results.results).map(([name, result]) =>
  `   ${result.success ? '‚úÖ' : '‚ùå'} ${name}: ${result.status || result.error} ${result.duration ? `(${result.duration})` : ''}`
).join('\n')}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
    
        console.log(report);
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô UI
        if (typeof showToast === 'function') {
          const overallStatus = results.internetConnectivity && results.localServerHealth?.success && successCount > 0 ? '‚úÖ' : '‚ùå';
    
          showToast(`
            <div class="text-left">
              <h6 class="mb-2">üîç Card Reader Diagnostic ${overallStatus}</h6>
              <div class="small mb-2">
                <div>üåê Internet: ${results.internetConnectivity ? '‚úÖ' : '‚ùå'}</div>
                <div>üè† Server: ${results.localServerHealth?.success ? '‚úÖ' : '‚ùå'}</div>
                <div>üì° Endpoints: ${successCount}/${totalCount} OK</div>
                <div>üîß Config: ${results.cardReaderConfig?.available ? '‚úÖ' : '‚ùå'}</div>
              </div>
              <div class="d-flex gap-2">
                <button onclick="navigator.clipboard.writeText(\`${report.replace(/`/g, '\\`')}\`).then(() => showToast('üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success', '', 2000))" class="btn btn-sm btn-secondary">
                  üìã Copy Report
                </button>
                <button onclick="window.open('data:text/plain;charset=utf-8,' + encodeURIComponent(\`${report.replace(/`/g, '\\`')}\`))" class="btn btn-sm btn-info">
                  üìÑ Export
                </button>
              </div>
            </div>
          `, overallStatus === '‚úÖ' ? 'success' : 'warning', 'Diagnostic Report', 20000);
        }
    
        return results;
    
      } finally {
        // Hide loading
        showLoading(false);
      }
    }
    
    /**
     * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
     */
    function showSystemHealthStatus() {
      if (typeof showToast === 'function') {
        const healthStatus = `
          <div class="system-health">
            <h6 class="mb-3">üè• ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h6>
            <div class="status-grid">
              <div class="status-item">
                <strong>üî• Firebase:</strong> ${window.firebase ? '‚úÖ Connected' : '‚ùå Disconnected'}
              </div>
              <div class="status-item">
                <strong>üîå Socket.IO:</strong> ${window.io && window.io.connected ? '‚úÖ Connected' : '‚ùå Disconnected'}
              </div>
              <div class="status-item">
                <strong>üñ®Ô∏è Printer:</strong> ${window.PrinterService ? '‚úÖ Available' : '‚ùå Unavailable'}
              </div>
              <div class="status-item">
                <strong>üÜî Card Reader:</strong> <span id="cardReaderHealthStatus">üîç Checking...</span>
              </div>
            </div>
            <div class="mt-3">
              <button onclick="location.reload()" class="btn btn-sm btn-primary">
                üîÑ Reload Page
              </button>
            </div>
          </div>
        `;
    
        showToast(healthStatus, 'info', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö', 0);
    
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Card Reader ‡πÅ‡∏ö‡∏ö real-time
        checkCardReaderStatus().then(status => {
          const healthElement = document.getElementById('cardReaderHealthStatus');
          if (healthElement) {
            healthElement.textContent = status.online ? '‚úÖ Online' : '‚ùå Offline';
          }
        });
      }
    }
    
    // Make functions globally available
    window.retryReadCard = retryReadCard;
    window.showManualCustomerEntry = showManualCustomerEntry;
    window.submitManualEntry = submitManualEntry;
    window.tryCardReaderAgain = tryCardReaderAgain;
    window.checkCardReaderStatus = checkCardReaderStatus;
    window.updateCardReaderStatusDisplay = updateCardReaderStatusDisplay;
    window.showSystemHealthStatus = showSystemHealthStatus;
    window.runComprehensiveCardReaderDiagnostic = runComprehensiveCardReaderDiagnostic;
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô monitoring ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° monitoring ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      setTimeout(initCardReaderStatusMonitoring, 3000);
    });

    // ======================= BARCODE INPUT PROCESSING =======================
    async function processBarcodeInput() {
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
      const barcodeProductInfo = document.getElementById('barcodeProductInfo');
    
      if (!barcodeInput) return;
    
      const barcode = barcodeInput.value.trim();
    
      if (!barcode) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'warning');
        barcodeInput.focus();
        return;
      }
    
      // Show loading state
      let loaderId = null;
      try {
        // Show loading
        showLoading(true);
    
        // üîç Audit Log - Barcode scan attempt
        logAuditEvent('BARCODE_SCAN_ATTEMPT', {
          branchCode: BRANCH_CODE,
          barcode: barcode,
          inputMethod: 'manual',
          timestamp: new Date().toISOString()
        }, 'INFO');
    
        // Rate limiting for barcode processing
        if (!checkRateLimit('barcode_process', 20, 60000)) {
          showToast('‡∏Ñ‡∏∏‡∏ì‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'warning');
          return;
        }
    
        // Validate barcode format
        const sanitizedBarcode = sanitizeInput(barcode, 'text');
        if (sanitizedBarcode.length < 3) {
          showToast('‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'warning');
          barcodeInput.focus();
          return;
        }
    
        // Check if stock data is available
        if (!approvedStocks || approvedStocks.length === 0) {
          showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
          return;
        }
    
        // Find product by barcode
        const product = approvedStocks.find(p =>
          p.barcode === sanitizedBarcode ||

          p.imei === sanitizedBarcode ||
          p.name.toLowerCase().includes(sanitizedBarcode.toLowerCase())
        );
    
        if (product) {
          // Check if product is already in cart
          let inCart = false;
          let cartMessage = '';
    
          if (product.imei) {
            // For IMEI products, check by IMEI
            inCart = cartItems.some(item => item.imei === product.imei);
            cartMessage = `'${product.name}' (IMEI: ${product.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`;
          } else {
            // For quantity products, check by name
            inCart = cartItems.some(item => item.name === product.name && !item.imei);
            cartMessage = `'${product.name}' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`;
          }
    
          if (inCart) {
            showToast(cartMessage, 'warning');
            barcodeResults.classList.add('hidden');
    
            // üîç Audit Log - Product already in cart
            logAuditEvent('BARCODE_SCAN_DUPLICATE', {
              branchCode: BRANCH_CODE,
              productId: product._id,
              productName: product.name,
              barcode: sanitizedBarcode
            }, 'WARNING');
    
            return;
          }
    
          // Show product found message
          barcodeProductInfo.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">${product.name}</div>
                <div class="text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${formatPrice(product.price)}</div>
                ${product.imei ? `<div class="text-xs">IMEI: ${product.imei}</div>` : ''}
                ${product.brand ? `<div class="text-xs">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${product.brand}</div>` : ''}
              </div>
              <div class="text-right">
                <div class="badge badge-success">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                <div class="text-xs mt-1">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î: ${sanitizedBarcode}</div>
              </div>
            </div>
          `;
          barcodeResults.classList.remove('hidden');
    
          // Add to cart
          addToCart(
            product._id,
            product.name,
            product.price,
            product.imei,
            product.taxType,
            product.model,
            product.poNumber,
            product.supplier
          );
    
          // Show success message
          showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
          // Clear input after successful scan
          barcodeInput.value = '';
    
          // Auto-hide results after 3 seconds
          setTimeout(() => {
            barcodeResults.classList.add('hidden');
          }, 3000);
    
          // üîç Audit Log - Successful barcode scan
          logAuditEvent('BARCODE_SCAN_SUCCESS', {
            branchCode: BRANCH_CODE,
            productId: product._id,
            productName: product.name,
            barcode: sanitizedBarcode,
            price: product.price,
            cartCount: cartItems.length + 1
          }, 'SUCCESS');
    
          // Focus back to barcode input for next scan
          setTimeout(() => {
            barcodeInput.focus();
          }, 100);
    
        } else {
          // Product not found
          showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î: ${sanitizedBarcode}`, 'error');
          barcodeResults.classList.add('hidden');
    
          // üîç Audit Log - Product not found
          logAuditEvent('BARCODE_SCAN_NOT_FOUND', {
            branchCode: BRANCH_CODE,
            barcode: sanitizedBarcode,
            stockCount: approvedStocks.length
          }, 'WARNING');
    
          // Focus back to input
          barcodeInput.focus();
          barcodeInput.select();
        }
    
      } catch (error) {
        console.error('‚ùå Barcode processing error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î', 'error');
        barcodeResults.classList.add('hidden');
    
        // üîç Audit Log - Barcode processing error
        logAuditEvent('BARCODE_SCAN_ERROR', {
          branchCode: BRANCH_CODE,
          barcode: barcode,
          error: error.message,
          stack: error.stack
        }, 'ERROR');
    
      } finally {
        // Hide loading
        showLoading(false);
      }
    }
    
    // ======================= END OF BARCODE INPUT PROCESSING =======================

    // ======================= END OF SCANNER LOGIC =======================</script>

  <!-- Add modal HTML for confirmations before the closing </body> tag -->
  <input type="checkbox" id="confirmActionModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
      <p class="py-4" id="confirmActionText">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
      <div class="modal-action">
        <label for="confirmActionModal" class="btn btn-secondary" id="cancelActionBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</label>
        <label for="confirmActionModal" class="btn btn-primary" id="okActionBtn">‡∏ï‡∏Å‡∏•‡∏á</label>
      </div>
    </div>
  </div>
  <!-- Add customConfirm function and its event listeners -->
  <script>
    let pendingAction = null;
    function customConfirm(message, actionCallback) {
      document.getElementById('confirmActionText').textContent = message;
      pendingAction = actionCallback;
      document.getElementById('confirmActionModal').checked = true;
    }
    document.getElementById('okActionBtn').addEventListener('click', () => {
      if (pendingAction) pendingAction();
      pendingAction = null;
    });
    document.getElementById('cancelActionBtn').addEventListener('click', () => {
      pendingAction = null;
    });
  </script>

  <!-- Firebase Realtime Database Enhanced -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const currentSession = {
      branchCode: window.BRANCH_CODE || 'PATTANI',
      sessionId: 'POS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      staffId: localStorage.getItem('userId'),
      staffName: localStorage.getItem('userName'),
      timestamp: Date.now()
    };

    // Firebase References
    const cartCountRef = ref(db, `pos/${currentSession.branchCode}/cart/count`);
    const sessionRef = ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`);
    const stockUpdatesRef = ref(db, `pos/${currentSession.branchCode}/stockUpdates`);
    const salesRef = ref(db, `pos/${currentSession.branchCode}/sales`);
    const notificationsRef = ref(db, `pos/${currentSession.branchCode}/notifications`);
    const onlineUsersRef = ref(db, `pos/${currentSession.branchCode}/onlineUsers`);

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    let lastUpdateSource = null;
    let lastCartCount = 0;
    let isFirebaseConnected = false;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
    const connectedRef = ref(db, '.info/connected');
    onValue(connectedRef, (snapshot) => {
      isFirebaseConnected = snapshot.val() === true;
      window.isFirebaseConnected = isFirebaseConnected;
      console.log('üî• Firebase connection status:', isFirebaseConnected ? 'Connected' : 'Disconnected');
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firebase status indicator
      updateFirebaseStatus(isFirebaseConnected);
      
      if (isFirebaseConnected) {
        registerSession();
        setupOnDisconnect();
        
        if (typeof showToast === 'function') {
          showToast('üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (window.posNotificationSystem) {
          window.posNotificationSystem.showToast('pos', {
            title: 'Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
            message: '‡∏£‡∏∞‡∏ö‡∏ö Real-time Database ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
            type: 'success',
            icon: 'üî•'
          });
        }
      } else {
        if (typeof showToast === 'function') {
          showToast('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', 'warning');
        }
      }
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
      updateConnectionStatus();
    });

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô session
    async function registerSession() {
      try {
        await set(sessionRef, {
          ...currentSession,
          status: 'online',
          lastActivity: serverTimestamp(),
          cartItems: window.cartItems?.length || 0,
          userAgent: navigator.userAgent,
          connectedAt: serverTimestamp()
        });
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ online
        await set(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`), {
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          sessionId: currentSession.sessionId,
          connectedAt: serverTimestamp()
        });
        
        console.log('‚úÖ Session registered to Firebase');
      } catch (error) {
        console.error('‚ùå Failed to register session:', error);
      }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ onDisconnect
    function setupOnDisconnect() {
      onDisconnect(sessionRef).set({
        ...currentSession,
        status: 'offline',
        lastActivity: serverTimestamp(),
        disconnectedAt: serverTimestamp()
      });
      
      onDisconnect(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á Cart Count
    onValue(cartCountRef, (snapshot) => {
      const count = snapshot.val() || 0;
      if (lastUpdateSource !== 'socket' && lastCartCount !== count) {
        updateCartCountDisplay(count, 'firebase');
        lastCartCount = count;
      }
      setTimeout(() => { lastUpdateSource = null; }, 100);
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stock
    onValue(stockUpdatesRef, (snapshot) => {
      const updates = snapshot.val();
      if (updates) {
        console.log('üì¶ Stock updates received from Firebase:', updates);
        
        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å with throttling
        safeReloadStocks();
        
        if (typeof showToast === 'function') {
          showToast('üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        
        // POS Notification
        if (window.posNotificationSystem) {
          window.posNotificationSystem.showToast('pos', {
            title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å',
            message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å Firebase',
            type: 'info',
            icon: 'üì¶'
          });
        }
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    onValue(notificationsRef, (snapshot) => {
      const notifications = snapshot.val();
      if (notifications) {
        Object.entries(notifications).forEach(([key, notification]) => {
          if (notification.timestamp > (Date.now() - 60000)) { // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            if (typeof showToast === 'function') {
              showToast(notification.message, notification.type || 'info');
            }
            
            if (window.posNotificationSystem) {
              window.posNotificationSystem.addNotification('pos', {
                title: notification.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                message: notification.message,
                type: notification.type || 'info',
                icon: notification.icon || 'üîî',
                metadata: {
                  source: 'firebase',
                  firebaseKey: key,
                  timestamp: new Date().toLocaleString('th-TH')
                }
              });
            }
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    onValue(onlineUsersRef, (snapshot) => {
      const users = snapshot.val() || {};
      const onlineCount = Object.keys(users).length;
      console.log(`üë• Online users in ${currentSession.branchCode}:`, onlineCount);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element)
      const onlineCountEl = document.getElementById('onlineUserCount');
      if (onlineCountEl) {
        onlineCountEl.textContent = onlineCount;
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
    window.updateCartCountDisplay = function (count, source = 'local') {
      const el = document.getElementById("cartCount");
      if (el && el.textContent != count) {
        el.textContent = count;
        console.log(`üìä Cart count updated: ${count} (source: ${source})`);
      }
      lastUpdateSource = source;
      lastCartCount = count;
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firebase
    window.updateCartCountToFirebase = function (count) {
      if (!isFirebaseConnected) {
        console.warn('‚ö†Ô∏è Firebase not connected, skipping cart update');
        return;
      }
      
      if (lastCartCount !== count) {
        set(cartCountRef, count).then(() => {
          console.log('‚úÖ Firebase cart count updated successfully');
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï session activity
          set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`), serverTimestamp());
          set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/cartItems`), count);
          
        }).catch(err => {
          console.error('‚ùå Firebase cart update error:', err);
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'warning');
          }
        });
      }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    window.sendSaleToFirebase = function (saleData) {
      if (!isFirebaseConnected) {
        console.warn('‚ö†Ô∏è Firebase not connected, skipping sale sync');
        return;
      }

      const saleRef = push(salesRef);
      set(saleRef, {
        ...saleData,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode,
        timestamp: serverTimestamp(),
        syncedAt: Date.now()
      }).then(() => {
        console.log('‚úÖ Sale data synced to Firebase');
      }).catch(err => {
        console.error('‚ùå Failed to sync sale data:', err);
      });
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    window.sendNotificationToFirebase = function (notification) {
      if (!isFirebaseConnected) return;

      const notifRef = push(notificationsRef);
      set(notifRef, {
        ...notification,
        branchCode: currentSession.branchCode,
        sessionId: currentSession.sessionId,
        timestamp: serverTimestamp(),
        createdAt: Date.now()
      }).then(() => {
        console.log('‚úÖ Notification sent to Firebase');
      }).catch(err => {
        console.error('‚ùå Failed to send notification:', err);
      });
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Activity
    window.updateActivity = function (activity) {
      if (!isFirebaseConnected) return;
      
      set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`), serverTimestamp());
      set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/currentActivity`), activity);
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å
    window.sendStockUpdateToFirebase = function (stockData) {
      if (!isFirebaseConnected) return;

      const updateRef = push(stockUpdatesRef);
      set(updateRef, {
        ...stockData,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode,
        timestamp: serverTimestamp(),
        updatedAt: Date.now()
      });
    };

    // Heartbeat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤ session
    setInterval(() => {
      if (isFirebaseConnected) {
        set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastHeartbeat`), serverTimestamp());
      }
    }, 30000); // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // Cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('beforeunload', () => {
      if (isFirebaseConnected) {
        set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/status`), 'offline');
        remove(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`));
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    function updateFirebaseStatus(connected) {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        statusEl.className = connected ? 'w-2 h-2 rounded-full connected' : 'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 'Firebase: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' : 'Firebase: ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
      }
    }

    function updateSocketStatus(connected) {
      const statusEl = document.getElementById('socketStatus');
      if (statusEl) {
        statusEl.className = connected ? 'w-2 h-2 rounded-full connected' : 'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 'Socket.IO: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' : 'Socket.IO: ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
      }
    }

    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;

      const firebaseOk = window.isFirebaseConnected || false;
      const socketOk = window.socketConnected || false;

      if (firebaseOk && socketOk) {
        statusEl.className = 'connection-status online text-xs font-medium';
        statusEl.textContent = 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
      } else if (!firebaseOk && !socketOk) {
        statusEl.className = 'connection-status offline text-xs font-medium';
        statusEl.textContent = 'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
      } else {
        statusEl.className = 'connection-status connecting text-xs font-medium';
        statusEl.textContent = 'üü° ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
      }
    }

    // Export functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Socket.IO ‡πÉ‡∏ä‡πâ
    window.updateFirebaseStatus = updateFirebaseStatus;
    window.updateSocketStatus = updateSocketStatus;
    window.updateConnectionStatus = updateConnectionStatus;

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• session ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window
    window.currentSession = currentSession;

    console.log('üî• Firebase Realtime Database initialized with enhanced features');
    console.log('üì± Session ID:', currentSession.sessionId);
    console.log('üè¢ Branch Code:', currentSession.branchCode);
  </script>

  <!-- Socket.IO Client Integration Enhanced -->
  <script>
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡∏û‡∏£‡πâ‡∏≠‡∏° configuration
    const socket = io({
      timeout: 10000,
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      randomizationFactor: 0.5
    });

    let socketConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;

    socket.on('connect', () => {
      socketConnected = true;
      window.socketConnected = true;
      reconnectAttempts = 0;
      console.log('üîó Socket.IO connected successfully');
      console.log('üÜî Socket ID:', socket.id);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Socket status indicator
      if (window.updateSocketStatus) {
        window.updateSocketStatus(true);
      }

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠ join room
      socket.emit('join_branch', {
        branchCode: window.BRANCH_CODE || window.currentBranchCode,
        sessionId: window.currentSession?.sessionId,
        staffId: localStorage.getItem('userId'),
        staffName: localStorage.getItem('userName'),
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      });

      if (typeof showToast === 'function') {
        showToast('üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
          message: 'Socket.IO ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
          type: 'success',
          icon: 'üîó'
        });
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏° heartbeat
      startHeartbeat();

      // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: 'Socket.IO ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß',
          message: '‡∏£‡∏∞‡∏ö‡∏ö real-time ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
          type: 'success',
          icon: 'üîó',
          source: 'socket'
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    });

    socket.on('disconnect', (reason) => {
      socketConnected = false;
      window.socketConnected = false;
      console.log('‚ùå Socket.IO disconnected:', reason);
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Socket status indicator
      if (window.updateSocketStatus) {
        window.updateSocketStatus(false);
      }
    
      let message = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
      let toastType = 'warning';
    
      if (reason === 'io server disconnect') {
        message = '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        toastType = 'error';
      } else if (reason === 'io client disconnect') {
        message = '‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
        toastType = 'info';
      } else if (reason === 'ping timeout') {
        message = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
      } else if (reason === 'transport close') {
        message = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î';
      }
    
      if (typeof showToast === 'function') {
        showToast(`‚ö†Ô∏è Socket.IO: ${message}`, toastType);
      }

      // ‡∏´‡∏¢‡∏∏‡∏î heartbeat
      stopHeartbeat();

      // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: 'Socket.IO ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
          message: message,
          type: 'warning',
          icon: '‚ö†Ô∏è',
          source: 'socket'
        });
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
      if (typeof showToast === 'function') {
        showToast('üîÑ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          message: `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å ${attemptNumber} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,
          type: 'success',
          icon: 'üîÑ'
        });
      }
    });

    socket.on('reconnect_attempt', (attemptNumber) => {
      reconnectAttempts = attemptNumber;
      console.log('üîÑ Attempting to reconnect...', attemptNumber);
    
      if (attemptNumber <= 3) {
        if (typeof showToast === 'function') {
          showToast(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà... (${attemptNumber}/5)`, 'info');
        }
      }
    });

    socket.on('reconnect_failed', () => {
      console.error('‚ùå Socket.IO reconnection failed');
      if (typeof showToast === 'function') {
        showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡πÑ‡∏î‡πâ', 'error');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
          message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
          type: 'error',
          icon: '‚ùå',
          actions: [{
            label: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
            action: 'primary',
            callback: () => socket.connect()
          }]
        });
      }
    });

    // Heartbeat functions
    function startHeartbeat() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
    
      heartbeatInterval = setInterval(() => {
        if (socketConnected) {
          socket.emit('heartbeat', {
            branchCode: window.BRANCH_CODE,
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now(),
            cartItems: window.cartItems?.length || 0
          });
        }
      }, 30000); // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // ‡∏ü‡∏±‡∏á event ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï cart count
    socket.on('cart_count_updated', (data) => {
      console.log('üì¶ Cart count updated via Socket.IO:', data);
      const newCount = data.count || data;
    
      if (window.updateCartCountDisplay) {
        window.updateCartCountDisplay(newCount, 'socket');
      }
    
      if (window.posNotificationSystem && data.branchCode === window.BRANCH_CODE) {
        window.posNotificationSystem.showToast('pos', {
          title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤',
          message: `‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
          type: 'info',
          icon: 'üõí'
        });
      }
    });

    // ‡∏ü‡∏±‡∏á event ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å
    socket.on('stock_updated', (data) => {
      console.log('üìà Stock updated - refreshing product data', data);
    
      safeReloadStocks();
    
      if (typeof showToast === 'function') {
        showToast('üì¶ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'info');
      }
    
      // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å',
          message: '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
          type: 'info',
          icon: 'üì¶',
          source: 'socket'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
          message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
          type: 'info',
          icon: 'üì¶'
        });
      }
    });

    // ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å inventory dashboard
    socket.on('stockUpdate', (data) => {
      console.log('üìà Stock update received from inventory dashboard');
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('üì¶ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'info');
      }
    });

    socket.on('stockApproved', (data) => {
      console.log('‚úÖ Stock approved:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
          message: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${data.productName || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'success',
          icon: '‚úÖ',
          metadata: {
            productId: data.productId,
            branchCode: data.branchCode,
            approvedBy: data.approvedBy,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('stockVerified', (data) => {
      console.log('üîç Stock verified:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('üîç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
          message: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${data.productName || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'} ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'info',
          icon: 'üîç',
          metadata: {
            productId: data.productId,
            verifiedBy: data.verifiedBy,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('stockRejected', (data) => {
      console.log('‚ùå Stock rejected:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'warning');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
          message: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${data.productName || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ${data.reason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•'}`,
          type: 'warning',
          icon: '‚ùå',
          metadata: {
            productId: data.productId,
            rejectedBy: data.rejectedBy,
            reason: data.reason,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('order_completed', (data) => {
      console.log('‚úÖ Order completed:', data);
      if (typeof showToast === 'function') {
        showToast(`üéâ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${data.orderId || data.order_id} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`, 'success');
      }
    
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ Firebase
      if (window.sendSaleToFirebase && data.branchCode === window.BRANCH_CODE) {
        window.sendSaleToFirebase({
          orderId: data.orderId || data.order_id,
          invoiceNo: data.invoiceNo || data.invoice_no,
          total: data.total,
          items: data.items,
          customer: data.customer,
          staff: data.staff,
          paymentMethod: data.paymentMethod,
          source: 'socket'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
          message: `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${data.orderId || data.order_id} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`,
          type: 'success',
          icon: 'üéâ',
          actions: data.receiptUrl ? [{
            label: '‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à',
            action: 'primary',
            callback: () => window.open(data.receiptUrl, '_blank')
          }] : [],
          metadata: {
            orderId: data.orderId || data.order_id,
            total: data.total,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('branch_notification', (data) => {
      console.log('üîî Branch notification:', data);
    
      if (data.branchCode && data.branchCode !== window.BRANCH_CODE) {
        return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏£‡∏≤
      }
    
      if (typeof showToast === 'function') {
        showToast(data.message || 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', data.type || 'info');
      }
    
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: data.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤',
          message: data.message,
          type: data.type || 'info',
          icon: data.icon || 'üîî',
          source: 'socket',
          priority: data.priority || 'normal'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: data.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤',
          message: data.message,
          type: data.type || 'info',
          icon: data.icon || 'üîî',
          metadata: {
            branchCode: data.branchCode,
            source: 'branch_notification',
            priority: data.priority,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á event ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
    socket.on('promotion_updated', (data) => {
      console.log('üéÅ Promotion updated:', data);
    
      if (typeof loadActivePromotions === 'function') {
        loadActivePromotions();
      }
    
      if (typeof showToast === 'function') {
        showToast('üéÅ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô', 'info');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
          message: `‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ${data.promotionName || '‡πÉ‡∏´‡∏°‡πà'} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï`,
          type: 'info',
          icon: 'üéÅ',
          metadata: {
            promotionId: data.promotionId,
            promotionName: data.promotionName,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á event ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    window.emitCartUpdate = function (cartData) {
      if (socketConnected) {
        socket.emit('cart_updated', {
          branchCode: window.BRANCH_CODE || window.currentBranchCode,
          sessionId: window.currentSession?.sessionId,
          cartItems: cartData,
          count: cartData.length,
          timestamp: new Date().toISOString(),
          staffId: localStorage.getItem('userId')
        });
        console.log('üì§ Cart update sent to server');
      } else {
        console.warn('‚ö†Ô∏è Socket not connected, cannot emit cart update');
      }
    };

    window.emitCheckoutCompleted = function (orderData) {
      if (socketConnected) {
        socket.emit('checkout_completed', {
          ...orderData,
          branchCode: window.BRANCH_CODE || window.currentBranchCode,
          sessionId: window.currentSession?.sessionId,
          timestamp: new Date().toISOString()
        });
        console.log('üí∞ Checkout completion sent to server');
      }
    };

    window.emitStockCheck = function (productId) {
      if (socketConnected) {
        socket.emit('stock_check', {
          productId,
          branchCode: window.BRANCH_CODE,
          sessionId: window.currentSession?.sessionId,
          timestamp: new Date().toISOString()
        });
      }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    window.getConnectionStatus = function () {
      return {
        socket: socketConnected,
        firebase: window.isFirebaseConnected || false,
        socketId: socket.id,
        reconnectAttempts: reconnectAttempts,
        timestamp: new Date().toISOString()
      };
    };

    // Error handling
    socket.on('error', (error) => {
      console.error('‚ùå Socket.IO error:', error);
      if (typeof showToast === 'function') {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO', 'danger');
      }
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket.IO connection error:', error);
      if (typeof showToast === 'function') {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket.IO ‡πÑ‡∏î‡πâ', 'error');
      }
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
    setInterval(() => {
      const status = window.getConnectionStatus();
      console.log('üìä Connection Status:', status);
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    }, 10000); // ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    console.log('üîå Socket.IO client initialized with enhanced features');
    console.log('üì° Attempting to connect to server...');

    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    document.addEventListener('DOMContentLoaded', () => {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    
      setTimeout(() => {
        if (socketConnected) {
          if (typeof showToast === 'function') {
            showToast('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö Real-time ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
          }
        }
    
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        if (window.updateConnectionStatus) {
          window.updateConnectionStatus();
        }
      }, 2000);
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    document.addEventListener('DOMContentLoaded', function () {
      // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏î Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
        customerSearch.addEventListener('input', function (e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });

    let searchTimeout = null;
    let selectedCustomer = null;
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà)
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');

      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'warning');
        } else {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô');
        }
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
        } else {
          alert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;
      // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® loaderId ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å try block
      let loaderId = null;

      try {
        // Show loading
        showLoading(true);
    
        if (typeof showToast === 'function') {
          showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status code ‡∏Å‡πà‡∏≠‡∏ô parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('üö´ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', 'error');
          }
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ cooldown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ 429
          lastSearchTime = Date.now() + 27000; // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 27 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏£‡∏ß‡∏° 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

          resultsList.innerHTML = `
        <div class="p-4 text-center text-red-500">
          <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
          <p class="text-sm font-medium">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
          <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</p>
        </div>
      `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');

          if (typeof showToast === 'function') {
            showToast('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'success');
          }
        } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          resultsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
          <i class="bi bi-person-x text-2xl mb-2 block"></i>
          <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</p>
          <p class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${searchValue}</p>
        </div>
      `;
          resultsContainer.classList.remove('hidden');

          if (typeof showToast === 'function') {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);

        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        if (error.message.includes('429')) {
          errorMessage = '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
        }

        resultsList.innerHTML = `
      <div class="p-4 text-center text-red-500">
        <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
        <p class="text-sm font-medium">${errorMessage}</p>
        <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
      </div>
    `;
        resultsContainer.classList.remove('hidden');

        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
        // Hide loading
        showLoading(false);
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
      resultsList.innerHTML = `
    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
         onclick="selectCustomer('${customerData._id}', '${customerData.contactPhone || ''}')">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h4 class=\"font-semibold text-sm\">${customerData.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
            <i class="bi bi-credit-card mr-1"></i>
            ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
          </p>
          <p class="text-xs text-gray-600 dark:text-gray-400">
            <i class="bi bi-telephone mr-1"></i>
            ‡πÇ‡∏ó‡∏£: ${customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
          </p>
          <div class="flex items-center gap-2 mt-2">
            <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">
              ${customerData.isNewCustomer ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤'}
            </span>
            <span class="text-xs text-gray-500">
              ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${customerData.totalPurchases || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </span>
          </div>
        </div>
        <div class="text-right">
          <button class="btn btn-sm btn-primary">
            <i class="bi bi-check-circle mr-1"></i>
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          </button>
        </div>
      </div>
    </div>
  `;

    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö frontstore)
    function fillCustomerFormFrontstore(customer) {
      selectedCustomer = customer;

      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        document.getElementById('customerType').value = 'individual';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
        document.getElementById('personalFields').classList.remove('hidden');
        document.getElementById('corporateFields').classList.add('hidden');

              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
      document.getElementById('customerPrefix').value = individual.prefix || '';
      document.getElementById('customerGender').value = individual.gender || '';
      document.getElementById('customerFirstName').value = individual.firstName || '';
      document.getElementById('customerLastName').value = individual.lastName || '';
      document.getElementById('customerTaxId').value = individual.taxId || individual.idCard || '';
      document.getElementById('customerPhone').value = individual.phone || '';
      document.getElementById('customerEmailPersonal').value = individual.email || '';
      document.getElementById('customerOccupation').value = individual.occupation?.category || '';
    
      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏
      if (individual.birthDate || individual.dateOfBirth) {
        const birthDate = individual.birthDate || individual.dateOfBirth;
    
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        let formattedDate = birthDate;
        if (typeof birthDate === 'string' && birthDate.includes('/')) {
          const parts = birthDate.split('/');
          if (parts.length === 3) {
            formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
          }
        }
    
        document.getElementById('customerBirthDate').value = formattedDate;
    
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
        setTimeout(() => {
          calculateAgeFromBirthDate();
        }, 100);
      } else if (individual.age) {
        document.getElementById('customerAge').value = individual.age;
      }

        // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || addr.houseNo || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || addr.zipcode || '';
        }
      } else if (customer.customerType === 'corporate' && customer.corporate) {
        const corporate = customer.corporate;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        document.getElementById('customerType').value = 'corporate';

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        document.getElementById('personalFields').classList.add('hidden');
        document.getElementById('corporateFields').classList.remove('hidden');

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        document.getElementById('companyName').value = corporate.companyName || '';
        document.getElementById('companyTaxId').value = corporate.companyTaxId || '';
        document.getElementById('contactPerson').value = corporate.contactPerson || '';
        document.getElementById('corporatePhone').value = corporate.corporatePhone || '';
        document.getElementById('corporateEmail').value = corporate.corporateEmail || '';
        document.getElementById('companyAddress').value = corporate.companyAddress || '';
      }

      // ‚úÖ Fix: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö null-safe (frontstore)
      if (customer.statistics) {
        const statusText = customer.statistics.isNewCustomer ?
          '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠)' :
          `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ${customer.statistics.totalPurchases} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;

        if (typeof showToast === 'function') {
          showToast(statusText, 'info');
        } else {
          console.log('üë§ Customer status (frontstore):', statusText);
        }
      }
    
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•
      if (typeof updateEmailStatus === 'function') {
        updateEmailStatus();
      }
    }

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÄ‡∏î‡∏¥‡∏°)
    function fillCustomerForm(customer) {
      selectedCustomer = customer;

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      document.getElementById('customerType').value = customer.customerType;

      if (customer.customerType === 'individual') {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
        document.getElementById('personalFields').classList.remove('hidden');
        document.getElementById('corporateFields').classList.add('hidden');

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
        if (customer.individual) {
          document.getElementById('customerPrefix').value = customer.individual.prefix || '';
          document.getElementById('customerGender').value = customer.individual.gender || '';
          document.getElementById('customerFirstName').value = customer.individual.firstName || '';
          document.getElementById('customerLastName').value = customer.individual.lastName || '';
          document.getElementById('customerPhone').value = customer.individual.phone || '';
          document.getElementById('customerTaxId').value = customer.individual.taxId || '';
          document.getElementById('customerOccupation').value = customer.individual.occupation?.category || '';
    
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏
          if (customer.individual.birthDate || customer.individual.dateOfBirth) {
            const birthDate = customer.individual.birthDate || customer.individual.dateOfBirth;
            let formattedDate = birthDate;
            if (typeof birthDate === 'string' && birthDate.includes('/')) {
              const parts = birthDate.split('/');
              if (parts.length === 3) {
                formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
              }
            }
            document.getElementById('customerBirthDate').value = formattedDate;
            setTimeout(() => {
              calculateAgeFromBirthDate();
            }, 100);
          } else if (customer.individual.age) {
            document.getElementById('customerAge').value = customer.individual.age;
          }

          // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
          if (customer.individual.address) {
            document.getElementById('houseNo').value = customer.individual.address.houseNo || '';
            document.getElementById('moo').value = customer.individual.address.moo || '';
            document.getElementById('subDistrict').value = customer.individual.address.subDistrict || '';
            document.getElementById('district').value = customer.individual.address.district || '';
            document.getElementById('province').value = customer.individual.address.province || '';
            document.getElementById('zipcode').value = customer.individual.address.zipcode || '';
          }
        }
      } else if (customer.customerType === 'corporate') {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        document.getElementById('personalFields').classList.add('hidden');
        document.getElementById('corporateFields').classList.remove('hidden');

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        if (customer.corporate) {
          document.getElementById('companyName').value = customer.corporate.companyName || '';
          document.getElementById('companyTaxId').value = customer.corporate.companyTaxId || '';
          document.getElementById('contactPerson').value = customer.corporate.contactPerson || '';
          document.getElementById('corporatePhone').value = customer.corporate.corporatePhone || '';
          document.getElementById('companyAddress').value = customer.corporate.companyAddress || '';
        }
      }

      // ‚úÖ Fix: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö null-safe (legacy)
      if (customer.statistics) {
        const statusText = customer.statistics.isNewCustomer ?
          '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠)' :
          `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ${customer.statistics.totalPurchases} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;

        if (typeof showToast === 'function') {
          showToast(statusText, 'info');
        } else {
          console.log('üë§ Customer status (legacy):', statusText);
        }
      }
    }

    console.log('üîå Socket.IO client initialized');

    // =================== POS NOTIFICATION GLOBAL FUNCTIONS ===================
    
    // Global functions for external use
    window.showPOSToast = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.showToast('pos', {
          title,
          message,
          type,
          icon: options.icon || 'üè™',
          duration: options.duration || 4000,
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
        if (typeof showToast === 'function') {
          showToast(`${title}: ${message}`, type);
        } else {
          console.log(`[POS Toast] ${title}: ${message} (${type})`);
        }
      }
    };

    window.addPOSNotification = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.addNotification('pos', {
          title,
          message,
          type,
          icon: options.icon || 'üè™',
          actions: options.actions || [],
          metadata: {
            source: 'external',
            timestamp: new Date().toLocaleString('th-TH'),
            ...options.metadata
          },
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
      }
    };

    // Clear all POS notifications
    window.clearPOSNotifications = function() {
      if (posNotificationSystem) {
        posNotificationSystem.clearNotifications('pos');
      }
    };

    // Mark all POS notifications as read
    window.markAllPOSAsRead = function() {
      if (posNotificationSystem) {
        posNotificationSystem.markAllAsRead('pos');
      }
    };

    // Get notification system status
    window.getPOSNotificationStatus = function() {
      if (posNotificationSystem) {
        return {
          initialized: true,
          unreadCount: posNotificationSystem.getUnreadCount('pos'),
          totalCount: posNotificationSystem.getNotificationCount('pos'),
          system: posNotificationSystem
        };
      }
      return { initialized: false };
    };

    // Test notification function (for debugging)
    window.testPOSNotifications = function() {
      console.log('üß™ Testing POS Notifications...');
    
      if (!posNotificationSystem) {
        console.error('‚ùå POS Notification System not initialized');
        return;
      }

      // Test toast
      showPOSToast('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', '‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥', 'success', {
        icon: 'üß™',
        duration: 3000
      });

      // Test notification with actions
      addPOSNotification('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô POS', 'info', {
        icon: 'üîî',
        actions: [
          {
            label: '‡∏ï‡∏Å‡∏•‡∏á',
            action: 'primary',
            callback: () => console.log('‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏Å‡∏•‡∏á')
          },
          {
            label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            action: 'secondary',
            callback: () => console.log('‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')
          }
        ],
        metadata: {
          testId: Date.now(),
          testType: 'manual'
        }
      });

      // Display status
      const status = getPOSNotificationStatus();
      console.log('üìä POS Notification Status:', status);
    };

    // ‚úâÔ∏è **‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•**
    window.testEmailSystem = async function() {
      console.log('üìß Testing Email System...');
    
      try {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        console.log('üîç Checking email service status...');
        const emailStatus = await checkEmailServiceStatus();
        console.log('üìä Email Service Status:', emailStatus);
    
        if (emailStatus.available) {
          if (typeof showToast === 'function') {
            showToast('‚úÖ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
          }
          console.log('‚úÖ Email service is available');
          console.log('üìã Email service details:', emailStatus.details);
        } else {
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          }
          console.log('‚ö†Ô∏è Email service not available:', emailStatus.error);
        }
    
        // 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        const customerType = document.getElementById('customerType').value;
        const customerEmail = customerType === 'individual'
          ? document.getElementById('customerEmailPersonal').value
          : document.getElementById('corporateEmail').value;
    
        if (customerEmail) {
          console.log('üìß Customer email found:', customerEmail);
          if (typeof showToast === 'function') {
            showToast(`üìß ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á: ${customerEmail}`, 'info');
          }
        } else {
          console.log('‚ö†Ô∏è No customer email provided');
          if (typeof showToast === 'function') {
            showToast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'warning');
          }
        }
    
        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ checkbox
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        if (emailCheckbox && emailCheckbox.checked) {
          console.log('‚úÖ Email sending is enabled');
          if (typeof showToast === 'function') {
            showToast('‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
          }
        } else {
          console.log('‚ùå Email sending is disabled');
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          }
        }
    
        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
        const summary = {
          emailServiceAvailable: emailStatus.available,
          customerEmailProvided: !!customerEmail,
          emailSendingEnabled: emailCheckbox?.checked || false,
          readyToSend: emailStatus.available && !!customerEmail && (emailCheckbox?.checked || false)
        };
    
        console.log('üìä Email System Test Summary:', summary);
    
        if (summary.readyToSend) {
          if (typeof showToast === 'function') {
            showToast('üéâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!', 'success');
          }
        } else {
          const issues = [];
          if (!summary.emailServiceAvailable) issues.push('‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
          if (!summary.customerEmailProvided) issues.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
          if (!summary.emailSendingEnabled) issues.push('‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
    
          if (typeof showToast === 'function') {
            showToast(`‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${issues.join(', ')}`, 'warning');
          }
        }
    
        return summary;
    
      } catch (error) {
        console.error('‚ùå Email system test failed:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•', 'error');
        }
        return { error: error.message };
      }
    };

    // ‚úâÔ∏è **‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö**
    window.sendTestEmail = async function() {
      console.log('üì§ Sending test email...');
    
      try {
        const customerType = document.getElementById('customerType').value;
        const customerEmail = customerType === 'individual'
          ? document.getElementById('customerEmailPersonal').value
          : document.getElementById('corporateEmail').value;
    
        if (!customerEmail) {
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'error');
          }
          return;
        }
    
        const customerName = customerType === 'individual'
          ? `${document.getElementById('customerPrefix').value}${document.getElementById('customerFirstName').value} ${document.getElementById('customerLastName').value}`.trim()
          : document.getElementById('companyName').value;
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        const testEmailData = {
          orderId: 'TEST_' + Date.now(),
          invoiceNo: 'TEST_INV_' + Date.now(),
          customerEmail: customerEmail,
          customerName: customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          customerType: customerType
        };
    
        console.log('üìß Test email data:', testEmailData);
        if (typeof showToast === 'function') {
          showToast('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö...', 'info');
        }
    
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        await sendReceiptEmail(testEmailData);
    
        if (typeof showToast === 'function') {
          showToast('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
        }
        console.log('‚úÖ Test email sent successfully');
    
      } catch (error) {
        console.error('‚ùå Test email failed:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message, 'error');
        }
      }
    };

    // Auto-test on development environment
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
      // Add test buttons
      setTimeout(() => {
        if (!document.getElementById('testPOSNotificationBtn')) {
          const testBtn = document.createElement('button');
          testBtn.id = 'testPOSNotificationBtn';
          testBtn.textContent = 'üîî Test POS Notifications';
          testBtn.className = 'fixed bottom-2 right-2 z-50 bg-cyan-500 text-white px-3 py-1 rounded text-sm';
          testBtn.onclick = () => testPOSNotifications();
          document.body.appendChild(testBtn);
        }
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        if (!document.getElementById('testEmailBtn')) {
          const emailBtn = document.createElement('button');
          emailBtn.id = 'testEmailBtn';
          emailBtn.textContent = 'üìß Test Email';
          emailBtn.className = 'fixed bottom-2 right-44 z-50 bg-green-500 text-white px-3 py-1 rounded text-sm';
          emailBtn.onclick = () => testEmailSystem();
          document.body.appendChild(emailBtn);
        }
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        if (!document.getElementById('sendTestEmailBtn')) {
          const sendBtn = document.createElement('button');
          sendBtn.id = 'sendTestEmailBtn';
          sendBtn.textContent = 'üì§ Send Test';
          sendBtn.className = 'fixed bottom-2 right-80 z-50 bg-orange-500 text-white px-3 py-1 rounded text-sm';
          sendBtn.onclick = () => sendTestEmail();
          document.body.appendChild(sendBtn);
        }
    
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Multi-IP Card Reader
        if (!document.getElementById('testCardReaderBtn')) {
          const cardBtn = document.createElement('button');
          cardBtn.id = 'testCardReaderBtn';
          cardBtn.textContent = 'üÜî Test Card Reader';
          cardBtn.className = 'fixed bottom-2 right-[20rem] z-50 bg-purple-500 text-white px-3 py-1 rounded text-sm';
          cardBtn.onclick = () => {
            if (typeof window.testCardReaderConnection === 'function') {
              window.testCardReaderConnection();
            } else {
              alert('‚ùå Card Reader Service ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
          };
          document.body.appendChild(cardBtn);
        }
    
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Multi-IP Endpoints
        if (!document.getElementById('showEndpointStatusBtn')) {
          const endpointBtn = document.createElement('button');
          endpointBtn.id = 'showEndpointStatusBtn';
          endpointBtn.textContent = 'üìä Endpoint Status';
          endpointBtn.className = 'fixed bottom-2 right-[26rem] z-50 bg-indigo-500 text-white px-3 py-1 rounded text-sm';
          endpointBtn.onclick = () => {
            if (typeof window.showEndpointStatus === 'function') {
              window.showEndpointStatus();
            } else {
              alert('‚ùå Card Reader Service ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
          };
          document.body.appendChild(endpointBtn);
        }
    
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Debug Card Reader Config
        if (!document.getElementById('debugCardReaderBtn')) {
          const debugBtn = document.createElement('button');
          debugBtn.id = 'debugCardReaderBtn';
          debugBtn.textContent = 'üîç Debug Card Reader';
          debugBtn.className = 'fixed bottom-2 right-[32rem] z-50 bg-pink-500 text-white px-3 py-1 rounded text-sm';
          debugBtn.onclick = () => {
            if (typeof window.debugCardReader === 'function') {
              window.debugCardReader();
            } else {
              alert('‚ùå Card Reader Service ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
          };
          document.body.appendChild(debugBtn);
        }
      }, 2000);
    }
    }
    
    console.log('üîî POS Notification Global Functions initialized');
  </script>

  <!-- ‚úÖ Enhanced: Printer Service Integration (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HistoryReceipt.html) -->
  <script src="/js/printer-service.js"></script>
  
  <script>
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° BRANCH_CODE global variable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PrinterService
    window.BRANCH_CODE = 'PATTANI'; // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° branch ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    
    // ‚úÖ Enhanced: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó PrinterService integration ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HistoryReceipt.html
    if (typeof window.PrinterService !== 'undefined') {
      console.log('üñ®Ô∏è PrinterService available, upgrading frontstore functions...');
    
      // Override printPOS function ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ PrinterService (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
      window.printPOSWithService = async function(receiptImage) {
        showLoading(true);
    
        try {
    
          // ‡πÉ‡∏ä‡πâ PrinterService ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
          const result = await window.PrinterService.print(receiptImage, {
            documentType: 'frontstore_receipt',
            timestamp: new Date().toISOString()
          });
    
          showLoading(false);

          if (window.showToast) {
            window.showToast('‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üñ®Ô∏è', 'success');
          }
    
        } catch (error) {
          console.error('Print error:', error);
          showLoading(false);
    
          if (window.showToast) {
            window.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: ' + error.message, 'error');
          }
        }
      };
    
      // ‚úÖ Enhanced: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HistoryReceipt.html
      window.testPrinterConnectionWithService = async function() {
        showLoading(true);
    
        try {
          const status = await window.PrinterService.getStatus();
    
          showLoading(false);

          if (status.status === 'connected' || status.status === 'ready') {
            if (typeof showToast === 'function') {
              showToast('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }
          } else {
            throw new Error(status.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ');
          }

        } catch (error) {
          console.error('Printer test failed:', error);
          showLoading(false);

          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
          }
        }
      };
    
      // ‚úÖ Enhanced: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö HistoryReceipt.html
      window.showPrinterSettingsWithService = function() {
        const branchInfo = window.PrinterService.getCurrentBranch();
    
        let message = `üñ®Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (PrinterService)\n\n`;
        message += `‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${branchInfo.code || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n`;
        message += `‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤: ${branchInfo.data?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}\n`;
        message += `URL ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå: ${branchInfo.printerURL || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'}\n`;
        message += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: ${window.PrinterService.isInitialized ? '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô'}\n\n`;
    
        if (branchInfo.data && branchInfo.data.printerServerUrl) {
          message += `‚úÖ ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n`;
          message += `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
        } else {
          message += `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n`;
          message += `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
        }
    
        alert(message);
      };

      // ‚úÖ Enhanced: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HistoryReceipt.html
      window.testDirectPrinterConnection = async function() {
        showLoading(true);
    
        try {
    
          const printerURL = await PrinterSystem.getPrinterURL();
          const apiKey = PrinterSystem.getAPIKey();
    
          console.log(`üîç Testing direct connection to: ${printerURL}`);
          console.log(`üîë Using API Key: ${apiKey.substring(0, 10)}...`);
    
    
          // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô proxy endpoint
          const healthResponse = await fetch('/api/printer/print', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
              image: 'health-check',
              printerURL: printerURL,
              apiKey: apiKey
            })
          });
    
          const healthData = await healthResponse.json();
          console.log('üè• Health check result:', healthData);
    
          showLoading(false);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          let resultMessage = `üñ®Ô∏è ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Printer Server (‡∏ú‡πà‡∏≤‡∏ô Proxy)\n\n`;
          resultMessage += `URL: ${printerURL}\n`;
          resultMessage += `API Key: ${apiKey.substring(0, 10)}...\n\n`;
    
          const healthSuccess = healthData.success || false;
          resultMessage += `Health Check: ${healthSuccess ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'}\n\n`;
    
          if (healthSuccess) {
            resultMessage += `üéâ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n`;
            resultMessage += `Printer Server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`;
          } else {
            resultMessage += `‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠\n`;
            resultMessage += `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå`;
          }
    
          alert(resultMessage);
    
          if (typeof showToast === 'function') {
            showToast(healthSuccess ?
              '‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Printer Server ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' :
              '‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Printer Server ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
              healthSuccess ? 'success' : 'error'
            );
          }
    
        } catch (error) {
          console.error('Direct printer test failed:', error);
          showLoading(false);
    
          alert(`‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Printer Server ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\n\nError: ${error.message}`);
    
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Printer Server ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
          }
        }
      };

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö manual
      document.addEventListener('DOMContentLoaded', () => {
        const manualCheckBtn = document.getElementById('manual-printer-check');
        if (manualCheckBtn) {
          manualCheckBtn.addEventListener('click', testPrinterConnectionWithService);
        }
      });
    
      console.log('‚úÖ Frontstore-PrinterService integration completed');
      console.log('üìñ Available functions: printPOSWithService(), testPrinterConnectionWithService(), showPrinterSettingsWithService(), testDirectPrinterConnection()');
    } else {
      console.warn('‚ö†Ô∏è PrinterService not available in Frontstore');
    
      // Fallback functions
      window.printPOSWithService = async function() {
        if (typeof showToast === 'function') {
          showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
        }
        return Promise.resolve({ success: false, error: 'PrinterService not available' });
      };
    }
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Database Integration (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô HistoryReceipt.html)
    console.log('üîß Database Printer Integration Summary (Frontstore):');
    console.log('   Data Source: https://www.2pheenong.com/api/branch');
    console.log('   Default Branch: 00000 (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)');
    console.log('   Fallback IP: http://100.84.132.71:4004');
    console.log('   API Key: printer-server-key-2024');
    console.log('   Status: ‚úÖ Database-Driven & Ready');
    console.log('   Benefits: üóÑÔ∏è Dynamic, üîÑ Auto-Update, üîí Secure, üåê Multi-Branch');
    console.log('');
    console.log('üéØ Quick Test Commands (All Async):');
    console.log('   await testDirectPrinterConnection() - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Printer Server');
    console.log('   await showPrinterSettingsWithService() - ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
    console.log('   await testPrinterConnectionWithService() - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    console.log('');
    console.log('üìñ Documentation: Database integration allows dynamic printer');
    console.log('   configuration per branch with secure Tailscale connections.');
  </script>

  <script>
    // =================== COMPREHENSIVE THAI ADDRESS SYSTEM ===================

    // Comprehensive Thai Address Dataset
    window.THAI_ADDRESS_DATA = {
      // All 77 Thai Provinces with ID, Name (Thai), Name (English), and Region
      provinces: [
        {id: 1, name: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', name_en: 'Bangkok', region: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø'},
        {id: 2, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', name_en: 'Samut Prakan', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 3, name: '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Nonthaburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 4, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Pathum Thani', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 5, name: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', name_en: 'Phra Nakhon Si Ayutthaya', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 6, name: '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', name_en: 'Ang Thong', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 7, name: '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Lopburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 8, name: '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sing Buri', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 9, name: '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', name_en: 'Chai Nat', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 10, name: '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Saraburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 11, name: '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chonburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 12, name: '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', name_en: 'Rayong', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 13, name: '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chanthaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 14, name: '‡∏ï‡∏£‡∏≤‡∏î', name_en: 'Trat', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 15, name: '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', name_en: 'Chachoengsao', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 16, name: '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Prachin Buri', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 17, name: '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', name_en: 'Nakhon Nayok', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 18, name: '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Sa Kaeo', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
        {id: 19, name: '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', name_en: 'Nakhon Ratchasima', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 20, name: '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', name_en: 'Buriram', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 21, name: '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', name_en: 'Surin', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 22, name: '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', name_en: 'Sisaket', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 23, name: '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Ubon Ratchathani', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 24, name: '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', name_en: 'Yasothon', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 25, name: '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', name_en: 'Chaiyaphum', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 26, name: '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Amnat Charoen', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 27, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', name_en: 'Nong Bua Lam Phu', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 28, name: '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Khon Kaen', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 29, name: '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Udon Thani', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 30, name: '‡πÄ‡∏•‡∏¢', name_en: 'Loei', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 31, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', name_en: 'Nong Khai', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 32, name: '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', name_en: 'Maha Sarakham', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 33, name: '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', name_en: 'Roi Et', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 34, name: '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', name_en: 'Kalasin', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 35, name: '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', name_en: 'Sakon Nakhon', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 36, name: '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', name_en: 'Nakhon Phanom', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 37, name: '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', name_en: 'Mukdahan', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
        {id: 38, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Chiang Mai', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 39, name: '‡∏•‡∏≥‡∏û‡∏π‡∏ô', name_en: 'Lamphun', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 40, name: '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', name_en: 'Lampang', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 41, name: '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', name_en: 'Uttaradit', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 42, name: '‡πÅ‡∏û‡∏£‡πà', name_en: 'Phrae', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 43, name: '‡∏ô‡πà‡∏≤‡∏ô', name_en: 'Nan', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 44, name: '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', name_en: 'Phayao', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 45, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', name_en: 'Chiang Rai', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 46, name: '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', name_en: 'Mae Hong Son', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
        {id: 47, name: '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', name_en: 'Nakhon Sawan', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 48, name: '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Uthai Thani', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 49, name: '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', name_en: 'Kamphaeng Phet', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 50, name: '‡∏ï‡∏≤‡∏Å', name_en: 'Tak', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
        {id: 51, name: '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', name_en: 'Sukhothai', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 52, name: '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', name_en: 'Phitsanulok', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 53, name: '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', name_en: 'Phichit', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 54, name: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', name_en: 'Phetchabun', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 55, name: '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Ratchaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
        {id: 56, name: '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Kanchanaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
        {id: 57, name: '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Suphan Buri', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 58, name: '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', name_en: 'Nakhon Pathom', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 59, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', name_en: 'Samut Sakhon', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 60, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', name_en: 'Samut Songkhram', region: '‡∏Å‡∏•‡∏≤‡∏á'},
        {id: 61, name: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Phetchaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
        {id: 62, name: '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', name_en: 'Prachuap Khiri Khan', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
        {id: 63, name: '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', name_en: 'Nakhon Si Thammarat', region: '‡πÉ‡∏ï‡πâ'},
        {id: 64, name: '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', name_en: 'Krabi', region: '‡πÉ‡∏ï‡πâ'},
        {id: 65, name: '‡∏û‡∏±‡∏á‡∏á‡∏≤', name_en: 'Phang Nga', region: '‡πÉ‡∏ï‡πâ'},
        {id: 66, name: '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', name_en: 'Phuket', region: '‡πÉ‡∏ï‡πâ'},
        {id: 67, name: '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Surat Thani', region: '‡πÉ‡∏ï‡πâ'},
        {id: 68, name: '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', name_en: 'Ranong', region: '‡πÉ‡∏ï‡πâ'},
        {id: 69, name: '‡∏ä‡∏∏‡∏°‡∏û‡∏£', name_en: 'Chumphon', region: '‡πÉ‡∏ï‡πâ'},
        {id: 70, name: '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', name_en: 'Songkhla', region: '‡πÉ‡∏ï‡πâ'},
        {id: 71, name: '‡∏™‡∏ï‡∏π‡∏•', name_en: 'Satun', region: '‡πÉ‡∏ï‡πâ'},
        {id: 72, name: '‡∏ï‡∏£‡∏±‡∏á', name_en: 'Trang', region: '‡πÉ‡∏ï‡πâ'},
        {id: 73, name: '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', name_en: 'Phatthalung', region: '‡πÉ‡∏ï‡πâ'},
        {id: 74, name: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', name_en: 'Pattani', region: '‡πÉ‡∏ï‡πâ'},
        {id: 75, name: '‡∏¢‡∏∞‡∏•‡∏≤', name_en: 'Yala', region: '‡πÉ‡∏ï‡πâ'},
        {id: 76, name: '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', name_en: 'Narathiwat', region: '‡πÉ‡∏ï‡πâ'},
        {id: 77, name: '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', name_en: 'Bueng Kan', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'}
      ],

      // Sample comprehensive districts for key provinces - will be populated by functions
      districts: {},

      // Sample comprehensive sub-districts - will be populated by functions
      subDistricts: {},

      // Postal codes mapping
      postalCodes: {}
    };

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üåç Initializing Comprehensive Thai Address System...');

      // Initialize comprehensive address data
      initializeThaiAddressData();

      // Initialize enhanced dropdowns
      initializeLocationAutocomplete();
    });

    function initializeLocationAutocomplete() {
      try {
        const provInput = document.getElementById('province');
        const distInput = document.getElementById('district');
        const subInput = document.getElementById('subDistrict');
        const zipInput = document.getElementById('zipcode');

        const provDD = document.getElementById('provinceDropdown');
        const distDD = document.getElementById('districtDropdown');
        const subDD = document.getElementById('subDistrictDropdown');

        if (!provInput || !distInput || !subInput || !zipInput || !provDD || !distDD || !subDD) {
          console.warn('‚ö†Ô∏è Some location elements not found, skipping initialization');
          return;
        }

        console.log('üèóÔ∏è Setting up enhanced Thai address dropdowns...');

        // Setup Province dropdown
        const provinceDropdown = setupEnhancedDropdown(provInput, provDD, (itemData) => {
          console.log('üèõÔ∏è Selected province:', itemData.name);

          // Set province value
          provInput.value = itemData.name;

          // Clear dependent fields
          distInput.value = '';
          subInput.value = '';
          zipInput.value = '';

          // Load districts for this province
          loadDistrictsForProvince(itemData.id, districtDropdown);

          // Clear sub-district dropdown
          clearDropdown(subDD, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô');

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ',
          loadingText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...'
        });

        // Setup District dropdown
        const districtDropdown = setupEnhancedDropdown(distInput, distDD, (itemData) => {
          console.log('üèòÔ∏è Selected district:', itemData.name);

          // Set district value
          distInput.value = itemData.name;

          // Clear dependent fields
          subInput.value = '';
          zipInput.value = '';

          // Load sub-districts for this district
          loadSubDistrictsForDistrict(itemData.province_id, itemData.id, tambonDropdown);

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ',
          loadingText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≥‡πÄ‡∏†‡∏≠...'
        });

        // Setup Sub-district dropdown
        const tambonDropdown = setupEnhancedDropdown(subInput, subDD, (itemData) => {
          console.log('üèòÔ∏è Selected sub-district:', itemData.name);

          // Set sub-district value
          subInput.value = itemData.name;

          // Auto-fill postal code if available
          if (itemData.zipcode) {
            zipInput.value = itemData.zipcode;
            // Trigger zipcode validation if available
            if (typeof validateZipcode === 'function') {
              validateZipcode(itemData.zipcode);
            }
            console.log('üìÆ Auto-filled postal code:', itemData.zipcode);
          }

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ',
          loadingText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡∏ö‡∏•...'
        });

        // Enhanced Province focus handler - show all provinces on focus/click
        provInput.addEventListener('focus', () => {
          // Show all provinces when user clicks/focuses on the field
          const allProvinces = window.THAI_ADDRESS_DATA.provinces || [];
          if (allProvinces.length > 0) {
            const items = allProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `‡∏†‡∏≤‡∏Å${province.region} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${province.id.toString().padStart(2, '0')}`
            }));
            provinceDropdown.setItems(items);
            provinceDropdown.open();
          }
        });

        // Enhanced Province search - filter as user types
        provInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();

          if (query.length === 0) {
            // Show all provinces when input is empty
            const allProvinces = window.THAI_ADDRESS_DATA.provinces || [];
            const items = allProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `‡∏†‡∏≤‡∏Ñ${province.region} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${province.id.toString().padStart(2, '0')}`
            }));
            provinceDropdown.setItems(items);
            provinceDropdown.open();
            return;
          }

          // Search provinces locally
          const filteredProvinces = searchProvinces(query);

          if (filteredProvinces.length > 0) {
            const items = filteredProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `‡∏†‡∏≤‡∏Ñ${province.region} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${province.id.toString().padStart(2, '0')}`
            }));

            provinceDropdown.setItems(items);
            provinceDropdown.open();
          } else {
            provinceDropdown.setItems([]);
            provinceDropdown.open();
          }
        }, 200));

        // Enhanced District focus handler - show all districts for selected province
        distInput.addEventListener('focus', () => {
          const selectedProvince = getSelectedProvince(provInput.value);

          if (!selectedProvince) {
            clearDropdown(distDD, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
            return;
          }

          // Show all districts for the selected province
          const allDistricts = window.THAI_ADDRESS_DATA.districts[selectedProvince.id] || [];
          if (allDistricts.length > 0) {
            const items = allDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${district.id.toString().padStart(2, '0')}`
            }));
            districtDropdown.setItems(items);
            districtDropdown.open();
          }
        });

        // Enhanced District search - filter as user types
        distInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          const selectedProvince = getSelectedProvince(provInput.value);

          if (!selectedProvince) {
            clearDropdown(distDD, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
            return;
          }

          if (query.length === 0) {
            // Show all districts when input is empty
            const allDistricts = window.THAI_ADDRESS_DATA.districts[selectedProvince.id] || [];
            const items = allDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${district.id.toString().padStart(2, '0')}`
            }));
            districtDropdown.setItems(items);
            districtDropdown.open();
            return;
          }

          // Search districts locally
          const filteredDistricts = searchDistricts(selectedProvince.id, query);

          if (filteredDistricts.length > 0) {
            const items = filteredDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™: ${district.id.toString().padStart(2, '0')}`
            }));

            districtDropdown.setItems(items);
            districtDropdown.open();
          } else {
            districtDropdown.setItems([]);
            districtDropdown.open();
          }
        }, 200));

        // Enhanced Sub-district focus handler - show all sub-districts for selected district
        subInput.addEventListener('focus', () => {
          const selectedProvince = getSelectedProvince(provInput.value);
          const selectedDistrict = getSelectedDistrict(selectedProvince?.id, distInput.value);

          if (!selectedProvince || !selectedDistrict) {
            clearDropdown(subDD, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
            return;
          }

          // Show all sub-districts for the selected district
          const key = `${selectedProvince.id}-${selectedDistrict.id}`;
          const allSubDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
          if (allSubDistricts.length > 0) {
            const items = allSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${subDistrict.zipcode}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
            }));
            tambonDropdown.setItems(items);
            tambonDropdown.open();
          }
        });

        // Enhanced Sub-district search - filter as user types
        subInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          const selectedProvince = getSelectedProvince(provInput.value);
          const selectedDistrict = getSelectedDistrict(selectedProvince?.id, distInput.value);

          if (!selectedProvince || !selectedDistrict) {
            clearDropdown(subDD, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô');
            return;
          }

          if (query.length === 0) {
            // Show all sub-districts when input is empty
            const key = `${selectedProvince.id}-${selectedDistrict.id}`;
            const allSubDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
            const items = allSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${subDistrict.zipcode}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
            }));
            tambonDropdown.setItems(items);
            tambonDropdown.open();
            return;
          }

          // Search sub-districts locally
          const filteredSubDistricts = searchSubDistricts(selectedProvince.id, selectedDistrict.id, query);

          if (filteredSubDistricts.length > 0) {
            const items = filteredSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${subDistrict.zipcode}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
            }));

            tambonDropdown.setItems(items);
            tambonDropdown.open();
          } else {
            tambonDropdown.setItems([]);
            tambonDropdown.open();
          }
        }, 200));

        // Enhanced Zipcode Validation
        setupZipcodeValidation();

        // Add event listeners for address preview updates
        ['houseNo', 'moo', 'soi', 'road', 'zipcode'].forEach(id => {
          const element = document.getElementById(id);
          if (element && typeof window.updateAddressPreview === 'function') {
            element.addEventListener('input', window.updateAddressPreview);
          }
        });

        console.log('‚úÖ Comprehensive Thai Address System initialized successfully!');
      } catch (error) {
        console.error('‚ùå Failed to initialize Thai address system:', error);
      }
    }

    // =================== THAI ADDRESS DATA INITIALIZATION ===================

    function initializeThaiAddressData() {
      console.log('üóÑÔ∏è Initializing comprehensive Thai address dataset...');

      // Comprehensive districts data for Thai provinces
      window.THAI_ADDRESS_DATA.districts = {
        1: [ // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ - All 50 Official Districts (Khet) - Verified 2024
          {id: 1, name: '‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô', name_en: 'Bang Bon', province_id: 1},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', name_en: 'Bang Kapi', province_id: 1},
          {id: 3, name: '‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', name_en: 'Bang Khae', province_id: 1},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô', name_en: 'Bang Khen', province_id: 1},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°', name_en: 'Bang Kho Laem', province_id: 1},
          {id: 6, name: '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', name_en: 'Bang Khun Thian', province_id: 1},
          {id: 7, name: '‡∏ö‡∏≤‡∏á‡∏ô‡∏≤', name_en: 'Bang Na', province_id: 1},
          {id: 8, name: '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î', name_en: 'Bang Phlat', province_id: 1},
          {id: 9, name: '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', name_en: 'Bang Rak', province_id: 1},
          {id: 10, name: '‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠', name_en: 'Bang Sue', province_id: 1},
          {id: 11, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Bangkok Noi', province_id: 1},
          {id: 12, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà', name_en: 'Bangkok Yai', province_id: 1},
          {id: 13, name: '‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°', name_en: 'Bueng Kum', province_id: 1},
          {id: 14, name: '‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', name_en: 'Chatuchak', province_id: 1},
          {id: 15, name: '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', name_en: 'Chom Thong', province_id: 1},
          {id: 16, name: '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', name_en: 'Din Daeng', province_id: 1},
          {id: 17, name: '‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Don Mueang', province_id: 1},
          {id: 18, name: '‡∏î‡∏∏‡∏™‡∏¥‡∏ï', name_en: 'Dusit', province_id: 1},
          {id: 19, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á', name_en: 'Huai Khwang', province_id: 1},
          {id: 20, name: '‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß', name_en: 'Khan Na Yao', province_id: 1},
          {id: 21, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤', name_en: 'Khlong Sam Wa', province_id: 1},
          {id: 22, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô', name_en: 'Khlong San', province_id: 1},
          {id: 23, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', name_en: 'Khlong Toei', province_id: 1},
          {id: 24, name: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà', name_en: 'Lak Si', province_id: 1},
          {id: 25, name: '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', name_en: 'Lat Krabang', province_id: 1},
          {id: 26, name: '‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß', name_en: 'Lat Phrao', province_id: 1},
          {id: 27, name: '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Min Buri', province_id: 1},
          {id: 28, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', name_en: 'Nong Chok', province_id: 1},
          {id: 29, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°', name_en: 'Nong Khaem', province_id: 1},
          {id: 30, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', name_en: 'Pathum Wan', province_id: 1},
          {id: 31, name: '‡∏û‡∏ç‡∏≤‡πÑ‡∏ó', name_en: 'Phaya Thai', province_id: 1},
          {id: 32, name: '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', name_en: 'Phra Khanong', province_id: 1},
          {id: 33, name: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', name_en: 'Phra Nakhon', province_id: 1},
          {id: 34, name: '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', name_en: 'Pom Prap Sattru Phai', province_id: 1},
          {id: 35, name: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®', name_en: 'Prawet', province_id: 1},
          {id: 36, name: '‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞', name_en: 'Rat Burana', province_id: 1},
          {id: 37, name: '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ', name_en: 'Ratchathewi', province_id: 1},
          {id: 38, name: '‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°', name_en: 'Sai Mai', province_id: 1},
          {id: 39, name: '‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå', name_en: 'Samphanthawong', province_id: 1},
          {id: 40, name: '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á', name_en: 'Saphan Sung', province_id: 1},
          {id: 41, name: '‡∏™‡∏≤‡∏ó‡∏£', name_en: 'Sathon', province_id: 1},
          {id: 42, name: '‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á', name_en: 'Suan Luang', province_id: 1},
          {id: 43, name: '‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤', name_en: 'Thawi Watthana', province_id: 1},
          {id: 44, name: '‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Thon Buri', province_id: 1},
          {id: 45, name: '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏', name_en: 'Thung Khru', province_id: 1},
          {id: 46, name: '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á', name_en: 'Wang Thonglang', province_id: 1},
          {id: 47, name: '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', name_en: 'Watthana', province_id: 1},
          {id: 48, name: '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤', name_en: 'Yan Nawa', province_id: 1},
          {id: 49, name: '‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô', name_en: 'Taling Chan', province_id: 1},
          {id: 50, name: '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Phasi Charoen', province_id: 1}
        ],
        74: [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Pattani', province_id: 74},
          {id: 2, name: '‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Khok Pho', province_id: 74},
          {id: 3, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å', name_en: 'Nong Chik', province_id: 74},
          {id: 4, name: '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', name_en: 'Panare', province_id: 74},
          {id: 5, name: '‡∏°‡∏≤‡∏¢‡∏≠', name_en: 'Mayo', province_id: 74},
          {id: 6, name: '‡∏ó‡∏∏‡πà‡∏á‡∏¢‡∏≤‡∏á‡πÅ‡∏î‡∏á', name_en: 'Thung Yang Daeng', province_id: 74},
          {id: 7, name: '‡∏™‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sai Buri', province_id: 74},
          {id: 8, name: '‡πÑ‡∏°‡πâ‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Mai Kaen', province_id: 74},
          {id: 9, name: '‡∏¢‡∏∞‡∏£‡∏±‡∏á', name_en: 'Yarang', province_id: 74},
          {id: 10, name: '‡∏¢‡∏∞‡∏´‡∏£‡∏¥‡πà‡∏á', name_en: 'Yaring', province_id: 74},
          {id: 11, name: '‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô', name_en: 'Mae Lan', province_id: 74},
          {id: 12, name: '‡∏Å‡∏∞‡∏û‡πâ‡∏≠', name_en: 'Kapho', province_id: 74}
        ],
        38: [ // ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà - All 25 Official Districts - Verified 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Mueang Chiang Mai', province_id: 38},
          {id: 2, name: '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', name_en: 'Chom Thong', province_id: 38},
          {id: 3, name: '‡πÅ‡∏°‡πà‡πÅ‡∏à‡πà‡∏°', name_en: 'Mae Chaem', province_id: 38},
          {id: 4, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏î‡∏≤‡∏ß', name_en: 'Chiang Dao', province_id: 38},
          {id: 5, name: '‡∏î‡∏≠‡∏¢‡∏™‡∏∞‡πÄ‡∏Å‡πá‡∏î', name_en: 'Doi Saket', province_id: 38},
          {id: 6, name: '‡πÅ‡∏°‡πà‡πÅ‡∏ï‡∏á', name_en: 'Mae Taeng', province_id: 38},
          {id: 7, name: '‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°', name_en: 'Mae Rim', province_id: 38},
          {id: 8, name: '‡∏™‡∏∞‡πÄ‡∏°‡∏¥‡∏á', name_en: 'Samoeng', province_id: 38},
          {id: 9, name: '‡∏ù‡∏≤‡∏á', name_en: 'Fang', province_id: 38},
          {id: 10, name: '‡πÅ‡∏°‡πà‡∏≠‡∏≤‡∏¢', name_en: 'Mae Ai', province_id: 38},
          {id: 11, name: '‡∏û‡∏£‡πâ‡∏≤‡∏ß', name_en: 'Phrao', province_id: 38},
          {id: 12, name: '‡∏™‡∏±‡∏ô‡∏õ‡πà‡∏≤‡∏ï‡∏≠‡∏á', name_en: 'San Pa Tong', province_id: 38},
          {id: 13, name: '‡∏™‡∏±‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á', name_en: 'San Kamphaeng', province_id: 38},
          {id: 14, name: '‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', name_en: 'San Sai', province_id: 38},
          {id: 15, name: '‡∏´‡∏≤‡∏á‡∏î‡∏á', name_en: 'Hang Dong', province_id: 38},
          {id: 16, name: '‡∏Æ‡∏≠‡∏î', name_en: 'Hot', province_id: 38},
          {id: 17, name: '‡∏î‡∏≠‡∏¢‡πÄ‡∏ï‡πà‡∏≤', name_en: 'Doi Tao', province_id: 38},
          {id: 18, name: '‡∏≠‡∏°‡∏Å‡πã‡∏≠‡∏¢', name_en: 'Omkoi', province_id: 38},
          {id: 19, name: '‡∏™‡∏≤‡∏£‡∏†‡∏µ', name_en: 'Saraphi', province_id: 38},
          {id: 20, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡πÅ‡∏´‡∏á', name_en: 'Wiang Haeng', province_id: 38},
          {id: 21, name: '‡πÑ‡∏ä‡∏¢‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', name_en: 'Chai Prakan', province_id: 38},
          {id: 22, name: '‡πÅ‡∏°‡πà‡∏ß‡∏≤‡∏á', name_en: 'Mae Wang', province_id: 38},
          {id: 23, name: '‡πÅ‡∏°‡πà‡∏≠‡∏≠‡∏ô', name_en: 'Mae On', province_id: 38},
          {id: 24, name: '‡∏î‡∏≠‡∏¢‡∏´‡∏•‡πà‡∏≠', name_en: 'Doi Lo', province_id: 38},
          {id: 25, name: '‡∏Å‡∏±‡∏•‡∏¢‡∏≤‡∏ì‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡∏≤', name_en: 'Galyani Vadhana', province_id: 38}
        ],
        11: [ // ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ - All 11 Official Districts - Verified 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Chonburi', province_id: 11},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏∂‡∏á', name_en: 'Ban Bueng', province_id: 11},
          {id: 3, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà', name_en: 'Nong Yai', province_id: 11},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á', name_en: 'Bang Lamung', province_id: 11},
          {id: 5, name: '‡∏û‡∏≤‡∏ô‡∏ó‡∏≠‡∏á', name_en: 'Phan Thong', province_id: 11},
          {id: 6, name: '‡∏û‡∏ô‡∏±‡∏™‡∏ô‡∏¥‡∏Ñ‡∏°', name_en: 'Phanat Nikhom', province_id: 11},
          {id: 7, name: '‡∏®‡∏£‡∏µ‡∏£‡∏≤‡∏ä‡∏≤', name_en: 'Si Racha', province_id: 11},
          {id: 8, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏µ‡∏ä‡∏±‡∏á', name_en: 'Ko Sichang', province_id: 11},
          {id: 9, name: '‡∏™‡∏±‡∏ï‡∏ï‡∏≤‡∏´‡∏µ‡∏ö', name_en: 'Sattahip', province_id: 11},
          {id: 10, name: '‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á', name_en: 'Bo Thong', province_id: 11},
          {id: 11, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', name_en: 'Ko Chan', province_id: 11}
        ],
        66: [ // ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï - All 3 Official Districts - Verified 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', name_en: 'Mueang Phuket', province_id: 66},
          {id: 2, name: '‡∏Å‡∏∞‡∏ó‡∏π‡πâ', name_en: 'Kathu', province_id: 66},
          {id: 3, name: '‡∏ñ‡∏•‡∏≤‡∏á', name_en: 'Thalang', province_id: 66}
        ],
        64: [ // ‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà - All 8 Official Districts - Verified 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', name_en: 'Mueang Krabi', province_id: 64},
          {id: 2, name: '‡πÄ‡∏Ç‡∏≤‡∏û‡∏ô‡∏°', name_en: 'Khao Phanom', province_id: 64},
          {id: 3, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏•‡∏±‡∏ô‡∏ï‡∏≤', name_en: 'Ko Lanta', province_id: 64},
          {id: 4, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏ó‡πà‡∏≠‡∏°', name_en: 'Khlong Thom', province_id: 64},
          {id: 5, name: '‡∏≠‡πà‡∏≤‡∏ß‡∏•‡∏∂‡∏Å', name_en: 'Ao Luek', province_id: 64},
          {id: 6, name: '‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏¢‡∏≤', name_en: 'Plai Phraya', province_id: 64},
          {id: 7, name: '‡∏•‡∏≥‡∏ó‡∏±‡∏ö', name_en: 'Lam Thap', province_id: 64},
          {id: 8, name: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏•‡∏≠‡∏á', name_en: 'Nuea Khlong', province_id: 64}
        ],
        70: [ // ‡∏™‡∏á‡∏Ç‡∏•‡∏≤ - All 16 Official Districts
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏á‡∏Ç‡∏•‡∏≤', name_en: 'Mueang Songkhla', province_id: 70},
          {id: 2, name: '‡∏™‡∏ó‡∏¥‡∏á‡∏û‡∏£‡∏∞', name_en: 'Sathing Phra', province_id: 70},
          {id: 3, name: '‡∏à‡∏∞‡∏ô‡∏∞', name_en: 'Chana', province_id: 70},
          {id: 4, name: '‡∏ô‡∏≤‡∏ó‡∏ß‡∏µ', name_en: 'Na Thawi', province_id: 70},
          {id: 5, name: '‡πÄ‡∏ó‡∏û‡∏≤', name_en: 'Thepha', province_id: 70},
          {id: 6, name: '‡∏™‡∏∞‡∏ö‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏¢', name_en: 'Saba Yoi', province_id: 70},
          {id: 7, name: '‡∏£‡∏∞‡πÇ‡∏ô‡∏î', name_en: 'Ranot', province_id: 70},
          {id: 8, name: '‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', name_en: 'Krasae Sin', province_id: 70},
          {id: 9, name: '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', name_en: 'Hat Yai', province_id: 70},
          {id: 10, name: '‡∏£‡∏±‡∏ï‡∏†‡∏π‡∏°‡∏¥', name_en: 'Rattaphum', province_id: 70},
          {id: 11, name: '‡∏™‡∏∞‡πÄ‡∏î‡∏≤', name_en: 'Sadao', province_id: 70},
          {id: 12, name: '‡∏ô‡∏≤‡∏´‡∏°‡πà‡∏≠‡∏°', name_en: 'Na Mom', province_id: 70},
          {id: 13, name: '‡∏Ñ‡∏ß‡∏ô‡πÄ‡∏ô‡∏µ‡∏¢‡∏á', name_en: 'Khuan Niang', province_id: 70},
          {id: 14, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≥', name_en: 'Bang Klam', province_id: 70},
          {id: 15, name: '‡∏™‡∏¥‡∏á‡∏´‡∏ô‡∏Ñ‡∏£', name_en: 'Singhanakhon', province_id: 70},
          {id: 16, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≠‡∏¢‡πÇ‡∏Ç‡πà‡∏á', name_en: 'Khlong Hoi Khong', province_id: 70}
        ],
        67: [ // ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ - All 19 Official Districts - Major Tourism Hub 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Surat Thani', province_id: 67},
          {id: 2, name: '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏î‡∏¥‡∏©‡∏ê‡πå', name_en: 'Kanchanadit', province_id: 67},
          {id: 3, name: '‡∏î‡∏≠‡∏ô‡∏™‡∏±‡∏Å', name_en: 'Don Sak', province_id: 67},
          {id: 4, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢', name_en: 'Ko Samui', province_id: 67},
          {id: 5, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏û‡∏∞‡∏á‡∏±‡∏ô', name_en: 'Ko Pha-ngan', province_id: 67},
          {id: 6, name: '‡πÑ‡∏ä‡∏¢‡∏≤', name_en: 'Chaiya', province_id: 67},
          {id: 7, name: '‡∏ó‡πà‡∏≤‡∏â‡∏≤‡∏á', name_en: 'Tha Chang', province_id: 67},
          {id: 8, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≤‡∏Ç‡∏∏‡∏ô', name_en: 'Ban Ta Khun', province_id: 67},
          {id: 9, name: '‡∏û‡∏ô‡∏°', name_en: 'Phanom', province_id: 67},
          {id: 10, name: '‡∏ó‡πà‡∏≤‡∏ä‡∏ô‡∏∞', name_en: 'Tha Chana', province_id: 67},
          {id: 11, name: '‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏ô‡∏ã‡∏≤', name_en: 'Khian Sa', province_id: 67},
          {id: 12, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡πÄ‡∏î‡∏¥‡∏°', name_en: 'Ban Na Doem', province_id: 67},
          {id: 13, name: '‡∏ß‡∏¥‡∏†‡∏≤‡∏ß‡∏î‡∏µ', name_en: 'Wiphawadi', province_id: 67},
          {id: 14, name: '‡∏û‡∏∏‡∏ô‡∏û‡∏¥‡∏ô', name_en: 'Phunphin', province_id: 67},
          {id: 15, name: '‡∏ä‡∏±‡∏¢‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chai Buri', province_id: 67},
          {id: 16, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏™‡∏≤‡∏£', name_en: 'Ban Na San', province_id: 67},
          {id: 17, name: '‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏±‡∏¢‡∏ä‡∏≤‡∏ç', name_en: 'Wiang Sa', province_id: 67},
          {id: 18, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏ï‡πà‡∏≤', name_en: 'Ko Tao', province_id: 67},
          {id: 19, name: '‡∏ó‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà', name_en: 'Tha Mai', province_id: 67}
        ],
        28: [ // ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô - All 26 Official Districts - Major Northeast Economic Center 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Mueang Khon Kaen', province_id: 28},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà', name_en: 'Ban Phai', province_id: 28},
          {id: 3, name: '‡∏û‡∏•', name_en: 'Phon', province_id: 28},
          {id: 4, name: '‡∏ä‡∏∏‡∏°‡πÅ‡∏û', name_en: 'Chum Phae', province_id: 28},
          {id: 5, name: '‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π', name_en: 'Si Chomphu', province_id: 28},
          {id: 6, name: '‡∏ô‡πâ‡∏≥‡∏û‡∏≠‡∏á', name_en: 'Nam Phong', province_id: 28},
          {id: 7, name: '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏±‡∏ï‡∏ô‡πå', name_en: 'Ubolratana', province_id: 28},
          {id: 8, name: '‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤', name_en: 'Non Sila', province_id: 28},
          {id: 9, name: '‡∏Å‡∏£‡∏∞‡∏ô‡∏ß‡∏ô', name_en: 'Kranuan', province_id: 28},
          {id: 10, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ù‡∏≤‡∏á', name_en: 'Ban Fang', province_id: 28},
          {id: 11, name: '‡πÄ‡∏õ‡∏∑‡∏≠‡∏¢‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Pueai Noi', province_id: 28},
          {id: 12, name: '‡∏û‡∏£‡∏∞‡∏¢‡∏∑‡∏ô', name_en: 'Phra Yuen', province_id: 28},
          {id: 13, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡∏≠', name_en: 'Nong Ruea', province_id: 28},
          {id: 14, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤', name_en: 'Ban Lao', province_id: 28},
          {id: 15, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡πÄ‡∏Å‡πà‡∏≤', name_en: 'Wiang Kao', province_id: 28},
          {id: 16, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏¢‡∏≤‡∏á', name_en: 'Wiang Yang', province_id: 28},
          {id: 17, name: '‡πÅ‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà', name_en: 'Waeng Yai', province_id: 28},
          {id: 18, name: '‡πÅ‡∏ß‡∏á‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Waeng Noi', province_id: 28},
          {id: 19, name: '‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Si Mueng Mai', province_id: 28},
          {id: 20, name: '‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô', name_en: 'Phu Pha Man', province_id: 28},
          {id: 21, name: '‡πÄ‡∏Å‡πá‡∏á‡∏Ñ‡∏≠‡∏¢', name_en: 'Keng Khoi', province_id: 28},
          {id: 22, name: '‡∏†‡∏π‡∏ß‡∏¥‡πÄ‡∏®‡∏©', name_en: 'Phu Wiang', province_id: 28},
          {id: 23, name: '‡πÅ‡∏ã‡πà‡∏°', name_en: 'Sam Sung', province_id: 28},
          {id: 24, name: '‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡∏ä‡∏±‡∏¢', name_en: 'Khok Pho Chai', province_id: 28},
          {id: 25, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥', name_en: 'Nong Na Kham', province_id: 28},
          {id: 26, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ß‡πâ‡∏≤', name_en: 'Ban Khwao', province_id: 28}
        ],
        19: [ // ‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤ - All 32 Official Districts - Largest Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', name_en: 'Mueang Nakhon Ratchasima', province_id: 19},
          {id: 2, name: '‡∏Ñ‡∏£‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Khon Buri', province_id: 19},
          {id: 3, name: '‡∏Ñ‡∏á', name_en: 'Khong', province_id: 19},
          {id: 4, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏°', name_en: 'Ban Lueam', province_id: 19},
          {id: 5, name: '‡∏à‡∏±‡∏Å‡∏£‡∏≤‡∏ä', name_en: 'Chakkarat', province_id: 19},
          {id: 6, name: '‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏±‡∏¢', name_en: 'Chok Chai', province_id: 19},
          {id: 7, name: '‡∏î‡πà‡∏≤‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ó‡∏î', name_en: 'Dan Khun Thot', province_id: 19},
          {id: 8, name: '‡πÇ‡∏ô‡∏ô‡πÑ‡∏ó‡∏¢', name_en: 'Non Thai', province_id: 19},
          {id: 9, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏π‡∏á', name_en: 'Non Sung', province_id: 19},
          {id: 10, name: '‡∏Ç‡∏≤‡∏°‡∏™‡∏∞‡πÅ‡∏Å‡πÅ‡∏™‡∏á', name_en: 'Kham Sakae Saeng', province_id: 19},
          {id: 11, name: '‡∏Ç‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏≠', name_en: 'Kham Thale So', province_id: 19},
          {id: 12, name: '‡∏™‡∏µ‡∏Ñ‡∏¥‡πâ‡∏ß', name_en: 'Sikhiu', province_id: 19},
          {id: 13, name: '‡∏õ‡∏±‡∏Å‡∏ò‡∏á‡∏ä‡∏±‡∏¢', name_en: 'Pak Thong Chai', province_id: 19},
          {id: 14, name: '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', name_en: 'Wang Nam Khiao', province_id: 19},
          {id: 15, name: '‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå', name_en: 'Thepharak', province_id: 19},
          {id: 16, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏¢‡∏≤‡∏á', name_en: 'Mueang Yang', province_id: 19},
          {id: 17, name: '‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏¢', name_en: 'Prathai', province_id: 19},
          {id: 18, name: '‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á', name_en: 'Pak Chong', province_id: 19},
          {id: 19, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏∏‡∏ç‡∏°‡∏≤‡∏Å', name_en: 'Nong Bunmak', province_id: 19},
          {id: 20, name: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏¢', name_en: 'Kham Toei', province_id: 19},
          {id: 21, name: '‡∏ö‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà', name_en: 'Bua Yai', province_id: 19},
          {id: 22, name: '‡∏™‡∏π‡∏á‡πÄ‡∏ô‡∏¥‡∏ô', name_en: 'Sung Noen', province_id: 19},
          {id: 23, name: '‡πÄ‡∏™‡∏¥‡∏á‡∏™‡∏≤‡∏á', name_en: 'Soeng Sang', province_id: 19},
          {id: 24, name: '‡∏•‡∏≥‡∏ó‡∏∞‡πÄ‡∏°‡∏ô‡∏ä‡∏±‡∏¢', name_en: 'Lam Thamenchai', province_id: 19},
          {id: 25, name: '‡∏ö‡∏±‡∏ß‡∏•‡∏≤‡∏¢', name_en: 'Bua Lai', province_id: 19},
          {id: 26, name: '‡πÇ‡∏ô‡∏ô‡πÅ‡∏î‡∏á', name_en: 'Non Daeng', province_id: 19},
          {id: 27, name: '‡∏û‡∏¥‡∏°‡∏≤‡∏¢', name_en: 'Phimai', province_id: 19},
          {id: 28, name: '‡∏´‡πâ‡∏ß‡∏¢‡πÅ‡∏ñ‡∏•‡∏á', name_en: 'Huai Thalaeng', province_id: 19},
          {id: 29, name: '‡∏ä‡∏∏‡∏°‡∏û‡∏•‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chum Phuang', province_id: 19},
          {id: 30, name: '‡πÅ‡∏Å‡πâ‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ô‡∏≤‡∏á', name_en: 'Kaeng Sanam Nang', province_id: 19},
          {id: 31, name: '‡πÇ‡∏ô‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', name_en: 'Non Din Daeng', province_id: 19},
          {id: 32, name: '‡∏ö‡∏∂‡∏á‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ', name_en: 'Bueng Samakkhi', province_id: 19}
        ],
        29: [ // ‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ - All 20 Official Districts - Major Northeast Hub 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Udon Thani', province_id: 29},
          {id: 2, name: '‡∏Å‡∏∏‡∏°‡∏†‡∏ß‡∏≤‡∏õ‡∏µ', name_en: 'Kumphawapi', province_id: 29},
          {id: 3, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î', name_en: 'Non Sa-at', province_id: 29},
          {id: 4, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ß‡∏±‡∏ß‡∏ã‡∏≠', name_en: 'Nong Wua So', province_id: 29},
          {id: 5, name: '‡∏Å‡∏∏‡∏î‡∏à‡∏±‡∏ö', name_en: 'Kut Chap', province_id: 29},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏∑‡∏≠', name_en: 'Ban Phue', province_id: 29},
          {id: 7, name: '‡πÄ‡∏û‡πá‡∏ç', name_en: 'Phen', province_id: 29},
          {id: 8, name: '‡∏®‡∏£‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏', name_en: 'Si That', province_id: 29},
          {id: 9, name: '‡∏ô‡πâ‡∏≥‡πÇ‡∏™‡∏°', name_en: 'Nam Som', province_id: 29},
          {id: 10, name: '‡πÑ‡∏ä‡∏¢‡∏ß‡∏≤‡∏ô', name_en: 'Chai Wan', province_id: 29},
          {id: 11, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≤‡∏ô', name_en: 'Nong Han', province_id: 29},
          {id: 12, name: '‡∏ó‡∏∏‡πà‡∏á‡∏ù‡∏ô', name_en: 'Thung Fon', province_id: 29},
          {id: 13, name: '‡∏ß‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏´‡∏°‡∏≠', name_en: 'Wang Sam Mo', province_id: 29},
          {id: 14, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏∏‡∏á', name_en: 'Ban Dung', province_id: 29},
          {id: 15, name: '‡∏õ‡πà‡∏≤‡∏ï‡∏¥‡πâ‡∏ß', name_en: 'Pa Tio', province_id: 29},
          {id: 16, name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°', name_en: 'Sang Khom', province_id: 29},
          {id: 17, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡∏•‡∏≠‡∏á', name_en: 'Nong Saeng', province_id: 29},
          {id: 18, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡πà‡∏ß‡∏á', name_en: 'Ban Muang', province_id: 29},
          {id: 19, name: '‡∏ô‡∏≤‡πÉ‡∏´‡∏ç‡πà', name_en: 'Na Yung', province_id: 29},
          {id: 20, name: '‡πÇ‡∏ã‡πà‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'So Phisai', province_id: 29}
        ],
        12: [ // ‡∏£‡∏∞‡∏¢‡∏≠‡∏á - All 8 Official Districts - Eastern Seaboard Industrial Hub 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏∞‡∏¢‡∏≠‡∏á', name_en: 'Mueang Rayong', province_id: 12},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏â‡∏≤‡∏á', name_en: 'Ban Chang', province_id: 12},
          {id: 3, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏â‡∏≤‡∏á', name_en: 'Ko Chang', province_id: 12},
          {id: 4, name: '‡∏ß‡∏±‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', name_en: 'Wang Chan', province_id: 12},
          {id: 5, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏≤‡∏¢', name_en: 'Ban Khai', province_id: 12},
          {id: 6, name: '‡∏õ‡∏•‡∏ß‡∏Å‡πÅ‡∏î‡∏á', name_en: 'Pluak Daeng', province_id: 12},
          {id: 7, name: '‡πÄ‡∏Ç‡∏≤‡∏ä‡∏∞‡πÄ‡∏°‡∏≤', name_en: 'Khao Chamao', province_id: 12},
          {id: 8, name: '‡∏ô‡∏¥‡∏Ñ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤', name_en: 'Nikhom Phatthana', province_id: 12}
        ],
        58: [ // ‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏° - All 7 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', name_en: 'Mueang Nakhon Pathom', province_id: 58},
          {id: 2, name: '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÅ‡∏™‡∏ô', name_en: 'Kamphaeng Saen', province_id: 58},
          {id: 3, name: '‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢‡∏®‡∏£‡∏µ', name_en: 'Nakhon Chai Si', province_id: 58},
          {id: 4, name: '‡∏î‡∏≠‡∏ô‡∏ï‡∏π‡∏°', name_en: 'Don Tum', province_id: 58},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡πÄ‡∏•‡∏ô', name_en: 'Bang Len', province_id: 58},
          {id: 6, name: '‡∏™‡∏≤‡∏°‡∏û‡∏£‡∏≤‡∏ô', name_en: 'Sam Phran', province_id: 58},
          {id: 7, name: '‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•', name_en: 'Phutthamonthon', province_id: 58}
        ],
        2: [ // ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ - All 6 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', name_en: 'Mueang Samut Prakan', province_id: 2},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏ö‡πà‡∏≠', name_en: 'Bang Bo', province_id: 2},
          {id: 3, name: '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ', name_en: 'Bang Phli', province_id: 2},
          {id: 4, name: '‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á', name_en: 'Phra Pradaeng', province_id: 2},
          {id: 5, name: '‡∏û‡∏£‡∏∞‡∏™‡∏°‡∏∏‡∏ó‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå', name_en: 'Phra Samut Chedi', province_id: 2},
          {id: 6, name: '‡∏ö‡∏≤‡∏á‡πÄ‡∏™‡∏≤‡∏ò‡∏á', name_en: 'Bang Sao Thong', province_id: 2}
        ],
        3: [ // ‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ - All 6 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Nonthaburi', province_id: 3},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ß‡∏¢', name_en: 'Bang Kruai', province_id: 3},
          {id: 3, name: '‡∏ö‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà', name_en: 'Bang Yai', province_id: 3},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á', name_en: 'Bang Bua Thong', province_id: 3},
          {id: 5, name: '‡πÑ‡∏ú‡πà', name_en: 'Pai', province_id: 3},
          {id: 6, name: '‡∏õ‡∏≤‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î', name_en: 'Pak Kret', province_id: 3}
        ],
        4: [ // ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ - All 7 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Pathum Thani', province_id: 4},
          {id: 2, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á', name_en: 'Khlong Luang', province_id: 4},
          {id: 3, name: '‡∏ò‡∏±‡∏ç‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Thanyaburi', province_id: 4},
          {id: 4, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡∏≠', name_en: 'Nong Suea', province_id: 4},
          {id: 5, name: '‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏∏‡∏°‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Lat Lum Kaeo', province_id: 4},
          {id: 6, name: '‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤', name_en: 'Lam Luk Ka', province_id: 4},
          {id: 7, name: '‡∏™‡∏≤‡∏°‡πÇ‡∏Ñ‡∏Å', name_en: 'Sam Khok', province_id: 4}
        ],
        20: [ // ‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå - All 23 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', name_en: 'Mueang Buriram', province_id: 20},
          {id: 2, name: '‡∏Å‡∏£‡∏∞‡∏™‡∏±‡∏á', name_en: 'Krasang', province_id: 20},
          {id: 3, name: '‡∏Ñ‡∏π‡πÄ‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Khu Mueang', province_id: 20},
          {id: 4, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡∏ß‡∏î', name_en: 'Ban Kruat', province_id: 20},
          {id: 5, name: '‡∏õ‡∏£‡∏∞‡πÇ‡∏Ñ‡∏ô‡∏ä‡∏±‡∏¢', name_en: 'Prakhon Chai', province_id: 20},
          {id: 6, name: '‡∏õ‡∏∞‡∏Ñ‡∏≥', name_en: 'Pakham', province_id: 20},
          {id: 7, name: '‡∏ô‡∏≤‡∏á‡∏£‡∏≠‡∏á', name_en: 'Nang Rong', province_id: 20},
          {id: 8, name: '‡πÇ‡∏ô‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', name_en: 'Non Din Daeng', province_id: 20},
          {id: 9, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ä‡∏¢‡∏û‡∏à‡∏ô‡πå', name_en: 'Ban Mai Chaiyaphot', province_id: 20},
          {id: 10, name: '‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Na Pho', province_id: 20},
          {id: 11, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì', name_en: 'Non Suwan', province_id: 20},
          {id: 12, name: '‡∏ä‡∏≥‡∏ô‡∏¥', name_en: 'Chamni', province_id: 20},
          {id: 13, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô', name_en: 'Ban Dan', province_id: 20},
          {id: 14, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏ä', name_en: 'Huai Rat', province_id: 20},
          {id: 15, name: '‡∏•‡∏∞‡∏´‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', name_en: 'Lahan Sai', province_id: 20},
          {id: 16, name: '‡∏™‡∏ï‡∏∂‡∏Å', name_en: 'Satuek', province_id: 20},
          {id: 17, name: '‡πÇ‡∏Ñ‡∏Å‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Khok Charoen', province_id: 20},
          {id: 18, name: '‡∏û‡∏•‡∏±‡∏ö‡∏û‡∏•‡∏≤‡∏ä‡∏±‡∏¢', name_en: 'Phlapphla Chai', province_id: 20},
          {id: 19, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏á‡∏™‡πå', name_en: 'Nong Hong', province_id: 20},
          {id: 20, name: '‡πÅ‡∏Ñ‡∏ô‡∏î‡∏á', name_en: 'Kaen Dong', province_id: 20},
          {id: 21, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô', name_en: 'Ban Dan', province_id: 20},
          {id: 22, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì', name_en: 'Non Suwan', province_id: 20},
          {id: 23, name: '‡∏ä‡∏≥‡∏ô‡∏¥', name_en: 'Chamni', province_id: 20}
        ],
        23: [ // ‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ - All 25 Official Districts - Major Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Ubon Ratchathani', province_id: 23},
          {id: 2, name: '‡∏®‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Si Mueang Mai', province_id: 23},
          {id: 3, name: '‡πÇ‡∏Ç‡∏á‡πÄ‡∏à‡∏µ‡∏¢‡∏°', name_en: 'Khong Chiam', province_id: 23},
          {id: 4, name: '‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô', name_en: 'Khueng Nai', province_id: 23},
          {id: 5, name: '‡πÄ‡∏Ç‡∏°‡∏£‡∏≤‡∏ê', name_en: 'Khemarat', province_id: 23},
          {id: 6, name: '‡πÄ‡∏î‡∏ä‡∏≠‡∏∏‡∏î‡∏°', name_en: 'Det Udom', province_id: 23},
          {id: 7, name: '‡∏ô‡∏≤‡∏à‡∏∞‡∏´‡∏•‡∏ß‡∏¢', name_en: 'Na Chaluai', province_id: 23},
          {id: 8, name: '‡∏ô‡πâ‡∏≥‡∏¢‡∏∑‡∏ô', name_en: 'Nam Yuen', province_id: 23},
          {id: 9, name: '‡∏ö‡∏∏‡∏ì‡∏ë‡∏£‡∏¥‡∏Å', name_en: 'Buntharik', province_id: 23},
          {id: 10, name: '‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡∏ä‡∏ú‡∏•', name_en: 'Trakan Phuet Phon', province_id: 23},
          {id: 11, name: '‡∏Å‡∏∏‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏∏‡πâ‡∏ô', name_en: 'Kut Khaopun', province_id: 23},
          {id: 12, name: '‡∏°‡πà‡∏ß‡∏á‡∏™‡∏≤‡∏°‡∏™‡∏¥‡∏ö', name_en: 'Muang Sam Sip', province_id: 23},
          {id: 13, name: '‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏ä‡∏≥‡∏£‡∏≤‡∏ö', name_en: 'Warin Chamrap', province_id: 23},
          {id: 14, name: '‡∏û‡∏¥‡∏ö‡∏π‡∏•‡∏°‡∏±‡∏á‡∏™‡∏≤‡∏´‡∏≤‡∏£', name_en: 'Phibun Mangsahan', province_id: 23},
          {id: 15, name: '‡∏ï‡∏≤‡∏•‡∏™‡∏∏‡∏°', name_en: 'Tan Sum', province_id: 23},
          {id: 16, name: '‡πÇ‡∏û‡∏ò‡∏¥‡πå‡πÑ‡∏ó‡∏£', name_en: 'Pho Sai', province_id: 23},
          {id: 17, name: '‡∏™‡∏≥‡πÇ‡∏£‡∏á', name_en: 'Samrong', province_id: 23},
          {id: 18, name: '‡∏î‡∏≠‡∏ô‡∏°‡∏î‡πÅ‡∏î‡∏á', name_en: 'Don Mot Daeng', province_id: 23},
          {id: 19, name: '‡∏™‡∏¥‡∏£‡∏¥‡∏ô‡∏ò‡∏£', name_en: 'Sirindhorn', province_id: 23},
          {id: 20, name: '‡∏ó‡∏∏‡πà‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏∏‡∏î‡∏°', name_en: 'Thung Si Udom', province_id: 23},
          {id: 21, name: '‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏µ‡∏£‡∏∞‡∏ß‡∏á‡∏®‡πå', name_en: 'Sawang Wirawong', province_id: 23},
          {id: 22, name: '‡∏ô‡∏≤‡∏ï‡∏≤‡∏•', name_en: 'Na Tan', province_id: 23},
          {id: 23, name: '‡πÄ‡∏´‡∏•‡πà‡∏≤‡πÄ‡∏™‡∏∑‡∏≠‡πÇ‡∏Å‡πâ‡∏Å', name_en: 'Lao Suea Kok', province_id: 23},
          {id: 24, name: '‡∏™‡∏≥‡πÇ‡∏£‡∏á‡∏ó‡∏≤‡∏ö', name_en: 'Samrong Thap', province_id: 23},
          {id: 25, name: '‡∏ô‡πâ‡∏≥‡∏Ç‡∏∏‡πà‡∏ô', name_en: 'Nam Khun', province_id: 23}
        ],
        45: [ // ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢ - All 18 Official Districts - Northern Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', name_en: 'Mueang Chiang Rai', province_id: 45},
          {id: 2, name: '‡∏ß‡∏≤‡πÄ‡∏ä‡∏µ‡∏¢‡∏á', name_en: 'Wiang Chai', province_id: 45},
          {id: 3, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á', name_en: 'Chiang Khong', province_id: 45},
          {id: 4, name: '‡πÄ‡∏ó‡∏¥‡∏á', name_en: 'Thoeng', province_id: 45},
          {id: 5, name: '‡∏û‡∏≤‡∏ô', name_en: 'Phan', province_id: 45},
          {id: 6, name: '‡∏õ‡πà‡∏≤‡πÅ‡∏î‡∏î', name_en: 'Pa Daet', province_id: 45},
          {id: 7, name: '‡πÅ‡∏°‡πà‡∏à‡∏±‡∏ô', name_en: 'Mae Chan', province_id: 45},
          {id: 8, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÅ‡∏™‡∏ô', name_en: 'Chiang Saen', province_id: 45},
          {id: 9, name: '‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏¢', name_en: 'Mae Sai', province_id: 45},
          {id: 10, name: '‡πÅ‡∏°‡πà‡∏™‡∏£‡∏ß‡∏¢', name_en: 'Mae Suai', province_id: 45},
          {id: 11, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡∏¢', name_en: 'Wiang Chai', province_id: 45},
          {id: 12, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏´‡∏•‡∏á', name_en: 'Wiang Kalong', province_id: 45},
          {id: 13, name: '‡∏Ç‡∏∏‡∏ô‡∏ï‡∏≤‡∏•', name_en: 'Khun Tan', province_id: 45},
          {id: 14, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏õ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤', name_en: 'Wiang Pa Pao', province_id: 45},
          {id: 15, name: '‡∏û‡∏ç‡∏≤‡πÄ‡∏°‡πá‡∏á‡∏£‡∏≤‡∏¢', name_en: 'Phaya Mengrai', province_id: 45},
          {id: 16, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡∏¢', name_en: 'Wiang Chai', province_id: 45},
          {id: 17, name: '‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ß', name_en: 'Mae Lao', province_id: 45},
          {id: 18, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏∏‡πâ‡∏á', name_en: 'Wiang Chiang Rung', province_id: 45}
        ],
        63: [ // ‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä - All 23 Official Districts - Major Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', name_en: 'Mueang Nakhon Si Thammarat', province_id: 63},
          {id: 2, name: '‡∏û‡∏£‡∏´‡∏°‡∏Ñ‡∏µ‡∏£‡∏µ', name_en: 'Phrom Khiri', province_id: 63},
          {id: 3, name: '‡∏•‡∏≤‡∏ô‡∏™‡∏Å‡∏≤', name_en: 'Lan Saka', province_id: 63},
          {id: 4, name: '‡∏â‡∏ß‡∏≤‡∏á', name_en: 'Chawang', province_id: 63},
          {id: 5, name: '‡∏û‡∏¥‡∏õ‡∏π‡∏ô', name_en: 'Phipun', province_id: 63},
          {id: 6, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πÉ‡∏´‡∏ç‡πà', name_en: 'Chian Yai', province_id: 63},
          {id: 7, name: '‡∏ä‡∏∞‡∏≠‡∏ß‡∏î', name_en: 'Cha-uat', province_id: 63},
          {id: 8, name: '‡∏ó‡πà‡∏≤‡∏®‡∏≤‡∏•‡∏≤', name_en: 'Tha Sala', province_id: 63},
          {id: 9, name: '‡∏ó‡∏∏‡πà‡∏á‡∏™‡∏á', name_en: 'Thung Song', province_id: 63},
          {id: 10, name: '‡∏ô‡∏≤‡∏ö‡∏≠‡∏ô', name_en: 'Na Bon', province_id: 63},
          {id: 11, name: '‡∏ó‡∏∏‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà', name_en: 'Thung Yai', province_id: 63},
          {id: 12, name: '‡∏õ‡∏≤‡∏Å‡∏û‡∏ô‡∏±‡∏á', name_en: 'Pak Phanang', province_id: 63},
          {id: 13, name: '‡∏£‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏ö‡∏π‡∏•‡∏¢‡πå', name_en: 'Ron Phibun', province_id: 63},
          {id: 14, name: '‡∏™‡∏¥‡∏ä‡∏•', name_en: 'Sichon', province_id: 63},
          {id: 15, name: '‡∏Ç‡∏ô‡∏≠‡∏°', name_en: 'Khanom', province_id: 63},
          {id: 16, name: '‡∏´‡∏±‡∏ß‡πÑ‡∏ó‡∏£', name_en: 'Hua Sai', province_id: 63},
          {id: 17, name: '‡∏ö‡∏≤‡∏á‡∏Ç‡∏±‡∏ô', name_en: 'Bang Khan', province_id: 63},
          {id: 18, name: '‡∏ñ‡πâ‡∏≥‡∏û‡∏£‡∏£‡∏ì‡∏£‡∏≤', name_en: 'Tham Phannara', province_id: 63},
          {id: 19, name: '‡∏à‡∏∏‡∏¨‡∏≤‡∏†‡∏£‡∏ì‡πå', name_en: 'Chulabhorn', province_id: 63},
          {id: 20, name: '‡∏û‡∏£‡∏∞‡∏û‡∏£‡∏´‡∏°', name_en: 'Phra Phrom', province_id: 63},
          {id: 21, name: '‡∏ô‡∏ö‡∏û‡∏¥‡∏ï‡∏≥', name_en: 'Nop Phi Tam', province_id: 63},
          {id: 22, name: '‡∏ä‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á', name_en: 'Chang Klang', province_id: 63},
          {id: 23, name: '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', name_en: 'Chaloem Phra Kiat', province_id: 63}
        ],
        5: [ // ‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ - All 16 Official Districts - Historical Capital 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', name_en: 'Mueang Phra Nakhon Si Ayutthaya', province_id: 5},
          {id: 2, name: '‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠', name_en: 'Tha Ruea', province_id: 5},
          {id: 3, name: '‡∏ô‡∏Ñ‡∏£‡∏´‡∏•‡∏ß‡∏á', name_en: 'Nakhon Luang', province_id: 5},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡πÑ‡∏ó‡∏£', name_en: 'Bang Sai', province_id: 5},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏•', name_en: 'Bang Ban', province_id: 5},
          {id: 6, name: '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏≠‡∏¥‡∏ô', name_en: 'Bang Pa-in', province_id: 5},
          {id: 7, name: '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏´‡∏±‡∏ô', name_en: 'Bang Pahan', province_id: 5},
          {id: 8, name: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', name_en: 'Phra Nakhon Si Ayutthaya', province_id: 5},
          {id: 9, name: '‡∏•‡∏≤‡∏î‡∏ö‡∏±‡∏ß‡∏´‡∏•‡∏ß‡∏á', name_en: 'Lat Bua Luang', province_id: 5},
          {id: 10, name: '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Wang Noi', province_id: 5},
          {id: 11, name: '‡πÄ‡∏™‡∏ô‡∏≤', name_en: 'Sena', province_id: 5},
          {id: 12, name: '‡∏ö‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢', name_en: 'Bang Sai', province_id: 5},
          {id: 13, name: '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢', name_en: 'Uthai', province_id: 5},
          {id: 14, name: '‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä', name_en: 'Maha Rat', province_id: 5},
          {id: 15, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡∏£‡∏Å', name_en: 'Ban Phraek', province_id: 5},
          {id: 16, name: '‡∏†‡∏≤‡∏ä‡∏µ', name_en: 'Phachi', province_id: 5}
        ],
        6: [ // ‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á - All 7 Official Districts - Central Region 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', name_en: 'Mueang Ang Thong', province_id: 6},
          {id: 2, name: '‡πÑ‡∏ä‡πÇ‡∏¢', name_en: 'Chaiyo', province_id: 6},
          {id: 3, name: '‡∏õ‡πà‡∏≤‡πÇ‡∏°‡∏Å', name_en: 'Pa Mok', province_id: 6},
          {id: 4, name: '‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏ó‡∏≠‡∏á', name_en: 'Pho Thong', province_id: 6},
          {id: 5, name: '‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤', name_en: 'Sawaeng Ha', province_id: 6},
          {id: 6, name: '‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏±‡∏¢‡∏ä‡∏≤‡∏ç', name_en: 'Wiset Chai Chan', province_id: 6},
          {id: 7, name: '‡∏™‡∏≤‡∏°‡πÇ‡∏Å‡πâ', name_en: 'Samko', province_id: 6}
        ],
        7: [ // ‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ - All 11 Official Districts - Central Historical Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Lopburi', province_id: 7},
          {id: 2, name: '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°', name_en: 'Phatthana Nikhom', province_id: 7},
          {id: 3, name: '‡πÇ‡∏Ñ‡∏Å‡∏™‡∏≥‡πÇ‡∏£‡∏á', name_en: 'Khok Samrong', province_id: 7},
          {id: 4, name: '‡∏ä‡∏±‡∏¢‡∏ö‡∏≤‡∏î‡∏≤‡∏•', name_en: 'Chai Badan', province_id: 7},
          {id: 5, name: '‡∏ó‡πà‡∏≤‡∏ß‡∏∏‡πâ‡∏á', name_en: 'Tha Wung', province_id: 7},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏µ‡πà', name_en: 'Ban Mi', province_id: 7},
          {id: 7, name: '‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á', name_en: 'Tha Luang', province_id: 7},
          {id: 8, name: '‡∏™‡∏£‡∏∞‡πÇ‡∏ö‡∏™‡∏ñ‡πå', name_en: 'Sa Bot', province_id: 7},
          {id: 9, name: '‡πÇ‡∏Ñ‡∏Å‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Khok Charoen', province_id: 7},
          {id: 10, name: '‡∏•‡∏≥‡∏™‡∏ô‡∏ò‡∏¥', name_en: 'Lam Sonthi', province_id: 7},
          {id: 11, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á', name_en: 'Nong Muang', province_id: 7}
        ],
        8: [ // ‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ - All 6 Official Districts - Central Small Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Sing Buri', province_id: 8},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏à‡∏±‡∏ô', name_en: 'Bang Rachan', province_id: 8},
          {id: 3, name: '‡∏Ñ‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏à‡∏±‡∏ô', name_en: 'Khai Bang Rachan', province_id: 8},
          {id: 4, name: '‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'In Buri', province_id: 8},
          {id: 5, name: '‡∏û‡∏£‡∏´‡∏°‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Phrom Buri', province_id: 8},
          {id: 6, name: '‡∏ó‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏á', name_en: 'Tha Chang', province_id: 8}
        ],
        9: [ // ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó - All 8 Official Districts - Central Agricultural Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', name_en: 'Mueang Chai Nat', province_id: 9},
          {id: 2, name: '‡∏°‡πÇ‡∏ô‡∏£‡∏°‡∏¢‡πå', name_en: 'Manorom', province_id: 9},
          {id: 3, name: '‡∏ß‡∏±‡∏î‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Wat Sing', province_id: 9},
          {id: 4, name: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ß‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Sankhaburi', province_id: 9},
          {id: 5, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡∏∞‡πÇ‡∏°‡∏á', name_en: 'Nong Mamong', province_id: 9},
          {id: 6, name: '‡∏´‡∏≤‡∏î‡∏ó‡πà‡∏≤‡πÄ‡∏™‡∏≤', name_en: 'Hankha', province_id: 9},
          {id: 7, name: '‡πÄ‡∏ô‡∏¥‡∏ô‡∏Ç‡∏≤‡∏°', name_en: 'Noen Kham', province_id: 9},
          {id: 8, name: '‡∏™‡∏£‡∏£‡∏Ñ‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sapphaya', province_id: 9}
        ],
        10: [ // ‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ - All 13 Official Districts - Central Transportation Hub 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Saraburi', province_id: 10},
          {id: 2, name: '‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢', name_en: 'Kaeng Khoi', province_id: 10},
          {id: 3, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ñ', name_en: 'Nong Khae', province_id: 10},
          {id: 4, name: '‡∏ß‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏î‡∏á', name_en: 'Wihan Daeng', province_id: 10},
          {id: 5, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏ã‡∏á', name_en: 'Nong Saeng', province_id: 10},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏≠', name_en: 'Ban Mo', province_id: 10},
          {id: 7, name: '‡∏î‡∏≠‡∏ô‡∏û‡∏∏‡∏î', name_en: 'Don Phut', province_id: 10},
          {id: 8, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÇ‡∏î‡∏ô', name_en: 'Nong Don', province_id: 10},
          {id: 9, name: '‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏ö‡∏≤‡∏ó', name_en: 'Phra Phutthabat', province_id: 10},
          {id: 10, name: '‡πÄ‡∏™‡∏≤‡πÑ‡∏´‡πâ', name_en: 'Sao Hai', province_id: 10},
          {id: 11, name: '‡∏°‡∏ß‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', name_en: 'Muak Lek', province_id: 10},
          {id: 12, name: '‡∏ß‡∏±‡∏á‡∏°‡πà‡∏ß‡∏á', name_en: 'Wang Muang', province_id: 10},
          {id: 13, name: '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', name_en: 'Chaloem Phra Kiat', province_id: 10}
        ],
        13: [ // ‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ - All 10 Official Districts - Eastern Gem Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Chanthaburi', province_id: 13},
          {id: 2, name: '‡∏Ç‡∏•‡∏∏‡∏á', name_en: 'Khlung', province_id: 13},
          {id: 3, name: '‡∏ó‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà', name_en: 'Tha Mai', province_id: 13},
          {id: 4, name: '‡πÇ‡∏õ‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô', name_en: 'Pong Nam Ron', province_id: 13},
          {id: 5, name: '‡∏™‡∏≠‡∏¢‡∏î‡∏≤‡∏ß', name_en: 'Soi Dao', province_id: 13},
          {id: 6, name: '‡πÅ‡∏Å‡πà‡∏á‡∏´‡∏≤‡∏á‡πÅ‡∏°‡∏ß', name_en: 'Kaeng Hang Maeo', province_id: 13},
          {id: 7, name: '‡∏ô‡∏≤‡∏¢‡∏≤‡∏¢‡∏≠‡∏≤‡∏°', name_en: 'Na Yai Am', province_id: 13},
          {id: 8, name: '‡πÅ‡∏´‡∏•‡∏°‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Laem Sing', province_id: 13},
          {id: 9, name: '‡∏°‡∏∞‡∏Ç‡∏≤‡∏°', name_en: 'Makham', province_id: 13},
          {id: 10, name: '‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏¥‡∏ä‡∏å‡∏Å‡∏π‡∏è', name_en: 'Khao Khitchakut', province_id: 13}
        ],
        14: [ // ‡∏ï‡∏£‡∏≤‡∏î - All 7 Official Districts - Eastern Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏≤‡∏î', name_en: 'Mueang Trat', province_id: 14},
          {id: 2, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà', name_en: 'Khlong Yai', province_id: 14},
          {id: 3, name: '‡πÄ‡∏Ç‡∏≤‡∏™‡∏°‡∏¥‡∏á', name_en: 'Khao Saming', province_id: 14},
          {id: 4, name: '‡∏ö‡πà‡∏≠‡πÑ‡∏£‡πà', name_en: 'Bo Rai', province_id: 14},
          {id: 5, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏π‡∏î', name_en: 'Ko Kut', province_id: 14},
          {id: 6, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏ä‡πâ‡∏≤‡∏á', name_en: 'Ko Chang', province_id: 14},
          {id: 7, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏á', name_en: 'Ko Kong', province_id: 14}
        ],
        15: [ // ‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤ - All 11 Official Districts - Eastern Agricultural Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', name_en: 'Mueang Chachoengsao', province_id: 15},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏•‡πâ‡∏≤', name_en: 'Bang Khla', province_id: 15},
          {id: 3, name: '‡∏ö‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏£‡∏µ‡πâ‡∏¢‡∏ß', name_en: 'Bang Nam Priao', province_id: 15},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏õ‡∏∞‡∏Å‡∏á', name_en: 'Bang Pakong', province_id: 15},
          {id: 5, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Ban Pho', province_id: 15},
          {id: 6, name: '‡∏õ‡∏•‡∏≤‡∏õ‡∏≤‡∏Å', name_en: 'Pla Pak', province_id: 15},
          {id: 7, name: '‡∏£‡∏≤‡∏ä‡∏™‡∏≤‡∏™‡∏ô‡πå', name_en: 'Ratchasan', province_id: 15},
          {id: 8, name: '‡∏™‡∏ô‡∏≤‡∏°‡∏ä‡∏±‡∏¢‡πÄ‡∏Ç‡∏ï', name_en: 'Sanam Chai Khet', province_id: 15},
          {id: 9, name: '‡πÅ‡∏õ‡∏•‡∏á‡∏¢‡∏≤‡∏ß', name_en: 'Plaeng Yao', province_id: 15},
          {id: 10, name: '‡∏ó‡πà‡∏≤‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö', name_en: 'Tha Takiab', province_id: 15},
          {id: 11, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô', name_en: 'Khlong Khuean', province_id: 15}
        ],
        16: [ // ‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ - All 8 Official Districts - Eastern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Prachinburi', province_id: 16},
          {id: 2, name: '‡∏Å‡∏ö‡∏¥‡∏ô‡∏ó‡∏£‡πå‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Kabin Buri', province_id: 16},
          {id: 3, name: '‡∏ô‡∏≤‡∏î‡∏µ', name_en: 'Na Di', province_id: 16},
          {id: 4, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á', name_en: 'Ban Sang', province_id: 16},
          {id: 5, name: '‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ï‡∏Ñ‡∏≤‡∏°', name_en: 'Prachantakham', province_id: 16},
          {id: 6, name: '‡∏®‡∏£‡∏µ‡∏°‡πÇ‡∏´‡∏™‡∏ñ', name_en: 'Si Maha Phot', province_id: 16},
          {id: 7, name: '‡∏®‡∏£‡∏µ‡∏°‡∏´‡∏≤‡πÇ‡∏û‡∏ò‡∏¥', name_en: 'Si Maha Pho', province_id: 16},
          {id: 8, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Mueang Mai', province_id: 16}
        ],
        17: [ // ‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å - All 4 Official Districts - Central Small Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', name_en: 'Mueang Nakhon Nayok', province_id: 17},
          {id: 2, name: '‡∏õ‡∏≤‡∏Å‡∏û‡∏•‡∏µ', name_en: 'Pak Phli', province_id: 17},
          {id: 3, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤', name_en: 'Ban Na', province_id: 17},
          {id: 4, name: '‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏Å‡∏©‡πå', name_en: 'Ongkharak', province_id: 17}
        ],
        18: [ // ‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß - All 7 Official Districts - Eastern Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Mueang Sa Kaeo', province_id: 18},
          {id: 2, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏î', name_en: 'Khlong Hat', province_id: 18},
          {id: 3, name: '‡∏ï‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤', name_en: 'Ta Phraya', province_id: 18},
          {id: 4, name: '‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô', name_en: 'Wang Nam Yen', province_id: 18},
          {id: 5, name: '‡∏ß‡∏±‡∏í‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏£', name_en: 'Watthana Nakhon', province_id: 18},
          {id: 6, name: '‡∏≠‡∏£‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', name_en: 'Aranyaprathet', province_id: 18},
          {id: 7, name: '‡πÄ‡∏Ç‡∏≤‡∏â‡∏Å‡∏£‡∏£‡∏à‡πå', name_en: 'Khao Chakan', province_id: 18}
        ],
        21: [ // ‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå - All 17 Official Districts - Northeast Cultural Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', name_en: 'Mueang Surin', province_id: 21},
          {id: 2, name: '‡∏ä‡∏∏‡∏°‡∏û‡∏•‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chumphon Buri', province_id: 21},
          {id: 3, name: '‡∏ó‡πà‡∏≤‡∏ï‡∏π‡∏°', name_en: 'Tha Tum', province_id: 21},
          {id: 4, name: '‡∏à‡∏≠‡∏°‡∏û‡∏£‡∏∞', name_en: 'Chom Phra', province_id: 21},
          {id: 5, name: '‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏¢', name_en: 'Prathid', province_id: 21},
          {id: 6, name: '‡∏Å‡∏≤‡∏ö‡πÄ‡∏ä‡∏¥‡∏á', name_en: 'Kap Choeng', province_id: 21},
          {id: 7, name: '‡∏£‡∏±‡∏ï‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Rattanaburi', province_id: 21},
          {id: 8, name: '‡∏™‡∏ô‡∏°', name_en: 'Sanom', province_id: 21},
          {id: 9, name: '‡∏®‡∏µ‡∏Ç‡∏£‡∏†‡∏π‡∏°‡∏¥', name_en: 'Sikhoraphum', province_id: 21},
          {id: 10, name: '‡∏™‡∏±‡∏á‡∏Ç‡∏∞', name_en: 'Sangkha', province_id: 21},
          {id: 11, name: '‡∏•‡∏≥‡∏î‡∏ß‡∏ô', name_en: 'Lamduan', province_id: 21},
          {id: 12, name: '‡∏™‡∏≥‡πÇ‡∏£‡∏á‡∏ó‡∏≤‡∏ö', name_en: 'Samrong Thab', province_id: 21},
          {id: 13, name: '‡∏ö‡∏±‡∏ß‡πÄ‡∏ä‡∏î', name_en: 'Buachet', province_id: 21},
          {id: 14, name: '‡∏û‡∏ô‡∏°‡∏î‡∏á‡∏£‡∏±‡∏Å', name_en: 'Phanom Dong Rak', province_id: 21},
          {id: 15, name: '‡∏®‡∏£‡∏µ‡∏ì‡∏£‡∏á‡∏Ñ‡πå', name_en: 'Si Narong', province_id: 21},
          {id: 16, name: '‡πÄ‡∏Ç‡∏ß‡∏≤‡∏™‡∏¥‡∏ô‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', name_en: 'Khwao Sinrin', province_id: 21},
          {id: 17, name: '‡πÇ‡∏ô‡∏ô‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå', name_en: 'Non Narai', province_id: 21}
        ],
        22: [ // ‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© - All 22 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', name_en: 'Mueang Sisaket', province_id: 22},
          {id: 2, name: '‡∏¢‡∏≤‡∏á‡∏ä‡∏∏‡∏°‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Yang Chum Noi', province_id: 22},
          {id: 3, name: '‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå', name_en: 'Kanthararom', province_id: 22},
          {id: 4, name: '‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏•‡∏±‡∏Å‡∏©‡πå', name_en: 'Kantharalak', province_id: 22},
          {id: 5, name: '‡∏£‡∏≤‡∏©‡∏µ‡πÑ‡∏®‡∏•', name_en: 'Rasi Salai', province_id: 22},
          {id: 6, name: '‡∏≠‡∏∏‡∏ó‡∏∏‡∏°‡∏û‡∏£‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Uthumphon Phisai', province_id: 22},
          {id: 7, name: '‡∏ö‡∏∂‡∏á‡∏ö‡∏π‡∏£‡∏û‡πå', name_en: 'Bueng Bun', province_id: 22},
          {id: 8, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡∏ô', name_en: 'Huai Thap Than', province_id: 22},
          {id: 9, name: '‡πÇ‡∏ô‡∏ô‡∏Ñ‡∏π‡∏ì', name_en: 'Non Khun', province_id: 22},
          {id: 10, name: '‡∏®‡∏£‡∏µ‡∏£‡∏±‡∏ï‡∏ô‡∏∞', name_en: 'Si Rattana', province_id: 22},
          {id: 11, name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á', name_en: 'Nam Kliang', province_id: 22},
          {id: 12, name: '‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô', name_en: 'Wang Hin', province_id: 22},
          {id: 13, name: '‡∏†‡∏π‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Phu Sing', province_id: 22},
          {id: 14, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', name_en: 'Mueang Chan', province_id: 22},
          {id: 15, name: '‡πÄ‡∏ö‡∏ç‡∏à‡∏•‡∏±‡∏Å‡∏©‡πå', name_en: 'Benchalak', province_id: 22},
          {id: 16, name: '‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì', name_en: 'Pho Si Suwan', province_id: 22},
          {id: 17, name: '‡πÇ‡∏Ñ‡∏Å‡πÄ‡∏Ñ‡∏£‡πá‡∏î', name_en: 'Khok Kret', province_id: 22},
          {id: 18, name: '‡∏û‡∏¢‡∏∏‡∏´‡πå', name_en: 'Phayu', province_id: 22},
          {id: 19, name: '‡πÇ‡∏û‡∏ò‡∏¥‡πå‡πÑ‡∏ó‡∏£', name_en: 'Pho Sai', province_id: 22},
          {id: 20, name: '‡∏™‡∏¥‡∏•‡∏≤‡∏•‡∏≤‡∏î', name_en: 'Sila Lat', province_id: 22},
          {id: 21, name: '‡∏£‡∏≤‡∏ä‡∏≤‡∏†‡∏±‡∏è', name_en: 'Ratchabhat', province_id: 22},
          {id: 22, name: '‡∏ö‡∏±‡∏Å‡πÄ‡∏ã‡∏µ‡∏¢‡∏î', name_en: 'Bak Siad', province_id: 22}
        ],
        24: [ // ‡∏¢‡πÇ‡∏™‡∏ò‡∏£ - All 9 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏¢‡πÇ‡∏™‡∏ò‡∏£', name_en: 'Mueang Yasothon', province_id: 24},
          {id: 2, name: '‡πÄ‡∏™‡∏•‡∏†‡∏π‡∏°‡∏¥', name_en: 'Sela Phum', province_id: 24},
          {id: 3, name: '‡∏Å‡∏∏‡∏î‡∏ä‡∏∏‡∏°', name_en: 'Kut Chum', province_id: 24},
          {id: 4, name: '‡∏Ñ‡πâ‡∏≠‡∏ß‡∏±‡∏á', name_en: 'Kho Wang', province_id: 24},
          {id: 5, name: '‡∏õ‡πà‡∏≤‡∏ï‡∏¥‡πâ‡∏ß', name_en: 'Pa Tio', province_id: 24},
          {id: 6, name: '‡∏°‡∏´‡∏≤‡∏ä‡∏ô‡∏∞‡∏ä‡∏±‡∏¢', name_en: 'Maha Chana Chai', province_id: 24},
          {id: 7, name: '‡∏Å‡∏≤‡∏ö‡πÄ‡∏ä‡∏¥‡∏á', name_en: 'Kap Choeng', province_id: 24},
          {id: 8, name: '‡∏•‡∏≠‡∏¢‡∏ó‡∏≠‡∏á', name_en: 'Loeng Nok Tha', province_id: 24},
          {id: 9, name: '‡πÑ‡∏ó‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Thai Charoen', province_id: 24}
        ],
        25: [ // ‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥ - All 16 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', name_en: 'Mueang Chaiyaphum', province_id: 25},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ß‡πâ‡∏≤', name_en: 'Ban Khwao', province_id: 25},
          {id: 3, name: '‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à‡∏ì‡∏£‡∏á‡∏Ñ‡πå', name_en: 'Bamnet Narong', province_id: 25},
          {id: 4, name: '‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™', name_en: 'Chaturat', province_id: 25},
          {id: 5, name: '‡πÅ‡∏Å‡πâ‡∏á‡∏Ñ‡∏£‡πâ‡∏≠', name_en: 'Kaeng Khro', province_id: 25},
          {id: 6, name: '‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', name_en: 'Khon Sawan', province_id: 25},
          {id: 7, name: '‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≤‡∏£', name_en: 'Khon San', province_id: 25},
          {id: 8, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏±‡∏á‡∏Ç‡πå', name_en: 'Noen Sa-nga', province_id: 25},
          {id: 9, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏£‡∏∞‡πÄ‡∏´‡∏ß', name_en: 'Nong Bua Rawe', province_id: 25},
          {id: 10, name: '‡πÄ‡∏ó‡∏û‡∏™‡∏ñ‡∏¥‡∏ï', name_en: 'Thep Sathit', province_id: 25},
          {id: 11, name: '‡∏†‡∏±‡∏Å‡∏î‡∏µ‡∏ä‡∏∏‡∏°‡∏û‡∏•', name_en: 'Phakdi Chumphon', province_id: 25},
          {id: 12, name: '‡∏†‡∏π‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', name_en: 'Phu Khieo', province_id: 25},
          {id: 13, name: '‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏á‡πà‡∏≤', name_en: 'Nong Bua Daeng', province_id: 25},
          {id: 14, name: '‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á', name_en: 'Saeng Sang', province_id: 25},
          {id: 15, name: '‡∏™‡∏±‡∏ö‡πÉ‡∏´‡∏ç‡πà', name_en: 'Sap Yai', province_id: 25},
          {id: 16, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡πÅ‡∏î‡∏á', name_en: 'Nong Bua Daeng', province_id: 25}
        ],
        26: [ // ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç - All 7 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Mueang Amnat Charoen', province_id: 26},
          {id: 2, name: '‡∏ä‡∏≤‡∏ô‡∏∏‡∏°‡∏≤‡∏ô', name_en: 'Chanuman', province_id: 26},
          {id: 3, name: '‡πÄ‡∏™‡∏ô‡∏≤‡∏á‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏°', name_en: 'Senangkhanikhom', province_id: 26},
          {id: 4, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡∏≤', name_en: 'Pathum Ratchawongsa', province_id: 26},
          {id: 5, name: '‡∏´‡∏±‡∏ß‡∏ï‡∏∞‡∏û‡∏≤‡∏ô', name_en: 'Hua Taphan', province_id: 26},
          {id: 6, name: '‡∏•‡∏∑‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à', name_en: 'Lue Amnat', province_id: 26},
          {id: 7, name: '‡∏û‡∏ô‡∏≤', name_en: 'Phana', province_id: 26}
        ],
        27: [ // ‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π - All 6 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', name_en: 'Mueang Nong Bua Lam Phu', province_id: 27},
          {id: 2, name: '‡∏ô‡∏≤‡∏Ñ‡∏•‡∏≤‡∏á', name_en: 'Na Klang', province_id: 27},
          {id: 3, name: '‡∏ô‡∏≤‡∏ß‡∏±‡∏á', name_en: 'Na Wang', province_id: 27},
          {id: 4, name: '‡πÇ‡∏ô‡∏ô‡∏™‡∏±‡∏á', name_en: 'Non Sang', province_id: 27},
          {id: 5, name: '‡∏®‡∏£‡∏µ‡∏ö‡∏∏‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á', name_en: 'Si Bun Rueang', province_id: 27},
          {id: 6, name: '‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏π‡∏´‡∏≤', name_en: 'Suwannakhuha', province_id: 27}
        ],
        30: [ // ‡πÄ‡∏•‡∏¢ - All 14 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏•‡∏¢', name_en: 'Mueang Loei', province_id: 30},
          {id: 2, name: '‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏á', name_en: 'Na Duang', province_id: 30},
          {id: 3, name: '‡∏ô‡∏≤‡πÅ‡∏´‡πâ‡∏ß', name_en: 'Na Haeo', province_id: 30},
          {id: 4, name: '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', name_en: 'Phu Kradueng', province_id: 30},
          {id: 5, name: '‡∏†‡∏π‡∏´‡∏•‡∏ß‡∏á', name_en: 'Phu Luang', province_id: 30},
          {id: 6, name: '‡∏ú‡∏≤‡∏Ç‡∏≤‡∏ß', name_en: 'Pha Khao', province_id: 30},
          {id: 7, name: '‡∏î‡πà‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢', name_en: 'Dan Sai', province_id: 30},
          {id: 8, name: '‡∏ô‡∏≤‡∏î‡πâ‡∏ß‡∏á', name_en: 'Na Duang', province_id: 30},
          {id: 9, name: '‡∏†‡∏π‡πÄ‡∏£‡∏∑‡∏≠', name_en: 'Phu Ruea', province_id: 30},
          {id: 10, name: '‡∏ó‡πà‡∏≤‡∏•‡∏µ‡πà', name_en: 'Tha Li', province_id: 30},
          {id: 11, name: '‡∏ß‡∏±‡∏á‡∏™‡∏∞‡∏û‡∏∏‡∏á', name_en: 'Wang Saphung', province_id: 30},
          {id: 12, name: '‡∏õ‡∏≤‡∏Å‡∏ä‡∏°', name_en: 'Pak Chom', province_id: 30},
          {id: 13, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≤‡∏ô', name_en: 'Chiang Khan', province_id: 30},
          {id: 14, name: '‡πÄ‡∏≠‡∏£‡∏≤‡∏ß‡∏±‡∏ì', name_en: 'Erawan', province_id: 30}
        ],
        31: [ // ‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢ - All 7 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', name_en: 'Mueang Nong Khai', province_id: 31},
          {id: 2, name: '‡∏ó‡πà‡∏≤‡∏ö‡πà‡∏≠', name_en: 'Tha Bo', province_id: 31},
          {id: 3, name: '‡πÇ‡∏û‡∏ô‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Phon Phisai', province_id: 31},
          {id: 4, name: '‡∏®‡∏£‡∏µ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Si Chiang Mai', province_id: 31},
          {id: 5, name: '‡∏£‡∏±‡∏ï‡∏ô‡∏ß‡∏≤‡∏õ‡∏µ', name_en: 'Rattanawapi', province_id: 31},
          {id: 6, name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°', name_en: 'Sangkhom', province_id: 31},
          {id: 7, name: '‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏î‡∏á', name_en: 'Fang Daeng', province_id: 31}
        ],
        32: [ // ‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏° - All 13 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', name_en: 'Mueang Maha Sarakham', province_id: 32},
          {id: 2, name: '‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡∏ä‡∏±‡∏¢', name_en: 'Kantharawichai', province_id: 32},
          {id: 3, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏¢‡∏∑‡∏ô', name_en: 'Chiang Yuen', province_id: 32},
          {id: 4, name: '‡∏ö‡∏£‡∏ö‡∏∑‡∏≠', name_en: 'Borabue', province_id: 32},
          {id: 5, name: '‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å', name_en: 'Na Chueak', province_id: 32},
          {id: 6, name: '‡∏ô‡∏≤‡∏î‡∏π‡∏ô', name_en: 'Na Dun', province_id: 32},
          {id: 7, name: '‡∏¢‡∏≤‡∏á‡∏™‡∏µ‡∏™‡∏∏‡∏£‡∏≤‡∏ä', name_en: 'Yang Sisurat', province_id: 32},
          {id: 8, name: '‡∏ß‡∏≤‡∏õ‡∏µ‡∏õ‡∏ó‡∏∏‡∏°', name_en: 'Wapi Pathum', province_id: 32},
          {id: 9, name: '‡πÇ‡∏Å‡∏™‡∏∏‡∏°‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Kosum Phisai', province_id: 32},
          {id: 10, name: '‡∏Å‡∏∏‡∏î‡∏£‡∏±‡∏á', name_en: 'Kut Rang', province_id: 32},
          {id: 11, name: '‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°', name_en: 'Chuen Chom', province_id: 32},
          {id: 12, name: '‡∏û‡∏¢‡∏±‡∏Ñ‡∏Ü‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Phayakkhaphum Phisai', province_id: 32},
          {id: 13, name: '‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô', name_en: 'Khuang Nai', province_id: 32}
        ],
        33: [ // ‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î - All 20 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', name_en: 'Mueang Roi Et', province_id: 33},
          {id: 2, name: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ß‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Kaset Wisai', province_id: 33},
          {id: 3, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏£‡∏±‡∏ï‡∏ï‡πå', name_en: 'Pathum Rat', province_id: 33},
          {id: 4, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ç‡∏ß‡∏±‡∏ç', name_en: 'Chiang Khwan', province_id: 33},
          {id: 5, name: '‡πÄ‡∏™‡∏•‡∏†‡∏π‡∏°‡∏¥', name_en: 'Selaphum', province_id: 33},
          {id: 6, name: '‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥', name_en: 'Suwannaphum', province_id: 33},
          {id: 7, name: '‡∏ò‡∏ß‡∏±‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Thawat Buri', province_id: 33},
          {id: 8, name: '‡∏û‡∏ô‡∏°‡πÑ‡∏û‡∏£', name_en: 'Phanom Phrai', province_id: 33},
          {id: 9, name: '‡πÇ‡∏û‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', name_en: 'Phon Sai', province_id: 33},
          {id: 10, name: '‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á', name_en: 'Phon Thong', province_id: 33},
          {id: 11, name: '‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏ä‡∏±‡∏¢', name_en: 'Pho Chai', province_id: 33},
          {id: 12, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏û‡∏≠‡∏Å', name_en: 'Nong Phok', province_id: 33},
          {id: 13, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏µ', name_en: 'Nong Hi', province_id: 33},
          {id: 14, name: '‡πÄ‡∏≠‡∏£‡∏≤‡∏ß‡∏±‡∏ì', name_en: 'At Samat', province_id: 33},
          {id: 15, name: '‡∏•‡∏≥‡∏î‡∏ß‡∏ô', name_en: 'Lam Duan', province_id: 33},
          {id: 16, name: '‡πÄ‡∏°‡∏¢‡∏ß‡∏î‡∏µ', name_en: 'May', province_id: 33},
          {id: 17, name: '‡∏à‡∏±‡∏á‡∏´‡∏≤‡∏£', name_en: 'Jangha', province_id: 33},
          {id: 18, name: '‡∏à‡∏ï‡∏∏‡∏£‡∏û‡∏±‡∏Å‡∏ï‡∏£‡∏û‡∏¥‡∏°‡∏≤‡∏ô', name_en: 'Chaturaphak Phiman', province_id: 33},
          {id: 19, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏£‡∏ß‡∏á', name_en: 'Mueang Suang', province_id: 33},
          {id: 20, name: '‡πÇ‡∏Ñ‡∏Å‡∏™‡∏ß‡∏≤‡∏á', name_en: 'Khok Sawang', province_id: 33}
        ],
        34: [ // ‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå - All 18 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', name_en: 'Mueang Kalasin', province_id: 34},
          {id: 2, name: '‡∏ô‡∏≤‡∏°‡∏ô', name_en: 'Na Mon', province_id: 34},
          {id: 3, name: '‡∏Å‡∏°‡∏•‡∏≤‡πÑ‡∏™‡∏¢', name_en: 'Kamalasai', province_id: 34},
          {id: 4, name: '‡∏£‡πà‡∏≠‡∏á‡∏Ñ‡∏≥', name_en: 'Rong Kham', province_id: 34},
          {id: 5, name: '‡∏Å‡∏∏‡∏â‡∏¥‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå', name_en: 'Kuchinarai', province_id: 34},
          {id: 6, name: '‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á', name_en: 'Khao Wong', province_id: 34},
          {id: 7, name: '‡∏¢‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î', name_en: 'Yang Talat', province_id: 34},
          {id: 8, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏ú‡∏∂‡πâ‡∏á', name_en: 'Huai Phueng', province_id: 34},
          {id: 9, name: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à', name_en: 'Sahatsakhan', province_id: 34},
          {id: 10, name: '‡∏Å‡∏∏‡∏î‡∏ö‡∏≤‡∏Å', name_en: 'Kut Bak', province_id: 34},
          {id: 11, name: '‡∏ó‡πà‡∏≤‡∏Ñ‡∏±‡∏ô‡πÇ‡∏ó', name_en: 'Tha Khantho', province_id: 34},
          {id: 12, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏Å‡∏∏‡∏á‡∏®‡∏£‡∏µ', name_en: 'Nong Kung Si', province_id: 34},
          {id: 13, name: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à', name_en: 'Somdet', province_id: 34},
          {id: 14, name: '‡∏´‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡πá‡∏Å', name_en: 'Huai Mek', province_id: 34},
          {id: 15, name: '‡∏î‡∏≠‡∏ô‡∏à‡∏≤‡∏ô', name_en: 'Don Chan', province_id: 34},
          {id: 16, name: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏£‡∏≤‡∏¢', name_en: 'Saeng Sai', province_id: 34},
          {id: 17, name: '‡∏ô‡∏≤‡∏Ñ‡∏π', name_en: 'Na Khu', province_id: 34},
          {id: 18, name: '‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏≠‡∏≥‡∏ô‡∏≤‡∏à', name_en: 'Khama Rachophatthana', province_id: 34}
        ],
        35: [ // ‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£ - All 18 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', name_en: 'Mueang Sakon Nakhon', province_id: 35},
          {id: 2, name: '‡∏Å‡∏∏‡∏™‡∏∏‡∏°‡∏≤‡∏•‡∏¢‡πå', name_en: 'Kusuman', province_id: 35},
          {id: 3, name: '‡∏Å‡∏∏‡∏î‡∏ö‡∏≤‡∏Å', name_en: 'Kut Bak', province_id: 35},
          {id: 4, name: '‡∏û‡∏£‡∏£‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°', name_en: 'Phanna Nikhom', province_id: 35},
          {id: 5, name: '‡∏û‡∏±‡∏á‡πÇ‡∏Ñ‡∏ô', name_en: 'Phang Khon', province_id: 35},
          {id: 6, name: '‡∏ß‡∏≤‡∏£‡∏¥‡∏ä‡∏†‡∏π‡∏°‡∏¥', name_en: 'Waritchaphum', province_id: 35},
          {id: 7, name: '‡∏ô‡∏¥‡∏Ñ‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏π‡∏ô', name_en: 'Nikhom Nam Un', province_id: 35},
          {id: 8, name: '‡∏ß‡∏≤‡∏ô‡∏£‡∏ô‡∏¥‡∏ß‡∏≤‡∏™', name_en: 'Wanon Niwat', province_id: 35},
          {id: 9, name: '‡∏Ñ‡∏≥‡∏ï‡∏≤‡∏Å‡∏•‡πâ‡∏≤', name_en: 'Kham Ta Kla', province_id: 35},
          {id: 10, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡πà‡∏ß‡∏á', name_en: 'Ban Muang', province_id: 35},
          {id: 11, name: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢', name_en: 'Akat Amnuai', province_id: 35},
          {id: 12, name: '‡∏™‡πà‡∏≠‡∏á‡∏î‡∏≤‡∏ß', name_en: 'Song Dao', province_id: 35},
          {id: 13, name: '‡πÄ‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏¢', name_en: 'Tao Ngoi', province_id: 35},
          {id: 14, name: '‡πÇ‡∏Ñ‡∏Å‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì', name_en: 'Khok Si Suphan', province_id: 35},
          {id: 15, name: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢', name_en: 'Agat Amnuai', province_id: 35},
          {id: 16, name: '‡πÄ‡∏ã‡∏Å‡∏≤', name_en: 'Seka', province_id: 35},
          {id: 17, name: '‡πÄ‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏¢', name_en: 'Tao Ngoi', province_id: 35},
          {id: 18, name: '‡πÇ‡∏û‡∏ô‡∏ô‡∏≤‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Phon Na Kaeo', province_id: 35}
        ],
        36: [ // ‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏° - All 12 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', name_en: 'Mueang Nakhon Phanom', province_id: 36},
          {id: 2, name: '‡∏õ‡∏•‡∏≤‡∏õ‡∏≤‡∏Å', name_en: 'Pla Pak', province_id: 36},
          {id: 3, name: '‡∏ó‡πà‡∏≤‡∏≠‡∏∏‡πÄ‡∏ó‡∏ô', name_en: 'Tha Uthen', province_id: 36},
          {id: 4, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡∏á', name_en: 'Ban Phaeng', province_id: 36},
          {id: 5, name: '‡∏ò‡∏≤‡∏ï‡∏∏‡∏û‡∏ô‡∏°', name_en: 'That Phanom', province_id: 36},
          {id: 6, name: '‡πÄ‡∏£‡∏ì‡∏π‡∏ô‡∏Ñ‡∏£', name_en: 'Renu Nakhon', province_id: 36},
          {id: 7, name: '‡∏ô‡∏≤‡πÅ‡∏Å', name_en: 'Na Kae', province_id: 36},
          {id: 8, name: '‡∏®‡∏£‡∏µ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', name_en: 'Si Songkhram', province_id: 36},
          {id: 9, name: '‡∏ô‡∏≤‡∏´‡∏ß‡πâ‡∏≤', name_en: 'Na Wa', province_id: 36},
          {id: 10, name: '‡πÇ‡∏û‡∏ô‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', name_en: 'Phon Sawan', province_id: 36},
          {id: 11, name: '‡∏ô‡∏≤‡∏ó‡∏°', name_en: 'Na Thom', province_id: 36},
          {id: 12, name: '‡∏ß‡∏±‡∏á‡∏¢‡∏≤‡∏á', name_en: 'Wang Yang', province_id: 36}
        ],
        37: [ // ‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£ - All 7 Official Districts - Northeast Border Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', name_en: 'Mueang Mukdahan', province_id: 37},
          {id: 2, name: '‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ñ‡∏≥‡∏™‡∏£‡πâ‡∏≠‡∏¢', name_en: 'Nikhom Kham Soi', province_id: 37},
          {id: 3, name: '‡∏î‡∏≠‡∏ô‡∏ï‡∏≤‡∏•', name_en: 'Don Tan', province_id: 37},
          {id: 4, name: '‡∏î‡∏á‡∏´‡∏•‡∏ß‡∏á', name_en: 'Dong Luang', province_id: 37},
          {id: 5, name: '‡∏Ñ‡∏≥‡∏ä‡∏∞‡∏≠‡∏µ', name_en: 'Kham Cha-i', province_id: 37},
          {id: 6, name: '‡∏´‡∏ß‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà', name_en: 'Wan Yai', province_id: 37},
          {id: 7, name: '‡∏î‡∏≠‡∏ô‡∏ï‡∏≤‡∏•', name_en: 'Don Tan', province_id: 37}
        ],
        39: [ // ‡∏•‡∏≥‡∏û‡∏π‡∏ô - All 8 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏û‡∏π‡∏ô', name_en: 'Mueang Lamphun', province_id: 39},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á', name_en: 'Ban Hong', province_id: 39},
          {id: 3, name: '‡∏•‡∏µ‡πâ', name_en: 'Li', province_id: 39},
          {id: 4, name: '‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á', name_en: 'Thung Hua Chang', province_id: 39},
          {id: 5, name: '‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á', name_en: 'Pa Sang', province_id: 39},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥', name_en: 'Ban Thi', province_id: 39},
          {id: 7, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡∏≠‡∏á‡∏•‡πà‡∏≠‡∏á', name_en: 'Wiang Nong Long', province_id: 39},
          {id: 8, name: '‡πÅ‡∏°‡πà‡∏ó‡∏≤', name_en: 'Mae Tha', province_id: 39}
        ],
        40: [ // ‡∏•‡∏≥‡∏õ‡∏≤‡∏á - All 13 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á', name_en: 'Mueang Lampang', province_id: 40},
          {id: 2, name: '‡πÅ‡∏Å‡πâ‡∏ß‡∏ü‡πâ‡∏≤', name_en: 'Kaeo Fa', province_id: 40},
          {id: 3, name: '‡πÄ‡∏ñ‡∏¥‡∏ô', name_en: 'Thoen', province_id: 40},
          {id: 4, name: '‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞', name_en: 'Mae Mo', province_id: 40},
          {id: 5, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤', name_en: 'Ko Kha', province_id: 40},
          {id: 6, name: '‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏á‡∏≤‡∏°', name_en: 'Soem Ngam', province_id: 40},
          {id: 7, name: '‡∏á‡∏≤‡∏ß', name_en: 'Ngao', province_id: 40},
          {id: 8, name: '‡πÅ‡∏à‡πâ‡∏´‡πà‡∏°', name_en: 'Chae Hom', province_id: 40},
          {id: 9, name: '‡∏ß‡∏±‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', name_en: 'Wang Nuea', province_id: 40},
          {id: 10, name: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Ñ‡∏•‡∏≠‡∏á', name_en: 'Nuea Khlong', province_id: 40},
          {id: 11, name: '‡πÅ‡∏°‡πà‡∏û‡∏£‡∏¥‡∏Å', name_en: 'Mae Phrik', province_id: 40},
          {id: 12, name: '‡∏™‡∏ö‡∏õ‡∏£‡∏≤‡∏ö', name_en: 'Sop Prap', province_id: 40},
          {id: 13, name: '‡∏´‡∏•‡πà‡∏°‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Lom Kao', province_id: 40}
        ],
        41: [ // ‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå - All 9 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', name_en: 'Mueang Uttaradit', province_id: 41},
          {id: 2, name: '‡∏ï‡∏£‡∏≠‡∏ô', name_en: 'Tron', province_id: 41},
          {id: 3, name: '‡∏•‡∏±‡∏ö‡πÅ‡∏•', name_en: 'Lap Lae', province_id: 41},
          {id: 4, name: '‡∏ó‡πà‡∏≤‡∏õ‡∏•‡∏≤', name_en: 'Tha Pla', province_id: 41},
          {id: 5, name: '‡∏ô‡πâ‡∏≥‡∏õ‡∏≤‡∏î', name_en: 'Nam Pat', province_id: 41},
          {id: 6, name: '‡∏ü‡∏≤‡∏Å‡∏ó‡πà‡∏≤', name_en: 'Fak Tha', province_id: 41},
          {id: 7, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏Å', name_en: 'Ban Khok', province_id: 41},
          {id: 8, name: '‡∏ó‡∏≠‡∏á‡πÅ‡∏™‡∏ô‡∏Ç‡∏±‡∏ô', name_en: 'Thong Saen Khan', province_id: 41},
          {id: 9, name: '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', name_en: 'Phichit', province_id: 41}
        ],
        42: [ // ‡πÅ‡∏û‡∏£‡πà - All 8 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏û‡∏£‡πà', name_en: 'Mueang Phrae', province_id: 42},
          {id: 2, name: '‡∏£‡πâ‡∏≠‡∏á‡∏Å‡∏ß‡∏≤‡∏á', name_en: 'Rong Kwang', province_id: 42},
          {id: 3, name: '‡∏•‡∏≠‡∏á', name_en: 'Long', province_id: 42},
          {id: 4, name: '‡∏™‡∏π‡∏á‡πÄ‡∏°‡πà‡∏ô', name_en: 'Sung Men', province_id: 42},
          {id: 5, name: '‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏¢', name_en: 'Den Chai', province_id: 42},
          {id: 6, name: '‡∏™‡∏≠‡∏á', name_en: 'Song', province_id: 42},
          {id: 7, name: '‡∏ß‡∏±‡∏á‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Wang Chin', province_id: 42},
          {id: 8, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á‡πÑ‡∏Ç‡πà', name_en: 'Nong Muang Khai', province_id: 42}
        ],
        43: [ // ‡∏ô‡πà‡∏≤‡∏ô - All 15 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô', name_en: 'Mueang Nan', province_id: 43},
          {id: 2, name: '‡πÅ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏°', name_en: 'Mae Charim', province_id: 43},
          {id: 3, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏ß‡∏á', name_en: 'Ban Luang', province_id: 43},
          {id: 4, name: '‡∏ô‡∏≤‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Na Noi', province_id: 43},
          {id: 5, name: '‡∏õ‡∏±‡∏ß', name_en: 'Pua', province_id: 43},
          {id: 6, name: '‡∏ó‡πà‡∏≤‡∏ß‡∏±‡∏á‡∏ú‡∏≤', name_en: 'Tha Wang Pha', province_id: 43},
          {id: 7, name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏™‡∏≤', name_en: 'Wiang Sa', province_id: 43},
          {id: 8, name: '‡∏ó‡∏∏‡πà‡∏á‡∏ä‡πâ‡∏≤‡∏á', name_en: 'Thung Chang', province_id: 43},
          {id: 9, name: '‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥', name_en: 'Chaloem Phra Kiat', province_id: 43},
          {id: 10, name: '‡∏ô‡∏≤‡∏´‡∏°‡∏∑‡πà‡∏ô', name_en: 'Na Muen', province_id: 43},
          {id: 11, name: '‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç', name_en: 'Santisuk', province_id: 43},
          {id: 12, name: '‡∏ö‡πà‡∏≠‡πÄ‡∏Å‡∏•‡∏∑‡∏≠', name_en: 'Bo Kluea', province_id: 43},
          {id: 13, name: '‡∏™‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á', name_en: 'Song Phi Nong', province_id: 43},
          {id: 14, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏≤‡∏á', name_en: 'Chiang Klang', province_id: 43},
          {id: 15, name: '‡πÅ‡∏°‡πà‡πÄ‡∏à‡πâ‡∏≤', name_en: 'Mae Chao', province_id: 43}
        ],
        44: [ // ‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ - All 9 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', name_en: 'Mueang Phayao', province_id: 44},
          {id: 2, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥', name_en: 'Chiang Kham', province_id: 44},
          {id: 3, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏°‡πà‡∏ß‡∏ô', name_en: 'Chiang Muan', province_id: 44},
          {id: 4, name: '‡∏î‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ï‡πâ', name_en: 'Dok Kham Tai', province_id: 44},
          {id: 5, name: '‡∏õ‡∏á', name_en: 'Pong', province_id: 44},
          {id: 6, name: '‡πÅ‡∏°‡πà‡πÉ‡∏à', name_en: 'Mae Chai', province_id: 44},
          {id: 7, name: '‡∏à‡∏∏‡∏ô', name_en: 'Chun', province_id: 44},
          {id: 8, name: '‡∏†‡∏π‡πÄ‡∏ã‡∏µ‡∏¢‡∏á', name_en: 'Phu Sang', province_id: 44},
          {id: 9, name: '‡∏†‡∏π‡∏Å‡∏≤‡∏°‡∏¢‡∏≤‡∏ß', name_en: 'Phu Kam Yao', province_id: 44}
        ],
        46: [ // ‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô - All 7 Official Districts - Northern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', name_en: 'Mueang Mae Hong Son', province_id: 46},
          {id: 2, name: '‡∏Ç‡∏∏‡∏ô‡∏¢‡∏ß‡∏°', name_en: 'Khun Yuam', province_id: 46},
          {id: 3, name: '‡∏õ‡∏≤‡∏¢', name_en: 'Pai', province_id: 46},
          {id: 4, name: '‡πÅ‡∏°‡πà‡∏™‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á', name_en: 'Mae Sariang', province_id: 46},
          {id: 5, name: '‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Mae La Noi', province_id: 46},
          {id: 6, name: '‡∏™‡∏ö‡πÄ‡∏°‡∏¢', name_en: 'Sop Moei', province_id: 46},
          {id: 7, name: '‡πÅ‡∏°‡πà‡∏Ç‡πà‡∏≤', name_en: 'Mae Kha', province_id: 46}
        ],
        47: [ // ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå - All 15 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', name_en: 'Mueang Nakhon Sawan', province_id: 47},
          {id: 2, name: '‡πÇ‡∏Å‡∏£‡∏Å‡∏û‡∏£‡∏∞', name_en: 'Krok Phra', province_id: 47},
          {id: 3, name: '‡∏ä‡∏∏‡∏°‡πÅ‡∏™‡∏á', name_en: 'Chum Saeng', province_id: 47},
          {id: 4, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß', name_en: 'Nong Bua', province_id: 47},
          {id: 5, name: '‡∏ö‡∏£‡∏£‡∏û‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'Banphot Phisai', province_id: 47},
          {id: 6, name: '‡πÄ‡∏Å‡πâ‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß', name_en: 'Kao Liao', province_id: 47},
          {id: 7, name: '‡∏ï‡∏≤‡∏Ñ‡∏•‡∏µ', name_en: 'Tak Li', province_id: 47},
          {id: 8, name: '‡∏ó‡πà‡∏≤‡∏ï‡∏∞‡πÇ‡∏Å', name_en: 'Tha Tako', province_id: 47},
          {id: 9, name: '‡πÑ‡∏û‡∏®‡∏≤‡∏•‡∏µ', name_en: 'Phaisali', province_id: 47},
          {id: 10, name: '‡∏û‡∏¢‡∏∏‡∏´‡∏∞‡∏Ñ‡∏µ‡∏£‡∏µ', name_en: 'Phayuha Khiri', province_id: 47},
          {id: 11, name: '‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏ß', name_en: 'Lat Yao', province_id: 47},
          {id: 12, name: '‡∏ï‡∏≤‡∏Å‡∏ü‡πâ‡∏≤', name_en: 'Tak Fa', province_id: 47},
          {id: 13, name: '‡πÅ‡∏°‡πà‡∏ß‡∏á‡∏Å‡πå', name_en: 'Mae Wong', province_id: 47},
          {id: 14, name: '‡πÅ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏ô', name_en: 'Mae Poen', province_id: 47},
          {id: 15, name: '‡∏ä‡∏∏‡∏°‡∏ï‡∏≤‡∏ö‡∏á', name_en: 'Chum Ta Bong', province_id: 47}
        ],
        48: [ // ‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ - All 8 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Uthai Thani', province_id: 48},
          {id: 2, name: '‡∏ó‡∏±‡∏û‡∏ó‡∏±‡∏ô', name_en: 'Thap Than', province_id: 48},
          {id: 3, name: '‡∏®‡∏£‡∏µ‡∏™‡∏≥‡πÇ‡∏£‡∏á', name_en: 'Sawang Arom', province_id: 48},
          {id: 4, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏≤‡∏´‡∏¢‡πà‡∏≤‡∏á', name_en: 'Nong Khayang', province_id: 48},
          {id: 5, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏â‡∏≤‡∏á', name_en: 'Nong Chang', province_id: 48},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏£‡πà', name_en: 'Ban Rai', province_id: 48},
          {id: 7, name: '‡∏•‡∏≤‡∏ô‡∏™‡∏±‡∏Å', name_en: 'Lan Sak', province_id: 48},
          {id: 8, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ï', name_en: 'Huai Khot', province_id: 48}
        ],
        49: [ // ‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£ - All 11 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', name_en: 'Mueang Kamphaeng Phet', province_id: 49},
          {id: 2, name: '‡πÑ‡∏ó‡∏£‡∏á‡∏≤‡∏°', name_en: 'Sai Ngam', province_id: 49},
          {id: 3, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏•‡∏≤‡∏ô', name_en: 'Khlong Lan', province_id: 49},
          {id: 4, name: '‡∏Ç‡∏≤‡∏ì‡∏∏‡∏ß‡∏£‡∏•‡∏±‡∏Å‡∏©‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Khanu Woralaksaburi', province_id: 49},
          {id: 5, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏Ç‡∏•‡∏∏‡∏á', name_en: 'Khlong Khlung', province_id: 49},
          {id: 6, name: '‡∏û‡∏£‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢', name_en: 'Phran Kratai', province_id: 49},
          {id: 7, name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏∑‡∏≠', name_en: 'Lan Krabue', province_id: 49},
          {id: 8, name: '‡∏ó‡∏£‡∏≤‡∏¢‡∏ó‡∏≠‡∏á‡∏ß‡∏±‡∏í‡∏ô‡∏≤', name_en: 'Sai Thong Watthana', province_id: 49},
          {id: 9, name: '‡∏õ‡∏≤‡∏á‡∏®‡∏¥‡∏•‡∏≤‡∏ó‡∏≠‡∏á', name_en: 'Pang Sila Thong', province_id: 49},
          {id: 10, name: '‡∏ö‡∏∂‡∏á‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ', name_en: 'Bueng Samakkhi', province_id: 49},
          {id: 11, name: '‡πÇ‡∏Å‡∏™‡∏±‡∏°‡∏û‡∏µ‡∏ô‡∏Ñ‡∏£', name_en: 'Kosamphi Nakhon', province_id: 49}
        ],
        50: [ // ‡∏ï‡∏≤‡∏Å - All 9 Official Districts - Western Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏≤‡∏Å', name_en: 'Mueang Tak', province_id: 50},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≤‡∏Å', name_en: 'Ban Tak', province_id: 50},
          {id: 3, name: '‡∏™‡∏≤‡∏°‡πÄ‡∏á‡∏≤', name_en: 'Sam Ngao', province_id: 50},
          {id: 4, name: '‡πÅ‡∏°‡πà‡∏£‡∏∞‡∏°‡∏≤‡∏î', name_en: 'Mae Ramat', province_id: 50},
          {id: 5, name: '‡∏ó‡πà‡∏≤‡∏™‡∏≠‡∏á‡∏¢‡∏≤‡∏á', name_en: 'Tha Song Yang', province_id: 50},
          {id: 6, name: '‡πÅ‡∏°‡πà‡∏™‡∏≠‡∏î', name_en: 'Mae Sot', province_id: 50},
          {id: 7, name: '‡∏õ‡πä‡∏≠‡∏ö‡∏û‡∏£‡∏∞', name_en: 'Phop Phra', province_id: 50},
          {id: 8, name: '‡∏≠‡∏∏‡πâ‡∏°‡∏ú‡∏≤‡∏á', name_en: 'Um Phang', province_id: 50},
          {id: 9, name: '‡∏ß‡∏±‡∏á‡πÄ‡∏à‡πâ‡∏≤', name_en: 'Wang Chao', province_id: 50}
        ],
        51: [ // ‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢ - All 9 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', name_en: 'Mueang Sukhothai', province_id: 51},
          {id: 2, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏ô‡∏´‡∏≠‡∏¢', name_en: 'Ban Dan Lan Hoi', province_id: 51},
          {id: 3, name: '‡∏Ñ‡∏µ‡∏£‡∏µ‡∏°‡∏≤‡∏®', name_en: 'Khiri Mat', province_id: 51},
          {id: 4, name: '‡∏Å‡∏á‡πÑ‡∏Å‡∏£‡∏•‡∏≤‡∏®', name_en: 'Kong Krailat', province_id: 51},
          {id: 5, name: '‡∏®‡∏£‡∏µ‡∏™‡∏≥‡πÇ‡∏£‡∏á', name_en: 'Si Samrong', province_id: 51},
          {id: 6, name: '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£', name_en: 'Si Nakhon', province_id: 51},
          {id: 7, name: '‡∏®‡∏£‡∏µ‡∏™‡∏±‡∏ä‡∏ô‡∏≤‡∏•‡∏±‡∏¢', name_en: 'Si Satchanalai', province_id: 51},
          {id: 8, name: '‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πÇ‡∏•‡∏Å', name_en: 'Sawankhalok', province_id: 51},
          {id: 9, name: '‡∏ó‡∏∏‡πà‡∏á‡πÄ‡∏™‡∏•‡∏µ‡πà‡∏¢‡∏°', name_en: 'Thung Saliam', province_id: 51}
        ],
        52: [ // ‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å - All 9 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', name_en: 'Mueang Phitsanulok', province_id: 52},
          {id: 2, name: '‡∏ô‡∏Ñ‡∏£‡πÑ‡∏ó‡∏¢', name_en: 'Nakhon Thai', province_id: 52},
          {id: 3, name: '‡∏ä‡∏≤‡∏ï‡∏¥‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£', name_en: 'Chat Trakan', province_id: 52},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏Å‡∏≥', name_en: 'Bang Rakam', province_id: 52},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°', name_en: 'Bang Krathum', province_id: 52},
          {id: 6, name: '‡∏û‡∏£‡∏´‡∏°‡∏û‡∏¥‡∏£‡∏≤‡∏°', name_en: 'Phrom Phiram', province_id: 52},
          {id: 7, name: '‡∏ß‡∏±‡∏î‡πÇ‡∏ö‡∏™‡∏ñ‡πå', name_en: 'Wat Bot', province_id: 52},
          {id: 8, name: '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á', name_en: 'Wang Thong', province_id: 52},
          {id: 9, name: '‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏∞‡∏õ‡∏£‡∏≤‡∏á', name_en: 'Noen Maprang', province_id: 52}
        ],
        53: [ // ‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£ - All 12 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', name_en: 'Mueang Phichit', province_id: 53},
          {id: 2, name: '‡∏ß‡∏±‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡∏û‡∏π‡∏ô', name_en: 'Wang Sai Phun', province_id: 53},
          {id: 3, name: '‡πÇ‡∏õ‡πà‡∏á‡πÑ‡∏ú‡πà‡∏á‡∏≤‡∏°', name_en: 'Pho Prathap Chang', province_id: 53},
          {id: 4, name: '‡∏ï‡∏∞‡∏û‡∏≤‡∏ô‡∏´‡∏¥‡∏ô', name_en: 'Taphan Hin', province_id: 53},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡∏°‡∏π‡∏•‡∏ô‡∏≤‡∏Å', name_en: 'Bang Mun Nak', province_id: 53},
          {id: 6, name: '‡πÇ‡∏û‡∏ó‡∏∞‡πÄ‡∏•', name_en: 'Pho Thale', province_id: 53},
          {id: 7, name: '‡∏™‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏°', name_en: 'Sam Ngam', province_id: 53},
          {id: 8, name: '‡∏ó‡∏±‡∏ö‡∏Ñ‡∏•‡πâ‡∏≠', name_en: 'Thap Khlo', province_id: 53},
          {id: 9, name: '‡∏ö‡∏∂‡∏á‡∏ô‡∏≤‡∏£‡∏≤‡∏á', name_en: 'Bueng Na Rang', province_id: 53},
          {id: 10, name: '‡∏î‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Dong Charoen', province_id: 53},
          {id: 11, name: '‡∏ß‡∏ä‡∏¥‡∏£‡∏ö‡∏≤‡∏£‡∏°‡∏µ', name_en: 'Wachirabarami', province_id: 53},
          {id: 12, name: '‡∏™‡∏±‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å', name_en: 'Sak Lek', province_id: 53}
        ],
        54: [ // ‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå - All 11 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', name_en: 'Mueang Phetchabun', province_id: 54},
          {id: 2, name: '‡∏ä‡∏ô‡πÅ‡∏î‡∏ô', name_en: 'Chon Daen', province_id: 54},
          {id: 3, name: '‡πÄ‡∏•‡∏≤‡∏Ç‡∏ß‡∏±‡∏ç', name_en: 'Lao Khwan', province_id: 54},
          {id: 4, name: '‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Wichian Buri', province_id: 54},
          {id: 5, name: '‡∏®‡∏£‡∏µ‡πÄ‡∏ó‡∏û', name_en: 'Si Thep', province_id: 54},
          {id: 6, name: '‡∏´‡∏•‡πà‡∏°‡∏™‡∏±‡∏Å', name_en: 'Lom Sak', province_id: 54},
          {id: 7, name: '‡∏´‡∏•‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤', name_en: 'Lom Kao', province_id: 54},
          {id: 8, name: '‡∏ß‡∏±‡∏á‡πÇ‡∏õ‡πà‡∏á', name_en: 'Wang Pong', province_id: 54},
          {id: 9, name: '‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô', name_en: 'Nam Nao', province_id: 54},
          {id: 10, name: '‡∏ö‡∏∂‡∏á‡∏™‡∏≤‡∏°‡∏û‡∏±‡∏ô', name_en: 'Bueng Sam Phan', province_id: 54},
          {id: 11, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà', name_en: 'Nong Phai', province_id: 54}
        ],
        55: [ // ‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ - All 10 Official Districts - Western Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Ratchaburi', province_id: 55},
          {id: 2, name: '‡∏à‡∏≠‡∏°‡∏ö‡∏∂‡∏á', name_en: 'Chom Bueng', province_id: 55},
          {id: 3, name: '‡∏™‡∏ß‡∏ô‡∏ú‡∏∂‡πâ‡∏á', name_en: 'Suan Phueng', province_id: 55},
          {id: 4, name: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å', name_en: 'Damnoen Saduak', province_id: 55},
          {id: 5, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡πà‡∏á', name_en: 'Ban Pong', province_id: 55},
          {id: 6, name: '‡∏ö‡∏≤‡∏á‡πÅ‡∏û', name_en: 'Bang Phae', province_id: 55},
          {id: 7, name: '‡πÇ‡∏û‡∏ò‡∏≤‡∏£‡∏≤‡∏°', name_en: 'Photharam', province_id: 55},
          {id: 8, name: '‡∏õ‡∏≤‡∏Å‡∏ó‡πà‡∏≠', name_en: 'Pak Tho', province_id: 55},
          {id: 9, name: '‡∏ß‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏á', name_en: 'Wat Phleng', province_id: 55},
          {id: 10, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏≤', name_en: 'Ban Kha', province_id: 55}
        ],
        56: [ // ‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ - All 13 Official Districts - Western Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Kanchanaburi', province_id: 56},
          {id: 2, name: '‡πÑ‡∏ó‡∏£‡πÇ‡∏¢‡∏Ñ', name_en: 'Sai Yok', province_id: 56},
          {id: 3, name: '‡∏ö‡πà‡∏≠‡∏û‡∏•‡∏≠‡∏¢', name_en: 'Bo Phloi', province_id: 56},
          {id: 4, name: '‡∏®‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå', name_en: 'Si Sawat', province_id: 56},
          {id: 5, name: '‡∏ó‡πà‡∏≤‡∏°‡∏∞‡∏Å‡∏≤', name_en: 'Tha Maka', province_id: 56},
          {id: 6, name: '‡∏ó‡πà‡∏≤‡∏°‡πà‡∏ß‡∏á', name_en: 'Tha Muang', province_id: 56},
          {id: 7, name: '‡∏ó‡∏≠‡∏á‡∏ú‡∏≤‡∏†‡∏π‡∏°‡∏¥', name_en: 'Thong Pha Phum', province_id: 56},
          {id: 8, name: '‡∏™‡∏±‡∏á‡∏Ç‡∏•‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sangkhla Buri', province_id: 56},
          {id: 9, name: '‡∏û‡∏ô‡∏°‡∏ó‡∏ß‡∏ô', name_en: 'Phanom Thuan', province_id: 56},
          {id: 10, name: '‡πÄ‡∏•‡∏≤‡∏Ç‡∏ß‡∏±‡∏ç', name_en: 'Lao Khwan', province_id: 56},
          {id: 11, name: '‡∏î‡πà‡∏≤‡∏ô‡∏°‡∏∞‡∏Ç‡∏≤‡∏°‡πÄ‡∏ï‡∏µ‡πâ‡∏¢', name_en: 'Dan Makham Tia', province_id: 56},
          {id: 12, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏£‡∏∑‡∏≠', name_en: 'Nong Prue', province_id: 56},
          {id: 13, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏≤', name_en: 'Huai Krachao', province_id: 56}
        ],
        57: [ // ‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ - All 10 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Suphan Buri', province_id: 57},
          {id: 2, name: '‡πÄ‡∏î‡∏¥‡∏°‡∏ö‡∏≤‡∏á‡∏ô‡∏≤‡∏á‡∏ö‡∏ß‡∏ä', name_en: 'Doem Bang Nang Buat', province_id: 57},
          {id: 3, name: '‡∏î‡πà‡∏≤‡∏ô‡∏ä‡πâ‡∏≤‡∏á', name_en: 'Dan Chang', province_id: 57},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏õ‡∏•‡∏≤‡∏°‡πâ‡∏≤', name_en: 'Bang Pla Ma', province_id: 57},
          {id: 5, name: '‡∏®‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô‡∏ï‡πå', name_en: 'Si Prachan', province_id: 57},
          {id: 6, name: '‡∏î‡∏≠‡∏ô‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå', name_en: 'Don Chedi', province_id: 57},
          {id: 7, name: '‡∏™‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á', name_en: 'Song Phi Nong', province_id: 57},
          {id: 8, name: '‡∏™‡∏≤‡∏°‡∏ä‡∏∏‡∏Å', name_en: 'Sam Chuk', province_id: 57},
          {id: 9, name: '‡∏≠‡∏π‡πà‡∏ó‡∏≠‡∏á', name_en: 'U Thong', province_id: 57},
          {id: 10, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã', name_en: 'Nong Ya Sai', province_id: 57}
        ],
        59: [ // ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ - All 3 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', name_en: 'Mueang Samut Sakhon', province_id: 59},
          {id: 2, name: '‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô', name_en: 'Krathum Baen', province_id: 59},
          {id: 3, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏û‡πâ‡∏ß', name_en: 'Ban Phaeo', province_id: 59}
        ],
        60: [ // ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏° - All 3 Official Districts - Central Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', name_en: 'Mueang Samut Songkhram', province_id: 60},
          {id: 2, name: '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ', name_en: 'Bang Khonthi', province_id: 60},
          {id: 3, name: '‡∏≠‡∏±‡∏°‡∏û‡∏ß‡∏≤', name_en: 'Amphawa', province_id: 60}
        ],
        61: [ // ‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ - All 8 Official Districts - Western Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Mueang Phetchaburi', province_id: 61},
          {id: 2, name: '‡πÄ‡∏Ç‡∏≤‡∏¢‡πâ‡∏≠‡∏¢', name_en: 'Khao Yoi', province_id: 61},
          {id: 3, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡∏õ‡∏•‡πâ‡∏≠‡∏á', name_en: 'Nong Ya Plong', province_id: 61},
          {id: 4, name: '‡∏ä‡∏∞‡∏≠‡∏≥', name_en: 'Cha-am', province_id: 61},
          {id: 5, name: '‡∏ó‡πà‡∏≤‡∏¢‡∏≤‡∏á', name_en: 'Tha Yang', province_id: 61},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏≤‡∏î', name_en: 'Ban Lat', province_id: 61},
          {id: 7, name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏´‡∏•‡∏°', name_en: 'Ban Laem', province_id: 61},
          {id: 8, name: '‡πÅ‡∏Å‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏ô', name_en: 'Kaeng Krachan', province_id: 61}
        ],
        62: [ // ‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå - All 8 Official Districts - Western Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', name_en: 'Mueang Prachuap Khiri Khan', province_id: 62},
          {id: 2, name: '‡∏Å‡∏∏‡∏¢‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Kui Buri', province_id: 62},
          {id: 3, name: '‡∏ó‡∏±‡∏ö‡∏™‡∏∞‡πÅ‡∏Å', name_en: 'Thap Sakae', province_id: 62},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô', name_en: 'Bang Saphan', province_id: 62},
          {id: 5, name: '‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Bang Saphan Noi', province_id: 62},
          {id: 6, name: '‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Pran Buri', province_id: 62},
          {id: 7, name: '‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô', name_en: 'Hua Hin', province_id: 62},
          {id: 8, name: '‡∏™‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏¢‡∏¢‡∏≠‡∏î', name_en: 'Sam Roi Yot', province_id: 62}
        ],
        65: [ // ‡∏û‡∏±‡∏á‡∏á‡∏≤ - All 8 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏±‡∏á‡∏á‡∏≤', name_en: 'Mueang Phang Nga', province_id: 65},
          {id: 2, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏¢‡∏≤‡∏ß', name_en: 'Ko Yao', province_id: 65},
          {id: 3, name: '‡∏Å‡∏∞‡∏õ‡∏á', name_en: 'Kapong', province_id: 65},
          {id: 4, name: '‡∏ï‡∏∞‡∏Å‡∏±‡πà‡∏ß‡∏ó‡∏∏‡πà‡∏á', name_en: 'Takua Thung', province_id: 65},
          {id: 5, name: '‡∏ï‡∏∞‡∏Å‡∏±‡πà‡∏ß‡∏õ‡πà‡∏≤', name_en: 'Takua Pa', province_id: 65},
          {id: 6, name: '‡∏Ñ‡∏∏‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Khura Buri', province_id: 65},
          {id: 7, name: '‡∏ó‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Thai Mueang', province_id: 65},
          {id: 8, name: '‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Thap Put', province_id: 65}
        ],
        68: [ // ‡∏£‡∏∞‡∏ô‡∏≠‡∏á - All 5 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏∞‡∏ô‡∏≠‡∏á', name_en: 'Mueang Ranong', province_id: 68},
          {id: 2, name: '‡∏Å‡∏∞‡∏õ‡∏á', name_en: 'Kapoe', province_id: 68},
          {id: 3, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏°‡∏∞‡∏£‡∏¥‡∏î', name_en: 'Khlong Mard', province_id: 68},
          {id: 4, name: '‡∏•‡∏∞‡∏≠‡∏∏‡πà‡∏ô', name_en: 'La-un', province_id: 68},
          {id: 5, name: '‡∏™‡∏∏‡∏Ç‡∏™‡∏≥‡∏£‡∏≤‡∏ç', name_en: 'Suk Samran', province_id: 68}
        ],
        69: [ // ‡∏ä‡∏∏‡∏°‡∏û‡∏£ - All 8 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏û‡∏£', name_en: 'Mueang Chumphon', province_id: 69},
          {id: 2, name: '‡∏ó‡πà‡∏≤‡πÅ‡∏ã‡∏∞', name_en: 'Tha Sae', province_id: 69},
          {id: 3, name: '‡∏õ‡∏∞‡∏ó‡∏¥‡∏ß', name_en: 'Pathio', province_id: 69},
          {id: 4, name: '‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏ô', name_en: 'Lang Suan', province_id: 69},
          {id: 5, name: '‡∏•‡∏≥‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Lamae', province_id: 69},
          {id: 6, name: '‡∏ó‡∏∏‡πà‡∏á‡∏ï‡∏∞‡πÇ‡∏Å', name_en: 'Thung Tako', province_id: 69},
          {id: 7, name: '‡∏™‡∏ß‡∏µ', name_en: 'Sawi', province_id: 69},
          {id: 8, name: '‡∏ó‡∏∏‡πà‡∏á‡πÉ‡∏™', name_en: 'Thung Sai', province_id: 69}
        ],
        71: [ // ‡∏™‡∏ï‡∏π‡∏• - All 7 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏ï‡∏π‡∏•', name_en: 'Mueang Satun', province_id: 71},
          {id: 2, name: '‡∏Ñ‡∏ß‡∏ô‡πÇ‡∏î‡∏ô', name_en: 'Khuan Don', province_id: 71},
          {id: 3, name: '‡∏Ñ‡∏ß‡∏ô‡∏Å‡∏≤‡∏´‡∏•‡∏á', name_en: 'Khuan Kalong', province_id: 71},
          {id: 4, name: '‡∏ó‡πà‡∏≤‡πÅ‡∏û', name_en: 'Tha Phae', province_id: 71},
          {id: 5, name: '‡∏•‡∏∞‡∏á‡∏π', name_en: 'La-ngu', province_id: 71},
          {id: 6, name: '‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏ß‡πâ‡∏≤', name_en: 'Thung Wa', province_id: 71},
          {id: 7, name: '‡∏°‡∏∞‡∏ô‡∏±‡∏á', name_en: 'Manang', province_id: 71}
        ],
        72: [ // ‡∏ï‡∏£‡∏±‡∏á - All 10 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏£‡∏±‡∏á', name_en: 'Mueang Trang', province_id: 72},
          {id: 2, name: '‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏á', name_en: 'Kantang', province_id: 72},
          {id: 3, name: '‡∏¢‡∏≤‡∏ô‡∏ï‡∏≤‡∏Ç‡∏≤‡∏ß', name_en: 'Yan Ta Khao', province_id: 72},
          {id: 4, name: '‡∏õ‡∏∞‡πÄ‡∏•‡∏µ‡∏¢‡∏ô', name_en: 'Palian', province_id: 72},
          {id: 5, name: '‡∏®‡∏¥‡∏Ç‡∏£‡πÄ‡∏Ç‡∏ï', name_en: 'Sikao', province_id: 72},
          {id: 6, name: '‡∏´‡πâ‡∏ß‡∏¢‡∏¢‡∏≠‡∏î', name_en: 'Huai Yot', province_id: 72},
          {id: 7, name: '‡∏ß‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏®‡∏©', name_en: 'Wang Wiset', province_id: 72},
          {id: 8, name: '‡∏ô‡∏≤‡πÇ‡∏¢‡∏á', name_en: 'Na Yong', province_id: 72},
          {id: 9, name: '‡∏£‡∏±‡∏©‡∏é‡∏≤', name_en: 'Ratsada', province_id: 72},
          {id: 10, name: '‡∏´‡∏≤‡∏î‡∏™‡∏≥‡∏£‡∏≤‡∏ç', name_en: 'Hat Samran', province_id: 72}
        ],
        73: [ // ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á - All 11 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', name_en: 'Mueang Phatthalung', province_id: 73},
          {id: 2, name: '‡πÄ‡∏Ç‡∏≤‡∏ä‡∏±‡∏¢‡∏™‡∏ô', name_en: 'Khao Chaison', province_id: 73},
          {id: 3, name: '‡∏Å‡∏á‡∏´‡∏£‡∏≤', name_en: 'Kong Ra', province_id: 73},
          {id: 4, name: '‡∏ï‡∏∞‡πÇ‡∏´‡∏°‡∏î', name_en: 'Tamot', province_id: 73},
          {id: 5, name: '‡∏Ñ‡∏ß‡∏ô‡∏Ç‡∏ô‡∏∏‡∏ô', name_en: 'Khuan Khanun', province_id: 73},
          {id: 6, name: '‡∏õ‡πà‡∏≤‡∏ö‡∏≠‡∏ô', name_en: 'Pa Bon', province_id: 73},
          {id: 7, name: '‡∏õ‡∏≤‡∏Å‡∏û‡∏∞‡∏¢‡∏π‡∏ô', name_en: 'Pak Phayun', province_id: 73},
          {id: 8, name: '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', name_en: 'Srinakarin', province_id: 73},
          {id: 9, name: '‡∏®‡∏£‡∏µ‡∏ö‡∏£‡∏£‡∏û‡∏ï', name_en: 'Si Banphot', province_id: 73},
          {id: 10, name: '‡∏ö‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Bang Kaeo', province_id: 73},
          {id: 11, name: '‡∏õ‡πà‡∏≤‡∏û‡∏∞‡∏¢‡∏≠‡∏°', name_en: 'Pa Phayom', province_id: 73}
        ],
        75: [ // ‡∏¢‡∏∞‡∏•‡∏≤ - All 8 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏¢‡∏∞‡∏•‡∏≤', name_en: 'Mueang Yala', province_id: 75},
          {id: 2, name: '‡πÄ‡∏ö‡∏ï‡∏á', name_en: 'Betong', province_id: 75},
          {id: 3, name: '‡∏ö‡∏±‡∏ô‡∏ô‡∏±‡∏á‡∏™‡∏ï‡∏≤', name_en: 'Bannang Sata', province_id: 75},
          {id: 4, name: '‡∏ò‡∏≤‡∏£‡πÇ‡∏ï', name_en: 'Thanto', province_id: 75},
          {id: 5, name: '‡∏¢‡∏∞‡∏´‡∏≤', name_en: 'Yaha', province_id: 75},
          {id: 6, name: '‡∏£‡∏≤‡∏°‡∏±‡∏ô', name_en: 'Raman', province_id: 75},
          {id: 7, name: '‡∏Å‡∏≤‡∏ö‡∏±‡∏á', name_en: 'Kabang', province_id: 75},
          {id: 8, name: '‡∏Å‡∏£‡∏á‡∏õ‡∏¥‡∏ô‡∏±‡∏á', name_en: 'Krong Pinang', province_id: 75}
        ],
        76: [ // ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ - All 13 Official Districts - Southern Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', name_en: 'Mueang Narathiwat', province_id: 76},
          {id: 2, name: '‡∏ï‡∏≤‡∏Å‡πÉ‡∏ö', name_en: 'Tak Bai', province_id: 76},
          {id: 3, name: '‡∏ö‡∏≤‡πÄ‡∏à‡∏≤‡∏∞', name_en: 'Bacho', province_id: 76},
          {id: 4, name: '‡∏¢‡∏µ‡πà‡∏á‡∏≠', name_en: 'Yi-ngo', province_id: 76},
          {id: 5, name: '‡∏£‡∏∞‡πÅ‡∏á‡∏∞', name_en: 'Ra-ngae', province_id: 76},
          {id: 6, name: '‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏≤‡∏∞', name_en: 'Rueso', province_id: 76},
          {id: 7, name: '‡∏®‡∏£‡∏µ‡∏™‡∏≤‡∏Ñ‡∏£', name_en: 'Si Sakhon', province_id: 76},
          {id: 8, name: '‡πÅ‡∏ß‡πâ‡∏á', name_en: 'Waeng', province_id: 76},
          {id: 9, name: '‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô', name_en: 'Sukhirin', province_id: 76},
          {id: 10, name: '‡∏™‡∏∏‡πÑ‡∏´‡∏á‡πÇ‡∏Å-‡∏•‡∏Å', name_en: 'Su-ngai Kolok', province_id: 76},
          {id: 11, name: '‡∏™‡∏∏‡πÑ‡∏´‡∏á‡∏õ‡∏≤‡∏î‡∏µ', name_en: 'Su-ngai Padi', province_id: 76},
          {id: 12, name: '‡∏à‡∏∞‡πÅ‡∏ô‡∏∞', name_en: 'Chanae', province_id: 76},
          {id: 13, name: '‡πÄ‡∏à‡∏≤‡∏∞‡πÑ‡∏≠‡∏£‡πâ‡∏≠‡∏á', name_en: 'Cho-airong', province_id: 76}
        ],
        77: [ // ‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨ - All 8 Official Districts - Northeast Province 2024
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', name_en: 'Mueang Bueng Kan', province_id: 77},
          {id: 2, name: '‡∏ö‡∏∂‡∏á‡πÇ‡∏Ç‡∏á‡∏´‡∏•‡∏á', name_en: 'Bueng Khong Long', province_id: 77},
          {id: 3, name: '‡∏®‡∏£‡∏µ‡∏ß‡∏¥‡πÑ‡∏•', name_en: 'Si Wilai', province_id: 77},
          {id: 4, name: '‡πÇ‡∏ã‡πà‡∏û‡∏¥‡∏™‡∏±‡∏¢', name_en: 'So Phisai', province_id: 77},
          {id: 5, name: '‡πÄ‡∏ã‡∏Å‡∏≤', name_en: 'Seka', province_id: 77},
          {id: 6, name: '‡∏õ‡∏≤‡∏Å‡∏Ñ‡∏≤‡∏î', name_en: 'Pak Khat', province_id: 77},
          {id: 7, name: '‡πÇ‡∏û‡∏ô‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Phon Charoen', province_id: 77},
          {id: 8, name: '‡∏ö‡∏∏‡πà‡∏á‡∏Ñ‡∏•‡πâ‡∏≤', name_en: 'Bung Khla', province_id: 77}
        ],
        // Generic district pattern for provinces without specific data
        '_default': [
          {id: 1, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á{province_name}', name_en: 'Mueang {province_name_en}', province_id: 0}
        ]
      };

      // Comprehensive sub-districts data for Thai provinces
      window.THAI_ADDRESS_DATA.subDistricts = {
        '74-9': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏¢‡∏∞‡∏£‡∏±‡∏á
          {id: 1, name: '‡∏¢‡∏∞‡∏£‡∏±‡∏á', name_en: 'Yarang', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 2, name: '‡∏™‡∏∞‡∏î‡∏≤‡∏ß‡∏≤', name_en: 'Sadawa', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 3, name: '‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏ô', name_en: 'Prachan', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 4, name: '‡∏™‡∏∞‡∏ô‡∏≠', name_en: 'Sano', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 5, name: '‡∏£‡∏∞‡πÅ‡∏ß‡πâ‡∏á', name_en: 'Rawaeng', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 6, name: '‡∏õ‡∏¥‡∏ï‡∏π‡∏°‡∏∏‡∏î‡∏µ', name_en: 'Pitumudi', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 7, name: '‡∏ß‡∏±‡∏î', name_en: 'Wat', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 8, name: '‡∏Å‡∏£‡∏∞‡πÇ‡∏î', name_en: 'Krado', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 9, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Khlong Mai', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 10, name: '‡πÄ‡∏°‡∏≤‡∏∞‡∏°‡∏≤‡∏ß‡∏µ', name_en: 'Moh Mawi', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 11, name: '‡∏Å‡∏≠‡∏•‡∏≥', name_en: 'Ko Lam', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 12, name: '‡πÄ‡∏Ç‡∏≤‡∏ï‡∏π‡∏°', name_en: 'Khao Tum', province_id: 74, district_id: 9, zipcode: '94160'}
        ],
        '74-2': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå
          {id: 1, name: '‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Khok Pho', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 2, name: '‡∏°‡∏∞‡∏Å‡∏£‡∏π‡∏î', name_en: 'Makrut', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 3, name: '‡∏ö‡∏≤‡∏á‡πÇ‡∏Å‡∏£‡∏∞', name_en: 'Bang Kro', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 4, name: '‡∏õ‡πà‡∏≤‡∏ö‡∏≠‡∏ô', name_en: 'Pabon', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 5, name: '‡∏ó‡∏£‡∏≤‡∏¢‡∏Ç‡∏≤‡∏ß', name_en: 'Sai Khao', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 6, name: '‡∏ô‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏π‡πà', name_en: 'Na Pradu', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 7, name: '‡∏õ‡∏≤‡∏Å‡∏•‡πà‡∏≠', name_en: 'Paklo', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 8, name: '‡∏ó‡∏∏‡πà‡∏á‡∏û‡∏•‡∏≤', name_en: 'Thungphla', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 9, name: '‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠', name_en: 'Tha Ruea', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 10, name: '‡∏ô‡∏≤‡πÄ‡∏Å‡∏ï‡∏∏', name_en: 'Naket', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 11, name: '‡∏Ñ‡∏ß‡∏ô‡πÇ‡∏ô‡∏£‡∏µ', name_en: 'Khuan Nori', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 12, name: '‡∏ä‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏Å', name_en: 'Chang Hai Tok', province_id: 74, district_id: 2, zipcode: '94120'}
        ],
        '74-3': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å
          {id: 1, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏õ‡∏≤‡∏∞', name_en: 'Ko Po', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 2, name: '‡∏Ñ‡∏≠‡∏•‡∏≠‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á', name_en: 'Kholo Tanyong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 3, name: '‡∏î‡∏≠‡∏ô‡∏£‡∏±‡∏Å', name_en: 'Don Rak', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 4, name: '‡∏î‡∏≤‡πÇ‡∏ï‡πä‡∏∞', name_en: 'Dato', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 5, name: '‡∏ï‡∏∏‡∏¢‡∏á', name_en: 'Tuyong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 6, name: '‡∏ó‡πà‡∏≤‡∏Å‡∏≥‡∏ä‡∏≥', name_en: 'Tha Kamcham', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 7, name: '‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á', name_en: 'Bo Thong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 8, name: '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏≤', name_en: 'Bang Khao', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 9, name: '‡∏ö‡∏≤‡∏á‡∏ï‡∏≤‡∏ß‡∏≤', name_en: 'Bang Tawa', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 10, name: '‡∏õ‡∏∏‡πÇ‡∏•‡∏∞‡∏õ‡∏∏‡πÇ‡∏¢', name_en: 'Pulo Puyo', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 11, name: '‡∏¢‡∏≤‡∏ö‡∏µ', name_en: 'Yabi', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 12, name: '‡∏•‡∏¥‡∏õ‡∏∞‡∏™‡∏∞‡πÇ‡∏á', name_en: 'Lipa Sa-ngo', province_id: 74, district_id: 3, zipcode: '94130'}
        ],
        '74-4': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞
          {id: 1, name: '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', name_en: 'Panare', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 2, name: '‡∏ó‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°', name_en: 'Tha Kham', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 3, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å', name_en: 'Ban Nok', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 4, name: '‡∏î‡∏≠‡∏ô', name_en: 'Don', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 5, name: '‡∏Ñ‡∏ß‡∏ô', name_en: 'Khuan', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 6, name: '‡∏ó‡πà‡∏≤‡∏ô‡πâ‡∏≥', name_en: 'Tha Nam', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 7, name: '‡∏Ñ‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏∑‡∏≠', name_en: 'Khok Krabue', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 8, name: '‡∏û‡πà‡∏≠‡∏°‡∏¥‡πà‡∏á', name_en: 'Pho Ming', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 9, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', name_en: 'Ban Klang', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 10, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏ö‡πà‡∏≠', name_en: 'Ban Nam Bo', province_id: 74, district_id: 4, zipcode: '94130'}
        ],
        '74-5': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏°‡∏≤‡∏¢‡∏≠
          {id: 1, name: '‡∏°‡∏≤‡∏¢‡∏≠', name_en: 'Mayo', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 2, name: '‡∏ñ‡∏ô‡∏ô', name_en: 'Thanon', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 3, name: '‡∏ï‡∏£‡∏±‡∏á', name_en: 'Trang', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 4, name: '‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡∏∞', name_en: 'Krawa', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 5, name: '‡∏•‡∏∏‡πÇ‡∏ö‡∏∞‡∏¢‡∏¥‡πÑ‡∏£', name_en: 'Lubo Yirai', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 6, name: '‡∏•‡∏≤‡∏á‡∏≤', name_en: 'La-nga', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 7, name: '‡∏Å‡∏£‡∏∞‡πÄ‡∏™‡∏≤‡∏∞', name_en: 'Kraso', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 8, name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏à‡∏±‡∏ô', name_en: 'Ko Chan', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 9, name: '‡∏õ‡∏∞‡πÇ‡∏î', name_en: 'Pado', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 10, name: '‡∏™‡∏≤‡∏Ñ‡∏≠‡∏ö‡∏ô', name_en: 'Sakho Bon', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 11, name: '‡∏™‡∏≤‡∏Ñ‡∏≠‡πÉ‡∏ï‡πâ', name_en: 'Sakho Tai', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 12, name: '‡∏™‡∏∞‡∏Å‡∏≥', name_en: 'Sakam', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 13, name: '‡∏õ‡∏≤‡∏ô‡∏±‡∏ô', name_en: 'Panan', province_id: 74, district_id: 5, zipcode: '94140'}
        ],
        '74-6': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏ó‡∏∏‡πà‡∏á‡∏¢‡∏≤‡∏á‡πÅ‡∏î‡∏á
          {id: 1, name: '‡∏ï‡∏∞‡πÇ‡∏•‡∏∞‡πÅ‡∏°‡∏∞‡∏ô‡∏≤', name_en: 'Talo Maena', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 2, name: '‡∏û‡∏¥‡πÄ‡∏ó‡∏ô', name_en: 'Phithen', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 3, name: '‡∏ô‡πâ‡∏≥‡∏î‡∏≥', name_en: 'Nam Dam', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 4, name: '‡∏õ‡∏≤‡∏Å‡∏π', name_en: 'Paku', province_id: 74, district_id: 6, zipcode: '94150'}
        ],
        '74-7': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏™‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏µ
          {id: 1, name: '‡∏ï‡∏∞‡∏•‡∏∏‡∏ö‡∏±‡∏ô', name_en: 'Taluban', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 2, name: '‡∏ï‡∏∞‡∏ö‡∏¥‡πâ‡∏á', name_en: 'Tabing', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 3, name: '‡∏õ‡∏∞‡πÄ‡∏™‡∏¢‡∏∞‡∏ß‡∏≠', name_en: 'Pase Yawo', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 4, name: '‡∏ö‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤', name_en: 'Bang Kao', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 5, name: '‡∏ö‡∏∑‡∏≠‡πÄ‡∏£‡∏∞', name_en: 'Buere', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 6, name: '‡πÄ‡∏ï‡∏£‡∏≤‡∏∞‡∏ö‡∏≠‡∏ô', name_en: 'Trobon', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 7, name: '‡∏Å‡∏∞‡∏î‡∏∏‡∏ô‡∏á', name_en: 'Kadunong', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 8, name: '‡∏•‡∏∞‡∏´‡∏≤‡∏£', name_en: 'Lahan', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 9, name: '‡∏°‡∏∞‡∏ô‡∏±‡∏á‡∏î‡∏≤‡∏•‡∏≥', name_en: 'Manang Dalam', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 10, name: '‡πÅ‡∏õ‡πâ‡∏ô', name_en: 'Paen', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 11, name: '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏•‡πâ‡∏≤', name_en: 'Thungkhla', province_id: 74, district_id: 7, zipcode: '94110'}
        ],
        '74-8': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡πÑ‡∏°‡πâ‡πÅ‡∏Å‡πà‡∏ô
          {id: 1, name: '‡πÑ‡∏ó‡∏£‡∏ó‡∏≠‡∏á', name_en: 'Saithong', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 2, name: '‡πÑ‡∏°‡πâ‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Mai Kaen', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 3, name: '‡∏ï‡∏∞‡πÇ‡∏•‡∏∞‡πÑ‡∏Å‡∏£‡∏ó‡∏≠‡∏á', name_en: 'Talo Kraithong', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 4, name: '‡∏î‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', name_en: 'Donsai', province_id: 74, district_id: 8, zipcode: '94170'}
        ],
        '74-10': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏¢‡∏∞‡∏´‡∏£‡∏¥‡πà‡∏á
          {id: 1, name: '‡∏ï‡∏∞‡πÇ‡∏•‡∏∞', name_en: 'Talo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 2, name: '‡∏ï‡∏∞‡πÇ‡∏•‡∏∞‡∏Å‡∏≤‡πÇ‡∏õ‡∏£‡πå', name_en: 'Talo Kapo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 3, name: '‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏î‡∏≤‡∏•‡∏≠', name_en: 'Tanyong Dalo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 4, name: '‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏à‡∏∂‡∏á‡∏á‡∏≤', name_en: 'Tanyong Chueng-nga', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 5, name: '‡∏ï‡∏≠‡∏´‡∏•‡∏±‡∏á', name_en: 'Tolang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 6, name: '‡∏ï‡∏≤‡πÅ‡∏Å‡∏∞', name_en: 'Takae', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 7, name: '‡∏ï‡∏≤‡∏•‡∏µ‡∏≠‡∏≤‡∏¢‡∏£‡πå', name_en: 'Tali-ai', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 8, name: '‡∏¢‡∏≤‡∏°‡∏π', name_en: 'Yamu', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 9, name: '‡∏ö‡∏≤‡∏á‡∏õ‡∏π', name_en: 'Bang Pu', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 10, name: '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏£‡∏ï', name_en: 'Nong Raet', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 11, name: '‡∏õ‡∏¥‡∏¢‡∏≤‡∏°‡∏∏‡∏°‡∏±‡∏á', name_en: 'Piya Mumang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 12, name: '‡∏õ‡∏∏‡∏•‡∏≤‡∏Å‡∏á', name_en: 'Pulakong', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 13, name: '‡∏ö‡∏≤‡πÇ‡∏•‡∏¢', name_en: 'Baloi', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 14, name: '‡∏™‡∏≤‡∏ö‡∏±‡∏ô', name_en: 'Saban', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 15, name: '‡∏°‡∏∞‡∏ô‡∏±‡∏á‡∏¢‡∏á', name_en: 'Manang Yong', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 16, name: '‡∏£‡∏≤‡∏ï‡∏≤‡∏õ‡∏±‡∏ô‡∏¢‡∏±‡∏á', name_en: 'Rata Panyang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 17, name: '‡∏à‡∏∞‡∏£‡∏±‡∏á', name_en: 'Charang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 18, name: '‡πÅ‡∏´‡∏•‡∏°‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Laem Pho', province_id: 74, district_id: 10, zipcode: '94150'}
        ],
        '74-11': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô
          {id: 1, name: '‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô', name_en: 'Mae Lan', province_id: 74, district_id: 11, zipcode: '94180'},
          {id: 2, name: '‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢', name_en: 'Muang Tia', province_id: 74, district_id: 11, zipcode: '94180'},
          {id: 3, name: '‡∏õ‡πà‡∏≤‡πÑ‡∏£‡πà', name_en: 'Parai', province_id: 74, district_id: 11, zipcode: '94180'}
        ],
        '74-12': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡∏Å‡∏∞‡∏û‡πâ‡∏≠
          {id: 1, name: '‡∏Å‡∏∞‡∏£‡∏∏‡∏ö‡∏µ', name_en: 'Karubi', province_id: 74, district_id: 12, zipcode: '94160'},
          {id: 2, name: '‡∏ï‡∏∞‡πÇ‡∏•‡∏∞‡∏î‡∏∑‡∏≠‡∏£‡∏≤‡∏°‡∏±‡∏ô', name_en: 'Talo Dueraman', province_id: 74, district_id: 12, zipcode: '94160'},
          {id: 3, name: '‡∏õ‡∏•‡πà‡∏≠‡∏á‡∏´‡∏≠‡∏¢', name_en: 'Plong Hoi', province_id: 74, district_id: 12, zipcode: '94160'}
        ],
        '74-1': [ // ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ -> ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ
          {id: 1, name: '‡∏™‡∏∞‡∏ö‡∏≤‡∏£‡∏±‡∏á', name_en: 'Sabarang', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 2, name: '‡∏≠‡∏≤‡πÄ‡∏ô‡∏≤‡∏∞‡∏£‡∏π', name_en: 'Ano Ru', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 3, name: '‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏ï‡∏¥‡∏Å‡∏≠', name_en: 'Chabang Tiko', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 4, name: '‡∏ö‡∏≤‡∏ô‡∏≤', name_en: 'Bana', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 5, name: '‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏•‡∏∏‡πÇ‡∏•‡∏∞', name_en: 'Tanyong Lulo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 6, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏ô‡∏¥‡∏á', name_en: 'Khlong Maning', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 7, name: '‡∏Å‡∏∞‡∏°‡∏¥‡∏¢‡∏≠', name_en: 'Kamiyo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 8, name: '‡∏ö‡∏≤‡∏£‡∏≤‡πÇ‡∏´‡∏°', name_en: 'Barahom', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 9, name: '‡∏õ‡∏∞‡∏Å‡∏≤‡∏Æ‡∏∞‡∏£‡∏±‡∏á', name_en: 'Paka Harang', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 10, name: '‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏•', name_en: 'Ru Samilae', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 11, name: '‡∏ï‡∏∞‡∏•‡∏∏‡πÇ‡∏ö‡∏∞', name_en: 'Talubo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 12, name: '‡∏ö‡∏≤‡∏£‡∏≤‡πÄ‡∏Æ‡∏≤‡∏∞', name_en: 'Baraho', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 13, name: '‡∏õ‡∏∏‡∏¢‡∏∏‡∏î', name_en: 'Puyut', province_id: 74, district_id: 1, zipcode: '94000'}
        ],
        '1-1': [ // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø -> ‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£
          {id: 1, name: '‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏±‡∏á', name_en: 'Phra Borom Maha Ratchawang', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 2, name: '‡∏ß‡∏±‡∏á‡∏ö‡∏π‡∏£‡∏û‡∏≤‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå', name_en: 'Wang Burapha Phirom', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 3, name: '‡∏ß‡∏±‡∏î‡∏£‡∏≤‡∏ä‡∏ö‡∏û‡∏¥‡∏ò', name_en: 'Wat Ratchabophit', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 4, name: '‡∏™‡∏≥‡∏£‡∏≤‡∏ç‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå', name_en: 'Samran Rat', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 5, name: '‡∏®‡∏≤‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏∑‡∏≠', name_en: 'San Chao Pho Seua', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 6, name: '‡πÄ‡∏™‡∏≤‡∏ä‡∏¥‡∏á‡∏ä‡πâ‡∏≤', name_en: 'Sao Chingcha', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 7, name: '‡∏ö‡∏ß‡∏£‡∏ô‡∏¥‡πÄ‡∏ß‡∏®', name_en: 'Bowon Niwet', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 8, name: '‡∏ï‡∏•‡∏≤‡∏î‡∏¢‡∏≠‡∏î', name_en: 'Talat Yot', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 9, name: '‡∏ä‡∏ô‡∏∞‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', name_en: 'Chana Songkhram', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 10, name: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', name_en: 'Phra Nakhon', province_id: 1, district_id: 1, zipcode: '10200'}
        ],
        '38-1': [ // ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
          {id: 1, name: '‡∏®‡∏£‡∏µ‡∏†‡∏π‡∏°‡∏¥', name_en: 'Si Phum', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 2, name: '‡∏û‡∏£‡∏∞‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Phra Singh', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 3, name: '‡∏´‡∏≤‡∏¢‡∏¢‡∏≤', name_en: 'Haiya', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 4, name: '‡∏ä‡πà‡∏≤‡∏á‡∏°‡πà‡∏≠‡∏¢', name_en: 'Chang Moi', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 5, name: '‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏•‡∏≤‡∏ô', name_en: 'Chang Khlan', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 6, name: '‡∏ß‡∏±‡∏î‡πÄ‡∏Å‡∏ï', name_en: 'Wat Ket', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 7, name: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å', name_en: 'Chang Phueak', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 8, name: '‡∏™‡∏∏‡πÄ‡∏ó‡∏û', name_en: 'Suthep', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 9, name: '‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏µ‡∏¢‡∏∞', name_en: 'Mae Hia', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 10, name: '‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ô', name_en: 'Pa Tan', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 11, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≠‡∏¢', name_en: 'Nong Hoi', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 12, name: '‡∏ó‡πà‡∏≤‡∏®‡∏≤‡∏•‡∏≤', name_en: 'Tha Sala', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 13, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πà‡∏á', name_en: 'Nong Pa Khrang', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 14, name: '‡∏ü‡πâ‡∏≤‡∏Æ‡πà‡∏≤‡∏°', name_en: 'Fa Ham', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 15, name: '‡∏õ‡πà‡∏≤‡πÅ‡∏î‡∏î', name_en: 'Pa Daet', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 16, name: '‡∏™‡∏±‡∏ô‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠', name_en: 'San Phi Suea', province_id: 38, district_id: 1, zipcode: '50300'}
        ],
        '11-4': [ // ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ -> ‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á (Pattaya area)
          {id: 1, name: '‡∏ö‡∏≤‡∏á‡∏•‡∏∞‡∏°‡∏∏‡∏á', name_en: 'Bang Lamung', province_id: 11, district_id: 4, zipcode: '20150'},
          {id: 2, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏£‡∏∑‡∏≠', name_en: 'Nong Prue', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 3, name: '‡∏û‡∏±‡∏ó‡∏¢‡∏≤', name_en: 'Pattaya', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 4, name: '‡∏ö‡πâ‡∏≠‡∏á‡∏û‡∏£‡∏∞', name_en: 'Bong Phra', province_id: 11, district_id: 4, zipcode: '20150'},
          {id: 5, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡πÑ‡∏ï', name_en: 'Nong Plalai', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 6, name: '‡∏ï‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏ö', name_en: 'Takhiab', province_id: 11, district_id: 4, zipcode: '20260'}
        ],
        '70-9': [ // ‡∏™‡∏á‡∏Ç‡∏•‡∏≤ -> ‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà
          {id: 1, name: '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', name_en: 'Hat Yai', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 2, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏´‡∏≠‡∏¢', name_en: 'Khlong Hoy', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 3, name: '‡∏Ñ‡∏ß‡∏ô‡∏•‡∏±‡∏á', name_en: 'Khuan Lang', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 4, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏≠‡∏π‡πà‡∏ï‡∏∞‡πÄ‡∏û‡∏≤', name_en: 'Khlong U Taphao', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 5, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏•‡∏≤', name_en: 'Khlong La', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 6, name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏£‡∏∏', name_en: 'Ban Phru', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 7, name: '‡∏ï‡πâ‡∏ô‡∏´‡∏¢‡∏ß‡∏Å', name_en: 'Ton Ngao', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 8, name: '‡∏Ñ‡∏π‡∏Ç‡∏ß‡∏≤‡∏á', name_en: 'Khu Khwang', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 9, name: '‡∏Ñ‡∏≠‡∏´‡∏á‡∏™‡πå', name_en: 'Kho Hong', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 10, name: '‡∏ó‡πâ‡∏≤‡∏Å‡∏≥', name_en: 'Tha Kham', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 11, name: '‡∏°‡∏∞‡∏Ç‡∏≤‡∏°‡πÄ‡∏ï‡∏µ‡πâ‡∏¢', name_en: 'Makham Tia', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 12, name: '‡∏ô‡∏≤‡∏°‡∏ô', name_en: 'Namom', province_id: 70, district_id: 9, zipcode: '90110'}
        ],
        '67-4': [ // ‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ -> ‡πÄ‡∏Å‡∏≤‡∏∞‡∏™‡∏°‡∏∏‡∏¢ - Major Tourist Hub
          {id: 1, name: '‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Na Mueang', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 2, name: '‡∏ö‡πà‡∏≠‡∏ú‡∏∏‡∏î', name_en: 'Bo Phut', province_id: 67, district_id: 4, zipcode: '84320'},
          {id: 3, name: '‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏î', name_en: 'Maret', province_id: 67, district_id: 4, zipcode: '84310'},
          {id: 4, name: '‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏°', name_en: 'Taling Ngam', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 5, name: '‡∏•‡∏¥‡∏õ‡∏∞‡∏ô‡πâ‡∏≠‡∏¢', name_en: 'Lipa Noi', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 6, name: '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', name_en: 'Ang Thong', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 7, name: '‡πÄ‡∏â‡∏ß‡∏á', name_en: 'Chaweng', province_id: 67, district_id: 4, zipcode: '84320'},
          {id: 8, name: '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', name_en: 'Bang Rak', province_id: 67, district_id: 4, zipcode: '84320'}
        ],
        '1-15': [ // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ -> ‡πÄ‡∏Ç‡∏ï‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô - CBD
          {id: 1, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', name_en: 'Pathum Wan', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 2, name: '‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ', name_en: 'Lumphini', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 3, name: '‡∏£‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Rong Mueang', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 4, name: '‡∏ß‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Wang Mai', province_id: 1, district_id: 15, zipcode: '10330'}
        ],
        '1-16': [ // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ -> ‡πÄ‡∏Ç‡∏ï‡∏ß‡∏±‡∏í‡∏ô‡∏≤ - Business District
          {id: 1, name: '‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ', name_en: 'Lumphini', province_id: 1, district_id: 16, zipcode: '10330'},
          {id: 2, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', name_en: 'Khlong Toei', province_id: 1, district_id: 16, zipcode: '10110'},
          {id: 3, name: '‡∏Ñ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ô', name_en: 'Khlong Tan', province_id: 1, district_id: 16, zipcode: '10110'},
          {id: 4, name: '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', name_en: 'Phra Khanong', province_id: 1, district_id: 16, zipcode: '10110'}
        ],
        '38-1': [ // ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà - Old City & Business Center
          {id: 1, name: '‡∏®‡∏£‡∏µ‡∏†‡∏π‡∏°‡∏¥', name_en: 'Si Phum', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 2, name: '‡∏û‡∏£‡∏∞‡∏™‡∏¥‡∏á‡∏´‡πå', name_en: 'Phra Sing', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 3, name: '‡∏´‡∏≤‡∏¢‡∏¢‡∏≤', name_en: 'Haiya', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 4, name: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô', name_en: 'Chang Khlan', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 5, name: '‡∏ß‡∏±‡∏î‡πÄ‡∏Å‡∏ï', name_en: 'Wat Ket', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 6, name: '‡∏ä‡πà‡∏≤‡∏á‡∏°‡∏±‡πà‡∏ß', name_en: 'Chang Moi', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 7, name: '‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô', name_en: 'Chang Phueak', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 8, name: '‡∏™‡∏∏‡πÄ‡∏ó‡∏û', name_en: 'Su Thep', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 9, name: '‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏µ‡∏¢‡∏∞', name_en: 'Mae Hia', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 10, name: '‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ô', name_en: 'Pa Tan', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 11, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≠‡∏¢', name_en: 'Nong Hoi', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 12, name: '‡∏ó‡πà‡∏≤‡∏®‡∏≤‡∏•‡∏≤', name_en: 'Tha Sala', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 13, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏õ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πà‡∏á', name_en: 'Nong Pa Khrang', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 14, name: '‡∏´‡πâ‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Huai Kaeo', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 15, name: '‡∏™‡∏±‡∏ô‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠', name_en: 'San Phi Suea', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 16, name: '‡∏ü‡πâ‡∏≤‡∏Æ‡πà‡∏≤‡∏°', name_en: 'Fa Ham', province_id: 38, district_id: 1, zipcode: '50000'}
        ],
        '75-4': [ // ‡∏¢‡∏∞‡∏•‡∏≤ -> ‡∏ò‡∏≤‡∏£‡πÇ‡∏ï - Correct Official Sub-districts 2024
          {id: 1, name: '‡∏ï‡∏≥‡∏ö‡∏•‡∏ò‡∏≤‡∏£‡πÇ‡∏ï', name_en: 'Thanto', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 2, name: '‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏´‡∏£', name_en: 'Ban Rae', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 3, name: '‡∏ï‡∏≥‡∏ö‡∏•‡∏Ñ‡∏µ‡∏£‡∏µ‡πÄ‡∏Ç‡∏ï', name_en: 'Khirikhet', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 4, name: '‡∏ï‡∏≥‡∏ö‡∏•‡πÅ‡∏°‡πà‡∏´‡∏ß‡∏≤‡∏î', name_en: 'Mae Wad', province_id: 75, district_id: 4, zipcode: '95170'}
        ]
      };

      // Initialize postal code mappings
      window.THAI_ADDRESS_DATA.postalCodes = {
        // Common postal codes by region
        bangkok: ['10100', '10110', '10120', '10130', '10140', '10150', '10160', '10170', '10200', '10210', '10220', '10230', '10240', '10250', '10260', '10270', '10300', '10310', '10320', '10330', '10340', '10350', '10360', '10370', '10400', '10500', '10510', '10520', '10530', '10540', '10550', '10560', '10600', '10700', '10800', '10900'],
        pattani: ['94000', '94110', '94120', '94130', '94140', '94150', '94160', '94170', '94180', '94190'],
        yala: ['95110', '95130', '95140', '95150', '95160', '95170', '95180'],
        chiang_mai: ['50000', '50100', '50110', '50120', '50130', '50140', '50150', '50160', '50170', '50180', '50190', '50200', '50210', '50220', '50230', '50240', '50250', '50260', '50270', '50280', '50290', '50300'],
        chonburi: ['20000', '20110', '20120', '20130', '20140', '20150', '20160', '20170', '20180', '20190', '20230', '20250', '20260', '20270'],
        songkhla: ['90000', '90110', '90120', '90130', '90140', '90150', '90160', '90170', '90180', '90190', '90210', '90220', '90230', '90240', '90250', '90260'],
        surat_thani: ['84000', '84100', '84110', '84120', '84130', '84140', '84150', '84160', '84170', '84180', '84190', '84200', '84210', '84220', '84230', '84240', '84250', '84260', '84270', '84280', '84290', '84310', '84320', '84330', '84340', '84360', '84390'],
        khon_kaen: ['40000', '40110', '40120', '40130', '40140', '40150', '40160', '40170', '40180', '40190', '40210', '40220', '40230', '40240', '40250', '40260', '40270', '40280', '40290', '40310', '40320', '40330', '40340', '40350', '40360', '40370'],
        nakhon_ratchasima: ['30000', '30110', '30120', '30130', '30140', '30150', '30160', '30170', '30180', '30190', '30210', '30220', '30230', '30240', '30250', '30260', '30270', '30280', '30290', '30310', '30320', '30330', '30340', '30350', '30360', '30370', '30380', '30390', '30410', '30420', '30430', '30440'],
        udon_thani: ['41000', '41110', '41120', '41130', '41140', '41150', '41160', '41170', '41180', '41190', '41210', '41220', '41230', '41240', '41250', '41260', '41270', '41280', '41290', '41310', '41320'],
        rayong: ['21000', '21110', '21120', '21130', '21140', '21150', '21160', '21170', '21190'],
        nakhon_pathom: ['73000', '73110', '73120', '73130', '73140', '73150', '73160', '73170'],
        samut_prakan: ['10270', '10280', '10290', '10540', '10550', '10560', '10570', '10580', '10600', '10610'],
        nonthaburi: ['11000', '11110', '11120', '11130', '11140', '11150', '11160', '11170'],
        pathum_thani: ['12000', '12110', '12120', '12130', '12140', '12150', '12160', '12170'],
        buriram: ['31000', '31110', '31120', '31130', '31140', '31150', '31160', '31170', '31180', '31190', '31210', '31220', '31230', '31240', '31250', '31260', '31270', '31280', '31290', '31310', '31320', '31330', '31340'],
        ubon_ratchathani: ['34000', '34110', '34120', '34130', '34140', '34150', '34160', '34170', '34180', '34190', '34210', '34220', '34230', '34240', '34250', '34260', '34270', '34280', '34290', '34310', '34320', '34330', '34340', '34350', '34360'],
        chiang_rai: ['57000', '57110', '57120', '57130', '57140', '57150', '57160', '57170', '57180', '57190', '57210', '57220', '57230', '57240', '57250', '57260', '57270', '57280'],
        nakhon_si_thammarat: ['80000', '80110', '80120', '80130', '80140', '80150', '80160', '80170', '80180', '80190', '80210', '80220', '80230', '80240', '80250', '80260', '80270', '80280', '80290', '80310', '80320', '80330', '80340']
      };

      console.log('‚úÖ Comprehensive Thai address data initialized:');
      console.log('  - Provinces:', window.THAI_ADDRESS_DATA.provinces.length);
      console.log('  - District datasets:', Object.keys(window.THAI_ADDRESS_DATA.districts).length);
      console.log('  - Sub-district datasets:', Object.keys(window.THAI_ADDRESS_DATA.subDistricts).length);
      console.log('  - Postal code regions:', Object.keys(window.THAI_ADDRESS_DATA.postalCodes).length);
      console.log('  - Total comprehensive coverage for Thai address system');

      // Auto-generate remaining districts and sub-districts for provinces without data
      autoGenerateAddressData();
    }

    // =================== SEARCH AND HELPER FUNCTIONS ===================

    function searchProvinces(query) {
      const normalizedQuery = query.toLowerCase();
      return window.THAI_ADDRESS_DATA.provinces.filter(province =>
        province.name.toLowerCase().includes(normalizedQuery) ||
        (province.name_en && province.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 10); // Limit to 10 results for performance
    }

    function searchDistricts(provinceId, query) {
      const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];
      const normalizedQuery = query.toLowerCase();
      return districts.filter(district =>
        district.name.toLowerCase().includes(normalizedQuery) ||
        (district.name_en && district.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 15); // Limit to 15 results for performance
    }

    function searchSubDistricts(provinceId, districtId, query) {
      const key = `${provinceId}-${districtId}`;
      const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
      const normalizedQuery = query.toLowerCase();
      return subDistricts.filter(subDistrict =>
        subDistrict.name.toLowerCase().includes(normalizedQuery) ||
        (subDistrict.name_en && subDistrict.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 20); // Limit to 20 results for performance
    }

    function getSelectedProvince(provinceName) {
      return window.THAI_ADDRESS_DATA.provinces.find(province =>
        province.name === provinceName
      );
    }

    function getSelectedDistrict(provinceId, districtName) {
      if (!provinceId) return null;
      const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];
      return districts.find(district => district.name === districtName);
    }

    function loadDistrictsForProvince(provinceId, districtDropdownRef) {
      console.log('üîç Loading districts for province:', provinceId);

      try {
        const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];

        if (districts.length === 0) {
          // Load generic districts if specific province data not available
          loadGenericDistricts(provinceId);
        }

        // Clear district input but don't trigger dropdown immediately
        const distInput = document.getElementById('district');
        if (distInput) {
          distInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠...';
        }

        console.log('‚úÖ Districts loaded for province', provinceId, ':', districts.length, 'districts');
      } catch (error) {
        console.error('‚ùå Failed to load districts:', error);
      }
    }

    function loadSubDistrictsForDistrict(provinceId, districtId, tambonDropdownRef) {
      console.log('üîç Loading sub-districts for province:', provinceId, 'district:', districtId);

      try {
        const key = `${provinceId}-${districtId}`;
        const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];

        if (subDistricts.length === 0) {
          // Load generic sub-districts if specific district data not available
          loadGenericSubDistricts(provinceId, districtId);
        }

        // Clear sub-district input but don't trigger dropdown immediately
        const subInput = document.getElementById('subDistrict');
        if (subInput) {
          subInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡∏ö‡∏•...';
        }

        console.log('‚úÖ Sub-districts loaded for district', districtId, ':', subDistricts.length, 'sub-districts');
      } catch (error) {
        console.error('‚ùå Failed to load sub-districts:', error);
      }
    }

    function autoGenerateAddressData() {
      console.log('ü§ñ Auto-generating missing address data...');

      // Generate districts for provinces without specific data
      window.THAI_ADDRESS_DATA.provinces.forEach(province => {
        if (!window.THAI_ADDRESS_DATA.districts[province.id]) {
          const genericDistricts = [
            {id: 1, name: `‡πÄ‡∏°‡∏∑‡∏≠‡∏á${province.name}`, name_en: `Mueang ${province.name_en}`, province_id: province.id}
          ];
          window.THAI_ADDRESS_DATA.districts[province.id] = genericDistricts;
        }
      });

      // Generate sub-districts for districts without specific data
      Object.keys(window.THAI_ADDRESS_DATA.districts).forEach(provinceId => {
        const districts = window.THAI_ADDRESS_DATA.districts[provinceId];
        districts.forEach(district => {
          const key = `${provinceId}-${district.id}`;
          if (!window.THAI_ADDRESS_DATA.subDistricts[key]) {
            const genericSubDistricts = [
              {
                id: 1,
                name: '‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
                name_en: 'Nai Mueang',
                province_id: parseInt(provinceId),
                district_id: district.id,
                zipcode: generateZipcode(provinceId)
              }
            ];
            window.THAI_ADDRESS_DATA.subDistricts[key] = genericSubDistricts;
          }
        });
      });

      console.log('‚úÖ Auto-generation completed');
    }

    function generateZipcode(provinceId) {
      // Generate postal codes based on province patterns
      const provinceInt = parseInt(provinceId);
      if (provinceInt === 1) return '10100'; // Bangkok
      if (provinceInt === 74) return '94000'; // Pattani
      if (provinceInt === 38) return '50000'; // Chiang Mai
      if (provinceInt === 11) return '20000'; // Chonburi
      if (provinceInt === 70) return '90000'; // Songkhla

      // Generate based on province number
      return (provinceInt * 1000 + 100).toString().padStart(5, '0');
    }

    function loadGenericDistricts(provinceId) {
      // This function is now handled by autoGenerateAddressData
      console.log('üìÅ Generic districts handled by auto-generation system');
    }

    function loadGenericSubDistricts(provinceId, districtId) {
      // Generic sub-districts for districts without specific data
      const key = `${provinceId}-${districtId}`;
      const genericSubDistricts = [
        {id: 1, name: '‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', name_en: 'Nai Mueang', province_id: provinceId, district_id: districtId, zipcode: null}
      ];

      if (!window.THAI_ADDRESS_DATA.subDistricts[key]) {
        window.THAI_ADDRESS_DATA.subDistricts[key] = genericSubDistricts;
      }
    }

    function getProvinceName(provinceId) {
      const province = window.THAI_ADDRESS_DATA.provinces.find(p => p.id === provinceId);
      return province ? province.name.replace(/^(‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î|‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û)/, '') : '';
    }

    function getProvinceNameEn(provinceId) {
      const province = window.THAI_ADDRESS_DATA.provinces.find(p => p.id === provinceId);
      return province ? province.name_en : '';
    }

    function clearDropdown(dropdown, placeholderText) {
      if (dropdown) {
        dropdown.innerHTML = `<div class="dropdown-loading">${placeholderText}</div>`;
        dropdown.classList.remove('hidden');
        setTimeout(() => {
          dropdown.classList.add('hidden');
        }, 1000);
      }
    }

    // Debounce function for search performance
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // =================== ENHANCED DROPDOWN SETUP FUNCTION ===================

    // Enhanced Dropdown Setup Function
    function setupEnhancedDropdown(input, dropdown, onSelect, options = {}) {
      let items = [];
      let selectedIndex = -1;
    
      const config = {
        searchDelay: options.searchDelay || 300,
        placeholder: options.placeholder || '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
        noResultsText: options.noResultsText || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        loadingText: options.loadingText || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'
      };

      // Input focus handler
      input.addEventListener('focus', () => {
        if (items.length > 0) {
          showItems(items);
        } else {
          showPlaceholder();
        }
      });

      // Click outside handler
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });

      // Keyboard navigation
      input.addEventListener('keydown', (e) => {
        const itemElements = dropdown.querySelectorAll('.dropdown-item');
    
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, itemElements.length - 1);
            updateSelection(itemElements);
            break;
          case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(itemElements);
            break;
          case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && itemElements[selectedIndex]) {
              const itemData = JSON.parse(itemElements[selectedIndex].dataset.item);
              onSelect(itemData);
              hideDropdown();
            }
            break;
          case 'Escape':
            e.preventDefault();
            hideDropdown();
            break;
        }
      });

      function showItems(itemList) {
        items = itemList || [];
        dropdown.innerHTML = '';

        if (!Array.isArray(itemList) || itemList.length === 0) {
          showNoResults();
          return;
        }

        itemList.forEach((item, index) => {
          if (!item) return; // Skip null/undefined items

          const div = document.createElement('div');
          div.className = 'dropdown-item';

          try {
            div.dataset.item = JSON.stringify(item);
          } catch (e) {
            console.warn('Failed to stringify item:', item);
            return;
          }

          // Safely sanitize display text and sub text to prevent XSS
          const displayText = (item.displayText || item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠').toString().replace(/[<>&"']/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'": '&#39;'}[m];
          });
          const subText = (item.subText || '').toString().replace(/[<>&"']/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'": '&#39;'}[m];
          });

          // Create main text element safely
          const mainDiv = document.createElement('div');
          mainDiv.className = 'dropdown-item-main';
          mainDiv.textContent = item.displayText || item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
          div.appendChild(mainDiv);

          // Create sub text element safely if exists
          if (item.subText) {
            const subDiv = document.createElement('div');
            subDiv.className = 'dropdown-item-sub';
            subDiv.textContent = item.subText;
            div.appendChild(subDiv);
          }

          div.addEventListener('click', () => {
            onSelect(item);
            hideDropdown();
          });

          dropdown.appendChild(div);
        });

        dropdown.classList.remove('hidden');
        selectedIndex = -1;
      }

      function showPlaceholder() {
        dropdown.innerHTML = '';

        // Create placeholder element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-loading';
        div.textContent = config.placeholder || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function showNoResults() {
        dropdown.innerHTML = '';

        // Create no results element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-no-results';
        div.textContent = config.noResultsText || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function showLoading() {
        dropdown.innerHTML = '';

        // Create loading element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-loading';
        div.textContent = config.loadingText || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function hideDropdown() {
        dropdown.classList.add('hidden');
        selectedIndex = -1;
      }

      function updateSelection(itemElements) {
        itemElements.forEach((el, index) => {
          el.classList.toggle('selected', index === selectedIndex);
        });
    
        if (selectedIndex >= 0 && itemElements[selectedIndex]) {
          itemElements[selectedIndex].scrollIntoView({ block: 'nearest' });
        }
      }

      return {
        setItems: (newItems) => {
          items = newItems;
        },
        close: hideDropdown,
        open: () => {
          if (items.length > 0) {
            showItems(items);
          } else {
            showPlaceholder();
          }
        }
      };
    }

    // Enhanced Zipcode Validation and Auto-complete
    function setupZipcodeValidation() {
      const zipInput = document.getElementById('zipcode');
      if (!zipInput) return;

      let isAutoFilled = false;

      // Input validation (allow only numbers, max 5 digits)
      zipInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 5) {
          value = value.substring(0, 5);
        }
        e.target.value = value;
    
        // If user manually types, mark as not auto-filled
        if (!isAutoFilled) {
          zipInput.dataset.userInput = 'true';
        }
        isAutoFilled = false;

        // Validate zipcode
        validateZipcode(value);
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      });

      // Paste event handler
      zipInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = e.clipboardData.getData('text');
        const cleaned = paste.replace(/\D/g, '').substring(0, 5);
        zipInput.value = cleaned;
        zipInput.dataset.userInput = 'true';
        validateZipcode(cleaned);
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      });

      // Auto-fill function
      zipInput.autoFill = function(zipcode) {
        isAutoFilled = true;
        zipInput.value = zipcode;
        zipInput.dataset.userInput = 'false';
        validateZipcode(zipcode);
    
        // Show auto-fill indicator
        showZipcodeStatus('‚úÖ ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'success');
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      };

      // Validation function
      zipInput.validateZipcode = validateZipcode;

      function validateZipcode(value) {
        const statusDiv = document.getElementById('zipcodeStatus');
        const iconSpan = document.getElementById('zipcodeIcon');
        const messageSpan = document.getElementById('zipcodeMessage');
    
        if (!statusDiv || !iconSpan || !messageSpan) return;

        // Remove all border classes
        zipInput.classList.remove('border-green-500', 'border-yellow-500', 'border-red-500');

        if (value.length === 0) {
          statusDiv.classList.add('hidden');
          return;
        }

        if (value.length === 5 && /^\d{5}$/.test(value)) {
          // Valid format
          zipInput.classList.add('border-green-500');
          showZipcodeStatus('‚úÖ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'success');
        } else if (value.length > 0 && value.length < 5) {
          // Incomplete
          zipInput.classList.add('border-yellow-500');
          showZipcodeStatus('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
        } else {
          // Invalid
          zipInput.classList.add('border-red-500');
          showZipcodeStatus('‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        }
      }

      function showZipcodeStatus(message, type) {
        const statusDiv = document.getElementById('zipcodeStatus');
        const iconSpan = document.getElementById('zipcodeIcon');
        const messageSpan = document.getElementById('zipcodeMessage');
    
        if (!statusDiv || !iconSpan || !messageSpan) return;

        statusDiv.className = `mt-1 text-xs status-${type}`;
        statusDiv.classList.remove('hidden');
    
        const parts = message.split(' ');
        iconSpan.textContent = parts[0];
        messageSpan.textContent = parts.slice(1).join(' ');
      }
    }

    // Load functions
    async function loadProvinces() {
      try {
        const response = await fetch(window.provinceAPI.provinces);
        const data = await response.json();
    
        // Handle different response formats
        let provinces = null;
        if (Array.isArray(data)) {
          // Direct array response
          provinces = data;
          console.log('‚úÖ Provinces loaded (direct array):', data.length);
        } else if (data.success && data.data && Array.isArray(data.data)) {
          // Wrapped response format
          provinces = data.data;
          console.log('‚úÖ Provinces loaded (wrapped):', data.data.length);
        } else {
          console.warn('Invalid province data received:', data);
          return;
        }
    
        // Store provinces for later use if needed
        window.loadedProvinces = provinces;
    
      } catch (error) {
        console.error('‚ùå Failed to load provinces:', error);
      }
    }

    async function loadAmphures(provinceId, districtDropdownRef) {
      try {
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
    
        if (!distInput || !distDD) return;

        // Validate provinceId
        if (!provinceId || isNaN(provinceId)) {
          console.error('‚ùå Invalid provinceId for amphure loading:', provinceId);
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà', 'error');
          }
          if (distInput) distInput.value = '';
          if (distDD) {
            distDD.innerHTML = '<div class="dropdown-no-results">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
            distDD.classList.remove('hidden');
          }
          return;
        }

        console.log('üîç Loading amphures for province:', provinceId);
        const apiUrl = window.provinceAPI.amphures(provinceId);
        console.log('üì° API URL:', apiUrl);
    
        const response = await fetch(apiUrl);
        console.log('üìä Response status:', response.status, response.statusText);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('üìã Raw amphure response data:', data);
        console.log('üìã Type of data:', typeof data, 'Is array:', Array.isArray(data));
    
        // Handle different response formats
        let amphures = null;
        if (Array.isArray(data)) {
          amphures = data;
          console.log('‚úÖ Using direct array format, count:', amphures.length);
        } else if (data.success && data.data && Array.isArray(data.data)) {
          amphures = data.data;
          console.log('‚úÖ Using wrapped format, count:', amphures.length);
        } else if (data.error) {
          console.warn('API Error for amphures:', data.error);
          // Clear district and subdistrict fields
          distInput.value = '';
          subInput.value = '';
          zipInput.value = '';
    
          // Show user-friendly message
          if (districtDropdownRef) {
            districtDropdownRef.setItems([]);
            const distDD = document.getElementById('districtDropdown');
            if (distDD) {
              distDD.innerHTML = '<div class="dropdown-no-results">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏µ‡πâ</div>';
              distDD.classList.remove('hidden');
            }
          }
          return;
        } else {
          console.warn('Invalid amphure data received:', data);
          return;
        }
    
        if (amphures && amphures.length > 0) {
          const items = amphures
            .filter(item => item && (item.amphure_id || item.id)) // Filter out invalid items
            .map(item => {
              const amphureId = item.amphure_id || item.id;
              // ‚úÖ Fix: ‡πÉ‡∏ä‡πâ provinceId ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å parameter ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ API response
              const actualProvinceId = item.province_id || provinceId;
              const name = item.name_th || item.name;
    
              // Debug logging for each item
              console.log('üîç Processing amphure item:', {
                original: item,
                processed: {
                  id: amphureId,
                  name: name,
                  province_id: actualProvinceId,
                  amphure_id: amphureId
                }
              });
    
              return {
                id: amphureId,
                name: name,
                province_id: actualProvinceId,  // ‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                amphure_id: amphureId,
                displayText: name,
                subText: `‡∏£‡∏´‡∏±‡∏™: ${amphureId} | ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${actualProvinceId}`
              };
            });
    
          // Make items available for dropdown search
          if (districtDropdownRef) {
            districtDropdownRef.setItems(items);
    
            // Setup district search
            distInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                districtDropdownRef.setItems(items);
                districtDropdownRef.open();
                return;
              }
    
              const filtered = items.filter(item =>
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
    
              districtDropdownRef.setItems(filtered);
              districtDropdownRef.open();
            }, 300));
          }
    
          console.log('‚úÖ Amphures loaded for province:', provinceId, '- Count:', items.length);
        } else {
          console.log('üîç No amphures found for province:', provinceId);
        }
      } catch (error) {
        console.error('‚ùå Failed to load amphures:', error);
    
        // Show user-friendly error message
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
    
        if (distInput) distInput.value = '';
        if (distDD) {
          distDD.innerHTML = '<div class="dropdown-no-results">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</div>';
          distDD.classList.remove('hidden');
        }
    
        // Clear subsequent fields
        const subInput = document.getElementById('subDistrict');
        const zipInput = document.getElementById('zipcode');
        if (subInput) subInput.value = '';
        if (zipInput) zipInput.value = '';
      }
    }

    async function loadTambons(provinceId, amphureId, tambonDropdownRef) {
      try {
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
    
        if (!subInput || !subDD) return;

        // Validate IDs
        if (!provinceId || isNaN(provinceId) || !amphureId || isNaN(amphureId)) {
          console.error('‚ùå Invalid provinceId or amphureId:', {provinceId, amphureId});
          if (subInput) subInput.value = '';
          if (subDD) {
            subDD.innerHTML = '<div class="dropdown-no-results">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
            subDD.classList.remove('hidden');
          }
          return;
        }

        console.log('üîç Loading tambons for province:', provinceId, 'amphure:', amphureId);
        const apiUrl = window.provinceAPI.tambons(provinceId, amphureId);
        console.log('üì° API URL:', apiUrl);
    
        const response = await fetch(apiUrl);
        console.log('üìä Response status:', response.status, response.statusText);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('üìã Raw response data:', data);
    
        // Handle different response formats
        let tambons = null;
        if (Array.isArray(data)) {
          tambons = data;
        } else if (data.success && data.data && Array.isArray(data.data)) {
          tambons = data.data;
        } else if (data.error) {
          console.warn('API Error for tambons:', data.error);
          // Clear subdistrict and zipcode fields
          subInput.value = '';
          zipInput.value = '';
    
          // Show user-friendly message
          if (tambonDropdownRef) {
            tambonDropdownRef.setItems([]);
            const subDD = document.getElementById('subDistrictDropdown');
            if (subDD) {
              subDD.innerHTML = '<div class="dropdown-no-results">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏µ‡πâ</div>';
              subDD.classList.remove('hidden');
            }
          }
          return;
        } else {
          console.warn('Invalid tambon data received:', data);
          return;
        }
    
        if (tambons && tambons.length > 0) {
          const items = tambons
            .filter(item => item && (item.tambon_id || item.id)) // Filter out invalid items
            .map(item => {
              const tambonId = item.tambon_id || item.id;
              const name = item.name_th || item.name;
              const zipcode = item.zip_code || item.zipcode || item.postal_code;
              return {
                id: tambonId,
                name: name,
                province_id: item.province_id,
                amphure_id: item.amphure_id,
                tambon_id: tambonId,
                zip_code: zipcode,
                zipcode: zipcode,
                postal_code: zipcode,
                displayText: name,
                subText: zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${zipcode}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
              };
            });
    
          // Make items available for dropdown search
          if (tambonDropdownRef) {
            tambonDropdownRef.setItems(items);
    
            // Setup tambon search
            subInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                tambonDropdownRef.setItems(items);
                tambonDropdownRef.open();
                return;
              }
    
              const filtered = items.filter(item =>
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
    
              tambonDropdownRef.setItems(filtered);
              tambonDropdownRef.open();
            }, 300));
          }
    
          console.log('‚úÖ Tambons loaded for amphure:', amphureId, '- Count:', items.length);
        } else {
          console.log('üîç No tambons found for amphure:', amphureId);
        }
      } catch (error) {
        console.error('‚ùå Failed to load tambons:', error);
    
        // Show user-friendly error message
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
    
        if (subInput) subInput.value = '';
        if (subDD) {
          subDD.innerHTML = '<div class="dropdown-no-results">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•</div>';
          subDD.classList.remove('hidden');
        }
    
        // Clear zipcode field
        const zipInput = document.getElementById('zipcode');
        if (zipInput) zipInput.value = '';
      }
    }

    // Utility function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Address Preview Update Function (Global)
    window.updateAddressPreview = function() {
      const houseNo = document.getElementById('houseNo')?.value || '';
      const moo = document.getElementById('moo')?.value || '';
      const soi = document.getElementById('soi')?.value || '';
      const road = document.getElementById('road')?.value || '';
      const province = document.getElementById('province')?.value || '';
      const district = document.getElementById('district')?.value || '';
      const subDistrict = document.getElementById('subDistrict')?.value || '';
      const zipcode = document.getElementById('zipcode')?.value || '';
    
      let addressParts = [];
    
      if (houseNo) addressParts.push(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${houseNo}`);
      if (moo) addressParts.push(`‡∏´‡∏°‡∏π‡πà ${moo}`);
      if (soi) addressParts.push(`‡∏ã‡∏≠‡∏¢ ${soi}`);
      if (road) addressParts.push(`‡∏ñ‡∏ô‡∏ô ${road}`);
      if (subDistrict) addressParts.push(`‡∏ï‡∏≥‡∏ö‡∏• ${subDistrict}`);
      if (district) addressParts.push(`‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${district}`);
      if (province) addressParts.push(`‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${province}`);
      if (zipcode) addressParts.push(zipcode);
    
      const fullAddress = addressParts.join(' ');
      console.log('üìç Address Preview:', fullAddress);
    
      // You can add code here to show address preview in UI
    };

    console.log('üåç Enhanced Location Autocomplete with Zipcode Validation loaded');

    // ==================== RECEIPT VOUCHER SYNC FUNCTIONS ====================
    
    /**
     * Sync frontstore sale with Receipt Voucher System for automatic receipt voucher creation
     */
    async function syncFrontstoreWithReceiptVoucher(saleData) {
      try {
        console.log('üì§ Syncing frontstore sale data:', saleData);
    
        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('No authentication token found');
        }
    
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° sync data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
        const receiptData = {
          // Sync API fields
          source: 'frontstore',
          sourceId: saleData.orderId,
          documentNumber: `RV-FS-${saleData.invoiceNo}-${Date.now()}`,
          customerName: saleData.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
          totalAmount: saleData.totalAmount,
          netAmount: saleData.netAmount,
          vatAmount: saleData.vatAmount,
          paymentMethod: saleData.paymentMethod || 'cash',
          description: `‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${saleData.invoiceNo}`,
          notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${saleData.invoiceNo}`,
    
          // Additional metadata
          metadata: {
            invoiceNumber: saleData.invoiceNo,
            invoiceNo: saleData.invoiceNo,
            branchCode: saleData.branchCode,
            staffId: saleData.staffId,
            staffName: saleData.staffName,
            customerType: saleData.customerType,
            invoiceType: saleData.invoiceType,
            items: saleData.items?.map(item => ({
              name: item.name,
              quantity: item.qty,
              price: item.price,
              total: item.price * item.qty
            })) || []
          }
        };
    
        console.log('üìã Prepared receipt data:', receiptData);
    
        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Receipt Voucher Sync API
        const response = await fetch('/api/receipt-vouchers/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(receiptData)
        });
    
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Receipt Voucher API error: ${response.status} - ${errorText}`);
        }
    
        const result = await response.json();
    
        if (result.success) {
          console.log('‚úÖ Receipt voucher created successfully:', result.data.documentNumber);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          if (typeof showToast === 'function') {
            showToast(
              `üí∞ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
              'success',
              '‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
              4000
            );
          }
    
          // POS Notification
          if (posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: '‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
              message: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${result.data.documentNumber} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
              type: 'success',
              icon: 'üßæ',
              actions: [
                {
                  label: '‡∏î‡∏π‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
                  action: 'primary',
                  callback: () => {
                    window.open(`/receipt-voucher/${result.data.id}`, '_blank');
                  }
                }
              ]
            });
          }
    
          return result.data;
        } else {
          throw new Error(result.message || 'Failed to create receipt voucher');
        }
    
      } catch (error) {
        console.error('‚ùå Error syncing with Receipt Voucher System:', error);
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô error ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
        if (typeof showToast === 'function') {
          showToast(
            `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ${error.message}`,
            'warning',
            '‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            6000
          );
        }
    
        throw error; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ caller ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error
      }
    }

    // Make sync function globally available
    window.syncFrontstoreWithReceiptVoucher = syncFrontstoreWithReceiptVoucher;

    // ============================================
    // üîß Card Reader Comprehensive Diagnostic Tool
    // ============================================
    
    /**
     * ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Card Reader ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
     * ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Administrator ‡πÅ‡∏•‡∏∞ Technical Support
     */
    async function runCardReaderDiagnostic() {
      console.log('üîç Starting comprehensive Card Reader diagnostic...');
    
      const branchCode = window.BRANCH_CODE || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
      const diagnosticResults = {
        timestamp: new Date().toISOString(),
        branchCode: branchCode,
        tests: []
      };
    
      // ‚úÖ Test 1: Card Reader Configuration
      try {
        const configTest = {
          name: 'Configuration Check',
          status: 'running',
          details: {}
        };
    
        if (window.CardReaderConfig) {
          configTest.status = 'passed';
          configTest.details = {
            enabled: window.CardReaderConfig.isCardReaderEnabled(branchCode),
            branch: window.CardReaderConfig.getBranchName(branchCode),
            endpoints: window.CardReaderConfig.getCardProxyUrls(branchCode)
          };
        } else {
          configTest.status = 'failed';
          configTest.details = { error: 'CardReaderConfig not loaded' };
        }
    
        diagnosticResults.tests.push(configTest);
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'Configuration Check',
          status: 'error',
          details: { error: error.message }
        });
      }
    
      // ‚úÖ Test 2: Service Availability
      try {
        const serviceTest = {
          name: 'CardReaderService Availability',
          status: window.CardReaderService ? 'passed' : 'failed',
          details: {
            serviceLoaded: !!window.CardReaderService,
            readCardFunction: !!(window.CardReaderService?.readCard),
            loadTime: 'N/A'
          }
        };
    
        diagnosticResults.tests.push(serviceTest);
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'CardReaderService Availability',
          status: 'error',
          details: { error: error.message }
        });
      }
    
      // ‚úÖ Test 3: Network Connectivity
      const networkTests = [];
      if (window.CardReaderConfig?.isCardReaderEnabled(branchCode)) {
        const urlConfig = window.CardReaderConfig.getCardProxyUrls(branchCode);
    
        for (const proxy of urlConfig.all) {
          try {
            const startTime = Date.now();
            const response = await fetch(proxy.http + '/health', {
              method: 'GET',
              timeout: 3000
            });
            const endTime = Date.now();
    
            networkTests.push({
              name: `Network Test - ${proxy.name}`,
              status: response.ok ? 'passed' : 'failed',
              details: {
                url: proxy.http,
                responseTime: endTime - startTime,
                httpStatus: response.status,
                reachable: true
              }
            });
          } catch (error) {
            networkTests.push({
              name: `Network Test - ${proxy.name}`,
              status: 'failed',
              details: {
                url: proxy.http,
                error: error.message,
                reachable: false
              }
            });
          }
        }
      }
    
      diagnosticResults.tests.push(...networkTests);
    
      // ‚úÖ Test 4: Server API Test
      try {
        const startTime = Date.now();
        const response = await fetch('/api/cardreader/health', {
          method: 'GET',
          timeout: 5000
        });
        const endTime = Date.now();
    
        diagnosticResults.tests.push({
          name: 'Server API Health Check',
          status: response.ok ? 'passed' : 'failed',
          details: {
            url: '/api/cardreader/health',
            responseTime: endTime - startTime,
            httpStatus: response.status
          }
        });
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'Server API Health Check',
          status: 'failed',
          details: {
            url: '/api/cardreader/health',
            error: error.message
          }
        });
      }
    
      // ‚úÖ Display Results
      const passedTests = diagnosticResults.tests.filter(t => t.status === 'passed').length;
      const totalTests = diagnosticResults.tests.length;
    
      console.log('üìä Card Reader Diagnostic Results:', diagnosticResults);
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Report ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      const reportHTML = generateDiagnosticReport(diagnosticResults, passedTests, totalTests);
    
      if (typeof showToast === 'function') {
        showToast(
          reportHTML,
          passedTests === totalTests ? 'success' : 'warning',
          `üîç Card Reader Diagnostic (${passedTests}/${totalTests} passed)`,
          0 // ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á
        );
      }
    
      return diagnosticResults;
    }
    
    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Report ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢
     */
    function generateDiagnosticReport(results, passed, total) {
      const testRows = results.tests.map(test => {
        const statusIcon = test.status === 'passed' ? '‚úÖ' :
                          test.status === 'failed' ? '‚ùå' : '‚ö†Ô∏è';
        const statusClass = test.status === 'passed' ? 'text-success' :
                           test.status === 'failed' ? 'text-danger' : 'text-warning';
    
        return `
          <tr>
            <td class="${statusClass}">${statusIcon} ${test.name}</td>
            <td class="${statusClass}">${test.status.toUpperCase()}</td>
          </tr>
        `;
      }).join('');
    
      return `
        <div class="diagnostic-report">
          <h6 class="mb-3">üîç Card Reader Diagnostic Report</h6>
          <div class="mb-3">
            <strong>Branch:</strong> ${results.branchCode}<br>
            <strong>Time:</strong> ${new Date(results.timestamp).toLocaleString('th-TH')}<br>
            <strong>Results:</strong> ${passed}/${total} tests passed
          </div>
          
          <table class="table table-sm">
            <thead>
              <tr><th>Test</th><th>Status</th></tr>
            </thead>
            <tbody>
              ${testRows}
            </tbody>
          </table>
          
          <div class="d-flex gap-2 mt-3">
            <button onclick="copyDiagnosticResults()" class="btn btn-sm btn-info">
              üìã Copy Report
            </button>
            <button onclick="retestCardReader()" class="btn btn-sm btn-warning">
              üîÑ Run Again
            </button>
            ${passed < total ? '<button onclick="showCardReaderTroubleshooting()" class="btn btn-sm btn-danger">üõ†Ô∏è Troubleshoot</button>' : ''}
          </div>
        </div>
      `;
    }
    
    /**
     * ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á Clipboard
     */
    async function copyDiagnosticResults() {
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      if (window.lastDiagnosticResults) {
        try {
          const report = JSON.stringify(window.lastDiagnosticResults, null, 2);
          await navigator.clipboard.writeText(report);
    
          if (typeof showToast === 'function') {
            showToast('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success', 'Diagnostic', 3000);
          }
        } catch (error) {
          console.error('Failed to copy diagnostic results:', error);
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ', 'error', 'Diagnostic', 3000);
          }
        }
      }
    }
    
    /**
     * ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà
     */
    async function retestCardReader() {
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      const results = await runCardReaderDiagnostic();
      window.lastDiagnosticResults = results;
    }
    
    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤
     */
    function showCardReaderTroubleshooting() {
      const troubleshootingHTML = `
        <div class="troubleshooting-guide">
          <h6 class="mb-3">üõ†Ô∏è Card Reader Troubleshooting Guide</h6>
          
          <div class="mb-3">
            <h7><strong>üìã Common Issues & Solutions:</strong></h7>
            <ul class="small">
              <li><strong>HTTP 500 Error:</strong> Server-side issue, contact IT support</li>
              <li><strong>Timeout:</strong> Network latency, check network connection</li>
              <li><strong>SSL Error:</strong> Certificate issue, use HTTP or contact IT</li>
              <li><strong>Connection Failed:</strong> Card reader service not running</li>
            </ul>
          </div>
          
          <div class="mb-3">
            <h7><strong>üîß Quick Actions:</strong></h7>
            <div class="d-flex gap-2 mt-2">
              <button onclick="testSingleEndpoint()" class="btn btn-sm btn-outline-primary">
                üéØ Test Single Endpoint
              </button>
              <button onclick="resetCardReaderConfig()" class="btn btn-sm btn-outline-warning">
                üîÑ Reset Config
              </button>
            </div>
          </div>
          
          <div class="alert alert-info small">
            <strong>üí° For Administrators:</strong><br>
            ‚Ä¢ Check card reader proxy services on target IPs<br>
            ‚Ä¢ Verify network connectivity from this machine<br>
            ‚Ä¢ Review server logs for API endpoint errors<br>
            ‚Ä¢ Consider using manual entry as temporary solution
          </div>
        </div>
      `;
    
      if (typeof showToast === 'function') {
        showToast(troubleshootingHTML, 'info', 'üõ†Ô∏è Troubleshooting Guide', 0);
      }
    }
    
    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ functions ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å
    window.runCardReaderDiagnostic = runCardReaderDiagnostic;
    window.copyDiagnosticResults = copyDiagnosticResults;
    window.retestCardReader = retestCardReader;
    window.showCardReaderTroubleshooting = showCardReaderTroubleshooting;

    // ============================================
    // Thai ID Card Reader Integration
    // ============================================
    
    let cardWebSocket = null;
       let cardReaderConnected = false;
    let cardReaderAttempts = 0;
    const maxCardReaderAttempts = 3;
    
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Card Proxy Server (‡∏£‡∏±‡∏ô‡∏ö‡∏ô client machine)
    function initCardReader() {
      // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß - Silent mode
      if (cardReaderAttempts >= maxCardReaderAttempts) {
        // Silent failure - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏î‡πÜ
        updateCardReaderStatus(false);
        return;
      }

      try {
        cardReaderAttempts++;
        // Silent attempt - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á console log

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Card Proxy ‡∏ö‡∏ô localhost
        cardWebSocket = new WebSocket('ws://localhost:8080');

        // ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        const connectionTimeout = setTimeout(() => {
          if (cardWebSocket.readyState !== WebSocket.OPEN) {
            cardWebSocket.close();
            handleCardReaderConnectionFailed();
          }
        }, 3000);

        cardWebSocket.onopen = function() {
          clearTimeout(connectionTimeout);
          // Silent success
          cardReaderConnected = true;
          cardReaderAttempts = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          updateCardReaderStatus(true);

          // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á toast notification
        };

        cardWebSocket.onmessage = function(event) {
          try {
            const cardData = JSON.parse(event.data);
            console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', cardData);

            if (cardData && cardData.Citizenid) {
              handleCardData(cardData);
            } else if (cardData === null) {
              handleCardRemoved();
            } else if (cardData.error) {
              handleCardError(cardData);
            }
          } catch (error) {
            console.error('‚ùå Error parsing card data:', error);
          }
        };

        cardWebSocket.onclose = function(event) {
          clearTimeout(connectionTimeout);
          // Silent close
          cardReaderConnected = false;
          updateCardReaderStatus(false);

          // Auto reconnect ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà connection failed ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á
          if (event.code !== 1006 && cardReaderAttempts < maxCardReaderAttempts) {
            setTimeout(initCardReader, 5000);
          } else {
            handleCardReaderConnectionFailed();
          }
        };

        cardWebSocket.onerror = function(error) {
          clearTimeout(connectionTimeout);
          // Silent error
          cardReaderConnected = false;
          handleCardReaderConnectionFailed();
        };

      } catch (error) {
        // Silent error
        cardReaderConnected = false;
        handleCardReaderConnectionFailed();
      }
    }

    function handleCardReaderConnectionFailed() {
      updateCardReaderStatus(false);
      // Silent mode - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏î‡πÜ
    }

    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ - ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (UI ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
    function updateCardReaderStatus(connected) {
      // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á UI ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ - Card Reader ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      return;
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    function handleCardData(cardData) {
      console.log('üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:', cardData);
    
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô UI
      displayCardInfo(cardData);
    
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      autoFillCustomerData(cardData);
    
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      if (typeof showToast === 'function') {
        showToast(
          `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${cardData.TitleTh}${cardData.FirstNameTh} ${cardData.LastNameTh}`,
          'success',
          '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
          5000
        );
      }
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏≠‡∏î‡∏ö‡∏±‡∏ï‡∏£
    function handleCardRemoved() {
      console.log('üì§ ‡∏ñ‡∏≠‡∏î‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß');
      clearCardInfo();
    
      if (typeof showToast === 'function') {
        showToast('üì§ ‡∏ñ‡∏≠‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'info', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 3000);
      }
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
    function handleCardError(errorData) {
      console.error('‚ùå Card Reader Error:', errorData);
    
      if (typeof showToast === 'function') {
        showToast(
          `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ: ${errorData.details || errorData.error}`,
          'error',
          '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£',
          8000
        );
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô UI
    function displayCardInfo(cardData) {
      const cardInfoContainer = document.getElementById('cardInfoContainer');
      if (cardInfoContainer) {
        cardInfoContainer.innerHTML = `
          <div class="card-info">
            <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</h4>
            <div class="row">
              <div class="col-md-6">
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£:</strong> ${cardData.Citizenid}</p>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> ${cardData.TitleTh}${cardData.FirstNameTh} ${cardData.LastNameTh}</p>
                <p><strong>‡πÄ‡∏û‡∏®:</strong> ${cardData.Gender}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> ${cardData.BirthdayTh} (${cardData.Age} ‡∏õ‡∏µ)</p>
              </div>
              <div class="col-md-6">
                <p><strong>Name:</strong> ${cardData.TitleEng}${cardData.FirstNameEng} ${cardData.LastNameEng}</p>
                <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${cardData.Address}</p>
                <p><strong>‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${new Date(cardData.timestamp).toLocaleString('th-TH')}</p>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£
    function clearCardInfo() {
      const cardInfoContainer = document.getElementById('cardInfoContainer');
      if (cardInfoContainer) {
        cardInfoContainer.innerHTML = '';
      }
    }
    
    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    function autoFillCustomerData(cardData) {
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° field names ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
      const customerForm = document.getElementById('customerForm') || document.querySelector('[data-customer-form]');
    
      if (customerForm) {
        // ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
        const citizenIdField = customerForm.querySelector('[name="citizenId"], [name="citizen_id"], #citizenId');
        if (citizenIdField) citizenIdField.value = cardData.Citizenid;
    
        // ‡∏ä‡∏∑‡πà‡∏≠
        const firstNameField = customerForm.querySelector('[name="firstName"], [name="first_name"], #firstName, #customerFirstName');
        if (firstNameField) firstNameField.value = cardData.FirstNameTh;
    
        // ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
        const lastNameField = customerForm.querySelector('[name="lastName"], [name="last_name"], #lastName, #customerLastName');
        if (lastNameField) lastNameField.value = cardData.LastNameTh;
    
        // ‡πÄ‡∏û‡∏®
        const genderField = customerForm.querySelector('[name="gender"], #gender');
        if (genderField) {
          if (genderField.type === 'select-one') {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dropdown
            const genderValue = cardData.Gender === '‡∏ä‡∏≤‡∏¢' ? 'male' : 'female';
            genderField.value = genderValue;
          } else {
            genderField.value = cardData.Gender;
          }
        }
    
        // ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
        const birthdayField = customerForm.querySelector('[name="birthday"], [name="birth_date"], #birthday');
        if (birthdayField) {
          // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input[type="date"]
          const parts = cardData.BirthdayEn.split('/');
          if (parts.length === 3) {
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            birthdayField.value = formattedDate;
          }
        }
    
        // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        const addressField = customerForm.querySelector('[name="address"], #address');
        if (addressField) addressField.value = cardData.Address;
    
        console.log('‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
      }
    }
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
    async function readCardManually() {
      if (!cardReaderConnected) {
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
        }
        return;
      }
    
      try {
        const response = await fetch('http://localhost:3000/read-card');
        const result = await response.json();
    
        if (result.success && result.data) {
          handleCardData(result.data);
        } else {
          if (typeof showToast === 'function') {
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
          }
        }
      } catch (error) {
        console.error('‚ùå Error reading card manually:', error);
        if (typeof showToast === 'function') {
          showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£');
        }
      }
    }
    
    // Make functions globally available
    window.readCardManually = readCardManually;
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
    document.addEventListener('DOMContentLoaded', function() {
      // Silent mode - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    
      // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á UI ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ - ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      // addCardReaderUI();
    
      // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)
      // initCardReader(); // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô WebSocket ‡πÄ‡∏Å‡πà‡∏≤ - ‡πÉ‡∏ä‡πâ CardReaderService ‡πÅ‡∏ó‡∏ô
    });
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
    function addCardReaderUI() {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
      const style = document.createElement('style');
      style.textContent = `
        .card-reader-section {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin: 10px 0;
        }
        .card-reader-status {
          font-weight: bold;
          padding: 8px 12px;
          border-radius: 4px;
          margin-bottom: 10px;
        }
        .card-reader-status.connected {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
        .card-reader-status.disconnected {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        .card-info {
          background: #e7f3ff;
          border: 1px solid #b8daff;
          border-radius: 4px;
          padding: 15px;
          margin-top: 10px;
        }
        .btn-read-card {
          background: #007bff;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
        }
        .btn-read-card:hover {
          background: #0056b3;
        }
        .btn-read-card:disabled {
          background: #6c757d;
          cursor: not-allowed;
        }
      `;
      document.head.appendChild(style);
    
      // ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà UI ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£
      const targetContainer = document.querySelector('.customer-section, .form-section, .main-content')
                            || document.querySelector('#mainContent')
                            || document.querySelector('#level1Container')
                            || document.querySelector('.card')
                            || document.body;
    
      if (targetContainer) {
        const cardReaderSection = document.createElement('div');
        cardReaderSection.className = 'card-reader-section';
        cardReaderSection.innerHTML = `
          <h5>üÜî ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</h5>
          <div id="cardReaderStatus" class="card-reader-status">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£...</div>
          <button type="button" class="btn-read-card" onclick="readCardManually()">
            üìñ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
          </button>
          <div id="cardInfoContainer"></div>
        `;
    
        // ‡πÉ‡∏™‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô
        targetContainer.parentNode.insertBefore(cardReaderSection, targetContainer);
      }
    } // ‚Üê closing brace ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö addCardReaderUI()

  </script>
  <script>
    // === STOCK RESERVATION HANDLING ===
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    async function handleStockReservationsAfterSale(saleData, reservedItems) {
      if (!reservedItems || reservedItems.length === 0) {
        console.log('üì¶ No reserved items to process');
        return;
      }
    
      console.log('üîí Processing stock reservations after sale:', reservedItems);
    
      for (const item of reservedItems) {
        if (item.stockReservation && item.stockReservation.reservationId) {
          try {
            console.log(`üîì Using stock reservation for ${item.name}:`, item.stockReservation.reservationId);
    
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/stock-reservation/use', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                reservationId: item.stockReservation.reservationId,
                transactionId: saleData.receiptNumber || saleData.taxInvoiceNumber || 'UNKNOWN',
                saleType: 'cash'
              })
            });
    
            const result = await response.json();
    
            if (result.success) {
              console.log(`‚úÖ Stock reservation used for ${item.name}:`, result.data);
    
              if (typeof showToast === 'function') {
                showToast(
                  `‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${item.name}`,
                  'success'
                );
              }
            } else {
              console.warn(`‚ö†Ô∏è Failed to use stock reservation for ${item.name}:`, result.message);
    
              if (typeof showToast === 'function') {
                showToast(
                  `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${item.name}`,
                  'warning'
                );
              }
            }
    
          } catch (error) {
            console.error(`‚ùå Error using stock reservation for ${item.name}:`, error);
          }
        }
      }
    
      console.log('üîí Finished processing stock reservations');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
    function updateMixedPayment() {
      const cashAmount = parseFloat(document.getElementById('mixedCashAmount').value) || 0;
      const transferAmount = parseFloat(document.getElementById('mixedTransferAmount').value) || 0;
      const total = cashAmount + transferAmount;
    
      document.getElementById('mixedTotalDisplay').textContent = `${total.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })} ‡∏ö‡∏≤‡∏ó`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
    function toggleMixedPaymentSection() {
      const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const mixedSection = document.getElementById('mixedPaymentDetails');
    
      if (selectedPaymentMethod === 'MIXED') {
        mixedSection.classList.remove('hidden');
      } else {
        mixedSection.classList.add('hidden');
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤
        document.getElementById('mixedCashAmount').value = '';
        document.getElementById('mixedTransferAmount').value = '';
        document.getElementById('mixedTotalDisplay').textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö payment method
    document.addEventListener('DOMContentLoaded', function() {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö radio buttons
      const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
      paymentMethods.forEach(radio => {
        radio.addEventListener('change', toggleMixedPaymentSection);
      });
    });
  </script>
  
</body>

</html>
