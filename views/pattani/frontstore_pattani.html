<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>POS System</title>

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <!-- Old LoadingSystem v2.0.0 CSS removed - using new Lottie loading -->


  <!-- Error Boundaries and Network Error Handling -->
  <script>
    // ========== ERROR BOUNDARIES & NETWORK ERROR HANDLING ==========
    (function(window) {
      'use strict';

      console.log('🛡️ Error Boundaries & Network Error Handling initializing...');

      // Global Error Boundaries
      window.addEventListener('unhandledrejection', function(event) {
        console.error('🚨 Unhandled Promise Rejection:', event.reason);

        // แสดงข้อความแจ้งเตือนให้ผู้ใช้
        if (typeof showToast === 'function') {
          showToast('เกิดข้อผิดพลาดในระบบ กรุณาลองใหม่อีกครั้ง', 'error');
        }

        // Log error to backend if available
        if (window.auditLogger && typeof window.auditLogger.logEvent === 'function') {
          window.auditLogger.logEvent('ERROR', 'UNHANDLED_REJECTION', {
            reason: event.reason?.toString() || 'Unknown error',
            stack: event.reason?.stack || 'No stack trace'
          });
        }

        // Prevent default browser handling
        event.preventDefault();
      });

      window.addEventListener('error', function(event) {
        console.error('🚨 Global Error:', event.error);

        if (typeof showToast === 'function') {
          showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาลองใหม่อีกครั้ง', 'error');
        }

        // Log error to backend if available
        if (window.auditLogger && typeof window.auditLogger.logEvent === 'function') {
          window.auditLogger.logEvent('ERROR', 'GLOBAL_ERROR', {
            message: event.message || 'Unknown error',
            filename: event.filename || 'Unknown file',
            lineno: event.lineno || 0,
            colno: event.colno || 0,
            stack: event.error?.stack || 'No stack trace'
          });
        }
      });

      // Event Listener Management System to prevent memory leaks
      const eventListenerRegistry = {
        listeners: new Map(),
        timers: new Set(),
        observers: new Set(),

        /**
         * Add event listener with automatic cleanup tracking
         */
        add(element, event, handler, options = {}) {
          if (!element || typeof handler !== 'function') return;

          element.addEventListener(event, handler, options);

          const key = `${element.constructor.name}-${event}-${handler.name || 'anonymous'}`;
          if (!this.listeners.has(key)) {
            this.listeners.set(key, new Set());
          }
          this.listeners.get(key).add({ element, event, handler, options });

          return () => this.remove(element, event, handler);
        },

        /**
         * Remove specific event listener
         */
        remove(element, event, handler) {
          if (!element || !handler) return;

          element.removeEventListener(event, handler);

          const key = `${element.constructor.name}-${event}-${handler.name || 'anonymous'}`;
          const listeners = this.listeners.get(key);
          if (listeners) {
            for (const listener of listeners) {
              if (listener.element === element && listener.handler === handler) {
                listeners.delete(listener);
                break;
              }
            }
            if (listeners.size === 0) {
              this.listeners.delete(key);
            }
          }
        },

        /**
         * Track timers for automatic cleanup
         */
        addTimer(timerId) {
          this.timers.add(timerId);
          return timerId;
        },

        /**
         * Track observers for automatic cleanup
         */
        addObserver(observer) {
          this.observers.add(observer);
          return observer;
        },

        /**
         * Cleanup all tracked resources
         */
        cleanup() {
          console.log('🧹 Cleaning up event listeners and resources...');

          // Remove all event listeners
          for (const [key, listeners] of this.listeners.entries()) {
            for (const { element, event, handler } of listeners) {
              try {
                element.removeEventListener(event, handler);
              } catch (e) {
                console.warn(`Failed to remove listener for ${key}:`, e);
              }
            }
          }
          this.listeners.clear();

          // Clear all timers
          for (const timerId of this.timers) {
            try {
              clearTimeout(timerId);
              clearInterval(timerId);
            } catch (e) {
              console.warn('Failed to clear timer:', e);
            }
          }
          this.timers.clear();

          // Disconnect all observers
          for (const observer of this.observers) {
            try {
              if (observer.disconnect) observer.disconnect();
              if (observer.unobserve) observer.unobserve();
            } catch (e) {
              console.warn('Failed to disconnect observer:', e);
            }
          }
          this.observers.clear();
        }
      };

      // Auto cleanup on page unload
      window.addEventListener('beforeunload', () => {
        eventListenerRegistry.cleanup();
      });

      // Enhanced timer and animation management
      window.safeFunctions = {
        /**
         * Safe setTimeout with automatic cleanup tracking
         */
        setTimeout: (callback, delay, ...args) => {
          const timerId = setTimeout(() => {
            eventListenerRegistry.timers.delete(timerId);
            callback(...args);
          }, delay);
          return eventListenerRegistry.addTimer(timerId);
        },

        /**
         * Safe setInterval with automatic cleanup tracking
         */
        setInterval: (callback, interval, ...args) => {
          const timerId = setInterval(callback, interval, ...args);
          return eventListenerRegistry.addTimer(timerId);
        },

        /**
         * Safe requestAnimationFrame with automatic cleanup tracking
         */
        requestAnimationFrame: (callback) => {
          const animationId = requestAnimationFrame((timestamp) => {
            eventListenerRegistry.timers.delete(animationId);
            callback(timestamp);
          });
          return eventListenerRegistry.addTimer(animationId);
        },

        /**
         * Clear timer and remove from registry
         */
        clearTimer: (timerId) => {
          clearTimeout(timerId);
          clearInterval(timerId);
          cancelAnimationFrame(timerId);
          eventListenerRegistry.timers.delete(timerId);
        },

        /**
         * Add event listener with automatic cleanup
         */
        addEventListener: (element, event, handler, options) => {
          return eventListenerRegistry.add(element, event, handler, options);
        }
      };

      // API Response Cache System
      const apiCache = new Map();
      const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
      const MAX_CACHE_SIZE = 100;

      function getCacheKey(url, options = {}) {
        const method = options.method || 'GET';
        const body = options.body || '';
        return `${method}:${url}:${typeof body === 'string' ? body : JSON.stringify(body)}`;
      }

      function getCachedResponse(key) {
        const cached = apiCache.get(key);
        if (!cached) return null;

        const now = Date.now();
        if (now - cached.timestamp > CACHE_DURATION) {
          apiCache.delete(key);
          return null;
        }

        return cached.data;
      }

      function setCachedResponse(key, data) {
        // Implement LRU cache
        if (apiCache.size >= MAX_CACHE_SIZE) {
          const firstKey = apiCache.keys().next().value;
          apiCache.delete(firstKey);
        }

        apiCache.set(key, {
          data: data,
          timestamp: Date.now()
        });
      }

      // Circuit Breaker State Management
      const circuitBreakerState = {
        failures: 0,
        maxFailures: 5,
        timeout: 60000, // 1 minute
        lastFailureTime: null,
        state: 'CLOSED' // CLOSED, OPEN, HALF_OPEN
      };

      function shouldBypassCircuitBreaker() {
        if (circuitBreakerState.state === 'CLOSED') return true;
        if (circuitBreakerState.state === 'OPEN') {
          const timeSinceLastFailure = Date.now() - circuitBreakerState.lastFailureTime;
          if (timeSinceLastFailure > circuitBreakerState.timeout) {
            circuitBreakerState.state = 'HALF_OPEN';
            return true;
          }
          return false;
        }
        if (circuitBreakerState.state === 'HALF_OPEN') return true;
        return false;
      }

      function recordCircuitBreakerSuccess() {
        circuitBreakerState.failures = 0;
        circuitBreakerState.state = 'CLOSED';
        circuitBreakerState.lastFailureTime = null;
      }

      function recordCircuitBreakerFailure() {
        circuitBreakerState.failures++;
        circuitBreakerState.lastFailureTime = Date.now();

        if (circuitBreakerState.failures >= circuitBreakerState.maxFailures) {
          circuitBreakerState.state = 'OPEN';
          console.warn(`🚨 Circuit breaker OPEN - too many failures (${circuitBreakerState.failures})`);
        }
      }

      // Safe Fetch with Error Handling and Retry
      async function safeFetch(url, options = {}) {
        const maxRetries = options.maxRetries || 3;
        const timeout = options.timeout || 30000; // 30 seconds default
        const useCache = options.useCache !== false;
        const bypassCircuitBreaker = options.bypassCircuitBreaker || false;
        let lastError;

        // Check circuit breaker
        if (!bypassCircuitBreaker && !shouldBypassCircuitBreaker()) {
          const error = new Error('Circuit breaker is OPEN - service temporarily unavailable');
          error.name = 'CircuitBreakerError';
          if (typeof showToast === 'function') {
            showToast('ระบบกำลังมีปัญหา กรุณารอสักครู่แล้วลองใหม่อีกครั้ง', 'warning');
          }
          throw error;
        }

        // Check cache first (for GET requests)
        if (useCache && (!options.method || options.method === 'GET')) {
          const cacheKey = getCacheKey(url, options);
          const cached = getCachedResponse(cacheKey);
          if (cached) {
            console.log('📋 Using cached response for:', url);
            return cached;
          }
        }

        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            console.log(`🌐 Network request attempt ${attempt}/${maxRetries}: ${url}`);

            // Create AbortController for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const fetchOptions = {
              ...options,
              signal: controller.signal
            };

            const response = await fetch(url, fetchOptions);
            clearTimeout(timeoutId);

            if (!response.ok) {
              const errorText = await response.text().catch(() => 'No response text');
              throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
            }

            const data = await response.json();

            // Cache successful GET responses
            if (useCache && (!options.method || options.method === 'GET')) {
              const cacheKey = getCacheKey(url, options);
              setCachedResponse(cacheKey, data);
            }

            console.log(`✅ Network request successful: ${url}`);
            recordCircuitBreakerSuccess();
            return data;

          } catch (error) {
            lastError = error;
            console.error(`❌ Network request failed (attempt ${attempt}/${maxRetries}):`, error);

            // Don't retry on certain error types
            if (error.name === 'AbortError') {
              console.error('🕐 Request timeout:', url);
              break;
            }

            if (error.message.includes('400') || error.message.includes('401') || error.message.includes('403')) {
              console.error('🚫 Client error - not retrying:', error.message);
              break;
            }

            // Wait before retry (exponential backoff)
            if (attempt < maxRetries) {
              const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
              console.log(`⏳ Waiting ${delay}ms before retry...`);
              await new Promise(resolve => setTimeout(resolve, delay));
            }
          }
        }

        // All retries failed
        console.error('💥 All network retries failed for:', url, lastError);
        recordCircuitBreakerFailure();

        // Show user-friendly error message
        if (typeof showToast === 'function') {
          if (lastError.name === 'AbortError') {
            showToast('การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่อีกครั้ง', 'warning');
          } else if (lastError.message.includes('Failed to fetch')) {
            showToast('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต', 'error');
          } else {
            showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาลองใหม่อีกครั้ง', 'error');
          }
        }

        throw lastError;
      }

      // Input Validation Functions
      function validateCheckoutData(checkoutData) {
        const errors = [];

        // ตรวจสอบข้อมูลพื้นฐาน
        if (!checkoutData) {
          errors.push('ข้อมูลการชำระเงินไม่ถูกต้อง');
          return { isValid: false, errors };
        }

        // ตรวจสอบรายการสินค้า
        if (!checkoutData.items || !Array.isArray(checkoutData.items) || checkoutData.items.length === 0) {
          errors.push('ไม่มีรายการสินค้าในตะกร้า');
        } else {
          checkoutData.items.forEach((item, index) => {
            if (!item.id) {
              errors.push(`รายการที่ ${index + 1}: ไม่มีรหัสสินค้า`);
            }
            if (!item.qty || item.qty <= 0) {
              errors.push(`รายการที่ ${index + 1}: จำนวนสินค้าไม่ถูกต้อง`);
            }
            if (!item.price || item.price < 0) {
              errors.push(`รายการที่ ${index + 1}: ราคาสินค้าไม่ถูกต้อง`);
            }
          });
        }

        // ตรวจสอบยอดเงิน
        if (typeof checkoutData.totalAmount !== 'number' || checkoutData.totalAmount < 0) {
          errors.push('ยอดเงินรวมไม่ถูกต้อง');
        }

        // ตรวจสอบวิธีการชำระเงิน
        if (!checkoutData.paymentMethod) {
          errors.push('กรุณาเลือกวิธีการชำระเงิน');
        }

        // ตรวจสอบข้อมูลลูกค้า (หากมี)
        if (checkoutData.customer) {
          if (checkoutData.customer.email && !isValidEmail(checkoutData.customer.email)) {
            errors.push('รูปแบบอีเมลไม่ถูกต้อง');
          }
          if (checkoutData.customer.phone && !isValidPhoneNumber(checkoutData.customer.phone)) {
            errors.push('รูปแบบเบอร์โทรศัพท์ไม่ถูกต้อง');
          }
        }

        return {
          isValid: errors.length === 0,
          errors: errors
        };
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function isValidPhoneNumber(phone) {
        // รองรับรูปแบบเบอร์โทรไทย
        const phoneRegex = /^(\+66|66|0)?[0-9]{8,9}$/;
        return phoneRegex.test(phone.replace(/[-\s]/g, ''));
      }

      function sanitizeInput(input) {
        if (typeof input !== 'string') return input;

        // Remove potentially dangerous characters
        return input
          .replace(/[<>\"']/g, '')
          .trim()
          .substring(0, 1000); // Limit length
      }

      // Connection Status Monitoring
      let connectionStatus = {
        online: navigator.onLine,
        lastCheck: Date.now(),
        retryCount: 0
      };

      function updateConnectionStatus() {
        const wasOnline = connectionStatus.online;
        connectionStatus.online = navigator.onLine;
        connectionStatus.lastCheck = Date.now();

        if (wasOnline !== connectionStatus.online) {
          console.log('🌐 Connection status changed:', connectionStatus.online ? 'Online' : 'Offline');

          if (typeof showToast === 'function') {
            if (connectionStatus.online) {
              showToast('✅ กลับมาออนไลน์แล้ว', 'success');
              connectionStatus.retryCount = 0;
            } else {
              showToast('⚠️ การเชื่อมต่ออินเทอร์เน็ตขาดหาย', 'warning');
            }
          }

          // Emit custom event for other parts of the app
          window.dispatchEvent(new CustomEvent('connectionchange', {
            detail: { online: connectionStatus.online }
          }));
        }
      }

      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);

      // Export functions to global scope
      window.safeFetch = safeFetch;
      window.validateCheckoutData = validateCheckoutData;
      window.sanitizeInput = sanitizeInput;
      window.connectionStatus = connectionStatus;

      console.log('✅ Error Boundaries & Network Error Handling initialized successfully');

    })(window);
  </script>

  <script>
    // New Lottie Loading State with State Management (same as addNewProduct_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <script src="/js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <!-- Security & Audit Enhancement -->
  <script src="/js/security-manager.js"></script>
  <script src="/js/audit-logger.js"></script>
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <!-- (1) โหลด Tailwind CSS CDN ก่อน -->
  <!-- TODO: ในโหมด production ควรใช้ Tailwind CSS ที่ build แล้วแทน CDN เพื่อประสิทธิภาพที่ดีกว่า -->
  <script src="https://cdn.tailwindcss.com"></script>


  <!-- (2) กำหนดค่า Tailwind และ DaisyUI -->
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(...args) {
      const message = args[0];
      if (message && typeof message === 'string') {
        // Suppress Tailwind CDN warnings
        if (message.includes('cdn.tailwindcss.com should not be used in production') ||
            message.includes('tailwindcss.com') ||
            message.includes('Tailwind CSS')) {
          return; // Suppress these warnings
        }
      }
      originalWarn.apply(console, args);
    };

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />

  <!-- Modular Notification System -->
  <link rel="stylesheet" href="/css/notification-modules.css">
  <script src="/js/notification-modules.js"></script>

  <!-- Socket.IO with SRI -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- ✅ Multi-IP Card Reader Configuration -->
  <script src="/js/card-reader-config.js?v=1755165000"></script>
  <script src="/js/card-reader-service.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary-color: #0d6efd;
      --primary-hover: #138af2;
      --bg-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
    }

    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: "Prompt", sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }



    .bubble {
      width: 110px;
      height: 130px;
      border-radius: 0.75rem;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background-color: var(--primary-color);
      position: relative;
    }

    .bubble:hover {
      background-color: var(--primary-hover);
    }

    .bubble h6 {
      font-size: 0.875rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }

    .stock-count {
      position: absolute;
      bottom: 0.5rem;
      font-size: 0.75rem;
    }

    /* ===== ULTRA MINIMAL CARD STYLES ===== */
    .card {
      background: #ffffff !important;
      border: 1px solid #f1f5f9 !important;
      border-radius: 8px !important;
      padding: 1rem !important;
      margin-bottom: 0.75rem !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      color: #374151 !important;
    }

    .card:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
      border-color: #e2e8f0 !important;
    }

    /* Dark mode card styles */
    .dark .card {
      background: #1f2937 !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;
    }

    .dark .card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
      border-color: #4b5563 !important;
    }

    /* Card text alignment */
    .card h6,
    .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }

    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }

    .dark .card p {
      color: #9ca3af !important;
    }

    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }

    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }

    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }

    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }

    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }

    .card:hover .status-icon {
      opacity: 1 !important;
    }

    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }

    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }

    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }

    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }

    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }

    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }

    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }

    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }

    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }

    .dark .warning-text {
      color: #fbbf24 !important;
    }

    .dark .emergency-text {
      color: #f87171 !important;
    }

    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }

    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .lightOnly {
      display: block;
    }

    .darkOnly {
      display: none;
    }

    .dark .lightOnly {
      display: none !important;
    }

    .dark .darkOnly {
      display: block !important;
    }

    .dark .dark-bg {
      background-color: var(--bg-color);
    }

    .dark .dark-text {
      color: var(--primary-color);
    }

    /* ===== Flip Card ===== */
    .flip-card {
      perspective: 1000px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 0.75rem;
      width: 200px;
      height: 420px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      padding: 0.5rem;
    }

    .flip-card-back {
      transform: rotateY(180deg);
      background-color: var(--bg-color);
    }

    .product-price-big {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    html,
    body {
      overflow-x: hidden;
    }

    #mainContent {
      overflow-y: auto;
    }

    /* แก้ card ไม่ให้สูงเกิน */
    .card {
      max-height: none !important;
      overflow-y: visible !important;
    }

    .product-img {
      width: 200px;
      height: 200px;
      /* กำหนดความสูงคงที่ */
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* Stock type badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 0.375rem;
      line-height: 1;
    }

    .badge-info {
      background-color: #3b82f6;
      color: white;
    }

    .badge-success {
      background-color: #10b981;
      color: white;
    }

    .badge-primary {
      background-color: #8b5cf6;
      color: white;
    }

    .badge-sm {
      padding: 0.125rem 0.375rem;
      font-size: 0.6875rem;
    }

    /* Dark mode support for badges */
    .dark .badge-info {
      background-color: #2563eb;
    }

    .dark .badge-success {
      background-color: #059669;
    }

    .dark .badge-primary {
      background-color: #7c3aed;
    }

    /* Disabled button styles */
    .btn-disabled {
      background-color: #d1d5db !important;
      color: #6b7280 !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
      border: 1px solid #d1d5db !important;
    }

    .btn-disabled:hover {
      background-color: #d1d5db !important;
      color: #6b7280 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    .dark .btn-disabled {
      background-color: #4b5563 !important;
      color: #9ca3af !important;
      border: 1px solid #4b5563 !important;
    }

    .dark .btn-disabled:hover {
      background-color: #4b5563 !important;
      color: #9ca3af !important;
    }

    /* ===== OLD STYLES REMOVED - NOW USING MINIMAL DESIGN ===== */
    .product-name {
      position: absolute;
      top: 48%;
      left: 0.5rem;
      /* หรือจะใช้ left: 50%; transform: translateX(-50%) ก็ได้ */
      font-weight: 800;
    }

    h6 {
      white-space: normal;
      /* อนุญาตให้ตัดบรรทัด */
      word-wrap: break-word;
      /* ตัดคำเมื่อยาวเกิน */
      overflow: visible;
      /* แสดงข้อความทั้งหมด */
    }

    /* เพิ่ม CSS นี้ */
    .section-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      font-size: 1.125rem;
    }

    .cart-table {
      border-collapse: collapse;
    }

    .cart-table th,
    .cart-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
    }



    /* Promotion styles */
    .promotion-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff3b30;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      z-index: 10;
    }

    .promotion-text {
      color: #ff3b30;
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    .price-original {
      text-decoration: line-through;
      color: #999;
      font-size: 14px;
    }

    .price-promo {
      color: #ff3b30;
      font-weight: bold;
    }

    /* เพิ่ม style สำหรับ promotion summary */
    #appliedPromotions {
      margin-top: 8px;
      padding: 8px;
      background: #fef3c7;
      border-radius: 6px;
      font-size: 12px;
    }

    .dark #appliedPromotions {
      background: #78350f;
      color: #fef3c7;
    }

    .promotion-text {
      color: #ff3b30;
      font-size: 12px;
      margin-top: 4px;
    }

    .price-original {
      text-decoration: line-through;
      color: #999;
      font-size: 14px;
    }

    .price-promo {
      color: #ff3b30;
      font-weight: bold;
    }

    /* ===== PROMOTION STYLES ===== */
    /* Badge styling ที่มุมบนขวา */
    .promo-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ff3838 100%);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(255, 56, 56, 0.4);
      z-index: 20;
    }

    /* Promo Banner สำหรับ Level Cards */
    .level-promo-banner {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #ff6b6b 0%, #ff3838 50%, #ff6b6b 100%);
      background-size: 200% 100%;
      color: white;
      text-align: center;
      padding: 4px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 0.5rem 0.5rem 0 0;
    }

    /* Floating Promo Text */
    .floating-promo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 56, 56, 0.95);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 4px 15px rgba(255, 56, 56, 0.3);
    }

    /* Card with Promo Border */
    .card.has-promotion {
      position: relative;
      overflow: hidden;
    }

    .card.has-promotion::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ff6b6b, #ff3838, #ff6b6b, #ff3838);
      background-size: 400% 400%;
      border-radius: inherit;
      z-index: -1;
    }

    /* Promo Corner Ribbon */
    .promo-ribbon {
      position: absolute;
      top: 10px;
      right: -30px;
      background: linear-gradient(135deg, #ff3838 0%, #ff6b6b 100%);
      color: white;
      padding: 5px 40px;
      font-size: 11px;
      font-weight: 700;
      transform: rotate(45deg);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    /* Sparkle Effect */
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
    }

    /* Multiple sparkles with positioning */
    .sparkle:nth-child(1) {
      top: 10%;
      left: 20%;
    }

    .sparkle:nth-child(2) {
      top: 20%;
      right: 10%;
    }

    .sparkle:nth-child(3) {
      bottom: 15%;
      left: 15%;
    }

    .sparkle:nth-child(4) {
      bottom: 20%;
      right: 20%;
    }

    .sparkle:nth-child(5) {
      top: 50%;
      left: 50%;
    }

    /* Hot Deal Tag */
    .hot-deal-tag {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #ff3838;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    /* Promo Text */
    .promo-text-animated {
      background: linear-gradient(90deg, #ff3838, #ff6b6b, #ff3838);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      font-weight: 700;
    }

    /* Quick Actions Menu Dropdown Styles */
    .rotate-180 {
      transform: rotate(180deg);
    }

    .bi-chevron-down {
      transition: transform 0.2s ease;
    }

    #quickActionsDropdown {
      animation: dropdownFadeIn 0.2s ease-out;
      transform-origin: top right;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Dropdown hover effects */
    #quickActionsDropdown a {
      transition: all 0.2s ease;
      border-radius: 8px;
      margin: 2px 8px;
    }

    #quickActionsDropdown a:hover,
    #quickActionsDropdown a.bg-gray-100 {
      transform: translateX(4px);
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #quickActionsDropdown a:active {
      transform: translateX(2px) scale(0.98);
    }

    /* Dark mode support for dropdown */
    .dark #quickActionsDropdown {
      background: #374151;
      border-color: #6b7280;
    }

    .dark #quickActionsDropdown .border-gray-100 {
      border-color: #6b7280;
    }

    .dark #quickActionsDropdown a {
      color: #e5e7eb;
    }

    .dark #quickActionsDropdown a:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
    }

    /* 🔥 Fire Icon */
    .promo-fire-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 32px;
      z-index: 30;
      filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
    }

    /* Override สำหรับ cards ให้แสดง overflow */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
    }

    /* Customer Search Styles */
    #customerSearchResults {
      z-index: 10;
    }

    .customer-result-item:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }

    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    [data-theme="dark"] .loading-spinner {
      border-color: #555555;
      border-top-color: var(--primary-color);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== CONNECTION STATUS STYLES ===== */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .connection-status.online {
      color: #10b981;
    }

    .connection-status.offline {
      color: #ef4444;
    }

    .connection-status.connecting {
      color: #f59e0b;
    }

    /* Status indicators */
    #firebaseStatus.connected {
      background-color: #10b981 !important;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
    }

    #firebaseStatus.disconnected {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    #socketStatus.connected {
      background-color: #3b82f6 !important;
      box-shadow: 0 0 4px rgba(59, 130, 246, 0.5);
    }

    #socketStatus.disconnected {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    /* Pulse animation for connecting state */
    .connection-status.connecting::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #f59e0b;
      margin-right: 4px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    /* Dark mode support */
    .dark .connection-status.online {
      color: #34d399;
    }

    .dark .connection-status.offline {
      color: #f87171;
    }

    .dark .connection-status.connecting {
      color: #fbbf24;
    }

    /* ===== PRINTER STATUS STYLES ===== */
    .printer-status-indicator {
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .printer-status-indicator.online {
      color: #10b981;
    }

    .printer-status-indicator.offline {
      color: #ef4444;
    }

    .printer-status-indicator.checking {
      color: #f59e0b;
    }

    .printer-status-indicator.error {
      color: #ef4444;
    }

    /* Printer status dot */
    #printerStatus.online {
      background-color: #10b981 !important;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
    }

    #printerStatus.offline {
      background-color: #ef4444 !important;
      box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
    }

    #printerStatus.checking {
      background-color: #f59e0b !important;
      box-shadow: 0 0 4px rgba(245, 158, 11, 0.5);
      animation: pulse 1.5s infinite;
    }



    /* Dark mode support for printer status */
    .dark .printer-status-indicator.online {
      color: #34d399;
    }

    .dark .printer-status-indicator.offline,
    .dark .printer-status-indicator.error {
      color: #f87171;
    }

    .dark .printer-status-indicator.checking {
      color: #fbbf24;
    }
  </style>

  <style>
    /* ===== Enhanced Province-District-Subdistrict Dropdown Styles ===== */
    .dropdown-content {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      animation: dropdownFadeIn 0.2s ease-out;
      font-family: 'Prompt', sans-serif;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover, .dropdown-item.selected {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .dropdown-item-main {
      font-weight: 500;
      font-size: 14px;
      color: #1f2937;
    }

    .dropdown-item-sub {
      font-size: 12px;
      color: #6b7280;
    }

    .dropdown-loading {
      padding: 16px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .dropdown-no-results {
      padding: 16px;
      text-align: center;
      color: #9ca3af;
      font-size: 14px;
      font-style: italic;
    }

    /* Dark mode support for dropdown */
    .dark .dropdown-content {
      background: #374151;
      border-color: #6b7280;
      color: #e5e7eb;
    }

    .dark .dropdown-item {
      border-bottom-color: #4b5563;
    }

    .dark .dropdown-item:hover, .dark .dropdown-item.selected {
      background-color: #4338ca;
      color: #c7d2fe;
    }

    .dark .dropdown-item-main {
      color: #f9fafb;
    }

    .dark .dropdown-item-sub {
      color: #d1d5db;
    }

    .dark .dropdown-loading, .dark .dropdown-no-results {
      color: #9ca3af;
    }

    /* Enhanced Input Validation Styles */
    .input.border-green-500 {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.1);
    }
    
    .input.border-yellow-500 {
      border-color: #f59e0b !important;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.1);
    }
    
    .input.border-red-500 {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.1);
    }
    
    /* Zipcode input enhancements */
    #zipcode:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
    }
    
    #zipcode.border-green-500:focus {
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.15);
    }
    
    #zipcode.border-yellow-500:focus {
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
    }
    
    #zipcode.border-red-500:focus {
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.15);
    }

    /* Status message styling */
    .status-success {
      color: #10b981;
      background-color: rgba(16, 185, 129, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-warning {
      color: #f59e0b;
      background-color: rgba(245, 158, 11, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-error {
      color: #ef4444;
      background-color: rgba(239, 68, 68, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Dark mode for status messages */
    .dark .status-success {
      color: #34d399;
      background-color: rgba(52, 211, 153, 0.1);
    }

    .dark .status-warning {
      color: #fbbf24;
      background-color: rgba(251, 191, 36, 0.1);
    }

    .dark .status-error {
      color: #f87171;
      background-color: rgba(248, 113, 113, 0.1);
    }

    /* Input focus states */
    .input-enhanced:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Responsive dropdown */
    @media (max-width: 640px) {
      .dropdown-content {
        max-height: 150px;
      }
    }
  </style>

  <!-- Loading System - Remove problematic CSS link -->

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Loading Overlay CSS (Updated from addNewProduct_pattani.html) -->
  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <script>
    // Read depositNavigationData from sessionStorage and initialize page state
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const navDataRaw = sessionStorage.getItem('depositNavigationData');
        if (navDataRaw) {
          const navData = JSON.parse(navDataRaw);
          console.log('🔗 depositNavigationData loaded for frontstore:', navData);
    
          // ตรวจสอบการจองสต็อก
          if (navData.hasStockReservation && navData.stockReservation) {
            console.log('🔒 Stock reservation detected:', navData.stockReservation);
    
            // แสดงข้อความแจ้งเตือนเกี่ยวกับการจองสต็อก
            if (typeof showToast === 'function') {
              showToast(
                `พบการจองสต็อก: ${navData.stockReservation.productName} สำหรับ ${navData.stockReservation.customerName}`,
                'info'
              );
            }
          }
    
          // Auto-add product to cart if available
          if (navData.product && navData.product._id) {
            console.log('📦 Auto-adding product from deposit receipt:', navData.product);
    
            // Wait for cart system to be ready
            setTimeout(() => {
              try {
                // Create product object for adding to cart
                const productForCart = {
                  _id: navData.product._id,
                  name: navData.product.name,
                  brand: navData.product.brand,
                  model: navData.product.model,
                  price: navData.product.price,
                  imei: navData.product.imei,
                  category: navData.product.category,
                  quantity: 1,
                  fromDepositReceipt: true,
                  depositReceiptId: navData.depositReceiptId,
                  depositAmount: navData.amounts?.depositAmount || 0,
                  stockReservation: navData.stockReservation || null,
                  hasStockReservation: navData.hasStockReservation || false
                };
    
                // Add to cart if addToCart function exists
                if (typeof addToCart === 'function') {
                  // Call addToCart with correct parameters: (id, name, price, imei, taxType, model, poNumber, supplier)
                  addToCart(
                    navData.product._id,
                    navData.product.name,
                    navData.product.price,
                    navData.product.imei || '',
                    'inclusive', // Default tax type
                    navData.product.model || '',
                    '', // poNumber
                    '' // supplier
                  );
                  console.log('✅ Product added to cart from deposit receipt');
                } else {
                  console.log('⚠️ addToCart function not yet available, storing for later');
                  // Store for later use when cart system is ready
                  window.pendingDepositProduct = {
                    id: navData.product._id,
                    name: navData.product.name,
                    price: navData.product.price,
                    imei: navData.product.imei || '',
                    taxType: 'inclusive',
                    model: navData.product.model || '',
                    poNumber: '',
                    supplier: '',
                    fromDepositReceipt: true,
                    depositReceiptId: navData.depositReceiptId,
                    depositAmount: navData.amounts?.depositAmount || 0
                  };
                }
    
                // Pre-fill customer information if available
                if (navData.customer) {
                  console.log('👤 Pre-filling customer data:', navData.customer);

                  // Fill customer prefix (คำนำหน้า)
                  const prefixInput = document.getElementById('customerPrefix');
                  if (prefixInput && navData.customer.prefix) {
                    prefixInput.value = navData.customer.prefix;
                    console.log('✅ Customer prefix pre-filled:', navData.customer.prefix);
                  }

                  // Fill customer first name
                  const firstNameInput = document.getElementById('customerFirstName');
                  if (firstNameInput && navData.customer.firstName) {
                    firstNameInput.value = navData.customer.firstName;
                    console.log('✅ Customer first name pre-filled:', navData.customer.firstName);
                  }

                  // Fill customer last name
                  const lastNameInput = document.getElementById('customerLastName');
                  if (lastNameInput && navData.customer.lastName) {
                    lastNameInput.value = navData.customer.lastName;
                    console.log('✅ Customer last name pre-filled:', navData.customer.lastName);
                  }

                  // Fill customer phone
                  const phoneInput = document.getElementById('customerPhone');
                  if (phoneInput && navData.customer.phone) {
                    phoneInput.value = navData.customer.phone;
                    console.log('✅ Customer phone pre-filled:', navData.customer.phone);
                  }

                  // Fill birth date (convert to yyyy-MM-dd format)
                  const birthDateInput = document.getElementById('customerBirthDate');
                  if (birthDateInput && navData.customer.birthDate) {
                    // Convert ISO string to yyyy-MM-dd format
                    const birthDate = new Date(navData.customer.birthDate);
                    const formattedDate = birthDate.toISOString().split('T')[0];
                    birthDateInput.value = formattedDate;
                    console.log('✅ Customer birth date pre-filled:', formattedDate);
                  }

                  // Fill tax ID
                  const taxIdInput = document.getElementById('customerTaxId');
                  if (taxIdInput && navData.customer.taxId) {
                    taxIdInput.value = navData.customer.taxId;
                    console.log('✅ Customer tax ID pre-filled:', navData.customer.taxId);
                  }

                  // Fill address details
                  const houseNoInput = document.getElementById('houseNo');
                  if (houseNoInput && navData.customer.houseNo) {
                    houseNoInput.value = navData.customer.houseNo;
                    console.log('✅ Customer house no pre-filled:', navData.customer.houseNo);
                  }

                  const mooInput = document.getElementById('moo');
                  if (mooInput && navData.customer.moo) {
                    mooInput.value = navData.customer.moo;
                    console.log('✅ Customer moo pre-filled:', navData.customer.moo);
                  }

                  const subDistrictInput = document.getElementById('subDistrict');
                  if (subDistrictInput && navData.customer.subDistrict) {
                    subDistrictInput.value = navData.customer.subDistrict;
                    console.log('✅ Customer sub-district pre-filled:', navData.customer.subDistrict);
                  }

                  const districtInput = document.getElementById('district');
                  if (districtInput && navData.customer.district) {
                    districtInput.value = navData.customer.district;
                    console.log('✅ Customer district pre-filled:', navData.customer.district);
                  }

                  const provinceInput = document.getElementById('province');
                  if (provinceInput && navData.customer.province) {
                    provinceInput.value = navData.customer.province;
                    console.log('✅ Customer province pre-filled:', navData.customer.province);
                  }

                  const zipcodeInput = document.getElementById('zipcode');
                  if (zipcodeInput && navData.customer.zipcode) {
                    zipcodeInput.value = navData.customer.zipcode;
                    console.log('✅ Customer zipcode pre-filled:', navData.customer.zipcode);
                  }
                }
    
                // Show success notification
                if (typeof showNotification === 'function') {
                  showNotification('success', 'ข้อมูลจากใบรับเงินมัดจำถูกโหลดแล้ว');
                }
    
                // Clear the session storage after use
                sessionStorage.removeItem('depositNavigationData');
                console.log('🧹 depositNavigationData cleared from sessionStorage');
    
              } catch (error) {
                console.error('❌ Error processing deposit navigation data:', error);
              }
            }, 1000); // Wait 1 second for page to fully load
          }
        } else {
          console.log('ℹ️ No depositNavigationData found in sessionStorage for frontstore');
        }
      } catch (err) {
        console.error('❌ Error loading depositNavigationData for frontstore:', err);
      }
    });
  </script>

  
  <!-- Sidebar Container - จะถูกเติมด้วย sidebar.js -->
  <div id="sidebarContainer"></div>

  <div id="mainContent" class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out">
    <!-- Header -->
    <header
      class="p-4 bg-white dark:bg-gray-800
             border-b border-gray-200 dark:border-gray-700
             flex items-center justify-between"
    >
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">ระบบขายสด</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          กำลังโหลดสาขา...
        </p>
      </div>
      
      <!-- Modular Notifications & Actions -->
      <div class="flex items-center gap-4">
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-1">
            <span id="connectionStatus" class="connection-status offline text-xs font-medium">🔴 เชื่อมต่อ...</span>
            <div class="flex gap-1 ml-2">
              <div id="firebaseStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Firebase Status"></div>
              <div id="socketStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Socket.IO Status"></div>
              <div id="printerStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Printer Status"></div>
            </div>
          </div>
          <div id="onlineUserCount" class="text-xs text-gray-500" title="ผู้ใช้ออนไลน์">1</div>
        </div>

        <!-- Printer Status Badge -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-2">
            <span id="printer-status-badge" class="badge badge-warning text-xs">🟡 ตรวจสอบ...</span>
            <div id="printer-status-indicator" class="printer-status-indicator checking text-xs">ตรวจสอบสถานะ...</div>
          </div>
          <button id="manual-printer-check" class="btn btn-xs btn-ghost"
                  title="ตรวจสอบเครื่องพิมพ์"
                  aria-label="ตรวจสอบสถานะเครื่องพิมพ์ใหม่"
                  aria-describedby="printer-status-indicator">
            <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
          </button>
        </div>

        <!-- POS Notification Bell -->
        <div class="notification-bell pos-module" id="posNotificationBell">
          <button class="notification-toggle"
                  title="แจ้งเตือน POS"
                  aria-label="เปิดเมนูแจ้งเตือนระบบ POS"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="posNotificationDropdown">
            <i class="bi bi-bell" aria-hidden="true"></i>
            <span class="notification-badge" id="posNotificationCount" aria-label="จำนวนการแจ้งเตือนใหม่">0</span>
          </button>
          
          <!-- Dropdown Notifications -->
          <div class="notification-dropdown" id="posNotificationDropdown">
            <div class="notification-header">
              <h3><i class="bi bi-shop-window"></i> แจ้งเตือน POS</h3>
              <div class="notification-actions">
                <button class="mark-all-read" onclick="markAllAsRead('pos')">
                  <i class="bi bi-check-all"></i>
                </button>
                <button class="clear-all" onclick="clearAllNotifications('pos')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            <div class="notification-list" id="posNotificationList">
              <!-- Notifications will be inserted here -->
            </div>
          </div>
        </div>

                 <!-- Quick Actions Menu -->
         <div class="relative">
           <button id="quickActionsBtn" class="btn btn-outline flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300">
             <i class="bi bi-list text-lg"></i>
             <span class="hidden md:inline">เมนูด่วน</span>
             <i class="bi bi-chevron-down text-sm ml-1"></i>
           </button>
           
           <!-- Dropdown Menu -->
           <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
             <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between">
               <span>เลือกหน้าที่ต้องการ</span>
               <span id="dropdownBranchInfo" class="text-xs text-gray-400">สาขา: สำนักงานใหญ่</span>
             </div>
             
             <a href="HistoryReceipt" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200">
               <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                 <i class="bi bi-receipt text-blue-600"></i>
               </div>
               <div>
                 <div class="font-medium">ใบเสร็จ/ใบกำกับภาษี</div>
                 <div class="text-xs text-gray-500">ดูประวัติและจัดการใบเสร็จ</div>
               </div>
             </a>
             
             
            
             <!-- Footer with shortcuts -->
             <div class="px-4 py-2 border-t border-gray-100 mt-2">
               <div class="flex items-center justify-between text-xs text-gray-400">
                 <div class="flex flex-col">
                   <span>↑↓ เลือก • Enter ยืนยัน • Esc ปิด</span>
                   <span class="mt-1">Alt+M หรือ Ctrl+M เปิดเมนู</span>
                 </div>
                 <span id="connectionStatusMenu" class="flex items-center gap-1">
                   <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                   ออนไลน์
                 </span>
               </div>
             </div>
           </div>
         </div>
      </div>
    </header>

    <!-- Toast Notification Container for POS Module -->
    <div id="posToastContainer" class="toast-container pos-module"></div>

    <!-- เพิ่ม container หลักสำหรับ content -->
    <div class="flex-1 flex gap-4 p-4 overflow-auto">
      <!-- Left Column: Product Grid -->
      <div class="flex-1">
        <!-- HTML ส่วนค้นหา ใหม่ -->
        <div class="card p-4"> <!-- This card might need padding adjustment if the global .card style adds 1rem -->
          <div class="flex gap-2">
            <input type="text" id="searchQuery" class="input input-bordered w-full"
              placeholder="ค้นหาสินค้า หรือ IMEI..."
              aria-label="ช่องค้นหาสินค้า"
              aria-describedby="search-help" />
            <button id="btnSearch" class="btn btn-primary hidden"
              aria-label="ค้นหาสินค้า">
              <i class="bi bi-search" aria-hidden="true"></i> ค้นหา
            </button>
            <button id="btnReset" class="btn btn-secondary"
              aria-label="รีเซ็ตการค้นหาและกลับไปหน้าแรก">
              <i class="bi bi-x-circle" aria-hidden="true"></i> รีเซ็ต
            </button>
          </div>
        </div>

        <!-- Barcode Scanner Section -->
        <div class="card p-4">
          <h5 class="mb-3 font-semibold flex items-center gap-2" id="barcode-section-title">
            <i class="bi bi-upc-scan text-blue-600" aria-hidden="true"></i>
            สแกนบาร์โค้ด
          </h5>
          <div class="flex gap-2" role="group" aria-labelledby="barcode-section-title">
            <input type="text" id="barcodeInput" class="input input-bordered flex-1"
              placeholder="สแกนหรือพิมพ์บาร์โค้ดสินค้า..."
              aria-label="ช่องใส่บาร์โค้ดสินค้า"
              aria-describedby="barcode-help" />
            <button id="btnAddBarcode" class="btn btn-primary"
              title="เพิ่มสินค้าจากบาร์โค้ด"
              aria-label="เพิ่มสินค้าจากบาร์โค้ดที่ใส่">
              <i class="bi bi-plus-circle" aria-hidden="true"></i> เพิ่ม
            </button>
            <button id="btnClearBarcode" class="btn btn-secondary"
              title="ล้างบาร์โค้ด"
              aria-label="ล้างข้อมูลในช่องบาร์โค้ด">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
            </button>
          </div>
          <div class="text-xs text-gray-500 mt-2" id="barcode-help">
            💡 <strong>เคล็ดลับ:</strong> สแกนบาร์โค้ดหรือพิมพ์รหัสแล้วกด Enter | สินค้าจะถูกเพิ่มลงตะกร้าโดยอัตโนมัติ
          </div>
          <!-- Hidden helper text for screen readers -->
          <div id="search-help" class="sr-only">
            ใส่ชื่อสินค้า หมายเลข IMEI หรือบาร์โค้ดเพื่อค้นหาสินค้า
          </div>
          
          <!-- Barcode Results -->
          <div id="barcodeResults" class="mt-3 hidden">
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-check-circle text-green-600"></i>
                <span class="text-sm font-semibold text-green-800 dark:text-green-200">พบสินค้า</span>
              </div>
              <div id="barcodeProductInfo" class="text-sm text-green-700 dark:text-green-300 mt-1">
                <!-- Product info will be displayed here -->
              </div>
            </div>
          </div>
        </div>

        <script>
          // ฟังก์ชันสำหรับรีเซ็ตช่องค้นหา
          document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('searchQuery').value = ''; // เคลียร์ค่าช่องค้นหา
            SecurityHelpers.safeSetContent(document.getElementById('imeiResultGrid'), '', ''); // ล้างผลลัพธ์การค้นหา
            document.getElementById('imeiResultContainer').classList.add('hidden'); // ซ่อนผลลัพธ์การค้นหา
            goBackToLevel1(); // กลับไปหน้า Level 1
          });
        </script>

        <!-- Container ผลลัพธ์การค้นหา -->
        <div id="imeiResultContainer" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <h5 class="mb-2 font-semibold">ผลลัพธ์การค้นหา</h5>
          <div id="imeiResultGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 1 -->
        <div id="level1Container" class="card p-4"> <!-- This card might need padding adjustment -->
          <h5 class="mb-3">Level 1 – แบรนด์สินค้า</h5>
          <div id="level1Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 2 -->
        <div id="level2Container" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <div class="flex justify-between items-center mb-3">
            <h5 id="level2Title">รายการของ …</h5>
            <button id="btnGoBack" class="btn btn-sm">ย้อนกลับ</button>
          </div>
          <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Level 3 -->
        <div id="level3Container" class="card p-4 hidden"> <!-- This card might need padding adjustment -->
          <div class="flex justify-between items-center mb-3">
            <h5 id="level3Title">รายละเอียดสินค้า</h5>
            <button id="btnGoBackToLevel2" class="btn btn-sm">ย้อนกลับ</button>
          </div>
          <div id="level3Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          </div>
        </div>
      </div> <!-- End Left Column -->

      <!-- Right Column: Customer, Cart, Summary -->
      <div class="w-80 flex flex-col gap-4">
        <!-- Customer Info -->
        <div class="card p-4"> <!-- This card might need padding adjustment -->
          <h5 class="flex items-center gap-2 mb-3">
            <i class="bi bi-person-badge"></i> ข้อมูลลูกค้า
          </h5>

          <div class="flex gap-2 mb-4">
            <button id="btnReadCard" class="btn btn-info flex-1 flex items-center justify-center gap-2">
              <i class="bi bi-credit-card-2-front"></i> อ่านข้อมูลจากบัตรประชาชน
            </button>
            <button id="btnTestCardReader" class="btn btn-outline btn-info flex items-center justify-center gap-1 px-3" title="ทดสอบเครื่องอ่านบัตร">
              <i class="bi bi-tools"></i>
            </button>
            <button id="btnTestFillData" class="btn btn-outline btn-success flex items-center justify-center gap-1 px-3" title="ทดสอบรูปแบบบัตรจริง (# delimiter format)">
              <i class="bi bi-check2-square"></i>
            </button>
          </div>

          <!-- เพิ่มส่วนค้นหาลูกค้าตรงนี้ -->
          <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <label class="label">
              <span class="label-text font-semibold">
                <i class="bi bi-search"></i> ค้นหาลูกค้าเก่า
              </span>
            </label>
            <div class="flex gap-2">
              <input type="text" id="customerSearch" class="input input-bordered flex-1"
                placeholder="ค้นหาด้วยเลขบัตรประชาชน 13 หลัก" maxlength="13" />
              <button id="btnSearchCustomer" class="btn btn-primary" title="ค้นหาลูกค้า">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              💡 <strong>เคล็ดลับ:</strong> พิมพ์ครบ 13 หลักจะค้นหาอัตโนมัติ | ระบบจำกัดการค้นหา 3 วินาที/ครั้ง
            </div>

            <!-- ผลการค้นหา -->
            <div id="customerSearchResults" class="mt-3 hidden">
              <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                  <!-- Results will be inserted here -->
                </div>
              </div>
            </div>
          </div>
          <!-- จบส่วนค้นหาลูกค้า -->

          <!-- เลือกประเภทลูกค้า -->
          <div class="mb-4">
            <label class="label"><span class="label-text font-semibold">ประเภทลูกค้า</span></label>
            <select id="customerType" class="select select-bordered w-full">
              <option value="individual">บุคคลธรรมดา</option>
              <option value="corporate">นิติบุคคล</option>
            </select>
          </div>

          <!-- ฟิลด์บุคคลธรรมดา -->
          <div id="personalFields" class="grid grid-cols-2 gap-3">
            <div>
              <label class="label"><span class="label-text">คำนำหน้า</span></label>
              <select id="customerPrefix" class="select select-bordered w-full">
                <option value="">- เลือก -</option>
                <option value="นาย">นาย</option>
                <option value="นาง">นาง</option>
                <option value="นางสาว">น.ส.</option>
              </select>
            </div>
            <div>
              <label class="label"><span class="label-text">เพศ</span></label>
              <select id="customerGender" class="select select-bordered w-full">
                <option value="">- เลือกเพศ -</option>
                <option value="ชาย">ชาย</option>
                <option value="หญิง">หญิง</option>
                <option value="ไม่ระบุ">ไม่ระบุ</option>
              </select>
            </div>
            <div>
              <label class="label"><span class="label-text">ชื่อ</span></label>
              <input type="text" id="customerFirstName" class="input input-bordered w-full" placeholder="ชื่อ" />
            </div>
            <div>
              <label class="label"><span class="label-text">นามสกุล</span></label>
              <input type="text" id="customerLastName" class="input input-bordered w-full" placeholder="นามสกุล" />
            </div>
            <div>
              <label class="label"><span class="label-text">เบอร์โทร</span></label>
              <input type="text" id="customerPhone" class="input input-bordered w-full" placeholder="เบอร์โทร" />
            </div>
            <div>
              <label class="label"><span class="label-text">อาชีพ</span></label>
              <select id="customerOccupation" class="select select-bordered w-full">
                <option value="">- เลือกอาชีพ -</option>
                <option value="รับราชการ">รับราชการ</option>
                <option value="พนักงานบริษัทเอกชน">พนักงานบริษัทเอกชน</option>
                <option value="ข้าราชการครู">ข้าราชการครู</option>
                <option value="แพทย์">แพทย์</option>
                <option value="พยาบาล">พยาบาล</option>
                <option value="วิศวกร">วิศวกร</option>
                <option value="ทนายความ">ทนายความ</option>
                <option value="นักบัญชี">นักบัญชี</option>
                <option value="ธุรกิจส่วนตัว">ธุรกิจส่วนตัว</option>
                <option value="เกษตรกร">เกษตรกร</option>
                <option value="ค้าขาย">ค้าขาย</option>
                <option value="ช่างเทคนิค">ช่างเทคนิค</option>
                <option value="คนขับรถ">คนขับรถ</option>
                <option value="ป้องกันและรักษาความปลอดภัย">ป้องกันและรักษาความปลอดภัย</option>
                <option value="พนักงานธนาคาร">พนักงานธนาคาร</option>
                <option value="นักการเงิน">นักการเงิน</option>
                <option value="ครูอาชีวะ">ครูอาชีวะ</option>
                <option value="อาจารย์มหาวิทยาลัย">อาจารย์มหาวิทยาลัย</option>
                <option value="นักวิจัย">นักวิจัย</option>
                <option value="นักข่าว">นักข่าว</option>
                <option value="ช่างภาพ">ช่างภาพ</option>
                <option value="นักออกแบบ">นักออกแบบ</option>
                <option value="ช่างตัดผม">ช่างตัดผม</option>
                <option value="ช่างซ่อมรถ">ช่างซ่อมรถ</option>
                <option value="ช่างไฟฟ้า">ช่างไฟฟ้า</option>
                <option value="ช่างประปา">ช่างประปา</option>
                <option value="ช่างก่อสร้าง">ช่างก่อสร้าง</option>
                <option value="นักดนตรี">นักดนตรี</option>
                <option value="นักแสดง">นักแสดง</option>
                <option value="นักเขียน">นักเขียน</option>
                <option value="นักกีฬา">นักกีฬา</option>
                <option value="พ่อครัว/แม่ครัว">พ่อครัว/แม่ครัว</option>
                <option value="พนักงานเสิร์ฟ">พนักงานเสิร์ฟ</option>
                <option value="พนักงานขาย">พนักงานขาย</option>
                <option value="พนักงานต้อนรับ">พนักงานต้อนรับ</option>
                <option value="เจ้าหน้าที่โรงแรม">เจ้าหน้าที่โรงแรม</option>
                <option value="ไกด์นำเที่ยว">ไกด์นำเที่ยว</option>
                <option value="นักท่องเที่ยว">นักท่องเที่ยว</option>
                <option value="นวดแผนไทย">นวดแผนไทย</option>
                <option value="หมอตำแย">หมอตำแย</option>
                <option value="ยาม">ยาม</option>
                <option value="คนขับแท็กซี่">คนขับแท็กซี่</option>
                <option value="คนขับรถตู้">คนขับรถตู้</option>
                <option value="คนขับมอเตอร์ไซค์รับจ้าง">คนขับมอเตอร์ไซค์รับจ้าง</option>
                <option value="แรงงานก่อสร้าง">แรงงานก่อสร้าง</option>
                <option value="แม่บ้าน">แม่บ้าน</option>
                <option value="พี่เลี้ยงเด็ก">พี่เลี้ยงเด็ก</option>
                <option value="คนสวน">คนสวน</option>
                <option value="เลี้ยงสัตว์">เลี้ยงสัตว์</option>
                <option value="ประมง">ประมง</option>
                <option value="ปศุสัตว์">ปศุสัตว์</option>
                <option value="เจ้าของกิจการ">เจ้าของกิจการ</option>
                <option value="ผู้บริหาร">ผู้บริหาร</option>
                <option value="ที่ปรึกษา">ที่ปรึกษา</option>
                <option value="นักวิเคราะห์">นักวิเคราะห์</option>
                <option value="โปรแกรมเมอร์">โปรแกรมเมอร์</option>
                <option value="ผู้ดูแลระบบ">ผู้ดูแลระบบ</option>
                <option value="นักการตลาด">นักการตลาด</option>
                <option value="เซลล์">เซลล์</option>
                <option value="ตัวแทนขาย">ตัวแทนขาย</option>
                <option value="นายหน้า">นายหน้า</option>
                <option value="เจ้าหน้าที่บัญชี">เจ้าหน้าที่บัญชี</option>
                <option value="เจ้าหน้าที่การเงิน">เจ้าหน้าที่การเงิน</option>
                <option value="เจ้าหน้าที่HR">เจ้าหน้าที่HR</option>
                <option value="เลขานุการ">เลขานุการ</option>
                <option value="แคชเชียร์">แคชเชียร์</option>
                <option value="พนักงานคลังสินค้า">พนักงานคลังสินค้า</option>
                <option value="คนส่งของ">คนส่งของ</option>
                <option value="พนักงานทำความสะอาด">พนักงานทำความสะอาด</option>
                <option value="นักเรียน">นักเรียน</option>
                <option value="นักศึกษา">นักศึกษา</option>
                <option value="เกษียณอายุ">เกษียณอายุ</option>
                <option value="ว่างงาน">ว่างงาน</option>
                <option value="ธุรกิจออนไลน์">ธุรกิจออนไลน์</option>
                <option value="อื่นๆ">อื่นๆ</option>
              </select>
            </div>
            <div>
              <label class="label">
                <span class="label-text">วันเดือนปีเกิด</span>
                <span class="label-text-alt text-xs text-gray-500">คำนวณอายุอัตโนมัติ</span>
              </label>
              <input type="date" id="customerBirthDate" class="input input-bordered w-full"
                     title="เลือกวันเกิด ระบบจะคำนวณอายุให้อัตโนมัติ" />
            </div>
            <div>
              <label class="label"><span class="label-text">อายุ</span></label>
              <input type="number" id="customerAge" class="input input-bordered w-full" placeholder="อายุ" min="0" max="150" readonly />
            </div>
            <div>
              <label class="label">
                <span class="label-text">รหัสแนะนำ</span>
                <span class="label-text-alt text-xs text-green-600">ได้แต้มโบนัส!</span>
              </label>
              <input type="text" id="referralCode" class="input input-bordered w-full" 
                     placeholder="รหัสแนะนำ (ไม่บังคับ)" 
                     title="ใส่รหัสแนะนำเพื่อรับแต้มโบนัส" />
              <div id="referralStatus" class="text-xs mt-1 hidden">
                <!-- แสดงสถานะการตรวจสอบรหัสแนะนำ -->
              </div>
            </div>
            <div></div> <!-- Empty div for grid alignment -->
            <div>
              <label class="label"><span class="label-text">บ้านเลขที่</span></label>
              <input type="text" id="houseNo" class="input input-bordered w-full" placeholder="บ้านเลขที่" />
            </div>
            <div>
              <label class="label"><span class="label-text">หมู่</span></label>
              <input type="text" id="moo" class="input input-bordered w-full" placeholder="หมู่" />
            </div>
            <div>
              <label class="label"><span class="label-text">จังหวัด</span></label>
              <div class="relative">
                <input type="text" id="province" class="input input-bordered w-full" placeholder="จังหวัด" autocomplete="off" />
                <div id="provinceDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">คลิกเพื่อดูรายการทั้งหมด หรือพิมพ์เพื่อค้นหา</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">อำเภอ</span></label>
              <div class="relative">
                <input type="text" id="district" class="input input-bordered w-full" placeholder="อำเภอ" autocomplete="off" />
                <div id="districtDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">เลือกจังหวัดก่อน แล้วคลิกเพื่อดูรายการอำเภอ</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">ตำบล</span></label>
              <div class="relative">
                <input type="text" id="subDistrict" class="input input-bordered w-full" placeholder="ตำบล" autocomplete="off" />
                <div id="subDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                  <div class="p-2 text-sm text-gray-500 text-center">เลือกอำเภอก่อน แล้วคลิกเพื่อดูรายการตำบล</div>
                </div>
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">รหัสไปรษณีย์</span></label>
              <div class="relative">
                <input type="text" id="zipcode" 
                  class="input input-bordered w-full pr-10" 
                  placeholder="รหัสไปรษณีย์" 
                  maxlength="5" 
                  pattern="[0-9]{5}"
                  title="รหัสไปรษณีย์ 5 หลัก" />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <i class="bi bi-geo-alt text-gray-400"></i>
                </div>
                <div id="zipcodeStatus" class="mt-1 text-xs hidden">
                  <span id="zipcodeIcon"></span>
                  <span id="zipcodeMessage"></span>
                </div>
              </div>
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">อีเมล</span></label>
              <input type="email" id="customerEmailPersonal" class="input input-bordered w-full" placeholder="อีเมล (ถ้ามี)" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">เลขประจำตัวผู้เสียภาษี</span></label>
              <input type="text" id="customerTaxId" class="input input-bordered w-full" placeholder="" />
            </div>
          </div>

          <!-- ฟิลด์นิติบุคคล (ซ่อนเริ่มต้น) -->
          <div id="corporateFields" class="grid grid-cols-2 gap-3 hidden">
            <div class="col-span-2">
              <label class="label"><span class="label-text">ชื่อบริษัท</span></label>
              <input type="text" id="companyName" class="input input-bordered w-full" placeholder="ชื่อบริษัท" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">เลขทะเบียนนิติบุคคล</span></label>
              <input type="text" id="companyTaxId" class="input input-bordered w-full"
                placeholder="เลขทะเบียนนิติบุคคล" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">ผู้ติดต่อหลัก</span></label>
              <input type="text" id="contactPerson" class="input input-bordered w-full"
                placeholder="ชื่อผู้ติดต่อหลัก" />
            </div>
            <div>
              <label class="label"><span class="label-text">เบอร์โทร (บริษัท)</span></label>
              <input type="text" id="corporatePhone" class="input input-bordered w-full" placeholder="เบอร์โทรบริษัท" />
            </div>
            <div>
              <label class="label"><span class="label-text">อีเมล (บริษัท)</span></label>
              <input type="email" id="corporateEmail" class="input input-bordered w-full" placeholder="อีเมลบริษัท" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text">ที่อยู่บริษัท</span></label>
              <input type="text" id="companyAddress" class="input input-bordered w-full" placeholder="ที่อยู่บริษัท" />
            </div>
          </div>
        </div>

        <div class="card">
          <h5 class="section-title flex items-center gap-2">
            <i class="bi bi-cart4"></i> ตะกร้าสินค้า
            <span class="text-sm font-normal text-gray-500">(<span id="cartCount">0</span> รายการ)</span>
          </h5>


          <div class="overflow-y-auto max-h-96">
            <table class="table w-full border cart-table" id="cartTable">
              <thead>
                <tr>
                  <th>สินค้า</th>
                  <th>ราคา/ชิ้น</th>
                  <th>รวม</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- JS จะเติม <tr> ให้เอง -->
              </tbody>
            </table>
          </div>
          <div class="flex justify-between mt-3 px-2 font-medium">
            <span>ยอดรวม (ไม่รวมภาษี):</span>
            <span id="subTotal" class="text-primary-color font-semibold">0.00 ฿</span>
          </div>
        </div>

        <div class="card">
          <h5 class="section-title flex items-center gap-2">
            <i class="bi bi-receipt-cutoff"></i> ภาษี, ส่วนลด และสรุปยอด
          </h5>
          
          <!-- แสดงข้อมูลเกี่ยวกับการสร้างเอกสาร -->
          <!-- การชำระแบบผสม -->
          <div id="mixedPaymentDetails" class="hidden mb-4 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
            <h6 class="font-semibold mb-3 flex items-center gap-2">
              <i class="bi bi-cash-coin text-yellow-600"></i>
              รายละเอียดการชำระแบบผสม:
            </h6>
            <div class="grid grid-cols-2 gap-4 mb-3">
              <div>
                <label class="block text-sm font-medium mb-1">จำนวนเงินสด (บาท)</label>
                <input type="number" id="mixedCashAmount" class="input input-bordered w-full" placeholder="0.00" onchange="updateMixedPayment()" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">จำนวนโอน (บาท)</label>
                <input type="number" id="mixedTransferAmount" class="input input-bordered w-full" placeholder="0.00" onchange="updateMixedPayment()" />
              </div>
            </div>
            <div class="text-sm">
              <span class="text-gray-600">รวมทั้งสิ้น: </span>
              <span id="mixedTotalDisplay" class="font-medium text-yellow-700">0.00 บาท</span>
            </div>
          </div>

          <div class="mb-4 p-4 border border-blue-200 rounded-lg bg-blue-50">
            <h6 class="font-semibold mb-3 flex items-center gap-2">
              <i class="bi bi-file-text text-blue-600"></i>
              ประเภทเอกสาร:
            </h6>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div class="flex items-center gap-2 p-3 border border-gray-200 rounded bg-white">
                <i class="bi bi-check-circle-fill text-green-600"></i>
                <div>
                  <div class="font-medium">ใบเสร็จรับเงิน</div>
                  <div class="text-xs text-gray-600">เลขที่ RE-YYMMDD-XXXX</div>
                </div>
              </div>
              <div class="flex items-center gap-2 p-3 border border-gray-200 rounded bg-white">
                <i class="bi bi-check-circle-fill text-green-600"></i>
                <div>
                  <div class="font-medium">ใบกำกับภาษี</div>
                  <div class="text-xs text-gray-600">เลขที่ TX-YYMMDD-XXXX</div>
                </div>
              </div>
            </div>
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle-fill"></i>
              <span>ระบบจะสร้างเอกสารทั้งสองใบให้อัตโนมัติทุกครั้งที่มีการขาย</span>
            </div>
            
            <!-- เลือกส่งเอกสารทาง Email -->
            <div class="border-t pt-3">
              <h6 class="font-medium mb-2 text-gray-700">ส่งเอกสารทาง Email:</h6>
              <div class="space-y-2">
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="sendReceiptEmail" class="checkbox checkbox-sm" checked />
                  <span class="text-sm">ส่งใบเสร็จรับเงิน</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="sendTaxInvoiceEmail" class="checkbox checkbox-sm" />
                  <span class="text-sm">ส่งใบกำกับภาษี</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label"><span class="label-text font-semibold">อัตราภาษี (%)</span></label>
              <input type="number" id="vatRate" class="input input-bordered w-full" value="7" />
            </div>
            <div>
              <label class="label"><span class="label-text font-semibold">ส่วนลด (บาท/%)</span></label>
              <input type="text" id="discount" class="input input-bordered w-full" placeholder="100 หรือ 10%" />
            </div>
            <div class="col-span-2">
              <label class="label"><span class="label-text font-semibold">วิธีชำระเงิน</span></label>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">

                <!-- เงินสด -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-cash" value="CASH" class="hidden peer" checked />
                  <label for="payment-cash" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-cash-coin text-2xl text-green-600 mb-1"></i>
                    <span class="text-sm">เงินสด</span>
                  </label>
                </div>

                <!-- บัตรเครดิต -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-credit" value="CARD" class="hidden peer" />
                  <label for="payment-credit" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-credit-card text-2xl text-blue-600 mb-1"></i>
                    <span class="text-sm">บัตรเครดิต</span>
                  </label>
                </div>

                <!-- โอนเงิน -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-transfer" value="TRANSFER" class="hidden peer" />
                  <label for="payment-transfer" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-bank text-2xl text-purple-600 mb-1"></i>
                    <span class="text-sm">โอนเงิน</span>
                  </label>
                </div>

                <!-- การชำระแบบผสม (เงินสด + โอน) -->
                <div>
                  <input type="radio" name="paymentMethod" id="payment-mixed" value="MIXED" class="hidden peer" />
                  <label for="payment-mixed" class="flex flex-col items-center justify-center border rounded-lg p-3 cursor-pointer transition-all hover:border-blue-500 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700">
                    <i class="bi bi-cash-coin text-2xl text-purple-600 mb-1"></i>
                    <span class="text-sm">ผสม</span>
                  </label>
                </div>


              </div>
            </div>

          </div>


          <div class="bg-gray-50 rounded-lg p-3 mt-4">
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">ประเภทเอกสาร:</span>
              <span id="docTypeLabel" class="font-medium">ใบเสร็จรับเงิน + ใบกำกับภาษี</span>
            </div>
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">ภาษีมูลค่าเพิ่ม (7%):</span>
              <span id="vatAmount" class="font-medium">0.00 ฿</span>
            </div>
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">ส่วนลด:</span>
              <span id="discountAmount" class="font-medium text-red-600">0.00 ฿</span>
            </div>
            <!-- promotions summary -->
            <div class="flex justify-between w-full mb-2">
              <span class="text-gray-600">โปรโมชั่น:</span>
              <span id="promotionDiscount" class="font-medium text-red-600">0.00 ฿</span>
            </div>
            <div id="appliedPromotions" class="text-xs text-gray-500 mb-2"></div>
            <!-- deposit deduction -->
            <div id="depositDeductionRow" class="flex justify-between w-full mb-2" style="display: none;">
              <span class="text-gray-600">หักเงินมัดจำ:</span>
              <span id="depositDeductionAmount" class="font-medium text-green-600">-0.00 ฿</span>
            </div>
            <div class="flex justify-between w-full pt-2 border-t border-gray-200">
              <span class="font-semibold">รวมทั้งสิ้น:</span>
              <span id="totalPrice" class="text-lg font-bold text-blue-700">0.00 ฿</span>
            </div>
          </div>


          <!-- Email Options -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mt-4">
            <h6 class="font-semibold text-sm mb-3 flex items-center gap-2">
              <i class="bi bi-envelope-at text-blue-600"></i> ตัวเลือกการส่งอีเมล
            </h6>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="sendEmailReceipt" class="checkbox checkbox-primary" checked />
              <label for="sendEmailReceipt" class="text-sm cursor-pointer flex-1">
                ส่งใบเสร็จรับเงิน/ใบกำกับภาษีทางอีเมลอัตโนมัติ
              </label>
              <button 
                type="button" 
                onclick="updateEmailServiceIndicator()" 
                class="btn btn-sm btn-ghost text-xs px-2 py-1 ml-1" 
                title="ตรวจสอบสถานะระบบอีเมล">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            <div id="emailNote" class="text-xs text-gray-500 mt-2">
              <i class="bi bi-info-circle"></i> 
              <span id="emailNoteText">ระบบจะส่งอีเมลอัตโนมัติหลังชำระเงินสำเร็จ</span>
            </div>
          </div>

          <button class="btn btn-success w-full mt-4 py-3" id="btnSingleCheckout">
            <i class="bi bi-check-circle mr-2"></i> ชำระเงินและพิมพ์ใบเสร็จ
          </button>
        </div>
      </div> <!-- End Right Column -->
    </div> <!-- End Main Content two-column flex container -->
  </div> <!-- End Main Content -->
  </div> <!-- End Sidebar/Main Content flex container -->

  <!-- Footer -->
  <footer class="mt-auto text-center text-sm text-gray-500 dark:text-gray-400 py-4">
    © 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์.
  </footer>

  <!-- JavaScript Logic -->
  <script>
    // -----------------------------
    // 1) อ่าน branch_code จาก URL parameter
    // -----------------------------
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

    if (!BRANCH_CODE) {
      console.warn("Branch not found in URL or localStorage, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    window.BRANCH_CODE = BRANCH_CODE; // Make it globally accessible
    console.log(`[frontstore_pattani] Using branch code: ${BRANCH_CODE}`);

    // -----------------------------
    // รับข้อมูลจากใบรับเงินมัดจำ (ถ้ามี)
    // -----------------------------
    const productParam = urlParams.get('product');
    const receiptParam = urlParams.get('receipt');

    console.log('📋 URL Parameters:', {
      branch: BRANCH_CODE,
      product: productParam,
      receipt: receiptParam
    });

    // ตัวแปรสำหรับเก็บข้อมูลจากใบรับ
    let fromDepositReceipt = false;
    let preSelectedProductId = null;
    let depositReceiptData = null;

    // ฟังก์ชันโหลดข้อมูลใบรับเงินมัดจำ
    async function loadDepositReceiptData() {
      if (!receiptParam) return null;

      try {
        console.log('🔍 กำลังโหลดข้อมูลใบรับเงินมัดจำจาก API:', receiptParam);

        // ดึงข้อมูลจาก API โดยตรง
        const response = await fetch(`/api/deposit-receipts/${receiptParam}`);

        if (!response.ok) {
          console.warn('⚠️ ไม่สามารถดึงข้อมูลจาก API:', response.status);
          return null;
        }

        const response_json = await response.json();
        console.log('✅ ดึงข้อมูลจาก API สำเร็จ:', response_json);

        // Extract actual receipt data from response
        const receipt = response_json.data || response_json;
        console.log('📦 ข้อมูลใบรับที่แยกออกมา:', receipt);
        console.log('👤 ข้อมูลลูกค้าจาก API:', receipt.customer);

        depositReceiptData = receipt;
        fromDepositReceipt = true;
        preSelectedProductId = productParam;

        // เก็บข้อมูลเงินมัดจำเพื่อใช้ในการคำนวณ
        window.depositReceiptInfo = {
          receiptId: receipt._id || receipt.id,
          depositReceiptId: receipt._id || receipt.id, // เพิ่ม depositReceiptId สำหรับส่งไป API
          receiptNumber: receipt.receiptNumber,
          depositAmount: receipt.amounts?.depositAmount || 0,
          remainingAmount: receipt.amounts?.remainingAmount || 0,
          totalAmount: receipt.amounts?.totalAmount || receipt.amounts?.totalPrice || 0
        };
        console.log('💰 บันทึกข้อมูลเงินมัดจำ:', window.depositReceiptInfo);

        // เติมข้อมูลลูกค้าในฟอร์มทันที
        fillCustomerFormFromReceipt(receipt);

        // แสดงข้อมูลใบรับเงินมัดจำ
        console.log('🔄 กำลังเรียก displayDepositReceiptInfo...');
        displayDepositReceiptInfo(receipt);

        return receipt;
      } catch (error) {
        console.error('❌ Error loading deposit receipt from API:', error);
      }
      return null;
    }

    // ฟังก์ชันเติมข้อมูลลูกค้าจากใบรับเงินมัดจำ
    function fillCustomerFormFromReceipt(receipt) {
      if (!receipt || !receipt.customer) {
        console.warn('⚠️ ไม่มีข้อมูลลูกค้าในใบรับ');
        return;
      }

      const customer = receipt.customer;
      console.log('👤 กำลังเติมข้อมูลลูกค้า:', customer);

      setTimeout(() => {
        // เติมเบอร์โทร
        if (customer.phone) {
          const phoneInput = document.getElementById('customerPhone');
          if (phoneInput) {
            phoneInput.value = customer.phone;
            console.log('✅ เติมเบอร์โทร:', customer.phone);
          }
        }

        // เติมชื่อ-สกุล
        if (customer.name) {
          const nameParts = customer.name.trim().split(' ');
          const firstName = nameParts[0] || '';
          const lastName = nameParts.slice(1).join(' ') || '';

          const firstNameInput = document.getElementById('customerFirstName');
          const lastNameInput = document.getElementById('customerLastName');

          if (firstNameInput && firstName) {
            firstNameInput.value = firstName;
            console.log('✅ เติมชื่อ:', firstName);
          }

          if (lastNameInput && lastName) {
            lastNameInput.value = lastName;
            console.log('✅ เติมนามสกุล:', lastName);
          }
        }

        // เติมที่อยู่ - เติมทั้งฟิลด์เดี่ยวและฟิลด์แยก
        if (customer.address) {
          // ถ้า address เป็น object ให้เติมฟิลด์แยกทีละฟิลด์
          if (typeof customer.address === 'object') {
            // เติมบ้านเลขที่
            if (customer.address.houseNo) {
              const houseNoInput = document.getElementById('houseNo');
              if (houseNoInput) {
                houseNoInput.value = customer.address.houseNo;
                console.log('✅ เติมบ้านเลขที่:', customer.address.houseNo);
              }
            }

            // เติมหมู่
            if (customer.address.village || customer.address.moo) {
              const mooInput = document.getElementById('moo');
              if (mooInput) {
                mooInput.value = customer.address.village || customer.address.moo || '';
                console.log('✅ เติมหมู่:', customer.address.village || customer.address.moo);
              }
            }

            // เติมจังหวัด
            if (customer.address.province) {
              const provinceInput = document.getElementById('province');
              if (provinceInput) {
                provinceInput.value = customer.address.province;
                console.log('✅ เติมจังหวัด:', customer.address.province);
              }
            }

            // เติมอำเภอ
            if (customer.address.district) {
              const districtInput = document.getElementById('district');
              if (districtInput) {
                districtInput.value = customer.address.district;
                console.log('✅ เติมอำเภอ:', customer.address.district);
              }
            }

            // เติมตำบล
            if (customer.address.subDistrict) {
              const subDistrictInput = document.getElementById('subDistrict');
              if (subDistrictInput) {
                subDistrictInput.value = customer.address.subDistrict;
                console.log('✅ เติมตำบล:', customer.address.subDistrict);
              }
            }

            // เติมรหัสไปรษณีย์
            if (customer.address.zipcode) {
              const zipcodeInput = document.getElementById('zipcode');
              if (zipcodeInput) {
                zipcodeInput.value = customer.address.zipcode;
                console.log('✅ เติมรหัสไปรษณีย์:', customer.address.zipcode);
              }
            }

            console.log('✅ เติมที่อยู่แบบแยกฟิลด์เรียบร้อย');
          }
          // ถ้า address เป็น string ให้เติมในฟิลด์ customerAddress (ถ้ามี)
          else {
            const addressInput = document.getElementById('customerAddress');
            if (addressInput) {
              addressInput.value = customer.address;
              console.log('✅ เติมที่อยู่:', customer.address);
            }
          }
        }

        // เติมอีเมล
        if (customer.email) {
          const emailInput = document.getElementById('customerEmail');
          if (emailInput) {
            emailInput.value = customer.email;
            console.log('✅ เติมอีเมล:', customer.email);
          }
        }

        // เติมเลขประจำตัวผู้เสียภาษี
        if (customer.taxId) {
          const taxIdInput = document.getElementById('customerTaxId');
          if (taxIdInput) {
            taxIdInput.value = customer.taxId;
            console.log('✅ เติมเลขประจำตัวผู้เสียภาษี:', customer.taxId);
          }
        }

        // เติมเลขบัตรประชาชน
        if (customer.idCard) {
          const idCardInput = document.getElementById('customerIdCard');
          if (idCardInput) {
            idCardInput.value = customer.idCard;
            console.log('✅ เติมเลขบัตรประชาชน:', customer.idCard);
          }
        }

        console.log('✅ เติมข้อมูลลูกค้าจากใบมัดจำเรียบร้อย');
      }, 500);
    }

    // ฟังก์ชันแสดงข้อมูลใบรับเงินมัดจำ
    function displayDepositReceiptInfo(receipt) {
      console.log('📋 แสดงข้อมูลใบรับเงินมัดจำ:', receipt);
      console.log('👤 ข้อมูลลูกค้าในใบรับ:', receipt.customer);

      // แสดงข้อมูลลูกค้าแบบละเอียด
      if (receipt.customer) {
        const customer = receipt.customer;
        const address = customer.address || {};

        const customerInfo = `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h4 class="font-semibold text-blue-800 mb-3">
              <i class="bi bi-receipt"></i> ข้อมูลจากใบรับเงินมัดจำ: ${receipt.receiptNumber || receipt.id}
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-700">
              <div>
                <p><strong>ชื่อลูกค้า:</strong> ${customer.name || 'ไม่ระบุ'}</p>
                <p><strong>เบอร์โทร:</strong> ${customer.phone || 'ไม่ระบุ'}</p>
                <p><strong>อีเมล:</strong> ${customer.email || 'ไม่ระบุ'}</p>
                <p><strong>เลขบัตรประชาชน:</strong> ${customer.idCard || 'ไม่ระบุ'}</p>
                <p><strong>ประเภทลูกค้า:</strong> ${customer.customerType === 'individual' ? 'บุคคลธรรมดา' : customer.customerType === 'business' ? 'นิติบุคคล' : 'ไม่ระบุ'}</p>
              </div>
              <div>
                <p><strong>ที่อยู่:</strong> ${address.street || ''} ${address.subdistrict || ''} ${address.district || ''} ${address.province || ''} ${address.zipcode || ''}</p>
                <p><strong>สินค้า:</strong> ${receipt.product?.name || 'ไม่ระบุ'}</p>
                <p><strong>ราคาเต็ม:</strong> ${(receipt.amounts?.totalAmount || receipt.amounts?.totalPrice || 0).toLocaleString()} บาท</p>
                <p><strong>เงินมัดจำแล้ว:</strong> <span class="text-green-600 font-bold">${(receipt.amounts?.depositAmount || 0).toLocaleString()} บาท</span></p>
                <p><strong class="text-red-600">ยอดคงเหลือที่ต้องชำระ:</strong> <span class="text-red-600 font-bold text-lg">${(receipt.amounts?.remainingAmount || 0).toLocaleString()} บาท</span></p>
                <p><strong>ประเภทการขาย:</strong> ${receipt.saleType === 'installment' ? 'ขายผ่อน' : 'ขายสด'}</p>
              </div>
            </div>
          </div>
        `;

        // แทรกข้อมูลที่ด้านบนของหน้า
        const contentArea = document.querySelector('.container-fluid') || document.querySelector('main');
        if (contentArea) {
          const infoDiv = document.createElement('div');
          infoDiv.innerHTML = customerInfo;
          infoDiv.className = 'deposit-receipt-info';
          contentArea.insertBefore(infoDiv, contentArea.firstChild);
        }
      }

      // เติมข้อมูลลูกค้าในฟอร์ม
      fillCustomerForm(receipt.customer);
    }

    // ฟังก์ชันเติมข้อมูลลูกค้าในฟอร์มจากใบรับเงินมัดจำ
    function fillCustomerForm(customer) {
      if (!customer) {
        console.log('❌ ไม่มีข้อมูลลูกค้าจากใบรับเงินมัดจำ');
        return;
      }

      console.log('📝 เติมข้อมูลลูกค้าในฟอร์มจากใบรับเงินมัดจำ:', customer);

      // ตั้งค่าประเภทลูกค้าเป็นบุคคลธรรมดา
      const customerTypeField = document.getElementById('customerType');
      if (customerTypeField) {
        customerTypeField.value = 'individual';
        customerTypeField.dispatchEvent(new Event('change')); // Trigger change event
        console.log('✅ ตั้งค่าประเภทลูกค้า: บุคคลธรรมดา');
      }

      // รอให้ฟอร์มบุคคลธรรมดาแสดงผล
      setTimeout(() => {
        // แยกชื่อและนามสกุลจาก customer.name
        const fullName = customer.name || '';
        const nameParts = fullName.trim().split(' ');
        let firstName = '', lastName = '';

        if (nameParts.length >= 2) {
          firstName = nameParts[0];
          lastName = nameParts.slice(1).join(' ');
        } else if (nameParts.length === 1) {
          firstName = nameParts[0];
        }

        // เติมข้อมูลลูกค้าในฟิลด์ที่ถูกต้อง
        const fields = {
          'customerFirstName': firstName,
          'customerLastName': lastName,
          'customerPhone': customer.phone,
          'customerTaxId': customer.idCard || customer.taxId,
          'customerEmailPersonal': customer.email
        };

        Object.entries(fields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
            console.log(`✅ เติมข้อมูล ${fieldId}: ${value}`);
          } else if (!field) {
            console.log(`⚠️ ไม่พบฟิลด์ ${fieldId}`);
          }
        });

        // เติมข้อมูลที่อยู่หากมี
        if (customer.address) {
          const addressField = document.getElementById('customerAddress');
          if (addressField) {
            let fullAddress = '';
            if (typeof customer.address === 'string') {
              fullAddress = customer.address;
            } else if (customer.address.fullAddress) {
              fullAddress = customer.address.fullAddress;
            } else {
              // รวมที่อยู่จาก object
              const addr = customer.address;
              fullAddress = [addr.street, addr.subdistrict, addr.district, addr.province, addr.zipcode]
                .filter(Boolean).join(' ');
            }
            addressField.value = fullAddress;
            console.log(`✅ เติมข้อมูลที่อยู่: ${fullAddress}`);
          }
        }

        // เติมข้อมูลเพิ่มเติมหากมีในใบรับเงินมัดจำ
        const additionalFields = {
          'customerPrefix': customer.prefix,
          'customerGender': customer.gender,
          'customerAge': customer.age,
          'customerBirthDate': customer.birthDate ? new Date(customer.birthDate).toISOString().split('T')[0] : null // แปลงเป็น yyyy-MM-dd
        };

        Object.entries(additionalFields).forEach(([fieldId, value]) => {
          if (value) {
            const field = document.getElementById(fieldId);
            if (field) {
              field.value = value;
              console.log(`✅ เติมข้อมูล ${fieldId}: ${value}`);

              // Trigger change event สำหรับ customerPrefix เพื่อให้ auto-fill เพศ
              if (fieldId === 'customerPrefix') {
                field.dispatchEvent(new Event('change'));
              }
            } else {
              console.log(`⚠️ ไม่พบฟิลด์ ${fieldId}`);
            }
          }
        });

        // เติมข้อมูลที่อยู่แยกส่วนหากมี
        if (customer.address && typeof customer.address === 'object' && customer.address.houseNo) {
          const addressFields = {
            'houseNo': customer.address.houseNo,
            'moo': customer.address.moo,
            'subDistrict': customer.address.subDistrict,
            'district': customer.address.district,
            'province': customer.address.province,
            'zipcode': customer.address.zipcode
          };

          Object.entries(addressFields).forEach(([fieldId, value]) => {
            if (value) {
              const field = document.getElementById(fieldId);
              if (field) {
                field.value = value;
                console.log(`✅ เติมข้อมูลที่อยู่ ${fieldId}: ${value}`);
              }
            }
          });
        }

        console.log('✅ เติมข้อมูลลูกค้าจากใบรับเงินมัดจำเสร็จสิ้น');
      }, 100); // รอ 100ms ให้ฟอร์มแสดงผลก่อน
    }

    // ฟังก์ชันเพิ่มสินค้าที่เลือกไว้จากใบรับลงตะกร้าอัตโนมัติ
    async function autoAddPreSelectedProduct() {
      if (!preSelectedProductId || !fromDepositReceipt) return;

      console.log('🛒 กำลังเพิ่มสินค้าจากใบรับเงินมัดจำลงตะกร้า:', preSelectedProductId);

      // รอให้ approvedStocks โหลดเสร็จก่อน
      let attempts = 0;
      while ((!approvedStocks || approvedStocks.length === 0) && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (approvedStocks.length === 0) {
        console.warn('⚠️ ไม่สามารถโหลดสต็อกสินค้าได้');
        return;
      }

      // หาสินค้าจาก branchStockId หรือ product_id
      let product = approvedStocks.find(item => item._id === preSelectedProductId);

      // ถ้าไม่เจอ ให้ลองหาจาก product_id
      if (!product) {
        product = approvedStocks.find(item =>
          item.product_id?._id === preSelectedProductId ||
          item.product_id === preSelectedProductId
        );
        if (product) {
          console.log('✅ พบสินค้าจาก product_id:', product);
        }
      }

      if (product) {
        console.log('✅ พบสินค้าที่ต้องการ:', product);

        try {
          // เตรียม parameters สำหรับฟังก์ชัน addToCart
          const id = product._id || product.id;
          const name = product.name || 'ไม่ระบุชื่อ';
          const price = product.price || 0;
          const imei = product.imei || '';
          const taxType = product.taxType || 'inclusive';
          const model = product.model || '';
          const poNumber = product.poNumber || '';
          const supplier = product.supplier || '';

          console.log('🛒 Parameters สำหรับ addToCart:', {
            id, name, price, imei, taxType, model, poNumber, supplier
          });

          // เพิ่มลงตะกร้าอัตโนมัติ (ส่ง parameters แยกแต่ละตัว)
          if (typeof addToCart === 'function') {
            addToCart(id, name, price, imei, taxType, model, poNumber, supplier);
          } else {
            console.error('❌ ฟังก์ชัน addToCart ไม่พบ');
          }

          // แสดงการแจ้งเตือน
          if (typeof showToast === 'function') {
            showToast(`เพิ่มสินค้า "${product.name}" ลงตะกร้าอัตโนมัติแล้ว`, 'success');
          }
        } catch (error) {
          console.error('❌ Error adding product to cart:', error);
          if (typeof showToast === 'function') {
            showToast('เกิดข้อผิดพลาดในการเพิ่มสินค้า กรุณาเพิ่มเอง', 'error');
          }
        }
      } else {
        console.warn('⚠️ ไม่พบสินค้าที่ระบุ:', preSelectedProductId);
        console.warn('📋 Debug - Available stocks:', {
          totalStocks: approvedStocks.length,
          allStockIds: approvedStocks.map(s => ({
            _id: s._id,
            product_id: s.product_id?._id || s.product_id,
            name: s.name,
            imei: s.imei
          })),
          searchingFor: preSelectedProductId
        });

        // Debug: ค้นหาสินค้าที่ชื่อใกล้เคียง
        const depositProductData = window.selectedProductData || depositReceiptData?.product;
        if (depositProductData) {
          console.warn('🔍 Searching by product name from deposit:', depositProductData.name);
          const similarProducts = approvedStocks.filter(s =>
            s.name === depositProductData.name ||
            s.product_id?.name === depositProductData.name
          );
          console.warn('🔍 Products with same name:', similarProducts.map(p => ({
            _id: p._id,
            product_id: p.product_id?._id || p.product_id,
            name: p.name,
            imei: p.imei
          })));
        }

        if (typeof showToast === 'function') {
          showToast('ไม่พบสินค้าที่ต้องการในสต็อกสาขานี้ กรุณาเลือกสินค้าเอง', 'warning');
        }
      }
    }

    const API_ROOT = '/api';

    // อัพเดท localStorage และ title
    if (urlParams.has('branch')) {
      localStorage.setItem('activeBranch', BRANCH_CODE);
    }

    if (urlParams.has('name')) {
      document.title = `POS - ${decodeURIComponent(urlParams.get('name'))}`;
    }

    let cartItems = [];
    let staffName = 'Guest';
    let approvedStocks = [];   // จะเก็บสินค้าที่ verified=true
    let activePromotions = []; // จะเก็บโปรโมชั่นที่ active

    // ========== HELPER FUNCTIONS FOR PRODUCT CATEGORIZATION ==========
    // Helper functions for data transformation (เหมือน step1.html)
    function extractBrand(productName) {
      if (!productName) return 'ไม่มีแบรนด์';
    
      const brandKeywords = {
        'iPhone': 'Apple',
        'iPad': 'Apple',
        'MacBook': 'Apple',
        'AirPods': 'Apple',
        'Samsung': 'Samsung',
        'Galaxy': 'Samsung',
        'Huawei': 'Huawei',
        'Xiaomi': 'Xiaomi',
        'Oppo': 'Oppo',
        'Vivo': 'Vivo',
        'Realme': 'Realme',
        'OnePlus': 'OnePlus'
      };
    
      for (const [keyword, brand] of Object.entries(brandKeywords)) {
        if (productName.toLowerCase().includes(keyword.toLowerCase())) {
          return brand;
        }
      }
    
      // ถ้าไม่พบแบรนด์ที่รู้จัก ให้ใช้คำแรกเป็นแบรนด์
      const firstWord = productName.split(' ')[0];
      return firstWord || 'ไม่มีแบรนด์';
    }
    
    function extractProductName(productName) {
      if (!productName) return 'ไม่มีชื่อสินค้า';
    
      const productKeywords = [
        'iPhone', 'iPad', 'MacBook', 'AirPods', 'Apple Watch', 'iMac', 'Mac', 'iPod',
        'Galaxy', 'Samsung', 'Note',
        'Huawei', 'Honor', 'Nova', 'Mate', 'P Series',
        'Xiaomi', 'Redmi', 'Mi', 'POCO',
        'Oppo', 'Find', 'Reno', 'A Series',
        'Vivo', 'X Series', 'Y Series', 'V Series',
        'Realme', 'OnePlus'
      ];
    
      const name = productName.toLowerCase();
    
      for (const keyword of productKeywords) {
        if (name.includes(keyword.toLowerCase())) {
          return keyword;
        }
      }
    
      // ถ้าไม่พบคีย์เวิร์ดที่รู้จัก ให้ใช้คำสองคำแรก
      const words = productName.split(' ');
      if (words.length >= 2) {
        return words.slice(0, 2).join(' ');
      }
    
      return words[0] || 'ไม่มีชื่อสินค้า';
    }
    
    function determineCategory(productName, productType, categoryGroup) {
      // ✅ ตรวจสอบ categoryGroup จาก API ก่อน (ใช้ข้อมูลจากฐานข้อมูลเป็นหลัก)
      if (categoryGroup && categoryGroup.name) {
        return categoryGroup.name;
      }
    
      // ✅ Fallback: ใช้ productType ถ้ามี
      if (productType === 'mobile') return 'มือถือ/แท็บเล็ต';
      if (productType === 'accessory') return 'อุปกรณ์เสริม';
      if (productType === 'boxset') return 'ชุดสินค้า';
      if (productType === 'gift') return 'ของแถม';
    
      // ✅ Enhanced keyword matching จากชื่อสินค้า (สำหรับ fallback)
      if (!productName) return 'อื่นๆ';
    
      const name = productName.toLowerCase();
    
      // ขยาย keyword สำหรับมือถือ
      if (name.includes('iphone') || name.includes('samsung') || name.includes('galaxy') ||
          name.includes('huawei') || name.includes('xiaomi') || name.includes('oppo') ||
          name.includes('vivo') || name.includes('phone') || name.includes('มือถือ') ||
          name.includes('realme') || name.includes('oneplus') || name.includes('nokia')) {
        return 'มือถือ';
      }
    
      // ขยาย keyword สำหรับแท็บเล็ต
      if (name.includes('ipad') || name.includes('tablet') || name.includes('แท็บเล็ต')) {
        return 'แท็บเล็ต';
      }
    
      // ขยาย keyword สำหรับคอมพิวเตอร์
      if (name.includes('macbook') || name.includes('laptop') || name.includes('คอมพิวเตอร์') ||
          name.includes('notebook') || name.includes('computer') || name.includes('pc')) {
        return 'คอมพิวเตอร์';
      }
    
      // ขยาย keyword สำหรับอุปกรณ์เสริม
      if (name.includes('airpods') || name.includes('headphone') || name.includes('earphone') ||
          name.includes('case') || name.includes('charger') || name.includes('สายชาร์จ') ||
          name.includes('หูฟัง') || name.includes('เคส') || name.includes('powerbank') ||
          name.includes('cable') || name.includes('adapter') || name.includes('stand') ||
          name.includes('screen protector') || name.includes('ฟิล์ม')) {
        return 'อุปกรณ์เสริม';
      }
    
      return 'อื่นๆ';
    }

    function getCategoryIcon(category) {
      const icons = {
        'มือถือ': 'phone',
        'มือถือ/แท็บเล็ต': 'phone',
        'แท็บเล็ต': 'tablet',
        'คอมพิวเตอร์': 'laptop',
        'อุปกรณ์เสริม': 'headphones',
        'ชุดสินค้า': 'boxes',
        'ของแถม': 'gift',
        'อื่นๆ': 'box'
      };
    
      // ถ้าไม่พบใน mapping ให้ลองหาด้วยคำที่คล้ายกัน
      if (!icons[category] && category) {
        const lowerCategory = category.toLowerCase();
        if (lowerCategory.includes('มือถือ') || lowerCategory.includes('phone')) return 'phone';
        if (lowerCategory.includes('แท็บเล็ต') || lowerCategory.includes('tablet')) return 'tablet';
        if (lowerCategory.includes('คอมพิวเตอร์') || lowerCategory.includes('laptop') || lowerCategory.includes('computer')) return 'laptop';
        if (lowerCategory.includes('อุปกรณ์') || lowerCategory.includes('accessory')) return 'headphones';
        if (lowerCategory.includes('ชุด') || lowerCategory.includes('boxset')) return 'boxes';
        if (lowerCategory.includes('ของแถม') || lowerCategory.includes('gift')) return 'gift';
      }
    
      return icons[category] || 'box';
    }

    function getProductIcon(productName) {
      const icons = {
        'iPhone': 'phone',
        'iPad': 'tablet',
        'MacBook': 'laptop',
        'Mac': 'laptop',
        'iMac': 'pc-display',
        'AirPods': 'headphones',
        'Apple Watch': 'smartwatch',
        'Galaxy': 'phone',
        'Samsung': 'phone',
        'Note': 'phone',
        'Huawei': 'phone',
        'Honor': 'phone',
        'Nova': 'phone',
        'Mate': 'phone',
        'P Series': 'phone',
        'Xiaomi': 'phone',
        'Redmi': 'phone',
        'Mi': 'phone',
        'POCO': 'phone',
        'Oppo': 'phone',
        'Find': 'phone',
        'Reno': 'phone',
        'A Series': 'phone',
        'Vivo': 'phone',
        'X Series': 'phone',
        'Y Series': 'phone',
        'V Series': 'phone',
        'Realme': 'phone',
        'OnePlus': 'phone'
      };
      return icons[productName] || 'phone';
    }

    // 🔒 Security & Audit Variables
    let sessionId = generateSessionId();
    let auditBuffer = [];
    let lastActionTime = Date.now();
    let actionCount = 0;
    let deviceFingerprint = null;

    // 🔐 Security Functions
    function generateSessionId() {
      return 'POS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getDeviceFingerprint() {
      if (deviceFingerprint) return deviceFingerprint;

      deviceFingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        cookieEnabled: navigator.cookieEnabled,
        timestamp: Date.now()
      };

      return deviceFingerprint;
    }

          // Show loading overlay
          // 🔍 Enhanced Audit Logger
    function logAuditEvent(action, details = {}, level = 'INFO') {
      const auditEvent = {
        id: generateAuditId(),
        sessionId: sessionId,
        timestamp: new Date().toISOString(),
        action: action,
        level: level,
        userId: localStorage.getItem('userId') || 'unknown',
        userName: localStorage.getItem('userName') || staffName || 'Guest',
        branchCode: BRANCH_CODE,
        ipAddress: 'client-side', // จะได้จาก server
        deviceInfo: getDeviceFingerprint(),
        details: {
          ...details,
          url: window.location.href,
          cartCount: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0)
        }
      };

      // เพิ่มใน buffer
      auditBuffer.push(auditEvent);

      // ส่งไป server ทันที หรือ batch ทุก 5 events
      if (auditBuffer.length >= 5 || level === 'ERROR' || level === 'CRITICAL') {
        flushAuditBuffer();
      }

      console.log('🔍 Audit:', auditEvent);
    }

    function generateAuditId() {
      return 'AUDIT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    }

    // 📤 Send Audit Events to Server
    async function flushAuditBuffer() {
      if (auditBuffer.length === 0) return;

      const events = [...auditBuffer];
      auditBuffer = [];

      try {
        const token = localStorage.getItem('authToken') || localStorage.getItem('accessToken') || '';
    
        // ถ้าไม่มี token ให้ log แต่ไม่ส่งไป server
        if (!token) {
          console.warn('⚠️ No auth token available, audit events stored locally only');
          return;
        }

        const response = await fetch('/api/audit/log-events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ events })
        });

        if (!response.ok) {
          // ถ้าเป็น 401 ให้ลบ token ที่หมดอายุ
          if (response.status === 401) {
            console.warn('⚠️ Auth token expired, removing invalid token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('accessToken');
            return; // ไม่คืน events กลับไปใน buffer เพราะ token หมดอายุ
          }
    
          console.error('❌ Failed to send audit events:', response.status);
          // คืนกลับไปใน buffer สำหรับ error อื่นๆ
          auditBuffer.unshift(...events);
        }
      } catch (error) {
        console.error('❌ Audit logging error:', error);
        // คืนกลับไปใน buffer
        auditBuffer.unshift(...events);
      }
    }

    // 🛡️ Rate Limiting
    function checkRateLimit(action, maxActions = 10, timeWindow = 60000) {
      const now = Date.now();
      const key = `rateLimit_${action}`;

      let actionLog = JSON.parse(localStorage.getItem(key) || '[]');
      actionLog = actionLog.filter(time => now - time < timeWindow);

      if (actionLog.length >= maxActions) {
        logAuditEvent('RATE_LIMIT_EXCEEDED', { action, count: actionLog.length }, 'WARNING');
        return false;
      }

      actionLog.push(now);
      localStorage.setItem(key, JSON.stringify(actionLog));
      return true;
    }

    // 🔒 Input Sanitization
    function sanitizeInput(input, type = 'text') {
      if (!input) return '';

      let sanitized = input.toString().trim();

      switch (type) {
        case 'taxId':
          sanitized = sanitized.replace(/[^0-9]/g, '').substring(0, 13);
          break;
        case 'phone':
          sanitized = sanitized.replace(/[^0-9-+]/g, '').substring(0, 20);
          break;
        case 'number':
          sanitized = sanitized.replace(/[^0-9.]/g, '');
          break;
        case 'text':
          sanitized = sanitized.replace(/[<>\"']/g, '');
          break;
      }

      return sanitized;
    }

    // 🎁 Referral Code Validation
    async function validateReferralCode(input) {
      const value = input.value.trim();
      const statusElement = document.getElementById('referralStatus');
    
      if (!value) {
        if (statusElement) {
          statusElement.classList.add('hidden');
        }
        return true;
      }
    
      try {
        // Show loading
        if (statusElement) {
          SecurityHelpers.safeSetHTML(statusElement, '<i class="bi bi-hourglass-split text-blue-500"></i> กำลังตรวจสอบ...', true);
          statusElement.className = 'text-xs mt-1 text-blue-600';
          statusElement.classList.remove('hidden');
        }
    
        // Check if referral code exists
        const response = await fetch(`/api/points/members/search?q=${encodeURIComponent(value)}`);
        const result = await response.json();
    
        if (result.success && result.data.length > 0) {
          const referrer = result.data.find(member => member.memberCode === value);
    
          if (referrer) {
            if (statusElement) {
              // Safely create referrer status with proper sanitization
              SecurityHelpers.safeSetContent(statusElement, '', '');

              const icon = document.createElement('i');
              icon.className = 'bi bi-check-circle text-green-500';

              const text = document.createTextNode(` พบผู้แนะนำ: ${referrer.name || 'ไม่ระบุ'} (${referrer.phone || 'ไม่ระบุ'})`);

              statusElement.appendChild(icon);
              statusElement.appendChild(text);
              statusElement.className = 'text-xs mt-1 text-green-600';
              statusElement.classList.remove('hidden');
            }
            return true;
          }
        }
    
        // Invalid referral code
        if (statusElement) {
          SecurityHelpers.safeSetHTML(statusElement, '<i class="bi bi-x-circle text-red-500"></i> ไม่พบรหัสแนะนำในระบบ', true);
          statusElement.className = 'text-xs mt-1 text-red-500';
          statusElement.classList.remove('hidden');
        }
        return false;
    
      } catch (error) {
        console.error('Error validating referral code:', error);
        if (statusElement) {
          statusElement.innerHTML = '<i class="bi bi-exclamation-triangle text-yellow-500"></i> ไม่สามารถตรวจสอบได้';
          statusElement.className = 'text-xs mt-1 text-yellow-600';
          statusElement.classList.remove('hidden');
        }
        return true; // Allow form to proceed even if validation fails
      }
    }

    // 🔐 Session Management
    function validateSession() {
      const token = localStorage.getItem('authToken');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        logAuditEvent('SESSION_INVALID', {}, 'WARNING');
        showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
        setTimeout(() => window.location.href = '/login', 2000);
        return false;
      }

      return true;
    }

    // 🔒 Transaction Lock
    const transactionLocks = new Set();

    function acquireTransactionLock(lockId) {
      if (transactionLocks.has(lockId)) {
        logAuditEvent('TRANSACTION_LOCK_CONFLICT', { lockId }, 'WARNING');
        return false;
      }
      transactionLocks.add(lockId);
      return true;
    }

    function releaseTransactionLock(lockId) {
      transactionLocks.delete(lockId);
    }

    // -----------------------------
    // 1) โหลดข้อมูลสต๊อก (cash) และ boxsets ก่อนแสดง Level 1
    // -----------------------------
    // 📝 Loading state management
    let isLoadingStocks = false; // Flag to prevent duplicate loading
    
    // Helper function to safely reload stocks
    function safeReloadStocks() {
      if (typeof loadApprovedStocks === 'function' && !isLoadingStocks) {
        return loadApprovedStocks().then(() => {
          if (typeof loadLevel1 === 'function') {
            loadLevel1();
          }
        });
      } else {
        console.log('⚠️ loadApprovedStocks skipped - already loading');
        return Promise.resolve();
      }
    }
    
    // Performance optimization: Cache mechanism for stocks
    let stocksCache = {
      data: null,
      timestamp: null,
      ttl: 5 * 60 * 1000, // 5 minutes cache TTL
      isValid() {
        return this.data && this.timestamp && (Date.now() - this.timestamp < this.ttl);
      },
      set(data) {
        this.data = data;
        this.timestamp = Date.now();
      },
      clear() {
        this.data = null;
        this.timestamp = null;
      }
    };

    // Performance optimization: Pagination configuration
    const STOCK_PAGINATION = {
      pageSize: 500, // Load 500 items at a time
      initialLoad: 250, // Load first 250 items immediately
      batchSize: 100 // Process in batches of 100 for filtering
    };

    /**
     * Performance optimization: Process large arrays in batches to prevent UI blocking
     * @param {Array} data - Array to process
     * @param {Function} filterFn - Filter function to apply
     * @returns {Promise<Array>} - Filtered results
     */
    async function processBatchFiltering(data, filterFn) {
      const results = [];
      const batchSize = STOCK_PAGINATION.batchSize;

      for (let i = 0; i < data.length; i += batchSize) {
        const batch = data.slice(i, i + batchSize);
        const batchResults = batch.filter(filterFn);
        results.push(...batchResults);

        // Yield control to prevent UI blocking
        if (i % (batchSize * 2) === 0) {
          await new Promise(resolve => setTimeout(resolve, 1));
        }
      }

      return results;
    }

    /**
     * Security helper functions to prevent XSS attacks
     */
    const SecurityHelpers = {
      /**
       * Sanitize text content to prevent XSS
       * @param {string} text - Text to sanitize
       * @returns {string} - Sanitized text
       */
      sanitizeText(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/[<>&"']/g, function(match) {
          const escapeChars = {
            '<': '&lt;',
            '>': '&gt;',
            '&': '&amp;',
            '"': '&quot;',
            "'": '&#39;'
          };
          return escapeChars[match];
        });
      },

      /**
       * Create safe text node
       * @param {string} text - Text content
       * @returns {Text} - Text node
       */
      createTextNode(text) {
        return document.createTextNode(text || '');
      },

      /**
       * Safely set innerHTML by creating elements
       * @param {HTMLElement} element - Target element
       * @param {string} className - CSS class name
       * @param {string} textContent - Text content
       */
      safeSetContent(element, className, textContent) {
        if (!element) return;
        // Clear element safely without innerHTML
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }
        if (className) element.className = className;
        if (textContent) element.appendChild(this.createTextNode(textContent));
      },

      /**
       * Safely set HTML content for trusted sources only
       * @param {HTMLElement} element - Target element
       * @param {string} htmlContent - HTML content (must be trusted)
       * @param {boolean} isTrusted - Flag to confirm content is trusted
       */
      safeSetHTML(element, htmlContent, isTrusted = false) {
        if (!element) return;
        if (!isTrusted) {
          console.warn('⚠️ Using safeSetHTML without trusted flag, falling back to text content');
          this.safeSetContent(element, '', htmlContent);
          return;
        }
        // Clear element safely
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }
        element.innerHTML = htmlContent;
      },

      /**
       * Create element safely with attributes
       * @param {string} tagName - HTML tag name
       * @param {Object} attributes - Attributes to set
       * @param {string|Node} content - Text content or child node
       * @returns {HTMLElement} - Created element
       */
      createElement(tagName, attributes = {}, content = '') {
        const element = document.createElement(tagName);

        // Set attributes safely
        for (const [key, value] of Object.entries(attributes)) {
          if (key === 'className' || key === 'class') {
            element.className = this.sanitizeText(value);
          } else if (key === 'id') {
            element.id = this.sanitizeText(value);
          } else if (key.startsWith('data-')) {
            element.setAttribute(key, this.sanitizeText(value));
          } else if (['src', 'href', 'action'].includes(key)) {
            // URL attributes need special validation
            if (this.isValidURL(value)) {
              element.setAttribute(key, value);
            }
          } else {
            element.setAttribute(key, this.sanitizeText(value));
          }
        }

        // Set content safely
        if (typeof content === 'string') {
          element.appendChild(this.createTextNode(content));
        } else if (content instanceof Node) {
          element.appendChild(content);
        }

        return element;
      },

      /**
       * Validate URL to prevent javascript: and other dangerous protocols
       * @param {string} url - URL to validate
       * @returns {boolean} - True if URL is safe
       */
      isValidURL(url) {
        if (!url || typeof url !== 'string') return false;
        const sanitized = url.trim().toLowerCase();
        const dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:', 'about:'];
        return !dangerousProtocols.some(protocol => sanitized.startsWith(protocol));
      },

      /**
       * Validate and sanitize numeric input
       * @param {any} value - Value to validate
       * @param {number} defaultValue - Default value if invalid
       * @returns {number} - Sanitized number
       */
      sanitizeNumber(value, defaultValue = 0) {
        const num = parseFloat(value);
        return isNaN(num) ? defaultValue : num;
      },

      /**
       * Validate Thai National ID
       * @param {string} id - Thai National ID to validate
       * @returns {boolean} - True if valid
       */
      validateThaiID(id) {
        if (!id || typeof id !== 'string') return false;

        // Remove all non-digits
        const cleanId = id.replace(/\D/g, '');

        // Must be exactly 13 digits
        if (cleanId.length !== 13) return false;

        // Calculate checksum using Thai ID algorithm
        let sum = 0;
        for (let i = 0; i < 12; i++) {
          sum += parseInt(cleanId.charAt(i)) * (13 - i);
        }

        const checkDigit = (11 - (sum % 11)) % 10;
        return checkDigit === parseInt(cleanId.charAt(12));
      },

      /**
       * Validate email format
       * @param {string} email - Email to validate
       * @returns {boolean} - True if valid
       */
      validateEmail(email) {
        if (!email || typeof email !== 'string') return false;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
      },

      /**
       * Validate Thai phone number
       * @param {string} phone - Phone number to validate
       * @returns {boolean} - True if valid
       */
      validateThaiPhone(phone) {
        if (!phone || typeof phone !== 'string') return false;
        const cleanPhone = phone.replace(/\D/g, '');

        // Thai mobile: 10 digits starting with 0[6-9]
        // Thai landline: 9-10 digits starting with 0[2-7]
        const mobileRegex = /^0[6-9]\d{8}$/;
        const landlineRegex = /^0[2-7]\d{7,8}$/;

        return mobileRegex.test(cleanPhone) || landlineRegex.test(cleanPhone);
      },

      /**
       * Sanitize and validate currency amount
       * @param {any} amount - Amount to validate
       * @param {number} maxDecimals - Maximum decimal places
       * @returns {number} - Validated amount
       */
      validateCurrency(amount, maxDecimals = 2) {
        const num = parseFloat(amount);
        if (isNaN(num) || num < 0) return 0;

        const multiplier = Math.pow(10, maxDecimals);
        return Math.round(num * multiplier) / multiplier;
      },

      /**
       * Validate and sanitize product code/SKU
       * @param {string} code - Product code to validate
       * @returns {string|null} - Sanitized code or null if invalid
       */
      validateProductCode(code) {
        if (!code || typeof code !== 'string') return null;

        // Allow alphanumeric, hyphens, underscores, and dots
        const sanitized = code.trim().replace(/[^a-zA-Z0-9\-_\.]/g, '');

        // Must be between 1 and 50 characters
        return (sanitized.length >= 1 && sanitized.length <= 50) ? sanitized : null;
      },

      /**
       * Validate date input
       * @param {string|Date} date - Date to validate
       * @returns {Date|null} - Valid Date object or null
       */
      validateDate(date) {
        if (!date) return null;

        const dateObj = date instanceof Date ? date : new Date(date);

        // Check if date is valid and not in the future beyond reasonable bounds
        const now = new Date();
        const maxFutureDate = new Date(now.getFullYear() + 10, 11, 31);
        const minPastDate = new Date(1900, 0, 1);

        if (isNaN(dateObj.getTime()) ||
            dateObj > maxFutureDate ||
            dateObj < minPastDate) {
          return null;
        }

        return dateObj;
      }
    };

    async function loadApprovedStocks(forceReload = false) {
      // Prevent duplicate loading
      if (isLoadingStocks) {
        console.log('⚠️ loadApprovedStocks already running, skipping...');
        return;
      }

      // Check cache first (unless forced reload)
      if (!forceReload && stocksCache.isValid()) {
        console.log('✅ Using cached stock data');
        approvedStocks = stocksCache.data;

        logAuditEvent('LOAD_STOCKS_FROM_CACHE', {
          branchCode: BRANCH_CODE,
          stockCount: approvedStocks.length,
          cacheAge: Date.now() - stocksCache.timestamp
        }, 'INFO');

        return;
      }

      isLoadingStocks = true;
    
      try {
        // 🔍 Audit Log - Loading stocks
        logAuditEvent('LOAD_STOCKS_START', {
          branchCode: BRANCH_CODE,
          stockType: 'cash',
          requestType: 'approved_stocks_and_boxsets'
        }, 'INFO');

        console.log('🔄 Loading approved stocks and boxsets...');
        console.log('🏢 Current BRANCH_CODE:', BRANCH_CODE);
        console.log('🔑 localStorage branchCode:', localStorage.getItem('branchCode'));
        const token = localStorage.getItem('authToken') || '';
    
        // โหลดข้อมูลสต๊อกปกติ
        const stockUrl = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}&verified=true&purchaseType=cash`;
        console.log('📡 Stock API URL:', stockUrl);

        const stockJs = await safeFetch(stockUrl, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 15000,
          maxRetries: 2
        });

        console.log('📊 Stock API Response:', stockJs);

        let regularStocks = [];
        if (stockJs && stockJs.success) {
          console.log('📋 Raw stock data from API:', stockJs.data.length, 'items');
          console.log('🔍 Sample raw stock items:', stockJs.data.slice(0, 3));

          // Performance optimization: Batch process filtering for large datasets
          console.log('🚀 Processing stock data with batch filtering for performance...');
          regularStocks = await processBatchFiltering(stockJs.data, (item) => {
            const hasStock = item.stock_value > 0;
            const isVerified = item.verified === true;

            // Reduced logging for performance - only log first few items
            if (regularStocks.length < 3) {
              console.log(`🔍 Filtering stock item "${item.name}":`, {
                _id: item._id,
                purchaseType: item.purchaseType,
                stock_value: item.stock_value,
                hasStock,
                verified: item.verified,
                isVerified,
                passesFilter: hasStock && isVerified
              });
            }

            // Store original stock value for calculations
            if (hasStock && isVerified) {
              item.originalStockValue = item.stock_value;
            }

            return hasStock && isVerified;
          });
        } else {
          console.log('❌ Stock API Error:', stockJs);
        }

        // โหลดข้อมูล boxsets จาก API ใหม่
        const boxsetUrl = `${API_ROOT}/branch-stock/boxset/${currentBranchCode}`;
        console.log('📡 Boxset API URL:', boxsetUrl);

        const boxsetJs = await safeFetch(boxsetUrl, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 15000,
          maxRetries: 2
        });

        console.log('📊 Boxset API Response:', boxsetJs);

        let boxsets = [];
        if (boxsetJs && boxsetJs.success) {
          console.log('📋 Raw boxset data from API:', boxsetJs.data.length, 'items');
    
          // Performance optimization: Batch process boxsets filtering
          console.log('🚀 Processing boxset data with batch filtering for performance...');
          boxsets = await processBatchFiltering(boxsetJs.data, (item) => {
            const hasCashSale = item.saleTypes && item.saleTypes.includes('cash');
            const hasStock = item.stock_value > 0;
            const isActive = item.status === 'active';

            // Reduced logging for performance - only log first few items
            if (boxsets.length < 3) {
              console.log(`🔍 Filtering boxset item "${item.name}":`, {
                _id: item._id,
                saleTypes: item.saleTypes,
                stock_value: item.stock_value,
                status: item.status,
                hasCashSale,
                hasStock,
                isActive,
                passesFilter: hasCashSale && hasStock && isActive
              });
            }

            // Transform boxset format to match stock item for cash sale system
            if (hasCashSale && hasStock && isActive) {
              item.price = item.boxsetPrice;
              item.cost = item.totalCost;
              item.originalStockValue = item.stock_value;
              item.verified = true;
              item.productType = 'boxset';
              item.brand = 'Boxset';
              item.model = 'Standard';
              item.taxType = item.taxType || 'include';
              item.poNumber = '';
              item.supplier = '';
            }

            return hasCashSale && hasStock && isActive;
          });
    
          console.log('📦 Filtered boxsets:', boxsets.length, 'items');
          console.log('🔍 Sample boxsets:', boxsets.slice(0, 3));
    
          // Remove duplicates based on _id to prevent duplicate display
          const uniqueBoxsets = [];
          const seenIds = new Set();
    
          boxsets.forEach(boxset => {
            if (!seenIds.has(boxset._id)) {
              seenIds.add(boxset._id);
              uniqueBoxsets.push(boxset);
            } else {
              console.log(`⚠️ Duplicate boxset detected and removed: ${boxset.name} (ID: ${boxset._id})`);
            }
          });
    
          boxsets = uniqueBoxsets;
          console.log('✅ After duplicate removal:', boxsets.length, 'unique boxsets');
    
          // Debug: แสดงโครงสร้างข้อมูล boxset ทั้งหมด
          boxsets.forEach((boxset, index) => {
            console.log(`🎁 Boxset ${index + 1} (${boxset.name}) structure:`, {
              _id: boxset._id,
              name: boxset.name,
              selectedProducts: boxset.selectedProducts,
              products: boxset.products,
              productList: boxset.productList,
              items: boxset.items,
              allKeys: Object.keys(boxset)
            });
    
            // Debug: ตรวจสอบข้อมูลรายละเอียดของสินค้าใน boxset
            if (boxset.selectedProducts && Array.isArray(boxset.selectedProducts)) {
              console.log(`📋 Boxset "${boxset.name}" has selectedProducts:`, boxset.selectedProducts);
              boxset.selectedProducts.forEach((product, idx) => {
                console.log(`  - Product ${idx + 1}:`, {
                  name: product.name,
                  productName: product.productName,
                  quantity: product.quantity,
                  price: product.price,
                  allKeys: Object.keys(product)
                });
              });
            } else {
              console.log(`⚠️ Boxset "${boxset.name}" has NO selectedProducts or not an array`);
            }
    
            // ตรวจสอบ field อื่น ๆ ที่อาจเก็บข้อมูลสินค้า
            ['products', 'productList', 'items'].forEach(field => {
              if (boxset[field]) {
                console.log(`📋 Boxset "${boxset.name}" has ${field}:`, boxset[field]);
              }
            });
          });
        } else {
          console.log('❌ Boxset API Error:', boxsetRes.status, boxsetJs);
        }

        // รวมข้อมูล stocks และ boxsets with duplicate prevention
        const combinedStocks = [...regularStocks, ...boxsets];
    
        // Remove duplicates from final combined stocks based on _id
        const uniqueStocks = [];
        const seenStockIds = new Set();
    
        combinedStocks.forEach(item => {
          if (!seenStockIds.has(item._id)) {
            seenStockIds.add(item._id);
            uniqueStocks.push(item);
          } else {
            console.log(`⚠️ Duplicate stock item detected and removed: ${item.name} (ID: ${item._id})`);
          }
        });
    
        approvedStocks = uniqueStocks;

        // Performance optimization: Cache the processed data
        stocksCache.set(approvedStocks);

        console.log('✅ Total approved stocks after filtering:', approvedStocks.length, 'items');
        console.log('📦 Regular stocks:', regularStocks.length, 'items');
        console.log('📦 Boxsets:', boxsets.length, 'items');
        console.log('📦 Combined data sample:', approvedStocks.slice(0, 3));
        console.log('💾 Stock data cached for performance');

        // 🔍 Audit Log - Loading success
        logAuditEvent('LOAD_STOCKS_SUCCESS', {
          branchCode: BRANCH_CODE,
          stockCount: approvedStocks.length,
          regularStocksCount: regularStocks.length,
          boxsetsCount: boxsets.length,
          loadDuration: Date.now() - lastActionTime,
          cacheUpdated: true
        }, 'SUCCESS');

        // 🧪 เพิ่มปุ่มทดสอบสำหรับ debug (แสดงเฉพาะใน development)
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
          if (!document.getElementById('debugStockBtn')) {
            const debugBtn = document.createElement('button');
            debugBtn.id = 'debugStockBtn';
            debugBtn.textContent = '🧪 Debug Stock Data';
            debugBtn.className = 'fixed top-2 right-2 z-50 bg-red-500 text-white px-3 py-1 rounded text-sm';
            debugBtn.onclick = () => {
              logAuditEvent('DEBUG_BUTTON_CLICKED', {
                branchCode: BRANCH_CODE,
                stockCount: approvedStocks.length
              }, 'INFO');
              console.log('=== STOCK DEBUG INFO ===');
              console.log('BRANCH_CODE:', BRANCH_CODE);
              console.log('approvedStocks.length:', approvedStocks.length);
              console.log('All approvedStocks:', approvedStocks);
              alert(`BRANCH_CODE: ${BRANCH_CODE}\nStock Count: ${approvedStocks.length}\nCheck console for details`);
            };
            document.body.appendChild(debugBtn);
          }
    
          // เพิ่มปุ่มทดสอบ Loading
          if (!document.getElementById('debugLoadingBtn')) {
            const loadingBtn = document.createElement('button');
            loadingBtn.id = 'debugLoadingBtn';
            loadingBtn.textContent = '🔄 Test Loading';
            loadingBtn.className = 'fixed top-2 right-40 z-50 bg-blue-500 text-white px-3 py-1 rounded text-sm';
            loadingBtn.onclick = () => {
              console.log('🔄 Testing Loading...');
              showLoading(true);
              console.log('✅ Test loading shown');

              // ซ่อนหลังจาก 3 วินาที
              setTimeout(() => {
                showLoading(false);
                console.log('✅ Test loading hidden');
              }, 3000);
            };
            document.body.appendChild(loadingBtn);
          }

          // เพิ่มปุ่มทดสอบข้อมูลพนักงาน
          if (!document.getElementById('debugStaffBtn')) {
            const staffBtn = document.createElement('button');
            staffBtn.id = 'debugStaffBtn';
            staffBtn.textContent = '👤 Debug Staff';
            staffBtn.className = 'fixed top-2 right-80 z-50 bg-green-500 text-white px-3 py-1 rounded text-sm';
            staffBtn.onclick = () => {
              const staffInfo = {
                globalStaffName: staffName,
                userNameFromStorage: localStorage.getItem('userName'),
                userIdFromStorage: localStorage.getItem('userId'),
                staffNameFromStorage: localStorage.getItem('staffName'),
                authToken: localStorage.getItem('authToken') ? 'Present' : 'Missing'
              };
    
              console.log('=== STAFF DEBUG INFO ===');
              console.log('Staff Info:', staffInfo);
    
              let message = '👤 ข้อมูลพนักงานปัจจุบัน:\n\n';
              message += `ชื่อ (Global): ${staffInfo.globalStaffName}\n`;
              message += `ชื่อ (localStorage): ${staffInfo.userNameFromStorage}\n`;
              message += `User ID: ${staffInfo.userIdFromStorage}\n`;
              message += `Auth Token: ${staffInfo.authToken}\n\n`;
    
              if (staffInfo.globalStaffName === 'พนักงาน' || staffInfo.globalStaffName === 'Guest') {
                message += '⚠️ ยังใช้ชื่อ default!\n\n';
                message += 'แนะนำ: กดปุ่ม "โหลดข้อมูลใหม่" ด้านล่าง';
              } else {
                message += '✅ ชื่อพนักงานถูกต้อง';
              }
    
              const result = confirm(message + '\n\nต้องการโหลดข้อมูลพนักงานใหม่หรือไม่?');
              if (result) {
                console.log('🔄 Reloading employee profile...');
                loadEmployeeProfile();
              }
            };
            document.body.appendChild(staffBtn);
          }
        }
      } catch (err) {
        console.error('❌ loadApprovedStocks error:', err);
        logAuditEvent('LOAD_STOCKS_FAILED', {
          branchCode: BRANCH_CODE,
          error: err.message,
          stack: err.stack
        }, 'ERROR');
        approvedStocks = [];
      } finally {
        // Reset loading flag
        isLoadingStocks = false;
      }
    }

    // (1) แก้ branch_codes → applicableBranches, เพิ่ม loading state และ toast
    async function loadActivePromotions() {
      try {
        showToast('🔄 กำลังโหลดโปรโมชั่น...', 'info');
        const token = localStorage.getItem('authToken');
        const js = await safeFetch('/api/promotion/active', {
          headers: { 'Authorization': 'Bearer ' + token },
          timeout: 10000,
          maxRetries: 2
        });
        console.log('📡 API Response:', js); // DEBUG
        if (js.status === 'success') {
          activePromotions = js.data.filter(p => {
            const now = new Date();
            const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
            const startOk = new Date(p.startDate) <= now;
            const endOk = new Date(p.endDate) >= now;
            const activeOk = p.isActive === true;
            const usageOk = !p.usageLimit || (p.usageCount < p.usageLimit);
            console.log('📋 Promotion filter:', p.name, { branchOk, startOk, endOk, activeOk, usageOk }); // DEBUG
            return branchOk && startOk && endOk && activeOk && usageOk;
          });
          console.log('✅ Filtered promotions:', activePromotions); // DEBUG
          showToast(`✅ โหลดโปรโมชั่นสำเร็จ: ${activePromotions.length} รายการ`, 'success');
        }
      } catch (err) {
        console.error('❌ Error loading promotions:', err);
        activePromotions = [];
      }
    }

    // ========== เพิ่มโค้ดสำหรับแสดง Animation โปรโมชั่น ==========

    // ฟังก์ชันเช็คว่าสินค้ามีโปรโมชั่นหรือไม่ (ใช้ชื่อสินค้าในการเช็ค)
    function checkPromotionForProduct(productId) {
      console.log('🔍 Checking promotion for product:', productId);
      console.log('📊 Active promotions:', activePromotions.length);

      // หาข้อมูลสินค้าจาก approvedStocks
      const stockItem = approvedStocks.find(item => item._id === productId);
      if (!stockItem) {
        console.log('❌ Stock item not found for productId:', productId);
        return false;
      }

      console.log('📦 Stock item found:', {
        _id: stockItem._id,
        name: stockItem.name,
        brand: stockItem.brand
      });

      const hasPromo = activePromotions.some(p => {
        console.log('🎯 Checking promotion:', p.name);
        console.log('📋 Promotion applicableProducts:', p.applicableProducts);

        // ถ้าไม่ระบุสินค้า = ใช้ได้กับทุกสินค้า
        const allProducts = !p.applicableProducts ||
          (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);

        if (allProducts) {
          console.log(`✅ Promotion "${p.name}" applies to all products`);
          return true;
        }

        // เช็คด้วยชื่อสินค้า
        let matchByName = false;
        if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
          console.log('🔗 Checking by product name...');
          matchByName = p.applicableProducts.some(prod => {
            // Normalize ชื่อสินค้าก่อนเปรียบเทียบ
            const stockName = stockItem.name.trim().toLowerCase();
            const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
            const nameMatch = stockName === promoProductName;

            if (nameMatch) {
              console.log(`✅ Name match: "${stockItem.name}" === "${prod.name}"`);
            } else {
              console.log(`❌ Name no match: "${stockItem.name}" !== "${prod.name}"`);
            }

            return nameMatch;
          });
        }

        // เช็คด้วย Product ID (fallback)
        let matchById = false;
        if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
          console.log('🔗 Checking by product ID (fallback)...');
          matchById = p.applicableProducts.some(prod => {
            const prodId = typeof prod === 'string' ? prod : prod._id;
            const idMatch = prodId === productId;

            if (idMatch) {
              console.log(`✅ ID match: ${prodId} === ${productId}`);
            }

            return idMatch;
          });
        }

        const match = allProducts || matchByName || matchById;

        console.log('🎯 Result for', p.name, ':', {
          allProducts,
          matchByName,
          matchById,
          match
        });

        return match;
      });

      console.log('🔥 Final result:', hasPromo);
      return hasPromo;
    }

    // แก้ไขฟังก์ชัน checkBrandHasPromotion ให้ใช้ชื่อสินค้าด้วย
    function checkBrandHasPromotion(brandKey) {
      const brandProducts = approvedStocks.filter(p => {
        const key = (p.brand || p.name.split(' ')[0]).trim().toLowerCase();
        return key === brandKey;
      });

      // เช็คว่ามีสินค้าใดในแบรนด์นี้ที่มีโปรโมชั่นหรือไม่
      return brandProducts.some(product => {
        const hasPromo = activePromotions.some(promo => {
          // ถ้าโปรโมชั่นใช้ได้กับทุกสินค้า
          if (!promo.applicableProducts || promo.applicableProducts.length === 0) {
            return true;
          }

          // เช็คด้วยชื่อสินค้า
          return promo.applicableProducts.some(promoProd => {
            const stockName = product.name.trim().toLowerCase();
            const promoName = promoProd.name ? promoProd.name.trim().toLowerCase() : '';
            return stockName === promoName;
          });
        });

        return hasPromo;
      });
    }

    // แก้ไขฟังก์ชัน checkGroupHasPromotion ให้ใช้ชื่อสินค้าด้วย
    function checkGroupHasPromotion(groupItems) {
      return groupItems.some(item => {
        const hasPromo = activePromotions.some(promo => {
          // ถ้าโปรโมชั่นใช้ได้กับทุกสินค้า
          if (!promo.applicableProducts || promo.applicableProducts.length === 0) {
            return true;
          }

          // เช็คด้วยชื่อสินค้า
          return promo.applicableProducts.some(promoProd => {
            const stockName = item.name.trim().toLowerCase();
            const promoName = promoProd.name ? promoProd.name.trim().toLowerCase() : '';
            return stockName === promoName;
          });
        });

        return hasPromo;
      });
    }

    // เพิ่มฟังก์ชันสำหรับสร้าง confetti effect
    function createConfettiEffect(element) {
      const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
      const confettiCount = 30;

      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.transition = 'all 1s ease-out';
        confetti.style.zIndex = '1000';

        element.appendChild(confetti);

        setTimeout(() => {
          confetti.style.top = '100%';
          confetti.style.opacity = '0';
          confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
        }, 10);

        setTimeout(() => confetti.remove(), 1000);
      }
    }

    // ========== จบโค้ดเพิ่มเติม ==========

    // ฟังก์ชันคำนวณอายุจากวันเกิด
    function calculateAgeFromBirthDate() {
      const birthDateInput = document.getElementById('customerBirthDate');
      const ageInput = document.getElementById('customerAge');
    
      if (!birthDateInput || !ageInput || !birthDateInput.value) {
        return;
      }
    
      const birthDate = new Date(birthDateInput.value);
      const today = new Date();
    
      // ตรวจสอบว่าวันเกิดไม่เกินวันปัจจุบัน
      if (birthDate > today) {
        showToast('วันเกิดไม่สามารถมากกว่าวันปัจจุบันได้', 'warning');
        birthDateInput.value = '';
        ageInput.value = '';
        return;
      }
    
      // คำนวณอายุ
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
    
      // ถ้ายังไม่ถึงวันเกิดในปีนี้ ให้ลบอายุลง 1
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
    
      // ตรวจสอบอายุที่สมเหตุสมผล
      if (age < 0 || age > 150) {
        showToast('วันเกิดไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง', 'warning');
        birthDateInput.value = '';
        ageInput.value = '';
        return;
      }
    
      ageInput.value = age;
      console.log(`🎂 คำนวณอายุจากวันเกิด: ${age} ปี`);
    }

    // ฟังก์ชันอัพเดทสถานะการส่งอีเมล (Global function)
    function updateEmailStatus() {
      try {
        const customerType = document.getElementById('customerType')?.value || 'individual';
        const emailPersonal = document.getElementById('customerEmailPersonal');
        const emailCorporate = document.getElementById('corporateEmail');
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        const emailNote = document.getElementById('emailNoteText');
    
        // ตรวจสอบว่า elements มีอยู่หรือไม่
        if (!emailPersonal || !emailCorporate || !emailCheckbox || !emailNote) {
          console.warn('updateEmailStatus: Required elements not found');
          return;
        }
    
        const emailField = customerType === 'individual' ? emailPersonal : emailCorporate;
        const hasEmail = emailField && emailField.value.trim() !== '';
        const isChecked = emailCheckbox.checked;
    
        if (isChecked && !hasEmail) {
          emailNote.textContent = '⚠️ กรุณากรอกอีเมลลูกค้าเพื่อส่งใบเสร็จอัตโนมัติ';
          emailNote.parentElement.classList.add('text-yellow-600');
          emailNote.parentElement.classList.remove('text-gray-500', 'text-green-600');
        } else if (isChecked && hasEmail) {
          emailNote.textContent = '✅ ระบบจะส่งใบเสร็จไปยัง ' + emailField.value;
          emailNote.parentElement.classList.add('text-green-600');
          emailNote.parentElement.classList.remove('text-gray-500', 'text-yellow-600');
        } else {
          emailNote.textContent = 'ไม่ส่งอีเมลอัตโนมัติ';
          emailNote.parentElement.classList.add('text-gray-500');
          emailNote.parentElement.classList.remove('text-yellow-600', 'text-green-600');
        }
      } catch (error) {
        console.error('updateEmailStatus error:', error);
      }
    }


          // Global notification system instance
      let posNotificationSystem = null;

      // Quick Actions Menu JavaScript
      document.addEventListener('DOMContentLoaded', function() {
        const quickActionsBtn = document.getElementById('quickActionsBtn');
        const quickActionsDropdown = document.getElementById('quickActionsDropdown');
    
        if (quickActionsBtn && quickActionsDropdown) {
          const chevronIcon = quickActionsBtn.querySelector('.bi-chevron-down');
    
          // Toggle dropdown
          quickActionsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
    
            const isHidden = quickActionsDropdown.classList.contains('hidden');
    
            if (isHidden) {
              quickActionsDropdown.classList.remove('hidden');
              chevronIcon.classList.add('rotate-180');
            } else {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!quickActionsBtn.contains(e.target) && !quickActionsDropdown.contains(e.target)) {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Close dropdown on escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              quickActionsDropdown.classList.add('hidden');
              chevronIcon.classList.remove('rotate-180');
            }
          });
    
          // Keyboard navigation support
          const menuItems = quickActionsDropdown.querySelectorAll('a');
          let currentIndex = -1;
    
          document.addEventListener('keydown', (e) => {
            const isDropdownVisible = !quickActionsDropdown.classList.contains('hidden');
    
            if (!isDropdownVisible) return;
    
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              currentIndex = (currentIndex + 1) % menuItems.length;
              updateMenuFocus();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              currentIndex = currentIndex <= 0 ? menuItems.length - 1 : currentIndex - 1;
              updateMenuFocus();
            } else if (e.key === 'Enter' && currentIndex >= 0) {
              e.preventDefault();
              menuItems[currentIndex].click();
            }
          });
    
          function updateMenuFocus() {
            menuItems.forEach((item, index) => {
              if (index === currentIndex) {
                item.classList.add('bg-gray-100');
                item.focus();
              } else {
                item.classList.remove('bg-gray-100');
              }
            });
          }
    
          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // Alt+M or Ctrl+M to open menu
            if ((e.altKey || e.ctrlKey) && e.key.toLowerCase() === 'm') {
              e.preventDefault();
              quickActionsBtn.click();
            }
          });
        }
      });

      // Final safety check before DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
      // ประกาศ loaderId ไว้ข้างนอก try block
      let loaderId = null;
    
      try {
        // Initialize loading system
        console.log('🔍 Testing Loading...');

        // Show loading overlay
        showLoading(true);
        console.log('✅ Loading shown');
    
        // Initialize Modular Notification System
        if (typeof ModularNotificationSystem !== 'undefined') {
          posNotificationSystem = new ModularNotificationSystem();
          console.log('🔔 POS Notification System initialized');
    
          // ไม่แสดง welcome notification - ลบออกตามคำร้องของผู้ใช้
        } else {
          console.warn('⚠️ ModularNotificationSystem not available');
        }
    
        // 🔍 Audit Log - Page Load Start
        const pageLoadStart = Date.now();
        logAuditEvent('PAGE_LOAD_START', {
          url: window.location.href,
          branchCode: BRANCH_CODE,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        }, 'INFO');

        // Note: Sidebar initialization is now handled by sidebar.js

        // 2) Load employee profile, stocks, promotions, branch, level1
        await loadEmployeeProfile();     // ← เพิ่มบรรทัดนี้เพื่อโหลดข้อมูลพนักงาน
        await loadApprovedStocks();

        // 3) โหลดข้อมูลจากใบรับเงินมัดจำ (ถ้ามี)
        await loadDepositReceiptData();

        // ตรวจสอบ Card Reader System
        checkCardReaderSystem();
        await loadActivePromotions();    // ← เพิ่มบรรทัดนี้
        await loadBranchInfo();
        loadLevel1();

        // 4) เพิ่มสินค้าจากใบรับลงตะกร้าอัตโนมัติ (หลังจากโหลดสต็อกเสร็จ)
        if (fromDepositReceipt) {
          setTimeout(() => {
            autoAddPreSelectedProduct();
          }, 1000); // รอ 1 วินาที เพื่อให้แน่ใจว่าสต็อกโหลดเสร็จ
        }
        localStorage.removeItem('userEmail');

      // 3) Search & reset
      document.getElementById('btnSearch').addEventListener('click', searchItems);
      document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('searchQuery').value = '';
        SecurityHelpers.safeSetContent(document.getElementById('imeiResultGrid'), '', '');
        document.getElementById('imeiResultContainer').classList.add('hidden'); // ซ่อนผลลัพธ์การค้นหา
        goBackToLevel1(); // กลับไปหน้า Level 1
      });

      // 3.1) Barcode Scanner
      document.getElementById('btnAddBarcode').addEventListener('click', processBarcodeInput);
      document.getElementById('btnClearBarcode').addEventListener('click', () => {
        document.getElementById('barcodeInput').value = '';
        document.getElementById('barcodeResults').classList.add('hidden');
      });
    
      // Barcode input Enter key listener
      document.getElementById('barcodeInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          processBarcodeInput();
        }
      });

      // Auto-focus barcode input when Alt+B is pressed
      document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key === 'b') {
          e.preventDefault();
          document.getElementById('barcodeInput').focus();
        }
      });

      // 4) Level navigation
      document.getElementById('btnGoBack').addEventListener('click', goBackToLevel1);
      document.getElementById('btnGoBackToLevel2').addEventListener('click', goBackToLevel2);
    
      // 5) Customer gender auto-fill from prefix
      document.getElementById('customerPrefix').addEventListener('change', function() {
        const genderField = document.getElementById('customerGender');
        if (genderField) {
          const prefix = this.value;
          let gender = '';
    
          if (prefix === 'นาย') {
            gender = 'ชาย';
          } else if (prefix === 'นาง' || prefix === 'นางสาว') {
            gender = 'หญิง';
          }
    
          genderField.value = gender;
        }
      });
    
      // ✅ 6) [ลบแล้ว - ระบบสร้างเอกสารทั้งสองใบอัตโนมัติ]

      // ฟังก์ชันนี้ถูกย้ายไป global scope แล้ว (window.fillCustomerDataFromCard)
      /*
      function fillCustomerDataFromCard(cardData) {
        console.log('🔄 เติมข้อมูลลูกค้าจากบัตร:', cardData);
        console.log('🔍 ตรวจสอบ properties:', Object.keys(cardData));
    
        try {
          // ข้อมูลพื้นฐาน - ลองหลายๆ property name
          const citizenId = cardData.citizenId || cardData.Citizenid || cardData.CitizenId || cardData.id || '';
          const firstNameTh = cardData.firstNameTh || cardData.FirstNameTh || cardData.firstname || cardData.firstName || '';
          const lastNameTh = cardData.lastNameTh || cardData.LastNameTh || cardData.lastname || cardData.lastName || '';
          const titleTh = cardData.titleTh || cardData.TitleTh || cardData.title || cardData.prefix || '';
          const address = cardData.address || cardData.Address || cardData.addr || '';
    
          // ข้อมูลวันเกิดและอายุ - ลองหลาย property names
          const birthDate = cardData.birthDate || cardData.BirthdayEn || cardData.birthday ||
                           cardData.dateOfBirth || cardData.Birthday || cardData.BirthDate ||
                           cardData.birth_date || cardData.dob || '';
          const age = cardData.age || cardData.Age || cardData.AGE || '';
    
          // ข้อมูลที่อยู่แยกย่อย (ใช้ # เป็นตัวแยก)
          const district = cardData.district || cardData.District || '';
          const subDistrict = cardData.subDistrict || cardData.SubDistrict || cardData.tambon || '';
          const province = cardData.province || cardData.Province || cardData.changwat || '';
    
          // 🔍 Debug ข้อมูลที่แยกได้
          console.log('📋 ข้อมูลที่แยกได้:');
          console.log('  - เลขบัตรประชาชน:', citizenId);
          console.log('  - คำนำหน้า:', titleTh);
          console.log('  - ชื่อ:', firstNameTh);
          console.log('  - นามสกุล:', lastNameTh);
          console.log('  - วันเกิด:', birthDate);
          console.log('  - อายุ:', age);
          console.log('  - ที่อยู่:', address);
          console.log('  - อำเภอ (ดิบ):', district);
          console.log('  - ตำบล (ดิบ):', subDistrict);
          console.log('  - จังหวัด (ดิบ):', province);
    
          // 🔍 Debug วันเกิด properties ทั้งหมด
          console.log('📅 Debug วันเกิด properties:');
          console.log('  - cardData.birthDate:', cardData.birthDate);
          console.log('  - cardData.BirthdayEn:', cardData.BirthdayEn);
          console.log('  - cardData.birthday:', cardData.birthday);
          console.log('  - cardData.Birthday:', cardData.Birthday);
          console.log('  - cardData.BirthDate:', cardData.BirthDate);
          console.log('  - cardData.birth_date:', cardData.birth_date);
          console.log('  - cardData.dateOfBirth:', cardData.dateOfBirth);
          console.log('  - cardData.dob:', cardData.dob);
    
          // 🔍 Debug อายุ properties ทั้งหมด
          console.log('👶 Debug อายุ properties:');
          console.log('  - cardData.age:', cardData.age);
          console.log('  - cardData.Age:', cardData.Age);
          console.log('  - cardData.AGE:', cardData.AGE);
    
          // คำนำหน้า
          const prefixField = document.getElementById('customerPrefix');
          if (prefixField && titleTh) {
            prefixField.value = titleTh;
            console.log('✅ เติมคำนำหน้า:', titleTh);
          } else {
            console.log('❌ ไม่พบคำนำหน้าหรือ field');
          }
    
          // เพศ (อัตโนมัติจากคำนำหน้า)
          const genderField = document.getElementById('customerGender');
          if (genderField && titleTh) {
            let gender = '';
            if (titleTh === 'นาย') {
              gender = 'ชาย';
            } else if (titleTh === 'นาง' || titleTh === 'นางสาว') {
              gender = 'หญิง';
            }
    
            if (gender) {
              genderField.value = gender;
              console.log('✅ เติมเพศ (อัตโนมัติ):', gender);
            }
          }
    
          // ชื่อ
          const firstNameField = document.getElementById('customerFirstName');
          if (firstNameField && firstNameTh) {
            firstNameField.value = firstNameTh;
            console.log('✅ เติมชื่อ:', firstNameTh);
          } else {
            console.log('❌ ไม่พบชื่อหรือ field');
          }
    
          // นามสกุล
          const lastNameField = document.getElementById('customerLastName');
          if (lastNameField && lastNameTh) {
            lastNameField.value = lastNameTh;
            console.log('✅ เติมนามสกุล:', lastNameTh);
          } else {
            console.log('❌ ไม่พบนามสกุลหรือ field, lastNameTh =', lastNameTh);
          }
    
          // เลขประจำตัวผู้เสียภาษี (เลขบัตรประชาชน)
          const taxIdField = document.getElementById('customerTaxId');
          if (taxIdField && citizenId) {
            taxIdField.value = citizenId;
            console.log('✅ เติมเลขบัตรประชาชน:', citizenId);
          } else {
            console.log('❌ ไม่พบเลขบัตรหรือ field');
          }
    
          // วันเกิด
          console.log('🎂 กำลังเติมวันเกิด...');
          const birthDateField = document.getElementById('customerBirthDate');
          console.log('  - พบ birthDateField:', !!birthDateField);
          console.log('  - ข้อมูลวันเกิดที่ได้:', birthDate);
          console.log('  - typeof birthDate:', typeof birthDate);
    
          if (birthDateField && birthDate && typeof birthDate === 'string' && birthDate.trim()) {
            let formattedDate = birthDate;
            console.log('  - วันเกิดเริ่มต้น:', birthDate);
    
            // แปลงรูปแบบวันที่ถ้าจำเป็น
            if (typeof birthDate === 'string') {
              // รองรับรูปแบบ DD/MM/YYYY
              if (birthDate.includes('/')) {
                const parts = birthDate.split('/');
                console.log('  - แยกวันที่:', parts);
                if (parts.length === 3) {
                  let year = parseInt(parts[2], 10);
                  const month = parts[1].padStart(2, '0');
                  const day = parts[0].padStart(2, '0');
    
                  // แปลงปี พ.ศ. เป็น ค.ศ. ถ้าจำเป็น
                  if (year > 2500) {
                    console.log(`  - พบปี พ.ศ.: ${year}`);
                    year = year - 543;
                    console.log(`  - แปลงเป็น ค.ศ.: ${year}`);
                  }
    
                  // แปลงเป็น YYYY-MM-DD สำหรับ input[type="date"]
                  formattedDate = `${year}-${month}-${day}`;
                  console.log('  - วันที่หลังแปลง:', formattedDate);
                }
              }
            }
    
            birthDateField.value = formattedDate;
            console.log('✅ เติมวันเกิดสำเร็จ:', formattedDate);
    
            // ตรวจสอบค่าใน field หลังเติม
            setTimeout(() => {
              console.log('🔍 ตรวจสอบ UI หลังเติมวันเกิด:', birthDateField.value);
            }, 100);
          } else {
            console.log('❌ ไม่สามารถเติมวันเกิดได้:');
            console.log('  - birthDateField:', !!birthDateField);
            console.log('  - birthDate:', birthDate);
            console.log('  - birthDate type:', typeof birthDate);
            console.log('  - birthDate.trim():', (birthDate && typeof birthDate === 'string') ? birthDate.trim() : 'N/A');
          }
    
          // อายุ
          console.log('👶 กำลังเติมอายุ...');
          const ageField = document.getElementById('customerAge');
          console.log('  - พบ ageField:', !!ageField);
          console.log('  - ข้อมูลอายุที่ได้:', age);
          console.log('  - typeof age:', typeof age);
    
          if (ageField && age && age !== '') {
            // แปลงเป็นตัวเลขถ้าเป็น string
            const ageValue = typeof age === 'string' ? parseInt(age, 10) : age;
            console.log('  - อายุหลังแปลง:', ageValue);
    
            if (!isNaN(ageValue) && ageValue > 0) {
              ageField.value = ageValue;
              console.log('✅ เติมอายุสำเร็จ:', ageValue);
    
              // ตรวจสอบค่าใน field หลังเติม
              setTimeout(() => {
                console.log('🔍 ตรวจสอบ UI หลังเติมอายุ:', ageField.value);
                console.log('🔍 ageField readonly:', ageField.readOnly);
                console.log('🔍 ageField disabled:', ageField.disabled);
              }, 100);
            } else {
              console.log('❌ อายุไม่ถูกต้อง:', ageValue);
            }
          } else {
            console.log('❌ ไม่สามารถเติมอายุได้:');
            console.log('  - ageField:', !!ageField);
            console.log('  - age:', age);
            console.log('  - age !== "":', age !== '');
          }
    
          // จัดการข้อมูลที่อยู่ (ทั้งจากที่อยู่เต็มและข้อมูลแยกย่อย)
          console.log('🏠 กำลังประมวลผลข้อมูลที่อยู่...');
    
          // หา field ที่เกี่ยวข้องกับที่อยู่
          const houseNoField = document.getElementById('houseNo');
          const mooField = document.getElementById('moo');
          const provinceField = document.getElementById('province');
          const districtField = document.getElementById('district');
          const subDistrictField = document.getElementById('subDistrict');
          const zipcodeField = document.getElementById('zipcode');
    
          // 1. ใช้ข้อมูลแยกย่อยก่อน (เพราะแม่นยำกว่า)
    
          // จังหวัด (จากข้อมูลแยกย่อย)
          if (province && provinceField) {
            // แยกเฉพาะส่วนหลัก (ก่อน #)
            const cleanProvince = province.split('#')[0].trim();
            provinceField.value = cleanProvince;
            console.log('✅ เติมจังหวัด (แยกย่อย):', cleanProvince);
          }
    
          // อำเภอ (จากข้อมูลแยกย่อย)
          if (district && districtField) {
            // แยกเฉพาะส่วนหลัก (ก่อน #)
            // ตัวอย่าง: "ยะรัง#จังหวัดปัตตานี" → "ยะรัง"
            const cleanDistrict = district.split('#')[0].trim();
            districtField.value = cleanDistrict;
            console.log('✅ เติมอำเภอ (แยกย่อย):', cleanDistrict);
          }
    
          // ตำบล (จากข้อมูลแยกย่อย)
          if (subDistrict && subDistrictField) {
            // แยกเฉพาะส่วนหลัก (ก่อน #)
            // ตัวอย่าง: "ระแว้ง#อำเภอยะรัง#จังหวัดปัตตานี" → "ระแว้ง"
            const cleanSubDistrict = subDistrict.split('#')[0].trim();
            subDistrictField.value = cleanSubDistrict;
            console.log('✅ เติมตำบล (แยกย่อย):', cleanSubDistrict);
          }
    
          // 2. แยกข้อมูลจากที่อยู่เต็ม (สำหรับข้อมูลที่เหลือ)
          if (address && address.trim()) {
            console.log('🏠 กำลังแยกที่อยู่เต็ม:', address);
    
            // ค้นหารหัสไปรษณีย์ (5 หลัก)
            let zipMatch = address.match(/(\d{5})(?:\s|$)/g);
            if (!zipMatch) zipMatch = address.match(/\s(\d{5})$/);
            if (zipMatch && zipcodeField) {
              const zipcode = zipMatch[zipMatch.length - 1].replace(/\s/g, '');
              zipcodeField.value = zipcode;
              console.log('✅ เติมรหัสไปรษณีย์:', zipcode);
            }
    
            // ค้นหาหมู่ (หลายๆ รูปแบบ)
            let mooMatch = address.match(/หมู่\s*(\d+)/i) ||
                          address.match(/ม\.(\d+)/i) ||
                          address.match(/หมู่ที่\s*(\d+)/i);
            if (mooMatch && mooField) {
              const moo = mooMatch[1];
              mooField.value = moo;
              console.log('✅ เติมหมู่:', moo);
            }
    
            // ค้นหาเลขที่บ้าน (ที่ต้นสตริง)
            let houseMatch = address.match(/^(\d+[\\/\d-]*)/);
            if (houseMatch && houseNoField) {
              const houseNo = houseMatch[1];
              houseNoField.value = houseNo;
              console.log('✅ เติมเลขที่:', houseNo);
            }
    
            // ถ้าข้อมูลแยกย่อยไม่มี ลองหาจากที่อยู่เต็ม
            if (!province && provinceField) {
              let provinceMatch = address.match(/จังหวัด([^\s\d#]+)/i) ||
                                address.match(/จ\.([^\s\d#]+)/i);
              if (provinceMatch) {
                const foundProvince = provinceMatch[1].trim();
                provinceField.value = foundProvince;
                console.log('✅ เติมจังหวัด (จากที่อยู่เต็ม):', foundProvince);
              }
            }
    
            if (!district && districtField) {
              let districtMatch = address.match(/อำเภอ([^\s\d#]+)/i) ||
                                address.match(/อ\.([^\s\d#]+)/i) ||
                                address.match(/เขต([^\s\d#]+)/i);
              if (districtMatch) {
                const foundDistrict = districtMatch[1].trim();
                districtField.value = foundDistrict;
                console.log('✅ เติมอำเภอ (จากที่อยู่เต็ม):', foundDistrict);
              }
            }
    
            if (!subDistrict && subDistrictField) {
              let subDistrictMatch = address.match(/ตำบล([^\s\d#]+)/i) ||
                                   address.match(/ต\.([^\s\d#]+)/i) ||
                                   address.match(/แขวง([^\s\d#]+)/i);
              if (subDistrictMatch) {
                const foundSubDistrict = subDistrictMatch[1].trim();
                subDistrictField.value = foundSubDistrict;
                console.log('✅ เติมตำบล (จากที่อยู่เต็ม):', foundSubDistrict);
              }
            }
    
          } else {
            console.log('⚠️ ไม่พบข้อมูลที่อยู่เต็ม');
          }
    
          console.log('✅ เติมข้อมูลลูกค้าจากบัตรเสร็จสิ้น');
    
          // Trigger change events เพื่อให้ระบบอัพเดท
          const fieldsToUpdate = [
            prefixField, firstNameField, lastNameField, taxIdField,
            birthDateField, ageField,
            document.getElementById('houseNo'),
            document.getElementById('moo'),
            document.getElementById('province'),
            document.getElementById('district'),
            document.getElementById('subDistrict'),
            document.getElementById('zipcode')
          ].filter(field => field);
    
          fieldsToUpdate.forEach(field => {
            if (field && field.value) {
              field.dispatchEvent(new Event('change', { bubbles: true }));
              field.dispatchEvent(new Event('input', { bubbles: true }));
            }
          });
    
          // คำนวณอายุจากวันเกิดถ้ามีการเติมวันเกิด
          if (birthDateField && birthDateField.value) {
            setTimeout(() => {
              if (typeof calculateAgeFromBirthDate === 'function') {
                calculateAgeFromBirthDate();
                console.log('🎂 คำนวณอายุจากวันเกิดแล้ว');
              }
            }, 100);
          }
    
          // แสดงการแจ้งเตือนสำหรับข้อมูลที่เติมได้
          const filledFields = [];
          if (titleTh) filledFields.push('คำนำหน้า');
          if (firstNameTh) filledFields.push('ชื่อ');
          if (lastNameTh) filledFields.push('นามสกุล');
          if (citizenId) filledFields.push('เลขบัตรประชาชน');
    
          // เช็คว่าจริงๆ แล้วเติมวันเกิดและอายุสำเร็จหรือไม่
          const birthDateFilled = birthDateField && birthDateField.value;
          const ageFilled = ageField && ageField.value;
    
          if (birthDateFilled) filledFields.push('วันเกิด');
          if (ageFilled) filledFields.push('อายุ');
          if (address || district || subDistrict || province) filledFields.push('ที่อยู่');
    
          // แสดงข้อมูลที่ไม่พบด้วย
          const missingFields = [];
          if (!titleTh) missingFields.push('คำนำหน้า');
          if (!firstNameTh) missingFields.push('ชื่อ');
          if (!lastNameTh) missingFields.push('นามสกุล');
          if (!citizenId) missingFields.push('เลขบัตรประชาชน');
          if (!birthDateFilled && !ageFilled) missingFields.push('วันเกิด/อายุ');
          if (!address && !district && !subDistrict && !province) missingFields.push('ที่อยู่');
    
          if (typeof showToast === 'function') {
            if (filledFields.length > 0) {
              showToast(
                `✅ เติมข้อมูลสำเร็จ: ${filledFields.join(', ')}`,
                'success',
                'เครื่องอ่านบัตร',
                4000
              );
            }
    
            if (missingFields.length > 0) {
              showToast(
                `⚠️ ข้อมูลที่ไม่พบ: ${missingFields.join(', ')}`,
                'warning',
                'เครื่องอ่านบัตร',
                3000
              );
            }
          }
    
        } catch (error) {
          console.error('❌ Error filling customer data from card:', error);
          if (typeof showToast === 'function') {
            showToast('❌ เกิดข้อผิดพลาดในการเติมข้อมูล', 'error', 'เครื่องอ่านบัตร');
          }
        }
      }
      */ // ฟังก์ชันเก่าถูก comment ออก

      // 5) Card reader & checkout
      // ปุ่มทดสอบเครื่องอ่านบัตร
      document.getElementById('btnTestCardReader').addEventListener('click', function(e) {
        e.preventDefault();
    
        console.log('🧪 Testing Card Reader System...');
        checkCardReaderSystem();
    
        // แสดงข้อมูลเพิ่มเติมใน console
                 setTimeout(() => {
          console.log('📊 Card Reader System Status:');
          console.log('- CardReaderConfig:', typeof window.CardReaderConfig);
          console.log('- CardReaderService:', typeof window.CardReaderService);
          console.log('- fillCustomerDataFromCard:', typeof window.fillCustomerDataFromCard);
          console.log('- Branch Code:', BRANCH_CODE);
    
          if (window.CardReaderConfig) {
            const isEnabled = window.CardReaderConfig.isCardReaderEnabled(BRANCH_CODE);
            console.log('- Card Reader Enabled:', isEnabled);
    
            if (isEnabled) {
              const config = window.CardReaderConfig.getCardProxyUrls(BRANCH_CODE);
              console.log('- Available URLs:', config.all.map(u => u.http));
            }
          }
    
          // ทดสอบฟังก์ชันเติมข้อมูลด้วยข้อมูลจริง
          if (typeof window.fillCustomerDataFromCard === 'function') {
            console.log('🧪 Testing fillCustomerDataFromCard with EXACT real card data format...');
            window.testCardData = {
              // ข้อมูลพื้นฐานรูปแบบจริง (case-sensitive)
              Citizenid: '1234567890123',
              Gender: 'ชาย',
              TitleTh: 'นาย',
              FirstNameTh: 'สมชาย',
              LastNameTh: 'ใจดี',
              Age: '35',
              BirthdayTh: '15/03/1989',
    
              // ข้อมูลที่อยู่แบบ # delimiter (เหมือนบัตรจริง 100%)
              Address: '123/45#หมู่ที่ 7####ตำบลคลองหาด#อำเภอหาดใหญ่#จังหวัดสงขลา'
            };
            console.log('📝 EXACT real card data format available in window.testCardData');
            console.log('💡 Run: fillCustomerDataFromCard(testCardData) to test');
            console.log('🏠 Address format: 123/45#หมู่ที่ 7####ตำบลคลองหาด#อำเภอหาดใหญ่#จังหวัดสงขลา');
            console.log('🔍 This should fill all address fields including หมู่, ตำบล, อำเภอ with # delimiter parser');
          }
        }, 500);
      });
    
      // ฟังก์ชันพิเศษ: วิเคราะห์ข้อมูลจากบัตรจริง
    window.analyzeRealCardData = function(cardData) {
      console.log('🔍 ===== REAL CARD DATA ANALYSIS =====');
      console.log('📋 Raw data:', cardData);
      console.log('🔑 Available keys:', Object.keys(cardData));
    
      // วิเคราะห์ข้อมูลที่อยู่
      const addressKeys = Object.keys(cardData).filter(key =>
        key.toLowerCase().includes('address') ||
        key.toLowerCase().includes('district') ||
        key.toLowerCase().includes('province') ||
        key.toLowerCase().includes('tambon') ||
        key.toLowerCase().includes('amphoe') ||
        key.toLowerCase().includes('village') ||
        key.toLowerCase().includes('moo') ||
        key.toLowerCase().includes('house')
      );
    
      console.log('🏠 Address-related keys found:', addressKeys);
    
      addressKeys.forEach(key => {
        console.log(`  📍 ${key}:`, cardData[key]);
    
        // ถ้าเป็น Address และมี # ให้แยกดู
        if (key === 'Address' && cardData[key] && cardData[key].includes('#')) {
          const parts = cardData[key].split('#').filter(part => part.trim() !== '');
          console.log(`    🔍 Split by # (${parts.length} parts):`, parts);
    
          parts.forEach((part, index) => {
            const cleanPart = part.trim();
            if (cleanPart) {
              console.log(`      ${index + 1}. "${cleanPart}"`);
            }
          });
        }
      });
    
      // แนะนำการ mapping
      console.log('💡 Mapping suggestions:');
      console.log('  - หมู่ที่: village, moo, Village, Moo (หรือใน Address: หมู่ที่ X)');
      console.log('  - ตำบล: subDistrict, tambon, SubDistrict, Tambon (หรือใน Address: ตำบลXXX)');
      console.log('  - อำเภอ: district, amphoe, District, Amphoe (หรือใน Address: อำเภอXXX)');
      console.log('  - จังหวัด: province, changwat, Province, Changwat (หรือใน Address: จังหวัดXXX)');
      console.log('  - เลขที่บ้าน: houseNumber, houseNo, HouseNumber, HouseNo (หรือใน Address: XXX/XX)');
      console.log('🔍 สำหรับ # delimiter format: แยกแต่ละส่วนด้วย split("#")');
    
      return {
        allKeys: Object.keys(cardData),
        addressKeys: addressKeys,
        addressData: addressKeys.reduce((obj, key) => {
          obj[key] = cardData[key];
          return obj;
        }, {})
      };
    };

    // ปุ่มทดสอบเติมข้อมูลจริง (รวมที่อยู่)
      document.getElementById('btnTestFillData').addEventListener('click', function(e) {
        e.preventDefault();
    
        console.log('🧪 Testing fillCustomerDataFromCard with realistic data...');
    
        if (typeof window.fillCustomerDataFromCard === 'function') {
                      // ข้อมูลทดสอบรูปแบบเดียวกับบัตรจริง (# delimiter format)
            const testData = {
              // ข้อมูลพื้นฐานรูปแบบจริง
              Citizenid: '1234567890123',
              TitleTh: 'นาย',
              FirstNameTh: 'สมชาย',
              LastNameTh: 'ใจดี',
              Age: '35',
              BirthdayTh: '15/03/1989',
    
              // ข้อมูลที่อยู่แบบ # delimiter (เหมือนบัตรจริง 100%)
              Address: '123/45#หมู่ที่ 7####ตำบลคลองหาด#อำเภอหาดใหญ่#จังหวัดสงขลา'
            };
    
                      console.log('📝 Using real card data format:', testData);
            const result = window.fillCustomerDataFromCard(testData);
    
            if (result) {
              console.log('✅ Test data fill successful');
    
              // ตรวจสอบว่าช่องที่อยู่ถูกเติมหรือไม่
              setTimeout(() => {
                const addressCheck = {
                  houseNo: document.getElementById('houseNo')?.value || '',
                  moo: document.getElementById('moo')?.value || '',
                  subDistrict: document.getElementById('subDistrict')?.value || '',
                  district: document.getElementById('district')?.value || '',
                  province: document.getElementById('province')?.value || ''
                };
    
                console.log('🏠 Address fields after fill:', addressCheck);
    
                const filledAddressFields = Object.values(addressCheck).filter(v => v).length;
                const totalAddressFields = Object.keys(addressCheck).length;
    
                if (typeof showToast === 'function') {
                  if (filledAddressFields >= 3) {
                    showToast(
                      `✅ ทดสอบสำเร็จ: เติมที่อยู่ ${filledAddressFields}/${totalAddressFields} ช่อง`,
                      'success',
                      'การทดสอบ',
                      4000
                    );
                  } else {
                    showToast(
                      `⚠️ เติมที่อยู่ได้เพียง ${filledAddressFields}/${totalAddressFields} ช่อง`,
                      'warning',
                      'การทดสอบ',
                      4000
                    );
                  }
                }
              }, 500);
            } else {
              console.log('❌ Test data fill failed');
            }
        } else {
          console.error('❌ fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast('❌ ฟังก์ชันเติมข้อมูลไม่พร้อมใช้งาน', 'error', 'การทดสอบ');
          }
        }
      });
    
      // ปุ่มอ่านบัตรจริง
      document.getElementById('btnReadCard').addEventListener('click', async function(e) {
        e.preventDefault();
    
        // แสดง loading state
        const btn = e.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอ่านบัตร...';
        btn.disabled = true;
    
        try {
          // ตรวจสอบว่า CardReaderService พร้อมใช้งานหรือไม่
          if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
            throw new Error('ระบบเครื่องอ่านบัตรไม่พร้อมใช้งาน กรุณาติดต่อผู้ดูแลระบบ');
          }
    
          // ใช้ retry mechanism แทน readCard() ธรรมดา
          const result = await retryReadCard(1);
    
          if (result && result.success && result.data) {
            // จัดการข้อมูลบัตรที่อ่านได้
            const cardData = result.data;
    
            // เติมข้อมูลลูกค้าอัตโนมัติ
            if (typeof window.fillCustomerDataFromCard === 'function') {
              window.fillCustomerDataFromCard(cardData);
            } else {
              console.error('❌ fillCustomerDataFromCard function not available');
              if (typeof showToast === 'function') {
                showToast('❌ ฟังก์ชันเติมข้อมูลไม่พร้อมใช้งาน', 'error', 'เครื่องอ่านบัตร');
              }
            }
    
            // แสดงข้อความสำเร็จ
            if (typeof showToast === 'function') {
              showToast(
                `✅ อ่านบัตรประชาชนสำเร็จ: ${cardData.titleTh || ''}${cardData.firstNameTh || ''} ${cardData.lastNameTh || ''}`,
                'success',
                'เครื่องอ่านบัตร',
                5000
              );
            }
          } else {
            const errorMsg = result?.error || 'ไม่สามารถอ่านข้อมูลบัตรได้';
            throw new Error(errorMsg);
          }
    
        } catch (error) {
          console.error('❌ Error reading card:', error);
    
          // สร้างข้อความแสดงข้อผิดพลาดที่เป็นมิตรกับผู้ใช้
          let errorMessage = error.message || 'เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ';
    
          // ตรวจสอบว่าเป็น error จาก retry mechanism หรือไม่
          const isRetryError = errorMessage.includes('หลังจากลอง') && errorMessage.includes('ครั้ง');
    
          // เพิ่มข้อมูล debug สำหรับ admin
          if (error.connectionErrors && error.connectionErrors.length > 0) {
            console.log('🔍 Connection errors details:', error.connectionErrors);
    
            // แสดงรายละเอียด endpoint ที่ล้มเหลว
            const failedEndpoints = error.connectionErrors.map(err =>
              `${err.name}: ${err.error}`
            ).join('\n');
    
            console.log('📋 Failed endpoints summary:\n' + failedEndpoints);
          }
    
          // แสดงปุ่มทดสอบการเชื่อมต่อสำหรับผู้ดูแลระบบ
          const isAdmin = localStorage.getItem('userRole') === 'admin' || window.location.search.includes('debug=1');
    
          if (isAdmin && typeof showToast === 'function') {
            // สำหรับ admin แสดงข้อความพร้อมปุ่มทดสอบ
            const adminMessage = `
              <div class="mb-3">❌ ${errorMessage}</div>
              <div class="mt-2 d-grid gap-2">
                <div class="d-flex gap-2">
                  <button onclick="runComprehensiveCardReaderDiagnostic()" class="btn btn-sm btn-primary flex-1">
                    🔬 Full Diagnostic
                  </button>
                  <button onclick="testCardReaderConnection()" class="btn btn-sm btn-warning">
                    🔍 Quick Test
                  </button>
                </div>
                <div class="d-flex gap-2">
                  <button onclick="debugCardReaderConfig()" class="btn btn-sm btn-info flex-1">
                    🔧 Config
                  </button>
                  <button onclick="showSystemHealthStatus()" class="btn btn-sm btn-success flex-1">
                    🏥 Health
                  </button>
                </div>
                <div class="d-flex gap-2">
                  <button onclick="showManualCustomerEntry()" class="btn btn-sm btn-secondary flex-1">
                    ✏️ Manual Entry
                  </button>
                  <button onclick="tryCardReaderAgain()" class="btn btn-sm btn-outline-warning flex-1">
                    🔄 Retry
                  </button>
                </div>
              </div>
            `;
    
            showToast(adminMessage, 'error', 'เครื่องอ่านบัตร (Admin Mode)', 15000);
          } else {
            // สำหรับ user ทั่วไป แสดงข้อความพร้อมปุ่ม Manual Entry และ Retry
            if (typeof showToast === 'function') {
              const userMessage = `
                <div class="mb-3">❌ ${errorMessage}</div>
                <div class="mt-2 d-flex gap-2">
                  <button onclick="showManualCustomerEntry()" class="btn btn-sm btn-primary flex-1">
                    ✏️ กรอกข้อมูลด้วยตนเอง
                  </button>
                  ${!isRetryError ? `
                    <button onclick="tryCardReaderAgain()" class="btn btn-sm btn-warning">
                      🔄 ลองใหม่
                    </button>
                  ` : ''}
                </div>
              `;
              showToast(userMessage, 'error', 'เครื่องอ่านบัตร', 15000);
            }
          }
        } finally {
          // คืนสถานะปกติของปุ่ม
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      });
      document.getElementById('btnSingleCheckout').addEventListener('click', singleCheckout);

      // 6) Vat & discount changes
      document.getElementById('vatRate').addEventListener('change', renderCart);
      document.getElementById('discount').addEventListener('change', renderCart);

      // 7) Customer type toggle
      const sel = document.getElementById('customerType');
      sel.addEventListener('change', () => {
        const personal = document.getElementById('personalFields');
        const corporate = document.getElementById('corporateFields');
        if (sel.value === 'individual') {
          personal.classList.remove('hidden');
          corporate.classList.add('hidden');
          corporate.querySelectorAll('input').forEach(i => i.value = '');
        } else {
          personal.classList.add('hidden');
          corporate.classList.remove('hidden');
          personal.querySelectorAll('input, select').forEach(f => f.value = '');
        }
        updateEmailStatus(); // อัพเดทสถานะอีเมล
      });

      // 7.1) Email checkbox และ field listeners
      const emailCheckbox = document.getElementById('sendEmailReceipt');
      const emailPersonal = document.getElementById('customerEmailPersonal');
      const emailCorporate = document.getElementById('corporateEmail');

      emailCheckbox.addEventListener('change', updateEmailStatus);
      emailPersonal.addEventListener('input', updateEmailStatus);
      emailCorporate.addEventListener('input', updateEmailStatus);
    
      // เรียกครั้งแรกเพื่อตั้งค่าเริ่มต้น
      updateEmailStatus();
      // ตรวจสอบสถานะระบบอีเมล
      updateEmailServiceIndicator();

      // 7.2) Birth date change listener - คำนวณอายุอัตโนมัติ
      const customerBirthDate = document.getElementById('customerBirthDate');
      if (customerBirthDate) {
        customerBirthDate.addEventListener('change', function() {
          calculateAgeFromBirthDate();
    
          // แสดงข้อความยืนยันเมื่อป้อนวันเกิดด้วยตนเอง
          if (this.value && typeof showToast === 'function') {
            showToast('✅ บันทึกวันเกิดแล้ว', 'success');
          }
        });
      }



      // 8) Load initial data and setup barcode listener
      await loadLevel1();
      setupLanguageIndependentBarcodeListener();

      // 🔍 Audit Log - Page Load Complete
        const pageLoadEnd = Date.now();
        logAuditEvent('PAGE_LOAD_COMPLETE', {
          url: window.location.href,
          branchCode: BRANCH_CODE,
          loadDuration: pageLoadEnd - pageLoadStart,
          stocksLoaded: approvedStocks.length,
          promotionsLoaded: activePromotions.length
        }, 'SUCCESS');

        // ตรวจสอบและแสดงข้อมูลพนักงาน
        setTimeout(() => {
          const currentStaffName = localStorage.getItem('userName') || staffName || 'พนักงาน';
          const userId = localStorage.getItem('userId') || 'unknown';
    
          console.log('👤 Final Staff Info Check:', {
            staffName: currentStaffName,
            userId: userId,
            globalStaffName: staffName,
            isDefaultName: currentStaffName === 'พนักงาน'
          });
    
          if (currentStaffName === 'พนักงาน' || currentStaffName === 'Guest') {
            console.warn('⚠️ Still using default staff name after page load');
            if (typeof showToast === 'function') {
              showToast('⚠️ ไม่พบชื่อพนักงาน กรุณาตรวจสอบการเข้าสู่ระบบ', 'warning');
            }
    
            // POS Notification
            if (posNotificationSystem) {
              posNotificationSystem.addNotification('pos', {
                title: 'คำเตือนข้อมูลพนักงาน',
                message: 'ไม่พบชื่อพนักงานจากการ login กรุณาตรวจสอบ',
                type: 'warning',
                icon: '⚠️',
                actions: [
                  {
                    label: 'ตรวจสอบข้อมูล',
                    action: 'primary',
                    callback: () => {
                      console.log('🔍 Manual staff info check');
                      loadEmployeeProfile();
                    }
                  }
                ]
              });
            }
          } else {
            console.log('✅ Staff name loaded successfully:', currentStaffName);
            if (posNotificationSystem) {
              posNotificationSystem.showToast('pos', {
                title: 'ข้อมูลพนักงาน',
                message: `พร้อมทำงานในนาม: ${currentStaffName}`,
                type: 'success',
                icon: '👤',
                duration: 3000
              });
            }
          }
        }, 2000); // รอ 2 วินาทีให้ระบบโหลดเสร็จ
    
      } catch (error) {
        console.error('Page initialization error:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดหน้า', 'error');
      } finally {
        // Hide loading overlay
        showLoading(false);
      }
    });

    // ✅ ฟังก์ชันสำหรับกรอกข้อมูลลูกค้าด้วยตนเอง (Manual Entry)
    window.showManualCustomerEntry = function() {
      // ซ่อน toast notifications
      if (typeof hideToast === 'function') {
        hideToast();
      }
    
      // แสดง modal หรือ form สำหรับกรอกข้อมูลลูกค้า
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'manualCustomerModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">✏️ กรอกข้อมูลลูกค้าด้วยตนเอง</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                เนื่องจากเครื่องอ่านบัตรไม่สามารถใช้งานได้ กรุณากรอกข้อมูลลูกค้าด้วยตนเอง
              </div>
              
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label>หมายเลขบัตรประชาชน <span class="text-danger">*</span></label>
                  <input type="text" id="manualIdCard" class="form-control" 
                         placeholder="กรอกหมายเลขบัตรประชาชน 13 หลัก" maxlength="13">
                </div>
                
                <div class="col-md-2 mb-3">
                  <label>คำนำหน้า</label>
                  <select id="manualTitle" class="form-control">
                    <option value="">เลือก</option>
                    <option value="นาย">นาย</option>
                    <option value="นาง">นาง</option>
                    <option value="นางสาว">นางสาว</option>
                  </select>
                </div>
                
                <div class="col-md-5 mb-3">
                  <label>ชื่อ <span class="text-danger">*</span></label>
                  <input type="text" id="manualFirstName" class="form-control" placeholder="ชื่อ">
                </div>
                
                <div class="col-md-5 mb-3">
                  <label>นามสกุล <span class="text-danger">*</span></label>
                  <input type="text" id="manualLastName" class="form-control" placeholder="นามสกุล">
                </div>
                
                <div class="col-md-12 mb-3">
                  <label>ที่อยู่</label>
                  <textarea id="manualAddress" class="form-control" rows="3" 
                            placeholder="ที่อยู่ปัจจุบัน"></textarea>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label>เบอร์โทรศัพท์</label>
                  <input type="tel" id="manualPhone" class="form-control" placeholder="หมายเลขโทรศัพท์">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label>อีเมล</label>
                  <input type="email" id="manualEmail" class="form-control" placeholder="อีเมล (ถ้ามี)">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
              <button type="button" class="btn btn-primary" onclick="saveManualCustomerData()">
                <i class="fas fa-save"></i> บันทึกข้อมูล
              </button>
            </div>
          </div>
        </div>
      `;
    
      // เพิ่ม modal เข้าหน้า
      document.body.appendChild(modal);
    
      // แสดง modal
      $('#manualCustomerModal').modal('show');
    
      // ลบ modal เมื่อปิด
      $('#manualCustomerModal').on('hidden.bs.modal', function() {
        $(this).remove();
      });
    
      // Focus ที่ field แรก
      setTimeout(() => {
        document.getElementById('manualIdCard').focus();
      }, 500);
    };

    // ✅ ฟังก์ชันบันทึกข้อมูลลูกค้าที่กรอกด้วยตนเอง
    window.saveManualCustomerData = function() {
      const idCard = document.getElementById('manualIdCard').value.trim();
      const title = document.getElementById('manualTitle').value;
      const firstName = document.getElementById('manualFirstName').value.trim();
      const lastName = document.getElementById('manualLastName').value.trim();
      const address = document.getElementById('manualAddress').value.trim();
      const phone = document.getElementById('manualPhone').value.trim();
      const email = document.getElementById('manualEmail').value.trim();
    
      // ตรวจสอบข้อมูลที่จำเป็น
      if (!idCard || !firstName || !lastName) {
        if (typeof showToast === 'function') {
          showToast('❌ กรุณากรอกข้อมูลที่จำเป็น (บัตรประชาชน, ชื่อ, นามสกุล)', 'error', 'ข้อมูลไม่ครบ');
        }
        return;
      }
    
      // ตรวจสอบรูปแบบเลขบัตรประชาชน
      if (!/^\d{13}$/.test(idCard)) {
        if (typeof showToast === 'function') {
          showToast('❌ หมายเลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก', 'error', 'ข้อมูลไม่ถูกต้อง');
        }
        return;
      }
    
      // สร้างข้อมูลลูกค้าในรูปแบบเดียวกับข้อมูลจากบัตร
      const customerData = {
        // รูปแบบเดียวกับ card reader
        idCard: idCard,
        titleTh: title,
        firstNameTh: firstName,
        lastNameTh: lastName,
        address: address,
        phone: phone,
        email: email,
        // เพิ่ม metadata
        source: 'manual_entry',
        timestamp: new Date().toISOString()
      };
    
      try {
        // เติมข้อมูลลูกค้าลงในฟอร์ม
        if (typeof window.fillCustomerDataFromCard === 'function') {
          window.fillCustomerDataFromCard(customerData);
    
          // แสดงข้อความสำเร็จ
          if (typeof showToast === 'function') {
            showToast(
              '✅ บันทึกข้อมูลลูกค้าสำเร็จ: ' + title + firstName + ' ' + lastName,
              'success',
              'ข้อมูลลูกค้า',
              5000
            );
          }
    
          // ปิด modal
          $('#manualCustomerModal').modal('hide');
    
        } else {
          console.error('❌ fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast('❌ ระบบไม่สามารถบันทึกข้อมูลได้ กรุณาติดต่อผู้ดูแลระบบ', 'error', 'ข้อผิดพลาด');
          }
        }
    
      } catch (error) {
        console.error('❌ Error saving manual customer data:', error);
        if (typeof showToast === 'function') {
          showToast('❌ เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error', 'ข้อผิดพลาด');
        }
      }
    };

    // ✅ Global debugging functions for console use
    window.testCardReaderConnection = async function(branchCode) {
      console.log('🔍 Running card reader connection test...');
    
      if (!window.CardReaderService || typeof window.CardReaderService.testConnection !== 'function') {
        console.error('❌ CardReaderService.testConnection not available');
        if (typeof showToast === 'function') {
          showToast('❌ ฟังก์ชันทดสอบไม่พร้อมใช้งาน', 'error', 'การทดสอบ');
        }
        return;
      }
    
      try {
        const result = await window.CardReaderService.testConnection({ branchCode });
    
        if (result.results && result.results.length > 0) {
          console.table(result.results);
        }
        console.log('📊 Summary: ' + result.summary);
    
        if (typeof showToast === 'function') {
          showToast(result.summary, result.success ? 'success' : 'error', 'การทดสอบการเชื่อมต่อ', 8000);
        }
    
        return result;
      } catch (error) {
        console.error('❌ Test connection failed:', error);
        if (typeof showToast === 'function') {
          showToast('❌ การทดสอบล้มเหลว: ' + error.message, 'error', 'การทดสอบ');
        }
      }
    };

    window.debugCardReaderConfig = function(branchCode) {
      const currentBranch = branchCode || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
      const config = window.CardReaderConfig?.getBranchConfig(currentBranch);
      const urls = window.CardReaderConfig?.getCardProxyUrls(currentBranch);
    
      console.log('🔧 Card Reader Configuration:', {
        branchCode: currentBranch,
        config: config,
        urls: urls,
        enabled: window.CardReaderConfig?.isCardReaderEnabled(currentBranch)
      });
    
      if (typeof showToast === 'function') {
        const summary = 'สาขา: ' + currentBranch + ', Endpoints: ' + (urls?.all?.length || 0) + ', สถานะ: ' + (config?.enabled ? 'เปิด' : 'ปิด');
        showToast('🔧 ดูข้อมูลใน Console: ' + summary, 'info', 'Card Reader Config', 5000);
      }
    
      return { branchCode: currentBranch, config, urls };
    };



    // ฟังก์ชันตัดคำว่า "หมู่ที่", "หมู่", "ตำบล", "อำเภอ", "จังหวัด" ออก (ถ้ามี)
    function removeLocalityPrefix(str) {
      if (!str) return '';
      let result = str.trim();
      result = result.replace(/^หมู่ที่\s*/i, '').replace(/^หมู่\s*/i, '');
      result = result.replace(/^ตำบล\s*/i, '');
      result = result.replace(/^อำเภอ\s*/i, '');
      result = result.replace(/^จังหวัด\s*/i, '');
      return result.trim();
    }

    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const mc = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');

      // สลับเลื่อน sidebar
      sb.classList.toggle('-translate-x-full');
      sb.classList.toggle('translate-x-0');

      // สลับ margin ของ mainContent
      mc.classList.toggle('ml-0');
      mc.classList.toggle('ml-64');

      // สลับ icon
      icon.classList.toggle('bi-chevron-left');
      icon.classList.toggle('bi-chevron-right');
    }

    function showToast(message, type = 'info') {
      // เดิม: แสดงข้อความใน Console เท่านั้น
      // console.log(`[Toast: ${type}] ${message}`);

      // ใหม่: สร้างและแสดง Toast UI จริงๆ (ตัวอย่างโดยใช้ div ง่ายๆ)
      const toastContainer = document.body; // หรือหา container ที่เหมาะสม
      const toast = document.createElement('div');
      let bgColor = 'bg-blue-500'; // default info
      if (type === 'success') bgColor = 'bg-green-500';
      if (type === 'warning') bgColor = 'bg-yellow-500';
      if (type === 'danger') bgColor = 'bg-red-500';

      toast.className = `fixed bottom-5 right-5 ${bgColor} text-white p-3 rounded-lg shadow-lg transition-opacity duration-300 z-[100]`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      // ทำให้ Toast หายไปหลังจาก 3 วินาที
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toast.remove();
        }, 300); // รอ transition จบก่อนลบ
      }, 3000);
    }

    // ฟังก์ชัน format ราคา
    function formatPrice(num) {
      if (typeof num !== 'number') {
        num = parseFloat(num) || 0;
      }
      return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // ปรับปรุงฟังก์ชัน sanitizeImagePath ให้จัดการ image path ได้ดีขึ้น
    function sanitizeImagePath(originalPath) {
      if (!originalPath) return '';

      // ถ้าเป็น full URL หรือ data URL ให้ใช้ตรงๆ
      if (originalPath.startsWith('http') || originalPath.startsWith('data:')) {
        return originalPath;
      }

      // ถ้าขึ้นต้นด้วย /uploads/ แล้ว ให้ใช้ตรงๆ
      if (originalPath.startsWith('/uploads/')) {
        return originalPath;
      }

      // ถ้าขึ้นต้นด้วย uploads/ ให้เพิ่ม / ข้างหน้า
      if (originalPath.startsWith('uploads/')) {
        return '/' + originalPath;
      }

      // ตัด path เต็มออกเหลือเฉพาะส่วนหลัง uploads
      let sanitized = originalPath.replace(/^.*uploads[\\/]/, '');
      sanitized = sanitized.replace(/\\/g, '/');

      // เพิ่ม /uploads/ ข้างหน้า
      return `/uploads/${sanitized}`;
    }

    // ฟังก์ชันช่วยในการสร้าง image URL ที่ถูกต้อง
    function getImageUrl(imagePath) {
      if (!imagePath) {
        console.log('🖼️ Image path is empty, using placeholder');
        return 'https://via.placeholder.com/150?text=No+Image';
      }

      // ถ้าเป็น full URL แล้ว ให้ใช้ตรงๆ
      if (imagePath.startsWith('http') || imagePath.startsWith('data:')) {
        console.log('🖼️ Using full URL:', imagePath);
        return imagePath;
      }

      // ใช้ sanitizeImagePath เพื่อจัดการ path
      const sanitizedPath = sanitizeImagePath(imagePath);
      console.log('🖼️ Original path:', imagePath, '→ Sanitized path:', sanitizedPath);
      return sanitizedPath;
    }

    // trim ธรรมดา
    function removePrefixes(str) {
      if (!str) return '';
      return str.trim();
    }

    // โหลดโปรไฟล์พนักงาน
    async function loadEmployeeProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          console.warn('⚠️ No auth token found for employee profile');
          return;
        }

        console.log('👤 Loading employee profile...');
        const js = await safeFetch('/api/users/me', {
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          timeout: 10000,
          maxRetries: 2
        });
        if (!js.success) throw new Error(js.error || js.message || 'API request failed');
        const u = js.data;

        // --- 1) แก้ไขส่วนนี้ให้เซฟ userId กับ userName ลง localStorage ---
        if (u._id) {
          localStorage.setItem('userId', u._id);
          console.log('✅ User ID saved:', u._id);
        }
        if (u.name) {
          localStorage.setItem('userName', u.name);
          // อัปเดตตัวแปร global staffName ด้วย
          staffName = u.name;
          console.log('✅ Staff name updated:', u.name);
    
          // อัพเดทชื่อพนักงานใน notification system
          if (posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: 'ข้อมูลพนักงาน',
              message: `เข้าสู่ระบบในนาม: ${u.name}`,
              type: 'info',
              icon: '👤',
              metadata: {
                staffId: u._id,
                staffName: u.name,
                role: u.role?.name || u.position || 'พนักงาน'
              }
            });
          }
        }
        // ---------------------------------------------------------------

        // อัพเดทข้อมูลใน UI elements (ถ้ามี)
        const employeeNameEl = document.getElementById('employeeName');
        if (employeeNameEl) {
          employeeNameEl.textContent = u.name || '(ไม่พบชื่อ)';
        }

        // แสดงตำแหน่งงานแทนคำว่า "พนักงาน"
        const roleElement = document.getElementById('employeeRole');
        if (roleElement) {
          const roleName = u.role?.name || u.position || 'พนักงาน';
          roleElement.textContent = roleName;
        }

        // อัพเดท employee photo (ถ้ามี element)
        const employeePhotoEl = document.getElementById('employeePhoto');
        if (employeePhotoEl) {
          let img = u.imageUrl || u.photoUrl || u.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }
          employeePhotoEl.src = img || 'https://via.placeholder.com/150x150/e5e7eb/9ca3af?text=Avatar';
        }

        // แสดงข้อมูลพนักงานใน console
        console.log('👤 Employee Profile Loaded:', {
          id: u._id,
          name: u.name,
          role: u.role?.name || u.position || 'พนักงาน',
          email: u.email
        });

        // แสดงข้อความต้อนรับ
        if (typeof showToast === 'function') {
          showToast(`ยินดีต้อนรับ ${u.name}`, 'success');
        }

      } catch (err) {
        console.error('❌ Load Employee Profile Error:', err);
    
        // ตั้งค่า fallback staff name
        const fallbackName = localStorage.getItem('userName') || localStorage.getItem('staffName') || 'พนักงาน';
        staffName = fallbackName;
        console.log('⚠️ Using fallback staff name:', fallbackName);
    
        if (typeof showToast === 'function') {
          showToast('ไม่สามารถโหลดข้อมูลพนักงานได้', 'warning');
        }
      }
    }




    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // ใช้ debounce กับ loadLevel1
    const debouncedLoadLevel1 = debounce(loadLevel1, 1000);

    // เก็บหมวด Level 1 สำหรับใช้ตอนค้นหา
    let isLoadingLevel1 = false; // ตัวแปรสถานะ

    // -----------------------------
    // 2) ค้นหาสินค้า / IMEI (cash)
    // -----------------------------
    async function searchItems() {
      // ประกาศ loaderId ไว้ข้างนอก try block
      let loaderId = null;
    
      try {
        // Show loading
        showLoading(true);
    
        const raw = document.getElementById('searchQuery').value.trim();
        const isImei = /^\d+$/.test(raw);
        const token = localStorage.getItem('authToken') || '';
        const grid = document.getElementById('imeiResultGrid');
        const container = document.getElementById('imeiResultContainer');

        // ซ่อนหน้า Level1/2/3 แล้วโชว์ผลลัพธ์ Search
        ['level1Container', 'level2Container', 'level3Container']
          .forEach(id => document.getElementById(id).classList.add('hidden'));
        container.classList.remove('hidden');
        SecurityHelpers.safeSetContent(grid, '', '');

        let url = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}&verified=true&purchaseType=cash`;
        if (isImei) url += `&imei=${encodeURIComponent(raw)}`;

        const js = await safeFetch(url, {
          headers: { Authorization: `Bearer ${token}` },
          timeout: 10000,
          maxRetries: 2
        });
        let items = (js.success) ? js.data : [];

        // API taxType พร้อม purchaseType=cash แล้ว เหลือแค่เช็ค stock_value >0
        items = items.filter(it => it.stock_value > 0);

        // ถ้าเป็นชื่อ (ไม่ใช่ IMEI) ให้กรองเพิ่มด้วยคำค้น
        if (!isImei && raw) {
          const q = raw.toLowerCase();
          items = items.filter(st => st.name.toLowerCase().includes(q));
        }

        if (items.length === 0) {
          const noItemsText = `ไม่พบสินค้า${isImei ? ' (IMEI นี้)' : ''}`;
          SecurityHelpers.safeSetContent(grid, 'text-gray-500 col-span-full', noItemsText);
          return;
        }
        // เมื่อค้นหา IMEI เฉพาะ ให้แสดงแยกแต่ละ IMEI
        // เมื่อค้นหาด้วยชื่อ ให้จัดกลุ่มเหมือน Level3
        if (isImei) {
          // แสดงแยกแต่ละ IMEI เมื่อค้นหาเฉพาะ
          items.forEach(it => {
            const stockType = it.product_id?.stockType || it.stockType || 'imei';
            const stockTypeBadge = stockType === 'imei'
              ? '<span class="badge badge-info badge-sm">IMEI</span>'
              : '<span class="badge badge-success badge-sm">จำนวน</span>';
            const imeiDisplay = stockType === 'imei'
              ? `<p class="text-xs text-gray-600 mb-1">IMEI: ${it.imei || '-'}</p>`
              : '';

            const col = document.createElement('div');
            col.className = 'card p-4 flex flex-col';
            col.innerHTML = `
          <img src="${getImageUrl(it.image)}"
               class="product-img mb-2 rounded-md" alt="${it.name}" />
          <div class="flex items-center gap-2 mb-1">
            <h6 class="font-medium text-sm">${it.name}</h6>
            ${stockTypeBadge}
          </div>
          ${imeiDisplay}
          <p class="product-price-big mb-2">฿${formatPrice(it.price)}</p>
          <!-- ปุ่มหยิบใส่ตะกร้าถูกลบออก -->
        `;
            // col.querySelector("button")... (ลบ event listener ด้วย)
            grid.appendChild(col);
          });
        } else {
          // แสดงแบบจัดกลุ่มเมื่อค้นหาด้วยชื่อ
          const groupedSearchItems = items.reduce((groups, it) => {
            const stockType = it.product_id?.stockType || it.stockType || 'imei';
            const key = `${it.name}_${stockType}`;

            if (!groups[key]) {
              groups[key] = {
                name: it.name,
                stockType: stockType,
                items: [],
                image: it.image,
                price: it.price,
                taxType: it.taxType,
                model: it.model,
                poNumber: it.poNumber,
                supplier: it.supplier
              };
            }
            groups[key].items.push(it);
            return groups;
          }, {});

          Object.values(groupedSearchItems).forEach(group => {
            const stockTypeBadge = group.stockType === 'imei'
              ? '<span class="badge badge-info badge-sm">IMEI</span>'
              : '<span class="badge badge-success badge-sm">จำนวน</span>';

            let quantityBadge = '';
            let imeiDisplay = '';

            if (group.stockType === 'imei') {
              const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));

              if (availableDevices.length === 0) {
                quantityBadge = `<span class="badge emergency-badge badge-sm">🚨 หมดสต๊อก! 0 เครื่อง</span>`;
              } else if (availableDevices.length >= 1 && availableDevices.length <= 3) {
                quantityBadge = `<span class="badge warning-badge badge-sm">⚠️ เหลือน้อย! ${availableDevices.length} เครื่อง</span>`;
              } else {
                quantityBadge = `<span class="badge badge-primary badge-sm">เหลือ ${availableDevices.length} เครื่อง</span>`;
              }

              const availableDevice = availableDevices[0];
              if (availableDevice && availableDevice.imei) {
                imeiDisplay = `<div class="text-xs text-gray-600 mb-1">IMEI: ${availableDevice.imei}</div>`;
              } else {
                imeiDisplay = `<div class="text-xs emergency-text mb-1">🚨 ไม่มีเครื่องเหลือ!</div>`;
              }
            } else {
              quantityBadge = `<span class="badge badge-primary badge-sm">เหลือ ${group.items.length} ชิ้น</span>`;
            }

            const itemToAdd = group.stockType === 'imei'
              ? group.items.find(item => !hiddenProductIds.has(item._id)) || group.items[0]
              : group.items[0];

            // ตรวจสอบสถานะ stock ใน search results
            let isSearchOutOfStock = false;
            let isSearchLowStock = false;
            let searchCardClass = 'card p-4 flex flex-col';
            let searchStatusIcon = '';

            if (group.stockType === 'imei') {
              const searchAvailableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));
              isSearchOutOfStock = searchAvailableDevices.length === 0;
              isSearchLowStock = !isSearchOutOfStock && searchAvailableDevices.length >= 1 && searchAvailableDevices.length <= 3;
            } else {
              // สำหรับ Quantity: คำนวณจากสต๊อกจริง
              const totalOriginalStock = group.items.reduce((sum, item) => {
                return sum + (item.originalStockValue || item.stock_value);
              }, 0);
              const cartQty = cartItems
                .filter(item => {
                  return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
                })
                .reduce((sum, item) => sum + item.qty, 0);
              const searchAvailableQty = Math.max(0, totalOriginalStock - cartQty);
              isSearchOutOfStock = searchAvailableQty === 0;
              isSearchLowStock = !isSearchOutOfStock && searchAvailableQty >= 1 && searchAvailableQty <= 3;
            }

            // เพิ่ม CSS classes และ icons
            if (isSearchOutOfStock) {
              searchCardClass += ' out-of-stock-emergency';
              searchStatusIcon = '<span class="status-icon emergency-icon">🚨</span>';
            } else if (isSearchLowStock) {
              searchCardClass += ' low-stock-warning';
              searchStatusIcon = '<span class="status-icon warning-icon">⚠️</span>';
            }

            const col = document.createElement('div');
            col.className = searchCardClass;
            col.innerHTML = `
          ${searchStatusIcon}
          <img src="${getImageUrl(group.image)}"
               class="product-img mb-2 rounded-md" alt="${group.name}" />
          <div class="flex flex-wrap items-center gap-1 mb-1">
            <h6 class="font-medium text-sm ${isSearchOutOfStock ? 'emergency-text' : isSearchLowStock ? 'warning-text' : ''}">${group.name}</h6>
            ${stockTypeBadge}
            ${quantityBadge}
          </div>
          ${imeiDisplay}
          <p class="product-price-big mb-2">฿${formatPrice(group.price)}</p>
          ${group.stockType !== 'imei' && !isSearchOutOfStock ? `
            <button class="btn btn-primary btn-sm w-full mt-2" onclick="addProductToCart('${itemToAdd._id}', '${group.name}', ${group.price}, '', '${itemToAdd.taxType || ''}', '${itemToAdd.model || ''}', '${itemToAdd.poNumber || ''}', '${itemToAdd.supplier || ''}')">
              <i class="bi bi-cart-plus mr-1"></i>เพิ่มลงตะกร้า
            </button>
          ` : ''}
        `;

            // ไม่ต้องเพิ่ม event listener ปุ่มอีก
            grid.appendChild(col);
          });
        }

      } catch (err) {
        console.error('searchItems failed:', err);
        const grid = document.getElementById('imeiResultGrid');

        // Safely create error message to prevent XSS
        grid.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-500 col-span-full';
        errorDiv.textContent = `Error: ${err.message || 'เกิดข้อผิดพลาดในการค้นหา'}`;
        grid.appendChild(errorDiv);
      } finally {
        // Hide loading
        showLoading(false);
      }
    }

    // เก็บข้อมูล Level2 ไว้ใช้ตอนแสดง Level3
    let level2Groups = {};
    let currentLevel3Items = [];
    const hiddenProductIds = new Set();



    // -----------------------------
    // Level 1 – แบรนด์
    // -----------------------------
    // แทนที่ renderLevel1 เดิมด้วยฟังก์ชันนี้ (ปรับเป็นหมวดหมู่แทนแบรนด์)
    function renderLevel1(categories) {
      const grid = document.getElementById('level1Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      // ตรวจสอบว่ามีสินค้าหรือไม่
      if (categories.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 dark:text-gray-500">
              <i class="bi bi-box-seam text-6xl mb-4"></i>
              <h3 class="text-xl font-semibold mb-2">ไม่มีสินค้าในสต๊อก</h3>
              <p class="text-sm">ไม่พบสินค้าที่สามารถขายได้ในสาขานี้</p>
              <button onclick="loadLevel1()" class="btn btn-primary mt-4">
                <i class="bi bi-arrow-clockwise mr-2"></i>โหลดข้อมูลใหม่
              </button>
            </div>
          </div>
        `;
        return;
      }

      categories.forEach(category => {
        // คำนวณ stock ที่มีอยู่จริงในหมวดหมู่นี้
        const categoryItems = approvedStocks.filter(item => {
          // ใช้ฟังก์ชัน determineCategory เพื่อจัดหมวดหมู่ (ส่ง categoryGroup ไปด้วย)
          const itemCategory = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
          return itemCategory === category;
        });

        const totalItems = categoryItems.length;
        const availableItems = categoryItems.filter(item => {
          const stockValue = item.originalStockValue || item.stock_value || 0;
          return stockValue > 0;
        }).length;
    
        const totalStock = categoryItems.reduce((sum, item) => {
          return sum + (item.originalStockValue || item.stock_value || 0);
        }, 0);

        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 20; // เกณฑ์สำหรับหมวดหมู่

        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">🚨</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">⚠️</div>';
        }

        // ตรวจสอบโปรโมชั่น (ใช้ฟังก์ชันเดิม)
        const hasPromo = categoryItems.some(item => checkBrandHasPromotion(extractBrand(item.name)));

        const categoryCard = document.createElement('div');
        categoryCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';

        // Add stock alert classes
        if (isOutOfStock) {
          categoryCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          categoryCard.className += ' low-stock-warning';
        }

        if (hasPromo) {
          categoryCard.className += ' has-promotion';
          categoryCard.style.overflow = 'visible';
        }

        // สร้าง Fire Icon สำหรับโปรโมชั่น
        const fireIcon = hasPromo ? '<div class="promo-fire-icon">🔥</div>' : '';

        categoryCard.innerHTML = `
          <div class="card-body p-4">
            ${fireIcon}
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${category}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${totalItems} รายการ</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">🚨 สินค้าหมดทั้งหมด</span>' : isLowStock ? '<span class="text-xs warning-text">⚠️ สต๊อกในหมวดต่ำ</span>' : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getCategoryIcon(category)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-primary">${totalItems} สินค้า</div>
              ${isOutOfStock ? '<div class="badge badge-error ml-2">หมดสต๊อก</div>' : ''}
              ${hasPromo ? '<div class="badge badge-warning ml-2">🔥 มีโปรโมชั่น</div>' : ''}
            </div>
          </div>
        `;

        // ปิดการคลิกถ้าไม่มีสินค้า
        if (availableItems > 0) {
          categoryCard.addEventListener('click', () => loadLevel2(category, category));
        } else {
          categoryCard.classList.add('cursor-not-allowed', 'opacity-50');
          categoryCard.addEventListener('click', () => {
            showToast('ไม่มีสินค้าในหมวดนี้', 'warning');
          });
        }

        grid.appendChild(categoryCard);
      });
    }

    // Create alias function for backward compatibility
    async function loadStockAndCategories() {
      return await loadLevel1();
    }

    async function loadLevel1() {
      // แสดง/ซ่อน
      document.getElementById('level1Container').classList.remove('hidden');
      ['level2Container', 'level3Container', 'imeiResultContainer']
        .forEach(id => document.getElementById(id).classList.add('hidden'));

      // นับสต๊อกตามหมวดหมู่สินค้า (เหมือน step1.html)
      const categoryCounts = {};

      approvedStocks.forEach(item => {
        const category = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
        const stockType = item.product_id?.stockType || item.stockType || 'imei';

        if (!categoryCounts[category]) {
          categoryCounts[category] = 0;
        }

        if (stockType === 'imei') {
          // สำหรับ IMEI: นับทีละ 1 ถ้ายังไม่ได้ใส่ตะกร้า
          if (!hiddenProductIds.has(item._id)) {
            categoryCounts[category]++;
          }
        } else {
          // สำหรับ Quantity: ใช้ stock_value
          if (item.stock_value > 0) {
            categoryCounts[category] += item.stock_value;
          }
        }
      });

      // รวมหมวดหมู่ที่มีสินค้าแต่หมดสต๊อกด้วย
      const allCategories = approvedStocks.reduce((acc, item) => {
        const category = determineCategory(item.name, item.product_id?.productType || item.productType, item.categoryGroup);
        if (!acc.has(category)) {
          acc.add(category);
        }
        return acc;
      }, new Set());

      // เพิ่มหมวดหมู่ที่หมดสต๊อกเข้าไปด้วย
      allCategories.forEach(category => {
        if (!categoryCounts[category]) {
          categoryCounts[category] = 0;
        }
      });

      // สร้าง array ของหมวดหมู่
      const categories = Array.from(allCategories).sort();
      renderLevel1(categories);
    }



    // -----------------------------
    // Level 2 – กลุ่มสินค้าตามสองคำแรก
    // -----------------------------
    // แทนที่ renderLevel2 เดิมด้วยฟังก์ชันนี้
    function renderLevel2(productNames) {
      const grid = document.getElementById('level2Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      productNames.forEach(productName => {
        const productItems = level2Groups[productName];
    
        // Calculate total stock for this product name
        const totalStock = productItems.reduce((sum, item) => {
          return sum + (item.originalStockValue || item.stock_value || 0);
        }, 0);
        const availableItems = productItems.filter(item => {
          const stockValue = item.originalStockValue || item.stock_value || 0;
          return stockValue > 0;
        }).length;
    
        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 5;
    
        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">🚨</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">⚠️</div>';
        }

        // ตรวจสอบโปรโมชั่น
        const hasPromo = productItems.some(item => checkBrandHasPromotion(extractBrand(item.name)));
    
        const productCard = document.createElement('div');
        productCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';
    
        // Add stock alert classes
        if (isOutOfStock) {
          productCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          productCard.className += ' low-stock-warning';
        }

        if (hasPromo) {
          productCard.className += ' has-promotion';
          productCard.style.overflow = 'visible';
        }

        // สร้าง Fire Icon สำหรับโปรโมชั่น
        const fireIcon = hasPromo ? '<div class="promo-fire-icon">🔥</div>' : '';
    
        productCard.innerHTML = `
          <div class="card-body p-4">
            ${fireIcon}
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${productName}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${productItems.length} รายการ พร้อมขาย</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">🚨 สินค้าหมด</span>' : isLowStock ? '<span class="text-xs warning-text">⚠️ สินค้าใกล้หมด</span>' : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getProductIcon(productName)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-secondary">${productItems.length} สินค้า</div>
              <div class="badge ${isOutOfStock ? 'emergency-badge' : isLowStock ? 'warning-badge' : 'badge-success'} ml-2">คงเหลือ ${totalStock}</div>
              ${hasPromo ? '<div class="badge badge-warning ml-2">🔥 มีโปรโมชั่น</div>' : ''}
            </div>
          </div>
        `;
    
        // ปิดการคลิกถ้าไม่มีสินค้า
        if (availableItems > 0) {
          productCard.addEventListener('click', () => showLevel3Group(productName));
        } else {
          productCard.classList.add('cursor-not-allowed', 'opacity-50');
          productCard.addEventListener('click', () => {
            showToast('ไม่มีสินค้าในกลุ่มนี้', 'warning');
          });
        }
    
        grid.appendChild(productCard);
      });
    }

    function loadLevel2(category, parentLabel) {
      // ซ่อน/แสดง
      document.getElementById('level1Container').classList.add('hidden');
      ['level3Container', 'imeiResultContainer'].forEach(id =>
        document.getElementById(id).classList.add('hidden'));
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `รายการของ ${parentLabel}`;

      // กรอง stocks ตามหมวดหมู่
      const filtered = approvedStocks.filter(p => {
        const itemCategory = determineCategory(p.name, p.product_id?.productType || p.productType, p.categoryGroup);
        return itemCategory === category;
      });
    
      // จัดกลุ่มตามชื่อสินค้า (เหมือน step1.html)
      level2Groups = filtered.reduce((groups, p) => {
        const productName = extractProductName(p.name);
        (groups[productName] ||= []).push(p);
        return groups;
      }, {});

      // เก็บไว้ใน window เพื่อใช้ในการรีเฟรช UI
      window.level2Groups = level2Groups;

      if (!Object.keys(level2Groups).length) {
        showToast('ไม่พบสินค้าในหมวดนี้', 'warning');
        return goBackToLevel1();
      }
      renderLevel2(Object.keys(level2Groups));
    }

    // -----------------------------
    // Level 3 – รายละเอียดสินค้า
    // -----------------------------
    // แทนที่ renderLevel3 เดิมด้วยฟังก์ชันนี้
    function renderLevel3(items) {
      const grid = document.getElementById('level3Grid');
      SecurityHelpers.safeSetContent(grid, '', '');

      // กรองสินค้าที่จะแสดง:
      // - สำหรับ quantity: ต้องมี stock_value > 0
      // - สำหรับ IMEI: แสดงทุกกลุ่มที่มีสินค้าอยู่ (แม้จะถูกใส่ตะกร้าหมดแล้ว)
      const visible = items.filter(it => {
        const stockType = it.product_id?.stockType || it.stockType || 'imei';

        if (stockType === 'imei') {
          // IMEI: แสดงทุกตัวที่มีอยู่ (ไม่กรอง stock_value)
          return true;
        } else {
          // Quantity: ต้องมี stock_value > 0 และไม่ถูก hide
          return it.stock_value > 0 && !hiddenProductIds.has(it._id);
        }
      });

      if (!visible.length) {
        grid.innerHTML = `
      <div class="col-span-full text-center text-gray-500 py-8">
        <i class="bi bi-cart-check text-4xl mb-2 block"></i>
        <p>ไม่มีสินค้าที่สามารถเพิ่มได้</p>
        <p class="text-sm mt-1">สินค้าทั้งหมดถูกเพิ่มในตะกร้าแล้ว</p>
      </div>`;
        return;
      }

      // จัดกลุ่มสินค้า: IMEI และ Quantity ต่างก็รวมกันตามชื่อ
      const groupedItems = visible.reduce((groups, it) => {
        const stockType = it.product_id?.stockType || it.stockType || 'imei';

        // รวมสินค้าตามชื่อ + stockType ทั้ง IMEI และ Quantity
        const key = `${it.name}_${stockType}`;

        if (!groups[key]) {
          groups[key] = {
            name: it.name,
            stockType: stockType,
            items: [],
            image: it.image,
            price: it.price,
            taxType: it.taxType,
            model: it.model,
            poNumber: it.poNumber,
            supplier: it.supplier
          };
        }
        groups[key].items.push(it);
        return groups;
      }, {});

      Object.values(groupedItems).forEach(group => {
        // แก้ไขส่วนนี้ - เพิ่มการเช็คด้วยชื่อสินค้า
        const hasPromo = activePromotions.some(p => {
          // 1. ถ้าไม่ระบุสินค้า = ใช้ได้กับทุกสินค้า
          const allProducts = !p.applicableProducts || p.applicableProducts.length === 0;
          if (allProducts) return true;

          // 2. เช็คด้วยชื่อสินค้า (เหมือนกับ checkPromotionForProduct)
          let matchByName = false;
          if (group.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
            matchByName = p.applicableProducts.some(prod => {
              const stockName = group.name.trim().toLowerCase();
              const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
              return stockName === promoProductName;
            });
          }

          // 3. เช็คด้วย Product ID (fallback)
          const matchById = p.applicableProducts &&
            p.applicableProducts.some(prod =>
              group.items.some(item => (typeof prod === 'string' ? prod : prod._id) === item._id)
            );

          // 4. เช็คด้วย Category
          const inCategory = p.applicableCategories &&
            p.applicableCategories.includes(group.items[0].productType);

          return matchByName || matchById || inCategory;
        });

        const col = document.createElement('div');

        // ตรวจสอบสถานะ stock
        let isOutOfStock = false;
        let isLowStock = false;
        let cardClass = 'card p-4 flex flex-col relative';

        if (group.stockType === 'imei') {
          const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));
          isOutOfStock = availableDevices.length === 0;
          isLowStock = !isOutOfStock && availableDevices.length >= 1 && availableDevices.length <= 3;
        } else {
          const totalOriginalStock = group.items.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);
          const cartQty = cartItems
            .filter(item => {
              return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);
          const availableQty = totalOriginalStock - cartQty;
          isOutOfStock = availableQty === 0;
          isLowStock = !isOutOfStock && availableQty >= 1 && availableQty <= 3;
        }

        // เพิ่ม CSS classes ตามสถานะ stock
        if (isOutOfStock) {
          cardClass += ' out-of-stock-emergency';
        } else if (isLowStock) {
          cardClass += ' low-stock-warning';
        }

        col.className = cardClass;

        if (hasPromo) {
          col.style.overflow = 'visible';
        }

        // ใช้ Fire Icon และ Status Icon
        const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<span class="status-icon emergency-icon">🚨</span>';
        } else if (isLowStock) {
          statusIcon = '<span class="status-icon warning-icon">⚠️</span>';
        }

        // สร้าง stock type badge และ quantity/count badge
        const stockTypeBadge = group.stockType === 'imei'
          ? '<span class="badge badge-info badge-sm">IMEI</span>'
          : '<span class="badge badge-success badge-sm">จำนวน</span>';

        // สำหรับ IMEI แสดงจำนวนเครื่องที่เหลือ, สำหรับ Quantity แสดงจำนวนชิ้นที่เหลือ
        let quantityBadge = '';
        if (group.stockType === 'imei') {
          // นับจำนวนเครื่องที่ยังไม่ได้ใส่ตะกร้า
          const availableDevices = group.items.filter(item => !hiddenProductIds.has(item._id));

          // Debug logging for IMEI
          console.log(`🔍 IMEI calculation for ${group.name}:`, {
            totalDevices: group.items.length,
            hiddenDevices: group.items.filter(item => hiddenProductIds.has(item._id)).length,
            availableDevices: availableDevices.length,
            hiddenProductIds: Array.from(hiddenProductIds)
          });

          if (availableDevices.length === 0) {
            quantityBadge = `<span class="badge emergency-badge badge-sm">🚨 หมดสต๊อก! 0 เครื่อง</span>`;
          } else if (availableDevices.length >= 1 && availableDevices.length <= 3) {
            quantityBadge = `<span class="badge warning-badge badge-sm">⚠️ เหลือน้อย! ${availableDevices.length} เครื่อง</span>`;
          } else {
            quantityBadge = `<span class="badge badge-primary badge-sm">เหลือ ${availableDevices.length} เครื่อง</span>`;
          }
        } else {
          // รวมจำนวนสต๊อกทั้งหมดในกลุ่ม (สำหรับสินค้าชื่อเดียวกัน)
          const totalOriginalStock = group.items.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // คำนวณจำนวนที่อยู่ในตะกร้าทั้งหมดสำหรับสินค้าชื่อนี้
          const cartQty = cartItems
            .filter(item => {
              // ใช้ชื่อสินค้าในการหาแทนที่จะใช้ id เดียว
              return group.items.some(groupItem => groupItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          const availableQty = totalOriginalStock - cartQty;

          // Debug logging
          console.log(`🔍 Quantity calculation for ${group.name}:`, {
            groupItems: group.items.length,
            totalOriginalStock,
            cartQty,
            availableQty
          });

          const finalQty = Math.max(0, availableQty);

          if (finalQty === 0) {
            quantityBadge = `<span class="badge emergency-badge badge-sm">🚨 หมดสต๊อก! 0 ชิ้น</span>`;
          } else if (finalQty >= 1 && finalQty <= 3) {
            quantityBadge = `<span class="badge warning-badge badge-sm">⚠️ เหลือน้อย! ${finalQty} ชิ้น</span>`;
          } else {
            quantityBadge = `<span class="badge badge-primary badge-sm">เหลือ ${finalQty} ชิ้น</span>`;
          }
        }

        // สำหรับสินค้า IMEI แสดง IMEI ตัวแรกที่ยังไม่ได้ใส่ตะกร้า
        let imeiDisplay = '';
        if (group.stockType === 'imei') {
          const availableDevice = group.items.find(item => !hiddenProductIds.has(item._id));
          if (availableDevice && availableDevice.imei) {
            imeiDisplay = `<div class="text-xs text-gray-600 mb-1">IMEI: ${availableDevice.imei}</div>`;
          } else {
            // ถ้าไม่มีเครื่องเหลือแล้ว แสดงข้อความแจ้งแบบฉุกเฉิน
            imeiDisplay = `<div class="text-xs emergency-text mb-1">🚨 ไม่มีเครื่องเหลือ!</div>`;
          }
        }

        // ตรวจสอบสถานะสต๊อกและกำหนด styling
        let productOutOfStock = isOutOfStock;
        let productLowStock = isLowStock;

        // ตรวจสอบว่าเป็น Boxset หรือไม่ และสร้าง HTML สำหรับแสดงรายการสินค้าใน Boxset
        const isBoxset = group.items[0] && group.items[0].productType === 'boxset';
        let boxsetProductsDisplay = '';
    
        if (isBoxset) {
          const boxsetItem = group.items[0];
    
          // Debug: แสดงโครงสร้างข้อมูล boxset item
          console.log('🎁 Boxset item structure:', {
            _id: boxsetItem._id,
            name: boxsetItem.name,
            selectedProducts: boxsetItem.selectedProducts,
            products: boxsetItem.products,
            productList: boxsetItem.productList,
            items: boxsetItem.items,
            allKeys: Object.keys(boxsetItem)
          });
    
          // ลองหา field ที่เก็บรายการสินค้าจากหลาย field ที่เป็นไปได้
          let boxsetProducts = [];
          let sourceField = 'none';
    
          if (boxsetItem.selectedProducts && Array.isArray(boxsetItem.selectedProducts)) {
            boxsetProducts = boxsetItem.selectedProducts;
            sourceField = 'selectedProducts';
          } else if (boxsetItem.products && Array.isArray(boxsetItem.products)) {
            boxsetProducts = boxsetItem.products;
            sourceField = 'products';
          } else if (boxsetItem.productList && Array.isArray(boxsetItem.productList)) {
            boxsetProducts = boxsetItem.productList;
            sourceField = 'productList';
          } else if (boxsetItem.items && Array.isArray(boxsetItem.items)) {
            boxsetProducts = boxsetItem.items;
            sourceField = 'items';
          }
    
          console.log(`🎁 Found boxset products from "${sourceField}":`, boxsetProducts);
          console.log(`📊 Boxset products count: ${boxsetProducts.length}`);
    
          if (boxsetProducts.length > 0) {
            console.log(`✅ Rendering ${boxsetProducts.length} products for boxset "${boxsetItem.name}"`);
            boxsetProductsDisplay = `
              <div class="boxset-products mt-2 mb-2 p-2 bg-blue-50 rounded-md border border-blue-200">
                <div class="flex items-center gap-1 mb-2">
                  <span class="text-xs font-semibold text-blue-700">🎁 สินค้าใน Boxset:</span>
                  <span class="badge badge-info badge-xs">${boxsetProducts.length} รายการ</span>
                </div>
                <div class="boxset-products-list text-xs space-y-1">
                  ${boxsetProducts.map((product, idx) => {
                    // ลองหาชื่อสินค้าจากหลาย field
                    const productName = product.name || product.productName || product.itemName || product.title || 'ไม่ระบุชื่อ';
                    const productQty = product.quantity || product.qty || product.amount || 1;
                    const productPrice = product.price || product.unitPrice || 0;
    
                    console.log(`  📦 Product ${idx + 1}:`, {
                      name: productName,
                      quantity: productQty,
                      price: productPrice,
                      originalData: product
                    });
    
                    return `
                      <div class="flex items-center justify-between py-1 px-2 bg-white rounded border border-blue-100">
                        <div class="flex-1">
                          <span class="text-gray-700 font-medium">${productName}</span>
                          ${productPrice > 0 ? `<span class="text-xs text-gray-500 ml-1">(฿${productPrice})</span>` : ''}
                        </div>
                        <span class="badge badge-outline badge-xs text-blue-600">x${productQty}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `;
          } else {
            console.log(`⚠️ No products found for boxset "${boxsetItem.name}"`);
            boxsetProductsDisplay = `
              <div class="boxset-products mt-2 mb-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                <span class="text-xs text-gray-500">🎁 ยังไม่มีสินค้าใน Boxset นี้</span>
              </div>
            `;
          }
        }

        col.innerHTML = `
      ${fireIcon}
      ${statusIcon}
      <img src="${getImageUrl(group.image)}" class="product-img mb-2 rounded-md" alt="${group.name}" />
      <div class="flex flex-wrap items-center gap-1 mb-1">
        <h6 class="font-medium text-sm ${productOutOfStock ? 'emergency-text' : productLowStock ? 'warning-text' : ''}">${group.name}</h6>
        ${stockTypeBadge}
        ${quantityBadge}
        ${isBoxset ? '<span class="badge badge-secondary badge-sm ml-1">📦 Boxset</span>' : ''}
      </div>
      ${imeiDisplay}
      ${boxsetProductsDisplay}
      <p class="product-price-big mb-2">฿${formatPrice(group.price)}</p>
      ${hasPromo && !productOutOfStock ? '<p class="promotion-text">🎉 มีโปรโมชั่นพิเศษ!</p>' : ''}
      ${group.stockType !== 'imei' && !productOutOfStock ? `
        <button class="btn btn-primary btn-sm w-full mt-2" onclick="addProductToCart('${group.items[0]._id}', '${group.name}', ${group.price}, '', '${group.items[0].taxType || ''}', '${group.items[0].model || ''}', '${group.items[0].poNumber || ''}', '${group.items[0].supplier || ''}')">
          <i class="bi bi-cart-plus mr-1"></i>เพิ่มลงตะกร้า
        </button>
      ` : ''}
    `;
        // ไม่ต้องเพิ่ม event listener ปุ่มอีก
        grid.appendChild(col);
      });
    }


    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `รายละเอียดสินค้า: ${baseName}`;
      renderLevel3(level2Groups[baseName]);
    }





    // ปุ่มย้อนกลับจาก Level3 ไป Level2
    document.getElementById('btnGoBackToLevel2')
      .addEventListener('click', () => {
        document.getElementById('level3Container').classList.add('hidden');
        document.getElementById('level2Container').classList.remove('hidden');
      });


    // ----- ปุ่มย้อนกลับ -----
    function goBackToLevel1() {
      document.getElementById('level1Container').classList.remove('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }
    function goBackToLevel2() {
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }

    // — ปุ่มย้อนกลับ —
    document.getElementById('btnGoBack').addEventListener('click', () => {
      logAuditEvent('NAVIGATION_BACK_TO_LEVEL1', {
        fromLevel: 'level2',
        branchCode: BRANCH_CODE
      }, 'INFO');
      goBackToLevel1();
    });
    document.getElementById('btnGoBackToLevel2').addEventListener('click', () => {
      logAuditEvent('NAVIGATION_BACK_TO_LEVEL2', {
        fromLevel: 'level3',
        branchCode: BRANCH_CODE
      }, 'INFO');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
    });



    // -----------------------------
    // fetchTaxType ก็ใช้ cash ตลอด
    // -----------------------------
    async function fetchTaxType(imei) {
      const token = localStorage.getItem('authToken') || '';
      const url = `${API_ROOT}/branch-stock/taxType?branch_code=${BRANCH_CODE}` +
        `&verified=true&purchaseType=cash&imei=${encodeURIComponent(imei)}`;
      try {
        const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        const js = await resp.json();
        return (resp.ok && js.success && js.data.length) ? js.data[0].taxType : 'ไม่มีภาษี';
      } catch (err) {
        console.error('fetchTaxType failed:', err);
        return 'ไม่มีภาษี';
      }
    }




       async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        // เรียก /api/branch เพื่อดึง list สาขา
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const js = await res.json();
        if (res.ok && js.success) {
          // หา record ที่ตรงกับ BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === BRANCH_CODE);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} — ${branch.address}`;
            // อัพเดท title ของหน้าด้วยชื่อสาขาจริง
                          document.title = `POS - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `ระบบขายสด - ${branch.name}`;
    
              // อัพเดท dropdown branch info ใน Receipt Menu
              const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
              if (dropdownBranchInfo) {
                dropdownBranchInfo.textContent = `สาขา: ${branch.name}`;
              }
              return;
            }
        }
        throw new Error('ไม่พบข้อมูลสาขา');
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent =
          'สาขา: (ไม่พบข้อมูล)';
      }
    }





    // ค้นหา IMEI
    async function loadBranchVerified(branchId, imei = '') {
      const token = localStorage.getItem('authToken') || '';
      let url = `/api/branch-stock?branch_code=${branchId}&verified=true`;
      if (imei) url += `&imei=${encodeURIComponent(imei)}`;
      try {
        const res = await fetch(url, {
          headers: { Authorization: 'Bearer ' + token },
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลดสต๊อกได้');
        }
        renderIMEISearchResult(data.data);
      } catch (err) {
        showToast('Error: ' + err.message, 'danger');
      }
    }

    function renderIMEISearchResult(stockItems) {
      const grid = document.getElementById('imeiResultGrid');
      SecurityHelpers.safeSetContent(grid, '', '');

      if (!stockItems || stockItems.length === 0) {
        SecurityHelpers.safeSetContent(grid, 'text-gray-500', 'ไม่พบสินค้า IMEI ที่ค้นหา');
        return;
      }

      stockItems.forEach(st => {
        // ตรวจสอบ stockType
        const stockType = st.product_id?.stockType || st.stockType || 'imei';

        // ใช้ฟังก์ชัน getImageUrl ที่ปรับปรุงแล้ว
        const imgUrl = getImageUrl(st.image);

        // ใช้ราคา cash ตรงจาก API
        const price = st.price || 0;

        // คำนวณสถานะ stock
        let isOutOfStock = false;
        let isLowStock = false;
        let availableStock = 0;
        let stockBadgeText = '';
        let stockBadgeClass = '';
        let statusIcon = '';
        let buttonText = 'หยิบใส่ตะกร้า';
        let buttonClass = 'btn btn-primary mt-auto';
        let cardClass = 'product-card p-4 flex flex-col relative';

        if (stockType === 'imei') {
          // สำหรับ IMEI: ตรวจสอบว่าถูกใส่ตะกร้าแล้วหรือไม่
          isOutOfStock = hiddenProductIds.has(st._id);
          if (isOutOfStock) {
            stockBadgeText = '🚨 หมดสต๊อก! 0 เครื่อง';
            stockBadgeClass = 'emergency-badge';
            statusIcon = '<span class="status-icon emergency-icon">🚨</span>';
            buttonText = '🚨 หมดสต๊อก!';
            buttonClass = 'btn btn-error mt-auto emergency-text';
            cardClass += ' out-of-stock-emergency';
          } else {
            stockBadgeText = 'เหลือ 1 เครื่อง';
            stockBadgeClass = 'badge badge-info';
          }
        } else {
          // สำหรับ Quantity: คำนวณ stock ที่เหลือ
          const totalOriginalStock = st.originalStockValue || st.stock_value || 0;
          const cartQty = cartItems
            .filter(item => item.id === st._id && !item.imei)
            .reduce((sum, item) => sum + item.qty, 0);
          availableStock = Math.max(0, totalOriginalStock - cartQty);

          if (availableStock === 0) {
            isOutOfStock = true;
            stockBadgeText = '🚨 หมดสต๊อก! 0 ชิ้น';
            stockBadgeClass = 'emergency-badge';
            statusIcon = '<span class="status-icon emergency-icon">🚨</span>';
            buttonText = '🚨 หมดสต๊อก!';
            buttonClass = 'btn btn-error mt-auto emergency-text';
            cardClass += ' out-of-stock-emergency';
          } else if (availableStock <= 3) {
            isLowStock = true;
            stockBadgeText = `⚠️ เหลือน้อย! ${availableStock} ชิ้น`;
            stockBadgeClass = 'warning-badge';
            statusIcon = '<span class="status-icon warning-icon">⚠️</span>';
            buttonText = '⚠️ หยิบใส่ตะกร้า';
            buttonClass = 'btn btn-warning mt-auto warning-text';
            cardClass += ' low-stock-warning';
          } else {
            stockBadgeText = `เหลือ ${availableStock} ชิ้น`;
            stockBadgeClass = 'badge badge-info';
          }
        }

        // สร้าง stock type badge
        const stockTypeBadge = stockType === 'imei'
          ? '<span class="badge badge-info badge-sm">IMEI</span>'
          : '<span class="badge badge-success badge-sm">จำนวน</span>';

        // แสดง IMEI เฉพาะเมื่อเป็นประเภท IMEI
        const imeiDisplay = stockType === 'imei'
          ? `<div class="text-sm text-gray-500 mb-1">IMEI: ${st.imei || '-'}</div>`
          : '';

        const col = document.createElement('div');
        col.className = cardClass;
        col.innerHTML = `
      ${statusIcon}
      <img src="${imgUrl}" alt="${st.name}" class="product-img mb-2 rounded-md" />
      <div class="flex flex-col flex-grow">
        <div class="flex items-center gap-2 mb-1">
          <div class="product-name font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${st.name || '-'}</div>
          ${stockTypeBadge}
        </div>
        ${imeiDisplay}
        <div class="product-price-big mb-2">฿${formatPrice(price)}</div>
        <div class="mb-2">
          <span class="${stockBadgeClass} text-xs px-2 py-1 rounded">${stockBadgeText}</span>
        </div>
        ${stockType === 'quantity' && !isOutOfStock ? `
          <button class="btn btn-primary mt-auto" onclick="addProductToCart('${st._id}', '${st.name}', ${price}, '', '${st.taxType || ''}', '${st.model || ''}', '${st.poNumber || ''}', '${st.supplier || ''}')">
            <i class="bi bi-cart-plus mr-1"></i>เพิ่มลงตะกร้า
          </button>
        ` : `<button class="${buttonClass}" ${isOutOfStock ? 'disabled' : ''}>${buttonText}</button>`}
      </div>
    `;

        // เพิ่ม event listener สำหรับสินค้าประเภท IMEI เท่านั้น
        if (stockType === 'imei' && !isOutOfStock) {
          const button = col.querySelector('button');
          if (button && !button.onclick) { // ตรวจสอบว่ายังไม่มี onclick handler
            button.addEventListener('click', async () => {
              const taxType = await fetchTaxType(st.imei);
              addToCart(
                st._id,
                st.name,
                price,
                st.imei, // ส่ง IMEI สำหรับสินค้าประเภท IMEI
                taxType,
                st.model || '',
                st.poNumber || '',
                st.supplier || ''
              );
            });
          }
        }

        grid.appendChild(col);
      });
    }




    // Cart operation lock to prevent race conditions
    const cartOperationLocks = new Map();

    function addToCart(id, name, price, imei, taxType, model, poNumber = '', supplier = '') {
      // 🔐 Security Checks
      if (!validateSession()) return;

      if (!checkRateLimit('addToCart', 20, 60000)) {
        showToast('❌ คุณเพิ่มสินค้าเร็วเกินไป กรุณารอสักครู่', 'warning');
        return;
      }

      // 🔒 Race condition prevention - create unique lock key
      const lockKey = imei ? `${id}_${imei}` : `${id}_quantity`;

      if (cartOperationLocks.get(lockKey)) {
        console.log(`⚠️ Cart operation already in progress for ${lockKey}`);
        return;
      }

      // Set lock
      cartOperationLocks.set(lockKey, true);

      try {

      // 🔒 Input Sanitization
      name = sanitizeInput(name, 'text');
      price = parseFloat(sanitizeInput(price.toString(), 'number')) || 0;
      imei = sanitizeInput(imei, 'text');

      // 🔍 Audit Log - Start
      const auditDetails = {
        productId: id,
        productName: name,
        price: price,
        imei: imei,
        taxType: taxType,
        model: model,
        supplier: supplier
      };

      logAuditEvent('ADD_TO_CART_START', auditDetails, 'INFO');

      // หาข้อมูลสินค้าใน approvedStocks เพื่อตรวจสอบ stockType และ stock_value
      const stockItem = approvedStocks.find(item => item._id === id);
      if (!stockItem) {
        logAuditEvent('ADD_TO_CART_FAILED', { ...auditDetails, reason: 'STOCK_NOT_FOUND' }, 'ERROR');
        showToast('❌ ไม่พบข้อมูลสินค้าในสต๊อก', 'error');
        cartOperationLocks.delete(lockKey);
        return;
      }

      const stockType = stockItem.product_id?.stockType || stockItem.stockType || 'imei';

      // สำหรับสินค้าประเภท quantity (ไม่มี IMEI) ให้หาจาก id เท่านั้น
      // สำหรับสินค้าประเภท IMEI ให้หาจาก id และ imei
      const exist = imei
        ? cartItems.find((i) => i.id === id && i.imei === imei)
        : cartItems.find((i) => i.id === id && !i.imei);

      if (exist) {
        // สำหรับสินค้า quantity ตรวจสอบว่ามีสต๊อกเพียงพอหรือไม่
        if (stockType === 'quantity') {
          // หาสินค้าทั้งหมดที่มีชื่อเดียวกัน
          const sameNameItems = approvedStocks.filter(item => item.name === name);
          const totalOriginalStock = sameNameItems.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // คำนวณจำนวนในตะกร้าทั้งหมดสำหรับสินค้าชื่อนี้
          const currentCartQty = cartItems
            .filter(item => {
              return sameNameItems.some(sameItem => sameItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          if (currentCartQty >= totalOriginalStock) {
            logAuditEvent('ADD_TO_CART_FAILED', {
              ...auditDetails,
              reason: 'INSUFFICIENT_STOCK',
              available: totalOriginalStock - currentCartQty,
              requested: 1
            }, 'WARNING');
            showToast(`❌ สต๊อก ${name} ไม่เพียงพอ (เหลือ ${totalOriginalStock - currentCartQty} ชิ้น)`, 'warning');
            cartOperationLocks.delete(lockKey);
            return;
          }
        }

        exist.qty++;
        logAuditEvent('ADD_TO_CART_SUCCESS', {
          ...auditDetails,
          action: 'QUANTITY_INCREASED',
          newQuantity: exist.qty,
          previousQuantity: exist.qty - 1
        }, 'INFO');
        showToast(`✅ เพิ่มจำนวน ${name} เป็น ${exist.qty} ชิ้น`, 'success');
    
        // POS Notification
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: 'เพิ่มจำนวนสินค้า',
            message: `${name} ตอนนี้มี ${exist.qty} ชิ้นในตะกร้า`,
            type: 'info',
            icon: '📈'
          });
        }
      } else {
        // ตรวจสอบสต๊อกก่อนเพิ่มใหม่
        if (stockType === 'quantity') {
          // หาสินค้าทั้งหมดที่มีชื่อเดียวกัน
          const sameNameItems = approvedStocks.filter(item => item.name === name);
          const totalOriginalStock = sameNameItems.reduce((sum, item) => {
            return sum + (item.originalStockValue || item.stock_value);
          }, 0);

          // คำนวณจำนวนในตะกร้าทั้งหมดสำหรับสินค้าชื่อนี้
          const currentCartQty = cartItems
            .filter(item => {
              return sameNameItems.some(sameItem => sameItem._id === item.id) && !item.imei;
            })
            .reduce((sum, item) => sum + item.qty, 0);

          if (currentCartQty >= totalOriginalStock) {
            showToast(`❌ สินค้า ${name} หมดสต๊อก`, 'warning');
            return;
          }
        }

        cartItems.push({
          id,
          name,
          model,
          price: parseFloat(price),
          imei: imei || '', // เก็บ IMEI หรือ empty string
          taxType,
          poNumber,
          supplierId: supplier,
          qty: 1,
          stockType: stockType // เพิ่ม stockType เพื่อใช้ในการจัดการ
        });

        // สำหรับสินค้า IMEI แต่ละตัวต้องซ่อน แต่สินค้า quantity ไม่ต้องซ่อน
        if (imei) {
          hiddenProductIds.add(id);
        }

        showToast(`✅ เพิ่ม ${name} ลงในตะกร้าแล้ว`, 'success');
    
        // POS Notification - New item added
        if (posNotificationSystem) {
          const stockText = stockType === 'imei' ? `IMEI: ${imei}` : 'จำนวน 1 ชิ้น';
          posNotificationSystem.showToast('pos', {
            title: 'เพิ่มสินค้าใหม่',
            message: `${name} (${stockText}) ราคา ฿${formatPrice(price)}`,
            type: 'success',
            icon: '🛒'
          });
    
          posNotificationSystem.addNotification('pos', {
            title: 'เพิ่มสินค้าในตะกร้า',
            message: `${name} - ฿${formatPrice(price)}`,
            type: 'info',
            icon: '🛍️',
            metadata: {
              productId: id,
              productName: name,
              price: price,
              stockType: stockType,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }

      // ไม่ต้องอัปเดต stock_value ที่นี่ เพราะเราจะคำนวณ real-time ใน renderLevel3

      // รีเฟรช UI ตามหน้าที่เปิดอยู่
      const lvl1 = document.getElementById('level1Container');
      const lvl2 = document.getElementById('level2Container');
      const lvl3 = document.getElementById('level3Container');

      if (!lvl1.classList.contains('hidden')) {
        // รีเฟรช Level 1
        loadLevel1();
      } else if (!lvl2.classList.contains('hidden')) {
        // รีเฟรช Level 2
        const parentLabel = document.getElementById('level2Title').textContent.replace('รายการของ ', '');
        const parentKey = parentLabel.toLowerCase();
        renderLevel2(Object.keys(window.level2Groups || {}));
      } else if (!lvl3.classList.contains('hidden')) {
        // รีเฟรช Level 3
        const base = document.getElementById('level3Title').textContent.replace('รายละเอียดสินค้า: ', '');
        renderLevel3(level2Groups[base]);
      }

      renderCart();

        // ตรวจโปรโมชั่นทันที
        checkAvailablePromotions();

      } catch (error) {
        console.error('❌ Error in addToCart:', error);
        logAuditEvent('ADD_TO_CART_ERROR', {
          productId: id,
          productName: name,
          error: error.message,
          lockKey: lockKey
        }, 'ERROR');
        showToast('❌ เกิดข้อผิดพลาดในการเพิ่มสินค้า กรุณาลองใหม่', 'error');
      } finally {
        // Always release the lock
        cartOperationLocks.delete(lockKey);
      }
    }

    // Wrap ฟังก์ชัน addToCart เดิมเพื่อเพิ่ม confetti
    const originalAddToCart = addToCart;
    window.addToCart = function (id, name, price, imei, taxType, model, poNumber, supplier) {
      // Note: The prompt changed checkItemHasPromotion to checkPromotionForProduct
      const hasPromo = checkPromotionForProduct(id);

      // เรียกฟังก์ชันเดิม
      originalAddToCart.call(this, id, name, price, imei, taxType, model, poNumber, supplier);

      if (hasPromo) {
        // แสดง confetti effect
        const mainContent = document.getElementById('mainContent');
        createConfettiEffect(mainContent);

        // แสดง toast พิเศษ
        showToast(`🎉 ยินดีด้วย! ${name} มีโปรโมชั่นพิเศษ!`, 'success');
    
        // POS Notification - Promotion detected
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: 'พบโปรโมชั่นพิเศษ! 🎉',
            message: `${name} มีส่วนลดพิเศษ!`,
            type: 'success',
            icon: '🔥',
            duration: 6000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: 'โปรโมชั่นถูกนำไปใช้',
            message: `${name} ได้รับส่วนลดพิเศษแล้ว`,
            type: 'success',
            icon: '🎁',
            metadata: {
              productName: name,
              productId: id,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      }
    };

    // Check if there's a pending deposit product to add to cart
    if (window.pendingDepositProduct) {
      console.log('🔄 Processing pending deposit product:', window.pendingDepositProduct);
      const product = window.pendingDepositProduct;
    
      // Add to cart now that addToCart function is available
      addToCart(
        product.id,
        product.name,
        product.price,
        product.imei,
        product.taxType,
        product.model,
        product.poNumber,
        product.supplier
      );
    
      // Clear the pending product
      delete window.pendingDepositProduct;
      console.log('✅ Pending deposit product added to cart and cleared');
    }

    function removeFromCart(index) {
      const removed = cartItems[index];
      cartItems.splice(index, 1);
      if (removed) {
        // คืนสินค้า IMEI ให้แสดงกลับ (สินค้า quantity ไม่ได้ซ่อนตั้งแต่แรก)
        if (removed.imei) {
          hiddenProductIds.delete(removed.id);
        }

        // ไม่ต้องคืนค่าสต๊อก เพราะเราคำนวณ real-time จาก originalStockValue

        // รีเฟรช UI ตามหน้าที่เปิดอยู่
        const lvl1 = document.getElementById('level1Container');
        const lvl2 = document.getElementById('level2Container');
        const lvl3 = document.getElementById('level3Container');

        if (!lvl1.classList.contains('hidden')) {
          // รีเฟรช Level 1
          loadLevel1();
        } else if (!lvl2.classList.contains('hidden')) {
          // รีเฟรช Level 2
          renderLevel2(Object.keys(window.level2Groups || {}));
        } else if (!lvl3.classList.contains('hidden')) {
          // รีเฟรช Level 3
          const base = document.getElementById('level3Title').textContent.replace('รายละเอียดสินค้า: ', '');
          renderLevel3(level2Groups[base]);
        }
      }
      renderCart();
      showToast(`🗑️ ลบ ${removed?.name} ออกจากตะกร้าแล้ว`, 'info');
    
      // POS Notification - Item removed
      if (posNotificationSystem && removed) {
        posNotificationSystem.showToast('pos', {
          title: 'ลบสินค้าจากตะกร้า',
          message: `${removed.name} ถูกลบออกจากตะกร้าแล้ว`,
          type: 'warning',
          icon: '🗑️'
        });
      }
    }

    /**
     * Clear all items from cart and reset related data
     * Implements proper cart clearing with audit logging and UI updates
     */
    function clearCart() {
      try {
        // Log audit event before clearing cart
        logAuditEvent('CART_CLEARED', {
          branchCode: BRANCH_CODE,
          sessionId: window.currentSession?.sessionId,
          itemCount: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
          staffId: staffName || 'unknown',
          timestamp: new Date().toISOString()
        }, 'INFO');

        // Clear IMEI products from hidden list
        cartItems.forEach(item => {
          if (item.imei) {
            hiddenProductIds.delete(item.id);
          }
        });

        // Clear cart array and related data
        cartItems = [];
        hiddenProductIds.clear();
        appliedPromotions = {};

        // Clear cached promotion data
        if (typeof promotionCache !== 'undefined' && promotionCache.clear) {
          promotionCache.clear();
        }

        // Update UI elements
        document.getElementById('cartCount').textContent = '0';

        // Update promotion display
        document.getElementById('promotionDiscount').textContent = '0.00 ฿';
        const appliedPromotionsEl = document.getElementById('appliedPromotions');
        if (appliedPromotionsEl) {
          appliedPromotionsEl.innerHTML = '';
          appliedPromotionsEl.classList.add('hidden');
        }

        // Update Firebase RTDB and Socket.IO
        if (window.updateCartCountToFirebase) {
          window.updateCartCountToFirebase(0);
        }

        // Emit cart update via Socket.IO
        if (window.emitCartUpdate) {
          window.emitCartUpdate([]);
        }

        // Refresh UI based on current level
        const lvl1 = document.getElementById('level1Container');
        const lvl2 = document.getElementById('level2Container');
        const lvl3 = document.getElementById('level3Container');

        if (lvl1 && !lvl1.classList.contains('hidden')) {
          loadLevel1();
        } else if (lvl2 && !lvl2.classList.contains('hidden')) {
          renderLevel2(Object.keys(window.level2Groups || {}));
        } else if (lvl3 && !lvl3.classList.contains('hidden')) {
          const base = document.getElementById('level3Title').textContent.replace('รายละเอียดสินค้า: ', '');
          renderLevel3(level2Groups[base]);
        }

        // Render empty cart
        renderCart();

        // Show success message
        showToast('🧹 ล้างตะกร้าสำเร็จ', 'success');

        // POS Notification - Cart cleared
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: 'ล้างตะกร้าสำเร็จ',
            message: 'สินค้าทั้งหมดถูกลบออกจากตะกร้าแล้ว',
            type: 'success',
            icon: '🧹'
          });
        }

        console.log('✅ Cart cleared successfully');

      } catch (error) {
        console.error('❌ Error clearing cart:', error);

        // Log error for audit
        logAuditEvent('CART_CLEAR_FAILED', {
          branchCode: BRANCH_CODE,
          error: error.message,
          stack: error.stack,
          staffId: staffName || 'unknown'
        }, 'ERROR');

        showToast('❌ เกิดข้อผิดพลาดในการล้างตะกร้า', 'error');
      }
    }

    // ==================== PROMOTION FUNCTIONS ====================
    // — แทนที่ฟังก์ชันเก่า ด้วยโค้ดใหม่ debounce+cache —
    let checkPromotionsTimeout = null;
    let isCheckingPromotions = false;
    let lastCheckedProductIds = '';
    let promotionCache = new Map();
    const CACHE_DURATION = 5 * 60 * 1000; // 5 นาที
    const DEBOUNCE_DELAY = 1000; // 1 วินาที
    let appliedPromotions = {};

    // debounce wrapper
    async function checkAvailablePromotions() {
      if (!cartItems.length) {
        appliedPromotions = {};
        document.getElementById('promotionDiscount').textContent = '0.00 ฿';
        document.getElementById('appliedPromotions').classList.add('hidden');
        return;
      }
      if (checkPromotionsTimeout) clearTimeout(checkPromotionsTimeout);
      checkPromotionsTimeout = setTimeout(doCheckPromotions, DEBOUNCE_DELAY);
    }

    async function doCheckPromotions() {
      if (isCheckingPromotions) return;
      isCheckingPromotions = true;
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const ids = [...new Set(cartItems.map(i => i.id))].sort(); // These are branchStockIds

        // Log the branchStockIds being sent and other relevant info
        console.log('🔍 Checking promotions for products (branchStockIds):', ids, 'for branchCode:', BRANCH_CODE);
        // The user's example also logged activePromotions.length, which might be relevant for context.'
        // console.log('📊 Active client-side promotions (for UI hints):', activePromotions.length);


        const cacheKey = ids.join(',');
        if (cacheKey === lastCheckedProductIds) return;
        const cached = promotionCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
          displayAvailablePromotions(cached.data);
          lastCheckedProductIds = cacheKey;
          return;
        }
        const res = await fetch('/api/promotion/check-available', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
        });
        if (res.status === 429) {
          if (cached) {
            displayAvailablePromotions(cached.data);
            lastCheckedProductIds = cacheKey;
          } else {
            setTimeout(() => { isCheckingPromotions = false; doCheckPromotions(); }, 10000);
          }
          return;
        }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const js = await res.json();

        // Log the API response
        console.log('📦 API Response from /api/promotion/check-available:', js);

        if (js.status === 'success') {
          promotionCache.set(cacheKey, { data: js.data || {}, timestamp: Date.now() });
          displayAvailablePromotions(js.data || {});
          lastCheckedProductIds = cacheKey;
        }
      } catch (err) {
        const ids = [...new Set(cartItems.map(i => i.id))].sort();
        const cacheKey = ids.join(',');
        const cached = promotionCache.get(cacheKey);
        if (cached) displayAvailablePromotions(cached.data);
        else {
          appliedPromotions = {};
          updatePromotionDisplay();
        }
        console.error('Error checking promotions:', err);
      } finally {
        isCheckingPromotions = false;
      }
    }

    function displayAvailablePromotions(data) {
      appliedPromotions = {};
      cartItems.forEach(item => {
        const promos = data[item.id] || [];
        if (promos.length) {
          const best = promos.reduce((b, p) => {
            const v = p.type === 'percentage' ? item.price * (p.discount / 100) : p.type === 'fixed' ? p.discount : 0;
            const bv = b.type === 'percentage' ? item.price * (b.discount / 100) : b.type === 'fixed' ? b.discount : 0;
            return v > bv ? p : b;
          });
          appliedPromotions[item.id] = best;
        }
      });
      updatePromotionDisplay();
    }

    function updatePromotionDisplay() {
      const rows = document.querySelectorAll('#cartTable tbody tr');
      cartItems.forEach((item, idx) => {
        const promo = appliedPromotions[item.id];
        const cell = rows[idx]?.cells[0];
        if (!cell) return;
        if (promo) {
          let discPerItem = 0;
          if (promo.type === 'percentage') {
            discPerItem = item.price * (promo.discount / 100);
          } else if (promo.type === 'fixed') {
            discPerItem = promo.discount;
          }
          const totalDisc = discPerItem * item.qty;
          const newPrice = (item.price * item.qty) - totalDisc;

          // แสดงชื่อสินค้า + แสดงส่วนลด
          cell.innerHTML = `
        ${item.name}
        <span class="badge badge-error badge-sm ml-2">${promo.name}</span>
        <div class="text-xs">
          <span class="line-through">฿${formatPrice(item.price * item.qty)}</span>
          <span class="text-red-600 ml-2">฿${formatPrice(newPrice)}</span>
        </div>`;
        } else {
          cell.textContent = item.name;
        }
      });
      calculatePromotionDiscount();
      calcSummary();
    }

    function calculatePromotionDiscount() {
      let total = 0, details = [];
      Object.entries(appliedPromotions).forEach(([pid, p]) => {
        const it = cartItems.find(i => i.id === pid);
        if (!it) return;
        let discPerItem = 0;
        if (p.type === 'discount_percentage') {
          discPerItem = it.price * (p.discount / 100);
        } else if (p.type === 'discount_amount') {
          discPerItem = p.discount;
        }
        total += discPerItem * it.qty;
        // เก็บรายละเอียดสำหรับแสดงใต้โปรโมชั่น
        details.push({
          name: p.name,
          discount: discPerItem * it.qty,
          productName: it.name
        });
      });
      document.getElementById('promotionDiscount').textContent = '-฿' + formatPrice(total);
      const el = document.getElementById('appliedPromotions');
      if (Array.isArray(details) && details.length > 0) {
        // Safely create promotion details to prevent XSS
        SecurityHelpers.safeSetContent(el, '', '');

        details.forEach(d => {
          const detailDiv = document.createElement('div');
          detailDiv.className = 'text-xs';

          // Sanitize data before displaying
          const promotionName = (d.name || 'โปรโมชั่น').toString();
          const productName = (d.productName || 'สินค้า').toString();
          const discount = formatPrice(d.discount || 0);

          detailDiv.textContent = `• ${promotionName} (${productName}): -฿${discount}`;
          el.appendChild(detailDiv);
        });

        el.classList.remove('hidden');
      } else {
        SecurityHelpers.safeSetContent(el, '', '');
        el.classList.add('hidden');
      }
      return total;
    }

    async function recordPromotionUsage(promotionId) {
      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/api/promotion/use', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: JSON.stringify({ promotionId }) });
        const js = await res.json();
        if (js.status !== 'success') console.error('Failed to record promotion usage:', js.message);
      } catch (err) {
        console.error('Error recording promotion usage:', err);
      }
    }

    function clearPromotionCache() {
      promotionCache.clear();
      lastCheckedProductIds = '';
      appliedPromotions = {};
      console.log('🧹 Promotion cache cleared');
    }

    // ==================== end PROMOTION FIX ====================

    // แก้ renderCart: เอา checkAvailablePromotions ออก
    function renderCart() {
      // 1) อัปเดตจำนวนรายการที่หัวตะกร้า
      document.getElementById('cartCount').textContent = cartItems.length;

      // 2) อัปเดต Firebase RTDB และ Socket.IO
      if (window.updateCartCountToFirebase) {
        window.updateCartCountToFirebase(cartItems.length);
      }

      const tbody = document.querySelector('#cartTable tbody');
      tbody.innerHTML = '';

      // 3) ถ้าไม่มีสินค้าเลย
      if (cartItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-gray-500 py-6">
              <i class="bi bi-cart-x text-3xl mb-2 block"></i>
              ไม่มีสินค้าในตะกร้า
            </td>
          </tr>`;
        // รีเซ็ตยอดทั้งหมด
        document.getElementById('subTotal').textContent = '0.00 ฿';
        document.getElementById('vatAmount').textContent = '0.00 ฿';
        document.getElementById('discountAmount').textContent = '0.00 ฿';
        document.getElementById('totalPrice').textContent = '0.00 ฿';
        // เอกสารเป็นใบเสร็จรับเงิน (ไม่มีภาษี)
        const docEl = document.getElementById('docTypeLabel');
        if (docEl) docEl.textContent = 'ใบเสร็จรับเงิน';
        return;
      }

      // 4) กรณีมีสินค้า ให้วนสร้างแถวปกติ
      let subTotal = 0;
      cartItems.forEach((item, idx) => {
        const lineTotal = item.qty * item.price;
        subTotal += lineTotal;

        // เช็คโปรโมชั่น และแสดง badge ถ้ามี
        const promo = appliedPromotions[item.id];
        const promoHTML = promo
          ? `<span class="badge badge-error badge-sm ml-2">${promo.name}</span>`
          : '';

        const tr = document.createElement('tr');
        // สร้างแถว
        let cellName;
        if (promo) {
          const disc = promo.type === 'percentage'
            ? item.price * (promo.discount / 100)
            : promo.discount;
          const newPrice = item.price - disc;
          cellName = `
          ${item.name}
          <span class="badge badge-error badge-sm ml-2">${promo.name}</span>
          <div class="text-xs">
            <span class="line-through">฿${formatPrice(item.price)}</span>
            <span class="text-red-600 ml-2">฿${formatPrice(newPrice)}</span>
          </div>
          ${item.imei ? `<div class="text-xs text-blue-600 font-mono mt-1">IMEI: ${item.imei}</div>` : ''}`;
        } else {
          cellName = `${item.name}
            <div class="text-xs text-gray-500">
              จำนวน: ${item.qty}
              ${item.imei ? `<br>IMEI: <span class="font-mono text-blue-600">${item.imei}</span>` : ''}
            </div>`;
        }
        tr.innerHTML = `
        <td>${cellName}</td>
        <td>฿${formatPrice(item.price)}</td>
        <td>฿${formatPrice(lineTotal)}</td>
        <td>
          <button class="btn btn-sm btn-error" data-idx="${idx}">
            <i class="bi bi-trash"></i>
          </button>
        </td>`;
        tr.querySelector('button')
          .addEventListener('click', () => removeFromCart(idx));
        tbody.appendChild(tr);
      });

      // 5) ปรับยอดรวมและสรุปต่อ
      document.getElementById('subTotal').textContent = formatPrice(subTotal);
      calcSummary();
      // เรียกเช็คโปรโมชั่นอีกครั้งหลังรีเฟรชตะกร้า
      if (cartItems.length > 0) checkAvailablePromotions();
    }



    // [ลบแล้ว - ฟังก์ชัน applyGlobalTaxType ไม่จำเป็นแล้ว เพราะระบบสร้างเอกสารทั้งสองใบอัตโนมัติ]

    function calcSummary() {
      const vatRate = parseFloat(document.getElementById('vatRate').value) || 7;
      let subTotal = 0;
      let vatAmount = 0;
      let totalBeforeDiscount = 0;

      cartItems.forEach(item => {
        const line = item.price * item.qty;
        subTotal += line;

        // ✅ ใช้ตรรกะการคำนวณภาษีที่ปรับปรุงแล้ว
        const effectiveTaxType = item.taxType || 'ไม่มีภาษี';
    
        if (effectiveTaxType === 'รวมภาษี') {
          // ภาษีรวมในราคา: ราคา = ราคาสุทธิ + ภาษี
          const netAmount = line / (1 + vatRate / 100);
          const taxAmount = line - netAmount;
          vatAmount += taxAmount;
          totalBeforeDiscount += line; // ใช้ราคารวมภาษี
        }
        else if (effectiveTaxType === 'แยกภาษี') {
          // ภาษีแยกจากราคา: ราคารวม = ราคาสุทธิ + ภาษี
          const taxAmount = line * (vatRate / 100);
          vatAmount += taxAmount;
          totalBeforeDiscount += (line + taxAmount); // ราคาสุทธิ + ภาษี
        }
        else { // ไม่มีภาษี
          totalBeforeDiscount += line;
        }
      });

      // คำนวณส่วนลด
      const discountInput = document.getElementById('discount').value.trim();
      let discountVal = 0;
      if (discountInput.endsWith('%')) {
        const perc = parseFloat(discountInput);
        if (!isNaN(perc)) discountVal = (perc / 100) * totalBeforeDiscount;
      } else {
        const num = parseFloat(discountInput);
        if (!isNaN(num)) discountVal = num;
      }

      // เพิ่มคำนวณส่วนลดโปรโมชั่น
      const promoDisc = calculatePromotionDiscount();
      const totalDiscount = discountVal + promoDisc;
      let finalTotal = totalBeforeDiscount - totalDiscount;

      // 💰 หักเงินมัดจำถ้ามีใบรับเงินมัดจำ
      let depositAmountUsed = 0;
      if (window.depositReceiptInfo && window.depositReceiptInfo.depositAmount > 0) {
        depositAmountUsed = window.depositReceiptInfo.depositAmount;
        finalTotal = finalTotal - depositAmountUsed;
        console.log(`💰 หักเงินมัดจำ: ${depositAmountUsed.toLocaleString()} บาท`);
        console.log(`💵 ยอดที่ต้องชำระคงเหลือ: ${finalTotal.toLocaleString()} บาท`);

        // แสดงรายการหักเงินมัดจำ
        const depositRow = document.getElementById('depositDeductionRow');
        const depositAmount = document.getElementById('depositDeductionAmount');
        if (depositRow && depositAmount) {
          depositRow.style.display = 'flex';
          depositAmount.textContent = `-${formatPrice(depositAmountUsed)}`;
        }
      } else {
        // ซ่อนรายการหักเงินมัดจำถ้าไม่มี
        const depositRow = document.getElementById('depositDeductionRow');
        if (depositRow) {
          depositRow.style.display = 'none';
        }
      }

      // อัพเดต DOM
      document.getElementById('subTotal').textContent = formatPrice(subTotal);
      document.getElementById('vatAmount').textContent = formatPrice(vatAmount);
      document.getElementById('discountAmount').textContent = formatPrice(discountVal);
      document.getElementById('totalPrice').textContent = formatPrice(finalTotal);

      // ✅ Determine if tax invoice is needed
      // Tax invoice is needed if there's VAT amount or if customer type is business
      const customerType = document.getElementById('customerType')?.value || 'individual';
      const needTaxInvoice = vatAmount > 0 || customerType === 'business';
    
      // ✅ Return calculated values for reuse in checkout
      return {
        subTotal,
        vatAmount,
        totalBeforeDiscount,
        finalTotal: finalTotal,
        needTaxInvoice,
        vatRate
      };
    }


    // ✅ Enhanced: ใช้ระบบพิมพ์เหมือน HistoryReceipt.html ที่ integrate กับฐานข้อมูล
    // PrinterSystem จะถูกโหลดจาก /js/printer-service.js แทน

    // ✅ Enhanced: ฟังก์ชันพิมพ์ใบเสร็จที่ใช้ PrinterService แบบเดียวกับ HistoryReceipt.html
    async function printReceiptOnClient(receiptImage) {
      try {
        if (!receiptImage) {
          console.warn('⚠️ No receipt image provided for printing');
          if (typeof showToast === 'function') {
            showToast('⚠️ ไม่มีไฟล์ใบเสร็จสำหรับพิมพ์', 'warning');
          }
          return { success: false, error: 'No receipt image' };
        }

        // ตรวจสอบว่า PrinterService พร้อมใช้งานหรือไม่
        if (typeof window.PrinterService === 'undefined') {
          console.warn('⚠️ PrinterService not available, using fallback method');
          if (typeof showToast === 'function') {
            showToast('⚠️ ระบบพิมพ์ไม่พร้อมใช้งาน', 'warning');
          }
          return { success: false, error: 'PrinterService not available' };
        }

        // ✅ Fix: อ่านข้อมูลลูกค้าตามประเภทที่ถูกต้อง
        const customerType = document.getElementById('customerType')?.value || 'individual';
        let customerName = '';
        let customerEmail = '';
        let customerTaxId = '';

        if (customerType === 'individual') {
          // บุคคลธรรมดา
          const prefix = document.getElementById('customerPrefix')?.value || '';
          const firstName = document.getElementById('customerFirstName')?.value || '';
          const lastName = document.getElementById('customerLastName')?.value || '';
          customerName = `${prefix}${firstName} ${lastName}`.trim();
          customerEmail = document.getElementById('customerEmailPersonal')?.value || '';
          customerTaxId = document.getElementById('customerTaxId')?.value || '';
        } else {
          // นิติบุคคล
          customerName = document.getElementById('companyName')?.value || '';
          customerEmail = document.getElementById('corporateEmail')?.value || '';
          customerTaxId = document.getElementById('companyTaxId')?.value || '';
        }

        const orderData = {
          items: cartItems.map(item => ({
            name: item.name,
            quantity: item.qty,
            price: item.price,
            total: item.qty * item.price,
            imei: item.imei
          })),
          total: cartItems.reduce((sum, item) => sum + (item.qty * item.price), 0),
          customerInfo: {
            type: customerType,
            taxId: customerTaxId,
            name: customerName,
            email: customerEmail
          },
          documentType: 'frontstore_receipt',
          timestamp: new Date().toISOString()
        };

        console.log('🖨️ Print order data via PrinterService:', orderData);
    
        // 🔍 Audit Log - Print attempt
        logAuditEvent('PRINT_ATTEMPT', {
          customerType: customerType,
          customerName: customerName,
          totalAmount: orderData.total,
          itemCount: orderData.items.length,
          printMethod: 'PrinterService'
        }, 'INFO');
    
        // ใช้ PrinterService.print() แบบเดียวกับ HistoryReceipt.html
        const result = await window.PrinterService.print(receiptImage, orderData);
    
        if (result && result.success) {
          // 🔍 Audit Log - Print success
          logAuditEvent('PRINT_SUCCESS', {
            customerType: customerType,
            customerName: customerName,
            totalAmount: orderData.total,
            printMethod: 'PrinterService'
          }, 'SUCCESS');
    
          if (typeof showToast === 'function') {
            showToast('✅ พิมพ์ใบเสร็จเรียบร้อยแล้ว', 'success');
          }
          return result;
        } else {
          throw new Error(result?.error || 'PrinterService failed');
        }
    
      } catch (error) {
        console.error('Error printing receipt via PrinterService:', error);
    
        // ✅ Fix: ประกาศตัวแปรใหม่ในกรณีที่ error เกิดก่อนการอ่านค่าลูกค้า
        const customerType = document.getElementById('customerType')?.value || 'individual';
        let customerName = '';
    
        if (customerType === 'individual') {
          const prefix = document.getElementById('customerPrefix')?.value || '';
          const firstName = document.getElementById('customerFirstName')?.value || '';
          const lastName = document.getElementById('customerLastName')?.value || '';
          customerName = `${prefix}${firstName} ${lastName}`.trim();
        } else {
          customerName = document.getElementById('companyName')?.value || '';
        }
    
        // 🔍 Audit Log - Print failure
        logAuditEvent('PRINT_FAILED', {
          customerType: customerType || 'unknown',
          customerName: customerName || 'unknown',
          totalAmount: cartItems?.reduce((sum, item) => sum + (item.qty * item.price), 0) || 0,
          error: error.message,
          printMethod: 'PrinterService',
          errorType: error.message.includes('CSP') ? 'CSP_VIOLATION' :
                     error.message.includes('Failed to fetch') ? 'NETWORK_ERROR' :
                     error.message.includes('ไม่พร้อมใช้งาน') ? 'PRINTER_OFFLINE' : 'UNKNOWN'
        }, 'WARNING');
    
        // ปรับข้อความ error ตามสาเหตุ
        let userMessage = '';
        let toastType = 'warning';
    
        if (error.message.includes('CSP') || error.message.includes('Content Security Policy')) {
          userMessage = '⚠️ ไม่สามารถพิมพ์ได้เนื่องจากการตั้งค่าความปลอดภัย (การขายสำเร็จแล้ว)';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          userMessage = '⚠️ ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้ (การขายสำเร็จแล้ว)';
        } else if (error.message.includes('ไม่พร้อมใช้งาน')) {
          userMessage = '⚠️ เครื่องพิมพ์ไม่พร้อมใช้งาน (การขายสำเร็จแล้ว)';
        } else {
          userMessage = `⚠️ ไม่สามารถพิมพ์ใบเสร็จได้: ${error.message} (การขายสำเร็จแล้ว)`;
        }
    
        // แสดง error message ที่เป็นมิตรกับผู้ใช้
        if (typeof showToast === 'function') {
          showToast(userMessage, toastType);
          // เพิ่มคำแนะนำ
          setTimeout(() => {
            showToast('💡 คำแนะนำ: คุณสามารถพิมพ์ใบเสร็จภายหลังได้จากหน้าประวัติการขาย', 'info');
          }, 2000);
        }
    
        // คืนค่า error แต่ไม่ throw เพื่อไม่ให้หยุดการทำงาน
        return {
          success: false,
          error: error.message,
          userMessage: userMessage
        };
      }
    }
    function singleCheckout() {
      if (cartItems.length === 0) {
        showToast('❌ ไม่มีสินค้าในตะกร้า', 'warning');
        return;
      }
      const taxId = document.getElementById('customerTaxId').value.trim();
      if (!taxId) {
        showToast('❌ กรุณากรอกเลขประจำตัวผู้เสียภาษี', 'warning');
        return;
      }
      customConfirm('คุณต้องการยืนยันการชำระเงินและพิมพ์ใบเสร็จหรือไม่?', () => {
        const btn = document.getElementById('btnSingleCheckout');
        btn.disabled = true;
        btn.classList.add('loading');
        doCheckout().finally(() => {
          btn.disabled = false;
          btn.classList.remove('loading');
        });
      });
    }


    // ตรวจสอบสถานะระบบอีเมล
    async function checkEmailServiceStatus() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/email/config', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
    
        if (response.ok) {
          const result = await response.json();
          return {
            available: result.success && result.data?.serviceEnabled,
            details: result.data
          };
        }
        return { available: false, error: `HTTP ${response.status}` };
      } catch (error) {
        console.warn('Cannot check email service status:', error);
        return { available: false, error: error.message };
      }
    }

    // อัปเดตสถานะการส่งอีเมลใน UI
    function updateEmailServiceIndicator() {
      checkEmailServiceStatus().then(status => {
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        const emailLabel = emailCheckbox?.parentElement;
    
        if (emailLabel) {
          // ลบ indicator เก่า
          const oldIndicator = emailLabel.querySelector('.email-status-indicator');
          if (oldIndicator) oldIndicator.remove();
    
          // เพิ่ม indicator ใหม่
          const indicator = document.createElement('span');
          indicator.className = 'email-status-indicator text-xs ml-2';
    
          if (status.available) {
            indicator.innerHTML = '<span class="text-green-600">🟢 พร้อมใช้งาน</span>';
            emailCheckbox.disabled = false;
          } else {
            indicator.innerHTML = '<span class="text-orange-600">🟡 ยังไม่พร้อม</span>';
            emailCheckbox.checked = false;
            emailCheckbox.disabled = true;
          }
    
          emailLabel.appendChild(indicator);
        }
      }).catch(err => {
        console.warn('Failed to update email service indicator:', err);
      });
    }

    // ฟังก์ชันส่งอีเมลใบเสร็จ
    async function sendReceiptEmail(emailData) {
      try {
        showToast('📧 กำลังส่งอีเมลใบเสร็จ...', 'info');
    
        const token = localStorage.getItem('authToken');
        // รองรับคีย์หลายรูปแบบจาก doCheckout
        const orderId = emailData.orderId || emailData.documentId || emailData.document_id || emailData.order_id || emailData.invoiceId || emailData._id;
        const invoiceNo = emailData.invoiceNo || emailData.documentNumber || emailData.document_no || emailData.invoice_no || emailData.order_number;
        const docType = (emailData.documentType || '').toString().toUpperCase();
        const payload = {
          orderId: orderId,
          invoiceNo: invoiceNo,
          email: emailData.customerEmail,
          customerName: emailData.customerName,
          // ตั้งประเภทเอกสารตามที่ส่งมา (ค่าเริ่มต้น receipt)
          type: docType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt',
          documents: {
            receipt: true,
            taxInvoice: docType === 'TAX_INVOICE' ? true : false
          }
        };

        // ป้องกัน 400 ถ้าข้อมูลบังคับไม่ครบ
        if (!payload.email || !payload.orderId || !payload.invoiceNo) {
          throw new Error('ข้อมูลไม่ครบถ้วน (ต้องการ email, orderId, invoiceNo)');
        }

        const response = await fetch('/api/email/send-receipt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload),
          timeout: 10000 // 10 second timeout
        });

        // ตรวจสอบ response status เฉพาะเจาะจง
        if (response.status === 503) {
          throw new Error('ระบบอีเมลยังไม่พร้อมใช้งาน กรุณาส่งใบเสร็จด้วยตนเองภายหลัง');
        }
    
        if (response.status === 500) {
          throw new Error('เซิร์ฟเวอร์มีปัญหา กรุณาลองใหม่อีกครั้งภายหลัง');
        }
    
        if (response.status === 404) {
          throw new Error('ไม่พบบริการส่งอีเมล กรุณาติดต่อผู้ดูแลระบบ');
        }

        const result = await response.json().catch(() => ({ success: false, message: 'ไม่สามารถอ่านข้อมูลตอบกลับได้' }));

        if (response.ok && result.success) {
          showToast(`✅ ส่งใบเสร็จไปยัง ${emailData.customerEmail} เรียบร้อยแล้ว`, 'success');
    
          // 🔍 Audit Log - Email sent
          logAuditEvent('EMAIL_SENT_SUCCESS', {
            orderId: emailData.orderId,
            invoiceNo: emailData.invoiceNo,
            email: emailData.customerEmail,
            customerType: emailData.customerType
          }, 'SUCCESS');
        } else {
          throw new Error(result.message || `เกิดข้อผิดพลาด (HTTP ${response.status})`);
        }

      } catch (error) {
        console.error('Send email error:', error);
    
        // แสดงข้อความแนะนำที่เป็นประโยชน์
        let userMessage = '';
        if (error.message.includes('503') || error.message.includes('ยังไม่พร้อมใช้งาน')) {
          userMessage = `⚠️ ระบบอีเมลยังไม่พร้อม | การขายเสร็จสิ้นแล้ว แต่ยังไม่ได้ส่งอีเมล`;
          showToast(userMessage, 'warning');
          showToast('💡 เคล็ดลับ: คุณสามารถส่งใบเสร็จให้ลูกค้าทางอื่นได้ เช่น Line, SMS หรือพิมพ์ใบเสร็จ', 'info');
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          userMessage = `🌐 ไม่สามารถเชื่อมต่อได้ | กรุณาตรวจสอบสัญญาณอินเทอร์เน็ต`;
          showToast(userMessage, 'warning');
        } else {
          userMessage = `⚠️ ส่งอีเมลไม่สำเร็จ: ${error.message}`;
          showToast(userMessage, 'warning');
        }
    
        // 🔍 Audit Log - Email failed with more details
        logAuditEvent('EMAIL_SENT_FAILED', {
          orderId: emailData.orderId,
          email: emailData.customerEmail,
          error: error.message,
          timestamp: new Date().toISOString(),
          suggestion: 'Manual delivery required'
        }, 'WARNING');
    
        // บันทึกลง localStorage สำหรับการส่งภายหลัง
        try {
          const failedEmails = JSON.parse(localStorage.getItem('failedEmails') || '[]');
          failedEmails.push({
            ...emailData,
            failedAt: new Date().toISOString(),
            error: error.message
          });
          localStorage.setItem('failedEmails', JSON.stringify(failedEmails.slice(-50))); // เก็บแค่ 50 รายการล่าสุด
          console.log('📝 บันทึกอีเมลที่ส่งไม่สำเร็จสำหรับการลองใหม่ภายหลัง');
        } catch (storageError) {
          console.warn('ไม่สามารถบันทึกรายการอีเมลที่ล้มเหลวได้:', storageError);
        }
    
        // ไม่ให้ error นี้หยุดการทำงานของระบบหลัก
      }
    }

    async function doCheckout() {
      // ประกาศ loaderId ไว้ข้างนอก try block
      let loaderId = null;
    
      // 🔐 Transaction Lock
      const transactionId = `checkout_${Date.now()}`;
      if (!acquireTransactionLock(transactionId)) {
        showToast('❌ ระบบกำลังประมวลผลรายการอื่น กรุณารอสักครู่', 'warning');
        return;
      }

      try {
        // Show loading
        showLoading(true);
        // 🔐 Security Validation
        if (!validateSession()) {
          releaseTransactionLock(transactionId);
          return;
        }

        if (!checkRateLimit('checkout', 3, 300000)) { // 3 ครั้ง ใน 5 นาที
          logAuditEvent('CHECKOUT_RATE_LIMITED', { transactionId }, 'WARNING');
          showToast('❌ คุณทำรายการเร็วเกินไป กรุณารอ 5 นาที', 'warning');
          releaseTransactionLock(transactionId);
          return;
        }

        const token = localStorage.getItem('authToken') || '';
        const staffId = localStorage.getItem('userId');
        const staffNameFromStorage = localStorage.getItem('userName');

        // 🔍 Audit Log - Checkout Start
        logAuditEvent('CHECKOUT_START', {
          transactionId,
          cartItems: cartItems.length,
          totalValue: cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0),
          staffId,
          branchCode: BRANCH_CODE
        }, 'INFO');

        // (0) ตรวจสอบว่ามี staffId หรือไม่
        if (!staffId) {
          logAuditEvent('CHECKOUT_FAILED', {
            transactionId,
            reason: 'NO_STAFF_ID'
          }, 'ERROR');
          throw new Error('ไม่สามารถระบุพนักงานขายได้ กรุณาตรวจสอบการเข้าสู่ระบบ');
        }

        // ปรับปรุงการจัดการชื่อพนักงาน - ตรวจสอบแหล่งข้อมูลหลายแหล่ง
        const staffNameFromToken = localStorage.getItem('staffName');
        const staffNameFromUserProfile = (() => {
          try {
            const profile = localStorage.getItem('userProfile');
            return profile ? JSON.parse(profile).name : null;
          } catch (e) {
            return null;
          }
        })();
    
        // เพิ่มการดึงชื่อจาก current session/API ล่าสุด
        let currentStaffName = null;
    
        // 1. ลองดึงจาก localStorage.userName ก่อน (ที่ loadEmployeeProfile() เซฟไว้)
        if (staffNameFromStorage && staffNameFromStorage !== 'พนักงาน' && staffNameFromStorage !== 'Guest') {
          currentStaffName = staffNameFromStorage;
          console.log('✅ Using staff name from localStorage.userName:', currentStaffName);
        }
        // 2. ลองใช้ global staffName ที่ถูกอัพเดทจาก loadEmployeeProfile()
        else if (staffName && staffName !== 'พนักงาน' && staffName !== 'Guest') {
          currentStaffName = staffName;
          console.log('✅ Using global staffName:', currentStaffName);
        }
        // 3. ลองดึงจาก staffNameFromToken
        else if (staffNameFromToken && staffNameFromToken !== 'พนักงาน' && staffNameFromToken !== 'Guest') {
          currentStaffName = staffNameFromToken;
          console.log('✅ Using staff name from token:', currentStaffName);
        }
        // 4. ลองดึงจาก userProfile
        else if (staffNameFromUserProfile && staffNameFromUserProfile !== 'พนักงาน' && staffNameFromUserProfile !== 'Guest') {
          currentStaffName = staffNameFromUserProfile;
          console.log('✅ Using staff name from user profile:', currentStaffName);
        }
        // 5. ถ้าไม่พบเลย ให้เรียก API ใหม่ทันที
        else {
          console.warn('⚠️ ไม่พบชื่อพนักงานจากแหล่งใดเลย กำลังดึงจาก API...');
          try {
            const token = localStorage.getItem('authToken');
            if (token) {
              const userResponse = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
              });
              const userData = await userResponse.json();
              if (userData.success && userData.data && userData.data.name) {
                currentStaffName = userData.data.name;
                // อัพเดท localStorage และ global variable ด้วย
                localStorage.setItem('userName', currentStaffName);
                staffName = currentStaffName;
                console.log('✅ Retrieved staff name from API:', currentStaffName);
              }
            }
          } catch (apiError) {
            console.error('❌ Failed to get staff name from API:', apiError);
          }
        }
    
        // Fallback สุดท้าย
        if (!currentStaffName) {
          currentStaffName = 'พนักงาน';
          console.warn('⚠️ ใช้ชื่อ fallback:', currentStaffName);
        }
    
        // Debug log เพื่อตรวจสอบค่าทั้งหมด
        console.log('🔍 Staff Name Debug - Final Check:', {
          currentStaffName: currentStaffName,
          staffNameFromStorage: staffNameFromStorage,
          globalStaffName: staffName,
          staffNameFromToken: staffNameFromToken,
          staffNameFromUserProfile: staffNameFromUserProfile,
          localStorage_userName: localStorage.getItem('userName'),
          localStorage_staffName: localStorage.getItem('staffName')
        });
    
        // Debug ข้อมูลชื่อพนักงาน
        console.log('🔍 Staff Name Debug:', {
          staffId: staffId,
          staffNameFromStorage: staffNameFromStorage,
          staffNameFromToken: staffNameFromToken,
          staffNameFromUserProfile: staffNameFromUserProfile,
          globalStaffName: staffName,
          finalStaffName: currentStaffName,
          isDefaultName: currentStaffName === 'พนักงาน'
        });
    
        // แสดงคำเตือนถ้ายังใช้ชื่อ default
        if (currentStaffName === 'พนักงาน') {
          console.warn("⚠️ ยังคงใช้ชื่อ default 'พนักงาน' - อาจมีปัญหาการ login");
          if (typeof showToast === 'function') {
            showToast('⚠️ ไม่พบชื่อพนักงาน จะใช้ชื่อ "พนักงาน" ในการบันทึก', 'warning');
          }
        } else {
          console.log('✅ ใช้ชื่อพนักงาน:', currentStaffName);
        }

        // ✅ Fix: เพิ่ม null safety ในการอ่านข้อมูลฟอร์ม
        const customerTypeElement = document.getElementById('customerType');
        if (!customerTypeElement) {
          throw new Error('ไม่พบฟิลด์ประเภทลูกค้า กรุณาโหลดหน้าใหม่');
        }
    
        const customerType = customerTypeElement.value;
        let customerInfo = {}, corporateInfo = {}, customerTaxId = '', companyTaxId = '';

        if (customerType === 'individual') {
          const taxIdElement = document.getElementById('customerTaxId');
          if (!taxIdElement) {
            throw new Error('ไม่พบฟิลด์เลขประจำตัวผู้เสียภาษี กรุณาโหลดหน้าใหม่');
          }
    
          customerTaxId = sanitizeInput(taxIdElement.value, 'taxId');
          if (!customerTaxId || customerTaxId.length !== 13) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INVALID_TAX_ID',
              providedTaxId: customerTaxId?.length || 0
            }, 'WARNING');
            throw new Error('กรุณากรอกเลขประจำตัวผู้เสียภาษี 13 หลักที่ถูกต้อง');
          }

          // ✅ Fix: เพิ่ม null safety สำหรับทุกฟิลด์
          const getElementValue = (id, defaultValue = '') => {
            const element = document.getElementById(id);
            if (!element) {
              console.warn(`⚠️ Element with id '${id}' not found, using default value`);
              return defaultValue;
            }
            return element.value || defaultValue;
          };

          customerInfo = {
            prefix: sanitizeInput(getElementValue('customerPrefix'), 'text'),
            gender: sanitizeInput(getElementValue('customerGender'), 'text'),
            firstName: sanitizeInput(getElementValue('customerFirstName'), 'text'),
            lastName: sanitizeInput(getElementValue('customerLastName'), 'text'),
            phone: sanitizeInput(getElementValue('customerPhone'), 'phone'),
            phoneNumber: sanitizeInput(getElementValue('customerPhone'), 'phone'), // เพิ่ม field นี้เพื่อให้ตรงกับ backend
            email: sanitizeInput(getElementValue('customerEmailPersonal'), 'text'),
            age: parseInt(getElementValue('customerAge')) || null,
            birthDate: getElementValue('customerBirthDate') || null,
            occupation: {
              category: sanitizeInput(getElementValue('customerOccupation'), 'text')
            },
            address: {
              houseNo: sanitizeInput(getElementValue('houseNo'), 'text'),
              moo: sanitizeInput(getElementValue('moo'), 'text'),
              subDistrict: sanitizeInput(getElementValue('subDistrict'), 'text'),
              district: sanitizeInput(getElementValue('district'), 'text'),
              province: sanitizeInput(getElementValue('province'), 'text'),
              zipcode: sanitizeInput(getElementValue('zipcode'), 'number'),
            },
            taxId: customerTaxId
          };

          // ตรวจสอบข้อมูลที่จำเป็น
          if (!customerInfo.firstName || !customerInfo.lastName) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INCOMPLETE_CUSTOMER_INFO',
              missingFields: ['firstName', 'lastName'].filter(field => !customerInfo[field])
            }, 'WARNING');
            throw new Error('กรุณากรอกชื่อและนามสกุลลูกค้า');
          }

        } else { // นิติบุคคล
          const companyTaxIdElement = document.getElementById('companyTaxId');
          if (!companyTaxIdElement) {
            throw new Error('ไม่พบฟิลด์เลขทะเบียนนิติบุคคล กรุณาโหลดหน้าใหม่');
          }
    
          companyTaxId = sanitizeInput(companyTaxIdElement.value, 'taxId');
          if (!companyTaxId || companyTaxId.length !== 13) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'INVALID_COMPANY_TAX_ID',
              providedTaxId: companyTaxId?.length || 0
            }, 'WARNING');
            throw new Error('กรุณากรอกเลขทะเบียนนิติบุคคล 13 หลักที่ถูกต้อง');
          }

          const companyName = sanitizeInput(getElementValue('companyName'), 'text');
          if (!companyName) {
            logAuditEvent('CHECKOUT_FAILED', {
              transactionId,
              reason: 'MISSING_COMPANY_NAME'
            }, 'WARNING');
            throw new Error('กรุณากรอกชื่อบริษัท');
          }

          corporateInfo = {
            companyName: companyName,
            companyTaxId,
            contactPerson: sanitizeInput(getElementValue('contactPerson'), 'text'),
            corporatePhone: sanitizeInput(getElementValue('corporatePhone'), 'phone'),
            corporateEmail: sanitizeInput(getElementValue('corporateEmail'), 'text'),
            companyAddress: sanitizeInput(getElementValue('companyAddress'), 'text')
          };
        }

        // ✅ ใช้ฟังก์ชัน calcSummary() เพื่อป้องกันการคำนวณซ้ำ
        const calculationResult = calcSummary();
    
        if (!calculationResult) {
          throw new Error('การคำนวณยอดรวมล้มเหลว');
        }
    
        const {
          subTotal: subTotalVal,
          vatAmount: vatAmountVal,
          totalBeforeDiscount,
          finalTotal,
          needTaxInvoice,
          vatRate
        } = calculationResult;

        // คำนวณส่วนลดโปรโมชั่น
        const promotionDiscount = calculatePromotionDiscount();
        const usedPromotions = Object.values(appliedPromotions).filter(p => p);
        // กำหนด invoiceType - เปลี่ยนให้สร้างทั้งสองเอกสารเสมอ
        const invoiceType = 'BOTH_DOCUMENTS'; // สร้างทั้งใบเสร็จรับเงินและใบกำกับภาษีพร้อมกัน
        const saleType = 'cash'; // บ่งบอกว่าเป็นขายสด

        // คำนวณส่วนลดที่ผู้ใช้กรอก (ไม่รวมโปรโมชั่น)
        const discountInputDoCheckout = document.getElementById('discount')?.value?.trim() || '';
        let discountVal = 0;
        if (discountInputDoCheckout.endsWith('%')) {
          const perc = parseFloat(discountInputDoCheckout);
          if (!isNaN(perc)) discountVal = (perc / 100) * totalBeforeDiscount;
        } else {
          const num = parseFloat(discountInputDoCheckout);
          if (!isNaN(num)) discountVal = num;
        }

        // ยอดรวมสุทธิหลังหักส่วนลดทั้งหมด (finalTotal จาก calcSummary() ถูกหักทั้ง discount และ promotion ไว้แล้ว)
        const totalVal = finalTotal;

        // มูลค่าสุทธิไม่รวมภาษี
        const netAmountVal = Math.max(totalVal - vatAmountVal, 0);

        // ตรวจสอบการจองสต็อกในตะกร้า
        const reservedItems = cartItems.filter(item => item.hasStockReservation);
        if (reservedItems.length > 0) {
          console.log('🔒 Found reserved items in cart:', reservedItems);
    
          // แจ้งเตือนเกี่ยวกับการตัดสต็อกสินค้าที่จอง
          for (const item of reservedItems) {
            if (typeof showToast === 'function') {
              showToast(
                `กำลังตัดสต็อกสินค้าที่จอง: ${item.name} (IMEI: ${item.imei})`,
                'info'
              );
            }
          }
        }

        // ✅ Fix: เพิ่ม null safety สำหรับ payment method
        const selectedPaymentElement = document.querySelector('input[name="paymentMethod"]:checked');
        console.log('🔍 Debug payment selection:', {
          selectedElement: selectedPaymentElement,
          allPaymentMethods: document.querySelectorAll('input[name="paymentMethod"]').length,
          checkedCount: document.querySelectorAll('input[name="paymentMethod"]:checked').length
        });
    
        if (!selectedPaymentElement) {
          // ตรวจสอบว่ามี radio buttons หรือไม่
          const allPaymentInputs = document.querySelectorAll('input[name="paymentMethod"]');
          console.error('❌ Payment method selection debug:', {
            totalInputs: allPaymentInputs.length,
            inputsData: Array.from(allPaymentInputs).map(input => ({
              id: input.id,
              value: input.value,
              checked: input.checked,
              disabled: input.disabled
            }))
          });
    
          logAuditEvent('CHECKOUT_FAILED', {
            transactionId,
            reason: 'NO_PAYMENT_METHOD_SELECTED',
            debugInfo: {
              totalPaymentInputs: allPaymentInputs.length,
              checkedInputs: document.querySelectorAll('input[name="paymentMethod"]:checked').length
            }
          }, 'WARNING');
          throw new Error('กรุณาเลือกวิธีการชำระเงิน (ไม่พบตัวเลือกที่เลือกไว้)');
        }
        const selectedPaymentMethod = selectedPaymentElement ? selectedPaymentElement.value : 'CASH';
        console.log('✅ Selected payment method:', selectedPaymentMethod);

        // กำหนด payment method สำหรับ paymentInfo
        let paymentMethod = 'cash';
        if (selectedPaymentMethod === 'TRANSFER') {
          paymentMethod = 'transfer';
        } else if (selectedPaymentMethod === 'CARD') {
          paymentMethod = 'credit_card';
        } else if (selectedPaymentMethod === 'MIXED') {
          paymentMethod = 'mixed'; // การชำระแบบผสม
        }

        // แปลงที่อยู่ให้เป็นสตริงตามที่ API ต้องการ
        const formatAddress = (addr) => {
          if (!addr) return '';
          if (typeof addr === 'string') return addr;
          try {
            const parts = [
              addr.houseNo ? `บ้านเลขที่ ${addr.houseNo}` : '',
              addr.moo ? `หมู่ ${addr.moo}` : '',
              addr.subDistrict ? `ตำบล ${addr.subDistrict}` : '',
              addr.district ? `อำเภอ ${addr.district}` : '',
              addr.province ? `จังหวัด ${addr.province}` : '',
              addr.zipcode ? `รหัสไปรษณีย์ ${addr.zipcode}` : ''
            ].filter(Boolean);
            return parts.join(' ').trim();
          } catch (e) {
            return '';
          }
        };

        const customerInfoForPayload = customerType === 'individual'
          ? { ...customerInfo, address: formatAddress(customerInfo.address) }
          : {};
        const corporateInfoForPayload = customerType === 'corporate'
          ? { ...corporateInfo, address: corporateInfo.companyAddress || '' }
          : {};

        // (3) เตรียม payload สำหรับบันทึกในฐานข้อมูล
        const basePayload = {
          // ข้อมูลสินค้า (เตรียมสำหรับ /api/taxinvoice/checkout)
          items: cartItems.map(item => ({
            id: item.id,
            name: item.name,
            qty: item.qty,
            price: item.price,
            total: item.qty * item.price,
            taxType: item.taxType || 'ไม่มีภาษี',
            imei: item.imei || '',
            brand: item.brand || '',
            productCode: item.productCode || '',
            category: item.category || ''
          })),
    
          // ข้อมูลลูกค้า
          customerType,
          customerInfo: customerInfoForPayload,
          ...(customerType === 'corporate' && { corporateInfo: corporateInfoForPayload }),
          customerTaxId,
          companyTaxId,
    
          // ข้อมูลการเงิน
          subTotal: subTotalVal,
          vatAmount: vatAmountVal,
          netAmount: netAmountVal,
          discount: discountVal,
          promotionDiscount: promotionDiscount,
          total: totalVal,
    
          // ข้อมูลการชำระเงิน
          paymentMethod: paymentMethod,
          paymentInfo: {
            received: true,
            method: paymentMethod,
            amount: totalVal,
            timestamp: new Date().toISOString()
          },
    
          // ข้อมูลการดำเนินงาน
          invoiceType: invoiceType,
          saleType: saleType, // บ่งบอกว่าเป็นขายสด
          transactionType: 'sale',
          branch_code: BRANCH_CODE,
          staffId: staffId,
          staffName: currentStaffName,
    
          // ข้อมูลโปรโมชั่น
          appliedPromotions: usedPromotions,
    
          // Timestamp
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
    
        // สร้างรูปแบบเลขที่เอกสารที่ต้องการ
        const now = new Date();
        const yearBE = now.getFullYear() + 543; // แปลงเป็นปี พ.ศ.
        const yearShort = yearBE.toString().slice(-2); // เอาแค่ 2 หลักสุดท้าย
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const datePrefix = `${yearShort}${month}${day}`; // 680811
    
        // เพิ่มข้อมูลรูปแบบเลขที่เอกสารสำหรับทั้งสองเอกสาร
        const documentNumberFormat = {
          receiptPrefix: 'RE',
          taxInvoicePrefix: 'TX',
          dateFormat: datePrefix,
          // backend ควรจะใช้ข้อมูลนี้ในการสร้างเลขที่ เช่น RE-680811-0001 และ TX-680811-0001
        };
    
        // ใช้ payload เดียวสำหรับ API /api/taxinvoice/checkout ซึ่งจะสร้างเลขที่เอกสารให้
        const payload = {
          ...basePayload,
          documentNumberFormat: documentNumberFormat,
          // เพิ่ม depositReceiptId ถ้ามาจากใบมัดจำ
          depositReceiptId: window.depositReceiptInfo?.depositReceiptId || null,
          // เพิ่ม branchCode สำหรับ API delivery-note (ใช้ camelCase)
          branchCode: BRANCH_CODE,
          branchName: localStorage.getItem('activeBranchName') || 'สาขาหลัก'
        };

        // (4) เรียก API checkout ใหม่ที่ใช้ TaxInvoice/Receipt models
        console.log('🔧 Staff Info Debug:', {
          staffId: staffId,
          staffNameFromStorage: staffNameFromStorage,
          globalStaffName: staffName,
          currentStaffName: currentStaffName
        });
    
        // Debug payload โดยเฉพาะ staffName
        console.log('📋 Payload Debug - Staff Info:', {
          'payload.staffName': payload.staffName,
          'payload.staffId': payload.staffId,
          'typeof payload.staffName': typeof payload.staffName,
          'staffName isEmpty': !payload.staffName
        });
    
        console.log('📋 Document Number Format:', documentNumberFormat);
        console.log('Sending checkout payload:', JSON.stringify(payload, null, 2));

        // ✅ ตรวจสอบว่ามาจาก DepositReceipt หรือ frontstore โดยตรง
        let rs;
        let apiEndpoint;

        // ตรวจสอบจาก sessionStorage หรือ URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const hasReceiptParam = urlParams.has('receipt'); // ถ้ามี receipt parameter แสดงว่ามาจาก deposit
        const sourceFromSession = sessionStorage.getItem('checkoutSource');
        const sourceType = sourceFromSession || (hasReceiptParam ? 'deposit' : 'direct');

        console.log('🔍 Checkout Source:', sourceType, '(from session:', sourceFromSession, ', has receipt param:', hasReceiptParam, ')');

        if (sourceType === 'deposit') {
          // มาจาก DepositReceipt → สร้างใบส่งของและตัดสต็อก
          apiEndpoint = '/api/delivery-note/create-from-sale';
          console.log('📦 สร้างใบส่งของผ่าน:', apiEndpoint);
        } else {
          // มาจาก frontstore โดยตรง → สร้างใบเสร็จ/ใบกำกับภาษี
          apiEndpoint = '/api/taxinvoice/checkout';
          console.log('🧾 บันทึกเอกสารผ่าน:', apiEndpoint);
        }
    
        // ตั้งค่า Authorization ให้ตรงกับ middleware ของปลายทาง
        const requestHeaders = { 'Content-Type': 'application/json' };
        // ใช้ Bearer token สำหรับทุก API endpoints
        requestHeaders.Authorization = 'Bearer ' + token;

        // Calculate cart total
        const cartTotal = cartItems.reduce((sum, item) => sum + (item.price * item.qty), 0);

        // Validate checkout data before sending
        const validation = validateCheckoutData({
          items: cartItems,
          totalAmount: parseFloat(cartTotal),
          paymentMethod: selectedPaymentMethod,
          customer: selectedCustomer
        });

        if (!validation.isValid) {
          showToast('ข้อมูลการชำระเงินไม่ถูกต้อง: ' + validation.errors.join(', '), 'error');
          return;
        }

        const fetchResult = await safeFetch(apiEndpoint, {
          method: 'POST',
          headers: requestHeaders,
          body: JSON.stringify(payload),
          timeout: 30000,
          maxRetries: 2,
          useCache: false
        });

        const js = fetchResult;
        if (!js.success) {
          const errorMsg = sourceType === 'deposit' ? '❌ สร้างใบส่งของไม่สำเร็จ' : '❌ บันทึกเอกสารไม่สำเร็จ';
          throw new Error(js.error || `${errorMsg} (Server Response)`);
        }

        // (5) แสดง success และเปิดเอกสาร
        console.log('📋 API Response:', js);
        console.log('📋 Response Keys:', Object.keys(js));
        if (js.data) {
          console.log('📋 Response Data Keys:', Object.keys(js.data));
        }

        let document_id, document_number, docTypeText, successMessage;
        let stockDeductions = [];
        let receiptData, taxInvoiceData, documentsCreated;

        if (sourceType === 'deposit') {
          // ใบส่งของ
          const deliveryData = js.data || js;
          console.log('📦 Delivery Note Data:', deliveryData);

          const deliveryNote = deliveryData.deliveryNote;
          stockDeductions = deliveryData.stockDeductions || [];

          document_id = deliveryNote?.id;
          document_number = deliveryNote?.documentNumber || '';
          docTypeText = 'ใบส่งของ';

          successMessage = `✅ สร้างใบส่งของสำเร็จ!\n📦 เลขที่: ${document_number}\n`;
          if (stockDeductions.length > 0) {
            successMessage += `🔄 ตัดสต็อก: ${stockDeductions.length} รายการ`;
          }
        } else {
          // ใบเสร็จ/ใบกำกับภาษี
          const documentData = js.data || js;
          console.log('📋 Document Data:', documentData);

          receiptData = documentData.receipt;
          taxInvoiceData = documentData.taxInvoice;
          documentsCreated = documentData.documentsCreated || {};

          const primaryDoc = taxInvoiceData || receiptData;
          document_id = primaryDoc?.id;
          document_number = primaryDoc?.documentNumber || '';
          docTypeText = 'ใบกำกับภาษี';

          successMessage = '✅ บันทึกเอกสารทั้งสองใบสำเร็จ!\n';
          if (documentsCreated.receiptNumber) {
            successMessage += `📄 ใบเสร็จรับเงิน: ${documentsCreated.receiptNumber}\n`;
          }
          if (documentsCreated.taxInvoiceNumber) {
            successMessage += `🧾 ใบกำกับภาษี: ${documentsCreated.taxInvoiceNumber}`;
          }

          if (!documentsCreated.receiptNumber && !documentsCreated.taxInvoiceNumber) {
            successMessage = '✅ บันทึกใบเสร็จรับเงินและใบกำกับภาษีสำเร็จ!';
          }
        }

        showToast(successMessage, 'success');

        // POS Notification - Checkout Success
        if (posNotificationSystem) {
          if (sourceType === 'deposit') {
            // ใบส่งของ
            let notificationMessage = `สร้างใบส่งของสำเร็จ:\n`;
            notificationMessage += `📦 ${document_number}\n`;

            if (stockDeductions.length > 0) {
              notificationMessage += `\n🔄 ตัดสต็อก: ${stockDeductions.length} รายการ\n`;
            }

            notificationMessage += `💰 ยอดรวม ฿${formatPrice(totalVal)}`;

            posNotificationSystem.showToast('pos', {
              title: 'สร้างใบส่งของสำเร็จ! 🎉',
              message: notificationMessage,
              type: 'success',
              icon: '📦',
              duration: 5000
            });

            posNotificationSystem.addNotification('pos', {
              title: 'การขายเสร็จสิ้น - สร้างใบส่งของและตัดสต็อก',
              message: `ใบส่งของ ${document_number} - ฿${formatPrice(totalVal)} (${selectedPaymentMethod})`,
              type: 'success',
              icon: '📦',
              actions: [
                {
                  label: 'ดูใบส่งของ',
                  action: 'primary',
                  callback: () => {
                    const viewUrl = `/DeliveryNotePDF?id=${document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                }
              ],
              metadata: {
                documentId: document_id,
                documentNumber: document_number,
                documentType: 'delivery_note',
                totalAmount: totalVal,
                paymentMethod: selectedPaymentMethod,
                itemCount: cartItems.length,
                stockDeductions: stockDeductions.length,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          } else {
            // ใบเสร็จ/ใบกำกับภาษี
            let notificationMessage = 'สร้างเอกสารทั้งสองใบสำเร็จ:\n';
            if (documentsCreated.receiptNumber) {
              notificationMessage += `📄 ใบเสร็จ ${documentsCreated.receiptNumber}\n`;
            }
            if (documentsCreated.taxInvoiceNumber) {
              notificationMessage += `🧾 ใบกำกับภาษี ${documentsCreated.taxInvoiceNumber}\n`;
            }

            if (!documentsCreated.receiptNumber && !documentsCreated.taxInvoiceNumber) {
              notificationMessage = 'สร้างใบเสร็จรับเงินและใบกำกับภาษีสำเร็จ\n';
            }

            notificationMessage += `💰 ยอดรวม ฿${formatPrice(totalVal)}`;

            posNotificationSystem.showToast('pos', {
              title: 'บันทึกเอกสารสำเร็จ! 🎉',
              message: notificationMessage,
              type: 'success',
              icon: '💰',
              duration: 5000
            });

            posNotificationSystem.addNotification('pos', {
              title: 'การขายเสร็จสิ้น - สร้างเอกสารทั้งสองใบ',
              message: `สร้างทั้งใบเสร็จและใบกำกับภาษี - ฿${formatPrice(totalVal)} (${selectedPaymentMethod})`,
              type: 'success',
              icon: '🧾',
              actions: [
                {
                  label: 'ดูใบกำกับภาษี',
                  action: 'primary',
                  callback: () => {
                    const viewUrl = `/api/pdf/a4-tax-invoice-fixed/${taxInvoiceData?.id || document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                },
                {
                  label: 'ดูใบเสร็จรับเงิน',
                  action: 'secondary',
                  callback: () => {
                    const viewUrl = `/api/pdf/a4-receipt/${receiptData?.id || document_id}`;
                    window.open(viewUrl, '_blank');
                  }
                }
              ],
              metadata: {
                documentId: document_id,
                documentNumber: document_number,
                documentType: invoiceType,
                totalAmount: totalVal,
                paymentMethod: selectedPaymentMethod,
                itemCount: cartItems.length,
                timestamp: new Date().toLocaleString('th-TH')
              }
            });
          }
        }

        // เปิดเอกสารในแท็บใหม่
        if (sourceType === 'deposit') {
          console.log('📦 Opening delivery note PDF...');
          const deliveryNoteUrl = `/DeliveryNotePDF?id=${document_id}`;
          window.open(deliveryNoteUrl, '_blank');
          console.log(`✅ Delivery note opened: ${deliveryNoteUrl}`);
        } else {
          console.log('🖨️ Opening tax invoice/receipt...');
          const primaryDoc = taxInvoiceData || receiptData;
          const receiptImage = primaryDoc?.receiptImage || primaryDoc?.taxInvoiceImage || js.data?.pdfFile;
          if (receiptImage) {
            const printResult = await printReceiptOnClient(receiptImage);
            if (printResult && printResult.success) {
              console.log(`✅ ${docTypeText} printed successfully`);
            } else {
              console.warn(`⚠️ ${docTypeText} printing failed but saved to database:`, printResult?.error);
            }
          } else {
            console.warn('⚠️ No document image received from server');
            if (typeof showToast === 'function') {
              showToast(`⚠️ ${docTypeText}บันทึกสำเร็จแล้ว แต่เซิร์ฟเวอร์ไม่ได้ส่งไฟล์กลับมา`, 'warning');
            }
          }
        }

        // บันทึกการใช้โปรโมชั่น (ถ้ามี)
        if (usedPromotions && usedPromotions.length > 0) {
          for (const promo of usedPromotions) {
            await recordPromotionUsage(promo.id);
          }
        }

        // (6) บันทึก audit log
        if (sourceType === 'deposit') {
          logAuditEvent('DELIVERY_NOTE_CREATED', {
            transactionId,
            deliveryNoteId: document_id,
            documentNumber: document_number,
            documentType: 'delivery_note',
            totalAmount: totalVal,
            itemCount: cartItems.length,
            paymentMethod: selectedPaymentMethod,
            stockDeductions: stockDeductions.length,
            customerType: customerType,
            apiEndpoint: apiEndpoint
          }, 'SUCCESS');
        } else {
          logAuditEvent('DOCUMENT_SAVE_SUCCESS', {
            transactionId,
            documentId: document_id,
            documentNumber: document_number,
            documentType: invoiceType,
            totalAmount: totalVal,
            itemCount: cartItems.length,
            paymentMethod: selectedPaymentMethod,
            promotionsUsed: usedPromotions.length,
            customerType: customerType,
            apiEndpoint: apiEndpoint
          }, 'SUCCESS');
        }

        // ล้าง sessionStorage checkoutSource
        sessionStorage.removeItem('checkoutSource');

        // (7) เคลียร์ตะกร้าและข้อมูลลูกค้า
        cartItems = [];
        hiddenProductIds.clear();
        appliedPromotions = {};
        clearPromotionCache();
        renderCart();

        // รีเฟรช Level 3 ถ้าเปิดอยู่
        const lvl3 = document.getElementById('level3Container');
        if (!lvl3.classList.contains('hidden')) {
          const base = document.getElementById('level3Title').textContent.replace('รายละเอียดสินค้า: ', '');
          renderLevel3(level2Groups[base]);
        }

        // ✅ Fix: เคลียร์ฟอร์มลูกค้าแบบ null-safe
        const personalFields = document.getElementById('personalFields');
        if (personalFields) {
          personalFields.querySelectorAll('input, select').forEach(field => field.value = '');
          personalFields.classList.remove('hidden');
        }
    
        // เคลียร์ฟิลด์วันเกิดและอายุ
        const birthDateField = document.getElementById('customerBirthDate');
        const ageField = document.getElementById('customerAge');
        if (birthDateField) birthDateField.value = '';
        if (ageField) ageField.value = '';
    
        const corporateFields = document.getElementById('corporateFields');
        if (corporateFields) {
          corporateFields.querySelectorAll('input').forEach(input => input.value = '');
          corporateFields.classList.add('hidden');
        }
    
        const customerTypeSelect = document.getElementById('customerType');
        if (customerTypeSelect) {
          customerTypeSelect.value = 'individual';
        }
    
        const discountField = document.getElementById('discount');
        if (discountField) {
          discountField.value = '';
        }
    
        // ✅ Fix: รีเซ็ต checkbox อีเมลแบบ null-safe
        const sendEmailCheckbox = document.getElementById('sendEmailReceipt');
        if (sendEmailCheckbox) {
          sendEmailCheckbox.checked = true;
        }
        updateEmailStatus();
        // รีเฟรชสถานะระบบอีเมล
        updateEmailServiceIndicator();

      } catch (err) {
        logAuditEvent('CHECKOUT_FAILED', {
          transactionId,
          error: err.message,
          stack: err.stack
        }, 'ERROR');
        showToast(`❌ Error: ${err.message}`, 'danger');
        console.error('Checkout error:', err);
    
        // POS Notification - Checkout Error
        if (posNotificationSystem) {
          posNotificationSystem.showToast('pos', {
            title: 'ชำระเงินไม่สำเร็จ',
            message: `เกิดข้อผิดพลาด: ${err.message}`,
            type: 'error',
            icon: '❌',
            duration: 8000
          });
    
          posNotificationSystem.addNotification('pos', {
            title: 'ข้อผิดพลาดการชำระเงิน',
            message: err.message,
            type: 'error',
            icon: '🚨',
            actions: [
              {
                label: 'ลองใหม่',
                action: 'primary',
                callback: () => {
                  document.getElementById('btnSingleCheckout')?.click();
                }
              },
              {
                label: 'ติดต่อช่วยเหลือ',
                action: 'secondary',
                callback: () => {
                  console.log('📞 ติดต่อช่วยเหลือ');
                }
              }
            ],
            metadata: {
              error: err.message,
              transactionId: transactionId,
              timestamp: new Date().toLocaleString('th-TH')
            }
          });
        }
      } finally {
        // Hide loading
        showLoading(false);
        // 🔓 ปล่อย transaction lock เสมอ
        releaseTransactionLock(transactionId);
      }
    }



    // ✅ ฟังก์ชันเติมข้อมูลลูกค้าจากบัตรประชาชน (Global Scope) - ปรับปรุงให้รองรับที่อยู่
    window.fillCustomerDataFromCard = function(cardData) {
      console.log('🔄 เติมข้อมูลลูกค้าจากบัตร:', cardData);
      console.log('🔍 ตรวจสอบ properties:', Object.keys(cardData));
    
      try {
        // ข้อมูลพื้นฐาน - ลองหลายๆ property name
        const citizenId = cardData.citizenId || cardData.Citizenid || cardData.CitizenId || cardData.id || '';
        const firstNameTh = cardData.firstNameTh || cardData.FirstNameTh || cardData.firstname || cardData.firstName || '';
        const lastNameTh = cardData.lastNameTh || cardData.LastNameTh || cardData.lastname || cardData.lastName || '';
        const titleTh = cardData.titleTh || cardData.TitleTh || cardData.title || cardData.prefix || '';
    
        // ข้อมูลที่อยู่ - รองรับหลายรูปแบบจากบัตรจริง
        const address = cardData.address || cardData.Address || cardData.addr || cardData.fullAddress || '';
        const district = cardData.district || cardData.District || cardData.amphoe || cardData.Amphoe || '';
        const subDistrict = cardData.subDistrict || cardData.SubDistrict || cardData.tambon || cardData.Tambon || '';
        const province = cardData.province || cardData.Province || cardData.changwat || cardData.Changwat || '';
        const village = cardData.village || cardData.Village || cardData.moo || cardData.Moo || '';
        const houseNumber = cardData.houseNumber || cardData.HouseNumber || cardData.houseNo || cardData.HouseNo || '';
    
        // ข้อมูลวันเกิดและอายุ
        const birthDate = cardData.birthDate || cardData.BirthdayEn || cardData.birthday ||
                         cardData.dateOfBirth || cardData.Birthday || cardData.BirthDate || '';
        const age = cardData.age || cardData.Age || cardData.AGE || '';
    
        console.log('📋 ข้อมูลที่แยกได้จากบัตรจริง:');
        console.log('  - เลขบัตรประชาชน:', citizenId);
        console.log('  - คำนำหน้า:', titleTh);
        console.log('  - ชื่อ:', firstNameTh);
        console.log('  - นามสกุล:', lastNameTh);
        console.log('  - วันเกิด:', birthDate);
        console.log('  - อายุ:', age);
        console.log('  - ที่อยู่เต็ม:', address);
        console.log('  - เลขที่บ้าน:', houseNumber);
        console.log('  - หมู่ที่:', village);
        console.log('  - ตำบล:', subDistrict);
        console.log('  - อำเภอ:', district);
        console.log('  - จังหวัด:', province);
    
        // Debug: แสดงข้อมูลดิบทั้งหมดจากบัตร
        console.log('🔍 Raw card data keys:', Object.keys(cardData));
        console.log('🔍 Raw card data:', cardData);
    
        // วิเคราะห์ข้อมูลที่อยู่อัตโนมัติ
        if (typeof window.analyzeRealCardData === 'function') {
          const analysis = window.analyzeRealCardData(cardData);
          console.log('📊 Address analysis result:', analysis);
        }
    
        // เติมข้อมูลพื้นฐาน
        const basicFields = {
          'customerPrefix': titleTh,
          'customerFirstName': firstNameTh,
          'customerLastName': lastNameTh,
          'customerTaxId': citizenId,
          'customerAge': age
        };
    
        let filledCount = 0;
        Object.entries(basicFields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log(`✅ เติม ${fieldId}:`, value);
          }
        });
    
        // จัดการวันเกิด (แปลงรูปแบบถ้าจำเป็น)
        if (birthDate) {
          const birthDateField = document.getElementById('customerBirthDate');
          if (birthDateField) {
            let formattedDate = birthDate;
            if (birthDate.includes('/')) {
              const parts = birthDate.split('/');
              if (parts.length === 3) {
                formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
              }
            }
            birthDateField.value = formattedDate;
            birthDateField.dispatchEvent(new Event('input', { bubbles: true }));
            birthDateField.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('✅ เติมวันเกิด:', formattedDate);
          }
        }
    
        // ✅ จัดการข้อมูลที่อยู่อย่างละเอียด
        console.log('🏠 กำลังประมวลผลข้อมูลที่อยู่...');
    
        // หา field ที่อยู่ทั้งหมด
        const addressFields = {
          houseNo: document.getElementById('houseNo'),
          moo: document.getElementById('moo'),
          province: document.getElementById('province'),
          district: document.getElementById('district'),
          subDistrict: document.getElementById('subDistrict'),
          zipcode: document.getElementById('zipcode')
        };
    
        // 1. เติมข้อมูลจากข้อมูลแยกย่อยจากบัตรจริงก่อน (แม่นยำกว่า)
    
        // เติมเลขที่บ้าน
        if (houseNumber && addressFields.houseNo && !addressFields.houseNo.value) {
          addressFields.houseNo.value = houseNumber;
          addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('✅ เติมเลขที่บ้าน (จากบัตร):', houseNumber);
        }
    
        // เติมหมู่ที่
        if (village && addressFields.moo && !addressFields.moo.value) {
          // ลองแยกตัวเลขหมู่ที่ออกมา
          const mooNumber = village.toString().replace(/[^\d]/g, '');
          if (mooNumber) {
            addressFields.moo.value = mooNumber;
            addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('✅ เติมหมู่ที่ (จากบัตร):', mooNumber);
          }
        }
    
        // เติมจังหวัด
        if (province && addressFields.province && !addressFields.province.value) {
          const cleanProvince = province.split('#')[0].trim().replace(/^จังหวัด/, '');
          addressFields.province.value = cleanProvince;
          addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('✅ เติมจังหวัด (จากบัตร):', cleanProvince);
        }
    
        // เติมอำเภอ
        if (district && addressFields.district && !addressFields.district.value) {
          const cleanDistrict = district.split('#')[0].trim().replace(/^อำเภอ/, '');
          addressFields.district.value = cleanDistrict;
          addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('✅ เติมอำเภอ (จากบัตร):', cleanDistrict);
        }
    
        // เติมตำบล
        if (subDistrict && addressFields.subDistrict && !addressFields.subDistrict.value) {
          const cleanSubDistrict = subDistrict.split('#')[0].trim().replace(/^ตำบล/, '');
          addressFields.subDistrict.value = cleanSubDistrict;
          addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
          filledCount++;
          console.log('✅ เติมตำบล (จากบัตร):', cleanSubDistrict);
        }
    
        // 2. หากยังไม่มีข้อมูลแยกย่อย ลองแยกจากที่อยู่เต็ม
        if (address && (!province || !district || !subDistrict || !village)) {
          console.log('🔍 ลองแยกข้อมูลจากที่อยู่เต็ม:', address);
    
          // ตรวจสอบรูปแบบที่ใช้ # เป็น delimiter (จากบัตรจริง)
          if (address.includes('#')) {
            console.log('🔍 พบรูปแบบ # delimiter - ใช้วิธีแยกแบบพิเศษ');
    
            // แยกด้วย # และลบ # ว่างออก
            const parts = address.split('#').filter(part => part.trim() !== '');
            console.log('📍 Parts after split:', parts);
    
            for (const part of parts) {
              const cleanPart = part.trim();
              if (!cleanPart) continue;
    
              // เลขที่บ้าน (ส่วนแรกที่เป็นตัวเลข)
              if (/^\d+(?:\/\d+)?/.test(cleanPart) && addressFields.houseNo && !addressFields.houseNo.value) {
                addressFields.houseNo.value = cleanPart;
                addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
                filledCount++;
                console.log('✅ เติมเลขที่บ้าน (# format):', cleanPart);
              }
    
              // หมู่ที่
              else if (cleanPart.includes('หมู่ที่') && addressFields.moo && !addressFields.moo.value) {
                const mooMatch = cleanPart.match(/หมู่ที่\s*(\d+)/);
                if (mooMatch) {
                  addressFields.moo.value = mooMatch[1];
                  addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('✅ เติมหมู่ที่ (# format):', mooMatch[1]);
                }
              }
    
              // ตำบล
              else if (cleanPart.includes('ตำบล') && addressFields.subDistrict && !addressFields.subDistrict.value) {
                const tambonName = cleanPart.replace('ตำบล', '').trim();
                if (tambonName) {
                  addressFields.subDistrict.value = tambonName;
                  addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('✅ เติมตำบล (# format):', tambonName);
                }
              }
    
              // อำเภอ
              else if (cleanPart.includes('อำเภอ') && addressFields.district && !addressFields.district.value) {
                const amphoeName = cleanPart.replace('อำเภอ', '').trim();
                if (amphoeName) {
                  addressFields.district.value = amphoeName;
                  addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('✅ เติมอำเภอ (# format):', amphoeName);
                }
              }
    
              // จังหวัด
              else if (cleanPart.includes('จังหวัด') && addressFields.province && !addressFields.province.value) {
                const provinceName = cleanPart.replace('จังหวัด', '').trim();
                if (provinceName) {
                  addressFields.province.value = provinceName;
                  addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
                  filledCount++;
                  console.log('✅ เติมจังหวัด (# format):', provinceName);
                }
              }
            }
          } else {
            // รูปแบบปกติ - ใช้ regex แบบเดิม
            console.log('🔍 ใช้รูปแบบ regex ปกติ');
    
            // แยกเลขที่บ้าน
            const houseNoMatch = address.match(/^(\d+[\\/\d-]*)/);
            if (houseNoMatch && addressFields.houseNo && !addressFields.houseNo.value) {
              addressFields.houseNo.value = houseNoMatch[1];
              addressFields.houseNo.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('✅ เติมเลขที่บ้าน:', houseNoMatch[1]);
            }
    
            // แยกหมู่ที่
            const mooMatch = address.match(/หมู่\s*(\d+)|หมู่ที่\s*(\d+)/);
            if (mooMatch && addressFields.moo && !addressFields.moo.value) {
              const mooNumber = mooMatch[1] || mooMatch[2];
              addressFields.moo.value = mooNumber;
              addressFields.moo.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('✅ เติมหมู่ที่:', mooNumber);
            }
    
            // แยกจังหวัด
            const provinceMatch = address.match(/จังหวัด([ก-๙\s]+?)(?:\s|$)/);
            if (provinceMatch && addressFields.province && !addressFields.province.value) {
              const provinceName = provinceMatch[1].trim();
              addressFields.province.value = provinceName;
              addressFields.province.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('✅ เติมจังหวัด:', provinceName);
            }
    
            // แยกอำเภอ
            const districtMatch = address.match(/อำเภอ([ก-๙\s]+?)(?:\s|จังหวัด|$)/);
            if (districtMatch && addressFields.district && !addressFields.district.value) {
              const districtName = districtMatch[1].trim();
              addressFields.district.value = districtName;
              addressFields.district.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('✅ เติมอำเภอ:', districtName);
            }
    
            // แยกตำบล
            const subDistrictMatch = address.match(/ตำบล([ก-๙\s]+?)(?:\s|อำเภอ|$)/);
            if (subDistrictMatch && addressFields.subDistrict && !addressFields.subDistrict.value) {
              const subDistrictName = subDistrictMatch[1].trim();
              addressFields.subDistrict.value = subDistrictName;
              addressFields.subDistrict.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
              console.log('✅ เติมตำบล:', subDistrictName);
            }
          }
    
          // แยกรหัสไปรษณีย์
          const zipcodeMatch = address.match(/(\d{5})(?:\s|$)/);
          if (zipcodeMatch && addressFields.zipcode && !addressFields.zipcode.value) {
            addressFields.zipcode.value = zipcodeMatch[1];
            addressFields.zipcode.dispatchEvent(new Event('change', { bubbles: true }));
            filledCount++;
            console.log('✅ เติมรหัสไปรษณีย์:', zipcodeMatch[1]);
          }
        }
    
        // แสดงผลลัพธ์
        if (typeof showToast === 'function') {
          if (filledCount > 0) {
            const addressCount = Object.values(addressFields).filter(field => field && field.value).length;
    
            if (addressCount >= 3) {
              // เติมที่อยู่ได้ครบ
              const message = `✅ เติมข้อมูลจากบัตรประชาชนสำเร็จ (${filledCount} ช่อง, รวมที่อยู่ ${addressCount}/5 ช่อง)`;
              showToast(message, 'success', 'เครื่องอ่านบัตร', 4000);
            } else if (addressCount > 0) {
              // เติมที่อยู่ได้บางส่วน
              const message = `⚠️ เติมข้อมูลพื้นฐานสำเร็จ แต่ที่อยู่ไม่ครบ (${addressCount}/5 ช่อง)`;
              showToast(message, 'warning', 'เครื่องอ่านบัตร', 5000);
    
              // แสดงคำแนะนำ
              setTimeout(() => {
                showToast('💡 ตรวจสอบ Console สำหรับข้อมูล debug', 'info', 'คำแนะนำ', 3000);
              }, 1000);
            } else {
              // ไม่มีที่อยู่เลย
              const message = `✅ เติมข้อมูลพื้นฐานสำเร็จ (${filledCount} ช่อง) แต่ไม่พบข้อมูลที่อยู่`;
              showToast(message, 'warning', 'เครื่องอ่านบัตร', 4000);
    
              // แสดงคำแนะนำ
              setTimeout(() => {
                showToast('💡 กรอกที่อยู่ด้วยตนเอง หรือตรวจสอบ Console', 'info', 'คำแนะนำ', 4000);
              }, 1000);
            }
          } else {
            showToast('⚠️ ไม่พบข้อมูลที่สามารถเติมได้', 'warning', 'เครื่องอ่านบัตร', 3000);
          }
        }
    
        return true;
    
      } catch (error) {
        console.error('❌ Error filling customer data from card:', error);
        if (typeof showToast === 'function') {
          showToast('❌ เกิดข้อผิดพลาดในการเติมข้อมูล', 'error', 'เครื่องอ่านบัตร');
        }
        return false;
      }
    };

    // ตรวจสอบระบบเครื่องอ่านบัตร
    function checkCardReaderSystem() {
      console.log('🔍 Checking Card Reader System...');
    
      const branchCode = BRANCH_CODE || '00000';
    
      // ตรวจสอบ CardReaderConfig
      if (!window.CardReaderConfig) {
        console.warn('❌ CardReaderConfig not loaded');
        return;
      }
    
      // ตรวจสอบ CardReaderService
      if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
        console.warn('❌ CardReaderService not loaded');
    
        // แสดง notification เตือน
        if (typeof showToast === 'function') {
          showToast(
            '⚠️ ระบบเครื่องอ่านบัตรไม่พร้อมใช้งาน',
            'warning',
            'การตรวจสอบระบบ',
            5000
          );
        }
        return;
      }
    
      // ตรวจสอบว่าสาขานี้เปิดใช้เครื่องอ่านบัตรหรือไม่
      const isEnabled = window.CardReaderConfig.isCardReaderEnabled(branchCode);
      console.log(`📱 Card Reader for branch ${branchCode}: ${isEnabled ? 'ENABLED' : 'DISABLED'}`);
    
      if (isEnabled) {
        const config = window.CardReaderConfig.getCardProxyUrls(branchCode);
        console.log(`📡 Available endpoints: ${config.totalCount}`);
    
        if (typeof showToast === 'function') {
          showToast(
            `✅ เครื่องอ่านบัตรพร้อมใช้งาน (${config.totalCount} endpoints)`,
            'success',
            'การตรวจสอบระบบ',
            3000
          );
        }
    
        // ตรวจสอบฟังก์ชันเติมข้อมูล
        const fillFunctionAvailable = typeof window.fillCustomerDataFromCard === 'function';
        console.log(`📝 fillCustomerDataFromCard available: ${fillFunctionAvailable}`);
    
        if (!fillFunctionAvailable) {
          console.warn('⚠️ fillCustomerDataFromCard function not available');
          if (typeof showToast === 'function') {
            showToast(
              '⚠️ ฟังก์ชันเติมข้อมูลลูกค้าไม่พร้อมใช้งาน',
              'warning',
              'การตรวจสอบระบบ',
              3000
            );
          }
        }
      } else {
        console.log(`❌ Card reader disabled for branch: ${branchCode}`);
    
        if (typeof showToast === 'function') {
          showToast(
            '⚠️ เครื่องอ่านบัตรไม่ได้เปิดใช้งานสำหรับสาขานี้',
            'warning',
            'การตรวจสอบระบบ',
            5000
          );
        }
      }
    }

    // อ่านบัตร ปชช. + removeLocalityPrefix()
    async function readCard() {
      console.log('readCard() ถูกเรียกแล้ว');  // <<< เพิ่มตรงนี้
      // ประกาศ loaderId ไว้ข้างนอก try block
      let loaderId = null;
    
      try {
        // ตรวจสอบการเชื่อมต่อกับเครื่องอ่านบัตรก่อน
        if (typeof showToast === 'function') {
          showToast('🔍 กำลังเชื่อมต่อเครื่องอ่านบัตรประชาชน...', 'info');
        }
    
        // Show loading
        showLoading(true);
    
        // ✅ ใช้ Multi-IP Card Reader Service ใหม่
        const branchCode = BRANCH_CODE || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
    
        // แสดงข้อมูล endpoints ที่จะลอง
        if (window.CardReaderConfig?.isCardReaderEnabled(branchCode)) {
          const cardProxyConfig = window.CardReaderConfig.getCardProxyUrls(branchCode);
          const endpointCount = cardProxyConfig.totalCount + 1; // +1 สำหรับ Server API
    
          if (typeof showToast === 'function') {
            showToast(
              `🔍 กำลังเชื่อมต่อเครื่องอ่านบัตร (${endpointCount} endpoints)...`,
              'info',
              'การเชื่อมต่อ'
            );
          }
        }
    
        // ตรวจสอบว่า CardReaderService พร้อมใช้งาน
        if (!window.CardReaderService || typeof window.CardReaderService.readCard !== 'function') {
          throw new Error('ระบบเครื่องอ่านบัตรไม่พร้อมใช้งาน กรุณาโหลดหน้าเว็บใหม่');
        }
    
        // ✅ ใช้ CardReaderService ที่รองรับหลายสาขาและหลาย IP
        const result = await window.CardReaderService.readCard({
          branchCode: branchCode,
          source: 'frontstore_pattani'
        });
    
        console.log('🔍 Multi-IP card reader response:', result);
    
        if (!result.success) {
          throw new Error(result.error || 'ไม่สามารถอ่านข้อมูลบัตรได้');
        }
    
        // แสดงข้อความสำเร็จพร้อมข้อมูล endpoint ที่ใช้
        if (typeof showToast === 'function' && result.usedEndpoint) {
          const endpointInfo = result.usedEndpoint;
          let successMessage = `✅ เชื่อมต่อเครื่องอ่านบัตรสำเร็จ ผ่าน ${endpointInfo.name}`;
    
          if (endpointInfo.attemptNumber > 1) {
            successMessage += ` (ลองครั้งที่ ${endpointInfo.attemptNumber}/${endpointInfo.totalAttempts})`;
          }
    
          showToast(successMessage, 'success', 'เครื่องอ่านบัตร', 4000);
        }
    
                 // เติมข้อมูลลูกค้าอัตโนมัติ
        if (result.data) {
          if (typeof window.fillCustomerDataFromCard === 'function') {
            window.fillCustomerDataFromCard(result.data);
          } else {
            console.error('❌ fillCustomerDataFromCard function not available in readCard');
          }
    
              // แสดงข้อความสำเร็จ
          const cardData = result.data;
          const customerName = `${cardData.titleTh || cardData.TitleTh || ''}${cardData.firstNameTh || cardData.FirstNameTh || ''} ${cardData.lastNameTh || cardData.LastNameTh || ''}`.trim();
    
                if (typeof showToast === 'function') {
            showToast(
              `✅ อ่านบัตรประชาชนสำเร็จ: ${customerName}`,
              'success',
              'เครื่องอ่านบัตร',
              5000
            );
          }
        }
    
        return result;
    
      } catch (err) {
        console.error('❌ readCard() error:', err);
    
        // จัดการ error messages ให้เป็นมิตรกับผู้ใช้
        let errorMessage = err.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ';
    
        // แปลง error messages ที่พบบ่อย
        if (errorMessage.includes('HTTP 500') || errorMessage.includes('Internal Server Error')) {
          errorMessage = 'เซิร์ฟเวอร์เครื่องอ่านบัตรมีปัญหา กรุณาติดต่อผู้ดูแลระบบ (Error 500)';
        } else if (errorMessage.includes('fetch')) {
          errorMessage = 'ไม่สามารถเชื่อมต่อเครื่องอ่านบัตรได้ กรุณาตรวจสอบการเชื่อมต่อ';
        } else if (errorMessage.includes('timeout')) {
          errorMessage = 'การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง';
        } else if (errorMessage.includes('SSL_PROTOCOL_ERROR') || errorMessage.includes('ERR_SSL')) {
          errorMessage = 'ปัญหาใบรับรองความปลอดภัย (SSL) กรุณาติดต่อผู้ดูแลระบบ';
        } else if (errorMessage.includes('CardReaderService')) {
          errorMessage = 'ระบบเครื่องอ่านบัตรไม่พร้อมใช้งาน กรุณาติดต่อผู้ดูแลระบบ';
        } else if (errorMessage.includes('ลองแล้ว 4 endpoint')) {
          errorMessage = 'เครื่องอ่านบัตรทุกตัวไม่สามารถใช้งานได้ กรุณาติดต่อผู้ดูแลระบบหรือกรอกข้อมูลด้วยตนเอง';
        }
    
        // ส่งการแจ้งเตือนไปยังระบบ monitoring (ถ้ามี)
        if (errorMessage.includes('HTTP 500') || errorMessage.includes('Internal Server Error')) {
          console.error('🚨 CRITICAL: Card Reader Service HTTP 500 Error detected');
    
          // ส่งข้อมูล error ไปยัง Firebase สำหรับ monitoring
          if (window.firebase && window.firebase.database) {
            try {
              const errorReport = {
                timestamp: new Date().toISOString(),
                error: 'Card Reader Service HTTP 500',
                branch: window.BRANCH_CODE || '00000',
                user: localStorage.getItem('userName') || 'unknown',
                details: err.message || 'Unknown HTTP 500 error'
              };
    
              window.firebase.database().ref('system-errors/card-reader').push(errorReport);
              console.log('📡 Error report sent to Firebase monitoring');
            } catch (firebaseError) {
              console.warn('⚠️ Failed to send error report to Firebase:', firebaseError);
            }
          }
        }
    
        if (typeof showToast === 'function') {
          showToast(`❌ ${errorMessage}`, 'error', 'เครื่องอ่านบัตร', 8000);
        }
    
        // ✅ เพิ่ม: แสดง manual entry form เมื่อ Card Reader ล้มเหลวทั้งหมด
        if (errorMessage.includes('ลองแล้ว') ||
            errorMessage.includes('ทุกตัวไม่สามารถใช้งานได้') ||
            errorMessage.includes('HTTP 500') ||
            errorMessage.includes('ไม่สามารถเชื่อมต่อ')) {
    
          console.log('🏷️ Showing manual entry form due to card reader failure');
    
          // รอ 3 วินาทีเพื่อให้ผู้ใช้อ่าน error message ก่อน
          setTimeout(() => {
            if (typeof showManualCustomerEntry === 'function') {
              showManualCustomerEntry();
            }
          }, 3000);
        }
    
        return {
          success: false,
          error: errorMessage
        };
      } finally {
        // Hide loading
        showLoading(false);
      }
    }







    // =================== LANGUAGE-INDEPENDENT GLOBAL BARCODE SCANNER ===================
    function findAndAddToCartByBarcode(barcode) {
      console.log(`กำลังค้นหาสินค้าด้วยบาร์โค้ด (ที่แปลงแล้ว): ${barcode}`);

      // ตรวจสอบว่ามีข้อมูลสต๊อกหรือไม่
      if (!approvedStocks || approvedStocks.length === 0) {
        showToast('ไม่พบข้อมูลสต๊อกสินค้า กรุณารอสักครู่แล้วลองใหม่', 'warning');
        return;
      }

      const product = approvedStocks.find(p => p.barcode === barcode || p.imei === barcode);
      if (product) {
        // ตรวจสอบว่าสินค้าอยู่ในตะกร้าแล้วหรือไม่ (สำหรับ IMEI)
        if (product.imei) {
          const inCart = cartItems.some(item => item.imei === product.imei);
          if (inCart) {
            showToast(`'${product.name}' (IMEI: ${product.imei}) มีอยู่ในตะกร้าแล้ว`, 'warning');
            return;
          }
        } else {
          // สำหรับสินค้าประเภท Quantity ตรวจสอบด้วยชื่อสินค้า
          const inCart = cartItems.some(item => item.name === product.name && !item.imei);
          if (inCart) {
            showToast(`'${product.name}' มีอยู่ในตะกร้าแล้ว`, 'warning');
            return;
          }
        }

        showToast(`พบสินค้า: ${product.name}`, 'info');
        addToCart(product._id, product.name, product.price, product.imei, product.taxType, product.model, product.poNumber, product.supplier);
      } else {
        showToast(`ไม่พบสินค้าสำหรับบาร์โค้ดนี้: ${barcode}`, 'error');
      }
    }

    function setupLanguageIndependentBarcodeListener() {
      let barcodeBuffer = '';
      let lastKeyTime = Date.now();
      const keycodeToCharMap = {
        'Digit0': '0', 'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4',
        'Digit5': '5', 'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9',
        'Numpad0': '0', 'Numpad1': '1', 'Numpad2': '2', 'Numpad3': '3', 'Numpad4': '4',
        'Numpad5': '5', 'Numpad6': '6', 'Numpad7': '7', 'Numpad8': '8', 'Numpad9': '9',
        'KeyA': 'A', 'KeyB': 'B', 'KeyC': 'C', 'KeyD': 'D', 'KeyE': 'E', 'KeyF': 'F',
        'KeyG': 'G', 'KeyH': 'H', 'KeyI': 'I', 'KeyJ': 'J', 'KeyK': 'K', 'KeyL': 'L',
        'KeyM': 'M', 'KeyN': 'N', 'KeyO': 'O', 'KeyP': 'P', 'KeyQ': 'Q', 'KeyR': 'R',
        'KeyS': 'S', 'KeyT': 'T', 'KeyU': 'U', 'KeyV': 'V', 'KeyW': 'W', 'KeyX': 'X',
        'KeyY': 'Y', 'KeyZ': 'Z',
        'Minus': '-', 'Equal': '=',
      };
      document.addEventListener('keydown', (event) => {
        if (event.target.isContentEditable || ['INPUT', 'TEXTAREA'].includes(event.target.tagName)) {
          return;
        }
        const currentTime = Date.now();
        const timeDiff = currentTime - lastKeyTime;
        lastKeyTime = currentTime;
        if (timeDiff > 100) {
          barcodeBuffer = '';
        }
        if (event.code === 'Enter') {
          if (barcodeBuffer.length > 2) {
            event.preventDefault();
            findAndAddToCartByBarcode(barcodeBuffer);
          }
          barcodeBuffer = '';
          return;
        }
        const char = keycodeToCharMap[event.code];
        if (char) {
          event.preventDefault();
          barcodeBuffer += char;
        }
      });
      console.log('✅ ระบบ Global Barcode Listener (ไม่ขึ้นกับภาษา) พร้อมใช้งาน');

      // 🔍 Audit Log - Barcode listener setup
      logAuditEvent('BARCODE_LISTENER_SETUP', {
        branchCode: BRANCH_CODE,
        listenerType: 'global_keyboard'
      }, 'INFO');
    }

    // 🔍 Error Handling for Audit Logging
    window.addEventListener('error', (event) => {
      logAuditEvent('JAVASCRIPT_ERROR', {
        error: event.error?.message || 'Unknown error',
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        branchCode: BRANCH_CODE
      }, 'ERROR');
    });

    window.addEventListener('unhandledrejection', (event) => {
      logAuditEvent('UNHANDLED_PROMISE_REJECTION', {
        reason: event.reason?.message || event.reason,
        stack: event.reason?.stack,
        branchCode: BRANCH_CODE
      }, 'ERROR');
    });

    // 🔍 Visibility Change (when user switches tabs)
    document.addEventListener('visibilitychange', () => {
      logAuditEvent('VISIBILITY_CHANGE', {
        hidden: document.hidden,
        branchCode: BRANCH_CODE,
        timestamp: new Date().toISOString()
      }, 'INFO');
    });

    // 🔍 Page Unload
    window.addEventListener('beforeunload', () => {
      logAuditEvent('PAGE_UNLOAD', {
        branchCode: BRANCH_CODE,
        sessionDuration: Date.now() - lastActionTime,
        cartItems: cartItems.length
      }, 'INFO');

      // ส่ง audit logs ที่เหลือก่อนออก
      flushAuditBuffer();
    });

    // ======================= END OF SCANNER LOGIC =======================

    // ======================= PRODUCT TO CART HELPER FUNCTION =======================
    
    /**
     * Helper function สำหรับเพิ่มสินค้าลงตะกร้าจากปุ่ม UI
     * @param {string} productId - ID ของสินค้า
     * @param {string} productName - ชื่อสินค้า
     * @param {number} price - ราคาสินค้า
     * @param {string} imei - เลข IMEI (ถ้ามี)
     * @param {string} taxType - ประเภทภาษี
     * @param {string} model - รุ่นสินค้า
     * @param {string} poNumber - เลข PO
     * @param {string} supplier - ผู้จำหน่าย
     */
    async function addProductToCart(productId, productName, price, imei = '', taxType = '', model = '', poNumber = '', supplier = '') {
      try {
        // ตรวจสอบข้อมูลพื้นฐาน
        if (!productId || !productName || !price) {
          console.error('❌ Invalid product data:', { productId, productName, price });
          showToast('❌ ข้อมูลสินค้าไม่ครบถ้วน', 'error');
          return;
        }

        // หาข้อมูลสินค้าใน approvedStocks เพื่อรับ taxType ที่ถูกต้อง
        const stockItem = approvedStocks.find(item => item._id === productId);
        if (!stockItem) {
          console.error('❌ Product not found in approved stocks:', productId);
          showToast('❌ ไม่พบสินค้าในระบบ', 'error');
          return;
        }

        // ใช้ข้อมูลจาก stockItem เป็นหลัก
        const finalTaxType = stockItem.taxType || taxType || 'ไม่มีภาษี';
        const finalModel = stockItem.model || model || '';
        const finalPoNumber = stockItem.poNumber || poNumber || '';
        const finalSupplier = stockItem.supplier || supplier || '';

        console.log('🛒 Adding product to cart:', {
          productId,
          productName,
          price,
          imei: imei || '(no IMEI)',
          taxType: finalTaxType,
          stockType: stockItem.stockType || 'imei'
        });

        // เรียกฟังก์ชัน addToCart() หลัก
        addToCart(
          productId,
          productName,
          price,
          imei,
          finalTaxType,
          finalModel,
          finalPoNumber,
          finalSupplier
        );

      } catch (error) {
        console.error('❌ Error in addProductToCart:', error);
        showToast(`❌ เกิดข้อผิดพลาด: ${error.message}`, 'error');
      }
    }

    // Make function globally available
    window.addProductToCart = addProductToCart;
    
    // ======== CARD READER RETRY MECHANISM ========
    
    // ตัวแปรสำหรับจัดการ retry
    let cardReaderRetryCount = 0;
    const maxRetries = 3;
    
    /**
     * ลอง readCard() ใหม่พร้อม exponential backoff
     */
    async function retryReadCard(retryNumber = 1) {
      if (retryNumber > maxRetries) {
        throw new Error(`ไม่สามารถอ่านบัตรได้หลังจากลอง ${maxRetries} ครั้ง กรุณากรอกข้อมูลด้วยตนเอง`);
      }
    
      console.log(`🔄 Card Reader Retry attempt ${retryNumber}/${maxRetries}`);
    
      // แสดงสถานะการลองใหม่
      if (typeof showToast === 'function') {
        showToast(`🔄 กำลังลองอ่านบัตรใหม่ครั้งที่ ${retryNumber}...`, 'info', 'เครื่องอ่านบัตร', 3000);
      }
    
      // รอตามแบบ exponential backoff (1s, 2s, 4s)
      const delay = Math.pow(2, retryNumber - 1) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    
      try {
        return await readCard();
      } catch (error) {
        console.warn(`❌ Retry ${retryNumber} failed:`, error.message);
    
        // ถ้าเป็น HTTP 500 หรือ network error ให้ลองใหม่
        if (error.message.includes('HTTP 500') ||
            error.message.includes('timeout') ||
            error.message.includes('Failed to fetch')) {
          return await retryReadCard(retryNumber + 1);
        }
    
        // ถ้าเป็น error อื่นที่ไม่ควร retry ให้ throw ทันที
        throw error;
      }
    }
    
    /**
     * ฟังก์ชันสำหรับ manual fallback เมื่อ Card Reader ล้มเหลว
     */
    function showManualCustomerEntry() {
      // ซ่อน toast ปัจจุบัน
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      // แสดง modal หรือ form สำหรับกรอกข้อมูลด้วยตนเอง
      if (typeof showToast === 'function') {
        const manualForm = `
          <div class="manual-entry-form">
            <h6 class="mb-3">🏷️ กรอกข้อมูลลูกค้าด้วยตนเอง</h6>
            <div class="form-group mb-2">
              <input type="text" id="manualTaxId" class="form-control" 
                     placeholder="เลขบัตรประชาชน (13 หลัก)" maxlength="13">
            </div>
            <div class="form-group mb-2">
              <input type="text" id="manualFirstName" class="form-control" 
                     placeholder="ชื่อ">
            </div>
            <div class="form-group mb-2">
              <input type="text" id="manualLastName" class="form-control" 
                     placeholder="นามสกุล">
            </div>
            <div class="form-group mb-3">
              <input type="text" id="manualPhone" class="form-control" 
                     placeholder="เบอร์โทรศัพท์">
            </div>
            <div class="d-flex gap-2">
              <button onclick="submitManualEntry()" class="btn btn-success btn-sm flex-1">
                ✅ บันทึกข้อมูล
              </button>
              <button onclick="tryCardReaderAgain()" class="btn btn-warning btn-sm">
                🔄 ลอง Card Reader อีกครั้ง
              </button>
            </div>
          </div>
        `;
    
        showToast(manualForm, 'info', 'กรอกข้อมูลด้วยตนเอง', 0); // 0 = ไม่หายไปเอง
      }
    }
    
    /**
     * บันทึกข้อมูลที่กรอกด้วยตนเอง
     */
    function submitManualEntry() {
      const taxId = document.getElementById('manualTaxId')?.value || '';
      const firstName = document.getElementById('manualFirstName')?.value || '';
      const lastName = document.getElementById('manualLastName')?.value || '';
      const phone = document.getElementById('manualPhone')?.value || '';
    
      // ตรวจสอบข้อมูลพื้นฐาน
      if (!taxId || !firstName || !lastName) {
        showToast('❌ กรุณากรอกข้อมูลให้ครบถ้วน', 'error', 'การกรอกข้อมูล', 5000);
        return;
      }
    
      // ตรวจสอบรูปแบบเลขบัตรประชาชน
      if (!/^\d{13}$/.test(taxId)) {
        showToast('❌ เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก', 'error', 'การกรอกข้อมูล', 5000);
        return;
      }
    
      // สร้างข้อมูลแบบเดียวกับที่ได้จาก Card Reader
      const manualCardData = {
        taxId: taxId,
        firstNameTh: firstName,
        lastNameTh: lastName,
        titleTh: 'นาย/นาง/นางสาว', // default
        phone: phone,
        source: 'manual_entry'
      };
    
      // เติมข้อมูลลูกค้าอัตโนมัติ
      if (typeof window.fillCustomerDataFromCard === 'function') {
        window.fillCustomerDataFromCard(manualCardData);
    
        // ซ่อน toast
        if (typeof hideAllToasts === 'function') {
          hideAllToasts();
        }
    
        showToast(`✅ บันทึกข้อมูลลูกค้าสำเร็จ: ${firstName} ${lastName}`, 'success', 'กรอกข้อมูลด้วยตนเอง', 5000);
      } else {
        showToast('❌ ไม่สามารถเติมข้อมูลลูกค้าได้ กรุณาติดต่อผู้ดูแลระบบ', 'error', 'การกรอกข้อมูล', 5000);
      }
    }
    
    /**
     * ลอง Card Reader อีกครั้งด้วย retry mechanism
     */
    async function tryCardReaderAgain() {
      // ซ่อน toast ปัจจุบัน
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      // รีเซ็ต retry counter
      cardReaderRetryCount = 0;
    
      try {
        const result = await retryReadCard(1);
    
        if (result && result.success && result.data) {
          const cardData = result.data;
    
          if (typeof window.fillCustomerDataFromCard === 'function') {
            window.fillCustomerDataFromCard(cardData);
          }
    
          showToast(
            `✅ อ่านบัตรประชาชนสำเร็จ: ${cardData.titleTh || ''}${cardData.firstNameTh || ''} ${cardData.lastNameTh || ''}`,
            'success',
            'เครื่องอ่านบัตร',
            5000
          );
        }
      } catch (error) {
        console.error('❌ Card Reader retry failed:', error);
        showToast(`❌ ${error.message}`, 'error', 'เครื่องอ่านบัตร', 8000);
    
        // แสดง manual entry form อีกครั้ง
        setTimeout(() => showManualCustomerEntry(), 2000);
      }
    }
    
    /**
     * ตรวจสอบสถานะ Card Reader Service
     */
    async function checkCardReaderStatus() {
      console.log('🔍 Checking Card Reader Service status...');
    
      try {
        const response = await fetch('/api/cardreader/status', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
          },
          timeout: 5000
        });
    
        if (response.ok) {
          const status = await response.json();
          console.log('✅ Card Reader Service status:', status);
          return status;
        } else {
          console.warn('⚠️ Card Reader Service status check failed:', response.status);
          return { online: false, error: `HTTP ${response.status}` };
        }
      } catch (error) {
        console.warn('⚠️ Card Reader Service status check error:', error.message);
        return { online: false, error: error.message };
      }
    }
    
    /**
     * แสดงสถานะ Card Reader บนหน้าจอ
     */
    function updateCardReaderStatusDisplay(status) {
      const statusElement = document.getElementById('cardReaderStatus');
    
      if (!statusElement) {
        // ถ้าไม่มี element สำหรับแสดงสถานะ ไม่ต้องทำอะไร
        return;
      }
    
      if (status.online) {
        statusElement.innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            เครื่องอ่านบัตรพร้อมใช้งาน
          </div>
        `;
      } else {
        statusElement.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            เครื่องอ่านบัตรไม่พร้อมใช้งาน: ${status.error || 'Unknown error'}
            <br>
            <button onclick="checkCardReaderStatus().then(updateCardReaderStatusDisplay)" 
                    class="btn btn-sm btn-warning mt-2">
              🔄 ตรวจสอบใหม่
            </button>
          </div>
        `;
      }
    }
    
    /**
     * ตรวจสอบสถานะ Card Reader อัตโนมัติเมื่อโหลดหน้า
     */
    async function initCardReaderStatusMonitoring() {
      // ตรวจสอบสถานะครั้งแรก
      const status = await checkCardReaderStatus();
      updateCardReaderStatusDisplay(status);
    
      // ตรวจสอบสถานะทุก 2 นาที
      setInterval(async () => {
        const status = await checkCardReaderStatus();
        updateCardReaderStatusDisplay(status);
      }, 120000); // 2 minutes
    }
    
    /**
     * เรียกใช้ยูทิลิตี้ทดสอบทั้งหมด
     */
    async function runComprehensiveCardReaderDiagnostic() {
      console.log('🔍 รันการทดสอบ Card Reader แบบละเอียด...');
    
      const results = {
        timestamp: new Date().toISOString(),
        branch: window.BRANCH_CODE || '00000',
        results: {}
      };
    
      // Show loading
      showLoading(true);
    
      try {
        // 1. ทดสอบการเชื่อมต่อแต่ละ endpoint
        console.log('1️⃣ ทดสอบ individual endpoints...');
        if (window.cardReaderService && window.cardReaderService.getConfig) {
          const config = window.cardReaderService.getConfig(window.BRANCH_CODE || '00000');
          console.log('📡 Testing endpoints:', config.endpoints);
    
          for (let i = 0; i < config.endpoints.length; i++) {
            const endpoint = config.endpoints[i];
            console.log(`🔄 Testing endpoint ${i + 1}:`, endpoint.name);
    
            try {
              const startTime = Date.now();
              // ทดสอบ ping endpoint (ถ้ามี) หรือ head request
              const testUrl = endpoint.url.includes('/read-card')
                ? endpoint.url.replace('/read-card', '/ping')
                : endpoint.url;
    
              // For connectivity tests, use raw fetch with timeout
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 3000);

              const response = await fetch(testUrl, {
                method: 'HEAD',
                signal: controller.signal
              });
              clearTimeout(timeoutId);
              const duration = Date.now() - startTime;
    
              results.results[endpoint.name] = {
                status: response.status,
                duration: `${duration}ms`,
                success: response.ok
              };
    
              console.log(`✅ ${endpoint.name}: ${response.status} (${duration}ms)`);
            } catch (error) {
              results.results[endpoint.name] = {
                error: error.message,
                success: false
              };
              console.log(`❌ ${endpoint.name}: ${error.message}`);
            }
          }
        }
    
        // 2. ทดสอบ network connectivity
        console.log('2️⃣ ทดสอบ network connectivity...');
        try {
          const internetTest = await fetch('https://www.google.com/favicon.ico', {
            method: 'HEAD',
            timeout: 3000
          });
          results.internetConnectivity = internetTest.ok;
          console.log('🌐 Internet connectivity:', internetTest.ok ? '✅' : '❌');
        } catch (error) {
          results.internetConnectivity = false;
          console.log('🌐 Internet connectivity: ❌', error.message);
        }
    
        // 3. ทดสอบ local server APIs
        console.log('3️⃣ ทดสอบ local server APIs...');
        try {
          const serverTest = await fetch('/api/health', {
            method: 'GET',
            timeout: 3000
          });
          results.localServerHealth = {
            status: serverTest.status,
            success: serverTest.ok
          };
          console.log('🏠 Local server health:', serverTest.ok ? '✅' : '❌');
        } catch (error) {
          results.localServerHealth = {
            error: error.message,
            success: false
          };
          console.log('🏠 Local server health: ❌', error.message);
        }
    
        // 4. ทดสอบ CardReader Service configuration
        console.log('4️⃣ ทดสอบ CardReader configuration...');
        try {
          results.cardReaderConfig = {
            available: typeof window.cardReaderService !== 'undefined',
            branch: window.BRANCH_CODE || '00000',
            configLoaded: window.cardReaderService?.getConfig ? true : false
          };
    
          if (window.cardReaderService?.getConfig) {
            const config = window.cardReaderService.getConfig(window.BRANCH_CODE || '00000');
            results.cardReaderConfig.endpointCount = config.endpoints?.length || 0;
            results.cardReaderConfig.enabled = config.enabled || false;
          }
        } catch (error) {
          results.cardReaderConfig = { error: error.message };
        }
    
        // 5. สร้างรายงาน
        console.log('📋 การทดสอบแล้วเสร็จ - สร้างรายงาน...');
    
        const successCount = Object.values(results.results).filter(r => r.success).length;
        const totalCount = Object.keys(results.results).length;
    
        const report = `Card Reader Diagnostic Report
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏰ เวลา: ${new Date().toLocaleString('th-TH')}
🏢 สาขา: ${results.branch}
🌐 อินเทอร์เน็ต: ${results.internetConnectivity ? '✅ เชื่อมต่อได้' : '❌ เชื่อมต่อไม่ได้'}
🏠 เซิร์ฟเวอร์: ${results.localServerHealth?.success ? '✅ ปกติ' : '❌ มีปัญหา'}
📡 Endpoints: ${successCount}/${totalCount} OK
🔧 Configuration: ${results.cardReaderConfig?.available ? '✅' : '❌'}

📊 Endpoint Details:
${Object.entries(results.results).map(([name, result]) =>
  `   ${result.success ? '✅' : '❌'} ${name}: ${result.status || result.error} ${result.duration ? `(${result.duration})` : ''}`
).join('\n')}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
    
        console.log(report);
    
        // แสดงผลใน UI
        if (typeof showToast === 'function') {
          const overallStatus = results.internetConnectivity && results.localServerHealth?.success && successCount > 0 ? '✅' : '❌';
    
          showToast(`
            <div class="text-left">
              <h6 class="mb-2">🔍 Card Reader Diagnostic ${overallStatus}</h6>
              <div class="small mb-2">
                <div>🌐 Internet: ${results.internetConnectivity ? '✅' : '❌'}</div>
                <div>🏠 Server: ${results.localServerHealth?.success ? '✅' : '❌'}</div>
                <div>📡 Endpoints: ${successCount}/${totalCount} OK</div>
                <div>🔧 Config: ${results.cardReaderConfig?.available ? '✅' : '❌'}</div>
              </div>
              <div class="d-flex gap-2">
                <button onclick="navigator.clipboard.writeText(\`${report.replace(/`/g, '\\`')}\`).then(() => showToast('📋 รายงานถูกคัดลอกแล้ว', 'success', '', 2000))" class="btn btn-sm btn-secondary">
                  📋 Copy Report
                </button>
                <button onclick="window.open('data:text/plain;charset=utf-8,' + encodeURIComponent(\`${report.replace(/`/g, '\\`')}\`))" class="btn btn-sm btn-info">
                  📄 Export
                </button>
              </div>
            </div>
          `, overallStatus === '✅' ? 'success' : 'warning', 'Diagnostic Report', 20000);
        }
    
        return results;
    
      } finally {
        // Hide loading
        showLoading(false);
      }
    }
    
    /**
     * เพิ่มข้อมูลสถานะระบบในการแจ้งเตือน
     */
    function showSystemHealthStatus() {
      if (typeof showToast === 'function') {
        const healthStatus = `
          <div class="system-health">
            <h6 class="mb-3">🏥 สถานะระบบ</h6>
            <div class="status-grid">
              <div class="status-item">
                <strong>🔥 Firebase:</strong> ${window.firebase ? '✅ Connected' : '❌ Disconnected'}
              </div>
              <div class="status-item">
                <strong>🔌 Socket.IO:</strong> ${window.io && window.io.connected ? '✅ Connected' : '❌ Disconnected'}
              </div>
              <div class="status-item">
                <strong>🖨️ Printer:</strong> ${window.PrinterService ? '✅ Available' : '❌ Unavailable'}
              </div>
              <div class="status-item">
                <strong>🆔 Card Reader:</strong> <span id="cardReaderHealthStatus">🔍 Checking...</span>
              </div>
            </div>
            <div class="mt-3">
              <button onclick="location.reload()" class="btn btn-sm btn-primary">
                🔄 Reload Page
              </button>
            </div>
          </div>
        `;
    
        showToast(healthStatus, 'info', 'สถานะระบบ', 0);
    
        // อัพเดทสถานะ Card Reader แบบ real-time
        checkCardReaderStatus().then(status => {
          const healthElement = document.getElementById('cardReaderHealthStatus');
          if (healthElement) {
            healthElement.textContent = status.online ? '✅ Online' : '❌ Offline';
          }
        });
      }
    }
    
    // Make functions globally available
    window.retryReadCard = retryReadCard;
    window.showManualCustomerEntry = showManualCustomerEntry;
    window.submitManualEntry = submitManualEntry;
    window.tryCardReaderAgain = tryCardReaderAgain;
    window.checkCardReaderStatus = checkCardReaderStatus;
    window.updateCardReaderStatusDisplay = updateCardReaderStatusDisplay;
    window.showSystemHealthStatus = showSystemHealthStatus;
    window.runComprehensiveCardReaderDiagnostic = runComprehensiveCardReaderDiagnostic;
    
    // เริ่มต้น monitoring เมื่อโหลดหน้าเสร็จ
    document.addEventListener('DOMContentLoaded', function() {
      // รอ 3 วินาทีก่อนเริ่ม monitoring เพื่อให้ระบบโหลดเสร็จ
      setTimeout(initCardReaderStatusMonitoring, 3000);
    });

    // ======================= BARCODE INPUT PROCESSING =======================
    async function processBarcodeInput() {
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
      const barcodeProductInfo = document.getElementById('barcodeProductInfo');
    
      if (!barcodeInput) return;
    
      const barcode = barcodeInput.value.trim();
    
      if (!barcode) {
        showToast('กรุณาใส่บาร์โค้ดสินค้า', 'warning');
        barcodeInput.focus();
        return;
      }
    
      // Show loading state
      let loaderId = null;
      try {
        // Show loading
        showLoading(true);
    
        // 🔍 Audit Log - Barcode scan attempt
        logAuditEvent('BARCODE_SCAN_ATTEMPT', {
          branchCode: BRANCH_CODE,
          barcode: barcode,
          inputMethod: 'manual',
          timestamp: new Date().toISOString()
        }, 'INFO');
    
        // Rate limiting for barcode processing
        if (!checkRateLimit('barcode_process', 20, 60000)) {
          showToast('คุณสแกนบาร์โค้ดบน่อยเกินไป กรุณารอสักครู่', 'warning');
          return;
        }
    
        // Validate barcode format
        const sanitizedBarcode = sanitizeInput(barcode, 'text');
        if (sanitizedBarcode.length < 3) {
          showToast('บาร์โค้ดต้องมีอย่างน้อย 3 ตัวอักษร', 'warning');
          barcodeInput.focus();
          return;
        }
    
        // Check if stock data is available
        if (!approvedStocks || approvedStocks.length === 0) {
          showToast('ไม่พบข้อมูลสต๊อกสินค้า กรุณารอสักครู่แล้วลองใหม่', 'warning');
          return;
        }
    
        // Find product by barcode
        const product = approvedStocks.find(p =>
          p.barcode === sanitizedBarcode ||

          p.imei === sanitizedBarcode ||
          p.name.toLowerCase().includes(sanitizedBarcode.toLowerCase())
        );
    
        if (product) {
          // Check if product is already in cart
          let inCart = false;
          let cartMessage = '';
    
          if (product.imei) {
            // For IMEI products, check by IMEI
            inCart = cartItems.some(item => item.imei === product.imei);
            cartMessage = `'${product.name}' (IMEI: ${product.imei}) มีอยู่ในตะกร้าแล้ว`;
          } else {
            // For quantity products, check by name
            inCart = cartItems.some(item => item.name === product.name && !item.imei);
            cartMessage = `'${product.name}' มีอยู่ในตะกร้าแล้ว`;
          }
    
          if (inCart) {
            showToast(cartMessage, 'warning');
            barcodeResults.classList.add('hidden');
    
            // 🔍 Audit Log - Product already in cart
            logAuditEvent('BARCODE_SCAN_DUPLICATE', {
              branchCode: BRANCH_CODE,
              productId: product._id,
              productName: product.name,
              barcode: sanitizedBarcode
            }, 'WARNING');
    
            return;
          }
    
          // Show product found message
          barcodeProductInfo.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium">${product.name}</div>
                <div class="text-xs">ราคา: ฿${formatPrice(product.price)}</div>
                ${product.imei ? `<div class="text-xs">IMEI: ${product.imei}</div>` : ''}
                ${product.brand ? `<div class="text-xs">แบรนด์: ${product.brand}</div>` : ''}
              </div>
              <div class="text-right">
                <div class="badge badge-success">พบสินค้า</div>
                <div class="text-xs mt-1">บาร์โค้ด: ${sanitizedBarcode}</div>
              </div>
            </div>
          `;
          barcodeResults.classList.remove('hidden');
    
          // Add to cart
          addToCart(
            product._id,
            product.name,
            product.price,
            product.imei,
            product.taxType,
            product.model,
            product.poNumber,
            product.supplier
          );
    
          // Show success message
          showToast(`เพิ่มสินค้า '${product.name}' ลงตะกร้าแล้ว`, 'success');
    
          // Clear input after successful scan
          barcodeInput.value = '';
    
          // Auto-hide results after 3 seconds
          setTimeout(() => {
            barcodeResults.classList.add('hidden');
          }, 3000);
    
          // 🔍 Audit Log - Successful barcode scan
          logAuditEvent('BARCODE_SCAN_SUCCESS', {
            branchCode: BRANCH_CODE,
            productId: product._id,
            productName: product.name,
            barcode: sanitizedBarcode,
            price: product.price,
            cartCount: cartItems.length + 1
          }, 'SUCCESS');
    
          // Focus back to barcode input for next scan
          setTimeout(() => {
            barcodeInput.focus();
          }, 100);
    
        } else {
          // Product not found
          showToast(`ไม่พบสินค้าสำหรับบาร์โค้ด: ${sanitizedBarcode}`, 'error');
          barcodeResults.classList.add('hidden');
    
          // 🔍 Audit Log - Product not found
          logAuditEvent('BARCODE_SCAN_NOT_FOUND', {
            branchCode: BRANCH_CODE,
            barcode: sanitizedBarcode,
            stockCount: approvedStocks.length
          }, 'WARNING');
    
          // Focus back to input
          barcodeInput.focus();
          barcodeInput.select();
        }
    
      } catch (error) {
        console.error('❌ Barcode processing error:', error);
        showToast('เกิดข้อผิดพลาดในการประมวลผลบาร์โค้ด', 'error');
        barcodeResults.classList.add('hidden');
    
        // 🔍 Audit Log - Barcode processing error
        logAuditEvent('BARCODE_SCAN_ERROR', {
          branchCode: BRANCH_CODE,
          barcode: barcode,
          error: error.message,
          stack: error.stack
        }, 'ERROR');
    
      } finally {
        // Hide loading
        showLoading(false);
      }
    }
    
    // ======================= END OF BARCODE INPUT PROCESSING =======================

    // ======================= END OF SCANNER LOGIC =======================</script>

  <!-- Add modal HTML for confirmations before the closing </body> tag -->
  <input type="checkbox" id="confirmActionModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">ยืนยันการกระทำ</h3>
      <p class="py-4" id="confirmActionText">ข้อความยืนยันที่นี่</p>
      <div class="modal-action">
        <label for="confirmActionModal" class="btn btn-secondary" id="cancelActionBtn">ยกเลิก</label>
        <label for="confirmActionModal" class="btn btn-primary" id="okActionBtn">ตกลง</label>
      </div>
    </div>
  </div>
  <!-- Add customConfirm function and its event listeners -->
  <script>
    let pendingAction = null;
    function customConfirm(message, actionCallback) {
      document.getElementById('confirmActionText').textContent = message;
      pendingAction = actionCallback;
      document.getElementById('confirmActionModal').checked = true;
    }
    document.getElementById('okActionBtn').addEventListener('click', () => {
      if (pendingAction) pendingAction();
      pendingAction = null;
    });
    document.getElementById('cancelActionBtn').addEventListener('click', () => {
      pendingAction = null;
    });
  </script>

  <!-- Firebase Realtime Database Enhanced -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
      authDomain: "pheenongacc.firebaseapp.com",
      databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pheenongacc",
      storageBucket: "pheenongacc.appspot.com",
      messagingSenderId: "158417807357",
      appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
      measurementId: "G-F7DPQ7XG9K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // ข้อมูล session ปัจจุบัน
    const currentSession = {
      branchCode: window.BRANCH_CODE || 'PATTANI',
      sessionId: 'POS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      staffId: localStorage.getItem('userId'),
      staffName: localStorage.getItem('userName'),
      timestamp: Date.now()
    };

    // Firebase References
    const cartCountRef = ref(db, `pos/${currentSession.branchCode}/cart/count`);
    const sessionRef = ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}`);
    const stockUpdatesRef = ref(db, `pos/${currentSession.branchCode}/stockUpdates`);
    const salesRef = ref(db, `pos/${currentSession.branchCode}/sales`);
    const notificationsRef = ref(db, `pos/${currentSession.branchCode}/notifications`);
    const onlineUsersRef = ref(db, `pos/${currentSession.branchCode}/onlineUsers`);

    // ตัวแปรเก็บสถานะ
    let lastUpdateSource = null;
    let lastCartCount = 0;
    let isFirebaseConnected = false;

    // ตรวจสอบการเชื่อมต่อ Firebase
    const connectedRef = ref(db, '.info/connected');
    onValue(connectedRef, (snapshot) => {
      isFirebaseConnected = snapshot.val() === true;
      window.isFirebaseConnected = isFirebaseConnected;
      console.log('🔥 Firebase connection status:', isFirebaseConnected ? 'Connected' : 'Disconnected');
      
      // อัปเดต Firebase status indicator
      updateFirebaseStatus(isFirebaseConnected);
      
      if (isFirebaseConnected) {
        registerSession();
        setupOnDisconnect();
        
        if (typeof showToast === 'function') {
          showToast('🔥 เชื่อมต่อ Firebase สำเร็จ', 'success');
        }
        
        // แสดงสถานะในระบบแจ้งเตือน
        if (window.posNotificationSystem) {
          window.posNotificationSystem.showToast('pos', {
            title: 'Firebase เชื่อมต่อแล้ว',
            message: 'ระบบ Real-time Database พร้อมใช้งาน',
            type: 'success',
            icon: '🔥'
          });
        }
      } else {
        if (typeof showToast === 'function') {
          showToast('⚠️ การเชื่อมต่อ Firebase ขัดข้อง', 'warning');
        }
      }
      
      // อัปเดตสถานะรวม
      updateConnectionStatus();
    });

    // ลงทะเบียน session
    async function registerSession() {
      try {
        await set(sessionRef, {
          ...currentSession,
          status: 'online',
          lastActivity: serverTimestamp(),
          cartItems: window.cartItems?.length || 0,
          userAgent: navigator.userAgent,
          connectedAt: serverTimestamp()
        });
        
        // เพิ่มผู้ใช้ online
        await set(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`), {
          staffId: currentSession.staffId,
          staffName: currentSession.staffName,
          sessionId: currentSession.sessionId,
          connectedAt: serverTimestamp()
        });
        
        console.log('✅ Session registered to Firebase');
      } catch (error) {
        console.error('❌ Failed to register session:', error);
      }
    }

    // ตั้งค่า onDisconnect
    function setupOnDisconnect() {
      onDisconnect(sessionRef).set({
        ...currentSession,
        status: 'offline',
        lastActivity: serverTimestamp(),
        disconnectedAt: serverTimestamp()
      });
      
      onDisconnect(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
    }

    // ฟังการเปลี่ยนแปลง Cart Count
    onValue(cartCountRef, (snapshot) => {
      const count = snapshot.val() || 0;
      if (lastUpdateSource !== 'socket' && lastCartCount !== count) {
        updateCartCountDisplay(count, 'firebase');
        lastCartCount = count;
      }
      setTimeout(() => { lastUpdateSource = null; }, 100);
    });

    // ฟังการอัปเดต Stock
    onValue(stockUpdatesRef, (snapshot) => {
      const updates = snapshot.val();
      if (updates) {
        console.log('📦 Stock updates received from Firebase:', updates);
        
        // รีโหลดข้อมูลสต๊อก with throttling
        safeReloadStocks();
        
        if (typeof showToast === 'function') {
          showToast('📦 อัปเดตข้อมูลสต๊อกแล้ว', 'info');
        }
        
        // POS Notification
        if (window.posNotificationSystem) {
          window.posNotificationSystem.showToast('pos', {
            title: 'อัปเดตสต๊อก',
            message: 'ข้อมูลสต๊อกได้รับการอัปเดตจาก Firebase',
            type: 'info',
            icon: '📦'
          });
        }
      }
    });

    // ฟังการแจ้งเตือน
    onValue(notificationsRef, (snapshot) => {
      const notifications = snapshot.val();
      if (notifications) {
        Object.entries(notifications).forEach(([key, notification]) => {
          if (notification.timestamp > (Date.now() - 60000)) { // แจ้งเตือนใน 1 นาทีล่าสุด
            if (typeof showToast === 'function') {
              showToast(notification.message, notification.type || 'info');
            }
            
            if (window.posNotificationSystem) {
              window.posNotificationSystem.addNotification('pos', {
                title: notification.title || 'แจ้งเตือนจากระบบ',
                message: notification.message,
                type: notification.type || 'info',
                icon: notification.icon || '🔔',
                metadata: {
                  source: 'firebase',
                  firebaseKey: key,
                  timestamp: new Date().toLocaleString('th-TH')
                }
              });
            }
          }
        });
      }
    });

    // ฟังผู้ใช้ออนไลน์
    onValue(onlineUsersRef, (snapshot) => {
      const users = snapshot.val() || {};
      const onlineCount = Object.keys(users).length;
      console.log(`👥 Online users in ${currentSession.branchCode}:`, onlineCount);
      
      // อัปเดตตัวเลขผู้ใช้ออนไลน์ (ถ้ามี element)
      const onlineCountEl = document.getElementById('onlineUserCount');
      if (onlineCountEl) {
        onlineCountEl.textContent = onlineCount;
      }
    });

    // ฟังก์ชันอัปเดตการแสดงผล (ใช้ร่วมกัน)
    window.updateCartCountDisplay = function (count, source = 'local') {
      const el = document.getElementById("cartCount");
      if (el && el.textContent != count) {
        el.textContent = count;
        console.log(`📊 Cart count updated: ${count} (source: ${source})`);
      }
      lastUpdateSource = source;
      lastCartCount = count;
    };

    // ฟังก์ชันอัปเดต Firebase
    window.updateCartCountToFirebase = function (count) {
      if (!isFirebaseConnected) {
        console.warn('⚠️ Firebase not connected, skipping cart update');
        return;
      }
      
      if (lastCartCount !== count) {
        set(cartCountRef, count).then(() => {
          console.log('✅ Firebase cart count updated successfully');
          
          // อัปเดต session activity
          set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`), serverTimestamp());
          set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/cartItems`), count);
          
        }).catch(err => {
          console.error('❌ Firebase cart update error:', err);
          if (typeof showToast === 'function') {
            showToast('⚠️ ไม่สามารถอัปเดตข้อมูลได้', 'warning');
          }
        });
      }
    };

    // ฟังก์ชันส่งข้อมูลการขาย
    window.sendSaleToFirebase = function (saleData) {
      if (!isFirebaseConnected) {
        console.warn('⚠️ Firebase not connected, skipping sale sync');
        return;
      }

      const saleRef = push(salesRef);
      set(saleRef, {
        ...saleData,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode,
        timestamp: serverTimestamp(),
        syncedAt: Date.now()
      }).then(() => {
        console.log('✅ Sale data synced to Firebase');
      }).catch(err => {
        console.error('❌ Failed to sync sale data:', err);
      });
    };

    // ฟังก์ชันส่งแจ้งเตือน
    window.sendNotificationToFirebase = function (notification) {
      if (!isFirebaseConnected) return;

      const notifRef = push(notificationsRef);
      set(notifRef, {
        ...notification,
        branchCode: currentSession.branchCode,
        sessionId: currentSession.sessionId,
        timestamp: serverTimestamp(),
        createdAt: Date.now()
      }).then(() => {
        console.log('✅ Notification sent to Firebase');
      }).catch(err => {
        console.error('❌ Failed to send notification:', err);
      });
    };

    // ฟังก์ชันอัปเดต Activity
    window.updateActivity = function (activity) {
      if (!isFirebaseConnected) return;
      
      set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastActivity`), serverTimestamp());
      set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/currentActivity`), activity);
    };

    // ฟังก์ชันส่งข้อมูลการเปลี่ยนแปลงสต๊อก
    window.sendStockUpdateToFirebase = function (stockData) {
      if (!isFirebaseConnected) return;

      const updateRef = push(stockUpdatesRef);
      set(updateRef, {
        ...stockData,
        sessionId: currentSession.sessionId,
        branchCode: currentSession.branchCode,
        timestamp: serverTimestamp(),
        updatedAt: Date.now()
      });
    };

    // Heartbeat เพื่อรักษา session
    setInterval(() => {
      if (isFirebaseConnected) {
        set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/lastHeartbeat`), serverTimestamp());
      }
    }, 30000); // ทุก 30 วินาที

    // Cleanup เมื่อปิดหน้า
    window.addEventListener('beforeunload', () => {
      if (isFirebaseConnected) {
        set(ref(db, `pos/${currentSession.branchCode}/sessions/${currentSession.sessionId}/status`), 'offline');
        remove(ref(db, `pos/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`));
      }
    });

    // ฟังก์ชันอัปเดตสถานะการเชื่อมต่อ
    function updateFirebaseStatus(connected) {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        statusEl.className = connected ? 'w-2 h-2 rounded-full connected' : 'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 'Firebase: เชื่อมต่อแล้ว' : 'Firebase: ขัดข้อง';
      }
    }

    function updateSocketStatus(connected) {
      const statusEl = document.getElementById('socketStatus');
      if (statusEl) {
        statusEl.className = connected ? 'w-2 h-2 rounded-full connected' : 'w-2 h-2 rounded-full disconnected';
        statusEl.title = connected ? 'Socket.IO: เชื่อมต่อแล้ว' : 'Socket.IO: ขัดข้อง';
      }
    }

    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;

      const firebaseOk = window.isFirebaseConnected || false;
      const socketOk = window.socketConnected || false;

      if (firebaseOk && socketOk) {
        statusEl.className = 'connection-status online text-xs font-medium';
        statusEl.textContent = '🟢 ออนไลน์';
      } else if (!firebaseOk && !socketOk) {
        statusEl.className = 'connection-status offline text-xs font-medium';
        statusEl.textContent = '🔴 ออฟไลน์';
      } else {
        statusEl.className = 'connection-status connecting text-xs font-medium';
        statusEl.textContent = '🟡 เชื่อมต่อบางส่วน';
      }
    }

    // Export functions สำหรับให้ Socket.IO ใช้
    window.updateFirebaseStatus = updateFirebaseStatus;
    window.updateSocketStatus = updateSocketStatus;
    window.updateConnectionStatus = updateConnectionStatus;

    // เก็บข้อมูล session ไว้ใน window
    window.currentSession = currentSession;

    console.log('🔥 Firebase Realtime Database initialized with enhanced features');
    console.log('📱 Session ID:', currentSession.sessionId);
    console.log('🏢 Branch Code:', currentSession.branchCode);
  </script>

  <!-- Socket.IO Client Integration Enhanced -->
  <script>
    // เชื่อมต่อ Socket.IO พร้อม configuration
    const socket = io({
      timeout: 10000,
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      randomizationFactor: 0.5
    });

    let socketConnected = false;
    let reconnectAttempts = 0;
    let heartbeatInterval = null;

    socket.on('connect', () => {
      socketConnected = true;
      window.socketConnected = true;
      reconnectAttempts = 0;
      console.log('🔗 Socket.IO connected successfully');
      console.log('🆔 Socket ID:', socket.id);

      // อัปเดต Socket status indicator
      if (window.updateSocketStatus) {
        window.updateSocketStatus(true);
      }

      // ส่งข้อมูลสาขาไปยังเซิร์ฟเวอร์เพื่อ join room
      socket.emit('join_branch', {
        branchCode: window.BRANCH_CODE || window.currentBranchCode,
        sessionId: window.currentSession?.sessionId,
        staffId: localStorage.getItem('userId'),
        staffName: localStorage.getItem('userName'),
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      });

      if (typeof showToast === 'function') {
        showToast('🔗 เชื่อมต่อ Socket.IO สำเร็จ', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: 'ระบบเชื่อมต่อแล้ว',
          message: 'Socket.IO พร้อมใช้งาน',
          type: 'success',
          icon: '🔗'
        });
      }

      // เริ่ม heartbeat
      startHeartbeat();

      // ส่งแจ้งเตือนไป Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: 'Socket.IO เชื่อมต่อแล้ว',
          message: 'ระบบ real-time พร้อมใช้งาน',
          type: 'success',
          icon: '🔗',
          source: 'socket'
        });
      }

      // อัปเดตสถานะรวม
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    });

    socket.on('disconnect', (reason) => {
      socketConnected = false;
      window.socketConnected = false;
      console.log('❌ Socket.IO disconnected:', reason);
    
      // อัปเดต Socket status indicator
      if (window.updateSocketStatus) {
        window.updateSocketStatus(false);
      }
    
      let message = 'การเชื่อมต่อขัดข้อง';
      let toastType = 'warning';
    
      if (reason === 'io server disconnect') {
        message = 'เซิร์ฟเวอร์ตัดการเชื่อมต่อ';
        toastType = 'error';
      } else if (reason === 'io client disconnect') {
        message = 'ตัดการเชื่อมต่อด้วยตนเอง';
        toastType = 'info';
      } else if (reason === 'ping timeout') {
        message = 'การเชื่อมต่อหมดเวลา';
      } else if (reason === 'transport close') {
        message = 'การเชื่อมต่อปิดโดยไม่คาดคิด';
      }
    
      if (typeof showToast === 'function') {
        showToast(`⚠️ Socket.IO: ${message}`, toastType);
      }

      // หยุด heartbeat
      stopHeartbeat();

      // ส่งแจ้งเตือนไป Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: 'Socket.IO ตัดการเชื่อมต่อ',
          message: message,
          type: 'warning',
          icon: '⚠️',
          source: 'socket'
        });
      }

      // อัปเดตสถานะรวม
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('🔄 Socket.IO reconnected after', attemptNumber, 'attempts');
      if (typeof showToast === 'function') {
        showToast('🔄 เชื่อมต่อ Socket.IO ใหม่สำเร็จ', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: 'เชื่อมต่อใหม่สำเร็จ',
          message: `เชื่อมต่อ Socket.IO ใหม่หลังจาก ${attemptNumber} ครั้ง`,
          type: 'success',
          icon: '🔄'
        });
      }
    });

    socket.on('reconnect_attempt', (attemptNumber) => {
      reconnectAttempts = attemptNumber;
      console.log('🔄 Attempting to reconnect...', attemptNumber);
    
      if (attemptNumber <= 3) {
        if (typeof showToast === 'function') {
          showToast(`🔄 กำลังพยายามเชื่อมต่อใหม่... (${attemptNumber}/5)`, 'info');
        }
      }
    });

    socket.on('reconnect_failed', () => {
      console.error('❌ Socket.IO reconnection failed');
      if (typeof showToast === 'function') {
        showToast('❌ ไม่สามารถเชื่อมต่อ Socket.IO ได้', 'error');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'การเชื่อมต่อล้มเหลว',
          message: 'ไม่สามารถเชื่อมต่อ Socket.IO ใหม่ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต',
          type: 'error',
          icon: '❌',
          actions: [{
            label: 'ลองใหม่',
            action: 'primary',
            callback: () => socket.connect()
          }]
        });
      }
    });

    // Heartbeat functions
    function startHeartbeat() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
    
      heartbeatInterval = setInterval(() => {
        if (socketConnected) {
          socket.emit('heartbeat', {
            branchCode: window.BRANCH_CODE,
            sessionId: window.currentSession?.sessionId,
            timestamp: Date.now(),
            cartItems: window.cartItems?.length || 0
          });
        }
      }, 30000); // ทุก 30 วินาที
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    // ฟัง event จากเซิร์ฟเวอร์เมื่อมีการอัปเดต cart count
    socket.on('cart_count_updated', (data) => {
      console.log('📦 Cart count updated via Socket.IO:', data);
      const newCount = data.count || data;
    
      if (window.updateCartCountDisplay) {
        window.updateCartCountDisplay(newCount, 'socket');
      }
    
      if (window.posNotificationSystem && data.branchCode === window.BRANCH_CODE) {
        window.posNotificationSystem.showToast('pos', {
          title: 'อัปเดตตะกร้า',
          message: `ตะกร้าสินค้า: ${newCount} รายการ`,
          type: 'info',
          icon: '🛒'
        });
      }
    });

    // ฟัง event อัปเดตสต๊อก
    socket.on('stock_updated', (data) => {
      console.log('📈 Stock updated - refreshing product data', data);
    
      safeReloadStocks();
    
      if (typeof showToast === 'function') {
        showToast('📦 สต๊อกสินค้าได้รับการอัปเดตแล้ว', 'info');
      }
    
      // ส่งต่อไป Firebase
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: 'อัปเดตสต๊อก',
          message: 'สต๊อกสินค้าได้รับการอัปเดต',
          type: 'info',
          icon: '📦',
          source: 'socket'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.showToast('pos', {
          title: 'อัปเดตสต๊อกสินค้า',
          message: 'ข้อมูลสต๊อกได้รับการอัปเดตแล้ว',
          type: 'info',
          icon: '📦'
        });
      }
    });

    // รับการอัปเดตจาก inventory dashboard
    socket.on('stockUpdate', (data) => {
      console.log('📈 Stock update received from inventory dashboard');
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('📦 มีการอัปเดตสต๊อกจากระบบตรวจสอบ', 'info');
      }
    });

    socket.on('stockApproved', (data) => {
      console.log('✅ Stock approved:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('✅ สินค้าได้รับการอนุมัติแล้ว - อัปเดตข้อมูลแล้ว', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'สินค้าได้รับการอนุมัติ',
          message: `สินค้า ${data.productName || 'รายการใหม่'} พร้อมขายแล้ว`,
          type: 'success',
          icon: '✅',
          metadata: {
            productId: data.productId,
            branchCode: data.branchCode,
            approvedBy: data.approvedBy,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('stockVerified', (data) => {
      console.log('🔍 Stock verified:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('🔍 สินค้าได้รับการตรวจสอบแล้ว - อัปเดตข้อมูลแล้ว', 'success');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'สินค้าผ่านการตรวจสอบ',
          message: `สินค้า ${data.productName || 'รายการใหม่'} ผ่านการตรวจสอบแล้ว`,
          type: 'info',
          icon: '🔍',
          metadata: {
            productId: data.productId,
            verifiedBy: data.verifiedBy,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('stockRejected', (data) => {
      console.log('❌ Stock rejected:', data);
      safeReloadStocks();
      if (typeof showToast === 'function') {
        showToast('❌ สินค้าถูกปฏิเสธ - อัปเดตข้อมูลแล้ว', 'warning');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'สินค้าถูกปฏิเสธ',
          message: `สินค้า ${data.productName || 'รายการ'} ถูกปฏิเสธ: ${data.reason || 'ไม่ระบุเหตุผล'}`,
          type: 'warning',
          icon: '❌',
          metadata: {
            productId: data.productId,
            rejectedBy: data.rejectedBy,
            reason: data.reason,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('order_completed', (data) => {
      console.log('✅ Order completed:', data);
      if (typeof showToast === 'function') {
        showToast(`🎉 คำสั่งซื้อ ${data.orderId || data.order_id} เสร็จสิ้น`, 'success');
      }
    
      // ส่งข้อมูลการขายไป Firebase
      if (window.sendSaleToFirebase && data.branchCode === window.BRANCH_CODE) {
        window.sendSaleToFirebase({
          orderId: data.orderId || data.order_id,
          invoiceNo: data.invoiceNo || data.invoice_no,
          total: data.total,
          items: data.items,
          customer: data.customer,
          staff: data.staff,
          paymentMethod: data.paymentMethod,
          source: 'socket'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'คำสั่งซื้อเสร็จสิ้น',
          message: `ออเดอร์ ${data.orderId || data.order_id} สำเร็จแล้ว`,
          type: 'success',
          icon: '🎉',
          actions: data.receiptUrl ? [{
            label: 'ดูใบเสร็จ',
            action: 'primary',
            callback: () => window.open(data.receiptUrl, '_blank')
          }] : [],
          metadata: {
            orderId: data.orderId || data.order_id,
            total: data.total,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    socket.on('branch_notification', (data) => {
      console.log('🔔 Branch notification:', data);
    
      if (data.branchCode && data.branchCode !== window.BRANCH_CODE) {
        return; // ข้ามถ้าไม่ใช่สาขาเรา
      }
    
      if (typeof showToast === 'function') {
        showToast(data.message || '📢 แจ้งเตือนจากระบบ', data.type || 'info');
      }
    
      if (window.sendNotificationToFirebase) {
        window.sendNotificationToFirebase({
          title: data.title || 'แจ้งเตือนสาขา',
          message: data.message,
          type: data.type || 'info',
          icon: data.icon || '🔔',
          source: 'socket',
          priority: data.priority || 'normal'
        });
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: data.title || 'แจ้งเตือนสาขา',
          message: data.message,
          type: data.type || 'info',
          icon: data.icon || '🔔',
          metadata: {
            branchCode: data.branchCode,
            source: 'branch_notification',
            priority: data.priority,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    // ฟัง event โปรโมชั่น
    socket.on('promotion_updated', (data) => {
      console.log('🎁 Promotion updated:', data);
    
      if (typeof loadActivePromotions === 'function') {
        loadActivePromotions();
      }
    
      if (typeof showToast === 'function') {
        showToast('🎁 มีการอัปเดตโปรโมชั่น', 'info');
      }
    
      if (window.posNotificationSystem) {
        window.posNotificationSystem.addNotification('pos', {
          title: 'อัปเดตโปรโมชั่น',
          message: `โปรโมชั่น ${data.promotionName || 'ใหม่'} ได้รับการอัปเดต`,
          type: 'info',
          icon: '🎁',
          metadata: {
            promotionId: data.promotionId,
            promotionName: data.promotionName,
            timestamp: new Date().toLocaleString('th-TH')
          }
        });
      }
    });

    // ฟังก์ชันสำหรับส่ง event ไปยังเซิร์ฟเวอร์
    window.emitCartUpdate = function (cartData) {
      if (socketConnected) {
        socket.emit('cart_updated', {
          branchCode: window.BRANCH_CODE || window.currentBranchCode,
          sessionId: window.currentSession?.sessionId,
          cartItems: cartData,
          count: cartData.length,
          timestamp: new Date().toISOString(),
          staffId: localStorage.getItem('userId')
        });
        console.log('📤 Cart update sent to server');
      } else {
        console.warn('⚠️ Socket not connected, cannot emit cart update');
      }
    };

    window.emitCheckoutCompleted = function (orderData) {
      if (socketConnected) {
        socket.emit('checkout_completed', {
          ...orderData,
          branchCode: window.BRANCH_CODE || window.currentBranchCode,
          sessionId: window.currentSession?.sessionId,
          timestamp: new Date().toISOString()
        });
        console.log('💰 Checkout completion sent to server');
      }
    };

    window.emitStockCheck = function (productId) {
      if (socketConnected) {
        socket.emit('stock_check', {
          productId,
          branchCode: window.BRANCH_CODE,
          sessionId: window.currentSession?.sessionId,
          timestamp: new Date().toISOString()
        });
      }
    };

    // ฟังก์ชันตรวจสอบสถานะการเชื่อมต่อ
    window.getConnectionStatus = function () {
      return {
        socket: socketConnected,
        firebase: window.isFirebaseConnected || false,
        socketId: socket.id,
        reconnectAttempts: reconnectAttempts,
        timestamp: new Date().toISOString()
      };
    };

    // Error handling
    socket.on('error', (error) => {
      console.error('❌ Socket.IO error:', error);
      if (typeof showToast === 'function') {
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ Socket.IO', 'danger');
      }
    });

    socket.on('connect_error', (error) => {
      console.error('❌ Socket.IO connection error:', error);
      if (typeof showToast === 'function') {
        showToast('ไม่สามารถเชื่อมต่อ Socket.IO ได้', 'error');
      }
    });

    // ตรวจสอบสถานะการเชื่อมต่อเป็นระยะ
    setInterval(() => {
      const status = window.getConnectionStatus();
      console.log('📊 Connection Status:', status);
    
      // อัปเดตสถานะด้วยฟังก์ชันใหม่
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    }, 10000); // ทุก 10 วินาที

    console.log('🔌 Socket.IO client initialized with enhanced features');
    console.log('📡 Attempting to connect to server...');

    // รอให้ DOM โหลดเสร็จแล้วค่อยแสดงสถานะ
    document.addEventListener('DOMContentLoaded', () => {
      // อัปเดตสถานะทันทีเมื่อโหลดหน้า
      if (window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }
    
      setTimeout(() => {
        if (socketConnected) {
          if (typeof showToast === 'function') {
            showToast('🚀 ระบบ Real-time พร้อมใช้งาน', 'success');
          }
        }
    
        // อัปเดตสถานะอีกครั้งหลังจาก 2 วินาที
        if (window.updateConnectionStatus) {
          window.updateConnectionStatus();
        }
      }, 2000);
    });

    // เพิ่ม event listeners สำหรับการค้นหาลูกค้า
    document.addEventListener('DOMContentLoaded', function () {
      // ปุ่มค้นหาลูกค้า
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // ช่องค้นหาลูกค้า - กด Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ค้นหาอัตโนมัติเมื่อพิมพ์ครบ 13 หลัก
        customerSearch.addEventListener('input', function (e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // ซ่อนผลการค้นหาเมื่อพิมพ์ไม่ครบ 13 หลัก
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });

    let searchTimeout = null;
    let selectedCustomer = null;
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 วินาที

    // ฟังก์ชันค้นหาลูกค้าเก่า (แบบใหม่)
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');

      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('กรุณากรอกเลขบัตรประชาชน', 'warning');
        } else {
          alert('กรุณากรอกเลขบัตรประชาชน');
        }
        return;
      }

      // ตรวจสอบรูปแบบเลขบัตรประชาชน (13 หลัก)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก', 'warning');
        } else {
          alert('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาอยู่ กรุณารอสักครู่', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`กรุณารอ ${remaining} วินาที ก่อนค้นหาใหม่`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;
      // ประกาศ loaderId ไว้ข้างนอก try block
      let loaderId = null;

      try {
        // Show loading
        showLoading(true);
    
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาลูกค้า...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ตรวจสอบ status code ก่อน parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('🚫 คำขอเกินขีดจำกัด กรุณารอ 30 วินาที', 'error');
          }
          // เพิ่มเวลา cooldown เมื่อเจอ 429
          lastSearchTime = Date.now() + 27000; // บล็อกเพิ่มอีก 27 วินาที (รวม 30 วินาที)

          resultsList.innerHTML = `
        <div class="p-4 text-center text-red-500">
          <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
          <p class="text-sm font-medium">คำขอเกินขีดจำกัด</p>
          <p class="text-xs text-gray-400 mt-1">กรุณารอ 30 วินาที ก่อนค้นหาใหม่</p>
        </div>
      `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // เจอลูกค้า - แสดงผลลัพธ์
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');

          if (typeof showToast === 'function') {
            showToast('พบข้อมูลลูกค้า', 'success');
          }
        } else {
          // ไม่เจอลูกค้า
          resultsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
          <i class="bi bi-person-x text-2xl mb-2 block"></i>
          <p class="text-sm">ไม่พบข้อมูลลูกค้าเก่า</p>
          <p class="text-xs text-gray-400">เลขบัตรประชาชน: ${searchValue}</p>
        </div>
      `;
          resultsContainer.classList.remove('hidden');

          if (typeof showToast === 'function') {
            showToast('ไม่พบข้อมูลลูกค้าเก่า', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);

        let errorMessage = 'เกิดข้อผิดพลาดในการค้นหา';
        if (error.message.includes('429')) {
          errorMessage = 'คำขอเกินขีดจำกัด กรุณารอสักครู่';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
        }

        resultsList.innerHTML = `
      <div class="p-4 text-center text-red-500">
        <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
        <p class="text-sm font-medium">${errorMessage}</p>
        <p class="text-xs text-gray-400 mt-1">กรุณาลองใหม่อีกครั้ง</p>
      </div>
    `;
        resultsContainer.classList.remove('hidden');

        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
        // Hide loading
        showLoading(false);
      }
    }

    // แสดงผลลัพธ์การค้นหาลูกค้า
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');

      // แสดงข้อมูลลูกค้าที่พบ
      resultsList.innerHTML = `
    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
         onclick="selectCustomer('${customerData._id}', '${customerData.contactPhone || ''}')">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h4 class=\"font-semibold text-sm\">${customerData.displayName || 'ไม่ระบุชื่อ'}</h4>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
            <i class="bi bi-credit-card mr-1"></i>
            บัตรประชาชน: ${customerData.contactPhone || 'ไม่ระบุ'}
          </p>
          <p class="text-xs text-gray-600 dark:text-gray-400">
            <i class="bi bi-telephone mr-1"></i>
            โทร: ${customerData.contactPhone || 'ไม่ระบุ'}
          </p>
          <div class="flex items-center gap-2 mt-2">
            <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">
              ${customerData.isNewCustomer ? 'ลูกค้าใหม่' : 'ลูกค้าเก่า'}
            </span>
            <span class="text-xs text-gray-500">
              ซื้อมาแล้ว ${customerData.totalPurchases || 0} ครั้ง
            </span>
          </div>
        </div>
        <div class="text-right">
          <button class="btn btn-sm btn-primary">
            <i class="bi bi-check-circle mr-1"></i>
            เลือก
          </button>
        </div>
      </div>
    </div>
  `;

    // กรอกข้อมูลลูกค้าลงในฟอร์ม (สำหรับ frontstore)
    function fillCustomerFormFrontstore(customer) {
      selectedCustomer = customer;

      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;

        // ตั้งค่าประเภทลูกค้า
        document.getElementById('customerType').value = 'individual';

        // แสดงฟอร์มบุคคลธรรมดา
        document.getElementById('personalFields').classList.remove('hidden');
        document.getElementById('corporateFields').classList.add('hidden');

              // ข้อมูลพื้นฐาน
      document.getElementById('customerPrefix').value = individual.prefix || '';
      document.getElementById('customerGender').value = individual.gender || '';
      document.getElementById('customerFirstName').value = individual.firstName || '';
      document.getElementById('customerLastName').value = individual.lastName || '';
      document.getElementById('customerTaxId').value = individual.taxId || individual.idCard || '';
      document.getElementById('customerPhone').value = individual.phone || '';
      document.getElementById('customerEmailPersonal').value = individual.email || '';
      document.getElementById('customerOccupation').value = individual.occupation?.category || '';
    
      // จัดการวันเกิดและอายุ
      if (individual.birthDate || individual.dateOfBirth) {
        const birthDate = individual.birthDate || individual.dateOfBirth;
    
        // แปลงรูปแบบวันที่ถ้าจำเป็น
        let formattedDate = birthDate;
        if (typeof birthDate === 'string' && birthDate.includes('/')) {
          const parts = birthDate.split('/');
          if (parts.length === 3) {
            formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
          }
        }
    
        document.getElementById('customerBirthDate').value = formattedDate;
    
        // คำนวณอายุจากวันเกิด
        setTimeout(() => {
          calculateAgeFromBirthDate();
        }, 100);
      } else if (individual.age) {
        document.getElementById('customerAge').value = individual.age;
      }

        // ที่อยู่
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || addr.houseNo || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || addr.zipcode || '';
        }
      } else if (customer.customerType === 'corporate' && customer.corporate) {
        const corporate = customer.corporate;

        // ตั้งค่าประเภทลูกค้า
        document.getElementById('customerType').value = 'corporate';

        // แสดงฟอร์มนิติบุคคล
        document.getElementById('personalFields').classList.add('hidden');
        document.getElementById('corporateFields').classList.remove('hidden');

        // เติมข้อมูลนิติบุคคล
        document.getElementById('companyName').value = corporate.companyName || '';
        document.getElementById('companyTaxId').value = corporate.companyTaxId || '';
        document.getElementById('contactPerson').value = corporate.contactPerson || '';
        document.getElementById('corporatePhone').value = corporate.corporatePhone || '';
        document.getElementById('corporateEmail').value = corporate.corporateEmail || '';
        document.getElementById('companyAddress').value = corporate.companyAddress || '';
      }

      // ✅ Fix: แสดงสถานะลูกค้าแบบ null-safe (frontstore)
      if (customer.statistics) {
        const statusText = customer.statistics.isNewCustomer ?
          'ลูกค้าใหม่ (ยังไม่มีประวัติการซื้อ)' :
          `ลูกค้าเก่า (ซื้อแล้ว ${customer.statistics.totalPurchases} ครั้ง)`;

        if (typeof showToast === 'function') {
          showToast(statusText, 'info');
        } else {
          console.log('👤 Customer status (frontstore):', statusText);
        }
      }
    
      // อัพเดทสถานะอีเมล
      if (typeof updateEmailStatus === 'function') {
        updateEmailStatus();
      }
    }

    // เติมข้อมูลลูกค้าลงในฟอร์ม (เดิม)
    function fillCustomerForm(customer) {
      selectedCustomer = customer;

      // ตั้งค่าประเภทลูกค้า
      document.getElementById('customerType').value = customer.customerType;

      if (customer.customerType === 'individual') {
        // แสดงฟอร์มบุคคลธรรมดา
        document.getElementById('personalFields').classList.remove('hidden');
        document.getElementById('corporateFields').classList.add('hidden');

        // เติมข้อมูลบุคคลธรรมดา
        if (customer.individual) {
          document.getElementById('customerPrefix').value = customer.individual.prefix || '';
          document.getElementById('customerGender').value = customer.individual.gender || '';
          document.getElementById('customerFirstName').value = customer.individual.firstName || '';
          document.getElementById('customerLastName').value = customer.individual.lastName || '';
          document.getElementById('customerPhone').value = customer.individual.phone || '';
          document.getElementById('customerTaxId').value = customer.individual.taxId || '';
          document.getElementById('customerOccupation').value = customer.individual.occupation?.category || '';
    
          // จัดการวันเกิดและอายุ
          if (customer.individual.birthDate || customer.individual.dateOfBirth) {
            const birthDate = customer.individual.birthDate || customer.individual.dateOfBirth;
            let formattedDate = birthDate;
            if (typeof birthDate === 'string' && birthDate.includes('/')) {
              const parts = birthDate.split('/');
              if (parts.length === 3) {
                formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
              }
            }
            document.getElementById('customerBirthDate').value = formattedDate;
            setTimeout(() => {
              calculateAgeFromBirthDate();
            }, 100);
          } else if (customer.individual.age) {
            document.getElementById('customerAge').value = customer.individual.age;
          }

          // ที่อยู่
          if (customer.individual.address) {
            document.getElementById('houseNo').value = customer.individual.address.houseNo || '';
            document.getElementById('moo').value = customer.individual.address.moo || '';
            document.getElementById('subDistrict').value = customer.individual.address.subDistrict || '';
            document.getElementById('district').value = customer.individual.address.district || '';
            document.getElementById('province').value = customer.individual.address.province || '';
            document.getElementById('zipcode').value = customer.individual.address.zipcode || '';
          }
        }
      } else if (customer.customerType === 'corporate') {
        // แสดงฟอร์มนิติบุคคล
        document.getElementById('personalFields').classList.add('hidden');
        document.getElementById('corporateFields').classList.remove('hidden');

        // เติมข้อมูลนิติบุคคล
        if (customer.corporate) {
          document.getElementById('companyName').value = customer.corporate.companyName || '';
          document.getElementById('companyTaxId').value = customer.corporate.companyTaxId || '';
          document.getElementById('contactPerson').value = customer.corporate.contactPerson || '';
          document.getElementById('corporatePhone').value = customer.corporate.corporatePhone || '';
          document.getElementById('companyAddress').value = customer.corporate.companyAddress || '';
        }
      }

      // ✅ Fix: แสดงสถานะลูกค้าแบบ null-safe (legacy)
      if (customer.statistics) {
        const statusText = customer.statistics.isNewCustomer ?
          'ลูกค้าใหม่ (ยังไม่มีประวัติการซื้อ)' :
          `ลูกค้าเก่า (ซื้อแล้ว ${customer.statistics.totalPurchases} ครั้ง)`;

        if (typeof showToast === 'function') {
          showToast(statusText, 'info');
        } else {
          console.log('👤 Customer status (legacy):', statusText);
        }
      }
    }

    console.log('🔌 Socket.IO client initialized');

    // =================== POS NOTIFICATION GLOBAL FUNCTIONS ===================
    
    // Global functions for external use
    window.showPOSToast = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.showToast('pos', {
          title,
          message,
          type,
          icon: options.icon || '🏪',
          duration: options.duration || 4000,
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
        if (typeof showToast === 'function') {
          showToast(`${title}: ${message}`, type);
        } else {
          console.log(`[POS Toast] ${title}: ${message} (${type})`);
        }
      }
    };

    window.addPOSNotification = function(title, message, type = 'info', options = {}) {
      if (posNotificationSystem) {
        return posNotificationSystem.addNotification('pos', {
          title,
          message,
          type,
          icon: options.icon || '🏪',
          actions: options.actions || [],
          metadata: {
            source: 'external',
            timestamp: new Date().toLocaleString('th-TH'),
            ...options.metadata
          },
          ...options
        });
      } else {
        console.warn('POS Notification System not initialized');
      }
    };

    // Clear all POS notifications
    window.clearPOSNotifications = function() {
      if (posNotificationSystem) {
        posNotificationSystem.clearNotifications('pos');
      }
    };

    // Mark all POS notifications as read
    window.markAllPOSAsRead = function() {
      if (posNotificationSystem) {
        posNotificationSystem.markAllAsRead('pos');
      }
    };

    // Get notification system status
    window.getPOSNotificationStatus = function() {
      if (posNotificationSystem) {
        return {
          initialized: true,
          unreadCount: posNotificationSystem.getUnreadCount('pos'),
          totalCount: posNotificationSystem.getNotificationCount('pos'),
          system: posNotificationSystem
        };
      }
      return { initialized: false };
    };

    // Test notification function (for debugging)
    window.testPOSNotifications = function() {
      console.log('🧪 Testing POS Notifications...');
    
      if (!posNotificationSystem) {
        console.error('❌ POS Notification System not initialized');
        return;
      }

      // Test toast
      showPOSToast('ทดสอบระบบ', 'ระบบแจ้งเตือน POS ทำงานปกติ', 'success', {
        icon: '🧪',
        duration: 3000
      });

      // Test notification with actions
      addPOSNotification('ทดสอบการแจ้งเตือน', 'นี่คือการทดสอบระบบแจ้งเตือน POS', 'info', {
        icon: '🔔',
        actions: [
          {
            label: 'ตกลง',
            action: 'primary',
            callback: () => console.log('✅ ผู้ใช้คลิกตกลง')
          },
          {
            label: 'ยกเลิก',
            action: 'secondary',
            callback: () => console.log('❌ ผู้ใช้คลิกยกเลิก')
          }
        ],
        metadata: {
          testId: Date.now(),
          testType: 'manual'
        }
      });

      // Display status
      const status = getPOSNotificationStatus();
      console.log('📊 POS Notification Status:', status);
    };

    // ✉️ **เพิ่มฟังก์ชันทดสอบระบบอีเมล**
    window.testEmailSystem = async function() {
      console.log('📧 Testing Email System...');
    
      try {
        // 1. ตรวจสอบสถานะบริการอีเมล
        console.log('🔍 Checking email service status...');
        const emailStatus = await checkEmailServiceStatus();
        console.log('📊 Email Service Status:', emailStatus);
    
        if (emailStatus.available) {
          if (typeof showToast === 'function') {
            showToast('✅ บริการอีเมลพร้อมใช้งาน', 'success');
          }
          console.log('✅ Email service is available');
          console.log('📋 Email service details:', emailStatus.details);
        } else {
          if (typeof showToast === 'function') {
            showToast('⚠️ บริการอีเมลยังไม่พร้อมใช้งาน', 'warning');
          }
          console.log('⚠️ Email service not available:', emailStatus.error);
        }
    
        // 2. ทดสอบการตรวจสอบข้อมูลลูกค้า
        const customerType = document.getElementById('customerType').value;
        const customerEmail = customerType === 'individual'
          ? document.getElementById('customerEmailPersonal').value
          : document.getElementById('corporateEmail').value;
    
        if (customerEmail) {
          console.log('📧 Customer email found:', customerEmail);
          if (typeof showToast === 'function') {
            showToast(`📧 จะส่งอีเมลไปยัง: ${customerEmail}`, 'info');
          }
        } else {
          console.log('⚠️ No customer email provided');
          if (typeof showToast === 'function') {
            showToast('⚠️ ไม่พบอีเมลลูกค้า กรุณากรอกอีเมลก่อนทดสอบ', 'warning');
          }
        }
    
        // 3. ตรวจสอบสถานะ checkbox
        const emailCheckbox = document.getElementById('sendEmailReceipt');
        if (emailCheckbox && emailCheckbox.checked) {
          console.log('✅ Email sending is enabled');
          if (typeof showToast === 'function') {
            showToast('✅ การส่งอีเมลอัตโนมัติเปิดใช้งานแล้ว', 'success');
          }
        } else {
          console.log('❌ Email sending is disabled');
          if (typeof showToast === 'function') {
            showToast('❌ การส่งอีเมลอัตโนมัติปิดใช้งาน', 'warning');
          }
        }
    
        // 4. แสดงสรุปผล
        const summary = {
          emailServiceAvailable: emailStatus.available,
          customerEmailProvided: !!customerEmail,
          emailSendingEnabled: emailCheckbox?.checked || false,
          readyToSend: emailStatus.available && !!customerEmail && (emailCheckbox?.checked || false)
        };
    
        console.log('📊 Email System Test Summary:', summary);
    
        if (summary.readyToSend) {
          if (typeof showToast === 'function') {
            showToast('🎉 ระบบอีเมลพร้อมส่งใบเสร็จอัตโนมัติ!', 'success');
          }
        } else {
          const issues = [];
          if (!summary.emailServiceAvailable) issues.push('บริการอีเมลไม่พร้อม');
          if (!summary.customerEmailProvided) issues.push('ไม่มีอีเมลลูกค้า');
          if (!summary.emailSendingEnabled) issues.push('ปิดการส่งอีเมล');
    
          if (typeof showToast === 'function') {
            showToast(`⚠️ ปัญหา: ${issues.join(', ')}`, 'warning');
          }
        }
    
        return summary;
    
      } catch (error) {
        console.error('❌ Email system test failed:', error);
        if (typeof showToast === 'function') {
          showToast('❌ เกิดข้อผิดพลาดในการทดสอบระบบอีเมล', 'error');
        }
        return { error: error.message };
      }
    };

    // ✉️ **ฟังก์ชันส่งอีเมลทดสอบ**
    window.sendTestEmail = async function() {
      console.log('📤 Sending test email...');
    
      try {
        const customerType = document.getElementById('customerType').value;
        const customerEmail = customerType === 'individual'
          ? document.getElementById('customerEmailPersonal').value
          : document.getElementById('corporateEmail').value;
    
        if (!customerEmail) {
          if (typeof showToast === 'function') {
            showToast('❌ กรุณากรอกอีเมลลูกค้าก่อนทดสอบ', 'error');
          }
          return;
        }
    
        const customerName = customerType === 'individual'
          ? `${document.getElementById('customerPrefix').value}${document.getElementById('customerFirstName').value} ${document.getElementById('customerLastName').value}`.trim()
          : document.getElementById('companyName').value;
    
        // สร้างข้อมูลทดสอบ
        const testEmailData = {
          orderId: 'TEST_' + Date.now(),
          invoiceNo: 'TEST_INV_' + Date.now(),
          customerEmail: customerEmail,
          customerName: customerName || 'ลูกค้าทดสอบ',
          customerType: customerType
        };
    
        console.log('📧 Test email data:', testEmailData);
        if (typeof showToast === 'function') {
          showToast('📤 กำลังส่งอีเมลทดสอบ...', 'info');
        }
    
        // เรียกฟังก์ชันส่งอีเมล
        await sendReceiptEmail(testEmailData);
    
        if (typeof showToast === 'function') {
          showToast('✅ ส่งอีเมลทดสอบสำเร็จ!', 'success');
        }
        console.log('✅ Test email sent successfully');
    
      } catch (error) {
        console.error('❌ Test email failed:', error);
        if (typeof showToast === 'function') {
          showToast('❌ ส่งอีเมลทดสอบไม่สำเร็จ: ' + error.message, 'error');
        }
      }
    };

    // Auto-test on development environment
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
      // Add test buttons
      setTimeout(() => {
        if (!document.getElementById('testPOSNotificationBtn')) {
          const testBtn = document.createElement('button');
          testBtn.id = 'testPOSNotificationBtn';
          testBtn.textContent = '🔔 Test POS Notifications';
          testBtn.className = 'fixed bottom-2 right-2 z-50 bg-cyan-500 text-white px-3 py-1 rounded text-sm';
          testBtn.onclick = () => testPOSNotifications();
          document.body.appendChild(testBtn);
        }
    
        // เพิ่มปุ่มทดสอบอีเมล
        if (!document.getElementById('testEmailBtn')) {
          const emailBtn = document.createElement('button');
          emailBtn.id = 'testEmailBtn';
          emailBtn.textContent = '📧 Test Email';
          emailBtn.className = 'fixed bottom-2 right-44 z-50 bg-green-500 text-white px-3 py-1 rounded text-sm';
          emailBtn.onclick = () => testEmailSystem();
          document.body.appendChild(emailBtn);
        }
    
        // เพิ่มปุ่มส่งอีเมลทดสอบ
        if (!document.getElementById('sendTestEmailBtn')) {
          const sendBtn = document.createElement('button');
          sendBtn.id = 'sendTestEmailBtn';
          sendBtn.textContent = '📤 Send Test';
          sendBtn.className = 'fixed bottom-2 right-80 z-50 bg-orange-500 text-white px-3 py-1 rounded text-sm';
          sendBtn.onclick = () => sendTestEmail();
          document.body.appendChild(sendBtn);
        }
    
        // ✅ เพิ่มปุ่มทดสอบ Multi-IP Card Reader
        if (!document.getElementById('testCardReaderBtn')) {
          const cardBtn = document.createElement('button');
          cardBtn.id = 'testCardReaderBtn';
          cardBtn.textContent = '🆔 Test Card Reader';
          cardBtn.className = 'fixed bottom-2 right-[20rem] z-50 bg-purple-500 text-white px-3 py-1 rounded text-sm';
          cardBtn.onclick = () => {
            if (typeof window.testCardReaderConnection === 'function') {
              window.testCardReaderConnection();
            } else {
              alert('❌ Card Reader Service ไม่พร้อมใช้งาน');
            }
          };
          document.body.appendChild(cardBtn);
        }
    
        // ✅ เพิ่มปุ่มแสดงสถานะ Multi-IP Endpoints
        if (!document.getElementById('showEndpointStatusBtn')) {
          const endpointBtn = document.createElement('button');
          endpointBtn.id = 'showEndpointStatusBtn';
          endpointBtn.textContent = '📊 Endpoint Status';
          endpointBtn.className = 'fixed bottom-2 right-[26rem] z-50 bg-indigo-500 text-white px-3 py-1 rounded text-sm';
          endpointBtn.onclick = () => {
            if (typeof window.showEndpointStatus === 'function') {
              window.showEndpointStatus();
            } else {
              alert('❌ Card Reader Service ไม่พร้อมใช้งาน');
            }
          };
          document.body.appendChild(endpointBtn);
        }
    
        // ✅ เพิ่มปุ่ม Debug Card Reader Config
        if (!document.getElementById('debugCardReaderBtn')) {
          const debugBtn = document.createElement('button');
          debugBtn.id = 'debugCardReaderBtn';
          debugBtn.textContent = '🔍 Debug Card Reader';
          debugBtn.className = 'fixed bottom-2 right-[32rem] z-50 bg-pink-500 text-white px-3 py-1 rounded text-sm';
          debugBtn.onclick = () => {
            if (typeof window.debugCardReader === 'function') {
              window.debugCardReader();
            } else {
              alert('❌ Card Reader Service ไม่พร้อมใช้งาน');
            }
          };
          document.body.appendChild(debugBtn);
        }
      }, 2000);
    }
    }
    
    console.log('🔔 POS Notification Global Functions initialized');
  </script>

  <!-- ✅ Enhanced: Printer Service Integration (เหมือน HistoryReceipt.html) -->
  <script src="/js/printer-service.js"></script>
  
  <script>
    // เพิ่ม BRANCH_CODE global variable สำหรับ PrinterService
    window.BRANCH_CODE = 'PATTANI'; // สามารถเปลี่ยนตาม branch ที่ใช้งาน
    
    // ✅ Enhanced: อัพเดท PrinterService integration ให้เหมือน HistoryReceipt.html
    if (typeof window.PrinterService !== 'undefined') {
      console.log('🖨️ PrinterService available, upgrading frontstore functions...');
    
      // Override printPOS function ให้ใช้ PrinterService (สำหรับใช้ในอนาคต)
      window.printPOSWithService = async function(receiptImage) {
        showLoading(true);
    
        try {
    
          // ใช้ PrinterService แทนการส่งแบบเดิม
          const result = await window.PrinterService.print(receiptImage, {
            documentType: 'frontstore_receipt',
            timestamp: new Date().toISOString()
          });
    
          showLoading(false);

          if (window.showToast) {
            window.showToast('พิมพ์ใบเสร็จสำเร็จ! 🖨️', 'success');
          }
    
        } catch (error) {
          console.error('Print error:', error);
          showLoading(false);
    
          if (window.showToast) {
            window.showToast('เกิดข้อผิดพลาดระหว่างพิมพ์: ' + error.message, 'error');
          }
        }
      };
    
      // ✅ Enhanced: ทดสอบการเชื่อมต่อเครื่องพิมพ์แบบเดียวกับ HistoryReceipt.html
      window.testPrinterConnectionWithService = async function() {
        showLoading(true);
    
        try {
          const status = await window.PrinterService.getStatus();
    
          showLoading(false);

          if (status.status === 'connected' || status.status === 'ready') {
            if (typeof showToast === 'function') {
              showToast('✅ เชื่อมต่อเครื่องพิมพ์สำเร็จ!', 'success');
            }
          } else {
            throw new Error(status.message || 'ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้');
          }

        } catch (error) {
          console.error('Printer test failed:', error);
          showLoading(false);

          if (typeof showToast === 'function') {
            showToast('❌ ทดสอบเชื่อมต่อเครื่องพิมพ์ล้มเหลว: ' + error.message, 'error');
          }
        }
      };
    
      // ✅ Enhanced: แสดงการตั้งค่าใหม่แบบเดียวกับ HistoryReceipt.html
      window.showPrinterSettingsWithService = function() {
        const branchInfo = window.PrinterService.getCurrentBranch();
    
        let message = `🖨️ ข้อมูลการตั้งค่าเครื่องพิมพ์ (PrinterService)\n\n`;
        message += `สาขาปัจจุบัน: ${branchInfo.code || 'ไม่ระบุ'}\n`;
        message += `ชื่อสาขา: ${branchInfo.data?.name || 'ไม่พบข้อมูล'}\n`;
        message += `URL เครื่องพิมพ์: ${branchInfo.printerURL || 'ไม่ได้ตั้งค่า'}\n`;
        message += `สถานะระบบ: ${window.PrinterService.isInitialized ? '✅ พร้อมใช้งาน' : '⚠️ กำลังเริ่มต้น'}\n\n`;
    
        if (branchInfo.data && branchInfo.data.printerServerUrl) {
          message += `✅ พบการตั้งค่าอัตโนมัติจากฐานข้อมูล\n`;
          message += `ระบบจะพิมพ์ไปยังเครื่องพิมพ์ของสาขาโดยอัตโนมัติ`;
        } else {
          message += `⚠️ ไม่พบการตั้งค่าอัตโนมัติ\n`;
          message += `กำลังใช้การตั้งค่าเริ่มต้น`;
        }
    
        alert(message);
      };

      // ✅ Enhanced: เพิ่มฟังก์ชันทดสอบการเชื่อมต่อแบบโดยตรงเหมือน HistoryReceipt.html
      window.testDirectPrinterConnection = async function() {
        showLoading(true);
    
        try {
    
          const printerURL = await PrinterSystem.getPrinterURL();
          const apiKey = PrinterSystem.getAPIKey();
    
          console.log(`🔍 Testing direct connection to: ${printerURL}`);
          console.log(`🔑 Using API Key: ${apiKey.substring(0, 10)}...`);
    
    
          // ทดสอบผ่าน proxy endpoint
          const healthResponse = await fetch('/api/printer/print', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
              image: 'health-check',
              printerURL: printerURL,
              apiKey: apiKey
            })
          });
    
          const healthData = await healthResponse.json();
          console.log('🏥 Health check result:', healthData);
    
          showLoading(false);
    
          // แสดงผลลัพธ์
          let resultMessage = `🖨️ ผลการทดสอบ Printer Server (ผ่าน Proxy)\n\n`;
          resultMessage += `URL: ${printerURL}\n`;
          resultMessage += `API Key: ${apiKey.substring(0, 10)}...\n\n`;
    
          const healthSuccess = healthData.success || false;
          resultMessage += `Health Check: ${healthSuccess ? '✅ ผ่าน' : '❌ ล้มเหลว'}\n\n`;
    
          if (healthSuccess) {
            resultMessage += `🎉 การเชื่อมต่อสำเร็จ!\n`;
            resultMessage += `Printer Server พร้อมใช้งาน`;
          } else {
            resultMessage += `⚠️ มีปัญหาในการเชื่อมต่อ\n`;
            resultMessage += `กรุณาตรวจสอบการตั้งค่าและเครื่องพิมพ์`;
          }
    
          alert(resultMessage);
    
          if (typeof showToast === 'function') {
            showToast(healthSuccess ?
              '✅ ทดสอบ Printer Server สำเร็จ!' :
              '❌ การทดสอบ Printer Server ล้มเหลว',
              healthSuccess ? 'success' : 'error'
            );
          }
    
        } catch (error) {
          console.error('Direct printer test failed:', error);
          showLoading(false);
    
          alert(`❌ การทดสอบ Printer Server ล้มเหลว\n\nError: ${error.message}`);
    
          if (typeof showToast === 'function') {
            showToast('❌ ทดสอบ Printer Server ล้มเหลว: ' + error.message, 'error');
          }
        }
      };

      // เพิ่ม event listener สำหรับปุ่มตรวจสอบเครื่องพิมพ์แบบ manual
      document.addEventListener('DOMContentLoaded', () => {
        const manualCheckBtn = document.getElementById('manual-printer-check');
        if (manualCheckBtn) {
          manualCheckBtn.addEventListener('click', testPrinterConnectionWithService);
        }
      });
    
      console.log('✅ Frontstore-PrinterService integration completed');
      console.log('📖 Available functions: printPOSWithService(), testPrinterConnectionWithService(), showPrinterSettingsWithService(), testDirectPrinterConnection()');
    } else {
      console.warn('⚠️ PrinterService not available in Frontstore');
    
      // Fallback functions
      window.printPOSWithService = async function() {
        if (typeof showToast === 'function') {
          showToast('⚠️ ระบบพิมพ์ไม่พร้อมใช้งาน', 'warning');
        }
        return Promise.resolve({ success: false, error: 'PrinterService not available' });
      };
    }
    
    // ข้อมูลเกี่ยวกับ Database Integration (เหมือน HistoryReceipt.html)
    console.log('🔧 Database Printer Integration Summary (Frontstore):');
    console.log('   Data Source: https://www.2pheenong.com/api/branch');
    console.log('   Default Branch: 00000 (สำนักงานใหญ่)');
    console.log('   Fallback IP: http://100.84.132.71:4004');
    console.log('   API Key: printer-server-key-2024');
    console.log('   Status: ✅ Database-Driven & Ready');
    console.log('   Benefits: 🗄️ Dynamic, 🔄 Auto-Update, 🔒 Secure, 🌐 Multi-Branch');
    console.log('');
    console.log('🎯 Quick Test Commands (All Async):');
    console.log('   await testDirectPrinterConnection() - ทดสอบเชื่อมต่อ Printer Server');
    console.log('   await showPrinterSettingsWithService() - ดูการตั้งค่าปัจจุบัน');
    console.log('   await testPrinterConnectionWithService() - ทดสอบการเชื่อมต่อ');
    console.log('');
    console.log('📖 Documentation: Database integration allows dynamic printer');
    console.log('   configuration per branch with secure Tailscale connections.');
  </script>

  <script>
    // =================== COMPREHENSIVE THAI ADDRESS SYSTEM ===================

    // Comprehensive Thai Address Dataset
    window.THAI_ADDRESS_DATA = {
      // All 77 Thai Provinces with ID, Name (Thai), Name (English), and Region
      provinces: [
        {id: 1, name: 'กรุงเทพมหานคร', name_en: 'Bangkok', region: 'กรุงเทพฯ'},
        {id: 2, name: 'สมุทรปราการ', name_en: 'Samut Prakan', region: 'กลาง'},
        {id: 3, name: 'นนทบุรี', name_en: 'Nonthaburi', region: 'กลาง'},
        {id: 4, name: 'ปทุมธานี', name_en: 'Pathum Thani', region: 'กลาง'},
        {id: 5, name: 'พระนครศรีอยุธยา', name_en: 'Phra Nakhon Si Ayutthaya', region: 'กลาง'},
        {id: 6, name: 'อ่างทอง', name_en: 'Ang Thong', region: 'กลาง'},
        {id: 7, name: 'ลพบุรี', name_en: 'Lopburi', region: 'กลาง'},
        {id: 8, name: 'สิงห์บุรี', name_en: 'Sing Buri', region: 'กลาง'},
        {id: 9, name: 'ชัยนาท', name_en: 'Chai Nat', region: 'กลาง'},
        {id: 10, name: 'สระบุรี', name_en: 'Saraburi', region: 'กลาง'},
        {id: 11, name: 'ชลบุรี', name_en: 'Chonburi', region: 'ตะวันออก'},
        {id: 12, name: 'ระยอง', name_en: 'Rayong', region: 'ตะวันออก'},
        {id: 13, name: 'จันทบุรี', name_en: 'Chanthaburi', region: 'ตะวันออก'},
        {id: 14, name: 'ตราด', name_en: 'Trat', region: 'ตะวันออก'},
        {id: 15, name: 'ฉะเชิงเทรา', name_en: 'Chachoengsao', region: 'ตะวันออก'},
        {id: 16, name: 'ปราจีนบุรี', name_en: 'Prachin Buri', region: 'ตะวันออก'},
        {id: 17, name: 'นครนายก', name_en: 'Nakhon Nayok', region: 'กลาง'},
        {id: 18, name: 'สระแก้ว', name_en: 'Sa Kaeo', region: 'ตะวันออก'},
        {id: 19, name: 'นครราชสีมา', name_en: 'Nakhon Ratchasima', region: 'อีสาน'},
        {id: 20, name: 'บุรีรัมย์', name_en: 'Buriram', region: 'อีสาน'},
        {id: 21, name: 'สุรินทร์', name_en: 'Surin', region: 'อีสาน'},
        {id: 22, name: 'ศรีสะเกษ', name_en: 'Sisaket', region: 'อีสาน'},
        {id: 23, name: 'อุบลราชธานี', name_en: 'Ubon Ratchathani', region: 'อีสาน'},
        {id: 24, name: 'ยโสธร', name_en: 'Yasothon', region: 'อีสาน'},
        {id: 25, name: 'ชัยภูมิ', name_en: 'Chaiyaphum', region: 'อีสาน'},
        {id: 26, name: 'อำนาจเจริญ', name_en: 'Amnat Charoen', region: 'อีสาน'},
        {id: 27, name: 'หนองบัวลำภู', name_en: 'Nong Bua Lam Phu', region: 'อีสาน'},
        {id: 28, name: 'ขอนแก่น', name_en: 'Khon Kaen', region: 'อีสาน'},
        {id: 29, name: 'อุดรธานี', name_en: 'Udon Thani', region: 'อีสาน'},
        {id: 30, name: 'เลย', name_en: 'Loei', region: 'อีสาน'},
        {id: 31, name: 'หนองคาย', name_en: 'Nong Khai', region: 'อีสาน'},
        {id: 32, name: 'มหาสารคาม', name_en: 'Maha Sarakham', region: 'อีสาน'},
        {id: 33, name: 'ร้อยเอ็ด', name_en: 'Roi Et', region: 'อีสาน'},
        {id: 34, name: 'กาฬสินธุ์', name_en: 'Kalasin', region: 'อีสาน'},
        {id: 35, name: 'สกลนคร', name_en: 'Sakon Nakhon', region: 'อีสาน'},
        {id: 36, name: 'นครพนม', name_en: 'Nakhon Phanom', region: 'อีสาน'},
        {id: 37, name: 'มุกดาหาร', name_en: 'Mukdahan', region: 'อีสาน'},
        {id: 38, name: 'เชียงใหม่', name_en: 'Chiang Mai', region: 'เหนือ'},
        {id: 39, name: 'ลำพูน', name_en: 'Lamphun', region: 'เหนือ'},
        {id: 40, name: 'ลำปาง', name_en: 'Lampang', region: 'เหนือ'},
        {id: 41, name: 'อุตรดิตถ์', name_en: 'Uttaradit', region: 'เหนือ'},
        {id: 42, name: 'แพร่', name_en: 'Phrae', region: 'เหนือ'},
        {id: 43, name: 'น่าน', name_en: 'Nan', region: 'เหนือ'},
        {id: 44, name: 'พะเยา', name_en: 'Phayao', region: 'เหนือ'},
        {id: 45, name: 'เชียงราย', name_en: 'Chiang Rai', region: 'เหนือ'},
        {id: 46, name: 'แม่ฮ่องสอน', name_en: 'Mae Hong Son', region: 'เหนือ'},
        {id: 47, name: 'นครสวรรค์', name_en: 'Nakhon Sawan', region: 'กลาง'},
        {id: 48, name: 'อุทัยธานี', name_en: 'Uthai Thani', region: 'กลาง'},
        {id: 49, name: 'กำแพงเพชร', name_en: 'Kamphaeng Phet', region: 'กลาง'},
        {id: 50, name: 'ตาก', name_en: 'Tak', region: 'ตะวันตก'},
        {id: 51, name: 'สุโขทัย', name_en: 'Sukhothai', region: 'กลาง'},
        {id: 52, name: 'พิษณุโลก', name_en: 'Phitsanulok', region: 'กลาง'},
        {id: 53, name: 'พิจิตร', name_en: 'Phichit', region: 'กลาง'},
        {id: 54, name: 'เพชรบูรณ์', name_en: 'Phetchabun', region: 'กลาง'},
        {id: 55, name: 'ราชบุรี', name_en: 'Ratchaburi', region: 'ตะวันตก'},
        {id: 56, name: 'กาญจนบุรี', name_en: 'Kanchanaburi', region: 'ตะวันตก'},
        {id: 57, name: 'สุพรรณบุรี', name_en: 'Suphan Buri', region: 'กลาง'},
        {id: 58, name: 'นครปฐม', name_en: 'Nakhon Pathom', region: 'กลาง'},
        {id: 59, name: 'สมุทรสาคร', name_en: 'Samut Sakhon', region: 'กลาง'},
        {id: 60, name: 'สมุทรสงคราม', name_en: 'Samut Songkhram', region: 'กลาง'},
        {id: 61, name: 'เพชรบุรี', name_en: 'Phetchaburi', region: 'ตะวันตก'},
        {id: 62, name: 'ประจวบคีรีขันธ์', name_en: 'Prachuap Khiri Khan', region: 'ตะวันตก'},
        {id: 63, name: 'นครศรีธรรมราช', name_en: 'Nakhon Si Thammarat', region: 'ใต้'},
        {id: 64, name: 'กระบี่', name_en: 'Krabi', region: 'ใต้'},
        {id: 65, name: 'พังงา', name_en: 'Phang Nga', region: 'ใต้'},
        {id: 66, name: 'ภูเก็ต', name_en: 'Phuket', region: 'ใต้'},
        {id: 67, name: 'สุราษฎร์ธานี', name_en: 'Surat Thani', region: 'ใต้'},
        {id: 68, name: 'ระนอง', name_en: 'Ranong', region: 'ใต้'},
        {id: 69, name: 'ชุมพร', name_en: 'Chumphon', region: 'ใต้'},
        {id: 70, name: 'สงขลา', name_en: 'Songkhla', region: 'ใต้'},
        {id: 71, name: 'สตูล', name_en: 'Satun', region: 'ใต้'},
        {id: 72, name: 'ตรัง', name_en: 'Trang', region: 'ใต้'},
        {id: 73, name: 'พัทลุง', name_en: 'Phatthalung', region: 'ใต้'},
        {id: 74, name: 'ปัตตานี', name_en: 'Pattani', region: 'ใต้'},
        {id: 75, name: 'ยะลา', name_en: 'Yala', region: 'ใต้'},
        {id: 76, name: 'นราธิวาส', name_en: 'Narathiwat', region: 'ใต้'},
        {id: 77, name: 'บึงกาฬ', name_en: 'Bueng Kan', region: 'อีสาน'}
      ],

      // Sample comprehensive districts for key provinces - will be populated by functions
      districts: {},

      // Sample comprehensive sub-districts - will be populated by functions
      subDistricts: {},

      // Postal codes mapping
      postalCodes: {}
    };

    document.addEventListener('DOMContentLoaded', function() {
      console.log('🌍 Initializing Comprehensive Thai Address System...');

      // Initialize comprehensive address data
      initializeThaiAddressData();

      // Initialize enhanced dropdowns
      initializeLocationAutocomplete();
    });

    function initializeLocationAutocomplete() {
      try {
        const provInput = document.getElementById('province');
        const distInput = document.getElementById('district');
        const subInput = document.getElementById('subDistrict');
        const zipInput = document.getElementById('zipcode');

        const provDD = document.getElementById('provinceDropdown');
        const distDD = document.getElementById('districtDropdown');
        const subDD = document.getElementById('subDistrictDropdown');

        if (!provInput || !distInput || !subInput || !zipInput || !provDD || !distDD || !subDD) {
          console.warn('⚠️ Some location elements not found, skipping initialization');
          return;
        }

        console.log('🏗️ Setting up enhanced Thai address dropdowns...');

        // Setup Province dropdown
        const provinceDropdown = setupEnhancedDropdown(provInput, provDD, (itemData) => {
          console.log('🏛️ Selected province:', itemData.name);

          // Set province value
          provInput.value = itemData.name;

          // Clear dependent fields
          distInput.value = '';
          subInput.value = '';
          zipInput.value = '';

          // Load districts for this province
          loadDistrictsForProvince(itemData.id, districtDropdown);

          // Clear sub-district dropdown
          clearDropdown(subDD, 'เลือกอำเภอก่อน');

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: 'คลิกเพื่อเลือกจังหวัด หรือพิมพ์เพื่อค้นหา',
          noResultsText: 'ไม่พบจังหวัดที่ต้องการ - สามารถพิมพ์ชื่อจังหวัดเองได้',
          loadingText: 'กำลังโหลดรายการจังหวัด...'
        });

        // Setup District dropdown
        const districtDropdown = setupEnhancedDropdown(distInput, distDD, (itemData) => {
          console.log('🏘️ Selected district:', itemData.name);

          // Set district value
          distInput.value = itemData.name;

          // Clear dependent fields
          subInput.value = '';
          zipInput.value = '';

          // Load sub-districts for this district
          loadSubDistrictsForDistrict(itemData.province_id, itemData.id, tambonDropdown);

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: 'คลิกเพื่อเลือกอำเภอ หรือพิมพ์เพื่อค้นหา',
          noResultsText: 'ไม่พบอำเภอที่ต้องการ - สามารถพิมพ์ชื่ออำเภอเองได้',
          loadingText: 'กำลังโหลดรายการอำเภอ...'
        });

        // Setup Sub-district dropdown
        const tambonDropdown = setupEnhancedDropdown(subInput, subDD, (itemData) => {
          console.log('🏘️ Selected sub-district:', itemData.name);

          // Set sub-district value
          subInput.value = itemData.name;

          // Auto-fill postal code if available
          if (itemData.zipcode) {
            zipInput.value = itemData.zipcode;
            // Trigger zipcode validation if available
            if (typeof validateZipcode === 'function') {
              validateZipcode(itemData.zipcode);
            }
            console.log('📮 Auto-filled postal code:', itemData.zipcode);
          }

          // Safe update address preview
          if (typeof window.updateAddressPreview === 'function') {
            window.updateAddressPreview();
          }
        }, {
          searchDelay: 200,
          placeholder: 'คลิกเพื่อเลือกตำบล หรือพิมพ์เพื่อค้นหา',
          noResultsText: 'ไม่พบตำบลที่ต้องการ - สามารถพิมพ์ชื่อตำบลเองได้',
          loadingText: 'กำลังโหลดรายการตำบล...'
        });

        // Enhanced Province focus handler - show all provinces on focus/click
        provInput.addEventListener('focus', () => {
          // Show all provinces when user clicks/focuses on the field
          const allProvinces = window.THAI_ADDRESS_DATA.provinces || [];
          if (allProvinces.length > 0) {
            const items = allProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `ภาก${province.region} • รหัส: ${province.id.toString().padStart(2, '0')}`
            }));
            provinceDropdown.setItems(items);
            provinceDropdown.open();
          }
        });

        // Enhanced Province search - filter as user types
        provInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();

          if (query.length === 0) {
            // Show all provinces when input is empty
            const allProvinces = window.THAI_ADDRESS_DATA.provinces || [];
            const items = allProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `ภาค${province.region} • รหัส: ${province.id.toString().padStart(2, '0')}`
            }));
            provinceDropdown.setItems(items);
            provinceDropdown.open();
            return;
          }

          // Search provinces locally
          const filteredProvinces = searchProvinces(query);

          if (filteredProvinces.length > 0) {
            const items = filteredProvinces.map(province => ({
              id: province.id,
              name: province.name,
              displayText: province.name,
              subText: `ภาค${province.region} • รหัส: ${province.id.toString().padStart(2, '0')}`
            }));

            provinceDropdown.setItems(items);
            provinceDropdown.open();
          } else {
            provinceDropdown.setItems([]);
            provinceDropdown.open();
          }
        }, 200));

        // Enhanced District focus handler - show all districts for selected province
        distInput.addEventListener('focus', () => {
          const selectedProvince = getSelectedProvince(provInput.value);

          if (!selectedProvince) {
            clearDropdown(distDD, 'กรุณาเลือกจังหวัดก่อน');
            return;
          }

          // Show all districts for the selected province
          const allDistricts = window.THAI_ADDRESS_DATA.districts[selectedProvince.id] || [];
          if (allDistricts.length > 0) {
            const items = allDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} • รหัส: ${district.id.toString().padStart(2, '0')}`
            }));
            districtDropdown.setItems(items);
            districtDropdown.open();
          }
        });

        // Enhanced District search - filter as user types
        distInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          const selectedProvince = getSelectedProvince(provInput.value);

          if (!selectedProvince) {
            clearDropdown(distDD, 'กรุณาเลือกจังหวัดก่อน');
            return;
          }

          if (query.length === 0) {
            // Show all districts when input is empty
            const allDistricts = window.THAI_ADDRESS_DATA.districts[selectedProvince.id] || [];
            const items = allDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} • รหัส: ${district.id.toString().padStart(2, '0')}`
            }));
            districtDropdown.setItems(items);
            districtDropdown.open();
            return;
          }

          // Search districts locally
          const filteredDistricts = searchDistricts(selectedProvince.id, query);

          if (filteredDistricts.length > 0) {
            const items = filteredDistricts.map(district => ({
              id: district.id,
              name: district.name,
              province_id: district.province_id,
              displayText: district.name,
              subText: `${selectedProvince.name} • รหัส: ${district.id.toString().padStart(2, '0')}`
            }));

            districtDropdown.setItems(items);
            districtDropdown.open();
          } else {
            districtDropdown.setItems([]);
            districtDropdown.open();
          }
        }, 200));

        // Enhanced Sub-district focus handler - show all sub-districts for selected district
        subInput.addEventListener('focus', () => {
          const selectedProvince = getSelectedProvince(provInput.value);
          const selectedDistrict = getSelectedDistrict(selectedProvince?.id, distInput.value);

          if (!selectedProvince || !selectedDistrict) {
            clearDropdown(subDD, 'กรุณาเลือกจังหวัดและอำเภอก่อน');
            return;
          }

          // Show all sub-districts for the selected district
          const key = `${selectedProvince.id}-${selectedDistrict.id}`;
          const allSubDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
          if (allSubDistricts.length > 0) {
            const items = allSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `รหัสไปรษณีย์: ${subDistrict.zipcode}` : 'ไม่มีรหัสไปรษณีย์'
            }));
            tambonDropdown.setItems(items);
            tambonDropdown.open();
          }
        });

        // Enhanced Sub-district search - filter as user types
        subInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          const selectedProvince = getSelectedProvince(provInput.value);
          const selectedDistrict = getSelectedDistrict(selectedProvince?.id, distInput.value);

          if (!selectedProvince || !selectedDistrict) {
            clearDropdown(subDD, 'กรุณาเลือกจังหวัดและอำเภอก่อน');
            return;
          }

          if (query.length === 0) {
            // Show all sub-districts when input is empty
            const key = `${selectedProvince.id}-${selectedDistrict.id}`;
            const allSubDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
            const items = allSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `รหัสไปรษณีย์: ${subDistrict.zipcode}` : 'ไม่มีรหัสไปรษณีย์'
            }));
            tambonDropdown.setItems(items);
            tambonDropdown.open();
            return;
          }

          // Search sub-districts locally
          const filteredSubDistricts = searchSubDistricts(selectedProvince.id, selectedDistrict.id, query);

          if (filteredSubDistricts.length > 0) {
            const items = filteredSubDistricts.map(subDistrict => ({
              id: subDistrict.id,
              name: subDistrict.name,
              province_id: subDistrict.province_id,
              district_id: subDistrict.district_id,
              zipcode: subDistrict.zipcode,
              displayText: subDistrict.name,
              subText: subDistrict.zipcode ? `รหัสไปรษณีย์: ${subDistrict.zipcode}` : 'ไม่มีรหัสไปรษณีย์'
            }));

            tambonDropdown.setItems(items);
            tambonDropdown.open();
          } else {
            tambonDropdown.setItems([]);
            tambonDropdown.open();
          }
        }, 200));

        // Enhanced Zipcode Validation
        setupZipcodeValidation();

        // Add event listeners for address preview updates
        ['houseNo', 'moo', 'soi', 'road', 'zipcode'].forEach(id => {
          const element = document.getElementById(id);
          if (element && typeof window.updateAddressPreview === 'function') {
            element.addEventListener('input', window.updateAddressPreview);
          }
        });

        console.log('✅ Comprehensive Thai Address System initialized successfully!');
      } catch (error) {
        console.error('❌ Failed to initialize Thai address system:', error);
      }
    }

    // =================== THAI ADDRESS DATA INITIALIZATION ===================

    function initializeThaiAddressData() {
      console.log('🗄️ Initializing comprehensive Thai address dataset...');

      // Comprehensive districts data for Thai provinces
      window.THAI_ADDRESS_DATA.districts = {
        1: [ // กรุงเทพมหานคร - All 50 Official Districts (Khet) - Verified 2024
          {id: 1, name: 'บางบอน', name_en: 'Bang Bon', province_id: 1},
          {id: 2, name: 'บางกะปิ', name_en: 'Bang Kapi', province_id: 1},
          {id: 3, name: 'บางแค', name_en: 'Bang Khae', province_id: 1},
          {id: 4, name: 'บางเขน', name_en: 'Bang Khen', province_id: 1},
          {id: 5, name: 'บางคอแหลม', name_en: 'Bang Kho Laem', province_id: 1},
          {id: 6, name: 'บางขุนเทียน', name_en: 'Bang Khun Thian', province_id: 1},
          {id: 7, name: 'บางนา', name_en: 'Bang Na', province_id: 1},
          {id: 8, name: 'บางพลัด', name_en: 'Bang Phlat', province_id: 1},
          {id: 9, name: 'บางรัก', name_en: 'Bang Rak', province_id: 1},
          {id: 10, name: 'บางซื่อ', name_en: 'Bang Sue', province_id: 1},
          {id: 11, name: 'บางกอกน้อย', name_en: 'Bangkok Noi', province_id: 1},
          {id: 12, name: 'บางกอกใหญ่', name_en: 'Bangkok Yai', province_id: 1},
          {id: 13, name: 'บึงกุ่ม', name_en: 'Bueng Kum', province_id: 1},
          {id: 14, name: 'จตุจักร', name_en: 'Chatuchak', province_id: 1},
          {id: 15, name: 'จอมทอง', name_en: 'Chom Thong', province_id: 1},
          {id: 16, name: 'ดินแดง', name_en: 'Din Daeng', province_id: 1},
          {id: 17, name: 'ดอนเมือง', name_en: 'Don Mueang', province_id: 1},
          {id: 18, name: 'ดุสิต', name_en: 'Dusit', province_id: 1},
          {id: 19, name: 'ห้วยขวาง', name_en: 'Huai Khwang', province_id: 1},
          {id: 20, name: 'คันนายาว', name_en: 'Khan Na Yao', province_id: 1},
          {id: 21, name: 'คลองสามวา', name_en: 'Khlong Sam Wa', province_id: 1},
          {id: 22, name: 'คลองสาน', name_en: 'Khlong San', province_id: 1},
          {id: 23, name: 'คลองเตย', name_en: 'Khlong Toei', province_id: 1},
          {id: 24, name: 'หลักสี่', name_en: 'Lak Si', province_id: 1},
          {id: 25, name: 'ลาดกระบัง', name_en: 'Lat Krabang', province_id: 1},
          {id: 26, name: 'ลาดพร้าว', name_en: 'Lat Phrao', province_id: 1},
          {id: 27, name: 'มีนบุรี', name_en: 'Min Buri', province_id: 1},
          {id: 28, name: 'หนองจอก', name_en: 'Nong Chok', province_id: 1},
          {id: 29, name: 'หนองแขม', name_en: 'Nong Khaem', province_id: 1},
          {id: 30, name: 'ปทุมวัน', name_en: 'Pathum Wan', province_id: 1},
          {id: 31, name: 'พญาไท', name_en: 'Phaya Thai', province_id: 1},
          {id: 32, name: 'พระโขนง', name_en: 'Phra Khanong', province_id: 1},
          {id: 33, name: 'พระนคร', name_en: 'Phra Nakhon', province_id: 1},
          {id: 34, name: 'ป้อมปราบศัตรูพ่าย', name_en: 'Pom Prap Sattru Phai', province_id: 1},
          {id: 35, name: 'ประเวศ', name_en: 'Prawet', province_id: 1},
          {id: 36, name: 'ราษฎร์บูรณะ', name_en: 'Rat Burana', province_id: 1},
          {id: 37, name: 'ราชเทวี', name_en: 'Ratchathewi', province_id: 1},
          {id: 38, name: 'สายไหม', name_en: 'Sai Mai', province_id: 1},
          {id: 39, name: 'สัมพันธวงศ์', name_en: 'Samphanthawong', province_id: 1},
          {id: 40, name: 'สะพานสูง', name_en: 'Saphan Sung', province_id: 1},
          {id: 41, name: 'สาทร', name_en: 'Sathon', province_id: 1},
          {id: 42, name: 'สวนหลวง', name_en: 'Suan Luang', province_id: 1},
          {id: 43, name: 'ทวีวัฒนา', name_en: 'Thawi Watthana', province_id: 1},
          {id: 44, name: 'ธนบุรี', name_en: 'Thon Buri', province_id: 1},
          {id: 45, name: 'ทุ่งครุ', name_en: 'Thung Khru', province_id: 1},
          {id: 46, name: 'วังทองหลาง', name_en: 'Wang Thonglang', province_id: 1},
          {id: 47, name: 'วัฒนา', name_en: 'Watthana', province_id: 1},
          {id: 48, name: 'ยานนาวา', name_en: 'Yan Nawa', province_id: 1},
          {id: 49, name: 'ตลิ่งชัน', name_en: 'Taling Chan', province_id: 1},
          {id: 50, name: 'ภาษีเจริญ', name_en: 'Phasi Charoen', province_id: 1}
        ],
        74: [ // ปัตตานี
          {id: 1, name: 'เมืองปัตตานี', name_en: 'Mueang Pattani', province_id: 74},
          {id: 2, name: 'โคกโพธิ์', name_en: 'Khok Pho', province_id: 74},
          {id: 3, name: 'หนองจิก', name_en: 'Nong Chik', province_id: 74},
          {id: 4, name: 'ปะนาเระ', name_en: 'Panare', province_id: 74},
          {id: 5, name: 'มายอ', name_en: 'Mayo', province_id: 74},
          {id: 6, name: 'ทุ่งยางแดง', name_en: 'Thung Yang Daeng', province_id: 74},
          {id: 7, name: 'สายบุรี', name_en: 'Sai Buri', province_id: 74},
          {id: 8, name: 'ไม้แก่น', name_en: 'Mai Kaen', province_id: 74},
          {id: 9, name: 'ยะรัง', name_en: 'Yarang', province_id: 74},
          {id: 10, name: 'ยะหริ่ง', name_en: 'Yaring', province_id: 74},
          {id: 11, name: 'แม่ลาน', name_en: 'Mae Lan', province_id: 74},
          {id: 12, name: 'กะพ้อ', name_en: 'Kapho', province_id: 74}
        ],
        38: [ // เชียงใหม่ - All 25 Official Districts - Verified 2024
          {id: 1, name: 'เมืองเชียงใหม่', name_en: 'Mueang Chiang Mai', province_id: 38},
          {id: 2, name: 'จอมทอง', name_en: 'Chom Thong', province_id: 38},
          {id: 3, name: 'แม่แจ่ม', name_en: 'Mae Chaem', province_id: 38},
          {id: 4, name: 'เชียงดาว', name_en: 'Chiang Dao', province_id: 38},
          {id: 5, name: 'ดอยสะเก็ด', name_en: 'Doi Saket', province_id: 38},
          {id: 6, name: 'แม่แตง', name_en: 'Mae Taeng', province_id: 38},
          {id: 7, name: 'แม่ริม', name_en: 'Mae Rim', province_id: 38},
          {id: 8, name: 'สะเมิง', name_en: 'Samoeng', province_id: 38},
          {id: 9, name: 'ฝาง', name_en: 'Fang', province_id: 38},
          {id: 10, name: 'แม่อาย', name_en: 'Mae Ai', province_id: 38},
          {id: 11, name: 'พร้าว', name_en: 'Phrao', province_id: 38},
          {id: 12, name: 'สันป่าตอง', name_en: 'San Pa Tong', province_id: 38},
          {id: 13, name: 'สันกำแพง', name_en: 'San Kamphaeng', province_id: 38},
          {id: 14, name: 'สันทราย', name_en: 'San Sai', province_id: 38},
          {id: 15, name: 'หางดง', name_en: 'Hang Dong', province_id: 38},
          {id: 16, name: 'ฮอด', name_en: 'Hot', province_id: 38},
          {id: 17, name: 'ดอยเต่า', name_en: 'Doi Tao', province_id: 38},
          {id: 18, name: 'อมก๋อย', name_en: 'Omkoi', province_id: 38},
          {id: 19, name: 'สารภี', name_en: 'Saraphi', province_id: 38},
          {id: 20, name: 'เวียงแหง', name_en: 'Wiang Haeng', province_id: 38},
          {id: 21, name: 'ไชยปราการ', name_en: 'Chai Prakan', province_id: 38},
          {id: 22, name: 'แม่วาง', name_en: 'Mae Wang', province_id: 38},
          {id: 23, name: 'แม่ออน', name_en: 'Mae On', province_id: 38},
          {id: 24, name: 'ดอยหล่อ', name_en: 'Doi Lo', province_id: 38},
          {id: 25, name: 'กัลยาณิวัฒนา', name_en: 'Galyani Vadhana', province_id: 38}
        ],
        11: [ // ชลบุรี - All 11 Official Districts - Verified 2024
          {id: 1, name: 'เมืองชลบุรี', name_en: 'Mueang Chonburi', province_id: 11},
          {id: 2, name: 'บ้านบึง', name_en: 'Ban Bueng', province_id: 11},
          {id: 3, name: 'หนองใหญ่', name_en: 'Nong Yai', province_id: 11},
          {id: 4, name: 'บางละมุง', name_en: 'Bang Lamung', province_id: 11},
          {id: 5, name: 'พานทอง', name_en: 'Phan Thong', province_id: 11},
          {id: 6, name: 'พนัสนิคม', name_en: 'Phanat Nikhom', province_id: 11},
          {id: 7, name: 'ศรีราชา', name_en: 'Si Racha', province_id: 11},
          {id: 8, name: 'เกาะสีชัง', name_en: 'Ko Sichang', province_id: 11},
          {id: 9, name: 'สัตตาหีบ', name_en: 'Sattahip', province_id: 11},
          {id: 10, name: 'บ่อทอง', name_en: 'Bo Thong', province_id: 11},
          {id: 11, name: 'เกาะจันทร์', name_en: 'Ko Chan', province_id: 11}
        ],
        66: [ // ภูเก็ต - All 3 Official Districts - Verified 2024
          {id: 1, name: 'เมืองภูเก็ต', name_en: 'Mueang Phuket', province_id: 66},
          {id: 2, name: 'กะทู้', name_en: 'Kathu', province_id: 66},
          {id: 3, name: 'ถลาง', name_en: 'Thalang', province_id: 66}
        ],
        64: [ // กระบี่ - All 8 Official Districts - Verified 2024
          {id: 1, name: 'เมืองกระบี่', name_en: 'Mueang Krabi', province_id: 64},
          {id: 2, name: 'เขาพนม', name_en: 'Khao Phanom', province_id: 64},
          {id: 3, name: 'เกาะลันตา', name_en: 'Ko Lanta', province_id: 64},
          {id: 4, name: 'คลองท่อม', name_en: 'Khlong Thom', province_id: 64},
          {id: 5, name: 'อ่าวลึก', name_en: 'Ao Luek', province_id: 64},
          {id: 6, name: 'ปลายพระยา', name_en: 'Plai Phraya', province_id: 64},
          {id: 7, name: 'ลำทับ', name_en: 'Lam Thap', province_id: 64},
          {id: 8, name: 'เหนือคลอง', name_en: 'Nuea Khlong', province_id: 64}
        ],
        70: [ // สงขลา - All 16 Official Districts
          {id: 1, name: 'เมืองสงขลา', name_en: 'Mueang Songkhla', province_id: 70},
          {id: 2, name: 'สทิงพระ', name_en: 'Sathing Phra', province_id: 70},
          {id: 3, name: 'จะนะ', name_en: 'Chana', province_id: 70},
          {id: 4, name: 'นาทวี', name_en: 'Na Thawi', province_id: 70},
          {id: 5, name: 'เทพา', name_en: 'Thepha', province_id: 70},
          {id: 6, name: 'สะบ้าย้อย', name_en: 'Saba Yoi', province_id: 70},
          {id: 7, name: 'ระโนด', name_en: 'Ranot', province_id: 70},
          {id: 8, name: 'กระแสสินธุ์', name_en: 'Krasae Sin', province_id: 70},
          {id: 9, name: 'หาดใหญ่', name_en: 'Hat Yai', province_id: 70},
          {id: 10, name: 'รัตภูมิ', name_en: 'Rattaphum', province_id: 70},
          {id: 11, name: 'สะเดา', name_en: 'Sadao', province_id: 70},
          {id: 12, name: 'นาหม่อม', name_en: 'Na Mom', province_id: 70},
          {id: 13, name: 'ควนเนียง', name_en: 'Khuan Niang', province_id: 70},
          {id: 14, name: 'บางกล่ำ', name_en: 'Bang Klam', province_id: 70},
          {id: 15, name: 'สิงหนคร', name_en: 'Singhanakhon', province_id: 70},
          {id: 16, name: 'คลองหอยโข่ง', name_en: 'Khlong Hoi Khong', province_id: 70}
        ],
        67: [ // สุราษฎร์ธานี - All 19 Official Districts - Major Tourism Hub 2024
          {id: 1, name: 'เมืองสุราษฎร์ธานี', name_en: 'Mueang Surat Thani', province_id: 67},
          {id: 2, name: 'กาญจนดิษฐ์', name_en: 'Kanchanadit', province_id: 67},
          {id: 3, name: 'ดอนสัก', name_en: 'Don Sak', province_id: 67},
          {id: 4, name: 'เกาะสมุย', name_en: 'Ko Samui', province_id: 67},
          {id: 5, name: 'เกาะพะงัน', name_en: 'Ko Pha-ngan', province_id: 67},
          {id: 6, name: 'ไชยา', name_en: 'Chaiya', province_id: 67},
          {id: 7, name: 'ท่าฉาง', name_en: 'Tha Chang', province_id: 67},
          {id: 8, name: 'บ้านตาขุน', name_en: 'Ban Ta Khun', province_id: 67},
          {id: 9, name: 'พนม', name_en: 'Phanom', province_id: 67},
          {id: 10, name: 'ท่าชนะ', name_en: 'Tha Chana', province_id: 67},
          {id: 11, name: 'เคียนซา', name_en: 'Khian Sa', province_id: 67},
          {id: 12, name: 'บ้านนาเดิม', name_en: 'Ban Na Doem', province_id: 67},
          {id: 13, name: 'วิภาวดี', name_en: 'Wiphawadi', province_id: 67},
          {id: 14, name: 'พุนพิน', name_en: 'Phunphin', province_id: 67},
          {id: 15, name: 'ชัยบุรี', name_en: 'Chai Buri', province_id: 67},
          {id: 16, name: 'บ้านนาสาร', name_en: 'Ban Na San', province_id: 67},
          {id: 17, name: 'วิเศษชัยชาญ', name_en: 'Wiang Sa', province_id: 67},
          {id: 18, name: 'เกาะเต่า', name_en: 'Ko Tao', province_id: 67},
          {id: 19, name: 'ท่าใหม่', name_en: 'Tha Mai', province_id: 67}
        ],
        28: [ // ขอนแก่น - All 26 Official Districts - Major Northeast Economic Center 2024
          {id: 1, name: 'เมืองขอนแก่น', name_en: 'Mueang Khon Kaen', province_id: 28},
          {id: 2, name: 'บ้านไผ่', name_en: 'Ban Phai', province_id: 28},
          {id: 3, name: 'พล', name_en: 'Phon', province_id: 28},
          {id: 4, name: 'ชุมแพ', name_en: 'Chum Phae', province_id: 28},
          {id: 5, name: 'สีชมพู', name_en: 'Si Chomphu', province_id: 28},
          {id: 6, name: 'น้ำพอง', name_en: 'Nam Phong', province_id: 28},
          {id: 7, name: 'อุบลรัตน์', name_en: 'Ubolratana', province_id: 28},
          {id: 8, name: 'โนนศิลา', name_en: 'Non Sila', province_id: 28},
          {id: 9, name: 'กระนวน', name_en: 'Kranuan', province_id: 28},
          {id: 10, name: 'บ้านฝาง', name_en: 'Ban Fang', province_id: 28},
          {id: 11, name: 'เปือยน้อย', name_en: 'Pueai Noi', province_id: 28},
          {id: 12, name: 'พระยืน', name_en: 'Phra Yuen', province_id: 28},
          {id: 13, name: 'หนองเรือ', name_en: 'Nong Ruea', province_id: 28},
          {id: 14, name: 'บ้านเหล่า', name_en: 'Ban Lao', province_id: 28},
          {id: 15, name: 'เวียงเก่า', name_en: 'Wiang Kao', province_id: 28},
          {id: 16, name: 'เวียงยาง', name_en: 'Wiang Yang', province_id: 28},
          {id: 17, name: 'แวงใหญ่', name_en: 'Waeng Yai', province_id: 28},
          {id: 18, name: 'แวงน้อย', name_en: 'Waeng Noi', province_id: 28},
          {id: 19, name: 'สีเมืองใหม่', name_en: 'Si Mueng Mai', province_id: 28},
          {id: 20, name: 'ภูผาม่าน', name_en: 'Phu Pha Man', province_id: 28},
          {id: 21, name: 'เก็งคอย', name_en: 'Keng Khoi', province_id: 28},
          {id: 22, name: 'ภูวิเศษ', name_en: 'Phu Wiang', province_id: 28},
          {id: 23, name: 'แซ่ม', name_en: 'Sam Sung', province_id: 28},
          {id: 24, name: 'โคกโพธิชัย', name_en: 'Khok Pho Chai', province_id: 28},
          {id: 25, name: 'หนองนาคำ', name_en: 'Nong Na Kham', province_id: 28},
          {id: 26, name: 'บ้านเขว้า', name_en: 'Ban Khwao', province_id: 28}
        ],
        19: [ // นครราชสีมา - All 32 Official Districts - Largest Northeast Province 2024
          {id: 1, name: 'เมืองนครราชสีมา', name_en: 'Mueang Nakhon Ratchasima', province_id: 19},
          {id: 2, name: 'ครบุรี', name_en: 'Khon Buri', province_id: 19},
          {id: 3, name: 'คง', name_en: 'Khong', province_id: 19},
          {id: 4, name: 'บ้านเลื่อม', name_en: 'Ban Lueam', province_id: 19},
          {id: 5, name: 'จักราช', name_en: 'Chakkarat', province_id: 19},
          {id: 6, name: 'โชคชัย', name_en: 'Chok Chai', province_id: 19},
          {id: 7, name: 'ด่านขุนทด', name_en: 'Dan Khun Thot', province_id: 19},
          {id: 8, name: 'โนนไทย', name_en: 'Non Thai', province_id: 19},
          {id: 9, name: 'โนนสูง', name_en: 'Non Sung', province_id: 19},
          {id: 10, name: 'ขามสะแกแสง', name_en: 'Kham Sakae Saeng', province_id: 19},
          {id: 11, name: 'ขามทะเลสอ', name_en: 'Kham Thale So', province_id: 19},
          {id: 12, name: 'สีคิ้ว', name_en: 'Sikhiu', province_id: 19},
          {id: 13, name: 'ปักธงชัย', name_en: 'Pak Thong Chai', province_id: 19},
          {id: 14, name: 'วังน้ำเขียว', name_en: 'Wang Nam Khiao', province_id: 19},
          {id: 15, name: 'เทพารักษ์', name_en: 'Thepharak', province_id: 19},
          {id: 16, name: 'เมืองยาง', name_en: 'Mueang Yang', province_id: 19},
          {id: 17, name: 'ประทาย', name_en: 'Prathai', province_id: 19},
          {id: 18, name: 'ปากช่อง', name_en: 'Pak Chong', province_id: 19},
          {id: 19, name: 'หนองบุญมาก', name_en: 'Nong Bunmak', province_id: 19},
          {id: 20, name: 'คำเตย', name_en: 'Kham Toei', province_id: 19},
          {id: 21, name: 'บัวใหญ่', name_en: 'Bua Yai', province_id: 19},
          {id: 22, name: 'สูงเนิน', name_en: 'Sung Noen', province_id: 19},
          {id: 23, name: 'เสิงสาง', name_en: 'Soeng Sang', province_id: 19},
          {id: 24, name: 'ลำทะเมนชัย', name_en: 'Lam Thamenchai', province_id: 19},
          {id: 25, name: 'บัวลาย', name_en: 'Bua Lai', province_id: 19},
          {id: 26, name: 'โนนแดง', name_en: 'Non Daeng', province_id: 19},
          {id: 27, name: 'พิมาย', name_en: 'Phimai', province_id: 19},
          {id: 28, name: 'ห้วยแถลง', name_en: 'Huai Thalaeng', province_id: 19},
          {id: 29, name: 'ชุมพลบุรี', name_en: 'Chum Phuang', province_id: 19},
          {id: 30, name: 'แก้งสนามนาง', name_en: 'Kaeng Sanam Nang', province_id: 19},
          {id: 31, name: 'โนนดินแดง', name_en: 'Non Din Daeng', province_id: 19},
          {id: 32, name: 'บึงสามัคคี', name_en: 'Bueng Samakkhi', province_id: 19}
        ],
        29: [ // อุดรธานี - All 20 Official Districts - Major Northeast Hub 2024
          {id: 1, name: 'เมืองอุดรธานี', name_en: 'Mueang Udon Thani', province_id: 29},
          {id: 2, name: 'กุมภวาปี', name_en: 'Kumphawapi', province_id: 29},
          {id: 3, name: 'โนนสะอาด', name_en: 'Non Sa-at', province_id: 29},
          {id: 4, name: 'หนองวัวซอ', name_en: 'Nong Wua So', province_id: 29},
          {id: 5, name: 'กุดจับ', name_en: 'Kut Chap', province_id: 29},
          {id: 6, name: 'บ้านผือ', name_en: 'Ban Phue', province_id: 29},
          {id: 7, name: 'เพ็ญ', name_en: 'Phen', province_id: 29},
          {id: 8, name: 'ศรีธาตุ', name_en: 'Si That', province_id: 29},
          {id: 9, name: 'น้ำโสม', name_en: 'Nam Som', province_id: 29},
          {id: 10, name: 'ไชยวาน', name_en: 'Chai Wan', province_id: 29},
          {id: 11, name: 'หนองหาน', name_en: 'Nong Han', province_id: 29},
          {id: 12, name: 'ทุ่งฝน', name_en: 'Thung Fon', province_id: 29},
          {id: 13, name: 'วังสามหมอ', name_en: 'Wang Sam Mo', province_id: 29},
          {id: 14, name: 'บ้านดุง', name_en: 'Ban Dung', province_id: 29},
          {id: 15, name: 'ป่าติ้ว', name_en: 'Pa Tio', province_id: 29},
          {id: 16, name: 'สังคม', name_en: 'Sang Khom', province_id: 29},
          {id: 17, name: 'หนองเสาลอง', name_en: 'Nong Saeng', province_id: 29},
          {id: 18, name: 'บ้านม่วง', name_en: 'Ban Muang', province_id: 29},
          {id: 19, name: 'นาใหญ่', name_en: 'Na Yung', province_id: 29},
          {id: 20, name: 'โซ่พิสัย', name_en: 'So Phisai', province_id: 29}
        ],
        12: [ // ระยอง - All 8 Official Districts - Eastern Seaboard Industrial Hub 2024
          {id: 1, name: 'เมืองระยอง', name_en: 'Mueang Rayong', province_id: 12},
          {id: 2, name: 'บ้านฉาง', name_en: 'Ban Chang', province_id: 12},
          {id: 3, name: 'เกาะฉาง', name_en: 'Ko Chang', province_id: 12},
          {id: 4, name: 'วังจันทร์', name_en: 'Wang Chan', province_id: 12},
          {id: 5, name: 'บ้านคาย', name_en: 'Ban Khai', province_id: 12},
          {id: 6, name: 'ปลวกแดง', name_en: 'Pluak Daeng', province_id: 12},
          {id: 7, name: 'เขาชะเมา', name_en: 'Khao Chamao', province_id: 12},
          {id: 8, name: 'นิคมพัฒนา', name_en: 'Nikhom Phatthana', province_id: 12}
        ],
        58: [ // นครปฐม - All 7 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: 'เมืองนครปฐม', name_en: 'Mueang Nakhon Pathom', province_id: 58},
          {id: 2, name: 'กำแพงแสน', name_en: 'Kamphaeng Saen', province_id: 58},
          {id: 3, name: 'นครชัยศรี', name_en: 'Nakhon Chai Si', province_id: 58},
          {id: 4, name: 'ดอนตูม', name_en: 'Don Tum', province_id: 58},
          {id: 5, name: 'บางเลน', name_en: 'Bang Len', province_id: 58},
          {id: 6, name: 'สามพราน', name_en: 'Sam Phran', province_id: 58},
          {id: 7, name: 'พุทธมณฑล', name_en: 'Phutthamonthon', province_id: 58}
        ],
        2: [ // สมุทรปราการ - All 6 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: 'เมืองสมุทรปราการ', name_en: 'Mueang Samut Prakan', province_id: 2},
          {id: 2, name: 'บางบ่อ', name_en: 'Bang Bo', province_id: 2},
          {id: 3, name: 'บางพลี', name_en: 'Bang Phli', province_id: 2},
          {id: 4, name: 'พระประแดง', name_en: 'Phra Pradaeng', province_id: 2},
          {id: 5, name: 'พระสมุทรเจดีย์', name_en: 'Phra Samut Chedi', province_id: 2},
          {id: 6, name: 'บางเสาธง', name_en: 'Bang Sao Thong', province_id: 2}
        ],
        3: [ // นนทบุรี - All 6 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: 'เมืองนนทบุรี', name_en: 'Mueang Nonthaburi', province_id: 3},
          {id: 2, name: 'บางกรวย', name_en: 'Bang Kruai', province_id: 3},
          {id: 3, name: 'บางใหญ่', name_en: 'Bang Yai', province_id: 3},
          {id: 4, name: 'บางบัวทอง', name_en: 'Bang Bua Thong', province_id: 3},
          {id: 5, name: 'ไผ่', name_en: 'Pai', province_id: 3},
          {id: 6, name: 'ปากเกร็ด', name_en: 'Pak Kret', province_id: 3}
        ],
        4: [ // ปทุมธานี - All 7 Official Districts - Bangkok Metropolitan Satellite 2024
          {id: 1, name: 'เมืองปทุมธานี', name_en: 'Mueang Pathum Thani', province_id: 4},
          {id: 2, name: 'คลองหลวง', name_en: 'Khlong Luang', province_id: 4},
          {id: 3, name: 'ธัญบุรี', name_en: 'Thanyaburi', province_id: 4},
          {id: 4, name: 'หนองเสือ', name_en: 'Nong Suea', province_id: 4},
          {id: 5, name: 'ลาดหลุมแก้ว', name_en: 'Lat Lum Kaeo', province_id: 4},
          {id: 6, name: 'ลำลูกกา', name_en: 'Lam Luk Ka', province_id: 4},
          {id: 7, name: 'สามโคก', name_en: 'Sam Khok', province_id: 4}
        ],
        20: [ // บุรีรัมย์ - All 23 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองบุรีรัมย์', name_en: 'Mueang Buriram', province_id: 20},
          {id: 2, name: 'กระสัง', name_en: 'Krasang', province_id: 20},
          {id: 3, name: 'คูเมือง', name_en: 'Khu Mueang', province_id: 20},
          {id: 4, name: 'บ้านกรวด', name_en: 'Ban Kruat', province_id: 20},
          {id: 5, name: 'ประโคนชัย', name_en: 'Prakhon Chai', province_id: 20},
          {id: 6, name: 'ปะคำ', name_en: 'Pakham', province_id: 20},
          {id: 7, name: 'นางรอง', name_en: 'Nang Rong', province_id: 20},
          {id: 8, name: 'โนนดินแดง', name_en: 'Non Din Daeng', province_id: 20},
          {id: 9, name: 'บ้านใหม่ไชยพจน์', name_en: 'Ban Mai Chaiyaphot', province_id: 20},
          {id: 10, name: 'นาโพธิ์', name_en: 'Na Pho', province_id: 20},
          {id: 11, name: 'โนนสุวรรณ', name_en: 'Non Suwan', province_id: 20},
          {id: 12, name: 'ชำนิ', name_en: 'Chamni', province_id: 20},
          {id: 13, name: 'บ้านด่าน', name_en: 'Ban Dan', province_id: 20},
          {id: 14, name: 'ห้วยราช', name_en: 'Huai Rat', province_id: 20},
          {id: 15, name: 'ละหานทราย', name_en: 'Lahan Sai', province_id: 20},
          {id: 16, name: 'สตึก', name_en: 'Satuek', province_id: 20},
          {id: 17, name: 'โคกเจริญ', name_en: 'Khok Charoen', province_id: 20},
          {id: 18, name: 'พลับพลาชัย', name_en: 'Phlapphla Chai', province_id: 20},
          {id: 19, name: 'หนองหงส์', name_en: 'Nong Hong', province_id: 20},
          {id: 20, name: 'แคนดง', name_en: 'Kaen Dong', province_id: 20},
          {id: 21, name: 'บ้านด่าน', name_en: 'Ban Dan', province_id: 20},
          {id: 22, name: 'โนนสุวรรณ', name_en: 'Non Suwan', province_id: 20},
          {id: 23, name: 'ชำนิ', name_en: 'Chamni', province_id: 20}
        ],
        23: [ // อุบลราชธานี - All 25 Official Districts - Major Northeast Border Province 2024
          {id: 1, name: 'เมืองอุบลราชธานี', name_en: 'Mueang Ubon Ratchathani', province_id: 23},
          {id: 2, name: 'ศรีเมืองใหม่', name_en: 'Si Mueang Mai', province_id: 23},
          {id: 3, name: 'โขงเจียม', name_en: 'Khong Chiam', province_id: 23},
          {id: 4, name: 'เขื่องใน', name_en: 'Khueng Nai', province_id: 23},
          {id: 5, name: 'เขมราฐ', name_en: 'Khemarat', province_id: 23},
          {id: 6, name: 'เดชอุดม', name_en: 'Det Udom', province_id: 23},
          {id: 7, name: 'นาจะหลวย', name_en: 'Na Chaluai', province_id: 23},
          {id: 8, name: 'น้ำยืน', name_en: 'Nam Yuen', province_id: 23},
          {id: 9, name: 'บุณฑริก', name_en: 'Buntharik', province_id: 23},
          {id: 10, name: 'ตระการพืชผล', name_en: 'Trakan Phuet Phon', province_id: 23},
          {id: 11, name: 'กุดข้าวปุ้น', name_en: 'Kut Khaopun', province_id: 23},
          {id: 12, name: 'ม่วงสามสิบ', name_en: 'Muang Sam Sip', province_id: 23},
          {id: 13, name: 'วารินชำราบ', name_en: 'Warin Chamrap', province_id: 23},
          {id: 14, name: 'พิบูลมังสาหาร', name_en: 'Phibun Mangsahan', province_id: 23},
          {id: 15, name: 'ตาลสุม', name_en: 'Tan Sum', province_id: 23},
          {id: 16, name: 'โพธิ์ไทร', name_en: 'Pho Sai', province_id: 23},
          {id: 17, name: 'สำโรง', name_en: 'Samrong', province_id: 23},
          {id: 18, name: 'ดอนมดแดง', name_en: 'Don Mot Daeng', province_id: 23},
          {id: 19, name: 'สิรินธร', name_en: 'Sirindhorn', province_id: 23},
          {id: 20, name: 'ทุ่งศรีอุดม', name_en: 'Thung Si Udom', province_id: 23},
          {id: 21, name: 'สว่างวีระวงศ์', name_en: 'Sawang Wirawong', province_id: 23},
          {id: 22, name: 'นาตาล', name_en: 'Na Tan', province_id: 23},
          {id: 23, name: 'เหล่าเสือโก้ก', name_en: 'Lao Suea Kok', province_id: 23},
          {id: 24, name: 'สำโรงทาบ', name_en: 'Samrong Thap', province_id: 23},
          {id: 25, name: 'น้ำขุ่น', name_en: 'Nam Khun', province_id: 23}
        ],
        45: [ // เชียงราย - All 18 Official Districts - Northern Border Province 2024
          {id: 1, name: 'เมืองเชียงราย', name_en: 'Mueang Chiang Rai', province_id: 45},
          {id: 2, name: 'วาเชียง', name_en: 'Wiang Chai', province_id: 45},
          {id: 3, name: 'เชียงของ', name_en: 'Chiang Khong', province_id: 45},
          {id: 4, name: 'เทิง', name_en: 'Thoeng', province_id: 45},
          {id: 5, name: 'พาน', name_en: 'Phan', province_id: 45},
          {id: 6, name: 'ป่าแดด', name_en: 'Pa Daet', province_id: 45},
          {id: 7, name: 'แม่จัน', name_en: 'Mae Chan', province_id: 45},
          {id: 8, name: 'เชียงแสน', name_en: 'Chiang Saen', province_id: 45},
          {id: 9, name: 'แม่สาย', name_en: 'Mae Sai', province_id: 45},
          {id: 10, name: 'แม่สรวย', name_en: 'Mae Suai', province_id: 45},
          {id: 11, name: 'เวียงชัย', name_en: 'Wiang Chai', province_id: 45},
          {id: 12, name: 'เวียงกาหลง', name_en: 'Wiang Kalong', province_id: 45},
          {id: 13, name: 'ขุนตาล', name_en: 'Khun Tan', province_id: 45},
          {id: 14, name: 'เวียงป่าเป้า', name_en: 'Wiang Pa Pao', province_id: 45},
          {id: 15, name: 'พญาเม็งราย', name_en: 'Phaya Mengrai', province_id: 45},
          {id: 16, name: 'เวียงชัย', name_en: 'Wiang Chai', province_id: 45},
          {id: 17, name: 'แม่ลาว', name_en: 'Mae Lao', province_id: 45},
          {id: 18, name: 'เวียงเชียงรุ้ง', name_en: 'Wiang Chiang Rung', province_id: 45}
        ],
        63: [ // นครศรีธรรมราช - All 23 Official Districts - Major Southern Province 2024
          {id: 1, name: 'เมืองนครศรีธรรมราช', name_en: 'Mueang Nakhon Si Thammarat', province_id: 63},
          {id: 2, name: 'พรหมคีรี', name_en: 'Phrom Khiri', province_id: 63},
          {id: 3, name: 'ลานสกา', name_en: 'Lan Saka', province_id: 63},
          {id: 4, name: 'ฉวาง', name_en: 'Chawang', province_id: 63},
          {id: 5, name: 'พิปูน', name_en: 'Phipun', province_id: 63},
          {id: 6, name: 'เชียรใหญ่', name_en: 'Chian Yai', province_id: 63},
          {id: 7, name: 'ชะอวด', name_en: 'Cha-uat', province_id: 63},
          {id: 8, name: 'ท่าศาลา', name_en: 'Tha Sala', province_id: 63},
          {id: 9, name: 'ทุ่งสง', name_en: 'Thung Song', province_id: 63},
          {id: 10, name: 'นาบอน', name_en: 'Na Bon', province_id: 63},
          {id: 11, name: 'ทุ่งใหญ่', name_en: 'Thung Yai', province_id: 63},
          {id: 12, name: 'ปากพนัง', name_en: 'Pak Phanang', province_id: 63},
          {id: 13, name: 'ร่อนพิบูลย์', name_en: 'Ron Phibun', province_id: 63},
          {id: 14, name: 'สิชล', name_en: 'Sichon', province_id: 63},
          {id: 15, name: 'ขนอม', name_en: 'Khanom', province_id: 63},
          {id: 16, name: 'หัวไทร', name_en: 'Hua Sai', province_id: 63},
          {id: 17, name: 'บางขัน', name_en: 'Bang Khan', province_id: 63},
          {id: 18, name: 'ถ้ำพรรณรา', name_en: 'Tham Phannara', province_id: 63},
          {id: 19, name: 'จุฬาภรณ์', name_en: 'Chulabhorn', province_id: 63},
          {id: 20, name: 'พระพรหม', name_en: 'Phra Phrom', province_id: 63},
          {id: 21, name: 'นบพิตำ', name_en: 'Nop Phi Tam', province_id: 63},
          {id: 22, name: 'ช้างกลาง', name_en: 'Chang Klang', province_id: 63},
          {id: 23, name: 'เฉลิมพระเกียรติ', name_en: 'Chaloem Phra Kiat', province_id: 63}
        ],
        5: [ // พระนครศรีอยุธยา - All 16 Official Districts - Historical Capital 2024
          {id: 1, name: 'เมืองพระนครศรีอยุธยา', name_en: 'Mueang Phra Nakhon Si Ayutthaya', province_id: 5},
          {id: 2, name: 'ท่าเรือ', name_en: 'Tha Ruea', province_id: 5},
          {id: 3, name: 'นครหลวง', name_en: 'Nakhon Luang', province_id: 5},
          {id: 4, name: 'บางไทร', name_en: 'Bang Sai', province_id: 5},
          {id: 5, name: 'บางบาล', name_en: 'Bang Ban', province_id: 5},
          {id: 6, name: 'บางปะอิน', name_en: 'Bang Pa-in', province_id: 5},
          {id: 7, name: 'บางปะหัน', name_en: 'Bang Pahan', province_id: 5},
          {id: 8, name: 'พระนครศรีอยุธยา', name_en: 'Phra Nakhon Si Ayutthaya', province_id: 5},
          {id: 9, name: 'ลาดบัวหลวง', name_en: 'Lat Bua Luang', province_id: 5},
          {id: 10, name: 'วังน้อย', name_en: 'Wang Noi', province_id: 5},
          {id: 11, name: 'เสนา', name_en: 'Sena', province_id: 5},
          {id: 12, name: 'บางซ้าย', name_en: 'Bang Sai', province_id: 5},
          {id: 13, name: 'อุทัย', name_en: 'Uthai', province_id: 5},
          {id: 14, name: 'มหาราช', name_en: 'Maha Rat', province_id: 5},
          {id: 15, name: 'บ้านแพรก', name_en: 'Ban Phraek', province_id: 5},
          {id: 16, name: 'ภาชี', name_en: 'Phachi', province_id: 5}
        ],
        6: [ // อ่างทอง - All 7 Official Districts - Central Region 2024
          {id: 1, name: 'เมืองอ่างทอง', name_en: 'Mueang Ang Thong', province_id: 6},
          {id: 2, name: 'ไชโย', name_en: 'Chaiyo', province_id: 6},
          {id: 3, name: 'ป่าโมก', name_en: 'Pa Mok', province_id: 6},
          {id: 4, name: 'โพธิ์ทอง', name_en: 'Pho Thong', province_id: 6},
          {id: 5, name: 'แสวงหา', name_en: 'Sawaeng Ha', province_id: 6},
          {id: 6, name: 'วิเศษชัยชาญ', name_en: 'Wiset Chai Chan', province_id: 6},
          {id: 7, name: 'สามโก้', name_en: 'Samko', province_id: 6}
        ],
        7: [ // ลพบุรี - All 11 Official Districts - Central Historical Province 2024
          {id: 1, name: 'เมืองลพบุรี', name_en: 'Mueang Lopburi', province_id: 7},
          {id: 2, name: 'พัฒนานิคม', name_en: 'Phatthana Nikhom', province_id: 7},
          {id: 3, name: 'โคกสำโรง', name_en: 'Khok Samrong', province_id: 7},
          {id: 4, name: 'ชัยบาดาล', name_en: 'Chai Badan', province_id: 7},
          {id: 5, name: 'ท่าวุ้ง', name_en: 'Tha Wung', province_id: 7},
          {id: 6, name: 'บ้านหมี่', name_en: 'Ban Mi', province_id: 7},
          {id: 7, name: 'ท่าหลวง', name_en: 'Tha Luang', province_id: 7},
          {id: 8, name: 'สระโบสถ์', name_en: 'Sa Bot', province_id: 7},
          {id: 9, name: 'โคกเจริญ', name_en: 'Khok Charoen', province_id: 7},
          {id: 10, name: 'ลำสนธิ', name_en: 'Lam Sonthi', province_id: 7},
          {id: 11, name: 'หนองม่วง', name_en: 'Nong Muang', province_id: 7}
        ],
        8: [ // สิงห์บุรี - All 6 Official Districts - Central Small Province 2024
          {id: 1, name: 'เมืองสิงห์บุรี', name_en: 'Mueang Sing Buri', province_id: 8},
          {id: 2, name: 'บางระจัน', name_en: 'Bang Rachan', province_id: 8},
          {id: 3, name: 'ค่ายบางระจัน', name_en: 'Khai Bang Rachan', province_id: 8},
          {id: 4, name: 'อินทร์บุรี', name_en: 'In Buri', province_id: 8},
          {id: 5, name: 'พรหมบุรี', name_en: 'Phrom Buri', province_id: 8},
          {id: 6, name: 'ท่าช้าง', name_en: 'Tha Chang', province_id: 8}
        ],
        9: [ // ชัยนาท - All 8 Official Districts - Central Agricultural Province 2024
          {id: 1, name: 'เมืองชัยนาท', name_en: 'Mueang Chai Nat', province_id: 9},
          {id: 2, name: 'มโนรมย์', name_en: 'Manorom', province_id: 9},
          {id: 3, name: 'วัดสิงห์', name_en: 'Wat Sing', province_id: 9},
          {id: 4, name: 'เกษตรวิสัย', name_en: 'Sankhaburi', province_id: 9},
          {id: 5, name: 'หนองมะโมง', name_en: 'Nong Mamong', province_id: 9},
          {id: 6, name: 'หาดท่าเสา', name_en: 'Hankha', province_id: 9},
          {id: 7, name: 'เนินขาม', name_en: 'Noen Kham', province_id: 9},
          {id: 8, name: 'สรรคบุรี', name_en: 'Sapphaya', province_id: 9}
        ],
        10: [ // สระบุรี - All 13 Official Districts - Central Transportation Hub 2024
          {id: 1, name: 'เมืองสระบุรี', name_en: 'Mueang Saraburi', province_id: 10},
          {id: 2, name: 'แก่งคอย', name_en: 'Kaeng Khoi', province_id: 10},
          {id: 3, name: 'หนองแค', name_en: 'Nong Khae', province_id: 10},
          {id: 4, name: 'วิหารแดง', name_en: 'Wihan Daeng', province_id: 10},
          {id: 5, name: 'หนองแซง', name_en: 'Nong Saeng', province_id: 10},
          {id: 6, name: 'บ้านหมอ', name_en: 'Ban Mo', province_id: 10},
          {id: 7, name: 'ดอนพุด', name_en: 'Don Phut', province_id: 10},
          {id: 8, name: 'หนองโดน', name_en: 'Nong Don', province_id: 10},
          {id: 9, name: 'พระพุทธบาท', name_en: 'Phra Phutthabat', province_id: 10},
          {id: 10, name: 'เสาไห้', name_en: 'Sao Hai', province_id: 10},
          {id: 11, name: 'มวกเหล็ก', name_en: 'Muak Lek', province_id: 10},
          {id: 12, name: 'วังม่วง', name_en: 'Wang Muang', province_id: 10},
          {id: 13, name: 'เฉลิมพระเกียรติ', name_en: 'Chaloem Phra Kiat', province_id: 10}
        ],
        13: [ // จันทบุรี - All 10 Official Districts - Eastern Gem Province 2024
          {id: 1, name: 'เมืองจันทบุรี', name_en: 'Mueang Chanthaburi', province_id: 13},
          {id: 2, name: 'ขลุง', name_en: 'Khlung', province_id: 13},
          {id: 3, name: 'ท่าใหม่', name_en: 'Tha Mai', province_id: 13},
          {id: 4, name: 'โป่งน้ำร้อน', name_en: 'Pong Nam Ron', province_id: 13},
          {id: 5, name: 'สอยดาว', name_en: 'Soi Dao', province_id: 13},
          {id: 6, name: 'แก่งหางแมว', name_en: 'Kaeng Hang Maeo', province_id: 13},
          {id: 7, name: 'นายายอาม', name_en: 'Na Yai Am', province_id: 13},
          {id: 8, name: 'แหลมสิงห์', name_en: 'Laem Sing', province_id: 13},
          {id: 9, name: 'มะขาม', name_en: 'Makham', province_id: 13},
          {id: 10, name: 'เขาคิชฌกูฏ', name_en: 'Khao Khitchakut', province_id: 13}
        ],
        14: [ // ตราด - All 7 Official Districts - Eastern Border Province 2024
          {id: 1, name: 'เมืองตราด', name_en: 'Mueang Trat', province_id: 14},
          {id: 2, name: 'คลองใหญ่', name_en: 'Khlong Yai', province_id: 14},
          {id: 3, name: 'เขาสมิง', name_en: 'Khao Saming', province_id: 14},
          {id: 4, name: 'บ่อไร่', name_en: 'Bo Rai', province_id: 14},
          {id: 5, name: 'เกาะกูด', name_en: 'Ko Kut', province_id: 14},
          {id: 6, name: 'เกาะช้าง', name_en: 'Ko Chang', province_id: 14},
          {id: 7, name: 'เกาะกง', name_en: 'Ko Kong', province_id: 14}
        ],
        15: [ // ฉะเชิงเทรา - All 11 Official Districts - Eastern Agricultural Province 2024
          {id: 1, name: 'เมืองฉะเชิงเทรา', name_en: 'Mueang Chachoengsao', province_id: 15},
          {id: 2, name: 'บางคล้า', name_en: 'Bang Khla', province_id: 15},
          {id: 3, name: 'บางน้ำเปรี้ยว', name_en: 'Bang Nam Priao', province_id: 15},
          {id: 4, name: 'บางปะกง', name_en: 'Bang Pakong', province_id: 15},
          {id: 5, name: 'บ้านโพธิ์', name_en: 'Ban Pho', province_id: 15},
          {id: 6, name: 'ปลาปาก', name_en: 'Pla Pak', province_id: 15},
          {id: 7, name: 'ราชสาสน์', name_en: 'Ratchasan', province_id: 15},
          {id: 8, name: 'สนามชัยเขต', name_en: 'Sanam Chai Khet', province_id: 15},
          {id: 9, name: 'แปลงยาว', name_en: 'Plaeng Yao', province_id: 15},
          {id: 10, name: 'ท่าตะเกียบ', name_en: 'Tha Takiab', province_id: 15},
          {id: 11, name: 'คลองเขื่อน', name_en: 'Khlong Khuean', province_id: 15}
        ],
        16: [ // ปราจีนบุรี - All 8 Official Districts - Eastern Province 2024
          {id: 1, name: 'เมืองปราจีนบุรี', name_en: 'Mueang Prachinburi', province_id: 16},
          {id: 2, name: 'กบินทร์บุรี', name_en: 'Kabin Buri', province_id: 16},
          {id: 3, name: 'นาดี', name_en: 'Na Di', province_id: 16},
          {id: 4, name: 'บ้านสร้าง', name_en: 'Ban Sang', province_id: 16},
          {id: 5, name: 'ประจันตคาม', name_en: 'Prachantakham', province_id: 16},
          {id: 6, name: 'ศรีมโหสถ', name_en: 'Si Maha Phot', province_id: 16},
          {id: 7, name: 'ศรีมหาโพธิ', name_en: 'Si Maha Pho', province_id: 16},
          {id: 8, name: 'เมืองใหม่', name_en: 'Mueang Mai', province_id: 16}
        ],
        17: [ // นครนายก - All 4 Official Districts - Central Small Province 2024
          {id: 1, name: 'เมืองนครนายก', name_en: 'Mueang Nakhon Nayok', province_id: 17},
          {id: 2, name: 'ปากพลี', name_en: 'Pak Phli', province_id: 17},
          {id: 3, name: 'บ้านนา', name_en: 'Ban Na', province_id: 17},
          {id: 4, name: 'องครักษ์', name_en: 'Ongkharak', province_id: 17}
        ],
        18: [ // สระแก้ว - All 7 Official Districts - Eastern Border Province 2024
          {id: 1, name: 'เมืองสระแก้ว', name_en: 'Mueang Sa Kaeo', province_id: 18},
          {id: 2, name: 'คลองหาด', name_en: 'Khlong Hat', province_id: 18},
          {id: 3, name: 'ตาพระยา', name_en: 'Ta Phraya', province_id: 18},
          {id: 4, name: 'วังน้ำเย็น', name_en: 'Wang Nam Yen', province_id: 18},
          {id: 5, name: 'วัฒนานคร', name_en: 'Watthana Nakhon', province_id: 18},
          {id: 6, name: 'อรัญประเทศ', name_en: 'Aranyaprathet', province_id: 18},
          {id: 7, name: 'เขาฉกรรจ์', name_en: 'Khao Chakan', province_id: 18}
        ],
        21: [ // สุรินทร์ - All 17 Official Districts - Northeast Cultural Province 2024
          {id: 1, name: 'เมืองสุรินทร์', name_en: 'Mueang Surin', province_id: 21},
          {id: 2, name: 'ชุมพลบุรี', name_en: 'Chumphon Buri', province_id: 21},
          {id: 3, name: 'ท่าตูม', name_en: 'Tha Tum', province_id: 21},
          {id: 4, name: 'จอมพระ', name_en: 'Chom Phra', province_id: 21},
          {id: 5, name: 'ประทาย', name_en: 'Prathid', province_id: 21},
          {id: 6, name: 'กาบเชิง', name_en: 'Kap Choeng', province_id: 21},
          {id: 7, name: 'รัตนบุรี', name_en: 'Rattanaburi', province_id: 21},
          {id: 8, name: 'สนม', name_en: 'Sanom', province_id: 21},
          {id: 9, name: 'ศีขรภูมิ', name_en: 'Sikhoraphum', province_id: 21},
          {id: 10, name: 'สังขะ', name_en: 'Sangkha', province_id: 21},
          {id: 11, name: 'ลำดวน', name_en: 'Lamduan', province_id: 21},
          {id: 12, name: 'สำโรงทาบ', name_en: 'Samrong Thab', province_id: 21},
          {id: 13, name: 'บัวเชด', name_en: 'Buachet', province_id: 21},
          {id: 14, name: 'พนมดงรัก', name_en: 'Phanom Dong Rak', province_id: 21},
          {id: 15, name: 'ศรีณรงค์', name_en: 'Si Narong', province_id: 21},
          {id: 16, name: 'เขวาสินรินทร์', name_en: 'Khwao Sinrin', province_id: 21},
          {id: 17, name: 'โนนนารายณ์', name_en: 'Non Narai', province_id: 21}
        ],
        22: [ // ศรีสะเกษ - All 22 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองศรีสะเกษ', name_en: 'Mueang Sisaket', province_id: 22},
          {id: 2, name: 'ยางชุมน้อย', name_en: 'Yang Chum Noi', province_id: 22},
          {id: 3, name: 'กันทรารมย์', name_en: 'Kanthararom', province_id: 22},
          {id: 4, name: 'กันทรลักษ์', name_en: 'Kantharalak', province_id: 22},
          {id: 5, name: 'ราษีไศล', name_en: 'Rasi Salai', province_id: 22},
          {id: 6, name: 'อุทุมพรพิสัย', name_en: 'Uthumphon Phisai', province_id: 22},
          {id: 7, name: 'บึงบูรพ์', name_en: 'Bueng Bun', province_id: 22},
          {id: 8, name: 'ห้วยทับทัน', name_en: 'Huai Thap Than', province_id: 22},
          {id: 9, name: 'โนนคูณ', name_en: 'Non Khun', province_id: 22},
          {id: 10, name: 'ศรีรัตนะ', name_en: 'Si Rattana', province_id: 22},
          {id: 11, name: 'น้ำเกลี้ยง', name_en: 'Nam Kliang', province_id: 22},
          {id: 12, name: 'วังหิน', name_en: 'Wang Hin', province_id: 22},
          {id: 13, name: 'ภูสิงห์', name_en: 'Phu Sing', province_id: 22},
          {id: 14, name: 'เมืองจันทร์', name_en: 'Mueang Chan', province_id: 22},
          {id: 15, name: 'เบญจลักษ์', name_en: 'Benchalak', province_id: 22},
          {id: 16, name: 'โพธิ์ศรีสุวรรณ', name_en: 'Pho Si Suwan', province_id: 22},
          {id: 17, name: 'โคกเคร็ด', name_en: 'Khok Kret', province_id: 22},
          {id: 18, name: 'พยุห์', name_en: 'Phayu', province_id: 22},
          {id: 19, name: 'โพธิ์ไทร', name_en: 'Pho Sai', province_id: 22},
          {id: 20, name: 'สิลาลาด', name_en: 'Sila Lat', province_id: 22},
          {id: 21, name: 'ราชาภัฏ', name_en: 'Ratchabhat', province_id: 22},
          {id: 22, name: 'บักเซียด', name_en: 'Bak Siad', province_id: 22}
        ],
        24: [ // ยโสธร - All 9 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองยโสธร', name_en: 'Mueang Yasothon', province_id: 24},
          {id: 2, name: 'เสลภูมิ', name_en: 'Sela Phum', province_id: 24},
          {id: 3, name: 'กุดชุม', name_en: 'Kut Chum', province_id: 24},
          {id: 4, name: 'ค้อวัง', name_en: 'Kho Wang', province_id: 24},
          {id: 5, name: 'ป่าติ้ว', name_en: 'Pa Tio', province_id: 24},
          {id: 6, name: 'มหาชนะชัย', name_en: 'Maha Chana Chai', province_id: 24},
          {id: 7, name: 'กาบเชิง', name_en: 'Kap Choeng', province_id: 24},
          {id: 8, name: 'ลอยทอง', name_en: 'Loeng Nok Tha', province_id: 24},
          {id: 9, name: 'ไทยเจริญ', name_en: 'Thai Charoen', province_id: 24}
        ],
        25: [ // ชัยภูมิ - All 16 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองชัยภูมิ', name_en: 'Mueang Chaiyaphum', province_id: 25},
          {id: 2, name: 'บ้านเขว้า', name_en: 'Ban Khwao', province_id: 25},
          {id: 3, name: 'บำเหน็จณรงค์', name_en: 'Bamnet Narong', province_id: 25},
          {id: 4, name: 'จัตุรัส', name_en: 'Chaturat', province_id: 25},
          {id: 5, name: 'แก้งคร้อ', name_en: 'Kaeng Khro', province_id: 25},
          {id: 6, name: 'คอนสวรรค์', name_en: 'Khon Sawan', province_id: 25},
          {id: 7, name: 'คอนสาร', name_en: 'Khon San', province_id: 25},
          {id: 8, name: 'โนนสังข์', name_en: 'Noen Sa-nga', province_id: 25},
          {id: 9, name: 'หนองบัวระเหว', name_en: 'Nong Bua Rawe', province_id: 25},
          {id: 10, name: 'เทพสถิต', name_en: 'Thep Sathit', province_id: 25},
          {id: 11, name: 'ภักดีชุมพล', name_en: 'Phakdi Chumphon', province_id: 25},
          {id: 12, name: 'ภูเขียว', name_en: 'Phu Khieo', province_id: 25},
          {id: 13, name: 'เนินสง่า', name_en: 'Nong Bua Daeng', province_id: 25},
          {id: 14, name: 'แสงสว่าง', name_en: 'Saeng Sang', province_id: 25},
          {id: 15, name: 'สับใหญ่', name_en: 'Sap Yai', province_id: 25},
          {id: 16, name: 'หนองบัวแดง', name_en: 'Nong Bua Daeng', province_id: 25}
        ],
        26: [ // อำนาจเจริญ - All 7 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองอำนาจเจริญ', name_en: 'Mueang Amnat Charoen', province_id: 26},
          {id: 2, name: 'ชานุมาน', name_en: 'Chanuman', province_id: 26},
          {id: 3, name: 'เสนางคนิคม', name_en: 'Senangkhanikhom', province_id: 26},
          {id: 4, name: 'ปทุมราชวงศา', name_en: 'Pathum Ratchawongsa', province_id: 26},
          {id: 5, name: 'หัวตะพาน', name_en: 'Hua Taphan', province_id: 26},
          {id: 6, name: 'ลืออำนาจ', name_en: 'Lue Amnat', province_id: 26},
          {id: 7, name: 'พนา', name_en: 'Phana', province_id: 26}
        ],
        27: [ // หนองบัวลำภู - All 6 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองหนองบัวลำภู', name_en: 'Mueang Nong Bua Lam Phu', province_id: 27},
          {id: 2, name: 'นาคลาง', name_en: 'Na Klang', province_id: 27},
          {id: 3, name: 'นาวัง', name_en: 'Na Wang', province_id: 27},
          {id: 4, name: 'โนนสัง', name_en: 'Non Sang', province_id: 27},
          {id: 5, name: 'ศรีบุญเรือง', name_en: 'Si Bun Rueang', province_id: 27},
          {id: 6, name: 'สุวรรณคูหา', name_en: 'Suwannakhuha', province_id: 27}
        ],
        30: [ // เลย - All 14 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองเลย', name_en: 'Mueang Loei', province_id: 30},
          {id: 2, name: 'นาด้วง', name_en: 'Na Duang', province_id: 30},
          {id: 3, name: 'นาแห้ว', name_en: 'Na Haeo', province_id: 30},
          {id: 4, name: 'ภูเก็ต', name_en: 'Phu Kradueng', province_id: 30},
          {id: 5, name: 'ภูหลวง', name_en: 'Phu Luang', province_id: 30},
          {id: 6, name: 'ผาขาว', name_en: 'Pha Khao', province_id: 30},
          {id: 7, name: 'ด่านซ้าย', name_en: 'Dan Sai', province_id: 30},
          {id: 8, name: 'นาด้วง', name_en: 'Na Duang', province_id: 30},
          {id: 9, name: 'ภูเรือ', name_en: 'Phu Ruea', province_id: 30},
          {id: 10, name: 'ท่าลี่', name_en: 'Tha Li', province_id: 30},
          {id: 11, name: 'วังสะพุง', name_en: 'Wang Saphung', province_id: 30},
          {id: 12, name: 'ปากชม', name_en: 'Pak Chom', province_id: 30},
          {id: 13, name: 'เชียงคาน', name_en: 'Chiang Khan', province_id: 30},
          {id: 14, name: 'เอราวัณ', name_en: 'Erawan', province_id: 30}
        ],
        31: [ // หนองคาย - All 7 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองหนองคาย', name_en: 'Mueang Nong Khai', province_id: 31},
          {id: 2, name: 'ท่าบ่อ', name_en: 'Tha Bo', province_id: 31},
          {id: 3, name: 'โพนพิสัย', name_en: 'Phon Phisai', province_id: 31},
          {id: 4, name: 'ศรีเชียงใหม่', name_en: 'Si Chiang Mai', province_id: 31},
          {id: 5, name: 'รัตนวาปี', name_en: 'Rattanawapi', province_id: 31},
          {id: 6, name: 'สังคม', name_en: 'Sangkhom', province_id: 31},
          {id: 7, name: 'ฝั่งแดง', name_en: 'Fang Daeng', province_id: 31}
        ],
        32: [ // มหาสารคาม - All 13 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองมหาสารคาม', name_en: 'Mueang Maha Sarakham', province_id: 32},
          {id: 2, name: 'กันทรวิชัย', name_en: 'Kantharawichai', province_id: 32},
          {id: 3, name: 'เชียงยืน', name_en: 'Chiang Yuen', province_id: 32},
          {id: 4, name: 'บรบือ', name_en: 'Borabue', province_id: 32},
          {id: 5, name: 'นาเชือก', name_en: 'Na Chueak', province_id: 32},
          {id: 6, name: 'นาดูน', name_en: 'Na Dun', province_id: 32},
          {id: 7, name: 'ยางสีสุราช', name_en: 'Yang Sisurat', province_id: 32},
          {id: 8, name: 'วาปีปทุม', name_en: 'Wapi Pathum', province_id: 32},
          {id: 9, name: 'โกสุมพิสัย', name_en: 'Kosum Phisai', province_id: 32},
          {id: 10, name: 'กุดรัง', name_en: 'Kut Rang', province_id: 32},
          {id: 11, name: 'ชื่นชม', name_en: 'Chuen Chom', province_id: 32},
          {id: 12, name: 'พยัคฆภูมิพิสัย', name_en: 'Phayakkhaphum Phisai', province_id: 32},
          {id: 13, name: 'เขื่องใน', name_en: 'Khuang Nai', province_id: 32}
        ],
        33: [ // ร้อยเอ็ด - All 20 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองร้อยเอ็ด', name_en: 'Mueang Roi Et', province_id: 33},
          {id: 2, name: 'เกษตรวิสัย', name_en: 'Kaset Wisai', province_id: 33},
          {id: 3, name: 'ปทุมรัตต์', name_en: 'Pathum Rat', province_id: 33},
          {id: 4, name: 'เชียงขวัญ', name_en: 'Chiang Khwan', province_id: 33},
          {id: 5, name: 'เสลภูมิ', name_en: 'Selaphum', province_id: 33},
          {id: 6, name: 'สุวรรณภูมิ', name_en: 'Suwannaphum', province_id: 33},
          {id: 7, name: 'ธวัชบุรี', name_en: 'Thawat Buri', province_id: 33},
          {id: 8, name: 'พนมไพร', name_en: 'Phanom Phrai', province_id: 33},
          {id: 9, name: 'โพนทราย', name_en: 'Phon Sai', province_id: 33},
          {id: 10, name: 'โพนทอง', name_en: 'Phon Thong', province_id: 33},
          {id: 11, name: 'โพธิ์ชัย', name_en: 'Pho Chai', province_id: 33},
          {id: 12, name: 'หนองพอก', name_en: 'Nong Phok', province_id: 33},
          {id: 13, name: 'หนองหี', name_en: 'Nong Hi', province_id: 33},
          {id: 14, name: 'เอราวัณ', name_en: 'At Samat', province_id: 33},
          {id: 15, name: 'ลำดวน', name_en: 'Lam Duan', province_id: 33},
          {id: 16, name: 'เมยวดี', name_en: 'May', province_id: 33},
          {id: 17, name: 'จังหาร', name_en: 'Jangha', province_id: 33},
          {id: 18, name: 'จตุรพักตรพิมาน', name_en: 'Chaturaphak Phiman', province_id: 33},
          {id: 19, name: 'เมืองสรวง', name_en: 'Mueang Suang', province_id: 33},
          {id: 20, name: 'โคกสวาง', name_en: 'Khok Sawang', province_id: 33}
        ],
        34: [ // กาฬสินธุ์ - All 18 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองกาฬสินธุ์', name_en: 'Mueang Kalasin', province_id: 34},
          {id: 2, name: 'นามน', name_en: 'Na Mon', province_id: 34},
          {id: 3, name: 'กมลาไสย', name_en: 'Kamalasai', province_id: 34},
          {id: 4, name: 'ร่องคำ', name_en: 'Rong Kham', province_id: 34},
          {id: 5, name: 'กุฉินารายณ์', name_en: 'Kuchinarai', province_id: 34},
          {id: 6, name: 'เขาวง', name_en: 'Khao Wong', province_id: 34},
          {id: 7, name: 'ยางตลาด', name_en: 'Yang Talat', province_id: 34},
          {id: 8, name: 'ห้วยผึ้ง', name_en: 'Huai Phueng', province_id: 34},
          {id: 9, name: 'สมเด็จ', name_en: 'Sahatsakhan', province_id: 34},
          {id: 10, name: 'กุดบาก', name_en: 'Kut Bak', province_id: 34},
          {id: 11, name: 'ท่าคันโท', name_en: 'Tha Khantho', province_id: 34},
          {id: 12, name: 'หนองกุงศรี', name_en: 'Nong Kung Si', province_id: 34},
          {id: 13, name: 'สมเด็จ', name_en: 'Somdet', province_id: 34},
          {id: 14, name: 'ห้วยเม็ก', name_en: 'Huai Mek', province_id: 34},
          {id: 15, name: 'ดอนจาน', name_en: 'Don Chan', province_id: 34},
          {id: 16, name: 'เสียงทราย', name_en: 'Saeng Sai', province_id: 34},
          {id: 17, name: 'นาคู', name_en: 'Na Khu', province_id: 34},
          {id: 18, name: 'ค่าราชอำนาจ', name_en: 'Khama Rachophatthana', province_id: 34}
        ],
        35: [ // สกลนคร - All 18 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองสกลนคร', name_en: 'Mueang Sakon Nakhon', province_id: 35},
          {id: 2, name: 'กุสุมาลย์', name_en: 'Kusuman', province_id: 35},
          {id: 3, name: 'กุดบาก', name_en: 'Kut Bak', province_id: 35},
          {id: 4, name: 'พรรณานิคม', name_en: 'Phanna Nikhom', province_id: 35},
          {id: 5, name: 'พังโคน', name_en: 'Phang Khon', province_id: 35},
          {id: 6, name: 'วาริชภูมิ', name_en: 'Waritchaphum', province_id: 35},
          {id: 7, name: 'นิคมน้ำอูน', name_en: 'Nikhom Nam Un', province_id: 35},
          {id: 8, name: 'วานรนิวาส', name_en: 'Wanon Niwat', province_id: 35},
          {id: 9, name: 'คำตากล้า', name_en: 'Kham Ta Kla', province_id: 35},
          {id: 10, name: 'บ้านม่วง', name_en: 'Ban Muang', province_id: 35},
          {id: 11, name: 'อากาศอำนวย', name_en: 'Akat Amnuai', province_id: 35},
          {id: 12, name: 'ส่องดาว', name_en: 'Song Dao', province_id: 35},
          {id: 13, name: 'เต่างอย', name_en: 'Tao Ngoi', province_id: 35},
          {id: 14, name: 'โคกศรีสุพรรณ', name_en: 'Khok Si Suphan', province_id: 35},
          {id: 15, name: 'อากาศอำนวย', name_en: 'Agat Amnuai', province_id: 35},
          {id: 16, name: 'เซกา', name_en: 'Seka', province_id: 35},
          {id: 17, name: 'เต่างอย', name_en: 'Tao Ngoi', province_id: 35},
          {id: 18, name: 'โพนนาแก้ว', name_en: 'Phon Na Kaeo', province_id: 35}
        ],
        36: [ // นครพนม - All 12 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองนครพนม', name_en: 'Mueang Nakhon Phanom', province_id: 36},
          {id: 2, name: 'ปลาปาก', name_en: 'Pla Pak', province_id: 36},
          {id: 3, name: 'ท่าอุเทน', name_en: 'Tha Uthen', province_id: 36},
          {id: 4, name: 'บ้านแพง', name_en: 'Ban Phaeng', province_id: 36},
          {id: 5, name: 'ธาตุพนม', name_en: 'That Phanom', province_id: 36},
          {id: 6, name: 'เรณูนคร', name_en: 'Renu Nakhon', province_id: 36},
          {id: 7, name: 'นาแก', name_en: 'Na Kae', province_id: 36},
          {id: 8, name: 'ศรีสงคราม', name_en: 'Si Songkhram', province_id: 36},
          {id: 9, name: 'นาหว้า', name_en: 'Na Wa', province_id: 36},
          {id: 10, name: 'โพนสวรรค์', name_en: 'Phon Sawan', province_id: 36},
          {id: 11, name: 'นาทม', name_en: 'Na Thom', province_id: 36},
          {id: 12, name: 'วังยาง', name_en: 'Wang Yang', province_id: 36}
        ],
        37: [ // มุกดาหาร - All 7 Official Districts - Northeast Border Province 2024
          {id: 1, name: 'เมืองมุกดาหาร', name_en: 'Mueang Mukdahan', province_id: 37},
          {id: 2, name: 'นิคมคำสร้อย', name_en: 'Nikhom Kham Soi', province_id: 37},
          {id: 3, name: 'ดอนตาล', name_en: 'Don Tan', province_id: 37},
          {id: 4, name: 'ดงหลวง', name_en: 'Dong Luang', province_id: 37},
          {id: 5, name: 'คำชะอี', name_en: 'Kham Cha-i', province_id: 37},
          {id: 6, name: 'หว้านให้ใหญ่', name_en: 'Wan Yai', province_id: 37},
          {id: 7, name: 'ดอนตาล', name_en: 'Don Tan', province_id: 37}
        ],
        39: [ // ลำพูน - All 8 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองลำพูน', name_en: 'Mueang Lamphun', province_id: 39},
          {id: 2, name: 'บ้านโฮ่ง', name_en: 'Ban Hong', province_id: 39},
          {id: 3, name: 'ลี้', name_en: 'Li', province_id: 39},
          {id: 4, name: 'ทุ่งหัวช้าง', name_en: 'Thung Hua Chang', province_id: 39},
          {id: 5, name: 'ป่าซาง', name_en: 'Pa Sang', province_id: 39},
          {id: 6, name: 'บ้านธิ', name_en: 'Ban Thi', province_id: 39},
          {id: 7, name: 'เวียงหนองล่อง', name_en: 'Wiang Nong Long', province_id: 39},
          {id: 8, name: 'แม่ทา', name_en: 'Mae Tha', province_id: 39}
        ],
        40: [ // ลำปาง - All 13 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองลำปาง', name_en: 'Mueang Lampang', province_id: 40},
          {id: 2, name: 'แก้วฟ้า', name_en: 'Kaeo Fa', province_id: 40},
          {id: 3, name: 'เถิน', name_en: 'Thoen', province_id: 40},
          {id: 4, name: 'แม่เมาะ', name_en: 'Mae Mo', province_id: 40},
          {id: 5, name: 'เกาะคา', name_en: 'Ko Kha', province_id: 40},
          {id: 6, name: 'เสริมงาม', name_en: 'Soem Ngam', province_id: 40},
          {id: 7, name: 'งาว', name_en: 'Ngao', province_id: 40},
          {id: 8, name: 'แจ้ห่ม', name_en: 'Chae Hom', province_id: 40},
          {id: 9, name: 'วังเหนือ', name_en: 'Wang Nuea', province_id: 40},
          {id: 10, name: 'เหนือคลอง', name_en: 'Nuea Khlong', province_id: 40},
          {id: 11, name: 'แม่พริก', name_en: 'Mae Phrik', province_id: 40},
          {id: 12, name: 'สบปราบ', name_en: 'Sop Prap', province_id: 40},
          {id: 13, name: 'หล่มแก่น', name_en: 'Lom Kao', province_id: 40}
        ],
        41: [ // อุตรดิตถ์ - All 9 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองอุตรดิตถ์', name_en: 'Mueang Uttaradit', province_id: 41},
          {id: 2, name: 'ตรอน', name_en: 'Tron', province_id: 41},
          {id: 3, name: 'ลับแล', name_en: 'Lap Lae', province_id: 41},
          {id: 4, name: 'ท่าปลา', name_en: 'Tha Pla', province_id: 41},
          {id: 5, name: 'น้ำปาด', name_en: 'Nam Pat', province_id: 41},
          {id: 6, name: 'ฟากท่า', name_en: 'Fak Tha', province_id: 41},
          {id: 7, name: 'บ้านโคก', name_en: 'Ban Khok', province_id: 41},
          {id: 8, name: 'ทองแสนขัน', name_en: 'Thong Saen Khan', province_id: 41},
          {id: 9, name: 'พิจิตร', name_en: 'Phichit', province_id: 41}
        ],
        42: [ // แพร่ - All 8 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองแพร่', name_en: 'Mueang Phrae', province_id: 42},
          {id: 2, name: 'ร้องกวาง', name_en: 'Rong Kwang', province_id: 42},
          {id: 3, name: 'ลอง', name_en: 'Long', province_id: 42},
          {id: 4, name: 'สูงเม่น', name_en: 'Sung Men', province_id: 42},
          {id: 5, name: 'เด่นชัย', name_en: 'Den Chai', province_id: 42},
          {id: 6, name: 'สอง', name_en: 'Song', province_id: 42},
          {id: 7, name: 'วังชิ้น', name_en: 'Wang Chin', province_id: 42},
          {id: 8, name: 'หนองม่วงไข่', name_en: 'Nong Muang Khai', province_id: 42}
        ],
        43: [ // น่าน - All 15 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองน่าน', name_en: 'Mueang Nan', province_id: 43},
          {id: 2, name: 'แม่จริม', name_en: 'Mae Charim', province_id: 43},
          {id: 3, name: 'บ้านหลวง', name_en: 'Ban Luang', province_id: 43},
          {id: 4, name: 'นาน้อย', name_en: 'Na Noi', province_id: 43},
          {id: 5, name: 'ปัว', name_en: 'Pua', province_id: 43},
          {id: 6, name: 'ท่าวังผา', name_en: 'Tha Wang Pha', province_id: 43},
          {id: 7, name: 'เวียงสา', name_en: 'Wiang Sa', province_id: 43},
          {id: 8, name: 'ทุ่งช้าง', name_en: 'Thung Chang', province_id: 43},
          {id: 9, name: 'เฉลิมพระเกียรติ', name_en: 'Chaloem Phra Kiat', province_id: 43},
          {id: 10, name: 'นาหมื่น', name_en: 'Na Muen', province_id: 43},
          {id: 11, name: 'สันติสุข', name_en: 'Santisuk', province_id: 43},
          {id: 12, name: 'บ่อเกลือ', name_en: 'Bo Kluea', province_id: 43},
          {id: 13, name: 'สองพี่น้อง', name_en: 'Song Phi Nong', province_id: 43},
          {id: 14, name: 'เชียงกลาง', name_en: 'Chiang Klang', province_id: 43},
          {id: 15, name: 'แม่เจ้า', name_en: 'Mae Chao', province_id: 43}
        ],
        44: [ // พะเยา - All 9 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองพะเยา', name_en: 'Mueang Phayao', province_id: 44},
          {id: 2, name: 'เชียงคำ', name_en: 'Chiang Kham', province_id: 44},
          {id: 3, name: 'เชียงม่วน', name_en: 'Chiang Muan', province_id: 44},
          {id: 4, name: 'ดอกคำใต้', name_en: 'Dok Kham Tai', province_id: 44},
          {id: 5, name: 'ปง', name_en: 'Pong', province_id: 44},
          {id: 6, name: 'แม่ใจ', name_en: 'Mae Chai', province_id: 44},
          {id: 7, name: 'จุน', name_en: 'Chun', province_id: 44},
          {id: 8, name: 'ภูเซียง', name_en: 'Phu Sang', province_id: 44},
          {id: 9, name: 'ภูกามยาว', name_en: 'Phu Kam Yao', province_id: 44}
        ],
        46: [ // แม่ฮ่องสอน - All 7 Official Districts - Northern Province 2024
          {id: 1, name: 'เมืองแม่ฮ่องสอน', name_en: 'Mueang Mae Hong Son', province_id: 46},
          {id: 2, name: 'ขุนยวม', name_en: 'Khun Yuam', province_id: 46},
          {id: 3, name: 'ปาย', name_en: 'Pai', province_id: 46},
          {id: 4, name: 'แม่สะเรียง', name_en: 'Mae Sariang', province_id: 46},
          {id: 5, name: 'แม่ลาน้อย', name_en: 'Mae La Noi', province_id: 46},
          {id: 6, name: 'สบเมย', name_en: 'Sop Moei', province_id: 46},
          {id: 7, name: 'แม่ข่า', name_en: 'Mae Kha', province_id: 46}
        ],
        47: [ // นครสวรรค์ - All 15 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองนครสวรรค์', name_en: 'Mueang Nakhon Sawan', province_id: 47},
          {id: 2, name: 'โกรกพระ', name_en: 'Krok Phra', province_id: 47},
          {id: 3, name: 'ชุมแสง', name_en: 'Chum Saeng', province_id: 47},
          {id: 4, name: 'หนองบัว', name_en: 'Nong Bua', province_id: 47},
          {id: 5, name: 'บรรพตพิสัย', name_en: 'Banphot Phisai', province_id: 47},
          {id: 6, name: 'เก้าเลี้ยว', name_en: 'Kao Liao', province_id: 47},
          {id: 7, name: 'ตาคลี', name_en: 'Tak Li', province_id: 47},
          {id: 8, name: 'ท่าตะโก', name_en: 'Tha Tako', province_id: 47},
          {id: 9, name: 'ไพศาลี', name_en: 'Phaisali', province_id: 47},
          {id: 10, name: 'พยุหะคีรี', name_en: 'Phayuha Khiri', province_id: 47},
          {id: 11, name: 'ลาดยาว', name_en: 'Lat Yao', province_id: 47},
          {id: 12, name: 'ตากฟ้า', name_en: 'Tak Fa', province_id: 47},
          {id: 13, name: 'แม่วงก์', name_en: 'Mae Wong', province_id: 47},
          {id: 14, name: 'แม่เปิน', name_en: 'Mae Poen', province_id: 47},
          {id: 15, name: 'ชุมตาบง', name_en: 'Chum Ta Bong', province_id: 47}
        ],
        48: [ // อุทัยธานี - All 8 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองอุทัยธานี', name_en: 'Mueang Uthai Thani', province_id: 48},
          {id: 2, name: 'ทัพทัน', name_en: 'Thap Than', province_id: 48},
          {id: 3, name: 'ศรีสำโรง', name_en: 'Sawang Arom', province_id: 48},
          {id: 4, name: 'หนองขาหย่าง', name_en: 'Nong Khayang', province_id: 48},
          {id: 5, name: 'หนองฉาง', name_en: 'Nong Chang', province_id: 48},
          {id: 6, name: 'บ้านไร่', name_en: 'Ban Rai', province_id: 48},
          {id: 7, name: 'ลานสัก', name_en: 'Lan Sak', province_id: 48},
          {id: 8, name: 'ห้วยคต', name_en: 'Huai Khot', province_id: 48}
        ],
        49: [ // กำแพงเพชร - All 11 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองกำแพงเพชร', name_en: 'Mueang Kamphaeng Phet', province_id: 49},
          {id: 2, name: 'ไทรงาม', name_en: 'Sai Ngam', province_id: 49},
          {id: 3, name: 'คลองลาน', name_en: 'Khlong Lan', province_id: 49},
          {id: 4, name: 'ขาณุวรลักษบุรี', name_en: 'Khanu Woralaksaburi', province_id: 49},
          {id: 5, name: 'คลองขลุง', name_en: 'Khlong Khlung', province_id: 49},
          {id: 6, name: 'พรานกระต่าย', name_en: 'Phran Kratai', province_id: 49},
          {id: 7, name: 'ลานกระบือ', name_en: 'Lan Krabue', province_id: 49},
          {id: 8, name: 'ทรายทองวัฒนา', name_en: 'Sai Thong Watthana', province_id: 49},
          {id: 9, name: 'ปางศิลาทอง', name_en: 'Pang Sila Thong', province_id: 49},
          {id: 10, name: 'บึงสามัคคี', name_en: 'Bueng Samakkhi', province_id: 49},
          {id: 11, name: 'โกสัมพีนคร', name_en: 'Kosamphi Nakhon', province_id: 49}
        ],
        50: [ // ตาก - All 9 Official Districts - Western Province 2024
          {id: 1, name: 'เมืองตาก', name_en: 'Mueang Tak', province_id: 50},
          {id: 2, name: 'บ้านตาก', name_en: 'Ban Tak', province_id: 50},
          {id: 3, name: 'สามเงา', name_en: 'Sam Ngao', province_id: 50},
          {id: 4, name: 'แม่ระมาด', name_en: 'Mae Ramat', province_id: 50},
          {id: 5, name: 'ท่าสองยาง', name_en: 'Tha Song Yang', province_id: 50},
          {id: 6, name: 'แม่สอด', name_en: 'Mae Sot', province_id: 50},
          {id: 7, name: 'ป๊อบพระ', name_en: 'Phop Phra', province_id: 50},
          {id: 8, name: 'อุ้มผาง', name_en: 'Um Phang', province_id: 50},
          {id: 9, name: 'วังเจ้า', name_en: 'Wang Chao', province_id: 50}
        ],
        51: [ // สุโขทัย - All 9 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองสุโขทัย', name_en: 'Mueang Sukhothai', province_id: 51},
          {id: 2, name: 'บ้านด่านลานหอย', name_en: 'Ban Dan Lan Hoi', province_id: 51},
          {id: 3, name: 'คีรีมาศ', name_en: 'Khiri Mat', province_id: 51},
          {id: 4, name: 'กงไกรลาศ', name_en: 'Kong Krailat', province_id: 51},
          {id: 5, name: 'ศรีสำโรง', name_en: 'Si Samrong', province_id: 51},
          {id: 6, name: 'ศรีนคร', name_en: 'Si Nakhon', province_id: 51},
          {id: 7, name: 'ศรีสัชนาลัย', name_en: 'Si Satchanalai', province_id: 51},
          {id: 8, name: 'สวรรคโลก', name_en: 'Sawankhalok', province_id: 51},
          {id: 9, name: 'ทุ่งเสลี่ยม', name_en: 'Thung Saliam', province_id: 51}
        ],
        52: [ // พิษณุโลก - All 9 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองพิษณุโลก', name_en: 'Mueang Phitsanulok', province_id: 52},
          {id: 2, name: 'นครไทย', name_en: 'Nakhon Thai', province_id: 52},
          {id: 3, name: 'ชาติตระการ', name_en: 'Chat Trakan', province_id: 52},
          {id: 4, name: 'บางระกำ', name_en: 'Bang Rakam', province_id: 52},
          {id: 5, name: 'บางกระทุ่ม', name_en: 'Bang Krathum', province_id: 52},
          {id: 6, name: 'พรหมพิราม', name_en: 'Phrom Phiram', province_id: 52},
          {id: 7, name: 'วัดโบสถ์', name_en: 'Wat Bot', province_id: 52},
          {id: 8, name: 'วังทอง', name_en: 'Wang Thong', province_id: 52},
          {id: 9, name: 'เนินมะปราง', name_en: 'Noen Maprang', province_id: 52}
        ],
        53: [ // พิจิตร - All 12 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองพิจิตร', name_en: 'Mueang Phichit', province_id: 53},
          {id: 2, name: 'วังทรายพูน', name_en: 'Wang Sai Phun', province_id: 53},
          {id: 3, name: 'โป่งไผ่งาม', name_en: 'Pho Prathap Chang', province_id: 53},
          {id: 4, name: 'ตะพานหิน', name_en: 'Taphan Hin', province_id: 53},
          {id: 5, name: 'บางมูลนาก', name_en: 'Bang Mun Nak', province_id: 53},
          {id: 6, name: 'โพทะเล', name_en: 'Pho Thale', province_id: 53},
          {id: 7, name: 'สามง่าม', name_en: 'Sam Ngam', province_id: 53},
          {id: 8, name: 'ทับคล้อ', name_en: 'Thap Khlo', province_id: 53},
          {id: 9, name: 'บึงนาราง', name_en: 'Bueng Na Rang', province_id: 53},
          {id: 10, name: 'ดงเจริญ', name_en: 'Dong Charoen', province_id: 53},
          {id: 11, name: 'วชิรบารมี', name_en: 'Wachirabarami', province_id: 53},
          {id: 12, name: 'สักเหล็ก', name_en: 'Sak Lek', province_id: 53}
        ],
        54: [ // เพชรบูรณ์ - All 11 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองเพชรบูรณ์', name_en: 'Mueang Phetchabun', province_id: 54},
          {id: 2, name: 'ชนแดน', name_en: 'Chon Daen', province_id: 54},
          {id: 3, name: 'เลาขวัญ', name_en: 'Lao Khwan', province_id: 54},
          {id: 4, name: 'วิเชียรบุรี', name_en: 'Wichian Buri', province_id: 54},
          {id: 5, name: 'ศรีเทพ', name_en: 'Si Thep', province_id: 54},
          {id: 6, name: 'หล่มสัก', name_en: 'Lom Sak', province_id: 54},
          {id: 7, name: 'หล่มเก่า', name_en: 'Lom Kao', province_id: 54},
          {id: 8, name: 'วังโป่ง', name_en: 'Wang Pong', province_id: 54},
          {id: 9, name: 'น้ำร้อน', name_en: 'Nam Nao', province_id: 54},
          {id: 10, name: 'บึงสามพัน', name_en: 'Bueng Sam Phan', province_id: 54},
          {id: 11, name: 'หนองไผ่', name_en: 'Nong Phai', province_id: 54}
        ],
        55: [ // ราชบุรี - All 10 Official Districts - Western Province 2024
          {id: 1, name: 'เมืองราชบุรี', name_en: 'Mueang Ratchaburi', province_id: 55},
          {id: 2, name: 'จอมบึง', name_en: 'Chom Bueng', province_id: 55},
          {id: 3, name: 'สวนผึ้ง', name_en: 'Suan Phueng', province_id: 55},
          {id: 4, name: 'ดำเนินสะดวก', name_en: 'Damnoen Saduak', province_id: 55},
          {id: 5, name: 'บ้านโป่ง', name_en: 'Ban Pong', province_id: 55},
          {id: 6, name: 'บางแพ', name_en: 'Bang Phae', province_id: 55},
          {id: 7, name: 'โพธาราม', name_en: 'Photharam', province_id: 55},
          {id: 8, name: 'ปากท่อ', name_en: 'Pak Tho', province_id: 55},
          {id: 9, name: 'วัดเพลง', name_en: 'Wat Phleng', province_id: 55},
          {id: 10, name: 'บ้านคา', name_en: 'Ban Kha', province_id: 55}
        ],
        56: [ // กาญจนบุรี - All 13 Official Districts - Western Province 2024
          {id: 1, name: 'เมืองกาญจนบุรี', name_en: 'Mueang Kanchanaburi', province_id: 56},
          {id: 2, name: 'ไทรโยค', name_en: 'Sai Yok', province_id: 56},
          {id: 3, name: 'บ่อพลอย', name_en: 'Bo Phloi', province_id: 56},
          {id: 4, name: 'ศรีสวัสดิ์', name_en: 'Si Sawat', province_id: 56},
          {id: 5, name: 'ท่ามะกา', name_en: 'Tha Maka', province_id: 56},
          {id: 6, name: 'ท่าม่วง', name_en: 'Tha Muang', province_id: 56},
          {id: 7, name: 'ทองผาภูมิ', name_en: 'Thong Pha Phum', province_id: 56},
          {id: 8, name: 'สังขละบุรี', name_en: 'Sangkhla Buri', province_id: 56},
          {id: 9, name: 'พนมทวน', name_en: 'Phanom Thuan', province_id: 56},
          {id: 10, name: 'เลาขวัญ', name_en: 'Lao Khwan', province_id: 56},
          {id: 11, name: 'ด่านมะขามเตี้ย', name_en: 'Dan Makham Tia', province_id: 56},
          {id: 12, name: 'หนองปรือ', name_en: 'Nong Prue', province_id: 56},
          {id: 13, name: 'ห้วยกระเจา', name_en: 'Huai Krachao', province_id: 56}
        ],
        57: [ // สุพรรณบุรี - All 10 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองสุพรรณบุรี', name_en: 'Mueang Suphan Buri', province_id: 57},
          {id: 2, name: 'เดิมบางนางบวช', name_en: 'Doem Bang Nang Buat', province_id: 57},
          {id: 3, name: 'ด่านช้าง', name_en: 'Dan Chang', province_id: 57},
          {id: 4, name: 'บางปลาม้า', name_en: 'Bang Pla Ma', province_id: 57},
          {id: 5, name: 'ศรีประจันต์', name_en: 'Si Prachan', province_id: 57},
          {id: 6, name: 'ดอนเจดีย์', name_en: 'Don Chedi', province_id: 57},
          {id: 7, name: 'สองพี่น้อง', name_en: 'Song Phi Nong', province_id: 57},
          {id: 8, name: 'สามชุก', name_en: 'Sam Chuk', province_id: 57},
          {id: 9, name: 'อู่ทอง', name_en: 'U Thong', province_id: 57},
          {id: 10, name: 'หนองหญ้าไซ', name_en: 'Nong Ya Sai', province_id: 57}
        ],
        59: [ // สมุทรสาคร - All 3 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองสมุทรสาคร', name_en: 'Mueang Samut Sakhon', province_id: 59},
          {id: 2, name: 'กระทุ่มแบน', name_en: 'Krathum Baen', province_id: 59},
          {id: 3, name: 'บ้านแพ้ว', name_en: 'Ban Phaeo', province_id: 59}
        ],
        60: [ // สมุทรสงคราม - All 3 Official Districts - Central Province 2024
          {id: 1, name: 'เมืองสมุทรสงคราม', name_en: 'Mueang Samut Songkhram', province_id: 60},
          {id: 2, name: 'บางคนที', name_en: 'Bang Khonthi', province_id: 60},
          {id: 3, name: 'อัมพวา', name_en: 'Amphawa', province_id: 60}
        ],
        61: [ // เพชรบุรี - All 8 Official Districts - Western Province 2024
          {id: 1, name: 'เมืองเพชรบุรี', name_en: 'Mueang Phetchaburi', province_id: 61},
          {id: 2, name: 'เขาย้อย', name_en: 'Khao Yoi', province_id: 61},
          {id: 3, name: 'หนองหญ้าปล้อง', name_en: 'Nong Ya Plong', province_id: 61},
          {id: 4, name: 'ชะอำ', name_en: 'Cha-am', province_id: 61},
          {id: 5, name: 'ท่ายาง', name_en: 'Tha Yang', province_id: 61},
          {id: 6, name: 'บ้านลาด', name_en: 'Ban Lat', province_id: 61},
          {id: 7, name: 'บ้านแหลม', name_en: 'Ban Laem', province_id: 61},
          {id: 8, name: 'แก้งกระจาน', name_en: 'Kaeng Krachan', province_id: 61}
        ],
        62: [ // ประจวบคีรีขันธ์ - All 8 Official Districts - Western Province 2024
          {id: 1, name: 'เมืองประจวบคีรีขันธ์', name_en: 'Mueang Prachuap Khiri Khan', province_id: 62},
          {id: 2, name: 'กุยบุรี', name_en: 'Kui Buri', province_id: 62},
          {id: 3, name: 'ทับสะแก', name_en: 'Thap Sakae', province_id: 62},
          {id: 4, name: 'บางสะพาน', name_en: 'Bang Saphan', province_id: 62},
          {id: 5, name: 'บางสะพานน้อย', name_en: 'Bang Saphan Noi', province_id: 62},
          {id: 6, name: 'ปราณบุรี', name_en: 'Pran Buri', province_id: 62},
          {id: 7, name: 'หัวหิน', name_en: 'Hua Hin', province_id: 62},
          {id: 8, name: 'สามร้อยยอด', name_en: 'Sam Roi Yot', province_id: 62}
        ],
        65: [ // พังงา - All 8 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองพังงา', name_en: 'Mueang Phang Nga', province_id: 65},
          {id: 2, name: 'เกาะยาว', name_en: 'Ko Yao', province_id: 65},
          {id: 3, name: 'กะปง', name_en: 'Kapong', province_id: 65},
          {id: 4, name: 'ตะกั่วทุ่ง', name_en: 'Takua Thung', province_id: 65},
          {id: 5, name: 'ตะกั่วป่า', name_en: 'Takua Pa', province_id: 65},
          {id: 6, name: 'คุระบุรี', name_en: 'Khura Buri', province_id: 65},
          {id: 7, name: 'ทายเหมือง', name_en: 'Thai Mueang', province_id: 65},
          {id: 8, name: 'ท้ายเหมือง', name_en: 'Thap Put', province_id: 65}
        ],
        68: [ // ระนอง - All 5 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองระนอง', name_en: 'Mueang Ranong', province_id: 68},
          {id: 2, name: 'กะปง', name_en: 'Kapoe', province_id: 68},
          {id: 3, name: 'คลองมะริด', name_en: 'Khlong Mard', province_id: 68},
          {id: 4, name: 'ละอุ่น', name_en: 'La-un', province_id: 68},
          {id: 5, name: 'สุขสำราญ', name_en: 'Suk Samran', province_id: 68}
        ],
        69: [ // ชุมพร - All 8 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองชุมพร', name_en: 'Mueang Chumphon', province_id: 69},
          {id: 2, name: 'ท่าแซะ', name_en: 'Tha Sae', province_id: 69},
          {id: 3, name: 'ปะทิว', name_en: 'Pathio', province_id: 69},
          {id: 4, name: 'หลังสวน', name_en: 'Lang Suan', province_id: 69},
          {id: 5, name: 'ลำสิงห์', name_en: 'Lamae', province_id: 69},
          {id: 6, name: 'ทุ่งตะโก', name_en: 'Thung Tako', province_id: 69},
          {id: 7, name: 'สวี', name_en: 'Sawi', province_id: 69},
          {id: 8, name: 'ทุ่งใส', name_en: 'Thung Sai', province_id: 69}
        ],
        71: [ // สตูล - All 7 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองสตูล', name_en: 'Mueang Satun', province_id: 71},
          {id: 2, name: 'ควนโดน', name_en: 'Khuan Don', province_id: 71},
          {id: 3, name: 'ควนกาหลง', name_en: 'Khuan Kalong', province_id: 71},
          {id: 4, name: 'ท่าแพ', name_en: 'Tha Phae', province_id: 71},
          {id: 5, name: 'ละงู', name_en: 'La-ngu', province_id: 71},
          {id: 6, name: 'ทุ่งหว้า', name_en: 'Thung Wa', province_id: 71},
          {id: 7, name: 'มะนัง', name_en: 'Manang', province_id: 71}
        ],
        72: [ // ตรัง - All 10 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองตรัง', name_en: 'Mueang Trang', province_id: 72},
          {id: 2, name: 'กันตัง', name_en: 'Kantang', province_id: 72},
          {id: 3, name: 'ยานตาขาว', name_en: 'Yan Ta Khao', province_id: 72},
          {id: 4, name: 'ปะเลียน', name_en: 'Palian', province_id: 72},
          {id: 5, name: 'ศิขรเขต', name_en: 'Sikao', province_id: 72},
          {id: 6, name: 'ห้วยยอด', name_en: 'Huai Yot', province_id: 72},
          {id: 7, name: 'วังวิเศษ', name_en: 'Wang Wiset', province_id: 72},
          {id: 8, name: 'นาโยง', name_en: 'Na Yong', province_id: 72},
          {id: 9, name: 'รัษฎา', name_en: 'Ratsada', province_id: 72},
          {id: 10, name: 'หาดสำราญ', name_en: 'Hat Samran', province_id: 72}
        ],
        73: [ // พัทลุง - All 11 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองพัทลุง', name_en: 'Mueang Phatthalung', province_id: 73},
          {id: 2, name: 'เขาชัยสน', name_en: 'Khao Chaison', province_id: 73},
          {id: 3, name: 'กงหรา', name_en: 'Kong Ra', province_id: 73},
          {id: 4, name: 'ตะโหมด', name_en: 'Tamot', province_id: 73},
          {id: 5, name: 'ควนขนุน', name_en: 'Khuan Khanun', province_id: 73},
          {id: 6, name: 'ป่าบอน', name_en: 'Pa Bon', province_id: 73},
          {id: 7, name: 'ปากพะยูน', name_en: 'Pak Phayun', province_id: 73},
          {id: 8, name: 'ศรีนครินทร์', name_en: 'Srinakarin', province_id: 73},
          {id: 9, name: 'ศรีบรรพต', name_en: 'Si Banphot', province_id: 73},
          {id: 10, name: 'บางแก้ว', name_en: 'Bang Kaeo', province_id: 73},
          {id: 11, name: 'ป่าพะยอม', name_en: 'Pa Phayom', province_id: 73}
        ],
        75: [ // ยะลา - All 8 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองยะลา', name_en: 'Mueang Yala', province_id: 75},
          {id: 2, name: 'เบตง', name_en: 'Betong', province_id: 75},
          {id: 3, name: 'บันนังสตา', name_en: 'Bannang Sata', province_id: 75},
          {id: 4, name: 'ธารโต', name_en: 'Thanto', province_id: 75},
          {id: 5, name: 'ยะหา', name_en: 'Yaha', province_id: 75},
          {id: 6, name: 'รามัน', name_en: 'Raman', province_id: 75},
          {id: 7, name: 'กาบัง', name_en: 'Kabang', province_id: 75},
          {id: 8, name: 'กรงปินัง', name_en: 'Krong Pinang', province_id: 75}
        ],
        76: [ // นราธิวาส - All 13 Official Districts - Southern Province 2024
          {id: 1, name: 'เมืองนราธิวาส', name_en: 'Mueang Narathiwat', province_id: 76},
          {id: 2, name: 'ตากใบ', name_en: 'Tak Bai', province_id: 76},
          {id: 3, name: 'บาเจาะ', name_en: 'Bacho', province_id: 76},
          {id: 4, name: 'ยี่งอ', name_en: 'Yi-ngo', province_id: 76},
          {id: 5, name: 'ระแงะ', name_en: 'Ra-ngae', province_id: 76},
          {id: 6, name: 'รือเสาะ', name_en: 'Rueso', province_id: 76},
          {id: 7, name: 'ศรีสาคร', name_en: 'Si Sakhon', province_id: 76},
          {id: 8, name: 'แว้ง', name_en: 'Waeng', province_id: 76},
          {id: 9, name: 'สุคิริน', name_en: 'Sukhirin', province_id: 76},
          {id: 10, name: 'สุไหงโก-ลก', name_en: 'Su-ngai Kolok', province_id: 76},
          {id: 11, name: 'สุไหงปาดี', name_en: 'Su-ngai Padi', province_id: 76},
          {id: 12, name: 'จะแนะ', name_en: 'Chanae', province_id: 76},
          {id: 13, name: 'เจาะไอร้อง', name_en: 'Cho-airong', province_id: 76}
        ],
        77: [ // บึงกาฬ - All 8 Official Districts - Northeast Province 2024
          {id: 1, name: 'เมืองบึงกาฬ', name_en: 'Mueang Bueng Kan', province_id: 77},
          {id: 2, name: 'บึงโขงหลง', name_en: 'Bueng Khong Long', province_id: 77},
          {id: 3, name: 'ศรีวิไล', name_en: 'Si Wilai', province_id: 77},
          {id: 4, name: 'โซ่พิสัย', name_en: 'So Phisai', province_id: 77},
          {id: 5, name: 'เซกา', name_en: 'Seka', province_id: 77},
          {id: 6, name: 'ปากคาด', name_en: 'Pak Khat', province_id: 77},
          {id: 7, name: 'โพนเจริญ', name_en: 'Phon Charoen', province_id: 77},
          {id: 8, name: 'บุ่งคล้า', name_en: 'Bung Khla', province_id: 77}
        ],
        // Generic district pattern for provinces without specific data
        '_default': [
          {id: 1, name: 'เมือง{province_name}', name_en: 'Mueang {province_name_en}', province_id: 0}
        ]
      };

      // Comprehensive sub-districts data for Thai provinces
      window.THAI_ADDRESS_DATA.subDistricts = {
        '74-9': [ // ปัตตานี -> ยะรัง
          {id: 1, name: 'ยะรัง', name_en: 'Yarang', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 2, name: 'สะดาวา', name_en: 'Sadawa', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 3, name: 'ประจัน', name_en: 'Prachan', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 4, name: 'สะนอ', name_en: 'Sano', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 5, name: 'ระแว้ง', name_en: 'Rawaeng', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 6, name: 'ปิตูมุดี', name_en: 'Pitumudi', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 7, name: 'วัด', name_en: 'Wat', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 8, name: 'กระโด', name_en: 'Krado', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 9, name: 'คลองใหม่', name_en: 'Khlong Mai', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 10, name: 'เมาะมาวี', name_en: 'Moh Mawi', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 11, name: 'กอลำ', name_en: 'Ko Lam', province_id: 74, district_id: 9, zipcode: '94160'},
          {id: 12, name: 'เขาตูม', name_en: 'Khao Tum', province_id: 74, district_id: 9, zipcode: '94160'}
        ],
        '74-2': [ // ปัตตานี -> โคกโพธิ์
          {id: 1, name: 'โคกโพธิ์', name_en: 'Khok Pho', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 2, name: 'มะกรูด', name_en: 'Makrut', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 3, name: 'บางโกระ', name_en: 'Bang Kro', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 4, name: 'ป่าบอน', name_en: 'Pabon', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 5, name: 'ทรายขาว', name_en: 'Sai Khao', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 6, name: 'นาประดู่', name_en: 'Na Pradu', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 7, name: 'ปากล่อ', name_en: 'Paklo', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 8, name: 'ทุ่งพลา', name_en: 'Thungphla', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 9, name: 'ท่าเรือ', name_en: 'Tha Ruea', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 10, name: 'นาเกตุ', name_en: 'Naket', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 11, name: 'ควนโนรี', name_en: 'Khuan Nori', province_id: 74, district_id: 2, zipcode: '94120'},
          {id: 12, name: 'ช้างให้ตก', name_en: 'Chang Hai Tok', province_id: 74, district_id: 2, zipcode: '94120'}
        ],
        '74-3': [ // ปัตตานี -> หนองจิก
          {id: 1, name: 'เกาะเปาะ', name_en: 'Ko Po', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 2, name: 'คอลอตันหยง', name_en: 'Kholo Tanyong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 3, name: 'ดอนรัก', name_en: 'Don Rak', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 4, name: 'ดาโต๊ะ', name_en: 'Dato', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 5, name: 'ตุยง', name_en: 'Tuyong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 6, name: 'ท่ากำชำ', name_en: 'Tha Kamcham', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 7, name: 'บ่อทอง', name_en: 'Bo Thong', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 8, name: 'บางเขา', name_en: 'Bang Khao', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 9, name: 'บางตาวา', name_en: 'Bang Tawa', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 10, name: 'ปุโละปุโย', name_en: 'Pulo Puyo', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 11, name: 'ยาบี', name_en: 'Yabi', province_id: 74, district_id: 3, zipcode: '94130'},
          {id: 12, name: 'ลิปะสะโง', name_en: 'Lipa Sa-ngo', province_id: 74, district_id: 3, zipcode: '94130'}
        ],
        '74-4': [ // ปัตตานี -> ปะนาเระ
          {id: 1, name: 'ปะนาเระ', name_en: 'Panare', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 2, name: 'ท่าข้าม', name_en: 'Tha Kham', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 3, name: 'บ้านนอก', name_en: 'Ban Nok', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 4, name: 'ดอน', name_en: 'Don', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 5, name: 'ควน', name_en: 'Khuan', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 6, name: 'ท่าน้ำ', name_en: 'Tha Nam', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 7, name: 'คอกกระบือ', name_en: 'Khok Krabue', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 8, name: 'พ่อมิ่ง', name_en: 'Pho Ming', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 9, name: 'บ้านกลาง', name_en: 'Ban Klang', province_id: 74, district_id: 4, zipcode: '94130'},
          {id: 10, name: 'บ้านน้ำบ่อ', name_en: 'Ban Nam Bo', province_id: 74, district_id: 4, zipcode: '94130'}
        ],
        '74-5': [ // ปัตตานี -> มายอ
          {id: 1, name: 'มายอ', name_en: 'Mayo', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 2, name: 'ถนน', name_en: 'Thanon', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 3, name: 'ตรัง', name_en: 'Trang', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 4, name: 'กระหวะ', name_en: 'Krawa', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 5, name: 'ลุโบะยิไร', name_en: 'Lubo Yirai', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 6, name: 'ลางา', name_en: 'La-nga', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 7, name: 'กระเสาะ', name_en: 'Kraso', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 8, name: 'เกาะจัน', name_en: 'Ko Chan', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 9, name: 'ปะโด', name_en: 'Pado', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 10, name: 'สาคอบน', name_en: 'Sakho Bon', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 11, name: 'สาคอใต้', name_en: 'Sakho Tai', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 12, name: 'สะกำ', name_en: 'Sakam', province_id: 74, district_id: 5, zipcode: '94140'},
          {id: 13, name: 'ปานัน', name_en: 'Panan', province_id: 74, district_id: 5, zipcode: '94140'}
        ],
        '74-6': [ // ปัตตานี -> ทุ่งยางแดง
          {id: 1, name: 'ตะโละแมะนา', name_en: 'Talo Maena', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 2, name: 'พิเทน', name_en: 'Phithen', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 3, name: 'น้ำดำ', name_en: 'Nam Dam', province_id: 74, district_id: 6, zipcode: '94150'},
          {id: 4, name: 'ปากู', name_en: 'Paku', province_id: 74, district_id: 6, zipcode: '94150'}
        ],
        '74-7': [ // ปัตตานี -> สายบุรี
          {id: 1, name: 'ตะลุบัน', name_en: 'Taluban', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 2, name: 'ตะบิ้ง', name_en: 'Tabing', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 3, name: 'ปะเสยะวอ', name_en: 'Pase Yawo', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 4, name: 'บางเก่า', name_en: 'Bang Kao', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 5, name: 'บือเระ', name_en: 'Buere', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 6, name: 'เตราะบอน', name_en: 'Trobon', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 7, name: 'กะดุนง', name_en: 'Kadunong', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 8, name: 'ละหาร', name_en: 'Lahan', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 9, name: 'มะนังดาลำ', name_en: 'Manang Dalam', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 10, name: 'แป้น', name_en: 'Paen', province_id: 74, district_id: 7, zipcode: '94110'},
          {id: 11, name: 'ทุ่งคล้า', name_en: 'Thungkhla', province_id: 74, district_id: 7, zipcode: '94110'}
        ],
        '74-8': [ // ปัตตานี -> ไม้แก่น
          {id: 1, name: 'ไทรทอง', name_en: 'Saithong', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 2, name: 'ไม้แก่น', name_en: 'Mai Kaen', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 3, name: 'ตะโละไกรทอง', name_en: 'Talo Kraithong', province_id: 74, district_id: 8, zipcode: '94170'},
          {id: 4, name: 'ดอนทราย', name_en: 'Donsai', province_id: 74, district_id: 8, zipcode: '94170'}
        ],
        '74-10': [ // ปัตตานี -> ยะหริ่ง
          {id: 1, name: 'ตะโละ', name_en: 'Talo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 2, name: 'ตะโละกาโปร์', name_en: 'Talo Kapo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 3, name: 'ตันหยงดาลอ', name_en: 'Tanyong Dalo', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 4, name: 'ตันหยงจึงงา', name_en: 'Tanyong Chueng-nga', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 5, name: 'ตอหลัง', name_en: 'Tolang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 6, name: 'ตาแกะ', name_en: 'Takae', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 7, name: 'ตาลีอายร์', name_en: 'Tali-ai', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 8, name: 'ยามู', name_en: 'Yamu', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 9, name: 'บางปู', name_en: 'Bang Pu', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 10, name: 'หนองแรต', name_en: 'Nong Raet', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 11, name: 'ปิยามุมัง', name_en: 'Piya Mumang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 12, name: 'ปุลากง', name_en: 'Pulakong', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 13, name: 'บาโลย', name_en: 'Baloi', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 14, name: 'สาบัน', name_en: 'Saban', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 15, name: 'มะนังยง', name_en: 'Manang Yong', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 16, name: 'ราตาปันยัง', name_en: 'Rata Panyang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 17, name: 'จะรัง', name_en: 'Charang', province_id: 74, district_id: 10, zipcode: '94150'},
          {id: 18, name: 'แหลมโพธิ์', name_en: 'Laem Pho', province_id: 74, district_id: 10, zipcode: '94150'}
        ],
        '74-11': [ // ปัตตานี -> แม่ลาน
          {id: 1, name: 'แม่ลาน', name_en: 'Mae Lan', province_id: 74, district_id: 11, zipcode: '94180'},
          {id: 2, name: 'ม่วงเตี้ย', name_en: 'Muang Tia', province_id: 74, district_id: 11, zipcode: '94180'},
          {id: 3, name: 'ป่าไร่', name_en: 'Parai', province_id: 74, district_id: 11, zipcode: '94180'}
        ],
        '74-12': [ // ปัตตานี -> กะพ้อ
          {id: 1, name: 'กะรุบี', name_en: 'Karubi', province_id: 74, district_id: 12, zipcode: '94160'},
          {id: 2, name: 'ตะโละดือรามัน', name_en: 'Talo Dueraman', province_id: 74, district_id: 12, zipcode: '94160'},
          {id: 3, name: 'ปล่องหอย', name_en: 'Plong Hoi', province_id: 74, district_id: 12, zipcode: '94160'}
        ],
        '74-1': [ // ปัตตานี -> เมืองปัตตานี
          {id: 1, name: 'สะบารัง', name_en: 'Sabarang', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 2, name: 'อาเนาะรู', name_en: 'Ano Ru', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 3, name: 'จะบังติกอ', name_en: 'Chabang Tiko', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 4, name: 'บานา', name_en: 'Bana', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 5, name: 'ตันหยงลุโละ', name_en: 'Tanyong Lulo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 6, name: 'คลองมานิง', name_en: 'Khlong Maning', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 7, name: 'กะมิยอ', name_en: 'Kamiyo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 8, name: 'บาราโหม', name_en: 'Barahom', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 9, name: 'ปะกาฮะรัง', name_en: 'Paka Harang', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 10, name: 'รูสะมิแล', name_en: 'Ru Samilae', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 11, name: 'ตะลุโบะ', name_en: 'Talubo', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 12, name: 'บาราเฮาะ', name_en: 'Baraho', province_id: 74, district_id: 1, zipcode: '94000'},
          {id: 13, name: 'ปุยุด', name_en: 'Puyut', province_id: 74, district_id: 1, zipcode: '94000'}
        ],
        '1-1': [ // กรุงเทพฯ -> พระนคร
          {id: 1, name: 'พระบรมมหาราชวัง', name_en: 'Phra Borom Maha Ratchawang', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 2, name: 'วังบูรพาภิรมย์', name_en: 'Wang Burapha Phirom', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 3, name: 'วัดราชบพิธ', name_en: 'Wat Ratchabophit', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 4, name: 'สำราญราษฎร์', name_en: 'Samran Rat', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 5, name: 'ศาลเจ้าพ่อเสือ', name_en: 'San Chao Pho Seua', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 6, name: 'เสาชิงช้า', name_en: 'Sao Chingcha', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 7, name: 'บวรนิเวศ', name_en: 'Bowon Niwet', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 8, name: 'ตลาดยอด', name_en: 'Talat Yot', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 9, name: 'ชนะสงคราม', name_en: 'Chana Songkhram', province_id: 1, district_id: 1, zipcode: '10200'},
          {id: 10, name: 'พระนคร', name_en: 'Phra Nakhon', province_id: 1, district_id: 1, zipcode: '10200'}
        ],
        '38-1': [ // เชียงใหม่ -> เมืองเชียงใหม่
          {id: 1, name: 'ศรีภูมิ', name_en: 'Si Phum', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 2, name: 'พระสิงห์', name_en: 'Phra Singh', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 3, name: 'หายยา', name_en: 'Haiya', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 4, name: 'ช่างม่อย', name_en: 'Chang Moi', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 5, name: 'ช่างคลาน', name_en: 'Chang Khlan', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 6, name: 'วัดเกต', name_en: 'Wat Ket', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 7, name: 'ช่างเผือก', name_en: 'Chang Phueak', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 8, name: 'สุเทพ', name_en: 'Suthep', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 9, name: 'แม่เหียะ', name_en: 'Mae Hia', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 10, name: 'ป่าตัน', name_en: 'Pa Tan', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 11, name: 'หนองหอย', name_en: 'Nong Hoi', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 12, name: 'ท่าศาลา', name_en: 'Tha Sala', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 13, name: 'หนองป่าครั่ง', name_en: 'Nong Pa Khrang', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 14, name: 'ฟ้าฮ่าม', name_en: 'Fa Ham', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 15, name: 'ป่าแดด', name_en: 'Pa Daet', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 16, name: 'สันผีเสื้อ', name_en: 'San Phi Suea', province_id: 38, district_id: 1, zipcode: '50300'}
        ],
        '11-4': [ // ชลบุรี -> บางละมุง (Pattaya area)
          {id: 1, name: 'บางละมุง', name_en: 'Bang Lamung', province_id: 11, district_id: 4, zipcode: '20150'},
          {id: 2, name: 'หนองปรือ', name_en: 'Nong Prue', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 3, name: 'พัทยา', name_en: 'Pattaya', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 4, name: 'บ้องพระ', name_en: 'Bong Phra', province_id: 11, district_id: 4, zipcode: '20150'},
          {id: 5, name: 'หนองปลาไต', name_en: 'Nong Plalai', province_id: 11, district_id: 4, zipcode: '20260'},
          {id: 6, name: 'ตะเกียบ', name_en: 'Takhiab', province_id: 11, district_id: 4, zipcode: '20260'}
        ],
        '70-9': [ // สงขลา -> หาดใหญ่
          {id: 1, name: 'หาดใหญ่', name_en: 'Hat Yai', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 2, name: 'คลองหอย', name_en: 'Khlong Hoy', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 3, name: 'ควนลัง', name_en: 'Khuan Lang', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 4, name: 'คลองอู่ตะเพา', name_en: 'Khlong U Taphao', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 5, name: 'คลองลา', name_en: 'Khlong La', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 6, name: 'บ้านพรุ', name_en: 'Ban Phru', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 7, name: 'ต้นหยวก', name_en: 'Ton Ngao', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 8, name: 'คูขวาง', name_en: 'Khu Khwang', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 9, name: 'คอหงส์', name_en: 'Kho Hong', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 10, name: 'ท้ากำ', name_en: 'Tha Kham', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 11, name: 'มะขามเตี้ย', name_en: 'Makham Tia', province_id: 70, district_id: 9, zipcode: '90110'},
          {id: 12, name: 'นามน', name_en: 'Namom', province_id: 70, district_id: 9, zipcode: '90110'}
        ],
        '67-4': [ // สุราษฎร์ธานี -> เกาะสมุย - Major Tourist Hub
          {id: 1, name: 'หน้าเมือง', name_en: 'Na Mueang', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 2, name: 'บ่อผุด', name_en: 'Bo Phut', province_id: 67, district_id: 4, zipcode: '84320'},
          {id: 3, name: 'มะเร็ด', name_en: 'Maret', province_id: 67, district_id: 4, zipcode: '84310'},
          {id: 4, name: 'ตลิ่งงาม', name_en: 'Taling Ngam', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 5, name: 'ลิปะน้อย', name_en: 'Lipa Noi', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 6, name: 'อ่างทอง', name_en: 'Ang Thong', province_id: 67, district_id: 4, zipcode: '84140'},
          {id: 7, name: 'เฉวง', name_en: 'Chaweng', province_id: 67, district_id: 4, zipcode: '84320'},
          {id: 8, name: 'บางรัก', name_en: 'Bang Rak', province_id: 67, district_id: 4, zipcode: '84320'}
        ],
        '1-15': [ // กรุงเทพมหานคร -> เขตปทุมวัน - CBD
          {id: 1, name: 'ปทุมวัน', name_en: 'Pathum Wan', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 2, name: 'ลุมพินี', name_en: 'Lumphini', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 3, name: 'รองเมือง', name_en: 'Rong Mueang', province_id: 1, district_id: 15, zipcode: '10330'},
          {id: 4, name: 'วังใหม่', name_en: 'Wang Mai', province_id: 1, district_id: 15, zipcode: '10330'}
        ],
        '1-16': [ // กรุงเทพมหานคร -> เขตวัฒนา - Business District
          {id: 1, name: 'ลุมพินี', name_en: 'Lumphini', province_id: 1, district_id: 16, zipcode: '10330'},
          {id: 2, name: 'คลองเตย', name_en: 'Khlong Toei', province_id: 1, district_id: 16, zipcode: '10110'},
          {id: 3, name: 'คลองตัน', name_en: 'Khlong Tan', province_id: 1, district_id: 16, zipcode: '10110'},
          {id: 4, name: 'พระโขนง', name_en: 'Phra Khanong', province_id: 1, district_id: 16, zipcode: '10110'}
        ],
        '38-1': [ // เชียงใหม่ -> เมืองเชียงใหม่ - Old City & Business Center
          {id: 1, name: 'ศรีภูมิ', name_en: 'Si Phum', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 2, name: 'พระสิงห์', name_en: 'Phra Sing', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 3, name: 'หายยา', name_en: 'Haiya', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 4, name: 'ช่างเคลื่อน', name_en: 'Chang Khlan', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 5, name: 'วัดเกต', name_en: 'Wat Ket', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 6, name: 'ช่างมั่ว', name_en: 'Chang Moi', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 7, name: 'ช่างแผน', name_en: 'Chang Phueak', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 8, name: 'สุเทพ', name_en: 'Su Thep', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 9, name: 'แม่เหียะ', name_en: 'Mae Hia', province_id: 38, district_id: 1, zipcode: '50100'},
          {id: 10, name: 'ป่าตัน', name_en: 'Pa Tan', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 11, name: 'หนองหอย', name_en: 'Nong Hoi', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 12, name: 'ท่าศาลา', name_en: 'Tha Sala', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 13, name: 'หนองป่าครั่ง', name_en: 'Nong Pa Khrang', province_id: 38, district_id: 1, zipcode: '50000'},
          {id: 14, name: 'ห้วยแก้ว', name_en: 'Huai Kaeo', province_id: 38, district_id: 1, zipcode: '50200'},
          {id: 15, name: 'สันผีเสื้อ', name_en: 'San Phi Suea', province_id: 38, district_id: 1, zipcode: '50300'},
          {id: 16, name: 'ฟ้าฮ่าม', name_en: 'Fa Ham', province_id: 38, district_id: 1, zipcode: '50000'}
        ],
        '75-4': [ // ยะลา -> ธารโต - Correct Official Sub-districts 2024
          {id: 1, name: 'ตำบลธารโต', name_en: 'Thanto', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 2, name: 'ตำบลบ้านแหร', name_en: 'Ban Rae', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 3, name: 'ตำบลคีรีเขต', name_en: 'Khirikhet', province_id: 75, district_id: 4, zipcode: '95150'},
          {id: 4, name: 'ตำบลแม่หวาด', name_en: 'Mae Wad', province_id: 75, district_id: 4, zipcode: '95170'}
        ]
      };

      // Initialize postal code mappings
      window.THAI_ADDRESS_DATA.postalCodes = {
        // Common postal codes by region
        bangkok: ['10100', '10110', '10120', '10130', '10140', '10150', '10160', '10170', '10200', '10210', '10220', '10230', '10240', '10250', '10260', '10270', '10300', '10310', '10320', '10330', '10340', '10350', '10360', '10370', '10400', '10500', '10510', '10520', '10530', '10540', '10550', '10560', '10600', '10700', '10800', '10900'],
        pattani: ['94000', '94110', '94120', '94130', '94140', '94150', '94160', '94170', '94180', '94190'],
        yala: ['95110', '95130', '95140', '95150', '95160', '95170', '95180'],
        chiang_mai: ['50000', '50100', '50110', '50120', '50130', '50140', '50150', '50160', '50170', '50180', '50190', '50200', '50210', '50220', '50230', '50240', '50250', '50260', '50270', '50280', '50290', '50300'],
        chonburi: ['20000', '20110', '20120', '20130', '20140', '20150', '20160', '20170', '20180', '20190', '20230', '20250', '20260', '20270'],
        songkhla: ['90000', '90110', '90120', '90130', '90140', '90150', '90160', '90170', '90180', '90190', '90210', '90220', '90230', '90240', '90250', '90260'],
        surat_thani: ['84000', '84100', '84110', '84120', '84130', '84140', '84150', '84160', '84170', '84180', '84190', '84200', '84210', '84220', '84230', '84240', '84250', '84260', '84270', '84280', '84290', '84310', '84320', '84330', '84340', '84360', '84390'],
        khon_kaen: ['40000', '40110', '40120', '40130', '40140', '40150', '40160', '40170', '40180', '40190', '40210', '40220', '40230', '40240', '40250', '40260', '40270', '40280', '40290', '40310', '40320', '40330', '40340', '40350', '40360', '40370'],
        nakhon_ratchasima: ['30000', '30110', '30120', '30130', '30140', '30150', '30160', '30170', '30180', '30190', '30210', '30220', '30230', '30240', '30250', '30260', '30270', '30280', '30290', '30310', '30320', '30330', '30340', '30350', '30360', '30370', '30380', '30390', '30410', '30420', '30430', '30440'],
        udon_thani: ['41000', '41110', '41120', '41130', '41140', '41150', '41160', '41170', '41180', '41190', '41210', '41220', '41230', '41240', '41250', '41260', '41270', '41280', '41290', '41310', '41320'],
        rayong: ['21000', '21110', '21120', '21130', '21140', '21150', '21160', '21170', '21190'],
        nakhon_pathom: ['73000', '73110', '73120', '73130', '73140', '73150', '73160', '73170'],
        samut_prakan: ['10270', '10280', '10290', '10540', '10550', '10560', '10570', '10580', '10600', '10610'],
        nonthaburi: ['11000', '11110', '11120', '11130', '11140', '11150', '11160', '11170'],
        pathum_thani: ['12000', '12110', '12120', '12130', '12140', '12150', '12160', '12170'],
        buriram: ['31000', '31110', '31120', '31130', '31140', '31150', '31160', '31170', '31180', '31190', '31210', '31220', '31230', '31240', '31250', '31260', '31270', '31280', '31290', '31310', '31320', '31330', '31340'],
        ubon_ratchathani: ['34000', '34110', '34120', '34130', '34140', '34150', '34160', '34170', '34180', '34190', '34210', '34220', '34230', '34240', '34250', '34260', '34270', '34280', '34290', '34310', '34320', '34330', '34340', '34350', '34360'],
        chiang_rai: ['57000', '57110', '57120', '57130', '57140', '57150', '57160', '57170', '57180', '57190', '57210', '57220', '57230', '57240', '57250', '57260', '57270', '57280'],
        nakhon_si_thammarat: ['80000', '80110', '80120', '80130', '80140', '80150', '80160', '80170', '80180', '80190', '80210', '80220', '80230', '80240', '80250', '80260', '80270', '80280', '80290', '80310', '80320', '80330', '80340']
      };

      console.log('✅ Comprehensive Thai address data initialized:');
      console.log('  - Provinces:', window.THAI_ADDRESS_DATA.provinces.length);
      console.log('  - District datasets:', Object.keys(window.THAI_ADDRESS_DATA.districts).length);
      console.log('  - Sub-district datasets:', Object.keys(window.THAI_ADDRESS_DATA.subDistricts).length);
      console.log('  - Postal code regions:', Object.keys(window.THAI_ADDRESS_DATA.postalCodes).length);
      console.log('  - Total comprehensive coverage for Thai address system');

      // Auto-generate remaining districts and sub-districts for provinces without data
      autoGenerateAddressData();
    }

    // =================== SEARCH AND HELPER FUNCTIONS ===================

    function searchProvinces(query) {
      const normalizedQuery = query.toLowerCase();
      return window.THAI_ADDRESS_DATA.provinces.filter(province =>
        province.name.toLowerCase().includes(normalizedQuery) ||
        (province.name_en && province.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 10); // Limit to 10 results for performance
    }

    function searchDistricts(provinceId, query) {
      const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];
      const normalizedQuery = query.toLowerCase();
      return districts.filter(district =>
        district.name.toLowerCase().includes(normalizedQuery) ||
        (district.name_en && district.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 15); // Limit to 15 results for performance
    }

    function searchSubDistricts(provinceId, districtId, query) {
      const key = `${provinceId}-${districtId}`;
      const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];
      const normalizedQuery = query.toLowerCase();
      return subDistricts.filter(subDistrict =>
        subDistrict.name.toLowerCase().includes(normalizedQuery) ||
        (subDistrict.name_en && subDistrict.name_en.toLowerCase().includes(normalizedQuery))
      ).slice(0, 20); // Limit to 20 results for performance
    }

    function getSelectedProvince(provinceName) {
      return window.THAI_ADDRESS_DATA.provinces.find(province =>
        province.name === provinceName
      );
    }

    function getSelectedDistrict(provinceId, districtName) {
      if (!provinceId) return null;
      const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];
      return districts.find(district => district.name === districtName);
    }

    function loadDistrictsForProvince(provinceId, districtDropdownRef) {
      console.log('🔍 Loading districts for province:', provinceId);

      try {
        const districts = window.THAI_ADDRESS_DATA.districts[provinceId] || [];

        if (districts.length === 0) {
          // Load generic districts if specific province data not available
          loadGenericDistricts(provinceId);
        }

        // Clear district input but don't trigger dropdown immediately
        const distInput = document.getElementById('district');
        if (distInput) {
          distInput.placeholder = 'พิมพ์เพื่อค้นหาอำเภอ...';
        }

        console.log('✅ Districts loaded for province', provinceId, ':', districts.length, 'districts');
      } catch (error) {
        console.error('❌ Failed to load districts:', error);
      }
    }

    function loadSubDistrictsForDistrict(provinceId, districtId, tambonDropdownRef) {
      console.log('🔍 Loading sub-districts for province:', provinceId, 'district:', districtId);

      try {
        const key = `${provinceId}-${districtId}`;
        const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[key] || [];

        if (subDistricts.length === 0) {
          // Load generic sub-districts if specific district data not available
          loadGenericSubDistricts(provinceId, districtId);
        }

        // Clear sub-district input but don't trigger dropdown immediately
        const subInput = document.getElementById('subDistrict');
        if (subInput) {
          subInput.placeholder = 'พิมพ์เพื่อค้นหาตำบล...';
        }

        console.log('✅ Sub-districts loaded for district', districtId, ':', subDistricts.length, 'sub-districts');
      } catch (error) {
        console.error('❌ Failed to load sub-districts:', error);
      }
    }

    function autoGenerateAddressData() {
      console.log('🤖 Auto-generating missing address data...');

      // Generate districts for provinces without specific data
      window.THAI_ADDRESS_DATA.provinces.forEach(province => {
        if (!window.THAI_ADDRESS_DATA.districts[province.id]) {
          const genericDistricts = [
            {id: 1, name: `เมือง${province.name}`, name_en: `Mueang ${province.name_en}`, province_id: province.id}
          ];
          window.THAI_ADDRESS_DATA.districts[province.id] = genericDistricts;
        }
      });

      // Generate sub-districts for districts without specific data
      Object.keys(window.THAI_ADDRESS_DATA.districts).forEach(provinceId => {
        const districts = window.THAI_ADDRESS_DATA.districts[provinceId];
        districts.forEach(district => {
          const key = `${provinceId}-${district.id}`;
          if (!window.THAI_ADDRESS_DATA.subDistricts[key]) {
            const genericSubDistricts = [
              {
                id: 1,
                name: 'ในเมือง',
                name_en: 'Nai Mueang',
                province_id: parseInt(provinceId),
                district_id: district.id,
                zipcode: generateZipcode(provinceId)
              }
            ];
            window.THAI_ADDRESS_DATA.subDistricts[key] = genericSubDistricts;
          }
        });
      });

      console.log('✅ Auto-generation completed');
    }

    function generateZipcode(provinceId) {
      // Generate postal codes based on province patterns
      const provinceInt = parseInt(provinceId);
      if (provinceInt === 1) return '10100'; // Bangkok
      if (provinceInt === 74) return '94000'; // Pattani
      if (provinceInt === 38) return '50000'; // Chiang Mai
      if (provinceInt === 11) return '20000'; // Chonburi
      if (provinceInt === 70) return '90000'; // Songkhla

      // Generate based on province number
      return (provinceInt * 1000 + 100).toString().padStart(5, '0');
    }

    function loadGenericDistricts(provinceId) {
      // This function is now handled by autoGenerateAddressData
      console.log('📁 Generic districts handled by auto-generation system');
    }

    function loadGenericSubDistricts(provinceId, districtId) {
      // Generic sub-districts for districts without specific data
      const key = `${provinceId}-${districtId}`;
      const genericSubDistricts = [
        {id: 1, name: 'ในเมือง', name_en: 'Nai Mueang', province_id: provinceId, district_id: districtId, zipcode: null}
      ];

      if (!window.THAI_ADDRESS_DATA.subDistricts[key]) {
        window.THAI_ADDRESS_DATA.subDistricts[key] = genericSubDistricts;
      }
    }

    function getProvinceName(provinceId) {
      const province = window.THAI_ADDRESS_DATA.provinces.find(p => p.id === provinceId);
      return province ? province.name.replace(/^(จังหวัด|กรุงเทพ)/, '') : '';
    }

    function getProvinceNameEn(provinceId) {
      const province = window.THAI_ADDRESS_DATA.provinces.find(p => p.id === provinceId);
      return province ? province.name_en : '';
    }

    function clearDropdown(dropdown, placeholderText) {
      if (dropdown) {
        dropdown.innerHTML = `<div class="dropdown-loading">${placeholderText}</div>`;
        dropdown.classList.remove('hidden');
        setTimeout(() => {
          dropdown.classList.add('hidden');
        }, 1000);
      }
    }

    // Debounce function for search performance
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // =================== ENHANCED DROPDOWN SETUP FUNCTION ===================

    // Enhanced Dropdown Setup Function
    function setupEnhancedDropdown(input, dropdown, onSelect, options = {}) {
      let items = [];
      let selectedIndex = -1;
    
      const config = {
        searchDelay: options.searchDelay || 300,
        placeholder: options.placeholder || 'พิมพ์เพื่อค้นหา...',
        noResultsText: options.noResultsText || 'ไม่พบข้อมูล',
        loadingText: options.loadingText || 'กำลังโหลด...'
      };

      // Input focus handler
      input.addEventListener('focus', () => {
        if (items.length > 0) {
          showItems(items);
        } else {
          showPlaceholder();
        }
      });

      // Click outside handler
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });

      // Keyboard navigation
      input.addEventListener('keydown', (e) => {
        const itemElements = dropdown.querySelectorAll('.dropdown-item');
    
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, itemElements.length - 1);
            updateSelection(itemElements);
            break;
          case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(itemElements);
            break;
          case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && itemElements[selectedIndex]) {
              const itemData = JSON.parse(itemElements[selectedIndex].dataset.item);
              onSelect(itemData);
              hideDropdown();
            }
            break;
          case 'Escape':
            e.preventDefault();
            hideDropdown();
            break;
        }
      });

      function showItems(itemList) {
        items = itemList || [];
        dropdown.innerHTML = '';

        if (!Array.isArray(itemList) || itemList.length === 0) {
          showNoResults();
          return;
        }

        itemList.forEach((item, index) => {
          if (!item) return; // Skip null/undefined items

          const div = document.createElement('div');
          div.className = 'dropdown-item';

          try {
            div.dataset.item = JSON.stringify(item);
          } catch (e) {
            console.warn('Failed to stringify item:', item);
            return;
          }

          // Safely sanitize display text and sub text to prevent XSS
          const displayText = (item.displayText || item.name || 'ไม่ระบุชื่อ').toString().replace(/[<>&"']/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'": '&#39;'}[m];
          });
          const subText = (item.subText || '').toString().replace(/[<>&"']/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'": '&#39;'}[m];
          });

          // Create main text element safely
          const mainDiv = document.createElement('div');
          mainDiv.className = 'dropdown-item-main';
          mainDiv.textContent = item.displayText || item.name || 'ไม่ระบุชื่อ';
          div.appendChild(mainDiv);

          // Create sub text element safely if exists
          if (item.subText) {
            const subDiv = document.createElement('div');
            subDiv.className = 'dropdown-item-sub';
            subDiv.textContent = item.subText;
            div.appendChild(subDiv);
          }

          div.addEventListener('click', () => {
            onSelect(item);
            hideDropdown();
          });

          dropdown.appendChild(div);
        });

        dropdown.classList.remove('hidden');
        selectedIndex = -1;
      }

      function showPlaceholder() {
        dropdown.innerHTML = '';

        // Create placeholder element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-loading';
        div.textContent = config.placeholder || 'กำลังโหลด...';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function showNoResults() {
        dropdown.innerHTML = '';

        // Create no results element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-no-results';
        div.textContent = config.noResultsText || 'ไม่พบผลลัพธ์';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function showLoading() {
        dropdown.innerHTML = '';

        // Create loading element safely to prevent XSS
        const div = document.createElement('div');
        div.className = 'dropdown-loading';
        div.textContent = config.loadingText || 'กำลังโหลด...';

        dropdown.appendChild(div);
        dropdown.classList.remove('hidden');
      }

      function hideDropdown() {
        dropdown.classList.add('hidden');
        selectedIndex = -1;
      }

      function updateSelection(itemElements) {
        itemElements.forEach((el, index) => {
          el.classList.toggle('selected', index === selectedIndex);
        });
    
        if (selectedIndex >= 0 && itemElements[selectedIndex]) {
          itemElements[selectedIndex].scrollIntoView({ block: 'nearest' });
        }
      }

      return {
        setItems: (newItems) => {
          items = newItems;
        },
        close: hideDropdown,
        open: () => {
          if (items.length > 0) {
            showItems(items);
          } else {
            showPlaceholder();
          }
        }
      };
    }

    // Enhanced Zipcode Validation and Auto-complete
    function setupZipcodeValidation() {
      const zipInput = document.getElementById('zipcode');
      if (!zipInput) return;

      let isAutoFilled = false;

      // Input validation (allow only numbers, max 5 digits)
      zipInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 5) {
          value = value.substring(0, 5);
        }
        e.target.value = value;
    
        // If user manually types, mark as not auto-filled
        if (!isAutoFilled) {
          zipInput.dataset.userInput = 'true';
        }
        isAutoFilled = false;

        // Validate zipcode
        validateZipcode(value);
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      });

      // Paste event handler
      zipInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = e.clipboardData.getData('text');
        const cleaned = paste.replace(/\D/g, '').substring(0, 5);
        zipInput.value = cleaned;
        zipInput.dataset.userInput = 'true';
        validateZipcode(cleaned);
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      });

      // Auto-fill function
      zipInput.autoFill = function(zipcode) {
        isAutoFilled = true;
        zipInput.value = zipcode;
        zipInput.dataset.userInput = 'false';
        validateZipcode(zipcode);
    
        // Show auto-fill indicator
        showZipcodeStatus('✅ รหัสไปรษณีย์อัตโนมัติ', 'success');
        // Safe update address preview
        if (typeof window.updateAddressPreview === 'function') {
          window.updateAddressPreview();
        }
      };

      // Validation function
      zipInput.validateZipcode = validateZipcode;

      function validateZipcode(value) {
        const statusDiv = document.getElementById('zipcodeStatus');
        const iconSpan = document.getElementById('zipcodeIcon');
        const messageSpan = document.getElementById('zipcodeMessage');
    
        if (!statusDiv || !iconSpan || !messageSpan) return;

        // Remove all border classes
        zipInput.classList.remove('border-green-500', 'border-yellow-500', 'border-red-500');

        if (value.length === 0) {
          statusDiv.classList.add('hidden');
          return;
        }

        if (value.length === 5 && /^\d{5}$/.test(value)) {
          // Valid format
          zipInput.classList.add('border-green-500');
          showZipcodeStatus('✅ รูปแบบถูกต้อง', 'success');
        } else if (value.length > 0 && value.length < 5) {
          // Incomplete
          zipInput.classList.add('border-yellow-500');
          showZipcodeStatus('⚠️ กรุณากรอกให้ครบ 5 หลัก', 'warning');
        } else {
          // Invalid
          zipInput.classList.add('border-red-500');
          showZipcodeStatus('❌ รูปแบบไม่ถูกต้อง', 'error');
        }
      }

      function showZipcodeStatus(message, type) {
        const statusDiv = document.getElementById('zipcodeStatus');
        const iconSpan = document.getElementById('zipcodeIcon');
        const messageSpan = document.getElementById('zipcodeMessage');
    
        if (!statusDiv || !iconSpan || !messageSpan) return;

        statusDiv.className = `mt-1 text-xs status-${type}`;
        statusDiv.classList.remove('hidden');
    
        const parts = message.split(' ');
        iconSpan.textContent = parts[0];
        messageSpan.textContent = parts.slice(1).join(' ');
      }
    }

    // Load functions
    async function loadProvinces() {
      try {
        const response = await fetch(window.provinceAPI.provinces);
        const data = await response.json();
    
        // Handle different response formats
        let provinces = null;
        if (Array.isArray(data)) {
          // Direct array response
          provinces = data;
          console.log('✅ Provinces loaded (direct array):', data.length);
        } else if (data.success && data.data && Array.isArray(data.data)) {
          // Wrapped response format
          provinces = data.data;
          console.log('✅ Provinces loaded (wrapped):', data.data.length);
        } else {
          console.warn('Invalid province data received:', data);
          return;
        }
    
        // Store provinces for later use if needed
        window.loadedProvinces = provinces;
    
      } catch (error) {
        console.error('❌ Failed to load provinces:', error);
      }
    }

    async function loadAmphures(provinceId, districtDropdownRef) {
      try {
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
    
        if (!distInput || !distDD) return;

        // Validate provinceId
        if (!provinceId || isNaN(provinceId)) {
          console.error('❌ Invalid provinceId for amphure loading:', provinceId);
          if (typeof showToast === 'function') {
            showToast('❌ รหัสจังหวัดไม่ถูกต้อง กรุณาเลือกจังหวัดใหม่', 'error');
          }
          if (distInput) distInput.value = '';
          if (distDD) {
            distDD.innerHTML = '<div class="dropdown-no-results">❌ กรุณาเลือกจังหวัดที่ถูกต้อง</div>';
            distDD.classList.remove('hidden');
          }
          return;
        }

        console.log('🔍 Loading amphures for province:', provinceId);
        const apiUrl = window.provinceAPI.amphures(provinceId);
        console.log('📡 API URL:', apiUrl);
    
        const response = await fetch(apiUrl);
        console.log('📊 Response status:', response.status, response.statusText);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('📋 Raw amphure response data:', data);
        console.log('📋 Type of data:', typeof data, 'Is array:', Array.isArray(data));
    
        // Handle different response formats
        let amphures = null;
        if (Array.isArray(data)) {
          amphures = data;
          console.log('✅ Using direct array format, count:', amphures.length);
        } else if (data.success && data.data && Array.isArray(data.data)) {
          amphures = data.data;
          console.log('✅ Using wrapped format, count:', amphures.length);
        } else if (data.error) {
          console.warn('API Error for amphures:', data.error);
          // Clear district and subdistrict fields
          distInput.value = '';
          subInput.value = '';
          zipInput.value = '';
    
          // Show user-friendly message
          if (districtDropdownRef) {
            districtDropdownRef.setItems([]);
            const distDD = document.getElementById('districtDropdown');
            if (distDD) {
              distDD.innerHTML = '<div class="dropdown-no-results">ไม่พบข้อมูลอำเภอสำหรับจังหวัดนี้</div>';
              distDD.classList.remove('hidden');
            }
          }
          return;
        } else {
          console.warn('Invalid amphure data received:', data);
          return;
        }
    
        if (amphures && amphures.length > 0) {
          const items = amphures
            .filter(item => item && (item.amphure_id || item.id)) // Filter out invalid items
            .map(item => {
              const amphureId = item.amphure_id || item.id;
              // ✅ Fix: ใช้ provinceId ที่ส่งมาจาก parameter แทนการพึ่งพา API response
              const actualProvinceId = item.province_id || provinceId;
              const name = item.name_th || item.name;
    
              // Debug logging for each item
              console.log('🔍 Processing amphure item:', {
                original: item,
                processed: {
                  id: amphureId,
                  name: name,
                  province_id: actualProvinceId,
                  amphure_id: amphureId
                }
              });
    
              return {
                id: amphureId,
                name: name,
                province_id: actualProvinceId,  // ← แก้ไขตรงนี้
                amphure_id: amphureId,
                displayText: name,
                subText: `รหัส: ${amphureId} | จังหวัด: ${actualProvinceId}`
              };
            });
    
          // Make items available for dropdown search
          if (districtDropdownRef) {
            districtDropdownRef.setItems(items);
    
            // Setup district search
            distInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                districtDropdownRef.setItems(items);
                districtDropdownRef.open();
                return;
              }
    
              const filtered = items.filter(item =>
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
    
              districtDropdownRef.setItems(filtered);
              districtDropdownRef.open();
            }, 300));
          }
    
          console.log('✅ Amphures loaded for province:', provinceId, '- Count:', items.length);
        } else {
          console.log('🔍 No amphures found for province:', provinceId);
        }
      } catch (error) {
        console.error('❌ Failed to load amphures:', error);
    
        // Show user-friendly error message
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
    
        if (distInput) distInput.value = '';
        if (distDD) {
          distDD.innerHTML = '<div class="dropdown-no-results">เกิดข้อผิดพลาดในการโหลดข้อมูลอำเภอ</div>';
          distDD.classList.remove('hidden');
        }
    
        // Clear subsequent fields
        const subInput = document.getElementById('subDistrict');
        const zipInput = document.getElementById('zipcode');
        if (subInput) subInput.value = '';
        if (zipInput) zipInput.value = '';
      }
    }

    async function loadTambons(provinceId, amphureId, tambonDropdownRef) {
      try {
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
    
        if (!subInput || !subDD) return;

        // Validate IDs
        if (!provinceId || isNaN(provinceId) || !amphureId || isNaN(amphureId)) {
          console.error('❌ Invalid provinceId or amphureId:', {provinceId, amphureId});
          if (subInput) subInput.value = '';
          if (subDD) {
            subDD.innerHTML = '<div class="dropdown-no-results">กรุณาเลือกอำเภอที่ถูกต้อง</div>';
            subDD.classList.remove('hidden');
          }
          return;
        }

        console.log('🔍 Loading tambons for province:', provinceId, 'amphure:', amphureId);
        const apiUrl = window.provinceAPI.tambons(provinceId, amphureId);
        console.log('📡 API URL:', apiUrl);
    
        const response = await fetch(apiUrl);
        console.log('📊 Response status:', response.status, response.statusText);
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    
        const data = await response.json();
        console.log('📋 Raw response data:', data);
    
        // Handle different response formats
        let tambons = null;
        if (Array.isArray(data)) {
          tambons = data;
        } else if (data.success && data.data && Array.isArray(data.data)) {
          tambons = data.data;
        } else if (data.error) {
          console.warn('API Error for tambons:', data.error);
          // Clear subdistrict and zipcode fields
          subInput.value = '';
          zipInput.value = '';
    
          // Show user-friendly message
          if (tambonDropdownRef) {
            tambonDropdownRef.setItems([]);
            const subDD = document.getElementById('subDistrictDropdown');
            if (subDD) {
              subDD.innerHTML = '<div class="dropdown-no-results">ไม่พบข้อมูลตำบลสำหรับอำเภอนี้</div>';
              subDD.classList.remove('hidden');
            }
          }
          return;
        } else {
          console.warn('Invalid tambon data received:', data);
          return;
        }
    
        if (tambons && tambons.length > 0) {
          const items = tambons
            .filter(item => item && (item.tambon_id || item.id)) // Filter out invalid items
            .map(item => {
              const tambonId = item.tambon_id || item.id;
              const name = item.name_th || item.name;
              const zipcode = item.zip_code || item.zipcode || item.postal_code;
              return {
                id: tambonId,
                name: name,
                province_id: item.province_id,
                amphure_id: item.amphure_id,
                tambon_id: tambonId,
                zip_code: zipcode,
                zipcode: zipcode,
                postal_code: zipcode,
                displayText: name,
                subText: zipcode ? `รหัสไปรษณีย์: ${zipcode}` : 'ไม่มีรหัสไปรษณีย์'
              };
            });
    
          // Make items available for dropdown search
          if (tambonDropdownRef) {
            tambonDropdownRef.setItems(items);
    
            // Setup tambon search
            subInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                tambonDropdownRef.setItems(items);
                tambonDropdownRef.open();
                return;
              }
    
              const filtered = items.filter(item =>
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
    
              tambonDropdownRef.setItems(filtered);
              tambonDropdownRef.open();
            }, 300));
          }
    
          console.log('✅ Tambons loaded for amphure:', amphureId, '- Count:', items.length);
        } else {
          console.log('🔍 No tambons found for amphure:', amphureId);
        }
      } catch (error) {
        console.error('❌ Failed to load tambons:', error);
    
        // Show user-friendly error message
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
    
        if (subInput) subInput.value = '';
        if (subDD) {
          subDD.innerHTML = '<div class="dropdown-no-results">เกิดข้อผิดพลาดในการโหลดข้อมูลตำบล</div>';
          subDD.classList.remove('hidden');
        }
    
        // Clear zipcode field
        const zipInput = document.getElementById('zipcode');
        if (zipInput) zipInput.value = '';
      }
    }

    // Utility function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Address Preview Update Function (Global)
    window.updateAddressPreview = function() {
      const houseNo = document.getElementById('houseNo')?.value || '';
      const moo = document.getElementById('moo')?.value || '';
      const soi = document.getElementById('soi')?.value || '';
      const road = document.getElementById('road')?.value || '';
      const province = document.getElementById('province')?.value || '';
      const district = document.getElementById('district')?.value || '';
      const subDistrict = document.getElementById('subDistrict')?.value || '';
      const zipcode = document.getElementById('zipcode')?.value || '';
    
      let addressParts = [];
    
      if (houseNo) addressParts.push(`เลขที่ ${houseNo}`);
      if (moo) addressParts.push(`หมู่ ${moo}`);
      if (soi) addressParts.push(`ซอย ${soi}`);
      if (road) addressParts.push(`ถนน ${road}`);
      if (subDistrict) addressParts.push(`ตำบล ${subDistrict}`);
      if (district) addressParts.push(`อำเภอ ${district}`);
      if (province) addressParts.push(`จังหวัด ${province}`);
      if (zipcode) addressParts.push(zipcode);
    
      const fullAddress = addressParts.join(' ');
      console.log('📍 Address Preview:', fullAddress);
    
      // You can add code here to show address preview in UI
    };

    console.log('🌍 Enhanced Location Autocomplete with Zipcode Validation loaded');

    // ==================== RECEIPT VOUCHER SYNC FUNCTIONS ====================
    
    /**
     * Sync frontstore sale with Receipt Voucher System for automatic receipt voucher creation
     */
    async function syncFrontstoreWithReceiptVoucher(saleData) {
      try {
        console.log('📤 Syncing frontstore sale data:', saleData);
    
        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('No authentication token found');
        }
    
        // เตรียม sync data สำหรับการขายหน้าร้าน
        const receiptData = {
          // Sync API fields
          source: 'frontstore',
          sourceId: saleData.orderId,
          documentNumber: `RV-FS-${saleData.invoiceNo}-${Date.now()}`,
          customerName: saleData.customerName || 'ลูกค้าทั่วไป',
          totalAmount: saleData.totalAmount,
          netAmount: saleData.netAmount,
          vatAmount: saleData.vatAmount,
          paymentMethod: saleData.paymentMethod || 'cash',
          description: `รับเงินจากการขาย ใบเสร็จเลขที่ ${saleData.invoiceNo}`,
          notes: `สร้างอัตโนมัติจากระบบขายหน้าร้าน ใบเสร็จเลขที่ ${saleData.invoiceNo}`,
    
          // Additional metadata
          metadata: {
            invoiceNumber: saleData.invoiceNo,
            invoiceNo: saleData.invoiceNo,
            branchCode: saleData.branchCode,
            staffId: saleData.staffId,
            staffName: saleData.staffName,
            customerType: saleData.customerType,
            invoiceType: saleData.invoiceType,
            items: saleData.items?.map(item => ({
              name: item.name,
              quantity: item.qty,
              price: item.price,
              total: item.price * item.qty
            })) || []
          }
        };
    
        console.log('📋 Prepared receipt data:', receiptData);
    
        // ส่งไปยัง Receipt Voucher Sync API
        const response = await fetch('/api/receipt-vouchers/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(receiptData)
        });
    
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Receipt Voucher API error: ${response.status} - ${errorText}`);
        }
    
        const result = await response.json();
    
        if (result.success) {
          console.log('✅ Receipt voucher created successfully:', result.data.documentNumber);
    
          // แสดงการแจ้งเตือนสำเร็จ
          if (typeof showToast === 'function') {
            showToast(
              `💰 สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`,
              'success',
              'ระบบใบสำคัญรับเงิน',
              4000
            );
          }
    
          // POS Notification
          if (posNotificationSystem) {
            posNotificationSystem.addNotification('pos', {
              title: 'ใบสำคัญรับเงิน',
              message: `สร้างใบสำคัญรับเงิน ${result.data.documentNumber} สำเร็จ`,
              type: 'success',
              icon: '🧾',
              actions: [
                {
                  label: 'ดูใบสำคัญรับเงิน',
                  action: 'primary',
                  callback: () => {
                    window.open(`/receipt-voucher/${result.data.id}`, '_blank');
                  }
                }
              ]
            });
          }
    
          return result.data;
        } else {
          throw new Error(result.message || 'Failed to create receipt voucher');
        }
    
      } catch (error) {
        console.error('❌ Error syncing with Receipt Voucher System:', error);
    
        // แสดงการแจ้งเตือน error แต่ไม่ให้ขัดขวางการทำงานหลัก
        if (typeof showToast === 'function') {
          showToast(
            `⚠️ ไม่สามารถสร้างใบสำคัญรับเงินอัตโนมัติได้: ${error.message}`,
            'warning',
            'ระบบใบสำคัญรับเงิน',
            6000
          );
        }
    
        throw error; // Re-throw เพื่อให้ caller รู้ว่าเกิด error
      }
    }

    // Make sync function globally available
    window.syncFrontstoreWithReceiptVoucher = syncFrontstoreWithReceiptVoucher;

    // ============================================
    // 🔧 Card Reader Comprehensive Diagnostic Tool
    // ============================================
    
    /**
     * เครื่องมือวินิจฉัยปัญหา Card Reader แบบครอบคลุม
     * สำหรับ Administrator และ Technical Support
     */
    async function runCardReaderDiagnostic() {
      console.log('🔍 Starting comprehensive Card Reader diagnostic...');
    
      const branchCode = window.BRANCH_CODE || window.CardReaderConfig?.getCurrentBranchCode() || '00000';
      const diagnosticResults = {
        timestamp: new Date().toISOString(),
        branchCode: branchCode,
        tests: []
      };
    
      // ✅ Test 1: Card Reader Configuration
      try {
        const configTest = {
          name: 'Configuration Check',
          status: 'running',
          details: {}
        };
    
        if (window.CardReaderConfig) {
          configTest.status = 'passed';
          configTest.details = {
            enabled: window.CardReaderConfig.isCardReaderEnabled(branchCode),
            branch: window.CardReaderConfig.getBranchName(branchCode),
            endpoints: window.CardReaderConfig.getCardProxyUrls(branchCode)
          };
        } else {
          configTest.status = 'failed';
          configTest.details = { error: 'CardReaderConfig not loaded' };
        }
    
        diagnosticResults.tests.push(configTest);
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'Configuration Check',
          status: 'error',
          details: { error: error.message }
        });
      }
    
      // ✅ Test 2: Service Availability
      try {
        const serviceTest = {
          name: 'CardReaderService Availability',
          status: window.CardReaderService ? 'passed' : 'failed',
          details: {
            serviceLoaded: !!window.CardReaderService,
            readCardFunction: !!(window.CardReaderService?.readCard),
            loadTime: 'N/A'
          }
        };
    
        diagnosticResults.tests.push(serviceTest);
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'CardReaderService Availability',
          status: 'error',
          details: { error: error.message }
        });
      }
    
      // ✅ Test 3: Network Connectivity
      const networkTests = [];
      if (window.CardReaderConfig?.isCardReaderEnabled(branchCode)) {
        const urlConfig = window.CardReaderConfig.getCardProxyUrls(branchCode);
    
        for (const proxy of urlConfig.all) {
          try {
            const startTime = Date.now();
            const response = await fetch(proxy.http + '/health', {
              method: 'GET',
              timeout: 3000
            });
            const endTime = Date.now();
    
            networkTests.push({
              name: `Network Test - ${proxy.name}`,
              status: response.ok ? 'passed' : 'failed',
              details: {
                url: proxy.http,
                responseTime: endTime - startTime,
                httpStatus: response.status,
                reachable: true
              }
            });
          } catch (error) {
            networkTests.push({
              name: `Network Test - ${proxy.name}`,
              status: 'failed',
              details: {
                url: proxy.http,
                error: error.message,
                reachable: false
              }
            });
          }
        }
      }
    
      diagnosticResults.tests.push(...networkTests);
    
      // ✅ Test 4: Server API Test
      try {
        const startTime = Date.now();
        const response = await fetch('/api/cardreader/health', {
          method: 'GET',
          timeout: 5000
        });
        const endTime = Date.now();
    
        diagnosticResults.tests.push({
          name: 'Server API Health Check',
          status: response.ok ? 'passed' : 'failed',
          details: {
            url: '/api/cardreader/health',
            responseTime: endTime - startTime,
            httpStatus: response.status
          }
        });
      } catch (error) {
        diagnosticResults.tests.push({
          name: 'Server API Health Check',
          status: 'failed',
          details: {
            url: '/api/cardreader/health',
            error: error.message
          }
        });
      }
    
      // ✅ Display Results
      const passedTests = diagnosticResults.tests.filter(t => t.status === 'passed').length;
      const totalTests = diagnosticResults.tests.length;
    
      console.log('📊 Card Reader Diagnostic Results:', diagnosticResults);
    
      // สร้าง HTML Report สำหรับแสดงผล
      const reportHTML = generateDiagnosticReport(diagnosticResults, passedTests, totalTests);
    
      if (typeof showToast === 'function') {
        showToast(
          reportHTML,
          passedTests === totalTests ? 'success' : 'warning',
          `🔍 Card Reader Diagnostic (${passedTests}/${totalTests} passed)`,
          0 // ไม่หายไปเอง
        );
      }
    
      return diagnosticResults;
    }
    
    /**
     * สร้าง HTML Report สำหรับแสดงผลการวินิจฉัย
     */
    function generateDiagnosticReport(results, passed, total) {
      const testRows = results.tests.map(test => {
        const statusIcon = test.status === 'passed' ? '✅' :
                          test.status === 'failed' ? '❌' : '⚠️';
        const statusClass = test.status === 'passed' ? 'text-success' :
                           test.status === 'failed' ? 'text-danger' : 'text-warning';
    
        return `
          <tr>
            <td class="${statusClass}">${statusIcon} ${test.name}</td>
            <td class="${statusClass}">${test.status.toUpperCase()}</td>
          </tr>
        `;
      }).join('');
    
      return `
        <div class="diagnostic-report">
          <h6 class="mb-3">🔍 Card Reader Diagnostic Report</h6>
          <div class="mb-3">
            <strong>Branch:</strong> ${results.branchCode}<br>
            <strong>Time:</strong> ${new Date(results.timestamp).toLocaleString('th-TH')}<br>
            <strong>Results:</strong> ${passed}/${total} tests passed
          </div>
          
          <table class="table table-sm">
            <thead>
              <tr><th>Test</th><th>Status</th></tr>
            </thead>
            <tbody>
              ${testRows}
            </tbody>
          </table>
          
          <div class="d-flex gap-2 mt-3">
            <button onclick="copyDiagnosticResults()" class="btn btn-sm btn-info">
              📋 Copy Report
            </button>
            <button onclick="retestCardReader()" class="btn btn-sm btn-warning">
              🔄 Run Again
            </button>
            ${passed < total ? '<button onclick="showCardReaderTroubleshooting()" class="btn btn-sm btn-danger">🛠️ Troubleshoot</button>' : ''}
          </div>
        </div>
      `;
    }
    
    /**
     * คัดลอกผลการวินิจฉัยไปยัง Clipboard
     */
    async function copyDiagnosticResults() {
      // เก็บผลการวินิจฉัยล่าสุด
      if (window.lastDiagnosticResults) {
        try {
          const report = JSON.stringify(window.lastDiagnosticResults, null, 2);
          await navigator.clipboard.writeText(report);
    
          if (typeof showToast === 'function') {
            showToast('✅ คัดลอกรายงานเรียบร้อย', 'success', 'Diagnostic', 3000);
          }
        } catch (error) {
          console.error('Failed to copy diagnostic results:', error);
          if (typeof showToast === 'function') {
            showToast('❌ ไม่สามารถคัดลอกได้', 'error', 'Diagnostic', 3000);
          }
        }
      }
    }
    
    /**
     * รันการวินิจฉัยใหม่
     */
    async function retestCardReader() {
      if (typeof hideAllToasts === 'function') {
        hideAllToasts();
      }
    
      const results = await runCardReaderDiagnostic();
      window.lastDiagnosticResults = results;
    }
    
    /**
     * แสดงคำแนะนำการแก้ไขปัญหา
     */
    function showCardReaderTroubleshooting() {
      const troubleshootingHTML = `
        <div class="troubleshooting-guide">
          <h6 class="mb-3">🛠️ Card Reader Troubleshooting Guide</h6>
          
          <div class="mb-3">
            <h7><strong>📋 Common Issues & Solutions:</strong></h7>
            <ul class="small">
              <li><strong>HTTP 500 Error:</strong> Server-side issue, contact IT support</li>
              <li><strong>Timeout:</strong> Network latency, check network connection</li>
              <li><strong>SSL Error:</strong> Certificate issue, use HTTP or contact IT</li>
              <li><strong>Connection Failed:</strong> Card reader service not running</li>
            </ul>
          </div>
          
          <div class="mb-3">
            <h7><strong>🔧 Quick Actions:</strong></h7>
            <div class="d-flex gap-2 mt-2">
              <button onclick="testSingleEndpoint()" class="btn btn-sm btn-outline-primary">
                🎯 Test Single Endpoint
              </button>
              <button onclick="resetCardReaderConfig()" class="btn btn-sm btn-outline-warning">
                🔄 Reset Config
              </button>
            </div>
          </div>
          
          <div class="alert alert-info small">
            <strong>💡 For Administrators:</strong><br>
            • Check card reader proxy services on target IPs<br>
            • Verify network connectivity from this machine<br>
            • Review server logs for API endpoint errors<br>
            • Consider using manual entry as temporary solution
          </div>
        </div>
      `;
    
      if (typeof showToast === 'function') {
        showToast(troubleshootingHTML, 'info', '🛠️ Troubleshooting Guide', 0);
      }
    }
    
    // ทำให้ functions พร้อมใช้งานทั่วโลก
    window.runCardReaderDiagnostic = runCardReaderDiagnostic;
    window.copyDiagnosticResults = copyDiagnosticResults;
    window.retestCardReader = retestCardReader;
    window.showCardReaderTroubleshooting = showCardReaderTroubleshooting;

    // ============================================
    // Thai ID Card Reader Integration
    // ============================================
    
    let cardWebSocket = null;
       let cardReaderConnected = false;
    let cardReaderAttempts = 0;
    const maxCardReaderAttempts = 3;
    
    // เชื่อมต่อกับ Card Proxy Server (รันบน client machine)
    function initCardReader() {
      // หยุดการพยายามเชื่อมต่อถ้าครบจำนวนครั้งแล้ว - Silent mode
      if (cardReaderAttempts >= maxCardReaderAttempts) {
        // Silent failure - ไม่แสดงข้อความใดๆ
        updateCardReaderStatus(false);
        return;
      }

      try {
        cardReaderAttempts++;
        // Silent attempt - ไม่แสดง console log

        // เชื่อมต่อ WebSocket ไปยัง Card Proxy บน localhost
        cardWebSocket = new WebSocket('ws://localhost:8080');

        // ตั้ง timeout สำหรับการเชื่อมต่อ
        const connectionTimeout = setTimeout(() => {
          if (cardWebSocket.readyState !== WebSocket.OPEN) {
            cardWebSocket.close();
            handleCardReaderConnectionFailed();
          }
        }, 3000);

        cardWebSocket.onopen = function() {
          clearTimeout(connectionTimeout);
          // Silent success
          cardReaderConnected = true;
          cardReaderAttempts = 0; // รีเซ็ตเมื่อเชื่อมต่อสำเร็จ
          updateCardReaderStatus(true);

          // ไม่แสดง toast notification
        };

        cardWebSocket.onmessage = function(event) {
          try {
            const cardData = JSON.parse(event.data);
            console.log('📋 ข้อมูลบัตรประชาชน:', cardData);

            if (cardData && cardData.Citizenid) {
              handleCardData(cardData);
            } else if (cardData === null) {
              handleCardRemoved();
            } else if (cardData.error) {
              handleCardError(cardData);
            }
          } catch (error) {
            console.error('❌ Error parsing card data:', error);
          }
        };

        cardWebSocket.onclose = function(event) {
          clearTimeout(connectionTimeout);
          // Silent close
          cardReaderConnected = false;
          updateCardReaderStatus(false);

          // Auto reconnect เฉพาะเมื่อไม่ใช่ connection failed และยังไม่ครบจำนวนครั้ง
          if (event.code !== 1006 && cardReaderAttempts < maxCardReaderAttempts) {
            setTimeout(initCardReader, 5000);
          } else {
            handleCardReaderConnectionFailed();
          }
        };

        cardWebSocket.onerror = function(error) {
          clearTimeout(connectionTimeout);
          // Silent error
          cardReaderConnected = false;
          handleCardReaderConnectionFailed();
        };

      } catch (error) {
        // Silent error
        cardReaderConnected = false;
        handleCardReaderConnectionFailed();
      }
    }

    function handleCardReaderConnectionFailed() {
      updateCardReaderStatus(false);
      // Silent mode - ไม่แสดงข้อความใดๆ
    }

    
    // อัพเดทสถานะการเชื่อมต่อเครื่องอ่านบัตร - ไม่ทำอะไร (UI ถูกลบออกแล้ว)
    function updateCardReaderStatus(connected) {
      // ไม่แสดง UI สถานะ - Card Reader ทำงานในพื้นหลังอย่างเดียว
      return;
    }
    
    // จัดการข้อมูลบัตรที่อ่านได้
    function handleCardData(cardData) {
      console.log('📋 ข้อมูลบัตรประชาชน:', cardData);
    
      // แสดงข้อมูลบัตรใน UI
      displayCardInfo(cardData);
    
      // เติมข้อมูลลูกค้าอัตโนมัติ
      autoFillCustomerData(cardData);
    
      // แสดงการแจ้งเตือน
      if (typeof showToast === 'function') {
        showToast(
          `✅ อ่านบัตรประชาชนสำเร็จ: ${cardData.TitleTh}${cardData.FirstNameTh} ${cardData.LastNameTh}`,
          'success',
          'เครื่องอ่านบัตร',
          5000
        );
      }
    }
    
    // จัดการเมื่อถอดบัตร
    function handleCardRemoved() {
      console.log('📤 ถอดบัตรแล้ว');
      clearCardInfo();
    
      if (typeof showToast === 'function') {
        showToast('📤 ถอดบัตรประชาชนแล้ว', 'info', 'เครื่องอ่านบัตร', 3000);
      }
    }
    
    // จัดการ error ในการอ่านบัตร
    function handleCardError(errorData) {
      console.error('❌ Card Reader Error:', errorData);
    
      if (typeof showToast === 'function') {
        showToast(
          `❌ ไม่สามารถอ่านบัตรได้: ${errorData.details || errorData.error}`,
          'error',
          'เครื่องอ่านบัตร',
          8000
        );
      }
    }
    
    // แสดงข้อมูลบัตรใน UI
    function displayCardInfo(cardData) {
      const cardInfoContainer = document.getElementById('cardInfoContainer');
      if (cardInfoContainer) {
        cardInfoContainer.innerHTML = `
          <div class="card-info">
            <h4>ข้อมูลบัตรประชาชน</h4>
            <div class="row">
              <div class="col-md-6">
                <p><strong>เลขบัตร:</strong> ${cardData.Citizenid}</p>
                <p><strong>ชื่อ-นามสกุล:</strong> ${cardData.TitleTh}${cardData.FirstNameTh} ${cardData.LastNameTh}</p>
                <p><strong>เพศ:</strong> ${cardData.Gender}</p>
                <p><strong>วันเกิด:</strong> ${cardData.BirthdayTh} (${cardData.Age} ปี)</p>
              </div>
              <div class="col-md-6">
                <p><strong>Name:</strong> ${cardData.TitleEng}${cardData.FirstNameEng} ${cardData.LastNameEng}</p>
                <p><strong>ที่อยู่:</strong> ${cardData.Address}</p>
                <p><strong>อ่านเมื่อ:</strong> ${new Date(cardData.timestamp).toLocaleString('th-TH')}</p>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    // ล้างข้อมูลบัตร
    function clearCardInfo() {
      const cardInfoContainer = document.getElementById('cardInfoContainer');
      if (cardInfoContainer) {
        cardInfoContainer.innerHTML = '';
      }
    }
    
    // เติมข้อมูลลูกค้าอัตโนมัติ
    function autoFillCustomerData(cardData) {
      // เติมข้อมูลในฟอร์มลูกค้า (ปรับตาม field names ที่มีอยู่)
      const customerForm = document.getElementById('customerForm') || document.querySelector('[data-customer-form]');
    
      if (customerForm) {
        // เลขบัตรประชาชน
        const citizenIdField = customerForm.querySelector('[name="citizenId"], [name="citizen_id"], #citizenId');
        if (citizenIdField) citizenIdField.value = cardData.Citizenid;
    
        // ชื่อ
        const firstNameField = customerForm.querySelector('[name="firstName"], [name="first_name"], #firstName, #customerFirstName');
        if (firstNameField) firstNameField.value = cardData.FirstNameTh;
    
        // นามสกุล
        const lastNameField = customerForm.querySelector('[name="lastName"], [name="last_name"], #lastName, #customerLastName');
        if (lastNameField) lastNameField.value = cardData.LastNameTh;
    
        // เพศ
        const genderField = customerForm.querySelector('[name="gender"], #gender');
        if (genderField) {
          if (genderField.type === 'select-one') {
            // สำหรับ dropdown
            const genderValue = cardData.Gender === 'ชาย' ? 'male' : 'female';
            genderField.value = genderValue;
          } else {
            genderField.value = cardData.Gender;
          }
        }
    
        // วันเกิด
        const birthdayField = customerForm.querySelector('[name="birthday"], [name="birth_date"], #birthday');
        if (birthdayField) {
          // แปลงรูปแบบวันที่สำหรับ input[type="date"]
          const parts = cardData.BirthdayEn.split('/');
          if (parts.length === 3) {
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            birthdayField.value = formattedDate;
          }
        }
    
        // ที่อยู่
        const addressField = customerForm.querySelector('[name="address"], #address');
        if (addressField) addressField.value = cardData.Address;
    
        console.log('✅ เติมข้อมูลลูกค้าอัตโนมัติแล้ว');
      }
    }
    
    // อ่านบัตรด้วยตนเอง
    async function readCardManually() {
      if (!cardReaderConnected) {
        if (typeof showToast === 'function') {
          showToast('❌ ไม่พบเครื่องอ่านบัตร กรุณาตรวจสอบการเชื่อมต่อ', 'error', 'เครื่องอ่านบัตร');
        }
        return;
      }
    
      try {
        const response = await fetch('http://localhost:3000/read-card');
        const result = await response.json();
    
        if (result.success && result.data) {
          handleCardData(result.data);
        } else {
          if (typeof showToast === 'function') {
            showToast('❌ ไม่พบบัตรประชาชน กรุณาใส่บัตรและลองอีกครั้ง', 'warning', 'เครื่องอ่านบัตร');
          }
        }
      } catch (error) {
        console.error('❌ Error reading card manually:', error);
        if (typeof showToast === 'function') {
          showToast('❌ ไม่สามารถอ่านบัตรได้ กรุณาตรวจสอบการเชื่อมต่อ', 'error', 'เครื่องอ่านบัตร');
        }
      }
    }
    
    // Make functions globally available
    window.readCardManually = readCardManually;
    
    // เริ่มต้นการเชื่อมต่อเครื่องอ่านบัตรเมื่อโหลดหน้าเสร็จ
    document.addEventListener('DOMContentLoaded', function() {
      // Silent mode - ไม่แสดงข้อความ
    
      // ไม่แสดง UI เครื่องอ่านบัตร - ลบออกตามคำร้องของผู้ใช้
      // addCardReaderUI();
    
      // เชื่อมต่อเครื่องอ่านบัตร (ทำงานในพื้นหลัง)
      // initCardReader(); // ✅ ปิดการใช้งาน WebSocket เก่า - ใช้ CardReaderService แทน
    });
    
    // เพิ่ม UI สำหรับเครื่องอ่านบัตร
    function addCardReaderUI() {
      // เพิ่ม CSS สำหรับเครื่องอ่านบัตร
      const style = document.createElement('style');
      style.textContent = `
        .card-reader-section {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 15px;
          margin: 10px 0;
        }
        .card-reader-status {
          font-weight: bold;
          padding: 8px 12px;
          border-radius: 4px;
          margin-bottom: 10px;
        }
        .card-reader-status.connected {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
        .card-reader-status.disconnected {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        .card-info {
          background: #e7f3ff;
          border: 1px solid #b8daff;
          border-radius: 4px;
          padding: 15px;
          margin-top: 10px;
        }
        .btn-read-card {
          background: #007bff;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
        }
        .btn-read-card:hover {
          background: #0056b3;
        }
        .btn-read-card:disabled {
          background: #6c757d;
          cursor: not-allowed;
        }
      `;
      document.head.appendChild(style);
    
      // หา element ที่เหมาะสมสำหรับใส่ UI เครื่องอ่านบัตร
      const targetContainer = document.querySelector('.customer-section, .form-section, .main-content')
                            || document.querySelector('#mainContent')
                            || document.querySelector('#level1Container')
                            || document.querySelector('.card')
                            || document.body;
    
      if (targetContainer) {
        const cardReaderSection = document.createElement('div');
        cardReaderSection.className = 'card-reader-section';
        cardReaderSection.innerHTML = `
          <h5>🆔 เครื่องอ่านบัตรประชาชน</h5>
          <div id="cardReaderStatus" class="card-reader-status">🔄 กำลังเชื่อมต่อเครื่องอ่านบัตร...</div>
          <button type="button" class="btn-read-card" onclick="readCardManually()">
            📖 อ่านบัตรด้วยตนเอง
          </button>
          <div id="cardInfoContainer"></div>
        `;
    
        // ใส่ก่อนเนื้อหาอื่น
        targetContainer.parentNode.insertBefore(cardReaderSection, targetContainer);
      }
    } // ← closing brace สำหรับ addCardReaderUI()

  </script>
  <script>
    // === STOCK RESERVATION HANDLING ===
    
    // จัดการการจองสต็อกหลังขายสำเร็จ
    async function handleStockReservationsAfterSale(saleData, reservedItems) {
      if (!reservedItems || reservedItems.length === 0) {
        console.log('📦 No reserved items to process');
        return;
      }
    
      console.log('🔒 Processing stock reservations after sale:', reservedItems);
    
      for (const item of reservedItems) {
        if (item.stockReservation && item.stockReservation.reservationId) {
          try {
            console.log(`🔓 Using stock reservation for ${item.name}:`, item.stockReservation.reservationId);
    
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/stock-reservation/use', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                reservationId: item.stockReservation.reservationId,
                transactionId: saleData.receiptNumber || saleData.taxInvoiceNumber || 'UNKNOWN',
                saleType: 'cash'
              })
            });
    
            const result = await response.json();
    
            if (result.success) {
              console.log(`✅ Stock reservation used for ${item.name}:`, result.data);
    
              if (typeof showToast === 'function') {
                showToast(
                  `ตัดสต็อกสินค้าที่จองสำเร็จ: ${item.name}`,
                  'success'
                );
              }
            } else {
              console.warn(`⚠️ Failed to use stock reservation for ${item.name}:`, result.message);
    
              if (typeof showToast === 'function') {
                showToast(
                  `ไม่สามารถตัดสต็อกสินค้าที่จองได้: ${item.name}`,
                  'warning'
                );
              }
            }
    
          } catch (error) {
            console.error(`❌ Error using stock reservation for ${item.name}:`, error);
          }
        }
      }
    
      console.log('🔒 Finished processing stock reservations');
    }

    // ฟังก์ชันสำหรับการชำระแบบผสม
    function updateMixedPayment() {
      const cashAmount = parseFloat(document.getElementById('mixedCashAmount').value) || 0;
      const transferAmount = parseFloat(document.getElementById('mixedTransferAmount').value) || 0;
      const total = cashAmount + transferAmount;
    
      document.getElementById('mixedTotalDisplay').textContent = `${total.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })} บาท`;
    }

    // ฟังก์ชันแสดง/ซ่อนส่วนการชำระแบบผสม
    function toggleMixedPaymentSection() {
      const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      const mixedSection = document.getElementById('mixedPaymentDetails');
    
      if (selectedPaymentMethod === 'MIXED') {
        mixedSection.classList.remove('hidden');
      } else {
        mixedSection.classList.add('hidden');
        // รีเซ็ตค่า
        document.getElementById('mixedCashAmount').value = '';
        document.getElementById('mixedTransferAmount').value = '';
        document.getElementById('mixedTotalDisplay').textContent = '0.00 บาท';
      }
    }

    // เพิ่ม event listeners สำหรับ payment method
    document.addEventListener('DOMContentLoaded', function() {
      // เพิ่ม event listener สำหรับ radio buttons
      const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
      paymentMethods.forEach(radio => {
        radio.addEventListener('change', toggleMixedPaymentSection);
      });
    });
  </script>
  
</body>

</html>
