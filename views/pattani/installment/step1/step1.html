<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</title>
  
  <!-- Permissive Content Security Policy for ZK9500 HTTP API -->
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />



  <!-- Tailwind CSS CDN -->
  
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(msg) {
      if (msg && msg.includes && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com')
      )) {
        return; // Suppress Tailwind production warnings
      }
      originalWarn.apply(console, arguments);
    };
  </script>

  <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>
  
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Installment System Styles - Complete Inline -->
  <style>
    /* ========== INSTALLMENT SYSTEM SPECIFIC STYLES ========== */
    /* ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani */

    /* ========== PERFORMANCE OPTIMIZATIONS ========== */
    /* Performance optimization: Use will-change for animated elements */
    .stepper,
    .step-icon,
    .loading-spinner,
    .card,
    .toast,
    .modal,
    .dropdown {
      will-change: transform, opacity;
    }

    /* CSS containment for better performance */
    .card,
    .product-card,
    .modal-box,
    .step-content {
      contain: layout style paint;
    }

    /* Optimize transforms with transform3d for hardware acceleration */
    .toast,
    .modal,
    .dropdown,
    .stepper {
      transform: translate3d(0, 0, 0);
    }

    /* Optimize repaints by grouping similar elements */
    .btn,
    .input,
    .select,
    .textarea {
      backface-visibility: hidden;
    }

    /* Use cheaper CSS properties for frequently changing elements */
    .loading-spinner,
    .progress-bar {
      will-change: transform;
      transform: translateZ(0);
    }

    /* ========== PDF STYLES ========== */
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á Customer / Meta */
    .pdf-header-grid {
      display: flex;
      justify-content: space-between;
      background: #eaf7ff;
      padding: 8pt;
      margin-bottom: 12pt;
    }

    .pdf-box {
      width: 48%;
      border: 1pt solid #008cff;
      padding: 6pt;
      background: #ffffff;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .pdf-table th {
      background: #008cff;
      color: #ffffff;
    }

    /* Totals area */
    .pdf-totals-grid {
      display: flex;
      justify-content: space-between;
      background: #eaf7ff;
      padding: 8pt;
      margin-top: 12pt;
    }

    .pdf-amount-words {
      width: 60%;
      font-size: 12pt;
    }

    .pdf-grandbox {
      width: 35%;
      background: #cce8ff;
      padding: 6pt;
      text-align: right;
      font-size: 12pt;
    }

    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà signature */
    .pdf-sign-row .pdf-sign-box {
      border-top: 1pt dashed #000000;
      padding-top: 6pt;
      width: 30%;
      text-align: center;
    }

    /* ========== STEPPER STYLES ========== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .dark .stepper::before {
      background: #4b5563;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: #4361ee;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      z-index: 2;
      position: relative;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .step.active .step-icon {
      background: #4361ee;
      color: white;
      border-color: #4361ee;
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
    }

    .step.completed .step-icon {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .step.completed .step-icon::before {
      content: '‚úì';
      font-size: 18px;
      font-weight: bold;
    }

    .step-text {
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      text-align: center;
      transition: color 0.3s ease;
      line-height: 1.2;
    }

    .step.active .step-text {
      color: #4361ee;
      font-weight: 600;
    }

    .step.completed .step-text {
      color: #10b981;
      font-weight: 600;
    }

    .step-content {
      display: none !important;
      width: 100%;
    }

    .step-content.active {
      display: block !important;
    }

    /* ========== PRODUCT CARD STYLES ========== */
    .product-card {
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* ========== PROMOTION STYLES ========== */
    /* üî• Fire Icon */
    .promo-fire-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 32px;
      z-index: 30;
      filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
    }

    /* Card with promotion */
    .card.has-promotion {
      position: relative;
      overflow: visible !important;
    }
    
    /* Enhanced promotion badge */
    .promo-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: pulse-promo 2s infinite;
    }
    
    @keyframes pulse-promo {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Override card overflow for promotion icons */
    #level1Items .card,
    #level2Items .card,
    #level3Items .card {
      overflow: visible !important;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Fire Icon animation ‡πÉ‡∏ô dark mode */
    .dark .promo-fire-icon {
      filter: brightness(1.2);
    }

    /* Confetti styles */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 1000;
    }

    /* ========== DARK MODE SUPPORT ========== */
    /* Input ‡πÅ‡∏•‡∏∞ Select Dark Mode Support */
    .input,
    .select,
    .textarea {
      background-color: #ffffff;
      border: 1px solid #d1d5db;
      color: #1f2937;
    }

    .dark .input,
    .dark .select,
    .dark .textarea {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f9fafb !important;
    }

    .dark .input:focus,
    .dark .select:focus,
    .dark .textarea:focus {
      background-color: #4b5563 !important;
      border-color: #6b7280 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }

    .dark .input::placeholder,
    .dark .textarea::placeholder {
      color: #9ca3af !important;
    }

    /* File Input Dark Mode */
    .dark .file-input {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f9fafb !important;
    }

    .dark .file-input::file-selector-button {
      background-color: #4b5563 !important;
      border-color: #6b7280 !important;
      color: #f9fafb !important;
    }

    /* Radio ‡πÅ‡∏•‡∏∞ Checkbox Dark Mode */
    .dark .radio,
    .dark .checkbox {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
    }

    .dark .radio:checked,
    .dark .checkbox:checked {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
    }

    /* Modal Dark Mode */
    .dark .modal-box {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
      border: 1px solid #374151 !important;
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Dark Mode */
    .dark .btn {
      border-color: #4b5563 !important;
    }

    .dark .btn:not(.btn-primary):not(.btn-secondary):not(.btn-accent) {
      background-color: #374151 !important;
      color: #f9fafb !important;
    }

    .dark .btn:not(.btn-primary):not(.btn-secondary):not(.btn-accent):hover {
      background-color: #4b5563 !important;
    }

    /* Dropdown Options Dark Mode */
    .dark .select option {
      background-color: #374151 !important;
      color: #f9fafb !important;
    }

    /* Table Dark Mode */
    .dark .table {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }

    .dark .table th,
    .dark .table td {
      border-color: #374151 !important;
    }

    /* Background containers Dark Mode */
    .dark .bg-white {
      background-color: #1f2937 !important;
    }

    .dark .bg-gray-50 {
      background-color: #374151 !important;
    }

    .dark .bg-blue-50 {
      background-color: #1e3a8a !important;
    }

    .dark .bg-yellow-50 {
      background-color: #92400e !important;
    }

    .dark .bg-green-50 {
      background-color: #14532d !important;
    }

    /* Text Colors Dark Mode */
    .dark .text-gray-600,
    .dark .text-gray-700,
    .dark .text-gray-800,
    .dark .text-gray-900 {
      color: #d1d5db !important;
    }

    .dark .text-blue-700 {
      color: #93c5fd !important;
    }

    /* Border Colors Dark Mode */
    .dark .border-gray-200,
    .dark .border-gray-300 {
      border-color: #4b5563 !important;
    }

    /* Main Content Dark Mode */
    .dark main {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }

    /* Container Dark Mode */
    .dark .container {
      background-color: #1f2937 !important;
    }

    /* Force light mode main content */
    main {
      background-color: #f9fafb !important;
      color: #374151 !important;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á div ‡πÅ‡∏•‡∏∞ section containers */
    .dark div:not([class*="bg-"]):not([style*="background"]) {
      color: inherit;
    }

    /* Sidebar Dark Mode ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á */
    .dark aside {
      background-color: #1f2937 !important;
    }

    /* Header Dark Mode */
    .dark header {
      background-color: #1f2937 !important;
      color: #f9fafb !important;
    }

    /* Label Dark Mode */
    .dark label {
      color: #f9fafb !important;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô step4 */
    .dark #step4 .card {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: transparent !important;
    }

    .dark #step4.step-content.active {
      background-color: transparent !important;
    }

    /* ========== SIDEBAR STYLES ========== */
    /* ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô sidebar */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }

    /* ========== RESPONSIVE LAYOUT WITH SIDEBAR ========== */
    /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ layout ‡πÄ‡∏°‡∏∑‡πà‡∏≠ sidebar ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î */
    #mainContent {
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö padding ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    .container-fluid {
      width: 100%;
      max-width: 100%;
      padding: 1rem;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö stepper ‡πÉ‡∏´‡πâ‡∏°‡∏µ margin bottom */
    .stepper {
      margin-bottom: 2rem;
    }

    /* Enhanced sidebar */
    .sidebar-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    /* ========== STOCK ALERT STYLES ========== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }

    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }

    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }

    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }

    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }

    .card:hover .status-icon {
      opacity: 1 !important;
    }

    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }

    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }

    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }

    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }

    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }

    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }

    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }

    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }

    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }

    .dark .warning-text {
      color: #fbbf24 !important;
    }

    .dark .emergency-text {
      color: #f87171 !important;
    }

    /* ========== LAYOUT OVERRIDES ========== */
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å step */
    #step1, #step2, #step3, #step4 {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }

    /* Grid spacing adjustments */
    #level1Items .card,
    #level2Items .card,
    #level3Items .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    /* Loading overlay */
    [data-theme="dark"] .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== ENHANCED CARD STYLES ========== */
    .card {
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      background: white;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .card-header {
      padding: 16px 20px;
      font-weight: 600;
      font-size: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: rgba(248, 250, 252, 0.5);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 20px;
    }

    .dark .card {
      background: #1f2937;
      border-color: #374151;
    }

    .dark .card-header {
      background: rgba(0, 0, 0, 0.2);
      border-bottom-color: #374151;
      color: #e5e7eb;
    }

    /* ========== ENHANCED DARK MODE SUPPORT ========== */
    .dark .stepper {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border-color: #374151 !important;
    }

    .dark .stepper::before {
      background: #4b5563 !important;
    }

    .dark .step-icon {
      background: #374151 !important;
      color: #9ca3af !important;
    }

    .dark .step.active .step-icon {
      background: #2563eb !important;
      color: white !important;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2) !important;
    }

    .dark .step.completed .step-icon {
      background: #059669 !important;
      color: white !important;
    }

    .dark .step-text {
      color: #9ca3af !important;
    }

    .dark .step.active .step-text {
      color: #60a5fa !important;
    }

    .dark .step.completed .step-text {
      color: #34d399 !important;
    }

    .dark .product-card {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
      color: #f3f4f6 !important;
    }

    .dark .product-card:hover {
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3) !important;
      border-color: #2563eb !important;
    }

    /* ========== MAIN CONTENT ADJUSTMENTS ========== */
    @media (max-width: 768px) {
      #mainContent {
        margin-left: 0 !important;
      }
    }

    #mainContent.ml-0 {
      margin-left: 0 !important;
    }

    #mainContent.ml-64 {
      margin-left: 16rem !important;
    }
  </style>

  <!-- Modal Z-Index Fix -->
  <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö z-index ‡∏Ç‡∏≠‡∏á modal ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà conflict ‡∏Å‡∏±‡∏ô */
    #cameraModal {
      z-index: 9998 !important;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á modal */
    .modal:not(.hidden) {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .modal.hidden {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }
  </style>

  <!-- Enhanced Dark Mode Styles for Installment System -->
  <style>
    /* ===== ENHANCED DARK MODE SUPPORT ===== */
    /* Dark mode body and main areas */
    .dark body {
      background-color: #111827;
      color: #f3f4f6;
    }

    .dark #mainContent {
      background-color: #111827;
    }

    /* Dark mode card header styles */
    .dark .card-header {
      color: #f3f4f6 !important;
    }

    /* Dark mode stepper */
    .dark .step-text {
      color: #9ca3af;
    }

    .dark .step.active .step-text {
      color: #60a5fa;
    }

    .dark .step-icon {
      background: #374151;
      color: #9ca3af;
    }

    .dark .step.active .step-icon {
      background: #2563eb;
      color: white;
    }

    /* Dark mode form elements */
    .dark .input,
    .dark .select,
    .dark .textarea {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    .dark .input:focus,
    .dark .select:focus,
    .dark .textarea:focus {
      border-color: #2563eb !important;
      box-shadow: 0 0 0 1px #2563eb !important;
    }

    .dark .input::placeholder {
      color: #9ca3af !important;
    }

    .dark .label-text {
      color: #d1d5db !important;
    }

    /* Dark mode backgrounds */
    .dark .bg-blue-50 {
      background-color: #1e3a8a !important;
    }

    .dark .bg-green-50 {
      background-color: #14532d !important;
    }

    .dark .bg-gray-50 {
      background-color: #374151 !important;
    }

    .dark .bg-orange-50 {
      background-color: #9a3412 !important;
    }

    /* Dark mode button states */
    .dark .btn-primary {
      background-color: #2563eb !important;
      border-color: #2563eb !important;
      color: white !important;
    }

    .dark .btn-primary:hover {
      background-color: #1d4ed8 !important;
      border-color: #1d4ed8 !important;
    }

    .dark .btn-secondary {
      background-color: #6b7280 !important;
      border-color: #6b7280 !important;
      color: #f3f4f6 !important;
    }

    .dark .btn-secondary:hover {
      background-color: #4b5563 !important;
      border-color: #4b5563 !important;
    }

    .dark .btn-outline {
      border-color: #4b5563 !important;
      color: #d1d5db !important;
    }

    .dark .btn-outline:hover {
      background-color: #4b5563 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    /* Dark mode table styles */
    .dark .table th {
      background-color: #374151 !important;
      color: #f3f4f6 !important;
    }

    .dark .table td {
      border-color: #4b5563 !important;
      color: #e5e7eb !important;
    }

    .dark .table tr:hover {
      background-color: #374151 !important;
    }

    /* Dark mode card styles */
    .dark .card {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }

    .dark .card-title {
      color: #f3f4f6 !important;
    }

    .dark .card-body {
      color: #e5e7eb !important;
    }

    /* Dark mode badge styles */
    .dark .badge {
      background-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    .dark .badge-primary {
      background-color: #2563eb !important;
      color: white !important;
    }

    .dark .badge-success {
      background-color: #059669 !important;
      color: white !important;
    }

    .dark .badge-warning {
      background-color: #d97706 !important;
      color: white !important;
    }

    .dark .badge-error {
      background-color: #dc2626 !important;
      color: white !important;
    }

    /* Dark mode modal styles */
    .dark .modal-box {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
    }

    .dark .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    /* Dark mode dropdown styles */
    .dark .dropdown-content {
      background-color: #1f2937 !important;
      border-color: #374151 !important;
    }

    .dark .dropdown-content a {
      color: #e5e7eb !important;
    }

    .dark .dropdown-content a:hover {
      background-color: #374151 !important;
    }

    /* Dark mode alert styles */
    .dark .alert {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    .dark .alert-info {
      background-color: #1e40af !important;
      border-color: #2563eb !important;
    }

    .dark .alert-success {
      background-color: #059669 !important;
      border-color: #10b981 !important;
    }

    .dark .alert-warning {
      background-color: #d97706 !important;
      border-color: #f59e0b !important;
    }

    .dark .alert-error {
      background-color: #dc2626 !important;
      border-color: #ef4444 !important;
    }

    /* Dark mode text colors */
    .dark .text-gray-600 {
      color: #9ca3af !important;
    }

    .dark .text-gray-700 {
      color: #d1d5db !important;
    }

    .dark .text-gray-800 {
      color: #e5e7eb !important;
    }

    .dark .text-gray-900 {
      color: #f3f4f6 !important;
    }

    /* Dark mode border colors */
    .dark .border-gray-200 {
      border-color: #374151 !important;
    }

    .dark .border-gray-300 {
      border-color: #4b5563 !important;
    }

    .dark .border-gray-400 {
      border-color: #6b7280 !important;
    }

    /* Dark mode hover states */
    .dark .hover\:bg-gray-50:hover {
      background-color: #374151 !important;
    }

    .dark .hover\:bg-gray-100:hover {
      background-color: #4b5563 !important;
    }

    .dark .hover\:text-gray-700:hover {
      color: #e5e7eb !important;
    }
  </style>

  <!-- Loading System - Remove problematic CSS link -->

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script>
    // New Lottie Loading State with State Management (same as addNewProduct_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <!-- Loading Overlay CSS (Updated from addNewProduct_pattani.html) -->
  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <script>
    // Early function definitions to prevent ReferenceError
    console.log('üîß Setting up early function definitions...');
    
    // Retry mechanism for API calls with rate limiting handling
    async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 1000) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(url, options);
    
          // Check for rate limiting (429) or server errors (5xx)
          if (response.status === 429) {
            const retryAfter = response.headers.get('Retry-After');
            const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : delay * Math.pow(2, i);
    
            if (i < maxRetries - 1) {
              console.log(`‚è≥ Rate limited. Waiting ${waitTime}ms before retry ${i + 1}/${maxRetries}...`);
              await new Promise(resolve => setTimeout(resolve, waitTime));
              continue;
            } else {
              // Last retry failed
              const errorText = await response.text();
              if (errorText.toLowerCase().includes('too many requests')) {
                throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
              }
              throw new Error(`Too many requests. Please wait ${Math.ceil(waitTime/1000)} seconds and try again.`);
            }
          }
    
          // Handle server errors with retry
          if (response.status >= 500 && i < maxRetries - 1) {
            console.log(`‚ö†Ô∏è Server error ${response.status}. Retrying ${i + 1}/${maxRetries}...`);
            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
            continue;
          }
    
          // Check response body for rate limit message
          if (!response.ok) {
            const responseText = await response.text();
            if (responseText.toLowerCase().includes('too many requests')) {
              if (i < maxRetries - 1) {
                const waitTime = delay * Math.pow(2, i);
                console.log(`‚è≥ Rate limit detected in response. Waiting ${waitTime}ms before retry ${i + 1}/${maxRetries}...`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
                continue;
              } else {
                throw new Error('‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
              }
            }
            // Re-create response with the text we already read
            return new Response(responseText, {
              status: response.status,
              statusText: response.statusText,
              headers: response.headers
            });
          }
    
          return response;
        } catch (error) {
          if (i === maxRetries - 1) {
            // Final retry failed
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            }
            throw error;
          }
          console.log(`üîÑ Attempt ${i + 1} failed: ${error.message}. Retrying...`);
          await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
        }
      }
    }
    
    // Email document functions - early definitions
    window.initializeEmailDocumentSettings = window.initializeEmailDocumentSettings || function() {
      console.log('üîÑ Early initializeEmailDocumentSettings called - will be replaced later');
      return true;
    };
    
    window.updateEmailDocumentSelection = window.updateEmailDocumentSelection || function() {
      console.log('üîÑ Early updateEmailDocumentSelection called');
    };
    
    window.updateEmailPreview = window.updateEmailPreview || function() {
      console.log('üîÑ Early updateEmailPreview called');
    };
    
    window.checkEmailRequirement = window.checkEmailRequirement || function() {
      console.log('üîÑ Early checkEmailRequirement called');
      return true;
    };
    
    window.getSelectedEmailDocuments = window.getSelectedEmailDocuments || function() {
      console.log('üîÑ Early getSelectedEmailDocuments called');
      return [];
    };
    
    window.updateEmailAutomationIndicator = window.updateEmailAutomationIndicator || function() {
      console.log('üîÑ Early updateEmailAutomationIndicator called');
    };
    
    console.log('‚úÖ Early function definitions ready');
  </script>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  

  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-64">
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>
      </div>
      
      <!-- Modular Notifications & Actions -->
      <div class="flex items-center gap-4">
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-1">
            <span id="connectionStatus" class="connection-status offline text-xs font-medium">üî¥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            <div class="flex gap-1 ml-2">
              <div id="firebaseStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Firebase Status"></div>
              <div id="socketStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Socket.IO Status"></div>
              <div id="printerStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Printer Status"></div>
            </div>
          </div>
          <div id="onlineUserCount" class="text-xs text-gray-500" title="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">1</div>
        </div>

        <!-- Quick Actions Menu -->
        <div class="relative">
          <button id="quickActionsBtn" class="btn btn-outline flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300">
            <i class="bi bi-list text-lg"></i>
            <span class="hidden md:inline">‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
            <i class="bi bi-chevron-down text-sm ml-1"></i>
          </button>
          
          <!-- Dropdown Menu -->
          <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
            <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between">
              <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</span>
              <span id="dropdownBranchInfo" class="text-xs text-gray-400">‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</span>
            </div>
            
            <a href="/History_installment" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200">
              <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-receipt text-blue-600"></i>
              </div>
              <div>
                <div class="font-medium">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</div>
                <div class="text-xs text-gray-500">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
              </div>
            </a>
            
            <a href="/Installment_on_use" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors duration-200">
              <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-arrow-repeat text-orange-600"></i>
              </div>
              <div>
                <div class="font-medium">‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</div>
                <div class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ</div>
              </div>
            </a>
            
            <a href="/Installment_complete_pickup" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors duration-200">
              <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="bi bi-check-circle text-green-600"></i>
              </div>
              <div>
                <div class="font-medium">‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</div>
                <div class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö</div>
              </div>
            </a>
            
            <!-- Footer with shortcuts -->
            <div class="px-4 py-2 border-t border-gray-100 mt-2">
              <div class="flex items-center justify-between text-xs text-gray-400">
                <span>‡∏Å‡∏î Alt+M ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
                <span>v1.0.0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900">
      <div class="container-fluid p-4">
        <!-- Stepper -->
        <div class="stepper" role="navigation" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
          <div class="step active" data-step="1" role="tab" aria-selected="true" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
            <div class="step-icon" aria-hidden="true">1</div>
            <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          </div>
          <div class="step" data-step="2" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
            <div class="step-icon" aria-hidden="true">2</div>
            <div class="step-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          </div>
          <div class="step" data-step="3" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô">
            <div class="step-icon" aria-hidden="true">3</div>
            <div class="step-text">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô</div>
          </div>
          <div class="step" data-step="4" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå">
            <div class="step-icon" aria-hidden="true">4</div>
            <div class="step-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</div>
          </div>
        </div>



        <!-- STEP 1: Product Selection -->
        <div id="step1" class="step-content active">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Left: Product Browser -->
            <div class="lg:col-span-2 space-y-4">
              <!-- Search Card -->
              <div class="card p-4">
                <div class="flex gap-2">
                  <div class="flex-1 relative">
                    <input id="productSearchQuery" class="input input-bordered w-full pr-10"
                      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠ IMEI..." aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô" autocomplete="off" />
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                      <i class="bi bi-search text-gray-400"></i>
                    </div>
                  </div>
                  <button id="btnProductSearch" class="btn btn-primary" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    <i class="bi bi-search" aria-hidden="true"></i>
                    <span class="hidden sm:inline">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                  </button>
                  <button id="btnProductReset" class="btn btn-secondary" aria-label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                    <span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</span>
                  </button>
                </div>
              </div>

              <!-- Search Results Container -->
              <div id="imeiResultContainer" class="card p-4 hidden">
                <h5 class="mb-3 font-semibold"><i class="bi bi-search"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5>
                <div id="imeiResultList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- Search results will be rendered here -->
                </div>
              </div>

              <!-- Level 1 Container -->
              <div id="level1Container" class="card p-4">
                <h5 class="mb-3 font-semibold text-green-700 dark:text-green-300"><i class="bi bi-credit-card-2-front"></i> Level 1 ‚Äì ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h5>
                <div id="level1Items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- Products will be rendered here -->
                </div>
              </div>

              <!-- Level 2 Container -->
              <div id="level2Container" class="card p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                  <h5 id="level2Title" class="font-semibold"><i class="bi bi-menu-button-wide"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ...</h5>
                  <button class="btn btn-sm" id="btnBackToLevel1">
                    <i class="bi bi-arrow-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </div>
                <div id="level2Items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- Level 2 items will be rendered here -->
                </div>
              </div>

              <!-- Level 3 Container -->
              <div id="level3Container" class="card p-4 hidden">
                <div class="flex justify-between items-center mb-3">
                  <h5 id="level3Title" class="font-semibold"><i class="bi bi-phone"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
                  <button class="btn btn-sm" id="btnBackToLevel2">
                    <i class="bi bi-arrow-left mr-1"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </div>
                <div id="level3Items" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                  <!-- Level 3 items will be rendered here -->
                </div>
              </div>
            </div>

            <!-- Right: Cart Summary -->
            <div>
              <div class="card p-4">
                <h5 class="flex items-center gap-2 mb-4 font-semibold">
                  <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
                  <span class="text-sm font-normal text-gray-500 ml-2">(<span id="cartCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                </h5>
                
                <!-- Barcode Scanner -->
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                  <label class="label">
                    <span class="label-text font-semibold">
                      <i class="bi bi-upc-scan"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / IMEI
                    </span>
                  </label>
                  <div class="flex gap-2">
                    <input type="text" id="barcodeInput" class="input input-bordered flex-1"
                      placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå IMEI ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô..." autocomplete="off" />
                    <button id="btnAddBarcode" class="btn btn-primary" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å IMEI">
                      <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                    <button id="btnClearBarcode" class="btn btn-secondary" title="‡∏•‡πâ‡∏≤‡∏á IMEI">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå IMEI ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter | ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                  </div>
                  
                  <!-- Barcode Results -->
                  <div id="barcodeResults" class="mt-3 hidden">
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                      <div class="flex items-center gap-2">
                        <i class="bi bi-check-circle text-green-600"></i>
                        <span class="text-sm font-semibold text-green-800 dark:text-green-200">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</span>
                      </div>
                      <div id="barcodeProductInfo" class="text-sm text-green-700 dark:text-green-300 mt-1">
                        <!-- Product info will be displayed here -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Customer Search Section -->
                <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                  <label class="label">
                    <span class="label-text font-semibold">
                      <i class="bi bi-person-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                    </span>
                  </label>
                  <div class="flex gap-2">
                    <input type="text" id="customerSearch" class="input input-bordered flex-1"
                      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." autocomplete="off" />
                    <button id="btnSearchCustomer" class="btn btn-primary" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                      <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </div>

                  <!-- Customer Search Results -->
                  <div id="customerSearchResults" class="mt-3 hidden">
                    <!-- Search results will be displayed here -->
                  </div>

                  <!-- Selected Customer Display -->
                  <div id="selectedCustomerDisplay" class="mt-3 hidden">
                    <!-- Selected customer info will be displayed here -->
                  </div>
                </div>

                <div class="cart-summary">
                  <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                </div>



                <div class="mt-4">
                  <button id="btnStep1ToStep2" class="btn btn-primary btn-block" disabled>
                    <i class="bi bi-x-circle mr-2"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </main>

  <!-- Scripts -->
  
  <!-- Global Data Manager -->
  <script src="/views/pattani/installment/js/global-data-manager.js?v=2"></script>

  <!-- Installment API Module -->
  <script src="/views/pattani/installment-api.js"></script>

  <!-- Shared Promotion Manager -->
  <script src="/views/shared/js/promotion-manager.js"></script>
  
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  <script>
    // Global Data Manager will be initialized by global-data-manager.js
    // Use window.globalInstallmentManager instead
    
    // Get branch code from URL and validate
    const urlParams = new URLSearchParams(window.location.search);
    const branchFromURL = urlParams.get('branch');
    
    // Check for invalid branch code and redirect if needed
    // '00000' is valid as it's the main office branch code
    if (!branchFromURL || branchFromURL === 'undefined' || branchFromURL === 'null') {
      console.error('‚ùå Invalid branch code:', branchFromURL);
      alert('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà');
      // Redirect to branch selection (using frontstore_index instead of branch-selection)
      window.location.href = '/frontstore_index';
    } else {
      // Set valid branch code (including '00000' for main office)
      window.BRANCH_CODE = branchFromURL;
      console.log('‚úÖ Branch code set:', branchFromURL);
    }
    
    // Global variables
    let cartItems = [];
    let branchInstallments = [];
    let currentParentKey = null;
    let currentLevel = 1;
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];
    
    // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏° Simple Cache System
    const simpleCache = {
      data: new Map(),
      timestamps: new Map(),
      maxAge: 5 * 60 * 1000, // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
    
      set(key, value) {
        this.data.set(key, value);
        this.timestamps.set(key, Date.now());
        console.log(`üíæ Cached: ${key}`);
      },
    
      get(key) {
        const timestamp = this.timestamps.get(key);
        const data = this.data.get(key);
    
        if (!timestamp || !data) return null;
    
        if (Date.now() - timestamp > this.maxAge) {
          this.data.delete(key);
          this.timestamps.delete(key);
          console.log(`üóëÔ∏è Cache expired: ${key}`);
          return null;
        }
    
        console.log(`‚úÖ Cache hit: ${key}`);
        return data;
      },
    
      clear() {
        this.data.clear();
        this.timestamps.clear();
        console.log('üßπ Cache cleared');
      }
    };
    
    // Define getImageUrl early to avoid undefined errors
    function getImageUrl(imagePath) {
      if (!imagePath) return '/uploads/Logo2.png';
      if (imagePath.startsWith('http')) return imagePath;
    
      let url = imagePath;
    
      // Debug logging
      console.log('üñºÔ∏è Original image path:', imagePath);
    
      // Convert all backslashes to forward slashes first
      url = url.replace(/\\/g, '/');
    
      // Remove any existing domain or protocol
      url = url.replace(/^https?:\/\/[^\/]+/, '');
    
      // More aggressive cleanup of duplicate path segments
      // Remove multiple consecutive uploads/products segments
      url = url.replace(/(\/?uploads\/products\/)+/g, '/uploads/products/');
      url = url.replace(/(\/?uploads\\products\\)+/g, '/uploads/products/');
      url = url.replace(/(uploads\/products\/)+/g, 'uploads/products/');
    
      // Clean up any remaining duplicates
      url = url.replace(/uploads\/products\/uploads\/products\//g, 'uploads/products/');
      url = url.replace(/\/uploads\/products\/uploads\/products\//g, '/uploads/products/');
    
      // Ensure leading slash
      if (!url.startsWith('/')) {
        url = '/' + url;
      }
    
      // Add uploads/products prefix if not present
      if (!url.startsWith('/uploads/products/')) {
        // Remove any leading slashes before adding the prefix
        url = '/uploads/products/' + url.replace(/^\/+/, '');
      }
    
      // Final cleanup: remove duplicate slashes
      url = url.replace(/\/{2,}/g, '/');
    
      console.log('üñºÔ∏è Cleaned image path:', url);
      return url;
    }
    
    // Branch code setup - will be handled by global-data-manager.js
    // Placeholder - initializeBranchInfo() will be called in DOMContentLoaded
    
          // Wait for Global Data Manager initialization
      const initGlobalManager = () => {
        if (window.globalInstallmentManager) {
    // Update global data manager with branch code
          window.globalInstallmentManager.updateStepData(1, { branchCode: BRANCH_CODE });
        } else {
          setTimeout(initGlobalManager, 100);
        }
      };
      initGlobalManager();


    // Toast function
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
    
      container.appendChild(toast);
    
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
    
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Utility functions
    function formatPrice(num) {
      return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getBranchCode() {
      return window.BRANCH_CODE || 'PATTANI';
    }

    // getImageUrl function already defined above
    
    // Notification system
    function setupNotifications() {
      // Handle notification elements only if they exist
      const notificationButton = document.getElementById('notificationButton');
      const notificationDropdown = document.getElementById('notificationDropdown');
    
      if (notificationButton && notificationDropdown) {
        notificationButton.addEventListener('click', function(e) {
          e.stopPropagation();
          notificationDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', function() {
          notificationDropdown.classList.add('hidden');
        });
      }

      // Handle quick actions - these elements exist
      const quickActionsBtn = document.getElementById('quickActionsBtn');
      const quickActionsDropdown = document.getElementById('quickActionsDropdown');
    
      if (quickActionsBtn && quickActionsDropdown) {
        quickActionsBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          quickActionsDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', function() {
          quickActionsDropdown.classList.add('hidden');
        });
      }
    }

    // Helper functions for data transformation
    function extractBrand(productName) {
      if (!productName) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå';
    
      const brandKeywords = {
        'iPhone': 'Apple',
        'iPad': 'Apple',
        'MacBook': 'Apple',
        'AirPods': 'Apple',
        'Samsung': 'Samsung',
        'Galaxy': 'Samsung',
        'Huawei': 'Huawei',
        'Xiaomi': 'Xiaomi',
        'Oppo': 'Oppo',
        'Vivo': 'Vivo',
        'Realme': 'Realme',
        'OnePlus': 'OnePlus'
      };
    
      for (const [keyword, brand] of Object.entries(brandKeywords)) {
        if (productName.toLowerCase().includes(keyword.toLowerCase())) {
          return brand;
        }
      }
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
      const firstWord = productName.split(' ')[0];
      return firstWord || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå';
    }
    
    function extractProductName(productName) {
      if (!productName) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    
      const productKeywords = [
        'iPhone', 'iPad', 'MacBook', 'AirPods', 'Apple Watch', 'iMac', 'Mac', 'iPod',
        'Galaxy', 'Samsung', 'Note',
        'Huawei', 'Honor', 'Nova', 'Mate', 'P Series',
        'Xiaomi', 'Redmi', 'Mi', 'POCO',
        'Oppo', 'Find', 'Reno', 'A Series',
        'Vivo', 'X Series', 'Y Series', 'V Series',
        'Realme', 'OnePlus'
      ];
    
      const name = productName.toLowerCase();
    
      for (const keyword of productKeywords) {
        if (name.includes(keyword.toLowerCase())) {
          return keyword;
        }
      }
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏£‡∏Å
      const words = productName.split(' ');
      if (words.length >= 2) {
        return words.slice(0, 2).join(' ');
      }
    
      return words[0] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    }
    
    function determineCategory(productName, productType) {
      if (productType === 'mobile') return '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠';
      if (productType === 'accessory') return '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°';
      if (productType === 'boxset') return '‡∏ä‡∏∏‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      if (productType === 'gift') return '‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°';
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ productType ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      if (!productName) return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    
      const name = productName.toLowerCase();
      if (name.includes('iphone') || name.includes('samsung') || name.includes('galaxy') ||
          name.includes('huawei') || name.includes('xiaomi') || name.includes('oppo') ||
          name.includes('vivo') || name.includes('phone') || name.includes('‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠')) {
        return '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠';
      }
    
      if (name.includes('ipad') || name.includes('tablet') || name.includes('‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï')) {
        return '‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï';
      }
    
      if (name.includes('macbook') || name.includes('laptop') || name.includes('‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå') ||
          name.includes('notebook')) {
        return '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå';
      }
    
      if (name.includes('airpods') || name.includes('headphone') || name.includes('earphone') ||
          name.includes('case') || name.includes('charger') || name.includes('‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à') ||
          name.includes('‡∏´‡∏π‡∏ü‡∏±‡∏á') || name.includes('‡πÄ‡∏Ñ‡∏™')) {
        return '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°';
      }
    
      return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
    }

    async function loadBranchInfo() {
      let js = null;
      let branchCode = null;
      try {
        branchCode = window.BRANCH_CODE;
        if (!branchCode) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å');
        }
        const token = localStorage.getItem('authToken') || '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        js = await res.json();
        if (res.ok && js.success) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} ‚Äî ${branch.address}`;
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
                          document.title = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
    
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown branch info ‡πÉ‡∏ô Receipt Menu
              const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
              if (dropdownBranchInfo) {
                dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branch.name}`;
              }
            return;
          }
        }
        throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`);
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        console.error('üîç Available branches:', js?.data?.map(b => ({ code: b.branch_code, name: b.name })) || 'No data');
        document.getElementById('branchInfo').textContent =
          `‡∏™‡∏≤‡∏Ç‡∏≤: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}"`;
    
        // Show available branches for debugging
        if (js?.data) {
          console.log('üìã Available branch codes:', js.data.map(b => b.branch_code));
          showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å`, 'error');
        }
      }
    }
    
    // Load branch installments - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å BranchStock ‡πÅ‡∏•‡∏∞ product-image
    async function loadBranchInstallments() {
      showLoading(true);
    
      try {
        const branchCode = getBranchCode();
        console.log(`üì¶ Loading installment products for branch: ${branchCode}`);
    
        // Check authentication first
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          // Redirect to login or show login modal
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
          return;
        }
    
        // Continue showing loading
    
        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏≤‡∏Å BranchStock API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô)
        const [branchStockRes, productImageRes, actualStockRes, boxsetRes] = await Promise.all([
          fetchWithRetry(`/api/branch-stock/taxType?branch_code=${branchCode}&purchaseType=installment&verified=true`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }),
          fetchWithRetry('/api/product-image', {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }),
          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å BranchStock API (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô)
          fetchWithRetry(`/api/branch-stock/taxType?branch_code=${branchCode}&purchaseType=installment&verified=true`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }),
          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Boxset ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
          fetchWithRetry(`/api/branch-stock/boxset/${branchCode}`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          })
        ]);
    
        // Handle authentication errors specifically
        if (branchStockRes.status === 401) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)', 'error');
          localStorage.removeItem('authToken');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
          return;
        }
    
        if (productImageRes.status === 401) {
          console.warn('Product image API authentication failed, using default images');
        }
    
        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        // Continue showing loading
    
        if (branchStockRes.ok) {
          const branchStockData = await branchStockRes.json();
          let productImageData = { status: 'error', data: [] };
          let actualStockData = { success: false, data: [] };
    
          // Get actual stock data for verification
          if (actualStockRes.ok) {
            try {
              actualStockData = await actualStockRes.json();
              console.log(`üìä Found ${actualStockData.data?.length || 0} verified stock items with installment support`);
            } catch (e) {
              console.warn('Failed to parse actual stock data:', e);
            }
          } else {
            console.warn(`‚ö†Ô∏è Actual stock API failed: ${actualStockRes.status}`);
          }
    
          // Try to get product images, but don't fail if it doesn't work
          if (productImageRes.ok) {
            try {
              productImageData = await productImageRes.json();
            } catch (e) {
              console.warn('Failed to parse product image data:', e);
            }
          }
    
          if (branchStockData.success && branchStockData.data && branchStockData.data.length > 0) {
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            const verifiedStockItems = new Set();
            const stockAvailabilityMap = new Map();
    
            if (actualStockData.success && actualStockData.data) {
              actualStockData.data.forEach(stockItem => {
                // Create unique identifier for stock verification
                const stockKey = stockItem.imei ?
                  `${stockItem.name}-${stockItem.imei}` :
                  `${stockItem.name}-${stockItem.brand || ''}-${stockItem.model || ''}`;
    
                verifiedStockItems.add(stockKey);
                stockAvailabilityMap.set(stockKey, {
                  stock_value: stockItem.stock_value || 0,
                  verified: true,
                  id: stockItem._id,
                  productId: stockItem.product_id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° Product ID ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                  imei: stockItem.imei,
                  price: stockItem.price
                });
    
                // Also add by name only for products without IMEI
                if (!stockItem.imei) {
                  verifiedStockItems.add(stockItem.name);
                  stockAvailabilityMap.set(stockItem.name, {
                    stock_value: stockItem.stock_value || 0,
                    verified: true,
                    id: stockItem._id,
                    productId: stockItem.product_id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° Product ID ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                    imei: null,
                    price: stockItem.price
                  });
                }
              });
            }
    
            console.log(`‚úÖ Verified ${verifiedStockItems.size} stock items available for installment`);
    
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image
            const productImageMap = new Map();
            if (productImageData.status === 'success' && productImageData.data) {
              productImageData.data.forEach(item => {
                productImageMap.set(item.name, item);
              });
            }
    
            // Continue showing loading
    
            // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Boxset ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
            let boxsetInstallments = [];
            if (boxsetRes.ok) {
              const boxsetData = await boxsetRes.json();
              if (boxsetData.success && boxsetData.data) {
                boxsetInstallments = boxsetData.data
                  .filter(boxset => {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Boxset ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
                    const supportsInstallment = boxset.saleTypes && boxset.saleTypes.includes('installment');
                    const hasStock = boxset.stock_value > 0;
                    const isActive = boxset.status === 'active';
    
                    console.log(`üéÅ Boxset "${boxset.name}":`, {
                      supportsInstallment,
                      hasStock,
                      isActive,
                      saleTypes: boxset.saleTypes
                    });
    
                    return supportsInstallment && hasStock && isActive;
                  })
                  .map(boxset => ({
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
                    _id: boxset._id,
                    name: boxset.name,
                    brand: 'Boxset',
                    model: 'Standard',
                    category: 'Boxset',
                    price: boxset.boxsetPrice,
                    cost: boxset.totalCost,
                    stock: boxset.stock_value,
                    stock_value: boxset.stock_value,
                    verified: true,
                    productType: 'boxset',
                    stockType: 'boxset',
                    purchaseType: boxset.saleTypes,
                    taxType: boxset.taxType || '‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏©‡∏µ',
                    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å installmentConfig
                    downAmount: boxset.installmentConfig?.downAmount || (boxset.boxsetPrice * 0.3),
                    downInstallment: boxset.installmentConfig?.downInstallment || 0,
                    downInstallmentCount: boxset.installmentConfig?.downInstallmentCount || 0,
                    creditThreshold: boxset.installmentConfig?.creditThreshold || 0,
                    payUseInstallment: boxset.installmentConfig?.payUseInstallment || 0,
                    payUseInstallmentCount: boxset.installmentConfig?.payUseInstallmentCount || 0,
                    pricePayOff: boxset.installmentConfig?.pricePayOff || boxset.boxsetPrice,
                    docFee: boxset.installmentConfig?.docFee || 0,
                    payoffDiscount: boxset.installmentConfig?.payoffDiscount || 0,
                    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                    boxsetProducts: boxset.products || [],
                    isBoxset: true,
                    image: boxset.image || null
                  }));
    
                console.log(`‚úÖ Processed ${boxsetInstallments.length} installment boxsets`);
              }
            }
    
            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
            branchInstallments = branchStockData.data
              .filter(item => {
                // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö stock_value ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                if (!item.stock_value || item.stock_value <= 0) {
                  console.log(`‚ùå No stock: ${item.name} (stock: ${item.stock_value})`);
                  return false;
                }
    
                // ‚úÖ 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡πà‡∏≠‡∏ô)
                const supportsInstallment = item.purchaseType &&
                  (Array.isArray(item.purchaseType) ?
                    item.purchaseType.includes('installment') :
                    item.purchaseType === 'installment');
    
                if (!supportsInstallment) {
                  console.log(`‚ùå Not installment: ${item.name} (type: ${JSON.stringify(item.purchaseType)})`);
                  return false;
                }
    
                console.log(`‚úÖ Installment product: ${item.name}`);
    
                // ‚úÖ 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ú‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
                const stockKey = item.imei ?
                  `${item.name}-${item.imei}` :
                  `${item.name}-${item.brand || ''}-${item.model || ''}`;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á stockKey ‡πÅ‡∏•‡∏∞ name
                const hasStockByKey = verifiedStockItems.has(stockKey);
                const hasStockByName = verifiedStockItems.has(item.name);
                const stockInfo = stockAvailabilityMap.get(stockKey) || stockAvailabilityMap.get(item.name);

                // ‚úÖ 4. ‡πÉ‡∏ä‡πâ stock_value ‡∏à‡∏≤‡∏Å API ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ verified stock ‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢)
                const primaryStock = item.stock_value || 0;
                const verifiedStock = stockInfo?.stock_value || 0;
                const finalStock = Math.max(primaryStock, verifiedStock); // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤

                if (finalStock <= 0) {
                  console.log(`‚ùå No final stock: ${item.name} (primary: ${primaryStock}, verified: ${verifiedStock})`);
                  return false;
                }
    
                // ‚úÖ 5. Optional IMEI check ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ IMEI (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                if (item.imei && item.stockType === 'imei') {
                  const imeiExists = Array.from(stockAvailabilityMap.keys()).some(key =>
                    key.includes(item.imei) || stockAvailabilityMap.get(key)?.imei === item.imei
                  );

                  if (!imeiExists) {
                    console.warn(`‚ö†Ô∏è IMEI not found in verified stock (allowing anyway): ${item.name} (IMEI: ${item.imei})`);
                    // ‡πÑ‡∏°‡πà return false - ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
                  }
                }

                console.log(`‚úÖ Accepted: ${item.name} (final stock: ${finalStock})`);
                return true;
              })
              .map(item => {
                // Get verified stock info
                const stockKey = item.imei ?
                  `${item.name}-${item.imei}` :
                  `${item.name}-${item.brand || ''}-${item.model || ''}`;
    
                const stockInfo = stockAvailabilityMap.get(stockKey) || stockAvailabilityMap.get(item.name);
    
                // ‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image collection
                const productImageItem = productImageMap.get(item.name);
                let imageUrl = '/uploads/Logo2.png'; // default image
    
                if (productImageItem && productImageItem.image) {
                  // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image - ‡πÉ‡∏ä‡πâ getImageUrl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ path
                  imageUrl = window.getImageUrl ? window.getImageUrl(productImageItem.image) : productImageItem.image;
                } else if (item.image) {
                  // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å BranchStock - ‡πÉ‡∏ä‡πâ getImageUrl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ path
                  imageUrl = window.getImageUrl ? window.getImageUrl(item.image) : item.image;
                }
    
                return {
                  id: item._id, // BranchStock ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                  branchStockId: item._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
                  productId: stockInfo?.productId || item.product_id || null, // ‡πÉ‡∏ä‡πâ Product ID ‡∏à‡∏≤‡∏Å stockInfo ‡∏´‡∏£‡∏∑‡∏≠ item.product_id
                  name: item.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
                  brand: extractBrand(item.name) || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
                  category: determineCategory(item.name, item.productType),
                  price: stockInfo?.price || item.price || 0,
                  stock: Math.max(stockInfo?.stock_value || 0, item.stock_value || 0),
                  barcode: item.imei || `${item.name}_${item._id}`,
                  imei: stockInfo?.imei || item.imei || null,
                  image: imageUrl,
                  hasPromotion: false,
                  isHidden: false,
                  stockType: item.stockType || 'imei',
                  verified: stockInfo?.verified || false,
                  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô
                  downAmount: item.downAmount || 0,
                  downInstallment: item.downInstallment || 0,
                  downInstallmentCount: item.downInstallmentCount || 0,
                  creditThreshold: item.creditThreshold || 0,
                  payUseInstallment: item.payUseInstallment || 0,
                  payUseInstallmentCount: item.payUseInstallmentCount || 0,
                  pricePayOff: item.pricePayOff || 0,
                  docFee: item.docFee || 0,
                  purchaseType: item.purchaseType || ['installment'],
                  productType: item.productType || 'mobile',
                  taxType: item.taxType || 'included',
                  taxRate: item.taxRate || 7
                };
              });
    
            // ‚úÖ ‡∏£‡∏ß‡∏° Boxset ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
            branchInstallments = [...branchInstallments, ...boxsetInstallments];
    
            // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å (‡∏£‡∏ß‡∏° Boxset)
            const installmentOnlyProducts = branchInstallments.filter(item =>
              item.purchaseType &&
              (Array.isArray(item.purchaseType) ?
                item.purchaseType.includes('installment') :
                item.purchaseType === 'installment') &&
              item.stock > 0 &&
              item.verified
            );
    
            console.log(`‚úÖ Final result: ${branchInstallments.length} total (including ${boxsetInstallments.length} boxsets), ${installmentOnlyProducts.length} verified installment products`);

            // ‚úÖ Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
            const filteredOutCount = branchInstallments.length - installmentOnlyProducts.length;
            console.log(`üìä Debug: ${filteredOutCount} products filtered out due to stock/verification checks`);

            // ‚úÖ ‡∏ú‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á: ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà verified ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ stock > 0
            if (installmentOnlyProducts.length === 0) {
              console.warn('‚ö†Ô∏è No verified products, falling back to all products with stock');
              const fallbackProducts = branchInstallments.filter(item =>
                item.purchaseType &&
                (Array.isArray(item.purchaseType) ?
                  item.purchaseType.includes('installment') :
                  item.purchaseType === 'installment') &&
                item.stock > 0
              );
              console.log(`üì¶ Fallback: Found ${fallbackProducts.length} products with stock (ignoring verification)`);

              if (fallbackProducts.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ');
              }
            }
    
            await loadLevel1();
            showToast(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ ${installmentOnlyProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          } else {
            throw new Error('No installment products found in stock');
          }
        } else {
          throw new Error(`API Error: ${branchStockRes.status} - ${branchStockRes.statusText}`);
        }
      } catch (error) {
        console.error('Error loading branch installments:', error);
    
        // Handle different types of errors
        if (error.message.includes('401') || error.message.includes('authentication')) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
          localStorage.removeItem('authToken');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
        }
    
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ó‡∏ô mockdata
        branchInstallments = [];
        await loadLevel1();
      } finally {
        showLoading(false);
      }
    }

    // Product hierarchy functions matching original
    async function loadLevel1() {
      // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
      const installmentProducts = branchInstallments.filter(item => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (!item.purchaseType ||
            !(Array.isArray(item.purchaseType) ?
              item.purchaseType.includes('installment') :
              item.purchaseType === 'installment')) {
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
        if (!item.stock || item.stock <= 0) {
          console.log(`‚ö†Ô∏è Level1 filter: No stock for ${item.name} (stock: ${item.stock})`);
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (item.verified === false) {
          console.log(`‚ö†Ô∏è Level1 filter: Not verified for ${item.name}`);
          return false;
        }
    
        return true;
      });
    
      // ‚úÖ ‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const categoriesWithStock = new Map();
      installmentProducts.forEach(item => {
        if (!categoriesWithStock.has(item.category)) {
          categoriesWithStock.set(item.category, {
            count: 0,
            stock: 0
          });
        }
        const cat = categoriesWithStock.get(item.category);
        cat.count++;
        cat.stock += item.stock;
      });
    
      const categories = Array.from(categoriesWithStock.keys()).filter(category => {
        const catInfo = categoriesWithStock.get(category);
        return catInfo.count > 0 && catInfo.stock > 0;
      });
    
      console.log(`‚úÖ Loading level 1: ${categories.length} categories with stock available`);
      console.log('Categories with stock:', Object.fromEntries(categoriesWithStock));
    
      renderLevel1(categories, categoriesWithStock);
      currentLevel = 1;
    }
    
    function renderLevel1(categories, categoriesWithStock) {
      const container = document.getElementById('level1Items');
      if (!container) return;
    
      container.innerHTML = '';
    
      // Show level1Container, hide others
      document.getElementById('level1Container').classList.remove('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (categories.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 dark:text-gray-500">
              <i class="bi bi-credit-card-2-front text-6xl mb-4"></i>
              <h3 class="text-xl font-semibold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
              <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</p>
              <div class="text-xs text-gray-400 mt-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</div>
              <button onclick="loadBranchInstallments()" class="btn btn-primary mt-4">
                <i class="bi bi-arrow-clockwise mr-2"></i>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>
        `;
        return;
      }
    
      categories.forEach(category => {
        // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
        const categoryInfo = categoriesWithStock.get(category);
        const totalItems = categoryInfo.count;
        const totalStock = categoryInfo.stock;
    
        // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥)
        const categoryItems = branchInstallments.filter(item =>
          item.category === category &&
          item.purchaseType &&
          (Array.isArray(item.purchaseType) ?
            item.purchaseType.includes('installment') :
            item.purchaseType === 'installment') &&
          item.stock > 0 &&
          item.verified !== false
        );
        const availableItems = categoryItems.length;
    
        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 20; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    
        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">üö®</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">‚ö†Ô∏è</div>';
        }
    
        const categoryCard = document.createElement('div');
        categoryCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';
    
        // Add stock alert classes
        if (isOutOfStock) {
          categoryCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          categoryCard.className += ' low-stock-warning';
        }
    
        categoryCard.innerHTML = `
          <div class="card-body p-4">
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${category}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">üö® ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>' : isLowStock ? '<span class="text-xs warning-text">‚ö†Ô∏è ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≥</span>' : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getCategoryIcon(category)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-success">${totalItems} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
              ${availableItems === 0 ? '<div class="badge badge-error ml-2">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</div>' : ''}
            </div>
          </div>
        `;
    
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (availableItems > 0) {
          categoryCard.addEventListener('click', () => loadLevel2(category));
        } else {
          categoryCard.classList.add('cursor-not-allowed', 'opacity-50');
          categoryCard.addEventListener('click', () => {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ', 'warning');
          });
        }
    
        container.appendChild(categoryCard);
      });
    }
    
    function getCategoryIcon(category) {
      const icons = {
        '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠': 'phone',
        '‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï': 'tablet',
        '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': 'laptop',
        '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'headphones',
        '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'box'
      };
      return icons[category] || 'box';
    }

    function loadLevel2(category) {
              // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
        const categoryItems = branchInstallments.filter(item => {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
          if (item.category !== category) {
            return false;
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
          if (!item.purchaseType ||
              !(Array.isArray(item.purchaseType) ?
                item.purchaseType.includes('installment') :
                item.purchaseType === 'installment')) {
            return false;
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
          if (!item.stock || item.stock <= 0) {
            console.log(`‚ö†Ô∏è Level2 filter: No stock for ${item.name} in ${category} (stock: ${item.stock})`);
            return false;
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          if (item.verified === false) {
            console.log(`‚ö†Ô∏è Level2 filter: Not verified for ${item.name} in ${category}`);
            return false;
          }
    
          return true;
        });
    
      const productNames = [...new Set(categoryItems.map(item => extractProductName(item.name)))];
    
      console.log(`üîç Loading level 2 for ${category}: found ${categoryItems.length} items, ${productNames.length} unique products with stock`);
    
      if (productNames.length === 0) {
        console.warn(`‚ö†Ô∏è No products with stock available for category: ${category}`);
      }
    
      renderLevel2(productNames, category);
      currentLevel = 2;
      currentParentKey = category;
    }
    
    function renderLevel2(productNames, category) {
      const container = document.getElementById('level2Items');
      const title = document.getElementById('level2Title');
    
      if (!container || !title) return;
    
      container.innerHTML = '';
              title.innerHTML = `<i class="bi bi-menu-button-wide"></i> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î ${category}`;
    
      // Show level2Container, hide others
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    
      productNames.forEach(productName => {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
        const productItems = branchInstallments.filter(item =>
          item.category === category &&
          extractProductName(item.name) === productName &&
          item.purchaseType &&
          item.purchaseType.includes('installment')
        );
    
        // Calculate total stock for this product name
        const totalStock = productItems.reduce((sum, item) => sum + item.stock, 0);
        const availableItems = productItems.filter(item => item.stock > 0).length;
    
        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 5;
    
        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">üö®</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">‚ö†Ô∏è</div>';
        }
    
        const productCard = document.createElement('div');
        productCard.className = 'card product-card cursor-pointer hover:shadow-lg transition-shadow';
    
        // Add stock alert classes
        if (isOutOfStock) {
          productCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          productCard.className += ' low-stock-warning';
        }
    
        productCard.innerHTML = `
          <div class="card-body p-4">
            ${statusIcon}
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title text-lg font-semibold ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${productName}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">${availableItems}/${productItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</p>
                ${isOutOfStock ? '<span class="text-xs emergency-text">üö® ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : isLowStock ? '<span class="text-xs warning-text">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>' : ''}
                ${productItems.length > 0 && productItems[0].downAmount > 0 ? `
                  <div class="text-xs text-blue-600 dark:text-blue-400 mt-1">
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ø${formatPrice(productItems[0].downAmount)}
                  </div>
                ` : ''}
              </div>
              <div class="text-3xl">
                <i class="bi bi-${getProductIcon(productName)}"></i>
              </div>
            </div>
            <div class="mt-4">
              <div class="badge badge-success">${productItems.length} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
              <div class="badge ${isOutOfStock ? 'emergency-badge' : isLowStock ? 'warning-badge' : 'badge-info'} ml-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${totalStock}</div>
            </div>
          </div>
        `;
    
        productCard.addEventListener('click', async () => await loadLevel3(category, productName));
        container.appendChild(productCard);
      });
    }
    
    function getBrandIcon(brand) {
      const icons = {
        'Apple': 'apple',
        'Samsung': 'phone',
        'Huawei': 'phone',
        'Xiaomi': 'phone',
        'Oppo': 'phone',
        'Vivo': 'phone'
      };
      return icons[brand] || 'box';
    }
    
    function getProductIcon(productName) {
      const icons = {
        'iPhone': 'phone',
        'iPad': 'tablet',
        'MacBook': 'laptop',
        'Mac': 'laptop',
        'iMac': 'pc-display',
        'AirPods': 'headphones',
        'Apple Watch': 'smartwatch',
        'Galaxy': 'phone',
        'Samsung': 'phone',
        'Note': 'phone',
        'Huawei': 'phone',
        'Honor': 'phone',
        'Nova': 'phone',
        'Mate': 'phone',
        'P Series': 'phone',
        'Xiaomi': 'phone',
        'Redmi': 'phone',
        'Mi': 'phone',
        'POCO': 'phone',
        'Oppo': 'phone',
        'Find': 'phone',
        'Reno': 'phone',
        'A Series': 'phone',
        'Vivo': 'phone',
        'X Series': 'phone',
        'Y Series': 'phone',
        'V Series': 'phone',
        'Realme': 'phone',
        'OnePlus': 'phone'
      };
      return icons[productName] || 'phone';
    }

    async function loadLevel3(category, productName) {
      // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
      const items = branchInstallments.filter(item => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (item.category !== category || extractProductName(item.name) !== productName) {
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
        if (!item.purchaseType ||
            !(Array.isArray(item.purchaseType) ?
              item.purchaseType.includes('installment') :
              item.purchaseType === 'installment')) {
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
        if (!item.stock || item.stock <= 0) {
          console.log(`‚ö†Ô∏è Level3 filter: No stock for ${item.name} in ${category}/${productName} (stock: ${item.stock})`);
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        if (item.verified === false) {
          console.log(`‚ö†Ô∏è Level3 filter: Not verified for ${item.name} in ${category}/${productName}`);
          return false;
        }
    
        return true;
      });
    
      console.log(`üîç Loading level 3 for ${category}/${productName}: found ${items.length} items with stock`);
    
      if (items.length === 0) {
        console.warn(`‚ö†Ô∏è No stock available for ${category}/${productName}`);
      }
    
      await renderLevel3(items);
      currentLevel = 3;
      currentLevel3Items = items;
    }
    
    async function renderLevel3(items) {
      const container = document.getElementById('level3Items');
      const title = document.getElementById('level3Title');
    
      if (!container || !title) return;
    
      container.innerHTML = '';
      title.innerHTML = `<i class="bi bi-phone"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô ${currentParentKey}`;
    
      // Show level3Container, hide others
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
    
      // Group items by product name - ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
      const groupedItems = items.reduce((groups, item) => {
        if (hiddenProductIds.has(item.id)) return groups;
    
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡πà‡∏≠‡∏ô
        if (!item.purchaseType || !item.purchaseType.includes('installment')) return groups;
    
        const key = item.name.trim();
        if (!groups[key]) {
          groups[key] = [];
        }
        groups[key].push(item);
        return groups;
      }, {});
    
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
      if (Object.keys(groupedItems).length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="text-gray-400 dark:text-gray-500">
              <i class="bi bi-cart-x text-4xl mb-4"></i>
              <h3 class="text-lg font-semibold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</h3>
              <p class="text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</p>
            </div>
          </div>
        `;
        return;
      }
    
      // Render grouped products
      for (const [productName, productItems] of Object.entries(groupedItems)) {
        // Calculate totals for this product group
        const totalStock = productItems.reduce((sum, item) => sum + item.stock, 0);
        const imeiList = productItems
          .map(item => item.imei)
          .filter(imei => imei && imei.trim() !== '')
          .join(', ');
    
        // Use first item for common data
        const sampleItem = productItems[0];
    
        // Check for promotions using promotion manager
        let hasPromotion = false;
        let promotionDetails = [];
    
        if (window.promotionManager && window.promotionManager.isInitialized) {
          try {
            hasPromotion = await window.promotionManager.checkPromotionsForProduct(sampleItem._id);
            if (hasPromotion) {
              // Get promotion details for tooltip/display
              promotionDetails = await window.promotionManager.getPromotionsForProduct(sampleItem._id);
              console.log(`üéÅ Found ${promotionDetails.length} promotions for product:`, sampleItem.name);
            }
          } catch (error) {
            console.warn('Error checking promotion for product:', sampleItem._id, error);
            hasPromotion = productItems.some(item => item.hasPromotion); // fallback
          }
        } else {
          hasPromotion = productItems.some(item => item.hasPromotion); // fallback
        }
    
        // Get image URL before using in template literal
        const imageUrl = getImageUrl(sampleItem.image);
    
        const stockStatus = getStockStatus(totalStock);
    
        // Stock Alert Logic
        const isOutOfStock = totalStock <= 0;
        const isLowStock = totalStock > 0 && totalStock <= 5;
    
        // Status Icon
        let statusIcon = '';
        if (isOutOfStock) {
          statusIcon = '<div class="status-icon emergency-icon">üö®</div>';
        } else if (isLowStock) {
          statusIcon = '<div class="status-icon warning-icon">‚ö†Ô∏è</div>';
        }
    
        const productCard = document.createElement('div');
        productCard.className = `card product-card ${hasPromotion ? 'has-promotion' : ''}`;
    
        // Add stock alert classes
        if (isOutOfStock) {
          productCard.className += ' out-of-stock-emergency';
        } else if (isLowStock) {
          productCard.className += ' low-stock-warning';
        }
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô)
        let installmentDetails = '';
    
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô) - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (sampleItem.downAmount > 0 || sampleItem.downInstallment > 0 || sampleItem.downInstallmentCount > 0) {
          installmentDetails += `
            <div class="space-y-2">
              <span class="text-sm text-gray-600 block">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô):</span>
              <div class="grid grid-cols-3 gap-2 bg-gray-50 dark:bg-gray-700 p-3 rounded">
                <div class="text-center">
                  <div class="text-xs text-gray-500 mb-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</div>
                  <div class="font-semibold text-green-600">‡∏ø${formatPrice(sampleItem.downAmount || 0)}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-500 mb-1">‡∏á‡∏ß‡∏î</div>
                  <div class="font-semibold text-blue-600">${sampleItem.downInstallmentCount || 0}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-gray-500 mb-1">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                  <div class="font-semibold text-purple-600">‡∏ø${formatPrice(sampleItem.downInstallment || 0)}</div>
                </div>
              </div>
            </div>
          `;
        }
    
        // Create promotion tooltip content
        let promotionTooltip = '';
        if (hasPromotion && promotionDetails.length > 0) {
          const promoNames = promotionDetails.map(p => p.name).join(', ');
          const promoCount = promotionDetails.length;
          promotionTooltip = `title="üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô: ${promoNames} (${promoCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)" data-promotion-count="${promoCount}"`;
        }
    
        productCard.innerHTML = `
          <div class="card-body p-4">
            ${hasPromotion ? `<div class="promo-fire-icon" ${promotionTooltip}>üî•<span class="promo-badge">${promotionDetails.length || 1}</span></div>` : ''}
            ${statusIcon}
            <div class="product-img-container mb-3">
              <img src="${imageUrl}" alt="${productName}" 
                   class="w-full h-32 object-cover rounded-lg"
                   onerror="this.src='/uploads/Logo2.png'">
            </div>
            <h3 class="card-title text-sm font-semibold mb-2 ${isOutOfStock ? 'emergency-text' : isLowStock ? 'warning-text' : ''}">${productName}</h3>
            ${hasPromotion && promotionDetails.length > 0 ? `
              <div class="promotion-preview text-xs text-orange-600 mb-2">
                <i class="bi bi-gift"></i> ${promotionDetails[0].name}
                ${promotionDetails.length > 1 ? ` +${promotionDetails.length - 1} ‡∏≠‡∏∑‡πà‡∏ô‡πÜ` : ''}
              </div>
            ` : ''}
            
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
            <div class="space-y-1 mb-3">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå:</span>
                <span class="text-sm font-medium">${sampleItem.brand}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                <span class="badge ${stockStatus.class}">${totalStock} ${sampleItem.stockType === 'imei' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' : '‡∏ä‡∏¥‡πâ‡∏ô'}</span>
              </div>
            </div>

            <!-- Boxset Products Display (if it's a boxset) -->
            ${sampleItem.productType === 'boxset' && sampleItem.boxsetProducts && sampleItem.boxsetProducts.length > 0 ? `
              <div class="boxset-products mt-3 mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <div class="flex items-center gap-1 mb-2">
                  <span class="text-sm font-semibold text-blue-700 dark:text-blue-300">üéÅ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Boxset:</span>
                  <span class="badge badge-info badge-sm">${sampleItem.boxsetProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="boxset-products-list text-xs space-y-1">
                  ${sampleItem.boxsetProducts.map((product, idx) => {
                    const productName = product.name || product.productName || product.itemName || product.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                    const productQty = product.quantity || product.qty || product.amount || 1;

                    return `
                      <div class="flex items-center justify-between py-1 px-2 bg-white dark:bg-gray-800 rounded border border-blue-100 dark:border-blue-700">
                        <div class="flex-1">
                          <span class="font-medium text-gray-800 dark:text-gray-200">${productName}</span>
                          ${product.brand ? `<span class="text-gray-500 ml-1">(${product.brand})</span>` : ''}
                        </div>
                        <span class="text-blue-600 dark:text-blue-400 font-medium">${productQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô -->
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
              <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2 flex items-center">
                <i class="bi bi-credit-card mr-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
              </h4>
              <div class="space-y-1">
                ${installmentDetails}
              </div>
            </div>
            
            ${imeiList ? `
              <div class="mt-2 mb-3">
                <span class="text-sm text-gray-600 block mb-1">IMEI:</span>
                <div class="text-xs font-mono text-gray-500 bg-gray-50 dark:bg-gray-700 p-2 rounded max-h-16 overflow-y-auto">
                  ${imeiList}
                </div>
              </div>
            ` : ''}
            
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ -->
            <div class="flex flex-wrap gap-1 mb-3">
              ${sampleItem.purchaseType.map(type => {
                const typeMap = {
                  'cash': { text: '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏î', class: 'badge-primary' },
                  'installment': { text: '‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞', class: 'badge-success' }
                };
                const typeInfo = typeMap[type] || { text: type, class: 'badge-secondary' };
                return `<span class="badge ${typeInfo.class} text-xs">${typeInfo.text}</span>`;
              }).join('')}
            </div>
            
            <div class="mt-4">
              <div class="text-center text-sm text-gray-500 bg-green-50 dark:bg-green-900/20 p-2 rounded border border-green-200 dark:border-green-800">
                <i class="bi bi-upc-scan"></i>
                ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå IMEI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
              </div>
            </div>
          </div>
        `;

        container.appendChild(productCard);
      }
    }

    function getStockStatus(stock) {
      if (stock <= 0) return { class: 'badge-error', text: '‡∏´‡∏°‡∏î' };
      if (stock <= 5) return { class: 'badge-warning', text: '‡∏ô‡πâ‡∏≠‡∏¢' };
      return { class: 'badge-success', text: '‡∏û‡∏£‡πâ‡∏≠‡∏°' };
    }

    // Navigation functions
    function backToLevel1() {
      loadLevel1();
    }

    function backToLevel2() {
      if (currentParentKey) {
        loadLevel2(currentParentKey);
      } else {
        loadLevel1();
      }
    }

    // Add to cart function
    async function addToCart(itemId) {
      const item = branchInstallments.find(p => p.id === itemId);
      if (!item) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô', 'error');
        return;
      }
    
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
      if (item.stock <= 0) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î', 'error');
        return;
      }
    
      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Real-time
      showLoading(true);
    
      try {
        const hasStock = await verifyProductStock(item.id, item.name, item.imei);
    
        if (!hasStock) {
          showLoading(false);
          showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${item.name}' ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô`, 'error');
    
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          await loadBranchInstallments();
          return;
        }
    
        showLoading(false);
      } catch (error) {
        showLoading(false);
        console.error('Error verifying stock:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
        return;
      }

      // For IMEI products, check if specific IMEI already in cart
      if (item.imei) {
        const existingIMEI = cartItems.find(cartItem =>
          cartItem.imei === item.imei ||
          cartItem.barcode === item.imei
        );
    
        if (existingIMEI) {
          showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${item.name}' (IMEI: ${item.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
          return;
        }
      }

      // Check if same product already in cart (for non-IMEI products)
      const existingIndex = cartItems.findIndex(cartItem =>
        cartItem.id === itemId && !cartItem.imei && !item.imei
      );
    
      if (existingIndex > -1 && !item.imei) {
        // Update quantity for non-IMEI products only
        cartItems[existingIndex].quantity += 1;
        cartItems[existingIndex].totalPrice = cartItems[existingIndex].quantity * item.price;
      } else {
        // Add new item
        const cartItem = {
          id: item.id,
          branchStockId: item.branchStockId, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
          productId: item.productId, // Product ID ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
          name: item.name,
          brand: item.brand,
          price: item.price,
          quantity: 1,
          totalPrice: item.price,
          image: item.image,
          barcode: item.barcode,
          maxStock: item.stock,
          // Installment specific data
          downAmount: item.downAmount || 0,
          downInstallment: item.downInstallment || 0,
          downInstallmentCount: item.downInstallmentCount || 0,
          pricePayOff: item.pricePayOff || 0,
          purchaseType: item.purchaseType || ['installment'],
          stockType: item.stockType || 'imei'
        };
    
        // Add IMEI if available
        if (item.imei) {
          cartItem.imei = item.imei;
        }
    
        cartItems.push(cartItem);
      }

      // Update displays
      renderCart();
      updateCartCount();
      updateStep1Button();
    
      // Save to localStorage with multiple keys for step2 compatibility
      // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ alias ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
      const cartDataStr = JSON.stringify(cartItems);
      localStorage.setItem('cartItems', cartDataStr);
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á pointer ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ duplicate data
      localStorage.setItem('cartData_pointer', 'cartItems');
      localStorage.setItem('step1_selectedProducts_pointer', 'cartItems');
    
      // Sync with Global Data Manager
      const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
      if (window.globalInstallmentManager) {
        window.globalInstallmentManager.updateStepData(1, {
        cartItems: cartItems,
        selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
        totalAmount: totalAmount
        });
      }
    
      console.log('üì¶ Saved cart data to localStorage:', {
        cartItems: cartItems.length + ' items',
        totalAmount: totalAmount,
        keys: ['cartItems', 'cartData', 'step1_selectedProducts']
      });
    
      showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${item.name}' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
      // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å
      item.stockVerified = true;
      item.verificationTime = new Date().toISOString();
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Real-time
    async function verifyProductStock(productId, productName, imei = null) {
      try {
        const branchCode = getBranchCode();
        const authToken = localStorage.getItem('authToken');
    
        if (!authToken) {
          console.warn('No auth token for stock verification');
          return false;
        }
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏≤‡∏Å API
        const response = await fetchWithRetry(`/api/branch-stock/taxType?branch_code=${branchCode}&verified=true&purchaseType=installment`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
    
        if (!response.ok) {
          console.warn('Stock verification API failed');
          return false;
        }
    
        const stockData = await response.json();
    
        if (!stockData.success || !stockData.data) {
          console.warn('No stock data returned');
          return false;
        }
    
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å
        const foundStock = stockData.data.find(item => {
          if (imei && item.imei) {
            return item.imei === imei && item.name === productName;
          }
          return item._id === productId || (item.name === productName && item.stock_value > 0);
        });
    
        const hasStock = foundStock && foundStock.stock_value > 0;
    
        if (!hasStock) {
          console.log(`‚ùå Real-time verification failed: ${productName} ${imei ? `(IMEI: ${imei})` : `(ID: ${productId})`}`);
        } else {
          console.log(`‚úÖ Real-time verification passed: ${productName} (stock: ${foundStock.stock_value})`);
        }
    
        return hasStock;
    
      } catch (error) {
        console.error('Error verifying stock:', error);
        return false;
      }
    }
    
    // Enhanced search functions - ‡πÉ‡∏ä‡πâ API ‡∏à‡∏≤‡∏Å BranchStock ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image
    async function searchItems() {
      const query = document.getElementById('productSearchQuery').value.trim();
      if (!query) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'warning');
        return;
      }

      showLoading(true);
    
      try {
        const branchCode = getBranchCode();
        const authToken = localStorage.getItem('authToken');
    
        if (!authToken) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          return;
        }
    
        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å BranchStock search ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞ product-image
        const [searchRes, productImageRes, stockVerificationRes] = await Promise.all([
          fetchWithRetry(`/api/branch-stock/search?branch_code=${branchCode}&q=${encodeURIComponent(query)}&type=all&purchaseType=installment`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }),
          fetchWithRetry('/api/product-image', {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          }),
          // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          fetchWithRetry(`/api/branch-stock/taxType?branch_code=${branchCode}&purchaseType=installment&verified=true`, {
            headers: {
              'Authorization': `Bearer ${authToken}`,
              'Content-Type': 'application/json'
            }
          })
        ]);
    
        if (searchRes.ok) {
          const searchData = await searchRes.json();
          let productImageData = { status: 'error', data: [] };
          let stockVerificationData = { success: false, data: [] };
    
          // Get product images (optional)
          if (productImageRes.ok) {
            try {
              productImageData = await productImageRes.json();
            } catch (e) {
              console.warn('Failed to parse product image data:', e);
            }
          }
    
          // Get stock verification data (optional but important)
          if (stockVerificationRes.ok) {
            try {
              stockVerificationData = await stockVerificationRes.json();
              console.log(`‚úÖ Stock verification: ${stockVerificationData.data?.length || 0} verified items`);
            } catch (e) {
              console.warn('Failed to parse stock verification data:', e);
            }
          }
    
          if (searchData.success && searchData.data) {
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
            const verifiedStockIds = new Set();
            const verifiedStockNames = new Set();
    
            if (stockVerificationData.success && stockVerificationData.data) {
              stockVerificationData.data.forEach(item => {
                verifiedStockIds.add(item._id);
                verifiedStockNames.add(item.name);
                if (item.imei) {
                  verifiedStockIds.add(`${item.name}-${item.imei}`);
                }
              });
            }
    
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image
            const productImageMap = new Map();
            if (productImageData.status === 'success' && productImageData.data) {
              productImageData.data.forEach(item => {
                productImageMap.set(item.name, item);
              });
            }
    
            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
            const searchResults = searchData.data
              .filter(item => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å
                if (!item.stock_value || item.stock_value <= 0) {
                  return false;
                }
    
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
                const hasVerification = verifiedStockIds.has(item._id) ||
                                      verifiedStockNames.has(item.name) ||
                                      (item.imei && verifiedStockIds.has(`${item.name}-${item.imei}`));
    
                if (!hasVerification) {
                  console.log(`‚ö†Ô∏è Search result not verified: ${item.name}`);
                  return false;
                }
    
                return true;
              })
              .map(item => {
                // ‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image collection
                const productImageItem = productImageMap.get(item.name);
                let imageUrl = '/uploads/Logo2.png'; // default image
    
                if (productImageItem && productImageItem.image) {
                  // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image - ‡πÉ‡∏ä‡πâ getImageUrl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ path
                  imageUrl = window.getImageUrl ? window.getImageUrl(productImageItem.image) : productImageItem.image;
                } else if (item.image) {
                  // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å BranchStock - ‡πÉ‡∏ä‡πâ getImageUrl ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ path
                  imageUrl = window.getImageUrl ? window.getImageUrl(item.image) : item.image;
                }
    
                return {
                  id: item._id,
                  branchStockId: item._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
                  productId: item.productId || null, // Product ID ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                  name: item.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
                  brand: extractBrand(item.name) || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
                  category: determineCategory(item.name, item.productType),
                  price: item.price || 0,
                  stock: item.stock_value || 0,
                  barcode: item.imei || `${item.name}_${item._id}`,
                  imei: item.imei || null,
                  image: imageUrl,
                  hasPromotion: false,
                  isHidden: false,
                  stockType: item.stockType || 'imei',
                  downAmount: item.downAmount || 0,
                  downInstallment: item.downInstallment || 0,
                  downInstallmentCount: item.downInstallmentCount || 0,
                  matchType: item.matchType || 'search',
                  matchScore: item.matchScore || 50
                };
              });
    
            renderSearchResults(searchResults);
    
            if (searchResults.length === 0) {
              showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'info');
            } else {
              showToast(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô ${searchResults.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            }
          } else {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'info');
            renderSearchResults([]);
          }
        } else {
          throw new Error(`API Error: ${searchRes.status}`);
        }
      } catch (error) {
        console.error('Search error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + error.message, 'error');
    
        // Fallback to local search if API fails
        const localResults = searchInLocalData(query);
        renderSearchResults(localResults);
      } finally {
        showLoading(false);
      }
    }
    
    function searchInLocalData(query) {
      const searchTerm = query.toLowerCase();
      return branchInstallments.filter(item =>
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
        item.purchaseType &&
        item.purchaseType.includes('installment') &&
        (item.name.toLowerCase().includes(searchTerm) ||
         item.brand.toLowerCase().includes(searchTerm) ||
         item.barcode.includes(searchTerm) ||
         item.category.toLowerCase().includes(searchTerm))
      );
    }
    
    function renderSearchResults(results) {
      const container = document.getElementById('imeiResultList');
      if (!container) return;
    
      container.innerHTML = '';
    
      // Show search results container
      document.getElementById('imeiResultContainer').classList.remove('hidden');
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    
      results.forEach(item => {
        const productCard = document.createElement('div');
        productCard.className = `card product-card ${item.hasPromotion ? 'has-promotion' : ''}`;
    
        const stockStatus = getStockStatus(item.stock);
        const priceDisplay = formatPrice(item.price);
        const imageUrl = getImageUrl(item.image);
    
        productCard.innerHTML = `
          <div class="card-body p-4">
            ${item.hasPromotion ? '<div class="promo-fire-icon">üî•</div>' : ''}
            <div class="product-img-container mb-3">
              <img src="${imageUrl}" alt="${item.name}" 
                   class="w-full h-32 object-cover rounded-lg"
                   onerror="this.src='/uploads/Logo2.png'">
            </div>
            <h3 class="card-title text-sm font-semibold mb-2">${item.name}</h3>
            <div class="space-y-1">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå:</span>
                <span class="text-sm font-medium">${item.brand}</span>
              </div>
              ${item.downAmount > 0 || item.downInstallment > 0 || item.downInstallmentCount > 0 ? `
                <div class="space-y-2">
                  <span class="text-sm text-gray-600 block">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô):</span>
                  <div class="grid grid-cols-3 gap-1 bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs">
                    <div class="text-center">
                      <div class="text-gray-500 mb-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</div>
                      <div class="font-semibold text-green-600">‡∏ø${formatPrice(item.downAmount || 0)}</div>
                    </div>
                    <div class="text-center">
                      <div class="text-gray-500 mb-1">‡∏á‡∏ß‡∏î</div>
                      <div class="font-semibold text-blue-600">${item.downInstallmentCount || 0}</div>
                    </div>
                    <div class="text-center">
                      <div class="text-gray-500 mb-1">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                      <div class="font-semibold text-purple-600">‡∏ø${formatPrice(item.downInstallment || 0)}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                <span class="badge ${stockStatus.class}">${item.stock} ${item.stockType === 'imei' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' : '‡∏ä‡∏¥‡πâ‡∏ô'}</span>
              </div>
              ${item.imei ? `
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">IMEI:</span>
                  <span class="text-xs font-mono text-gray-500">${item.imei}</span>
                </div>
              ` : ''}
              ${item.matchType ? `
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö:</span>
                  <span class="text-xs badge badge-info">${item.matchType === 'imei' ? 'IMEI' : '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</span>
                </div>
              ` : ''}
            </div>
            <div class="mt-4">
              <div class="text-center text-sm text-gray-500 bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                <i class="bi bi-upc-scan"></i>
                ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå IMEI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
              </div>
            </div>
          </div>
        `;
    
        container.appendChild(productCard);
      });
    }

    function resetSearch() {
      document.getElementById('productSearchQuery').value = '';
      document.getElementById('imeiResultContainer').classList.add('hidden');
      loadLevel1();
    }

    // ======================= BARCODE INPUT PROCESSING =======================
    async function processBarcodeInput() {
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
      const barcodeProductInfo = document.getElementById('barcodeProductInfo');
    
      if (!barcodeInput) return;
    
      const barcode = barcodeInput.value.trim();
    
      if (!barcode) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà IMEI ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô', 'warning');
        barcodeInput.focus();
        return;
      }
    
      // Show loading state
      let loaderId = null;
      try {
        showLoading(true);
    
        // Validate IMEI format (basic validation)
        if (barcode.length < 10) {
          showToast('IMEI ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'warning');
          barcodeInput.focus();
          return;
        }
    
        // Check if installment products data is available
        if (!branchInstallments || branchInstallments.length === 0) {
          showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning');
          return;
        }
    
        // Find product by IMEI first (local search)
        let product = branchInstallments.find(p =>
          p.imei === barcode ||
          p.barcode === barcode ||
          p.name.toLowerCase().includes(barcode.toLowerCase())
        );
    
        // If not found locally, search via API
        if (!product) {
          await findAndAddToCartByBarcode(barcode);
          return;
        }
    
        // Check if product is already in cart
        const inCart = cartItems.some(item =>
          item.imei === product.imei ||
          (item.id === product.id && product.imei)
        );
    
        if (inCart) {
          showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}' (IMEI: ${product.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
          barcodeResults.classList.add('hidden');
          barcodeInput.focus();
          barcodeInput.select();
          return;
        }
    
        // Check stock
        if (product.stock <= 0) {
          showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}' ‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å`, 'error');
          barcodeResults.classList.add('hidden');
          barcodeInput.focus();
          return;
        }
    
        // Show product found message
        barcodeProductInfo.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium">${product.name}</div>
              ${product.downAmount > 0 || product.downInstallment > 0 || product.downInstallmentCount > 0 ? `
                <div class="mt-2">
                  <div class="text-xs text-gray-600 mb-1">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô):</div>
                  <div class="grid grid-cols-3 gap-1 text-xs">
                    <div>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ‡∏ø${formatPrice(product.downAmount || 0)}</div>
                    <div>‡∏á‡∏ß‡∏î: ${product.downInstallmentCount || 0}</div>
                    <div>‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${formatPrice(product.downInstallment || 0)}</div>
                  </div>
                </div>
              ` : ''}
              ${product.imei ? `<div class="text-xs">IMEI: ${product.imei}</div>` : ''}
              ${product.brand ? `<div class="text-xs">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${product.brand}</div>` : ''}
            </div>
            <div class="text-right">
              <div class="badge badge-success">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
              <div class="text-xs mt-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${product.stock}</div>
            </div>
          </div>
        `;
        barcodeResults.classList.remove('hidden');
    
        // Add to cart
        await addToCart(product.id);
    
        // Show success message
        showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${product.name}' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
        // Clear input after successful scan
        barcodeInput.value = '';
    
        // Auto-hide results after 3 seconds
        setTimeout(() => {
          barcodeResults.classList.add('hidden');
        }, 3000);
    
        // Focus back to barcode input for next scan
        setTimeout(() => {
          barcodeInput.focus();
        }, 100);
    
      } catch (error) {
        console.error('‚ùå Barcode processing error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• IMEI', 'error');
        barcodeResults.classList.add('hidden');
        barcodeInput.focus();
      } finally {
        showLoading(false);
      }
    }

    // Clear barcode input
    function clearBarcodeInput() {
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
    
      if (barcodeInput) {
        barcodeInput.value = '';
        barcodeInput.focus();
      }
    
      if (barcodeResults) {
        barcodeResults.classList.add('hidden');
      }
    }
    
    async function findAndAddToCartByBarcode(barcode) {
      showLoading(true);
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
      const barcodeProductInfo = document.getElementById('barcodeProductInfo');
    
      try {
        const branchCode = getBranchCode();
    
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
          return;
        }
    
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• product-image ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const productImageRes = await fetch('/api/product-image', {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
    
        let productImageMap = new Map();
        if (productImageRes.ok) {
          const productImageData = await productImageRes.json();
          if (productImageData.status === 'success' && productImageData.data) {
            productImageData.data.forEach(item => {
              productImageMap.set(item.name, item);
            });
          }
        }
    
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ IMEI ‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ IMEI)
        let response = await fetchWithRetry(`/api/branch-stock/search?branch_code=${branchCode}&q=${encodeURIComponent(barcode)}&type=imei&purchaseType=installment`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
    
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data && data.data.length > 0) {
            const foundItem = data.data[0]; // ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏£‡∏Å
    
            // Check if already in cart
            const inCart = cartItems.some(item =>
              item.imei === foundItem.imei ||
              (foundItem.imei && item.barcode === foundItem.imei)
            );
    
            if (inCart) {
              showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${foundItem.name}' (IMEI: ${foundItem.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
              if (barcodeResults) barcodeResults.classList.add('hidden');
              if (barcodeInput) {
                barcodeInput.focus();
                barcodeInput.select();
              }
              return;
            }
    
            if (foundItem.stock_value > 0) {
              // ‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image collection
              const productImageItem = productImageMap.get(foundItem.name);
              let imageUrl = '/uploads/Logo2.png'; // default image
    
              if (productImageItem && productImageItem.image) {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å product-image
                imageUrl = productImageItem.image.startsWith('/uploads/')
                  ? productImageItem.image
                  : `/uploads/${productImageItem.image.replace(/^.*uploads[\\/]/, '')}`;
              } else if (foundItem.image) {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å BranchStock ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô product-image
                imageUrl = foundItem.image.startsWith('/uploads/')
                  ? foundItem.image
                  : `/uploads/products/${foundItem.image}`;
              }
    
              // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
              const product = {
                id: foundItem._id,
                branchStockId: foundItem._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
                productId: foundItem.productId || foundItem._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° productId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reference
                name: foundItem.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
                brand: extractBrand(foundItem.name) || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
                category: determineCategory(foundItem.name, foundItem.productType),
                price: foundItem.price || 0,
                stock: foundItem.stock_value || 0,
                barcode: foundItem.imei || `${foundItem.name}_${foundItem._id}`,
                imei: foundItem.imei || null,
                image: imageUrl,
                hasPromotion: false,
                isHidden: false,
                stockType: foundItem.stockType || 'imei',
                downAmount: foundItem.downAmount || 0,
                downInstallment: foundItem.downInstallment || 0,
                downInstallmentCount: foundItem.downInstallmentCount || 0
              };
    
              // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô branchInstallments ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
              if (!branchInstallments.find(item => item.id === product.id)) {
                branchInstallments.push(product);
              }
    
              // Show product found message
              if (barcodeProductInfo) {
                barcodeProductInfo.innerHTML = `
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium">${product.name}</div>
                      ${product.downAmount > 0 || product.downInstallment > 0 || product.downInstallmentCount > 0 ? `
                        <div class="mt-2">
                          <div class="text-xs text-gray-600 mb-1">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô):</div>
                          <div class="grid grid-cols-3 gap-1 text-xs">
                            <div>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ‡∏ø${formatPrice(product.downAmount || 0)}</div>
                            <div>‡∏á‡∏ß‡∏î: ${product.downInstallmentCount || 0}</div>
                            <div>‡∏ú‡πà‡∏≠‡∏ô: ‡∏ø${formatPrice(product.downInstallment || 0)}</div>
                          </div>
                        </div>
                      ` : ''}
                      ${product.imei ? `<div class="text-xs">IMEI: ${product.imei}</div>` : ''}
                      ${product.brand ? `<div class="text-xs">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${product.brand}</div>` : ''}
                    </div>
                    <div class="text-right">
                      <div class="badge badge-success">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
                      <div class="text-xs mt-1">API: ${barcode}</div>
                    </div>
                  </div>
                `;
                barcodeResults.classList.remove('hidden');
              }
    
              await addToCart(product.id);
              if (barcodeInput) barcodeInput.value = '';
              showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${product.name}' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
    
              // Auto-hide results after 3 seconds
              setTimeout(() => {
                if (barcodeResults) barcodeResults.classList.add('hidden');
              }, 3000);
    
              // Focus back to input
              setTimeout(() => {
                if (barcodeInput) barcodeInput.focus();
              }, 100);
    
            } else {
              showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å', 'error');
              if (barcodeResults) barcodeResults.classList.add('hidden');
            }
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏î‡πâ‡∏ß‡∏¢ IMEI ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            response = await fetchWithRetry(`/api/branch-stock/search?branch_code=${branchCode}&q=${encodeURIComponent(barcode)}&type=name&purchaseType=installment`, {
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              const nameData = await response.json();
              if (nameData.success && nameData.data && nameData.data.length > 0) {
                showToast(`‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô ${nameData.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤`, 'info');
                // Render search results instead of auto-adding
                const searchResults = nameData.data.map(item => {
                  const productImageItem = productImageMap.get(item.name);
                  let imageUrl = '/uploads/Logo2.png';
    
                  if (productImageItem && productImageItem.image) {
                    imageUrl = productImageItem.image.startsWith('/uploads/')
                      ? productImageItem.image
                      : `/uploads/${productImageItem.image.replace(/^.*uploads[\\/]/, '')}`;
                  } else if (item.image) {
                    imageUrl = item.image.startsWith('/uploads/')
                      ? item.image
                      : `/uploads/products/${item.image}`;
                  }
    
                  return {
                    id: item._id,
                    branchStockId: item._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
                    productId: item.productId || item._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° productId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reference
                    name: item.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
                    brand: extractBrand(item.name) || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
                    category: determineCategory(item.name, item.productType),
                    price: item.price || 0,
                    stock: item.stock_value || 0,
                    barcode: item.imei || `${item.name}_${item._id}`,
                    imei: item.imei || null,
                    image: imageUrl,
                    downAmount: item.downAmount || 0,
                    downInstallment: item.downInstallment || 0,
                    downInstallmentCount: item.downInstallmentCount || 0,
                    matchType: 'name'
                  };
                });
                renderSearchResults(searchResults);
              } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å IMEI ‡∏ô‡∏µ‡πâ', 'error');
              }
            } else {
              showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å IMEI ‡∏ô‡∏µ‡πâ', 'error');
            }
    
            if (barcodeResults) barcodeResults.classList.add('hidden');
          }
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
          if (barcodeResults) barcodeResults.classList.add('hidden');
        }
      } catch (error) {
        console.error('Barcode search error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + error.message, 'error');
        if (barcodeResults) barcodeResults.classList.add('hidden');
      } finally {
        showLoading(false);
        // Focus back to input
        if (barcodeInput) {
          barcodeInput.focus();
        }
      }
    }

    // Cart display functions
    function renderCart() {
      const cartContainer = document.querySelector('.cart-summary');
      if (!cartContainer) return;

      if (cartItems.length === 0) {
        cartContainer.innerHTML = `
          <div class="text-center py-8">
            <i class="bi bi-cart text-4xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏á</p>
            <p class="text-xs text-gray-400 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
          </div>
        `;
        return;
      }

      let totalAmount = 0;
      cartContainer.innerHTML = '';
    
      cartItems.forEach((item, index) => {
        totalAmount += item.totalPrice;
    
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item bg-white dark:bg-gray-800 rounded-lg p-4 border';
    
        const imageUrl = getImageUrl(item.image);
    
        cartItem.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${imageUrl}" alt="${item.name}"
                 class="w-16 h-16 object-cover rounded-lg"
                 onerror="this.src='/uploads/Logo2.png'">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${item.name}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400">${item.brand}</p>
              ${item.imei ? `<p class="text-xs text-blue-600 dark:text-blue-400 font-mono">IMEI: ${item.imei}</p>` : ''}
              <div class="flex gap-2 mt-1">
                <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">‡∏ú‡πà‡∏≠‡∏ô</span>
              </div>
              ${item.downAmount > 0 || item.downInstallment > 0 || item.downInstallmentCount > 0 ? `
                <div class="mt-2 bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs">
                  <div class="text-gray-600 dark:text-gray-400 mb-1">‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥/‡∏á‡∏ß‡∏î/‡∏ú‡πà‡∏≠‡∏ô)</div>
                  <div class="grid grid-cols-3 gap-1 text-center">
                    <div>
                      <div class="text-gray-500">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</div>
                      <div class="font-medium text-green-600">‡∏ø${formatPrice(item.downAmount || 0)}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">‡∏á‡∏ß‡∏î</div>
                      <div class="font-medium text-blue-600">${item.downInstallmentCount || 0}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                      <div class="font-medium text-purple-600">‡∏ø${formatPrice(item.downInstallment || 0)}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
              <p class="text-xs text-gray-500 mt-1">‡∏ø${formatPrice(item.price)} √ó ${item.quantity}</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-primary">‡∏ø${formatPrice(item.totalPrice)}</p>
              <div class="flex items-center space-x-2 mt-1">
                ${!item.imei ? `
                  <button onclick="updateQuantity(${index}, -1)" 
                          class="btn btn-xs btn-circle" ${item.quantity <= 1 ? 'disabled' : ''}>
                    <i class="bi bi-dash"></i>
                  </button>
                  <span class="text-sm">${item.quantity}</span>
                  <button onclick="updateQuantity(${index}, 1)" 
                          class="btn btn-xs btn-circle" ${item.quantity >= item.maxStock ? 'disabled' : ''}>
                    <i class="bi bi-plus"></i>
                  </button>
                ` : `
                  <span class="text-xs text-gray-500">IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ</span>
                `}
                <button onclick="removeFromCart(${index})" 
                        class="btn btn-xs btn-circle btn-error">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
    
        cartContainer.appendChild(cartItem);
      });
    
      // Add total display
      const totalDiv = document.createElement('div');
      totalDiv.className = 'border-t pt-3 mt-3';
      totalDiv.innerHTML = `
        <div class="flex justify-between items-center font-bold">
          <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
          <span class="text-primary">‡∏ø${formatPrice(totalAmount)}</span>
        </div>
      `;
      cartContainer.appendChild(totalDiv);
    }
    
    function updateQuantity(index, change) {
      const item = cartItems[index];
    
      // IMEI products cannot change quantity
      if (item.imei) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ (1 IMEI = 1 ‡∏ä‡∏¥‡πâ‡∏ô)', 'warning');
        return;
      }
    
      const newQuantity = item.quantity + change;
    
      if (newQuantity <= 0) {
        removeFromCart(index);
        return;
      }
    
      if (newQuantity > item.maxStock) {
        showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å', 'warning');
        return;
      }
    
      item.quantity = newQuantity;
      item.totalPrice = item.quantity * item.price;
    
      renderCart();
      updateCartCount();
      updateStep1Button();
    
      // Save to localStorage with multiple keys for step2 compatibility
      // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ alias ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
      const cartDataStr = JSON.stringify(cartItems);
      localStorage.setItem('cartItems', cartDataStr);
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á pointer ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ duplicate data
      localStorage.setItem('cartData_pointer', 'cartItems');
      localStorage.setItem('step1_selectedProducts_pointer', 'cartItems');
    
      // Sync with Global Data Manager
      const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
      if (window.globalInstallmentManager) {
        window.globalInstallmentManager.updateStepData(1, {
        cartItems: cartItems,
        selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
        totalAmount: totalAmount
      });
      }
    }
    
    function clearCart() {
      console.log('üßπ Clearing all cart items...');
      cartItems = [];
    
      // Clear from localStorage
      localStorage.removeItem('cartItems');
      localStorage.removeItem('cartData');
      localStorage.removeItem('step1_selectedProducts');
      localStorage.removeItem('cartData_pointer');
      localStorage.removeItem('step1_selectedProducts_pointer');
      localStorage.removeItem('installmentData_step1');
    
      // Clear from globalInstallmentManager safely
      if (window.globalInstallmentManager) {
        try {
          if (typeof window.globalInstallmentManager.updateStepData === 'function') {
            window.globalInstallmentManager.updateStepData(1, {
              cartItems: [],
              selectedProducts: [],
              totalAmount: 0
            });
          }
        } catch (e) {
          console.log('Note: globalInstallmentManager clear skipped');
        }
      }
    
      // Update UI
      renderCart();
      updateCartCount();
      updateStep1Button();
    
      showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }
    
    function updateCartCount() {
      const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cartCount').textContent = count;
    }

    function updateStep1Button() {
      const btn = document.getElementById('btnStep1ToStep2');
      if (btn) {
        btn.disabled = cartItems.length === 0;
        if (cartItems.length === 0) {
          btn.innerHTML = '<i class="bi bi-x-circle mr-2"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô';
        } else {
          btn.innerHTML = '<i class="bi bi-arrow-right mr-2"></i> ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πà‡∏≠‡∏ô)';
        }
      }
    }
    
    function removeFromCart(index) {
      const item = cartItems[index];
      cartItems.splice(index, 1);
    
      renderCart();
      updateCartCount();
      updateStep1Button();
    
      // Save to localStorage with multiple keys for step2 compatibility
      // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ alias ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
      const cartDataStr = JSON.stringify(cartItems);
      localStorage.setItem('cartItems', cartDataStr);
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á pointer ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ duplicate data
      localStorage.setItem('cartData_pointer', 'cartItems');
      localStorage.setItem('step1_selectedProducts_pointer', 'cartItems');
    
      // Sync with Global Data Manager
      const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
      if (window.globalInstallmentManager) {
        window.globalInstallmentManager.updateStepData(1, {
        cartItems: cartItems,
        selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
        totalAmount: totalAmount
      });
      }
    
      showToast(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${item.name}' ${item.imei ? `(IMEI: ${item.imei})` : ''} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'info');
    }

    // Navigation
    function goToStep2() {
      // Validate using Global Data Manager
      if (window.globalInstallmentManager) {
        const errors = window.globalInstallmentManager.getValidationErrors(1);
      if (errors.length > 0) {
        showToast(errors[0].replace('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô'), 'warning');
        return;
      }
    
      // Complete step 1
        window.globalInstallmentManager.completeStep(1);
      }
    
      // Save cart data with multiple keys for step2 compatibility
      // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ alias ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
      const cartDataStr = JSON.stringify(cartItems);
      localStorage.setItem('cartItems', cartDataStr);
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á pointer ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ duplicate data
      localStorage.setItem('cartData_pointer', 'cartItems');
      localStorage.setItem('step1_selectedProducts_pointer', 'cartItems');
    
      console.log('üöÄ Proceeding to Step 2 with cart data:', {
        cartItems: cartItems.length + ' items',
        totalAmount: cartItems.reduce((sum, item) => sum + item.totalPrice, 0),
        savedKeys: ['cartItems', 'cartData', 'step1_selectedProducts']
      });
    
      // Show loading before navigation
      showLoading(true);

      // Include branch code in URL when navigating to step2
      const branchCode = window.BRANCH_CODE || getBranchCode();
      const branchName = document.getElementById('branchInfo')?.textContent || '';

      // Navigate after showing loading animation
      setTimeout(() => {
        window.location.href = `/step2?branch=${encodeURIComponent(branchCode)}&name=${encodeURIComponent(branchName)}`;
      }, 500);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Step 1 initialized');

      // Show main loading at start
      showLoading(true);
    
      // Helper function to get branch code from URL
      function getBranchCodeFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const branchFromURL = urlParams.get('branch');

        if (branchFromURL && branchFromURL !== 'undefined' && branchFromURL !== 'null') {
          return branchFromURL;
        }

        // Try to get from global variable or localStorage as fallback
        return window.BRANCH_CODE || localStorage.getItem('activeBranch') || null;
      }

      // Initialize branch info first
      if (window.globalInstallmentManager) {
        window.globalInstallmentManager.initializeBranchInfo();
      }

      // Initialize promotion manager
      if (window.promotionManager) {
        const branchCode = getBranchCodeFromURL() || 'PTN01';
        await window.promotionManager.initialize(branchCode);
        console.log('‚úÖ Promotion manager initialized for step1');
      }
    
      // Initialize theme
      const savedTheme = localStorage.getItem('darkMode');
      if (savedTheme === 'true') {
        document.documentElement.classList.add('dark');
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    
      // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ step1 (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
      console.log('üßπ Auto-clearing cart data on page load...');
      cartItems = [];
    
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å localStorage
      localStorage.removeItem('cartItems');
      localStorage.removeItem('cartData');
      localStorage.removeItem('step1_selectedProducts');
      localStorage.removeItem('cartData_pointer');
      localStorage.removeItem('step1_selectedProducts_pointer');
      localStorage.removeItem('installmentData_step1');
    
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å globalInstallmentManager (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
      if (window.globalInstallmentManager) {
        try {
          // ‡πÉ‡∏ä‡πâ updateStepData ‡πÅ‡∏ó‡∏ô clearStepData
          if (typeof window.globalInstallmentManager.updateStepData === 'function') {
            window.globalInstallmentManager.updateStepData(1, {
              cartItems: [],
              selectedProducts: [],
              totalAmount: 0
            });
          }
        } catch (e) {
          console.log('Note: globalInstallmentManager clear skipped', e);
        }
      }
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      setTimeout(() => {
        renderCart();
        updateCartCount();
        updateStep1Button();
      }, 100);
    
      // Setup event listeners
      setupNotifications();
      document.getElementById('btnStep1ToStep2').addEventListener('click', goToStep2);
      document.getElementById('btnProductSearch').addEventListener('click', searchItems);
      document.getElementById('btnProductReset').addEventListener('click', resetSearch);
      document.getElementById('btnAddBarcode').addEventListener('click', processBarcodeInput);
      document.getElementById('btnClearBarcode').addEventListener('click', clearBarcodeInput);

      // Customer search event handlers
      document.getElementById('btnSearchCustomer').addEventListener('click', async function() {
        const searchTerm = document.getElementById('customerSearch').value.trim();
        if (searchTerm) {
          if (window.InstallmentAPI && window.InstallmentAPI.searchExistingCustomer) {
            await window.InstallmentAPI.searchExistingCustomer(searchTerm);
          } else {
            console.warn('InstallmentAPI.searchExistingCustomer not available');
          }
        }
      });

      // Customer search on Enter key
      document.getElementById('customerSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('btnSearchCustomer').click();
        }
      });
      document.getElementById('btnBackToLevel1').addEventListener('click', backToLevel1);
      document.getElementById('btnBackToLevel2').addEventListener('click', backToLevel2);
    
      // No button needed - auto clear only
    
      // Setup search input
      document.getElementById('productSearchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchItems();
        }
      });
    
      // Setup barcode input
      document.getElementById('barcodeInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          processBarcodeInput();
        }
      });
    
      // Auto-focus barcode input on page load
      setTimeout(() => {
        document.getElementById('barcodeInput').focus();
      }, 1000);
    
      // Load branch info
      await loadBranchInfo();
    
      // Update connection status
      document.getElementById('connectionStatus').textContent = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
      document.getElementById('connectionStatus').classList.remove('offline');
      document.getElementById('firebaseStatus').classList.remove('bg-gray-400');
      document.getElementById('firebaseStatus').classList.add('bg-green-400');
      document.getElementById('socketStatus').classList.remove('bg-gray-400');
      document.getElementById('socketStatus').classList.add('bg-green-400');
    
      // Setup step data change listener
      document.addEventListener('installmentStepChanged', function(event) {
        const { stepNumber, stepData } = event.detail;
        if (window.globalInstallmentManager) {
          updateStepProgress(window.globalInstallmentManager.data);
          updateNavigationButtons(window.globalInstallmentManager.data);
        }
      });
    
      // Load products
      await loadBranchInstallments();
    
      // Update initial step status if Global Manager is ready
      if (window.globalInstallmentManager) {
        updateStepProgress(window.globalInstallmentManager.data);
        updateNavigationButtons(window.globalInstallmentManager.data);
      }
    
      showToast('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');

      // Hide main loading when initialization is complete
      setTimeout(() => {
        showLoading(false);
      }, 1000);
    });

    // Step Progress and Navigation Functions
    function updateStepProgress(stepData) {
      // Update stepper progress
      const steppers = document.querySelectorAll('.step');
      steppers.forEach((stepper, index) => {
        const stepNumber = index + 1;
        const stepKey = `step${stepNumber}`;
    
        if (stepData && stepData[stepKey] && stepData[stepKey].completed) {
          stepper.classList.add('completed');
        } else {
          stepper.classList.remove('completed');
        }
    
        if (stepNumber === 1) {
          stepper.classList.add('active');
        } else {
          stepper.classList.remove('active');
        }
      });
    
      // Update progress indicator if available
      if (window.globalInstallmentManager) {
        const percentage = window.globalInstallmentManager.getProgressPercentage();
      const progressBar = document.querySelector('.progress-bar');
      if (progressBar) {
        progressBar.style.width = percentage + '%';
        }
      }
    }
    
    function updateNavigationButtons(stepData) {
      const nextBtn = document.getElementById('btnStep1ToStep2');
      if (nextBtn && window.globalInstallmentManager) {
        const canProceed = window.globalInstallmentManager.validateStep(1);
        nextBtn.disabled = !canProceed;
        nextBtn.classList.toggle('btn-disabled', !canProceed);
    
        // Update button text based on validation
        const errors = window.globalInstallmentManager.getValidationErrors(1);
        if (errors.length > 0) {
          nextBtn.title = errors[0];
        } else {
          nextBtn.title = '‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        }
      }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î
    async function refreshStockIfNeeded() {
      try {
        const outOfStockItems = branchInstallments.filter(item =>
          item.stock <= 0 || item.verified === false
        );
    
        if (outOfStockItems.length > 0) {
          console.log(`üîÑ Found ${outOfStockItems.length} items out of stock, refreshing...`);
    
          showLoading(true);
          await loadBranchInstallments();
          showLoading(false);
    
          showToast(`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'info');
        }
      } catch (error) {
        console.error('Error refreshing stock:', error);
      }
    }
    
    // ‚úÖ Auto-refresh ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ loading)
    setInterval(async () => {
      if (branchInstallments.length > 0) {
        const hasOutOfStock = branchInstallments.some(item =>
          item.stock <= 0 || item.verified === false
        );
    
        if (hasOutOfStock) {
          console.log('üîÑ Auto-refreshing stock due to out-of-stock items');
          await refreshStockIfNeeded();
        }
      }
    }, 30000); // ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    
    // Make functions globally available
    window.showToast = showToast;
    window.removeFromCart = removeFromCart;
    window.updateQuantity = updateQuantity;
    window.addToCart = addToCart;
    window.backToLevel1 = backToLevel1;
    window.backToLevel2 = backToLevel2;
    window.processBarcodeInput = processBarcodeInput;
    window.clearBarcodeInput = clearBarcodeInput;
    window.refreshStockIfNeeded = refreshStockIfNeeded;
    window.verifyProductStock = verifyProductStock;
    window.findAndAddToCartByBarcode = findAndAddToCartByBarcode;
    
    // Signature functionality removed - signatures are handled in step2.html

// Old loading system code removed - using new Lottie loading
  </script>

</body>
</html> 