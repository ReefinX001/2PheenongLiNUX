<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani - Step 4: ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />

  <!-- Include Shared CSS Files -->
  <!-- Disabled: Using inline CSS for stepper like step1 -->
  <!-- <link rel="stylesheet" href="/views/pattani/installment/shared/css/stepper-common.css?v=4.0"> -->
  <link rel="stylesheet" href="/views/pattani/installment/shared/css/common-styles.css">

  <!-- Include Shared JavaScript Files -->
  <script src="/views/pattani/installment/shared/js/common-utils.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Enhanced Tailwind CSS production warning suppression
    const originalWarn = console.warn;
    const originalLog = console.log;
    const originalError = console.error;

    // Suppress console.warn messages
    console.warn = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalWarn.apply(console, args);
    };

    // Suppress console.log messages for Tailwind warnings
    console.log = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalLog.apply(console, args);
    };

    // Suppress console.error messages for Tailwind warnings
    console.error = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalError.apply(console, args);
    };

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>
  
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Installment System Styles - Complete Inline -->
  <style>
    /* ========== INSTALLMENT SYSTEM SPECIFIC STYLES ========== */
    /* ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani */

    /* ========== PERFORMANCE OPTIMIZATIONS ========== */
    .stepper,
    .step-icon,
    .loading-spinner,
    .card,
    .toast,
    .modal,
    .dropdown {
      will-change: transform, opacity;
    }

    .card,
    .product-card,
    .modal-box,
    .step-content {
      contain: layout style paint;
    }

    /* ========== STEPPER STYLES ========== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #94a3b8;
      z-index: 2;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .step.active .step-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .step.completed .step-icon {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Combined step-text and step-label styles */

    /* ========== CARD STYLES ========== */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    /* Dark mode card */
    .dark .card {
      background: #1f2937;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .dark .card-title {
      color: #f1f5f9;
    }

    /* ========== BUTTON STYLES ========== */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 0.625rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    /* ========== TOAST STYLES ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    /* Dark mode toast */
    .dark .toast {
      background: #374151;
      color: #f3f4f6;
    }

  </style>

  <!-- Stepper Styles - Consistent with other steps -->
  <style>
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .dark .stepper::before {
      background: #4b5563;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: #4361ee;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      z-index: 2;
      position: relative;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .step.active .step-icon {
      background: #4361ee;
      color: white;
      border-color: #4361ee;
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
    }

    .step.completed .step-icon {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .step.completed .step-icon::before {
      content: '‚úì';
      font-size: 18px;
      font-weight: bold;
    }

    .step-text {
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      text-align: center;
      transition: color 0.3s ease;
      line-height: 1.2;
    }

    .step.active .step-text {
      color: #4361ee;
      font-weight: 600;
    }

    .step.completed .step-text {
      color: #10b981;
      font-weight: 600;
    }

    .dark .stepper {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border-color: #374151 !important;
    }

    .dark .step-icon {
      background: #374151 !important;
      color: #9ca3af !important;
    }

    .dark .step.active .step-icon {
      background: #2563eb !important;
      color: white !important;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2) !important;
    }

    .dark .step.completed .step-icon {
      background: #059669 !important;
      color: white !important;
    }

    .dark .step-text {
      color: #9ca3af !important;
    }

    .dark .step.active .step-text {
      color: #60a5fa !important;
    }

    .dark .step.completed .step-text {
      color: #34d399 !important;
    }
  </style>
  
  <!-- Step 4 Specific Styles -->
  <style>
    /* Clean White Summary Cards */
    .summary-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      transition: all 0.3s ease;
    }

    .summary-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border-color: #e2e8f0;
    }
    
    .summary-card.completed {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-color: #10b981;
    }

    .summary-card.processing {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
      animation: pulse 2s infinite;
    }
    
    .summary-card.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: #ef4444;
    }

    /* Card title consistency */
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
    }

    .dark .card-title {
      color: #f3f4f6;
    }
    
    /* Document Status */
    .document-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .document-status.pending {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .document-status.generating {
      background: #fef3c7;
      color: #92400e;
      animation: pulse 1s infinite;
    }
    
    .document-status.ready {
      background: #d1fae5;
      color: #065f46;
    }
    
    .document-status.error {
      background: #fecaca;
      color: #991b1b;
    }
    
    /* Clean Payment Summary */
    .payment-summary {
      background: white;
      color: #1f2937;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      border: 1px solid #f1f5f9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .payment-amount {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 1rem 0;
      color: #3b82f6;
    }
    
    /* Action Buttons - Using DaisyUI for consistency */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      min-height: 3rem;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      border-color: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
      border-color: #9ca3af;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .btn-success:hover {
      background: #059669;
      border-color: #059669;
    }

    .btn-outline {
      background: transparent;
      color: #374151;
      border-color: #d1d5db;
    }

    .btn-outline:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-block {
      width: 100%;
    }

    /* Dark mode button styles */
    .dark .btn-secondary {
      background: #374151;
      color: #d1d5db;
      border-color: #4b5563;
    }

    .dark .btn-secondary:hover {
      background: #4b5563;
      border-color: #6b7280;
    }

    .dark .btn-outline {
      color: #d1d5db;
      border-color: #4b5563;
    }

    .dark .btn-outline:hover {
      background: #374151;
      border-color: #6b7280;
    }
    
    /* Progress Indicator */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      position: relative;
    }
    
    .progress-step::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      right: -40%;
      height: 2px;
      background: #e5e7eb;
      z-index: 1;
    }

    .progress-step:last-child::after {
      display: none;
    }
    
    .progress-step.completed::after {
      background: #10b981;
    }
    
    .progress-step.processing::after {
      background: #f59e0b;
    }
    
    .progress-step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .progress-step.completed .progress-step-icon {
      background: #10b981;
      color: white;
    }

    .progress-step.processing .progress-step-icon {
      background: #f59e0b;
      color: white;
      animation: pulse 1s infinite;
    }
    
    .progress-step.error .progress-step-icon {
      background: #ef4444;
      color: white;
    }
    
    /* Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 5 steps */
    @media (max-width: 768px) {
      .progress-steps {
        flex-wrap: wrap;
        gap: 1rem;
      }
      
      .progress-step {
        flex-basis: calc(50% - 0.5rem);
        margin-bottom: 1rem;
      }
      
      .progress-step::after {
        display: none;
      }
      
      .progress-step:nth-child(3) {
        flex-basis: 100%;
      }
    }
    
    /* Enhanced Dark Mode Support - Consistent with other steps */
    .dark body {
      background-color: #111827;
      color: #f3f4f6;
    }

    .dark #mainContent {
      background-color: #111827;
    }

    .dark .summary-card {
      background: #1f2937;
      border-color: #374151;
      color: #f3f4f6;
    }

    .dark .summary-card.completed {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      border-color: #059669;
    }
    
    .dark .summary-card.processing {
      background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
      border-color: #d97706;
    }
    
    .dark .summary-card.error {
      background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
      border-color: #ef4444;
    }

    /* Payment summary dark mode */
    .dark .payment-summary {
      background: linear-gradient(135deg, #10b981 0%, #047857 100%);
      border-color: #22c55e;
    }

    /* Document status dark mode */
    .dark .document-status.pending {
      background: #374151;
      color: #9ca3af;
    }
    
    .dark .document-status.generating {
      background: #92400e;
      color: #fbbf24;
    }
    
    .dark .document-status.ready {
      background: #065f46;
      color: #34d399;
    }
    
    .dark .document-status.error {
      background: #991b1b;
      color: #f87171;
    }

    /* Progress step dark mode */
    .dark .progress-step-icon {
      background: #374151;
      color: #9ca3af;
    }
    
    .dark .progress-step.completed .progress-step-icon {
      background: #059669;
      color: white;
    }

    .dark .progress-step.processing .progress-step-icon {
      background: #d97706;
      color: white;
    }

    /* Modal dark mode */
    .dark .modal-box {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
    }

    .dark .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    /* Input and form elements dark mode */
    .dark .input,
    .dark .select,
    .dark .textarea {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    .dark .input:focus,
    .dark .select:focus,
    .dark .textarea:focus {
      border-color: #2563eb !important;
      box-shadow: 0 0 0 1px #2563eb !important;
    }

    /* Text colors dark mode */
    .dark .text-gray-600 {
      color: #9ca3af !important;
    }

    .dark .text-gray-700 {
      color: #d1d5db !important;
    }

    .dark .text-gray-800 {
      color: #e5e7eb !important;
    }

    .dark .text-gray-900 {
      color: #f3f4f6 !important;
    }

    /* Border colors dark mode */
    .dark .border-gray-200 {
      border-color: #374151 !important;
    }

    .dark .border-gray-300 {
      border-color: #4b5563 !important;
    }

    /* Background colors dark mode */
    .dark .bg-white {
      background-color: #1f2937 !important;
    }

    .dark .bg-gray-50 {
      background-color: #374151 !important;
    }

    .dark .bg-blue-50 {
      background-color: #1e3a8a !important;
    }

    .dark .bg-green-50 {
      background-color: #14532d !important;
    }

    .dark .bg-yellow-50 {
      background-color: #92400e !important;
    }

    .dark .bg-red-50 {
      background-color: #991b1b !important;
    }

    /* Container dark mode */
    .dark .container-fluid {
      background-color: transparent !important;
    }

    /* Main content dark mode */
    .dark main {
      background-color: #111827 !important;
      color: #f3f4f6 !important;
    }

    /* Responsive Layout with Sidebar - Consistent with other steps */
    #mainContent {
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Container for padding consistency */
    .container-fluid {
      width: 100%;
      max-width: 100%;
      padding: 1rem;
    }

    /* Mobile responsive sidebar */
    @media (max-width: 768px) {
      #mainContent {
        margin-left: 0 !important;
      }
      
      .payment-amount {
        font-size: 2rem;
      }

      .summary-card {
      padding: 1rem;
      }
      
      .progress-steps {
        flex-direction: column;
        gap: 1rem;
      }
      
      .progress-step::after {
        display: none;
      }
    }

    #mainContent.ml-0 {
      margin-left: 0 !important;
    }

    #mainContent.ml-64 {
      margin-left: 16rem !important;
    }

    /* Enhanced sidebar */
    .sidebar-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    /* Stepper margin consistency */
    .stepper {
      margin-bottom: 2rem;
    }

    /* Card consistency */
    .card {
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      background: white;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .dark .card {
      background: #1f2937;
      border-color: #374151;
    }

    /* ========== LOADING OVERLAY STYLES ========== */
    @keyframes pulse {
      0% { opacity: .75;}
      50%{ opacity: 1;}
      100%{ opacity: .75;}
    }
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <!-- Animate.css for loading animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie.js for animated loading icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-64">
    <!-- Header with Clean Design -->
    <header class="p-6 bg-white border-b border-gray-100 flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-4">
        <!-- Company Logo -->
        <img src="/uploads/Logo2.png" alt="2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢" class="h-12 w-auto">
        <div class="border-l border-gray-200 pl-4">
          <h1 class="text-xl font-light text-gray-800" id="pageTitle">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
          <p class="text-sm text-gray-500" id="branchInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>
        </div>
      </div>
      
      <!-- Progress Indicator -->
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
          ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span class="font-semibold text-blue-600">4</span> ‡∏à‡∏≤‡∏Å 4
            </div>
        <div class="w-16 h-16">
          <svg class="w-full h-full" viewBox="0 0 36 36">
            <path class="progress-ring progress-ring-background" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#f1f5f9" stroke-width="2" fill="transparent"/>
            <path class="progress-ring progress-ring-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#3b82f6" stroke-width="2" stroke-dasharray="100, 100" fill="transparent"/>
          </svg>
          <div class="text-center mt-1 text-xs text-gray-400">100%</div>
          </div>
        </div>
    </header>

    <!-- Content with Clean White Theme -->
    <main class="flex-1 overflow-y-auto bg-white">
      <div class="container-fluid p-6">
        <!-- Include Shared Stepper Template -->
        <!-- Stepper Navigation -->
        <div class="stepper" role="navigation" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
            <div class="step completed" data-step="1" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
              <div class="step-icon" aria-hidden="true">‚úì</div>
              <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            </div>
            <div class="step completed" data-step="2" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
              <div class="step-icon" aria-hidden="true">‚úì</div>
              <div class="step-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            </div>
            <div class="step completed" data-step="3" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô">
              <div class="step-icon" aria-hidden="true">‚úì</div>
              <div class="step-text">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô</div>
            </div>
            <div class="step active" data-step="4" role="tab" aria-selected="true" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå">
              <div class="step-icon" aria-hidden="true">4</div>
              <div class="step-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</div>
            </div>
          </div>
        
        <script>
          // Simple navigation function
          function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= 4) {
              window.location.href = `/step${stepNumber}`;
            }
          }
        </script>

        <!-- Main Content -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          
          <!-- Left Column: Summary Information -->
          <div class="xl:col-span-2 space-y-6">
            
            <!-- Contract Summary -->
            <div class="summary-card">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-file-earmark-text text-blue-600"></i>
                ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
              </h3>
              
              <div id="contractSummary" class="space-y-4">
                <!-- Contract details will be loaded here -->
              </div>
              </div>

            <!-- Customer Information -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="bi bi-person-fill text-green-600"></i>
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                </div>
                <div class="flex gap-2">
                  <button id="btnViewFullCustomerDetails" class="btn btn-sm btn-outline">
                    <i class="bi bi-eye"></i>
                    <span>‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                  </button>
                  <button id="btnDebugCustomerData" class="btn btn-sm btn-info" style="font-size: 10px;">
                    <i class="bi bi-bug"></i>
                    <span>Debug</span>
                  </button>
                </div>
              </h3>
              
              <div id="customerSummary" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Customer details will be loaded here -->
              </div>
              </div>

            <!-- Items Summary -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-cart-fill text-purple-600"></i>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </h3>
              
              <div id="itemsSummary" class="space-y-3">
                <!-- Items will be loaded here -->
              </div>
              </div>

            <!-- Payment Plan Summary -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-credit-card text-orange-600"></i>
                ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
              </h3>
              
              <div id="paymentPlanSummary" class="space-y-3">
                <!-- Payment plan details will be loaded here -->
            </div>
          </div>
        </div>

          <!-- Right Column: Actions & Documents -->
          <div class="space-y-6">
            
            <!-- Payment Summary -->
            <div class="payment-summary">
              <h3 class="text-lg font-bold mb-2">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <div class="payment-amount" id="todayPaymentAmount">‡∏ø0.00</div>
              <div class="space-y-1 text-xs text-gray-600">
                <div id="paymentBreakdown">
                  <div class="font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå: <span id="downPaymentDisplay">‡∏ø0.00</span></div>
                  <div id="docFeeDisplay" style="display: none;">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: <span>‡∏ø0.00</span></div>
                  <div id="taxDisplay" style="display: none;">‡∏†‡∏≤‡∏©‡∏µ (VAT 7%): <span>‡∏ø0.00</span></div>
                </div>
              </div>
            </div>

            <!-- Process Status -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-gear-fill text-blue-600"></i>
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
              </h3>
              
              <div class="progress-steps">
                <div class="progress-step" id="step-stock">
                  <div class="progress-step-icon">1</div>
                  <span class="text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</span>
                </div>
                <div class="progress-step" id="step-validate">
                  <div class="progress-step-icon">2</div>
                  <span class="text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </div>
                <div class="progress-step" id="step-contract">
                  <div class="progress-step-icon">3</div>
                  <span class="text-xs">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                </div>
                <div class="progress-step" id="step-documents">
                  <div class="progress-step-icon">4</div>
                  <span class="text-xs">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
                </div>
                <div class="progress-step" id="step-email">
                  <div class="progress-step-icon">5</div>
                  <span class="text-xs">‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
        </div>
      </div>

              <!-- üÜï Real-time Status Container -->
              <div id="realtime-status" class="mt-3 text-center min-h-[24px]">
                <!-- Real-time status messages will appear here -->
              </div>

              <div id="statusMessage" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
                <i class="bi bi-info-circle text-blue-600"></i>
                <span class="text-sm">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span>
              </div>
              
              <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (‚úÖ ENABLED - ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) -->
              <div id="stockUpdateDetails" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg" style="display: none;">
                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2 flex items-center gap-2">
                  <i class="bi bi-box-seam"></i>
                  ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
              </h4>
                <div id="stockUpdateList" class="space-y-1 text-sm">
                  <!-- Stock update details will appear here -->
                  </div>
                </div>
                  </div>

            <!-- Document Generation -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-file-earmark-pdf text-red-600"></i>
                ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
              </h3>
              
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:</span>
                  <div class="document-status pending" id="quotationStatus">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>

                <div class="flex justify-between items-center">
                  <span class="text-sm">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:</span>
                  <div class="document-status pending" id="invoiceStatus">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>

                <div class="flex justify-between items-center">
                  <span class="text-sm">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</span>
                  <div class="document-status pending" id="receiptStatus">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>

                <div class="flex justify-between items-center" id="taxInvoiceRow">
                  <span class="text-sm">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ:</span>
                  <div class="document-status pending" id="taxInvoiceStatusDoc">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>

                <!-- ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
                <!-- <div class="flex justify-between items-center">
                  <span class="text-sm">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</span>
                  <div class="document-status pending" id="receiptVoucherStatus">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div> -->

                <div class="flex justify-between items-center">
                  <span class="text-sm">‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á:</span>
                  <div class="document-status pending" id="deliveryNoteStatus">
                    <i class="bi bi-clock"></i>
                    <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                </div>
              </div>
            </div>
          </div>

            <!-- Payment Method Display (from Step 3) -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-cash-coin text-green-600"></i>
                ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
              </h3>
              
              <div id="paymentMethodDisplay" class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                  <i class="bi bi-info-circle text-blue-600"></i>
                  <div>
                    <p class="text-sm text-gray-600">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Step 3:</p>
                    <p id="selectedPaymentMethod" class="font-semibold text-lg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ô Step 3</p>
                  </div>
                </div>
                
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° -->
                <div id="mixedPaymentDisplayStep4" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                  <h4 class="font-medium mb-2 text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°:</h4>
                  <div id="mixedPaymentBreakdown" class="space-y-1 text-sm">
                    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-lightning-fill text-yellow-600"></i>
                ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
              </h3>
              
              <div class="space-y-3">
                <button id="btnCreateContract" class="btn btn-primary btn-block">
                  <i class="bi bi-file-earmark-plus"></i>
                  <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>
                </button>
                
                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -->
                <div id="contractCreationStatus" class="mt-2 p-3 rounded-lg text-center bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-400" style="display: none;">
                  <i class="bi bi-info-circle"></i>
                  <span class="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
                </div>
                
                <div id="documentsSection" class="space-y-2" style="display: none;">
                  <button id="btnDownloadQuotation" class="btn btn-secondary btn-block" disabled>
                    <i class="bi bi-download"></i>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                </button>
                
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
                  <button id="btnDownloadInvoice" class="btn btn-secondary btn-block" disabled>
                    <i class="bi bi-download"></i>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span>
                </button>

                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á -->
                  <button id="btnDownloadDeliveryNote" class="btn btn-info btn-block" disabled>
                    <i class="bi bi-truck"></i>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</span>
                </button>
                
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
                  <button id="btnDownloadReceiptOnly" class="btn btn-success btn-block" disabled>
                    <i class="bi bi-receipt"></i>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                  </button>
                  
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ -->
                  <button id="btnDownloadTaxInvoiceOnly" class="btn btn-primary btn-block" disabled>
                    <i class="bi bi-file-text"></i>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>
                  </button>
                
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå -->
                  <div class="border-t pt-2 mt-2">
                    <p class="text-xs text-gray-500 mb-2">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
                    <div class="grid grid-cols-1 gap-2">
                      <button id="btnPrintDownPaymentReceipt" class="btn btn-outline btn-block" disabled style="display: none;">
                        <i class="bi bi-printer"></i>
                        <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå)</span>
                      </button>
                      <button id="btnPrintDownPaymentTaxInvoice" class="btn btn-outline btn-block" disabled style="display: none;">
                        <i class="bi bi-receipt"></i>
                        <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå)</span>
                      </button>
                    </div>
                  </div>
                  
                  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
                  <button id="btnSendEmail" class="btn btn-success btn-block" disabled>
                    <i class="bi bi-envelope"></i>
                    <span>‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á Email</span>
                  </button>
                </div>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                <div class="border-t pt-3 mt-4">
                  <button id="btnStartOver" class="btn btn-outline btn-block">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</span>
                  </button>
                  
                  <button id="btnGoToHistory" class="btn btn-outline btn-block mt-2">
                    <i class="bi bi-clock-history"></i>
                    <span>‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    </main>


  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-lg mx-4 relative">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î Modal -->
      <button id="btnCloseSuccessModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="bi bi-check-circle-fill text-green-600 text-3xl"></i>
                </div>
        <h3 class="text-xl font-bold text-green-800 dark:text-green-200 mb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤: <span id="contractNumber" class="font-mono font-bold"></span></p>
        
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
              <span class="text-gray-600 dark:text-gray-400">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
              <div class="font-bold text-green-600" id="successPaymentAmount">‡∏ø0.00</div>
                    </div>
                    <div>
              <span class="text-gray-600 dark:text-gray-400">‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</span>
              <div class="font-bold" id="nextInstallmentDate">-</div>
                    </div>
                </div>
              </div>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß -->
        <div id="documentsStatus"></div>

        <div class="flex gap-3">
          <button id="btnPrintDocuments" class="btn btn-primary flex-1">
            <i class="bi bi-printer"></i>
            <span>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
          </button>
          <button id="btnNewContract" class="btn btn-secondary flex-1">
            <i class="bi bi-plus-circle"></i>
            <span>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
          </button>
                </div>
                        </div>
                        </div>
                      </div>

  <!-- Scripts -->
  
  <!-- Printer Service Integration -->
  <script src="/js/printer-service.js"></script>
  <script>
    // Set BRANCH_CODE for PrinterService
    window.BRANCH_CODE = window.BRANCH_CODE || '00000';
    console.log('üñ®Ô∏è PrinterService loaded for branch:', window.BRANCH_CODE);
  </script>
  

  <!-- Branch Info Function -->
  <script>
    // Enhanced getImageUrl function to handle duplicate path segments
    function getImageUrl(imagePath) {
      console.log('[Step4] getImageUrl input:', imagePath);
    
      if (!imagePath) {
        console.log('[Step4] No image path provided');
        return '';
      }
    
      let cleanedPath = imagePath.toString().trim();
    
      // Remove duplicate /uploads/products/ segments with enhanced patterns
      const patterns = [
        /\/uploads\/products\/uploads\/products\//g,
        /uploads\/products\/uploads\/products\//g,
        /\/uploads\/products\/(?:uploads\/products\/)+/g,
        /uploads\/products\/(?:uploads\/products\/)+/g
      ];
    
      patterns.forEach(pattern => {
        cleanedPath = cleanedPath.replace(pattern, '/uploads/products/');
      });
    
      // Clean up multiple slashes
      cleanedPath = cleanedPath.replace(/\/+/g, '/');
    
      // Ensure path starts with /
      if (!cleanedPath.startsWith('/')) {
        cleanedPath = '/' + cleanedPath;
      }
    
      console.log('[Step4] getImageUrl output:', cleanedPath);
      return cleanedPath;
    }
    
    // Make getImageUrl globally available
    window.getImageUrl = getImageUrl;
    
    async function loadBranchInfo() {
      let js = null;
      let branchCode = null;
      try {
        branchCode = window.BRANCH_CODE;
        if (!branchCode) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å');
        }
        const token = localStorage.getItem('authToken') || '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        js = await res.json();
        if (res.ok && js.success) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} ‚Äî ${branch.address}`;
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
            document.title = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
            document.getElementById('pageTitle').textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
    
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown branch info ‡πÉ‡∏ô Receipt Menu
            const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
        if (dropdownBranchInfo) {
              dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branch.name}`;
            }
            return;
          }
        }
        throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`);
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        console.error('üîç Available branches:', js?.data?.map(b => ({ code: b.branch_code, name: b.name })) || 'No data');
        document.getElementById('branchInfo').textContent =
          `‡∏™‡∏≤‡∏Ç‡∏≤: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}"`;
    
        // Show available branches for debugging
        if (js?.data) {
          console.log('üìã Available branch codes:', js.data.map(b => b.branch_code));
          // Use window.showToast since it might be outside of scope
          if (typeof showToast === 'function') {
            showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å`, 'error');
          }
        }
      }
    }
  </script>
  
  <!-- Global Data Manager -->
  <script src="/views/pattani/installment/js/global-data-manager.js"></script>
  
  <!-- Authentication Helper -->
  <script src="/views/pattani/installment/js/auth-helper.js"></script>
  
  <!-- Receipt & Tax Invoice Integration -->
  <script src="/views/pattani/installment/js/receipt-tax-invoice-integration.js"></script>
  
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  
  <!-- Step 4 JavaScript -->
  <script src="/views/pattani/installment/step4/js/step4-integration.js"></script>

  <script>
      // Function to load and display document fee from step3
      function loadDocumentFeeFromStep3() {
        try {
          console.log('üí∞ Loading document fee from step3...');
      
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å step3
          const step3Data = window.globalInstallmentManager?.getStepData(3);
          console.log('üìã Step3 data:', step3Data);
      
          // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          let docFee = 0;
      
          if (step3Data?.docFee) {
            docFee = parseFloat(step3Data.docFee);
            console.log('‚úÖ Document fee found in step3 data:', docFee);
          } else {
            // üö® MANDATORY: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏à‡∏≤‡∏Å step3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï fallback
            console.error('üö® MANDATORY ERROR: Document fee not found in step3 data');
            alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å step3 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô step3 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            throw new Error('MANDATORY ERROR: Document fee required from step3 data');
          }
      
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          const docFeeDisplay = document.getElementById('docFeeDisplay');
          if (docFeeDisplay && docFee > 0) {
            docFeeDisplay.style.display = 'block';
            const docFeeSpan = docFeeDisplay.querySelector('span');
            if (docFeeSpan) {
              docFeeSpan.textContent = `‡∏ø${docFee.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            }
            console.log('üí∞ Document fee displayed:', docFee);
          }
      
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
          updateTodayPaymentAmount(docFee);
      
          return docFee;
      
        } catch (error) {
          console.error('‚ùå Error loading document fee:', error);
          // üö® MANDATORY: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï fallback - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å step3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          if (error.message.includes('MANDATORY ERROR')) {
            throw error;
          }
          throw new Error('MANDATORY ERROR: Document fee loading failed');
        }
      }
      
      // Function to update today payment amount
      function updateTodayPaymentAmount(docFee = 0) {
        try {
          console.log('üí∏ Updating today payment amount...');
      
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å step1 (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) ‡πÅ‡∏•‡∏∞ step3 (‡∏†‡∏≤‡∏©‡∏µ)
          const step1Data = window.globalInstallmentManager?.getStepData(1);
          const step3Data = window.globalInstallmentManager?.getStepData(3);
      
          console.log('Step1 data:', step1Data);
          console.log('Step3 data:', step3Data);
      
          // üîß FIX: ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö PDF controllers
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
          let subtotal = 0;
          const sourceItems = (step1Data?.items && Array.isArray(step1Data.items))
            ? step1Data.items
            : (Array.isArray(step1Data?.cartItems) ? step1Data.cartItems : []);
          if (sourceItems.length) {
            subtotal = sourceItems
              .filter(item => !item.name?.includes('‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°') && !item.description?.includes('‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°'))
              .reduce((sum, item) => {
                // ‡πÉ‡∏ä‡πâ downAmount ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ price/totalPrice
                const price = parseFloat(item.downAmount || item.price || item.totalPrice || 0);
                const quantity = parseInt(item.quantity || 1);
                return sum + (price * quantity);
              }, 0);
          }
      
          console.log('üìä Calculated subtotal (excluding doc fee):', subtotal);
      
          // üîß FIX: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å step3 ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏™‡∏°‡∏≠
          let totalWithTax, vatAmount, afterDiscount;
          const downPayment = parseFloat(step3Data?.down_payment || step3Data?.downPayment || 0);
          const baseForTax = (downPayment > 0 ? downPayment : subtotal) + docFee;
      
          if (step3Data?.taxType === 'inclusive') {
            // VAT ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤
            afterDiscount = baseForTax;
            totalWithTax = afterDiscount;
            vatAmount = Math.round((afterDiscount - (afterDiscount / 1.07)) * 100) / 100;
          } else if (step3Data?.taxType === 'exclusive' || step3Data?.taxType === 'vat') {
            // VAT ‡πÅ‡∏¢‡∏Å‡∏ô‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤
            afterDiscount = baseForTax;
            vatAmount = Math.round(afterDiscount * 0.07 * 100) / 100;
            totalWithTax = Math.round((afterDiscount + vatAmount) * 100) / 100;
          } else {
            // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ
            afterDiscount = baseForTax;
            vatAmount = 0;
            totalWithTax = afterDiscount;
          }
      
          console.log('üìä Calculated tax amounts (normalized):', {
            subtotal, downPayment, docFee, baseForTax, afterDiscount, vatAmount, totalWithTax, taxType: step3Data?.taxType
          });
      
          console.log('üìä Final total with tax:', totalWithTax);
      
          // ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏à‡∏≤‡∏Å step3Data ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì 30%)
          // Variable already declared above, reuse it
      
          console.log('üîç Down Payment Debug:', {
            step3_down_payment: step3Data?.down_payment,
            step3_downPayment: step3Data?.downPayment,
            parsedDownPayment: downPayment,
            docFee: docFee
          });
      
          // üîß FIX: ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
          // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ)
          // ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏¢‡∏Å)
          const todayTotal = totalWithTax; // ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
      
          console.log('üí∞ Payment calculation (Fixed - ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô):', {
            downPayment,
            docFee,
            vatAmount,
            totalWithTax,
            todayTotal,
            note: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ'
          });
      
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ = ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)
          const todayPaymentElement = document.getElementById('todayPaymentAmount');
          const downPaymentDisplay = document.getElementById('downPaymentDisplay');
      
          if (todayPaymentElement) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)
            todayPaymentElement.textContent = `‡∏ø${todayTotal.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
          }
      
          if (downPaymentDisplay) {
            downPaymentDisplay.textContent = `‡∏ø${downPayment.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
          }
      
          // üîß FIX: ‡πÅ‡∏™‡∏î‡∏á VAT ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô PDF controllers)
          if (vatAmount && vatAmount > 0) {
            const taxDisplay = document.getElementById('taxDisplay');
            if (taxDisplay) {
              taxDisplay.style.display = 'block';
              const taxSpan = taxDisplay.querySelector('span');
              if (taxSpan) {
                taxSpan.textContent = `‡∏ø${vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
              }
            }
          }
      
          console.log('‚úÖ Today payment amount updated - ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î):', todayTotal, '(‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå:', downPayment, '+ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:', docFee, '+ VAT:', vatAmount, ')');
      
          // üîß LOG: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          console.log('üìä PAYMENT SUMMARY - Step4 (Fixed):', {
            step4_downPayment: downPayment,
            step4_docFee: docFee,
            step4_vatAmount: vatAmount,
            step4_todayPayment: todayTotal,
            step4_totalWithTax: totalWithTax,
            step4_calculation: `‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå ${downPayment} + ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ${docFee} + VAT ${vatAmount} = ${todayTotal}`,
            message: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ)'
          });
      
          // üîß FIX: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏õ‡∏¢‡∏±‡∏á step3Data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ backend ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          if (step3Data && vatAmount > 0) {
            step3Data.vatAmount = vatAmount;
            step3Data.totalWithTax = totalWithTax;
            window.globalInstallmentManager?.updateStepData(3, step3Data);
            console.log('üîß FIXED: Updated step3Data with VAT info for backend:', {
              vatAmount: step3Data.vatAmount,
              totalWithTax: step3Data.totalWithTax,
              taxType: step3Data.taxType
            });
          }
      
        } catch (error) {
          console.error('‚ùå Error updating today payment amount:', error);
        }
      }

      // Check if coming from deposit receipt and conditionally hide document options
      function checkDepositReceiptSource() {
        const urlParams = new URLSearchParams(window.location.search);
        const depositReceiptId = urlParams.get('depositReceiptId');
        const fromDepositReceipt = urlParams.get('fromDepositReceipt') === 'true';
      
        if (depositReceiptId || fromDepositReceipt) {
          console.log('üéØ Coming from deposit receipt, hiding receipt/tax invoice buttons');
      
          // Hide down payment buttons since they're already handled in deposit receipt
          const downPaymentReceiptBtn = document.getElementById('btnPrintDownPaymentReceipt');
          const downPaymentTaxInvoiceBtn = document.getElementById('btnPrintDownPaymentTaxInvoice');
      
          if (downPaymentReceiptBtn) {
            downPaymentReceiptBtn.style.display = 'none';
          }
      
          if (downPaymentTaxInvoiceBtn) {
            downPaymentTaxInvoiceBtn.style.display = 'none';
          }
      
          // Add note about document availability
          const documentsSection = document.getElementById('documentsSection');
          if (documentsSection) {
            const noteElement = document.createElement('div');
            noteElement.className = 'alert alert-info mt-3';
            noteElement.innerHTML = `
              <div class="flex items-center gap-2">
                <i class="bi bi-info-circle text-blue-600"></i>
                <span class="text-sm">
                  ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
                </span>
              </div>
            `;
            documentsSection.appendChild(noteElement);
          }
        }
      }

      // Delivery note functions
      async function createDeliveryNote() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const depositReceiptId = urlParams.get('depositReceiptId');
      
          if (!depositReceiptId) {
            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥');
          }
      
          const deliveryInfo = {
            address: '', // Will be filled from customer data
            deliveryDate: new Date().toISOString(),
            specialInstructions: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á'
          };
      
          const response = await fetch(`/api/delivery-notes/from-deposit/${depositReceiptId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(deliveryInfo)
          });
      
          const result = await response.json();
      
          if (result.success) {
            // Update delivery note status
            updateDocumentStatus('deliveryNoteStatus', 'completed');
      
            // Enable delivery note download button
            const deliveryNoteBtn = document.getElementById('btnDownloadDeliveryNote');
            if (deliveryNoteBtn) {
              deliveryNoteBtn.disabled = false;
              deliveryNoteBtn.onclick = () => downloadDeliveryNote(result.data._id);
            }
      
            showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            return result.data;
          } else {
            throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á');
          }
        } catch (error) {
          console.error('Error creating delivery note:', error);
          showToast(error.message, 'error');
          throw error;
        }
      }

      function downloadDeliveryNote(deliveryNoteId) {
        window.open(`/api/delivery-notes/${deliveryNoteId}/print`, '_blank');
      }

      function updateDocumentStatus(statusElementId, status) {
        const statusElement = document.getElementById(statusElementId);
        if (statusElement) {
          statusElement.className = `document-status ${status}`;
      
          const icon = statusElement.querySelector('i');
          const text = statusElement.querySelector('span');
      
          switch (status) {
            case 'completed':
              icon.className = 'bi bi-check-circle';
              text.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
              statusElement.style.color = '#10b981';
              break;
            case 'processing':
              icon.className = 'bi bi-hourglass-split';
              text.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
              statusElement.style.color = '#f59e0b';
              break;
            case 'pending':
            default:
              icon.className = 'bi bi-clock';
              text.textContent = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
              statusElement.style.color = '#6b7280';
              break;
          }
        }
      }

      function initializeDeliveryNoteButton() {
        const deliveryNoteBtn = document.getElementById('btnDownloadDeliveryNote');
        if (deliveryNoteBtn) {
          deliveryNoteBtn.addEventListener('click', async function() {
            try {
              updateDocumentStatus('deliveryNoteStatus', 'processing');
              const deliveryNote = await createDeliveryNote();
              // Button will be enabled and onclick set in createDeliveryNote function
            } catch (error) {
              updateDocumentStatus('deliveryNoteStatus', 'pending');
            }
          });
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Step 4 initialized');
      
        // Check for draft recovery after a short delay
        setTimeout(() => {
          checkAndRestoreDraft();
        }, 1000);
      
        // Initialize branch info first
        if (window.globalInstallmentManager) {
          window.globalInstallmentManager.initializeBranchInfo();
        }
      
        // Load branch info
        await loadBranchInfo();
      
        // Initialize theme
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'true') {
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å step3
        setTimeout(() => {
          loadDocumentFeeFromStep3();
          // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          loadStep4ItemsSummary();
          // Check if coming from deposit receipt and hide document buttons accordingly
          checkDepositReceiptSource();
          // Initialize delivery note button
          initializeDeliveryNoteButton();
        }, 500); // ‡∏£‡∏≠‡πÉ‡∏´‡πâ globalInstallmentManager ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      
        showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)', 'success');
      });

    // Safe HTML escaping function to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return unsafe;
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö draft saving
    function collectAllInstallmentData() {
      try {
        console.log('üì¶ Collecting installment data for draft...');
      
        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å globalDataManager ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (window.globalDataManager) {
          const step1Data = globalDataManager.getStepData(1);
          const step2Data = globalDataManager.getStepData(2);
          const step3Data = globalDataManager.getStepData(3);
          const step4Data = globalDataManager.getStepData(4);
      
          return {
            step1: step1Data,
            step2: step2Data,
            step3: step3Data,
            step4: step4Data,
            timestamp: new Date().toISOString()
          };
        }
      
        // Fallback: ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
        return {
          step1: JSON.parse(localStorage.getItem('step1_data') || '{}'),
          step2: JSON.parse(localStorage.getItem('step2_data') || '{}'),
          step3: JSON.parse(localStorage.getItem('step3_data') || '{}'),
          step4: JSON.parse(localStorage.getItem('step4_data') || '{}'),
          timestamp: new Date().toISOString()
        };
      
      } catch (error) {
        console.error('Error collecting installment data:', error);
        return { error: error.message, timestamp: new Date().toISOString() };
      }
    }

    // Auto-save draft functionality for error recovery
    function saveDraft() {
      try {
        const draftData = {
          timestamp: new Date().toISOString(),
          step: 4,
          data: collectAllInstallmentData()
        };
        localStorage.setItem('installmentDraft', JSON.stringify(draftData));
        return true;
      } catch (e) {
        console.error('Failed to save draft:', e);
        return false;
      }
    }

    // Restore from draft if available
    function checkAndRestoreDraft() {
      try {
        const draftStr = localStorage.getItem('installmentDraft');
        if (!draftStr) return false;
      
        const draft = JSON.parse(draftStr);
        const draftAge = Date.now() - new Date(draft.timestamp).getTime();
        const oneHour = 60 * 60 * 1000;
      
        // Only restore if draft is less than 1 hour old
        if (draftAge < oneHour) {
          if (confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            // Restore data to globalInstallmentManager
            if (window.globalInstallmentManager && draft.data) {
              console.log('üîÑ Restoring from draft...');
              showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
              return true;
            }
          }
        } else {
          // Clear old draft
          localStorage.removeItem('installmentDraft');
        }
      } catch (e) {
        console.error('Failed to restore draft:', e);
      }
      return false;
    }

    // Auto-save every 30 seconds
    setInterval(() => {
      if (saveDraft()) {
        console.log('‚úÖ Draft auto-saved');
      }
    }, 30000);

    // Toast function with XSS protection
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
      }`;
      
      // Create elements safely without innerHTML
      const toastContent = document.createElement('div');
      toastContent.className = 'flex items-center gap-2';
      
      const icon = document.createElement('i');
      icon.className = `bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}`;
      
      const span = document.createElement('span');
      span.textContent = message; // Safe text content, not HTML
      
      toastContent.appendChild(icon);
      toastContent.appendChild(span);
      toast.appendChild(toastContent);
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      function calculateMixedPayment() {
        const cashAmount = parseFloat(document.getElementById('mixedCashAmount').value) || 0;
        const transferAmount = parseFloat(document.getElementById('mixedTransferAmount').value) || 0;
        const total = cashAmount + transferAmount;
      
        document.getElementById('mixedTotal').textContent = total.toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö payment method
      document.addEventListener('DOMContentLoaded', function() {
        // ‡πÇ‡∏´‡∏•‡∏î payment method ‡∏à‡∏≤‡∏Å step3
        if (window.globalInstallmentManager) {
          const step3Data = window.globalInstallmentManager.getStepData(3);
          if (step3Data && step3Data.paymentMethod) {
            console.log('üí≥ Loading payment method from step3:', step3Data.paymentMethod);
            const savedMethod = document.querySelector(`input[name="downPaymentMethod"][value="${step3Data.paymentMethod}"]`);
            if (savedMethod) {
              savedMethod.checked = true;
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô mixed ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á mixedPaymentDetails
              if (step3Data.paymentMethod === 'mixed') {
                const mixedSection = document.getElementById('mixedPaymentDetails');
                if (mixedSection) {
                  mixedSection.classList.remove('hidden');
                }
              }
            }
          }
        }
      
        const paymentMethods = document.querySelectorAll('input[name="downPaymentMethod"]');
        paymentMethods.forEach(radio => {
          radio.addEventListener('change', function() {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å payment method ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á step4 data
            if (window.globalInstallmentManager) {
              const step4Data = window.globalInstallmentManager.getStepData(4) || {};
              window.globalInstallmentManager.updateStepData(4, {
                ...step4Data,
                paymentMethod: this.value,
                timestamp: new Date().toISOString()
              });
              console.log('üíæ Saved payment method to step4:', this.value);
            }
      
            const mixedSection = document.getElementById('mixedPaymentDetails');
            if (this.value === 'mixed') {
              mixedSection.classList.remove('hidden');
            } else {
              mixedSection.classList.add('hidden');
              // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤
              document.getElementById('mixedCashAmount').value = '';
              document.getElementById('mixedTransferAmount').value = '';
              document.getElementById('mixedTotal').textContent = '0.00';
            }
          });
        });
      });

      // Make functions globally available
      window.showToast = showToast;
      window.calculateMixedPayment = calculateMixedPayment;
    </script>

  <!-- Customer Details Modal -->
  <div id="customerDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 overflow-hidden">
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="bi bi-person-circle text-green-600"></i>
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </h3>
        <button id="btnCloseCustomerModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <!-- Modal Content -->
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-person text-blue-600"></i>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            </h4>
            
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</label>
                  <div id="modalPrefix" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡πÄ‡∏û‡∏®</label>
                  <div id="modalGender" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ä‡∏∑‡πà‡∏≠</label>
                  <div id="modalFirstName" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                  <div id="modalLastName" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</label>
                <div id="modalFullName" class="font-medium text-gray-800 dark:text-gray-200 text-lg">-</div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÄ‡∏Å‡∏¥‡∏î</label>
                  <div id="modalBirthDate" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏≠‡∏≤‡∏¢‡∏∏</label>
                  <div id="modalAge" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                <div id="modalIdNumber" class="font-medium text-gray-800 dark:text-gray-200 font-mono text-lg">-</div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ -->
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-telephone text-green-600"></i>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
            </h4>
            
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <div id="modalPhone" class="font-medium text-gray-800 dark:text-gray-200 text-lg">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <div id="modalEmail" class="font-medium text-gray-800 dark:text-gray-200 break-all">-</div>
              </div>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                    <i class="bi bi-chat-square-text text-green-500"></i>
                    Line ID
                  </label>
                  <div id="modalLineId" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                    <i class="bi bi-facebook text-blue-500"></i>
                    Facebook
                  </label>
                  <div id="modalFacebook" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-geo-alt text-purple-600"></i>
              ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                  <div id="modalIdCardAddress" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                </div>
                
                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô -->
                <div class="grid grid-cols-2 gap-3 text-xs">
                  <div>
                    <span class="text-gray-500">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span>
                    <div id="modalHouseNo" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà:</span>
                    <div id="modalMoo" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏ã‡∏≠‡∏¢:</span>
                    <div id="modalSoi" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏ñ‡∏ô‡∏ô:</span>
                    <div id="modalRoad" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á:</span>
                    <div id="modalSubDistrict" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï:</span>
                    <div id="modalDistrict" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</span>
                    <div id="modalProvince" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:</span>
                    <div id="modalZipcode" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                </div>
              </div>
              
              <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                  <span id="modalAddressSameIndicator" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" style="display: none;">
                    ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                  </span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                  <div id="modalCurrentAddress" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                </div>
              </div>
            </div>
            
            <!-- ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                <i class="bi bi-geo text-blue-600"></i>
                ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </h5>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <div class="text-xs text-gray-500 mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î (Coordinates)</div>
                  <div id="modalCoordinates" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">Google Maps URL</div>
                  <div id="modalMapUrl" class="text-sm text-blue-600 dark:text-blue-400 break-all">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Latitude)</div>
                  <div id="modalLatitude" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Longitude)</div>
                  <div id="modalLongitude" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-briefcase text-orange-600"></i>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</label>
                <div id="modalOccupation" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                <div id="modalIncome" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                <div id="modalWorkplace" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-people text-purple-600"></i>
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô
            </h4>
            
            <div id="witnessSection" class="space-y-4">
              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ô -->
              <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ä‡∏∑‡πà‡∏≠</label>
                  <div id="modalWitnessFirstName" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                  <div id="modalWitnessLastName" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                  <div id="modalWitnessIdCard" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label>
                  <div id="modalWitnessRelationship" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
              </div>
              
              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ô -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                  <div id="modalWitnessPhone" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏ï‡πá‡∏°</label>
                  <div id="modalWitnessFullName" class="font-medium text-gray-800 dark:text-gray-200">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</div>
                </div>
              </div>
              
              <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏¢‡∏≤‡∏ô -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    <i class="bi bi-camera text-blue-600"></i>
                    ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô
                    <span class="text-red-500">*</span>
                  </h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalWitnessPhoto" class="flex items-center justify-center h-32">
                      <div class="text-center text-gray-500 dark:text-gray-400">
                        <i class="bi bi-image text-2xl mb-2 block"></i>
                        <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    <i class="bi bi-credit-card text-green-600"></i>
                    ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
                    <span class="text-red-500">*</span>
                  </h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalWitnessIdCardImage" class="flex items-center justify-center h-32">
                      <div class="text-center text-gray-500 dark:text-gray-400">
                        <i class="bi bi-credit-card text-2xl mb-2 block"></i>
                        <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏¢‡∏≤‡∏ô -->
              <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-700">
                <div class="flex items-start gap-2">
                  <i class="bi bi-info-circle text-purple-600 mt-0.5 flex-shrink-0"></i>
                  <div class="text-sm text-purple-700 dark:text-purple-300">
                    <div class="font-medium mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</div>
                    <ul class="space-y-1 text-xs">
                      <li>‚Ä¢ ‡∏û‡∏¢‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ</li>
                      <li>‚Ä¢ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</li>
                      <li>‚Ä¢ ‡∏û‡∏¢‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 18 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-file-image text-teal-600"></i>
              ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-credit-card text-blue-600"></i>
                  ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                  <span class="text-red-500 text-sm">*</span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalIdCardImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-image text-2xl mb-2 block"></i>
                      <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£ -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-person-badge text-green-600"></i>
                  ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£
                  <span class="text-red-500 text-sm">*</span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalSelfieImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-camera-fill text-2xl mb-2 block"></i>
                      <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-receipt text-purple-600"></i>
                  ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalSalarySlipImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-file-earmark-text text-2xl mb-2 block"></i>
                      <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
            <div class="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700">
              <div class="flex items-start gap-2">
                <i class="bi bi-info-circle text-amber-600 mt-0.5 flex-shrink-0"></i>
                <div class="text-sm text-amber-700 dark:text-amber-300">
                  <div class="font-medium mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</div>
                  <ul class="space-y-1 text-xs">
                    <li>‚Ä¢ ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</li>
                    <li>‚Ä¢ ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ)</li>
                    <li>‚Ä¢ ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-shield-check text-indigo-600"></i>
              ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
            </h4>
            
            <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô -->
            <div class="mb-4">
              <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:</div>
              <div id="modalAuthMethod" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                <i class="bi bi-question-circle"></i>
                <span>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
              </div>
            </div>
            
            <!-- ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
            <div class="space-y-4">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="bi bi-pen text-indigo-600"></i>
                ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
              </h5>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg h-32 flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalCustomerSignature">
                      <span class="text-gray-500 dark:text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg h-32 flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalEmployeeSignature">
                      <span class="text-gray-500 dark:text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
            <div id="modalFingerprintSection" class="space-y-4" style="display: none;">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="bi bi-fingerprint text-purple-600"></i>
                ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
              </h5>
              
              <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-purple-800 dark:text-purple-200">‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    <div class="text-sm text-purple-600 dark:text-purple-300">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="modalFingerprintDate">-</span></div>
                  </div>
                  <div id="modalFingerprintStatus" class="px-3 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-200 text-sm">
                    <i class="bi bi-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                  </div>
                </div>
                <div id="modalFingerprintData" class="mt-2 text-xs text-gray-600 dark:text-gray-400 font-mono bg-white dark:bg-gray-800 p-2 rounded truncate">
                  ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="flex justify-end p-6 border-t border-gray-200 dark:border-gray-700">
        <button id="btnEditCustomerData" class="btn btn-primary mr-3">
          <i class="bi bi-pencil"></i>
          <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        </button>
        <button id="btnCloseCustomerModalFooter" class="btn btn-secondary">
          <span>‡∏õ‡∏¥‡∏î</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Customer Details Modal Management
    window.customerDetailsModal = {
    
      showModal() {
        const modal = document.getElementById('customerDetailsModal');
        if (modal) {
          modal.classList.remove('hidden');
          this.loadCustomerData();
        }
      },
    
      hideModal() {
        const modal = document.getElementById('customerDetailsModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      },
    
      loadCustomerData() {
        try {
          console.log('üîç MANDATORY: Checking for customer data from step2 only...');
          console.log('globalInstallmentManager exists:', !!window.globalInstallmentManager);
    
          // üö® MANDATORY: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å globalInstallmentManager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ localStorage
          const stepData = window.globalInstallmentManager?.getStepData(2);
          console.log('üìã Step data from globalInstallmentManager (MANDATORY SOURCE):', stepData);
    
          // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          if (stepData) {
            console.log('üîç Full stepData structure:');
            console.log(stepData);
            console.log('üîç Keys in stepData:', Object.keys(stepData));
            if (stepData.customer) {
              console.log('üîç Keys in stepData.customer:', Object.keys(stepData.customer));
            }
          }
    
          // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å stepData (‡∏≠‡∏≤‡∏à‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô customer object ‡∏´‡∏£‡∏∑‡∏≠ root level)
          const stepCustomerData = stepData?.customer || {};
          console.log('üë§ Customer data from stepData (MANDATORY SOURCE):', stepCustomerData);
    
          // ÔøΩ MANDATORY: ‡∏ú‡∏™‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å level ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
          const customerData = {
            ...stepData,  // Root level data (‡∏≠‡∏≤‡∏à‡∏°‡∏µ witness, attachments, etc.)
            ...stepCustomerData  // Customer object data
          };
          console.log('üîÑ MANDATORY: Using only stepData customer data:', customerData);
          console.log('üìä MANDATORY data validation:', {
            hasFirstName: !!(customerData.firstName || customerData.first_name),
            hasLastName: !!(customerData.lastName || customerData.last_name),
            hasPhone: !!(customerData.phone || customerData.phone_number),
            hasEmail: !!customerData.email,
            hasAddress: !!(customerData.address || customerData.houseNo),
            hasSignature: !!(customerData.signature || customerData.customerSignature)
          });
    
          // üö® MANDATORY: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å step2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          if (!stepCustomerData || Object.keys(stepCustomerData).length === 0) {
            console.error('üö® MANDATORY ERROR: No customer data found in step2');
            alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å step2 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô step2 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            this.showNoDataMessage();
            throw new Error('MANDATORY ERROR: Customer data required from step2');
          }
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å stepData.customer ‡∏ó‡∏µ‡πà‡∏°‡∏µ underscore format
          const actualCustomerData = customerData.customer || customerData;
    
          // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
          console.log('üîç DEBUG - actualCustomerData:', actualCustomerData);
          console.log('üîç DEBUG - actualCustomerData keys:', Object.keys(actualCustomerData));
          if (actualCustomerData) {
            console.log('üîç DEBUG - Sample fields:');
            console.log('  gender:', actualCustomerData.gender);
            console.log('  sex:', actualCustomerData.sex);
            console.log('  line_id:', actualCustomerData.line_id);
            console.log('  lineId:', actualCustomerData.lineId);
            console.log('  facebook:', actualCustomerData.facebook);
          }
    
          document.getElementById('modalPrefix').textContent = actualCustomerData.prefix || customerData.prefix || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalFirstName').textContent = actualCustomerData.first_name || actualCustomerData.firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalLastName').textContent = actualCustomerData.last_name || actualCustomerData.lastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
        const prefix = actualCustomerData.prefix || '';
        const firstName = actualCustomerData.first_name || actualCustomerData.firstName || '';
        const lastName = actualCustomerData.last_name || actualCustomerData.lastName || '';
    
        document.getElementById('modalFullName').textContent = `${prefix} ${firstName} ${lastName}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
        // Enhanced gender display - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠ prefix
        let gender = actualCustomerData.gender || actualCustomerData.sex || '';
    
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏® ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å prefix
        if (!gender) {
          const prefix = actualCustomerData.prefix || customerData.prefix || '';
          if (prefix.includes('‡∏ô‡∏≤‡∏¢')) {
            gender = '‡∏ä‡∏≤‡∏¢';
          } else if (prefix.includes('‡∏ô‡∏≤‡∏á') || prefix.includes('‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß')) {
            gender = '‡∏´‡∏ç‡∏¥‡∏á';
          } else {
            gender = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          }
        }
    
        document.getElementById('modalGender').textContent = gender;
    
        document.getElementById('modalBirthDate').textContent = actualCustomerData.birth_date || actualCustomerData.birthDate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        document.getElementById('modalAge').textContent = actualCustomerData.age ? `${actualCustomerData.age} ‡∏õ‡∏µ` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        document.getElementById('modalIdNumber').textContent = actualCustomerData.tax_id || actualCustomerData.idCard || actualCustomerData.idNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
        document.getElementById('modalPhone').textContent = actualCustomerData.phone_number || actualCustomerData.phone || actualCustomerData.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        document.getElementById('modalEmail').textContent = actualCustomerData.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
        // Fix Line ID display - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô step2
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô step2 form ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        const lineId = actualCustomerData.line_id || actualCustomerData.lineId || '';
        document.getElementById('modalLineId').textContent = lineId || '-';
    
        // Fix Facebook display - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô step2
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô step2 form ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        const fbUrl = actualCustomerData.facebook || actualCustomerData.fb || '';
        document.getElementById('modalFacebook').textContent = fbUrl ?
            (fbUrl.length > 50 ? fbUrl.substring(0, 50) + '...' : fbUrl) :
            '-';
    
          // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á nested object ‡πÅ‡∏•‡∏∞ flat structure
          const addressData = customerData.address || {
            houseNo: customerData.houseNo,
            moo: customerData.moo,
            soi: customerData.soi,
            road: customerData.road,
            subDistrict: customerData.subDistrict,
            district: customerData.district,
            province: customerData.province,
            zipcode: customerData.zipcode
          };
    
          const idCardAddress = this.formatAddress(addressData);
          document.getElementById('modalIdCardAddress').textContent = idCardAddress || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô
          document.getElementById('modalHouseNo').textContent = addressData.houseNo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalMoo').textContent = addressData.moo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalSoi').textContent = addressData.soi || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalRoad').textContent = addressData.road || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalSubDistrict').textContent = addressData.subDistrict || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalDistrict').textContent = addressData.district || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalProvince').textContent = addressData.province || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalZipcode').textContent = addressData.zipcode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          const currentAddress = customerData.isSameAddress ?
            '‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' :
            this.formatAddress(customerData.contactAddress || customerData.currentAddress);
          document.getElementById('modalCurrentAddress').textContent = currentAddress || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          // ‡πÅ‡∏™‡∏î‡∏á indicator ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
          const sameIndicator = document.getElementById('modalAddressSameIndicator');
          if (customerData.isSameAddress) {
            sameIndicator.style.display = 'inline-block';
          } else {
            sameIndicator.style.display = 'none';
          }
    
          // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
          console.log('üó∫Ô∏è Location data debug:', {
            coordinates: customerData.coordinates,
            customerCoordinates: customerData.customerCoordinates,
            latitude: customerData.latitude,
            customerLatitude: customerData.customerLatitude,
            longitude: customerData.longitude,
            customerLongitude: customerData.customerLongitude,
            mapUrl: customerData.mapUrl,
            customerMapUrl: customerData.customerMapUrl
          });
    
          document.getElementById('modalCoordinates').textContent = customerData.coordinates || customerData.customerCoordinates || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalLatitude').textContent = customerData.latitude || customerData.customerLatitude || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          document.getElementById('modalLongitude').textContent = customerData.longitude || customerData.customerLongitude || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          const mapUrlElement = document.getElementById('modalMapUrl');
          const mapUrl = customerData.mapUrl || customerData.customerMapUrl;
          if (mapUrl) {
            mapUrlElement.innerHTML = `<a href="${mapUrl}" target="_blank" class="hover:underline">${mapUrl.length > 50 ? mapUrl.substring(0, 50) + '...' : mapUrl}</a>`;
          } else {
            mapUrlElement.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          }
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
          document.getElementById('modalOccupation').textContent = actualCustomerData.occupation || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          const income = actualCustomerData.income || actualCustomerData.monthlyIncome;
          document.getElementById('modalIncome').textContent = income ? `‡∏ø${parseInt(income).toLocaleString()}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          document.getElementById('modalWorkplace').textContent = actualCustomerData.workplace || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          // ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
          this.loadAuthenticationMethod(customerData);
    
          // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å stepData.attachments ‡∏î‡πâ‡∏ß‡∏¢)
          const documentsData = { ...customerData, ...(stepData?.attachments || {}) };
          this.loadDocumentImages(documentsData);
    
          // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å stepData.signature ‡∏î‡πâ‡∏ß‡∏¢)
          const signatureData = {
            ...customerData,
            signature: stepData?.signature,
            customerSignature: stepData?.signature || customerData.customerSignature
          };
          this.loadSignatures(signatureData);
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô - ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ stepData ‡πÄ‡∏õ‡πá‡∏ô fallback
          console.log('üë• Loading witness data for customer modal...');
          this.loadWitnessDataForModal(stepData);
    
        } catch (error) {
          console.error('‚ùå MANDATORY ERROR: Customer data loading failed:', error);
          // üö® MANDATORY: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï fallback - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å step2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          if (error.message.includes('MANDATORY ERROR')) {
            throw error;
          }
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å step2', 'error');
          throw new Error('MANDATORY ERROR: Customer data loading failed');
        }
      },
    
      showNoDataMessage() {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const elements = [
          'modalPrefix', 'modalFirstName', 'modalLastName', 'modalFullName',
          'modalGender', 'modalBirthDate', 'modalAge', 'modalIdNumber',
          'modalPhone', 'modalEmail', 'modalLineId', 'modalFacebook'
        ];
    
        elements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = '<span class="text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Step 2</span>';
          }
        });
    
        console.warn('‚ùå ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
      },
    
      formatAddress(addressData) {
        if (!addressData) return '';
    
        const parts = [];
    
        if (addressData.houseNumber || addressData.houseNo) parts.push(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${addressData.houseNumber || addressData.houseNo}`);
        if (addressData.village || addressData.moo) parts.push(`‡∏´‡∏°‡∏π‡πà ${addressData.village || addressData.moo}`);
        if (addressData.soi) parts.push(`‡∏ã‡∏≠‡∏¢ ${addressData.soi}`);
        if (addressData.street || addressData.road) parts.push(`‡∏ñ‡∏ô‡∏ô ${addressData.street || addressData.road}`);
        if (addressData.subdistrict || addressData.subDistrict) parts.push(`‡∏ï‡∏≥‡∏ö‡∏• ${addressData.subdistrict || addressData.subDistrict}`);
        if (addressData.district) parts.push(`‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ${addressData.district}`);
        if (addressData.province) parts.push(`‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${addressData.province}`);
        if (addressData.postalCode || addressData.zipcode) parts.push(`‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå ${addressData.postalCode || addressData.zipcode}`);
    
        return parts.join(' ');
      },
    
      loadAuthenticationMethod(customerData) {
        const authMethodElement = document.getElementById('modalAuthMethod');
        const fingerprintSection = document.getElementById('modalFingerprintSection');
    
        // Check multiple possible field names for authentication method
        const method = customerData.authMethod ||
                      customerData.customerAuthMethod ||
                      customerData.auth_method ||
                      customerData.authenticationMethod ||
                      customerData.authType ||
                      customerData.signature ? 'signature' : null;  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ signature
    
        if (method) {
    
          if (method === 'signature') {
            authMethodElement.innerHTML = `
              <i class="bi bi-pen-fill"></i>
              <span>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
            `;
            authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
            fingerprintSection.style.display = 'none';
          } else if (method === 'fingerprint') {
            authMethodElement.innerHTML = `
              <i class="bi bi-fingerprint"></i>
              <span>‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</span>
            `;
            authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
            fingerprintSection.style.display = 'block';
    
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
            this.loadFingerprintData(customerData);
          }
        } else {
          authMethodElement.innerHTML = `
            <i class="bi bi-question-circle"></i>
            <span>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
          `;
          authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
          fingerprintSection.style.display = 'none';
        }
      },
    
      loadFingerprintData(customerData) {
        const fingerprintData = customerData.fingerprintData || customerData.customerFingerprintData;
        const fingerprintDate = customerData.fingerprintDate || new Date().toLocaleDateString('th-TH');
    
        document.getElementById('modalFingerprintDate').textContent = fingerprintDate;
    
        if (fingerprintData) {
          document.getElementById('modalFingerprintData').textContent =
            fingerprintData.length > 100 ? fingerprintData.substring(0, 100) + '...' : fingerprintData;
          document.getElementById('modalFingerprintStatus').innerHTML = `
            <i class="bi bi-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
          `;
        } else {
          document.getElementById('modalFingerprintData').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠';
          document.getElementById('modalFingerprintStatus').innerHTML = `
            <i class="bi bi-x-circle"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          `;
          document.getElementById('modalFingerprintStatus').className = 'px-3 py-1 rounded-full bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-200 text-sm';
        }
      },
    
      loadDocumentImages(customerData) {
        console.log('üñºÔ∏è Loading document images:', customerData);
    
        // ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å stepData.attachments ‡πÅ‡∏•‡∏∞ localStorage server URLs
        const idCardContainer = document.getElementById('modalIdCardImage');
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö attachments ‡∏à‡∏≤‡∏Å globalInstallmentManager
        const stepData = window.globalInstallmentManager?.getStepData(2);
        const attachments = stepData?.attachments || {};
    
        // üîß Safe object property access to prevent [object Object] issues
        const getAttachmentUrl = (attachment) => {
          console.log('üîç getAttachmentUrl called with:', typeof attachment, attachment);
          if (!attachment) {
            console.log('   ‚Üí No attachment provided, returning null');
            return null;
          }
    
          // If it's already a string, validate it first
          if (typeof attachment === 'string') {
            // Check if it's not the string representation of an object
            if (attachment.includes('[object') || attachment.includes('Object]')) {
              console.log('   ‚Üí Attachment is string but contains [object Object], returning null');
              return null;
            }
            console.log('   ‚Üí Attachment is valid string:', attachment.substring(0, 50) + '...');
            return attachment;
          }
    
          // Check for various property names that might contain the URL
          if (attachment.url && typeof attachment.url === 'string' && !attachment.url.includes('[object')) {
            console.log('   ‚Üí Using attachment.url:', attachment.url.substring(0, 50) + '...');
            return attachment.url;
          }
          if (attachment.data && typeof attachment.data === 'string' && !attachment.data.includes('[object')) {
            console.log('   ‚Üí Using attachment.data:', attachment.data.substring(0, 50) + '...');
            return attachment.data;
          }
          if (attachment.imageData && typeof attachment.imageData === 'string' && !attachment.imageData.includes('[object')) {
            console.log('   ‚Üí Using attachment.imageData:', attachment.imageData.substring(0, 50) + '...');
            return attachment.imageData;
          }
          if (attachment.path && typeof attachment.path === 'string' && !attachment.path.includes('[object')) {
            console.log('   ‚Üí Using attachment.path:', attachment.path.substring(0, 50) + '...');
            return attachment.path;
          }
          if (attachment.src && typeof attachment.src === 'string' && !attachment.src.includes('[object')) {
            console.log('   ‚Üí Using attachment.src:', attachment.src.substring(0, 50) + '...');
            return attachment.src;
          }
    
          console.log('   ‚Üí No valid URL found in attachment object:', Object.keys(attachment));
          return null;
        };
    
        // Helper function to safely escape strings for HTML attributes
        const escapeHtmlAttribute = (str) => {
          if (typeof str !== 'string') return '';
          return str.replace(/"/g, '&quot;')
                   .replace(/'/g, '&#39;')
                   .replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;')
                   .replace(/\\/g, '&#92;');
        };
    
        const idCardSources = [
          // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: server URLs ‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ base64
          localStorage.getItem('customer_idCard_url'),
          getAttachmentUrl(attachments.idCard),
          localStorage.getItem('idCardImageUrl'),
          localStorage.getItem('idCardImageData'),
          localStorage.getItem('idCardImage'),
          customerData.idCardImageUrl,
          customerData.idCardImage,
          customerData.idCard_image
        ];
    
        // Validate image URL to prevent [object Object] issues
        const isValidImageUrl = (url) => {
          if (!url || typeof url !== 'string') return false;
          if (url === 'null' || url === 'undefined' || url === '') return false;
          if (url.includes('[object') || url.includes('Object]')) return false;
          // Check if it's a valid data URL or http URL
          if (url.startsWith('data:image/') || url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) {
            return true;
          }
          return false;
        };
    
        const idCardImage = idCardSources.find(img => isValidImageUrl(img));
        console.log('üñºÔ∏è ID Card Image - Checking sources:');
        console.log('   customer_idCard_url:', localStorage.getItem('customer_idCard_url') ? 'found' : 'not found');
        console.log('   attachments.idCard:', attachments.idCard ? 'found' : 'not found');
        console.log('   localStorage items:', idCardSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected ID Card Image:', idCardImage ? (idCardImage.startsWith('http') ? idCardImage : idCardImage.substring(0, 50) + '...') : 'none');
    
        if (idCardImage && isValidImageUrl(idCardImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeIdCardImage = escapeHtmlAttribute(idCardImage);
    
          idCardContainer.innerHTML = `
            <img src="${idCardImage}" 
                 alt="‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeIdCardImage}"
                 data-image-title="‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = idCardContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-image text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span>
            </div>
          `;
        }
    
        // ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£ - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å stepData.attachments ‡πÅ‡∏•‡∏∞ localStorage server URLs
        const selfieContainer = document.getElementById('modalSelfieImage');
        const selfieSources = [
          // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: server URLs ‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ base64
          localStorage.getItem('customer_selfie_url'),
          getAttachmentUrl(attachments.selfie),
          localStorage.getItem('selfieImageUrl'),
          localStorage.getItem('selfieImageData'),
          localStorage.getItem('selfieImage'),
          customerData.selfieImageUrl,
          customerData.selfieImage,
          customerData.selfie_image
        ];
    
        const selfieImage = selfieSources.find(img => isValidImageUrl(img));
        console.log('üñºÔ∏è Selfie Image - Checking sources:');
        console.log('   customer_selfie_url:', localStorage.getItem('customer_selfie_url') ? 'found' : 'not found');
        console.log('   attachments.selfie:', attachments.selfie ? 'found' : 'not found');
        console.log('   localStorage items:', selfieSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected Selfie Image:', selfieImage ? (selfieImage.startsWith('http') ? selfieImage : selfieImage.substring(0, 50) + '...') : 'none');
    
        if (selfieImage && isValidImageUrl(selfieImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeSelfieImage = escapeHtmlAttribute(selfieImage);
    
          selfieContainer.innerHTML = `
            <img src="${selfieImage}" 
                 alt="‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeSelfieImage}"
                 data-image-title="‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = selfieContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          selfieContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-camera-fill text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà</span>
            </div>
          `;
        }
    
        // ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å stepData.attachments ‡πÅ‡∏•‡∏∞ localStorage server URLs
        const salarySlipContainer = document.getElementById('modalSalarySlipImage');
        const salarySlipSources = [
          // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: server URLs ‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ base64
          localStorage.getItem('customer_salarySlip_url'),
          getAttachmentUrl(attachments.salarySlip),
          localStorage.getItem('salarySlipImageUrl'),
          localStorage.getItem('salarySlipImageData'),
          localStorage.getItem('salarySlipImage'),
          customerData.salarySlipImageUrl,
          customerData.salarySlipImage,
          customerData.salary_slip_image
        ];
    
        const salarySlipImage = salarySlipSources.find(img => isValidImageUrl(img));
        console.log('üñºÔ∏è Salary Slip Image - Checking sources:');
        console.log('   attachments.salarySlip:', attachments.salarySlip ? 'found' : 'not found');
        console.log('   localStorage items:', salarySlipSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected Salary Slip Image:', salarySlipImage ? salarySlipImage.substring(0, 50) + '...' : 'none');
    
        if (salarySlipImage && isValidImageUrl(salarySlipImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeSalarySlipImage = escapeHtmlAttribute(salarySlipImage);
    
          salarySlipContainer.innerHTML = `
            <img src="${salarySlipImage}" 
                 alt="‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeSalarySlipImage}"
                 data-image-title="‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = salarySlipContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          salarySlipContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-file-earmark-text text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
            </div>
          `;
        }
      },
    
      showImageModal(imageUrl, title) {
        // üîß Validate imageUrl to prevent [object Object] errors
        if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.includes('[object Object]')) {
          console.error('‚ùå Invalid image URL provided to showImageModal:', imageUrl);
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          return;
        }
    
        console.log('üñºÔ∏è Opening image modal for:', imageUrl.substring(0, 100) + '...');
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á image modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°
        const imageModal = document.createElement('div');
        imageModal.id = 'imageViewModal';
        imageModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4';
    
        imageModal.innerHTML = `
          <div class="relative max-w-full max-h-full">
            <button onclick="document.getElementById('imageViewModal').remove()" 
                    class="absolute -top-12 right-0 text-white hover:text-gray-300 text-3xl z-10">
              <i class="bi bi-x-lg"></i>
            </button>
            <div class="bg-white dark:bg-gray-800 p-2 rounded-lg">
              <div class="text-center mb-2">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${title}</h4>
              </div>
              <img src="${imageUrl}" 
                   alt="${title}" 
                   class="max-w-full max-h-[80vh] object-contain rounded"
                   style="max-width: 90vw;">
            </div>
          </div>
        `;
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        imageModal.addEventListener('click', function(e) {
          if (e.target === imageModal) {
            imageModal.remove();
          }
        });
    
        document.body.appendChild(imageModal);
    
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° keyboard event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î modal ‡∏î‡πâ‡∏ß‡∏¢ ESC
        const closeOnEscape = function(e) {
          if (e.key === 'Escape') {
            imageModal.remove();
            document.removeEventListener('keydown', closeOnEscape);
          }
        };
        document.addEventListener('keydown', closeOnEscape);
      },
    
      loadSignatures(customerData) {
        console.log('‚úçÔ∏è Loading signatures:', customerData);
    
        // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        const customerSigContainer = document.getElementById('modalCustomerSignature');
                const customerSignatureSources = [
          localStorage.getItem('customerSignature'),
          localStorage.getItem('step2_signature'),
          localStorage.getItem('step2_customerSignature'),
          customerData.customerSignature,
          customerData.signature
        ];
    
        const savedCustomerSignature = customerSignatureSources.find(sig => sig && sig !== 'null' && sig !== '');
        console.log('Customer signature sources:', customerSignatureSources);
        console.log('Selected customer signature:', savedCustomerSignature ? savedCustomerSignature.substring(0, 50) + '...' : 'none');
    
        if (savedCustomerSignature) {
          customerSigContainer.innerHTML = `<img src="${savedCustomerSignature}" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="max-w-full max-h-full object-contain">`;
        } else {
          customerSigContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>';
        }
    
        // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å attachments ‡πÅ‡∏•‡∏∞ localStorage
        const employeeSigContainer = document.getElementById('modalEmployeeSignature');
    
        // ‡∏î‡∏∂‡∏á attachments ‡∏à‡∏≤‡∏Å stepData
        const stepDataForSig = window.globalInstallmentManager?.getStepData(2);
        const attachmentsForSig = stepDataForSig?.attachments || {};
    
        const employeeSignatureSources = [
          attachmentsForSig.salespersonSignature?.url,
          attachmentsForSig.salespersonSignature?.data,
          attachmentsForSig.salespersonSignature?.imageData,
          attachmentsForSig.employeeSignature?.url,
          attachmentsForSig.employeeSignature?.data,
          attachmentsForSig.employeeSignature?.imageData,
          localStorage.getItem('salespersonSignature'),
          localStorage.getItem('step2_salespersonSignature'),
          localStorage.getItem('employeeSignature'),
          customerData.salespersonSignature,
          customerData.employeeSignature
        ];
    
        const savedEmployeeSignature = employeeSignatureSources.find(sig => sig && sig !== 'null' && sig !== '');
        console.log('‚úçÔ∏è Employee signature - Checking sources:');
        console.log('   attachments.salespersonSignature:', attachmentsForSig.salespersonSignature ? 'found' : 'not found');
        if (attachmentsForSig.salespersonSignature) {
          console.log('   salespersonSignature structure:', attachmentsForSig.salespersonSignature);
        }
        console.log('   attachments.employeeSignature:', attachmentsForSig.employeeSignature ? 'found' : 'not found');
        console.log('   localStorage items:', employeeSignatureSources.slice(6, 9).map(s => s ? 'found' : 'not found'));
        console.log('   All employeeSignatureSources:', employeeSignatureSources.map((s, i) => `${i}: ${s ? (typeof s === 'string' && s.length > 50 ? s.substring(0, 50) + '...' : 'found') : 'not found'}`));
        console.log('   Selected employee signature:', savedEmployeeSignature ? savedEmployeeSignature.substring(0, 50) + '...' : 'none');
    
        // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (savedCustomerSignature && savedEmployeeSignature) {
          const sameSignature = savedCustomerSignature === savedEmployeeSignature;
          console.log('‚ö†Ô∏è SIGNATURE COMPARISON:', sameSignature ? 'IDENTICAL (‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô!)' : 'DIFFERENT (‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)');
          if (sameSignature) {
            console.log('üö® WARNING: Customer and Employee signatures are identical!');
          }
        }
    
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
        if (savedEmployeeSignature && savedEmployeeSignature !== savedCustomerSignature) {
          employeeSigContainer.innerHTML = `<img src="${savedEmployeeSignature}" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="max-w-full max-h-full object-contain">`;
        } else {
          employeeSigContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>';
    
          if (savedEmployeeSignature === savedCustomerSignature && savedEmployeeSignature) {
            console.log('üö® Blocked identical signature display for employee');
            employeeSigContainer.innerHTML = '<span class="text-orange-500 dark:text-orange-400 text-sm">‚ö†Ô∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>';
          }
        }
      },
    
      loadWitnessData(stepData) {
        try {
          console.log('üë• Loading witness data from stepData:', stepData);
    
          // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ
          let witnessData = null;
    
          // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å stepData.witness
          if (stepData?.witness) {
            witnessData = stepData.witness;
            console.log('üë• Found witness data in stepData.witness:', witnessData);
          }
    
          // 1.5 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å stepData.customer.witness
          if (!witnessData && stepData?.customer?.witness) {
            witnessData = stepData.customer.witness;
            console.log('üë• Found witness data in stepData.customer.witness:', witnessData);
          }
    
          // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å localStorage - ‡πÄ‡∏û‡∏¥‡πà‡∏° debug
          if (!witnessData) {
            console.log('üë• Searching for witness data in localStorage...');
    
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö witness_data key
            const witnessJson = localStorage.getItem('witness_data');
            console.log('üë• witness_data from localStorage:', witnessJson);
    
            if (witnessJson) {
              try {
                witnessData = JSON.parse(witnessJson);
                console.log('üë• Found witness data in localStorage:', witnessData);
              } catch (e) {
                console.warn('üë• Invalid witness JSON in localStorage:', e);
              }
            } else {
              console.log('üë• No witness_data in localStorage, checking other keys...');
    
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö keys ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô
              const allKeys = Object.keys(localStorage);
              const witnessKeys = allKeys.filter(key =>
                key.toLowerCase().includes('witness') ||
                key.toLowerCase().includes('‡∏û‡∏¢‡∏≤‡∏ô')
              );
    
              console.log('üë• Available witness-related keys:', witnessKeys);
    
              // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ witness keys ‡∏≠‡∏∑‡πà‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ
              if (witnessKeys.length > 0) {
                for (const key of witnessKeys) {
                  const value = localStorage.getItem(key);
                  console.log(`üë• Checking ${key}:`, value);
    
                  // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô JSON object
                  if (value && (value.startsWith('{') || value.startsWith('['))) {
                    try {
                      const parsed = JSON.parse(value);
                      if (parsed && typeof parsed === 'object' && (parsed.firstName || parsed.name)) {
                        witnessData = parsed;
                        console.log(`üë• Found witness data in ${key}:`, witnessData);
                        break;
                      }
                    } catch (e) {
                      console.log(`üë• Could not parse ${key} as JSON`);
                    }
                  }
                }
              }
            }
          }
    
          // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å hidden input (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô form)
          if (!witnessData) {
            const witnessDataInput = document.getElementById('witnessData');
            if (witnessDataInput && witnessDataInput.value) {
              try {
                witnessData = JSON.parse(witnessDataInput.value);
                console.log('üë• Found witness data in hidden input:', witnessData);
              } catch (e) {
                console.warn('üë• Invalid witness JSON in hidden input');
              }
            }
          }
    
          if (witnessData && Object.keys(witnessData).length > 0) {
            console.log('üë• Loading witness information:', witnessData);
            console.log('üë• Witness data keys:', Object.keys(witnessData));
            console.log('üë• Witness field values:');
            console.log('  name:', witnessData.name);
            console.log('  firstName:', witnessData.firstName);
            console.log('  lastName:', witnessData.lastName);
            console.log('  relation:', witnessData.relation);
            console.log('  relationship:', witnessData.relationship);
    
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ô - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ field names
            // Parse name if it's a single field
            let witnessFirstName = witnessData.firstName || witnessData.first_name || witnessData.witnessFirstName || '';
            let witnessLastName = witnessData.lastName || witnessData.last_name || witnessData.witnessLastName || '';
    
            console.log('üë• Initial name parsing:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              fromData: {
                firstName: witnessData.firstName,
                lastName: witnessData.lastName,
                name: witnessData.name
              }
            });
    
            // If name is empty but there's a 'name' field, try to split it
            if ((!witnessFirstName && !witnessLastName) && witnessData.name && witnessData.name.trim()) {
              console.log('üë• Splitting name field:', witnessData.name);
              const nameParts = witnessData.name.trim().split(' ');
              if (nameParts.length >= 2) {
                witnessFirstName = nameParts[0];
                witnessLastName = nameParts.slice(1).join(' ');
                console.log('üë• Split into:', { firstName: witnessFirstName, lastName: witnessLastName });
              } else if (nameParts.length === 1) {
                witnessFirstName = nameParts[0];
                console.log('üë• Single name:', witnessFirstName);
              }
            }
    
            // Check stepData level for witness info (‡∏≠‡∏≤‡∏à‡∏°‡∏µ firstName ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö stepData)
            if (!witnessFirstName && stepData?.firstName) {
              witnessFirstName = stepData.firstName;
              console.log('üë• Using stepData firstName:', witnessFirstName);
            }
            if (!witnessLastName && stepData?.lastName) {
              witnessLastName = stepData.lastName;
              console.log('üë• Using stepData lastName:', witnessLastName);
            }
    
            const witnessIdCard = witnessData.idCard || witnessData.id_card || witnessData.witnessIdCard || witnessData.idNumber;
            const witnessRelationship = witnessData.relationship || witnessData.witnessRelationship || witnessData.relation || '';
            const witnessPhone = witnessData.phone || witnessData.phoneNumber || witnessData.phone_number || witnessData.witnessPhone;
    
            console.log('üë• Final parsed values:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              idCard: witnessIdCard,
              relationship: witnessRelationship,
              phone: witnessPhone
            });
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å localStorage
            console.log('üë• Setting witness display fields:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              idCard: witnessIdCard,
              relationship: witnessRelationship,
              phone: witnessPhone
            });
    
            document.getElementById('modalWitnessFirstName').textContent = witnessFirstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessLastName').textContent = witnessLastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessIdCard').textContent = witnessIdCard || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
            // ‡πÅ‡∏õ‡∏•‡∏á relationship ‡∏à‡∏≤‡∏Å English ‡πÄ‡∏õ‡πá‡∏ô Thai
            let relationshipThai = witnessRelationship;
            if (witnessRelationship === 'friend') {
              relationshipThai = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô';
            } else if (witnessRelationship === 'sibling') {
              relationshipThai = '‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á';
            } else if (witnessRelationship === 'relative') {
              relationshipThai = '‡∏ç‡∏≤‡∏ï‡∏¥';
            } else if (witnessRelationship === 'colleague') {
              relationshipThai = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô';
            }
    
            document.getElementById('modalWitnessRelationship').textContent = relationshipThai || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessPhone').textContent = witnessPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
            // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏¢‡∏≤‡∏ô
            const fullName = `${witnessFirstName || ''} ${witnessLastName || ''}`.trim();
            document.getElementById('modalWitnessFullName').textContent = fullName;
    
            // ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô
            this.loadWitnessPhoto(witnessData);
    
            // ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
            this.loadWitnessIdCardImage(witnessData);
    
            console.log('‚úÖ Witness data loaded successfully');
          } else {
            console.log('üë• No witness data found, using customer data as witness');
            this.useCustomerAsWitness(stepData);
          }
    
        } catch (error) {
          console.error('‚ùå Error loading witness data:', error);
          this.useCustomerAsWitness(stepData);
        }
      },
    
      loadWitnessPhoto(witnessData) {
        const photoContainer = document.getElementById('modalWitnessPhoto');
    
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏π‡∏õ: server URL -> base64 -> localStorage
        const photoSources = [
          localStorage.getItem('witness_witnessPhoto_url'),
          witnessData.photoUrl,
          localStorage.getItem('witness_witnessPhoto'),
          witnessData.photo,
          witnessData.witnessPhoto
        ];
    
        const validPhotoUrl = photoSources.find(url => url && url.trim() !== '');
    
        if (validPhotoUrl) {
          console.log('üë• Loading witness photo from:', validPhotoUrl.substring(0, 50) + '...');
          photoContainer.innerHTML = `
            <img src="${validPhotoUrl}" 
                 alt="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validPhotoUrl}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-red-500\\'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</div>';">
          `;
        } else {
          photoContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-image text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô</span>
            </div>
          `;
        }
      },
    
      loadWitnessIdCardImage(witnessData) {
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
    
        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏π‡∏õ: server URL -> base64 -> localStorage
        const idCardSources = [
          localStorage.getItem('witness_witnessIdCard_url'),
          witnessData.idCardImageUrl,
          localStorage.getItem('witness_witnessIdCard'),
          witnessData.idCardImage,
          witnessData.witnessIdCard
        ];
    
        const validIdCardUrl = idCardSources.find(url => url && url.trim() !== '');
    
        if (validIdCardUrl) {
          console.log('üë• Loading witness ID card from:', validIdCardUrl.substring(0, 50) + '...');
          idCardContainer.innerHTML = `
            <img src="${validIdCardUrl}" 
                 alt="‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validIdCardUrl}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-red-500\\'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</div>';">
          `;
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-credit-card text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</span>
            </div>
          `;
        }
      },
    
      showNoWitnessData() {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô
        const witnessElements = [
          'modalWitnessFirstName', 'modalWitnessLastName', 'modalWitnessIdCard',
          'modalWitnessRelationship', 'modalWitnessPhone', 'modalWitnessFullName'
        ];
    
        witnessElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = '<span class="text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Step 2</span>';
          }
        });
    
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const photoContainer = document.getElementById('modalWitnessPhoto');
        if (photoContainer) {
          photoContainer.innerHTML = `
            <div class="text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô</span>
            </div>
          `;
        }
    
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
        if (idCardContainer) {
          idCardContainer.innerHTML = `
            <div class="text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</span>
            </div>
          `;
        }
    
        console.warn('‚ùå ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
      },
    
      loadWitnessDataForModal(stepData) {
        try {
          console.log('üë• [Modal] Loading witness data for customer modal...');
    
          // Priority 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å localStorage ‡∏Å‡πà‡∏≠‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          let witnessData = null;
          const witnessJson = localStorage.getItem('witness_data');
    
          if (witnessJson) {
            try {
              witnessData = JSON.parse(witnessJson);
              console.log('üë• [Modal] Found witness data in localStorage:', witnessData);
            } catch (e) {
              console.warn('üë• [Modal] Invalid witness JSON in localStorage');
            }
          }
    
          // Priority 2: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å stepData
          if (!witnessData && stepData?.witness) {
            witnessData = stepData.witness;
            console.log('üë• [Modal] Using witness data from stepData:', witnessData);
          }
    
          if (witnessData && Object.keys(witnessData).length > 0) {
            console.log('üë• [Modal] Processing witness data:', witnessData);
    
            // Extract fields - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
            const firstName = witnessData.firstName || witnessData.first_name || '';
            const lastName = witnessData.lastName || witnessData.last_name || '';
            const idCard = witnessData.idCard || witnessData.id_card || '';
            const phone = witnessData.phone || witnessData.phone_number || '';
            let relationship = witnessData.relationship || witnessData.relation || '';
    
            // ‡πÅ‡∏õ‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            if (relationship === 'friend') {
              relationship = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô';
            } else if (relationship === 'sibling') {
              relationship = '‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á';
            } else if (relationship === 'relative') {
              relationship = '‡∏ç‡∏≤‡∏ï‡∏¥';
            } else if (relationship === 'colleague') {
              relationship = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô';
            }
    
            console.log('üë• [Modal] Setting fields:', {
              firstName,
              lastName,
              idCard,
              phone,
              relationship
            });
    
            // Update DOM elements
            document.getElementById('modalWitnessFirstName').textContent = firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessLastName').textContent = lastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessIdCard').textContent = idCard || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessRelationship').textContent = relationship || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('modalWitnessPhone').textContent = phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
            // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
            const fullName = `${firstName} ${lastName}`.trim();
            document.getElementById('modalWitnessFullName').textContent = fullName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
            console.log('‚úÖ [Modal] Witness data loaded successfully');
          } else {
            console.log('üë• [Modal] No witness data found, using fallback');
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
            const noDataMessage = '<span class="text-amber-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô</span>';
            document.getElementById('modalWitnessFirstName').innerHTML = noDataMessage;
            document.getElementById('modalWitnessLastName').innerHTML = noDataMessage;
            document.getElementById('modalWitnessRelationship').innerHTML = noDataMessage;
            document.getElementById('modalWitnessPhone').innerHTML = noDataMessage;
            document.getElementById('modalWitnessFullName').innerHTML = noDataMessage;
          }
    
        } catch (error) {
          console.error('‚ùå [Modal] Error loading witness data:', error);
        }
      },
    
      useCustomerAsWitness(stepData) {
        try {
          console.log('üë• Using customer data as witness fallback');
    
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å stepData
          const customerData = stepData?.customer || stepData || {};
          const actualCustomerData = customerData.customer || customerData;
    
          // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
          const witnessFirstName = actualCustomerData.first_name || actualCustomerData.firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          const witnessLastName = actualCustomerData.last_name || actualCustomerData.lastName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          const witnessIdCard = actualCustomerData.tax_id || actualCustomerData.idCard || actualCustomerData.idNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          const witnessPhone = actualCustomerData.phone_number || actualCustomerData.phone || actualCustomerData.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
          document.getElementById('modalWitnessFirstName').textContent = witnessFirstName;
          document.getElementById('modalWitnessLastName').textContent = witnessLastName;
          document.getElementById('modalWitnessIdCard').textContent = witnessIdCard;
          document.getElementById('modalWitnessRelationship').textContent = '‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á';
          document.getElementById('modalWitnessPhone').textContent = witnessPhone;
    
          // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏¢‡∏≤‡∏ô
          const fullName = `${witnessFirstName} ${witnessLastName}`.trim();
          document.getElementById('modalWitnessFullName').textContent = fullName;
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          this.loadCustomerAsWitnessPhotos(stepData);
    
          console.log('‚úÖ Customer data used as witness successfully');
    
        } catch (error) {
          console.error('‚ùå Error using customer as witness:', error);
          this.showNoWitnessData();
        }
      },
    
      loadCustomerAsWitnessPhotos(stepData) {
        const photoContainer = document.getElementById('modalWitnessPhoto');
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
    
        // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏û‡∏¢‡∏≤‡∏ô
        const attachments = stepData?.attachments || {};
    
        // ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
        const customerPhotoSources = [
          localStorage.getItem('customer_photo_url'),
          localStorage.getItem('customerPhotoData'),
          attachments.customerPhoto
        ];
    
        const validCustomerPhoto = customerPhotoSources.find(url => url && url.trim() !== '');
    
        if (validCustomerPhoto) {
          photoContainer.innerHTML = `
            <img src="${validCustomerPhoto}" 
                 alt="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô)" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validCustomerPhoto}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-yellow-500\\'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</div>';">
            <div class="absolute top-0 right-0 bg-blue-500 text-white px-2 py-1 text-xs rounded-bl">
              ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
            </div>
          `;
        } else {
          photoContainer.innerHTML = `
            <div class="text-center text-yellow-500">
              <i class="bi bi-person-circle text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</span>
              <div class="text-xs mt-1">(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô)</div>
            </div>
          `;
        }
    
        // ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
        const idCardSources = [
          localStorage.getItem('customer_idCard_url'),
          localStorage.getItem('idCardImageData'),
          attachments.idCard
        ];
    
        const validIdCard = idCardSources.find(url => url && url.trim() !== '');
    
        if (validIdCard) {
          idCardContainer.innerHTML = `
            <img src="${validIdCard}" 
                 alt="‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô)" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validIdCard}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-yellow-500\\'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£</div>';">
            <div class="absolute top-0 right-0 bg-blue-500 text-white px-2 py-1 text-xs rounded-bl">
              ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô
            </div>
          `;
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-yellow-500">
              <i class="bi bi-credit-card text-2xl mb-2 block"></i>
              <span class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span>
              <div class="text-xs mt-1">(‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô)</div>
            </div>
          `;
        }
      }
    };
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ‡πÄ‡∏õ‡∏¥‡∏î modal
      document.getElementById('btnViewFullCustomerDetails')?.addEventListener('click', function() {
        window.customerDetailsModal.showModal();
      });
    
      // Debug button
      document.getElementById('btnDebugCustomerData')?.addEventListener('click', function() {
        console.clear();
        console.log('üîç === DEBUG CUSTOMER DATA ===');
        console.log('1. globalInstallmentManager exists:', !!window.globalInstallmentManager);
    
        if (window.globalInstallmentManager) {
          console.log('2. globalInstallmentManager methods:');
          console.log('   - getStepData:', typeof window.globalInstallmentManager.getStepData);
          console.log('   - currentStep:', window.globalInstallmentManager.currentStep);
          console.log('   - isInitialized:', window.globalInstallmentManager.isInitialized);
    
          for (let i = 1; i <= 4; i++) {
            const stepData = window.globalInstallmentManager.getStepData(i);
            console.log(`3. Step ${i} data:`, stepData);
          }
        }
    
        console.log('4. Step 2 customer data structure:');
        const step2Data = window.globalInstallmentManager?.getStepData(2);
        if (step2Data) {
          console.log('   step2Data.customer:', step2Data.customer);
          console.log('   step2Data.signature:', step2Data.signature);
          console.log('   step2Data.attachments:', step2Data.attachments);
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î attachments
          if (step2Data.attachments) {
                    console.log('   attachments breakdown:');
        Object.keys(step2Data.attachments).forEach(key => {
          const attachment = step2Data.attachments[key];
          if (attachment) {
            console.log(`     ${key}:`, {
              hasData: !!(attachment.data || attachment.imageData),
              hasUrl: !!attachment.url,
              timestamp: attachment.timestamp,
              size: (attachment.data || attachment.imageData) ? 'found' : 'not found',
              fullStructure: attachment // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°
            });
          }
        });
          }
        }
    
        console.log('5. LocalStorage data:');
        const localData = window.customerDetailsModal.getLocalStorageData();
        console.log('   Combined local data:', localData);
    
        console.log('6. Image localStorage items:');
        const imageKeys = [
          'idCardImageData', 'idCardImage', 'idCardImageUrl',
          'selfieImageData', 'selfieImage', 'selfieImageUrl',
          'salarySlipImageData', 'salarySlipImage', 'salarySlipImageUrl'
        ];
        imageKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        console.log('7. Signature localStorage items:');
        const signatureKeys = [
          'customerSignature', 'step2_signature',
          'employeeSignature', 'salespersonSignature'
        ];
        signatureKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        console.log('8. Other important localStorage items:');
        const otherKeys = ['step2_customerData'];
        otherKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            if (key === 'step2_customerData') {
              try {
                console.log(`   ${key}:`, JSON.parse(value));
              } catch {
                console.log(`   ${key}: (invalid JSON)`);
              }
            } else {
              console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
            }
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Debug');
      });
    
      // ‡∏õ‡∏¥‡∏î modal
      document.getElementById('btnCloseCustomerModal')?.addEventListener('click', function() {
        window.customerDetailsModal.hideModal();
      });
    
      document.getElementById('btnCloseCustomerModalFooter')?.addEventListener('click', function() {
        window.customerDetailsModal.hideModal();
      });
    
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ step2
      document.getElementById('btnEditCustomerData')?.addEventListener('click', function() {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà?')) {
          window.location.href = '/step2';
        }
      });
    
      // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
      document.getElementById('customerDetailsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
          window.customerDetailsModal.hideModal();
        }
      });
    });
  </script>

  <!-- üöÄ MANDATORY DATABASE-ONLY: Ensure Step4Integration uses ONLY database, no fallback -->
  <script>
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Step4Integration.js ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    document.addEventListener('DOMContentLoaded', function() {
      // üö® MANDATORY: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (typeof Step4Integration !== 'undefined') {
        console.log('ÔøΩ MANDATORY: Step4Integration set to DATABASE-ONLY mode');
    
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ generateReceiptDocument ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (window.step4Integration && window.step4Integration.generateReceiptDocument) {
          const originalGenerateReceipt = window.step4Integration.generateReceiptDocument.bind(window.step4Integration);
    
          window.step4Integration.generateReceiptDocument = async function(documentData) {
            console.log('üö® MANDATORY DATABASE-ONLY: Receipt generation starting...');
    
            try {
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ó‡∏µ‡πà‡∏°‡∏µ MANDATORY database persistence)
              const result = await originalGenerateReceipt(documentData);
              console.log('‚úÖ MANDATORY: Receipt saved to database successfully');
              return result;
            } catch (error) {
              // üö® MANDATORY: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï fallback - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              if (error.message.includes('MANDATORY ERROR')) {
                console.error('üö® MANDATORY DATABASE ERROR: Receipt generation failed');
                alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                throw error;
              }
              throw error;
            }
          };
        }
    
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ generateTaxInvoiceDocument ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (window.step4Integration && window.step4Integration.generateTaxInvoiceDocument) {
          const originalGenerateTaxInvoice = window.step4Integration.generateTaxInvoiceDocument.bind(window.step4Integration);
    
          window.step4Integration.generateTaxInvoiceDocument = async function(documentData) {
            console.log('üö® MANDATORY DATABASE-ONLY: Tax invoice generation starting...');
    
            try {
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ó‡∏µ‡πà‡∏°‡∏µ MANDATORY database persistence)
              const result = await originalGenerateTaxInvoice(documentData);
              console.log('‚úÖ MANDATORY: Tax invoice saved to database successfully');
              return result;
            } catch (error) {
              // üö® MANDATORY: ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï fallback - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              if (error.message.includes('MANDATORY ERROR')) {
                console.error('ÔøΩ MANDATORY DATABASE ERROR: Tax invoice generation failed');
                alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                throw error;
              }
              throw error;
            }
          };
        }
    
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ createContract ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (window.step4Integration && window.step4Integration.createContract) {
          const originalCreateContract = window.step4Integration.createContract.bind(window.step4Integration);
    
          window.step4Integration.createContract = async function() {
            console.log('üö® MANDATORY DATABASE-ONLY: Contract creation starting...');
    
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            await this.ensureSignaturesIncluded();
    
            try {
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
              const result = await originalCreateContract();
              console.log('‚úÖ MANDATORY: Contract saved to database successfully');
              return result;
            } catch (error) {
              console.error('üö® MANDATORY DATABASE ERROR: Contract creation failed:', error);
              alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
              throw error;
            }
          };
    
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡¶π‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
          window.step4Integration.ensureSignaturesIncluded = async function() {
            console.log('üñãÔ∏è MANDATORY: Ensuring all signatures are included in database submission...');
    
            const signatures = {
              customerSignature: localStorage.getItem('customerSignature') || '',
              salespersonSignature: localStorage.getItem('salespersonSignature') || '',
              authorizedSignature: localStorage.getItem('salespersonSignature') || ''
            };
    
            console.log('üîç MANDATORY Signature status for database:', {
              customer: signatures.customerSignature ? 'Present' : 'Missing',
              salesperson: signatures.salespersonSignature ? 'Present' : 'Missing',
              authorized: signatures.authorizedSignature ? 'Present' : 'Missing'
            });
    
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô global data manager ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (window.globalInstallmentManager) {
              const step2Data = window.globalInstallmentManager.getStepData(2) || {};
              if (!step2Data.signatures) {
                step2Data.signatures = {};
              }
    
              step2Data.signatures.customer = signatures.customerSignature;
              step2Data.signatures.salesperson = signatures.salespersonSignature;
              step2Data.signatures.authorized = signatures.authorizedSignature;
    
              // ‡πÉ‡∏ä‡πâ setStepData (alias ‡∏Ç‡∏≠‡∏á updateStepData)
              window.globalInstallmentManager.setStepData(2, step2Data);
              console.log('‚úÖ MANDATORY: Signatures prepared for database submission');
            }
    
            return signatures;
          };
    
          console.log('‚úÖ MANDATORY: Step4Integration configured for DATABASE-ONLY mode');
        }
      } else {
        console.error('üö® MANDATORY ERROR: Step4Integration not found - please check js/step4-integration.js');
        alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Step4Integration ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå js/step4-integration.js');
      }
    });
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ step4
    // Helper function to clean image paths
    function cleanImagePath(imagePath) {
      if (!imagePath) {
        return '/uploads/Logo2.png';
      }
    
      if (imagePath.startsWith('http')) {
        return imagePath;
      }
    
      let cleanedPath = imagePath.toString().trim();
    
      // Convert all backslashes to forward slashes first
      cleanedPath = cleanedPath.replace(/\\/g, '/');
    
      // Remove duplicate /uploads/products/ segments
      const patterns = [
        /\/uploads\/products\/uploads\/products\//g,
        /uploads\/products\/uploads\/products\//g,
        /\/uploads\/products\/(?:uploads\/products\/)+/g,
        /uploads\/products\/(?:uploads\/products\/)+/g
      ];
    
      patterns.forEach(pattern => {
        cleanedPath = cleanedPath.replace(pattern, '/uploads/products/');
      });
    
      // Clean up multiple slashes
      cleanedPath = cleanedPath.replace(/\/+/g, '/');
    
      // Ensure path starts with /
      if (!cleanedPath.startsWith('/')) {
        cleanedPath = '/' + cleanedPath;
      }
    
      // If it doesn't contain uploads/products/, add it
      if (!cleanedPath.includes('uploads/products/')) {
        const filename = cleanedPath.replace(/^\/+/, '');
        cleanedPath = `/uploads/products/${filename}`;
      }
    
      return cleanedPath;
    }

    function loadStep4ItemsSummary() {
      const itemsSummaryDiv = document.getElementById('itemsSummary');
    
      if (!itemsSummaryDiv) {
        console.warn('Step4: Items summary element not found');
        return;
      }
    
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å step1
      const step1Data = window.globalInstallmentManager?.getStepData(1);
      let products = [];
    
      if (step1Data?.cartItems) {
        products = step1Data.cartItems;
      } else {
        // Fallback to localStorage
        try {
          const cartData = localStorage.getItem('cartItems') || localStorage.getItem('cartData');
          if (cartData) {
            products = JSON.parse(cartData);
          }
        } catch (e) {
          console.error('Error loading cart data:', e);
        }
      }
    
      if (products.length === 0) {
        // Safe DOM manipulation instead of innerHTML
        itemsSummaryDiv.innerHTML = ''; // Clear first
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-6';
    
        const icon = document.createElement('i');
        icon.className = 'bi bi-cart-x text-3xl text-gray-400';
    
        const text = document.createElement('p');
        text.className = 'text-gray-500 mt-2';
        text.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    
        emptyDiv.appendChild(icon);
        emptyDiv.appendChild(text);
        itemsSummaryDiv.appendChild(emptyDiv);
        return;
      }
    
      let html = '';
    
      products.forEach((item, index) => {
        const quantity = item.quantity || 1;
        const downAmount = parseFloat(item.downAmount || 0);
        const downInstallment = parseFloat(item.downInstallment || 0);
        const downInstallmentCount = parseInt(item.downInstallmentCount || 0);
        // ‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå + (‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î)
        const totalPrice = downAmount + (downInstallment * downInstallmentCount);
        const subtotal = downAmount * quantity;
    
        html += `
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-white dark:bg-gray-600 rounded-lg flex items-center justify-center overflow-hidden">
                ${item.image ?
                  `<img src="${cleanImagePath(item.image)}" alt="${item.name}" class="w-full h-full object-cover rounded">` :
                  '<i class="bi bi-phone text-gray-400"></i>'
                }
              </div>
              
              <div class="flex-1 min-w-0">
                <h6 class="font-semibold text-sm">${escapeHtml(item.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')}</h6>
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ${item.brand ? `<span class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">${escapeHtml(item.brand)}</span>` : ''}
                  ${item.imei ? `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded font-mono">IMEI: ${escapeHtml(item.imei)}</span>` : ''}
                </div>
                
                <div class="mt-2 bg-white dark:bg-gray-600 p-2 rounded text-xs">
                  <div class="grid grid-cols-4 gap-1 text-center">
                    <div>
                      <div class="text-gray-500">‡∏î‡∏≤‡∏ß‡∏ô‡πå</div>
                      <div class="font-bold text-green-600">‡∏ø${formatPriceStep4(downAmount)}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                      <div class="font-bold text-purple-600">‡∏ø${formatPriceStep4(downInstallment)}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">‡∏á‡∏ß‡∏î</div>
                      <div class="font-bold text-blue-600">${downInstallmentCount}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                      <div class="font-bold text-orange-600">‡∏ø${formatPriceStep4(totalPrice)}</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-right">
                <div class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${quantity}</div>
                <div class="font-bold text-blue-600 text-lg">‡∏ø${formatPriceStep4(subtotal)}</div>
                <div class="text-xs text-gray-500">(‡∏¢‡∏≠‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå)</div>
              </div>
            </div>
          </div>
        `;
      });
    
      itemsSummaryDiv.innerHTML = html;
    
      console.log('‚úÖ Step4: Items summary loaded with', products.length, 'items');
    }
    
    // Helper function for price formatting in step4
    function formatPriceStep4(num) {
      return Number(num || 0).toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
  </script>

  <!-- =============================================
       INSTALLMENT DATA CONSOLIDATION & BACKEND SUBMISSION
       ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Step ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
       Version 3.0 - Optimized for existing button
  ============================================= -->
  <script>
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á plan_type ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö backend validation
    function mapPlanType(planType) {
      console.log('üîÑ Mapping plan type:', planType);
    
      // Map frontend plan types to backend accepted values
      const planTypeMap = {
        'custom': 'plan1',        // Custom plans become plan1
        'recommended': 'plan2',   // Recommended plans become plan2
        'manual': 'plan1',        // Manual plans become plan1
        'plan1': 'plan1',         // Already valid
        'plan2': 'plan2',         // Already valid
        'plan3': 'plan3'          // Already valid
      };
    
      const mappedType = planTypeMap[planType] || 'plan1';
      console.log('‚úÖ Plan type mapped:', { original: planType, mapped: mappedType });
      return mappedType;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function collectAllInstallmentData() {
      console.log('üì¶ Collecting all installment data from Steps 1-4...');
    
      try {
        // Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const step1Products = getStep1Products();
    
        // Step 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        const step2Customer = getStep2Customer();
    
        // Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏†‡∏≤‡∏©‡∏µ
        const step3Invoice = getStep3Invoice();
    
        // Step 4: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (async function)
        const step4Payment = await getStep4Payment();
    
        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà payment controller ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        const consolidatedData = {
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
          items: step1Products.items || [],
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
          customer_type: 'individual', // Default to individual
          customer: {
            prefix: step2Customer.customer?.prefix || '‡∏ô‡∏≤‡∏¢',
            first_name: step2Customer.customer?.first_name || '',
            last_name: step2Customer.customer?.last_name || '',
            phone_number: step2Customer.customer?.phone_number || '',
            email: step2Customer.customer?.email || '',
            tax_id: step2Customer.customer?.tax_id || '',
            address: step2Customer.customer?.address || {}
          },
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          witness: {
            name: '',
            id_card: '',
            phone: '',
            relation: ''
          },
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          attachments: {
            id_card_image: '',
            income_slip: '',
            selfie_image: '',
            customer_signature: step4Payment.customer_signature || '',
            salesperson_signature: step4Payment.salesperson_signature || '',
            authorized_signature: ''
          },
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
          plan_type: mapPlanType(step3Invoice.plan_type) || 'plan1',
          down_payment: parseFloat(step3Invoice.down_payment || 0),
          installment_count: parseInt(step3Invoice.installment_count || 12),
          installment_amount: parseFloat(step3Invoice.installment_amount || 0),
          credit_amount: parseFloat(step3Invoice.credit_amount || 0),
          payoff_amount: parseFloat(step3Invoice.payoff_amount || 0),
          doc_fee: parseFloat(step3Invoice.document_fee || 0),
          quotation_no: '',
          credit_term: `${step3Invoice.installment_count || 12} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
          sub_total: parseFloat(step1Products.totalAmount || 0),
          total_amount: parseFloat(step3Invoice.total_with_tax || step3Invoice.total_amount || step1Products.totalAmount || 0),
          total_text: '',
          quotation_terms: '',
    
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          branch_code: window.BRANCH_CODE || '00000',
          salesperson_id: step4Payment.salesperson_id || '',
    
          // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          appliedPromotions: [],
          promotionDiscount: 0,
          skipStockDeduction: false,
          payoffContract: false,
    
          timestamp: new Date().toISOString()
        };
    
        console.log('‚úÖ Data collected successfully:', consolidatedData);
        return consolidatedData;
    
      } catch (error) {
        console.error('‚ùå Error collecting data:', error);
        throw error;
      }
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Step 1
    function getStep1Products() {
      console.log('üì¶ Getting Step 1 product data...');
    
      // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö pointer system ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ memory
      function getDataWithPointer(key) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô pointer ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const pointerKey = key + '_pointer';
        const pointer = localStorage.getItem(pointerKey);
    
        if (pointer) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô pointer ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å key ‡∏à‡∏£‡∏¥‡∏á
          console.log(`üìé Found pointer: ${key} ‚Üí ${pointer}`);
          return localStorage.getItem(pointer);
        }
    
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà pointer ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡πÜ
        return localStorage.getItem(key);
      }
    
      // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
      let products = [];
      const sources = ['cartItems', 'cartData', 'step1_selectedProducts', 'selectedProducts'];
    
      for (const key of sources) {
        const data = getDataWithPointer(key);
        if (data) {
          try {
            products = JSON.parse(data);
            console.log(`‚úÖ Found products in ${key}`);
            break;
          } catch (e) {
            console.warn(`Failed to parse ${key}:`, e);
          }
        }
      }
    
      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ú‡πà‡∏≠‡∏ô
      let installmentPlan = {};
      const planData = localStorage.getItem('installmentData_step1');
      if (planData) {
        try {
          installmentPlan = JSON.parse(planData);
        } catch (e) {}
      }
    
      return {
        items: Array.isArray(products) ? products.map(item => ({
          // üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ IMEI ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
          id: item.imei || item.branchStockId || item.id || item._id, // ‡πÉ‡∏ä‡πâ IMEI ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
          branchStockId: item.branchStockId || item.id || item._id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° branchStockId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend
          productId: item.productId || item.product_id || item.id, // ‡πÄ‡∏û‡∏¥‡πà‡∏° productId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reference
          imei: item.imei || null, // IMEI ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
          stockIdentifier: item.imei || item._id, // ‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend stock operations
          name: item.name || item.product_name || '',
          price: parseFloat(item.price || item.unitPrice || 0),
          quantity: parseInt(item.quantity || 1),
          total: parseFloat(item.total || item.totalPrice || (item.price * item.quantity) || 0)
        })) : [],
        plan_type: installmentPlan.plan_type || installmentPlan.planType || 'manual',
        installment_count: parseInt(installmentPlan.installment_count || installmentPlan.installmentCount || 12),
        total_amount: products.reduce((sum, item) => sum + parseFloat(item.total || item.totalPrice || 0), 0)
      };
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Step 2 (‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ field ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á Backend)
    function getStep2Customer() {
      console.log('üë§ Getting Step 2 customer data...');
    
      // Try getting data from globalInstallmentManager first
      let customerData = null;
      if (window.globalInstallmentManager) {
        const step2Data = window.globalInstallmentManager.getStepData(2);
        if (step2Data && step2Data.customer) {
          customerData = step2Data.customer;
          console.log('‚úÖ Got customer data from globalInstallmentManager');
        }
      }
    
      // Fallback to localStorage
      if (!customerData) {
        const localData = localStorage.getItem('step2_customerData');
        if (localData) {
          try {
            customerData = JSON.parse(localData);
            console.log('‚úÖ Got customer data from localStorage');
          } catch (e) {
            console.error('Failed to parse localStorage data:', e);
          }
        }
      }
    
      if (!customerData) {
        console.warn('‚ùå No customer data found');
        return {
          customer: {
            first_name: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            last_name: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            phone_number: '',
            email: '',
            nationalId: '',
            tax_id: '',
            address: {
              houseNo: '1',
              moo: '',
              subDistrict: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              district: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              province: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              zipcode: '00000'
            }
          }
        };
      }
    
      try {
        const customer = customerData;
        console.log('üìã Processing customer data:', customer);
    
        // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ field ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend ‡∏û‡∏£‡πâ‡∏≠‡∏° fallback values
        const result = {
          customer: {
            // ‡πÅ‡∏õ‡∏•‡∏á firstName ‚Üí first_name
            first_name: customer.firstName || customer.first_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            // ‡πÅ‡∏õ‡∏•‡∏á lastName ‚Üí last_name
            last_name: customer.lastName || customer.last_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            // ‡πÅ‡∏õ‡∏•‡∏á phone ‚Üí phone_number
            phone_number: customer.phone || customer.mobile || customer.phone_number || '',
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° nationalId ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UnifiedCustomer validation (‡∏•‡∏ö‡∏Ç‡∏µ‡∏î‡∏≠‡∏≠‡∏Å)
            nationalId: (customer.idCard || customer.nationalId || customer.national_id || customer.tax_id || '').replace(/-/g, ''),
            // ‡πÅ‡∏õ‡∏•‡∏á nationalId ‚Üí tax_id (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ - ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡∏Ç‡∏µ‡∏î)
            tax_id: customer.idCard || customer.nationalId || customer.national_id || customer.tax_id || '',
    
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            email: customer.email || '',
            birth_date: customer.birthDate || customer.birth_date || '',
            age: parseInt(customer.age || 0),
            prefix: customer.prefix || '‡∏ô‡∏≤‡∏¢',
    
            // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà - Fix mapping to match backend validation
            address: customer.address || {
              houseNo: customer.houseNo || '1',
              moo: customer.moo || '',
              subDistrict: customer.subdistrict || customer.tambon || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              district: customer.district || customer.amphoe || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              province: customer.province || customer.changwat || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
              zipcode: customer.postalCode || customer.postal_code || '00000'
            },
    
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            occupation: customer.occupation || '',
            workplace: customer.workplace || '',
            monthly_income: parseFloat(customer.monthlyIncome || customer.monthly_income || 0)
          },
    
          // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
          signatures: {
            customer: localStorage.getItem('customerSignature') || '',
            salesperson: localStorage.getItem('salespersonSignature') || ''
          }
        };
    
        console.log('‚úÖ Final customer data structure:', result);
        console.log('üîç Address validation check:', {
          hasHouseNo: !!result.customer.address.houseNo,
          hasSubDistrict: !!result.customer.address.subDistrict,
          hasDistrict: !!result.customer.address.district,
          hasProvince: !!result.customer.address.province,
          hasZipcode: !!result.customer.address.zipcode
        });
    
        // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô (witness) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const step2Data = localStorage.getItem('step2Data');
        if (step2Data) {
          try {
            const parsedStep2 = JSON.parse(step2Data);
            if (parsedStep2.witness) {
              result.witness = {
                name: `${parsedStep2.witness.firstName || ''} ${parsedStep2.witness.lastName || ''}`.trim(),
                firstName: parsedStep2.witness.firstName || '',
                lastName: parsedStep2.witness.lastName || '',
                phone: parsedStep2.witness.phoneNumber || parsedStep2.witness.phone || '',
                idCard: parsedStep2.witness.idCard || parsedStep2.witness.id_card || '',
                relationship: parsedStep2.witness.relationship || parsedStep2.witness.relation || '',
                address: parsedStep2.witness.address || '',
    
                // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏¢‡∏≤‡∏ô (base64 ‡∏´‡∏£‡∏∑‡∏≠ URL)
                photoUrl: parsedStep2.attachments?.witness_photo || '',
                idCardImageUrl: parsedStep2.attachments?.witness_id_card || ''
              };
              console.log('‚úÖ Witness data included:', result.witness);
            }
          } catch (e) {
            console.warn('Failed to parse witness data:', e);
          }
        }
    
        // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (attachments)
        const documentsData = localStorage.getItem('step2_documents');
        if (documentsData) {
          try {
            result.attachments = JSON.parse(documentsData);
          } catch (e) {
            console.warn('Failed to parse documents:', e);
          }
        }
    
        return result;
      } catch (e) {
        console.error('Error parsing customer data:', e);
        return { customer: {} };
      }
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Step 3
    function getStep3Invoice() {
      console.log('üìã Getting Step 3 invoice data...');
    
      // Try to get data from globalInstallmentManager first
      let step3Data = {};
      if (window.globalInstallmentManager) {
        const globalStep3Data = window.globalInstallmentManager.getStepData(3);
        if (globalStep3Data) {
          step3Data = {
            plan_type: globalStep3Data.plan_type || 'plan1',
            down_payment: parseFloat(globalStep3Data.down_payment || 0),
            installment_amount: parseFloat(globalStep3Data.installment_amount || 0),
            installment_count: parseInt(globalStep3Data.installment_count || 12),
            document_fee: parseFloat(globalStep3Data.doc_fee || 0),
            vat_amount: parseFloat(globalStep3Data.vatAmount || 0),
            total_with_tax: parseFloat(globalStep3Data.totalWithTax || globalStep3Data.total_with_tax || 0),
            total_amount: parseFloat(globalStep3Data.totalWithTax || globalStep3Data.total_amount || 0)
          };
          console.log('‚úÖ Got Step 3 data from globalInstallmentManager:', step3Data);
          return step3Data;
        }
      }
    
      // Fallback to sessionStorage
      const quotationData = sessionStorage.getItem('installmentQuotationData');
      if (!quotationData) return {};
    
      try {
        const quotation = JSON.parse(quotationData);
        return {
          plan_type: quotation.planType || 'plan1',
          down_payment: parseFloat(quotation.downPayment || quotation.down_payment || 0),
          installment_amount: parseFloat(quotation.monthlyPayment || quotation.monthly_payment || 0),
          installment_count: parseInt(quotation.installmentCount || 12),
          document_fee: parseFloat(quotation.docFee || quotation.document_fee || 0),
          vat_amount: parseFloat(quotation.vatAmount || quotation.vat_amount || 0),
          total_with_tax: parseFloat(quotation.totalWithTax || quotation.total_with_tax || 0),
          total_amount: parseFloat(quotation.totalWithTax || quotation.total_amount || 0)
        };
      } catch (e) {
        console.error('Error parsing quotation data:', e);
        return {};
      }
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Step 4 - Real Authentication Data Only
    async function getStep4Payment() {
      console.log('üí≥ Getting Step 4 payment data...');
    
      // Fix: ‡πÉ‡∏ä‡πâ downPaymentMethod ‡πÅ‡∏ó‡∏ô paymentMethod ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      const paymentMethod = document.querySelector('input[name="downPaymentMethod"]:checked');
      const payment = {
        payment_method: paymentMethod ? paymentMethod.value : 'cash'
      };
    
      // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö authentication ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      let userInfo = {};
      let branchInfo = {};
    
      // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: JWT Token > localStorage > API Call
      try {
        const authToken = localStorage.getItem('authToken');
        if (authToken) {
          // ‡πÅ‡∏¢‡∏Å JWT payload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
          const tokenParts = authToken.split('.');
          if (tokenParts.length === 3) {
            const payload = JSON.parse(atob(tokenParts[1]));
            console.log('üîë JWT Payload:', payload);
    
            userInfo = {
              id: payload.id || payload.user_id || payload.userId || payload.sub,
              name: payload.name || payload.fullName || payload.displayName,
              username: payload.username || payload.user_name,
              branch_code: payload.branch_code || payload.branchCode
            };
          }
        }
    
        // ‡∏ñ‡πâ‡∏≤ JWT ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage
        if (!userInfo.id || !userInfo.name) {
          const storedUserInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          userInfo = {
            id: userInfo.id || storedUserInfo.id || storedUserInfo.user_id,
            name: userInfo.name || storedUserInfo.name || storedUserInfo.fullName,
            username: userInfo.username || storedUserInfo.username,
            branch_code: userInfo.branch_code || storedUserInfo.branch_code
          };
        }
    
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
        const storedBranchInfo = JSON.parse(localStorage.getItem('branchInfo') || '{}');
        branchInfo = {
          code: userInfo.branch_code || storedBranchInfo.code || storedBranchInfo.branch_code,
          name: storedBranchInfo.name || storedBranchInfo.branch_name
        };
    
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (!userInfo.id || !userInfo.name) {
          console.log('‚ö†Ô∏è No valid user data found, attempting API call...');
    
          try {
            const response = await fetch('/api/users/me', {
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              const apiResponse = await response.json();
              const userData = apiResponse.data || apiResponse; // Handle both {data: ...} and direct response

              userInfo = {
                id: userData._id || userData.id || userData.user_id,
                name: userData.name || userData.fullName || userData.displayName || userData.username,
                username: userData.username,
                branch_code: userData.branch_code || userData.branchCode,
                role: userData.role,
                email: userData.email
              };

              console.log('üì° API Response:', apiResponse);
              console.log('üë§ Processed userInfo:', userInfo);
    
              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
              localStorage.setItem('userInfo', JSON.stringify(userInfo));
              console.log('‚úÖ User data updated from API');
            }
          } catch (apiError) {
            console.warn('‚ö†Ô∏è API call failed:', apiError.message);
          }
        }
    
      } catch (e) {
        console.error('‚ùå Error retrieving user data:', e);
      }
    
      // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö payment object
      payment.branch_code = branchInfo.code || window.BRANCH_CODE || null;
      payment.salesperson_id = userInfo.id || null;
      payment.salesperson_name = userInfo.name || null;
      payment.created_by = userInfo.username || userInfo.id || null;
    
      // ‚úÖ ‡∏î‡∏∂‡∏á salesperson signature ‡∏à‡∏≤‡∏Å step3 data
      const step3Data = window.globalInstallmentManager?.getStepData(3) || {};
      payment.salesperson_signature = step3Data.signature || '';
    
      console.log('üîç Real Authentication Data:', {
        branch_code: payment.branch_code,
        salesperson_id: payment.salesperson_id,
        salesperson_name: payment.salesperson_name,
        salesperson_signature: payment.salesperson_signature ? '‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô',
        created_by: payment.created_by,
        data_source: userInfo.id ? 'Valid User Data' : 'No User Data'
      });
    
      // ‚ö†Ô∏è Error handling - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ fallback ‡πÅ‡∏ï‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤
      if (!payment.salesperson_id) {
        console.error('‚ùå CRITICAL: No salesperson_id found - authentication system issue');
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      }
    
      if (!payment.salesperson_name) {
        console.error('‚ùå CRITICAL: No salesperson_name found - user profile incomplete');
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
      }
    
      return payment;
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
    async function submitInstallmentToBackend() {
      try {
        console.log('üöÄ Starting backend submission...');
    
        // ‚úÖ Enhanced validation before sending to backend
        console.log('üîç Debugging customer data before submission:');
        const step1Data = window.globalInstallmentManager?.getStepData(1);
        const step2Data = window.globalInstallmentManager?.getStepData(2);
    
        console.log('üìã Step 1 data:', step1Data);
        console.log('üìã Step 2 data:', step2Data);
    
        // ‚úÖ Validate required fields for UnifiedCustomer
        const customerData = step2Data?.customer || {};
        // Map firstName/lastName to first_name/last_name for compatibility
        const requiredFields = [
          { field: 'first_name', value: customerData.firstName || customerData.first_name, label: '‡∏ä‡∏∑‡πà‡∏≠' },
          { field: 'last_name', value: customerData.lastName || customerData.last_name, label: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' },
          { field: 'tax_id', value: customerData.idCard || customerData.tax_id, label: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' },
          { field: 'phone_number', value: customerData.phone || customerData.phone_number, label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' }
        ];
    
        const missingFields = [];
        requiredFields.forEach(({field, value, label}) => {
          if (!value || (typeof value === 'string' && value.trim() === '')) {
            missingFields.push(label);
            console.error(`‚ùå Missing required field: ${field} (${label})`);
          } else {
            console.log(`‚úÖ ${label}: ${value}`);
          }
        });
    
        if (missingFields.length > 0) {
          alert(`‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:\n${missingFields.join('\n')}`);
          return;
        }
    
        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const data = await collectAllInstallmentData();
    
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏° payment controller requirements
        if (!data.customer || !data.customer.first_name) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
        }
    
        if (!data.customer.phone_number) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
        }
    
        if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
          throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
        }
    
        if (!data.plan_type || !['plan1', 'plan2', 'plan3'].includes(data.plan_type)) {
          throw new Error('planType ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
    
        if (!data.total_amount || data.total_amount <= 0) {
          throw new Error('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
        }
    
        if (data.down_payment < 0) {
          throw new Error('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏ö');
        }
    
        // Get auth token
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
        }
    
        // ‡πÅ‡∏™‡∏î‡∏á Loading
        showStep4Loading();

        // üö´ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        setProcessingStatus(true);

        // üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        showRealTimeStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...', 'info');
        updateProgressStep('step-stock', 'processing');
        await simulateDelay(500); // Simulate stock checking
        updateProgressStep('step-stock', 'completed');

        showRealTimeStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');
        updateProgressStep('step-validate', 'processing');
        await simulateDelay(300); // Simulate validation
        updateProgressStep('step-validate', 'completed');

        showRealTimeStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞...', 'info');
        updateProgressStep('step-contract', 'processing');

        console.log('üì§ Sending data to backend:', data);
        console.log('üîç Payment Controller Validation Check:', {
          hasCustomer: !!data.customer,
          customerType: data.customer_type,
          firstName: data.customer?.first_name,
          lastName: data.customer?.last_name,
          phone: data.customer?.phone_number,
          taxId: data.customer?.tax_id,
          hasItems: !!data.items && Array.isArray(data.items),
          itemsCount: data.items?.length || 0,
          planType: data.plan_type,
          planTypeValid: ['plan1', 'plan2', 'plan3'].includes(data.plan_type),
          totalAmount: data.total_amount,
          downPayment: data.down_payment,
          installmentCount: data.installment_count,
          branchCode: data.branch_code,
          salespersonId: data.salesperson_id
        });
    
        // Retry logic for 502 errors
        let retryCount = 0;
        const maxRetries = 3;
        let response;
    
        while (retryCount < maxRetries) {
          try {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend with timeout
            response = await Promise.race([
              fetch('/api/installment/create', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
              }),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Request timeout')), 30000)
              )
            ]);
    
            // Check for 502 Bad Gateway
            if (response.status === 502) {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚ö†Ô∏è 502 Bad Gateway - Retrying (${retryCount}/${maxRetries})...`);
                // Continue showing loading during retry
                console.log('‚ö†Ô∏è Retrying request...');
                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // Exponential backoff
                continue;
              } else {
                throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á (502 Bad Gateway) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
              }
            }
    
            // Break if successful
            break;
    
          } catch (error) {
            if (error.message === 'Request timeout') {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚ö†Ô∏è Request timeout - Retrying (${retryCount}/${maxRetries})...`);
                // Continue showing loading during retry
                console.log('‚ö†Ô∏è Retrying request after timeout...');
                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                continue;
              } else {
                throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
              }
            }
            throw error;
          }
        }
    
        if (!response.ok) {
          let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞';
    
          try {
            const errorData = await response.json();
            console.log('‚ùå Error response data:', errorData);
    
            // Check for specific error types
            if (errorData.error) {
              // Handle new error codes from backend
              if (errorData.error === 'DUPLICATE_CONTRACT_NUMBER') {
                errorMessage = '‚ùå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ã‡πâ‡∏≥\n\n' + errorData.message + '\n\nüîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà';

                // Auto retry with new contract number
                if (errorData.retryable) {
                  setTimeout(() => {
                    submitInstallmentToBackend();
                  }, 2000);
                  return;
                }
              } else if (errorData.error === 'DUPLICATE_DATA') {
                errorMessage = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥\n\n' + errorData.message;

                // Offer retry option
                if (errorData.retryable) {
                  setTimeout(() => {
                    if (confirm('‚ùì ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                      submitInstallmentToBackend();
                    }
                  }, 1500);
                  return;
                }
              } else if (errorData.error.includes('‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠') || errorData.error.includes('insufficient stock') || errorData.error.includes('out of stock')) {
                // Extract product details from error message if available
                const productMatch = errorData.error.match(/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤.*?:\s*([^,]+)/);
                if (productMatch) {
                  errorMessage = `‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠\n\n‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${productMatch[1]}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                } else {
                  errorMessage = '‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                }
              } else if (errorData.error.includes('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ')) {
                errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ\n\n' + errorData.error;
              } else if (errorData.error.includes('duplicate key') || errorData.error.includes('E11000')) {
                const contractMatch = errorData.error.match(/contractNumber: "([^"]+)"/);
                if (contractMatch) {
                  errorMessage = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${contractMatch[1]} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`;
                } else {
                  errorMessage = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                }
              } else if (errorData.error.includes('validation') || errorData.error.includes('required')) {
                errorMessage = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                if (errorData.details) {
                  console.error('üîç Validation details:', errorData.details);
                  errorMessage += '\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + JSON.stringify(errorData.details);
                }
              } else {
                errorMessage = errorData.error;
              }
            } else if (errorData.message) {
              errorMessage = errorData.message;

              // Handle validation errors array
              if (errorData.errors && Array.isArray(errorData.errors)) {
                errorMessage += '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n‚Ä¢ ' + errorData.errors.join('\n‚Ä¢ ');
              }
            }
          } catch (e) {
            // If response body is not JSON
            if (response.status === 500) {
              errorMessage = '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (500) - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
              console.log('üí° Hint: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console log ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ backend');
            } else if (response.status === 401) {
              errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà';
              // Redirect to login
              setTimeout(() => window.location.href = '/login', 2000);
            } else if (response.status === 403) {
              errorMessage = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ';
            } else if (response.status === 409) {
              errorMessage = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            } else if (response.status === 400) {
              errorMessage = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            } else if (response.status === 404) {
              errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö API endpoint ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
            }
          }
    
          console.error('‚ùå Full error details:', {
            status: response.status,
            statusText: response.statusText,
            errorMessage: errorMessage,
            url: '/api/installment/create',
            timestamp: new Date().toISOString()
          });
    
          throw new Error(errorMessage);
        }
    
        const result = await response.json();
        console.log('‚úÖ Success response:', result);

        // üî• ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (result.data && result.data.stockDeductionLog) {
          displayStockDeductionDetails(result.data.stockDeductionLog);
        }

        // üÜï ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
        showRealTimeStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
        updateProgressStep('step-contract', 'completed');

        // üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        showRealTimeStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤, ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)...', 'info');
        updateProgressStep('step-documents', 'processing');
        await simulateDelay(800); // Simulate document creation
        showRealTimeStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
        updateProgressStep('step-documents', 'completed');

        // üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        showRealTimeStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...', 'info');
        updateProgressStep('step-email', 'processing');
        await simulateDelay(500); // Simulate email sending
        showRealTimeStatus('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
        updateProgressStep('step-email', 'completed');

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤
        if (result.data) {
          sessionStorage.setItem('installmentContractId', result.data._id || '');
          sessionStorage.setItem('installmentContractNo', result.data.contractNumber || '');
        }

        // ‡∏ã‡πà‡∏≠‡∏ô Loading
        showStep4Loading(false);

        // üö´ ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        setProcessingStatus(false);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showSuccessMessage(result);
    
        return result;
    
      } catch (error) {
        console.error('‚ùå Submission error:', error);

        // üÜï ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô error
        const currentSteps = ['step-stock', 'step-validate', 'step-contract', 'step-documents', 'step-email'];
        currentSteps.forEach(stepId => {
          const stepElement = document.getElementById(stepId);
          if (stepElement && stepElement.classList.contains('processing')) {
            updateProgressStep(stepId, 'error');
          }
        });

        showRealTimeStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');

        // ‡∏ã‡πà‡∏≠‡∏ô Loading
        showStep4Loading(false);

        // üö´ ‡∏õ‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        setProcessingStatus(false);

        // Save draft for recovery
        saveDraft();

        // ‡πÅ‡∏™‡∏î‡∏á Error with recovery option
        showErrorMessageWithRecovery(error.message);

        throw error;
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    function showSuccessMessage(result) {
      const contractNo = result.data?.contractNo || result.data?.contractNumber || result.contractNo || result.contractNumber || 'N/A';
    
      // üÜï ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      updateDocumentStatus('quotationStatus', 'completed');
      updateDocumentStatus('invoiceStatus', 'completed');
      updateDocumentStatus('receiptStatus', 'completed');
      updateDocumentStatus('receiptVoucherStatus', 'completed');
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      updateDocumentStatus('taxInvoiceStatusDoc', 'completed');
    
      updateDocumentStatus('deliveryNoteStatus', 'completed');
    
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
          html: `
            <div>
              <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤: <strong>${contractNo}</strong></p>
              <p class="text-sm text-gray-600 mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
            </div>
          `,
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#10b981'
        }).then(() => {
          // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          document.querySelectorAll('#btnDownloadQuotation, #btnDownloadInvoice, #btnDownloadDeliveryNote, #btnDownloadReceiptOnly, #btnDownloadTaxInvoiceOnly')
            .forEach(btn => btn.disabled = false);
    
          // ‡πÅ‡∏™‡∏î‡∏á Success Modal (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          const modal = document.getElementById('successModal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      } else {
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${contractNo}`);
        // üö´ ‡∏•‡∏ö window.location.reload() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        document.querySelectorAll('#btnDownloadQuotation, #btnDownloadInvoice, #btnDownloadDeliveryNote, #btnDownloadReceiptOnly, #btnDownloadTaxInvoiceOnly')
          .forEach(btn => btn.disabled = false);
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error with recovery option
    function showErrorMessageWithRecovery(message) {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
          html: `
            <div>
              <p>${escapeHtml(message)}</p>
              <p class="text-sm text-gray-600 mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</p>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#3b82f6',
          cancelButtonColor: '#6b7280'
        }).then((result) => {
          if (result.isConfirmed) {
            // Retry submission
            submitInstallmentToBackend();
          }
        });
      } else {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`);
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error (original function for backward compatibility)
    function showErrorMessage(message) {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
          text: message,
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#ef4444'
        });
      } else {
        alert(`Error: ${message}`);
      }
    }
    
    // ==========================================
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤" ‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéØ Connecting Create Contract button to backend...');
    
      const createContractBtn = document.getElementById('btnCreateContract');
      if (createContractBtn) {
        createContractBtn.addEventListener('click', async function(e) {
          e.preventDefault();
    
          console.log('üìù Create Contract button clicked');
    
          // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤
          if (typeof Swal !== 'undefined') {
            const confirm = await Swal.fire({
              title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤',
              text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
              cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
              confirmButtonColor: '#3b82f6',
              cancelButtonColor: '#6b7280'
            });
    
            if (!confirm.isConfirmed) return;
          } else {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞?')) return;
          }
    
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Progress Steps
          resetProgressSteps();

          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
          try {
            await submitInstallmentToBackend();
          } catch (error) {
            console.error('Failed to create contract:', error);
          }
        });
    
        console.log('‚úÖ Create Contract button connected to backend submission');
      } else {
        console.warn('‚ö†Ô∏è Create Contract button not found');
      }
    });
    
    // üîß Debug function for attachments
    window.debugStep4Attachments = function() {
      console.log('üîç Debugging Step 4 attachments...');
      const stepData = window.globalInstallmentManager?.getStepData(2);
      console.log('üìã Step data:', stepData);
      console.log('üìé Attachments:', stepData?.attachments);
      if (stepData?.attachments) {
        Object.keys(stepData.attachments).forEach(key => {
          console.log(`   ${key}:`, typeof stepData.attachments[key], stepData.attachments[key]);
        });
      }
    };
    
    // üîß Debug function for customer data validation
    window.debugCustomerData = function() {
      console.log('üîç Debugging customer data validation...');
      const customerData = window.globalInstallmentManager?.getStepData(1);
      console.log('üë§ Customer data:', customerData);
    
      // Check required fields
      const requiredFields = ['firstName', 'lastName', 'idNumber', 'phoneNumber'];
      requiredFields.forEach(field => {
        const value = customerData?.[field];
        console.log(`   ${field}:`, value ? '‚úÖ' : '‚ùå', value);
      });
    
      // Check all step data
      console.log('üìä All steps data:');
      for (let i = 1; i <= 4; i++) {
        const stepData = window.globalInstallmentManager?.getStepData(i);
        console.log(`   Step ${i}:`, stepData);
      }
    
      return customerData;
    };
    
    // üó∫Ô∏è Debug function for coordinates
    window.debugStep4Coordinates = function() {
      console.log('üîç Debugging Step 4 coordinates...');
      const stepData = window.globalInstallmentManager?.getStepData(2);
      console.log('üìã Customer data:', stepData);
    
      if (stepData) {
        console.log('üó∫Ô∏è Coordinate fields found:');
        console.log('   coordinates:', stepData.coordinates);
        console.log('   customerCoordinates:', stepData.customerCoordinates);
        console.log('   latitude:', stepData.latitude);
        console.log('   customerLatitude:', stepData.customerLatitude);
        console.log('   longitude:', stepData.longitude);
        console.log('   customerLongitude:', stepData.customerLongitude);
        console.log('   customerMapUrl:', stepData.customerMapUrl);
    
        // Check what's currently displayed
        console.log('üì∫ Currently displayed:');
        console.log('   modalCoordinates:', document.getElementById('modalCoordinates')?.textContent);
        console.log('   modalLatitude:', document.getElementById('modalLatitude')?.textContent);
        console.log('   modalLongitude:', document.getElementById('modalLongitude')?.textContent);
        console.log('   modalMapUrl:', document.getElementById('modalMapUrl')?.textContent);
      }
    };
    
    // üîß Enhanced coordinate display function
    window.updateCoordinateDisplay = function(coordinateData) {
      console.log('üó∫Ô∏è Updating coordinate display with:', coordinateData);
    
      // Update coordinates
      const coordsElement = document.getElementById('modalCoordinates');
      if (coordsElement) {
        coordsElement.textContent = coordinateData.coordinates || coordinateData.customerCoordinates || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    
      // Update latitude
      const latElement = document.getElementById('modalLatitude');
      if (latElement) {
        latElement.textContent = coordinateData.latitude || coordinateData.customerLatitude || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    
      // Update longitude
      const lngElement = document.getElementById('modalLongitude');
      if (lngElement) {
        lngElement.textContent = coordinateData.longitude || coordinateData.customerLongitude || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    
      // Update Google Maps URL
      const mapUrlElement = document.getElementById('modalMapUrl');
      if (mapUrlElement && coordinateData.customerMapUrl) {
        mapUrlElement.innerHTML = `<a href="${coordinateData.customerMapUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">${coordinateData.customerMapUrl}</a>`;
      } else if (mapUrlElement) {
        mapUrlElement.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    
      console.log('‚úÖ Coordinate display updated');
    };
    
    // üß™ Test function to set sample coordinates
    window.setTestCoordinates = function() {
      console.log('üß™ Setting test coordinates...');
      const testData = {
        coordinates: '7.0000000, 100.0000000',
        customerCoordinates: '7.0000000, 100.0000000',
        latitude: '7.0000000',
        customerLatitude: '7.0000000',
        longitude: '100.0000000',
        customerLongitude: '100.0000000',
        customerMapUrl: 'https://maps.google.com/?q=7.0000000,100.0000000'
      };
    
      window.updateCoordinateDisplay(testData);
    };
    
    // ‚úÖ User Data Validation - Check Only, No Hardcode
    console.log('üïê Step 4 loaded at:', new Date().toISOString());
    
    // ÔøΩ User Data Validation Function
    function validateUserAuthentication() {
      console.log('üîç Validating user authentication...');
    
      const authToken = localStorage.getItem('authToken');
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const branchInfo = JSON.parse(localStorage.getItem('branchInfo') || '{}');
    
      const validationResults = {
        hasAuthToken: !!authToken,
        hasUserInfo: Object.keys(userInfo).length > 0,
        hasBranchInfo: Object.keys(branchInfo).length > 0,
        userHasId: !!(userInfo.id || userInfo.user_id),
        userHasName: !!(userInfo.name || userInfo.fullName),
        issues: []
      };
    
      if (!validationResults.hasAuthToken) {
        validationResults.issues.push('No authentication token found');
      }
    
      if (!validationResults.hasUserInfo) {
        validationResults.issues.push('No user information in localStorage');
      }
    
      if (!validationResults.userHasId) {
        validationResults.issues.push('User ID missing from userInfo');
      }
    
      if (!validationResults.userHasName) {
        validationResults.issues.push('User name missing from userInfo');
      }
    
      console.log('üìä Authentication Validation Results:', validationResults);
    
      if (validationResults.issues.length > 0) {
        console.warn('‚ö†Ô∏è Authentication Issues Found:');
        validationResults.issues.forEach(issue => console.warn(`   - ${issue}`));
        console.warn('üí° Suggestion: Check login process and ensure user data is properly saved');
      } else {
        console.log('‚úÖ Authentication validation passed');
      }
    
      return validationResults;
    }
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener('DOMContentLoaded', function() {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ authentication ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏°
      setTimeout(() => {
        validateUserAuthentication();
      }, 1000);
    });
    
    // Add comprehensive data validation debug function
    window.validateAllStepData = function() {
      console.log('üîç === COMPREHENSIVE DATA VALIDATION ===');
    
      // Check step 1 (customer data)
      const step1Data = window.globalInstallmentManager?.getStepData(1);
      console.log('üìã Step 1 (Customer Data):', step1Data);
    
      if (step1Data) {
        const requiredCustomerFields = ['firstName', 'lastName', 'idNumber', 'phoneNumber'];
        console.log('üë§ Customer field validation:');
        requiredCustomerFields.forEach(field => {
          const value = step1Data[field];
          const status = value && value.trim() ? '‚úÖ' : '‚ùå';
          console.log(`   ${field}: ${status} "${value}"`);
        });
      }
    
      // Check step 2 (attachments)
      const step2Data = window.globalInstallmentManager?.getStepData(2);
      console.log('üìé Step 2 (Attachments):', step2Data);
    
      // Check step 3 (product data)
      const step3Data = window.globalInstallmentManager?.getStepData(3);
      console.log('üì¶ Step 3 (Product Data):', step3Data);
    
      // Check step 4 (contract data)
      const step4Data = window.globalInstallmentManager?.getStepData(4);
      console.log('üìÑ Step 4 (Contract Data):', step4Data);
    
      return {
        step1: step1Data,
        step2: step2Data,
        step3: step3Data,
        step4: step4Data
      };
    };
  </script>

  <!-- Loading System -->
  <script>
    let lottieAnimation = null;

    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // Backward compatibility functions
    function showStep4Loading(show = true) {
      showLoading(show);
    }

    function hideStep4Loading() {
      showLoading(false);
    }

    // Show loading on page load
    document.addEventListener('DOMContentLoaded', function() {
      showLoading(true);

      // Hide loading after page is fully loaded
      setTimeout(() => {
        showLoading(false);
      }, 1500);
    });

    // üö´ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô beforeunload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    // Show loading when navigating away - DISABLED
    /*
    window.addEventListener('beforeunload', function() {
      showLoading(true);
    });
    */

    // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Progress Steps
    function updateProgressStep(stepId, status) {
      const stepElement = document.getElementById(stepId);
      if (!stepElement) {
        console.warn(`‚ö†Ô∏è Progress step element not found: ${stepId}`);
        return;
      }

      // ‡∏•‡∏ö class ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤
      stepElement.classList.remove('processing', 'completed', 'error');

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
      if (status !== 'pending') {
        stepElement.classList.add(status);
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° icon ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      const iconElement = stepElement.querySelector('.progress-step-icon');
      if (iconElement) {
        switch(status) {
          case 'processing':
            iconElement.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
            break;
          case 'completed':
            iconElement.innerHTML = '‚úì';
            break;
          case 'error':
            iconElement.innerHTML = '‚úó';
            break;
          default:
            // Reset to original number
            const stepNumber = stepId.split('-')[1] === 'stock' ? '1' :
                             stepId.split('-')[1] === 'validate' ? '2' :
                             stepId.split('-')[1] === 'contract' ? '3' :
                             stepId.split('-')[1] === 'documents' ? '4' : '5';
            iconElement.innerHTML = stepNumber;
        }
      }

      console.log(`üìä Progress step updated: ${stepId} -> ${status}`);
    }

    // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤
    function simulateDelay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Progress Steps
    function resetProgressSteps() {
      const steps = ['step-stock', 'step-validate', 'step-contract', 'step-documents', 'step-email'];
      steps.forEach(stepId => {
        updateProgressStep(stepId, 'pending');
      });
      console.log('üîÑ Progress steps reset to pending');
    }

    // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    function showRealTimeStatus(message, type = 'info') {
      const statusContainer = document.getElementById('realtime-status');
      if (statusContainer) {
        const statusClass = type === 'success' ? 'text-green-600' :
                          type === 'error' ? 'text-red-600' :
                          type === 'warning' ? 'text-yellow-600' : 'text-blue-600';

        statusContainer.innerHTML = `<div class="${statusClass} text-sm animate-pulse">${message}</div>`;

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setTimeout(() => {
          if (statusContainer.innerHTML.includes(message)) {
            statusContainer.innerHTML = '';
          }
        }, 3000);
      }
    }

    // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
    function displayStockDeductionDetails(stockDeductionLog) {
      const stockUpdateDetails = document.getElementById('stockUpdateDetails');
      const stockUpdateList = document.getElementById('stockUpdateList');

      if (!stockUpdateDetails || !stockUpdateList || !Array.isArray(stockDeductionLog)) {
        return;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å
      let stockHtml = '';
      stockDeductionLog.forEach((result, index) => {
        const statusIcon = result.success ?
          '<i class="bi bi-check-circle-fill text-green-600"></i>' :
          '<i class="bi bi-x-circle-fill text-red-600"></i>';

        const statusText = result.success ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
        const statusClass = result.success ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300';

        stockHtml += `
          <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border">
            <div class="flex items-center gap-2">
              ${statusIcon}
              <span class="font-medium">${escapeHtml(result.item)}</span>
            </div>
            <span class="${statusClass} text-xs">${statusText}</span>
          </div>
        `;

        if (result.success && result.message) {
          stockHtml += `<div class="text-xs text-gray-600 dark:text-gray-400 ml-6 mb-1">${escapeHtml(result.message)}</div>`;
        }

        if (!result.success && result.error) {
          stockHtml += `<div class="text-xs text-red-600 dark:text-red-400 ml-6 mb-1">${escapeHtml(result.error)}</div>`;
        }
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
      stockUpdateList.innerHTML = stockHtml;
      stockUpdateDetails.style.display = 'block';

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏á 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        stockUpdateDetails.style.display = 'none';
      }, 10000);

      console.log('‚úÖ Stock deduction details displayed:', stockDeductionLog);
    }

    // üö´ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à
    let isProcessingContract = false;

    function setProcessingStatus(status) {
      isProcessingContract = status;
      console.log(`üîí Contract processing status: ${status}`);
    }

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
    window.addEventListener('beforeunload', function(e) {
      if (isProcessingContract) {
        const message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ';
        e.preventDefault();
        e.returnValue = message;
        return message;
      }
    });

    // üö´ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô event listeners ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£ redirect ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    // Show loading for form submissions and AJAX requests - DISABLED
    /*
    document.addEventListener('submit', function() {
      showLoading(true);
    });
    */

    // Show loading for navigation links - DISABLED
    /*
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a[href]');
      if (link && !link.hasAttribute('download') &&
          !link.href.startsWith('javascript:') &&
          !link.href.startsWith('mailto:') &&
          !link.href.startsWith('tel:') &&
          link.target !== '_blank') {
        showLoading(true);
      }
    });
    */
  </script>

  </body>
  </html> 