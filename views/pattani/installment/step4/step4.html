<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบผ่อน Pattani - Step 4: เสร็จสิ้น</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />

  <!-- Include Shared CSS Files -->
  <!-- Disabled: Using inline CSS for stepper like step1 -->
  <!-- <link rel="stylesheet" href="/views/pattani/installment/shared/css/stepper-common.css?v=4.0"> -->
  <link rel="stylesheet" href="/views/pattani/installment/shared/css/common-styles.css">

  <!-- Include Shared JavaScript Files -->
  <script src="/views/pattani/installment/shared/js/common-utils.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Enhanced Tailwind CSS production warning suppression
    const originalWarn = console.warn;
    const originalLog = console.log;
    const originalError = console.error;

    // Suppress console.warn messages
    console.warn = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalWarn.apply(console, args);
    };

    // Suppress console.log messages for Tailwind warnings
    console.log = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalLog.apply(console, args);
    };

    // Suppress console.error messages for Tailwind warnings
    console.error = function(...args) {
      const msg = args.join(' ');
      if (msg && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com') ||
        msg.includes('tailwindcss.com/docs/installation') ||
        msg.includes('To use Tailwind CSS in production')
      )) {
        return; // Suppress Tailwind production warnings
      }
      return originalError.apply(console, args);
    };

    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>
  
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Installment System Styles - Complete Inline -->
  <style>
    /* ========== INSTALLMENT SYSTEM SPECIFIC STYLES ========== */
    /* ไฟล์ CSS เฉพาะสำหรับระบบผ่อน Pattani */

    /* ========== PERFORMANCE OPTIMIZATIONS ========== */
    .stepper,
    .step-icon,
    .loading-spinner,
    .card,
    .toast,
    .modal,
    .dropdown {
      will-change: transform, opacity;
    }

    .card,
    .product-card,
    .modal-box,
    .step-content {
      contain: layout style paint;
    }

    /* ========== STEPPER STYLES ========== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #94a3b8;
      z-index: 2;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .step.active .step-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .step.completed .step-icon {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Combined step-text and step-label styles */

    /* ========== CARD STYLES ========== */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    /* Dark mode card */
    .dark .card {
      background: #1f2937;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .dark .card-title {
      color: #f1f5f9;
    }

    /* ========== BUTTON STYLES ========== */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 0.625rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    /* ========== TOAST STYLES ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    /* Dark mode toast */
    .dark .toast {
      background: #374151;
      color: #f3f4f6;
    }

  </style>

  <!-- Stepper Styles - Consistent with other steps -->
  <style>
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .dark .stepper::before {
      background: #4b5563;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: #4361ee;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      z-index: 2;
      position: relative;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .step.active .step-icon {
      background: #4361ee;
      color: white;
      border-color: #4361ee;
      transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
    }

    .step.completed .step-icon {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .step.completed .step-icon::before {
      content: '✓';
      font-size: 18px;
      font-weight: bold;
    }

    .step-text {
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      text-align: center;
      transition: color 0.3s ease;
      line-height: 1.2;
    }

    .step.active .step-text {
      color: #4361ee;
      font-weight: 600;
    }

    .step.completed .step-text {
      color: #10b981;
      font-weight: 600;
    }

    .dark .stepper {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border-color: #374151 !important;
    }

    .dark .step-icon {
      background: #374151 !important;
      color: #9ca3af !important;
    }

    .dark .step.active .step-icon {
      background: #2563eb !important;
      color: white !important;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2) !important;
    }

    .dark .step.completed .step-icon {
      background: #059669 !important;
      color: white !important;
    }

    .dark .step-text {
      color: #9ca3af !important;
    }

    .dark .step.active .step-text {
      color: #60a5fa !important;
    }

    .dark .step.completed .step-text {
      color: #34d399 !important;
    }
  </style>
  
  <!-- Step 4 Specific Styles -->
  <style>
    /* Clean White Summary Cards */
    .summary-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      transition: all 0.3s ease;
    }

    .summary-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border-color: #e2e8f0;
    }
    
    .summary-card.completed {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border-color: #10b981;
    }

    .summary-card.processing {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
      animation: pulse 2s infinite;
    }
    
    .summary-card.error {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: #ef4444;
    }

    /* Card title consistency */
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
    }

    .dark .card-title {
      color: #f3f4f6;
    }
    
    /* Document Status */
    .document-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .document-status.pending {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .document-status.generating {
      background: #fef3c7;
      color: #92400e;
      animation: pulse 1s infinite;
    }
    
    .document-status.ready {
      background: #d1fae5;
      color: #065f46;
    }
    
    .document-status.error {
      background: #fecaca;
      color: #991b1b;
    }
    
    /* Clean Payment Summary */
    .payment-summary {
      background: white;
      color: #1f2937;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      border: 1px solid #f1f5f9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .payment-amount {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 1rem 0;
      color: #3b82f6;
    }
    
    /* Action Buttons - Using DaisyUI for consistency */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      min-height: 3rem;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      border-color: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
      border-color: #9ca3af;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .btn-success:hover {
      background: #059669;
      border-color: #059669;
    }

    .btn-outline {
      background: transparent;
      color: #374151;
      border-color: #d1d5db;
    }

    .btn-outline:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-block {
      width: 100%;
    }

    /* Dark mode button styles */
    .dark .btn-secondary {
      background: #374151;
      color: #d1d5db;
      border-color: #4b5563;
    }

    .dark .btn-secondary:hover {
      background: #4b5563;
      border-color: #6b7280;
    }

    .dark .btn-outline {
      color: #d1d5db;
      border-color: #4b5563;
    }

    .dark .btn-outline:hover {
      background: #374151;
      border-color: #6b7280;
    }
    
    /* Progress Indicator */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      position: relative;
    }
    
    .progress-step::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      right: -40%;
      height: 2px;
      background: #e5e7eb;
      z-index: 1;
    }

    .progress-step:last-child::after {
      display: none;
    }
    
    .progress-step.completed::after {
      background: #10b981;
    }
    
    .progress-step.processing::after {
      background: #f59e0b;
    }
    
    .progress-step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      z-index: 2;
      position: relative;
    }
    
    .progress-step.completed .progress-step-icon {
      background: #10b981;
      color: white;
    }

    .progress-step.processing .progress-step-icon {
      background: #f59e0b;
      color: white;
      animation: pulse 1s infinite;
    }
    
    .progress-step.error .progress-step-icon {
      background: #ef4444;
      color: white;
    }
    
    /* Responsive สำหรับ 5 steps */
    @media (max-width: 768px) {
      .progress-steps {
        flex-wrap: wrap;
        gap: 1rem;
      }
      
      .progress-step {
        flex-basis: calc(50% - 0.5rem);
        margin-bottom: 1rem;
      }
      
      .progress-step::after {
        display: none;
      }
      
      .progress-step:nth-child(3) {
        flex-basis: 100%;
      }
    }
    
    /* Enhanced Dark Mode Support - Consistent with other steps */
    .dark body {
      background-color: #111827;
      color: #f3f4f6;
    }

    .dark #mainContent {
      background-color: #111827;
    }

    .dark .summary-card {
      background: #1f2937;
      border-color: #374151;
      color: #f3f4f6;
    }

    .dark .summary-card.completed {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      border-color: #059669;
    }
    
    .dark .summary-card.processing {
      background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
      border-color: #d97706;
    }
    
    .dark .summary-card.error {
      background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
      border-color: #ef4444;
    }

    /* Payment summary dark mode */
    .dark .payment-summary {
      background: linear-gradient(135deg, #10b981 0%, #047857 100%);
      border-color: #22c55e;
    }

    /* Document status dark mode */
    .dark .document-status.pending {
      background: #374151;
      color: #9ca3af;
    }
    
    .dark .document-status.generating {
      background: #92400e;
      color: #fbbf24;
    }
    
    .dark .document-status.ready {
      background: #065f46;
      color: #34d399;
    }
    
    .dark .document-status.error {
      background: #991b1b;
      color: #f87171;
    }

    /* Progress step dark mode */
    .dark .progress-step-icon {
      background: #374151;
      color: #9ca3af;
    }
    
    .dark .progress-step.completed .progress-step-icon {
      background: #059669;
      color: white;
    }

    .dark .progress-step.processing .progress-step-icon {
      background: #d97706;
      color: white;
    }

    /* Modal dark mode */
    .dark .modal-box {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
    }

    .dark .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    /* Input and form elements dark mode */
    .dark .input,
    .dark .select,
    .dark .textarea {
      background-color: #374151 !important;
      border-color: #4b5563 !important;
      color: #f3f4f6 !important;
    }

    .dark .input:focus,
    .dark .select:focus,
    .dark .textarea:focus {
      border-color: #2563eb !important;
      box-shadow: 0 0 0 1px #2563eb !important;
    }

    /* Text colors dark mode */
    .dark .text-gray-600 {
      color: #9ca3af !important;
    }

    .dark .text-gray-700 {
      color: #d1d5db !important;
    }

    .dark .text-gray-800 {
      color: #e5e7eb !important;
    }

    .dark .text-gray-900 {
      color: #f3f4f6 !important;
    }

    /* Border colors dark mode */
    .dark .border-gray-200 {
      border-color: #374151 !important;
    }

    .dark .border-gray-300 {
      border-color: #4b5563 !important;
    }

    /* Background colors dark mode */
    .dark .bg-white {
      background-color: #1f2937 !important;
    }

    .dark .bg-gray-50 {
      background-color: #374151 !important;
    }

    .dark .bg-blue-50 {
      background-color: #1e3a8a !important;
    }

    .dark .bg-green-50 {
      background-color: #14532d !important;
    }

    .dark .bg-yellow-50 {
      background-color: #92400e !important;
    }

    .dark .bg-red-50 {
      background-color: #991b1b !important;
    }

    /* Container dark mode */
    .dark .container-fluid {
      background-color: transparent !important;
    }

    /* Main content dark mode */
    .dark main {
      background-color: #111827 !important;
      color: #f3f4f6 !important;
    }

    /* Responsive Layout with Sidebar - Consistent with other steps */
    #mainContent {
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Container for padding consistency */
    .container-fluid {
      width: 100%;
      max-width: 100%;
      padding: 1rem;
    }

    /* Mobile responsive sidebar */
    @media (max-width: 768px) {
      #mainContent {
        margin-left: 0 !important;
      }
      
      .payment-amount {
        font-size: 2rem;
      }

      .summary-card {
      padding: 1rem;
      }
      
      .progress-steps {
        flex-direction: column;
        gap: 1rem;
      }
      
      .progress-step::after {
        display: none;
      }
    }

    #mainContent.ml-0 {
      margin-left: 0 !important;
    }

    #mainContent.ml-64 {
      margin-left: 16rem !important;
    }

    /* Enhanced sidebar */
    .sidebar-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    /* Stepper margin consistency */
    .stepper {
      margin-bottom: 2rem;
    }

    /* Card consistency */
    .card {
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      background: white;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .dark .card {
      background: #1f2937;
      border-color: #374151;
    }

    /* ========== LOADING OVERLAY STYLES ========== */
    @keyframes pulse {
      0% { opacity: .75;}
      50%{ opacity: 1;}
      100%{ opacity: .75;}
    }
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <!-- Animate.css for loading animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie.js for animated loading icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-64">
    <!-- Header with Clean Design -->
    <header class="p-6 bg-white border-b border-gray-100 flex items-center justify-between shadow-sm">
      <div class="flex items-center gap-4">
        <!-- Company Logo -->
        <img src="/uploads/Logo2.png" alt="2 พี่น้อง โมบาย" class="h-12 w-auto">
        <div class="border-l border-gray-200 pl-4">
          <h1 class="text-xl font-light text-gray-800" id="pageTitle">สรุปและชำระเงิน</h1>
          <p class="text-sm text-gray-500" id="branchInfo">กำลังโหลดสาขา...</p>
        </div>
      </div>
      
      <!-- Progress Indicator -->
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
          ขั้นตอนที่ <span class="font-semibold text-blue-600">4</span> จาก 4
            </div>
        <div class="w-16 h-16">
          <svg class="w-full h-full" viewBox="0 0 36 36">
            <path class="progress-ring progress-ring-background" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#f1f5f9" stroke-width="2" fill="transparent"/>
            <path class="progress-ring progress-ring-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#3b82f6" stroke-width="2" stroke-dasharray="100, 100" fill="transparent"/>
          </svg>
          <div class="text-center mt-1 text-xs text-gray-400">100%</div>
          </div>
        </div>
    </header>

    <!-- Content with Clean White Theme -->
    <main class="flex-1 overflow-y-auto bg-white">
      <div class="container-fluid p-6">
        <!-- Include Shared Stepper Template -->
        <!-- Stepper Navigation -->
        <div class="stepper" role="navigation" aria-label="ขั้นตอนการทำงาน">
            <div class="step completed" data-step="1" role="tab" aria-selected="false" aria-label="ขั้นตอนที่ 1 เลือกสินค้า">
              <div class="step-icon" aria-hidden="true">✓</div>
              <div class="step-text">เลือกสินค้า</div>
            </div>
            <div class="step completed" data-step="2" role="tab" aria-selected="false" aria-label="ขั้นตอนที่ 2 ข้อมูลลูกค้า">
              <div class="step-icon" aria-hidden="true">✓</div>
              <div class="step-text">ข้อมูลลูกค้า</div>
            </div>
            <div class="step completed" data-step="3" role="tab" aria-selected="false" aria-label="ขั้นตอนที่ 3 รายละเอียดผ่อน">
              <div class="step-icon" aria-hidden="true">✓</div>
              <div class="step-text">รายละเอียดผ่อน</div>
            </div>
            <div class="step active" data-step="4" role="tab" aria-selected="true" aria-label="ขั้นตอนที่ 4 ยืนยันและพิมพ์">
              <div class="step-icon" aria-hidden="true">4</div>
              <div class="step-text">ยืนยันและพิมพ์</div>
            </div>
          </div>
        
        <script>
          // Simple navigation function
          function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= 4) {
              window.location.href = `/step${stepNumber}`;
            }
          }
        </script>

        <!-- Main Content -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          
          <!-- Left Column: Summary Information -->
          <div class="xl:col-span-2 space-y-6">
            
            <!-- Contract Summary -->
            <div class="summary-card">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-file-earmark-text text-blue-600"></i>
                สรุปสัญญาผ่อนชำระ
              </h3>
              
              <div id="contractSummary" class="space-y-4">
                <!-- Contract details will be loaded here -->
              </div>
              </div>

            <!-- Customer Information -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="bi bi-person-fill text-green-600"></i>
                  ข้อมูลลูกค้า
                </div>
                <div class="flex gap-2">
                  <button id="btnViewFullCustomerDetails" class="btn btn-sm btn-outline">
                    <i class="bi bi-eye"></i>
                    <span>ดูเพิ่มเติม</span>
                  </button>
                  <button id="btnDebugCustomerData" class="btn btn-sm btn-info" style="font-size: 10px;">
                    <i class="bi bi-bug"></i>
                    <span>Debug</span>
                  </button>
                </div>
              </h3>
              
              <div id="customerSummary" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Customer details will be loaded here -->
              </div>
              </div>

            <!-- Items Summary -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-cart-fill text-purple-600"></i>
                รายการสินค้า
              </h3>
              
              <div id="itemsSummary" class="space-y-3">
                <!-- Items will be loaded here -->
              </div>
              </div>

            <!-- Payment Plan Summary -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-credit-card text-orange-600"></i>
                แผนการชำระเงิน
              </h3>
              
              <div id="paymentPlanSummary" class="space-y-3">
                <!-- Payment plan details will be loaded here -->
            </div>
          </div>
        </div>

          <!-- Right Column: Actions & Documents -->
          <div class="space-y-6">
            
            <!-- Payment Summary -->
            <div class="payment-summary">
              <h3 class="text-lg font-bold mb-2">ยอดชำระวันนี้</h3>
              <div class="payment-amount" id="todayPaymentAmount">฿0.00</div>
              <div class="space-y-1 text-xs text-gray-600">
                <div id="paymentBreakdown">
                  <div class="font-medium">เงินดาวน์: <span id="downPaymentDisplay">฿0.00</span></div>
                  <div id="docFeeDisplay" style="display: none;">ค่าธรรมเนียมเอกสาร: <span>฿0.00</span></div>
                  <div id="taxDisplay" style="display: none;">ภาษี (VAT 7%): <span>฿0.00</span></div>
                </div>
              </div>
            </div>

            <!-- Process Status -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-gear-fill text-blue-600"></i>
                สถานะการดำเนินการ
              </h3>
              
              <div class="progress-steps">
                <div class="progress-step" id="step-stock">
                  <div class="progress-step-icon">1</div>
                  <span class="text-xs">ตรวจสอบสต๊อก</span>
                </div>
                <div class="progress-step" id="step-validate">
                  <div class="progress-step-icon">2</div>
                  <span class="text-xs">ตรวจสอบข้อมูล</span>
                </div>
                <div class="progress-step" id="step-contract">
                  <div class="progress-step-icon">3</div>
                  <span class="text-xs">สร้างสัญญา</span>
                </div>
                <div class="progress-step" id="step-documents">
                  <div class="progress-step-icon">4</div>
                  <span class="text-xs">สร้างเอกสาร</span>
                </div>
                <div class="progress-step" id="step-email">
                  <div class="progress-step-icon">5</div>
                  <span class="text-xs">ส่งอีเมล</span>
        </div>
      </div>

              <!-- 🆕 Real-time Status Container -->
              <div id="realtime-status" class="mt-3 text-center min-h-[24px]">
                <!-- Real-time status messages will appear here -->
              </div>

              <div id="statusMessage" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
                <i class="bi bi-info-circle text-blue-600"></i>
                <span class="text-sm">พร้อมดำเนินการ (รวมตัดสต๊อกอัตโนมัติ)</span>
              </div>
              
              <!-- รายละเอียดการตัดสต็อก (✅ ENABLED - เปิดใช้งานแล้ว) -->
              <div id="stockUpdateDetails" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg" style="display: none;">
                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2 flex items-center gap-2">
                  <i class="bi bi-box-seam"></i>
                  รายละเอียดการตัดสต๊อก
              </h4>
                <div id="stockUpdateList" class="space-y-1 text-sm">
                  <!-- Stock update details will appear here -->
                  </div>
                </div>
                  </div>

            <!-- Document Generation -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-file-earmark-pdf text-red-600"></i>
                เอกสาร
              </h3>
              
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm">ใบเสนอราคา:</span>
                  <div class="document-status pending" id="quotationStatus">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div>

                <div class="flex justify-between items-center">
                  <span class="text-sm">ใบแจ้งหนี้:</span>
                  <div class="document-status pending" id="invoiceStatus">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div>

                <div class="flex justify-between items-center">
                  <span class="text-sm">ใบเสร็จรับเงิน:</span>
                  <div class="document-status pending" id="receiptStatus">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div>

                <div class="flex justify-between items-center" id="taxInvoiceRow">
                  <span class="text-sm">ใบกำกับภาษี:</span>
                  <div class="document-status pending" id="taxInvoiceStatusDoc">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div>

                <!-- ซ่อนใบสำคัญรับเงิน -->
                <!-- <div class="flex justify-between items-center">
                  <span class="text-sm">ใบสำคัญรับเงิน:</span>
                  <div class="document-status pending" id="receiptVoucherStatus">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div> -->

                <div class="flex justify-between items-center">
                  <span class="text-sm">ใบส่งของ:</span>
                  <div class="document-status pending" id="deliveryNoteStatus">
                    <i class="bi bi-clock"></i>
                    <span>รอดำเนินการ</span>
                </div>
              </div>
            </div>
          </div>

            <!-- Payment Method Display (from Step 3) -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-cash-coin text-green-600"></i>
                วิธีการชำระเงิน
              </h3>
              
              <div id="paymentMethodDisplay" class="p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                  <i class="bi bi-info-circle text-blue-600"></i>
                  <div>
                    <p class="text-sm text-gray-600">วิธีการชำระที่เลือกจาก Step 3:</p>
                    <p id="selectedPaymentMethod" class="font-semibold text-lg">กรุณาเลือกวิธีการชำระใน Step 3</p>
                  </div>
                </div>
                
                <!-- แสดงรายละเอียดถ้าเป็นการชำระแบบผสม -->
                <div id="mixedPaymentDisplayStep4" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                  <h4 class="font-medium mb-2 text-sm">รายละเอียดการชำระแบบผสม:</h4>
                  <div id="mixedPaymentBreakdown" class="space-y-1 text-sm">
                    <!-- จะถูกเติมด้วย JavaScript -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="summary-card">
              <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-lightning-fill text-yellow-600"></i>
                การดำเนินการ
              </h3>
              
              <div class="space-y-3">
                <button id="btnCreateContract" class="btn btn-primary btn-block">
                  <i class="bi bi-file-earmark-plus"></i>
                  <span>สร้างสัญญาผ่อนชำระ</span>
                </button>
                
                <!-- แสดงสถานะการสร้างสัญญา -->
                <div id="contractCreationStatus" class="mt-2 p-3 rounded-lg text-center bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-400" style="display: none;">
                  <i class="bi bi-info-circle"></i>
                  <span class="text-sm">กรุณาสร้างสัญญาก่อนดาวน์โหลดเอกสาร</span>
                </div>
                
                <div id="documentsSection" class="space-y-2" style="display: none;">
                  <button id="btnDownloadQuotation" class="btn btn-secondary btn-block" disabled>
                    <i class="bi bi-download"></i>
                    <span>ดาวน์โหลดใบเสนอราคา</span>
                </button>
                
                  <!-- ปุ่มใบแจ้งหนี้ -->
                  <button id="btnDownloadInvoice" class="btn btn-secondary btn-block" disabled>
                    <i class="bi bi-download"></i>
                    <span>ดาวน์โหลดใบแจ้งหนี้</span>
                </button>

                  <!-- ปุ่มใบส่งของ -->
                  <button id="btnDownloadDeliveryNote" class="btn btn-info btn-block" disabled>
                    <i class="bi bi-truck"></i>
                    <span>ดาวน์โหลดใบส่งของ</span>
                </button>
                
                  <!-- ปุ่มใบเสร็จรับเงิน -->
                  <button id="btnDownloadReceiptOnly" class="btn btn-success btn-block" disabled>
                    <i class="bi bi-receipt"></i>
                    <span>ดาวน์โหลดใบเสร็จรับเงิน</span>
                  </button>
                  
                  <!-- ปุ่มใบกำกับภาษี -->
                  <button id="btnDownloadTaxInvoiceOnly" class="btn btn-primary btn-block" disabled>
                    <i class="bi bi-file-text"></i>
                    <span>ดาวน์โหลดใบกำกับภาษี</span>
                  </button>
                
                  <!-- ปุ่มพิมพ์เอกสารสำหรับค่าดาวน์ -->
                  <div class="border-t pt-2 mt-2">
                    <p class="text-xs text-gray-500 mb-2">สำหรับค่าดาวน์ (ชำระวันนี้)</p>
                    <div class="grid grid-cols-1 gap-2">
                      <button id="btnPrintDownPaymentReceipt" class="btn btn-outline btn-block" disabled style="display: none;">
                        <i class="bi bi-printer"></i>
                        <span>พิมพ์ใบเสร็จรับเงิน (ค่าดาวน์)</span>
                      </button>
                      <button id="btnPrintDownPaymentTaxInvoice" class="btn btn-outline btn-block" disabled style="display: none;">
                        <i class="bi bi-receipt"></i>
                        <span>พิมพ์ใบกำกับภาษี (ค่าดาวน์)</span>
                      </button>
                    </div>
                  </div>
                  
                  <!-- ปุ่มส่งอีเมล -->
                  <button id="btnSendEmail" class="btn btn-success btn-block" disabled>
                    <i class="bi bi-envelope"></i>
                    <span>ส่งเอกสารทาง Email</span>
                  </button>
                </div>

                <!-- ปุ่มจัดการอื่นๆ -->
                <div class="border-t pt-3 mt-4">
                  <button id="btnStartOver" class="btn btn-outline btn-block">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>เริ่มใหม่</span>
                  </button>
                  
                  <button id="btnGoToHistory" class="btn btn-outline btn-block mt-2">
                    <i class="bi bi-clock-history"></i>
                    <span>ดูประวัติการผ่อน</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    </main>


  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-lg mx-4 relative">
      <!-- ปุ่มปิด Modal -->
      <button id="btnCloseSuccessModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="bi bi-check-circle-fill text-green-600 text-3xl"></i>
                </div>
        <h3 class="text-xl font-bold text-green-800 dark:text-green-200 mb-2">สัญญาผ่อนชำระสำเร็จ!</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">เลขที่สัญญา: <span id="contractNumber" class="font-mono font-bold"></span></p>
        
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
              <span class="text-gray-600 dark:text-gray-400">ยอดชำระวันนี้:</span>
              <div class="font-bold text-green-600" id="successPaymentAmount">฿0.00</div>
                    </div>
                    <div>
              <span class="text-gray-600 dark:text-gray-400">งวดถัดไป:</span>
              <div class="font-bold" id="nextInstallmentDate">-</div>
                    </div>
                </div>
              </div>

        <!-- แสดงสถานะเอกสารที่สร้างแล้ว -->
        <div id="documentsStatus"></div>

        <div class="flex gap-3">
          <button id="btnPrintDocuments" class="btn btn-primary flex-1">
            <i class="bi bi-printer"></i>
            <span>พิมพ์เอกสาร</span>
          </button>
          <button id="btnNewContract" class="btn btn-secondary flex-1">
            <i class="bi bi-plus-circle"></i>
            <span>สัญญาใหม่</span>
          </button>
                </div>
                        </div>
                        </div>
                      </div>

  <!-- Scripts -->
  
  <!-- Printer Service Integration -->
  <script src="/js/printer-service.js"></script>
  <script>
    // Set BRANCH_CODE for PrinterService
    window.BRANCH_CODE = window.BRANCH_CODE || '00000';
    console.log('🖨️ PrinterService loaded for branch:', window.BRANCH_CODE);
  </script>
  

  <!-- Branch Info Function -->
  <script>
    // Enhanced getImageUrl function to handle duplicate path segments
    function getImageUrl(imagePath) {
      console.log('[Step4] getImageUrl input:', imagePath);
    
      if (!imagePath) {
        console.log('[Step4] No image path provided');
        return '';
      }
    
      let cleanedPath = imagePath.toString().trim();
    
      // Remove duplicate /uploads/products/ segments with enhanced patterns
      const patterns = [
        /\/uploads\/products\/uploads\/products\//g,
        /uploads\/products\/uploads\/products\//g,
        /\/uploads\/products\/(?:uploads\/products\/)+/g,
        /uploads\/products\/(?:uploads\/products\/)+/g
      ];
    
      patterns.forEach(pattern => {
        cleanedPath = cleanedPath.replace(pattern, '/uploads/products/');
      });
    
      // Clean up multiple slashes
      cleanedPath = cleanedPath.replace(/\/+/g, '/');
    
      // Ensure path starts with /
      if (!cleanedPath.startsWith('/')) {
        cleanedPath = '/' + cleanedPath;
      }
    
      console.log('[Step4] getImageUrl output:', cleanedPath);
      return cleanedPath;
    }
    
    // Make getImageUrl globally available
    window.getImageUrl = getImageUrl;
    
    async function loadBranchInfo() {
      let js = null;
      let branchCode = null;
      try {
        branchCode = window.BRANCH_CODE;
        if (!branchCode) {
          throw new Error('ไม่พบรหัสสาขา กรุณาเลือกสาขาจากหน้าหลัก');
        }
        const token = localStorage.getItem('authToken') || '';
        // เรียก /api/branch เพื่อดึง list สาขา
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        js = await res.json();
        if (res.ok && js.success) {
          // หา record ที่ตรงกับ BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            document.getElementById('branchInfo').textContent =
              `${branch.name} — ${branch.address}`;
            // อัพเดท title ของหน้าด้วยชื่อสาขาจริง
            document.title = `ระบบผ่อน - ${branch.name}`;
            document.getElementById('pageTitle').textContent = `ระบบผ่อน - ${branch.name}`;
    
            // อัพเดท dropdown branch info ใน Receipt Menu
            const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
        if (dropdownBranchInfo) {
              dropdownBranchInfo.textContent = `สาขา: ${branch.name}`;
            }
            return;
          }
        }
        throw new Error(`ไม่พบสาขา ${branchCode}`);
      } catch (err) {
        console.error('❌ loadBranchInfo error:', err);
        console.error('🔍 Available branches:', js?.data?.map(b => ({ code: b.branch_code, name: b.name })) || 'No data');
        document.getElementById('branchInfo').textContent =
          `สาขา: ไม่พบข้อมูลสาขา "${branchCode}"`;
    
        // Show available branches for debugging
        if (js?.data) {
          console.log('📋 Available branch codes:', js.data.map(b => b.branch_code));
          // Use window.showToast since it might be outside of scope
          if (typeof showToast === 'function') {
            showToast(`ไม่พบสาขา "${branchCode}" กรุณาเลือกสาขาจากหน้าหลัก`, 'error');
          }
        }
      }
    }
  </script>
  
  <!-- Global Data Manager -->
  <script src="/views/pattani/installment/js/global-data-manager.js"></script>
  
  <!-- Authentication Helper -->
  <script src="/views/pattani/installment/js/auth-helper.js"></script>
  
  <!-- Receipt & Tax Invoice Integration -->
  <script src="/views/pattani/installment/js/receipt-tax-invoice-integration.js"></script>
  
  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  
  <!-- Step 4 JavaScript -->
  <script src="/views/pattani/installment/step4/js/step4-integration.js"></script>

  <script>
      // Function to load and display document fee from step3
      function loadDocumentFeeFromStep3() {
        try {
          console.log('💰 Loading document fee from step3...');
      
          // ดึงข้อมูลจาก step3
          const step3Data = window.globalInstallmentManager?.getStepData(3);
          console.log('📋 Step3 data:', step3Data);
      
          // ดึงค่าธรรมเนียมเอกสาร
          let docFee = 0;
      
          if (step3Data?.docFee) {
            docFee = parseFloat(step3Data.docFee);
            console.log('✅ Document fee found in step3 data:', docFee);
          } else {
            // 🚨 MANDATORY: ต้องมีค่าธรรมเนียมจาก step3 เท่านั้น ไม่อนุญาต fallback
            console.error('🚨 MANDATORY ERROR: Document fee not found in step3 data');
            alert('❌ ข้อผิดพลาด: ไม่พบค่าธรรมเนียมเอกสารจาก step3 กรุณากรอกข้อมูลใน step3 ให้ครบถ้วน');
            throw new Error('MANDATORY ERROR: Document fee required from step3 data');
          }
      
          // แสดงค่าธรรมเนียมเอกสาร
          const docFeeDisplay = document.getElementById('docFeeDisplay');
          if (docFeeDisplay && docFee > 0) {
            docFeeDisplay.style.display = 'block';
            const docFeeSpan = docFeeDisplay.querySelector('span');
            if (docFeeSpan) {
              docFeeSpan.textContent = `฿${docFee.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            }
            console.log('💰 Document fee displayed:', docFee);
          }
      
          // อัพเดทยอดชำระวันนี้
          updateTodayPaymentAmount(docFee);
      
          return docFee;
      
        } catch (error) {
          console.error('❌ Error loading document fee:', error);
          // 🚨 MANDATORY: ไม่อนุญาต fallback - ต้องใช้ข้อมูลจาก step3 เท่านั้น
          if (error.message.includes('MANDATORY ERROR')) {
            throw error;
          }
          throw new Error('MANDATORY ERROR: Document fee loading failed');
        }
      }
      
      // Function to update today payment amount
      function updateTodayPaymentAmount(docFee = 0) {
        try {
          console.log('💸 Updating today payment amount...');
      
          // ดึงข้อมูลจาก step1 (สินค้า) และ step3 (ภาษี)
          const step1Data = window.globalInstallmentManager?.getStepData(1);
          const step3Data = window.globalInstallmentManager?.getStepData(3);
      
          console.log('Step1 data:', step1Data);
          console.log('Step3 data:', step3Data);
      
          // 🔧 FIX: ใช้การคำนวณแบบเดียวกับ PDF controllers
          // คำนวณยอดรวมสินค้า (ไม่รวมค่าธรรมเนียมเอกสาร)
          let subtotal = 0;
          const sourceItems = (step1Data?.items && Array.isArray(step1Data.items))
            ? step1Data.items
            : (Array.isArray(step1Data?.cartItems) ? step1Data.cartItems : []);
          if (sourceItems.length) {
            subtotal = sourceItems
              .filter(item => !item.name?.includes('ค่าธรรมเนียม') && !item.description?.includes('ค่าธรรมเนียม'))
              .reduce((sum, item) => {
                // ใช้ downAmount เป็นราคาหลักสำหรับผ่อน ถ้าไม่มีให้ใช้ price/totalPrice
                const price = parseFloat(item.downAmount || item.price || item.totalPrice || 0);
                const quantity = parseInt(item.quantity || 1);
                return sum + (price * quantity);
              }, 0);
          }
      
          console.log('📊 Calculated subtotal (excluding doc fee):', subtotal);
      
          // 🔧 FIX: ใช้ข้อมูลจาก step3 โดยตรง แต่ปรับให้รวมค่าธรรมเนียมเอกสารในฐานภาษีเสมอ
          let totalWithTax, vatAmount, afterDiscount;
          const downPayment = parseFloat(step3Data?.down_payment || step3Data?.downPayment || 0);
          const baseForTax = (downPayment > 0 ? downPayment : subtotal) + docFee;
      
          if (step3Data?.taxType === 'inclusive') {
            // VAT รวมในราคา
            afterDiscount = baseForTax;
            totalWithTax = afterDiscount;
            vatAmount = Math.round((afterDiscount - (afterDiscount / 1.07)) * 100) / 100;
          } else if (step3Data?.taxType === 'exclusive' || step3Data?.taxType === 'vat') {
            // VAT แยกนอกราคา
            afterDiscount = baseForTax;
            vatAmount = Math.round(afterDiscount * 0.07 * 100) / 100;
            totalWithTax = Math.round((afterDiscount + vatAmount) * 100) / 100;
          } else {
            // ไม่มีภาษี
            afterDiscount = baseForTax;
            vatAmount = 0;
            totalWithTax = afterDiscount;
          }
      
          console.log('📊 Calculated tax amounts (normalized):', {
            subtotal, downPayment, docFee, baseForTax, afterDiscount, vatAmount, totalWithTax, taxType: step3Data?.taxType
          });
      
          console.log('📊 Final total with tax:', totalWithTax);
      
          // ใช้เงินดาวน์จาก step3Data โดยตรง (แทนการคำนวณ 30%)
          // Variable already declared above, reuse it
      
          console.log('🔍 Down Payment Debug:', {
            step3_down_payment: step3Data?.down_payment,
            step3_downPayment: step3Data?.downPayment,
            parsedDownPayment: downPayment,
            docFee: docFee
          });
      
          // 🔧 FIX: ใบเสร็จและใบกำกับภาษีต้องแสดงยอดเงินเท่ากัน
          // ใบเสร็จ = ยอดรวมทั้งหมด (ไม่แสดงรายการภาษี)
          // ใบกำกับภาษี = ยอดรวมทั้งหมด (แสดงรายการภาษีแยก)
          const todayTotal = totalWithTax; // ใช้ยอดรวมทั้งหมดเท่ากัน
      
          console.log('💰 Payment calculation (Fixed - ใบเสร็จและใบกำกับภาษียอดเท่ากัน):', {
            downPayment,
            docFee,
            vatAmount,
            totalWithTax,
            todayTotal,
            note: 'ใบเสร็จและใบกำกับภาษีแสดงยอดเท่ากัน แต่ใบเสร็จไม่แสดงรายการภาษี'
          });
      
          // แสดงผล - ยอดชำระวันนี้ = ยอดรวมทั้งหมด (เท่ากับใบกำกับภาษี)
          const todayPaymentElement = document.getElementById('todayPaymentAmount');
          const downPaymentDisplay = document.getElementById('downPaymentDisplay');
      
          if (todayPaymentElement) {
            // แสดงยอดชำระวันนี้ (ยอดรวมทั้งหมดเท่ากับใบกำกับภาษี)
            todayPaymentElement.textContent = `฿${todayTotal.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
          }
      
          if (downPaymentDisplay) {
            downPaymentDisplay.textContent = `฿${downPayment.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
          }
      
          // 🔧 FIX: แสดง VAT ที่คำนวณใหม่ (เหมือน PDF controllers)
          if (vatAmount && vatAmount > 0) {
            const taxDisplay = document.getElementById('taxDisplay');
            if (taxDisplay) {
              taxDisplay.style.display = 'block';
              const taxSpan = taxDisplay.querySelector('span');
              if (taxSpan) {
                taxSpan.textContent = `฿${vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
              }
            }
          }
      
          console.log('✅ Today payment amount updated - ยอดชำระวันนี้ (ยอดรวมทั้งหมด):', todayTotal, '(เงินดาวน์:', downPayment, '+ ค่าธรรมเนียม:', docFee, '+ VAT:', vatAmount, ')');
      
          // 🔧 LOG: แสดงการเปรียบเทียบยอดรวมทั้งหมด
          console.log('📊 PAYMENT SUMMARY - Step4 (Fixed):', {
            step4_downPayment: downPayment,
            step4_docFee: docFee,
            step4_vatAmount: vatAmount,
            step4_todayPayment: todayTotal,
            step4_totalWithTax: totalWithTax,
            step4_calculation: `เงินดาวน์ ${downPayment} + ค่าธรรมเนียม ${docFee} + VAT ${vatAmount} = ${todayTotal}`,
            message: 'ใบเสร็จและใบกำกับภาษีแสดงยอดเท่ากัน (ใบเสร็จไม่แสดงรายการภาษี)'
          });
      
          // 🔧 FIX: บันทึกข้อมูลภาษีไปยัง step3Data เพื่อให้ backend ใช้งาน
          if (step3Data && vatAmount > 0) {
            step3Data.vatAmount = vatAmount;
            step3Data.totalWithTax = totalWithTax;
            window.globalInstallmentManager?.updateStepData(3, step3Data);
            console.log('🔧 FIXED: Updated step3Data with VAT info for backend:', {
              vatAmount: step3Data.vatAmount,
              totalWithTax: step3Data.totalWithTax,
              taxType: step3Data.taxType
            });
          }
      
        } catch (error) {
          console.error('❌ Error updating today payment amount:', error);
        }
      }

      // Check if coming from deposit receipt and conditionally hide document options
      function checkDepositReceiptSource() {
        const urlParams = new URLSearchParams(window.location.search);
        const depositReceiptId = urlParams.get('depositReceiptId');
        const fromDepositReceipt = urlParams.get('fromDepositReceipt') === 'true';
      
        if (depositReceiptId || fromDepositReceipt) {
          console.log('🎯 Coming from deposit receipt, hiding receipt/tax invoice buttons');
      
          // Hide down payment buttons since they're already handled in deposit receipt
          const downPaymentReceiptBtn = document.getElementById('btnPrintDownPaymentReceipt');
          const downPaymentTaxInvoiceBtn = document.getElementById('btnPrintDownPaymentTaxInvoice');
      
          if (downPaymentReceiptBtn) {
            downPaymentReceiptBtn.style.display = 'none';
          }
      
          if (downPaymentTaxInvoiceBtn) {
            downPaymentTaxInvoiceBtn.style.display = 'none';
          }
      
          // Add note about document availability
          const documentsSection = document.getElementById('documentsSection');
          if (documentsSection) {
            const noteElement = document.createElement('div');
            noteElement.className = 'alert alert-info mt-3';
            noteElement.innerHTML = `
              <div class="flex items-center gap-2">
                <i class="bi bi-info-circle text-blue-600"></i>
                <span class="text-sm">
                  ใบเสร็จรับเงิน/ใบกำกับภาษีสำหรับเงินมัดจำสามารถดาวน์โหลดได้จากหน้าใบรับเงินมัดจำ
                </span>
              </div>
            `;
            documentsSection.appendChild(noteElement);
          }
        }
      }

      // Delivery note functions
      async function createDeliveryNote() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const depositReceiptId = urlParams.get('depositReceiptId');
      
          if (!depositReceiptId) {
            throw new Error('ไม่พบข้อมูลใบรับเงินมัดจำ');
          }
      
          const deliveryInfo = {
            address: '', // Will be filled from customer data
            deliveryDate: new Date().toISOString(),
            specialInstructions: 'กรุณาตรวจสอบสินค้าให้ครบถ้วนก่อนรับของ'
          };
      
          const response = await fetch(`/api/delivery-notes/from-deposit/${depositReceiptId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(deliveryInfo)
          });
      
          const result = await response.json();
      
          if (result.success) {
            // Update delivery note status
            updateDocumentStatus('deliveryNoteStatus', 'completed');
      
            // Enable delivery note download button
            const deliveryNoteBtn = document.getElementById('btnDownloadDeliveryNote');
            if (deliveryNoteBtn) {
              deliveryNoteBtn.disabled = false;
              deliveryNoteBtn.onclick = () => downloadDeliveryNote(result.data._id);
            }
      
            showToast('สร้างใบส่งของสำเร็จ', 'success');
            return result.data;
          } else {
            throw new Error(result.error || 'เกิดข้อผิดพลาดในการสร้างใบส่งของ');
          }
        } catch (error) {
          console.error('Error creating delivery note:', error);
          showToast(error.message, 'error');
          throw error;
        }
      }

      function downloadDeliveryNote(deliveryNoteId) {
        window.open(`/api/delivery-notes/${deliveryNoteId}/print`, '_blank');
      }

      function updateDocumentStatus(statusElementId, status) {
        const statusElement = document.getElementById(statusElementId);
        if (statusElement) {
          statusElement.className = `document-status ${status}`;
      
          const icon = statusElement.querySelector('i');
          const text = statusElement.querySelector('span');
      
          switch (status) {
            case 'completed':
              icon.className = 'bi bi-check-circle';
              text.textContent = 'เสร็จสิ้น';
              statusElement.style.color = '#10b981';
              break;
            case 'processing':
              icon.className = 'bi bi-hourglass-split';
              text.textContent = 'กำลังดำเนินการ';
              statusElement.style.color = '#f59e0b';
              break;
            case 'pending':
            default:
              icon.className = 'bi bi-clock';
              text.textContent = 'รอดำเนินการ';
              statusElement.style.color = '#6b7280';
              break;
          }
        }
      }

      function initializeDeliveryNoteButton() {
        const deliveryNoteBtn = document.getElementById('btnDownloadDeliveryNote');
        if (deliveryNoteBtn) {
          deliveryNoteBtn.addEventListener('click', async function() {
            try {
              updateDocumentStatus('deliveryNoteStatus', 'processing');
              const deliveryNote = await createDeliveryNote();
              // Button will be enabled and onclick set in createDeliveryNote function
            } catch (error) {
              updateDocumentStatus('deliveryNoteStatus', 'pending');
            }
          });
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Step 4 initialized');
      
        // Check for draft recovery after a short delay
        setTimeout(() => {
          checkAndRestoreDraft();
        }, 1000);
      
        // Initialize branch info first
        if (window.globalInstallmentManager) {
          window.globalInstallmentManager.initializeBranchInfo();
        }
      
        // Load branch info
        await loadBranchInfo();
      
        // Initialize theme
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'true') {
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      
        // โหลดค่าธรรมเนียมเอกสารจาก step3
        setTimeout(() => {
          loadDocumentFeeFromStep3();
          // โหลดสรุปรายการสินค้า
          loadStep4ItemsSummary();
          // Check if coming from deposit receipt and hide document buttons accordingly
          checkDepositReceiptSource();
          // Initialize delivery note button
          initializeDeliveryNoteButton();
        }, 500); // รอให้ globalInstallmentManager โหลดเสร็จ
      
        showToast('ระบบสรุปและชำระเงินพร้อมใช้งาน (รวมตัดสต๊อกอัตโนมัติ)', 'success');
      });

    // Safe HTML escaping function to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return unsafe;
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ฟังก์ชันรวบรวมข้อมูลสำหรับ draft saving
    function collectAllInstallmentData() {
      try {
        console.log('📦 Collecting installment data for draft...');
      
        // รวบรวมข้อมูลจาก globalDataManager ถ้ามี
        if (window.globalDataManager) {
          const step1Data = globalDataManager.getStepData(1);
          const step2Data = globalDataManager.getStepData(2);
          const step3Data = globalDataManager.getStepData(3);
          const step4Data = globalDataManager.getStepData(4);
      
          return {
            step1: step1Data,
            step2: step2Data,
            step3: step3Data,
            step4: step4Data,
            timestamp: new Date().toISOString()
          };
        }
      
        // Fallback: รวบรวมข้อมูลจาก localStorage
        return {
          step1: JSON.parse(localStorage.getItem('step1_data') || '{}'),
          step2: JSON.parse(localStorage.getItem('step2_data') || '{}'),
          step3: JSON.parse(localStorage.getItem('step3_data') || '{}'),
          step4: JSON.parse(localStorage.getItem('step4_data') || '{}'),
          timestamp: new Date().toISOString()
        };
      
      } catch (error) {
        console.error('Error collecting installment data:', error);
        return { error: error.message, timestamp: new Date().toISOString() };
      }
    }

    // Auto-save draft functionality for error recovery
    function saveDraft() {
      try {
        const draftData = {
          timestamp: new Date().toISOString(),
          step: 4,
          data: collectAllInstallmentData()
        };
        localStorage.setItem('installmentDraft', JSON.stringify(draftData));
        return true;
      } catch (e) {
        console.error('Failed to save draft:', e);
        return false;
      }
    }

    // Restore from draft if available
    function checkAndRestoreDraft() {
      try {
        const draftStr = localStorage.getItem('installmentDraft');
        if (!draftStr) return false;
      
        const draft = JSON.parse(draftStr);
        const draftAge = Date.now() - new Date(draft.timestamp).getTime();
        const oneHour = 60 * 60 * 1000;
      
        // Only restore if draft is less than 1 hour old
        if (draftAge < oneHour) {
          if (confirm('พบข้อมูลที่บันทึกไว้ก่อนหน้านี้ ต้องการกู้คืนข้อมูลหรือไม่?')) {
            // Restore data to globalInstallmentManager
            if (window.globalInstallmentManager && draft.data) {
              console.log('🔄 Restoring from draft...');
              showToast('กำลังกู้คืนข้อมูล...', 'info');
              return true;
            }
          }
        } else {
          // Clear old draft
          localStorage.removeItem('installmentDraft');
        }
      } catch (e) {
        console.error('Failed to restore draft:', e);
      }
      return false;
    }

    // Auto-save every 30 seconds
    setInterval(() => {
      if (saveDraft()) {
        console.log('✅ Draft auto-saved');
      }
    }, 30000);

    // Toast function with XSS protection
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
      }`;
      
      // Create elements safely without innerHTML
      const toastContent = document.createElement('div');
      toastContent.className = 'flex items-center gap-2';
      
      const icon = document.createElement('i');
      icon.className = `bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}`;
      
      const span = document.createElement('span');
      span.textContent = message; // Safe text content, not HTML
      
      toastContent.appendChild(icon);
      toastContent.appendChild(span);
      toast.appendChild(toastContent);
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
      }

      // ฟังก์ชันสำหรับการชำระแบบผสม
      function calculateMixedPayment() {
        const cashAmount = parseFloat(document.getElementById('mixedCashAmount').value) || 0;
        const transferAmount = parseFloat(document.getElementById('mixedTransferAmount').value) || 0;
        const total = cashAmount + transferAmount;
      
        document.getElementById('mixedTotal').textContent = total.toLocaleString('th-TH', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // เพิ่ม event listeners สำหรับ payment method
      document.addEventListener('DOMContentLoaded', function() {
        // โหลด payment method จาก step3
        if (window.globalInstallmentManager) {
          const step3Data = window.globalInstallmentManager.getStepData(3);
          if (step3Data && step3Data.paymentMethod) {
            console.log('💳 Loading payment method from step3:', step3Data.paymentMethod);
            const savedMethod = document.querySelector(`input[name="downPaymentMethod"][value="${step3Data.paymentMethod}"]`);
            if (savedMethod) {
              savedMethod.checked = true;
              // ถ้าเป็น mixed ให้แสดง mixedPaymentDetails
              if (step3Data.paymentMethod === 'mixed') {
                const mixedSection = document.getElementById('mixedPaymentDetails');
                if (mixedSection) {
                  mixedSection.classList.remove('hidden');
                }
              }
            }
          }
        }
      
        const paymentMethods = document.querySelectorAll('input[name="downPaymentMethod"]');
        paymentMethods.forEach(radio => {
          radio.addEventListener('change', function() {
            // บันทึก payment method ที่เลือกไปยัง step4 data
            if (window.globalInstallmentManager) {
              const step4Data = window.globalInstallmentManager.getStepData(4) || {};
              window.globalInstallmentManager.updateStepData(4, {
                ...step4Data,
                paymentMethod: this.value,
                timestamp: new Date().toISOString()
              });
              console.log('💾 Saved payment method to step4:', this.value);
            }
      
            const mixedSection = document.getElementById('mixedPaymentDetails');
            if (this.value === 'mixed') {
              mixedSection.classList.remove('hidden');
            } else {
              mixedSection.classList.add('hidden');
              // รีเซ็ตค่า
              document.getElementById('mixedCashAmount').value = '';
              document.getElementById('mixedTransferAmount').value = '';
              document.getElementById('mixedTotal').textContent = '0.00';
            }
          });
        });
      });

      // Make functions globally available
      window.showToast = showToast;
      window.calculateMixedPayment = calculateMixedPayment;
    </script>

  <!-- Customer Details Modal -->
  <div id="customerDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl max-h-[90vh] w-full mx-4 overflow-hidden">
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="bi bi-person-circle text-green-600"></i>
          ข้อมูลลูกค้าทั้งหมด
        </h3>
        <button id="btnCloseCustomerModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <!-- Modal Content -->
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- ข้อมูลพื้นฐาน -->
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-person text-blue-600"></i>
              ข้อมูลพื้นฐาน
            </h4>
            
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">คำนำหน้าชื่อ</label>
                  <div id="modalPrefix" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">เพศ</label>
                  <div id="modalGender" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">ชื่อ</label>
                  <div id="modalFirstName" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">นามสกุล</label>
                  <div id="modalLastName" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">ชื่อ-นามสกุลเต็ม</label>
                <div id="modalFullName" class="font-medium text-gray-800 dark:text-gray-200 text-lg">-</div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">วัน/เดือน/ปี เกิด</label>
                  <div id="modalBirthDate" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">อายุ</label>
                  <div id="modalAge" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">เลขบัตรประชาชน</label>
                <div id="modalIdNumber" class="font-medium text-gray-800 dark:text-gray-200 font-mono text-lg">-</div>
              </div>
            </div>
          </div>
          
          <!-- ข้อมูลติดต่อ -->
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-telephone text-green-600"></i>
              ข้อมูลติดต่อ
            </h4>
            
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">หมายเลขโทรศัพท์</label>
                <div id="modalPhone" class="font-medium text-gray-800 dark:text-gray-200 text-lg">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">อีเมล</label>
                <div id="modalEmail" class="font-medium text-gray-800 dark:text-gray-200 break-all">-</div>
              </div>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                    <i class="bi bi-chat-square-text text-green-500"></i>
                    Line ID
                  </label>
                  <div id="modalLineId" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                    <i class="bi bi-facebook text-blue-500"></i>
                    Facebook
                  </label>
                  <div id="modalFacebook" class="font-medium text-gray-800 dark:text-gray-200">-</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ที่อยู่ -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-geo-alt text-purple-600"></i>
              ที่อยู่
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- ที่อยู่ตามบัตรประชาชน -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300">ที่อยู่ตามบัตรประชาชน</h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                  <div id="modalIdCardAddress" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                </div>
                
                <!-- รายละเอียดที่อยู่แยกส่วน -->
                <div class="grid grid-cols-2 gap-3 text-xs">
                  <div>
                    <span class="text-gray-500">บ้านเลขที่:</span>
                    <div id="modalHouseNo" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">หมู่ที่:</span>
                    <div id="modalMoo" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">ซอย:</span>
                    <div id="modalSoi" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">ถนน:</span>
                    <div id="modalRoad" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">ตำบล/แขวง:</span>
                    <div id="modalSubDistrict" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">อำเภอ/เขต:</span>
                    <div id="modalDistrict" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">จังหวัด:</span>
                    <div id="modalProvince" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                  <div>
                    <span class="text-gray-500">รหัสไปรษณีย์:</span>
                    <div id="modalZipcode" class="font-medium text-gray-700 dark:text-gray-300">-</div>
                  </div>
                </div>
              </div>
              
              <!-- ที่อยู่ปัจจุบัน -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  ที่อยู่ปัจจุบัน
                  <span id="modalAddressSameIndicator" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" style="display: none;">
                    เหมือนกับบัตรประชาชน
                  </span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                  <div id="modalCurrentAddress" class="text-sm text-gray-600 dark:text-gray-400">-</div>
                </div>
              </div>
            </div>
            
            <!-- พิกัดแผนที่ -->
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                <i class="bi bi-geo text-blue-600"></i>
                พิกัดแผนที่
              </h5>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <div class="text-xs text-gray-500 mb-1">พิกัด (Coordinates)</div>
                  <div id="modalCoordinates" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">Google Maps URL</div>
                  <div id="modalMapUrl" class="text-sm text-blue-600 dark:text-blue-400 break-all">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">ละติจูด (Latitude)</div>
                  <div id="modalLatitude" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
                
                <div>
                  <div class="text-xs text-gray-500 mb-1">ลองจิจูด (Longitude)</div>
                  <div id="modalLongitude" class="font-medium text-gray-800 dark:text-gray-200 font-mono">-</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ข้อมูลการงาน -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-briefcase text-orange-600"></i>
              ข้อมูลการงาน
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">อาชีพ</label>
                <div id="modalOccupation" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">รายได้ต่อเดือน</label>
                <div id="modalIncome" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 dark:text-gray-400">สถานที่ทำงาน</label>
                <div id="modalWorkplace" class="font-medium text-gray-800 dark:text-gray-200">-</div>
              </div>
            </div>
          </div>
          
          <!-- ข้อมูลพยาน -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-people text-purple-600"></i>
              ข้อมูลพยาน
            </h4>
            
            <div id="witnessSection" class="space-y-4">
              <!-- ข้อมูลพื้นฐานพยาน -->
              <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">ชื่อ</label>
                  <div id="modalWitnessFirstName" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">นามสกุล</label>
                  <div id="modalWitnessLastName" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">เลขบัตรประชาชน</label>
                  <div id="modalWitnessIdCard" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">ความสัมพันธ์</label>
                  <div id="modalWitnessRelationship" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
              </div>
              
              <!-- ข้อมูลติดต่อพยาน -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">หมายเลขโทรศัพท์</label>
                  <div id="modalWitnessPhone" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
                
                <div>
                  <label class="text-sm text-gray-600 dark:text-gray-400">ชื่อ-นามสกุลเต็ม</label>
                  <div id="modalWitnessFullName" class="font-medium text-gray-800 dark:text-gray-200">ไม่ระบุ</div>
                </div>
              </div>
              
              <!-- รูปภาพพยาน -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    <i class="bi bi-camera text-blue-600"></i>
                    รูปถ่ายพยาน
                    <span class="text-red-500">*</span>
                  </h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalWitnessPhoto" class="flex items-center justify-center h-32">
                      <div class="text-center text-gray-500 dark:text-gray-400">
                        <i class="bi bi-image text-2xl mb-2 block"></i>
                        <span class="text-sm">ไม่มีรูปถ่ายพยาน</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    <i class="bi bi-credit-card text-green-600"></i>
                    รูปบัตรประชาชนพยาน
                    <span class="text-red-500">*</span>
                  </h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalWitnessIdCardImage" class="flex items-center justify-center h-32">
                      <div class="text-center text-gray-500 dark:text-gray-400">
                        <i class="bi bi-credit-card text-2xl mb-2 block"></i>
                        <span class="text-sm">ไม่มีรูปบัตรประชาชนพยาน</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- หมายเหตุเกี่ยวกับพยาน -->
              <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-700">
                <div class="flex items-start gap-2">
                  <i class="bi bi-info-circle text-purple-600 mt-0.5 flex-shrink-0"></i>
                  <div class="text-sm text-purple-700 dark:text-purple-300">
                    <div class="font-medium mb-1">หมายเหตุ:</div>
                    <ul class="space-y-1 text-xs">
                      <li>• พยานต้องเป็นบุคคลที่รู้จักลูกค้าเป็นอย่างดี</li>
                      <li>• รูปถ่ายพยานและรูปบัตรประชาชนพยานเป็นเอกสารบังคับ</li>
                      <li>• พยานควรมีอายุตั้งแต่ 18 ปีขึ้นไป</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- เอกสารประกอบ -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-file-image text-teal-600"></i>
              เอกสารประกอบ
            </h4>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- รูปบัตรประชาชน -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-credit-card text-blue-600"></i>
                  รูปบัตรประชาชน
                  <span class="text-red-500 text-sm">*</span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalIdCardImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-image text-2xl mb-2 block"></i>
                      <span class="text-sm">ไม่มีรูปบัตรประชาชน</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- รูปเซลฟี่พร้อมบัตร -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-person-badge text-green-600"></i>
                  รูปเซลฟี่พร้อมบัตร
                  <span class="text-red-500 text-sm">*</span>
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalSelfieImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-camera-fill text-2xl mb-2 block"></i>
                      <span class="text-sm">ไม่มีรูปเซลฟี่</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- สลิปเงินเดือน -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i class="bi bi-receipt text-purple-600"></i>
                  สลิปเงินเดือน
                </h5>
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 aspect-[3/2] flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                  <div id="modalSalarySlipImage" class="w-full h-full flex items-center justify-center">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                      <i class="bi bi-file-earmark-text text-2xl mb-2 block"></i>
                      <span class="text-sm">ไม่มีสลิปเงินเดือน</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- หมายเหตุเกี่ยวกับเอกสาร -->
            <div class="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700">
              <div class="flex items-start gap-2">
                <i class="bi bi-info-circle text-amber-600 mt-0.5 flex-shrink-0"></i>
                <div class="text-sm text-amber-700 dark:text-amber-300">
                  <div class="font-medium mb-1">หมายเหตุ:</div>
                  <ul class="space-y-1 text-xs">
                    <li>• รูปบัตรประชาชนและรูปเซลฟี่พร้อมบัตรเป็นเอกสารบังคับ</li>
                    <li>• สลิปเงินเดือนเป็นเอกสารเสริม (แนะนำให้มี)</li>
                    <li>• กดที่รูปเพื่อดูขนาดเต็ม</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <!-- การยืนยันตัวตน -->
          <div class="lg:col-span-2 space-y-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
              <i class="bi bi-shield-check text-indigo-600"></i>
              การยืนยันตัวตน
            </h4>
            
            <!-- วิธีการยืนยันตัวตน -->
            <div class="mb-4">
              <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">วิธีการยืนยันตัวตน:</div>
              <div id="modalAuthMethod" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                <i class="bi bi-question-circle"></i>
                <span>ไม่ระบุ</span>
              </div>
            </div>
            
            <!-- ลายเซ็น -->
            <div class="space-y-4">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="bi bi-pen text-indigo-600"></i>
                ลายเซ็น
              </h5>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300">ลายเซ็นลูกค้า</h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg h-32 flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalCustomerSignature">
                      <span class="text-gray-500 dark:text-gray-400 text-sm">ไม่มีลายเซ็น</span>
                    </div>
                  </div>
                </div>
                
                <div class="space-y-2">
                  <h6 class="font-medium text-gray-700 dark:text-gray-300">ลายเซ็นพนักงาน</h6>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg h-32 flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600">
                    <div id="modalEmployeeSignature">
                      <span class="text-gray-500 dark:text-gray-400 text-sm">ไม่มีลายเซ็น</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ลายนิ้วมือ (ถ้ามี) -->
            <div id="modalFingerprintSection" class="space-y-4" style="display: none;">
              <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                <i class="bi bi-fingerprint text-purple-600"></i>
                ลายนิ้วมือ
              </h5>
              
              <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-purple-800 dark:text-purple-200">ลายนิ้วมือลูกค้า</div>
                    <div class="text-sm text-purple-600 dark:text-purple-300">บันทึกเมื่อ: <span id="modalFingerprintDate">-</span></div>
                  </div>
                  <div id="modalFingerprintStatus" class="px-3 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-200 text-sm">
                    <i class="bi bi-check-circle"></i> บันทึกแล้ว
                  </div>
                </div>
                <div id="modalFingerprintData" class="mt-2 text-xs text-gray-600 dark:text-gray-400 font-mono bg-white dark:bg-gray-800 p-2 rounded truncate">
                  ไม่มีข้อมูลลายนิ้วมือ
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="flex justify-end p-6 border-t border-gray-200 dark:border-gray-700">
        <button id="btnEditCustomerData" class="btn btn-primary mr-3">
          <i class="bi bi-pencil"></i>
          <span>แก้ไขข้อมูล</span>
        </button>
        <button id="btnCloseCustomerModalFooter" class="btn btn-secondary">
          <span>ปิด</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Customer Details Modal Management
    window.customerDetailsModal = {
    
      showModal() {
        const modal = document.getElementById('customerDetailsModal');
        if (modal) {
          modal.classList.remove('hidden');
          this.loadCustomerData();
        }
      },
    
      hideModal() {
        const modal = document.getElementById('customerDetailsModal');
        if (modal) {
          modal.classList.add('hidden');
        }
      },
    
      loadCustomerData() {
        try {
          console.log('🔍 MANDATORY: Checking for customer data from step2 only...');
          console.log('globalInstallmentManager exists:', !!window.globalInstallmentManager);
    
          // 🚨 MANDATORY: ดึงข้อมูลจาก globalInstallmentManager เท่านั้น ไม่ใช้ localStorage
          const stepData = window.globalInstallmentManager?.getStepData(2);
          console.log('📋 Step data from globalInstallmentManager (MANDATORY SOURCE):', stepData);
    
          // Debug: ตรวจสอบโครงสร้างข้อมูลทั้งหมด
          if (stepData) {
            console.log('🔍 Full stepData structure:');
            console.log(stepData);
            console.log('🔍 Keys in stepData:', Object.keys(stepData));
            if (stepData.customer) {
              console.log('🔍 Keys in stepData.customer:', Object.keys(stepData.customer));
            }
          }
    
          // แยกข้อมูลลูกค้าจาก stepData (อาจอยู่ใน customer object หรือ root level)
          const stepCustomerData = stepData?.customer || {};
          console.log('👤 Customer data from stepData (MANDATORY SOURCE):', stepCustomerData);
    
          // � MANDATORY: ผสานข้อมูลจากทุก level เพื่อให้ครบถ้วน
          const customerData = {
            ...stepData,  // Root level data (อาจมี witness, attachments, etc.)
            ...stepCustomerData  // Customer object data
          };
          console.log('🔄 MANDATORY: Using only stepData customer data:', customerData);
          console.log('📊 MANDATORY data validation:', {
            hasFirstName: !!(customerData.firstName || customerData.first_name),
            hasLastName: !!(customerData.lastName || customerData.last_name),
            hasPhone: !!(customerData.phone || customerData.phone_number),
            hasEmail: !!customerData.email,
            hasAddress: !!(customerData.address || customerData.houseNo),
            hasSignature: !!(customerData.signature || customerData.customerSignature)
          });
    
          // 🚨 MANDATORY: ตรวจสอบข้อมูลลูกค้าจาก step2 เท่านั้น
          if (!stepCustomerData || Object.keys(stepCustomerData).length === 0) {
            console.error('🚨 MANDATORY ERROR: No customer data found in step2');
            alert('❌ ข้อผิดพลาด: ไม่พบข้อมูลลูกค้าจาก step2 กรุณากรอกข้อมูลใน step2 ให้ครบถ้วน');
            this.showNoDataMessage();
            throw new Error('MANDATORY ERROR: Customer data required from step2');
          }
    
          // ข้อมูลพื้นฐาน - ดึงจาก stepData.customer ที่มี underscore format
          const actualCustomerData = customerData.customer || customerData;
    
          // Debug: แสดงข้อมูลที่มีอยู่จริง
          console.log('🔍 DEBUG - actualCustomerData:', actualCustomerData);
          console.log('🔍 DEBUG - actualCustomerData keys:', Object.keys(actualCustomerData));
          if (actualCustomerData) {
            console.log('🔍 DEBUG - Sample fields:');
            console.log('  gender:', actualCustomerData.gender);
            console.log('  sex:', actualCustomerData.sex);
            console.log('  line_id:', actualCustomerData.line_id);
            console.log('  lineId:', actualCustomerData.lineId);
            console.log('  facebook:', actualCustomerData.facebook);
          }
    
          document.getElementById('modalPrefix').textContent = actualCustomerData.prefix || customerData.prefix || 'ไม่ระบุ';
          document.getElementById('modalFirstName').textContent = actualCustomerData.first_name || actualCustomerData.firstName || 'ไม่ระบุ';
          document.getElementById('modalLastName').textContent = actualCustomerData.last_name || actualCustomerData.lastName || 'ไม่ระบุ';
    
        const prefix = actualCustomerData.prefix || '';
        const firstName = actualCustomerData.first_name || actualCustomerData.firstName || '';
        const lastName = actualCustomerData.last_name || actualCustomerData.lastName || '';
    
        document.getElementById('modalFullName').textContent = `${prefix} ${firstName} ${lastName}`.trim() || 'ไม่ระบุ';
    
        // Enhanced gender display - ดึงจากข้อมูลหรือ prefix
        let gender = actualCustomerData.gender || actualCustomerData.sex || '';
    
        // ถ้าไม่มีข้อมูลเพศ ให้ดึงจาก prefix
        if (!gender) {
          const prefix = actualCustomerData.prefix || customerData.prefix || '';
          if (prefix.includes('นาย')) {
            gender = 'ชาย';
          } else if (prefix.includes('นาง') || prefix.includes('นางสาว')) {
            gender = 'หญิง';
          } else {
            gender = 'ไม่ระบุ';
          }
        }
    
        document.getElementById('modalGender').textContent = gender;
    
        document.getElementById('modalBirthDate').textContent = actualCustomerData.birth_date || actualCustomerData.birthDate || 'ไม่ระบุ';
        document.getElementById('modalAge').textContent = actualCustomerData.age ? `${actualCustomerData.age} ปี` : 'ไม่ระบุ';
        document.getElementById('modalIdNumber').textContent = actualCustomerData.tax_id || actualCustomerData.idCard || actualCustomerData.idNumber || 'ไม่ระบุ';
    
        // ข้อมูลติดต่อ
        document.getElementById('modalPhone').textContent = actualCustomerData.phone_number || actualCustomerData.phone || actualCustomerData.phoneNumber || 'ไม่ระบุ';
        document.getElementById('modalEmail').textContent = actualCustomerData.email || 'ไม่ระบุ';
    
        // Fix Line ID display - ข้อมูลนี้ไม่ได้ถูกเก็บใน step2
        // ต้องเพิ่ม field นี้ใน step2 form ในอนาคต
        const lineId = actualCustomerData.line_id || actualCustomerData.lineId || '';
        document.getElementById('modalLineId').textContent = lineId || '-';
    
        // Fix Facebook display - ข้อมูลนี้ไม่ได้ถูกเก็บใน step2
        // ต้องเพิ่ม field นี้ใน step2 form ในอนาคต
        const fbUrl = actualCustomerData.facebook || actualCustomerData.fb || '';
        document.getElementById('modalFacebook').textContent = fbUrl ?
            (fbUrl.length > 50 ? fbUrl.substring(0, 50) + '...' : fbUrl) :
            '-';
    
          // ที่อยู่ - รองรับทั้ง nested object และ flat structure
          const addressData = customerData.address || {
            houseNo: customerData.houseNo,
            moo: customerData.moo,
            soi: customerData.soi,
            road: customerData.road,
            subDistrict: customerData.subDistrict,
            district: customerData.district,
            province: customerData.province,
            zipcode: customerData.zipcode
          };
    
          const idCardAddress = this.formatAddress(addressData);
          document.getElementById('modalIdCardAddress').textContent = idCardAddress || 'ไม่ระบุ';
    
          // รายละเอียดที่อยู่แยกส่วน
          document.getElementById('modalHouseNo').textContent = addressData.houseNo || 'ไม่ระบุ';
          document.getElementById('modalMoo').textContent = addressData.moo || 'ไม่ระบุ';
          document.getElementById('modalSoi').textContent = addressData.soi || 'ไม่ระบุ';
          document.getElementById('modalRoad').textContent = addressData.road || 'ไม่ระบุ';
          document.getElementById('modalSubDistrict').textContent = addressData.subDistrict || 'ไม่ระบุ';
          document.getElementById('modalDistrict').textContent = addressData.district || 'ไม่ระบุ';
          document.getElementById('modalProvince').textContent = addressData.province || 'ไม่ระบุ';
          document.getElementById('modalZipcode').textContent = addressData.zipcode || 'ไม่ระบุ';
    
          const currentAddress = customerData.isSameAddress ?
            'เหมือนกับที่อยู่ตามบัตรประชาชน' :
            this.formatAddress(customerData.contactAddress || customerData.currentAddress);
          document.getElementById('modalCurrentAddress').textContent = currentAddress || 'ไม่ระบุ';
    
          // แสดง indicator สำหรับที่อยู่เหมือนกัน
          const sameIndicator = document.getElementById('modalAddressSameIndicator');
          if (customerData.isSameAddress) {
            sameIndicator.style.display = 'inline-block';
          } else {
            sameIndicator.style.display = 'none';
          }
    
          // พิกัดแผนที่
          console.log('🗺️ Location data debug:', {
            coordinates: customerData.coordinates,
            customerCoordinates: customerData.customerCoordinates,
            latitude: customerData.latitude,
            customerLatitude: customerData.customerLatitude,
            longitude: customerData.longitude,
            customerLongitude: customerData.customerLongitude,
            mapUrl: customerData.mapUrl,
            customerMapUrl: customerData.customerMapUrl
          });
    
          document.getElementById('modalCoordinates').textContent = customerData.coordinates || customerData.customerCoordinates || 'ไม่ระบุ';
          document.getElementById('modalLatitude').textContent = customerData.latitude || customerData.customerLatitude || 'ไม่ระบุ';
          document.getElementById('modalLongitude').textContent = customerData.longitude || customerData.customerLongitude || 'ไม่ระบุ';
    
          const mapUrlElement = document.getElementById('modalMapUrl');
          const mapUrl = customerData.mapUrl || customerData.customerMapUrl;
          if (mapUrl) {
            mapUrlElement.innerHTML = `<a href="${mapUrl}" target="_blank" class="hover:underline">${mapUrl.length > 50 ? mapUrl.substring(0, 50) + '...' : mapUrl}</a>`;
          } else {
            mapUrlElement.textContent = 'ไม่ระบุ';
          }
    
          // ข้อมูลการงาน
          document.getElementById('modalOccupation').textContent = actualCustomerData.occupation || 'ไม่ระบุ';
    
          const income = actualCustomerData.income || actualCustomerData.monthlyIncome;
          document.getElementById('modalIncome').textContent = income ? `฿${parseInt(income).toLocaleString()}` : 'ไม่ระบุ';
    
          document.getElementById('modalWorkplace').textContent = actualCustomerData.workplace || 'ไม่ระบุ';
    
          // การยืนยันตัวตน
          this.loadAuthenticationMethod(customerData);
    
          // เอกสารประกอบ (รวมข้อมูลจาก stepData.attachments ด้วย)
          const documentsData = { ...customerData, ...(stepData?.attachments || {}) };
          this.loadDocumentImages(documentsData);
    
          // ลายเซ็น (รวมข้อมูลจาก stepData.signature ด้วย)
          const signatureData = {
            ...customerData,
            signature: stepData?.signature,
            customerSignature: stepData?.signature || customerData.customerSignature
          };
          this.loadSignatures(signatureData);
    
          // ข้อมูลพยาน - โหลดจาก localStorage ก่อน แล้วใช้ stepData เป็น fallback
          console.log('👥 Loading witness data for customer modal...');
          this.loadWitnessDataForModal(stepData);
    
        } catch (error) {
          console.error('❌ MANDATORY ERROR: Customer data loading failed:', error);
          // 🚨 MANDATORY: ไม่อนุญาต fallback - ต้องใช้ข้อมูลจาก step2 เท่านั้น
          if (error.message.includes('MANDATORY ERROR')) {
            throw error;
          }
          showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลลูกค้าจาก step2', 'error');
          throw new Error('MANDATORY ERROR: Customer data loading failed');
        }
      },
    
      showNoDataMessage() {
        // แสดงข้อความเมื่อไม่มีข้อมูล
        const elements = [
          'modalPrefix', 'modalFirstName', 'modalLastName', 'modalFullName',
          'modalGender', 'modalBirthDate', 'modalAge', 'modalIdNumber',
          'modalPhone', 'modalEmail', 'modalLineId', 'modalFacebook'
        ];
    
        elements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = '<span class="text-red-500">ไม่พบข้อมูล - โปรดกรอกข้อมูลใน Step 2</span>';
          }
        });
    
        console.warn('❌ แสดงข้อความไม่มีข้อมูลให้ผู้ใช้');
      },
    
      formatAddress(addressData) {
        if (!addressData) return '';
    
        const parts = [];
    
        if (addressData.houseNumber || addressData.houseNo) parts.push(`เลขที่ ${addressData.houseNumber || addressData.houseNo}`);
        if (addressData.village || addressData.moo) parts.push(`หมู่ ${addressData.village || addressData.moo}`);
        if (addressData.soi) parts.push(`ซอย ${addressData.soi}`);
        if (addressData.street || addressData.road) parts.push(`ถนน ${addressData.street || addressData.road}`);
        if (addressData.subdistrict || addressData.subDistrict) parts.push(`ตำบล ${addressData.subdistrict || addressData.subDistrict}`);
        if (addressData.district) parts.push(`อำเภอ ${addressData.district}`);
        if (addressData.province) parts.push(`จังหวัด ${addressData.province}`);
        if (addressData.postalCode || addressData.zipcode) parts.push(`รหัสไปรษณีย์ ${addressData.postalCode || addressData.zipcode}`);
    
        return parts.join(' ');
      },
    
      loadAuthenticationMethod(customerData) {
        const authMethodElement = document.getElementById('modalAuthMethod');
        const fingerprintSection = document.getElementById('modalFingerprintSection');
    
        // Check multiple possible field names for authentication method
        const method = customerData.authMethod ||
                      customerData.customerAuthMethod ||
                      customerData.auth_method ||
                      customerData.authenticationMethod ||
                      customerData.authType ||
                      customerData.signature ? 'signature' : null;  // ถ้ามีลายเซ็นให้ใช้ signature
    
        if (method) {
    
          if (method === 'signature') {
            authMethodElement.innerHTML = `
              <i class="bi bi-pen-fill"></i>
              <span>ลายเซ็น</span>
            `;
            authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
            fingerprintSection.style.display = 'none';
          } else if (method === 'fingerprint') {
            authMethodElement.innerHTML = `
              <i class="bi bi-fingerprint"></i>
              <span>ลายนิ้วมือ</span>
            `;
            authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
            fingerprintSection.style.display = 'block';
    
            // โหลดข้อมูลลายนิ้วมือ
            this.loadFingerprintData(customerData);
          }
        } else {
          authMethodElement.innerHTML = `
            <i class="bi bi-question-circle"></i>
            <span>ไม่ระบุ</span>
          `;
          authMethodElement.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
          fingerprintSection.style.display = 'none';
        }
      },
    
      loadFingerprintData(customerData) {
        const fingerprintData = customerData.fingerprintData || customerData.customerFingerprintData;
        const fingerprintDate = customerData.fingerprintDate || new Date().toLocaleDateString('th-TH');
    
        document.getElementById('modalFingerprintDate').textContent = fingerprintDate;
    
        if (fingerprintData) {
          document.getElementById('modalFingerprintData').textContent =
            fingerprintData.length > 100 ? fingerprintData.substring(0, 100) + '...' : fingerprintData;
          document.getElementById('modalFingerprintStatus').innerHTML = `
            <i class="bi bi-check-circle"></i> บันทึกแล้ว
          `;
        } else {
          document.getElementById('modalFingerprintData').textContent = 'ไม่มีข้อมูลลายนิ้วมือ';
          document.getElementById('modalFingerprintStatus').innerHTML = `
            <i class="bi bi-x-circle"></i> ไม่มีข้อมูล
          `;
          document.getElementById('modalFingerprintStatus').className = 'px-3 py-1 rounded-full bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-200 text-sm';
        }
      },
    
      loadDocumentImages(customerData) {
        console.log('🖼️ Loading document images:', customerData);
    
        // รูปบัตรประชาชน - ดึงจาก stepData.attachments และ localStorage server URLs
        const idCardContainer = document.getElementById('modalIdCardImage');
    
        // ตรวจสอบ attachments จาก globalInstallmentManager
        const stepData = window.globalInstallmentManager?.getStepData(2);
        const attachments = stepData?.attachments || {};
    
        // 🔧 Safe object property access to prevent [object Object] issues
        const getAttachmentUrl = (attachment) => {
          console.log('🔍 getAttachmentUrl called with:', typeof attachment, attachment);
          if (!attachment) {
            console.log('   → No attachment provided, returning null');
            return null;
          }
    
          // If it's already a string, validate it first
          if (typeof attachment === 'string') {
            // Check if it's not the string representation of an object
            if (attachment.includes('[object') || attachment.includes('Object]')) {
              console.log('   → Attachment is string but contains [object Object], returning null');
              return null;
            }
            console.log('   → Attachment is valid string:', attachment.substring(0, 50) + '...');
            return attachment;
          }
    
          // Check for various property names that might contain the URL
          if (attachment.url && typeof attachment.url === 'string' && !attachment.url.includes('[object')) {
            console.log('   → Using attachment.url:', attachment.url.substring(0, 50) + '...');
            return attachment.url;
          }
          if (attachment.data && typeof attachment.data === 'string' && !attachment.data.includes('[object')) {
            console.log('   → Using attachment.data:', attachment.data.substring(0, 50) + '...');
            return attachment.data;
          }
          if (attachment.imageData && typeof attachment.imageData === 'string' && !attachment.imageData.includes('[object')) {
            console.log('   → Using attachment.imageData:', attachment.imageData.substring(0, 50) + '...');
            return attachment.imageData;
          }
          if (attachment.path && typeof attachment.path === 'string' && !attachment.path.includes('[object')) {
            console.log('   → Using attachment.path:', attachment.path.substring(0, 50) + '...');
            return attachment.path;
          }
          if (attachment.src && typeof attachment.src === 'string' && !attachment.src.includes('[object')) {
            console.log('   → Using attachment.src:', attachment.src.substring(0, 50) + '...');
            return attachment.src;
          }
    
          console.log('   → No valid URL found in attachment object:', Object.keys(attachment));
          return null;
        };
    
        // Helper function to safely escape strings for HTML attributes
        const escapeHtmlAttribute = (str) => {
          if (typeof str !== 'string') return '';
          return str.replace(/"/g, '&quot;')
                   .replace(/'/g, '&#39;')
                   .replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;')
                   .replace(/\\/g, '&#92;');
        };
    
        const idCardSources = [
          // ลำดับความสำคัญ: server URLs ก่อน, แล้วค่อย base64
          localStorage.getItem('customer_idCard_url'),
          getAttachmentUrl(attachments.idCard),
          localStorage.getItem('idCardImageUrl'),
          localStorage.getItem('idCardImageData'),
          localStorage.getItem('idCardImage'),
          customerData.idCardImageUrl,
          customerData.idCardImage,
          customerData.idCard_image
        ];
    
        // Validate image URL to prevent [object Object] issues
        const isValidImageUrl = (url) => {
          if (!url || typeof url !== 'string') return false;
          if (url === 'null' || url === 'undefined' || url === '') return false;
          if (url.includes('[object') || url.includes('Object]')) return false;
          // Check if it's a valid data URL or http URL
          if (url.startsWith('data:image/') || url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) {
            return true;
          }
          return false;
        };
    
        const idCardImage = idCardSources.find(img => isValidImageUrl(img));
        console.log('🖼️ ID Card Image - Checking sources:');
        console.log('   customer_idCard_url:', localStorage.getItem('customer_idCard_url') ? 'found' : 'not found');
        console.log('   attachments.idCard:', attachments.idCard ? 'found' : 'not found');
        console.log('   localStorage items:', idCardSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected ID Card Image:', idCardImage ? (idCardImage.startsWith('http') ? idCardImage : idCardImage.substring(0, 50) + '...') : 'none');
    
        if (idCardImage && isValidImageUrl(idCardImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeIdCardImage = escapeHtmlAttribute(idCardImage);
    
          idCardContainer.innerHTML = `
            <img src="${idCardImage}" 
                 alt="รูปบัตรประชาชน" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeIdCardImage}"
                 data-image-title="รูปบัตรประชาชน"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">ไม่สามารถโหลดรูปได้</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = idCardContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-image text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปบัตรประชาชน</span>
            </div>
          `;
        }
    
        // รูปเซลฟี่พร้อมบัตร - ดึงจาก stepData.attachments และ localStorage server URLs
        const selfieContainer = document.getElementById('modalSelfieImage');
        const selfieSources = [
          // ลำดับความสำคัญ: server URLs ก่อน, แล้วค่อย base64
          localStorage.getItem('customer_selfie_url'),
          getAttachmentUrl(attachments.selfie),
          localStorage.getItem('selfieImageUrl'),
          localStorage.getItem('selfieImageData'),
          localStorage.getItem('selfieImage'),
          customerData.selfieImageUrl,
          customerData.selfieImage,
          customerData.selfie_image
        ];
    
        const selfieImage = selfieSources.find(img => isValidImageUrl(img));
        console.log('🖼️ Selfie Image - Checking sources:');
        console.log('   customer_selfie_url:', localStorage.getItem('customer_selfie_url') ? 'found' : 'not found');
        console.log('   attachments.selfie:', attachments.selfie ? 'found' : 'not found');
        console.log('   localStorage items:', selfieSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected Selfie Image:', selfieImage ? (selfieImage.startsWith('http') ? selfieImage : selfieImage.substring(0, 50) + '...') : 'none');
    
        if (selfieImage && isValidImageUrl(selfieImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeSelfieImage = escapeHtmlAttribute(selfieImage);
    
          selfieContainer.innerHTML = `
            <img src="${selfieImage}" 
                 alt="รูปเซลฟี่พร้อมบัตร" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeSelfieImage}"
                 data-image-title="รูปเซลฟี่พร้อมบัตร"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">ไม่สามารถโหลดรูปได้</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = selfieContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          selfieContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-camera-fill text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปเซลฟี่</span>
            </div>
          `;
        }
    
        // สลิปเงินเดือน - ดึงจาก stepData.attachments และ localStorage server URLs
        const salarySlipContainer = document.getElementById('modalSalarySlipImage');
        const salarySlipSources = [
          // ลำดับความสำคัญ: server URLs ก่อน, แล้วค่อย base64
          localStorage.getItem('customer_salarySlip_url'),
          getAttachmentUrl(attachments.salarySlip),
          localStorage.getItem('salarySlipImageUrl'),
          localStorage.getItem('salarySlipImageData'),
          localStorage.getItem('salarySlipImage'),
          customerData.salarySlipImageUrl,
          customerData.salarySlipImage,
          customerData.salary_slip_image
        ];
    
        const salarySlipImage = salarySlipSources.find(img => isValidImageUrl(img));
        console.log('🖼️ Salary Slip Image - Checking sources:');
        console.log('   attachments.salarySlip:', attachments.salarySlip ? 'found' : 'not found');
        console.log('   localStorage items:', salarySlipSources.slice(2, 5).map(s => s ? 'found' : 'not found'));
        console.log('   Selected Salary Slip Image:', salarySlipImage ? salarySlipImage.substring(0, 50) + '...' : 'none');
    
        if (salarySlipImage && isValidImageUrl(salarySlipImage)) {
          // Create a safe version of the image URL for the data attribute
          const safeSalarySlipImage = escapeHtmlAttribute(salarySlipImage);
    
          salarySlipContainer.innerHTML = `
            <img src="${salarySlipImage}" 
                 alt="สลิปเงินเดือน" 
                 class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                 data-image-url="${safeSalarySlipImage}"
                 data-image-title="สลิปเงินเดือน"
                 onerror="this.parentElement.innerHTML='<div class=\\"text-center text-red-500 dark:text-red-400\\"><i class=\\"bi bi-exclamation-triangle text-2xl mb-2 block\\"></i><span class=\\"text-sm\\">ไม่สามารถโหลดรูปได้</span></div>'">
          `;
    
          // Add click event listener after element is created
          setTimeout(() => {
            const img = salarySlipContainer.querySelector('img');
            if (img) {
              img.addEventListener('click', function() {
                const imageUrl = this.getAttribute('data-image-url');
                const imageTitle = this.getAttribute('data-image-title');
                // Decode the escaped HTML entities back to original
                const decodedUrl = imageUrl.replace(/&quot;/g, '"')
                                          .replace(/&#39;/g, "'")
                                          .replace(/&lt;/g, '<')
                                          .replace(/&gt;/g, '>')
                                          .replace(/&#92;/g, '\\');
                window.customerDetailsModal.showImageModal(decodedUrl, imageTitle);
              });
            }
          }, 0);
        } else {
          salarySlipContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-file-earmark-text text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีสลิปเงินเดือน</span>
            </div>
          `;
        }
      },
    
      showImageModal(imageUrl, title) {
        // 🔧 Validate imageUrl to prevent [object Object] errors
        if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.includes('[object Object]')) {
          console.error('❌ Invalid image URL provided to showImageModal:', imageUrl);
          alert('ไม่สามารถแสดงรูปภาพได้ เนื่องจากไฟล์รูปภาพผิดพลาด');
          return;
        }
    
        console.log('🖼️ Opening image modal for:', imageUrl.substring(0, 100) + '...');
    
        // สร้าง image modal สำหรับดูภาพขนาดเต็ม
        const imageModal = document.createElement('div');
        imageModal.id = 'imageViewModal';
        imageModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4';
    
        imageModal.innerHTML = `
          <div class="relative max-w-full max-h-full">
            <button onclick="document.getElementById('imageViewModal').remove()" 
                    class="absolute -top-12 right-0 text-white hover:text-gray-300 text-3xl z-10">
              <i class="bi bi-x-lg"></i>
            </button>
            <div class="bg-white dark:bg-gray-800 p-2 rounded-lg">
              <div class="text-center mb-2">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${title}</h4>
              </div>
              <img src="${imageUrl}" 
                   alt="${title}" 
                   class="max-w-full max-h-[80vh] object-contain rounded"
                   style="max-width: 90vw;">
            </div>
          </div>
        `;
    
        // เพิ่ม event listener สำหรับปิด modal เมื่อคลิกพื้นหลัง
        imageModal.addEventListener('click', function(e) {
          if (e.target === imageModal) {
            imageModal.remove();
          }
        });
    
        document.body.appendChild(imageModal);
    
        // เพิ่ม keyboard event listener สำหรับปิด modal ด้วย ESC
        const closeOnEscape = function(e) {
          if (e.key === 'Escape') {
            imageModal.remove();
            document.removeEventListener('keydown', closeOnEscape);
          }
        };
        document.addEventListener('keydown', closeOnEscape);
      },
    
      loadSignatures(customerData) {
        console.log('✍️ Loading signatures:', customerData);
    
        // ลายเซ็นลูกค้า - ใช้เฉพาะลายเซ็นลูกค้า
        const customerSigContainer = document.getElementById('modalCustomerSignature');
                const customerSignatureSources = [
          localStorage.getItem('customerSignature'),
          localStorage.getItem('step2_signature'),
          localStorage.getItem('step2_customerSignature'),
          customerData.customerSignature,
          customerData.signature
        ];
    
        const savedCustomerSignature = customerSignatureSources.find(sig => sig && sig !== 'null' && sig !== '');
        console.log('Customer signature sources:', customerSignatureSources);
        console.log('Selected customer signature:', savedCustomerSignature ? savedCustomerSignature.substring(0, 50) + '...' : 'none');
    
        if (savedCustomerSignature) {
          customerSigContainer.innerHTML = `<img src="${savedCustomerSignature}" alt="ลายเซ็นลูกค้า" class="max-w-full max-h-full object-contain">`;
        } else {
          customerSigContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400 text-sm">ไม่มีลายเซ็น</span>';
        }
    
        // ลายเซ็นพนักงาน - ดึงจาก attachments และ localStorage
        const employeeSigContainer = document.getElementById('modalEmployeeSignature');
    
        // ดึง attachments จาก stepData
        const stepDataForSig = window.globalInstallmentManager?.getStepData(2);
        const attachmentsForSig = stepDataForSig?.attachments || {};
    
        const employeeSignatureSources = [
          attachmentsForSig.salespersonSignature?.url,
          attachmentsForSig.salespersonSignature?.data,
          attachmentsForSig.salespersonSignature?.imageData,
          attachmentsForSig.employeeSignature?.url,
          attachmentsForSig.employeeSignature?.data,
          attachmentsForSig.employeeSignature?.imageData,
          localStorage.getItem('salespersonSignature'),
          localStorage.getItem('step2_salespersonSignature'),
          localStorage.getItem('employeeSignature'),
          customerData.salespersonSignature,
          customerData.employeeSignature
        ];
    
        const savedEmployeeSignature = employeeSignatureSources.find(sig => sig && sig !== 'null' && sig !== '');
        console.log('✍️ Employee signature - Checking sources:');
        console.log('   attachments.salespersonSignature:', attachmentsForSig.salespersonSignature ? 'found' : 'not found');
        if (attachmentsForSig.salespersonSignature) {
          console.log('   salespersonSignature structure:', attachmentsForSig.salespersonSignature);
        }
        console.log('   attachments.employeeSignature:', attachmentsForSig.employeeSignature ? 'found' : 'not found');
        console.log('   localStorage items:', employeeSignatureSources.slice(6, 9).map(s => s ? 'found' : 'not found'));
        console.log('   All employeeSignatureSources:', employeeSignatureSources.map((s, i) => `${i}: ${s ? (typeof s === 'string' && s.length > 50 ? s.substring(0, 50) + '...' : 'found') : 'not found'}`));
        console.log('   Selected employee signature:', savedEmployeeSignature ? savedEmployeeSignature.substring(0, 50) + '...' : 'none');
    
        // เปรียบเทียบลายเซ็นว่าซ้ำกันหรือไม่
        if (savedCustomerSignature && savedEmployeeSignature) {
          const sameSignature = savedCustomerSignature === savedEmployeeSignature;
          console.log('⚠️ SIGNATURE COMPARISON:', sameSignature ? 'IDENTICAL (ซ้ำกัน!)' : 'DIFFERENT (ต่างกัน)');
          if (sameSignature) {
            console.log('🚨 WARNING: Customer and Employee signatures are identical!');
          }
        }
    
        // ป้องกันการแสดงลายเซ็นซ้ำกัน
        if (savedEmployeeSignature && savedEmployeeSignature !== savedCustomerSignature) {
          employeeSigContainer.innerHTML = `<img src="${savedEmployeeSignature}" alt="ลายเซ็นพนักงาน" class="max-w-full max-h-full object-contain">`;
        } else {
          employeeSigContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400 text-sm">ไม่มีลายเซ็น</span>';
    
          if (savedEmployeeSignature === savedCustomerSignature && savedEmployeeSignature) {
            console.log('🚨 Blocked identical signature display for employee');
            employeeSigContainer.innerHTML = '<span class="text-orange-500 dark:text-orange-400 text-sm">⚠️ ลายเซ็นซ้ำกับลูกค้า</span>';
          }
        }
      },
    
      loadWitnessData(stepData) {
        try {
          console.log('👥 Loading witness data from stepData:', stepData);
    
          // หาข้อมูลพยานจากแหล่งต่างๆ
          let witnessData = null;
    
          // 1. ตรวจสอบจาก stepData.witness
          if (stepData?.witness) {
            witnessData = stepData.witness;
            console.log('👥 Found witness data in stepData.witness:', witnessData);
          }
    
          // 1.5 ตรวจสอบจาก stepData.customer.witness
          if (!witnessData && stepData?.customer?.witness) {
            witnessData = stepData.customer.witness;
            console.log('👥 Found witness data in stepData.customer.witness:', witnessData);
          }
    
          // 2. ตรวจสอบจาก localStorage - เพิ่ม debug
          if (!witnessData) {
            console.log('👥 Searching for witness data in localStorage...');
    
            // ตรวจสอบ witness_data key
            const witnessJson = localStorage.getItem('witness_data');
            console.log('👥 witness_data from localStorage:', witnessJson);
    
            if (witnessJson) {
              try {
                witnessData = JSON.parse(witnessJson);
                console.log('👥 Found witness data in localStorage:', witnessData);
              } catch (e) {
                console.warn('👥 Invalid witness JSON in localStorage:', e);
              }
            } else {
              console.log('👥 No witness_data in localStorage, checking other keys...');
    
              // ตรวจสอบ keys อื่นๆ ที่อาจมีข้อมูลพยาน
              const allKeys = Object.keys(localStorage);
              const witnessKeys = allKeys.filter(key =>
                key.toLowerCase().includes('witness') ||
                key.toLowerCase().includes('พยาน')
              );
    
              console.log('👥 Available witness-related keys:', witnessKeys);
    
              // หากมี witness keys อื่น ลองใช้
              if (witnessKeys.length > 0) {
                for (const key of witnessKeys) {
                  const value = localStorage.getItem(key);
                  console.log(`👥 Checking ${key}:`, value);
    
                  // หากเป็น JSON object
                  if (value && (value.startsWith('{') || value.startsWith('['))) {
                    try {
                      const parsed = JSON.parse(value);
                      if (parsed && typeof parsed === 'object' && (parsed.firstName || parsed.name)) {
                        witnessData = parsed;
                        console.log(`👥 Found witness data in ${key}:`, witnessData);
                        break;
                      }
                    } catch (e) {
                      console.log(`👥 Could not parse ${key} as JSON`);
                    }
                  }
                }
              }
            }
          }
    
          // 3. ตรวจสอบจาก hidden input (กรณีที่ข้อมูลถูกเก็บใน form)
          if (!witnessData) {
            const witnessDataInput = document.getElementById('witnessData');
            if (witnessDataInput && witnessDataInput.value) {
              try {
                witnessData = JSON.parse(witnessDataInput.value);
                console.log('👥 Found witness data in hidden input:', witnessData);
              } catch (e) {
                console.warn('👥 Invalid witness JSON in hidden input');
              }
            }
          }
    
          if (witnessData && Object.keys(witnessData).length > 0) {
            console.log('👥 Loading witness information:', witnessData);
            console.log('👥 Witness data keys:', Object.keys(witnessData));
            console.log('👥 Witness field values:');
            console.log('  name:', witnessData.name);
            console.log('  firstName:', witnessData.firstName);
            console.log('  lastName:', witnessData.lastName);
            console.log('  relation:', witnessData.relation);
            console.log('  relationship:', witnessData.relationship);
    
            // ข้อมูลพื้นฐานพยาน - รองรับหลาย field names
            // Parse name if it's a single field
            let witnessFirstName = witnessData.firstName || witnessData.first_name || witnessData.witnessFirstName || '';
            let witnessLastName = witnessData.lastName || witnessData.last_name || witnessData.witnessLastName || '';
    
            console.log('👥 Initial name parsing:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              fromData: {
                firstName: witnessData.firstName,
                lastName: witnessData.lastName,
                name: witnessData.name
              }
            });
    
            // If name is empty but there's a 'name' field, try to split it
            if ((!witnessFirstName && !witnessLastName) && witnessData.name && witnessData.name.trim()) {
              console.log('👥 Splitting name field:', witnessData.name);
              const nameParts = witnessData.name.trim().split(' ');
              if (nameParts.length >= 2) {
                witnessFirstName = nameParts[0];
                witnessLastName = nameParts.slice(1).join(' ');
                console.log('👥 Split into:', { firstName: witnessFirstName, lastName: witnessLastName });
              } else if (nameParts.length === 1) {
                witnessFirstName = nameParts[0];
                console.log('👥 Single name:', witnessFirstName);
              }
            }
    
            // Check stepData level for witness info (อาจมี firstName ที่ระดับ stepData)
            if (!witnessFirstName && stepData?.firstName) {
              witnessFirstName = stepData.firstName;
              console.log('👥 Using stepData firstName:', witnessFirstName);
            }
            if (!witnessLastName && stepData?.lastName) {
              witnessLastName = stepData.lastName;
              console.log('👥 Using stepData lastName:', witnessLastName);
            }
    
            const witnessIdCard = witnessData.idCard || witnessData.id_card || witnessData.witnessIdCard || witnessData.idNumber;
            const witnessRelationship = witnessData.relationship || witnessData.witnessRelationship || witnessData.relation || '';
            const witnessPhone = witnessData.phone || witnessData.phoneNumber || witnessData.phone_number || witnessData.witnessPhone;
    
            console.log('👥 Final parsed values:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              idCard: witnessIdCard,
              relationship: witnessRelationship,
              phone: witnessPhone
            });
    
            // แสดงข้อมูลพยานที่ถูกต้องจาก localStorage
            console.log('👥 Setting witness display fields:', {
              firstName: witnessFirstName,
              lastName: witnessLastName,
              idCard: witnessIdCard,
              relationship: witnessRelationship,
              phone: witnessPhone
            });
    
            document.getElementById('modalWitnessFirstName').textContent = witnessFirstName || 'ไม่ระบุ';
            document.getElementById('modalWitnessLastName').textContent = witnessLastName || 'ไม่ระบุ';
            document.getElementById('modalWitnessIdCard').textContent = witnessIdCard || 'ไม่ระบุ';
    
            // แปลง relationship จาก English เป็น Thai
            let relationshipThai = witnessRelationship;
            if (witnessRelationship === 'friend') {
              relationshipThai = 'เพื่อน';
            } else if (witnessRelationship === 'sibling') {
              relationshipThai = 'พี่น้อง';
            } else if (witnessRelationship === 'relative') {
              relationshipThai = 'ญาติ';
            } else if (witnessRelationship === 'colleague') {
              relationshipThai = 'เพื่อนร่วมงาน';
            }
    
            document.getElementById('modalWitnessRelationship').textContent = relationshipThai || 'ไม่ระบุ';
            document.getElementById('modalWitnessPhone').textContent = witnessPhone || 'ไม่ระบุ';
    
            // ชื่อเต็มพยาน
            const fullName = `${witnessFirstName || ''} ${witnessLastName || ''}`.trim();
            document.getElementById('modalWitnessFullName').textContent = fullName;
    
            // รูปถ่ายพยาน
            this.loadWitnessPhoto(witnessData);
    
            // รูปบัตรประชาชนพยาน
            this.loadWitnessIdCardImage(witnessData);
    
            console.log('✅ Witness data loaded successfully');
          } else {
            console.log('👥 No witness data found, using customer data as witness');
            this.useCustomerAsWitness(stepData);
          }
    
        } catch (error) {
          console.error('❌ Error loading witness data:', error);
          this.useCustomerAsWitness(stepData);
        }
      },
    
      loadWitnessPhoto(witnessData) {
        const photoContainer = document.getElementById('modalWitnessPhoto');
    
        // ลำดับความสำคัญในการหารูป: server URL -> base64 -> localStorage
        const photoSources = [
          localStorage.getItem('witness_witnessPhoto_url'),
          witnessData.photoUrl,
          localStorage.getItem('witness_witnessPhoto'),
          witnessData.photo,
          witnessData.witnessPhoto
        ];
    
        const validPhotoUrl = photoSources.find(url => url && url.trim() !== '');
    
        if (validPhotoUrl) {
          console.log('👥 Loading witness photo from:', validPhotoUrl.substring(0, 50) + '...');
          photoContainer.innerHTML = `
            <img src="${validPhotoUrl}" 
                 alt="รูปถ่ายพยาน" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validPhotoUrl}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-red-500\\'>ไม่สามารถโหลดรูปได้</div>';">
          `;
        } else {
          photoContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-image text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปถ่ายพยาน</span>
            </div>
          `;
        }
      },
    
      loadWitnessIdCardImage(witnessData) {
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
    
        // ลำดับความสำคัญในการหารูป: server URL -> base64 -> localStorage
        const idCardSources = [
          localStorage.getItem('witness_witnessIdCard_url'),
          witnessData.idCardImageUrl,
          localStorage.getItem('witness_witnessIdCard'),
          witnessData.idCardImage,
          witnessData.witnessIdCard
        ];
    
        const validIdCardUrl = idCardSources.find(url => url && url.trim() !== '');
    
        if (validIdCardUrl) {
          console.log('👥 Loading witness ID card from:', validIdCardUrl.substring(0, 50) + '...');
          idCardContainer.innerHTML = `
            <img src="${validIdCardUrl}" 
                 alt="รูปบัตรประชาชนพยาน" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validIdCardUrl}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-red-500\\'>ไม่สามารถโหลดรูปได้</div>';">
          `;
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400">
              <i class="bi bi-credit-card text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปบัตรประชาชนพยาน</span>
            </div>
          `;
        }
      },
    
      showNoWitnessData() {
        // แสดงข้อความเมื่อไม่มีข้อมูลพยาน
        const witnessElements = [
          'modalWitnessFirstName', 'modalWitnessLastName', 'modalWitnessIdCard',
          'modalWitnessRelationship', 'modalWitnessPhone', 'modalWitnessFullName'
        ];
    
        witnessElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = '<span class="text-red-500">ไม่พบข้อมูล - โปรดกรอกข้อมูลใน Step 2</span>';
          }
        });
    
        // แสดงข้อความสำหรับรูปภาพ
        const photoContainer = document.getElementById('modalWitnessPhoto');
        if (photoContainer) {
          photoContainer.innerHTML = `
            <div class="text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่พบรูปถ่ายพยาน</span>
            </div>
          `;
        }
    
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
        if (idCardContainer) {
          idCardContainer.innerHTML = `
            <div class="text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่พบรูปบัตรประชาชนพยาน</span>
            </div>
          `;
        }
    
        console.warn('❌ แสดงข้อความไม่มีข้อมูลพยานให้ผู้ใช้');
      },
    
      loadWitnessDataForModal(stepData) {
        try {
          console.log('👥 [Modal] Loading witness data for customer modal...');
    
          // Priority 1: ตรวจสอบจาก localStorage ก่อน (ข้อมูลล่าสุด)
          let witnessData = null;
          const witnessJson = localStorage.getItem('witness_data');
    
          if (witnessJson) {
            try {
              witnessData = JSON.parse(witnessJson);
              console.log('👥 [Modal] Found witness data in localStorage:', witnessData);
            } catch (e) {
              console.warn('👥 [Modal] Invalid witness JSON in localStorage');
            }
          }
    
          // Priority 2: ถ้าไม่มีใน localStorage ให้ใช้จาก stepData
          if (!witnessData && stepData?.witness) {
            witnessData = stepData.witness;
            console.log('👥 [Modal] Using witness data from stepData:', witnessData);
          }
    
          if (witnessData && Object.keys(witnessData).length > 0) {
            console.log('👥 [Modal] Processing witness data:', witnessData);
    
            // Extract fields - รองรับหลายรูปแบบ
            const firstName = witnessData.firstName || witnessData.first_name || '';
            const lastName = witnessData.lastName || witnessData.last_name || '';
            const idCard = witnessData.idCard || witnessData.id_card || '';
            const phone = witnessData.phone || witnessData.phone_number || '';
            let relationship = witnessData.relationship || witnessData.relation || '';
    
            // แปลความสัมพันธ์เป็นภาษาไทย
            if (relationship === 'friend') {
              relationship = 'เพื่อน';
            } else if (relationship === 'sibling') {
              relationship = 'พี่น้อง';
            } else if (relationship === 'relative') {
              relationship = 'ญาติ';
            } else if (relationship === 'colleague') {
              relationship = 'เพื่อนร่วมงาน';
            }
    
            console.log('👥 [Modal] Setting fields:', {
              firstName,
              lastName,
              idCard,
              phone,
              relationship
            });
    
            // Update DOM elements
            document.getElementById('modalWitnessFirstName').textContent = firstName || 'ไม่ระบุ';
            document.getElementById('modalWitnessLastName').textContent = lastName || 'ไม่ระบุ';
            document.getElementById('modalWitnessIdCard').textContent = idCard || 'ไม่ระบุ';
            document.getElementById('modalWitnessRelationship').textContent = relationship || 'ไม่ระบุ';
            document.getElementById('modalWitnessPhone').textContent = phone || 'ไม่ระบุ';
    
            // ชื่อเต็ม
            const fullName = `${firstName} ${lastName}`.trim();
            document.getElementById('modalWitnessFullName').textContent = fullName || 'ไม่ระบุ';
    
            console.log('✅ [Modal] Witness data loaded successfully');
          } else {
            console.log('👥 [Modal] No witness data found, using fallback');
            // แสดงข้อความแทน
            const noDataMessage = '<span class="text-amber-600">ไม่พบข้อมูลพยาน</span>';
            document.getElementById('modalWitnessFirstName').innerHTML = noDataMessage;
            document.getElementById('modalWitnessLastName').innerHTML = noDataMessage;
            document.getElementById('modalWitnessRelationship').innerHTML = noDataMessage;
            document.getElementById('modalWitnessPhone').innerHTML = noDataMessage;
            document.getElementById('modalWitnessFullName').innerHTML = noDataMessage;
          }
    
        } catch (error) {
          console.error('❌ [Modal] Error loading witness data:', error);
        }
      },
    
      useCustomerAsWitness(stepData) {
        try {
          console.log('👥 Using customer data as witness fallback');
    
          // ดึงข้อมูลลูกค้าจาก stepData
          const customerData = stepData?.customer || stepData || {};
          const actualCustomerData = customerData.customer || customerData;
    
          // ใช้ข้อมูลลูกค้าเป็นพยาน
          const witnessFirstName = actualCustomerData.first_name || actualCustomerData.firstName || 'ไม่ระบุ';
          const witnessLastName = actualCustomerData.last_name || actualCustomerData.lastName || 'ไม่ระบุ';
          const witnessIdCard = actualCustomerData.tax_id || actualCustomerData.idCard || actualCustomerData.idNumber || 'ไม่ระบุ';
          const witnessPhone = actualCustomerData.phone_number || actualCustomerData.phone || actualCustomerData.phoneNumber || 'ไม่ระบุ';
    
          // แสดงข้อมูลพยาน (ใช้ข้อมูลลูกค้า)
          document.getElementById('modalWitnessFirstName').textContent = witnessFirstName;
          document.getElementById('modalWitnessLastName').textContent = witnessLastName;
          document.getElementById('modalWitnessIdCard').textContent = witnessIdCard;
          document.getElementById('modalWitnessRelationship').textContent = 'ตัวลูกค้าเอง';
          document.getElementById('modalWitnessPhone').textContent = witnessPhone;
    
          // ชื่อเต็มพยาน
          const fullName = `${witnessFirstName} ${witnessLastName}`.trim();
          document.getElementById('modalWitnessFullName').textContent = fullName;
    
          // แสดงรูปภาพจากข้อมูลลูกค้า
          this.loadCustomerAsWitnessPhotos(stepData);
    
          console.log('✅ Customer data used as witness successfully');
    
        } catch (error) {
          console.error('❌ Error using customer as witness:', error);
          this.showNoWitnessData();
        }
      },
    
      loadCustomerAsWitnessPhotos(stepData) {
        const photoContainer = document.getElementById('modalWitnessPhoto');
        const idCardContainer = document.getElementById('modalWitnessIdCardImage');
    
        // ใช้รูปลูกค้าเป็นรูปพยาน
        const attachments = stepData?.attachments || {};
    
        // รูปถ่ายพยาน (ใช้รูปลูกค้า)
        const customerPhotoSources = [
          localStorage.getItem('customer_photo_url'),
          localStorage.getItem('customerPhotoData'),
          attachments.customerPhoto
        ];
    
        const validCustomerPhoto = customerPhotoSources.find(url => url && url.trim() !== '');
    
        if (validCustomerPhoto) {
          photoContainer.innerHTML = `
            <img src="${validCustomerPhoto}" 
                 alt="รูปถ่ายลูกค้า (ใช้เป็นพยาน)" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validCustomerPhoto}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-yellow-500\\'>ไม่มีรูปถ่าย</div>';">
            <div class="absolute top-0 right-0 bg-blue-500 text-white px-2 py-1 text-xs rounded-bl">
              ลูกค้าเป็นพยาน
            </div>
          `;
        } else {
          photoContainer.innerHTML = `
            <div class="text-center text-yellow-500">
              <i class="bi bi-person-circle text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปถ่าย</span>
              <div class="text-xs mt-1">(ลูกค้าเป็นพยาน)</div>
            </div>
          `;
        }
    
        // รูปบัตรประชาชนพยาน (ใช้รูปบัตรลูกค้า)
        const idCardSources = [
          localStorage.getItem('customer_idCard_url'),
          localStorage.getItem('idCardImageData'),
          attachments.idCard
        ];
    
        const validIdCard = idCardSources.find(url => url && url.trim() !== '');
    
        if (validIdCard) {
          idCardContainer.innerHTML = `
            <img src="${validIdCard}" 
                 alt="บัตรประชาชนลูกค้า (ใช้เป็นพยาน)" 
                 class="w-full h-full object-contain rounded cursor-pointer"
                 onclick="window.open('${validIdCard}', '_blank')"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center text-yellow-500\\'>ไม่มีรูปบัตร</div>';">
            <div class="absolute top-0 right-0 bg-blue-500 text-white px-2 py-1 text-xs rounded-bl">
              ลูกค้าเป็นพยาน
            </div>
          `;
        } else {
          idCardContainer.innerHTML = `
            <div class="text-center text-yellow-500">
              <i class="bi bi-credit-card text-2xl mb-2 block"></i>
              <span class="text-sm">ไม่มีรูปบัตรประชาชน</span>
              <div class="text-xs mt-1">(ลูกค้าเป็นพยาน)</div>
            </div>
          `;
        }
      }
    };
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // เปิด modal
      document.getElementById('btnViewFullCustomerDetails')?.addEventListener('click', function() {
        window.customerDetailsModal.showModal();
      });
    
      // Debug button
      document.getElementById('btnDebugCustomerData')?.addEventListener('click', function() {
        console.clear();
        console.log('🔍 === DEBUG CUSTOMER DATA ===');
        console.log('1. globalInstallmentManager exists:', !!window.globalInstallmentManager);
    
        if (window.globalInstallmentManager) {
          console.log('2. globalInstallmentManager methods:');
          console.log('   - getStepData:', typeof window.globalInstallmentManager.getStepData);
          console.log('   - currentStep:', window.globalInstallmentManager.currentStep);
          console.log('   - isInitialized:', window.globalInstallmentManager.isInitialized);
    
          for (let i = 1; i <= 4; i++) {
            const stepData = window.globalInstallmentManager.getStepData(i);
            console.log(`3. Step ${i} data:`, stepData);
          }
        }
    
        console.log('4. Step 2 customer data structure:');
        const step2Data = window.globalInstallmentManager?.getStepData(2);
        if (step2Data) {
          console.log('   step2Data.customer:', step2Data.customer);
          console.log('   step2Data.signature:', step2Data.signature);
          console.log('   step2Data.attachments:', step2Data.attachments);
    
          // แสดงรายละเอียด attachments
          if (step2Data.attachments) {
                    console.log('   attachments breakdown:');
        Object.keys(step2Data.attachments).forEach(key => {
          const attachment = step2Data.attachments[key];
          if (attachment) {
            console.log(`     ${key}:`, {
              hasData: !!(attachment.data || attachment.imageData),
              hasUrl: !!attachment.url,
              timestamp: attachment.timestamp,
              size: (attachment.data || attachment.imageData) ? 'found' : 'not found',
              fullStructure: attachment // แสดงโครงสร้างเต็ม
            });
          }
        });
          }
        }
    
        console.log('5. LocalStorage data:');
        const localData = window.customerDetailsModal.getLocalStorageData();
        console.log('   Combined local data:', localData);
    
        console.log('6. Image localStorage items:');
        const imageKeys = [
          'idCardImageData', 'idCardImage', 'idCardImageUrl',
          'selfieImageData', 'selfieImage', 'selfieImageUrl',
          'salarySlipImageData', 'salarySlipImage', 'salarySlipImageUrl'
        ];
        imageKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        console.log('7. Signature localStorage items:');
        const signatureKeys = [
          'customerSignature', 'step2_signature',
          'employeeSignature', 'salespersonSignature'
        ];
        signatureKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        console.log('8. Other important localStorage items:');
        const otherKeys = ['step2_customerData'];
        otherKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            if (key === 'step2_customerData') {
              try {
                console.log(`   ${key}:`, JSON.parse(value));
              } catch {
                console.log(`   ${key}: (invalid JSON)`);
              }
            } else {
              console.log(`   ${key}:`, value.substring(0, 100) + (value.length > 100 ? '...' : ''));
            }
          } else {
            console.log(`   ${key}: (not found)`);
          }
        });
    
        alert('กรุณาเปิด Console (F12) เพื่อดูข้อมูล Debug');
      });
    
      // ปิด modal
      document.getElementById('btnCloseCustomerModal')?.addEventListener('click', function() {
        window.customerDetailsModal.hideModal();
      });
    
      document.getElementById('btnCloseCustomerModalFooter')?.addEventListener('click', function() {
        window.customerDetailsModal.hideModal();
      });
    
      // แก้ไขข้อมูล - กลับไป step2
      document.getElementById('btnEditCustomerData')?.addEventListener('click', function() {
        if (confirm('คุณต้องการกลับไปแก้ไขข้อมูลลูกค้าใหม่?')) {
          window.location.href = '/step2';
        }
      });
    
      // ปิด modal เมื่อคลิกพื้นหลัง
      document.getElementById('customerDetailsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
          window.customerDetailsModal.hideModal();
        }
      });
    });
  </script>

  <!-- 🚀 MANDATORY DATABASE-ONLY: Ensure Step4Integration uses ONLY database, no fallback -->
  <script>
    // เรียก Step4Integration.js ที่มีอยู่แล้วและบังคับให้ใช้ฐานข้อมูลเท่านั้น
    document.addEventListener('DOMContentLoaded', function() {
      // 🚨 MANDATORY: ห้ามใช้อย่างอื่นนอกจากฐานข้อมูล
      if (typeof Step4Integration !== 'undefined') {
        console.log('� MANDATORY: Step4Integration set to DATABASE-ONLY mode');
    
        // บังคับให้ generateReceiptDocument ใช้ฐานข้อมูลเท่านั้น
        if (window.step4Integration && window.step4Integration.generateReceiptDocument) {
          const originalGenerateReceipt = window.step4Integration.generateReceiptDocument.bind(window.step4Integration);
    
          window.step4Integration.generateReceiptDocument = async function(documentData) {
            console.log('🚨 MANDATORY DATABASE-ONLY: Receipt generation starting...');
    
            try {
              // เรียกฟังก์ชันเดิม (ที่มี MANDATORY database persistence)
              const result = await originalGenerateReceipt(documentData);
              console.log('✅ MANDATORY: Receipt saved to database successfully');
              return result;
            } catch (error) {
              // 🚨 MANDATORY: ไม่อนุญาต fallback - หยุดการทำงานทั้งหมด
              if (error.message.includes('MANDATORY ERROR')) {
                console.error('🚨 MANDATORY DATABASE ERROR: Receipt generation failed');
                alert('❌ ข้อผิดพลาด: ไม่สามารถบันทึกใบเสร็จลงฐานข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่อฐานข้อมูล');
                throw error;
              }
              throw error;
            }
          };
        }
    
        // บังคับให้ generateTaxInvoiceDocument ใช้ฐานข้อมูลเท่านั้น
        if (window.step4Integration && window.step4Integration.generateTaxInvoiceDocument) {
          const originalGenerateTaxInvoice = window.step4Integration.generateTaxInvoiceDocument.bind(window.step4Integration);
    
          window.step4Integration.generateTaxInvoiceDocument = async function(documentData) {
            console.log('🚨 MANDATORY DATABASE-ONLY: Tax invoice generation starting...');
    
            try {
              // เรียกฟังก์ชันเดิม (ที่มี MANDATORY database persistence)
              const result = await originalGenerateTaxInvoice(documentData);
              console.log('✅ MANDATORY: Tax invoice saved to database successfully');
              return result;
            } catch (error) {
              // 🚨 MANDATORY: ไม่อนุญาต fallback - หยุดการทำงานทั้งหมด
              if (error.message.includes('MANDATORY ERROR')) {
                console.error('� MANDATORY DATABASE ERROR: Tax invoice generation failed');
                alert('❌ ข้อผิดพลาด: ไม่สามารถบันทึกใบกำกับภาษีลงฐานข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่อฐานข้อมูล');
                throw error;
              }
              throw error;
            }
          };
        }
    
        // บังคับให้ createContract ใช้ฐานข้อมูลเท่านั้น
        if (window.step4Integration && window.step4Integration.createContract) {
          const originalCreateContract = window.step4Integration.createContract.bind(window.step4Integration);
    
          window.step4Integration.createContract = async function() {
            console.log('🚨 MANDATORY DATABASE-ONLY: Contract creation starting...');
    
            // เพิ่มการรวบรวมลายเซ็นก่อนส่งข้อมูล
            await this.ensureSignaturesIncluded();
    
            try {
              // เรียกฟังก์ชันเดิม (ที่ต้องบันทึกลงฐานข้อมูลเท่านั้น)
              const result = await originalCreateContract();
              console.log('✅ MANDATORY: Contract saved to database successfully');
              return result;
            } catch (error) {
              console.error('🚨 MANDATORY DATABASE ERROR: Contract creation failed:', error);
              alert('❌ ข้อผิดพลาด: ไม่สามารถบันทึกสัญญาลงฐานข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่อฐานข้อมูล');
              throw error;
            }
          };
    
          // เพิ่มฟังก์ชันใহม่สำหรับตรวจสอบลายเซ็น
          window.step4Integration.ensureSignaturesIncluded = async function() {
            console.log('🖋️ MANDATORY: Ensuring all signatures are included in database submission...');
    
            const signatures = {
              customerSignature: localStorage.getItem('customerSignature') || '',
              salespersonSignature: localStorage.getItem('salespersonSignature') || '',
              authorizedSignature: localStorage.getItem('salespersonSignature') || ''
            };
    
            console.log('🔍 MANDATORY Signature status for database:', {
              customer: signatures.customerSignature ? 'Present' : 'Missing',
              salesperson: signatures.salespersonSignature ? 'Present' : 'Missing',
              authorized: signatures.authorizedSignature ? 'Present' : 'Missing'
            });
    
            // บันทึกลายเซ็นใน global data manager สำหรับส่งไปฐานข้อมูล
            if (window.globalInstallmentManager) {
              const step2Data = window.globalInstallmentManager.getStepData(2) || {};
              if (!step2Data.signatures) {
                step2Data.signatures = {};
              }
    
              step2Data.signatures.customer = signatures.customerSignature;
              step2Data.signatures.salesperson = signatures.salespersonSignature;
              step2Data.signatures.authorized = signatures.authorizedSignature;
    
              // ใช้ setStepData (alias ของ updateStepData)
              window.globalInstallmentManager.setStepData(2, step2Data);
              console.log('✅ MANDATORY: Signatures prepared for database submission');
            }
    
            return signatures;
          };
    
          console.log('✅ MANDATORY: Step4Integration configured for DATABASE-ONLY mode');
        }
      } else {
        console.error('🚨 MANDATORY ERROR: Step4Integration not found - please check js/step4-integration.js');
        alert('❌ ข้อผิดพลาด: ไม่พบ Step4Integration กรุณาตรวจสอบไฟล์ js/step4-integration.js');
      }
    });
    
    // ฟังก์ชันโหลดสรุปรายการสินค้า step4
    // Helper function to clean image paths
    function cleanImagePath(imagePath) {
      if (!imagePath) {
        return '/uploads/Logo2.png';
      }
    
      if (imagePath.startsWith('http')) {
        return imagePath;
      }
    
      let cleanedPath = imagePath.toString().trim();
    
      // Convert all backslashes to forward slashes first
      cleanedPath = cleanedPath.replace(/\\/g, '/');
    
      // Remove duplicate /uploads/products/ segments
      const patterns = [
        /\/uploads\/products\/uploads\/products\//g,
        /uploads\/products\/uploads\/products\//g,
        /\/uploads\/products\/(?:uploads\/products\/)+/g,
        /uploads\/products\/(?:uploads\/products\/)+/g
      ];
    
      patterns.forEach(pattern => {
        cleanedPath = cleanedPath.replace(pattern, '/uploads/products/');
      });
    
      // Clean up multiple slashes
      cleanedPath = cleanedPath.replace(/\/+/g, '/');
    
      // Ensure path starts with /
      if (!cleanedPath.startsWith('/')) {
        cleanedPath = '/' + cleanedPath;
      }
    
      // If it doesn't contain uploads/products/, add it
      if (!cleanedPath.includes('uploads/products/')) {
        const filename = cleanedPath.replace(/^\/+/, '');
        cleanedPath = `/uploads/products/${filename}`;
      }
    
      return cleanedPath;
    }

    function loadStep4ItemsSummary() {
      const itemsSummaryDiv = document.getElementById('itemsSummary');
    
      if (!itemsSummaryDiv) {
        console.warn('Step4: Items summary element not found');
        return;
      }
    
      // ดึงข้อมูลสินค้าจาก step1
      const step1Data = window.globalInstallmentManager?.getStepData(1);
      let products = [];
    
      if (step1Data?.cartItems) {
        products = step1Data.cartItems;
      } else {
        // Fallback to localStorage
        try {
          const cartData = localStorage.getItem('cartItems') || localStorage.getItem('cartData');
          if (cartData) {
            products = JSON.parse(cartData);
          }
        } catch (e) {
          console.error('Error loading cart data:', e);
        }
      }
    
      if (products.length === 0) {
        // Safe DOM manipulation instead of innerHTML
        itemsSummaryDiv.innerHTML = ''; // Clear first
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-6';
    
        const icon = document.createElement('i');
        icon.className = 'bi bi-cart-x text-3xl text-gray-400';
    
        const text = document.createElement('p');
        text.className = 'text-gray-500 mt-2';
        text.textContent = 'ไม่พบรายการสินค้า';
    
        emptyDiv.appendChild(icon);
        emptyDiv.appendChild(text);
        itemsSummaryDiv.appendChild(emptyDiv);
        return;
      }
    
      let html = '';
    
      products.forEach((item, index) => {
        const quantity = item.quantity || 1;
        const downAmount = parseFloat(item.downAmount || 0);
        const downInstallment = parseFloat(item.downInstallment || 0);
        const downInstallmentCount = parseInt(item.downInstallmentCount || 0);
        // ยอดสินค้าทั้งหมด = เงินดาวน์ + (ค่างวดต่อเดือน × จำนวนงวด)
        const totalPrice = downAmount + (downInstallment * downInstallmentCount);
        const subtotal = downAmount * quantity;
    
        html += `
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-white dark:bg-gray-600 rounded-lg flex items-center justify-center overflow-hidden">
                ${item.image ?
                  `<img src="${cleanImagePath(item.image)}" alt="${item.name}" class="w-full h-full object-cover rounded">` :
                  '<i class="bi bi-phone text-gray-400"></i>'
                }
              </div>
              
              <div class="flex-1 min-w-0">
                <h6 class="font-semibold text-sm">${escapeHtml(item.name || 'สินค้า')}</h6>
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ${item.brand ? `<span class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">${escapeHtml(item.brand)}</span>` : ''}
                  ${item.imei ? `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded font-mono">IMEI: ${escapeHtml(item.imei)}</span>` : ''}
                </div>
                
                <div class="mt-2 bg-white dark:bg-gray-600 p-2 rounded text-xs">
                  <div class="grid grid-cols-4 gap-1 text-center">
                    <div>
                      <div class="text-gray-500">ดาวน์</div>
                      <div class="font-bold text-green-600">฿${formatPriceStep4(downAmount)}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">ผ่อน/เดือน</div>
                      <div class="font-bold text-purple-600">฿${formatPriceStep4(downInstallment)}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">งวด</div>
                      <div class="font-bold text-blue-600">${downInstallmentCount}</div>
                    </div>
                    <div>
                      <div class="text-gray-500">ยอดทั้งหมด</div>
                      <div class="font-bold text-orange-600">฿${formatPriceStep4(totalPrice)}</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-right">
                <div class="text-sm text-gray-500">จำนวน: ${quantity}</div>
                <div class="font-bold text-blue-600 text-lg">฿${formatPriceStep4(subtotal)}</div>
                <div class="text-xs text-gray-500">(ยอดดาวน์)</div>
              </div>
            </div>
          </div>
        `;
      });
    
      itemsSummaryDiv.innerHTML = html;
    
      console.log('✅ Step4: Items summary loaded with', products.length, 'items');
    }
    
    // Helper function for price formatting in step4
    function formatPriceStep4(num) {
      return Number(num || 0).toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
  </script>

  <!-- =============================================
       INSTALLMENT DATA CONSOLIDATION & BACKEND SUBMISSION
       รวบรวมข้อมูลจากทุก Step และส่งไป Backend
       Version 3.0 - Optimized for existing button
  ============================================= -->
  <script>
    // ฟังก์ชันแปลง plan_type ให้ตรงกับ backend validation
    function mapPlanType(planType) {
      console.log('🔄 Mapping plan type:', planType);
    
      // Map frontend plan types to backend accepted values
      const planTypeMap = {
        'custom': 'plan1',        // Custom plans become plan1
        'recommended': 'plan2',   // Recommended plans become plan2
        'manual': 'plan1',        // Manual plans become plan1
        'plan1': 'plan1',         // Already valid
        'plan2': 'plan2',         // Already valid
        'plan3': 'plan3'          // Already valid
      };
    
      const mappedType = planTypeMap[planType] || 'plan1';
      console.log('✅ Plan type mapped:', { original: planType, mapped: mappedType });
      return mappedType;
    }

    // ฟังก์ชันรวบรวมข้อมูลทั้งหมด
    async function collectAllInstallmentData() {
      console.log('📦 Collecting all installment data from Steps 1-4...');
    
      try {
        // Step 1: ข้อมูลสินค้า
        const step1Products = getStep1Products();
    
        // Step 2: ข้อมูลลูกค้า
        const step2Customer = getStep2Customer();
    
        // Step 3: ข้อมูลใบเสนอราคา/ภาษี
        const step3Invoice = getStep3Invoice();
    
        // Step 4: ข้อมูลการชำระเงิน (async function)
        const step4Payment = await getStep4Payment();
    
        // รวมข้อมูลทั้งหมดในรูปแบบที่ payment controller ต้องการ
        const consolidatedData = {
          // ข้อมูลสินค้า (จำเป็น)
          items: step1Products.items || [],
    
          // ข้อมูลลูกค้า (จำเป็น)
          customer_type: 'individual', // Default to individual
          customer: {
            prefix: step2Customer.customer?.prefix || 'นาย',
            first_name: step2Customer.customer?.first_name || '',
            last_name: step2Customer.customer?.last_name || '',
            phone_number: step2Customer.customer?.phone_number || '',
            email: step2Customer.customer?.email || '',
            tax_id: step2Customer.customer?.tax_id || '',
            address: step2Customer.customer?.address || {}
          },
    
          // ข้อมูลพยาน (ถ้ามี)
          witness: {
            name: '',
            id_card: '',
            phone: '',
            relation: ''
          },
    
          // ข้อมูลไฟล์แนบ (ถ้ามี)
          attachments: {
            id_card_image: '',
            income_slip: '',
            selfie_image: '',
            customer_signature: step4Payment.customer_signature || '',
            salesperson_signature: step4Payment.salesperson_signature || '',
            authorized_signature: ''
          },
    
          // ข้อมูลแผนการชำระ (จำเป็น)
          plan_type: mapPlanType(step3Invoice.plan_type) || 'plan1',
          down_payment: parseFloat(step3Invoice.down_payment || 0),
          installment_count: parseInt(step3Invoice.installment_count || 12),
          installment_amount: parseFloat(step3Invoice.installment_amount || 0),
          credit_amount: parseFloat(step3Invoice.credit_amount || 0),
          payoff_amount: parseFloat(step3Invoice.payoff_amount || 0),
          doc_fee: parseFloat(step3Invoice.document_fee || 0),
          quotation_no: '',
          credit_term: `${step3Invoice.installment_count || 12} เดือน`,
          sub_total: parseFloat(step1Products.totalAmount || 0),
          total_amount: parseFloat(step3Invoice.total_with_tax || step3Invoice.total_amount || step1Products.totalAmount || 0),
          total_text: '',
          quotation_terms: '',
    
          // ข้อมูลสาขาและพนักงาน
          branch_code: window.BRANCH_CODE || '00000',
          salesperson_id: step4Payment.salesperson_id || '',
    
          // ตัวเลือกเพิ่มเติม
          appliedPromotions: [],
          promotionDiscount: 0,
          skipStockDeduction: false,
          payoffContract: false,
    
          timestamp: new Date().toISOString()
        };
    
        console.log('✅ Data collected successfully:', consolidatedData);
        return consolidatedData;
    
      } catch (error) {
        console.error('❌ Error collecting data:', error);
        throw error;
      }
    }
    
    // ดึงข้อมูลสินค้าจาก Step 1
    function getStep1Products() {
      console.log('📦 Getting Step 1 product data...');
    
      // 🔧 แก้ไข: รองรับ pointer system เพื่อลดการใช้ memory
      function getDataWithPointer(key) {
        // ตรวจสอบว่าเป็น pointer หรือไม่
        const pointerKey = key + '_pointer';
        const pointer = localStorage.getItem(pointerKey);
    
        if (pointer) {
          // ถ้าเป็น pointer ให้ดึงข้อมูลจาก key จริง
          console.log(`📎 Found pointer: ${key} → ${pointer}`);
          return localStorage.getItem(pointer);
        }
    
        // ถ้าไม่ใช่ pointer ดึงข้อมูลตรงๆ
        return localStorage.getItem(key);
      }
    
      // ลองหาข้อมูลจากหลายแหล่ง
      let products = [];
      const sources = ['cartItems', 'cartData', 'step1_selectedProducts', 'selectedProducts'];
    
      for (const key of sources) {
        const data = getDataWithPointer(key);
        if (data) {
          try {
            products = JSON.parse(data);
            console.log(`✅ Found products in ${key}`);
            break;
          } catch (e) {
            console.warn(`Failed to parse ${key}:`, e);
          }
        }
      }
    
      // ข้อมูลแผนผ่อน
      let installmentPlan = {};
      const planData = localStorage.getItem('installmentData_step1');
      if (planData) {
        try {
          installmentPlan = JSON.parse(planData);
        } catch (e) {}
      }
    
      return {
        items: Array.isArray(products) ? products.map(item => ({
          // 🔧 แก้ไขเพื่อรองรับการตัดสต๊อกด้วย IMEI เป็นหลัก
          id: item.imei || item.branchStockId || item.id || item._id, // ใช้ IMEI เป็นหลักสำหรับการตัดสต๊อก
          branchStockId: item.branchStockId || item.id || item._id, // เพิ่ม branchStockId สำหรับ backend
          productId: item.productId || item.product_id || item.id, // เพิ่ม productId สำหรับ reference
          imei: item.imei || null, // IMEI เป็นตัวระบุหลักสำหรับการตัดสต๊อก
          stockIdentifier: item.imei || item._id, // ตัวระบุหลักสำหรับ backend stock operations
          name: item.name || item.product_name || '',
          price: parseFloat(item.price || item.unitPrice || 0),
          quantity: parseInt(item.quantity || 1),
          total: parseFloat(item.total || item.totalPrice || (item.price * item.quantity) || 0)
        })) : [],
        plan_type: installmentPlan.plan_type || installmentPlan.planType || 'manual',
        installment_count: parseInt(installmentPlan.installment_count || installmentPlan.installmentCount || 12),
        total_amount: products.reduce((sum, item) => sum + parseFloat(item.total || item.totalPrice || 0), 0)
      };
    }
    
    // ดึงข้อมูลลูกค้าจาก Step 2 (แปลงชื่อ field ให้ตรง Backend)
    function getStep2Customer() {
      console.log('👤 Getting Step 2 customer data...');
    
      // Try getting data from globalInstallmentManager first
      let customerData = null;
      if (window.globalInstallmentManager) {
        const step2Data = window.globalInstallmentManager.getStepData(2);
        if (step2Data && step2Data.customer) {
          customerData = step2Data.customer;
          console.log('✅ Got customer data from globalInstallmentManager');
        }
      }
    
      // Fallback to localStorage
      if (!customerData) {
        const localData = localStorage.getItem('step2_customerData');
        if (localData) {
          try {
            customerData = JSON.parse(localData);
            console.log('✅ Got customer data from localStorage');
          } catch (e) {
            console.error('Failed to parse localStorage data:', e);
          }
        }
      }
    
      if (!customerData) {
        console.warn('❌ No customer data found');
        return {
          customer: {
            first_name: 'ไม่ระบุ',
            last_name: 'ไม่ระบุ',
            phone_number: '',
            email: '',
            nationalId: '',
            tax_id: '',
            address: {
              houseNo: '1',
              moo: '',
              subDistrict: 'ไม่ระบุ',
              district: 'ไม่ระบุ',
              province: 'ไม่ระบุ',
              zipcode: '00000'
            }
          }
        };
      }
    
      try {
        const customer = customerData;
        console.log('📋 Processing customer data:', customer);
    
        // ⭐ แปลงชื่อ field ให้ตรงกับ Backend พร้อม fallback values
        const result = {
          customer: {
            // แปลง firstName → first_name
            first_name: customer.firstName || customer.first_name || 'ไม่ระบุ',
            // แปลง lastName → last_name
            last_name: customer.lastName || customer.last_name || 'ไม่ระบุ',
            // แปลง phone → phone_number
            phone_number: customer.phone || customer.mobile || customer.phone_number || '',
            // เพิ่ม nationalId สำหรับ UnifiedCustomer validation (ลบขีดออก)
            nationalId: (customer.idCard || customer.nationalId || customer.national_id || customer.tax_id || '').replace(/-/g, ''),
            // แปลง nationalId → tax_id (เก็บไว้เพื่อความเข้ากันได้ - ยังคงมีขีด)
            tax_id: customer.idCard || customer.nationalId || customer.national_id || customer.tax_id || '',
    
            // ข้อมูลอื่นๆ
            email: customer.email || '',
            birth_date: customer.birthDate || customer.birth_date || '',
            age: parseInt(customer.age || 0),
            prefix: customer.prefix || 'นาย',
    
            // ที่อยู่ - Fix mapping to match backend validation
            address: customer.address || {
              houseNo: customer.houseNo || '1',
              moo: customer.moo || '',
              subDistrict: customer.subdistrict || customer.tambon || 'ไม่ระบุ',
              district: customer.district || customer.amphoe || 'ไม่ระบุ',
              province: customer.province || customer.changwat || 'ไม่ระบุ',
              zipcode: customer.postalCode || customer.postal_code || '00000'
            },
    
            // ข้อมูลการทำงาน
            occupation: customer.occupation || '',
            workplace: customer.workplace || '',
            monthly_income: parseFloat(customer.monthlyIncome || customer.monthly_income || 0)
          },
    
          // ลายเซ็น
          signatures: {
            customer: localStorage.getItem('customerSignature') || '',
            salesperson: localStorage.getItem('salespersonSignature') || ''
          }
        };
    
        console.log('✅ Final customer data structure:', result);
        console.log('🔍 Address validation check:', {
          hasHouseNo: !!result.customer.address.houseNo,
          hasSubDistrict: !!result.customer.address.subDistrict,
          hasDistrict: !!result.customer.address.district,
          hasProvince: !!result.customer.address.province,
          hasZipcode: !!result.customer.address.zipcode
        });
    
        // 🔧 เพิ่มข้อมูลพยาน (witness) ถ้ามี
        const step2Data = localStorage.getItem('step2Data');
        if (step2Data) {
          try {
            const parsedStep2 = JSON.parse(step2Data);
            if (parsedStep2.witness) {
              result.witness = {
                name: `${parsedStep2.witness.firstName || ''} ${parsedStep2.witness.lastName || ''}`.trim(),
                firstName: parsedStep2.witness.firstName || '',
                lastName: parsedStep2.witness.lastName || '',
                phone: parsedStep2.witness.phoneNumber || parsedStep2.witness.phone || '',
                idCard: parsedStep2.witness.idCard || parsedStep2.witness.id_card || '',
                relationship: parsedStep2.witness.relationship || parsedStep2.witness.relation || '',
                address: parsedStep2.witness.address || '',
    
                // รูปภาพพยาน (base64 หรือ URL)
                photoUrl: parsedStep2.attachments?.witness_photo || '',
                idCardImageUrl: parsedStep2.attachments?.witness_id_card || ''
              };
              console.log('✅ Witness data included:', result.witness);
            }
          } catch (e) {
            console.warn('Failed to parse witness data:', e);
          }
        }
    
        // 🔧 เพิ่มเอกสารแนบ (attachments)
        const documentsData = localStorage.getItem('step2_documents');
        if (documentsData) {
          try {
            result.attachments = JSON.parse(documentsData);
          } catch (e) {
            console.warn('Failed to parse documents:', e);
          }
        }
    
        return result;
      } catch (e) {
        console.error('Error parsing customer data:', e);
        return { customer: {} };
      }
    }
    
    // ดึงข้อมูลใบเสนอราคาจาก Step 3
    function getStep3Invoice() {
      console.log('📋 Getting Step 3 invoice data...');
    
      // Try to get data from globalInstallmentManager first
      let step3Data = {};
      if (window.globalInstallmentManager) {
        const globalStep3Data = window.globalInstallmentManager.getStepData(3);
        if (globalStep3Data) {
          step3Data = {
            plan_type: globalStep3Data.plan_type || 'plan1',
            down_payment: parseFloat(globalStep3Data.down_payment || 0),
            installment_amount: parseFloat(globalStep3Data.installment_amount || 0),
            installment_count: parseInt(globalStep3Data.installment_count || 12),
            document_fee: parseFloat(globalStep3Data.doc_fee || 0),
            vat_amount: parseFloat(globalStep3Data.vatAmount || 0),
            total_with_tax: parseFloat(globalStep3Data.totalWithTax || globalStep3Data.total_with_tax || 0),
            total_amount: parseFloat(globalStep3Data.totalWithTax || globalStep3Data.total_amount || 0)
          };
          console.log('✅ Got Step 3 data from globalInstallmentManager:', step3Data);
          return step3Data;
        }
      }
    
      // Fallback to sessionStorage
      const quotationData = sessionStorage.getItem('installmentQuotationData');
      if (!quotationData) return {};
    
      try {
        const quotation = JSON.parse(quotationData);
        return {
          plan_type: quotation.planType || 'plan1',
          down_payment: parseFloat(quotation.downPayment || quotation.down_payment || 0),
          installment_amount: parseFloat(quotation.monthlyPayment || quotation.monthly_payment || 0),
          installment_count: parseInt(quotation.installmentCount || 12),
          document_fee: parseFloat(quotation.docFee || quotation.document_fee || 0),
          vat_amount: parseFloat(quotation.vatAmount || quotation.vat_amount || 0),
          total_with_tax: parseFloat(quotation.totalWithTax || quotation.total_with_tax || 0),
          total_amount: parseFloat(quotation.totalWithTax || quotation.total_amount || 0)
        };
      } catch (e) {
        console.error('Error parsing quotation data:', e);
        return {};
      }
    }
    
    // ดึงข้อมูลการชำระเงินจาก Step 4 - Real Authentication Data Only
    async function getStep4Payment() {
      console.log('💳 Getting Step 4 payment data...');
    
      // Fix: ใช้ downPaymentMethod แทน paymentMethod ที่ไม่มีอยู่
      const paymentMethod = document.querySelector('input[name="downPaymentMethod"]:checked');
      const payment = {
        payment_method: paymentMethod ? paymentMethod.value : 'cash'
      };
    
      // ✅ ดึงข้อมูลจากระบบ authentication จริงเท่านั้น
      let userInfo = {};
      let branchInfo = {};
    
      // ลำดับความสำคัญ: JWT Token > localStorage > API Call
      try {
        const authToken = localStorage.getItem('authToken');
        if (authToken) {
          // แยก JWT payload เพื่อดึงข้อมูลผู้ใช้จริง
          const tokenParts = authToken.split('.');
          if (tokenParts.length === 3) {
            const payload = JSON.parse(atob(tokenParts[1]));
            console.log('🔑 JWT Payload:', payload);
    
            userInfo = {
              id: payload.id || payload.user_id || payload.userId || payload.sub,
              name: payload.name || payload.fullName || payload.displayName,
              username: payload.username || payload.user_name,
              branch_code: payload.branch_code || payload.branchCode
            };
          }
        }
    
        // ถ้า JWT ไม่มีข้อมูลครบ ดึงจาก localStorage
        if (!userInfo.id || !userInfo.name) {
          const storedUserInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          userInfo = {
            id: userInfo.id || storedUserInfo.id || storedUserInfo.user_id,
            name: userInfo.name || storedUserInfo.name || storedUserInfo.fullName,
            username: userInfo.username || storedUserInfo.username,
            branch_code: userInfo.branch_code || storedUserInfo.branch_code
          };
        }
    
        // ดึงข้อมูลสาขา
        const storedBranchInfo = JSON.parse(localStorage.getItem('branchInfo') || '{}');
        branchInfo = {
          code: userInfo.branch_code || storedBranchInfo.code || storedBranchInfo.branch_code,
          name: storedBranchInfo.name || storedBranchInfo.branch_name
        };
    
        // ถ้ายังไม่มีข้อมูล ลองเรียก API เพื่อดึงข้อมูลล่าสุด
        if (!userInfo.id || !userInfo.name) {
          console.log('⚠️ No valid user data found, attempting API call...');
    
          try {
            const response = await fetch('/api/users/me', {
              headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
              }
            });
    
            if (response.ok) {
              const apiResponse = await response.json();
              const userData = apiResponse.data || apiResponse; // Handle both {data: ...} and direct response

              userInfo = {
                id: userData._id || userData.id || userData.user_id,
                name: userData.name || userData.fullName || userData.displayName || userData.username,
                username: userData.username,
                branch_code: userData.branch_code || userData.branchCode,
                role: userData.role,
                email: userData.email
              };

              console.log('📡 API Response:', apiResponse);
              console.log('👤 Processed userInfo:', userInfo);
    
              // บันทึกลง localStorage สำหรับใช้ครั้งต่อไป
              localStorage.setItem('userInfo', JSON.stringify(userInfo));
              console.log('✅ User data updated from API');
            }
          } catch (apiError) {
            console.warn('⚠️ API call failed:', apiError.message);
          }
        }
    
      } catch (e) {
        console.error('❌ Error retrieving user data:', e);
      }
    
      // ✅ กำหนดค่าสำหรับ payment object
      payment.branch_code = branchInfo.code || window.BRANCH_CODE || null;
      payment.salesperson_id = userInfo.id || null;
      payment.salesperson_name = userInfo.name || null;
      payment.created_by = userInfo.username || userInfo.id || null;
    
      // ✅ ดึง salesperson signature จาก step3 data
      const step3Data = window.globalInstallmentManager?.getStepData(3) || {};
      payment.salesperson_signature = step3Data.signature || '';
    
      console.log('🔍 Real Authentication Data:', {
        branch_code: payment.branch_code,
        salesperson_id: payment.salesperson_id,
        salesperson_name: payment.salesperson_name,
        salesperson_signature: payment.salesperson_signature ? 'มีลายเซ็น' : 'ไม่มีลายเซ็น',
        created_by: payment.created_by,
        data_source: userInfo.id ? 'Valid User Data' : 'No User Data'
      });
    
      // ⚠️ Error handling - ไม่ใช้ fallback แต่แจ้งเตือนปัญหา
      if (!payment.salesperson_id) {
        console.error('❌ CRITICAL: No salesperson_id found - authentication system issue');
        throw new Error('ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
      }
    
      if (!payment.salesperson_name) {
        console.error('❌ CRITICAL: No salesperson_name found - user profile incomplete');
        throw new Error('ข้อมูลผู้ใช้ไม่ครบถ้วน กรุณาติดต่อผู้ดูแลระบบ');
      }
    
      return payment;
    }
    
    // ฟังก์ชันส่งข้อมูลไป Backend
    async function submitInstallmentToBackend() {
      try {
        console.log('🚀 Starting backend submission...');
    
        // ✅ Enhanced validation before sending to backend
        console.log('🔍 Debugging customer data before submission:');
        const step1Data = window.globalInstallmentManager?.getStepData(1);
        const step2Data = window.globalInstallmentManager?.getStepData(2);
    
        console.log('📋 Step 1 data:', step1Data);
        console.log('📋 Step 2 data:', step2Data);
    
        // ✅ Validate required fields for UnifiedCustomer
        const customerData = step2Data?.customer || {};
        // Map firstName/lastName to first_name/last_name for compatibility
        const requiredFields = [
          { field: 'first_name', value: customerData.firstName || customerData.first_name, label: 'ชื่อ' },
          { field: 'last_name', value: customerData.lastName || customerData.last_name, label: 'นามสกุล' },
          { field: 'tax_id', value: customerData.idCard || customerData.tax_id, label: 'เลขบัตรประชาชน' },
          { field: 'phone_number', value: customerData.phone || customerData.phone_number, label: 'เบอร์โทรศัพท์' }
        ];
    
        const missingFields = [];
        requiredFields.forEach(({field, value, label}) => {
          if (!value || (typeof value === 'string' && value.trim() === '')) {
            missingFields.push(label);
            console.error(`❌ Missing required field: ${field} (${label})`);
          } else {
            console.log(`✅ ${label}: ${value}`);
          }
        });
    
        if (missingFields.length > 0) {
          alert(`❌ กรุณากรอกข้อมูลให้ครบถ้วน:\n${missingFields.join('\n')}`);
          return;
        }
    
        // รวบรวมข้อมูล
        const data = await collectAllInstallmentData();
    
        // ตรวจสอบข้อมูลจำเป็นตาม payment controller requirements
        if (!data.customer || !data.customer.first_name) {
          throw new Error('กรุณากรอกชื่อลูกค้า');
        }
    
        if (!data.customer.phone_number) {
          throw new Error('กรุณากรอกเบอร์โทรศัพท์ลูกค้า');
        }
    
        if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
          throw new Error('ไม่มีสินค้าในตะกร้า');
        }
    
        if (!data.plan_type || !['plan1', 'plan2', 'plan3'].includes(data.plan_type)) {
          throw new Error('planType ไม่ถูกต้อง');
        }
    
        if (!data.total_amount || data.total_amount <= 0) {
          throw new Error('ยอดรวมต้องมากกว่า 0');
        }
    
        if (data.down_payment < 0) {
          throw new Error('เงินดาวน์ต้องไม่เป็นค่าลบ');
        }
    
        // Get auth token
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          throw new Error('กรุณาเข้าสู่ระบบก่อน');
        }
    
        // แสดง Loading
        showStep4Loading();

        // 🚫 ป้องกันการเปลี่ยนหน้าขณะกำลังประมวลผล
        setProcessingStatus(true);

        // 🆕 เริ่มการอัปเดตสถานะแบบเรียลไทม์
        showRealTimeStatus('กำลังตรวจสอบสต๊อกสินค้า...', 'info');
        updateProgressStep('step-stock', 'processing');
        await simulateDelay(500); // Simulate stock checking
        updateProgressStep('step-stock', 'completed');

        showRealTimeStatus('กำลังตรวจสอบข้อมูลลูกค้า...', 'info');
        updateProgressStep('step-validate', 'processing');
        await simulateDelay(300); // Simulate validation
        updateProgressStep('step-validate', 'completed');

        showRealTimeStatus('กำลังสร้างสัญญาผ่อนชำระ...', 'info');
        updateProgressStep('step-contract', 'processing');

        console.log('📤 Sending data to backend:', data);
        console.log('🔍 Payment Controller Validation Check:', {
          hasCustomer: !!data.customer,
          customerType: data.customer_type,
          firstName: data.customer?.first_name,
          lastName: data.customer?.last_name,
          phone: data.customer?.phone_number,
          taxId: data.customer?.tax_id,
          hasItems: !!data.items && Array.isArray(data.items),
          itemsCount: data.items?.length || 0,
          planType: data.plan_type,
          planTypeValid: ['plan1', 'plan2', 'plan3'].includes(data.plan_type),
          totalAmount: data.total_amount,
          downPayment: data.down_payment,
          installmentCount: data.installment_count,
          branchCode: data.branch_code,
          salespersonId: data.salesperson_id
        });
    
        // Retry logic for 502 errors
        let retryCount = 0;
        const maxRetries = 3;
        let response;
    
        while (retryCount < maxRetries) {
          try {
            // ส่งข้อมูลไป Backend with timeout
            response = await Promise.race([
              fetch('/api/installment/create', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
              }),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Request timeout')), 30000)
              )
            ]);
    
            // Check for 502 Bad Gateway
            if (response.status === 502) {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`⚠️ 502 Bad Gateway - Retrying (${retryCount}/${maxRetries})...`);
                // Continue showing loading during retry
                console.log('⚠️ Retrying request...');
                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // Exponential backoff
                continue;
              } else {
                throw new Error('เซิร์ฟเวอร์ไม่ตอบสนอง (502 Bad Gateway) กรุณาลองใหม่ภายหลัง หรือติดต่อผู้ดูแลระบบ');
              }
            }
    
            // Break if successful
            break;
    
          } catch (error) {
            if (error.message === 'Request timeout') {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`⚠️ Request timeout - Retrying (${retryCount}/${maxRetries})...`);
                // Continue showing loading during retry
                console.log('⚠️ Retrying request after timeout...');
                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                continue;
              } else {
                throw new Error('การเชื่อมต่อหมดเวลา กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่');
              }
            }
            throw error;
          }
        }
    
        if (!response.ok) {
          let errorMessage = 'เกิดข้อผิดพลาดในการสร้างสัญญาผ่อนชำระ';
    
          try {
            const errorData = await response.json();
            console.log('❌ Error response data:', errorData);
    
            // Check for specific error types
            if (errorData.error) {
              // Handle new error codes from backend
              if (errorData.error === 'DUPLICATE_CONTRACT_NUMBER') {
                errorMessage = '❌ หมายเลขสัญญาซ้ำ\n\n' + errorData.message + '\n\n🔄 ระบบจะลองสร้างหมายเลขใหม่';

                // Auto retry with new contract number
                if (errorData.retryable) {
                  setTimeout(() => {
                    submitInstallmentToBackend();
                  }, 2000);
                  return;
                }
              } else if (errorData.error === 'DUPLICATE_DATA') {
                errorMessage = '❌ ข้อมูลซ้ำ\n\n' + errorData.message;

                // Offer retry option
                if (errorData.retryable) {
                  setTimeout(() => {
                    if (confirm('❓ ต้องการลองสร้างสัญญาใหม่หรือไม่?')) {
                      submitInstallmentToBackend();
                    }
                  }, 1500);
                  return;
                }
              } else if (errorData.error.includes('สต๊อกไม่เพียงพอ') || errorData.error.includes('insufficient stock') || errorData.error.includes('out of stock')) {
                // Extract product details from error message if available
                const productMatch = errorData.error.match(/สินค้า.*?:\s*([^,]+)/);
                if (productMatch) {
                  errorMessage = `❌ สต๊อกไม่เพียงพอ\n\nสินค้า: ${productMatch[1]}\n\nกรุณาตรวจสอบสต๊อกสินค้าและลองใหม่อีกครั้ง`;
                } else {
                  errorMessage = '❌ สต๊อกสินค้าไม่เพียงพอ\n\nกรุณาตรวจสอบสต๊อกสินค้าทั้งหมดและลองใหม่อีกครั้ง';
                }
              } else if (errorData.error.includes('ไม่สามารถตัดสต๊อกได้')) {
                errorMessage = '❌ ไม่สามารถตัดสต๊อกได้\n\n' + errorData.error;
              } else if (errorData.error.includes('duplicate key') || errorData.error.includes('E11000')) {
                const contractMatch = errorData.error.match(/contractNumber: "([^"]+)"/);
                if (contractMatch) {
                  errorMessage = `สัญญาเลขที่ ${contractMatch[1]} มีอยู่แล้วในระบบ`;
                } else {
                  errorMessage = 'สัญญานี้มีอยู่แล้วในระบบ กรุณาลองใหม่';
                }
              } else if (errorData.error.includes('validation') || errorData.error.includes('required')) {
                errorMessage = 'ข้อมูลไม่ครบถ้วนหรือไม่ถูกต้อง กรุณาตรวจสอบอีกครั้ง';
                if (errorData.details) {
                  console.error('🔍 Validation details:', errorData.details);
                  errorMessage += '\nรายละเอียด: ' + JSON.stringify(errorData.details);
                }
              } else {
                errorMessage = errorData.error;
              }
            } else if (errorData.message) {
              errorMessage = errorData.message;

              // Handle validation errors array
              if (errorData.errors && Array.isArray(errorData.errors)) {
                errorMessage += '\n\nรายละเอียดข้อผิดพลาด:\n• ' + errorData.errors.join('\n• ');
              }
            }
          } catch (e) {
            // If response body is not JSON
            if (response.status === 500) {
              errorMessage = 'เซิร์ฟเวอร์เกิดข้อผิดพลาด (500) - กรุณาตรวจสอบข้อมูลหรือติดต่อผู้ดูแลระบบ';
              console.log('💡 Hint: ตรวจสอบ console log ด้านบนเพื่อดูข้อมูลที่ส่งไป backend');
            } else if (response.status === 401) {
              errorMessage = 'กรุณาเข้าสู่ระบบใหม่';
              // Redirect to login
              setTimeout(() => window.location.href = '/login', 2000);
            } else if (response.status === 403) {
              errorMessage = 'คุณไม่มีสิทธิ์ในการดำเนินการนี้';
            } else if (response.status === 409) {
              errorMessage = 'ข้อมูลซ้ำ - หมายเลขสัญญาหรือข้อมูลนี้มีอยู่แล้วในระบบ กรุณาลองใหม่';
            } else if (response.status === 400) {
              errorMessage = 'ข้อมูลไม่ถูกต้อง กรุณาตรวจสอบข้อมูลอีกครั้ง';
            } else if (response.status === 404) {
              errorMessage = 'ไม่พบ API endpoint กรุณาติดต่อผู้ดูแลระบบ';
            }
          }
    
          console.error('❌ Full error details:', {
            status: response.status,
            statusText: response.statusText,
            errorMessage: errorMessage,
            url: '/api/installment/create',
            timestamp: new Date().toISOString()
          });
    
          throw new Error(errorMessage);
        }
    
        const result = await response.json();
        console.log('✅ Success response:', result);

        // 🔥 แสดงรายละเอียดการตัดสต๊อก (ถ้ามี)
        if (result.data && result.data.stockDeductionLog) {
          displayStockDeductionDetails(result.data.stockDeductionLog);
        }

        // 🆕 อัปเดตสถานะสัญญาเสร็จสิ้น
        showRealTimeStatus('สร้างสัญญาเสร็จสิ้น!', 'success');
        updateProgressStep('step-contract', 'completed');

        // 🆕 เริ่มขั้นตอนสร้างเอกสาร
        showRealTimeStatus('กำลังสร้างเอกสาร (ใบเสนอราคา, ใบกำกับภาษี)...', 'info');
        updateProgressStep('step-documents', 'processing');
        await simulateDelay(800); // Simulate document creation
        showRealTimeStatus('สร้างเอกสารเสร็จสิ้น!', 'success');
        updateProgressStep('step-documents', 'completed');

        // 🆕 เริ่มขั้นตอนส่งอีเมล
        showRealTimeStatus('กำลังส่งอีเมลยืนยัน...', 'info');
        updateProgressStep('step-email', 'processing');
        await simulateDelay(500); // Simulate email sending
        showRealTimeStatus('ส่งอีเมลเสร็จสิ้น!', 'success');
        updateProgressStep('step-email', 'completed');

        // เก็บเลขที่สัญญา
        if (result.data) {
          sessionStorage.setItem('installmentContractId', result.data._id || '');
          sessionStorage.setItem('installmentContractNo', result.data.contractNumber || '');
        }

        // ซ่อน Loading
        showStep4Loading(false);

        // 🚫 ปิดสถานะการประมวลผล
        setProcessingStatus(false);

        // แสดงข้อความสำเร็จ
        showSuccessMessage(result);
    
        return result;
    
      } catch (error) {
        console.error('❌ Submission error:', error);

        // 🆕 อัปเดตสถานะเป็น error
        const currentSteps = ['step-stock', 'step-validate', 'step-contract', 'step-documents', 'step-email'];
        currentSteps.forEach(stepId => {
          const stepElement = document.getElementById(stepId);
          if (stepElement && stepElement.classList.contains('processing')) {
            updateProgressStep(stepId, 'error');
          }
        });

        showRealTimeStatus('เกิดข้อผิดพลาด: ' + error.message, 'error');

        // ซ่อน Loading
        showStep4Loading(false);

        // 🚫 ปิดสถานะการประมวลผล
        setProcessingStatus(false);

        // Save draft for recovery
        saveDraft();

        // แสดง Error with recovery option
        showErrorMessageWithRecovery(error.message);

        throw error;
      }
    }
    
    // แสดงข้อความสำเร็จ
    function showSuccessMessage(result) {
      const contractNo = result.data?.contractNo || result.data?.contractNumber || result.contractNo || result.contractNumber || 'N/A';
    
      // 🆕 อัปเดตสถานะเอกสารทั้งหมดเป็น "เสร็จสิ้น" หลังจากสร้างสัญญาสำเร็จ
      updateDocumentStatus('quotationStatus', 'completed');
      updateDocumentStatus('invoiceStatus', 'completed');
      updateDocumentStatus('receiptStatus', 'completed');
      updateDocumentStatus('receiptVoucherStatus', 'completed');
    
      // อัปเดตสถานะใบกำกับภาษี (แสดงอยู่แล้ว)
      updateDocumentStatus('taxInvoiceStatusDoc', 'completed');
    
      updateDocumentStatus('deliveryNoteStatus', 'completed');
    
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: 'บันทึกข้อมูลสำเร็จ!',
          html: `
            <div>
              <p>เลขที่สัญญา: <strong>${contractNo}</strong></p>
              <p class="text-sm text-gray-600 mt-2">ข้อมูลถูกบันทึกเรียบร้อยแล้ว</p>
            </div>
          `,
          confirmButtonText: 'ตกลง',
          confirmButtonColor: '#10b981'
        }).then(() => {
          // เปิดใช้งานปุ่มพิมพ์เอกสาร
          document.querySelectorAll('#btnDownloadQuotation, #btnDownloadInvoice, #btnDownloadDeliveryNote, #btnDownloadReceiptOnly, #btnDownloadTaxInvoiceOnly')
            .forEach(btn => btn.disabled = false);
    
          // แสดง Success Modal (ถ้ามี)
          const modal = document.getElementById('successModal');
          if (modal) {
            modal.classList.remove('hidden');
          }
        });
      } else {
        alert(`บันทึกสำเร็จ!\nเลขที่สัญญา: ${contractNo}`);
        // 🚫 ลบ window.location.reload() เพื่อไม่ให้เปลี่ยนหน้า
        // เปิดใช้งานปุ่มพิมพ์เอกสาร
        document.querySelectorAll('#btnDownloadQuotation, #btnDownloadInvoice, #btnDownloadDeliveryNote, #btnDownloadReceiptOnly, #btnDownloadTaxInvoiceOnly')
          .forEach(btn => btn.disabled = false);
      }
    }
    
    // แสดงข้อความ Error with recovery option
    function showErrorMessageWithRecovery(message) {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด!',
          html: `
            <div>
              <p>${escapeHtml(message)}</p>
              <p class="text-sm text-gray-600 mt-2">ข้อมูลของคุณถูกบันทึกไว้แล้ว สามารถลองใหม่ได้</p>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'ลองใหม่',
          cancelButtonText: 'ยกเลิก',
          confirmButtonColor: '#3b82f6',
          cancelButtonColor: '#6b7280'
        }).then((result) => {
          if (result.isConfirmed) {
            // Retry submission
            submitInstallmentToBackend();
          }
        });
      } else {
        alert(`เกิดข้อผิดพลาด: ${message}\n\nข้อมูลถูกบันทึกไว้แล้ว กรุณาลองใหม่`);
      }
    }
    
    // แสดงข้อความ Error (original function for backward compatibility)
    function showErrorMessage(message) {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด!',
          text: message,
          confirmButtonText: 'ตกลง',
          confirmButtonColor: '#ef4444'
        });
      } else {
        alert(`Error: ${message}`);
      }
    }
    
    // ==========================================
    // เชื่อมต่อปุ่ม "สร้างสัญญา" กับฟังก์ชันส่งข้อมูล
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🎯 Connecting Create Contract button to backend...');
    
      const createContractBtn = document.getElementById('btnCreateContract');
      if (createContractBtn) {
        createContractBtn.addEventListener('click', async function(e) {
          e.preventDefault();
    
          console.log('📝 Create Contract button clicked');
    
          // ยืนยันการสร้างสัญญา
          if (typeof Swal !== 'undefined') {
            const confirm = await Swal.fire({
              title: 'ยืนยันการสร้างสัญญา',
              text: 'คุณต้องการบันทึกข้อมูลและสร้างสัญญาผ่อนชำระใช่หรือไม่?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'ยืนยัน',
              cancelButtonText: 'ยกเลิก',
              confirmButtonColor: '#3b82f6',
              cancelButtonColor: '#6b7280'
            });
    
            if (!confirm.isConfirmed) return;
          } else {
            if (!confirm('ยืนยันการสร้างสัญญาผ่อนชำระ?')) return;
          }
    
          // รีเซ็ตสถานะ Progress Steps
          resetProgressSteps();

          // ส่งข้อมูลไป Backend
          try {
            await submitInstallmentToBackend();
          } catch (error) {
            console.error('Failed to create contract:', error);
          }
        });
    
        console.log('✅ Create Contract button connected to backend submission');
      } else {
        console.warn('⚠️ Create Contract button not found');
      }
    });
    
    // 🔧 Debug function for attachments
    window.debugStep4Attachments = function() {
      console.log('🔍 Debugging Step 4 attachments...');
      const stepData = window.globalInstallmentManager?.getStepData(2);
      console.log('📋 Step data:', stepData);
      console.log('📎 Attachments:', stepData?.attachments);
      if (stepData?.attachments) {
        Object.keys(stepData.attachments).forEach(key => {
          console.log(`   ${key}:`, typeof stepData.attachments[key], stepData.attachments[key]);
        });
      }
    };
    
    // 🔧 Debug function for customer data validation
    window.debugCustomerData = function() {
      console.log('🔍 Debugging customer data validation...');
      const customerData = window.globalInstallmentManager?.getStepData(1);
      console.log('👤 Customer data:', customerData);
    
      // Check required fields
      const requiredFields = ['firstName', 'lastName', 'idNumber', 'phoneNumber'];
      requiredFields.forEach(field => {
        const value = customerData?.[field];
        console.log(`   ${field}:`, value ? '✅' : '❌', value);
      });
    
      // Check all step data
      console.log('📊 All steps data:');
      for (let i = 1; i <= 4; i++) {
        const stepData = window.globalInstallmentManager?.getStepData(i);
        console.log(`   Step ${i}:`, stepData);
      }
    
      return customerData;
    };
    
    // 🗺️ Debug function for coordinates
    window.debugStep4Coordinates = function() {
      console.log('🔍 Debugging Step 4 coordinates...');
      const stepData = window.globalInstallmentManager?.getStepData(2);
      console.log('📋 Customer data:', stepData);
    
      if (stepData) {
        console.log('🗺️ Coordinate fields found:');
        console.log('   coordinates:', stepData.coordinates);
        console.log('   customerCoordinates:', stepData.customerCoordinates);
        console.log('   latitude:', stepData.latitude);
        console.log('   customerLatitude:', stepData.customerLatitude);
        console.log('   longitude:', stepData.longitude);
        console.log('   customerLongitude:', stepData.customerLongitude);
        console.log('   customerMapUrl:', stepData.customerMapUrl);
    
        // Check what's currently displayed
        console.log('📺 Currently displayed:');
        console.log('   modalCoordinates:', document.getElementById('modalCoordinates')?.textContent);
        console.log('   modalLatitude:', document.getElementById('modalLatitude')?.textContent);
        console.log('   modalLongitude:', document.getElementById('modalLongitude')?.textContent);
        console.log('   modalMapUrl:', document.getElementById('modalMapUrl')?.textContent);
      }
    };
    
    // 🔧 Enhanced coordinate display function
    window.updateCoordinateDisplay = function(coordinateData) {
      console.log('🗺️ Updating coordinate display with:', coordinateData);
    
      // Update coordinates
      const coordsElement = document.getElementById('modalCoordinates');
      if (coordsElement) {
        coordsElement.textContent = coordinateData.coordinates || coordinateData.customerCoordinates || 'ไม่ระบุ';
      }
    
      // Update latitude
      const latElement = document.getElementById('modalLatitude');
      if (latElement) {
        latElement.textContent = coordinateData.latitude || coordinateData.customerLatitude || 'ไม่ระบุ';
      }
    
      // Update longitude
      const lngElement = document.getElementById('modalLongitude');
      if (lngElement) {
        lngElement.textContent = coordinateData.longitude || coordinateData.customerLongitude || 'ไม่ระบุ';
      }
    
      // Update Google Maps URL
      const mapUrlElement = document.getElementById('modalMapUrl');
      if (mapUrlElement && coordinateData.customerMapUrl) {
        mapUrlElement.innerHTML = `<a href="${coordinateData.customerMapUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">${coordinateData.customerMapUrl}</a>`;
      } else if (mapUrlElement) {
        mapUrlElement.textContent = 'ไม่ระบุ';
      }
    
      console.log('✅ Coordinate display updated');
    };
    
    // 🧪 Test function to set sample coordinates
    window.setTestCoordinates = function() {
      console.log('🧪 Setting test coordinates...');
      const testData = {
        coordinates: '7.0000000, 100.0000000',
        customerCoordinates: '7.0000000, 100.0000000',
        latitude: '7.0000000',
        customerLatitude: '7.0000000',
        longitude: '100.0000000',
        customerLongitude: '100.0000000',
        customerMapUrl: 'https://maps.google.com/?q=7.0000000,100.0000000'
      };
    
      window.updateCoordinateDisplay(testData);
    };
    
    // ✅ User Data Validation - Check Only, No Hardcode
    console.log('🕐 Step 4 loaded at:', new Date().toISOString());
    
    // � User Data Validation Function
    function validateUserAuthentication() {
      console.log('🔍 Validating user authentication...');
    
      const authToken = localStorage.getItem('authToken');
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const branchInfo = JSON.parse(localStorage.getItem('branchInfo') || '{}');
    
      const validationResults = {
        hasAuthToken: !!authToken,
        hasUserInfo: Object.keys(userInfo).length > 0,
        hasBranchInfo: Object.keys(branchInfo).length > 0,
        userHasId: !!(userInfo.id || userInfo.user_id),
        userHasName: !!(userInfo.name || userInfo.fullName),
        issues: []
      };
    
      if (!validationResults.hasAuthToken) {
        validationResults.issues.push('No authentication token found');
      }
    
      if (!validationResults.hasUserInfo) {
        validationResults.issues.push('No user information in localStorage');
      }
    
      if (!validationResults.userHasId) {
        validationResults.issues.push('User ID missing from userInfo');
      }
    
      if (!validationResults.userHasName) {
        validationResults.issues.push('User name missing from userInfo');
      }
    
      console.log('📊 Authentication Validation Results:', validationResults);
    
      if (validationResults.issues.length > 0) {
        console.warn('⚠️ Authentication Issues Found:');
        validationResults.issues.forEach(issue => console.warn(`   - ${issue}`));
        console.warn('💡 Suggestion: Check login process and ensure user data is properly saved');
      } else {
        console.log('✅ Authentication validation passed');
      }
    
      return validationResults;
    }
    
    // เรียกใช้เมื่อโหลดหน้า
    document.addEventListener('DOMContentLoaded', function() {
      // ตรวจสอบการ authentication เท่านั้น ไม่สร้างข้อมูลปลอม
      setTimeout(() => {
        validateUserAuthentication();
      }, 1000);
    });
    
    // Add comprehensive data validation debug function
    window.validateAllStepData = function() {
      console.log('🔍 === COMPREHENSIVE DATA VALIDATION ===');
    
      // Check step 1 (customer data)
      const step1Data = window.globalInstallmentManager?.getStepData(1);
      console.log('📋 Step 1 (Customer Data):', step1Data);
    
      if (step1Data) {
        const requiredCustomerFields = ['firstName', 'lastName', 'idNumber', 'phoneNumber'];
        console.log('👤 Customer field validation:');
        requiredCustomerFields.forEach(field => {
          const value = step1Data[field];
          const status = value && value.trim() ? '✅' : '❌';
          console.log(`   ${field}: ${status} "${value}"`);
        });
      }
    
      // Check step 2 (attachments)
      const step2Data = window.globalInstallmentManager?.getStepData(2);
      console.log('📎 Step 2 (Attachments):', step2Data);
    
      // Check step 3 (product data)
      const step3Data = window.globalInstallmentManager?.getStepData(3);
      console.log('📦 Step 3 (Product Data):', step3Data);
    
      // Check step 4 (contract data)
      const step4Data = window.globalInstallmentManager?.getStepData(4);
      console.log('📄 Step 4 (Contract Data):', step4Data);
    
      return {
        step1: step1Data,
        step2: step2Data,
        step3: step3Data,
        step4: step4Data
      };
    };
  </script>

  <!-- Loading System -->
  <script>
    let lottieAnimation = null;

    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // โหลดและเล่น Lottie animation
        if (!lottieAnimation) {
          console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('✅ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('❌ Error loading Lottie animation:', error);
              // Fallback เฉพาะเมื่อ Lottie โหลดไม่สำเร็จ
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    // Backward compatibility functions
    function showStep4Loading(show = true) {
      showLoading(show);
    }

    function hideStep4Loading() {
      showLoading(false);
    }

    // Show loading on page load
    document.addEventListener('DOMContentLoaded', function() {
      showLoading(true);

      // Hide loading after page is fully loaded
      setTimeout(() => {
        showLoading(false);
      }, 1500);
    });

    // 🚫 ปิดใช้งาน beforeunload เพื่อป้องกันการเปลี่ยนหน้าไม่จำเป็น
    // Show loading when navigating away - DISABLED
    /*
    window.addEventListener('beforeunload', function() {
      showLoading(true);
    });
    */

    // 🆕 ฟังก์ชันสำหรับอัปเดตสถานะ Progress Steps
    function updateProgressStep(stepId, status) {
      const stepElement = document.getElementById(stepId);
      if (!stepElement) {
        console.warn(`⚠️ Progress step element not found: ${stepId}`);
        return;
      }

      // ลบ class สถานะเก่า
      stepElement.classList.remove('processing', 'completed', 'error');

      // เพิ่ม class สถานะใหม่
      if (status !== 'pending') {
        stepElement.classList.add(status);
      }

      // เพิ่ม icon ตามสถานะ
      const iconElement = stepElement.querySelector('.progress-step-icon');
      if (iconElement) {
        switch(status) {
          case 'processing':
            iconElement.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
            break;
          case 'completed':
            iconElement.innerHTML = '✓';
            break;
          case 'error':
            iconElement.innerHTML = '✗';
            break;
          default:
            // Reset to original number
            const stepNumber = stepId.split('-')[1] === 'stock' ? '1' :
                             stepId.split('-')[1] === 'validate' ? '2' :
                             stepId.split('-')[1] === 'contract' ? '3' :
                             stepId.split('-')[1] === 'documents' ? '4' : '5';
            iconElement.innerHTML = stepNumber;
        }
      }

      console.log(`📊 Progress step updated: ${stepId} -> ${status}`);
    }

    // 🆕 ฟังก์ชันจำลองความล่าช้า
    function simulateDelay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 🆕 ฟังก์ชันรีเซ็ตสถานะ Progress Steps
    function resetProgressSteps() {
      const steps = ['step-stock', 'step-validate', 'step-contract', 'step-documents', 'step-email'];
      steps.forEach(stepId => {
        updateProgressStep(stepId, 'pending');
      });
      console.log('🔄 Progress steps reset to pending');
    }

    // 🆕 ฟังก์ชันแสดงข้อความสถานะแบบเรียลไทม์
    function showRealTimeStatus(message, type = 'info') {
      const statusContainer = document.getElementById('realtime-status');
      if (statusContainer) {
        const statusClass = type === 'success' ? 'text-green-600' :
                          type === 'error' ? 'text-red-600' :
                          type === 'warning' ? 'text-yellow-600' : 'text-blue-600';

        statusContainer.innerHTML = `<div class="${statusClass} text-sm animate-pulse">${message}</div>`;

        // ซ่อนข้อความหลัง 3 วินาที
        setTimeout(() => {
          if (statusContainer.innerHTML.includes(message)) {
            statusContainer.innerHTML = '';
          }
        }, 3000);
      }
    }

    // 🔥 ฟังก์ชันแสดงรายละเอียดการตัดสต๊อก
    function displayStockDeductionDetails(stockDeductionLog) {
      const stockUpdateDetails = document.getElementById('stockUpdateDetails');
      const stockUpdateList = document.getElementById('stockUpdateList');

      if (!stockUpdateDetails || !stockUpdateList || !Array.isArray(stockDeductionLog)) {
        return;
      }

      // สร้าง HTML สำหรับแสดงรายละเอียดการตัดสต๊อก
      let stockHtml = '';
      stockDeductionLog.forEach((result, index) => {
        const statusIcon = result.success ?
          '<i class="bi bi-check-circle-fill text-green-600"></i>' :
          '<i class="bi bi-x-circle-fill text-red-600"></i>';

        const statusText = result.success ? 'สำเร็จ' : 'ล้มเหลว';
        const statusClass = result.success ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300';

        stockHtml += `
          <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border">
            <div class="flex items-center gap-2">
              ${statusIcon}
              <span class="font-medium">${escapeHtml(result.item)}</span>
            </div>
            <span class="${statusClass} text-xs">${statusText}</span>
          </div>
        `;

        if (result.success && result.message) {
          stockHtml += `<div class="text-xs text-gray-600 dark:text-gray-400 ml-6 mb-1">${escapeHtml(result.message)}</div>`;
        }

        if (!result.success && result.error) {
          stockHtml += `<div class="text-xs text-red-600 dark:text-red-400 ml-6 mb-1">${escapeHtml(result.error)}</div>`;
        }
      });

      // แสดงรายละเอียด
      stockUpdateList.innerHTML = stockHtml;
      stockUpdateDetails.style.display = 'block';

      // ซ่อนรายละเอียดหลัง 10 วินาที
      setTimeout(() => {
        stockUpdateDetails.style.display = 'none';
      }, 10000);

      console.log('✅ Stock deduction details displayed:', stockDeductionLog);
    }

    // 🚫 ป้องกันการเปลี่ยนหน้าโดยไม่ได้ตั้งใจ
    let isProcessingContract = false;

    function setProcessingStatus(status) {
      isProcessingContract = status;
      console.log(`🔒 Contract processing status: ${status}`);
    }

    // ป้องกันการเปลี่ยนหน้าขณะกำลังประมวลผล
    window.addEventListener('beforeunload', function(e) {
      if (isProcessingContract) {
        const message = 'กำลังดำเนินการสร้างสัญญา กรุณารอให้เสร็จก่อนออกจากหน้านี้';
        e.preventDefault();
        e.returnValue = message;
        return message;
      }
    });

    // 🚫 ปิดใช้งาน event listeners ที่อาจทำให้เกิดการ redirect ไม่จำเป็น
    // Show loading for form submissions and AJAX requests - DISABLED
    /*
    document.addEventListener('submit', function() {
      showLoading(true);
    });
    */

    // Show loading for navigation links - DISABLED
    /*
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a[href]');
      if (link && !link.hasAttribute('download') &&
          !link.href.startsWith('javascript:') &&
          !link.href.startsWith('mailto:') &&
          !link.href.startsWith('tel:') &&
          link.target !== '_blank') {
        showLoading(true);
      }
    });
    */
  </script>

  </body>
  </html> 