<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani - Step 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  
  <!-- Permissive Content Security Policy for ZK9500 HTTP API --><!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />

  <!-- Modular CSS Files -->
  <link rel="stylesheet" href="css/loading-system.css">
  <link rel="stylesheet" href="css/installment-forms.css">
  <link rel="stylesheet" href="css/address-dropdown.css">
  <link rel="stylesheet" href="css/signature-modal.css">
  <link rel="stylesheet" href="css/step2-styles.css">
  <link rel="stylesheet" href="css/step2-dark-mode.css">






  
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(msg) {
      if (msg && msg.includes && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com')
      )) {
        return; // Suppress Tailwind production warnings
      }
      originalWarn.apply(console, arguments);
    };
  </script>

  <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>
  
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- CSS Styles moved to separate files -->

  <!-- SignaturePad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

  <!-- Modal Z-Index Fix -->
  <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö z-index ‡∏Ç‡∏≠‡∏á modal ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà conflict ‡∏Å‡∏±‡∏ô */
    #cameraModal {
      z-index: 9998 !important;
    }
    
    #signatureModal {
      z-index: 9999 !important;
    }
    
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ pointer events ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î camera modal */
    #signatureModal.hidden {
      pointer-events: none !important;
    }
    
    #signatureModal:not(.hidden) {
      pointer-events: auto !important;
    }
    
    /* ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ signature canvas ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */
    #signatureModalCanvas {
      touch-action: none !important;
      user-select: none !important;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á modal */
    #signatureModal:not(.hidden) {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    #signatureModal.hidden {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }
  </style>


  <!-- Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Lottie.js for loading animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Loading Overlay Styles -->
  <style>
    .step2-old-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .step2-old-loading-overlay.animate__fadeOut {
      opacity: 0;
      visibility: hidden;
    }

    .step2-old-loading-content {
      text-align: center;
      color: #374151;
    }

    .step2-old-lottie-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 1rem;
    }

    .step2-old-loading-text {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .step2-old-loading-subtext {
      font-size: 0.875rem;
      opacity: 0.7;
    }

    @media (prefers-color-scheme: dark) {
      .step2-old-loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }

      .step2-old-loading-content {
        color: #f3f4f6;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="step2OldLoadingOverlay" class="step2-old-loading-overlay">
    <div class="step2-old-loading-content">
      <div id="step2OldLottieContainer" class="step2-old-lottie-container"></div>
      <div class="step2-old-loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <div class="step2-old-loading-subtext">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
    </div>
  </div>
  <script>
    // Early function definitions to prevent ReferenceError
    console.log('üîß Setting up early function definitions...');
    
    // Declare global variables
    let selectedProducts = [];
    let currentSignatureType = null;
    let signaturePad = null;
    let currentStream = null;
    
    // Email document functions - early definitions
    window.initializeEmailDocumentSettings = window.initializeEmailDocumentSettings || function() {
      console.log('üîÑ Early initializeEmailDocumentSettings called - will be replaced later');
      return true;
    };
    
    window.updateEmailDocumentSelection = window.updateEmailDocumentSelection || function() {
      console.log('üîÑ Early updateEmailDocumentSelection called');
    };
    
    window.updateEmailPreview = window.updateEmailPreview || function() {
      console.log('üîÑ Early updateEmailPreview called');
    };
    
    window.checkEmailRequirement = window.checkEmailRequirement || function() {
      console.log('üîÑ Early checkEmailRequirement called');
      return true;
    };
    
    window.getSelectedEmailDocuments = window.getSelectedEmailDocuments || function() {
      console.log('üîÑ Early getSelectedEmailDocuments called');
      return [];
    };
    
    window.updateEmailAutomationIndicator = window.updateEmailAutomationIndicator || function() {
      console.log('üîÑ Early updateEmailAutomationIndicator called');
    };
    
    console.log('‚úÖ Early function definitions ready');
  </script>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  
  <!-- Loading Overlay Container -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div id="loadingMessage" class="text-lg font-medium mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <div id="loadingDescription" class="text-sm text-gray-600"></div>
      <div class="loading-progress">
        <div id="loadingProgressBar" class="loading-progress-bar" style="width: 0%"></div>
      </div>
      <div id="loadingPercentage" class="text-xs text-gray-500 mt-2">0%</div>
    </div>
  </div>

  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-64">
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani - Step 2</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>
        
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 mt-1">
          <div id="connectionStatus" class="connection-status">
            <span id="connectionText" class="connection-text">üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            <div class="connection-details">
              <span id="firebaseStatus" class="status-dot firebase" title="Firebase Realtime Database">‚óè</span>
              <span id="socketStatus" class="status-dot socket" title="Socket.IO">‚óè</span>
              <span id="onlineCount" class="online-count" title="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="flex items-center gap-3">
        <!-- Notifications -->
        <div class="relative" id="notificationWrapper">
          <button id="notificationButton" class="notification-button">
            <i class="bi bi-bell-fill text-lg"></i>
          </button>
          <span id="notificationDot" class="notification-dot hidden"></span>
          <span id="notificationBadge" class="notification-badge hidden">0</span>
          
          <!-- Notification Dropdown -->
          <div id="notificationDropdown" class="notification-dropdown hidden">
            <div class="notification-dropdown-header">
              <h3 class="notification-dropdown-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
              <button class="mark-all-read text-sm text-blue-600 dark:text-blue-400 hover:underline">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
            <div class="notification-dropdown-content">
              <div class="notification-loading">
                <div class="notification-loading-spinner"></div>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
              </div>
            </div>
            <div class="notification-dropdown-footer">
              <a href="#" class="text-sm">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
          </div>
        </div>

        <!-- Back to Step 1 -->
        <a href="../step1/step1.html" class="btn btn-outline">
          <i class="bi bi-arrow-left"></i>
          ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1
        </a>
      </div>
    </header>

    <!-- Content -->
    <div class="container-fluid p-4">
      <!-- Stepper -->
      <div class="stepper">
        <div class="step" data-step="1">
          <div class="step-icon">1</div>
          <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step active" data-step="2">
          <div class="step-icon">2</div>
          <div class="step-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-icon">3</div>
          <div class="step-text">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-icon">4</div>
          <div class="step-text">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
        </div>
      </div>

      <!-- Step 2: Customer Information -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Right: Product Summary -->
        <div class="lg:col-start-3 lg:row-start-1">
          <div class="card p-4 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 dark:from-blue-900/20 dark:to-indigo-900/20 dark:border-blue-700 rounded-lg">
            <h5 class="flex items-center gap-2 mb-4 font-semibold text-blue-800 dark:text-blue-300">
              <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
              <span class="text-sm font-normal text-gray-500 ml-2">(<span id="cartCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
            </h5>
            
            <!-- Product Summary Note -->
            <div class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
              <div class="flex items-center gap-2 text-yellow-800 dark:text-yellow-200">
                <i class="bi bi-info-circle"></i>
                <span class="text-sm font-medium">‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
              </div>
              <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà <button onclick="goToStep1()" class="text-blue-600 underline hover:text-blue-800">Step 1</button>
              </p>
            </div>

            <div class="cart-summary min-h-[200px] mb-4" id="productSummary">
              <div class="text-center text-gray-500 py-8">
                <i class="bi bi-cart text-4xl mb-2"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
              </div>
            </div>
            
            <!-- Form Progress Indicator -->
            <div class="mb-4 p-3 bg-white/50 dark:bg-gray-800/50 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                <span id="formProgress" class="text-sm font-bold text-blue-600">0%</span>
              </div>
              <div class="progress-bar">
                <div id="formProgressBar" class="progress-fill" style="width: 0%"></div>
              </div>
              <div id="formProgressDetails" class="text-xs text-gray-500 mt-1">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
              </div>
            </div>
            
            <!-- Next Step Button -->
            <div class="mt-4">
              <button id="btnStep2ToStep3" class="btn btn-primary btn-block">
                <i class="bi bi-arrow-right mr-2"></i> ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
              </button>
            </div>
          </div>
        </div>

        <!-- Left: Customer Form -->
        <div class="lg:col-span-2 lg:row-start-1 space-y-4">
          
          <!-- Customer Search -->
          <div class="card p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
            <h5 class="flex items-center gap-2 mb-4 font-semibold">
              <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </h5>
            
            <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-lg">
              <h4 class="font-semibold mb-3 flex items-center gap-2">
                <i class="bi bi-person-search text-blue-600"></i>
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="relative">
                  <input type="text" id="customerSearchIdCard" 
                    class="input input-bordered w-full pl-10" 
                    placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" 
                    maxlength="13" 
                    autocomplete="off" />
                  <i class="bi bi-credit-card absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                
                <div class="relative">
                  <input type="text" id="customerSearchPhone" 
                    class="input input-bordered w-full pl-10" 
                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" 
                    maxlength="10" 
                    autocomplete="off" />
                  <i class="bi bi-telephone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
              </div>
              
              <div class="flex gap-2 mt-3">
                <button id="btnAdvancedSearch" class="btn btn-outline flex-1">
                  <i class="bi bi-funnel"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                </button>
                <button id="btnQuickSearch" class="btn btn-primary">
                  <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
              </div>
              
              <div id="customerSearchResults" class="hidden mt-4 max-h-64 overflow-y-auto">
                <div class="border border-gray-200 dark:border-gray-600 rounded-lg">
                  <div id="searchResultsList" class="divide-y divide-gray-200 dark:divide-gray-600">
                    <!-- Search results will be populated here -->
                  </div>
                </div>
              </div>
              
              <div class="flex gap-2 mt-3 text-sm">
                <button id="btnCreateNewCustomer" class="text-green-600 hover:text-green-800 flex items-center gap-1">
                  <i class="bi bi-person-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                </button>
                <button id="btnClearSearch" class="text-gray-600 hover:text-gray-800 flex items-center gap-1">
                  <i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
              </div>
            </div>
          </div>



          <!-- Customer Form -->
          <div class="card p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="flex items-center justify-between mb-4">
              <h5 class="flex items-center gap-2 font-semibold">
                <i class="bi bi-person-fill text-blue-600"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
              </h5>
              <div class="flex items-center gap-2">
                <button type="button" id="btnClearCustomerForm" class="btn btn-outline btn-sm">
                  <i class="bi bi-arrow-clockwise"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                </button>
              </div>
            </div>

            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
            <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
              <label class="block text-sm font-semibold text-green-800 dark:text-green-200 mb-2">
                <i class="bi bi-search mr-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
              </label>
              <div class="flex gap-2">
                <input 
                  type="text" 
                  id="customerSearch" 
                  class="flex-1 px-3 py-2 border border-green-300 dark:border-green-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white"
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" 
                  maxlength="17" 
                />
                <button 
                  id="btnSearchCustomer" 
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 transition-colors" 
                  title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                >
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>

              <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
              <div id="customerSearchResults" class="mt-3 hidden">
                <div class="max-h-48 overflow-y-auto border border-green-300 dark:border-green-600 rounded-lg bg-white dark:bg-gray-800">
                  <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Results will be inserted here -->
                  </div>
                </div>
              </div>
            </div>
            <!-- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->

            <!-- Customer Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</span>
                </label>
                <select id="customerPrefix" class="select select-bordered w-full">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
                  <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                  <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                  <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                  <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠ <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="text" id="customerFirstName" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠" 
                    required 
                    autocomplete="given-name">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group md:col-span-2">
                <label class="label">
                  <span class="label-text font-medium">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="text" id="customerLastName" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" 
                    required 
                    autocomplete="family-name">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group md:col-span-2">
                <label class="label">
                  <span class="label-text font-medium">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="text-red-500">*</span></span>
                </label>
                <div class="flex gap-2">
                  <div class="relative flex-1">
                    <input type="text" id="customerIdCard" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" 
                      maxlength="17" 
                      required>
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <button id="btnReadCard" class="btn btn-info">
                    <i class="bi bi-credit-card-2-front"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                  </button>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="tel" id="customerPhone" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" 
                    maxlength="10" 
                    required 
                    autocomplete="tel">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
                </label>
                <div class="relative">
                  <input type="email" id="customerEmail" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" 
                    autocomplete="email">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">Facebook URL</span>
                </label>
                <div class="relative">
                  <input type="url" id="customerFacebook" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="https://www.facebook.com/username ‡∏´‡∏£‡∏∑‡∏≠ facebook.com/username" 
                    oninput="validateFacebookUrl(this)">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-facebook text-blue-600"></i> 
                  ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ü‡∏ã‡∏ö‡∏∏‡πä‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">Line ID</span>
                </label>
                <div class="relative">
                  <input type="text" id="customerLineId" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="Line ID ‡πÄ‡∏ä‡πà‡∏ô mylineid123" 
                    oninput="validateLineId(this)">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-chat-square-text text-green-600"></i> 
                  Line ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="date" id="customerBirthDate" 
                    class="input input-bordered w-full pr-10" 
                    required 
                    autocomplete="bday">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏≠‡∏≤‡∏¢‡∏∏ <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="number" id="customerAge" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)" 
                    min="1" 
                    max="120" 
                    required>
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
            </div>

            <!-- Income and Occupation Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-briefcase-fill text-blue-600"></i>
                ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="customerOccupation" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£, ‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢" 
                      required>
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-info-circle"></i> 
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="number" id="customerIncome" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="15000" 
                      min="0" 
                      step="100" 
                      required>
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-cash-coin"></i> 
                    ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)
                  </div>
                </div>
                
                <div class="form-group md:col-span-2">
                  <label class="label">
                    <span class="label-text font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                  </label>
                  <div class="relative">
                    <input type="text" id="customerWorkplace" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" 
                      autocomplete="organization">
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-building"></i> 
                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                  </div>
                </div>
              </div>
            </div>

            <!-- Address Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-geo-alt-fill text-blue-600"></i>
                ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></span>
                  </label>
                  <input type="text" id="houseNo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" 
                    required>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</span>
                  </label>
                  <input type="text" id="moo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ã‡∏≠‡∏¢</span>
                  </label>
                  <input type="text" id="soi" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ã‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ñ‡∏ô‡∏ô</span>
                  </label>
                  <input type="text" id="road" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ñ‡∏ô‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="province" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" 
                      autocomplete="off" 
                      required>
                    <div id="provinceDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="district" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" 
                      autocomplete="off" 
                      required>
                    <div id="districtDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="subDistrict" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ï‡∏≥‡∏ö‡∏•" 
                      autocomplete="off" 
                      required>
                    <div id="subDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span>
                  </label>
                  <input type="text" id="zipcode" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" 
                    maxlength="5" 
                    pattern="[0-9]{5}">
                </div>
              </div>
            </div>

            <!-- Contact Address Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold flex items-center gap-2">
                  <i class="bi bi-telephone-fill text-green-600"></i>
                  ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                </h4>
                <div class="flex items-center gap-3">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="sameAsMainAddress" 
                           class="checkbox checkbox-primary" 
                           onchange="toggleContactAddress()">
                    <span class="text-sm font-medium text-blue-600 dark:text-blue-400">
                      <i class="bi bi-check-circle"></i> ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </span>
                  </label>
                </div>
              </div>
              
              <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                <p class="text-sm text-blue-700 dark:text-blue-300 flex items-start gap-2">
                  <i class="bi bi-info-circle-fill text-blue-600 mt-0.5 flex-shrink-0"></i>
                  <span>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ ‡∏´‡∏≤‡∏Å‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                </p>
              </div>

              <!-- Contact Address Form -->
              <div id="contactAddressForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></span>
                    </label>
                    <input type="text" id="contactHouseNo" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" 
                      required>
                    <div class="form-error hidden"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</span>
                    </label>
                    <input type="text" id="contactMoo" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏ã‡∏≠‡∏¢</span>
                    </label>
                    <input type="text" id="contactSoi" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ã‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏ñ‡∏ô‡∏ô</span>
                    </label>
                    <input type="text" id="contactRoad" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ñ‡∏ô‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="text-red-500">*</span></span>
                    </label>
                    <div class="relative">
                      <input type="text" id="contactProvince" 
                        class="input input-bordered w-full" 
                        placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" 
                        autocomplete="off" 
                        required>
                      <div id="contactProvinceDropdown" class="dropdown-content hidden"></div>
                    </div>
                    <div class="form-error hidden"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï <span class="text-red-500">*</span></span>
                    </label>
                    <div class="relative">
                      <input type="text" id="contactDistrict" 
                        class="input input-bordered w-full" 
                        placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï" 
                        autocomplete="off" 
                        required 
                        disabled>
                      <div id="contactDistrictDropdown" class="dropdown-content hidden"></div>
                    </div>
                    <div class="form-error hidden"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á <span class="text-red-500">*</span></span>
                    </label>
                    <div class="relative">
                      <input type="text" id="contactSubDistrict" 
                        class="input input-bordered w-full" 
                        placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á" 
                        autocomplete="off" 
                        required 
                        disabled>
                      <div id="contactSubDistrictDropdown" class="dropdown-content hidden"></div>
                    </div>
                    <div class="form-error hidden"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span>
                    </label>
                    <div class="relative">
                      <input type="text" id="contactPostalCode" 
                        class="input input-bordered w-full pr-10" 
                        placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" 
                        maxlength="5" 
                        pattern="[0-9]{5}"
                        autocomplete="postal-code">
                      <i class="bi bi-geo-alt-fill absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                  </div>
                </div>
                
                <!-- Contact Address Preview -->
                <div id="contactAddressPreview" class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
                  <h5 class="font-medium mb-2 flex items-center gap-2">
                    <i class="bi bi-eye"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                  </h5>
                  <p id="contactAddressPreviewText" class="text-sm text-gray-700 dark:text-gray-300"></p>
                </div>
              </div>

              <!-- Address Comparison -->
              <div id="addressComparison" class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-700 hidden">
                <h5 class="font-medium mb-3 flex items-center gap-2 text-yellow-800 dark:text-yellow-300">
                  <i class="bi bi-arrows-expand"></i> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
                </h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <h6 class="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-1">
                      <i class="bi bi-house"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </h6>
                    <p id="mainAddressComparison" class="text-gray-600 dark:text-gray-400 p-2 bg-white dark:bg-gray-800 rounded border"></p>
                  </div>
                  <div>
                    <h6 class="font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-1">
                      <i class="bi bi-telephone"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                    </h6>
                    <p id="contactAddressComparison" class="text-gray-600 dark:text-gray-400 p-2 bg-white dark:bg-gray-800 rounded border"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Map Coordinates Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-geo-alt-fill text-red-600"></i>
                ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Map Coordinates)
              </h4>
              
              <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                <p class="text-sm text-blue-700 dark:text-blue-300 flex items-start gap-2">
                  <i class="bi bi-info-circle-fill text-blue-600 mt-0.5 flex-shrink-0"></i>
                  <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Maps ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                </p>
              </div>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coordinates Input -->
                <div class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                      <label class="label">
                        <span class="label-text font-medium">Latitude (‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î)</span>
                      </label>
                      <div class="relative">
                        <input type="number" id="customerLatitude" 
                          class="input input-bordered w-full pr-10" 
                          placeholder="7.0000000" 
                          step="0.0000001" 
                          min="-90" 
                          max="90"
                          oninput="validateCoordinates(); updateMapPreview();">
                        <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                      </div>
                      <div class="form-error hidden"></div>
                    </div>
                    
                    <div class="form-group">
                      <label class="label">
                        <span class="label-text font-medium">Longitude (‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î)</span>
                      </label>
                      <div class="relative">
                        <input type="number" id="customerLongitude" 
                          class="input input-bordered w-full pr-10" 
                          placeholder="100.0000000" 
                          step="0.0000001" 
                          min="-180" 
                          max="180"
                          oninput="validateCoordinates(); updateMapPreview();">
                        <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                      </div>
                      <div class="form-error hidden"></div>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">Google Maps URL</span>
                    </label>
                    <div class="flex gap-2">
                      <input type="url" id="customerMapUrl" 
                        class="input input-bordered flex-1" 
                        placeholder="https://maps.google.com/..."
                        oninput="extractCoordinatesFromUrl(this.value)">
                      <button type="button" id="btnPasteMapUrl" class="btn btn-info" onclick="pasteMapUrl()">
                        <i class="bi bi-clipboard"></i> ‡∏ß‡∏≤‡∏á
                      </button>
                    </div>
                    <div class="form-hint text-xs text-gray-500 mt-1">
                      <i class="bi bi-link-45deg"></i> 
                      ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Maps ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                    </div>
                  </div>
                  
                  <div class="flex gap-2">
                    <button type="button" id="btnGetCurrentLocation" class="btn btn-success flex-1" onclick="getCurrentLocation()">
                      <i class="bi bi-geo-alt"></i> ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                    <button type="button" id="btnClearCoordinates" class="btn btn-ghost" onclick="clearCoordinates()">
                      <i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á
                    </button>
                  </div>
                  
                  <!-- Coordinates Display -->
                  <div id="coordinatesDisplay" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
                    <div class="flex items-center justify-between mb-2">
                      <h5 class="font-medium flex items-center gap-2">
                        <i class="bi bi-check-circle text-green-600"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
                      </h5>
                      <button type="button" onclick="copyCoordinates()" class="btn btn-xs btn-ghost">
                        <i class="bi bi-clipboard"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                      </button>
                    </div>
                    <p class="text-sm">
                      <strong>Lat:</strong> <span id="displayLatitude">-</span><br>
                      <strong>Lng:</strong> <span id="displayLongitude">-</span>
                    </p>
                  </div>
                </div>
                
                <!-- Map Preview -->
                <div class="space-y-4">
                  <div class="bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden">
                    <div class="bg-gray-200 dark:bg-gray-700 px-4 py-2 flex items-center justify-between">
                      <h5 class="font-medium flex items-center gap-2">
                        <i class="bi bi-map"></i> ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                      </h5>
                      <div class="flex gap-2">
                        <button type="button" id="btnRefreshMap" class="btn btn-xs btn-ghost" onclick="refreshMapPreview()">
                          <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" id="btnFullscreenMap" class="btn btn-xs btn-ghost" onclick="openFullscreenMap()">
                          <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div id="mapContainer" class="h-64 bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
                      <div id="mapPlaceholder" class="text-center text-gray-500">
                        <i class="bi bi-geo-alt text-4xl mb-2 block"></i>
                        <p class="text-sm">‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>
                      </div>
                      
                      <iframe id="mapPreview" 
                        class="w-full h-full border-0 hidden"
                        frameborder="0" 
                        style="border:0" 
                        allowfullscreen="" 
                        aria-hidden="false" 
                        tabindex="0">
                      </iframe>
                    </div>
                  </div>
                  
                  <!-- Map Actions -->
                  <div class="flex gap-2">
                    <button type="button" id="btnOpenInGoogleMaps" class="btn btn-outline flex-1 text-xs" onclick="openInGoogleMaps()" disabled>
                      <i class="bi bi-box-arrow-up-right"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
                    </button>
                    <button type="button" id="btnShareLocation" class="btn btn-outline text-xs" onclick="shareLocation()" disabled>
                      <i class="bi bi-share"></i> ‡πÅ‡∏ä‡∏£‡πå
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Document Upload Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6 mt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-camera text-blue-600"></i> 
                ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
              </h4>
              
              <div class="document-upload-grid">
                <!-- ID Card Photo -->
                <div class="document-upload-card" id="idCardUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-credit-card-2-front text-lg"></i> 
                      ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeIdCard" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadIdCard" accept="image/*" class="hidden">
                      <button type="button" id="btnUploadIdCard" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="idCardPreview" class="hidden document-preview">
                      <img id="idCardImage" class="w-full h-32 object-cover rounded">
                    </div>
                  </div>
                </div>

                <!-- Selfie Photo -->
                <div class="document-upload-card" id="selfieUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-person-circle text-lg"></i> 
                      ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeSelfie" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadSelfie" accept="image/*" class="hidden">
                      <button type="button" id="btnUploadSelfie" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="selfiePreview" class="hidden document-preview">
                      <img id="selfieImage" class="w-full h-32 object-cover rounded">
                    </div>
                  </div>
                </div>

                <!-- Salary Slip Upload -->
                <div class="document-upload-card" id="salarySlipUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 flex items-center gap-2">
                      <i class="bi bi-receipt text-lg text-blue-600"></i> 
                      ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </h5>
                    <div class="document-status" id="salarySlipStatus">
                      <span class="status-badge optional">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span>
                    </div>
                  </div>
                  
                  <p class="text-xs text-gray-500 mb-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeSalarySlip" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadSalarySlip" accept="image/*" class="hidden">
                      <button type="button" id="btnUploadSalarySlip" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="salarySlipPreview" class="hidden document-preview">
                      <img id="salarySlipImage" class="w-full h-32 object-cover rounded">
                      <div class="preview-overlay">
                        <div class="preview-actions">
                          <button type="button" id="btnRetakeSalarySlip" class="btn btn-sm btn-outline">
                            <i class="bi bi-arrow-repeat"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                          </button>
                          <button type="button" id="btnPreviewSalarySlip" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> ‡∏î‡∏π‡πÉ‡∏´‡∏ç‡πà
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div class="document-tips text-xs text-gray-500">
                      <i class="bi bi-lightbulb"></i> 
                      ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                    </div>
                  </div>
                </div>

                <!-- Customer Signature -->
                <div class="document-upload-card" id="customerSignatureCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-pencil-square text-lg"></i> 
                      ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                      <h6 class="font-medium mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h6>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20">
                          <input type="radio" id="authMethodSignature" name="customerAuthMethod" value="signature" class="radio radio-primary" checked>
                          <div class="flex items-center gap-2">
                            <i class="bi bi-pen text-blue-600"></i>
                            <span class="text-sm font-medium">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
                          </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20">
                          <input type="radio" id="authMethodFingerprint" name="customerAuthMethod" value="fingerprint" class="radio radio-primary">
                          <div class="flex items-center gap-2">
                            <i class="bi bi-fingerprint text-green-600"></i>
                            <span class="text-sm font-medium">‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</span>
                          </div>
                        </label>
                      </div>
                    </div>

                    <div id="signatureSection" class="signature-auth-section">
                      <div id="customerSignaturePreview" class="signature-preview border rounded-lg p-4 hidden">
                        <img id="customerSignatureImage" src="" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="max-w-full h-auto mx-auto">
                      </div>
                      
                      <div id="customerSignaturePlaceholder" class="signature-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="bi bi-pen text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ô</p>
                      </div>
                      
                      <div class="flex gap-2 mt-3">
                        <button type="button" id="btnOpenCustomerSignature" class="btn btn-primary flex-1 text-sm">
                          <i class="bi bi-pen"></i> ‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                        </button>
                        <button type="button" id="btnRetakeCustomerSignature" class="btn btn-outline flex-1 text-sm hidden">
                          <i class="bi bi-arrow-clockwise"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                      </div>
                    </div>

                    <div id="fingerprintSection" class="fingerprint-auth-section hidden">
                      <div id="customerFingerprintPreview" class="fingerprint-preview border rounded-lg p-4 hidden">
                        <div class="text-center">
                          <i class="bi bi-fingerprint text-6xl text-green-600 mb-2"></i>
                          <p class="text-sm text-green-600 font-medium">‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                        </div>
                      </div>
                      
                      <div id="customerFingerprintPlaceholder" class="fingerprint-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="bi bi-fingerprint text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</p>
                      </div>
                      
                      <div class="flex gap-2 mt-3">
                        <button type="button" id="btnScanFingerprint" class="btn btn-success flex-1 text-sm">
                          <i class="bi bi-fingerprint"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
                        </button>
                        <button type="button" id="btnRetakeFingerprint" class="btn btn-outline flex-1 text-sm hidden">
                          <i class="bi bi-arrow-clockwise"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Salesperson Signature -->
                <div class="document-upload-card" id="salespersonSignatureCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-green-600 flex items-center gap-2">
                      <i class="bi bi-person-badge text-lg"></i> 
                      ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                      <div class="flex items-center gap-2 text-green-700 dark:text-green-300">
                        <i class="bi bi-person-check-fill text-green-600"></i>
                        <span class="text-sm">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="salespersonName" class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></span>
                      </div>
                    </div>
                    
                    <div id="salespersonSignaturePreview" class="signature-preview border rounded-lg p-4 hidden">
                      <img id="salespersonSignatureImage" src="" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢" class="max-w-full h-auto mx-auto">
                    </div>
                    
                    <div id="salespersonSignaturePlaceholder" class="signature-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                      <i class="bi bi-person-badge text-3xl text-gray-400 mb-2"></i>
                      <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ô</p>
                    </div>
                    
                    <div class="flex gap-2 mt-3">
                      <button type="button" id="btnOpenSalespersonSignature" class="btn btn-success flex-1 text-sm">
                        <i class="bi bi-person-badge"></i> ‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                      </button>
                      <button type="button" id="btnRetakeSalespersonSignature" class="btn btn-outline flex-1 text-sm hidden">
                        <i class="bi bi-arrow-clockwise"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Email Automation Section -->
              <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
                <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                  <i class="bi bi-envelope-fill text-blue-600"></i>
                  ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á Gmail
                  <div class="ml-auto">
                    <span id="emailSettingsStatus" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                      ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </span>
                  </div>
                </h4>
                
                <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                  <p class="text-sm text-blue-700 dark:text-blue-300 mb-3 flex items-start gap-2">
                    <i class="bi bi-info-circle-fill text-blue-600 mt-0.5 flex-shrink-0"></i>
                    <span>‡∏´‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏ß‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô Gmail ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4 (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</span>
                  </p>
                  
                  <div class="text-xs text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-800/30 p-2 rounded">
                    <i class="bi bi-lightbulb-fill"></i> 
                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                  </div>
                </div>

                <!-- Email Required Notice -->
                <div id="emailRequiredNotice" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg hidden">
                  <div class="flex items-start gap-2">
                    <i class="bi bi-exclamation-triangle-fill text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-yellow-700 dark:text-yellow-300">
                      <p class="font-medium">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô</p>
                      <p class="text-xs mt-1">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô Gmail ‡πÑ‡∏î‡πâ</p>
                    </div>
                  </div>
                </div>

                <!-- Document Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <!-- Quotation Document -->
                  <div class="document-email-option" data-document="quotation">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailQuotation" name="emailDocuments" value="quotation" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-file-earmark-text text-blue-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
                        </p>
                        <div class="text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- Invoice Document -->
                  <div class="document-email-option" data-document="invoice">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailInvoice" name="emailDocuments" value="invoice" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-receipt text-orange-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞
                        </p>
                        <div class="text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- Receipt & Tax Invoice Document -->
                  <div class="document-email-option" data-document="receipt">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailReceipt" name="emailDocuments" value="receipt" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-file-earmark-check text-green-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à & ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
                        </p>
                        <div class="text-xs text-purple-600 dark:text-purple-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- Selection Summary -->
                <div id="emailDocumentSummary" class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
                  <h5 class="font-medium mb-2 flex items-center gap-2">
                    <i class="bi bi-envelope-check"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á Gmail
                  </h5>
                  <div id="selectedDocumentsList" class="space-y-1 text-sm">
                    <!-- Selected documents will be listed here -->
                  </div>
                  <div class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                    <i class="bi bi-info-circle"></i>
                    <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á: <span id="targetEmailDisplay" class="font-medium text-blue-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></span>
                  </div>
                </div>

                <!-- Email Preview & Test -->
                <div id="emailPreviewSection" class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700 hidden">
                  <div class="flex items-center justify-between mb-3">
                    <h5 class="font-medium flex items-center gap-2 text-blue-800 dark:text-blue-300">
                      <i class="bi bi-eye"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
                    </h5>
                    <button type="button" id="btnTestEmail" class="btn btn-sm btn-outline" onclick="testEmailSettings()">
                      <i class="bi bi-send"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    </button>
                  </div>
                  <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                    <p><strong>‡∏ñ‡∏∂‡∏á:</strong> <span id="emailPreviewTo">customer@email.com</span></p>
                    <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani</p>
                    <p><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö:</strong> <span id="emailPreviewAttachments">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤, ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Hidden inputs for storing data -->
  <input type="hidden" id="idCardImageUrl" name="idCardImageUrl" />
  <input type="hidden" id="selfieUrl" name="selfieUrl" />
  <input type="hidden" id="customerSignatureUrl" name="customerSignatureUrl" />
  <input type="hidden" id="customerFingerprintData" name="customerFingerprintData" />
  <input type="hidden" id="salespersonSignatureUrl" name="salespersonSignatureUrl" />

  <!-- Early function definitions moved to separate JS files -->
      
        <!-- Modular JavaScript Files -->
  <script src="js/global-data-manager.js"></script>
  <script src="js/cart-manager.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/form-validation.js"></script>
  <script src="js/document-manager.js"></script>
  <script src="js/customer-search.js"></script>
  <script src="js/email-automation.js"></script>
  <script src="js/form-progress.js"></script>
  <script src="js/step2-main.js"></script>
  <script src="js/step2-form-validation.js"></script>
  <script src="js/step2-map-coordinates.js"></script>
  <script src="js/step2-signature.js"></script>
  <script src="js/step2-core.js"></script>

  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>
</body>
</html>
        
        // Add citizen ID from form if available
        const citizenId = document.getElementById('customerIdCard')?.value;
        if (citizenId) {
          formData.append('citizenId', citizenId);
        }
        
        let endpoint = '/api/upload-documents/document';
        
        // Use specific endpoints for different document types
        switch (type) {
          case 'idCard':
            endpoint = '/api/upload-documents/id-card';
            break;
          case 'selfie':
            endpoint = '/api/upload-documents/selfie';
            break;
          case 'salarySlip':
            endpoint = '/api/upload-documents/salary-slip';
            break;
          case 'signature':
            endpoint = '/api/upload-documents/signature';
            break;
        }
        
        const response = await fetch(endpoint, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Upload failed');
        }
        
        return result;
      }
      
      getCurrentCustomerId() {
        const cleanId = getCleanIdCard('customerIdCard');
        return cleanId || 'temp_' + Date.now();
      }
      

      
      updateDocumentStatus(type, status) {
        const statusEl = document.getElementById(`${type}Status`);
        if (statusEl) {
          const statusConfig = {
            pending: { icon: 'clock', class: 'badge-warning', text: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
            completed: { icon: 'check-circle', class: 'badge-success', text: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
            error: { icon: 'exclamation-circle', class: 'badge-error', text: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' }
          };
          
          const config = statusConfig[status] || statusConfig.pending;
          statusEl.innerHTML = `
            <span class="badge ${config.class}">
              <i class="bi bi-${config.icon}"></i> ${config.text}
            </span>
          `;
        }
      }
      
      openCamera(type) {
        this.currentCameraType = type;
        const modal = document.getElementById('cameraModal');
        if (modal) {
          modal.style.display = 'block';
          this.startCamera();
        }
      }
      
      async startCamera() {
        try {
          const video = document.getElementById('cameraPreview');
          const constraints = {
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: this.currentCameraType === 'selfie' ? 'user' : 'environment'
            }
          };
          
          this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = this.currentStream;
          
          showToast('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
        } catch (error) {
          console.error('Camera error:', error);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
        }
      }
      
      capturePhoto() {
        const video = document.getElementById('cameraPreview');
        const canvas = document.getElementById('cameraCanvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        context.drawImage(video, 0, 0);
        
        canvas.toBlob((blob) => {
          const file = new File([blob], `${this.currentCameraType}_${Date.now()}.jpg`, {
            type: 'image/jpeg'
          });
          
          this.handleCapturedPhoto(file);
        }, 'image/jpeg', 0.8);
      }
      
      async handleCapturedPhoto(file) {
        const loader = LoadingSystem.show({ message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...' });
        
        try {
          const previewUrl = URL.createObjectURL(file);
          // this.updateDocumentPreview(this.currentCameraType, previewUrl); // Disabled - using modular approach
          
          const uploadResult = await this.uploadFile(file, this.currentCameraType);
          
          if (uploadResult.success) {
            this.documents[this.currentCameraType] = {
              status: 'completed',
              file: file,
              preview: previewUrl,
              url: uploadResult.url
            };
            
            this.updateDocumentStatus(this.currentCameraType, 'completed');
            this.closeCamera();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            throw new Error(uploadResult.error || 'Upload failed');
          }
        } catch (error) {
          console.error('Capture error:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
        } finally {
          LoadingSystem.hide(loader);
        }
      }
      
      closeCamera() {
        if (this.currentStream) {
          this.currentStream.getTracks().forEach(track => track.stop());
          this.currentStream = null;
        }
        
        const modal = document.getElementById('cameraModal');
        if (modal) {
          modal.style.display = 'none';
        }
        
        this.currentCameraType = null;
      }
      
      retakeDocument(type) {
        this.documents[type] = { status: 'pending', file: null, preview: null };
        this.updateDocumentStatus(type, 'pending');
        
        const preview = document.getElementById(`${type}Preview`);
        if (preview) {
          preview.innerHTML = `
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <i class="bi bi-camera text-4xl text-gray-400 mb-2"></i>
              <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
            </div>
          `;
        }
      }
      
      setupCameraHandlers() {
        // Camera modal handlers
        const captureBtn = document.getElementById('capturePhoto');
        if (captureBtn) {
          captureBtn.addEventListener('click', () => {
            this.capturePhoto();
          });
        }
        
        const closeCameraBtn = document.getElementById('closeCameraModal');
        if (closeCameraBtn) {
          closeCameraBtn.addEventListener('click', () => {
            this.closeCamera();
          });
        }
      }
      
      setupSignatureHandlers() {
        // Will be implemented with signature pad
      }
    }
    
    // Enhanced Signature Pad Manager
    class SignaturePadManager {
      constructor() {
        this.signaturePads = {};
        this.isInitialized = false;
      }
      
      initialize() {
        if (this.isInitialized) return;
        
        this.setupSignaturePads();
        this.setupSignatureHandlers();
        this.isInitialized = true;
      }
      
      setupSignaturePads() {
        const signatureTypes = ['signature', 'employeeSignature'];
        
        signatureTypes.forEach(type => {
          const canvas = document.getElementById(`${type}Canvas`);
          if (canvas && window.SignaturePad) {
            this.signaturePads[type] = new SignaturePad(canvas, {
              backgroundColor: 'rgba(255, 255, 255, 0)',
              penColor: 'black',
              minWidth: 0.5,
              maxWidth: 2.5,
              throttle: 16,
              minDistance: 5
            });
            
            this.resizeCanvas(canvas);
            this.setupCanvasEvents(type);
          }
        });
      }
      
      setupCanvasEvents(type) {
        const canvas = document.getElementById(`${type}Canvas`);
        if (!canvas) return;
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
          e.preventDefault();
        });
        
        canvas.addEventListener('touchmove', (e) => {
          e.preventDefault();
        });
        
        canvas.addEventListener('touchend', (e) => {
          e.preventDefault();
        });
        
        // Mouse events
        canvas.addEventListener('mousedown', () => {
          this.updateSignatureStatus(type, 'signing');
        });
        
        canvas.addEventListener('mouseup', () => {
          this.updateSignatureStatus(type, 'signed');
        });
      }
      
      resizeCanvas(canvas) {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
      }
      
      setupSignatureHandlers() {
        const signatureTypes = ['signature', 'employeeSignature'];
        
        signatureTypes.forEach(type => {
          // Clear button
          const clearBtn = document.getElementById(`clear${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
          if (clearBtn) {
            clearBtn.addEventListener('click', () => {
              this.clearSignature(type);
            });
          }
          
          // Save button
          const saveBtn = document.getElementById(`save${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
          if (saveBtn) {
            saveBtn.addEventListener('click', () => {
              this.saveSignature(type);
            });
          }
        });
      }
      
      clearSignature(type) {
        const pad = this.signaturePads[type];
        if (pad) {
          pad.clear();
          this.updateSignatureStatus(type, 'cleared');
        }
      }
      
      async saveSignature(type) {
        const pad = this.signaturePads[type];
        if (!pad) return;
        
        if (pad.isEmpty()) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning');
          return;
        }
        
        const loader = LoadingSystem.show({ message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô...' });
        
        try {
          const dataURL = pad.toDataURL();
          const blob = this.dataURLtoBlob(dataURL);
          const file = new File([blob], `${type}_${Date.now()}.png`, {
            type: 'image/png'
          });
          
          const uploadResult = await this.uploadSignature(file, type);
          
          if (uploadResult.success) {
            // this.updateSignaturePreview(type, dataURL); // Disabled - using modular approach
            this.updateSignatureStatus(type, 'completed');
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            throw new Error(uploadResult.error || 'Upload failed');
          }
        } catch (error) {
          console.error('Signature save error:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô', 'error');
        } finally {
          LoadingSystem.hide(loader);
        }
      }
      
      dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        
        return new Blob([u8arr], { type: mime });
      }
      
      async uploadSignature(file, type) {
        const formData = new FormData();
        formData.append('signature', file);
        formData.append('type', type);
        formData.append('customerId', this.getCurrentCustomerId());
        
        // Add citizen ID from form if available
        const citizenId = document.getElementById('customerIdCard')?.value;
        if (citizenId) {
          formData.append('citizenId', citizenId);
        }
        
        const response = await fetch('/api/upload-documents/signature', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Signature upload failed');
        }
        
        return result;
      }
      
      getCurrentCustomerId() {
        const cleanId = getCleanIdCard('customerIdCard');
        return cleanId || 'temp_' + Date.now();
      }
      

      
      updateSignatureStatus(type, status) {
        const statusEl = document.getElementById(`${type}Status`);
        if (statusEl) {
          const statusConfig = {
            pending: { icon: 'pen', class: 'badge-warning', text: '‡∏£‡∏≠‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô' },
            signing: { icon: 'pen-fill', class: 'badge-info', text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô' },
            signed: { icon: 'check', class: 'badge-success', text: '‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß' },
            completed: { icon: 'check-circle', class: 'badge-success', text: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
            cleared: { icon: 'pen', class: 'badge-warning', text: '‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß' }
          };
          
          const config = statusConfig[status] || statusConfig.pending;
          statusEl.innerHTML = `
            <span class="badge ${config.class}">
              <i class="bi bi-${config.icon}"></i> ${config.text}
            </span>
          `;
        }
      }
      
      retakeSignature(type) {
        this.clearSignature(type);
        const preview = document.getElementById(`${type}Preview`);
        if (preview) {
          preview.innerHTML = `
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <i class="bi bi-pen text-4xl text-gray-400 mb-2"></i>
              <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</p>
            </div>
          `;
        }
      }
    }
    
    // Enhanced Card Reader System
    class CardReaderManager {
      constructor() {
        this.isReading = false;
        this.reader = null;
        this.readTimeout = null;
      }
      
      initialize() {
        this.setupCardReaderButton();
        this.setupCardReaderEvents();
      }
      
      setupCardReaderButton() {
        const readBtn = document.getElementById('btnReadCard');
        if (readBtn) {
          readBtn.addEventListener('click', () => {
            this.readCard();
          });
        }
      }
      
      setupCardReaderEvents() {
        // Setup automatic validation when ID card is typed
        const idCardInput = document.getElementById('customerIdCard');
        if (idCardInput) {
          idCardInput.addEventListener('input', () => {
            this.validateIdCardInput();
          });
        }
      }
      
      validateIdCardInput() {
        const idCard = document.getElementById('customerIdCard').value;
        const cleanId = idCard.replace(/\D/g, ''); // ‡∏•‡∏ö dash ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏≠‡∏≠‡∏Å
        const isValid = validateIdCard(idCard);
        
        const validationEl = document.getElementById('idCardValidation');
        if (validationEl) {
          if (cleanId.length === 13) {
            if (isValid) {
              validationEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
              this.autoFillFromIdCard(cleanId); // ‡∏™‡πà‡∏á clean version ‡πÑ‡∏õ
            } else {
              validationEl.innerHTML = '<span class="text-error"><i class="bi bi-x-circle"></i> ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
            }
          } else if (cleanId.length > 0) {
            validationEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> ‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ${cleanId.length}/13 ‡∏´‡∏•‡∏±‡∏Å</span>';
          } else {
            validationEl.innerHTML = '';
          }
        }
      }
      
      autoFillFromIdCard(idCard) {
        // Auto-fill birth date and age from ID card
        const birthDate = parseBirthDateFromIdCard(idCard);
        const age = calculateAgeFromIdCard(idCard);
        
        if (birthDate) {
          const birthDateInput = document.getElementById('customerBirthDate');
          if (birthDateInput) {
            birthDateInput.value = birthDate;
          }
        }
        
        if (age) {
          const ageInput = document.getElementById('customerAge');
          if (ageInput) {
            ageInput.value = age;
          }
        }
      }
      
      async readCard() {
        if (this.isReading) return;
        
        this.isReading = true;
        this.updateReadButtonState('reading');
        
        try {
          // Simulate card reading process
          const cardData = await this.performCardRead();
          
          if (cardData) {
            this.fillFormFromCardData(cardData);
            this.updateReadButtonState('success');
            showToast('‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } else {
            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ');
          }
        } catch (error) {
          console.error('Card read error:', error);
          this.updateReadButtonState('error');
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£', 'error');
        } finally {
          this.isReading = false;
          
          // Reset button after 3 seconds
          setTimeout(() => {
            this.updateReadButtonState('ready');
          }, 3000);
        }
      }
      
      async performCardRead() {
        // Simulate API call to card reader
        return new Promise((resolve) => {
          setTimeout(() => {
            // Mock card data
            const mockData = {
              idCard: '1234567890123',
              firstName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
              lastName: '‡πÉ‡∏à‡∏î‡∏µ',
              birthDate: '1985-05-15',
              age: calculateAge('1985-05-15'),
              address: {
                houseNo: '123/45',
                province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
                district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
                subDistrict: '‡∏™‡∏∞‡∏ö‡∏≤‡∏£‡∏±‡∏á',
                postalCode: '94000'
              }
            };
            
            resolve(mockData);
          }, 2000);
        });
      }
      
      fillFormFromCardData(cardData) {
        const fieldMappings = {
          customerIdCard: cardData.idCard,
          customerFirstName: cardData.firstName,
          customerLastName: cardData.lastName,
          customerPhone: cardData.phone,
          customerIdCard: cardData.idCard,
          customerEmail: cardData.email,
          customerBirthDate: cardData.birthDate,
          customerAge: cardData.age,
          customerOccupation: cardData.occupation,
          customerIncome: cardData.income,
          customerWorkplace: cardData.workplace,
          houseNo: cardData.address?.houseNo,
          province: cardData.address?.province,
          district: cardData.address?.district,
          subDistrict: cardData.address?.subDistrict,
          postalCode: cardData.address?.postalCode
        };
        
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
            
            // Trigger change event for validation
            field.dispatchEvent(new Event('change'));
          }
        });
      }
      
      updateReadButtonState(state) {
        const button = document.getElementById('btnReadCard');
        if (!button) return;
        
        const states = {
          ready: {
            text: '<i class="bi bi-person-badge"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô',
            class: 'btn-primary',
            disabled: false
          },
          reading: {
            text: '<i class="bi bi-arrow-repeat spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£...',
            class: 'btn-warning',
            disabled: true
          },
          success: {
            text: '<i class="bi bi-check-circle"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            class: 'btn-success',
            disabled: true
          },
          error: {
            text: '<i class="bi bi-exclamation-circle"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            class: 'btn-error',
            disabled: true
          }
        };
        
        const stateConfig = states[state] || states.ready;
        button.innerHTML = stateConfig.text;
        button.className = `btn ${stateConfig.class}`;
        button.disabled = stateConfig.disabled;
      }
    }
    
    // Enhanced Form Validation
    function validateForm() {
      const requiredFields = [
        { id: 'customerFirstName', name: '‡∏ä‡∏∑‡πà‡∏≠' },
        { id: 'customerLastName', name: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' },
        { id: 'customerPhone', name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' },
        { id: 'customerIdCard', name: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' },
        { id: 'customerBirthDate', name: '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î' },
        { id: 'customerAge', name: '‡∏≠‡∏≤‡∏¢‡∏∏' }
      ];
      
      let isValid = true;
      let firstInvalidField = null;
      
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        const value = element?.value?.trim();
        
        if (!value) {
          isValid = false;
          if (!firstInvalidField) {
            firstInvalidField = field;
          }
          
          // Add error styling
          if (element) {
            element.classList.add('validation-error');
          }
        } else {
          // Remove error styling
          if (element) {
            element.classList.remove('validation-error');
          }
        }
      });
      
      // Additional validations
      const idCard = document.getElementById('customerIdCard')?.value;
      if (idCard && !validateIdCard(idCard)) {
        isValid = false;
        if (!firstInvalidField) {
          firstInvalidField = { id: 'customerIdCard', name: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' };
        }
      }
      
      const age = parseInt(document.getElementById('customerAge')?.value);
      if (age && age < 18) {
        isValid = false;
        if (!firstInvalidField) {
          firstInvalidField = { id: 'customerAge', name: '‡∏≠‡∏≤‡∏¢‡∏∏' };
        }
        showToast('‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ', 'error');
      }
      
      return { isValid, firstInvalidField };
    }
    
    // Initialize managers (disabled - using modular approach)
    // let customerSearchManager;
    // let documentManager;
    // let signaturePadManager;
    // let cardReaderManager;
    
    // Initialize all systems
    function initializeEnhancedSystems() {
      // Using modular JS files instead of inline classes
      console.log('‚úÖ Using modular approach - Enhanced systems disabled');
    }

    // Utility function for image URLs (matching step1.html)
    function getImageUrl(imagePath) {
      if (!imagePath) return '/uploads/Logo2.png';
      if (imagePath.startsWith('http')) return imagePath;
      if (imagePath.startsWith('/')) return imagePath;
      return `/uploads/products/${imagePath}`;
    }

    // Note: Functions moved to step2-core.js to avoid duplication

    // Camera functionality
    function initCamera(targetType) {
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('cameraCanvas');
      const title = document.getElementById('cameraModalTitle');
      
      title.textContent = targetType === 'idCard' ? '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' : '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà';
      
      modal.classList.remove('hidden');
      
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          currentStream = stream;
          video.srcObject = stream;
          
          document.getElementById('capturePhoto').onclick = () => {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            
            // Update preview
            if (targetType === 'idCard') {
              updateIdCardPreview(dataURL);
            } else if (targetType === 'selfie') {
              updateSelfiePreview(dataURL);
            }
            
            modal.classList.add('hidden');
          };
        })
        .catch(error => {
          console.error('Camera error:', error);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
          modal.classList.add('hidden');
        });
    }

    function updateIdCardPreview(dataURL) {
      const preview = document.getElementById('idCardPreview');
      const image = document.getElementById('idCardImage');
      const hiddenInput = document.getElementById('idCardImageUrl');
      
      image.src = dataURL;
      preview.classList.remove('hidden');
      hiddenInput.value = dataURL;
      
      // Update status
      const statusBadge = document.querySelector('#idCardUploadCard .status-badge');
      statusBadge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
      statusBadge.className = 'status-badge completed';
      
      showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function updateSelfiePreview(dataURL) {
      const preview = document.getElementById('selfiePreview');
      const image = document.getElementById('selfieImage');
      const hiddenInput = document.getElementById('selfieUrl');
      
      image.src = dataURL;
      preview.classList.remove('hidden');
      hiddenInput.value = dataURL;
      
      // Update status
      const statusBadge = document.querySelector('#selfieUploadCard .status-badge');
      statusBadge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
      statusBadge.className = 'status-badge completed';
      
      showToast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // Signature functionality
    function initSignature(type) {
      const modal = document.getElementById('signatureModal');
      const canvas = document.getElementById('signatureModalCanvas');
      const title = document.getElementById('signatureModalTitle');
      
      // Check if elements exist before using them
      if (!modal || !canvas) {
        console.warn('Signature modal elements not found. Creating signature modal...');
        createSignatureModal();
        return;
      }
      
      currentSignatureType = type;
      
      if (title) {
        title.textContent = type === 'customer' ? '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
      }
      
      modal.classList.remove('hidden');
      
      // Setup canvas
      const ratio = window.devicePixelRatio || 1;
      canvas.width = 500 * ratio;
      canvas.height = 200 * ratio;
      canvas.style.width = '100%';
      canvas.style.height = '200px';
      
      const ctx = canvas.getContext('2d');
      ctx.scale(ratio, ratio);
      
      // Initialize signature pad
      if (signaturePad) {
        signaturePad.clear();
      }
      
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3
      });
    }

    function saveSignature() {
      if (!signaturePad || signaturePad.isEmpty()) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
      }
      
      const dataURL = signaturePad.toDataURL();
      
      if (currentSignatureType === 'customer') {
        // Update customer signature
        const preview = document.getElementById('customerSignaturePreview');
        const image = document.getElementById('customerSignatureImage');
        const placeholder = document.getElementById('customerSignaturePlaceholder');
        const hiddenInput = document.getElementById('customerSignatureUrl');
        const retakeBtn = document.getElementById('btnRetakeCustomerSignature');
        
        image.src = dataURL;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        hiddenInput.value = dataURL;
        retakeBtn.classList.remove('hidden');
        
        // Update status
        const statusBadge = document.querySelector('#customerSignatureCard .status-badge');
        statusBadge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
        statusBadge.className = 'status-badge completed';
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } else if (currentSignatureType === 'salesperson') {
        // Update salesperson signature
        const preview = document.getElementById('salespersonSignaturePreview');
        const image = document.getElementById('salespersonSignatureImage');
        const placeholder = document.getElementById('salespersonSignaturePlaceholder');
        const hiddenInput = document.getElementById('salespersonSignatureUrl');
        const retakeBtn = document.getElementById('btnRetakeSalespersonSignature');
        
        image.src = dataURL;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
        hiddenInput.value = dataURL;
        retakeBtn.classList.remove('hidden');
        
        // Update status
        const statusBadge = document.querySelector('#salespersonSignatureCard .status-badge');
        statusBadge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
        statusBadge.className = 'status-badge completed';
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }
      
      document.getElementById('signatureModal').classList.add('hidden');
    }

    // Navigation functions
    function goToStep1() {
      window.location.href = '../step1/step1.html';
    }



    // =================== CART MANAGEMENT FUNCTIONS ===================
    
    // Global cart variables  
    let cartItems = [];
    let branchInstallments = [];
    
    // Utility functions

    function getImageUrl(imagePath) {
      if (!imagePath) return '/uploads/Logo2.png';
      if (imagePath.startsWith('http')) return imagePath;
      if (imagePath.startsWith('/')) return imagePath;
      return `/uploads/products/${imagePath}`;
    }

    // Cart display functions
    function renderCart() {
      const cartContainer = document.getElementById('productSummary');
      if (!cartContainer) return;

      if (cartItems.length === 0) {
        cartContainer.innerHTML = `
          <div class="text-center py-8">
            <i class="bi bi-cart text-4xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏á</p>
            <p class="text-xs text-gray-400 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1</p>
          </div>
        `;
        return;
      }

      let totalAmount = 0;
      cartContainer.innerHTML = '';
      
      cartItems.forEach((item, index) => {
        totalAmount += item.totalPrice;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item bg-white dark:bg-gray-800 rounded-lg p-4 border mb-3';
        
        cartItem.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${getImageUrl(item.image)}" alt="${item.name}"
                 class="w-16 h-16 object-cover rounded-lg"
                 onerror="this.src='/uploads/Logo2.png'">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${item.name}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400">${item.brand}</p>
              ${item.imei ? `<p class="text-xs text-blue-600 dark:text-blue-400 font-mono">IMEI: ${item.imei}</p>` : ''}
              <div class="flex gap-2 mt-1">
                <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">‡∏ú‡πà‡∏≠‡∏ô</span>
                ${item.downAmount > 0 ? `<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">‡∏î‡∏≤‡∏ß‡∏ô‡πå ‡∏ø${formatPrice(item.downAmount)}</span>` : ''}
              </div>
              <p class="text-xs text-gray-500 mt-1">‡∏ø${formatPrice(item.price)} √ó ${item.quantity}</p>
            </div>
            <div class="text-right">
              <p class="font-semibold text-primary">‡∏ø${formatPrice(item.totalPrice)}</p>
              <div class="flex items-center space-x-2 mt-1">
                ${!item.imei ? `
                  <button onclick="updateQuantity(${index}, -1)" 
                          class="btn btn-xs btn-circle" ${item.quantity <= 1 ? 'disabled' : ''}>
                    <i class="bi bi-dash"></i>
                  </button>
                  <span class="text-sm">${item.quantity}</span>
                  <button onclick="updateQuantity(${index}, 1)" 
                          class="btn btn-xs btn-circle" ${item.quantity >= item.maxStock ? 'disabled' : ''}>
                    <i class="bi bi-plus"></i>
                  </button>
                ` : `
                  <span class="text-xs text-gray-500">IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ</span>
                `}
                <button onclick="removeFromCart(${index})" 
                        class="btn btn-xs btn-circle btn-error">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        cartContainer.appendChild(cartItem);
      });
      
      // Add total display
      const totalDiv = document.createElement('div');
      totalDiv.className = 'border-t pt-3 mt-3';
      totalDiv.innerHTML = `
        <div class="flex justify-between items-center font-bold">
          <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
          <span class="text-primary">‡∏ø${formatPrice(totalAmount)}</span>
        </div>
      `;
      cartContainer.appendChild(totalDiv);
    }
    
    function updateQuantity(index, change) {
      const item = cartItems[index];
      
      // IMEI products cannot change quantity
      if (item.imei) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏î‡πâ (1 IMEI = 1 ‡∏ä‡∏¥‡πâ‡∏ô)', 'warning');
        return;
      }
      
      const newQuantity = item.quantity + change;
      
      if (newQuantity <= 0) {
        removeFromCart(index);
        return;
      }
      
      if (newQuantity > item.maxStock) {
        showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å', 'warning');
        return;
      }
      
      item.quantity = newQuantity;
      item.totalPrice = item.quantity * item.price;
      
      renderCart();
      updateCartCount();
      
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      
      // Sync with Global Data Manager
      const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
      globalDataManager.updateStepData(1, {
        cartItems: cartItems,
        selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
        totalAmount: totalAmount
      });
    }
    
    function updateCartCount() {
      const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountEl = document.getElementById('cartCount');
      if (cartCountEl) {
        cartCountEl.textContent = count;
      }
    }
    
    function removeFromCart(index) {
      const item = cartItems[index];
      cartItems.splice(index, 1);
      
      renderCart();
      updateCartCount();
      
      localStorage.setItem('cartItems', JSON.stringify(cartItems));
      
      // Sync with Global Data Manager
      const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
      globalDataManager.updateStepData(1, {
        cartItems: cartItems,
        selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
        totalAmount: totalAmount
      });
      
      showToast(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${item.name}' ${item.imei ? `(IMEI: ${item.imei})` : ''} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'info');
    }

    // ======================= BARCODE INPUT PROCESSING =======================
    // Barcode functions moved to Step 1 - not needed in Step 2
    
    async function findAndAddToCartByBarcode(barcode) {
      const barcodeInput = document.getElementById('barcodeInput');
      const barcodeResults = document.getElementById('barcodeResults');
      const barcodeProductInfo = document.getElementById('barcodeProductInfo');
      
      try {
        const branchCode = getBranchCode();
        
        // Check if installment products data is available
        if (!branchInstallments || branchInstallments.length === 0) {
          // Load installment products if not available
          await loadBranchInstallments();
        }
        
        // Find product by IMEI first (local search)
        let product = branchInstallments.find(p => 
          p.imei === barcode || 
          p.barcode === barcode ||
          p.name.toLowerCase().includes(barcode.toLowerCase())
        );
        
        // If not found locally, search via API
        if (!product) {
          const response = await fetch(`/api/branch-stock/search?branch_code=${branchCode}&q=${encodeURIComponent(barcode)}&type=imei&purchaseType=installment`);
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data && data.data.length > 0) {
              const foundItem = data.data[0];
              
              product = {
                id: foundItem._id,
                name: foundItem.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
                brand: foundItem.brand || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
                price: foundItem.price || 0,
                stock: foundItem.stock_value || 0,
                imei: foundItem.imei || null,
                image: foundItem.image || '/uploads/Logo2.png',
                downAmount: foundItem.downAmount || 0,
                downInstallment: foundItem.downInstallment || 0,
                downInstallmentCount: foundItem.downInstallmentCount || 0,
                maxStock: foundItem.stock_value || 0
              };
              
              // Add to branchInstallments for future reference
              branchInstallments.push(product);
            }
          }
        }
        
        if (product) {
          // Check if product is already in cart
          const inCart = cartItems.some(item => 
            item.imei === product.imei || 
            (item.id === product.id && product.imei)
          );
          
          if (inCart) {
            showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}' (IMEI: ${product.imei}) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
            if (barcodeResults) barcodeResults.classList.add('hidden');
            if (barcodeInput) {
              barcodeInput.focus();
              barcodeInput.select();
            }
            return;
          }
          
          // Check stock
          if (product.stock <= 0) {
            showToast(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '${product.name}' ‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å`, 'error');
            if (barcodeResults) barcodeResults.classList.add('hidden');
            if (barcodeInput) barcodeInput.focus();
            return;
          }
          
          // Show product found message
          if (barcodeProductInfo) {
            barcodeProductInfo.innerHTML = `
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium">${product.name}</div>
                  <div class="text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°: ‡∏ø${formatPrice(product.price)}</div>
                  ${product.downAmount > 0 ? `<div class="text-xs">‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${formatPrice(product.downAmount)}</div>` : ''}
                  ${product.downInstallment > 0 ? `<div class="text-xs">‡∏ú‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏ø${formatPrice(product.downInstallment)}/${product.downInstallmentCount} ‡∏á‡∏ß‡∏î</div>` : ''}
                  ${product.imei ? `<div class="text-xs">IMEI: ${product.imei}</div>` : ''}
                  ${product.brand ? `<div class="text-xs">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${product.brand}</div>` : ''}
                </div>
                <div class="text-right">
                  <div class="badge badge-success">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
                  <div class="text-xs mt-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${product.stock}</div>
                </div>
              </div>
            `;
            barcodeResults.classList.remove('hidden');
          }
          
          // Add to cart
          const cartItem = {
            id: product.id,
            name: product.name,
            brand: product.brand,
            price: product.price,
            quantity: 1,
            totalPrice: product.price,
            image: product.image,
            barcode: product.barcode || product.imei,
            maxStock: product.stock,
            downAmount: product.downAmount || 0,
            downInstallment: product.downInstallment || 0,
            downInstallmentCount: product.downInstallmentCount || 0,
            stockType: 'imei'
          };
          
          // Add IMEI if available
          if (product.imei) {
            cartItem.imei = product.imei;
          }
          
          cartItems.push(cartItem);
          
          // Update displays
          renderCart();
          updateCartCount();
          
          // Save to localStorage
          localStorage.setItem('cartItems', JSON.stringify(cartItems));
          
          // Sync with Global Data Manager
          const totalAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
          globalDataManager.updateStepData(1, {
            cartItems: cartItems,
            selectedProducts: cartItems.map(item => ({ id: item.id, imei: item.imei })),
            totalAmount: totalAmount
          });
          
          showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô '${product.name}' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
          
          // Clear input after successful scan
          if (barcodeInput) barcodeInput.value = '';
          
          // Auto-hide results after 3 seconds
          setTimeout(() => {
            if (barcodeResults) barcodeResults.classList.add('hidden');
          }, 3000);
          
          // Focus back to barcode input for next scan
          setTimeout(() => {
            if (barcodeInput) barcodeInput.focus();
          }, 100);
          
        } else {
          showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å IMEI ‡∏ô‡∏µ‡πâ', 'error');
          if (barcodeResults) barcodeResults.classList.add('hidden');
        }
      } catch (error) {
        console.error('Barcode search error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + error.message, 'error');
        if (barcodeResults) barcodeResults.classList.add('hidden');
      }
    }

    // Load branch installments for barcode search
    async function loadBranchInstallments() {
      try {
        const branchCode = getBranchCode();
        const response = await fetch(`/api/installment/products/${branchCode}`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data && data.data.length > 0) {
            branchInstallments = data.data.map(item => ({
              id: item._id,
              name: item.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠',
              brand: item.brand || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå',
              price: item.price || 0,
              stock: item.stock_value || 0,
              barcode: item.imei || `${item.name}_${item._id}`,
              imei: item.imei || null,
              image: item.image || '/uploads/Logo2.png',
              downAmount: item.downAmount || 0,
              downInstallment: item.downInstallment || 0,
              downInstallmentCount: item.downInstallmentCount || 0
            }));
          }
        }
      } catch (error) {
        console.error('Error loading installments:', error);
      }
    }

    function getBranchCode() {
      return window.BRANCH_CODE || localStorage.getItem('activeBranch') || 'PATTANI';
    }

    // Initialize branch code and global data manager if not available
    if (!window.BRANCH_CODE) {
      const urlParams = new URLSearchParams(window.location.search);
      window.BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch') || 'PATTANI';
      localStorage.setItem('activeBranch', window.BRANCH_CODE);
    }

    // Initialize global data manager if not available
    if (!window.globalDataManager) {
      // Create a simple fallback global data manager
      window.globalDataManager = {
        stepData: {
          step1: { completed: false, data: { cartItems: [], branchCode: getBranchCode(), selectedProducts: [], totalAmount: 0 } },
          step2: { completed: false, data: { customerData: null, documentUploads: [], authMethod: null, signature: null } }
        },
        updateStepData: function(stepNumber, data) {
          const stepKey = `step${stepNumber}`;
          if (this.stepData[stepKey]) {
            this.stepData[stepKey].data = { ...this.stepData[stepKey].data, ...data };
            localStorage.setItem('globalStepData', JSON.stringify(this.stepData));
          }
        },
        getStepData: function(stepNumber) {
          const stepKey = `step${stepNumber}`;
          return this.stepData[stepKey] ? this.stepData[stepKey].data : null;
        }
      };
      
      // Load existing data from localStorage
      const savedStepData = localStorage.getItem('globalStepData');
      if (savedStepData) {
        try {
          const parsed = JSON.parse(savedStepData);
          window.globalDataManager.stepData = { ...window.globalDataManager.stepData, ...parsed };
        } catch (e) {
          console.warn('Error loading saved step data:', e);
        }
      }
    }

    // =================== ID CARD UTILITIES ===================
    
    // Helper function to get clean ID card number (without dashes)
    function getCleanIdCard(inputId = 'customerIdCard') {
      const element = document.getElementById(inputId);
      if (!element) return '';
      return element.value.replace(/\D/g, '');
    }
    
    // Helper function to validate and get clean ID card
    function getValidatedIdCard(inputId = 'customerIdCard') {
      const cleanId = getCleanIdCard(inputId);
      if (cleanId.length === 13 && validateIdCard(cleanId)) {
        return cleanId;
      }
      return null;
    }

    // =================== FORM PROGRESS CALCULATION ===================
    
    function calculateFormProgress() {
      const requiredFields = [
        'customerFirstName',
        'customerLastName', 
        'customerPhone',
        'customerIdCard',
        'customerBirthDate',
        'customerAge',
        'customerOccupation',
        'customerIncome',
        'customerAddress',
        'province',
        'district',
        'subDistrict',
        'zipcode'
      ];
      
      let filledCount = 0;
      let totalFields = requiredFields.length;
      
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value.trim() !== '') {
          filledCount++;
        }
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      // ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Facebook, Line)
      const facebookField = document.getElementById('customerFacebook');
      const lineField = document.getElementById('customerLineId');
      if ((facebookField && facebookField.value.trim() !== '') || 
          (lineField && lineField.value.trim() !== '')) {
        filledCount += 0.5; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      }
      totalFields += 1;
      
      // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
      const latField = document.getElementById('customerLatitude');
      const lngField = document.getElementById('customerLongitude');
      if (latField && lngField && latField.value.trim() !== '' && lngField.value.trim() !== '') {
        filledCount += 0.5; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      }
      totalFields += 1;
      
      // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
      const idCardStatus = document.getElementById('idCardStatus');
      const selfieStatus = document.getElementById('selfieStatus');
      const salarySlipStatus = document.getElementById('salarySlipStatus');
      
      let documentsUploaded = 0;
      if (idCardStatus && idCardStatus.textContent.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) documentsUploaded++;
      if (selfieStatus && selfieStatus.textContent.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) documentsUploaded++;
      if (salarySlipStatus && salarySlipStatus.textContent.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) documentsUploaded++;
      
      if (documentsUploaded > 0) {
        filledCount += (documentsUploaded / 3); // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
      }
      totalFields += 1;
      
      // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
      const customerSignature = document.getElementById('customerSignatureUrl');
      const salespersonSignature = document.getElementById('salespersonSignatureUrl');
      if ((customerSignature && customerSignature.value.trim() !== '') || 
          (salespersonSignature && salespersonSignature.value.trim() !== '')) {
        filledCount += 0.5; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      }
      totalFields += 1;
      
      const percentage = Math.round((filledCount / totalFields) * 100);
      return Math.min(100, Math.max(0, percentage));
    }
    
    function updateFormProgress() {
      const percentage = calculateFormProgress();
      const progressElement = document.getElementById('formProgress');
      const progressBarElement = document.getElementById('formProgressBar');
      const progressDetailsElement = document.getElementById('formProgressDetails');
      
      if (progressElement) {
        progressElement.textContent = percentage + '%';
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå
        if (percentage >= 80) {
          progressElement.className = 'text-sm font-bold text-green-600';
        } else if (percentage >= 50) {
          progressElement.className = 'text-sm font-bold text-yellow-600';
        } else {
          progressElement.className = 'text-sm font-bold text-red-600';
        }
      }
      
      if (progressBarElement) {
        progressBarElement.style.width = percentage + '%';
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö progress
        if (percentage >= 80) {
          progressBarElement.style.backgroundColor = '#10b981'; // green
        } else if (percentage >= 50) {
          progressBarElement.style.backgroundColor = '#f59e0b'; // yellow
        } else {
          progressBarElement.style.backgroundColor = '#ef4444'; // red
        }
      }
      
      if (progressDetailsElement) {
        if (percentage >= 90) {
          progressDetailsElement.textContent = 'üéâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ!';
          progressDetailsElement.className = 'text-xs text-green-600 mt-1';
        } else if (percentage >= 70) {
          progressDetailsElement.textContent = '‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
          progressDetailsElement.className = 'text-xs text-yellow-600 mt-1';
        } else if (percentage >= 40) {
          progressDetailsElement.textContent = 'üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
          progressDetailsElement.className = 'text-xs text-blue-600 mt-1';
        } else {
          progressDetailsElement.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
          progressDetailsElement.className = 'text-xs text-red-600 mt-1';
        }
      }
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      const nextButton = document.getElementById('btnStep2ToStep3');
      if (nextButton) {
        if (percentage >= 70) {
          nextButton.disabled = false;
          nextButton.classList.remove('btn-disabled');
          nextButton.innerHTML = '<i class="bi bi-arrow-right mr-2"></i> ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        } else {
          nextButton.disabled = true;
          nextButton.classList.add('btn-disabled');
          nextButton.innerHTML = '<i class="bi bi-exclamation-triangle mr-2"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
        }
      }
    }
    
    // Auto-update progress when form fields change
    function setupFormProgressTracking() {
      const formFields = [
        'customerFirstName', 'customerLastName', 'customerPhone', 'customerIdCard',
        'customerBirthDate', 'customerAge', 'customerOccupation', 'customerIncome',
        'customerAddress', 'province', 'district', 'subDistrict', 'zipcode',
        'customerFacebook', 'customerLineId', 'customerLatitude', 'customerLongitude'
      ];
      
      formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', updateFormProgress);
          field.addEventListener('change', updateFormProgress);
          field.addEventListener('blur', updateFormProgress);
        }
      });
      
      // Track file uploads
      const uploadElements = ['idCardStatus', 'selfieStatus', 'salarySlipStatus'];
      uploadElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          const observer = new MutationObserver(updateFormProgress);
          observer.observe(element, { childList: true, subtree: true, characterData: true });
        }
      });
      
      // Track signatures
      const signatureElements = ['customerSignatureUrl', 'salespersonSignatureUrl'];
      signatureElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
          const observer = new MutationObserver(updateFormProgress);
          observer.observe(element, { attributes: true, attributeFilter: ['value'] });
        }
      });
    }

    // =================== END FORM PROGRESS ===================

    // Note: Main initialization moved to step2-main.js to avoid duplication

    // =================== ENHANCED LOCATION AUTOCOMPLETE SYSTEM ===================
    
    function initializeLocationAutocomplete() {
      console.log('üåç Initializing Enhanced Location Autocomplete...');
      
      const provInput = document.getElementById('province');
      const distInput = document.getElementById('district');
      const subInput = document.getElementById('subDistrict');
      const zipInput = document.getElementById('zipcode');

      const provDD = document.getElementById('provinceDropdown');
      const distDD = document.getElementById('districtDropdown');
      const subDD = document.getElementById('subDistrictDropdown');

      if (!provInput || !distInput || !subInput || !zipInput || !provDD || !distDD || !subDD) {
        console.warn('‚ö†Ô∏è Some location elements not found, skipping initialization');
        return;
      }

      // Setup Province dropdown
      const provinceDropdown = setupEnhancedDropdown(provInput, provDD, (itemData) => {
        console.log('üèõÔ∏è Selected province:', itemData);
        
        provInput.value = itemData.name || itemData.name_th || '';
        distInput.value = '';
        subInput.value = '';
        zipInput.value = '';
        
        // Load amphures for this province
        const provinceId = parseInt(itemData.province_id) || itemData.id;
        if (provinceId) {
          loadAmphures(provinceId, districtDropdown);
        }
      });

      // Setup District dropdown
      const districtDropdown = setupEnhancedDropdown(distInput, distDD, (itemData) => {
        console.log('üèòÔ∏è Selected district:', itemData);
        
        distInput.value = itemData.name || itemData.name_th || '';
        subInput.value = '';
        zipInput.value = '';
        
        // Load tambons for this amphure
        const provinceId = parseInt(itemData.province_id) || itemData.province_id;
        const amphureId = parseInt(itemData.amphure_id) || itemData.id;
        
        if (provinceId && amphureId) {
          loadTambons(provinceId, amphureId, tambonDropdown);
        }
      });

      // Setup Tambon dropdown
      const tambonDropdown = setupEnhancedDropdown(subInput, subDD, (itemData) => {
        console.log('üèòÔ∏è Selected tambon:', itemData);
        
        subInput.value = itemData.name || itemData.name_th || '';
        
        // Auto-fill zipcode
        const zipcode = itemData.zip_code || itemData.zipcode || itemData.postal_code;
        if (zipcode) {
          zipInput.value = zipcode;
        }
      });

      // Enhanced Province search
      provInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value.trim();
        if (query.length < 1) {
          provinceDropdown.close();
          return;
        }

        try {
          const response = await fetch(`/api/provinces/search?q=${encodeURIComponent(query)}&type=province&limit=10`);
          const data = await response.json();
          
          let provinces = null;
          if (Array.isArray(data)) {
            provinces = data;
          } else if (data.success && data.data && Array.isArray(data.data)) {
            provinces = data.data;
          }
          
          if (provinces && provinces.length > 0) {
            const items = provinces
              .filter(item => item && (item.province_id || item.id))
              .map(item => {
                const id = item.province_id || item.id;
                const name = item.name_th || item.name;
                return {
                  id: id,
                  name: name,
                  province_id: id,
                  displayText: name,
                  subText: `‡∏£‡∏´‡∏±‡∏™: ${id}`
                };
              });
            
            provinceDropdown.setItems(items);
            provinceDropdown.open();
          } else {
            provinceDropdown.setItems([]);
            provinceDropdown.open();
          }
        } catch (error) {
          console.error('Province search error:', error);
        }
      }, 300));

      console.log('‚úÖ Enhanced Location Autocomplete initialized successfully!');
    }

    // Enhanced Dropdown Setup Function
    function setupEnhancedDropdown(input, dropdown, onSelect, options = {}) {
      let items = [];
      let selectedIndex = -1;
      
      // Input focus handler
      input.addEventListener('focus', () => {
        if (items.length > 0) {
          showItems(items);
        } else {
          showPlaceholder();
        }
      });

      // Click outside handler
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });

      // Keyboard navigation
      input.addEventListener('keydown', (e) => {
        const itemElements = dropdown.querySelectorAll('.dropdown-item');
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, itemElements.length - 1);
            updateSelection(itemElements);
            break;
          case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(itemElements);
            break;
          case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && itemElements[selectedIndex]) {
              const itemData = JSON.parse(itemElements[selectedIndex].dataset.item);
              onSelect(itemData);
              hideDropdown();
            }
            break;
          case 'Escape':
            e.preventDefault();
            hideDropdown();
            break;
        }
      });

      function showItems(itemList) {
        items = itemList || [];
        dropdown.innerHTML = '';
        
        if (!Array.isArray(itemList) || itemList.length === 0) {
          showNoResults();
          return;
        }

        itemList.forEach((item, index) => {
          if (!item) return;
          
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          
          try {
            div.dataset.item = JSON.stringify(item);
          } catch (e) {
            console.warn('Failed to stringify item:', item);
            return;
          }
          
          const displayText = item.displayText || item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
          const subText = item.subText || '';
          
          div.innerHTML = `
            <div class="dropdown-item-main">${displayText}</div>
            ${subText ? `<div class="dropdown-item-sub">${subText}</div>` : ''}
          `;
          
          div.addEventListener('click', () => {
            onSelect(item);
            hideDropdown();
          });
          
          dropdown.appendChild(div);
        });

        dropdown.classList.remove('hidden');
        selectedIndex = -1;
      }

      function showPlaceholder() {
        dropdown.innerHTML = `
          <div class="dropdown-loading">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>
        `;
        dropdown.classList.remove('hidden');
      }

      function showNoResults() {
        dropdown.innerHTML = `
          <div class="dropdown-no-results">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        `;
        dropdown.classList.remove('hidden');
      }

      function hideDropdown() {
        dropdown.classList.add('hidden');
        selectedIndex = -1;
      }

      function updateSelection(itemElements) {
        itemElements.forEach((el, index) => {
          el.classList.toggle('selected', index === selectedIndex);
        });
        
        if (selectedIndex >= 0 && itemElements[selectedIndex]) {
          itemElements[selectedIndex].scrollIntoView({ block: 'nearest' });
        }
      }

      return {
        setItems: (newItems) => {
          items = newItems;
        },
        close: hideDropdown,
        open: () => {
          if (items.length > 0) {
            showItems(items);
          } else {
            showPlaceholder();
          }
        }
      };
    }

    // Load functions
    async function loadAmphures(provinceId, districtDropdownRef) {
      try {
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
        
        if (!distInput || !distDD) return;

        if (!provinceId || isNaN(provinceId)) {
          console.error('‚ùå Invalid provinceId for amphure loading:', provinceId);
          if (distInput) distInput.value = '';
          if (distDD) {
            distDD.innerHTML = '<div class="dropdown-no-results">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
            distDD.classList.remove('hidden');
          }
          return;
        }

        console.log('üîç Loading amphures for province:', provinceId);
        const apiUrl = `/api/provinces/${provinceId}/amphures`;
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        let amphures = null;
        if (Array.isArray(data)) {
          amphures = data;
        } else if (data.success && data.data && Array.isArray(data.data)) {
          amphures = data.data;
        }
        
        if (amphures && amphures.length > 0) {
          const items = amphures
            .filter(item => item && (item.amphure_id || item.id))
            .map(item => {
              const amphureId = item.amphure_id || item.id;
              const actualProvinceId = item.province_id || provinceId;
              const name = item.name_th || item.name;
              
              return {
                id: amphureId,
                name: name,
                province_id: actualProvinceId,
                amphure_id: amphureId,
                displayText: name,
                subText: `‡∏£‡∏´‡∏±‡∏™: ${amphureId}`
              };
            });
          
          if (districtDropdownRef) {
            districtDropdownRef.setItems(items);
            
            // Setup district search
            distInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                districtDropdownRef.setItems(items);
                districtDropdownRef.open();
                return;
              }
              
              const filtered = items.filter(item => 
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
              
              districtDropdownRef.setItems(filtered);
              districtDropdownRef.open();
            }, 300));
          }
          
          console.log('‚úÖ Amphures loaded for province:', provinceId, '- Count:', items.length);
        }
      } catch (error) {
        console.error('‚ùå Failed to load amphures:', error);
        
        const distInput = document.getElementById('district');
        const distDD = document.getElementById('districtDropdown');
        
        if (distInput) distInput.value = '';
        if (distDD) {
          distDD.innerHTML = '<div class="dropdown-no-results">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</div>';
          distDD.classList.remove('hidden');
        }
      }
    }

    async function loadTambons(provinceId, amphureId, tambonDropdownRef) {
      try {
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
        
        if (!subInput || !subDD) return;

        if (!provinceId || isNaN(provinceId) || !amphureId || isNaN(amphureId)) {
          console.error('‚ùå Invalid provinceId or amphureId:', {provinceId, amphureId});
          if (subInput) subInput.value = '';
          if (subDD) {
            subDD.innerHTML = '<div class="dropdown-no-results">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
            subDD.classList.remove('hidden');
          }
          return;
        }

        console.log('üîç Loading tambons for province:', provinceId, 'amphure:', amphureId);
        const apiUrl = `/api/provinces/${provinceId}/amphures/${amphureId}/tambons`;
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        let tambons = null;
        if (Array.isArray(data)) {
          tambons = data;
        } else if (data.success && data.data && Array.isArray(data.data)) {
          tambons = data.data;
        }
        
        if (tambons && tambons.length > 0) {
          const items = tambons
            .filter(item => item && (item.tambon_id || item.id))
            .map(item => {
              const tambonId = item.tambon_id || item.id;
              const name = item.name_th || item.name;
              const zipcode = item.zip_code || item.zipcode || item.postal_code;
              return {
                id: tambonId,
                name: name,
                province_id: item.province_id,
                amphure_id: item.amphure_id,
                tambon_id: tambonId,
                zip_code: zipcode,
                zipcode: zipcode,
                postal_code: zipcode,
                displayText: name,
                subText: zipcode ? `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${zipcode}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå'
              };
            });
          
          if (tambonDropdownRef) {
            tambonDropdownRef.setItems(items);
            
            // Setup tambon search
            subInput.addEventListener('input', debounce(async (e) => {
              const query = e.target.value.trim();
              if (query.length < 1) {
                tambonDropdownRef.setItems(items);
                tambonDropdownRef.open();
                return;
              }
              
              const filtered = items.filter(item => 
                item.name && item.name.toLowerCase().includes(query.toLowerCase())
              );
              
              tambonDropdownRef.setItems(filtered);
              tambonDropdownRef.open();
            }, 300));
          }
          
          console.log('‚úÖ Tambons loaded for amphure:', amphureId, '- Count:', items.length);
        }
      } catch (error) {
        console.error('‚ùå Failed to load tambons:', error);
        
        const subInput = document.getElementById('subDistrict');
        const subDD = document.getElementById('subDistrictDropdown');
        
        if (subInput) subInput.value = '';
        if (subDD) {
          subDD.innerHTML = '<div class="dropdown-no-results">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•</div>';
          subDD.classList.remove('hidden');
        }
      }
    }

    // Utility function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // =================== END ENHANCED LOCATION AUTOCOMPLETE ===================
    
    // Additional helper functions
    function validateField(fieldId) {
      const field = document.getElementById(fieldId);
      const value = field.value.trim();
      
      if (!value) {
        field.classList.add('validation-error');
        return false;
      } else {
        field.classList.remove('validation-error');
        return true;
      }
    }
    
    function autoSaveFormData() {
      const formData = {
        customerFirstName: document.getElementById('customerFirstName').value,
        customerLastName: document.getElementById('customerLastName').value,
        customerPhone: document.getElementById('customerPhone').value,
        customerIdCard: getCleanIdCard('customerIdCard'),
        customerEmail: document.getElementById('customerEmail')?.value || '',
        customerBirthDate: document.getElementById('customerBirthDate')?.value || '',
        customerAge: document.getElementById('customerAge')?.value || '',
        customerOccupation: document.getElementById('customerOccupation')?.value || '',
        customerIncome: document.getElementById('customerIncome')?.value || '',
        customerWorkplace: document.getElementById('customerWorkplace')?.value || '',
        houseNo: document.getElementById('houseNo')?.value || '',
        province: document.getElementById('province')?.value || '',
        district: document.getElementById('district')?.value || '',
        subDistrict: document.getElementById('subDistrict')?.value || '',
        postalCode: document.getElementById('postalCode')?.value || '',
        authMethod: document.querySelector('input[name="customerAuthMethod"]:checked')?.value || 'signature',
        autoSavedAt: new Date().toISOString()
      };
      
      localStorage.setItem('customerFormData', JSON.stringify(formData));
      console.log('Form data auto-saved');
    }
    
    function loadSavedFormData() {
      const savedData = localStorage.getItem('customerFormData');
      if (savedData) {
        try {
          const formData = JSON.parse(savedData);
          
          Object.entries(formData).forEach(([key, value]) => {
            const field = document.getElementById(key);
            if (field && value) {
              field.value = value;
            }
          });
          
          // Handle auth method radio
          if (formData.authMethod) {
            const authRadio = document.querySelector(`input[name="customerAuthMethod"][value="${formData.authMethod}"]`);
            if (authRadio) {
              authRadio.checked = true;
            }
          }
          
          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ', 'info');
        } catch (error) {
          console.error('Error loading saved form data:', error);
        }
      }
    }
    

    
    // Step Progress and Navigation Functions
    function updateStepProgress(stepData) {
      // Update stepper progress
      const steppers = document.querySelectorAll('.stepper-item');
      steppers.forEach((stepper, index) => {
        const stepNumber = index + 1;
        const stepKey = `step${stepNumber}`;
        
        if (stepData[stepKey] && stepData[stepKey].completed) {
          stepper.classList.add('completed');
        } else {
          stepper.classList.remove('completed');
        }
        
        if (stepNumber === 2) {
          stepper.classList.add('active');
        } else {
          stepper.classList.remove('active');
        }
      });
      
      // Update progress bar
      const progressBar = document.querySelector('.progress-bar');
      if (progressBar) {
        const percentage = globalDataManager.getProgressPercentage();
        progressBar.style.width = percentage + '%';
      }
    }
    
    function updateNavigationButtons(stepData) {
      const nextBtn = document.getElementById('btnStep2Next');
      const prevBtn = document.getElementById('btnStep2Previous');
      
      if (nextBtn) {
        const canProceed = globalDataManager.validateStepRequirements(2);
        nextBtn.disabled = !canProceed;
        nextBtn.classList.toggle('btn-disabled', !canProceed);
        
        // Update button text based on validation
        const errors = globalDataManager.getStepValidationErrors(2);
        if (errors.length > 0) {
          nextBtn.title = errors[0];
        } else {
          nextBtn.title = '‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
        }
      }
      
      if (prevBtn) {
        const canGoBack = globalDataManager.isStepCompleted(1);
        prevBtn.disabled = !canGoBack;
        prevBtn.classList.toggle('btn-disabled', !canGoBack);
      }
    }
    
    function validateStepRequirements() {
      const errors = globalDataManager.getStepValidationErrors(2);
      if (errors.length > 0) {
        showToast(errors[0], 'warning');
        return false;
      }
      return true;
    }

    // Load salesperson name (Fixed display issue)
    function loadSalespersonName() {
      const salespersonNameElement = document.getElementById('salespersonName');
      if (salespersonNameElement && salespersonNameElement instanceof HTMLElement) {
        // Try to get employee name from various sources
        let employeeName = window.employeeName || 
                          localStorage.getItem('userName') || 
                          localStorage.getItem('employeeName') || 
                          sessionStorage.getItem('employeeName') || 
                          '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        
        // Ensure employeeName is a string, not an object
        if (typeof employeeName === 'object' && employeeName !== null) {
          if (employeeName.textContent) {
            employeeName = employeeName.textContent;
          } else if (employeeName.toString) {
            employeeName = employeeName.toString();
          } else {
            employeeName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
          }
        }
        
        // Clean the string
        employeeName = String(employeeName).trim();
        if (!employeeName || employeeName === '[object HTMLSpanElement]' || employeeName === '[object Object]') {
          employeeName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        }
        
        console.log('üè∑Ô∏è Setting salesperson name:', employeeName);
        salespersonNameElement.textContent = employeeName;
      }
    }

    // Customer Search Functions
    function searchCustomerByIdCard(idCard) {
      if (!idCard || idCard.length < 13) return;
      
      const spinner = document.getElementById('searchIdCardSpinner');
      spinner?.classList.remove('hidden');
      
      // Mock API call - replace with actual API
      setTimeout(() => {
        const mockCustomer = {
          id: 1,
          idCard: idCard,
          prefix: '‡∏ô‡∏≤‡∏¢',
          firstName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
          lastName: '‡πÉ‡∏à‡∏î‡∏µ',
          phone: '0987654321',
          email: 'somchai@email.com',
          birthDate: '1990-01-01',
          age: 33,
          occupation: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó',
          income: 25000,
          workplace: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
          address: {
            houseNo: '123',
            moo: '5',
            soi: '',
            road: '‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó',
            province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
            district: '‡∏ß‡∏±‡∏í‡∏ô‡∏≤',
            subDistrict: '‡∏•‡∏∏‡∏°‡∏û‡∏¥‡∏ô‡∏µ',
            postalCode: '10330'
          }
        };
        
        if (idCard === '1234567890123') {
          showCustomerSearchResults(mockCustomer);
        } else {
          showCustomerSearchNotFound();
        }
        
        spinner?.classList.add('hidden');
      }, 1000);
    }

    function searchCustomerByPhone(phone) {
      if (!phone || phone.length < 10) return;
      
      const spinner = document.getElementById('searchPhoneSpinner');
      spinner?.classList.remove('hidden');
      
      // Mock API call - replace with actual API
      setTimeout(() => {
        const mockCustomer = {
          id: 2,
          idCard: '9876543210987',
          prefix: '‡∏ô‡∏≤‡∏á',
          firstName: '‡∏™‡∏∏‡∏î‡∏≤',
          lastName: '‡πÉ‡∏à‡∏á‡∏≤‡∏°',
          phone: phone,
          email: 'suda@email.com',
          birthDate: '1985-05-15',
          age: 38,
          occupation: '‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£',
          income: 35000,
          workplace: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà',
          address: {
            houseNo: '456',
            moo: '2',
            soi: '‡∏™‡∏∏‡∏Ç‡πÉ‡∏à',
            road: '‡∏ñ‡∏ô‡∏ô‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô',
            province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
            district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
            subDistrict: '‡∏™‡∏∞‡∏ö‡∏≤‡∏£‡∏±‡∏á',
            postalCode: '94000'
          }
        };
        
        if (phone === '0987654321') {
          showCustomerSearchResults(mockCustomer);
        } else {
          showCustomerSearchNotFound();
        }
        
        spinner?.classList.add('hidden');
      }, 1000);
    }

    function showCustomerSearchResults(customer) {
      const resultsDiv = document.getElementById('customerSearchResults');
      const contentDiv = document.getElementById('customerSearchResultsContent');
      const notFoundDiv = document.getElementById('customerSearchNotFound');
      
      notFoundDiv?.classList.add('hidden');
      resultsDiv?.classList.remove('hidden');
      
      const address = `${customer.address.houseNo} ${customer.address.moo ? '‡∏´‡∏°‡∏π‡πà ' + customer.address.moo : ''} ${customer.address.soi ? '‡∏ã‡∏≠‡∏¢ ' + customer.address.soi : ''} ${customer.address.road ? customer.address.road : ''} ${customer.address.subDistrict} ${customer.address.district} ${customer.address.province} ${customer.address.postalCode}`.trim();
      
      if (contentDiv) {
        contentDiv.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${customer.prefix} ${customer.firstName} ${customer.lastName}</p>
              <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${customer.idCard}</p>
              <p><strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${customer.phone}</p>
              <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${customer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
            </div>
            <div>
              <p><strong>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:</strong> ${customer.occupation}</p>
              <p><strong>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ:</strong> ${customer.income ? customer.income.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</strong> ${customer.workplace || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${customer.age} ‡∏õ‡∏µ</p>
            </div>
            <div class="md:col-span-2">
              <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${address}</p>
            </div>
          </div>
        `;
      }
      
      window.foundCustomer = customer;
    }

    function showCustomerSearchNotFound() {
      const resultsDiv = document.getElementById('customerSearchResults');
      const notFoundDiv = document.getElementById('customerSearchNotFound');
      
      resultsDiv?.classList.add('hidden');
      notFoundDiv?.classList.remove('hidden');
    }

    // Contact Address Functions
    function toggleContactAddress() {
      const checkbox = document.getElementById('sameAsMainAddress');
      const contactForm = document.getElementById('contactAddressForm');
      
      if (checkbox?.checked) {
        copyMainAddressToContact();
        if (contactForm) {
          contactForm.style.opacity = '0.5';
          contactForm.style.pointerEvents = 'none';
        }
      } else {
        if (contactForm) {
          contactForm.style.opacity = '1';
          contactForm.style.pointerEvents = 'auto';
        }
      }
    }

    function copyMainAddressToContact() {
      const mappings = [
        ['customerHouseNo', 'contactHouseNo'],
        ['customerMoo', 'contactMoo'],
        ['customerSoi', 'contactSoi'],
        ['customerRoad', 'contactRoad'],
        ['customerProvince', 'contactProvince'],
        ['customerDistrict', 'contactDistrict'],
        ['customerSubDistrict', 'contactSubDistrict'],
        ['customerPostalCode', 'contactPostalCode']
      ];
      
      mappings.forEach(([mainField, contactField]) => {
        const mainElement = document.getElementById(mainField);
        const contactElement = document.getElementById(contactField);
        
        if (mainElement && contactElement) {
          contactElement.value = mainElement.value;
        }
      });
    }

    // Auto-fill postal code function
    async function updatePostalCode() {
      const province = document.getElementById('province')?.value;
      const district = document.getElementById('district')?.value;
      const subdistrict = document.getElementById('subDistrict')?.value;
      
      if (province && district && subdistrict) {
        try {
          const response = await fetch(`/api/address/postal-code?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}&subdistrict=${encodeURIComponent(subdistrict)}`);
          
          if (response.ok) {
            const data = await response.json();
            
            if (data.success && data.postalCode) {
              const postalCodeField = document.getElementById('postalCode');
              if (postalCodeField) {
                postalCodeField.value = data.postalCode;
              }
            }
          }
        } catch (error) {
          console.error('Error loading postal code:', error);
        }
      }
    }

    // Setup address change handlers
    function setupAddressHandlers() {
      // Auto-fill postal code when subdistrict is selected
      const subdistrictSelect = document.getElementById('subDistrict');
      if (subdistrictSelect) {
        subdistrictSelect.addEventListener('change', updatePostalCode);
      }
      
      // Also setup for contact address
      const contactSubdistrictSelect = document.getElementById('contactSubDistrict');
      if (contactSubdistrictSelect) {
        contactSubdistrictSelect.addEventListener('change', async function() {
          const province = document.getElementById('contactProvince')?.value;
          const district = document.getElementById('contactDistrict')?.value;
          const subdistrict = this.value;
          
          if (province && district && subdistrict) {
            try {
              const response = await fetch(`/api/address/postal-code?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}&subdistrict=${encodeURIComponent(subdistrict)}`);
              
              if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.postalCode) {
                  const postalCodeField = document.getElementById('contactPostalCode');
                  if (postalCodeField) {
                    postalCodeField.value = data.postalCode;
                  }
                }
              }
            } catch (error) {
              console.error('Error loading postal code:', error);
            }
          }
        });
      }
    }

    // Email Automation Functions
    function updateEmailDocumentSelection() {
      const checkboxes = document.querySelectorAll('input[name="emailDocuments"]:checked');
      const summaryDiv = document.getElementById('emailDocumentSummary');
      const previewDiv = document.getElementById('emailPreviewSection');
      const listDiv = document.getElementById('selectedDocumentsList');
      const statusSpan = document.getElementById('emailSettingsStatus');
      const emailInput = document.getElementById('customerEmail');
      
      if (checkboxes.length > 0) {
        summaryDiv?.classList.remove('hidden');
        
        const documentNames = {
          'quotation': '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
          'invoice': '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
          'receipt': '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à & ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ'
        };
        
        if (listDiv) {
          listDiv.innerHTML = '';
          checkboxes.forEach(checkbox => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 text-blue-600 dark:text-blue-400';
            div.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${documentNames[checkbox.value]}`;
            listDiv.appendChild(div);
          });
        }
        
        if (statusSpan) {
          statusSpan.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${checkboxes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
          statusSpan.className = 'text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-800 text-green-600 dark:text-green-300';
        }
        
        if (emailInput?.value) {
          previewDiv?.classList.remove('hidden');
          const emailPreviewTo = document.getElementById('emailPreviewTo');
          const emailPreviewAttachments = document.getElementById('emailPreviewAttachments');
          
          if (emailPreviewTo) emailPreviewTo.textContent = emailInput.value;
          if (emailPreviewAttachments) {
            emailPreviewAttachments.textContent = Array.from(checkboxes).map(cb => documentNames[cb.value]).join(', ');
          }
        } else {
          previewDiv?.classList.add('hidden');
        }
      } else {
        summaryDiv?.classList.add('hidden');
        previewDiv?.classList.add('hidden');
        if (statusSpan) {
          statusSpan.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
          statusSpan.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300';
        }
      }
    }

    function testEmailSettings() {
      const emailInput = document.getElementById('customerEmail');
      const selectedDocs = document.querySelectorAll('input[name="emailDocuments"]:checked');
      
      if (!emailInput?.value) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
      }
      
      if (selectedDocs.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
      }
      
      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•...', 'info');
      
      setTimeout(() => {
        showToast('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      }, 2000);
    }


    
    // ======================= FORM VALIDATION FUNCTIONS =======================
    
    // Format ID Card number (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ)
    function formatIdCard(input) {
      // ‡πÄ‡∏Å‡πá‡∏ö cursor position ‡πÑ‡∏ß‡πâ
      const cursorPosition = input.selectionStart;
      
      // ‡∏•‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å
      let value = input.value.replace(/\D/g, '');
      
      // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å
      if (value.length > 13) {
        value = value.substring(0, 13);
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ clear ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      if (value.length === 0) {
        input.value = '';
        return;
      }
      
      // Format ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 0-0000-00000-00-0
      let formatted = '';
      if (value.length >= 1) {
        formatted = value.substring(0, 1);
      }
      if (value.length >= 2) {
        formatted += '-' + value.substring(1, 5);
      }
      if (value.length >= 6) {
        formatted += '-' + value.substring(5, 10);
      }
      if (value.length >= 11) {
        formatted += '-' + value.substring(10, 12);
      }
      if (value.length >= 13) {
        formatted += '-' + value.substring(12, 13);
      }
      
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ value ‡πÉ‡∏´‡∏°‡πà
      input.value = formatted;
      
      // ‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á cursor ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
      let newCursorPosition = cursorPosition;
      if (formatted.length > cursorPosition) {
        input.setSelectionRange(newCursorPosition, newCursorPosition);
      } else {
        input.setSelectionRange(formatted.length, formatted.length);
      }
    }
    
    // Validate ID Card number (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö formatted input)
    function validateIdCard(idCard) {
      // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ dash ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å
      const cleanId = idCard.replace(/\D/g, '');
      const errorElement = document.querySelector('#customerIdCard').parentNode.parentNode.querySelector('.form-error');
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error (‡∏¢‡∏±‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå)
      if (cleanId.length === 0) {
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
        return false;
      }
      
      if (cleanId.length < 13) {
        if (errorElement) {
          errorElement.textContent = `‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 13 ‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ${cleanId.length} ‡∏´‡∏•‡∏±‡∏Å)`;
          errorElement.classList.remove('hidden');
        }
        return false;
      }
      
      if (cleanId.length > 13) {
        if (errorElement) {
          errorElement.textContent = '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 13 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
          errorElement.classList.remove('hidden');
        }
        return false;
      }
      
      // Thai ID card checksum validation (Algorithm ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(cleanId.charAt(i)) * (13 - i);
      }
      
      let remainder = sum % 11;
      let checkDigit = (11 - remainder) % 10;
      
      if (checkDigit !== parseInt(cleanId.charAt(12))) {
        if (errorElement) {
          errorElement.textContent = '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏¥‡∏î)';
          errorElement.classList.remove('hidden');
        }
        return false;
      }
      
      // ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      if (errorElement) {
        errorElement.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle"></i> ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
        errorElement.classList.remove('hidden');
      }
      return true;
    }
    
    // Validate Facebook URL
    function validateFacebookUrl(input) {
      const value = input.value.trim();
      const errorElement = input.parentNode.parentNode.querySelector('.form-error');
      
      if (!value) {
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
        return true;
      }
      
      const fbRegex = /^(https?:\/\/)?(www\.)?(facebook|fb)\.com\/.+/i;
      if (!fbRegex.test(value)) {
        if (errorElement) {
          errorElement.textContent = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL Facebook ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          errorElement.classList.remove('hidden');
        }
        return false;
      }
      
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.add('hidden');
      }
      return true;
    }
    
    // Validate Line ID
    function validateLineId(input) {
      const value = input.value.trim();
      const errorElement = input.parentNode.parentNode.querySelector('.form-error');
      
      if (!value) {
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
        return true;
      }
      
      // Line ID should be alphanumeric, underscore, dot, hyphen
      const lineRegex = /^[a-zA-Z0-9._-]+$/;
      if (!lineRegex.test(value)) {
        if (errorElement) {
          errorElement.textContent = 'Line ID ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç _ . - ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
          errorElement.classList.remove('hidden');
        }
        return false;
      }
      
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.add('hidden');
      }
      return true;
    }
    
    // ======================= MAP COORDINATES FUNCTIONS =======================
    
    // Validate coordinates
    function validateCoordinates() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      const displayDiv = document.getElementById('coordinatesDisplay');
      const displayLat = document.getElementById('displayLatitude');
      const displayLng = document.getElementById('displayLongitude');
      
      if (!latInput || !lngInput) return false;
      
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      
      const isValidLat = !isNaN(lat) && lat >= -90 && lat <= 90;
      const isValidLng = !isNaN(lng) && lng >= -180 && lng <= 180;
      
      if (isValidLat && isValidLng) {
        if (displayLat) displayLat.textContent = lat.toFixed(7);
        if (displayLng) displayLng.textContent = lng.toFixed(7);
        if (displayDiv) displayDiv.classList.remove('hidden');
        
        // Enable map buttons
        const openMapsBtn = document.getElementById('btnOpenInGoogleMaps');
        const shareBtn = document.getElementById('btnShareLocation');
        if (openMapsBtn) openMapsBtn.disabled = false;
        if (shareBtn) shareBtn.disabled = false;
        
        return true;
      } else {
        if (displayDiv) displayDiv.classList.add('hidden');
        
        // Disable map buttons
        const openMapsBtn = document.getElementById('btnOpenInGoogleMaps');
        const shareBtn = document.getElementById('btnShareLocation');
        if (openMapsBtn) openMapsBtn.disabled = true;
        if (shareBtn) shareBtn.disabled = true;
        
        return false;
      }
    }
    
    // Update map preview
    function updateMapPreview() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      const mapPreview = document.getElementById('mapPreview');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
      
      if (!latInput || !lngInput || !mapPreview || !mapPlaceholder) return;
      
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      
      if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
        // Use Google Maps Embed API with API key
        const apiKey = 'AIzaSyBA0Qs-rHslLghMCAmbLplx_zMNjeY7TZE';
        const embedUrl = `https://maps.google.com/maps?q=${lat},${lng}&hl=th&z=15&output=embed`;
        
        mapPreview.src = embedUrl;
        mapPreview.classList.remove('hidden');
        mapPlaceholder.classList.add('hidden');
      } else {
        mapPreview.classList.add('hidden');
        mapPlaceholder.classList.remove('hidden');
      }
    }
    
    // Extract coordinates from Google Maps URL
    function extractCoordinatesFromUrl(url) {
      if (!url) return;
      
      let lat, lng;
      
      // Try different Google Maps URL formats
      const patterns = [
        /@(-?\d+\.?\d*),(-?\d+\.?\d*)/,  // @lat,lng format
        /q=(-?\d+\.?\d*),(-?\d+\.?\d*)/,  // q=lat,lng format
        /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/, // 3d4d format
        /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/   // ll=lat,lng format
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          lat = parseFloat(match[1]);
          lng = parseFloat(match[2]);
          break;
        }
      }
      
      if (lat && lng) {
        const latInput = document.getElementById('customerLatitude');
        const lngInput = document.getElementById('customerLongitude');
        
        if (latInput) latInput.value = lat;
        if (lngInput) lngInput.value = lng;
        
        validateCoordinates();
        updateMapPreview();
        showToast('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
      }
    }
    
    // Paste map URL from clipboard
    async function pasteMapUrl() {
      try {
        const text = await navigator.clipboard.readText();
        const mapUrlInput = document.getElementById('customerMapUrl');
        if (mapUrlInput) {
          mapUrlInput.value = text;
          extractCoordinatesFromUrl(text);
        }
      } catch (err) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å clipboard ‡πÑ‡∏î‡πâ', 'error');
      }
    }
    
    // Get current location
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS', 'error');
        return;
      }
      
      const loader = LoadingSystem.show({ message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...' });
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          LoadingSystem.hide(loader);
          
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          const latInput = document.getElementById('customerLatitude');
          const lngInput = document.getElementById('customerLongitude');
          
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          validateCoordinates();
          updateMapPreview();
          
          showToast('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        },
        (error) => {
          LoadingSystem.hide(loader);
          
          let message = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              message = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
              break;
            case error.POSITION_UNAVAILABLE:
              message = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
              break;
            case error.TIMEOUT:
              message = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
              break;
          }
          
          showToast(message, 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        }
      );
    }
    
    // Clear coordinates
    function clearCoordinates() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      const mapUrlInput = document.getElementById('customerMapUrl');
      const displayDiv = document.getElementById('coordinatesDisplay');
      const mapPreview = document.getElementById('mapPreview');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
      
      if (latInput) latInput.value = '';
      if (lngInput) lngInput.value = '';
      if (mapUrlInput) mapUrlInput.value = '';
      
      if (displayDiv) displayDiv.classList.add('hidden');
      if (mapPreview) mapPreview.classList.add('hidden');
      if (mapPlaceholder) mapPlaceholder.classList.remove('hidden');
      
      const openMapsBtn = document.getElementById('btnOpenInGoogleMaps');
      const shareBtn = document.getElementById('btnShareLocation');
      if (openMapsBtn) openMapsBtn.disabled = true;
      if (shareBtn) shareBtn.disabled = true;
    }
    
    // Copy coordinates to clipboard
    async function copyCoordinates() {
      const displayLat = document.getElementById('displayLatitude');
      const displayLng = document.getElementById('displayLongitude');
      
      if (displayLat && displayLng) {
        const lat = displayLat.textContent;
        const lng = displayLng.textContent;
        
        if (lat !== '-' && lng !== '-') {
          try {
            await navigator.clipboard.writeText(`${lat}, ${lng}`);
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
          } catch (err) {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ', 'error');
          }
        }
      }
    }
    
    // Refresh map preview
    function refreshMapPreview() {
      updateMapPreview();
      showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }
    
    // Open in Google Maps
    function openInGoogleMaps() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      
      if (latInput && lngInput) {
        const lat = latInput.value;
        const lng = lngInput.value;
        
        if (lat && lng) {
          const url = `https://www.google.com/maps?q=${lat},${lng}`;
          window.open(url, '_blank');
        }
      }
    }
    
    // Open fullscreen map
    function openFullscreenMap() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      
      if (latInput && lngInput) {
        const lat = latInput.value;
        const lng = lngInput.value;
        
        if (lat && lng) {
          const url = `https://www.google.com/maps?q=${lat},${lng}&z=15`;
          window.open(url, '_blank', 'width=800,height=600');
        } else {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        }
      }
    }
    
    // Share location
    async function shareLocation() {
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      
      if (latInput && lngInput) {
        const lat = latInput.value;
        const lng = lngInput.value;
        
        if (lat && lng) {
          const url = `https://www.google.com/maps?q=${lat},${lng}`;
          
          if (navigator.share) {
            try {
              await navigator.share({
                title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà',
                text: `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`,
                url: url
              });
            } catch (err) {
              console.log('‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
            }
          } else {
            try {
              await navigator.clipboard.writeText(url);
              showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (err) {
              showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
            }
          }
        }
      }
    }
    

    
    // Get branch code
    function getBranchCode() {
      // Try to get from URL parameters first
      const urlParams = new URLSearchParams(window.location.search);
      let branchCode = urlParams.get('branch');
      
      // If not in URL, try localStorage
      if (!branchCode || branchCode === '00000' || branchCode === 'undefined' || branchCode === 'null') {
        branchCode = localStorage.getItem('activeBranch');
      }
      
      // If still not found, try global window variable
      if (!branchCode || branchCode === '00000' || branchCode === 'undefined' || branchCode === 'null') {
        branchCode = window.BRANCH_CODE;
      }
      
      // Default to head office if no valid branch found
      if (!branchCode || branchCode === 'undefined' || branchCode === 'null') {
        branchCode = '00000'; // Head office
      }
      
      return branchCode;
    }
    
    // Create signature modal dynamically
    function createSignatureModal() {
      const modal = document.createElement('div');
      modal.id = 'signatureModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4">
          <h3 id="signatureModalTitle" class="text-lg font-semibold mb-4">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</h3>
          <div class="space-y-4">
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-2">
              <canvas id="signatureModalCanvas" class="w-full border-0 cursor-crosshair" 
                      style="height: 200px; touch-action: none;"></canvas>
            </div>
            <div class="flex gap-3">
              <button id="clearSignatureBtn" class="btn btn-ghost flex-1">
                <i class="bi bi-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á
              </button>
              <button id="saveSignatureBtn" class="btn btn-primary flex-1">
                <i class="bi bi-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </button>
              <button id="closeSignatureBtn" class="btn btn-ghost">
                <i class="bi bi-x"></i> ‡∏õ‡∏¥‡∏î
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize signature pad
      initializeSignaturePad();
      
      console.log('‚úÖ Signature modal created successfully');
    }
    
    // Initialize signature pad functionality
    function initializeSignaturePad() {
      const canvas = document.getElementById('signatureModalCanvas');
      const clearBtn = document.getElementById('clearSignatureBtn');
      const saveBtn = document.getElementById('saveSignatureBtn');
      const closeBtn = document.getElementById('closeSignatureBtn');
      
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      
      // Set canvas properties
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events for mobile
      canvas.addEventListener('touchstart', handleTouchStart);
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', stopDrawing);
      
      function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      }
      
      function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        lastX = currentX;
        lastY = currentY;
      }
      
      function stopDrawing() {
        isDrawing = false;
      }
      
      function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
        isDrawing = true;
      }
      
      function handleTouchMove(e) {
        e.preventDefault();
        if (!isDrawing) return;
        
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const currentX = touch.clientX - rect.left;
        const currentY = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        lastX = currentX;
        lastY = currentY;
      }
      
      // Clear button
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
      }
      
      // Save button
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          saveSignature();
        });
      }
      
      // Close button
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          document.getElementById('signatureModal').classList.add('hidden');
        });
      }
    }
    
    // Save signature
    function saveSignature() {
      const canvas = document.getElementById('signatureModalCanvas');
      const modal = document.getElementById('signatureModal');
      
      if (!canvas) return;
      
      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        if (blob) {
          const file = new File([blob], `signature-${Date.now()}.png`, { type: 'image/png' });
          
          // Hide modal
          modal.classList.add('hidden');
          
          // Upload signature
          if (validateFile(file, 'signature')) {
            await uploadDocument(file, 'signature', 'signature');
          }
        }
      }, 'image/png');
    }
    
    // Enhanced goToStep3 with validation
    async function goToStep3() {
      // Basic validation
      const requiredFields = [
        { id: 'customerFirstName', name: '‡∏ä‡∏∑‡πà‡∏≠' },
        { id: 'customerLastName', name: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' },
        { id: 'customerIdCard', name: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' },
        { id: 'customerPhone', name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' },
        { id: 'customerBirthDate', name: '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î' },
        { id: 'customerAge', name: '‡∏≠‡∏≤‡∏¢‡∏∏' },
        { id: 'customerOccupation', name: '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û' },
        { id: 'customerIncome', name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' }
      ];
      
      let isValid = true;
      let firstInvalidField = null;
      
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && !element.value.trim()) {
          isValid = false;
          if (!firstInvalidField) {
            firstInvalidField = { id: field.id, name: field.name };
          }
          element.classList.add('border-red-500');
        } else if (element) {
          element.classList.remove('border-red-500');
        }
      });
      
      // Validate ID Card
      const idCardInput = document.getElementById('customerIdCard');
      if (idCardInput && idCardInput.value && !validateIdCard(idCardInput.value)) {
        isValid = false;
        if (!firstInvalidField) {
          firstInvalidField = { id: 'customerIdCard', name: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' };
        }
      }
      
      if (!isValid && firstInvalidField) {
        showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å${firstInvalidField.name}‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`, 'warning');
        document.getElementById(firstInvalidField.id).focus();
        return;
      }
      
      const loader = LoadingSystem.show({ message: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' });
      
      try {
        // Collect form data
        const formData = {
          // Personal Information
          firstName: document.getElementById('customerFirstName')?.value || '',
          lastName: document.getElementById('customerLastName')?.value || '',
          idCard: getCleanIdCard('customerIdCard'),
          phone: document.getElementById('customerPhone')?.value || '',
          email: document.getElementById('customerEmail')?.value || '',
          facebook: document.getElementById('customerFacebook')?.value || '',
          lineId: document.getElementById('customerLineId')?.value || '',
          birthDate: document.getElementById('customerBirthDate')?.value || '',
          age: document.getElementById('customerAge')?.value || '',
          
          // Occupation and Income
          occupation: document.getElementById('customerOccupation')?.value || '',
          income: document.getElementById('customerIncome')?.value || '',
          workplace: document.getElementById('customerWorkplace')?.value || '',
          
          // Address
          houseNo: document.getElementById('houseNo')?.value || '',
          moo: document.getElementById('moo')?.value || '',
          soi: document.getElementById('soi')?.value || '',
          road: document.getElementById('road')?.value || '',
          province: document.getElementById('province')?.value || '',
          district: document.getElementById('district')?.value || '',
          subDistrict: document.getElementById('subDistrict')?.value || '',
          postalCode: document.getElementById('zipcode')?.value || '',
          
          // Coordinates
          latitude: document.getElementById('customerLatitude')?.value || '',
          longitude: document.getElementById('customerLongitude')?.value || '',
          mapUrl: document.getElementById('customerMapUrl')?.value || '',
          
          // Meta data
          timestamp: new Date().toISOString(),
          branchCode: getBranchCode()
        };
        
        // Save to Global Data Manager
        globalDataManager.updateStepData(2, {
          customerData: formData,
          completed: true
        });
        
        // Save to localStorage as backup
        localStorage.setItem('step2Data', JSON.stringify(formData));
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        
        // Navigate to step 3
        setTimeout(() => {
          window.location.href = './step3/step3.html';
        }, 1000);
        
      } catch (error) {
        console.error('Save data error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      } finally {
        LoadingSystem.hide(loader);
      }
    }
    
    // ======================= DOCUMENT UPLOAD FUNCTIONS =======================
    
    // Initialize document upload event listeners
    function initializeDocumentUpload() {
      // ID Card upload
      const btnUploadIdCard = document.getElementById('btnUploadIdCard');
      const uploadIdCard = document.getElementById('uploadIdCard');
      const btnTakeIdCard = document.getElementById('btnTakeIdCard');
      
      if (btnUploadIdCard) {
        btnUploadIdCard.addEventListener('click', () => {
          uploadIdCard.click();
        });
      }
      
      if (uploadIdCard) {
        uploadIdCard.addEventListener('change', handleIdCardUpload);
      }
      
      if (btnTakeIdCard) {
        btnTakeIdCard.addEventListener('click', () => {
          openCamera('idCard');
        });
      }
      
      // Selfie upload
      const btnUploadSelfie = document.getElementById('btnUploadSelfie');
      const uploadSelfie = document.getElementById('uploadSelfie');
      const btnTakeSelfie = document.getElementById('btnTakeSelfie');
      
      if (btnUploadSelfie) {
        btnUploadSelfie.addEventListener('click', () => {
          uploadSelfie.click();
        });
      }
      
      if (uploadSelfie) {
        uploadSelfie.addEventListener('change', handleSelfieUpload);
      }
      
      if (btnTakeSelfie) {
        btnTakeSelfie.addEventListener('click', () => {
          openCamera('selfie');
        });
      }
      
      // Salary Slip upload
      const btnUploadSalarySlip = document.getElementById('btnUploadSalarySlip');
      const uploadSalarySlip = document.getElementById('uploadSalarySlip');
      const btnTakeSalarySlip = document.getElementById('btnTakeSalarySlip');
      
      if (btnUploadSalarySlip) {
        btnUploadSalarySlip.addEventListener('click', () => {
          uploadSalarySlip.click();
        });
      }
      
      if (uploadSalarySlip) {
        uploadSalarySlip.addEventListener('change', handleSalarySlipUpload);
      }
      
      if (btnTakeSalarySlip) {
        btnTakeSalarySlip.addEventListener('click', () => {
          openCamera('salarySlip');
        });
      }
    }
    
    // Handle ID Card upload
    async function handleIdCardUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!validateFile(file, 'idCard')) return;
      
      await uploadDocument(file, 'idCard', 'id-card');
    }
    
    // Handle Selfie upload
    async function handleSelfieUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!validateFile(file, 'selfie')) return;
      
      await uploadDocument(file, 'selfie', 'selfie');
    }
    
    // Handle Salary Slip upload
    async function handleSalarySlipUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!validateFile(file, 'salarySlip')) return;
      
      await uploadDocument(file, 'salarySlip', 'salary-slip');
    }
    
    // Validate file before upload
    function validateFile(file, type) {
      // Check file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (JPG, PNG, WebP)', 'error');
        return false;
      }
      
      // Check file size (5MB limit)
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB', 'error');
        return false;
      }
      
      // Show preview immediately
      showImagePreview(file, type);
      
      return true;
    }
    
    // Show image preview
    function showImagePreview(file, type) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewDiv = document.getElementById(`${type}Preview`);
        const previewImage = document.getElementById(`${type}Image`);
        
        if (previewDiv && previewImage) {
          previewImage.src = e.target.result;
          previewDiv.classList.remove('hidden');
          
          // Update status to processing
          updateDocumentStatus(type, 'processing');
        }
      };
      reader.readAsDataURL(file);
    }
    
    // Upload document to server
    async function uploadDocument(file, type, apiEndpoint) {
      const loader = LoadingSystem.show({ 
        message: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${getDocumentTypeName(type)}...`,
        showProgress: true 
      });
      
      try {
        // Get customer data for CitizenId
        const customerIdCardElement = document.getElementById('customerIdCard');
        const customerIdCard = customerIdCardElement?.value?.replace(/\D/g, '');
        
        // Allow upload if ID card is being filled (at least 10 digits for partial validation)
        if (!customerIdCard || customerIdCard.length < 10) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'warning');
          
          // Focus on ID card input if it exists
          if (customerIdCardElement) {
            customerIdCardElement.focus();
            customerIdCardElement.classList.add('border-red-500');
            setTimeout(() => {
              customerIdCardElement.classList.remove('border-red-500');
            }, 3000);
          }
          return;
        }
        
        // Use the ID card as is (even if not complete 13 digits)
        console.log(`üìã Using CitizenId: ${customerIdCard} (${customerIdCard.length} digits)`);
        
        // If less than 13 digits, pad with zeros or use as temp ID
        const finalCitizenId = customerIdCard.length === 13 ? customerIdCard : `temp_${customerIdCard}_${Date.now()}`;
        console.log(`üìã Final CitizenId for upload: ${finalCitizenId}`);
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('citizenId', finalCitizenId);
        formData.append('type', type);
        formData.append('branchCode', getBranchCode());
        
        // Add customer ID if available (from global data manager)
        const step2Data = globalDataManager.getStepData(2);
        if (step2Data && step2Data.customerId) {
          formData.append('customerId', step2Data.customerId);
        }
        
        // Update progress
        LoadingSystem.updateProgress(loader, 30);
        
        const response = await fetch(`/api/upload-documents/${apiEndpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
            'X-Citizen-Id': finalCitizenId
          },
          body: formData
        });
        
        LoadingSystem.updateProgress(loader, 70);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Network error' }));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          LoadingSystem.updateProgress(loader, 100);
          
          // Update document status
          updateDocumentStatus(type, 'completed');
          
          // Save URL to global data
          saveDocumentUrl(type, data.url);
          
          showToast(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${getDocumentTypeName(type)}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          
          console.log(`‚úÖ ${type} uploaded successfully:`, data);
        } else {
          throw new Error(data.error || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        
      } catch (error) {
        console.error(`Upload ${type} error:`, error);
        
        // Update status to error
        updateDocumentStatus(type, 'error');
        
        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
        if (error.message.includes('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô')) {
          errorMessage = error.message;
        } else if (error.message.includes('‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ')) {
          errorMessage = '‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)';
        } else if (error.message.includes('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')) {
          errorMessage = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ JPG, PNG, WebP';
        }
        
        showToast(errorMessage, 'error');
      } finally {
        LoadingSystem.hide(loader);
      }
    }
    
    // Get document type display name
    function getDocumentTypeName(type) {
      const names = {
        'idCard': '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô',
        'selfie': '‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà',
        'salarySlip': '‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        'signature': '‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô'
      };
      return names[type] || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
    }
    
    // Update document status UI
    function updateDocumentStatus(type, status) {
      const statusElement = document.querySelector(`#${type}UploadCard .status-badge`);
      if (statusElement) {
        statusElement.className = `status-badge ${status}`;
        
        const statusText = {
          'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
          'processing': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
          'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
          'error': '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
        };
        
        statusElement.textContent = statusText[status] || status;
      }
    }
    
    // Save document URL to global data
    function saveDocumentUrl(type, url) {
      const currentData = globalDataManager.getStepData(2) || {};
      if (!currentData.documents) currentData.documents = {};
      
      currentData.documents[type] = {
        url: url,
        uploadedAt: new Date().toISOString(),
        status: 'completed'
      };
      
      globalDataManager.updateStepData(2, currentData);
      
      // Also save to localStorage
      const step2Data = JSON.parse(localStorage.getItem('step2Data') || '{}');
      if (!step2Data.documents) step2Data.documents = {};
      step2Data.documents[type] = currentData.documents[type];
      localStorage.setItem('step2Data', JSON.stringify(step2Data));
    }
    
    // Open camera for document capture
    function openCamera(type) {
      // For mobile devices, try to open camera directly
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Mobile camera capture implementation
        showCameraModal(type);
      } else {
        // Fallback to file input
        document.getElementById(`upload${type.charAt(0).toUpperCase() + type.slice(1)}`).click();
      }
    }
    
    // Show camera modal (simplified version)
    function showCameraModal(type) {
      // Create camera modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
          <h3 class="text-lg font-semibold mb-4">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ${getDocumentTypeName(type)}</h3>
          <div class="space-y-4">
            <video id="cameraPreview" class="w-full rounded-lg" autoplay playsinline></video>
            <canvas id="cameraCanvas" class="hidden"></canvas>
            <div class="flex gap-3">
              <button id="captureBtn" class="btn btn-primary flex-1">
                <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
              </button>
              <button id="closeCameraBtn" class="btn btn-ghost">
                <i class="bi bi-x"></i> ‡∏õ‡∏¥‡∏î
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize camera
      initializeCamera(type, modal);
    }
    
    // Initialize camera
    async function initializeCamera(type, modal) {
      try {
        const video = modal.querySelector('#cameraPreview');
        const canvas = modal.querySelector('#cameraCanvas');
        const captureBtn = modal.querySelector('#captureBtn');
        const closeBtn = modal.querySelector('#closeCameraBtn');
        
        // Get camera stream
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: type === 'selfie' ? 'user' : 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        video.srcObject = stream;
        
        // Capture photo
        captureBtn.addEventListener('click', () => {
          const context = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            if (blob) {
              // Stop camera
              stream.getTracks().forEach(track => track.stop());
              
              // Remove modal
              document.body.removeChild(modal);
              
              // Create file from blob
              const file = new File([blob], `${type}-${Date.now()}.jpg`, { type: 'image/jpeg' });
              
              // Show preview and upload
              if (validateFile(file, type)) {
                await uploadDocument(file, type, type === 'idCard' ? 'id-card' : type === 'salarySlip' ? 'salary-slip' : type);
              }
            }
          }, 'image/jpeg', 0.8);
        });
        
        // Close modal
        closeBtn.addEventListener('click', () => {
          stream.getTracks().forEach(track => track.stop());
          document.body.removeChild(modal);
        });
        
      } catch (error) {
        console.error('Camera error:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
        document.body.removeChild(modal);
      }
    }
    
    // Load saved documents (for page refresh)
    function loadSavedDocuments() {
      const step2Data = globalDataManager.getStepData(2) || JSON.parse(localStorage.getItem('step2Data') || '{}');
      
      if (step2Data.documents) {
        Object.keys(step2Data.documents).forEach(type => {
          const doc = step2Data.documents[type];
          if (doc.url) {
            // Show preview
            const previewDiv = document.getElementById(`${type}Preview`);
            const previewImage = document.getElementById(`${type}Image`);
            
            if (previewDiv && previewImage) {
              previewImage.src = doc.url;
              previewDiv.classList.remove('hidden');
              updateDocumentStatus(type, doc.status || 'completed');
            }
          }
        });
      }
    }
    
    // Setup event listeners for new fields - REMOVED TO AVOID DUPLICATE DOMContentLoaded
    function setupAdditionalEventListeners() {
      // Initialize document upload
      initializeDocumentUpload();
      
      // Load saved documents
      loadSavedDocuments();
      
      // ID Card formatting and validation
      const idCardInput = document.getElementById('customerIdCard');
      if (idCardInput) {
        idCardInput.addEventListener('input', function() {
          formatIdCard(this);
          validateIdCard(this.value);
        });
      }
      
      // Birth date auto-calculation for age
      const birthDateInput = document.getElementById('customerBirthDate');
      if (birthDateInput) {
        birthDateInput.addEventListener('change', calculateAge);
      }
      
      // Map coordinates validation
      const latInput = document.getElementById('customerLatitude');
      const lngInput = document.getElementById('customerLongitude');
      if (latInput) {
        latInput.addEventListener('input', function() {
          validateCoordinates();
          updateMapPreview();
        });
      }
      if (lngInput) {
        lngInput.addEventListener('input', function() {
          validateCoordinates();
          updateMapPreview();
        });
      }
      
      // Map URL extraction
      const mapUrlInput = document.getElementById('customerMapUrl');
      if (mapUrlInput) {
        mapUrlInput.addEventListener('input', function() {
          extractCoordinatesFromUrl(this.value);
        });
      }
    }
    
    // ==================== CUSTOMER SEARCH FUNCTIONS ====================
    
    let searchTimeout = null;
    let selectedCustomer = null;
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');

      if (!searchValue) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'warning');
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        showToast('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'info');
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà`, 'warning');
        return;
      }

      lastSearchTime = now;
      isSearching = true;

      try {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');

        const token = localStorage.getItem('authToken') || '';
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status code ‡∏Å‡πà‡∏≠‡∏ô parse JSON
        if (response.status === 429) {
          showToast('üö´ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', 'error');
          lastSearchTime = Date.now() + 27000; // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 27 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

          resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <p class="text-sm font-medium">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
              <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');
          showToast('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'success');
        } else {
          // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          resultsList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              <i class="bi bi-person-x text-2xl mb-2 block"></i>
              <p class="text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</p>
              <p class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${searchValue}</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤', 'info');
        }

      } catch (error) {
        console.error('Customer search error:', error);

        let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        if (error.message.includes('429')) {
          errorMessage = '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
        }

        resultsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
            <p class="text-sm font-medium">${errorMessage}</p>
            <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
        showToast(errorMessage, 'error');
      } finally {
        isSearching = false;
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö
      resultsList.innerHTML = `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
             onclick="selectCustomerFromSearch('${customerData._id}', '${customerData.contactPhone || ''}')">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${customerData.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <i class="bi bi-credit-card mr-1"></i>
                ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: ${customerData.taxId || customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">
                <i class="bi bi-telephone mr-1"></i>
                ‡πÇ‡∏ó‡∏£: ${customerData.contactPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
              </p>
              <div class="flex items-center gap-2 mt-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs ${customerData.isNewCustomer ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                  ${customerData.isNewCustomer ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤'}
                </span>
                <span class="text-xs text-gray-500">
                  ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${customerData.totalPurchases || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </span>
              </div>
            </div>
            <div class="text-right">
              <button class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                <i class="bi bi-check-circle mr-1"></i>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    async function selectCustomerFromSearch(customerId, taxId) {
      try {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...', 'info');

        const token = localStorage.getItem('authToken') || '';
        const response = await fetch(`/api/customer/${customerId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success && result.data) {
          const customer = result.data;

          // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
          fillCustomerFormFromSearch(customer);

          // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          document.getElementById('customerSearchResults').classList.add('hidden');
          document.getElementById('customerSearch').value = '';

          showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } else {
          throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ');
        }

      } catch (error) {
        console.error('Select customer error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    function fillCustomerFormFromSearch(customer) {
      selectedCustomer = customer;

      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        if (document.getElementById('customerPrefix')) document.getElementById('customerPrefix').value = individual.prefix || '';
        if (document.getElementById('customerFirstName')) document.getElementById('customerFirstName').value = individual.firstName || '';
        if (document.getElementById('customerLastName')) document.getElementById('customerLastName').value = individual.lastName || '';
        if (document.getElementById('citizenId')) document.getElementById('citizenId').value = individual.taxId || individual.idCard || '';
        if (document.getElementById('customerPhone')) document.getElementById('customerPhone').value = individual.phone || '';
        if (document.getElementById('customerEmail')) document.getElementById('customerEmail').value = individual.email || '';
        
        // Facebook ‡πÅ‡∏•‡∏∞ Line ID ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (document.getElementById('customerFacebook') && individual.facebook) {
          document.getElementById('customerFacebook').value = individual.facebook;
        }
        if (document.getElementById('customerLineId') && individual.lineId) {
          document.getElementById('customerLineId').value = individual.lineId;
        }
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏
        if (individual.birthDate || individual.dateOfBirth) {
          const birthDate = individual.birthDate || individual.dateOfBirth;
          
          // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
          let formattedDate = birthDate;
          if (typeof birthDate === 'string' && birthDate.includes('/')) {
            const parts = birthDate.split('/');
            if (parts.length === 3) {
              formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
          }
          
          if (document.getElementById('customerBirthDate')) {
            document.getElementById('customerBirthDate').value = formattedDate;
          }
        } else if (individual.age) {
          if (document.getElementById('customerAge')) {
            document.getElementById('customerAge').value = individual.age;
          }
        }

        // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        if (individual.address) {
          const addr = individual.address;
          if (document.getElementById('customerAddress')) document.getElementById('customerAddress').value = addr.houseNumber || addr.houseNo || '';
          if (document.getElementById('customerProvince')) document.getElementById('customerProvince').value = addr.province || addr.changwat || '';
          if (document.getElementById('customerDistrict')) document.getElementById('customerDistrict').value = addr.district || addr.amphoe || '';
          if (document.getElementById('customerSubDistrict')) document.getElementById('customerSubDistrict').value = addr.subDistrict || addr.tambon || '';
          if (document.getElementById('customerZipcode')) document.getElementById('customerZipcode').value = addr.zipCode || addr.postalCode || addr.zipcode || '';
        }
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      if (customer.statistics) {
        const statusText = customer.statistics.isNewCustomer ?
          '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠)' :
          `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ${customer.statistics.totalPurchases} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;

        showToast(statusText, 'info');
      }
    }

    // ==================== SIGNATURE PAD FUNCTIONS MOVED TO SEPARATE FILE ====================
    // Signature functions moved to /js/step2-signature.js

    // Event listeners for customer search - REMOVED TO AVOID DUPLICATE DOMContentLoaded
    function setupCustomerSearchEventListeners() {
      // Customer search event listeners
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        // ‡∏Å‡∏î Enter
        customerSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å
        customerSearch.addEventListener('input', function(e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    }

    // Note: Global function exports moved to respective JS modules
  </script>

  <!-- Step 2 initialization handled by step2-main.js -->

  <!-- Loading Animation Functions -->
  <script>
    let step2OldLottieAnimation = null;

    function showStep2OldLoading() {
      try {
        const overlay = document.getElementById('step2OldLoadingOverlay');
        const container = document.getElementById('step2OldLottieContainer');

        if (!overlay || !container) {
          console.warn('[Step2Old] Loading elements not found');
          return;
        }

        overlay.classList.remove('animate__fadeOut');
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';

        // Initialize Lottie animation if not already done
        if (!step2OldLottieAnimation) {
          step2OldLottieAnimation = lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://lottie.host/4db68bbd-31f6-4cd8-b6a5-2cea9a7d3ec2/qBuDuHr0pB.json'
          });

          step2OldLottieAnimation.addEventListener('error', () => {
            console.warn('[Step2Old] Lottie animation failed to load');
            container.innerHTML = '<div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto"></div>';
          });
        }

        console.log('[Step2Old] Loading overlay shown');
      } catch (error) {
        console.error('[Step2Old] Error showing loading:', error);
      }
    }

    function hideStep2OldLoading() {
      try {
        const overlay = document.getElementById('step2OldLoadingOverlay');

        if (!overlay) {
          console.warn('[Step2Old] Loading overlay not found');
          return;
        }

        overlay.classList.add('animate__fadeOut');

        setTimeout(() => {
          overlay.style.display = 'none';
          overlay.style.opacity = '0';
          overlay.style.visibility = 'hidden';
        }, 300);

        console.log('[Step2Old] Loading overlay hidden');
      } catch (error) {
        console.error('[Step2Old] Error hiding loading:', error);
      }
    }

    // Auto-hide loading when page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Step2Old] DOM Content Loaded');

      // Hide loading after a short delay to ensure all resources are loaded
      setTimeout(() => {
        hideStep2OldLoading();
      }, 1000);
    });

    // Show loading when navigating away
    window.addEventListener('beforeunload', function() {
      showStep2OldLoading();
    });

    // Initial loading state
    document.addEventListener('readystatechange', function() {
      if (document.readyState === 'complete') {
        setTimeout(() => {
          hideStep2OldLoading();
        }, 500);
      }
    });
  </script>
</body>
</html>
