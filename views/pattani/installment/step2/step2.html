<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani - Step 2: ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</title>
  
  <!-- CSP configured at server level in server.js -->
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />

  <!-- Include Shared CSS Files -->
  <link rel="stylesheet" href="/views/pattani/installment/shared/css/stepper-common.css?v=4.0">
  <link rel="stylesheet" href="/views/pattani/installment/shared/css/common-styles.css">
  
  <!-- Step 2 Specific CSS Files -->
  <link rel="stylesheet" href="/views/pattani/installment/step2/css/installment-forms.css">
  <link rel="stylesheet" href="/views/pattani/installment/step2/css/address-dropdown.css">
  <link rel="stylesheet" href="/views/pattani/installment/step2/css/signature-modal.css">
  <link rel="stylesheet" href="/views/pattani/installment/step2/css/step2-styles.css">
  <link rel="stylesheet" href="/views/pattani/installment/step2/css/step2-dark-mode.css">

  <!-- Include Shared JavaScript Files -->
  <script src="/views/pattani/installment/shared/js/common-utils.js"></script>
  
  <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CSS production warning
    const originalWarn = console.warn;
    console.warn = function(msg) {
      if (msg && msg.includes && (
        msg.includes('should not be used in production') ||
        msg.includes('cdn.tailwindcss.com')
      )) {
        return; // Suppress Tailwind production warnings
      }
      originalWarn.apply(console, arguments);
    };
  </script>

  <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>
  
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- Sidebar CSS -->
  <link href="/views/pattani/sidebar/sidebar.css" rel="stylesheet" type="text/css" />
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- SignaturePad Library with Enhanced Loading -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"
          onerror="console.warn('SignaturePad CDN failed, trying fallback')"></script>

  <!-- Enhanced SignaturePad loading with retry mechanism -->
  <script>
    // Enhanced SignaturePad loading with retry mechanism
    window.signaturePadRetryCount = 0;
    window.maxSignaturePadRetries = 3;

    function checkSignaturePadLibrary() {
      return new Promise((resolve) => {
        if (typeof SignaturePad !== 'undefined') {
          console.log('‚úÖ SignaturePad library loaded successfully');
          resolve(true);
        } else {
          console.warn('‚ö†Ô∏è SignaturePad library not loaded, attempt:', window.signaturePadRetryCount + 1);

          if (window.signaturePadRetryCount < window.maxSignaturePadRetries) {
            window.signaturePadRetryCount++;

            // Try loading from alternative CDN
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/signature_pad@4.1.7/dist/signature_pad.umd.min.js';
            script.onload = () => {
              console.log('‚úÖ SignaturePad loaded from alternative CDN');
              resolve(true);
            };
            script.onerror = () => {
              setTimeout(() => {
                checkSignaturePadLibrary().then(resolve);
              }, 1000);
            };
            document.head.appendChild(script);
          } else {
            console.warn('‚ùå SignaturePad library failed to load after retries - fallback will be used');
            resolve(false);
          }
        }
      });
    }

    // Check SignaturePad availability on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        checkSignaturePadLibrary().then((loaded) => {
          window.signaturePadLoaded = loaded;
          console.log('üé® SignaturePad availability:', loaded ? 'Available' : 'Using fallback');
        });
      }, 500);
    });
  </script>
  
  <!-- Installment System Styles - Complete Inline -->
  <style>
    /* ========== INSTALLMENT SYSTEM SPECIFIC STYLES ========== */
    /* ‡πÑ‡∏ü‡∏•‡πå CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani */

    /* ========== PERFORMANCE OPTIMIZATIONS ========== */
    /* Performance optimization: Use will-change for animated elements */
    .stepper,
    .step-icon,
    .loading-spinner,
    .card,
    .toast,
    .modal,
    .dropdown {
      will-change: transform, opacity;
    }

    /* CSS containment for better performance */
    .card,
    .product-card,
    .modal-box,
    .step-content {
      contain: layout style paint;
    }

    /* ===== Enhanced Province-District-Subdistrict Dropdown Styles ===== */
    .dropdown-content {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      animation: dropdownFadeIn 0.2s ease-out;
      font-family: 'Prompt', sans-serif;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover, .dropdown-item.selected {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .dropdown-item-main {
      font-weight: 500;
      font-size: 14px;
      color: #1f2937;
    }

    .dropdown-item-sub {
      font-size: 12px;
      color: #6b7280;
      font-style: italic;
    }

    /* Dark mode support for dropdown */
    .dark .dropdown-content {
      background: #374151;
      border-color: #4b5563;
    }

    .dark .dropdown-item {
      border-bottom-color: #4b5563;
    }

    .dark .dropdown-item:hover, .dark .dropdown-item.selected {
      background-color: #1e40af;
      color: #dbeafe;
    }

    .dark .dropdown-item-main {
      color: #f9fafb;
    }

    .dark .dropdown-item-sub {
      color: #9ca3af;
    }

    /* ========== STEPPER STYLES ========== */
    .stepper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      min-width: 120px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
      transition: background-color 0.3s ease;
    }

    .step.active:not(:last-child)::after,
    .step.completed:not(:last-child)::after {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: #94a3b8;
      z-index: 2;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .step.active .step-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .step.completed .step-icon {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .step-text,
    .step-label {
      margin-top: 0.5rem;
      font-size: 12px;
      font-weight: 500;
      color: #64748b;
      text-align: center;
      transition: color 0.3s ease;
    }

    .step.active .step-text,
    .step.active .step-label {
      color: #3b82f6;
      font-weight: 600;
    }

    .step.completed .step-text,
    .step.completed .step-label {
      color: #10b981;
    }

    /* ========== CARD STYLES ========== */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    /* Dark mode card */
    .dark .card {
      background: #1f2937;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .dark .card-title {
      color: #f1f5f9;
    }

    /* ========== FORM STYLES ========== */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #475569;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 0.625rem 0.875rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      background-color: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-control:disabled {
      background-color: #f8fafc;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Dark mode form */
    .dark .form-label {
      color: #cbd5e1;
    }

    .dark .form-control {
      background-color: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }

    .dark .form-control:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    /* ========== BUTTON STYLES ========== */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 0.625rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      padding: 0.625rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    /* ========== TOAST STYLES ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast.warning {
      border-left: 4px solid #f59e0b;
    }

    .toast.info {
      border-left: 4px solid #3b82f6;
    }

    /* Dark mode toast */
    .dark .toast {
      background: #374151;
      color: #f3f4f6;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .stepper {
        padding: 1rem;
      }

      .step-label {
        font-size: 10px;
      }

      .step-icon {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }

      .card {
        margin-bottom: 1rem;
      }

      .btn-primary,
      .btn-secondary {
        padding: 0.5rem 1rem;
        font-size: 13px;
      }
    }

    /* ========== UTILITIES ========== */
    .text-required {
      color: #ef4444;
    }

    .border-error {
      border-color: #ef4444 !important;
    }

    .bg-gradient-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .bg-gradient-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .shadow-soft {
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
    }

    .transition-smooth {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== VALIDATION STYLES ========== */
    .input-error {
      border-color: #ef4444 !important;
      background-color: #fef2f2;
    }

    .input-success {
      border-color: #10b981 !important;
      background-color: #f0fdf4;
    }

    .validation-icon {
      pointer-events: none;
    }

    .form-error {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .form-error.show {
      display: block;
    }

    /* Required field indicator */
    .required-field::after {
      content: ' *';
      color: #ef4444;
    }

    /* üîß Enhanced Validation Styles */
    .input-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 1px #ef4444 !important;
      background-color: #fef2f2 !important;
    }

    .input-success {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 1px #10b981 !important;
      background-color: #ecfdf5 !important;
    }

    .validation-icon {
      pointer-events: none;
      z-index: 10;
    }

    /* Form field container for better validation display */
    .form-field-container {
      position: relative;
    }

    .form-error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .form-field-container.has-error .form-error-message {
      display: block;
    }

    /* Required field styling */
    input[required], select[required], textarea[required] {
      position: relative;
    }

    input[required]:invalid {
      border-color: #fbbf24;
    }

    input[required]:valid {
      border-color: #10b981;
    }
  </style>

  <!-- Google Maps API - DISABLED due to IP restrictions -->
  <script>
    // Google Maps loading disabled due to IP address restrictions
    function loadGoogleMapsAPI() {
      console.log('üó∫Ô∏è Google Maps loading skipped due to IP restrictions');
    
      // Initialize fallback immediately
      if (typeof initMap === 'function') {
        initMap();
      }
    
      // Update all address-related inputs to manual mode
      setTimeout(() => {
        const addressInputs = document.querySelectorAll('#customerCoordinates, #customerMapUrl, input[placeholder*="‡∏û‡∏¥‡∏Å‡∏±‡∏î"], input[placeholder*="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"]');
        addressInputs.forEach(input => {
          if (input && !input.classList.contains('maps-restricted')) {
            input.classList.add('maps-restricted');
            input.placeholder = (input.placeholder || '‡∏û‡∏¥‡∏Å‡∏±‡∏î/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà') + ' (‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)';
            input.title = 'Google Maps ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
          }
        });
    
        // Show notification once
        if (!window.mapsNotificationShown) {
          // Removed toast to avoid duplicate notifications
          window.mapsNotificationShown = true;
        }
      }, 100);
    }
    
    // Note: Google Maps initialization is handled in the main DOMContentLoaded handler
  </script>

  <!-- Modal Z-Index Fix -->
  <style>
    /* ‡∏õ‡∏£‡∏±‡∏ö z-index ‡∏Ç‡∏≠‡∏á modal ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà conflict ‡∏Å‡∏±‡∏ô */
    #cameraModal {
      z-index: 9998 !important;
    }
    
    #signatureModal {
      z-index: 9999 !important;
    }
    
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ pointer events ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î camera modal */
    #signatureModal.hidden {
      pointer-events: none !important;
    }
    
    #signatureModal:not(.hidden) {
      pointer-events: auto !important;
    }
    
    /* ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ signature canvas ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */
    #signatureModalCanvas {
      touch-action: none !important;
      user-select: none !important;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á modal */
    #signatureModal:not(.hidden) {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    #signatureModal.hidden {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }
  </style>

  <style>
    /* Google Maps IP Restriction Fallback Styles */
    .maps-restricted {
      background-color: #f9fafb !important;
      border-left: 3px solid #fbbf24 !important;
      position: relative;
    }
    
    .maps-restricted::before {
      content: "üåç";
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
      font-size: 16px;
    }
    
    .maps-restricted:focus {
      border-color: #f59e0b !important;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1) !important;
    }
    
    /* Suppress Google Maps error indicators */
    .gm-err-container,
    .gm-err-content,
    .gm-err-icon {
      display: none !important;
    }
    
    /* Hide Google Maps loading indicators when restricted */
    .maps-loading-disabled {
      display: none !important;
    }

    /* üñºÔ∏è Document Upload Styles */
    .document-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .document-upload-card {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .document-upload-card:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .document-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.processing {
      background: #dbeafe;
      color: #2563eb;
    }

    .status-badge.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .document-preview {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      overflow: hidden;
      background: white;
    }

    /* üì± Camera Modal Styles */
    #cameraModal video {
      max-height: 300px;
      object-fit: cover;
    }

    /* üîß Responsive adjustments */
    @media (max-width: 768px) {
      .document-upload-grid {
        grid-template-columns: 1fr;
      }
      
      #cameraModal .bg-white {
        margin: 1rem;
        max-width: calc(100vw - 2rem);
      }
    }

    /* Validation Styles */
    .validation-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 1px #ef4444;
    }

    .validation-success {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 1px #10b981;
    }

    .validation-message {
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .validation-message.error {
      color: #ef4444;
    }

    .validation-message.success {
      color: #10b981;
    }
  </style>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script>
    // New Lottie Loading State with State Management (same as addNewProduct_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // MODAL MANAGEMENT FUNCTIONS
    // ==========================================
    function closeAllModals() {
      console.log('üîê Closing all modals to prevent overlaps...');
    
      // Stop all video streams first
      if (window.currentStream) {
        window.currentStream.getTracks().forEach(track => track.stop());
        window.currentStream = null;
      }
    
      // Close camera modal
      const cameraModal = document.getElementById('cameraModal');
      if (cameraModal) {
        cameraModal.classList.add('hidden');
        cameraModal.classList.remove('flex');
    
        // Reset video element
        const video = document.getElementById('cameraVideo');
        if (video && video.srcObject) {
          const stream = video.srcObject;
          stream.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }
      }
    
      // Close signature modal
      const signatureModal = document.getElementById('signatureModal');
      if (signatureModal) {
        signatureModal.classList.add('hidden');
        signatureModal.classList.remove('flex');
      }
    
      // Close any dynamically created modals
      const dynamicModals = document.querySelectorAll('[id*="Modal"]:not(#cameraModal):not(#signatureModal)');
      dynamicModals.forEach(modal => {
        if (modal.classList.contains('fixed')) {
          modal.remove();
        }
      });
    
      console.log('‚úÖ All modals closed and cleaned up');
    }
    
    // ==========================================
    // MAIN INITIALIZATION - Single DOMContentLoaded Handler
    // ==========================================
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Starting Step 2 initialization');

      // Show main loading at start
      showStep2Loading(true);

      // üîê Close all modals first to prevent overlaps
      closeAllModals();
    
      // 1. Initialize navigation data from sessionStorage
      initializeNavigationData();
    
      // 2. Initialize Google Maps API (if needed)
      if (typeof loadGoogleMapsAPI === 'function') {
        loadGoogleMapsAPI();
      }
    
      // 3. Initialize main Step 2 functionality
      await initializeStep2();
    
      // 4. Initialize enhanced address dropdowns
      initializeEnhancedAddressDropdowns();
    
      // 5. Initialize Document Manager (if available)
      if (typeof DocumentManager !== 'undefined' && DocumentManager.init) {
        DocumentManager.init();
      }
    
      // 6. Initialize additional features
      initializeAdditionalFeatures();
    
      console.log('‚úÖ Step 2 initialization complete');

      // Hide main loading when initialization is complete
      setTimeout(() => {
        showStep2Loading(false);
      }, 1000);
    });
    
    // ==========================================
    // NAVIGATION DATA INITIALIZATION
    // ==========================================
    function initializeNavigationData() {
      try {
        const navDataRaw = sessionStorage.getItem('depositNavigationData');
        console.log('üîç Raw navigation data from sessionStorage:', navDataRaw);
    
        if (navDataRaw) {
          const navData = JSON.parse(navDataRaw);
          console.log('üîó depositNavigationData loaded:', navData);
          console.log('üì¶ Product data check:', {
            hasProduct: !!navData.product,
            productId: navData.product?._id,
            productName: navData.product?.name,
            productImei: navData.product?.imei,
            hasAmounts: !!navData.amounts,
            depositAmount: navData.amounts?.depositAmount,
            totalAmount: navData.amounts?.totalAmount
          });
    
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
          setTimeout(() => {
            if (typeof showToast === 'function') {
              showToast(
                `üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${navData.receiptNumber}`,
                'info'
              );
            }
          }, 500);
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
          if (navData.hasStockReservation && navData.stockReservation) {
            console.log('üîí Stock reservation detected for installment:', navData.stockReservation);
    
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global variable
            window.depositStockReservation = navData.stockReservation;
            window.hasDepositStockReservation = true;
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            setTimeout(() => {
              if (typeof showToast === 'function') {
                showToast(
                  `üîí ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${navData.stockReservation.productName} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${navData.stockReservation.customerName}`,
                  'success'
                );
              }
            }, 1000);
          }
    
          // Pre-fill customer info if available
          if (navData.customer) {
            console.log('üë§ Pre-filling customer data from deposit receipt:', navData.customer);
    
            // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏≤‡∏Å customer.name
            if (navData.customer.name) {
              const nameParts = navData.customer.name.split(' ');
              let prefix = '';
              let firstName = '';
              let lastName = '';
    
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
              if (nameParts.length > 0 && ['‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á', '‡∏ô.‡∏™.', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß'].includes(nameParts[0])) {
                prefix = nameParts[0];
                firstName = nameParts[1] || '';
                lastName = nameParts.slice(2).join(' ') || '';
              } else {
                firstName = nameParts[0] || '';
                lastName = nameParts.slice(1).join(' ') || '';
              }
    
              // Fill prefix
              const prefixInput = document.getElementById('customerPrefix');
              if (prefixInput && prefix) {
                prefixInput.value = prefix;
              }
    
              // Fill first name
              const firstNameInput = document.getElementById('customerFirstName');
              if (firstNameInput && firstName) {
                firstNameInput.value = firstName;
              }
    
              // Fill last name
              const lastNameInput = document.getElementById('customerLastName');
              if (lastNameInput && lastName) {
                lastNameInput.value = lastName;
              }
            }
    
            // Fill phone
            if (navData.customer.phone) {
              const phoneInput = document.getElementById('customerPhone');
              if (phoneInput) phoneInput.value = navData.customer.phone;
            }
    
            // Fill tax ID
            if (navData.customer.taxId) {
              const taxIdInput = document.getElementById('customerIdCard');
              if (taxIdInput) taxIdInput.value = navData.customer.taxId;
            }
    
            // Fill address if it's an object
            if (navData.customer.address && typeof navData.customer.address === 'object') {
              const addressData = navData.customer.address;
    
              if (addressData.houseNo) {
                const houseNoInput = document.getElementById('customerHouseNo');
                if (houseNoInput) houseNoInput.value = addressData.houseNo;
              }
    
              if (addressData.moo) {
                const mooInput = document.getElementById('customerMoo');
                if (mooInput) mooInput.value = addressData.moo;
              }
    
              if (addressData.subDistrict) {
                const subDistrictInput = document.getElementById('customerSubDistrict');
                if (subDistrictInput) subDistrictInput.value = addressData.subDistrict;
              }
    
              if (addressData.district) {
                const districtInput = document.getElementById('customerDistrict');
                if (districtInput) districtInput.value = addressData.district;
              }
    
              if (addressData.province) {
                const provinceInput = document.getElementById('customerProvince');
                if (provinceInput) provinceInput.value = addressData.province;
              }
    
              if (addressData.zipcode) {
                const zipcodeInput = document.getElementById('customerZipcode');
                if (zipcodeInput) zipcodeInput.value = addressData.zipcode;
              }
            }
    
            console.log('‚úÖ Customer data pre-filled from deposit receipt');
    
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï page title ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
            const pageTitle = document.querySelector('h1, .page-title, [data-title]');
            if (pageTitle) {
              pageTitle.innerHTML = `
                <div class="flex items-center gap-3">
                  <i class="bi bi-receipt text-blue-600"></i>
                  <div>
                    <div class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    <div class="text-sm text-blue-600">‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${navData.receiptNumber}</div>
                  </div>
                </div>
              `;
            }
          }
    
          // Pre-fill product summary if available
          if (navData.products && Array.isArray(navData.products)) {
            // Custom logic to display products in summary
            const productSummary = document.getElementById('productSummary');
            if (productSummary) {
              productSummary.innerHTML = navData.products.map(p => `<div>${p.name} (${p.quantity})</div>`).join('');
              const cartCount = document.getElementById('cartCount');
              if (cartCount) cartCount.textContent = navData.products.length;
            }
          }
    
          // Pre-fill single product from deposit receipt
          if (navData.product && navData.product._id) {
            console.log('üì¶ Adding product from deposit receipt to step2:', navData.product);
    
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥
            localStorage.removeItem('cartData');
            localStorage.removeItem('step1_selectedProducts');
            localStorage.removeItem('selectedProducts');
            localStorage.removeItem('cartItems');
            localStorage.removeItem('installmentData');
            console.log('üßπ Cleared old product data to prioritize deposit receipt data');
    
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            const depositCartData = [{
              id: navData.product._id || navData.product.id || `deposit_${navData.depositReceiptId}`,
              _id: navData.product._id || navData.product.id || `deposit_${navData.depositReceiptId}`,
              name: navData.product.name,
              brand: navData.product.brand,
              model: navData.product.model,
              price: navData.product.price,
              quantity: 1,
              totalPrice: navData.product.price,
              imei: navData.product.imei,
              category: navData.product.category || 'mobile',
              fromDepositReceipt: true,
              depositReceiptId: navData.depositReceiptId,
              depositAmount: navData.amounts?.depositAmount || 0,
              remainingAmount: navData.amounts?.remainingAmount || 0,
              downAmount: navData.amounts?.depositAmount || 0,
              downInstallment: Math.round((navData.amounts?.remainingAmount || 0) / 12),
              downInstallmentCount: 12,
              purchaseType: ['installment'],
              stockType: 'imei'
            }];
    
            localStorage.setItem('cartData', JSON.stringify(depositCartData));
            localStorage.setItem('step1_selectedProducts', JSON.stringify(depositCartData));
            console.log('üíæ Created new cartData from deposit receipt:', depositCartData);
    
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            updateProductSummaryDisplay(navData);
    
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
            addDepositReceiptBanner(navData);
    
            // Wait for global installment manager to be ready
            setTimeout(() => {
              if (window.globalInstallmentManager) {
                try {
                  // Add product to step1 data (products selection)
                  const productForStep1 = {
                    id: navData.product._id,
                    name: navData.product.name,
                    brand: navData.product.brand,
                    model: navData.product.model,
                    price: navData.product.price,
                    imei: navData.product.imei,
                    category: navData.product.category,
                    quantity: 1,
                    fromDepositReceipt: true,
                    depositReceiptId: navData.depositReceiptId,
                    depositAmount: navData.amounts?.depositAmount || 0,
                    totalAmount: navData.amounts?.totalAmount || 0,
                    remainingAmount: navData.amounts?.remainingAmount || 0
                  };
    
                  // Update step1 data with product
                  const step1Data = window.globalInstallmentManager.getStepData(1) || {};
                  step1Data.selectedProducts = [productForStep1];
                  step1Data.items = [productForStep1];
                  step1Data.totalItems = 1;
                  step1Data.totalAmount = navData.amounts?.totalAmount || navData.product.price || 0;
                  step1Data.fromDepositReceipt = true;
                  step1Data.depositReceiptData = navData;
    
                  window.globalInstallmentManager.updateStepData(1, step1Data);
                  console.log('‚úÖ Product added to step1 data from deposit receipt');
    
                  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä UI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                  if (window.step2Integration && typeof window.step2Integration.refreshProductDisplay === 'function') {
                    window.step2Integration.refreshProductDisplay();
                  }
    
                  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï global data manager ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥
                  window.globalInstallmentManager.data.step1 = {
                    data: {
                      selectedProducts: [productForStep1],
                      items: [productForStep1],
                      totalItems: 1,
                      totalAmount: navData.amounts?.totalAmount || navData.product.price || 0,
                      fromDepositReceipt: true,
                      depositReceiptData: navData
                    },
                    completed: true,
                    timestamp: new Date().toISOString()
                  };
    
                  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
                  window.globalInstallmentManager.saveToStorage();
                  console.log('üîÑ Force updated global data manager with deposit data');
    
                } catch (error) {
                  console.error('‚ùå Error adding product to step1 data:', error);
                }
              }
            }, 500);
    
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï step1 summary ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            setTimeout(() => {
              updateStep1Summary(navData);
              updateDepositReceiptInfo(navData);
    
              // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              forceUpdateProductDisplay(navData);
    
              // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              setTimeout(() => {
                if (typeof refreshProductSummary === 'function') {
                  refreshProductSummary();
                }
                if (typeof updateProductSummary === 'function') {
                  updateProductSummary();
                }
                if (window.step2Integration && typeof window.step2Integration.refreshDisplay === 'function') {
                  window.step2Integration.refreshDisplay();
                }
              }, 100);
            }, 1500);
          }
    
          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global variable
          window.depositNavigationData = navData;
    
        } else {
          console.log('‚ÑπÔ∏è No depositNavigationData found in sessionStorage');
        }
      } catch (err) {
        console.error('‚ùå Error loading depositNavigationData:', err);
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥
    function updateProductSummaryDisplay(navData) {
      const productSummary = document.getElementById('productSummary');
      if (!productSummary || !navData.product) return;
    
      let stockStatusHtml = '';
      if (navData.hasStockReservation && navData.stockReservation) {
        stockStatusHtml = `
          <div class="mt-2 p-2 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-700">
            <div class="flex items-center gap-2">
              <i class="bi bi-lock-fill text-green-600"></i>
              <span class="text-sm text-green-700 dark:text-green-300 font-medium">
                ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(navData.stockReservation.expiresAt).toLocaleString('th-TH')})
              </span>
            </div>
          </div>
        `;
      }
    
      productSummary.innerHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700 mb-4">
          <div class="flex items-center gap-3 mb-3">
            <i class="bi bi-receipt text-blue-600 text-xl"></i>
            <div>
              <div class="font-semibold text-blue-800 dark:text-blue-200">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
              <div class="text-sm text-blue-600 dark:text-blue-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${navData.receiptNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 p-3 rounded border">
            <div class="flex items-center gap-3">
              <i class="bi bi-phone text-gray-600 text-2xl"></i>
              <div class="flex-1">
                <div class="font-medium text-gray-800 dark:text-gray-200 text-lg">${navData.product.name}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  ${navData.product.brand} ${navData.product.model || ''}
                  ${navData.product.imei ? `‚Ä¢ IMEI: ${navData.product.imei}` : ''}
                </div>
                <div class="mt-2 grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <div class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                    <div class="font-semibold text-gray-800">‡∏ø${(navData.product.price || 0).toLocaleString()}</div>
                  </div>
                  <div>
                    <div class="text-gray-500">‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
                    <div class="font-semibold text-green-600">‡∏ø${(navData.amounts?.depositAmount || 0).toLocaleString()}</div>
                  </div>
                  <div>
                    <div class="text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                    <div class="font-semibold text-orange-600">‡∏ø${(navData.amounts?.remainingAmount || 0).toLocaleString()}</div>
                  </div>
                </div>
                ${stockStatusHtml}
              </div>
            </div>
          </div>
        </div>
      `;
    
      console.log('‚úÖ Product summary updated with deposit receipt data');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï step1 summary
    function updateStep1Summary(navData) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
      const cartCount = document.getElementById('cartCount');
      if (cartCount) {
        cartCount.textContent = '1';
        cartCount.classList.add('bg-green-500', 'text-white');
      }
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
      const summaryElements = {
        totalAmount: document.querySelector('[data-summary="totalAmount"]'),
        depositAmount: document.querySelector('[data-summary="depositAmount"]'),
        remainingAmount: document.querySelector('[data-summary="remainingAmount"]')
      };
    
      if (summaryElements.totalAmount) {
        summaryElements.totalAmount.textContent = `‡∏ø${(navData.amounts?.totalAmount || 0).toLocaleString()}`;
      }
      if (summaryElements.depositAmount) {
        summaryElements.depositAmount.textContent = `‡∏ø${(navData.amounts?.depositAmount || 0).toLocaleString()}`;
      }
      if (summaryElements.remainingAmount) {
        summaryElements.remainingAmount.textContent = `‡∏ø${(navData.amounts?.remainingAmount || 0).toLocaleString()}`;
      }
    
      console.log('‚úÖ Step1 summary updated with deposit receipt data');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÉ‡∏ô sidebar
    function updateDepositReceiptInfo(navData) {
      // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï element ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const productSelection = document.querySelector('.product-selection, .selected-products, #selectedProductsContainer');
      if (productSelection) {
        productSelection.innerHTML = `
          <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-700">
            <div class="flex items-center gap-2 mb-2">
              <i class="bi bi-check-circle-fill text-green-600"></i>
              <span class="font-medium text-green-700 dark:text-green-300">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            </div>
            <div class="text-sm space-y-1">
              <div><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${navData.product.name}</div>
              <div><strong>IMEI:</strong> ${navData.product.imei || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div><strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ‡∏ø${(navData.product.price || 0).toLocaleString()}</div>
              <div><strong>‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß:</strong> ‡∏ø${(navData.amounts?.depositAmount || 0).toLocaleString()}</div>
            </div>
          </div>
        `;
      }
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      const step1Badge = document.querySelector('[data-step="1"] .badge, .step-1-badge');
      if (step1Badge) {
        step1Badge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        step1Badge.className = 'badge bg-green-500 text-white text-xs px-2 py-1 rounded-full';
      }
    
      console.log('‚úÖ Deposit receipt info updated in sidebar');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥
    function forceUpdateProductDisplay(navData) {
      console.log('üîÑ Force updating product display with deposit data...');
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï sidebar ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
      const cartCount = document.getElementById('cartCount');
      if (cartCount) {
        cartCount.textContent = '1';
        cartCount.className = 'bg-green-500 text-white text-xs px-2 py-1 rounded-full font-medium';
      }
    
      // ‡∏´‡∏≤ element ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const productElements = [
        '#productSummary',
        '.product-summary',
        '.selected-products',
        '.cart-summary',
        '.items-summary',
        '[data-product-list]'
      ];
    
      productElements.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
          element.innerHTML = `
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700 mb-4">
              <div class="flex items-center gap-3 mb-3">
                <i class="bi bi-receipt text-blue-600 text-xl"></i>
                <div>
                  <div class="font-semibold text-blue-800 dark:text-blue-200">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
                  <div class="text-sm text-blue-600 dark:text-blue-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${navData.receiptNumber}</div>
                </div>
              </div>
              
              <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border shadow-sm">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                    <i class="bi bi-phone text-gray-600 text-xl"></i>
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold text-gray-800 dark:text-gray-200 text-lg">${navData.product.name}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      ${navData.product.brand} ${navData.product.model || ''}
                      ${navData.product.imei ? `‚Ä¢ IMEI: ${navData.product.imei}` : ''}
                    </div>
                    <div class="mt-2 flex gap-6 text-sm">
                      <div>
                        <span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤:</span>
                        <span class="font-semibold text-gray-800 ml-1">‡∏ø${(navData.product.price || 0).toLocaleString()}</span>
                      </div>
                      <div>
                        <span class="text-gray-500">‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
                        <span class="font-semibold text-green-600 ml-1">‡∏ø${(navData.amounts?.depositAmount || 0).toLocaleString()}</span>
                      </div>
                      <div>
                        <span class="text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                        <span class="font-semibold text-orange-600 ml-1">‡∏ø${(navData.amounts?.remainingAmount || 0).toLocaleString()}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          console.log(`‚úÖ Updated product display in ${selector}`);
        }
      });
    
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
      const summaryElements = document.querySelectorAll('[data-summary], .summary-amount, .total-amount');
      summaryElements.forEach(element => {
        if (element.textContent.includes('‡∏ø') || element.dataset.summary) {
          element.textContent = `‡∏ø${(navData.amounts?.totalAmount || navData.product.price || 0).toLocaleString()}`;
          element.className += ' text-blue-600 font-semibold';
        }
      });
    
      console.log('‚úÖ Force update product display completed');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
    function addDepositReceiptBanner(navData) {
      // ‡∏´‡∏≤ container ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
      const mainContainer = document.querySelector('#mainContent, .main-content, body > *:first-child') || document.body;
    
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
      const banner = document.createElement('div');
      banner.id = 'depositReceiptBanner';
      banner.className = 'fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg';
      banner.innerHTML = `
        <div class="container mx-auto px-4 py-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="bi bi-receipt text-xl"></i>
              <div>
                <div class="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥: ${navData.receiptNumber}</div>
                <div class="text-sm opacity-90">
                  ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${navData.product?.name} ‚Ä¢ ‡∏°‡∏±‡∏î‡∏à‡∏≥: ‡∏ø${(navData.amounts?.depositAmount || 0).toLocaleString()}
                  ${navData.hasStockReservation ? ' ‚Ä¢ üîí ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å' : ''}
                </div>
              </div>
            </div>
            <button onclick="closeBanner()" class="text-white hover:text-gray-200 p-2">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      `;
    
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
      document.body.insertBefore(banner, document.body.firstChild);
    
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° margin-top ‡πÉ‡∏´‡πâ content ‡∏´‡∏•‡∏±‡∏Å
      const content = document.querySelector('#mainContent, .main-content');
      if (content) {
        content.style.marginTop = '80px';
      }
    
      console.log('‚úÖ Deposit receipt banner added');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
    function closeBanner() {
      const banner = document.getElementById('depositReceiptBanner');
      if (banner) {
        banner.remove();
    
        // ‡∏•‡∏ö margin-top
        const content = document.querySelector('#mainContent, .main-content');
        if (content) {
          content.style.marginTop = '';
        }
      }
    }
    // Early function definitions to prevent ReferenceError
    console.log('üîß Setting up early function definitions...');
    
    // Get branch code from URL parameters immediately
    const urlParams = new URLSearchParams(window.location.search);
    const branchFromURL = urlParams.get('branch');
    const branchNameFromURL = urlParams.get('name');
    
    // Set branch code globally
    if (branchFromURL && branchFromURL !== 'undefined' && branchFromURL !== 'null') {
      window.BRANCH_CODE = branchFromURL;
      console.log('‚úÖ Branch code set from URL:', branchFromURL);
    } else {
      // Try to get from step 1 data or localStorage
      const step1Data = JSON.parse(localStorage.getItem('installmentData_step1') || '{}');
      if (step1Data.branchCode) {
        window.BRANCH_CODE = step1Data.branchCode;
        console.log('‚úÖ Branch code restored from step1 data:', step1Data.branchCode);
      } else {
        console.warn('‚ö†Ô∏è No branch code found in URL or localStorage');
      }
    }
    
    // Declare global variables
    let selectedProducts = [];
    let currentSignatureType = null;
    let signaturePad = null;
    let currentStream = null;
    
    // Google Maps API callback function (MUST be defined before Maps API loads)
    function initMap() {
      console.log('üó∫Ô∏è Map initialization - using manual input mode due to IP restrictions');
    
      // Skip Google Maps initialization - use manual input mode
      try {
        console.log('üö´ Skipping Google Maps Places initialization due to IP restrictions');
    
        // Immediately set up manual input mode
        setTimeout(() => {
          const addressInputs = [
            'customerCoordinates',
            'customerMapUrl'
          ];
    
          addressInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
              // Set up manual input mode immediately
              input.classList.add('maps-restricted');
              input.placeholder = (input.placeholder || '‡∏û‡∏¥‡∏Å‡∏±‡∏î') + ' (‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)';
              input.title = 'Google Maps ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
              console.log(`‚úÖ Manual input mode set for ${inputId}`);
            }
          });
        }, 100);
    
        return; // Skip all Google Maps related code
    
        // OLD CODE - Disabled
        if (false) { // Never execute
          addressInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input && typeof google !== 'undefined' && google.maps && google.maps.places) {
    
              // Try to use new PlaceAutocompleteElement first (recommended by Google)
              if (google.maps.places.PlaceAutocompleteElement) {
                try {
                  // Skip testing PlacesService to avoid deprecation warnings
    
                  const autocompleteElement = new google.maps.places.PlaceAutocompleteElement({
                    componentRestrictions: { country: 'th' },
                    types: ['address']
                  });
    
                  // Replace input with autocomplete element
                  input.parentNode.insertBefore(autocompleteElement, input);
                  input.style.display = 'none';
    
                  // Copy styling
                  autocompleteElement.className = input.className;
                  autocompleteElement.placeholder = input.placeholder;
    
                  autocompleteElement.addEventListener('gmp-placeselect', (event) => {
                    const place = event.place;
                    if (place.geometry && place.geometry.location) {
                      const lat = place.geometry.location.lat();
                      const lng = place.geometry.location.lng();
    
                      // Auto-fill coordinates
                      const coordsInput = document.getElementById('customerCoordinates');
                      const latInput = document.getElementById('customerLatitude');
                      const lngInput = document.getElementById('customerLongitude');

                      if (coordsInput) coordsInput.value = `${lat}, ${lng}`;
                      if (latInput) latInput.value = lat;
                      if (lngInput) lngInput.value = lng;
    
                      // Update input value
                      input.value = place.displayName || place.formattedAddress || `${lat}, ${lng}`;
    
                      // Call updateMapPreview if available
                      if (typeof updateMapPreview === 'function') {
                        updateMapPreview();
                      }
    
                      console.log('üìç Place selected (new API):', place.displayName, `(${lat}, ${lng})`);
                    }
                  });
    
                  console.log(`‚úÖ New PlaceAutocompleteElement initialized for ${inputId}`);
                  return;
                } catch (newApiError) {
                  console.warn('‚ö†Ô∏è New PlaceAutocompleteElement failed:', newApiError.message);
                }
              }
    
              // Skip Google Maps autocomplete completely due to IP restrictions
              console.warn('‚ö†Ô∏è Skipping Google Maps autocomplete due to IP restrictions');
    
              // Update UI to indicate manual input mode
              if (input) {
                input.placeholder = (input.placeholder || '‡∏û‡∏¥‡∏Å‡∏±‡∏î') + ' (‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á - Google Maps ‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î)';
                input.classList.add('maps-restricted');
                input.title = 'Google Maps ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î IP Address ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
              }
            }
          });
        } // End of if (false) block
    
        console.log('‚úÖ Manual input mode setup completed');
      } catch (error) {
        console.error('‚ùå Failed to initialize manual input mode:', error);
      }
    }
    
    // Make initMap globally available immediately
    window.initMap = initMap;
    
    // Google Maps disabled - no authentication needed
    window.gm_authFailure = function() {
      console.log('üö´ Google Maps authentication skipped - API disabled');
    };
    
    // Google Maps completely disabled - no error handling needed
    console.log('üö´ Google Maps error handling disabled - API not loaded');
    
    // Google Maps will be handled gracefully through UI fallbacks
    console.log('‚úÖ Early function definitions ready');
  </script>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  

  <div id="sidebarContainer"></div>

  <main id="mainContent" class="flex-1 overflow-y-auto transition-all duration-300 ml-64">
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...</p>
      </div>
        
      <!-- Modular Notifications & Actions -->
      <div class="flex items-center gap-4">
        <!-- Connection Status Indicator -->
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
          <div class="flex items-center gap-1">
            <span id="connectionStatus" class="connection-status offline text-xs font-medium">üî¥ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            <div class="flex gap-1 ml-2">
              <div id="firebaseStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Firebase Status"></div>
              <div id="socketStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Socket.IO Status"></div>
              <div id="printerStatus" class="w-2 h-2 rounded-full bg-gray-400" title="Printer Status"></div>
            </div>
          </div>
          <div id="onlineUserCount" class="text-xs text-gray-500" title="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">1</div>
        </div>

        <!-- Quick Actions Menu -->
        <div class="relative">
          <button id="quickActionsBtn" class="btn btn-outline flex items-center gap-2 px-4 py-2 border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-all duration-300">
            <i class="bi bi-list text-lg"></i>
            <span class="hidden md:inline">‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
            <i class="bi bi-chevron-down text-sm ml-1"></i>
          </button>
          
          <!-- Dropdown Menu -->
          <div id="quickActionsDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
            <div class="px-4 py-2 text-sm font-semibold text-gray-600 border-b border-gray-100 flex items-center justify-between">
              <span>‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</span>
              <i class="bi bi-lightning text-yellow-500"></i>
            </div>
            <div class="px-4 py-2">
              <button class="btn btn-sm btn-primary w-full mb-2">
                <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
              </button>
              <button class="btn btn-sm btn-primary w-full mb-2">
                <i class="bi bi-file-earmark-text"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
              </button>
              <button class="btn btn-sm btn-primary w-full mb-2">
                <i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
              </button>
              <button class="btn btn-sm btn-primary w-full mb-2">
                <i class="bi bi-box-arrow-left"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
              </button>
            </div>
        </div>
      </div>

        <!-- Notifications -->
        <div class="relative" id="notificationWrapper">
          <button id="notificationButton" class="notification-button">
            <i class="bi bi-bell-fill text-lg"></i>
          </button>
          <span id="notificationDot" class="notification-dot hidden"></span>
          <span id="notificationBadge" class="notification-badge hidden">0</span>
          
          <!-- Notification Dropdown -->
          <div id="notificationDropdown" class="notification-dropdown hidden">
            <div class="notification-dropdown-header">
              <h3 class="notification-dropdown-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
              <button class="mark-all-read text-sm text-blue-600 dark:text-blue-400 hover:underline">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
            <div class="notification-dropdown-content">
              <div class="notification-loading">
                <div class="notification-loading-spinner"></div>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
              </div>
            </div>
            <div class="notification-dropdown-footer">
              <a href="#" class="text-sm">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
          </div>
        </div>

        <!-- Back to Step 1 -->
        <a href="../step1/step1.html" class="btn btn-outline">
          <i class="bi bi-arrow-left"></i>
          ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1
        </a>
      </div>
    </header>

    <!-- Content -->
    <div class="container-fluid p-4">
      <!-- Stepper -->
      <div class="stepper" role="navigation" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
        <div class="step completed" data-step="1" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          <div class="step-icon" aria-hidden="true">‚úì</div>
          <div class="step-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step active" data-step="2" role="tab" aria-selected="true" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
          <div class="step-icon" aria-hidden="true">2</div>
          <div class="step-text">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="step" data-step="3" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô">
          <div class="step-icon" aria-hidden="true">3</div>
          <div class="step-text">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡πà‡∏≠‡∏ô</div>
        </div>
        <div class="step" data-step="4" role="tab" aria-selected="false" aria-label="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå">
          <div class="step-icon" aria-hidden="true">4</div>
          <div class="step-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</div>
        </div>
      </div>

      <script>
        // Function for navigation
        function goToStep(stepNumber) {
          const stepFiles = ['step1.html', 'step2.html', 'step3.html', 'step4.html'];
          if (stepNumber >= 1 && stepNumber <= 4) {
            window.location.href = `../step${stepNumber}/${stepFiles[stepNumber - 1]}`;
          }
        }
      </script>

      <!-- Step 2: Customer Information -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Right: Product Summary -->
        <div class="lg:col-start-3 lg:row-start-1">
          <div class="card p-4 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 dark:from-blue-900/20 dark:to-indigo-900/20 dark:border-blue-700 rounded-lg">
            <h5 class="flex items-center gap-2 mb-4 font-semibold text-blue-800 dark:text-blue-300">
              <i class="bi bi-cart"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô
              <span class="text-sm font-normal text-gray-500 ml-2">(<span id="cartCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
            </h5>
            
            <!-- Product Summary Note -->
            <div class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
              <div class="flex items-center gap-2 text-yellow-800 dark:text-yellow-200">
                <i class="bi bi-info-circle"></i>
                <span class="text-sm font-medium">‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
              </div>
              <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà <button onclick="goToStep1()" class="text-blue-600 underline hover:text-blue-800">Step 1</button>
              </p>
            </div>

            <div class="cart-summary min-h-[200px] mb-4" id="productSummary">
              <div class="text-center text-gray-500 py-8">
                <i class="bi bi-cart text-4xl mb-2"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
              </div>
            </div>
            
            <!-- Form Progress Indicator -->
            <div class="mb-4 p-3 bg-white/50 dark:bg-gray-800/50 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                <span id="formProgress" class="text-sm font-bold text-blue-600">0%</span>
              </div>
              <div class="progress-bar">
                <div id="formProgressBar" class="progress-fill" style="width: 0%"></div>
              </div>
              <div id="formProgressDetails" class="text-xs text-gray-500 mt-1">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="mt-4 space-y-2">
              <!-- Generate Quotation PDF Button -->
              <button id="btnGenerateQuotationPDF" class="btn btn-success btn-block">
                <i class="bi bi-file-earmark-pdf mr-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ PDF
              </button>
              
              <!-- Next Step Button -->
              <button id="btnStep2ToStep3" class="btn btn-primary btn-block">
                <i class="bi bi-arrow-right mr-2"></i> ‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
              </button>
            </div>
          </div>
        </div>

        <!-- Left: Customer Form -->
        <div class="lg:col-span-2 lg:row-start-1 space-y-4">
          

          <!-- Customer Form - ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å ‡∏à‡∏∞‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á -->
          <div class="card p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="flex items-center justify-between mb-4">
              <h5 class="flex items-center gap-2 font-semibold">
                <i class="bi bi-person-fill text-blue-600"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
              </h5>
              <div class="flex items-center gap-2">
                <button type="button" id="btnClearCustomerForm" class="btn btn-outline btn-sm">
                  <i class="bi bi-arrow-clockwise"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                </button>
              </div>
            </div>

            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
            <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
              <label class="block text-sm font-semibold text-green-800 dark:text-green-200 mb-2">
                <i class="bi bi-search mr-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
              </label>
              <div class="flex gap-2">
                <input 
                  type="text" 
                  id="customerSearch" 
                  class="flex-1 px-3 py-2 border border-green-300 dark:border-green-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white"
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" 
                  maxlength="17" 
                />
                <button 
                  id="btnSearchCustomer" 
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 transition-colors" 
                  title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                >
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>

              <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
              <div id="customerSearchResults" class="mt-3 hidden">
                <div class="max-h-48 overflow-y-auto border border-green-300 dark:border-green-600 rounded-lg bg-white dark:bg-gray-800">
                  <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Results will be inserted here -->
                  </div>
                </div>
              </div>
            </div>
            <!-- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->

            <!-- Customer Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</span>
                </label>
                <select id="customerPrefix" class="select select-bordered w-full">
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
                  <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                  <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                  <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                  <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡πÄ‡∏û‡∏® <span class="text-red-500">*</span></span>
                </label>
                <select id="customerGender" class="select select-bordered w-full" required>
                  <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
                  <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                  <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                  <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏ä‡∏∑‡πà‡∏≠ <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="text" id="customerFirstName" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠" 
                    required 
                    autocomplete="given-name">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group md:col-span-2">
                <label class="label">
                  <span class="label-text font-medium">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="text" id="customerLastName" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" 
                    required 
                    autocomplete="family-name">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group md:col-span-2">
                <label class="label">
                  <span class="label-text font-medium">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="text-red-500">*</span></span>
                </label>
                <div class="flex gap-2">
                  <div class="relative flex-1">
                    <input type="text" id="customerIdCard" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" 
                      maxlength="17" 
                      pattern="[0-9]{1}-[0-9]{4}-[0-9]{5}-[0-9]{2}-[0-9]{1}|[0-9]{13}"
                      oninput="formatIdCard(this)"
                      required>
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <button id="btnReadCard" class="btn btn-info">
                    <i class="bi bi-credit-card-2-front"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
                  </button>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-credit-card"></i> 
                  ‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="tel" id="customerPhone" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å" 
                    maxlength="12" 
                    pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}|[0-9]{9,10}"
                    oninput="formatPhoneNumber(this)"
                    required 
                    autocomplete="tel">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-telephone"></i> 
                  ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
                </label>
                <div class="relative">
                  <input type="email" id="customerEmail" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" 
                    autocomplete="email">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">Facebook URL</span>
                </label>
                <div class="relative">
                  <input type="url" id="customerFacebook" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="https://www.facebook.com/username ‡∏´‡∏£‡∏∑‡∏≠ facebook.com/username" 
                    oninput="validateFacebookUrl(this)">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-facebook text-blue-600"></i> 
                  ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ü‡∏ã‡∏ö‡∏∏‡πä‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                  <span class="label-text-alt text-xs text-green-600">‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™!</span>
                </label>
                <div class="relative">
                  <input type="text" id="referralCode" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" 
                    oninput="validateReferralCode(this)">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div id="referralStatus" class="form-hint text-xs mt-1 hidden">
                  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
                </div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-gift text-green-600"></i> 
                  ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">Line ID</span>
                </label>
                <div class="relative">
                  <input type="text" id="customerLineId" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="Line ID ‡πÄ‡∏ä‡πà‡∏ô mylineid123" 
                    oninput="validateLineId(this)">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
                <div class="form-hint text-xs text-gray-500 mt-1">
                  <i class="bi bi-chat-square-text text-green-600"></i> 
                  Line ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                </div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="date" id="customerBirthDate" 
                    class="input input-bordered w-full pr-10" 
                    required 
                    autocomplete="bday">
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
              
              <div class="form-group">
                <label class="label">
                  <span class="label-text font-medium">‡∏≠‡∏≤‡∏¢‡∏∏ <span class="text-red-500">*</span></span>
                </label>
                <div class="relative">
                  <input type="number" id="customerAge" 
                    class="input input-bordered w-full pr-10" 
                    placeholder="‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)" 
                    min="1" 
                    max="120" 
                    required>
                  <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                </div>
                <div class="form-error hidden"></div>
              </div>
            </div>

            <!-- Income and Occupation Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-briefcase-fill text-blue-600"></i>
                ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <select id="customerOccupation" class="select select-bordered w-full pr-10" required>
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>

                      <!-- ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê -->
                      <optgroup label="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê">
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ï‡∏≥‡∏£‡∏ß‡∏à">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ï‡∏≥‡∏£‡∏ß‡∏à</option>
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ó‡∏´‡∏≤‡∏£">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ó‡∏´‡∏≤‡∏£</option>
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                        <option value="‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</option>
                      </optgroup>

                      <!-- ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô -->
                      <optgroup label="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°/‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°/‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏õ‡∏†.">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏õ‡∏†.</option>
                        <option value="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</option>
                      </optgroup>

                      <!-- ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ -->
                      <optgroup label="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£">
                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ - ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
                        <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                        <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</option>
                        <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ - ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="‡∏ô‡∏±‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏ô‡∏±‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                        <option value="‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ SME">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ SME</option>
                      </optgroup>

                      <!-- ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏™‡∏£‡∏µ/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå -->
                      <optgroup label="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏™‡∏£‡∏µ/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå">
                        <option value="‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</option>
                        <option value="‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°">‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                        <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£">‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£</option>
                        <option value="‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏¥‡∏Å">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏¥‡∏Å</option>
                        <option value="‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        <option value="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ">‡∏ä‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏õ‡∏≤">‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå">‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏ú‡∏°">‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏ú‡∏°</option>
                        <option value="‡∏ô‡∏±‡∏Å‡πÅ‡∏õ‡∏•">‡∏ô‡∏±‡∏Å‡πÅ‡∏õ‡∏•</option>
                        <option value="‡∏Ñ‡∏£‡∏π‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏Ñ‡∏£‡∏π‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                        <option value="‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏∏‡πÄ‡∏ó‡∏®‡∏Å‡πå">‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏∏‡πÄ‡∏ó‡∏®‡∏Å‡πå</option>
                        <option value="‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û">‡∏ä‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û</option>
                        <option value="‡∏ô‡∏±‡∏Å‡∏î‡∏ô‡∏ï‡∏£‡∏µ">‡∏ô‡∏±‡∏Å‡∏î‡∏ô‡∏ï‡∏£‡∏µ</option>
                        <option value="‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô">‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</option>
                        <option value="Artist/‡∏ô‡∏±‡∏Å‡∏®‡∏¥‡∏•‡∏õ‡∏∞">Artist/‡∏ô‡∏±‡∏Å‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
                      </optgroup>

                      <!-- ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Ç‡∏ô‡∏™‡πà‡∏á/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
                      <optgroup label="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Ç‡∏ô‡∏™‡πà‡∏á/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
                        <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà</option>
                        <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
                        <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å</option>
                        <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Grab/Uber)">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏£‡∏ñ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Grab/Uber)</option>
                        <option value="‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ - ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á</option>
                        <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</option>
                        <option value="‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (Delivery)">‡∏Ñ‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (Delivery)</option>
                        <option value="‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô">‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô</option>
                        <option value="‡πÅ‡∏≠‡∏£‡πå‡πÇ‡∏Æ‡∏™‡πÄ‡∏ï‡∏™">‡πÅ‡∏≠‡∏£‡πå‡πÇ‡∏Æ‡∏™‡πÄ‡∏ï‡∏™</option>
                      </optgroup>

                      <!-- ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°/‡∏õ‡∏£‡∏∞‡∏°‡∏á -->
                      <optgroup label="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°/‡∏õ‡∏£‡∏∞‡∏°‡∏á">
                        <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏ß">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏ß</option>
                        <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å</option>
                        <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                        <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°</option>
                        <option value="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ - ‡∏õ‡∏•‡∏π‡∏Å‡∏¢‡∏≤‡∏á‡∏û‡∏≤‡∏£‡∏≤</option>
                        <option value="‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡πÇ‡∏Ñ/‡∏Å‡∏£‡∏∞‡∏ö‡∏∑‡∏≠">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡πÇ‡∏Ñ/‡∏Å‡∏£‡∏∞‡∏ö‡∏∑‡∏≠</option>
                        <option value="‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡∏™‡∏∏‡∏Å‡∏£">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡∏™‡∏∏‡∏Å‡∏£</option>
                        <option value="‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡πÑ‡∏Å‡πà">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡πÑ‡∏Å‡πà</option>
                        <option value="‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡∏õ‡∏•‡∏≤">‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå - ‡∏õ‡∏•‡∏≤</option>
                        <option value="‡∏ä‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏á">‡∏ä‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏á</option>
                        <option value="‡∏ä‡∏≤‡∏ß‡∏™‡∏ß‡∏ô">‡∏ä‡∏≤‡∏ß‡∏™‡∏ß‡∏ô</option>
                      </optgroup>

                      <!-- ‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                      <optgroup label="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                        <option value="‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                        <option value="‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì</option>
                        <option value="‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏û‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô">‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏û‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô">‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô</option>
                        <option value="‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                        <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
                        <option value="‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</option>
                      </optgroup>
                    </select>
                    <div class="validation-icon absolute right-10 top-1/2 transform -translate-y-1/2"></div>
                  </div>

                  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                  <div id="otherOccupationField" class="mt-2 hidden">
                    <input type="text" id="customerOccupationOther"
                      class="input input-bordered w-full"
                      placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">
                  </div>

                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-info-circle"></i>
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)"
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="number" id="customerIncome" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="15000" 
                      min="0" 
                      step="100" 
                      required>
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-cash-coin"></i> 
                    ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)
                  </div>
                </div>
                
                <div class="form-group md:col-span-2">
                  <label class="label">
                    <span class="label-text font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                  </label>
                  <div class="relative">
                    <input type="text" id="customerWorkplace" 
                      class="input input-bordered w-full pr-10" 
                      placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" 
                      autocomplete="organization">
                    <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                  </div>
                  <div class="form-error hidden"></div>
                  <div class="form-hint text-xs text-gray-500 mt-1">
                    <i class="bi bi-building"></i> 
                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
                  </div>
                </div>
              </div>
            </div>

            <!-- Address Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-geo-alt-fill text-blue-600"></i>
                ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></span>
                  </label>
                  <input type="text" id="houseNo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" 
                    required>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</span>
                  </label>
                  <input type="text" id="moo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ã‡∏≠‡∏¢</span>
                  </label>
                  <input type="text" id="soi" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ã‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ñ‡∏ô‡∏ô</span>
                  </label>
                  <input type="text" id="road" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ñ‡∏ô‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="province" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" 
                      autocomplete="off" 
                      required>
                    <div id="provinceDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="district" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" 
                      autocomplete="off" 
                      required>
                    <div id="districtDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á <span class="text-red-500">*</span></span>
                  </label>
                  <div class="relative">
                    <input type="text" id="subDistrict" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ï‡∏≥‡∏ö‡∏•" 
                      autocomplete="off" 
                      required>
                    <div id="subDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span>
                  </label>
                  <input type="text" id="zipcode" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" 
                    maxlength="5" 
                    pattern="[0-9]{5}">
                </div>
              </div>
            </div>

            <!-- Map Coordinates Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-geo-alt-fill text-red-600"></i>
                ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Map Coordinates)
              </h4>
              
              <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                <p class="text-sm text-blue-700 dark:text-blue-300 flex items-start gap-2">
                  <i class="bi bi-info-circle-fill text-blue-600 mt-0.5 flex-shrink-0"></i>
                  <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Maps ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                </p>
              </div>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coordinates Input -->
                <div class="space-y-4">
                    <div class="form-group">
                      <label class="label">
                      <span class="label-text font-medium">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Coordinates)</span>
                      </label>
                      <div class="relative">
                      <input type="text" id="customerCoordinates" 
                          class="input input-bordered w-full pr-10" 
                        placeholder="7.0000000, 100.0000000 ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" 
                        oninput="parseCoordinates(this.value); updateMapPreview();">
                        <div class="validation-icon absolute right-3 top-1/2 transform -translate-y-1/2"></div>
                      </div>
                      <div class="form-error hidden"></div>
                    <div class="form-hint text-xs text-gray-500 mt-1">
                      <i class="bi bi-geo"></i> 
                      ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î, ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î ‡πÄ‡∏ä‡πà‡∏ô 7.0000000, 100.0000000
                    </div>
                  </div>
                  
                  <!-- Hidden inputs for individual lat/lng values -->
                  <input type="hidden" id="customerLatitude">
                  <input type="hidden" id="customerLongitude">
                  
                  <div class="form-group">
                    <label class="label">
                      <span class="label-text font-medium">Google Maps URL</span>
                    </label>
                    <div class="flex gap-2">
                      <input type="url" id="customerMapUrl" 
                        class="input input-bordered flex-1" 
                        placeholder="https://maps.google.com/..."
                        oninput="extractCoordinatesFromUrl(this.value)">
                      <button type="button" id="btnPasteMapUrl" class="btn btn-info" onclick="pasteMapUrl()">
                        <i class="bi bi-clipboard"></i> ‡∏ß‡∏≤‡∏á
                      </button>
                    </div>
                    <div class="form-hint text-xs text-gray-500 mt-1">
                      <i class="bi bi-link-45deg"></i> 
                      ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Maps ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                    </div>
                  </div>
                  
                  <div class="flex gap-2">
                    <button type="button" id="btnGetCurrentLocation" class="btn btn-success flex-1" onclick="getCurrentLocation()">
                      <i class="bi bi-geo-alt"></i> ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                    <button type="button" id="btnClearCoordinates" class="btn btn-ghost" onclick="clearCoordinates()">
                      <i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á
                    </button>
                  </div>
                  
                  <!-- Coordinates Display -->
                  <div id="coordinatesDisplay" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
                    <div class="flex items-center justify-between mb-2">
                      <h5 class="font-medium flex items-center gap-2">
                        <i class="bi bi-check-circle text-green-600"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
                      </h5>
                      <button type="button" onclick="copyCoordinates()" class="btn btn-xs btn-ghost">
                        <i class="bi bi-clipboard"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                      </button>
                    </div>
                    <p class="text-sm">
                      <strong>Lat:</strong> <span id="displayLatitude">-</span><br>
                      <strong>Lng:</strong> <span id="displayLongitude">-</span>
                    </p>
                  </div>
                </div>
                
                <!-- Map Preview -->
                <div class="space-y-4">
                  <div class="bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden">
                    <div class="bg-gray-200 dark:bg-gray-700 px-4 py-2 flex items-center justify-between">
                      <h5 class="font-medium flex items-center gap-2">
                        <i class="bi bi-map"></i> ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                      </h5>
                      <div class="flex gap-2">
                        <button type="button" id="btnRefreshMap" class="btn btn-xs btn-ghost" onclick="refreshMapPreview()">
                          <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" id="btnFullscreenMap" class="btn btn-xs btn-ghost" onclick="openFullscreenMap()">
                          <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div id="mapContainer" class="h-64 bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
                      <div id="mapPlaceholder" class="text-center text-gray-500">
                        <i class="bi bi-geo-alt text-4xl mb-2 block"></i>
                        <p class="text-sm">‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>
                      </div>
                      
                      <iframe id="mapPreview" 
                        class="w-full h-full border-0 hidden"
                        frameborder="0" 
                        style="border:0" 
                        allowfullscreen="" 
                        aria-hidden="false" 
                        tabindex="0">
                      </iframe>
                    </div>
                  </div>
                  
                  <!-- Map Actions -->
                  <div class="flex gap-2">
                    <button type="button" id="btnOpenInGoogleMaps" class="btn btn-outline flex-1 text-xs" onclick="openInGoogleMaps()" disabled>
                      <i class="bi bi-box-arrow-up-right"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps
                    </button>
                    <button type="button" id="btnShareLocation" class="btn btn-outline text-xs" onclick="shareLocation()" disabled>
                      <i class="bi bi-share"></i> ‡πÅ‡∏ä‡∏£‡πå
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Address Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold flex items-center gap-2">
                  <i class="bi bi-envelope-fill text-purple-600"></i>
                  ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                </h4>
                <button type="button" id="btnCopyMainAddress" onclick="copyMainAddressToContact()" class="btn btn-outline btn-sm">
                  <i class="bi bi-copy"></i> ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                </button>
              </div>
              
              <div class="mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-700">
                <p class="text-sm text-purple-700 dark:text-purple-300 flex items-start gap-2">
                  <i class="bi bi-info-circle-fill text-purple-600 mt-0.5 flex-shrink-0"></i>
                  <span>‡∏´‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span>
                  </label>
                  <input type="text" id="contactHouseNo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</span>
                  </label>
                  <input type="text" id="contactMoo" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ã‡∏≠‡∏¢</span>
                  </label>
                  <input type="text" id="contactSoi" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ã‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ñ‡∏ô‡∏ô</span>
                  </label>
                  <input type="text" id="contactRoad" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏ñ‡∏ô‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
                  </label>
                  <div class="relative">
                    <input type="text" id="contactProvince" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" 
                      autocomplete="off">
                    <div id="contactProvinceDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï</span>
                  </label>
                  <div class="relative">
                    <input type="text" id="contactDistrict" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠" 
                      autocomplete="off">
                    <div id="contactDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á</span>
                  </label>
                  <div class="relative">
                    <input type="text" id="contactSubDistrict" 
                      class="input input-bordered w-full" 
                      placeholder="‡∏ï‡∏≥‡∏ö‡∏•" 
                      autocomplete="off">
                    <div id="contactSubDistrictDropdown" class="dropdown-content absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden">
                      <div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô</div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="label">
                    <span class="label-text font-medium">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</span>
                  </label>
                  <input type="text" id="contactPostalCode" 
                    class="input input-bordered w-full" 
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å" 
                    maxlength="5" 
                    pattern="[0-9]{5}">
                </div>
              </div>
            </div>

            <!-- Document Upload Section -->
            <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
              <h4 class="text-lg font-semibold mb-6 flex items-center gap-2">
                <i class="bi bi-file-earmark-text-fill text-green-600"></i>
                ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
              </h4>
              
              <div class="document-upload-grid">
                <!-- ID Card Photo -->
                <div class="document-upload-card" id="idCardUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-credit-card-2-front text-lg"></i> 
                      ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending" id="idCardStatus">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeIdCard" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadIdCard" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden">
                      <button type="button" id="btnUploadIdCard" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="idCardPreview" class="hidden document-preview">
                      <img id="idCardImage" class="w-full h-32 object-cover rounded">
                    </div>
                  </div>
                </div>

                <!-- Selfie Photo -->
                <div class="document-upload-card" id="selfieUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-person-circle text-lg"></i> 
                      ‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ï‡∏£ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending" id="selfieStatus">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeSelfie" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadSelfie" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden">
                      <button type="button" id="btnUploadSelfie" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="selfiePreview" class="hidden document-preview">
                      <img id="selfieImage" class="w-full h-32 object-cover rounded">
                    </div>
                  </div>
                </div>

                <!-- Salary Slip Upload -->
                <div class="document-upload-card" id="salarySlipUploadCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 flex items-center gap-2">
                      <i class="bi bi-receipt text-lg text-blue-600"></i> 
                      ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </h5>
                    <div class="document-status" id="salarySlipStatus">
                      <span class="status-badge optional">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span>
                    </div>
                  </div>
                  
                  <p class="text-xs text-gray-500 mb-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</p>
                  
                  <div class="space-y-3">
                    <div class="flex gap-2">
                      <button type="button" id="btnTakeSalarySlip" class="btn btn-primary flex-1 text-sm">
                        <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                      </button>
                      <input type="file" id="uploadSalarySlip" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden">
                      <button type="button" id="btnUploadSalarySlip" class="btn btn-outline text-sm">
                        <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                      </button>
                    </div>
                    
                    <div id="salarySlipPreview" class="hidden document-preview">
                      <img id="salarySlipImage" class="w-full h-32 object-cover rounded">
                      <div class="preview-overlay">
                        <div class="preview-actions">
                          <button type="button" id="btnRetakeSalarySlip" class="btn btn-sm btn-outline">
                            <i class="bi bi-arrow-repeat"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                          </button>
                          <button type="button" id="btnPreviewSalarySlip" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> ‡∏î‡∏π‡πÉ‡∏´‡∏ç‡πà
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div class="document-tips text-xs text-gray-500">
                      <i class="bi bi-lightbulb"></i> 
                      ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                    </div>
                  </div>
                </div>

                <!-- Customer Signature -->
                <div class="document-upload-card" id="customerSignatureCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-red-600 flex items-center gap-2">
                      <i class="bi bi-pencil-square text-lg"></i> 
                      ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                      <h6 class="font-medium mb-3 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h6>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20">
                          <input type="radio" id="authMethodSignature" name="customerAuthMethod" value="signature" class="radio radio-primary" checked>
                          <div class="flex items-center gap-2">
                            <i class="bi bi-pen text-blue-600"></i>
                            <span class="text-sm font-medium">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
                          </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-green-50 dark:hover:bg-green-900/20">
                          <input type="radio" id="authMethodFingerprint" name="customerAuthMethod" value="fingerprint" class="radio radio-primary">
                          <div class="flex items-center gap-2">
                            <i class="bi bi-fingerprint text-green-600"></i>
                            <span class="text-sm font-medium">‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</span>
                          </div>
                        </label>
                      </div>
                    </div>

                    <div id="signatureSection" class="signature-auth-section">
                      <div id="customerSignaturePreview" class="signature-preview border rounded-lg p-4 hidden">
                        <img id="customerSignatureImage" src="" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="max-w-full h-auto mx-auto">
                      </div>
                      
                      <div id="customerSignaturePlaceholder" class="signature-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="bi bi-pen text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ô</p>
                      </div>
                      
                      <div class="flex gap-2 mt-3">
                        <button type="button" id="btnOpenCustomerSignature" class="btn btn-primary flex-1 text-sm">
                          <i class="bi bi-pen"></i> ‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                        </button>
                        <button type="button" id="btnRetakeCustomerSignature" class="btn btn-outline flex-1 text-sm hidden">
                          <i class="bi bi-arrow-clockwise"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                      </div>
                    </div>

                    <div id="fingerprintSection" class="fingerprint-auth-section hidden">
                      <div id="customerFingerprintPreview" class="fingerprint-preview border rounded-lg p-4 hidden">
                        <div class="text-center">
                          <i class="bi bi-fingerprint text-6xl text-green-600 mb-2"></i>
                          <p class="text-sm text-green-600 font-medium">‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                        </div>
                      </div>
                      
                      <div id="customerFingerprintPlaceholder" class="fingerprint-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="bi bi-fingerprint text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</p>
                      </div>
                      
                      <div class="flex gap-2 mt-3">
                        <button type="button" id="btnScanFingerprint" class="btn btn-success flex-1 text-sm">
                          <i class="bi bi-fingerprint"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
                        </button>
                        <button type="button" id="btnRetakeFingerprint" class="btn btn-outline flex-1 text-sm hidden">
                          <i class="bi bi-arrow-clockwise"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Salesperson Signature -->
                <div class="document-upload-card" id="salespersonSignatureCard">
                  <div class="document-header">
                    <h5 class="font-semibold mb-2 text-green-600 flex items-center gap-2">
                      <i class="bi bi-person-badge text-lg"></i> 
                      ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ <span class="text-red-500">*</span>
                    </h5>
                    <div class="document-status">
                      <span class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                      <div class="flex items-center gap-2 text-green-700 dark:text-green-300">
                        <i class="bi bi-person-check-fill text-green-600"></i>
                        <span class="text-sm">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="salespersonName" class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></span>
                      </div>
                    </div>
                    
                    <div id="salespersonSignaturePreview" class="signature-preview border rounded-lg p-4 hidden">
                      <img id="salespersonSignatureImage" src="" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢" class="max-w-full h-auto mx-auto">
                    </div>
                    
                    <div id="salespersonSignaturePlaceholder" class="signature-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                      <i class="bi bi-person-badge text-3xl text-gray-400 mb-2"></i>
                      <p class="text-gray-500 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ô</p>
                    </div>
                    
                    <div class="flex gap-2 mt-3">
                      <button type="button" id="btnOpenSalespersonSignature" class="btn btn-success flex-1 text-sm">
                        <i class="bi bi-person-badge"></i> ‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                      </button>
                      <button type="button" id="btnRetakeSalespersonSignature" class="btn btn-outline flex-1 text-sm hidden">
                        <i class="bi bi-arrow-clockwise"></i> ‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- üë• Witness Information Section -->
              <div class="border-t border-gray-200 dark:border-gray-600 pt-6 mb-6">
                <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                  <i class="bi bi-person-plus-fill text-purple-600"></i>
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏ô
                  <span class="text-sm font-normal text-gray-500 ml-2">(‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</span>
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Witness Personal Information -->
                  <div class="space-y-4">
                    <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                      <i class="bi bi-person-vcard"></i>
                      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¢‡∏≤‡∏ô
                    </h5>
                    
                    <!-- Witness Name -->
                    <div class="form-field-container">
                      <label class="form-label required-field" for="witnessFirstName">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ô</label>
                      <input type="text" id="witnessFirstName" name="witnessFirstName" class="form-control" 
                             placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
                      <div class="form-error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ô</div>
                    </div>
                    
                    <!-- Witness Last Name -->
                    <div class="form-field-container">
                      <label class="form-label required-field" for="witnessLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡∏¢‡∏≤‡∏ô</label>
                      <input type="text" id="witnessLastName" name="witnessLastName" class="form-control" 
                             placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                      <div class="form-error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏û‡∏¢‡∏≤‡∏ô</div>
                    </div>
                    
                    <!-- Witness ID Card -->
                    <div class="form-field-container">
                      <label class="form-label required-field" for="witnessIdCard">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</label>
                      <input type="text" id="witnessIdCard" name="witnessIdCard" class="form-control" 
                             placeholder="X-XXXX-XXXXX-XX-X" maxlength="17" 
                             oninput="formatWitnessIdCard(this)" required>
                      <div class="form-error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</div>
                    </div>
                    
                    <!-- Witness Phone -->
                    <div class="form-field-container">
                      <label class="form-label" for="witnessPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏û‡∏¢‡∏≤‡∏ô</label>
                      <input type="tel" id="witnessPhone" name="witnessPhone" class="form-control" 
                             placeholder="0XX-XXX-XXXX" maxlength="12" 
                             oninput="formatWitnessPhone(this)">
                      <div class="form-error-message">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
                    </div>
                    
                    <!-- Witness Relationship -->
                    <div class="form-field-container">
                      <label class="form-label required-field" for="witnessRelationship">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                      <select id="witnessRelationship" name="witnessRelationship" class="form-control" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                        <option value="friend">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</option>
                        <option value="relative">‡∏ç‡∏≤‡∏ï‡∏¥</option>
                        <option value="colleague">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</option>
                        <option value="neighbor">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                      </select>
                      <div class="form-error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                  </div>
                  
                  <!-- Witness Photo Section -->
                  <div class="space-y-4">
                    <h5 class="font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2">
                      <i class="bi bi-camera-fill"></i>
                      ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô
                    </h5>
                    
                    <!-- Witness Photo Upload -->
                    <div class="document-upload-card" id="witnessPhotoCard">
                      <div class="document-header">
                        <h6 class="font-medium text-gray-700 dark:text-gray-300">
                          ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô <span class="text-red-500">*</span>
                        </h6>
                        <span id="witnessPhotoStatus" class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                      </div>
                      
                      <div id="witnessPhotoPreview" class="document-preview hidden">
                        <img id="witnessPhotoImage" src="" alt="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô" class="w-full h-48 object-cover rounded">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700">
                          <p class="text-sm text-gray-600 dark:text-gray-400">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                      </div>
                      
                      <div id="witnessPhotoPlaceholder" class="text-center py-8">
                        <i class="bi bi-person-bounding-box text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 text-sm mb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô</p>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                          <button type="button" id="btnCameraWitnessPhoto" class="btn btn-primary flex-1 text-sm">
                            <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                          </button>
                          <button type="button" id="btnUploadWitnessPhoto" class="btn btn-outline flex-1 text-sm">
                            <i class="bi bi-upload"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                          </button>
                        </div>
                        
                        <input type="file" id="uploadWitnessPhoto" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden">
                      </div>
                      
                      <div id="witnessPhotoActions" class="hidden mt-3 flex gap-2">
                        <button type="button" id="btnRetakeWitnessPhoto" class="btn btn-outline flex-1 text-sm">
                          <i class="bi bi-arrow-clockwise"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button type="button" id="btnDeleteWitnessPhoto" class="btn btn-error flex-1 text-sm">
                          <i class="bi bi-trash"></i> ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                        </button>
                      </div>
                    </div>
                    
                    <!-- Witness ID Card Photo Upload -->
                    <div class="document-upload-card" id="witnessIdCardCard">
                      <div class="document-header">
                        <h6 class="font-medium text-gray-700 dark:text-gray-300">
                          ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô <span class="text-red-500">*</span>
                        </h6>
                        <span id="witnessIdCardStatus" class="status-badge pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                      </div>
                      
                      <div id="witnessIdCardPreview" class="document-preview hidden">
                        <img id="witnessIdCardImage" src="" alt="‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô" class="w-full h-48 object-cover rounded">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700">
                          <p class="text-sm text-gray-600 dark:text-gray-400">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                      </div>
                      
                      <div id="witnessIdCardPlaceholder" class="text-center py-8">
                        <i class="bi bi-credit-card text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 text-sm mb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</p>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                          <button type="button" id="btnCameraWitnessIdCard" class="btn btn-primary flex-1 text-sm">
                            <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                          </button>
                          <button type="button" id="btnUploadWitnessIdCard" class="btn btn-outline flex-1 text-sm">
                            <i class="bi bi-upload"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                          </button>
                        </div>
                        
                        <input type="file" id="uploadWitnessIdCard" accept="image/jpeg,image/jpg,image/png,image/webp" class="hidden">
                      </div>
                      
                      <div id="witnessIdCardActions" class="hidden mt-3 flex gap-2">
                        <button type="button" id="btnRetakeWitnessIdCard" class="btn btn-outline flex-1 text-sm">
                          <i class="bi bi-arrow-clockwise"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button type="button" id="btnDeleteWitnessIdCard" class="btn btn-error flex-1 text-sm">
                          <i class="bi bi-trash"></i> ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Email Automation Section -->
              <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
                <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                  <i class="bi bi-envelope-fill text-blue-600"></i>
                  ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á Gmail
                  <div class="ml-auto">
                    <span id="emailSettingsStatus" class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                      ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </span>
                  </div>
                </h4>
                
                <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-200 dark:border-blue-700">
                  <p class="text-sm text-blue-700 dark:text-blue-300 mb-3 flex items-start gap-2">
                    <i class="bi bi-info-circle-fill text-blue-600 mt-0.5 flex-shrink-0"></i>
                    <span><strong>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á Gmail ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4</span>
                  </p>
                  
                  <div class="text-xs text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-800/30 p-2 rounded">
                    <i class="bi bi-lightbulb-fill"></i> 
                    <strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4
                  </div>
                </div>
                
                <!-- Document Selection Requirement Notice -->
                <div id="documentSelectionNotice" class="mb-4 p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700 rounded-lg">
                  <div class="flex items-start gap-2">
                    <i class="bi bi-exclamation-circle-fill text-orange-600 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-orange-700 dark:text-orange-300">
                      <p class="font-medium">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á Gmail</p>
                      <p class="text-xs mt-1">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏î‡πÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4</p>
                    </div>
                  </div>
                </div>

                <!-- Email Required Notice -->
                <div id="emailRequiredNotice" class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg hidden">
                  <div class="flex items-start gap-2">
                    <i class="bi bi-exclamation-triangle-fill text-yellow-600 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-yellow-700 dark:text-yellow-300">
                      <p class="font-medium">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô</p>
                      <p class="text-xs mt-1">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô Gmail ‡πÑ‡∏î‡πâ</p>
                    </div>
                  </div>
                </div>

                <!-- Document Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <!-- Quotation Document -->
                  <div class="document-email-option" data-document="quotation">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailQuotation" name="emailDocuments" value="quotation" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-file-earmark-text text-blue-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
                        </p>
                        <div class="text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- Invoice Document -->
                  <div class="document-email-option" data-document="invoice">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailInvoice" name="emailDocuments" value="invoice" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-receipt text-orange-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞
                        </p>
                        <div class="text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- Receipt Document -->
                  <div class="document-email-option" data-document="receipt">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailReceipt" name="emailDocuments" value="receipt" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-file-earmark-check text-green-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå
                        </p>
                        <div class="text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>

                  <!-- Tax Invoice Document (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤) -->
                  <div class="document-email-option" data-document="taxInvoice">
                    <label class="flex items-start gap-3 p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                      <input type="checkbox" id="emailTaxInvoice" name="emailDocuments" value="taxInvoice" 
                             class="checkbox checkbox-primary mt-1" onchange="updateEmailDocumentSelection()">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="bi bi-receipt-cutoff text-purple-600 text-lg"></i>
                          <h5 class="font-semibold text-gray-900 dark:text-gray-100">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h5>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                          ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%
                        </p>
                        <div class="text-xs text-purple-600 dark:text-purple-400 flex items-center gap-1">
                          <i class="bi bi-clock"></i>
                          <span>‡∏™‡πà‡∏á‡πÉ‡∏ô Step 4</span>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- Selection Summary -->
                <div id="emailDocumentSummary" class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hidden">
                  <h5 class="font-medium mb-2 flex items-center gap-2">
                    <i class="bi bi-envelope-check"></i> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ó‡∏≤‡∏á Gmail
                  </h5>
                  <div id="selectedDocumentsList" class="space-y-1 text-sm">
                    <!-- Selected documents will be listed here -->
                  </div>
                  <div class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                    <i class="bi bi-info-circle"></i>
                    <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á: <span id="targetEmailDisplay" class="font-medium text-blue-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span></span>
                  </div>
                </div>

                <!-- Email Preview & Test -->
                <div id="emailPreviewSection" class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700 hidden">
                  <div class="flex items-center justify-between mb-3">
                    <h5 class="font-medium flex items-center gap-2 text-blue-800 dark:text-blue-300">
                      <i class="bi bi-eye"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
                    </h5>
                    <button type="button" id="btnTestEmail" class="btn btn-sm btn-outline" onclick="testEmailSettings()">
                      <i class="bi bi-send"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    </button>
                  </div>
                  <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                    <p><strong>‡∏ñ‡∏∂‡∏á:</strong> <span id="emailPreviewTo">customer@email.com</span></p>
                    <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô Pattani</p>
                    <p><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö:</strong> <span id="emailPreviewAttachments">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤, ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Camera Modal -->
  <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 id="cameraModalTitle" class="text-lg font-semibold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</h3>
        <button id="closeCameraModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      
      <div class="relative mb-4">
        <video id="cameraVideo" class="w-full h-64 bg-black rounded-lg object-cover" autoplay muted playsinline></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
      </div>
      
      <div class="flex gap-3 justify-center">
        <button id="capturePhoto" class="btn btn-primary">
          <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
        <button id="retakePhoto" class="btn btn-outline hidden">
          <i class="bi bi-arrow-clockwise"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="confirmPhoto" class="btn btn-success hidden">
          <i class="bi bi-check"></i> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ
        </button>
      </div>
      
      <div id="capturedPreview" class="mt-4 hidden">
        <img id="previewImage" class="w-full h-32 object-cover rounded-lg" />
      </div>
    </div>
  </div>

  <!-- Witness Photo Camera Modal -->
  <div id="witnessPhotoCameraModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏¢‡∏≤‡∏ô</h3>
        <button id="closeWitnessPhotoModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      
      <div class="relative mb-4">
        <video id="witnessPhotoVideo" class="w-full h-64 bg-black rounded-lg object-cover" autoplay muted playsinline></video>
        <canvas id="witnessPhotoCanvas" class="hidden"></canvas>
      </div>
      
      <div class="flex gap-3 justify-center">
        <button id="captureWitnessPhoto" class="btn btn-primary">
          <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
      </div>
    </div>
  </div>

  <!-- Witness ID Card Camera Modal -->
  <div id="witnessIdCardCameraModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">‡∏ñ‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô</h3>
        <button id="closeWitnessIdCardModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      
      <div class="relative mb-4">
        <video id="witnessIdCardVideo" class="w-full h-64 bg-black rounded-lg object-cover" autoplay muted playsinline></video>
        <canvas id="witnessIdCardCanvas" class="hidden"></canvas>
      </div>
      
      <div class="flex gap-3 justify-center">
        <button id="captureWitnessIdCard" class="btn btn-primary">
          <i class="bi bi-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
      </div>
    </div>
  </div>

  <!-- Signature Modal -->
  <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 id="signatureModalTitle" class="text-lg font-semibold">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</h3>
        <button id="closeSignatureModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg text-xl"></i>
        </button>
      </div>
      
      <div class="mb-4">
        <canvas id="signatureModalCanvas" class="border border-gray-300 rounded-lg w-full bg-white cursor-crosshair" width="600" height="250"></canvas>
      </div>
      
      <div class="flex gap-3 justify-center">
        <button id="clearSignature" class="btn btn-outline">
          <i class="bi bi-eraser"></i> ‡∏•‡πâ‡∏≤‡∏á
        </button>
        <button id="saveSignature" class="btn btn-primary">
          <i class="bi bi-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden inputs for storing data -->
  <input type="hidden" id="idCardImageUrl" name="idCardImageUrl" />
  <input type="hidden" id="selfieUrl" name="selfieUrl" />
  <input type="hidden" id="customerSignatureUrl" name="customerSignatureUrl" />
  <input type="hidden" id="customerFingerprintData" name="customerFingerprintData" />
  <input type="hidden" id="salespersonSignatureUrl" name="salespersonSignatureUrl" />
  
  <!-- üë• Hidden inputs for witness data -->
  <input type="hidden" id="witnessPhotoUrl" name="witnessPhotoUrl" />
  <input type="hidden" id="witnessIdCardImageUrl" name="witnessIdCardImageUrl" />
  <input type="hidden" id="witnessData" name="witnessData" />
      
        <!-- Global Data Manager -->
  <script src="/views/pattani/installment/js/global-data-manager.js"></script>
  
  <!-- Receipt & Tax Invoice Integration -->
  <script src="/views/pattani/installment/js/receipt-tax-invoice-integration.js"></script>
  
  <!-- Modular JavaScript Files -->
  <script src="/views/pattani/installment/step2/js/customer-search.js"></script>
  <script src="/views/pattani/installment/step2/js/form-progress.js"></script>
  <script src="/views/pattani/installment/step2/js/document-upload-handler.js"></script>
  <script src="/views/pattani/installment/step2/js/document-manager.js?v=1.1"></script>
  <script src="/views/pattani/installment/step2/js/step2-integration.js"></script>
  
  <!-- Witness Photo Modal Fix -->
  <script src="/views/pattani/installment/step2/js/witness-photo-fix.js"></script>

  <!-- Sidebar JavaScript -->
  <script src="/views/pattani/sidebar/sidebar.js"></script>

  <script>
    // Step 2 Product Loading and Display Functions
    console.log('üîß Step 2: Loading product data and functions...');
    
    // Image URL function to handle duplicate paths
    function getImageUrl(imagePath) {
      if (!imagePath) return '/uploads/Logo2.png';
      if (imagePath.startsWith('http')) return imagePath;
    
      let url = imagePath;
    
      // Debug logging
      console.log('üñºÔ∏è Original image path:', imagePath);
    
      // Convert all backslashes to forward slashes first
      url = url.replace(/\\/g, '/');
    
      // Remove any existing domain or protocol
      url = url.replace(/^https?:\/\/[^\/]+/, '');
    
      // More aggressive cleanup of duplicate path segments
      // Remove multiple consecutive uploads/products segments
      url = url.replace(/(\/?uploads\/products\/)+/g, '/uploads/products/');
      url = url.replace(/(\/?uploads\\products\\)+/g, '/uploads/products/');
      url = url.replace(/(uploads\/products\/)+/g, 'uploads/products/');
    
      // Clean up any remaining duplicates
      url = url.replace(/uploads\/products\/uploads\/products\//g, 'uploads/products/');
      url = url.replace(/\/uploads\/products\/uploads\/products\//g, '/uploads/products/');
    
      // Ensure leading slash
      if (!url.startsWith('/')) {
        url = '/' + url;
      }
    
      // Add uploads/products prefix if not present
      if (!url.startsWith('/uploads/products/')) {
        // Remove any leading slashes before adding the prefix
        url = '/uploads/products/' + url.replace(/^\/+/, '');
      }
    
      // Final cleanup: remove duplicate slashes
      url = url.replace(/\/{2,}/g, '/');
    
      console.log('üñºÔ∏è Cleaned image path:', url);
      return url;
    }
    
    // Initialize global variables if not exists
    function initializeGlobals() {
      if (typeof window.selectedProducts === 'undefined') {
        window.selectedProducts = [];
        console.log('üîß Initialized empty selectedProducts array');
      }
    
      // Try to load from localStorage immediately
      try {
        const cartData = localStorage.getItem('cartData');
        const cartItems = localStorage.getItem('cartItems');
    
        if (cartData) {
          window.selectedProducts = JSON.parse(cartData);
          console.log('üì¶ Loaded products from cartData:', window.selectedProducts.length, 'items');
        } else if (cartItems) {
          window.selectedProducts = JSON.parse(cartItems);
          console.log('üì¶ Loaded products from cartItems:', window.selectedProducts.length, 'items');
        } else {
          // Try alternative storage keys
          const step1Data = localStorage.getItem('step1_selectedProducts');
          const productsData = localStorage.getItem('selectedProducts');
    
          if (step1Data) {
            window.selectedProducts = JSON.parse(step1Data);
            console.log('üì¶ Loaded products from step1_selectedProducts:', window.selectedProducts.length, 'items');
          } else if (productsData) {
            window.selectedProducts = JSON.parse(productsData);
            console.log('üì¶ Loaded products from selectedProducts:', window.selectedProducts.length, 'items');
          }
        }
      } catch (error) {
        console.error('‚ùå Error loading product data:', error);
        window.selectedProducts = [];
      }
    }
    
    // Toast function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer') || document.body;
      const toast = document.createElement('div');
      toast.className = `toast toast-${type} show`;
      toast.innerHTML = `
        <div class="toast-content">
          <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i>
          <span>${message}</span>
            </div>
          `;
    
      toastContainer.appendChild(toast);
    
          setTimeout(() => {
        toast.remove();
          }, 3000);
    }
    
    // Format price function
    function formatPrice(num) {
      return new Intl.NumberFormat('th-TH').format(num);
    }
    
    // Load and display product summary
    function loadProductSummary() {
      const productSummaryDiv = document.getElementById('productSummary');
      const cartCountSpan = document.getElementById('cartCount');
    
      if (!productSummaryDiv || !cartCountSpan) {
        console.warn('Product summary elements not found');
        return;
      }
    
      // Initialize globals first
      initializeGlobals();
    
      // Get current cart data with multiple fallback options
      let products = [];
    
      try {
        const cartData = localStorage.getItem('cartData');
        const cartItems = localStorage.getItem('cartItems');
        const step1Data = localStorage.getItem('step1_selectedProducts');
        const productsData = localStorage.getItem('selectedProducts');
    
        if (cartData && JSON.parse(cartData).length > 0) {
          products = JSON.parse(cartData);
          console.log('üì¶ Using cartData:', products.length, 'items');
        } else if (cartItems && JSON.parse(cartItems).length > 0) {
          products = JSON.parse(cartItems);
          console.log('üì¶ Using cartItems:', products.length, 'items');
        } else if (step1Data && JSON.parse(step1Data).length > 0) {
          products = JSON.parse(step1Data);
          console.log('üì¶ Using step1_selectedProducts:', products.length, 'items');
        } else if (productsData && JSON.parse(productsData).length > 0) {
          products = JSON.parse(productsData);
          console.log('üì¶ Using selectedProducts:', products.length, 'items');
        } else if (window.selectedProducts && window.selectedProducts.length > 0) {
          products = window.selectedProducts;
          console.log('üì¶ Using window.selectedProducts:', products.length, 'items');
        }
      } catch (error) {
        console.error('‚ùå Error parsing product data:', error);
        products = [];
      }
    
      console.log('üì¶ Loading product summary...', { products });
    
      if (!products || products.length === 0) {
        // Debug information
        const debugInfo = {
          cartData: localStorage.getItem('cartData') ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          cartItems: localStorage.getItem('cartItems') ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          step1_selectedProducts: localStorage.getItem('step1_selectedProducts') ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          selectedProducts: localStorage.getItem('selectedProducts') ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
        };
        console.log('üîç Debug localStorage keys:', debugInfo);
    
        productSummaryDiv.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i class="bi bi-cart text-4xl mb-2"></i>
            <p class="font-medium text-red-600 mb-2">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            <p class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Step 1 ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤</p>
            <div class="text-xs text-gray-400 mt-2 p-2 bg-gray-50 rounded">
              ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: cartData (${debugInfo.cartData}), cartItems (${debugInfo.cartItems}), step1_selectedProducts (${debugInfo.step1_selectedProducts}), selectedProducts (${debugInfo.selectedProducts})
            </div>
            <div class="mt-4 space-y-2">
              <button onclick="forceReloadProducts()" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
              </button>
              <br>
              <a href="../step1/step1.html" class="text-blue-600 underline hover:text-blue-800 text-sm">
                ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Step 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
              </a>
            </div>
          </div>
        `;
        cartCountSpan.textContent = '0';
    
        // Show warning toast
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Step 1 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', 'error');
        return;
      }
    
      cartCountSpan.textContent = products.length;
    
      let totalAmount = 0;
      let html = '';
    
      products.forEach((item, index) => {
        const quantity = item.quantity || 1;
        const price = parseFloat(item.downAmount || item.price || item.sellPrice || 0); // ‡πÉ‡∏ä‡πâ downAmount ‡πÅ‡∏ó‡∏ô price
        const subtotal = price * quantity;
        totalAmount += subtotal;
    
        html += `
          <div class="product-item mb-3 p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
            <div class="flex items-start gap-3">
              <div class="w-12 h-12 bg-gray-100 dark:bg-gray-600 rounded-lg flex items-center justify-center text-xs overflow-hidden">
                ${item.image ?
                  `<img src="${getImageUrl(item.image)}" alt="${item.name}" class="w-full h-full object-cover rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` :
                  ''
                }
                <div class="w-full h-full flex items-center justify-center text-gray-500 ${item.image ? 'hidden' : ''}">
                  <i class="bi bi-box"></i>
              </div>
            </div>
              
              <div class="flex-1 min-w-0">
                <h6 class="font-medium text-sm mb-1 line-clamp-2">${item.name || item.productName || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h6>
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mb-2">
                  <span>‡∏£‡∏´‡∏±‡∏™: ${item.code || item.productCode || 'N/A'}</span>
                  ${item.brand ? `<span>‚Ä¢ ${item.brand}</span>` : ''}
                  ${item.imei ? `<span>‚Ä¢ IMEI: ${item.imei}</span>` : ''}
        </div>
                
                ${item.downAmount > 0 || item.downInstallment > 0 || item.downInstallmentCount > 0 ? `
                  <div class="mt-2 bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-xs">
                    <div class="grid grid-cols-4 gap-1 text-center">
                      <div>
                        <div class="text-gray-500">‡∏î‡∏≤‡∏ß‡∏ô‡πå</div>
                        <div class="font-medium text-green-600">‡∏ø${formatPrice(item.downAmount || 0)}</div>
                      </div>
                      <div>
                        <div class="text-gray-500">‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        <div class="font-medium text-purple-600">‡∏ø${formatPrice(item.downInstallment || 0)}</div>
                      </div>
                      <div>
                        <div class="text-gray-500">‡∏á‡∏ß‡∏î</div>
                        <div class="font-medium text-blue-600">${item.downInstallmentCount || 0}</div>
                      </div>
                      <div>
                        <div class="text-gray-500">‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="font-medium text-orange-600">‡∏ø${formatPrice((item.downAmount || 0) + ((item.downInstallment || 0) * (item.downInstallmentCount || 0)))}</div>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                <div class="flex items-center justify-between mt-2">
                  <div class="text-xs">
                    <span class="text-gray-600 dark:text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: </span>
                    <span class="font-medium">${quantity}</span>
                    <span class="text-gray-500 ml-2">√ó ‡∏ø${formatPrice(price)} (‡∏î‡∏≤‡∏ß‡∏ô‡πå)</span>
          </div>
                  <div class="text-right">
                    <div class="font-semibold text-blue-600 dark:text-blue-400">‡∏ø${formatPrice(subtotal)}</div>
              </div>
            </div>
              </div>
            </div>
          </div>
        `;
      });
    
      html += `
        <div class="border-t border-gray-200 dark:border-gray-600 pt-3 mt-3">
          <div class="flex items-center justify-between text-lg font-semibold">
          <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span class="text-blue-600 dark:text-blue-400">‡∏ø${formatPrice(totalAmount)}</span>
        </div>
          <div class="text-xs text-gray-500 dark:text-gray-400 text-right mt-1">
            (${products.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                </div>
              </div>
            `;
    
      productSummaryDiv.innerHTML = html;
      console.log('‚úÖ Product summary loaded successfully');
    }
    
    // Go back to Step 1
    function goToStep1() {
      window.location.href = '../step1/step1.html';
    }
    
    // Force reload products from all possible sources
    function forceReloadProducts() {
      console.log('üîÑ Force reloading products...');
    
      // Clear current data
      window.selectedProducts = [];
    
      // Try to get data from any available source
      const possibleKeys = [
        'cartData',
        'cartItems',
        'step1_selectedProducts',
        'selectedProducts',
        'installment_products',
        'products'
      ];
    
      let foundData = false;
    
      for (const key of possibleKeys) {
        try {
          const data = localStorage.getItem(key);
          if (data) {
            const parsed = JSON.parse(data);
            if (Array.isArray(parsed) && parsed.length > 0) {
              window.selectedProducts = parsed;
              localStorage.setItem('cartData', JSON.stringify(parsed)); // Normalize to cartData
              console.log(`‚úÖ Found products in ${key}:`, parsed.length, 'items');
              foundData = true;
              break;
            }
          }
        } catch (error) {
          console.warn(`‚ùå Error parsing ${key}:`, error);
        }
      }
    
      if (foundData) {
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        loadProductSummary();
      } else {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Step 1', 'error');
        console.log('üîç Available localStorage keys:', Object.keys(localStorage));
        console.log('üîç localStorage contents:', {
          cartData: localStorage.getItem('cartData'),
          cartItems: localStorage.getItem('cartItems'),
          step1_selectedProducts: localStorage.getItem('step1_selectedProducts'),
          selectedProducts: localStorage.getItem('selectedProducts')
        });
      }
    }
    
    async function loadBranchInfo() {
      let js = null;
      let branchCode = null;
      try {
        branchCode = window.BRANCH_CODE;
        if (!branchCode) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å');
        }
        const token = localStorage.getItem('authToken') || '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        js = await res.json();
        if (res.ok && js.success) {
          // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö BRANCH_CODE
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            const branchInfoEl = document.getElementById('branchInfo');
            if (branchInfoEl) {
              branchInfoEl.textContent = `${branch.name} ‚Äî ${branch.address}`;
            }
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
                          document.title = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
              const pageTitleEl = document.getElementById('pageTitle');
              if (pageTitleEl) {
                pageTitleEl.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
              }
    
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown branch info ‡πÉ‡∏ô Receipt Menu
              const dropdownBranchInfo = document.getElementById('dropdownBranchInfo');
              if (dropdownBranchInfo) {
                dropdownBranchInfo.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤: ${branch.name}`;
              }
              return;
            }
        }
        throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`);
      } catch (err) {
        console.error('‚ùå loadBranchInfo error:', err);
        console.error('üîç Available branches:', js?.data?.map(b => ({ code: b.branch_code, name: b.name })) || 'No data');
        document.getElementById('branchInfo').textContent =
          `‡∏™‡∏≤‡∏Ç‡∏≤: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}"`;
    
        // Show available branches for debugging
        if (js?.data) {
          console.log('üìã Available branch codes:', js.data.map(b => b.branch_code));
          showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${branchCode}" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å`, 'error');
        }
      }
    }
    
    
    // ==========================================
    // STEP 2 MAIN INITIALIZATION
    // ==========================================
    async function initializeStep2() {
      console.log('üöÄ Step 2 main initialization');
    
      // Initialize branch info first
      if (window.globalInstallmentManager) {
        window.globalInstallmentManager.initializeBranchInfo();
      }
    
      // Debug localStorage data immediately
      console.log('üîç Step 2 Debug - localStorage check:', {
        cartData: localStorage.getItem('cartData') ? 'Found' : 'Not found',
        cartItems: localStorage.getItem('cartItems') ? 'Found' : 'Not found',
        step1_selectedProducts: localStorage.getItem('step1_selectedProducts') ? 'Found' : 'Not found',
        selectedProducts: localStorage.getItem('selectedProducts') ? 'Found' : 'Not found',
        allKeys: Object.keys(localStorage)
      });
    
      // Load branch info
      await loadBranchInfo();
    
      // Load product summary from localStorage
      loadProductSummary();
    
      // Setup Quick Actions dropdown
      const quickActionsBtn = document.getElementById('quickActionsBtn');
      const quickActionsDropdown = document.getElementById('quickActionsDropdown');
    
      if (quickActionsBtn && quickActionsDropdown) {
        quickActionsBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          quickActionsDropdown.classList.toggle('hidden');
        });
    
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
          quickActionsDropdown.classList.add('hidden');
        });
      }
    
      // Update connection status (similar to step1)
      const connectionStatus = document.getElementById('connectionStatus');
      if (connectionStatus) {
      setTimeout(() => {
          connectionStatus.innerHTML = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
          connectionStatus.className = 'connection-status online text-xs font-medium';
        }, 2000);
      }
    
      // Load salesperson info
      loadSalespersonInfo();
    
      // Force immediate update of salesperson name if element exists
      setTimeout(() => {
        const salespersonEl = document.getElementById('salespersonName');
        if (salespersonEl && (salespersonEl.textContent === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' || salespersonEl.textContent === '')) {
          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å userInfo ‡∏ó‡∏µ‡πà login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
          const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          let salespersonName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢'; // Default fallback
    
          // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: userInfo.name, userInfo.username, userInfo.displayName
          if (userInfo.name && userInfo.name.trim() !== '') {
            salespersonName = userInfo.name.trim();
          } else if (userInfo.username && userInfo.username.trim() !== '') {
            salespersonName = userInfo.username.trim();
          } else if (userInfo.displayName && userInfo.displayName.trim() !== '') {
            salespersonName = userInfo.displayName.trim();
          }
    
          salespersonEl.textContent = salespersonName;
          localStorage.setItem('salespersonName', salespersonName);
          localStorage.setItem('employeeName', salespersonName);
          console.log('üîß Force updated salesperson name to:', salespersonName);
        }
      }, 100);
    
      // Initialize signature components
      initializeSignatureComponents();
    
      // Initialize input event listeners
      initializeInputEventListeners();
    
      console.log('‚úÖ Step 2 main initialization complete');
    }
    
    // LoadingSystem is already available from utils.js
    
    // Input Formatting Functions
    function formatIdCard(input) {
      let value = input.value.replace(/\D/g, ''); // Remove non-digits
      if (value.length > 13) {
        value = value.substring(0, 13);
      }
    
      // Format as X-XXXX-XXXXX-XX-X
      if (value.length >= 1) {
        value = value.replace(/(\d{1})(\d{4})?(\d{5})?(\d{2})?(\d{1})?/, function(match, p1, p2, p3, p4, p5) {
          let result = p1;
          if (p2) result += '-' + p2;
          if (p3) result += '-' + p3;
          if (p4) result += '-' + p4;
          if (p5) result += '-' + p5;
          return result;
        });
      }
    
      input.value = value;
    }
    
    function formatPhoneNumber(input) {
      let value = input.value.replace(/\D/g, ''); // Remove non-digits
      if (value.length > 10) {
        value = value.substring(0, 10);
      }
    
      // Format as XXX-XXX-XXXX or XX-XXXX-XXXX
      if (value.length >= 10) {
        if (value.startsWith('0')) {
          value = value.replace(/(\d{2})(\d{3})(\d{4})/, '$1-$2-$3');
        } else {
          value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        }
      } else if (value.length >= 7) {
        if (value.startsWith('0')) {
          value = value.replace(/(\d{2})(\d{3})(\d+)/, '$1-$2-$3');
      } else {
          value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1-$2-$3');
        }
      } else if (value.length >= 4) {
        if (value.startsWith('0')) {
          value = value.replace(/(\d{2})(\d+)/, '$1-$2');
      } else {
          value = value.replace(/(\d{3})(\d+)/, '$1-$2');
        }
      }
    
      input.value = value;
    }
    
    // Coordinates Functions
    function parseCoordinates(coordinatesStr) {
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "lat,lng" ‡∏´‡∏£‡∏∑‡∏≠ "lat, lng" ‡∏´‡∏£‡∏∑‡∏≠ "lat lng"
      const cleanStr = coordinatesStr.trim();
    
      // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ comma ‡∏´‡∏£‡∏∑‡∏≠ space
      let parts = cleanStr.split(/[,\s]+/).filter(p => p.length > 0);
    
      if (parts.length === 2) {
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);
    
        if (!isNaN(lat) && !isNaN(lng)) {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
            document.getElementById('customerLatitude').value = lat;
            document.getElementById('customerLongitude').value = lng;
            console.log('‚úÖ Parsed coordinates:', {lat, lng});
          } else {
            console.warn('‚ö†Ô∏è Coordinates out of range:', {lat, lng});
          }
          updateCoordinatesDisplay(lat, lng);
      return true;
    }
      }
    
        return false;
      }
    
    function updateCoordinatesDisplay(lat, lng) {
      const display = document.getElementById('coordinatesDisplay');
      const displayLat = document.getElementById('displayLatitude');
      const displayLng = document.getElementById('displayLongitude');
    
      if (lat && lng && displayLat && displayLng) {
        displayLat.textContent = lat.toFixed(7);
        displayLng.textContent = lng.toFixed(7);
        display.classList.remove('hidden');
    
        // Enable map buttons
        document.getElementById('btnOpenInGoogleMaps').disabled = false;
        document.getElementById('btnShareLocation').disabled = false;
      } else {
        display.classList.add('hidden');
        document.getElementById('btnOpenInGoogleMaps').disabled = true;
        document.getElementById('btnShareLocation').disabled = true;
      }
    }
    
    function updateMapPreview() {
      try {
        const lat = document.getElementById('customerLatitude')?.value;
        const lng = document.getElementById('customerLongitude')?.value;
      const mapPreview = document.getElementById('mapPreview');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
    
        if (!mapPreview || !mapPlaceholder) {
          console.warn('‚ö†Ô∏è Map elements not found');
          return;
        }
    
      if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lng);
    
        if (latNum < -90 || latNum > 90) {
          console.error('‚ùå Invalid latitude:', latNum);
          mapPreview.classList.add('hidden');
          mapPlaceholder.classList.remove('hidden');
          mapPlaceholder.innerHTML = '<div class="text-red-500">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á -90 ‡∏ñ‡∏∂‡∏á 90)</div>';
          return;
        }
    
        if (lngNum < -180 || lngNum > 180) {
          console.error('‚ùå Invalid longitude:', lngNum);
          mapPreview.classList.add('hidden');
          mapPlaceholder.classList.remove('hidden');
          mapPlaceholder.innerHTML = '<div class="text-red-500">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á -180 ‡∏ñ‡∏∂‡∏á 180)</div>';
          return;
        }
    
        const apiKey = 'AIzaSyBA0Qs-rHslLghMCAmbLplx_zMNjeY7TZE';
        // ‡πÉ‡∏ä‡πâ place mode ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö center ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const embedUrl = `https://www.google.com/maps/embed/v1/place?key=${apiKey}&q=${latNum},${lngNum}&center=${latNum},${lngNum}&zoom=17&maptype=roadmap`;
    
          console.log('üó∫Ô∏è Loading map with marker at coordinates:', {lat, lng, url: embedUrl});
    
          // Add error handling for iframe load
          mapPreview.onload = function() {
            console.log('‚úÖ Map loaded successfully');
          };
    
          mapPreview.onerror = function() {
            console.error('‚ùå Google Maps failed to load, trying OpenStreetMap fallback');
            if (typeof loadOpenStreetMapFallback === 'function') {
              loadOpenStreetMapFallback(lat, lng);
            }
          };
    
        mapPreview.src = embedUrl;
        mapPreview.classList.remove('hidden');
        mapPlaceholder.classList.add('hidden');
    
          if (typeof updateCoordinatesDisplay === 'function') {
        updateCoordinatesDisplay(parseFloat(lat), parseFloat(lng));
          }
      } else {
          mapPreview.classList.add('hidden');
          mapPlaceholder.classList.remove('hidden');
        }
      } catch (error) {
        console.error('‚ùå Error in updateMapPreview:', error);
      }
    }
    
    // Fallback to OpenStreetMap if Google Maps fails
    function loadOpenStreetMapFallback(lat, lng) {
      const mapPreview = document.getElementById('mapPreview');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
    
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lng);
    
        if (isNaN(latNum) || isNaN(lngNum)) {
          console.error('‚ùå Invalid coordinates for OpenStreetMap:', {lat, lng});
          return;
        }
    
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì bounding box ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö zoom level ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        const delta = 0.005; // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì zoom level 16-17
        const bbox = `${lngNum-delta},${latNum-delta},${lngNum+delta},${latNum+delta}`;
    
        // Use OpenStreetMap iframe with proper parameters
        const osmEmbedUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${latNum},${lngNum}`;
    
        console.log('üåç Loading OpenStreetMap fallback:', osmEmbedUrl);
    
        mapPreview.src = osmEmbedUrl;
        mapPreview.classList.remove('hidden');
        mapPlaceholder.classList.add('hidden');
    
        showToast('‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (OpenStreetMap)', 'info');
      } catch (error) {
        console.error('‚ùå OpenStreetMap fallback also failed:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
        mapPreview.classList.add('hidden');
        mapPlaceholder.classList.remove('hidden');
      }
    }
    
    function extractCoordinatesFromUrl(url) {
      try {
        // Try to extract coordinates from Google Maps URL
      const patterns = [
          /@(-?\d+\.\d+),(-?\d+\.\d+)/,
          /ll=(-?\d+\.\d+),(-?\d+\.\d+)/,
          /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/
      ];
    
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);
    
            document.getElementById('customerCoordinates').value = `${lat}, ${lng}`;
            document.getElementById('customerLatitude').value = lat;
            document.getElementById('customerLongitude').value = lng;
        updateMapPreview();
            return;
          }
        }
      } catch (error) {
        console.error('Error extracting coordinates:', error);
      }
    }
    
    function getCurrentLocation() {
      if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
          function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
    
            document.getElementById('customerCoordinates').value = `${lat}, ${lng}`;
            document.getElementById('customerLatitude').value = lat;
            document.getElementById('customerLongitude').value = lng;
          updateMapPreview();
    
          showToast('‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');
        },
          function(error) {
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
          }
        );
      } else {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 'error');
      }
    }
    
    function clearCoordinates() {
      document.getElementById('customerCoordinates').value = '';
      document.getElementById('customerLatitude').value = '';
      document.getElementById('customerLongitude').value = '';
      document.getElementById('customerMapUrl').value = '';
    
      const mapPreview = document.getElementById('mapPreview');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
      mapPreview.classList.add('hidden');
      mapPlaceholder.classList.remove('hidden');
    
      updateCoordinatesDisplay();
    }
    
    function pasteMapUrl() {
      navigator.clipboard.readText().then(text => {
        document.getElementById('customerMapUrl').value = text;
        extractCoordinatesFromUrl(text);
      }).catch(err => {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏≤‡∏á URL ‡πÑ‡∏î‡πâ', 'error');
      });
    }
    
    function openInGoogleMaps() {
      const lat = document.getElementById('customerLatitude').value;
      const lng = document.getElementById('customerLongitude').value;
    
        if (lat && lng) {
          const url = `https://www.google.com/maps?q=${lat},${lng}`;
          window.open(url, '_blank');
      }
    }
    
    function shareLocation() {
      const lat = document.getElementById('customerLatitude').value;
      const lng = document.getElementById('customerLongitude').value;
    
        if (lat && lng) {
          const url = `https://www.google.com/maps?q=${lat},${lng}`;
    
          if (navigator.share) {
          navigator.share({
            title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                text: `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`,
                url: url
              });
          } else {
          navigator.clipboard.writeText(url).then(() => {
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß', 'success');
          });
        }
      }
    }
    
    function refreshMapPreview() {
      console.log('üîÑ Refreshing map preview...');
    
      // ‡∏•‡∏ö cache ‡∏Ç‡∏≠‡∏á iframe
      const mapPreview = document.getElementById('mapPreview');
      if (mapPreview) {
        const currentSrc = mapPreview.src;
        mapPreview.src = '';
    
        setTimeout(() => {
          updateMapPreview();
          console.log('‚úÖ Map preview refreshed');
        }, 100);
      } else {
        updateMapPreview();
      }
    }
    
    function openFullscreenMap() {
      const lat = document.getElementById('customerLatitude').value;
      const lng = document.getElementById('customerLongitude').value;
    
      if (lat && lng) {
        const url = `https://www.google.com/maps/@${lat},${lng},16z`;
        window.open(url, '_blank');
      }
    }
    
    function copyCoordinates() {
      const lat = document.getElementById('customerLatitude').value;
      const lng = document.getElementById('customerLongitude').value;
    
      if (lat && lng) {
        const coords = `${lat}, ${lng}`;
        navigator.clipboard.writeText(coords).then(() => {
          showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
        });
      }
    }
    
    // Address Dropdown Functions (‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏ï‡∏≥‡∏ö‡∏• ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    const addressData = {
      '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': {
        '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': ['‡∏™‡πÑ‡∏ö', '‡∏ï‡∏∞‡∏•‡∏∏‡∏ö‡∏±‡∏ô', '‡∏Å‡∏£‡∏á‡∏õ‡∏¥‡∏ô‡∏±‡∏á', '‡∏ö‡∏≤‡∏ô‡∏≤', '‡∏≠‡∏ô‡∏á‡∏Ñ‡πå', '‡∏ï‡∏£‡∏±‡∏á', '‡∏î‡∏≤‡∏ô‡∏≤', '‡∏ï‡∏≤‡∏õ‡∏≠', '‡∏ï‡∏∞‡∏•‡∏∏‡πÇ‡∏ö', '‡∏Å‡∏∞‡∏ï‡πâ‡∏≥', '‡∏≠‡∏≤‡∏ô‡∏≤', '‡∏ï‡∏∞‡πÇ‡∏•‡πä‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®'],
        '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å': ['‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å', '‡∏ï‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏∞', '‡∏ï‡∏≤‡πÅ‡∏¢‡∏á', '‡∏ï‡∏≤‡∏Ç‡∏±‡∏ô', '‡∏ö‡∏∑‡∏≠‡∏•‡∏≠', '‡∏ö‡∏≤‡∏£‡∏≤‡πÇ‡∏ï', '‡∏õ‡∏∏‡πÇ‡∏£‡∏á'],
        '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞': ['‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', '‡∏ï‡∏≤‡πÅ‡∏û', '‡∏ï‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏ï‡∏∞‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏ô', '‡∏ö‡∏≤‡πÇ‡∏à', '‡∏õ‡∏∂‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏ô', '‡∏ï‡∏≤‡πÅ‡∏≠']
      },
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    };
    
    function initializeAddressDropdowns() {
      const provinceInput = document.getElementById('province');
      const districtInput = document.getElementById('district');
      const subDistrictInput = document.getElementById('subDistrict');
    
      // Province dropdown
      if (provinceInput) {
        provinceInput.addEventListener('input', function() {
          filterProvinces(this.value);
        });
    
        provinceInput.addEventListener('change', function() {
          updateDistricts(this.value);
          districtInput.value = '';
          subDistrictInput.value = '';
        });
      }
    
      // District dropdown
      if (districtInput) {
        districtInput.addEventListener('input', function() {
          const province = provinceInput.value;
          if (province && addressData[province]) {
            filterDistricts(province, this.value);
          }
        });
    
        districtInput.addEventListener('change', function() {
          const province = provinceInput.value;
          updateSubDistricts(province, this.value);
          subDistrictInput.value = '';
        });
      }
    
      // SubDistrict dropdown
      if (subDistrictInput) {
        subDistrictInput.addEventListener('input', function() {
          const province = provinceInput.value;
          const district = districtInput.value;
          if (province && district && addressData[province] && addressData[province][district]) {
            filterSubDistricts(province, district, this.value);
          }
        });
      }
    }
    
    function filterProvinces(query) {
      const dropdown = document.getElementById('provinceDropdown');
      const provinces = Object.keys(addressData || {});
    
      if (query && query.length > 0) {
        const filtered = provinces.filter(p => p && p.toLowerCase().includes(query.toLowerCase()));
        showDropdownOptions(dropdown, filtered, (province) => {
          document.getElementById('province').value = province;
          dropdown.classList.add('hidden');
          updateDistricts(province);
        });
        dropdown.classList.remove('hidden');
      } else {
        dropdown.classList.add('hidden');
      }
    }
    
    function updateDistricts(province) {
      const districtInput = document.getElementById('district');
      const dropdown = document.getElementById('districtDropdown');
    
      if (addressData[province]) {
        districtInput.disabled = false;
        districtInput.placeholder = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠';
      } else {
        districtInput.disabled = true;
        districtInput.placeholder = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô';
        dropdown.classList.add('hidden');
      }
    }
    
    function filterDistricts(province, query) {
      const dropdown = document.getElementById('districtDropdown');
      const districts = Object.keys(addressData[province] || {});
    
      if (query && query.length > 0) {
        const filtered = districts.filter(d => d && d.toLowerCase().includes(query.toLowerCase()));
        showDropdownOptions(dropdown, filtered, (district) => {
          document.getElementById('district').value = district;
          dropdown.classList.add('hidden');
          updateSubDistricts(province, district);
        });
        dropdown.classList.remove('hidden');
      } else {
        dropdown.classList.add('hidden');
      }
    }
    
    function updateSubDistricts(province, district) {
      const subDistrictInput = document.getElementById('subDistrict');
      const dropdown = document.getElementById('subDistrictDropdown');
    
      if (addressData[province] && addressData[province][district]) {
        subDistrictInput.disabled = false;
        subDistrictInput.placeholder = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•';
      } else {
        subDistrictInput.disabled = true;
        subDistrictInput.placeholder = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô';
        dropdown.classList.add('hidden');
      }
    }
    
    function filterSubDistricts(province, district, query) {
      const dropdown = document.getElementById('subDistrictDropdown');
      const subDistricts = addressData[province] && addressData[province][district] ? addressData[province][district] : [];
    
      if (query && query.length > 0) {
        const filtered = subDistricts.filter(s => s && s.toLowerCase().includes(query.toLowerCase()));
        showDropdownOptions(dropdown, filtered, (subDistrict) => {
          document.getElementById('subDistrict').value = subDistrict;
          dropdown.classList.add('hidden');
        });
        dropdown.classList.remove('hidden');
      } else {
        dropdown.classList.add('hidden');
      }
    }
    
    function showDropdownOptions(dropdown, options, onSelect) {
      dropdown.innerHTML = '';
    
      if (options.length === 0) {
        dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        return;
      }
    
      options.forEach(option => {
        const div = document.createElement('div');
        div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm';
        div.textContent = option;
        div.addEventListener('click', () => onSelect(option));
        dropdown.appendChild(div);
      });
    }
    
    // showToast function already defined above at line 2715
    
    // Salesperson Functions
    function loadSalespersonInfo() {
      const salespersonNameEl = document.getElementById('salespersonName');
    
      if (salespersonNameEl) {
        try {
          // Try to get salesperson info from userInfo only (no more hardcoded values)
          const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          const activeUser = localStorage.getItem('activeUser');
    
          let salespersonName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢'; // Default name

          // Priority order: userInfo, activeUser, default (removed branchInfo.manager)
          if (userInfo.name && userInfo.name.trim() !== '') {
            salespersonName = userInfo.name.trim();
          } else if (userInfo.username && userInfo.username.trim() !== '') {
            salespersonName = userInfo.username.trim();
          } else if (userInfo.displayName && userInfo.displayName.trim() !== '') {
            salespersonName = userInfo.displayName.trim();
          } else if (activeUser && activeUser.trim() !== '' && activeUser !== 'Unknown') {
            salespersonName = activeUser.trim();
          }

          // Ensure proper display name format
          if (salespersonName === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
            salespersonName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
          }
    
          // Update the display element
          salespersonNameEl.textContent = salespersonName;
    
          // Store in localStorage for future use
          localStorage.setItem('salespersonName', salespersonName);
          localStorage.setItem('employeeName', salespersonName);
    
          // Also update any hidden input for salesperson name
          const salespersonInput = document.getElementById('salespersonName');
          if (salespersonInput && salespersonInput.tagName === 'INPUT') {
            salespersonInput.value = salespersonName;
          }
    
          console.log('üìã Salesperson loaded:', salespersonName);
      } catch (error) {
          console.error('Error loading salesperson info:', error);
          salespersonNameEl.textContent = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
        }
      }
    }
    
    function initializeSignatureComponents() {
      // Initialize customer signature pad if available
      const customerSignatureBtn = document.getElementById('btnOpenCustomerSignature');
      const salespersonSignatureBtn = document.getElementById('btnOpenSalespersonSignature');
    
      if (customerSignatureBtn) {
        // Remove any existing listeners first
        customerSignatureBtn.replaceWith(customerSignatureBtn.cloneNode(true));
        // Re-get the element after replacement
        const newCustomerBtn = document.getElementById('btnOpenCustomerSignature');

        newCustomerBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üñ±Ô∏è Customer signature button clicked');

          try {
            // Use document manager instead of enhanced signature manager
            if (window.documentManager && typeof window.documentManager.openSignatureModal === 'function') {
              console.log('üìù Using DocumentManager for customer signature');
              await window.documentManager.openSignatureModal('customer');
            } else {
              console.warn('‚ö†Ô∏è DocumentManager not available, trying fallback');
              // Fallback to enhanced signature manager
              if (!window.enhancedSignatureManager.isInitialized) {
                window.enhancedSignatureManager.init();
              }
              setTimeout(() => {
                window.enhancedSignatureManager.openModal();
              }, 100);
            }
          } catch (error) {
            console.error('‚ùå Error opening customer signature modal:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô', 'error');
          }
        }, { once: false });

        console.log('‚úÖ Customer signature button listener attached');
      }
    
      if (salespersonSignatureBtn) {
        // Remove any existing listeners first
        salespersonSignatureBtn.replaceWith(salespersonSignatureBtn.cloneNode(true));
        // Re-get the element after replacement
        const newSalespersonBtn = document.getElementById('btnOpenSalespersonSignature');
    
        newSalespersonBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üñ±Ô∏è Salesperson signature button clicked');

          try {
            // Use document manager instead of old functions
            if (window.documentManager && typeof window.documentManager.openSignatureModal === 'function') {
              console.log('üìù Using DocumentManager for salesperson signature');
              await window.documentManager.openSignatureModal('salesperson');
            } else {
              console.warn('‚ö†Ô∏è DocumentManager not available, trying fallback');
              // Fallback to old function
              setTimeout(() => {
                window.openSalespersonSignatureModal();
              }, 100);
            }
          } catch (error) {
            console.error('‚ùå Error opening salesperson signature modal:', error);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô', 'error');
          }
        }, { once: false });
    
        console.log('‚úÖ Salesperson signature button listener attached');
      }
    
      // Initialize fingerprint scanner
      const fingerprintBtn = document.getElementById('btnScanFingerprint');
      if (fingerprintBtn) {
        fingerprintBtn.addEventListener('click', function() {
          console.log('Starting fingerprint scan...');
          showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ', 'info');
        });
      }
    }
    
    // Initialize Input Event Listeners
    function initializeInputEventListeners() {
      // ID Card input formatting
      const idCardInput = document.getElementById('customerIdCard');
      if (idCardInput) {
        idCardInput.addEventListener('input', function() {
          formatIdCard(this);
        });
      }
    
      // Phone number input formatting
      const phoneInput = document.getElementById('customerPhone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function() {
          formatPhoneNumber(this);
        });
      }
    
      // Coordinates input parsing
      const coordinatesInput = document.getElementById('customerCoordinates');
      if (coordinatesInput) {
        coordinatesInput.addEventListener('input', function() {
          parseCoordinates(this.value);
        });
    
        coordinatesInput.addEventListener('change', function() {
          updateMapPreview();
        });
      }
    
      // Map URL input
      const mapUrlInput = document.getElementById('customerMapUrl');
      if (mapUrlInput) {
        mapUrlInput.addEventListener('input', function() {
          if (this.value.trim()) {
            extractCoordinatesFromUrl(this.value);
          }
        });
      }
    
      // Map control buttons
      const btnCurrentLocation = document.getElementById('btnCurrentLocation');
      if (btnCurrentLocation) {
        btnCurrentLocation.addEventListener('click', getCurrentLocation);
      }
    
      const btnClearCoordinates = document.getElementById('btnClearCoordinates');
      if (btnClearCoordinates) {
        btnClearCoordinates.addEventListener('click', clearCoordinates);
      }
    
      const btnPasteMapUrl = document.getElementById('btnPasteMapUrl');
      if (btnPasteMapUrl) {
        btnPasteMapUrl.addEventListener('click', pasteMapUrl);
      }
    
      const btnOpenInGoogleMaps = document.getElementById('btnOpenInGoogleMaps');
      if (btnOpenInGoogleMaps) {
        btnOpenInGoogleMaps.addEventListener('click', openInGoogleMaps);
      }
    
      const btnShareLocation = document.getElementById('btnShareLocation');
      if (btnShareLocation) {
        btnShareLocation.addEventListener('click', shareLocation);
      }
    
      const btnRefreshMap = document.getElementById('btnRefreshMap');
      if (btnRefreshMap) {
        btnRefreshMap.addEventListener('click', refreshMapPreview);
      }
    
      const btnFullscreenMap = document.getElementById('btnFullscreenMap');
      if (btnFullscreenMap) {
        btnFullscreenMap.addEventListener('click', openFullscreenMap);
      }
    
      const btnCopyCoordinates = document.getElementById('btnCopyCoordinates');
      if (btnCopyCoordinates) {
        btnCopyCoordinates.addEventListener('click', copyCoordinates);
      }
    
      // Update map preview when page loads if coordinates exist
            setTimeout(() => {
        updateMapPreview();
      }, 1000);
    }
    
    // Note: These functions are now called from the main initialization
    
    // Thailand Address API Functions
    let addressApiData = {
      provinces: [],
      districts: [],
      subDistricts: []
    };
    
    // Load Thailand Address API Data
    async function loadAddressData() {
      try {
            // Try multiple paths for address data
            let response;
            const paths = [
              '/api_province_with_amphure_tambon.json',
              '../../../api_province_with_amphure_tambon.json',
              '../../../../api_province_with_amphure_tambon.json'
            ];
    
            for (const path of paths) {
              try {
                console.log(`üîç Trying to load address data from: ${path}`);
                response = await fetch(path);
                if (response.ok) {
                  console.log(`‚úÖ Successfully loaded address data from: ${path}`);
                  break;
                }
              } catch (err) {
                console.log(`‚ùå Failed to load from: ${path}`);
                continue;
              }
            }
    
            if (!response || !response.ok) {
              console.warn('üìã Using fallback address data');
              // Fallback data for key provinces
              addressApiData.provinces = [
                '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤',
                '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï',
                '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢',
                '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ'
              ].sort();
    
              addressApiData.fullData = [
                { province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', subdistrict: '‡∏™‡πÑ‡∏ö', zipcode: '94000' },
                { province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', subdistrict: '‡∏ï‡∏∞‡∏•‡∏∏‡∏ö‡∏±‡∏ô', zipcode: '94000' },
                { province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', district: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', subdistrict: '‡∏Å‡∏£‡∏á‡∏õ‡∏¥‡∏ô‡∏±‡∏á', zipcode: '94000' },
                { province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', district: '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å', subdistrict: '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å', zipcode: '94170' },
                { province: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', district: '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', subdistrict: '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', zipcode: '94130' }
              ];
    
              showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏Å‡∏±‡∏î)', 'info');
              return;
            }
    
        const data = await response.json();
    
        // Process data for easier searching
        addressApiData.provinces = [...new Set(data.map(item => item.province))].sort();
        addressApiData.fullData = data;
    
      } catch (error) {
        console.error('Error loading address data:', error);
        // Fallback data
        addressApiData.provinces = ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡πå', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏ï‡∏£‡∏±‡∏á', '‡∏ï‡∏£‡∏≤‡∏î', '‡∏ï‡∏≤‡∏Å', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', '‡∏ô‡πà‡∏≤‡∏ô', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡∏û‡∏±‡∏á‡∏á‡∏≤', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡πÅ‡∏û‡∏£‡πà', '‡∏û‡∏±‡∏í‡∏ô‡∏≤', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÄ‡∏•‡∏¢', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏™‡∏ï‡∏π‡∏•', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ'];
      }
    }
    
    // Setup Province Dropdowns
    function setupProvinceDropdown(inputId, dropdownId, districtInputId, subdistrictInputId) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
    
      if (!input || !dropdown) return;
    
      let debounceTimer;
    
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = this.value.toLowerCase();
    
          if (query.length < 1) {
            dropdown.classList.add('hidden');
            return;
          }
    
          const filteredProvinces = addressApiData.provinces.filter(province =>
            province && province.toLowerCase().includes(query.toLowerCase())
          );
    
          if (filteredProvinces.length > 0) {
            dropdown.innerHTML = filteredProvinces.map(province =>
              `<div class="dropdown-item px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectProvince('${inputId}', '${province}', '${districtInputId}', '${subdistrictInputId}')">${province}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
      } else {
            dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div>';
            dropdown.classList.remove('hidden');
          }
        }, 200);
      });
    
      // Hide dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });
    }
    
    // Select Province
    function selectProvince(inputId, provinceName, districtInputId, subdistrictInputId) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(inputId.replace('Province', 'ProvinceDropdown'));
      const districtInput = document.getElementById(districtInputId);
      const subdistrictInput = document.getElementById(subdistrictInputId);
    
      if (input) {
        input.value = provinceName;
        dropdown.classList.add('hidden');
      }
    
      // Clear dependent fields
      if (districtInput) districtInput.value = '';
      if (subdistrictInput) subdistrictInput.value = '';
    
      // Update districts for selected province
      updateDistrictsForProvince(provinceName, districtInputId);
    }
    
    // Update Districts
    function updateDistrictsForProvince(provinceName, districtInputId) {
      if (!addressApiData.fullData) return;
    
      const districts = [...new Set(
        addressApiData.fullData
          .filter(item => item.province === provinceName)
          .map(item => item.district)
      )].sort();
    
      // Store districts for the input
      const districtInput = document.getElementById(districtInputId);
      if (districtInput) {
        districtInput.dataset.districts = JSON.stringify(districts);
        setupDistrictDropdown(districtInputId, provinceName);
      }
    }
    
    // Setup District Dropdown
    function setupDistrictDropdown(districtInputId, provinceName) {
      const districtInput = document.getElementById(districtInputId);
      const dropdownId = districtInputId.replace('District', 'DistrictDropdown');
      const dropdown = document.getElementById(dropdownId);
    
      if (!districtInput || !dropdown) return;
    
      let debounceTimer;
    
      districtInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = this.value.toLowerCase();
          const districts = JSON.parse(this.dataset.districts || '[]');
    
          if (query.length < 1) {
            dropdown.classList.add('hidden');
        return;
      }

          const filteredDistricts = districts.filter(district =>
            district && district.toLowerCase().includes(query.toLowerCase())
          );
    
          if (filteredDistricts.length > 0) {
            dropdown.innerHTML = filteredDistricts.map(district =>
              `<div class="dropdown-item px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectDistrict('${districtInputId}', '${district}', '${provinceName}')">${district}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
          } else {
            dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</div>';
            dropdown.classList.remove('hidden');
          }
        }, 200);
      });
    }
    
    // Select District
    function selectDistrict(districtInputId, districtName, provinceName) {
      const input = document.getElementById(districtInputId);
      const dropdown = document.getElementById(districtInputId.replace('District', 'DistrictDropdown'));
      const subdistrictInputId = districtInputId.replace('District', 'SubDistrict');
      const subdistrictInput = document.getElementById(subdistrictInputId);
    
      if (input) {
        input.value = districtName;
        dropdown.classList.add('hidden');
      }
    
      // Clear subdistrict
      if (subdistrictInput) subdistrictInput.value = '';
    
      // Update subdistricts
      updateSubdistrictsForDistrict(provinceName, districtName, subdistrictInputId);
    }
    
    // Update Subdistricts
    function updateSubdistrictsForDistrict(provinceName, districtName, subdistrictInputId) {
      if (!addressApiData.fullData) return;
    
      const subdistricts = addressApiData.fullData
        .filter(item => item.province === provinceName && item.district === districtName)
        .map(item => ({
          name: item.subdistrict,
          zipcode: item.zipcode
        }))
        .sort((a, b) => a.name.localeCompare(b.name));
    
      const subdistrictInput = document.getElementById(subdistrictInputId);
      if (subdistrictInput) {
        subdistrictInput.dataset.subdistricts = JSON.stringify(subdistricts);
        setupSubdistrictDropdown(subdistrictInputId);
      }
    }
    
    // Setup Subdistrict Dropdown
    function setupSubdistrictDropdown(subdistrictInputId) {
      const subdistrictInput = document.getElementById(subdistrictInputId);
      const dropdownId = subdistrictInputId.replace('SubDistrict', 'SubDistrictDropdown');
      const dropdown = document.getElementById(dropdownId);
    
      if (!subdistrictInput || !dropdown) return;
    
      let debounceTimer;
    
      subdistrictInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const query = this.value.toLowerCase();
          const subdistricts = JSON.parse(this.dataset.subdistricts || '[]');
    
          if (query.length < 1) {
            dropdown.classList.add('hidden');
            return;
          }
    
          const filteredSubdistricts = subdistricts.filter(item =>
            item && item.name && item.name.toLowerCase().includes(query.toLowerCase())
          );
    
          if (filteredSubdistricts.length > 0) {
            dropdown.innerHTML = filteredSubdistricts.map(item =>
              `<div class="dropdown-item px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectSubdistrict('${subdistrictInputId}', '${item.name}', '${item.zipcode}')">${item.name}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
          } else {
            dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•</div>';
            dropdown.classList.remove('hidden');
          }
        }, 200);
      });
    }
    
    // Select Subdistrict
    function selectSubdistrict(subdistrictInputId, subdistrictName, zipcode) {
      const input = document.getElementById(subdistrictInputId);
      const dropdown = document.getElementById(subdistrictInputId.replace('SubDistrict', 'SubDistrictDropdown'));
      const zipcodeInputId = subdistrictInputId.includes('contact') ? 'contactPostalCode' : 'zipcode';
      const zipcodeInput = document.getElementById(zipcodeInputId);
    
      if (input) {
        input.value = subdistrictName;
        dropdown.classList.add('hidden');
      }
    
      // Auto-fill zipcode
      if (zipcodeInput && zipcode) {
        zipcodeInput.value = zipcode;
      }
    }
    
    // Initialize Address Dropdowns
    function initializeAddressDropdowns() {
      // Main address dropdowns
      setupProvinceDropdown('province', 'provinceDropdown', 'district', 'subDistrict');
    
      // Contact address dropdowns
      setupProvinceDropdown('contactProvince', 'contactProvinceDropdown', 'contactDistrict', 'contactSubDistrict');
    
      // Hide dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        const dropdowns = ['provinceDropdown', 'districtDropdown', 'subDistrictDropdown',
                         'contactProvinceDropdown', 'contactDistrictDropdown', 'contactSubDistrictDropdown'];
        dropdowns.forEach(id => {
          const dropdown = document.getElementById(id);
          const input = dropdown?.previousElementSibling;
          if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
            dropdown.classList.add('hidden');
          }
        });
      });
    }
    
    // ==========================================
    // ADDITIONAL FEATURES INITIALIZATION
    // ==========================================
    function initializeAdditionalFeatures() {
      try {
        // Initialize Document Manager with error handling
        try {
          if (typeof DocumentManager !== 'undefined') {
            window.documentManager = new DocumentManager();
            console.log('üìÑ Document Manager initialized successfully');
          } else {
            console.log('‚ÑπÔ∏è DocumentManager class not available');
          }
        } catch (error) {
          console.error('‚ùå Error initializing Document Manager:', error);
        }
    
        // Load address data and initialize dropdowns
        loadAddressData().then(() => {
          console.log('üìç Address data loaded');
        });
    
        // Initialize Customer Search Manager
        if (typeof CustomerSearchManager !== 'undefined' && typeof window.customerSearchManager === 'undefined') {
          const customerSearchManager = new CustomerSearchManager();
          customerSearchManager.initialize();
          window.customerSearchManager = customerSearchManager;
          console.log('‚úÖ Customer Search Manager initialized');
        }
    
        // Initialize Form Progress Manager
        if (typeof FormProgressManager !== 'undefined' && typeof window.formProgressManager === 'undefined') {
          const formProgressManager = new FormProgressManager();
          formProgressManager.initialize();
          window.formProgressManager = formProgressManager;
          console.log('‚úÖ Form Progress Manager initialized');
        }
    
        // Initialize Card Reader System (if available)
        setTimeout(() => {
          if (window.CardReaderConfig && window.CardReaderService) {
            console.log('üîó Card Reader System initialized for installment step 2');
    
            // Set branch code for card reader
            const branchFromURL = new URLSearchParams(window.location.search).get('branch');
            if (branchFromURL && window.CardReaderConfig) {
              // Check if setBranchCode method exists
              if (typeof window.CardReaderConfig.setBranchCode === 'function') {
                window.CardReaderConfig.setBranchCode(branchFromURL);
              } else {
                // Store branch code as property if method doesn't exist
                window.CardReaderConfig.branchCode = branchFromURL;
                console.log('üìç Branch code set as property:', branchFromURL);
              }
            }
    
            // Register card reader handlers
            if (window.CardReaderService && typeof window.CardReaderService.registerHandler === 'function') {
              window.CardReaderService.registerHandler('citizen-card', (data) => {
                console.log('üí≥ Citizen card data received:', data);
                if (data.success && data.citizen) {
                  fillCustomerDataFromCard(data.citizen);
                  showToast('‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
              });
            } else if (window.CardReaderService) {
              console.log('‚ÑπÔ∏è Card reader service available but registerHandler not found');
            }
    
            // Setup card reader buttons if card reader is enabled
            if (window.CardReaderConfig && typeof window.CardReaderConfig.isCardReaderEnabled === 'function') {
              const isEnabled = window.CardReaderConfig.isCardReaderEnabled(branchFromURL || '00000');
              if (isEnabled && typeof setupCardReaderButtons === 'function') {
                setupCardReaderButtons();
              }
            }
          }
        }, 1000);
    
        // Initialize Signature Managers (if not already initialized)
        if (!window.signaturesInitialized) {
          setTimeout(() => {
            console.log('üöÄ Initializing signature managers...');
    
            if (window.enhancedSignatureManager && typeof window.enhancedSignatureManager.loadSavedSignature === 'function') {
              window.enhancedSignatureManager.loadSavedSignature();
              console.log('‚úÖ Enhanced signature manager initialized');
            }
    
            if (window.witnessSignatureManager && typeof window.witnessSignatureManager.loadSavedSignature === 'function') {
              window.witnessSignatureManager.loadSavedSignature();
              console.log('‚úÖ Witness signature manager initialized');
            }
    
            window.signaturesInitialized = true;
          }, 500);
        }
    
      } catch (error) {
        console.error('Error initializing additional features:', error);
      }
    }

    // Make functions globally available
  window.getImageUrl = getImageUrl;
  window.goToStep1 = goToStep1;
  window.forceReloadProducts = forceReloadProducts;
  window.loadProductSummary = loadProductSummary;
  window.formatPrice = formatPrice;
  window.formatIdCard = formatIdCard;
  window.formatPhoneNumber = formatPhoneNumber;
  window.parseCoordinates = parseCoordinates;
    window.updateMapPreview = updateMapPreview;
    window.extractCoordinatesFromUrl = extractCoordinatesFromUrl;
    window.getCurrentLocation = getCurrentLocation;
    window.clearCoordinates = clearCoordinates;
  window.pasteMapUrl = pasteMapUrl;
    window.openInGoogleMaps = openInGoogleMaps;
    window.shareLocation = shareLocation;
  window.refreshMapPreview = refreshMapPreview;
  window.openFullscreenMap = openFullscreenMap;
  window.copyCoordinates = copyCoordinates;
  window.showToast = showToast;
  window.selectProvince = selectProvince;
  window.selectDistrict = selectDistrict;
  window.selectSubdistrict = selectSubdistrict;

  // Initialize occupation dropdown handler
  setTimeout(() => {
    initializeOccupationDropdown();
  }, 100);

  // Function to initialize occupation dropdown
  function initializeOccupationDropdown() {
    const occupationSelect = document.getElementById('customerOccupation');
    const otherField = document.getElementById('otherOccupationField');
    const otherInput = document.getElementById('customerOccupationOther');

    if (occupationSelect && otherField && otherInput) {
      occupationSelect.addEventListener('change', function() {
        if (this.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)') {
          otherField.classList.remove('hidden');
          otherInput.required = true;
          otherInput.focus();
        } else {
          otherField.classList.add('hidden');
          otherInput.required = false;
          otherInput.value = '';
        }
      });

      console.log('‚úÖ Occupation dropdown handler initialized');
    } else {
      console.warn('‚ö†Ô∏è Occupation dropdown elements not found');
    }
  }

  console.log('‚úÖ Step 2 functions loaded');
  </script>

  <!-- Customer Search Manager -->
  <script>
    // Note: Customer Search Manager and Form Progress Manager are initialized in initializeAdditionalFeatures()
    
      // Sync FormProgressManager with Step2Integration
      function syncFormValidation() {
        // Force update form progress after any data change
        if (window.formProgressManager) {
          window.formProgressManager.refresh();
        }
    
        // Update Global Data Manager if available
        if (window.step2Integration) {
          window.step2Integration.saveCustomerData();
        }
      }
    
      // Enhanced event listeners for better synchronization
      function setupSyncEventListeners() {
        // ID Card field with special handling
        const idCardField = document.getElementById('customerIdCard');
        if (idCardField) {
          idCardField.addEventListener('input', function() {
            formatIdCard(this);
            setTimeout(syncFormValidation, 150); // Delay to allow formatting
          });
          idCardField.addEventListener('blur', function() {
            setTimeout(syncFormValidation, 100);
          });
        }
    
        // Phone field with special handling
        const phoneField = document.getElementById('customerPhone');
        if (phoneField) {
          phoneField.addEventListener('input', function() {
            formatPhoneNumber(this);
            setTimeout(syncFormValidation, 150);
          });
          phoneField.addEventListener('blur', function() {
            setTimeout(syncFormValidation, 100);
          });
        }
    
        // All other form fields
        const allFormFields = [
          'customerPrefix', 'customerGender', 'customerFirstName', 'customerLastName', 'customerEmail',
          'customerFacebook', 'customerLineId', 'customerBirthDate', 'customerAge',
          'customerOccupation', 'customerIncome', 'customerWorkplace',
          'houseNo', 'moo', 'soi', 'road', 'province', 'district', 'subDistrict', 'zipcode',
          'contactHouseNo', 'contactMoo', 'contactSoi', 'contactRoad',
          'contactProvince', 'contactDistrict', 'contactSubDistrict', 'contactPostalCode'
        ];
    
        allFormFields.forEach(fieldId => {
          const element = document.getElementById(fieldId);
          if (element) {
            element.addEventListener('input', syncFormValidation);
            element.addEventListener('change', syncFormValidation);
            element.addEventListener('blur', syncFormValidation);
          }
        });
      }
    
      // Initialize sync system
      setTimeout(() => {
        setupSyncEventListeners();
        syncFormValidation(); // Initial sync
        console.log('‚úÖ Form sync system initialized');
      }, 500);

      // Copy main address to contact address function
      window.copyMainAddressToContact = function() {
        // Get main address values
        const mainAddress = {
          houseNo: document.getElementById('houseNo')?.value || '',
          moo: document.getElementById('moo')?.value || '',
          soi: document.getElementById('soi')?.value || '',
          road: document.getElementById('road')?.value || '',
          province: document.getElementById('province')?.value || '',
          district: document.getElementById('district')?.value || '',
          subDistrict: document.getElementById('subDistrict')?.value || '',
          zipcode: document.getElementById('zipcode')?.value || ''
        };
    
        // Set contact address values
        if (document.getElementById('contactHouseNo')) document.getElementById('contactHouseNo').value = mainAddress.houseNo;
        if (document.getElementById('contactMoo')) document.getElementById('contactMoo').value = mainAddress.moo;
        if (document.getElementById('contactSoi')) document.getElementById('contactSoi').value = mainAddress.soi;
        if (document.getElementById('contactRoad')) document.getElementById('contactRoad').value = mainAddress.road;
        if (document.getElementById('contactProvince')) document.getElementById('contactProvince').value = mainAddress.province;
        if (document.getElementById('contactDistrict')) document.getElementById('contactDistrict').value = mainAddress.district;
        if (document.getElementById('contactSubDistrict')) document.getElementById('contactSubDistrict').value = mainAddress.subDistrict;
        if (document.getElementById('contactPostalCode')) document.getElementById('contactPostalCode').value = mainAddress.zipcode;
    
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
    
        // Update form progress
        if (window.formProgressManager) {
          window.formProgressManager.refresh();
        }
      };

      // Email Document Selection Function
      window.updateEmailDocumentSelection = function() {
        try {
          const checkboxes = document.querySelectorAll('input[name="emailDocuments"]:checked');
          const selectedDocuments = Array.from(checkboxes).map(cb => cb.value);
    
          console.log('üìß Selected email documents:', selectedDocuments);
    
          // Update UI to show selection count
          const selectionCount = selectedDocuments.length;
          const summaryElement = document.querySelector('.email-selection-summary');
    
          if (summaryElement) {
            summaryElement.textContent = selectionCount > 0 ?
              `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectionCount} ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£` :
              '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
          }
    
          // Save selection to form data
          const formData = globalDataManager.getStepData(2) || {};
          formData.emailDocuments = selectedDocuments;
          globalDataManager.updateStepData(2, formData);
    
          // Show toast for selection feedback
          if (selectionCount > 0) {
            const documentNames = {
              'quotation': '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
              'invoice': '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
              'receipt': '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à & ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ'
            };
    
            const selectedNames = selectedDocuments.map(doc => documentNames[doc] || doc).join(', ');
            showToast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${selectedNames}`, 'info');
          }
    
        } catch (error) {
          console.error('‚ùå Error updating email document selection:', error);
        }
      };

      // Validation Functions
      window.validateFacebookUrl = function(input) {
        const value = input.value.trim();
        const errorElement = input.parentNode.parentNode.querySelector('.form-error');
        const validationIcon = input.parentNode.querySelector('.validation-icon');
    
        if (!value) {
          if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '';
          }
          return true;
        }
    
        const fbRegex = /^(https?:\/\/)?(www\.)?(facebook|fb)\.com\/.+/i;
        if (!fbRegex.test(value)) {
          if (errorElement) {
            errorElement.textContent = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö URL Facebook ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô facebook.com/username';
            errorElement.classList.remove('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '<i class="bi bi-x-circle text-red-500"></i>';
          }
          return false;
        }
    
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
        if (validationIcon) {
          validationIcon.innerHTML = '<i class="bi bi-check-circle text-green-500"></i>';
        }
        return true;
      };
    
      window.validateLineId = function(input) {
        const value = input.value.trim();
        const errorElement = input.parentNode.parentNode.querySelector('.form-error');
        const validationIcon = input.parentNode.querySelector('.validation-icon');
    
        if (!value) {
          if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '';
          }
          return true;
        }
    
        // Line ID should be alphanumeric, underscore, dot, hyphen (3-20 characters)
        const lineRegex = /^[a-zA-Z0-9._-]{3,20}$/;
        if (!lineRegex.test(value)) {
          if (errorElement) {
            errorElement.textContent = 'Line ID ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 3-20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ a-z, 0-9, _, ., - ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
            errorElement.classList.remove('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '<i class="bi bi-x-circle text-red-500"></i>';
          }
          return false;
        }
    
        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
        if (validationIcon) {
          validationIcon.innerHTML = '<i class="bi bi-check-circle text-green-500"></i>';
        }
        return true;
      };

      // Validate Referral Code Function
      window.validateReferralCode = async function(input) {
        const value = input.value.trim();
        const errorElement = input.parentNode.parentNode.querySelector('.form-error');
        const validationIcon = input.parentNode.querySelector('.validation-icon');
        const statusElement = document.getElementById('referralStatus');
    
        if (!value) {
          if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.add('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '';
          }
          if (statusElement) {
            statusElement.classList.add('hidden');
          }
          return true;
        }
    
        try {
          // Show loading
          if (validationIcon) {
            validationIcon.innerHTML = '<i class="bi bi-hourglass-split text-blue-500"></i>';
          }
          if (statusElement) {
            statusElement.innerHTML = '<i class="bi bi-hourglass-split text-blue-500"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            statusElement.classList.remove('hidden');
          }
    
          // Check if referral code exists
          const response = await fetch(`/api/points/members/search?q=${encodeURIComponent(value)}`);
          const result = await response.json();
    
          if (result.success && result.data.length > 0) {
            const referrer = result.data.find(member => member.memberCode === value);
    
            if (referrer) {
              if (errorElement) {
                errorElement.textContent = '';
                errorElement.classList.add('hidden');
              }
              if (validationIcon) {
                validationIcon.innerHTML = '<i class="bi bi-check-circle text-green-500"></i>';
              }
              if (statusElement) {
                statusElement.innerHTML = `<i class="bi bi-check-circle text-green-500"></i> ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${referrer.name} (${referrer.phone})`;
                statusElement.className = 'form-hint text-xs mt-1 text-green-600';
                statusElement.classList.remove('hidden');
              }
              return true;
            }
          }
    
          // Invalid referral code
          if (errorElement) {
            errorElement.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
            errorElement.classList.remove('hidden');
          }
          if (validationIcon) {
            validationIcon.innerHTML = '<i class="bi bi-x-circle text-red-500"></i>';
          }
          if (statusElement) {
            statusElement.innerHTML = '<i class="bi bi-x-circle text-red-500"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
            statusElement.className = 'form-hint text-xs mt-1 text-red-500';
            statusElement.classList.remove('hidden');
          }
          return false;
    
        } catch (error) {
          console.error('Error validating referral code:', error);
          if (validationIcon) {
            validationIcon.innerHTML = '<i class="bi bi-exclamation-triangle text-yellow-500"></i>';
          }
          if (statusElement) {
            statusElement.innerHTML = '<i class="bi bi-exclamation-triangle text-yellow-500"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ';
            statusElement.className = 'form-hint text-xs mt-1 text-yellow-600';
            statusElement.classList.remove('hidden');
          }
          return true; // Allow form to proceed even if validation fails
        }
      };

      // Initialize Document Manager Integration
      window.addEventListener('load', () => {
        // Connect document manager to form submission
              const btnStep2ToStep3 = document.getElementById('btnStep2ToStep3');
      if (btnStep2ToStep3) {
        btnStep2ToStep3.addEventListener('click', handleStep2ToStep3);
      }
    
      // Handle Generate Quotation PDF button
      const btnGenerateQuotationPDF = document.getElementById('btnGenerateQuotationPDF');
      if (btnGenerateQuotationPDF) {
        btnGenerateQuotationPDF.addEventListener('click', handleGenerateQuotationPDF);
      }
    
        // Setup document validation
        if (window.documentManager) {
          console.log('‚úÖ Document Manager connected to Step 2');
        }
      });
    
      // Handle Step 2 to Step 3 navigation
      function handleStep2ToStep3() {
        console.log('üîÑ Processing Step 2 to Step 3...');
    
        // Validate form completion
        if (window.formProgressManager) {
          const progress = window.formProgressManager.calculateProgress();
          if (progress.required.percentage < 100) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
          }
        }
    
        // Ensure DocumentManager is properly initialized with all required methods
        let documentValidationPassed = false;
    
        if (window.documentManager) {
          // Check if validateDocuments method exists
          if (typeof window.documentManager.validateDocuments !== 'function') {
            console.warn('‚ö†Ô∏è DocumentManager missing validateDocuments method, recreating...');
            try {
              // Force reinitialize DocumentManager
              window.documentManager = new DocumentManager();
              console.log('‚úÖ DocumentManager recreated successfully');
            } catch (error) {
              console.error('‚ùå Failed to recreate DocumentManager:', error);
              window.documentManager = null;
            }
          }
    
          // Try to validate documents
          if (window.documentManager && typeof window.documentManager.validateDocuments === 'function') {
            try {
              const validation = window.documentManager.validateDocuments();
              console.log('üìÑ Document validation result:', validation);
    
              if (!validation.isValid) {
                showToast(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ${validation.missingDocuments.join(', ')}`, 'warning');
                return;
              }
              documentValidationPassed = true;
              console.log('‚úÖ Document validation passed');
            } catch (error) {
              console.error('‚ùå Error during document validation:', error);
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', 'warning');
              documentValidationPassed = true; // Allow to proceed but warn user
            }
          } else {
            console.warn('‚ö†Ô∏è DocumentManager.validateDocuments still not available, skipping document validation');
            documentValidationPassed = true; // Allow to proceed without document validation
          }
        } else {
          console.warn('‚ö†Ô∏è DocumentManager not found, skipping document validation');
          documentValidationPassed = true; // Allow to proceed without document validation
        }
    
        if (!documentValidationPassed) {
          console.log('‚ùå Document validation failed, stopping navigation');
          return;
        }
    
        // Store customer data for step 3
        const customerData = gatherCustomerData();
        localStorage.setItem('step2_customerData', JSON.stringify(customerData));
        console.log('üíæ Customer data stored for step 3');
    
        // Store document data for step 3
        if (window.documentManager && typeof window.documentManager.getDocumentsData === 'function') {
          try {
            const documents = window.documentManager.getDocumentsData();
            localStorage.setItem('step2_documents', JSON.stringify(documents));
            console.log('üìÑ Document data stored:', documents);
          } catch (error) {
            console.error('‚ùå Error getting documents data:', error);
            localStorage.setItem('step2_documents', JSON.stringify({}));
          }
        } else {
          console.warn('‚ö†Ô∏è DocumentManager.getDocumentsData not available, storing empty documents');
          localStorage.setItem('step2_documents', JSON.stringify({}));
        }
    
        showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...', 'success');

        // Show loading before navigation
        showStep2Loading(true);

        // Update Global Data Manager with customer data
        if (window.globalInstallmentManager) {
          try {
            // Store customer data in Global Data Manager format
            const globalCustomerData = {
              customer: {
                prefix: customerData.prefix,
                gender: customerData.gender,
                first_name: customerData.firstName,
                last_name: customerData.lastName,
                phone_number: customerData.phone,
                email: customerData.email,
                birth_date: customerData.birthDate,
                age: customerData.age,
                tax_id: customerData.idCard,
                occupation: customerData.occupation,
                income: customerData.income,
                workplace: customerData.workplace,
                address: {
                  houseNo: customerData.address.houseNo,
                  moo: customerData.address.moo,
                  lane: customerData.address.soi,
                  road: customerData.address.road,
                  subDistrict: customerData.address.subDistrict,
                  district: customerData.address.district,
                  province: customerData.address.province,
                  zipcode: customerData.address.zipcode
                },
                contactAddress: customerData.contactAddress,
                line_id: customerData.lineId,
                facebook: customerData.facebook,
                authMethod: customerData.authMethod,
                coordinates: customerData.coordinates,
                latitude: customerData.latitude,
                longitude: customerData.longitude,
                mapUrl: customerData.mapUrl
              },
              witness: {
                firstName: customerData.witness.firstName,
                lastName: customerData.witness.lastName,
                idCard: customerData.witness.idCard,
                phone: customerData.witness.phone,
                relationship: customerData.witness.relationship
              },
              attachments: {},
              customerType: 'individual'
            };
    
            // Add document data if available
            if (window.documentManager && typeof window.documentManager.getDocumentsData === 'function') {
              try {
                const documents = window.documentManager.getDocumentsData();
                globalCustomerData.attachments = documents;
              } catch (error) {
                console.warn('‚ùå Could not get documents data:', error);
              }
            }
    
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (window.hasDepositStockReservation && window.depositStockReservation) {
              globalCustomerData.stockReservation = window.depositStockReservation;
              globalCustomerData.hasStockReservation = true;
              console.log('üîí Adding stock reservation to step data:', window.depositStockReservation);
            }
    
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å deposit navigation data
            if (window.depositNavigationData) {
              globalCustomerData.depositNavigationData = window.depositNavigationData;
              console.log('üì¶ Adding deposit navigation data to step data');
            }
    
            // Update Step 2 data
            window.globalInstallmentManager.updateStepData(2, globalCustomerData);
    
            // Mark Step 2 as completed
            const isCompleted = window.globalInstallmentManager.completeStep(2);
            if (isCompleted) {
              console.log('‚úÖ Step 2 marked as completed successfully');
            } else {
              console.warn('‚ö†Ô∏è Failed to mark Step 2 as completed');
            }
    
          } catch (error) {
            console.error('‚ùå Error updating Global Data Manager:', error);
          }
        } else {
          console.warn('‚ö†Ô∏è Global Data Manager not available');
        }
    
        // Navigate to step 3 after showing loading animation
        setTimeout(() => {
          window.location.href = '/step3';
        }, 1500);
      }
    
      // Handle Generate Quotation PDF
      async function handleGenerateQuotationPDF() {
        console.log('üìÑ Generating Quotation PDF from Step 2...');
    
        try {
          // Validate form completion first
          if (window.formProgressManager) {
            const progress = window.formProgressManager.calculateProgress();
            if (progress.required.percentage < 100) {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');
              return;
            }
          }
    
          // Show loading
          showStep2Loading(true);
          const btnGenerateQuotationPDF = document.getElementById('btnGenerateQuotationPDF');
          const originalText = btnGenerateQuotationPDF.innerHTML;
          btnGenerateQuotationPDF.disabled = true;
          btnGenerateQuotationPDF.innerHTML = '<i class="bi bi-hourglass-split mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...';
    
          // Collect complete step data
          const stepData = await collectStep2CompleteData();
    
          console.log('üìã Step data collected for quotation PDF:', stepData);
    
          // Call the PDF generation API
          const response = await fetch('/api/pdf/installment/quotation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
            },
            body: JSON.stringify({ stepData })
          });
    
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
    
          // Download the PDF
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `quotation-${Date.now()}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
    
          showToast('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          console.log('‚úÖ Quotation PDF generated and downloaded successfully');
    
          // üîß ENHANCEMENT: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢
          try {
            console.log('üíæ Saving quotation data to database...');
            await saveQuotationToDatabase(stepData);
            showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } catch (saveError) {
            console.error('‚ùå Failed to save quotation to database:', saveError);
            // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
            showToast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà PDF ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'warning');
          }
    
        } catch (error) {
          console.error('‚ùå Error generating quotation PDF:', error);
          showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤: ' + error.message, 'error');
        } finally {
          // Hide loading
          showStep2Loading(false);

          // Reset button
          const btnGenerateQuotationPDF = document.getElementById('btnGenerateQuotationPDF');
          if (btnGenerateQuotationPDF) {
            btnGenerateQuotationPDF.disabled = false;
            btnGenerateQuotationPDF.innerHTML = originalText;
          }
        }
      }

      // üöÄ NEW FUNCTION: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      window.saveQuotationToDatabase = async function(stepData) {
        console.log('üíæ Saving quotation to database with signatures...');
    
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö step4
        const quotationData = {
          date: new Date(),
          branchCode: window.BRANCH_CODE || '00000',
          currency: 'THB',
          creditTerm: '30 ‡∏ß‡∏±‡∏ô',
          vatInclusive: true,
          customer: stepData.step2?.customer || stepData.customer,
          items: (stepData.step1?.products || stepData.products || []).map(item => ({
            productId: item.id || item.productId,
            productName: item.name,
            imei: item.imei || '',
            quantity: parseFloat(item.quantity) || 1,
            unitPrice: parseFloat(item.price) || 0,
            discount: 0,
            amount: (parseFloat(item.quantity) || 1) * (parseFloat(item.price) || 0)
          })),
          summary: {
            subtotal: stepData.paymentData?.subTotal || stepData.paymentData?.totalAmount || 0,
            shipping: 0,
            discount: 0,
            beforeTax: stepData.paymentData?.beforeTaxAmount || stepData.paymentData?.totalAmount || 0,
            tax: stepData.paymentData?.vatAmount || 0,
            netTotal: stepData.paymentData?.totalAmount || 0
          },
          // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á
          customerSignature: stepData.signatures?.customer ||
                            stepData.step2?.signatures?.customer ||
                            localStorage.getItem('customerSignature') || '',
          customerSignatureUrl: stepData.signatures?.customer ||
                               stepData.step2?.signatures?.customer ||
                               localStorage.getItem('customerSignature') || '',
          salespersonSignature: stepData.signatures?.salesperson ||
                               stepData.step2?.signatures?.salesperson ||
                               localStorage.getItem('salespersonSignature') || '',
          salespersonSignatureUrl: stepData.signatures?.salesperson ||
                                  stepData.step2?.signatures?.salesperson ||
                                  localStorage.getItem('salespersonSignature') || '',
          authorizedSignature: stepData.signatures?.authorized ||
                              stepData.step2?.signatures?.authorized ||
                              localStorage.getItem('salespersonSignature') || '',
          authorizedSignatureUrl: stepData.signatures?.authorized ||
                                 stepData.step2?.signatures?.authorized ||
                                 localStorage.getItem('salespersonSignature') || ''
        };

        console.log('üìã Quotation data to save:', {
          ...quotationData,
          customerSignature: quotationData.customerSignature ? 'Present (' + quotationData.customerSignature.substring(0, 30) + '...)' : 'Missing',
          salespersonSignature: quotationData.salespersonSignature ? 'Present (' + quotationData.salespersonSignature.substring(0, 30) + '...)' : 'Missing'
        });

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend
        const saveController = new AbortController();
        const saveTimeoutId = setTimeout(() => saveController.abort(), 15000);
    
        const response = await fetch('/api/quotation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
          },
          body: JSON.stringify(quotationData),
          signal: saveController.signal
        });
    
        clearTimeout(saveTimeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Failed to save quotation: ${response.status} - ${errorText}`);
        }

        const savedQuotation = await response.json();
        console.log('‚úÖ Quotation saved to database:', savedQuotation);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏•‡∏á sessionStorage
        const quotationNumber = savedQuotation.data?.quotationNumber || savedQuotation.quotationNumber;
        const quotationId = savedQuotation.data?._id || savedQuotation._id;
    
        if (quotationNumber) {
          sessionStorage.setItem('currentQuotationNumber', quotationNumber);
          sessionStorage.setItem('savedQuotationId', quotationId);
          console.log('üíæ Quotation info saved to session:', { quotationNumber, quotationId });
        }

        return savedQuotation;
      };
    
      // Collect complete data for PDF generation from Step 2
      async function collectStep2CompleteData() {
        console.log('üìã Collecting complete data from Step 2 for PDF generation...');
    
        // Step 1: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const step1Data = getStep1ProductsForPDF();
    
        // Step 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
        const step2Data = gatherCustomerData();
        const signatures = collectStep2SignatureData();
    
        // Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ default values ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ step3)
        const step3Data = getDefaultStep3Data();
    
        // üîß FIX: ‡∏£‡∏ß‡∏°‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà PDF controllers ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
        const completeData = {
          step1: step1Data,
          step2: { ...step2Data, signatures: signatures },
          step3: step3Data,
          step4: {}, // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• step4
          signatures: signatures, // ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà root level ‡∏î‡πâ‡∏ß‡∏¢
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backward compatibility
          customerSignature: signatures.customerSignature,
          salespersonSignature: signatures.salespersonSignature,
          employeeSignature: signatures.employeeSignature,
          authorizedSignature: signatures.authorizedSignature
        };
    
        console.log('üìã Complete data structure with signatures:', {
          hasStep2Signatures: !!completeData.step2.signatures,
          hasRootSignatures: !!completeData.signatures,
          customerSignature: completeData.signatures.customerSignature ? 'Present' : 'Missing',
          salespersonSignature: completeData.signatures.salespersonSignature ? 'Present' : 'Missing'
        });
    
        return completeData;
      }
    
      function getStep1ProductsForPDF() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å localStorage
        const step1Products = localStorage.getItem('step1_selectedProducts') ||
                             localStorage.getItem('selectedProducts') ||
                             localStorage.getItem('cartItems');
    
        if (step1Products) {
          try {
            return JSON.parse(step1Products);
          } catch (error) {
            console.error('‚ùå Error parsing step1 products:', error);
          }
        }
    
        return [];
      }
    
      function collectStep2SignatureData() {
        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏à‡∏≤‡∏Å localStorage
        return {
          customerSignature: localStorage.getItem('customerSignature') ||
                            localStorage.getItem('step2_signature') ||
                            localStorage.getItem('step2_customerSignature'),
    
          salespersonSignature: localStorage.getItem('salespersonSignature') ||
                               localStorage.getItem('step2_salespersonSignature') ||
                               localStorage.getItem('employeeSignature'),
    
          employeeSignature: localStorage.getItem('employeeSignature') ||
                            localStorage.getItem('salespersonSignature'),
    
          authorizedSignature: localStorage.getItem('salespersonSignature') ||
                              localStorage.getItem('employeeSignature')
        };
      }
    
      function getDefaultStep3Data() {
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö step3 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
        return {
          taxType: 'inclusive', // default ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ
          vatAmount: 0,
          beforeTaxAmount: 0,
          totalWithTax: 0,
          docFee: 500, // ‡∏Ñ‡πà‡∏≤ default ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          doc_fee: 500,
          downPayment: 0,
          installmentCount: 0,
          installmentAmount: 0,
          creditTerm: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
          paymentMethod: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
          shippingFee: 0,
          // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          branchData: getBranchDataFromUrl(),
          salespersonName: getSalespersonNameFromStorage()
        };
      }
    
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å URL
      function getBranchDataFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const branchCode = urlParams.get('branch') || '00000';
        const branchName = urlParams.get('name') || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà';
    
        let branchAddress = '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ';
        if (branchCode === '00000') {
          branchAddress = '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà';
        }
    
        return {
          code: branchCode,
          name: branchName,
          address: branchAddress,
          taxId: '0945566000616',
          tel: '09-2427-0769'
        };
      }
    
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
      function getSalespersonNameFromStorage() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å userInfo ‡∏Å‡πà‡∏≠‡∏ô
        try {
          const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
          if (userInfo.name && userInfo.name.trim() !== '') {
            return userInfo.name.trim();
          }
          if (userInfo.username && userInfo.username.trim() !== '') {
            return userInfo.username.trim();
          }
          if (userInfo.displayName && userInfo.displayName.trim() !== '') {
            return userInfo.displayName.trim();
          }
        } catch (e) {
          console.warn('Error parsing userInfo:', e);
        }
    
        // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        const sources = [
          localStorage.getItem('salespersonName'),
          localStorage.getItem('employeeName'),
          localStorage.getItem('currentUser'),
          localStorage.getItem('userEmail'),
          localStorage.getItem('username'),
          localStorage.getItem('activeUser')
        ];
    
        for (const name of sources) {
          if (name && name !== '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢' && name !== 'Unknown' && name.trim() !== '' && name !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
            return name.trim();
          }
        }
    
        return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢'; // Updated default name
      }
    
      // Gather customer data from form
      function gatherCustomerData() {
        // Get authentication method
        const authMethodRadio = document.querySelector('input[name="customerAuthMethod"]:checked');
        const authMethod = authMethodRadio ? authMethodRadio.value : 'signature';
    
        return {
          prefix: document.getElementById('customerPrefix')?.value || '',
          gender: document.getElementById('customerGender')?.value || '',
          firstName: document.getElementById('customerFirstName')?.value || '',
          lastName: document.getElementById('customerLastName')?.value || '',
          idCard: document.getElementById('customerIdCard')?.value || '',
          phone: document.getElementById('customerPhone')?.value || '',
          email: document.getElementById('customerEmail')?.value || '',
          facebook: document.getElementById('customerFacebook')?.value || '',
          lineId: document.getElementById('customerLineId')?.value || '',
          birthDate: document.getElementById('customerBirthDate')?.value || '',
          age: document.getElementById('customerAge')?.value || '',
          occupation: (() => {
            const occupationSelect = document.getElementById('customerOccupation')?.value || '';
            const occupationOther = document.getElementById('customerOccupationOther')?.value || '';
            return occupationSelect === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)' ? occupationOther : occupationSelect;
          })(),
          income: document.getElementById('customerIncome')?.value || '',
          workplace: document.getElementById('customerWorkplace')?.value || '',
          authMethod: authMethod,
          // Address data
          address: {
            houseNo: document.getElementById('houseNo')?.value || '',
            moo: document.getElementById('moo')?.value || '',
            soi: document.getElementById('soi')?.value || '',
            road: document.getElementById('road')?.value || '',
            province: document.getElementById('province')?.value || '',
            district: document.getElementById('district')?.value || '',
            subDistrict: document.getElementById('subDistrict')?.value || '',
            zipcode: document.getElementById('zipcode')?.value || ''
          },
          // Contact address
          contactAddress: {
            houseNo: document.getElementById('contactHouseNo')?.value || '',
            moo: document.getElementById('contactMoo')?.value || '',
            soi: document.getElementById('contactSoi')?.value || '',
            road: document.getElementById('contactRoad')?.value || '',
            province: document.getElementById('contactProvince')?.value || '',
            district: document.getElementById('contactDistrict')?.value || '',
            subDistrict: document.getElementById('contactSubDistrict')?.value || '',
            zipcode: document.getElementById('contactPostalCode')?.value || ''
          },
          // Coordinates
          coordinates: document.getElementById('customerCoordinates')?.value || '',
          latitude: document.getElementById('customerLatitude')?.value || '',
          longitude: document.getElementById('customerLongitude')?.value || '',
          mapUrl: document.getElementById('customerMapUrl')?.value || '',
          // Email documents
          emailDocuments: Array.from(document.querySelectorAll('input[name="emailDocuments"]:checked')).map(cb => cb.value),
          // Witness data
          witness: {
            firstName: document.getElementById('witnessFirstName')?.value || '',
            lastName: document.getElementById('witnessLastName')?.value || '',
            idCard: document.getElementById('witnessIdCard')?.value || '',
            phone: document.getElementById('witnessPhone')?.value || '',
            relationship: document.getElementById('witnessRelationship')?.value || ''
          },
          // Signatures - prefer server URLs over base64
          customerSignature: document.getElementById('customerSignatureUrl')?.value ||
                            localStorage.getItem('customerSignature_url') ||
                            localStorage.getItem('customerSignature') || '',
          salespersonSignature: document.getElementById('salespersonSignatureUrl')?.value ||
                               localStorage.getItem('salespersonSignature_url') ||
                               localStorage.getItem('salespersonSignature') || '',
          timestamp: new Date().toISOString()
        };
      }

      // Debug localStorage for troubleshooting
      console.log('üîç Current localStorage keys:', Object.keys(localStorage));
      console.log('üîç cartData:', localStorage.getItem('cartData'));
      console.log('üîç step1_selectedProducts:', localStorage.getItem('step1_selectedProducts'));
      console.log('üîç selectedProducts:', localStorage.getItem('selectedProducts'));
    
      // Global debug function for form validation
      window.debugFormValidation = function() {
        console.log('=== FORM VALIDATION DEBUG ===');
    
        // Check FormProgressManager
        if (window.formProgressManager) {
          console.log('üìä FormProgressManager Status:');
          window.formProgressManager.debugFieldValues();
        } else {
          console.log('‚ùå FormProgressManager not found');
        }
    
        // Check Step2Integration
        if (window.step2Integration) {
          console.log('üîß Step2Integration Status:');
          console.log(window.step2Integration.debug());
        } else {
          console.log('‚ùå Step2Integration not found');
        }
    
        // Check Global Data Manager
        if (window.globalInstallmentManager) {
          console.log('üåê Global Data Manager Status:');
          console.log('Step 2 data:', window.globalInstallmentManager.getStepData(2));
          console.log('Step 2 validation:', window.globalInstallmentManager.validateStep(2));
          console.log('Validation errors:', window.globalInstallmentManager.getValidationErrors(2));
        } else {
          console.log('‚ùå Global Data Manager not found');
        }
    
        // Manual field check
        console.log('üîç Manual Field Check:');
        const idCard = document.getElementById('customerIdCard');
        if (idCard) {
          const digits = idCard.value.replace(/\D/g, '');
          console.log(`ID Card: "${idCard.value}" -> digits: "${digits}" (${digits.length} chars)`);
        }
    
        console.log('=== END DEBUG ===');
      };
    
      // Function to clear all validation errors and force revalidation
      window.fixValidation = function() {
        console.log('üîß Fixing validation issues...');
    
        // Clear all errors from Step2Integration
        if (window.step2Integration) {
          window.step2Integration.clearAllErrors();
          setTimeout(() => {
            window.step2Integration.revalidateAllFields();
          }, 100);
        }
    
        // Refresh FormProgressManager
        if (window.formProgressManager) {
          setTimeout(() => {
            window.formProgressManager.refresh();
          }, 200);
        }
    
        // Sync with Global Data Manager
        setTimeout(() => {
          syncFormValidation();
        }, 300);
    
        console.log('‚úÖ Validation fix attempted. Check progress bar in 1 second.');
      };
    
      // Function to ensure DocumentManager is properly initialized
      window.ensureDocumentManager = function() {
        console.log('üîß Ensuring Document Manager initialization...');
    
        if (!window.documentManager) {
          console.log('üìÑ Creating new Document Manager instance...');
          try {
            window.documentManager = new DocumentManager();
            console.log('‚úÖ Document Manager created successfully');
          } catch (error) {
            console.error('‚ùå Failed to create Document Manager:', error);
            return false;
          }
        }
    
        // Test essential methods
        const requiredMethods = ['validateDocuments', 'getDocumentsData', 'isDocumentationComplete'];
        const missingMethods = requiredMethods.filter(method =>
          typeof window.documentManager[method] !== 'function'
        );
    
        if (missingMethods.length > 0) {
          console.error('‚ùå Document Manager missing methods:', missingMethods);
          console.log('üîÑ Attempting to recreate Document Manager...');
    
          try {
            // Force recreate with fresh instance
            window.documentManager = new DocumentManager();
    
            // Check again after recreation
            const stillMissingMethods = requiredMethods.filter(method =>
              typeof window.documentManager[method] !== 'function'
            );
    
            if (stillMissingMethods.length > 0) {
              console.error('‚ùå Still missing methods after recreation:', stillMissingMethods);
              console.log('Available methods:', Object.getOwnPropertyNames(window.documentManager));
              return false;
            } else {
              console.log('‚úÖ Document Manager recreated successfully with all methods');
            }
          } catch (error) {
            console.error('‚ùå Failed to recreate Document Manager:', error);
            return false;
          }
        }
    
        console.log('‚úÖ Document Manager fully functional');
        console.log('Available methods:', Object.getOwnPropertyNames(window.documentManager).filter(name => typeof window.documentManager[name] === 'function'));
        return true;
      };
    
      // Function to debug document validation
      window.debugDocuments = function() {
        console.log('=== DOCUMENT VALIDATION DEBUG ===');
    
        if (!window.documentManager) {
          console.log('‚ùå Document Manager not found');
          console.log('üí° Try running: ensureDocumentManager()');
          return;
        }
    
        try {
          console.log('üìÑ Document Manager Status:');
          console.log('  Instance:', !!window.documentManager);
          console.log('  Methods:', {
            validateDocuments: typeof window.documentManager.validateDocuments,
            getDocumentsData: typeof window.documentManager.getDocumentsData,
            isDocumentationComplete: typeof window.documentManager.isDocumentationComplete
          });
    
          const validation = window.documentManager.validateDocuments();
          console.log('üìã Validation Result:', validation);
    
          const documentsData = window.documentManager.getDocumentsData();
          console.log('üìÅ Documents Data:', documentsData);
    
          const isComplete = window.documentManager.isDocumentationComplete();
          console.log('‚úÖ Documentation Complete:', isComplete);
    
        } catch (error) {
          console.error('‚ùå Error in document debugging:', error);
        }
    
        console.log('=== END DOCUMENT DEBUG ===');
      };
    
      // Function to debug Global Data Manager step completion
      window.debugStepCompletion = function() {
        console.log('=== STEP COMPLETION DEBUG ===');
    
        if (!window.globalInstallmentManager) {
          console.log('‚ùå Global Data Manager not found');
          console.log('üí° Try refreshing the page');
          return;
        }
    
        try {
          console.log('üåê Global Data Manager Status:');
          console.log('  Current Step:', window.globalInstallmentManager.currentStep);
          console.log('  Is Initialized:', window.globalInstallmentManager.isInitialized);
    
          for (let i = 1; i <= 4; i++) {
            const isCompleted = window.globalInstallmentManager.isStepCompleted(i);
            const canNavigate = window.globalInstallmentManager.canNavigateToStep(i);
            const stepData = window.globalInstallmentManager.getStepData(i);
    
            console.log(`Step ${i}:`, {
              completed: isCompleted,
              canNavigate: canNavigate,
              hasData: !!stepData,
              dataKeys: stepData ? Object.keys(stepData) : []
            });
          }
    
          const nextStep = window.globalInstallmentManager.getNextStep();
          console.log('Next Step:', nextStep);
    
          console.log('Can navigate to Step 3:', window.globalInstallmentManager.canNavigateToStep(3));
    
        } catch (error) {
          console.error('‚ùå Error in step completion debugging:', error);
        }
    
        console.log('=== END STEP DEBUG ===');
      };
    
      // Function to force mark Step 2 as completed for troubleshooting
      window.forceCompleteStep2 = function() {
        console.log('üîß Force completing Step 2...');
    
        if (!window.globalInstallmentManager) {
          console.log('‚ùå Global Data Manager not found');
          return false;
        }
    
        try {
          // Gather current form data
          const customerData = gatherCustomerData();
    
          // Store in Global Data Manager format
          const globalCustomerData = {
            customer: {
              prefix: customerData.prefix,
              gender: customerData.gender,
              first_name: customerData.firstName,
              last_name: customerData.lastName,
              phone_number: customerData.phone,
              email: customerData.email,
              line_id: customerData.lineId,
              facebook: customerData.facebook,
              birth_date: customerData.birthDate,
              age: customerData.age,
              tax_id: customerData.idCard,
              occupation: customerData.occupation,
              income: customerData.income,
              workplace: customerData.workplace,
              address: customerData.address,
              contactAddress: customerData.contactAddress,
              authMethod: customerData.authMethod,
              coordinates: customerData.coordinates,
              latitude: customerData.latitude,
              longitude: customerData.longitude,
              mapUrl: customerData.mapUrl
            },
            attachments: {},
            customerType: 'individual'
          };
    
          // Update Step 2 data
          window.globalInstallmentManager.updateStepData(2, globalCustomerData);
    
          // Force complete Step 2
          const isCompleted = window.globalInstallmentManager.completeStep(2);
    
          if (isCompleted) {
            console.log('‚úÖ Step 2 force completed successfully!');
            console.log('üéØ You can now navigate to Step 3');
            return true;
          } else {
            console.error('‚ùå Failed to force complete Step 2');
            return false;
          }
    
        } catch (error) {
          console.error('‚ùå Error force completing Step 2:', error);
          return false;
        }
      };
    
      // Auto-ensure Document Manager on page load
      setTimeout(() => {
        ensureDocumentManager();
      }, 1000);
    
      // Immediate fix for current session
      setTimeout(() => {
        console.log('üö® IMMEDIATE FIX: Checking DocumentManager status...');
    
        if (!window.documentManager) {
          console.log('üîß DocumentManager not found, creating...');
          try {
            window.documentManager = new DocumentManager();
            console.log('‚úÖ DocumentManager created');
          } catch (error) {
            console.error('‚ùå Failed to create DocumentManager:', error);
          }
        }
    
        if (window.documentManager && typeof window.documentManager.validateDocuments !== 'function') {
          console.log('üîß validateDocuments method missing, fixing...');
    
          // Show current instance details for debugging
          console.log('Current instance methods:', Object.getOwnPropertyNames(window.documentManager));
          console.log('Constructor name:', window.documentManager.constructor.name);
    
          try {
            // Force recreate
            window.documentManager = new DocumentManager();
            console.log('‚úÖ DocumentManager recreated for immediate fix');
    
            // Verify fix
            if (typeof window.documentManager.validateDocuments === 'function') {
              console.log('üéâ validateDocuments method now available!');
            } else {
              console.error('‚ùå validateDocuments still missing after recreation');
            }
          } catch (error) {
            console.error('‚ùå Immediate fix failed:', error);
          }
        } else if (window.documentManager) {
          console.log('‚úÖ DocumentManager already working correctly');
        }
      }, 2000);
    
      // Instructions for users
      console.log('üí° ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô:');
      console.log('   - debugFormValidation() = ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
      console.log('   - fixValidation() = ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
      console.log('   - debugDocuments() = ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
      console.log('   - ensureDocumentManager() = ‡∏™‡∏£‡πâ‡∏≤‡∏á Document Manager ‡πÉ‡∏´‡∏°‡πà');
      console.log('   - quickFixDocumentManager() = ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô validateDocuments error');
      console.log('   - debugStepCompletion() = ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô step');
      console.log('   - forceCompleteStep2() = ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ Step 2 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö)');
      console.log('   - fixStep3Redirect() = ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Step 3 (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥!)');
    
              // Quick fix function for immediate use
        window.quickFixDocumentManager = function() {
          console.log('üö® QUICK FIX: Resolving validateDocuments error...');
    
          try {
            // Force recreate DocumentManager
            console.log('üîÑ Recreating DocumentManager...');
            window.documentManager = new DocumentManager();
    
            // Wait for initialization
            setTimeout(() => {
              if (typeof window.documentManager.validateDocuments === 'function') {
                console.log('‚úÖ SUCCESS: validateDocuments method is now available!');
                console.log('üéØ You can now click "‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" button safely');
    
                // Test the method
                try {
                  const testResult = window.documentManager.validateDocuments();
                  console.log('üìã Test validation result:', testResult);
                } catch (error) {
                  console.error('‚ùå Test validation failed:', error);
                }
              } else {
                console.error('‚ùå FAILED: validateDocuments method still not available');
                console.log('Available methods:', Object.getOwnPropertyNames(window.documentManager));
              }
            }, 500);
    
          } catch (error) {
            console.error('‚ùå Quick fix failed:', error);
            console.log('üí° Try refreshing the page or check if document-manager.js is loaded properly');
          }
        };
    
        // Ultimate fix for Step 3 redirect issue
        window.fixStep3Redirect = function() {
          console.log('üö® ULTIMATE FIX: Solving Step 3 redirect issue...');
    
          try {
            // 1. Fix DocumentManager
            if (!window.documentManager || typeof window.documentManager.validateDocuments !== 'function') {
              console.log('üîß Fixing DocumentManager...');
              window.documentManager = new DocumentManager();
            }
    
            // 2. Force complete Step 2
            console.log('üîß Force completing Step 2...');
            const step2Completed = forceCompleteStep2();
    
            if (step2Completed) {
              // 3. Verify step completion
              console.log('üîç Verifying step completion...');
              const canNavigateToStep3 = window.globalInstallmentManager.canNavigateToStep(3);
              console.log('Can navigate to Step 3:', canNavigateToStep3);
    
              if (canNavigateToStep3) {
                console.log('üéâ SUCCESS! You can now navigate to Step 3 without redirect');
                console.log('üéØ Try clicking the "‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" button again');
                return true;
              } else {
                console.log('‚ùå Still cannot navigate to Step 3. Checking details...');
                debugStepCompletion();
                return false;
              }
            } else {
              console.log('‚ùå Failed to complete Step 2');
              return false;
            }
    
          } catch (error) {
            console.error('‚ùå Ultimate fix failed:', error);
            console.log('üí° Try refreshing the page and filling the form again');
            return false;
          }
        };
    
      console.log('üéâ Step 2 initialization completed successfully!');
    
      // === ENHANCED SIGNATURE MANAGEMENT SYSTEM ===
      window.enhancedSignatureManager = {
        canvas: null,
        ctx: null,
        signaturePad: null,
        isInitialized: false,
        isDrawing: false,
    
        init() {
          if (this.isInitialized) return true;
    
          this.canvas = document.getElementById('signatureModalCanvas');
          if (!this.canvas) {
            console.error('Signature canvas not found');
            return false;
          }
    
          // Initialize SignaturePad if available
          if (window.SignaturePad) {
            this.signaturePad = new SignaturePad(this.canvas, {
              backgroundColor: 'rgb(255, 255, 255)',
              penColor: 'rgb(0, 0, 0)',
              velocityFilterWeight: 0.7,
              minWidth: 0.5,
              maxWidth: 2.5,
              throttle: 16,
              minPointDistance: 3
            });
          } else {
            // Fallback to basic canvas
            this.ctx = this.canvas.getContext('2d');
            this.setupBasicCanvas();
            this.bindBasicEvents();
          }
    
          this.bindModalEvents();
          this.isInitialized = true;
          return true;
        },
    
        setupBasicCanvas() {
          // Use the canvas dimensions from HTML attributes
          const canvasWidth = this.canvas.width;
          const canvasHeight = this.canvas.height;

          // Set canvas size in pixels (for high DPI displays)
          this.canvas.width = canvasWidth * 2;
          this.canvas.height = canvasHeight * 2;
          this.ctx.scale(2, 2);

          this.ctx.lineCap = 'round';
          this.ctx.lineJoin = 'round';
          this.ctx.strokeStyle = '#000000';
          this.ctx.lineWidth = 2;
          this.ctx.fillStyle = '#ffffff';
          this.ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        },
    
        bindBasicEvents() {
          if (!this.canvas || !this.ctx) return;

          // Mouse events
          this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
          this.canvas.addEventListener('mousemove', (e) => this.draw(e));
          this.canvas.addEventListener('mouseup', () => this.stopDrawing());
          this.canvas.addEventListener('mouseout', () => this.stopDrawing());

          // Touch events
          this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.startDrawing(e.touches[0]);
          });
          this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.draw(e.touches[0]);
          });
          this.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.stopDrawing();
          });
        },

        startDrawing(e) {
          this.isDrawing = true;
          const rect = this.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (600 / rect.width);
          const y = (e.clientY - rect.top) * (250 / rect.height);

          this.ctx.beginPath();
          this.ctx.moveTo(x, y);
        },

        draw(e) {
          if (!this.isDrawing) return;

          const rect = this.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (600 / rect.width);
          const y = (e.clientY - rect.top) * (250 / rect.height);

          this.ctx.lineTo(x, y);
          this.ctx.stroke();
        },

        stopDrawing() {
          this.isDrawing = false;
        },
    
        bindModalEvents() {
          // Close modal
          const closeBtn = document.getElementById('closeSignatureModal');
          if (closeBtn) {
            closeBtn.onclick = () => this.closeModal();
          }
    
          // Clear signature
          const clearBtn = document.getElementById('clearSignature');
          if (clearBtn) {
            clearBtn.onclick = () => this.clear();
          }
    
          // Save signature
          const saveBtn = document.getElementById('saveSignature');
          if (saveBtn) {
            saveBtn.onclick = () => this.save();
          }
        },
    
        openModal() {
          const modal = document.getElementById('signatureModal');
          if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
              if (!this.isInitialized) {
                this.init();
              }
            }, 100);
          }
        },
    
        closeModal() {
          const modal = document.getElementById('signatureModal');
          if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }
        },
    
        clear() {
          if (this.signaturePad) {
            this.signaturePad.clear();
          } else if (this.ctx) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          }
        },
    
        isEmpty() {
          if (this.signaturePad) {
            return this.signaturePad.isEmpty();
          } else if (this.ctx) {
            const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
            return !imageData.data.some(channel => channel !== 0);
          }
          return true;
        },
    
        getSignatureData() {
          if (this.isEmpty()) {
            return null;
          }
    
          if (this.signaturePad) {
            return this.signaturePad.toDataURL('image/png');
          } else if (this.canvas) {
            return this.canvas.toDataURL('image/png');
          }
          return null;
        },
    
        async save() {
          const signatureData = this.getSignatureData();
          if (!signatureData) {
            if (typeof showToast === 'function') {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
            }
            return;
          }
    
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          const salespersonSignature = localStorage.getItem('salespersonSignature') || localStorage.getItem('step2_salespersonSignature');
          if (signatureData === salespersonSignature) {
            if (typeof showToast === 'function') {
              showToast('‚ö†Ô∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà', 'warning');
            }
            console.warn('üö® Rejected identical signature for customer');
            return;
          }
    
          console.log('‚úÖ Saving unique customer signature');
          console.log('üìù Signature length:', signatureData.length);
          console.log('üîç First 100 chars:', signatureData.substring(0, 100));
    
          try {
            // Upload to server first
            const serverUrl = await uploadImageToServer('customerSignature', signatureData);
            console.log('üåê Customer signature uploaded to server:', serverUrl);
    
            // Save both base64 and server URL
            localStorage.setItem('customerSignature', signatureData); // Keep base64 for preview
            localStorage.setItem('customerSignature_url', serverUrl); // Store server URL
            localStorage.setItem('step2_signature', signatureData);
    
            // Update hidden input with server URL
            const hiddenInput = document.getElementById('customerSignatureUrl');
            if (hiddenInput) {
              hiddenInput.value = serverUrl; // Use server URL in form
            }
    
          } catch (error) {
            console.warn('‚ö†Ô∏è Server upload failed for customer signature, using base64:', error);
    
            // Fallback to localStorage only
            localStorage.setItem('customerSignature', signatureData);
            localStorage.setItem('step2_signature', signatureData);
    
            const hiddenInput = document.getElementById('customerSignatureUrl');
            if (hiddenInput) {
              hiddenInput.value = signatureData; // Fallback to base64
            }
          }
    
          // Update global step manager
          if (window.globalInstallmentManager) {
            window.globalInstallmentManager.updateStepData(2, { signature: signatureData });
          }
    
          // Update UI
          this.updateSignatureStatus(true);
    
          if (typeof showToast === 'function') {
            showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          }
    
          this.closeModal();
        },
    
        updateSignatureStatus(hasSaved = null) {
          const status = document.getElementById('signatureStatus');
          if (!status) return;
    
          const savedSignature = hasSaved !== null ? hasSaved : localStorage.getItem('customerSignature');
    
          if (savedSignature) {
            status.innerHTML = '<i class="bi bi-check-circle text-green-500"></i> ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            status.className = 'text-sm text-green-600';
          } else {
            status.innerHTML = '<i class="bi bi-exclamation-circle text-yellow-500"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô';
            status.className = 'text-sm text-yellow-600';
          }
        },
    
        loadSavedSignature() {
          this.updateSignatureStatus();
    
          // Also update hidden input if it exists
          const hiddenInput = document.getElementById('customerSignatureUrl');
          const savedSignature = localStorage.getItem('customerSignature');
          if (hiddenInput && savedSignature) {
            hiddenInput.value = savedSignature;
          }
        }
      };
    
      // Override existing signature functions to use enhanced manager
      window.openSignatureModal = function() {
        window.enhancedSignatureManager.openModal();
      };
    
      window.closeSignatureModal = function() {
        window.enhancedSignatureManager.closeModal();
      };
    
      window.clearSignature = function() {
        window.enhancedSignatureManager.clear();
      };
    
      window.saveSignature = function() {
        window.enhancedSignatureManager.save();
      };
    
      // Note: Signature initialization is now handled in initializeAdditionalFeatures()
    
      // Make it globally available
      window.signatureManager = window.enhancedSignatureManager;
    
      // ================ ENHANCED SALESPERSON SIGNATURE MANAGER ================
      // Prevent multiple instances
      if (window.salespersonSignatureManager) {
        console.log('‚ö†Ô∏è salespersonSignatureManager already exists, cleaning up...');
        if (window.salespersonSignatureManager.cleanup) {
          window.salespersonSignatureManager.cleanup();
        }
      }
    
      window.salespersonSignatureManager = {
        modal: null,
        canvas: null,
        ctx: null,
        signaturePad: null,
        isInitialized: false,
        isDrawing: false,
        instanceId: Date.now(), // ‡πÄ‡∏û‡∏¥‡πà‡∏° instance ID
    
        init() {
          if (this.isInitialized) {
            console.log('‚ö†Ô∏è Salesperson signature manager already initialized');
            return true;
          }
    
          console.log('üöÄ Initializing salesperson signature manager...');
          this.createModal();
    
          this.canvas = document.getElementById('salespersonSignatureCanvas');
          if (!this.canvas) {
            console.error('‚ùå Salesperson signature canvas not found');
            return false;
          }
    
          // Initialize SignaturePad if available
          if (window.SignaturePad) {
            this.signaturePad = new SignaturePad(this.canvas, {
              backgroundColor: 'rgb(255, 255, 255)',
              penColor: 'rgb(0, 0, 0)',
              velocityFilterWeight: 0.7,
              minWidth: 0.5,
              maxWidth: 2.5,
              throttle: 16,
              minPointDistance: 3
            });
          } else {
            // Fallback to basic canvas
            this.ctx = this.canvas.getContext('2d');
            this.setupBasicCanvas();
            this.bindBasicEvents();
          }
    
          this.bindModalEvents();
          this.isInitialized = true;
          console.log('‚úÖ Enhanced salesperson signature manager initialized');
          return true;
        },
    
        setupBasicCanvas() {
          const rect = this.canvas.getBoundingClientRect();
          this.canvas.width = rect.width * 2;
          this.canvas.height = rect.height * 2;
          this.ctx.scale(2, 2);
    
          this.ctx.lineCap = 'round';
          this.ctx.lineJoin = 'round';
          this.ctx.strokeStyle = '#000000';
          this.ctx.lineWidth = 2;
          this.ctx.fillStyle = '#ffffff';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        },
    
        bindBasicEvents() {
          if (!this.canvas || !this.ctx) return;
    
          // Mouse events
          this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
          this.canvas.addEventListener('mousemove', (e) => this.draw(e));
          this.canvas.addEventListener('mouseup', () => this.stopDrawing());
          this.canvas.addEventListener('mouseout', () => this.stopDrawing());
    
          // Touch events
          this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.startDrawing(e.touches[0]);
          });
          this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.draw(e.touches[0]);
          });
          this.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.stopDrawing();
          });
        },
    
        startDrawing(e) {
          this.isDrawing = true;
          const rect = this.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width * this.canvas.width / 2;
          const y = (e.clientY - rect.top) / rect.height * this.canvas.height / 2;
    
          this.ctx.beginPath();
          this.ctx.moveTo(x, y);
        },
    
        draw(e) {
          if (!this.isDrawing) return;
    
          const rect = this.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width * this.canvas.width / 2;
          const y = (e.clientY - rect.top) / rect.height * this.canvas.height / 2;
    
          this.ctx.lineTo(x, y);
          this.ctx.stroke();
        },
    
        stopDrawing() {
          this.isDrawing = false;
        },
    
        bindModalEvents() {
          // Close modal when clicking outside
          if (this.modal) {
            this.modal.addEventListener('click', (e) => {
              if (e.target === this.modal) {
                this.closeModal();
              }
            });
          }
    
          // Escape key to close
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modal && !this.modal.classList.contains('hidden')) {
              this.closeModal();
            }
          });
        },
    
        createModal() {
          // Check for multiple modals and remove all
          const allModals = document.querySelectorAll('#salespersonSignatureModal');
          if (allModals.length > 0) {
            console.log(`üóëÔ∏è Found ${allModals.length} existing modals, removing all...`);
            allModals.forEach(modal => modal.remove());
          }
    
          // Create enhanced modal HTML
          const modalHTML = `
            <div id="salespersonSignatureModal" class="fixed inset-0 z-[60] flex items-center justify-center hidden">
              <div class="fixed inset-0 bg-black bg-opacity-50"></div>
              <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 relative z-10">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold text-green-600 flex items-center gap-2">
                    <i class="bi bi-person-badge"></i> ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢
                  </h3>
                  <button type="button" onclick="window.closeSalespersonSignatureModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
                
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <p class="text-sm text-green-700 flex items-center gap-2">
                    <i class="bi bi-info-circle"></i>
                    <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</span>
                  </p>
                </div>
                
                <div class="mb-4">
                  <canvas id="salespersonSignatureCanvas" 
                    class="border-2 border-gray-300 rounded-lg w-full bg-white cursor-crosshair hover:border-green-400 transition-colors" 
                    width="600" height="250"></canvas>
                </div>
                
                <div class="flex gap-2">
                  <button type="button" onclick="window.clearSalespersonSignature()" class="btn btn-outline flex-1 text-sm">
                    <i class="bi bi-arrow-clockwise mr-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                  </button>
                  <button type="button" onclick="window.saveSalespersonSignature()" class="btn btn-success flex-1 text-sm">
                    <i class="bi bi-check-lg mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                  </button>
                </div>
              </div>
            </div>
          `;
    
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          this.modal = document.getElementById('salespersonSignatureModal');
        },
    
        openModal() {
          console.log(`üöÄ Opening salesperson modal (Instance: ${this.instanceId})`);
    
          // Check if modal is already open
          if (this.modal && !this.modal.classList.contains('hidden')) {
            console.log('‚ö†Ô∏è Modal is already open, skipping...');
            return;
          }
    
          this.init();
    
          // Close other modals first
          this.closeOtherModals();
    
          // Double-check no duplicate modals exist
          const duplicates = document.querySelectorAll('#salespersonSignatureModal');
          if (duplicates.length > 1) {
            console.log(`üö® Found ${duplicates.length} duplicate modals, keeping only the last one`);
            for (let i = 0; i < duplicates.length - 1; i++) {
              duplicates[i].remove();
            }
            this.modal = duplicates[duplicates.length - 1];
          }
    
          if (this.modal) {
            this.modal.classList.remove('hidden');
            this.clear(); // Clear canvas when opening
            console.log('‚úÖ Salesperson signature modal opened successfully');
          } else {
            console.error('‚ùå Failed to open modal - modal element not found');
          }
        },
    
        closeOtherModals() {
          // Close customer signature modal
          const customerModal = document.getElementById('signatureModal');
          if (customerModal) {
            customerModal.classList.add('hidden');
          }
    
          // Close camera modal
          const cameraModal = document.getElementById('cameraModal');
          if (cameraModal) {
            cameraModal.classList.add('hidden');
          }
    
          console.log('üîí Closed other modals');
        },
    
        closeModal() {
          if (this.modal) {
            this.modal.classList.add('hidden');
            console.log('‚ùå Salesperson signature modal closed');
          }
        },
    
        cleanup() {
          // Remove modal from DOM
          if (this.modal) {
            this.modal.remove();
            this.modal = null;
          }
    
          // Reset properties
          this.canvas = null;
          this.ctx = null;
          this.signaturePad = null;
          this.isInitialized = false;
    
          console.log('üßπ Salesperson signature manager cleaned up');
        },
    
        clear() {
          if (this.signaturePad) {
            this.signaturePad.clear();
          } else if (this.ctx) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          }
        },
    
        isEmpty() {
          if (this.signaturePad) {
            return this.signaturePad.isEmpty();
          } else if (this.ctx) {
            const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
            return !imageData.data.some(channel => channel !== 0);
          }
          return true;
        },
    
        getSignatureData() {
          if (this.isEmpty()) {
            return null;
          }
    
          if (this.signaturePad) {
            return this.signaturePad.toDataURL('image/png');
          } else if (this.canvas) {
            return this.canvas.toDataURL('image/png');
          }
          return null;
        },
    
        resizeCanvas() {
          if (!this.signaturePad || !this.canvas) return;
    
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const rect = this.canvas.getBoundingClientRect();
    
          this.canvas.width = rect.width * ratio;
          this.canvas.height = rect.height * ratio;
          this.canvas.getContext('2d').scale(ratio, ratio);
    
          this.signaturePad.clear();
        },
    
        backup() {
          return this.getSignatureData();
        },
    
        restore(backupData) {
          if (backupData && this.canvas) {
            const img = new Image();
            img.onload = () => {
              this.clear();
              if (this.ctx) {
                this.ctx.drawImage(img, 0, 0);
              }
            };
            img.src = backupData;
          }
        },
    
        async save() {
          const signatureData = this.getSignatureData();
          if (!signatureData) {
            if (typeof showToast === 'function') {
              showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
            }
            return;
          }
    
          try {
    
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const customerSignature = localStorage.getItem('customerSignature') || localStorage.getItem('step2_signature');
            if (signatureData === customerSignature) {
              if (typeof showToast === 'function') {
                showToast('‚ö†Ô∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡πÉ‡∏´‡∏°‡πà', 'warning');
              }
              console.warn('üö® Rejected identical signature for salesperson');
              return;
            }
    
            console.log('‚úÖ Saving unique salesperson signature');
            console.log('üìù Signature length:', signatureData.length);
            console.log('üîç First 100 chars:', signatureData.substring(0, 100));
    
            try {
              // Upload to server first
              const serverUrl = await uploadImageToServer('salespersonSignature', signatureData);
              console.log('üåê Salesperson signature uploaded to server:', serverUrl);
    
              // Save both base64 and server URL
              localStorage.setItem('salespersonSignature', signatureData); // Keep base64 for preview
              localStorage.setItem('salespersonSignature_url', serverUrl); // Store server URL
              localStorage.setItem('step2_salespersonSignature', signatureData);
    
              // Update hidden input with server URL
              const hiddenInput = document.getElementById('salespersonSignatureUrl');
              if (hiddenInput) {
                hiddenInput.value = serverUrl; // Use server URL in form
              }
    
            } catch (error) {
              console.warn('‚ö†Ô∏è Server upload failed for salesperson signature, using base64:', error);
    
              // Fallback to localStorage only
              localStorage.setItem('salespersonSignature', signatureData);
              localStorage.setItem('step2_salespersonSignature', signatureData);
    
              const hiddenInput = document.getElementById('salespersonSignatureUrl');
              if (hiddenInput) {
                hiddenInput.value = signatureData; // Fallback to base64
              }
            }
    
            // Update Global Data Manager
            if (window.globalInstallmentManager) {
              window.globalInstallmentManager.updateStepData(2, {
                salespersonSignature: signatureData,
                salespersonSignatureTimestamp: new Date().toISOString()
              });
            }
    
            // Update UI
            this.updateSignaturePreview(signatureData);
            this.updateSignatureStatus(true);
    
            if (typeof showToast === 'function') {
              showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
    
            this.closeModal();
          } catch (error) {
            console.error('Error saving salesperson signature:', error);
            if (typeof showToast === 'function') {
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô', 'error');
            }
          }
        },
    
        updateSignaturePreview(signatureData) {
          const preview = document.getElementById('salespersonSignaturePreview');
          const image = document.getElementById('salespersonSignatureImage');
          const placeholder = document.getElementById('salespersonSignaturePlaceholder');
          const retakeBtn = document.getElementById('btnRetakeSalespersonSignature');
    
          if (image) image.src = signatureData;
          if (preview) preview.classList.remove('hidden');
          if (placeholder) placeholder.classList.add('hidden');
          if (retakeBtn) retakeBtn.classList.remove('hidden');
    
          // Update status badge
          const statusBadge = document.querySelector('#salespersonSignatureCard .status-badge');
          if (statusBadge) {
            statusBadge.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
            statusBadge.className = 'status-badge completed';
          }
        },
    
        updateSignatureStatus(hasSaved = null) {
          const savedSignature = hasSaved !== null ? hasSaved : localStorage.getItem('salespersonSignature');
          // Update any status indicators if needed
        },
    
        loadSavedSignature() {
          const savedSignature = localStorage.getItem('salespersonSignature');
          if (savedSignature) {
            this.updateSignaturePreview(savedSignature);
    
            // Update hidden input
            const hiddenInput = document.getElementById('salespersonSignatureUrl');
            if (hiddenInput) {
              hiddenInput.value = savedSignature;
            }
          }
        }
      };
    
      // Global functions for salesperson signature (prevent overwriting)
      if (!window.openSalespersonSignatureModal) {
        window.openSalespersonSignatureModal = function() {
          console.log('üéØ openSalespersonSignatureModal called');
          if (window.salespersonSignatureManager) {
            window.salespersonSignatureManager.openModal();
          } else {
            console.error('‚ùå salespersonSignatureManager not found');
          }
        };
      }
    
      if (!window.closeSalespersonSignatureModal) {
        window.closeSalespersonSignatureModal = function() {
          console.log('üîí closeSalespersonSignatureModal called');
          if (window.salespersonSignatureManager) {
            window.salespersonSignatureManager.closeModal();
          }
        };
      }
    
      if (!window.clearSalespersonSignature) {
        window.clearSalespersonSignature = function() {
          console.log('üßπ clearSalespersonSignature called');
          if (window.salespersonSignatureManager) {
            window.salespersonSignatureManager.clear();
          }
        };
      }
    
      if (!window.saveSalespersonSignature) {
        window.saveSalespersonSignature = function() {
          console.log('üíæ saveSalespersonSignature called');
          if (window.salespersonSignatureManager) {
            window.salespersonSignatureManager.save();
          }
        };
      }
  </script>

  <!-- Card Reader Integration -->
  <script src="/js/card-reader-config.js"></script>
  <script src="/js/card-reader-service.js"></script>
  
  <!-- Add Google Maps error suppression and user guidance -->
  <script>
         // Google Maps completely disabled - no error suppression needed
     console.log('üö´ Google Maps API completely disabled - no network requests will be made');

     // Note: Card reader initialization is now handled in initializeAdditionalFeatures()

     function setupCardReaderButtons() {
       // Find tax ID input and add card reader button
       const taxIdInput = document.getElementById('taxId');
       if (taxIdInput && !document.getElementById('cardReaderBtn')) {
         const cardBtn = document.createElement('button');
         cardBtn.id = 'cardReaderBtn';
         cardBtn.type = 'button';
         cardBtn.className = 'btn btn-info btn-sm ml-2';
         cardBtn.innerHTML = '<i class="bi bi-credit-card"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£';
         cardBtn.title = '‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô';
         
         cardBtn.addEventListener('click', async function() {
           try {
             cardBtn.disabled = true;
             cardBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô...';
         
             const result = await window.CardReaderService.readCard({
               branchCode: window.BRANCH_CODE,
               timeout: 30000
             });
         
             if (result && result.success && result.data) {
               fillCustomerDataFromCard(result.data);
               showToast('‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
             } else {
               throw new Error(result?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏î‡πâ');
             }
         
           } catch (error) {
             console.error('Card reader error:', error);
             showToast('‚ùå ' + error.message, 'error');
           } finally {
             cardBtn.disabled = false;
             cardBtn.innerHTML = '<i class="bi bi-credit-card"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£';
           }
         });
         
         // Insert button after tax ID input
         taxIdInput.parentNode.appendChild(cardBtn);
       }
     }

     function fillCustomerDataFromCard(cardData) {
       if (!cardData) return;

       try {
         // Fill tax ID
         if (cardData.citizenId) {
           const taxIdInput = document.getElementById('taxId');
           if (taxIdInput) {
             taxIdInput.value = cardData.citizenId;
             taxIdInput.dispatchEvent(new Event('input'));
           }
         }
         
         // Fill name
         if (cardData.titleTh) {
           const prefixSelect = document.getElementById('prefix');
           if (prefixSelect) {
             prefixSelect.value = cardData.titleTh;
           }
         }
         
         if (cardData.firstNameTh) {
           const firstNameInput = document.getElementById('firstName');
           if (firstNameInput) {
             firstNameInput.value = cardData.firstNameTh;
             firstNameInput.dispatchEvent(new Event('input'));
           }
         }
         
         if (cardData.lastNameTh) {
           const lastNameInput = document.getElementById('lastName');
           if (lastNameInput) {
             lastNameInput.value = cardData.lastNameTh;
             lastNameInput.dispatchEvent(new Event('input'));
           }
         }
         
         // Fill address if available
         if (cardData.address) {
           const addressInput = document.getElementById('address');
           if (addressInput) {
             addressInput.value = cardData.address;
             addressInput.dispatchEvent(new Event('input'));
           }
         }
         
         console.log('‚úÖ Customer data filled from card:', {
           name: `${cardData.titleTh || ''} ${cardData.firstNameTh || ''} ${cardData.lastNameTh || ''}`,
           citizenId: cardData.citizenId
         });
         
       } catch (error) {
         console.error('Error filling customer data:', error);
         showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
       }
     }

     // üîß ENHANCED: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô validation ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö step2
     window.validateStep2Form = function() {
       const errors = [];
       const requiredFields = [
         { id: 'customerFirstName', name: '‡∏ä‡∏∑‡πà‡∏≠', minLength: 2 },
         { id: 'customerLastName', name: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', minLength: 2 },
         { id: 'customerIdCard', name: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', pattern: /^\d{1}-\d{4}-\d{5}-\d{2}-\d{1}$/ },
         { id: 'customerPhone', name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', pattern: /^\d{3}-\d{3}-\d{4}$/ },
         { id: 'customerEmail', name: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
         { id: 'houseNo', name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', minLength: 1 },
         { id: 'province', name: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' },
         { id: 'district', name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' },
         { id: 'subDistrict', name: '‡∏ï‡∏≥‡∏ö‡∏•' },
         { id: 'zipcode', name: '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå', pattern: /^\d{5}$/ }
       ];

       // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
       requiredFields.forEach(field => {
         const element = document.getElementById(field.id);
         if (!element) return;

         const value = element.value.trim();
         
         // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
         if (!value) {
           errors.push(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å${field.name}`);
           markFieldAsError(element);
           return;
         }

         // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
         if (field.minLength && value.length < field.minLength) {
           errors.push(`${field.name}‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${field.minLength} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£`);
           markFieldAsError(element);
           return;
         }

         // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (pattern)
         if (field.pattern && !field.pattern.test(value)) {
           let errorMsg = `${field.name}‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`;
           if (field.id === 'customerIdCard') errorMsg = '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å';
           if (field.id === 'customerPhone') errorMsg = '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏´‡∏•‡∏±‡∏Å';
           if (field.id === 'customerEmail') errorMsg = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
           if (field.id === 'zipcode') errorMsg = '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å';
         
           errors.push(errorMsg);
           markFieldAsError(element);
           return;
         }

         // ‡∏´‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
         markFieldAsValid(element);
       });

       // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
       const customerSignature = localStorage.getItem('customerSignature');
       if (!customerSignature) {
         errors.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
       }

       return {
         isValid: errors.length === 0,
         errors: errors
       };
     };

     // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á error
     function markFieldAsError(element) {
       element.classList.add('input-error');
       element.classList.remove('input-success');

       const validationIcon = element.parentNode.querySelector('.validation-icon');
       if (validationIcon) {
         validationIcon.innerHTML = '<i class="bi bi-x-circle text-red-500"></i>';
       }
     }

     // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á success
     function markFieldAsValid(element) {
       element.classList.remove('input-error');
       element.classList.add('input-success');

       const validationIcon = element.parentNode.querySelector('.validation-icon');
       if (validationIcon) {
         validationIcon.innerHTML = '<i class="bi bi-check-circle text-green-500"></i>';
       }
     }

     // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö format ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô with proper checksum validation
     window.formatIdCard = function(input) {
       let value = input.value.replace(/\D/g, '');
       if (value.length > 13) value = value.substring(0, 13);

       // Format display
       let formattedValue = value;
       if (value.length >= 1) {
         formattedValue = value.substring(0, 1) +
                (value.length > 1 ? '-' + value.substring(1, 5) : '') +
                (value.length > 5 ? '-' + value.substring(5, 10) : '') +
                (value.length > 10 ? '-' + value.substring(10, 12) : '') +
                (value.length > 12 ? '-' + value.substring(12, 13) : '');
       }

       input.value = formattedValue;

       // Real-time validation with checksum
       if (value.length === 13) {
         // Thai ID card checksum validation
         let sum = 0;
         for (let i = 0; i < 12; i++) {
           sum += parseInt(value.charAt(i)) * (13 - i);
         }
         const remainder = sum % 11;
         const checkDigit = remainder < 2 ? (1 - remainder) : (11 - remainder);
         
         if (checkDigit === parseInt(value.charAt(12))) {
           markFieldAsValid(input);
           // Remove any error message
           const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
           if (errorDiv) {
             errorDiv.classList.add('hidden');
             errorDiv.textContent = '';
           }
         } else {
           markFieldAsError(input);
           // Show checksum error
           const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
           if (errorDiv) {
             errorDiv.classList.remove('hidden');
             errorDiv.textContent = '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (checksum ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á)';
           }
         }
       } else if (value.length > 0) {
         // Show incomplete message
         const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
         if (errorDiv) {
           errorDiv.classList.remove('hidden');
           errorDiv.textContent = `‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å ${13 - value.length} ‡∏´‡∏•‡∏±‡∏Å`;
         }
       }
     };

     // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö format ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå with Thai mobile validation
     window.formatPhoneNumber = function(input) {
       let value = input.value.replace(/\D/g, '');
       if (value.length > 10) value = value.substring(0, 10);

       // Format display
       let formattedValue = value;
       if (value.length >= 6) {
         formattedValue = value.substring(0, 3) + '-' +
                value.substring(3, 6) + '-' +
                value.substring(6, 10);
       } else if (value.length >= 3) {
         formattedValue = value.substring(0, 3) + '-' + value.substring(3);
       }

       input.value = formattedValue;

       // Real-time validation - check Thai mobile prefixes
       if (value.length === 10) {
         // Thai mobile prefixes: 06, 08, 09
         const validPrefixes = ['06', '08', '09'];
         const prefix = value.substring(0, 2);
         
         if (validPrefixes.includes(prefix)) {
           markFieldAsValid(input);
           // Remove any error message
           const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
           if (errorDiv) {
             errorDiv.classList.add('hidden');
             errorDiv.textContent = '';
           }
         } else {
           markFieldAsError(input);
           // Show prefix error
           const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
           if (errorDiv) {
             errorDiv.classList.remove('hidden');
             errorDiv.textContent = '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 06, 08, ‡∏´‡∏£‡∏∑‡∏≠ 09';
           }
         }
       } else if (value.length > 0) {
         // Show incomplete message
         const errorDiv = input.parentElement?.parentElement?.querySelector('.form-error');
         if (errorDiv) {
           errorDiv.classList.remove('hidden');
           errorDiv.textContent = `‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å ${10 - value.length} ‡∏´‡∏•‡∏±‡∏Å`;
         }
       }
     };

     // Global function to manually update salesperson name
     window.updateSalespersonName = function(name = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢') {
       const salespersonEl = document.getElementById('salespersonName');
       if (salespersonEl) {
         salespersonEl.textContent = name;
         localStorage.setItem('salespersonName', name);
         localStorage.setItem('employeeName', name);
         console.log('‚úÖ Salesperson name updated to:', name);
         showToast(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${name}`, 'success');
       } else {
         console.warn('‚ö†Ô∏è Salesperson name element not found');
       }
     };

     // Clear old salesperson data and reload from userInfo
     window.clearAndReloadSalesperson = function() {
       console.log('üßπ Clearing old salesperson data...');
       localStorage.removeItem('salespersonName');
       localStorage.removeItem('employeeName');

       // Get fresh data from userInfo (same logic as loadSalespersonInfo)
       const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
       const activeUser = localStorage.getItem('activeUser');
       let salespersonName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';

       // Priority order: userInfo, activeUser, default (no branchInfo.manager)
       if (userInfo.name && userInfo.name.trim() !== '') {
         salespersonName = userInfo.name.trim();
       } else if (userInfo.username && userInfo.username.trim() !== '') {
         salespersonName = userInfo.username.trim();
       } else if (userInfo.displayName && userInfo.displayName.trim() !== '') {
         salespersonName = userInfo.displayName.trim();
       } else if (activeUser && activeUser.trim() !== '' && activeUser !== 'Unknown') {
         salespersonName = activeUser.trim();
       }

       // Ensure proper display name format
       if (salespersonName === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
         salespersonName = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
       }

       // Update display
       const salespersonEl = document.getElementById('salespersonName');
       if (salespersonEl) {
         salespersonEl.textContent = salespersonName;
         localStorage.setItem('salespersonName', salespersonName);
         localStorage.setItem('employeeName', salespersonName);
         console.log('‚úÖ Salesperson reloaded:', salespersonName);
         console.log('üîç UserInfo check:', userInfo);
       } else {
         console.warn('‚ö†Ô∏è Salesperson name element not found');
       }
     };

     // Debug function to check all localStorage salesperson-related data
     window.debugSalespersonData = function() {
       console.log('üîç Debugging salesperson data sources:');
       console.log('- userInfo:', JSON.parse(localStorage.getItem('userInfo') || '{}'));
       console.log('- activeUser:', localStorage.getItem('activeUser'));
       console.log('- branchInfo:', JSON.parse(localStorage.getItem('branchInfo') || '{}'));
       console.log('- salespersonName:', localStorage.getItem('salespersonName'));
       console.log('- employeeName:', localStorage.getItem('employeeName'));
     };

     // Debug function to manually reset camera modal
     window.resetWitnessCameraModal = function() {
       console.log('üîß Manually resetting witness camera modal...');
       resetCameraModal();
       showToast('Camera modal state reset', 'success');
     };

     // Initialize salesperson name immediately on script load
     document.addEventListener('DOMContentLoaded', function() {
       // Clear old data and reload from userInfo instead of using hardcoded default
       clearAndReloadSalesperson();

       // Force update salesperson display after a short delay
       // Force update salesperson name after DOM is ready
       setTimeout(() => {
         clearAndReloadSalesperson();
       }, 500);
     });

     // ÔøΩÔ∏è Setup Image Upload Functionality
     function setupImageUpload() {
       console.log('üñºÔ∏è Setting up image upload functionality...');

       // ID Card Upload
       const uploadIdCard = document.getElementById('uploadIdCard');
       const btnUploadIdCard = document.getElementById('btnUploadIdCard');
       const idCardImage = document.getElementById('idCardImage');
       const idCardPreview = document.getElementById('idCardPreview');
       const idCardStatus = document.getElementById('idCardStatus');

       if (btnUploadIdCard && uploadIdCard) {
         btnUploadIdCard.addEventListener('click', () => uploadIdCard.click());
         
         uploadIdCard.addEventListener('change', async function(e) {
           const file = e.target.files[0];
           if (file) {
             console.log('üì∑ ID Card file selected:', file.name, file.size);
             await handleImageUpload(file, 'idCard', idCardImage, idCardPreview, idCardStatus);
           }
         });
       }

       // Selfie Upload
       const uploadSelfie = document.getElementById('uploadSelfie');
       const btnUploadSelfie = document.getElementById('btnUploadSelfie');
       const selfieImage = document.getElementById('selfieImage');
       const selfiePreview = document.getElementById('selfiePreview');
       const selfieStatus = document.getElementById('selfieStatus');

       if (btnUploadSelfie && uploadSelfie) {
         btnUploadSelfie.addEventListener('click', () => uploadSelfie.click());
         
         uploadSelfie.addEventListener('change', async function(e) {
           const file = e.target.files[0];
           if (file) {
             console.log('üì∑ Selfie file selected:', file.name, file.size);
             await handleImageUpload(file, 'selfie', selfieImage, selfiePreview, selfieStatus);
           }
         });
       }

       // Camera functionality for mobile
       setupCameraCapture();
     }

     // üì∏ Handle Image Upload
     async function handleImageUpload(file, type, imageElement, previewElement, statusElement) {
       try {
         // Enhanced validation for JPG and other image files
         const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
         const allowedExtensions = ['.jpg', '.jpeg', '.png', '.webp'];
         const fileName = file.name.toLowerCase();
         const fileExtension = fileName.substring(fileName.lastIndexOf('.'));
         
         // Check MIME type
         if (!allowedTypes.includes(file.type.toLowerCase())) {
           throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û JPG, JPEG, PNG ‡∏´‡∏£‡∏∑‡∏≠ WebP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
         }
         
         // Check file extension
         if (!allowedExtensions.includes(fileExtension)) {
           throw new Error('‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô .jpg, .jpeg, .png ‡∏´‡∏£‡∏∑‡∏≠ .webp ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
         }
         
         if (file.size > 5 * 1024 * 1024) { // 5MB limit
           throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
         }
         
         // Show loading
         statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
         statusElement.className = 'status-badge processing';
         
         // Convert to base64 for preview
         const reader = new FileReader();
         reader.onload = function(e) {
           imageElement.src = e.target.result;
           previewElement.classList.remove('hidden');
         
           // Store image data
           const imageData = {
             filename: file.name,
             size: file.size,
             type: file.type,
             base64: e.target.result,
             uploadDate: new Date().toISOString()
           };
         
           // Save to customer data
           saveImageToCustomerData(type, imageData);
         
           // Update status
           statusElement.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
           statusElement.className = 'status-badge completed';
         
           console.log(`‚úÖ ${type} uploaded successfully:`, imageData.filename);
         
           // Show success toast
           if (typeof showToast === 'function') {
             showToast(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${type === 'idCard' ? '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' : '‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
           }
         };
         
         reader.onerror = function() {
           throw new Error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
         };
         
         reader.readAsDataURL(file);
         
       } catch (error) {
         console.error(`‚ùå Error uploading ${type}:`, error);
         statusElement.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
         statusElement.className = 'status-badge error';
         
         if (typeof showToast === 'function') {
           showToast(`‚ùå ${error.message}`, 'error');
         } else {
           alert(error.message);
         }
       }
     }

     // üíæ Save Image to Customer Data (Updated to use server storage)
     async function saveImageToCustomerData(type, imageData) {
       try {
         console.log(`üíæ Saving ${type} image to server...`);
         
         // Validate imageData and convert to string if needed
         if (!imageData) {
           console.error('‚ùå No imageData provided');
           return;
         }
         
         // Ensure imageData is a string
         const imageString = typeof imageData === 'string' ? imageData : String(imageData);
         let serverUrl = imageString;
         
         // If imageData is base64, upload to server first
         if (imageString && imageString.startsWith('data:image/')) {
           try {
             serverUrl = await uploadImageToServer(type, imageString);
             console.log(`üåê ${type} uploaded to server:`, serverUrl);
           } catch (error) {
             console.warn(`‚ö†Ô∏è Server upload failed for ${type}, using base64:`, error);
             serverUrl = imageString; // Fallback to base64
           }
         }
         
         // Update hidden input field
         const hiddenInput = document.getElementById('idCardImageUrl');
         if (hiddenInput && type === 'idCard') {
           hiddenInput.value = serverUrl;
         }
         
         // Get current customer data from globalInstallmentManager
         const currentData = window.globalInstallmentManager?.getStepData(2) || {};
         
         // Add image to customer data with server URL
         if (!currentData.attachments) {
           currentData.attachments = {};
         }
         
         currentData.attachments[type] = {
           url: serverUrl,
           data: imageString.startsWith('data:image/') ? imageString : null, // Keep base64 for preview
           timestamp: new Date().toISOString()
         };
         
         // Update global data manager
         if (window.globalInstallmentManager) {
           const step2Data = window.globalInstallmentManager.getStepData(2) || {};
           if (!step2Data.attachments) {
             step2Data.attachments = {};
           }
           step2Data.attachments[type] = currentData.attachments[type];
           window.globalInstallmentManager.updateStepData(2, step2Data);
         }
         
         // Update step2Integration if available
         if (window.step2Integration) {
           window.step2Integration.saveCustomerData();
         }
         
         // Save to localStorage for persistence
         localStorage.setItem(`customer_${type}`, imageString); // Keep base64 for preview
         localStorage.setItem(`customer_${type}_url`, serverUrl); // Store server URL
         
         console.log(`‚úÖ ${type} image saved to customer data with server URL`);
         
         return serverUrl;
         
       } catch (error) {
         console.error(`‚ùå Error saving ${type} image:`, error);
         throw error;
       }
     }

     // üì± Setup Camera Capture for Mobile
     function setupCameraCapture() {
       const btnTakeIdCard = document.getElementById('btnTakeIdCard');
       const btnTakeSelfie = document.getElementById('btnTakeSelfie');

       if (btnTakeIdCard) {
         btnTakeIdCard.addEventListener('click', () => {
           captureImageWithCamera('idCard');
         });
       }

       if (btnTakeSelfie) {
         btnTakeSelfie.addEventListener('click', () => {
           captureImageWithCamera('selfie');
         });
       }
     }

     // üì∏ Capture Image with Camera
     async function captureImageWithCamera(type) {
       try {
         console.log(`üì∏ Starting camera capture for ${type}...`);
         
         const stream = await navigator.mediaDevices.getUserMedia({
           video: {
             facingMode: type === 'selfie' ? 'user' : 'environment',
             width: { ideal: 1280 },
             height: { ideal: 720 }
           }
         });
         
         // Create camera modal
         showCameraModal(stream, type);
         
       } catch (error) {
         console.error('‚ùå Camera access error:', error);
         if (typeof showToast === 'function') {
           showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'error');
         } else {
           alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á');
         }
       }
     }

     // üì∑ Show Camera Modal (‡πÉ‡∏ä‡πâ modal ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
     function showCameraModal(stream, type) {
       const modal = document.getElementById('cameraModal');

       if (!modal) {
         console.error('‚ùå Camera modal not found');
         stream.getTracks().forEach(track => track.stop());
         showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö Camera Modal ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
         return;
       }

       const video = document.getElementById('cameraVideo');
       const captureBtn = document.getElementById('capturePhoto');
       const cancelBtn = document.getElementById('closeCameraModal');

       if (!video) {
         console.error('‚ùå Video element not found in camera modal');
         stream.getTracks().forEach(track => track.stop());
         showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö Video Element ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
         return;
       }

       if (!captureBtn || !cancelBtn) {
         console.error('‚ùå Camera modal buttons not found', { captureBtn: !!captureBtn, cancelBtn: !!cancelBtn });
         stream.getTracks().forEach(track => track.stop());
         showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
         return;
       }

       // Setup video stream
       video.srcObject = stream;
       modal.classList.remove('hidden');
       modal.classList.add('flex');

       // Update modal title
       const title = document.getElementById('cameraModalTitle');
       if (title) {
         title.textContent = type === 'idCard' ? '‡∏ñ‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' : '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà';
       }

       // Handle capture
       const handleCapture = () => {
         capturePhoto(video, stream, type);
         cleanup();
       };

       // Handle cancel
       const handleCancel = () => {
         cleanup();
       };

       // Cleanup function
       const cleanup = () => {
         stream.getTracks().forEach(track => track.stop());
         modal.classList.add('hidden');
         modal.classList.remove('flex');
         if (captureBtn) captureBtn.removeEventListener('click', handleCapture);
         if (cancelBtn) cancelBtn.removeEventListener('click', handleCancel);
         
         // Reset modal title
         if (title) {
           title.textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
         }
       };

       captureBtn.addEventListener('click', handleCapture);
       cancelBtn.addEventListener('click', handleCancel);
     }

     // üì∑ Capture Photo from Video
     function capturePhoto(video, stream, type) {
       const canvas = document.createElement('canvas');
       const context = canvas.getContext('2d');

       canvas.width = video.videoWidth;
       canvas.height = video.videoHeight;

       context.drawImage(video, 0, 0);

       canvas.toBlob((blob) => {
         const file = new File([blob], `${type}_${Date.now()}.jpg`, { type: 'image/jpeg' });
         
         const imageElement = document.getElementById(type === 'idCard' ? 'idCardImage' : 'selfieImage');
         const previewElement = document.getElementById(type === 'idCard' ? 'idCardPreview' : 'selfiePreview');
         const statusElement = document.getElementById(type === 'idCard' ? 'idCardStatus' : 'selfieStatus');
         
         handleImageUpload(file, type, imageElement, previewElement, statusElement);
       }, 'image/jpeg', 0.8);
     }

     // üîß ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Real-time Validation
     document.addEventListener('DOMContentLoaded', function() {
       // Set up image upload functionality
       setupImageUpload();
       setupWitnessImageUpload(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏¢‡∏≤‡∏ô

       // Global camera modal close button handler
       const closeCameraBtn = document.getElementById('closeCameraModal');
       if (closeCameraBtn) {
         closeCameraBtn.onclick = function() {
           console.log('üö™ Close camera modal button clicked');
         
           const modal = document.getElementById('cameraModal');
           const video = document.getElementById('cameraVideo');
         
           if (modal) {
             // Stop video stream
             if (video && video.srcObject) {
               const stream = video.srcObject;
               stream.getTracks().forEach(track => {
                 track.stop();
                 console.log('üõë Stopped track:', track.label);
               });
               video.srcObject = null;
             }
         
             // Hide modal
             modal.classList.add('hidden');
             modal.classList.remove('flex');
             modal.style.display = '';
             modal.style.visibility = '';
             modal.style.opacity = '';
             modal.style.pointerEvents = '';
         
             // Reset camera flag
             window._cameraInProgress = false;
         
             console.log('‚úÖ Camera modal closed via X button');
           }
         };
       }

       // Witness Photo Modal close button handler
       const closeWitnessPhotoBtn = document.getElementById('closeWitnessPhotoModal');
       if (closeWitnessPhotoBtn) {
         closeWitnessPhotoBtn.onclick = function() {
           console.log('üö™ Close witness photo modal button clicked');
           resetWitnessCameraModal('witnessPhoto');
         };
       }

       // Witness ID Card Modal close button handler
       const closeWitnessIdCardBtn = document.getElementById('closeWitnessIdCardModal');
       if (closeWitnessIdCardBtn) {
         closeWitnessIdCardBtn.onclick = function() {
           console.log('üö™ Close witness ID card modal button clicked');
           resetWitnessCameraModal('witnessIdCard');
         };
       }

       // Set up real-time validation for required fields
       const fields = [
         { id: 'customerIdCard', validator: 'formatIdCard' },
         { id: 'customerPhone', validator: 'formatPhoneNumber' },
         { id: 'customerEmail', validator: 'validateEmail' },
         { id: 'customerFirstName', validator: 'validateRequired' },
         { id: 'customerLastName', validator: 'validateRequired' },
         { id: 'houseNo', validator: 'validateRequired' },
         { id: 'zipcode', validator: 'validateZipcode' }
       ];

       fields.forEach(fieldConfig => {
         const element = document.getElementById(fieldConfig.id);
         if (element) {
           element.addEventListener('input', function() {
             switch(fieldConfig.validator) {
               case 'formatIdCard':
                 window.formatIdCard(this);
                 break;
               case 'formatPhoneNumber':
                 window.formatPhoneNumber(this);
                 break;
               case 'validateEmail':
                 validateEmailField(this);
                 break;
               case 'validateRequired':
                 validateRequiredField(this);
                 break;
               case 'validateZipcode':
                 validateZipcodeField(this);
                 break;
             }
           });

           element.addEventListener('blur', function() {
             // Validate on blur as well
             if (fieldConfig.validator === 'validateEmail') {
               validateEmailField(this);
             } else if (fieldConfig.validator === 'validateRequired') {
               validateRequiredField(this);
             } else if (fieldConfig.validator === 'validateZipcode') {
               validateZipcodeField(this);
             }
           });
         }
       });

       // Validate form before proceeding to next step
       const nextStepButton = document.querySelector('[onclick*="next"]') ||
                            document.querySelector('.btn-primary[onclick]');
       if (nextStepButton) {
         nextStepButton.addEventListener('click', function(e) {
           const validation = window.validateStep2Form();
           if (!validation.isValid) {
             e.preventDefault();
             e.stopPropagation();
         
             // Show validation errors
             const errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n' +
                                 validation.errors.join('\n');
         
             if (typeof showToast === 'function') {
               showToast('‚ùå ' + validation.errors[0], 'error');
             } else {
               alert(errorMessage);
             }
         
             console.warn('‚ùå Step2 validation failed:', validation.errors);
             return false;
           }
         });
       }
     });

     // Helper validation functions
     function validateEmailField(element) {
       const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
       const value = element.value.trim();

       if (value && !emailPattern.test(value)) {
         markFieldAsError(element);
       } else if (value) {
         markFieldAsValid(element);
       }
     }

     function validateRequiredField(element) {
       const value = element.value.trim();

       if (!value) {
         markFieldAsError(element);
       } else {
         markFieldAsValid(element);
       }
     }

     function validateZipcodeField(element) {
       const zipcodePattern = /^\d{5}$/;
       const value = element.value.trim();

       if (value && !zipcodePattern.test(value)) {
         markFieldAsError(element);
       } else if (value) {
         markFieldAsValid(element);
       }
     }

     // üë• Witness Management Functions
     function setupWitnessImageUpload() {
       console.log('üë• Setting up witness image upload functionality...');

       // Witness Photo Upload
       setupWitnessPhotoUpload();

       // Witness ID Card Upload
       setupWitnessIdCardUpload();

       // Witness form field listeners
       setupWitnessFieldListeners();

       // Restore witness images from localStorage
       restoreWitnessImages();
     }

     // üì∏ Setup Witness Photo Upload
     function setupWitnessPhotoUpload() {
       console.log('üîß Setting up witness photo upload...');

       const uploadWitnessPhoto = document.getElementById('uploadWitnessPhoto');
       const btnUploadWitnessPhoto = document.getElementById('btnUploadWitnessPhoto');
       const btnCameraWitnessPhoto = document.getElementById('btnCameraWitnessPhoto');
       const btnRetakeWitnessPhoto = document.getElementById('btnRetakeWitnessPhoto');
       const btnDeleteWitnessPhoto = document.getElementById('btnDeleteWitnessPhoto');

       // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ camera modal ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
       const cameraModal = document.getElementById('cameraModal');
       if (!cameraModal) {
         console.error('‚ùå Camera modal not found! Cannot use camera feature.');
         if (btnCameraWitnessPhoto) {
           btnCameraWitnessPhoto.disabled = true;
           btnCameraWitnessPhoto.innerHTML = '<i class="bi bi-camera-off"></i> ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°';
         }
       }

       if (btnUploadWitnessPhoto && uploadWitnessPhoto) {
         btnUploadWitnessPhoto.addEventListener('click', () => {
           uploadWitnessPhoto.click();
         });
         
         uploadWitnessPhoto.addEventListener('change', (e) => {
           const file = e.target.files[0];
           if (file) {
             handleWitnessImageUpload(file, 'witnessPhoto');
           }
         });
       }

       if (btnCameraWitnessPhoto) {
         btnCameraWitnessPhoto.addEventListener('click', async () => {
           console.log('üì∏ Camera button clicked for witness photo');
         
           // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö modal ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
           const modal = document.getElementById('cameraModal');
           if (!modal) {
             console.error('‚ùå Camera modal not found!');
             showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ó‡∏ô', 'error');
         
             // ‡πÄ‡∏õ‡∏¥‡∏î file chooser ‡πÅ‡∏ó‡∏ô
             if (uploadWitnessPhoto) {
               uploadWitnessPhoto.click();
             }
             return;
           }
         
           // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
           await captureWitnessImageWithCamera('witnessPhoto');
         });
       }

       if (btnRetakeWitnessPhoto) {
         btnRetakeWitnessPhoto.addEventListener('click', () => {
           captureWitnessImageWithCamera('witnessPhoto');
         });
       }

       if (btnDeleteWitnessPhoto) {
         btnDeleteWitnessPhoto.addEventListener('click', () => {
           deleteWitnessImage('witnessPhoto');
         });
       }
     }

     // üÜî Setup Witness ID Card Upload
     function setupWitnessIdCardUpload() {
       console.log('üîß Setting up witness ID card upload...');

       const uploadWitnessIdCard = document.getElementById('uploadWitnessIdCard');
       const btnUploadWitnessIdCard = document.getElementById('btnUploadWitnessIdCard');
       const btnCameraWitnessIdCard = document.getElementById('btnCameraWitnessIdCard');
       const btnRetakeWitnessIdCard = document.getElementById('btnRetakeWitnessIdCard');
       const btnDeleteWitnessIdCard = document.getElementById('btnDeleteWitnessIdCard');

       console.log('üéØ Elements found:', {
         uploadWitnessIdCard: !!uploadWitnessIdCard,
         btnUploadWitnessIdCard: !!btnUploadWitnessIdCard,
         btnCameraWitnessIdCard: !!btnCameraWitnessIdCard,
         btnRetakeWitnessIdCard: !!btnRetakeWitnessIdCard,
         btnDeleteWitnessIdCard: !!btnDeleteWitnessIdCard
       });

       if (btnUploadWitnessIdCard && uploadWitnessIdCard) {
         btnUploadWitnessIdCard.addEventListener('click', () => {
           uploadWitnessIdCard.click();
         });
         
         uploadWitnessIdCard.addEventListener('change', (e) => {
           const file = e.target.files[0];
           if (file) {
             handleWitnessImageUpload(file, 'witnessIdCard');
           }
         });
       }

       if (btnCameraWitnessIdCard) {
         console.log('üì∑ Setting up witness ID card camera button...');
         btnCameraWitnessIdCard.addEventListener('click', () => {
           console.log('üé¨ Witness ID card camera button clicked!');
           captureWitnessImageWithCamera('witnessIdCard');
         });
       } else {
         console.error('‚ùå btnCameraWitnessIdCard not found!');
       }

       if (btnRetakeWitnessIdCard) {
         btnRetakeWitnessIdCard.addEventListener('click', () => {
           captureWitnessImageWithCamera('witnessIdCard');
         });
       }

       if (btnDeleteWitnessIdCard) {
         btnDeleteWitnessIdCard.addEventListener('click', () => {
           deleteWitnessImage('witnessIdCard');
         });
       }
     }

     // üìù Setup Witness Field Listeners
     function setupWitnessFieldListeners() {
       const witnessFields = ['witnessFirstName', 'witnessLastName', 'witnessIdCard', 'witnessPhone', 'witnessRelationship'];

       witnessFields.forEach(fieldId => {
         const field = document.getElementById(fieldId);
         if (field) {
           field.addEventListener('input', updateWitnessDataInGlobalManager);
           field.addEventListener('change', updateWitnessDataInGlobalManager);
         }
       });
     }

     // ÔøΩ Restore Witness Images from localStorage
     function restoreWitnessImages() {
       console.log('üîÑ Restoring witness images from localStorage and server...');

       const witnessTypes = ['witnessPhoto', 'witnessIdCard'];

       witnessTypes.forEach(type => {
         // First check for server URL
         const serverUrlKey = `witness_${type}_url`;
         const savedServerUrl = localStorage.getItem(serverUrlKey);
         
         // Then check for base64 (for preview)
         const storageKey = `witness_${type}`;
         const savedBase64 = localStorage.getItem(storageKey);
         
         if (savedServerUrl) {
           console.log(`üåê Restoring ${type} from server URL:`, savedServerUrl);
         
           // Update hidden input with server URL
           let hiddenInputId = type === 'witnessIdCard' ? 'witnessIdCardImageUrl' : 'witnessPhotoUrl';
           const hiddenInput = document.getElementById(hiddenInputId);
           if (hiddenInput) {
             hiddenInput.value = savedServerUrl;
           }
         
           // Display preview using base64 if available, otherwise try server URL
           const displayImage = savedBase64 || savedServerUrl;
           displayWitnessImagePreview(type, displayImage);
         
         } else if (savedBase64) {
           console.log(`üì∑ Restoring ${type} from localStorage (base64 only)`);
           displayWitnessImagePreview(type, savedBase64);
         
           // Update hidden input with base64 as fallback
           let hiddenInputId = type === 'witnessIdCard' ? 'witnessIdCardImageUrl' : 'witnessPhotoUrl';
           const hiddenInput = document.getElementById(hiddenInputId);
           if (hiddenInput) {
             hiddenInput.value = savedBase64;
           }
         } else {
           console.log(`üì∑ No saved ${type} found in localStorage`);
         }
       });

       console.log('‚úÖ Witness image restoration completed');
     }

     // üì∏ Handle Witness Image Upload
     async function handleWitnessImageUpload(file, type) {
       if (!file) return;

       // Enhanced validation for JPG and other image files
       const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
       const allowedExtensions = ['.jpg', '.jpeg', '.png', '.webp'];
       const fileName = file.name.toLowerCase();
       const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

       // Check MIME type
       if (!allowedTypes.includes(file.type.toLowerCase())) {
         showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û JPG, JPEG, PNG ‡∏´‡∏£‡∏∑‡∏≠ WebP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
         return;
       }

       // Check file extension
       if (!allowedExtensions.includes(fileExtension)) {
         showToast('‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô .jpg, .jpeg, .png ‡∏´‡∏£‡∏∑‡∏≠ .webp ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
         return;
       }

       if (file.size > 5 * 1024 * 1024) { // 5MB limit
         showToast('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB (‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB)', 'error');
         return;
       }

       try {
         // Convert to base64
         const base64 = await convertFileToBase64(file);
         
         // Display preview first
         displayWitnessImagePreview(type, base64);
         
         // Show loading state
         showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${type === 'witnessPhoto' ? '‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô'}...`, 'info');
         
         // Save to server (async)
         try {
           await saveWitnessImageData(type, base64);
           showToast(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${type === 'witnessPhoto' ? '‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏¢‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
         } catch (error) {
           console.error('‚ùå Failed to upload image:', error);
           showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${error.message}`, 'error');
         }
         
       } catch (error) {
         console.error('Error processing witness image:', error);
         showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
       }
     }

     // üì± Capture Witness Image with Camera
     async function captureWitnessImageWithCamera(type) {
       console.log('üì∏ captureWitnessImageWithCamera called with type:', type);

       // ÔøΩ Force reset modal state if needed
       const modal = document.getElementById('cameraModal');
       if (modal && !modal.classList.contains('hidden')) {
         console.log('üîß Forcing modal reset to fix stuck state...');
         resetCameraModal();
       }

       // ÔøΩüîí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
       if (window._cameraInProgress) {
         console.log('‚ö†Ô∏è Camera operation already in progress');
         return;
       }

       window._cameraInProgress = true;

       try {
         // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost
         const isSecureContext = window.isSecureContext;
         console.log('üîí Secure context:', isSecureContext);
         console.log('üìç Location:', window.location.protocol + '//' + window.location.host);
         
         if (!isSecureContext) {
           showToast('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'error');
           console.error('Camera requires HTTPS or localhost. Current:', window.location.href);
           window._cameraInProgress = false;
           return;
         }
         
         if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
           showToast('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'error');
           console.error('MediaDevices API not available');
           window._cameraInProgress = false;
           return;
         }
         
         console.log('üì∑ Requesting camera permission...');
         
         // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ constraint ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô
         const constraints = {
           video: true,
           audio: false
         };
         
         const stream = await navigator.mediaDevices.getUserMedia(constraints);
         
         console.log('‚úÖ Camera stream obtained:', stream);
         console.log('üìπ Stream tracks:', stream.getTracks());
         
         showWitnessCameraModal(stream, type);
         
       } catch (error) {
         console.error('‚ùå Camera error details:', {
           name: error.name,
           message: error.message,
           constraint: error.constraint,
           stack: error.stack
         });
         
         // ‡πÅ‡∏™‡∏î‡∏á error ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
         let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
         
         if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
           errorMessage = '‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ browser';
         } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
           errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
         } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
           errorMessage = '‚ùå ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô';
         } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
           errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
         } else if (error.name === 'TypeError') {
           errorMessage = '‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
         }
         
         showToast(errorMessage, 'error');
         alert(errorMessage + '\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + error.message);
       } finally {
         // Reset flag after a delay
         setTimeout(() => {
           window._cameraInProgress = false;
         }, 1000);
       }
     }

     // üîß Reset Witness Camera Modal State
     function resetWitnessCameraModal(type) {
       let modalId, videoId;

       if (type === 'witnessPhoto') {
         modalId = 'witnessPhotoCameraModal';
         videoId = 'witnessPhotoVideo';
       } else if (type === 'witnessIdCard') {
         modalId = 'witnessIdCardCameraModal';
         videoId = 'witnessIdCardVideo';
       } else {
         return;
       }

       const modal = document.getElementById(modalId);
       const video = document.getElementById(videoId);

       if (modal) {
         // Force close modal
         modal.classList.add('hidden');
         modal.classList.remove('flex');
         
         // Reset all inline styles
         modal.style.display = '';
         modal.style.visibility = '';
         modal.style.opacity = '';
         modal.style.pointerEvents = '';
         
         // Stop any existing video streams
         if (video && video.srcObject) {
           const tracks = video.srcObject.getTracks();
           tracks.forEach(track => track.stop());
           video.srcObject = null;
         }
         
         // Reset camera progress flag
         window._cameraInProgress = false;
         
         console.log(`‚úÖ ${type} camera modal state reset`);
       }
     }

     // üîß Reset Camera Modal State (Original for other uses)
     function resetCameraModal() {
       const modal = document.getElementById('cameraModal');
       const video = document.getElementById('cameraVideo');

       if (modal) {
         // Force close modal
         modal.classList.add('hidden');
         modal.classList.remove('flex');
         
         // Reset all inline styles
         modal.style.display = '';
         modal.style.visibility = '';
         modal.style.opacity = '';
         modal.style.pointerEvents = '';
         
         // Stop any existing video streams
         if (video && video.srcObject) {
           const tracks = video.srcObject.getTracks();
           tracks.forEach(track => track.stop());
           video.srcObject = null;
         }
         
         // Reset camera progress flag
         window._cameraInProgress = false;
         
         console.log('‚úÖ Camera modal state reset');
       }
     }

     // üì∑ Show Witness Camera Modal
     function showWitnessCameraModal(stream, type) {
       console.log('üé¨ showWitnessCameraModal called with type:', type);

       // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å modal ‡πÅ‡∏•‡∏∞ elements ‡∏ï‡∏≤‡∏° type
       let modalId, videoId, captureBtnId, closeBtnId;

       if (type === 'witnessPhoto') {
         modalId = 'witnessPhotoCameraModal';
         videoId = 'witnessPhotoVideo';
         captureBtnId = 'captureWitnessPhoto';
         closeBtnId = 'closeWitnessPhotoModal';
       } else if (type === 'witnessIdCard') {
         modalId = 'witnessIdCardCameraModal';
         videoId = 'witnessIdCardVideo';
         captureBtnId = 'captureWitnessIdCard';
         closeBtnId = 'closeWitnessIdCardModal';
       } else {
         console.error('‚ùå Unknown witness type:', type);
         stream.getTracks().forEach(track => track.stop());
         return;
       }

       const modal = document.getElementById(modalId);
       const video = document.getElementById(videoId);
       const captureBtn = document.getElementById(captureBtnId);
       const cancelBtn = document.getElementById(closeBtnId);

       if (!modal) {
         console.error(`‚ùå ${modalId} not found in DOM`);
         console.log('üìã Available modals:', document.querySelectorAll('[id*="Modal"]'));
         stream.getTracks().forEach(track => track.stop());
         showToast(`‡πÑ‡∏°‡πà‡∏û‡∏ö ${modalId} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`, 'error');
         return;
       }

       console.log('‚úÖ Modal found, current state:', {
         hidden: modal.classList.contains('hidden'),
         display: modal.style.display,
         classes: modal.className
       });

       // ÔøΩ Reset modal if already open instead of skipping
       if (!modal.classList.contains('hidden')) {
         console.log('üîß Modal already open, resetting first...');
         resetWitnessCameraModal(type);
         // Small delay to ensure cleanup is complete
         setTimeout(() => showWitnessCameraModal(stream, type), 100);
         return;
       }

       if (!video) {
         console.error('‚ùå Video element not found in camera modal');
         stream.getTracks().forEach(track => track.stop());
         showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö Video Element ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
         return;
       }

       if (!captureBtn || !cancelBtn) {
         console.error('‚ùå Camera modal buttons not found', { captureBtn: !!captureBtn, cancelBtn: !!cancelBtn });
         stream.getTracks().forEach(track => track.stop());
         showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
         return;
       }

       // Setup video stream
       video.srcObject = stream;

       // Force show modal - remove all hiding styles
       modal.classList.remove('hidden');
       modal.classList.add('flex');
       modal.style.display = 'flex';  // Force display flex
       modal.style.visibility = 'visible';  // Ensure visible
       modal.style.opacity = '1';  // Ensure opaque
       modal.style.pointerEvents = 'auto';  // Enable interaction

       console.log('üé• Modal display updated:', {
         hidden: modal.classList.contains('hidden'),
         display: modal.style.display,
         visibility: modal.style.visibility,
         classes: modal.className,
         computedStyle: window.getComputedStyle(modal).display
       });

       // Title ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô HTML ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô

       // Wait for video to be ready
       video.onloadedmetadata = () => {
         console.log('üìπ Video ready:', {
           width: video.videoWidth,
           height: video.videoHeight,
           readyState: video.readyState
         });
       };

       // Handle capture
       const handleCapture = () => {
         captureWitnessPhoto(video, stream, type);
         cleanup();
       };

       // Handle cancel
       const handleCancel = () => {
         cleanup();
       };

       // Cleanup function
       const cleanup = () => {
         console.log('üßπ Cleaning up camera modal...');
         
         // Stop video stream
         if (stream) {
           stream.getTracks().forEach(track => {
             track.stop();
             console.log('üõë Stopped track:', track.label);
           });
         }
         
         // Reset modal display
         modal.classList.add('hidden');
         modal.classList.remove('flex');
         
         // Reset all inline styles that we added
         modal.style.display = '';
         modal.style.visibility = '';
         modal.style.opacity = '';
         modal.style.pointerEvents = '';
         
         // Remove event listeners
         if (captureBtn) captureBtn.removeEventListener('click', handleCapture);
         if (cancelBtn) cancelBtn.removeEventListener('click', handleCancel);
         
         // Reset video element
         if (video) {
           video.srcObject = null;
         }
         
         // Reset modal title
         if (title) {
           title.textContent = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
         }
         
         // Reset camera progress flag
         window._cameraInProgress = false;
         
         console.log('‚úÖ Camera modal cleanup complete');
       };

       // Add event listeners
       captureBtn.addEventListener('click', handleCapture);
       cancelBtn.addEventListener('click', handleCancel);

       // Also allow clicking backdrop to close
       modal.addEventListener('click', (e) => {
         if (e.target === modal) {
           console.log('üìç Backdrop clicked, closing modal');
           handleCancel();
         }
       });

       // Handle ESC key
       const handleEsc = (e) => {
         if (e.key === 'Escape') {
           console.log('‚å®Ô∏è ESC pressed, closing modal');
           handleCancel();
           document.removeEventListener('keydown', handleEsc);
         }
       };
       document.addEventListener('keydown', handleEsc);
     }

     // üì∏ Capture Witness Photo from Video
     async function captureWitnessPhoto(video, stream, type) {
       console.log('üì∏ captureWitnessPhoto called:', { type, videoReady: !!video, streamActive: !!stream });

       try {
         const canvas = document.createElement('canvas');
         const context = canvas.getContext('2d');
         
         canvas.width = video.videoWidth;
         canvas.height = video.videoHeight;
         
         console.log('üé® Canvas dimensions:', { width: canvas.width, height: canvas.height });
         
         context.drawImage(video, 0, 0);
         
         const base64 = canvas.toDataURL('image/jpeg', 0.8);
         console.log('üì∑ Image captured, base64 length:', base64.length);
         
         // Display preview first
         displayWitnessImagePreview(type, base64);
         
         // Show loading state
         showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î${type === 'witnessPhoto' ? '‡∏£‡∏π‡∏õ‡∏û‡∏¢‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô'}...`, 'info');
         
         // Save to server (async)
         try {
           await saveWitnessImageData(type, base64);
           showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${type === 'witnessPhoto' ? '‡∏£‡∏π‡∏õ‡∏û‡∏¢‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
         } catch (error) {
           console.error('‚ùå Failed to save image:', error);
           showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ${error.message}`, 'error');
         }
         
       } catch (error) {
         console.error('‚ùå Error capturing photo:', error);
         showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', 'error');
       }
     }

     // üñºÔ∏è Display Witness Image Preview
     function displayWitnessImagePreview(type, base64) {
       console.log('üñºÔ∏è displayWitnessImagePreview called:', { type, base64: base64?.substring(0, 50) + '...' });

       const preview = document.getElementById(`${type}Preview`);
       const placeholder = document.getElementById(`${type}Placeholder`);
       const image = document.getElementById(`${type}Image`);
       const status = document.getElementById(`${type}Status`);
       const actions = document.getElementById(`${type}Actions`);

       console.log('üéØ Elements found:', {
         preview: !!preview,
         placeholder: !!placeholder,
         image: !!image,
         status: !!status,
         actions: !!actions,
         previewId: `${type}Preview`,
         placeholderId: `${type}Placeholder`,
         imageId: `${type}Image`,
         statusId: `${type}Status`,
         actionsId: `${type}Actions`
       });

       if (preview && placeholder && image) {
         console.log('‚úÖ All required elements found, updating preview...');
         
         preview.classList.remove('hidden');
         placeholder.classList.add('hidden');
         actions?.classList.remove('hidden');
         
         image.src = base64;
         console.log('üñºÔ∏è Image src updated:', image.src.substring(0, 50) + '...');
         
         if (status) {
           status.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
           status.className = 'status-badge completed';
           console.log('‚úÖ Status updated to completed');
         }
         
         console.log('üéâ Preview display completed successfully');
       } else {
         console.error('‚ùå Missing required elements for preview display');
       }
     }

     // üåê Upload Image to Server
     async function uploadImageToServer(type, base64) {
       try {
         console.log('üåê Uploading image to server:', { type, base64Length: base64?.length });
         
         // Convert base64 to blob
         const response = await fetch(base64);
         const blob = await response.blob();
         
         // Create FormData
         const formData = new FormData();
         const filename = `${type}_${getBranchCode()}_${Date.now()}.jpg`;
         formData.append('file', blob, filename);
         formData.append('type', type);
         formData.append('branchCode', getBranchCode());
         
         console.log('ÔøΩ Sending to server:', { filename, type, branchCode: getBranchCode() });
         
         // Upload to server
         const uploadResponse = await fetch('/api/upload/installment-image', {
           method: 'POST',
           headers: {
             'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
           },
           body: formData
         });
         
         if (!uploadResponse.ok) {
           throw new Error(`Upload failed: ${uploadResponse.status}`);
         }
         
         const result = await uploadResponse.json();
         console.log('‚úÖ Upload successful:', result);
         
         return result.url; // Return server URL
         
       } catch (error) {
         console.error('‚ùå Upload failed:', error);
         throw error;
       }
     }

     // ÔøΩüíæ Save Witness Image Data (Updated to use server storage)
     async function saveWitnessImageData(type, base64) {
       console.log('üíæ saveWitnessImageData called:', { type, base64Length: base64?.length });

       try {
         // First upload to server
         const serverUrl = await uploadImageToServer(type, base64);
         console.log('üìÅ Image uploaded to server:', serverUrl);
         
         // Save server URL to hidden input - fix ID mapping for witnessIdCard
         let hiddenInputId = `${type}Url`;
         if (type === 'witnessIdCard') {
           hiddenInputId = 'witnessIdCardImageUrl'; // Use the correct ID from HTML
         } else if (type === 'witnessPhoto') {
           hiddenInputId = 'witnessPhotoUrl';
         }
         
         const hiddenInput = document.getElementById(hiddenInputId);
         console.log('üéØ Hidden input found:', {
           element: !!hiddenInput,
           inputId: hiddenInputId,
           type: type,
           serverUrl: serverUrl
         });
         
         if (hiddenInput) {
           hiddenInput.value = serverUrl; // Store server URL instead of base64
           console.log('‚úÖ Hidden input updated with server URL');
         } else {
           console.error('‚ùå Hidden input not found:', hiddenInputId);
         }
         
         // Also save to localStorage for backup (keep base64 for immediate preview)
         const storageKey = `witness_${type}`;
         localStorage.setItem(storageKey, base64); // Keep base64 for preview
         localStorage.setItem(`${storageKey}_url`, serverUrl); // Store server URL
         console.log('üíæ Saved to localStorage:', { storageKey, serverUrl });
         
         // Update witness data in Global Data Manager
         updateWitnessDataInGlobalManager();
         console.log('üîÑ Global Data Manager updated');
         
         return serverUrl;
         
       } catch (error) {
         console.error('‚ùå Failed to save image:', error);
         
         // Fallback: save base64 locally if server upload fails
         let hiddenInputId = `${type}Url`;
         if (type === 'witnessIdCard') {
           hiddenInputId = 'witnessIdCardImageUrl';
         } else if (type === 'witnessPhoto') {
           hiddenInputId = 'witnessPhotoUrl';
         }
         
         const hiddenInput = document.getElementById(hiddenInputId);
         if (hiddenInput) {
           hiddenInput.value = base64; // Fallback to base64
           console.log('üîÑ Fallback: using base64 storage');
         }
         
         const storageKey = `witness_${type}`;
         localStorage.setItem(storageKey, base64);
         
         updateWitnessDataInGlobalManager();
         
         throw error; // Re-throw for caller to handle
       }
     }

     // üè¢ Get Branch Code
     function getBranchCode() {
       const urlParams = new URLSearchParams(window.location.search);
       return urlParams.get('branch') || '00000';
     }

     // üóëÔ∏è Delete Witness Image
     async function deleteWitnessImage(type) {
       console.log('üóëÔ∏è deleteWitnessImage called:', { type });

       const preview = document.getElementById(`${type}Preview`);
       const placeholder = document.getElementById(`${type}Placeholder`);
       const status = document.getElementById(`${type}Status`);
       const actions = document.getElementById(`${type}Actions`);

       // Fix hidden input ID mapping for witnessIdCard
       let hiddenInputId = `${type}Url`;
       if (type === 'witnessIdCard') {
         hiddenInputId = 'witnessIdCardImageUrl';
       } else if (type === 'witnessPhoto') {
         hiddenInputId = 'witnessPhotoUrl';
       }

       const hiddenInput = document.getElementById(hiddenInputId);

       if (preview && placeholder) {
         preview.classList.add('hidden');
         placeholder.classList.remove('hidden');
         actions?.classList.add('hidden');
         
         if (status) {
           status.textContent = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
           status.className = 'status-badge pending';
         }
         
         if (hiddenInput) {
           hiddenInput.value = '';
         }
         
         // Remove from localStorage (both base64 and server URL)
         localStorage.removeItem(`witness_${type}`);
         localStorage.removeItem(`witness_${type}_url`);
         
         // Update witness data
         updateWitnessDataInGlobalManager();
         
         showToast(`‡∏•‡∏ö${type === 'witnessPhoto' ? '‡∏£‡∏π‡∏õ‡∏û‡∏¢‡∏≤‡∏ô' : '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏û‡∏¢‡∏≤‡∏ô'}‡πÅ‡∏•‡πâ‡∏ß`, 'success');
       }
     }

     // üîß Format Witness ID Card
     window.formatWitnessIdCard = function(input) {
       let value = input.value.replace(/\D/g, '');
       if (value.length > 13) value = value.substring(0, 13);

       if (value.length >= 1) {
         let formatted = value.substring(0, 1);
         if (value.length >= 2) formatted += '-' + value.substring(1, 5);
         if (value.length >= 6) formatted += '-' + value.substring(5, 10);
         if (value.length >= 11) formatted += '-' + value.substring(10, 12);
         if (value.length >= 13) formatted += '-' + value.substring(12, 13);
         value = formatted;
       }

       input.value = value;

       // Real-time validation
       const cleanValue = value.replace(/\D/g, '');
       if (cleanValue.length === 13) {
         markFieldAsValid(input);
       } else if (cleanValue.length > 0) {
         markFieldAsError(input);
       }

       updateWitnessDataInGlobalManager();
     };

     // üîß Format Witness Phone
     window.formatWitnessPhone = function(input) {
       let value = input.value.replace(/\D/g, '');
       if (value.length > 10) value = value.substring(0, 10);

       if (value.length >= 6) {
         value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
       } else if (value.length >= 3) {
         value = value.substring(0, 3) + '-' + value.substring(3);
       }

       input.value = value;

       // Real-time validation
       const cleanValue = value.replace(/\D/g, '');
       if (cleanValue.length === 10) {
         markFieldAsValid(input);
       } else if (cleanValue.length > 0) {
         markFieldAsError(input);
       }

       updateWitnessDataInGlobalManager();
     };

     // üìä Update Witness Data in Global Manager
     function updateWitnessDataInGlobalManager() {
       const witnessData = gatherWitnessData();

       // Save to hidden input
       const witnessDataInput = document.getElementById('witnessData');
       if (witnessDataInput) {
         witnessDataInput.value = JSON.stringify(witnessData);
       }

       // Save to localStorage
       localStorage.setItem('witness_data', JSON.stringify(witnessData));

       // Update Global Data Manager if available
       if (window.globalInstallmentManager) {
         window.globalInstallmentManager.updateStepData(2, {
           witness: witnessData
         });
       }
     }

     // üìã Gather Witness Data
     function gatherWitnessData() {
       // Get server URLs with fallback to localStorage
       const photoUrl = document.getElementById('witnessPhotoUrl')?.value ||
                       localStorage.getItem('witness_witnessPhoto_url') ||
                       localStorage.getItem('witness_witnessPhoto') || '';
         
       const idCardImageUrl = document.getElementById('witnessIdCardImageUrl')?.value ||
                             localStorage.getItem('witness_witnessIdCard_url') ||
                             localStorage.getItem('witness_witnessIdCard') || '';

       return {
         firstName: document.getElementById('witnessFirstName')?.value || '',
         lastName: document.getElementById('witnessLastName')?.value || '',
         idCard: document.getElementById('witnessIdCard')?.value || '',
         phone: document.getElementById('witnessPhone')?.value || '',
         relationship: document.getElementById('witnessRelationship')?.value || '',
         photoUrl: photoUrl,
         idCardImageUrl: idCardImageUrl,
         timestamp: new Date().toISOString()
       };
     }

     // üîß Convert File to Base64 (if not already defined)
     if (typeof convertFileToBase64 === 'undefined') {
       function convertFileToBase64(file) {
         return new Promise((resolve, reject) => {
           const reader = new FileReader();
           reader.onload = () => resolve(reader.result);
           reader.onerror = reject;
           reader.readAsDataURL(file);
         });
       }
     }
  </script>
  
  <!-- Immediate salesperson name cleanup -->
  <script>
    // Immediately clear old salesperson data when page loads
    if (typeof clearAndReloadSalesperson === 'function') {
      clearAndReloadSalesperson();
    } else {
      // Fallback cleanup
      localStorage.removeItem('salespersonName');
      localStorage.removeItem('employeeName');
      console.log('üßπ Immediate cleanup of old salesperson data');
    }

// Show/Hide Loading with Lottie animation
let step2LottieAnimation = null;
function showStep2Loading(show) {
  const loader = document.getElementById('step2LoadingOverlay');

  // Check if loader element exists
  if (!loader) {
    console.warn('‚ö†Ô∏è step2LoadingOverlay element not found');
    return;
  }

  if (show) {
    loader.style.display = 'flex';
    loader.classList.remove('animate__fadeOut');
    loader.classList.add('animate__fadeIn');

    if (!step2LottieAnimation) {
      console.log('=üîÑ Loading Lottie animation from /Loading/Loading.json');
      fetch('/Loading/Loading.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(animationData => {
          const lottieContainer = document.getElementById('step2LottieContainer');
          if (lottieContainer) {
            step2LottieAnimation = lottie.loadAnimation({
              container: lottieContainer,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              animationData: animationData
            });
            console.log('‚úÖ Lottie animation loaded successfully');
          }
        })
        .catch(error => {
          console.error('‚ùå Error loading Lottie animation:', error);
          const lottieContainer = document.getElementById('step2LottieContainer');
          if (lottieContainer) {
            lottieContainer.innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
          }
        });
    } else {
      if (step2LottieAnimation) {
        step2LottieAnimation.play();
      }
    }
  } else {
    if (step2LottieAnimation) {
      step2LottieAnimation.pause();
    }
    loader.classList.remove('animate__fadeIn');
    loader.classList.add('animate__fadeOut');
    setTimeout(() => { loader.style.display = 'none'; }, 600);
  }
}

// Loading system is now integrated with main DOMContentLoaded event above

// =================== COMPREHENSIVE THAI ADDRESS SYSTEM ===================

// Comprehensive Thai Address Dataset
window.THAI_ADDRESS_DATA = {
  // All 77 Thai Provinces with ID, Name (Thai), Name (English), and Region
  provinces: [
    {id: 1, name: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', name_en: 'Bangkok', region: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø'},
    {id: 2, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', name_en: 'Samut Prakan', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 3, name: '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Nonthaburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 4, name: '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Pathum Thani', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 5, name: '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', name_en: 'Phra Nakhon Si Ayutthaya', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 6, name: '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', name_en: 'Ang Thong', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 7, name: '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Lopburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 8, name: '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sing Buri', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 9, name: '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', name_en: 'Chai Nat', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 10, name: '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Saraburi', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 11, name: '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chonburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 12, name: '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', name_en: 'Rayong', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 13, name: '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Chanthaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 14, name: '‡∏ï‡∏£‡∏≤‡∏î', name_en: 'Trat', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 15, name: '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤', name_en: 'Chachoengsao', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 16, name: '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Prachin Buri', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 17, name: '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å', name_en: 'Nakhon Nayok', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 18, name: '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', name_en: 'Sa Kaeo', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å'},
    {id: 19, name: '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', name_en: 'Nakhon Ratchasima', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 20, name: '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', name_en: 'Buriram', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 21, name: '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', name_en: 'Surin', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 22, name: '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', name_en: 'Sisaket', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 23, name: '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Ubon Ratchathani', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 24, name: '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', name_en: 'Yasothon', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 25, name: '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', name_en: 'Chaiyaphum', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 26, name: '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç', name_en: 'Amnat Charoen', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 27, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', name_en: 'Nong Bua Lam Phu', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 28, name: '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Khon Kaen', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 29, name: '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Udon Thani', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 30, name: '‡πÄ‡∏•‡∏¢', name_en: 'Loei', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 31, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', name_en: 'Nong Khai', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 32, name: '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', name_en: 'Maha Sarakham', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 33, name: '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', name_en: 'Roi Et', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 34, name: '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', name_en: 'Kalasin', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 35, name: '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', name_en: 'Sakon Nakhon', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 36, name: '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', name_en: 'Nakhon Phanom', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 37, name: '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', name_en: 'Mukdahan', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'},
    {id: 38, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', name_en: 'Chiang Mai', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 39, name: '‡∏•‡∏≥‡∏û‡∏π‡∏ô', name_en: 'Lamphun', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 40, name: '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', name_en: 'Lampang', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 41, name: '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå', name_en: 'Uttaradit', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 42, name: '‡πÅ‡∏û‡∏£‡πà', name_en: 'Phrae', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 43, name: '‡∏ô‡πà‡∏≤‡∏ô', name_en: 'Nan', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 44, name: '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', name_en: 'Phayao', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 45, name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', name_en: 'Chiang Rai', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 46, name: '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', name_en: 'Mae Hong Son', region: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠'},
    {id: 47, name: '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå', name_en: 'Nakhon Sawan', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 48, name: '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Uthai Thani', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 49, name: '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', name_en: 'Kamphaeng Phet', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 50, name: '‡∏ï‡∏≤‡∏Å', name_en: 'Tak', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
    {id: 51, name: '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', name_en: 'Sukhothai', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 52, name: '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', name_en: 'Phitsanulok', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 53, name: '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', name_en: 'Phichit', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 54, name: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', name_en: 'Phetchabun', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 55, name: '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Ratchaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
    {id: 56, name: '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Kanchanaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
    {id: 57, name: '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Suphan Buri', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 58, name: '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', name_en: 'Nakhon Pathom', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 59, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', name_en: 'Samut Sakhon', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 60, name: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', name_en: 'Samut Songkhram', region: '‡∏Å‡∏•‡∏≤‡∏á'},
    {id: 61, name: '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Phetchaburi', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
    {id: 62, name: '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', name_en: 'Prachuap Khiri Khan', region: '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å'},
    {id: 63, name: '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', name_en: 'Nakhon Si Thammarat', region: '‡πÉ‡∏ï‡πâ'},
    {id: 64, name: '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', name_en: 'Krabi', region: '‡πÉ‡∏ï‡πâ'},
    {id: 65, name: '‡∏û‡∏±‡∏á‡∏á‡∏≤', name_en: 'Phang Nga', region: '‡πÉ‡∏ï‡πâ'},
    {id: 66, name: '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', name_en: 'Phuket', region: '‡πÉ‡∏ï‡πâ'},
    {id: 67, name: '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', name_en: 'Surat Thani', region: '‡πÉ‡∏ï‡πâ'},
    {id: 68, name: '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', name_en: 'Ranong', region: '‡πÉ‡∏ï‡πâ'},
    {id: 69, name: '‡∏ä‡∏∏‡∏°‡∏û‡∏£', name_en: 'Chumphon', region: '‡πÉ‡∏ï‡πâ'},
    {id: 70, name: '‡∏™‡∏á‡∏Ç‡∏•‡∏≤', name_en: 'Songkhla', region: '‡πÉ‡∏ï‡πâ'},
    {id: 71, name: '‡∏™‡∏ï‡∏π‡∏•', name_en: 'Satun', region: '‡πÉ‡∏ï‡πâ'},
    {id: 72, name: '‡∏ï‡∏£‡∏±‡∏á', name_en: 'Trang', region: '‡πÉ‡∏ï‡πâ'},
    {id: 73, name: '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', name_en: 'Phatthalung', region: '‡πÉ‡∏ï‡πâ'},
    {id: 74, name: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', name_en: 'Pattani', region: '‡πÉ‡∏ï‡πâ'},
    {id: 75, name: '‡∏¢‡∏∞‡∏•‡∏≤', name_en: 'Yala', region: '‡πÉ‡∏ï‡πâ'},
    {id: 76, name: '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', name_en: 'Narathiwat', region: '‡πÉ‡∏ï‡πâ'},
    {id: 77, name: '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', name_en: 'Bueng Kan', region: '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô'}
  ],

  // Sample comprehensive districts for key provinces - will be populated by functions
  districts: {},

  // Sample comprehensive sub-districts - will be populated by functions
  subDistricts: {},

  // Postal codes mapping
  postalCodes: {}
};

// Initialize comprehensive address data
function initializeThaiAddressData() {
  console.log('üåç Initializing Comprehensive Thai Address System...');

  // Pattani Districts
  window.THAI_ADDRESS_DATA.districts[74] = [
    {id: 7401, province_id: 74, name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', name_en: 'Mueang Pattani'},
    {id: 7402, province_id: 74, name: '‡πÇ‡∏Ñ‡∏Å‡πÇ‡∏û‡∏ò‡∏¥‡πå', name_en: 'Khok Pho'},
    {id: 7403, province_id: 74, name: '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å', name_en: 'Nong Chik'},
    {id: 7404, province_id: 74, name: '‡∏õ‡∏∞‡∏ô‡∏≤‡πÄ‡∏£‡∏∞', name_en: 'Panare'},
    {id: 7405, province_id: 74, name: '‡∏°‡∏≤‡∏¢‡∏≠', name_en: 'Mayo'},
    {id: 7406, province_id: 74, name: '‡∏ó‡∏∏‡πà‡∏á‡∏¢‡∏≤‡∏á‡πÅ‡∏î‡∏á', name_en: 'Thung Yang Daeng'},
    {id: 7407, province_id: 74, name: '‡∏™‡∏≤‡∏¢‡∏ö‡∏∏‡∏£‡∏µ', name_en: 'Sai Buri'},
    {id: 7408, province_id: 74, name: '‡πÑ‡∏°‡πâ‡πÅ‡∏Å‡πà‡∏ô', name_en: 'Mai Kaen'},
    {id: 7409, province_id: 74, name: '‡∏¢‡∏∞‡∏£‡∏±‡∏á', name_en: 'Yarang'},
    {id: 7410, province_id: 74, name: '‡∏¢‡∏∞‡∏´‡∏£‡∏¥‡πà‡∏á', name_en: 'Yaring'},
    {id: 7411, province_id: 74, name: '‡∏Å‡∏∞‡∏û‡πâ‡∏≠', name_en: 'Kapho'},
    {id: 7412, province_id: 74, name: '‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô', name_en: 'Mae Lan'}
  ];

  // Sample sub-districts for key districts
  window.THAI_ADDRESS_DATA.subDistricts[7409] = [
    {id: 740901, district_id: 7409, name: '‡∏¢‡∏∞‡∏£‡∏±‡∏á', name_en: 'Yarang', postal_code: '94160'},
    {id: 740902, district_id: 7409, name: '‡∏£‡∏∞‡πÅ‡∏ß‡πâ‡∏á', name_en: 'Rawaeng', postal_code: '94160'},
    {id: 740903, district_id: 7409, name: '‡∏•‡∏¥‡∏°‡∏¥', name_en: 'Limi', postal_code: '94160'},
    {id: 740904, district_id: 7409, name: '‡∏õ‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤', name_en: 'Pak Kha', postal_code: '94160'},
    {id: 740905, district_id: 7409, name: '‡∏ö‡∏∑‡∏≠‡πÅ‡∏Å', name_en: 'Bue Kae', postal_code: '94160'}
  ];

  console.log('‚úÖ Thai Address Data initialized');
  console.log('  - Total provinces:', window.THAI_ADDRESS_DATA.provinces.length);
  console.log('  - Sample districts for Pattani:', Object.keys(window.THAI_ADDRESS_DATA.districts).length);
  console.log('  - Sample sub-districts:', Object.keys(window.THAI_ADDRESS_DATA.subDistricts).length);
}

// Enhanced dropdown setup function
function setupEnhancedDropdown(inputElement, dropdownElement, onSelectCallback, options = {}) {
  const defaultOptions = {
    searchDelay: 300,
    placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
    noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
    loadingText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'
  };

  const config = { ...defaultOptions, ...options };
  let searchTimeout;
  let currentSelectedIndex = -1;
  let isDropdownVisible = false;

  // Show dropdown with data
  function showDropdown(data) {
    if (!data || data.length === 0) {
      dropdownElement.innerHTML = `<div class="p-4 text-center text-gray-500">${config.noResultsText}</div>`;
    } else {
      dropdownElement.innerHTML = data.map((item, index) => {
        const mainText = item.name || item.text || '';
        const subText = item.region ? `‡∏†‡∏≤‡∏Ñ${item.region}` : (item.name_en || '');

        return `
          <div class="dropdown-item ${index === currentSelectedIndex ? 'selected' : ''}"
               data-index="${index}"
               data-value="${JSON.stringify(item).replace(/"/g, '&quot;')}">
            <div class="dropdown-item-main">${mainText}</div>
            ${subText ? `<div class="dropdown-item-sub">${subText}</div>` : ''}
          </div>
        `;
      }).join('');

      // Add click listeners
      dropdownElement.querySelectorAll('.dropdown-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          const itemData = JSON.parse(item.getAttribute('data-value').replace(/&quot;/g, '"'));
          selectItem(itemData);
        });
      });
    }

    dropdownElement.classList.remove('hidden');
    isDropdownVisible = true;
  }

  // Hide dropdown
  function hideDropdown() {
    dropdownElement.classList.add('hidden');
    isDropdownVisible = false;
    currentSelectedIndex = -1;
  }

  // Select item
  function selectItem(itemData) {
    hideDropdown();
    if (onSelectCallback) {
      onSelectCallback(itemData);
    }
  }

  // Handle keyboard navigation
  function handleKeyboardNavigation(e) {
    if (!isDropdownVisible) return;

    const items = dropdownElement.querySelectorAll('.dropdown-item');

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
        updateSelection(items);
        break;
      case 'ArrowUp':
        e.preventDefault();
        currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
        updateSelection(items);
        break;
      case 'Enter':
        e.preventDefault();
        if (currentSelectedIndex >= 0 && items[currentSelectedIndex]) {
          const itemData = JSON.parse(items[currentSelectedIndex].getAttribute('data-value').replace(/&quot;/g, '"'));
          selectItem(itemData);
        }
        break;
      case 'Escape':
        hideDropdown();
        break;
    }
  }

  // Update visual selection
  function updateSelection(items) {
    items.forEach((item, index) => {
      item.classList.toggle('selected', index === currentSelectedIndex);
    });

    // Scroll selected item into view
    if (currentSelectedIndex >= 0 && items[currentSelectedIndex]) {
      items[currentSelectedIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  // Event listeners
  inputElement.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const searchTerm = e.target.value.trim();
      if (searchTerm.length >= 1) {
        // Search in provinces
        const filteredData = window.THAI_ADDRESS_DATA.provinces.filter(province =>
          province.name.includes(searchTerm) ||
          province.name_en.toLowerCase().includes(searchTerm.toLowerCase())
        );
        showDropdown(filteredData);
      } else {
        showDropdown(window.THAI_ADDRESS_DATA.provinces);
      }
    }, config.searchDelay);
  });

  inputElement.addEventListener('focus', () => {
    showDropdown(window.THAI_ADDRESS_DATA.provinces);
  });

  inputElement.addEventListener('keydown', handleKeyboardNavigation);

  // Hide dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!inputElement.contains(e.target) && !dropdownElement.contains(e.target)) {
      hideDropdown();
    }
  });

  return {
    show: showDropdown,
    hide: hideDropdown,
    updateData: showDropdown
  };
}

// Initialize enhanced address dropdowns
function initializeEnhancedAddressDropdowns() {
  try {
    initializeThaiAddressData();

    const provInput = document.getElementById('province');
    const distInput = document.getElementById('district');
    const subInput = document.getElementById('subDistrict');
    const zipInput = document.getElementById('zipcode');

    const provDD = document.getElementById('provinceDropdown');
    const distDD = document.getElementById('districtDropdown');
    const subDD = document.getElementById('subDistrictDropdown');

    if (!provInput || !distInput || !subInput || !zipInput || !provDD || !distDD || !subDD) {
      console.warn('‚ö†Ô∏è Some address elements not found, skipping enhanced initialization');
      return;
    }

    console.log('üèóÔ∏è Setting up enhanced Thai address dropdowns...');

    // Setup Province dropdown
    setupEnhancedDropdown(provInput, provDD, (itemData) => {
      console.log('üèõÔ∏è Selected province:', itemData.name);

      // Set province value
      provInput.value = itemData.name;

      // Clear dependent fields
      distInput.value = '';
      subInput.value = '';
      zipInput.value = '';

      // Load districts for this province (if available)
      const districts = window.THAI_ADDRESS_DATA.districts[itemData.id] || [];
      setupDistrictDropdown(distInput, distDD, districts, itemData.id);

      // Clear sub-district dropdown
      subDD.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô</div>';

      // Trigger change event for other handlers
      provInput.dispatchEvent(new Event('change', { bubbles: true }));
    }, {
      searchDelay: 200,
      placeholder: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
      noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£',
      loadingText: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...'
    });

    console.log('‚úÖ Enhanced address dropdowns initialized');

  } catch (error) {
    console.error('‚ùå Error initializing enhanced address dropdowns:', error);
  }
}

// Setup district dropdown
function setupDistrictDropdown(distInput, distDD, districts, provinceId) {
  // Clear current listeners
  distInput.replaceWith(distInput.cloneNode(true));
  const newDistInput = document.getElementById('district');

  setupEnhancedDropdown(newDistInput, distDD, (itemData) => {
    console.log('üèòÔ∏è Selected district:', itemData.name);

    // Set district value
    newDistInput.value = itemData.name;

    // Clear dependent fields
    document.getElementById('subDistrict').value = '';
    document.getElementById('zipcode').value = '';

    // Load sub-districts for this district (if available)
    const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[itemData.id] || [];
    setupSubDistrictDropdown(document.getElementById('subDistrict'), document.getElementById('subDistrictDropdown'), subDistricts);

    // Trigger change event
    newDistInput.dispatchEvent(new Event('change', { bubbles: true }));
  }, {
    searchDelay: 200,
    placeholder: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
    noResultsText: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£'
  });

  // Override input handler for district search
  newDistInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    let filteredData = districts;

    if (searchTerm.length >= 1) {
      filteredData = districts.filter(district =>
        district.name.includes(searchTerm) ||
        district.name_en.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    if (filteredData.length === 0) {
      distDD.innerHTML = '<div class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>';
    } else {
      distDD.innerHTML = filteredData.map((item, index) => {
        return `
          <div class="dropdown-item" data-index="${index}"
               data-value="${JSON.stringify(item).replace(/"/g, '&quot;')}">
            <div class="dropdown-item-main">${item.name}</div>
            <div class="dropdown-item-sub">${item.name_en}</div>
          </div>
        `;
      }).join('');

      // Add click listeners
      distDD.querySelectorAll('.dropdown-item').forEach((item) => {
        item.addEventListener('click', () => {
          const itemData = JSON.parse(item.getAttribute('data-value').replace(/&quot;/g, '"'));
          newDistInput.value = itemData.name;
          distDD.classList.add('hidden');

          // Load sub-districts
          const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[itemData.id] || [];
          setupSubDistrictDropdown(document.getElementById('subDistrict'), document.getElementById('subDistrictDropdown'), subDistricts);

          newDistInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });
    }
  });

  newDistInput.addEventListener('focus', () => {
    if (districts.length > 0) {
      distDD.innerHTML = districts.map((item, index) => {
        return `
          <div class="dropdown-item" data-index="${index}"
               data-value="${JSON.stringify(item).replace(/"/g, '&quot;')}">
            <div class="dropdown-item-main">${item.name}</div>
            <div class="dropdown-item-sub">${item.name_en}</div>
          </div>
        `;
      }).join('');

      distDD.querySelectorAll('.dropdown-item').forEach((item) => {
        item.addEventListener('click', () => {
          const itemData = JSON.parse(item.getAttribute('data-value').replace(/&quot;/g, '"'));
          newDistInput.value = itemData.name;
          distDD.classList.add('hidden');

          const subDistricts = window.THAI_ADDRESS_DATA.subDistricts[itemData.id] || [];
          setupSubDistrictDropdown(document.getElementById('subDistrict'), document.getElementById('subDistrictDropdown'), subDistricts);

          newDistInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });

      distDD.classList.remove('hidden');
    }
  });
}

// Setup sub-district dropdown
function setupSubDistrictDropdown(subInput, subDD, subDistricts) {
  // Clear current listeners
  subInput.replaceWith(subInput.cloneNode(true));
  const newSubInput = document.getElementById('subDistrict');

  newSubInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    let filteredData = subDistricts;

    if (searchTerm.length >= 1) {
      filteredData = subDistricts.filter(subDistrict =>
        subDistrict.name.includes(searchTerm) ||
        subDistrict.name_en.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    if (filteredData.length === 0) {
      subDD.innerHTML = '<div class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>';
    } else {
      subDD.innerHTML = filteredData.map((item, index) => {
        return `
          <div class="dropdown-item" data-index="${index}"
               data-value="${JSON.stringify(item).replace(/"/g, '&quot;')}">
            <div class="dropdown-item-main">${item.name}</div>
            <div class="dropdown-item-sub">${item.name_en} ‚Ä¢ ${item.postal_code}</div>
          </div>
        `;
      }).join('');

      // Add click listeners
      subDD.querySelectorAll('.dropdown-item').forEach((item) => {
        item.addEventListener('click', () => {
          const itemData = JSON.parse(item.getAttribute('data-value').replace(/&quot;/g, '"'));
          newSubInput.value = itemData.name;
          subDD.classList.add('hidden');

          // Auto-fill postal code
          if (itemData.postal_code) {
            document.getElementById('zipcode').value = itemData.postal_code;
          }

          newSubInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });
    }
  });

  newSubInput.addEventListener('focus', () => {
    if (subDistricts.length > 0) {
      subDD.innerHTML = subDistricts.map((item, index) => {
        return `
          <div class="dropdown-item" data-index="${index}"
               data-value="${JSON.stringify(item).replace(/"/g, '&quot;')}">
            <div class="dropdown-item-main">${item.name}</div>
            <div class="dropdown-item-sub">${item.name_en} ‚Ä¢ ${item.postal_code}</div>
          </div>
        `;
      }).join('');

      subDD.querySelectorAll('.dropdown-item').forEach((item) => {
        item.addEventListener('click', () => {
          const itemData = JSON.parse(item.getAttribute('data-value').replace(/&quot;/g, '"'));
          newSubInput.value = itemData.name;
          subDD.classList.add('hidden');

          if (itemData.postal_code) {
            document.getElementById('zipcode').value = itemData.postal_code;
          }

          newSubInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });

      subDD.classList.remove('hidden');
    }
  });
}

window.addEventListener('beforeunload', () => {
  if (step2LottieAnimation) {
    step2LottieAnimation.destroy();
    step2LottieAnimation = null;
  }
});
  </script>
</body>
</html>