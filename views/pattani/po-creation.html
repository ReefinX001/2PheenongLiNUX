<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สร้างใบสั่งซื้อ - ขายด่วน</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Flatpickr CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Tab Styles */
    .tab-button {
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: rgb(37, 99, 235) !important;
      border-color: rgb(37, 99, 235) !important;
    }
    .tab-content {
      transition: opacity 0.3s ease;
    }
    .tab-content.hidden {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>

  <script>
    let lottieAnimation = null;
  </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">


  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <button onclick="goBack()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i class="bi bi-arrow-left text-xl"></i>
          </button>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
            <i class="bi bi-file-earmark-plus text-blue-500 mr-2"></i>
            สร้างใบสั่งซื้อ - ขายด่วน
          </h1>
        </div>
        <div class="flex items-center space-x-4">
          <span id="userInfo" class="text-sm text-gray-600 dark:text-gray-400"></span>
          <button id="btnToggleDark" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <i id="themeIcon" class="bi bi-moon-stars text-xl text-gray-700 dark:text-gray-300"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Tab Navigation -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
          <button id="tabPending" class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400">
            <i class="bi bi-lightning-charge mr-2"></i>
            สินค้าขายด่วน (<span id="countPending">0</span>)
          </button>
          <button id="tabHistory" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
            <i class="bi bi-clock-history mr-2"></i>
            ประวัติที่สร้าง PO (<span id="countHistory">0</span>)
          </button>
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <!-- Pending Products Tab -->
    <div id="contentPending" class="tab-content active">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 flex items-center">
            <i class="bi bi-lightning-charge text-yellow-500 mr-2"></i>
            สินค้าขายด่วนที่รออนุมัติ
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            เลือกสินค้าที่ต้องการสร้างใบสั่งซื้อ
          </p>
        </div>

        <div class="p-6">
          <div id="quickSaleProducts" class="space-y-4">
            <!-- Products will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="contentHistory" class="tab-content hidden">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 flex items-center">
            <i class="bi bi-clock-history text-green-500 mr-2"></i>
            ประวัติสินค้าที่สร้าง PO แล้ว
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            สินค้าที่ได้สร้างใบสั่งซื้อแล้ว
          </p>
        </div>

        <div class="p-6">
          <div id="historyProducts" class="space-y-4">
            <!-- History products will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- PO Creation Form -->
    <div id="poCreationForm" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hidden">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 flex items-center">
          <i class="bi bi-file-earmark-text text-green-500 mr-2"></i>
          ข้อมูลใบสั่งซื้อ
        </h2>
      </div>

      <form id="createPOForm" class="p-6 space-y-6">
        <!-- Row 1: PO Number, Date, Branch -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              เลขที่ใบสั่งซื้อ (PO Number)
            </label>
            <input type="text" id="poNumber" readonly 
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              วันที่ออกใบสั่งซื้อ
            </label>
            <input type="text" id="poDate" 
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              สาขา
            </label>
            <input type="text" id="branchName" readonly 
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
        </div>

        <!-- Row 2: Supplier, Category Group -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              เลือกซัพพลายเออร์ <span class="text-red-500">*</span>
            </label>
            <select id="supplierId" required 
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              <option value="">-- เลือกซัพพลายเออร์ --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              กลุ่มจัดประเภท
            </label>
            <input type="text" id="categoryGroup" readonly 
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
        </div>

        <!-- Row 3: Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            หมายเหตุ
          </label>
          <input type="text" id="notes" value="ขายด่วน" 
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        </div>

        <!-- Product Details Table -->
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center">
            <i class="bi bi-box-seam text-purple-500 mr-2"></i>
            รายละเอียดสินค้า
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
              <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-2 text-left">ชื่อสินค้า</th>
                  <th class="px-4 py-2 text-left">แบรนด์</th>
                  <th class="px-4 py-2 text-left">IMEI</th>
                  <th class="px-4 py-2 text-right">จำนวน (Qty)</th>
                  <th class="px-4 py-2 text-right">ต้นทุน/หน่วย</th>
                  <th class="px-4 py-2 text-right">ส่วนลด/หน่วย</th>
                  <th class="px-4 py-2 text-right">ภาษี (%)</th>
                  <th class="px-4 py-2 text-left">ประเภทภาษี</th>
                  <th class="px-4 py-2 text-right">มูลค่าก่อนภาษี</th>
                  <th class="px-4 py-2 text-right">ภาษี (บาท)</th>
                  <th class="px-4 py-2 text-right">รวมภาษี (บาท)</th>
                </tr>
              </thead>
              <tbody id="productDetailsTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Product details will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Summary -->
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">สรุปยอดรวม</h4>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">มูลค่าสินค้ารวม</div>
              <div class="text-lg font-medium text-blue-600 dark:text-blue-400" id="summarySubtotal">0.00</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">ส่วนลดรวม</div>
              <div class="text-lg font-medium text-orange-600 dark:text-orange-400" id="summaryDiscount">0.00</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">ภาษีรวม</div>
              <div class="text-lg font-medium text-purple-600 dark:text-purple-400" id="summaryTax">0.00</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-600 dark:text-gray-400">ยอดรวมสุทธิ</div>
              <div class="text-xl font-bold text-green-600 dark:text-green-400" id="summaryTotal">0.00</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4">
          <button type="button" onclick="cancelPOCreation()" 
                  class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            ยกเลิก
          </button>
          <button type="submit" 
                  class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            สร้างใบสั่งซื้อ
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

  <script>
    // Global variables
    let selectedProducts = [];
    let allSuppliers = [];
    let allBranches = [];
    let historyProducts = []; // เก็บสินค้าที่สร้าง PO แล้ว
    let currentTab = 'pending'; // แท็บปัจจุบัน
    
    // กำหนด branch code สำหรับสาขาปัตตานี
    const BRANCH_CODE = '00000';

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      showLoading(true);

      try {
        initializePage();
        setupDarkMode();
        setupDatePicker();
        setupTabEventListeners();
        await loadQuickSaleProducts();
        await loadSuppliers();
        await loadBranches();
        updateTabCounts();
      } catch (error) {
        console.error('Error during page initialization:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    function setupTabEventListeners() {
      document.getElementById('tabPending').addEventListener('click', () => switchTab('pending'));
      document.getElementById('tabHistory').addEventListener('click', () => switchTab('history'));
    }

    function initializePage() {
      // Load user info
      const userName = localStorage.getItem('userName') || 'ผู้ใช้งาน';
      document.getElementById('userInfo').textContent = `สวัสดี, ${userName}`;
    }

    function setupDarkMode() {
      function updateDarkMode() {
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);

        // Update icon
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) {
          if (isDark) {
            themeIcon.className = 'bi bi-sun-fill text-xl text-yellow-500';
          } else {
            themeIcon.className = 'bi bi-moon-stars text-xl text-gray-700 dark:text-gray-300';
          }
        }
      }

      function loadDarkMode() {
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        updateDarkMode();
      }

      loadDarkMode();

      const btn = document.getElementById('btnToggleDark');
      if (btn) {
        btn.addEventListener('click', () => {
          document.documentElement.classList.toggle('dark');
          updateDarkMode();
        });
      }
    }

    function setupDatePicker() {
      flatpickr('#poDate', {
        dateFormat: 'd/m/Y',
        defaultDate: 'today'
        // Removed locale: "th" as Thai locale is not loaded
      });
    }

    async function loadQuickSaleProducts() {
      try {
        showLoading(true);
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/approved?branch_code=${BRANCH_CODE}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('ไม่สามารถโหลดข้อมูลสินค้าได้');
        }

        const result = await response.json();
        console.log(`[po-creation] Loaded ${result.count} products from branch ${BRANCH_CODE}:`, result.data);

        // Debug: แสดงสถานะของสินค้าที่โหลดมา
        if (result.data && result.data.length > 0) {
          result.data.forEach((product, index) => {
            console.log(`Product ${index + 1}:`, {
              id: product._id,
              name: product.name,
              imei: product.imei,
              poCreatedInSystem: product.poCreatedInSystem,
              poSystemId: product.poSystemId,
              status: product.status
            });
          });
        }

        displayQuickSaleProducts(result.data);

      } catch (error) {
        console.error('Error loading quick sale products:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้า: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function displayQuickSaleProducts(products) {
      const container = document.getElementById('quickSaleProducts');
    
      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="bi bi-inbox text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">ไม่มีสินค้าขายด่วนที่รอสร้าง PO</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">กรุณาอนุมัติสินค้าจากหน้าขายด่วนฉุกเฉินก่อน</p>
          </div>
        `;
        return;
      }

      container.innerHTML = products.map(product => `
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <input type="checkbox" id="product_${product._id}" 
                     class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                     onchange="toggleProductSelection('${product._id}')">
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">${product.name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  ${product.brand} | IMEI: ${product.imei || 'N/A'}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-500">
                  PO: ${product.poNumber} | สาขา: ${product.branch_code}
                </p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-lg font-semibold text-green-600 dark:text-green-400">
                ฿${(product.cost || 0).toLocaleString()}
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-500">
                ${product.categoryGroup?.name || 'ไม่ระบุ'}
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Store products data
      window.quickSaleProductsData = products;
    }

    function toggleProductSelection(productId) {
      const checkbox = document.getElementById(`product_${productId}`);
      const product = window.quickSaleProductsData.find(p => p._id === productId);
    
      if (checkbox.checked) {
        selectedProducts.push(product);
      } else {
        selectedProducts = selectedProducts.filter(p => p._id !== productId);
      }

      updateCreatePOButton();
    }

    function updateCreatePOButton() {
      const hasSelection = selectedProducts.length > 0;
    
      if (hasSelection) {
        document.getElementById('poCreationForm').classList.remove('hidden');
        populatePOForm();
      } else {
        document.getElementById('poCreationForm').classList.add('hidden');
      }
    }

    function populatePOForm() {
      if (selectedProducts.length === 0) return;

      const firstProduct = selectedProducts[0];
    
      // Generate PO Number
      const now = new Date();
      const year = (now.getFullYear() + 543).toString().slice(-2);
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const time = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0');
      const poNumber = `PO-QS-${year}${month}${day}-${time}`;

      document.getElementById('poNumber').value = poNumber;
      document.getElementById('branchName').value = firstProduct.branch_code;
      document.getElementById('categoryGroup').value = firstProduct.categoryGroup?.name || '';

      populateProductDetailsTable();
      calculateSummary();
    }

    function populateProductDetailsTable() {
      const tbody = document.getElementById('productDetailsTable');
    
      tbody.innerHTML = selectedProducts.map((product, index) => {
        // ใช้ค่าที่บันทึกไว้ หรือค่าเริ่มต้น
        const qty = product.editableQty || 1;
        const unitCost = product.editableCost || product.cost || 0;
        const discount = product.editableDiscount || 0;
        const taxRate = product.editableTaxRate || 7;
        const taxType = product.editableTaxType || product.taxType || 'แยกภาษี';
    
        const subtotal = qty * unitCost;
        const discountAmount = qty * discount;
        const beforeTax = subtotal - discountAmount;
    
        let taxAmount = 0;
        let totalWithTax = beforeTax;
    
        if (taxType === 'แยกภาษี') {
          taxAmount = beforeTax * (taxRate / 100);
          totalWithTax = beforeTax + taxAmount;
        } else if (taxType === 'รวมภาษี') {
          totalWithTax = beforeTax;
          taxAmount = totalWithTax - (totalWithTax / (1 + taxRate / 100));
        }

        return `
          <tr data-product-index="${index}">
            <td class="px-4 py-2">${product.name}</td>
            <td class="px-4 py-2">${product.brand}</td>
            <td class="px-4 py-2">${product.imei || 'N/A'}</td>
            <td class="px-4 py-2 text-right">
              <input type="number" min="1" step="1" value="${qty}" 
                     class="w-20 px-2 py-1 border rounded text-center bg-white dark:bg-gray-700 dark:border-gray-600"
                     onchange="updateProductField(${index}, 'qty', this.value)">
            </td>
            <td class="px-4 py-2 text-right">
              <input type="number" min="0" step="0.01" value="${unitCost}" 
                     class="w-24 px-2 py-1 border rounded text-right bg-white dark:bg-gray-700 dark:border-gray-600"
                     onchange="updateProductField(${index}, 'cost', this.value)">
            </td>
            <td class="px-4 py-2 text-right">
              <input type="number" min="0" step="0.01" value="${discount}" 
                     class="w-24 px-2 py-1 border rounded text-right bg-white dark:bg-gray-700 dark:border-gray-600"
                     onchange="updateProductField(${index}, 'discount', this.value)">
            </td>
            <td class="px-4 py-2 text-right">
              <input type="number" min="0" max="100" step="0.01" value="${taxRate}" 
                     class="w-20 px-2 py-1 border rounded text-center bg-white dark:bg-gray-700 dark:border-gray-600"
                     onchange="updateProductField(${index}, 'taxRate', this.value)">%
            </td>
            <td class="px-4 py-2">
              <select class="w-full px-2 py-1 border rounded bg-white dark:bg-gray-700 dark:border-gray-600"
                      onchange="updateProductField(${index}, 'taxType', this.value)">
                <option value="แยกภาษี" ${taxType === 'แยกภาษี' ? 'selected' : ''}>แยกภาษี</option>
                <option value="รวมภาษี" ${taxType === 'รวมภาษี' ? 'selected' : ''}>รวมภาษี</option>
                <option value="ไม่มีภาษี" ${taxType === 'ไม่มีภาษี' ? 'selected' : ''}>ไม่มีภาษี</option>
              </select>
            </td>
            <td class="px-4 py-2 text-right font-medium" id="beforeTax_${index}">${beforeTax.toLocaleString()}</td>
            <td class="px-4 py-2 text-right font-medium" id="taxAmount_${index}">${taxAmount.toLocaleString()}</td>
            <td class="px-4 py-2 text-right font-semibold text-green-600" id="totalWithTax_${index}">${totalWithTax.toLocaleString()}</td>
          </tr>
        `;
      }).join('');
    }

    // 🔥 ฟังก์ชันสำหรับอัพเดทข้อมูลสินค้าและคำนวณใหม่
    function updateProductField(index, field, value) {
      const product = selectedProducts[index];
      const numValue = parseFloat(value) || 0;
    
      // บันทึกค่าที่แก้ไข
      switch(field) {
        case 'qty':
          product.editableQty = Math.max(1, Math.floor(numValue));
          break;
        case 'cost':
          product.editableCost = Math.max(0, numValue);
          break;
        case 'discount':
          product.editableDiscount = Math.max(0, numValue);
          break;
        case 'taxRate':
          product.editableTaxRate = Math.max(0, Math.min(100, numValue));
          break;
        case 'taxType':
          product.editableTaxType = value;
          break;
      }
    
      // คำนวณและอัพเดทแถวนี้
      updateProductRow(index);
    
      // คำนวณสรุปใหม่
      calculateSummary();
    }
    
    // 🔥 ฟังก์ชันสำหรับอัพเดทแถวเดียว
    function updateProductRow(index) {
      const product = selectedProducts[index];
      const qty = product.editableQty || 1;
      const unitCost = product.editableCost || product.cost || 0;
      const discount = product.editableDiscount || 0;
      const taxRate = product.editableTaxRate || 7;
      const taxType = product.editableTaxType || product.taxType || 'แยกภาษี';
    
      const subtotal = qty * unitCost;
      const discountAmount = qty * discount;
      const beforeTax = subtotal - discountAmount;
    
      let taxAmount = 0;
      let totalWithTax = beforeTax;
    
      if (taxType === 'แยกภาษี') {
        taxAmount = beforeTax * (taxRate / 100);
        totalWithTax = beforeTax + taxAmount;
      } else if (taxType === 'รวมภาษี') {
        totalWithTax = beforeTax;
        taxAmount = totalWithTax - (totalWithTax / (1 + taxRate / 100));
      } else if (taxType === 'ไม่มีภาษี') {
        taxAmount = 0;
        totalWithTax = beforeTax;
      }
    
      // อัพเดทเซลล์ที่คำนวณได้
      document.getElementById(`beforeTax_${index}`).textContent = beforeTax.toLocaleString();
      document.getElementById(`taxAmount_${index}`).textContent = taxAmount.toLocaleString();
      document.getElementById(`totalWithTax_${index}`).textContent = totalWithTax.toLocaleString();
    }

    function calculateSummary() {
      let totalSubtotal = 0;
      let totalDiscount = 0;
      let totalTax = 0;
      let grandTotal = 0;

      selectedProducts.forEach(product => {
        const qty = product.editableQty || 1;
        const unitCost = product.editableCost || product.cost || 0;
        const discount = product.editableDiscount || 0;
        const taxRate = product.editableTaxRate || 7;
        const taxType = product.editableTaxType || product.taxType || 'แยกภาษี';
    
        const subtotal = qty * unitCost;
        const discountAmount = qty * discount;
        const beforeTax = subtotal - discountAmount;
    
        let taxAmount = 0;
        let totalWithTax = beforeTax;
    
        if (taxType === 'แยกภาษี') {
          taxAmount = beforeTax * (taxRate / 100);
          totalWithTax = beforeTax + taxAmount;
        } else if (taxType === 'รวมภาษี') {
          totalWithTax = beforeTax;
          taxAmount = totalWithTax - (totalWithTax / (1 + taxRate / 100));
        } else if (taxType === 'ไม่มีภาษี') {
          taxAmount = 0;
          totalWithTax = beforeTax;
        }

        totalSubtotal += subtotal;
        totalDiscount += discountAmount;
        totalTax += taxAmount;
        grandTotal += totalWithTax;
      });

      document.getElementById('summarySubtotal').textContent = totalSubtotal.toLocaleString();
      document.getElementById('summaryDiscount').textContent = totalDiscount.toLocaleString();
      document.getElementById('summaryTax').textContent = totalTax.toLocaleString();
      document.getElementById('summaryTotal').textContent = grandTotal.toLocaleString();
    }

    async function loadSuppliers() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/supplier', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('ไม่สามารถโหลดข้อมูลซัพพลายเออร์ได้');
        }

        const result = await response.json();
        allSuppliers = result.data;

        const select = document.getElementById('supplierId');
        select.innerHTML = '<option value="">-- เลือกซัพพลายเออร์ --</option>';
    
        allSuppliers.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier._id;
          option.textContent = `[${supplier.code}] ${supplier.name}`;
          select.appendChild(option);
        });

      } catch (error) {
        console.error('Error loading suppliers:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลซัพพลายเออร์: ' + error.message, 'error');
      }
    }

    async function loadBranches() {
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/branch', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('ไม่สามารถโหลดข้อมูลสาขาได้');
        }

        const result = await response.json();
        allBranches = result.data;

      } catch (error) {
        console.error('Error loading branches:', error);
      }
    }

    // Form submission
    document.getElementById('createPOForm').addEventListener('submit', async function(e) {
      e.preventDefault();
    
      const supplierId = document.getElementById('supplierId').value;
      if (!supplierId) {
        showToast('กรุณาเลือกซัพพลายเออร์', 'error');
        return;
      }

      if (selectedProducts.length === 0) {
        showToast('กรุณาเลือกสินค้าอย่างน้อย 1 รายการ', 'error');
        return;
      }

      try {
        showLoading(true);
    
        const poData = {
          poNumber: document.getElementById('poNumber').value,
          poDate: document.getElementById('poDate').value,
          branchCode: selectedProducts[0].branch_code,
          supplierId: supplierId,
          categoryGroup: selectedProducts[0].categoryGroup?._id,
          notes: document.getElementById('notes').value,
          products: selectedProducts.map(product => ({
            productId: product._id,
            name: product.name,
            brand: product.brand,
            imei: product.imei,
            qty: product.editableQty || 1,
            cost: product.editableCost || product.cost || 0,
            discount: product.editableDiscount || 0,
            taxRate: product.editableTaxRate || 7,
            taxType: product.editableTaxType || product.taxType || 'แยกภาษี'
          })),
          isQuickSale: true,
          createdBy: {
            id: localStorage.getItem('userId'),
            name: localStorage.getItem('userName')
          }
        };

        const token = localStorage.getItem('authToken');
        const response = await fetch('/api/purchase-order/create-from-quick-sale', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(poData)
        });

        if (!response.ok) {
          throw new Error('ไม่สามารถสร้างใบสั่งซื้อได้');
        }

        const result = await response.json();

        showToast('✅ สร้างใบสั่งซื้อเรียบร้อยแล้ว!', 'success');

        // เพิ่มสินค้าที่สร้าง PO ลงในประวัติ (temporary - จนกว่า server จะ sync)
        const createdPO = result.data;
        const supplierName = allSuppliers.find(s => s._id === poData.supplierId)?.name || 'ไม่ระบุ';

        console.log('✅ PO created successfully:', {
          poNumber: createdPO.poNumber,
          docDate: createdPO.docDate,
          supplierName: supplierName,
          selectedProductsCount: selectedProducts.length
        });

        selectedProducts.forEach(product => {
          historyProducts.push({
            ...product,
            poInfo: {
              poNumber: createdPO.poNumber,
              poDate: new Date(createdPO.docDate).toLocaleDateString('th-TH'),
              supplierName: supplierName,
              status: 'สร้างแล้ว'
            },
            createdAt: new Date().toISOString()
          });
        });

        console.log('📊 Updated historyProducts:', historyProducts.length);

        // ลบสินค้าที่สร้าง PO แล้วออกจากรายการขายด่วน
        selectedProducts.forEach(selectedProduct => {
          const productElement = document.querySelector(`input[value="${selectedProduct._id}"]`);
          if (productElement) {
            productElement.closest('.product-item').remove();
          }
        });

        // รีเซ็ตการเลือกและซ่อนฟอร์ม
        selectedProducts = [];
        document.getElementById('poCreationForm').classList.add('hidden');

        // อัพเดทจำนวนในแท็บ
        updateTabCounts();

        // รีโหลดรายการสินค้าขายด่วนใหม่
        await loadQuickSaleProducts();

        // แสดงข้อความและเปลี่ยนไปแท็บประวัติ
        setTimeout(() => {
          switchTab('history');
          showToast('📋 ดูสินค้าที่สร้าง PO ได้ในแท็บประวัติ', 'info');
        }, 1500);

      } catch (error) {
        console.error('Error creating PO:', error);
        showToast('เกิดข้อผิดพลาดในการสร้างใบสั่งซื้อ: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });

    function cancelPOCreation() {
      selectedProducts = [];
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.getElementById('poCreationForm').classList.add('hidden');
    }

    function goBack() {
      window.history.back();
    }

    // Tab Management Functions
    function switchTab(tabName) {
      // อัพเดทปุ่มแท็บ
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        btn.classList.remove('border-blue-500', 'text-blue-600');
      });

      // อัพเดทเนื้อหาแท็บ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.classList.add('hidden');
      });

      // เปิดแท็บที่เลือก
      if (tabName === 'pending') {
        document.getElementById('tabPending').classList.add('active');
        document.getElementById('tabPending').classList.add('border-blue-500', 'text-blue-600');
        document.getElementById('tabPending').classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        document.getElementById('contentPending').classList.add('active');
        document.getElementById('contentPending').classList.remove('hidden');
      } else if (tabName === 'history') {
        document.getElementById('tabHistory').classList.add('active');
        document.getElementById('tabHistory').classList.add('border-blue-500', 'text-blue-600');
        document.getElementById('tabHistory').classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        document.getElementById('contentHistory').classList.add('active');
        document.getElementById('contentHistory').classList.remove('hidden');
        loadHistoryProducts();
      }

      currentTab = tabName;
    }

    async function updateTabCounts() {
      // อัพเดทจำนวนสินค้าในแต่ละแท็บ
      const pendingCount = document.querySelectorAll('#quickSaleProducts .product-item').length;

      // นับจำนวนประวัติจาก server + local
      let serverHistoryCount = 0;
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/po-history?branch_code=${BRANCH_CODE}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          const result = await response.json();
          serverHistoryCount = result.count || 0;
        }
      } catch (error) {
        console.error('Error counting history products:', error);
      }

      const totalHistoryCount = serverHistoryCount + historyProducts.length;

      console.log('📊 Tab counts update:', {
        pendingCount,
        serverHistoryCount,
        localHistoryCount: historyProducts.length,
        totalHistoryCount
      });

      document.getElementById('countPending').textContent = pendingCount;
      document.getElementById('countHistory').textContent = totalHistoryCount;
    }

    async function loadHistoryProducts() {
      const historyContainer = document.getElementById('historyProducts');

      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/branch-stock/po-history?branch_code=${BRANCH_CODE}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('ไม่สามารถโหลดประวัติสินค้าได้');
        }

        const result = await response.json();
        const serverHistoryProducts = result.data || [];

        // Debug: แสดงข้อมูลประวัติจาก server
        console.log('🔄 Server history products:', {
          count: result.count,
          serverProducts: serverHistoryProducts.length,
          localProducts: historyProducts.length,
          serverData: serverHistoryProducts
        });

        // รวมข้อมูลจาก server กับข้อมูลจาก local storage (remove duplicates)
        const combinedProducts = [...serverHistoryProducts, ...historyProducts];

        // Remove duplicates based on _id or imei (prefer server data)
        const seenIds = new Set();
        const seenImeis = new Set();
        const allHistoryProducts = [];

        // Add server products first (priority)
        serverHistoryProducts.forEach(product => {
          if (product._id && !seenIds.has(product._id)) {
            seenIds.add(product._id);
            if (product.imei) seenImeis.add(product.imei);
            allHistoryProducts.push(product);
          } else if (product.imei && !seenImeis.has(product.imei)) {
            seenImeis.add(product.imei);
            allHistoryProducts.push(product);
          }
        });

        // Add local products if not already exists
        historyProducts.forEach(product => {
          const isDuplicate = (product._id && seenIds.has(product._id)) ||
                             (product.imei && seenImeis.has(product.imei));

          if (!isDuplicate) {
            if (product._id) seenIds.add(product._id);
            if (product.imei) seenImeis.add(product.imei);
            allHistoryProducts.push(product);
          }
        });

        console.log('🔄 Combined history products:', {
          serverCount: serverHistoryProducts.length,
          localCount: historyProducts.length,
          combinedCount: combinedProducts.length,
          uniqueCount: allHistoryProducts.length
        });

        if (allHistoryProducts.length === 0) {
          historyContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="bi bi-inbox text-4xl mb-4 block"></i>
              <p class="text-lg">ยังไม่มีสินค้าที่สร้าง PO</p>
              <p class="text-sm">สินค้าที่สร้าง PO แล้วจะแสดงที่นี่</p>
            </div>
          `;
          return;
        }

        historyContainer.innerHTML = allHistoryProducts.map(product => {
          const poInfo = product.poInfo || {
            poNumber: product.poSystemId || product.poNumber || 'ไม่ระบุ',
            poDate: product.poInfo?.poDate || (product.updatedAt ? new Date(product.updatedAt).toLocaleDateString('th-TH') : new Date().toLocaleDateString('th-TH')),
            supplierName: product.poInfo?.supplierName || product.supplier?.name || 'ไม่ระบุ',
            status: 'สร้างแล้ว'
          };

          return `
            <div class="product-item bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-4 mb-3">
                    <img src="${product.image || '/placeholder-image.png'}"
                         alt="${product.name}"
                         class="w-16 h-16 object-cover rounded-lg border border-gray-200 dark:border-gray-600">
                    <div class="flex-1">
                      <h4 class="font-semibold text-gray-900 dark:text-gray-100">${product.name}</h4>
                      <p class="text-sm text-gray-600 dark:text-gray-400">รุ่น: ${product.model || 'ไม่ระบุ'} |
                         ${(product.stockType === 'imei' || !product.barcode) ? 'IMEI: ' + (product.imei || 'ไม่ระบุ') : 'Barcode: ' + (product.barcode || 'ไม่ระบุ')}</p>
                      <p class="text-sm text-gray-600 dark:text-gray-400">ต้นทุน: ฿${(product.cost || 0).toLocaleString()}</p>
                    </div>
                  </div>

                  <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-3">
                    <div class="flex items-center gap-2 text-green-800 dark:text-green-200">
                      <i class="bi bi-check-circle-fill text-green-600"></i>
                      <span class="font-medium">สร้าง PO แล้ว</span>
                    </div>
                    <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                      เลขที่ PO: ${poInfo.poNumber} |
                      วันที่: ${poInfo.poDate} |
                      ซัพพลายเออร์: ${poInfo.supplierName}
                    </p>
                    ${poInfo.status ? `<p class="text-xs text-green-600 dark:text-green-400 mt-1">สถานะ: ${poInfo.status}</p>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading history products:', error);
        historyContainer.innerHTML = `
          <div class="text-center py-8 text-red-500 dark:text-red-400">
            <i class="bi bi-exclamation-triangle text-4xl mb-4 block"></i>
            <p class="text-lg">เกิดข้อผิดพลาดในการโหลดประวัติ</p>
            <p class="text-sm">${error.message}</p>
          </div>
        `;
      }
    }


    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
      toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fadeIn`;
      toast.textContent = message;
    
      document.body.appendChild(toast);
    
      setTimeout(() => {
        toast.remove();
      }, duration);
    }

    // Show/Hide Loading Function (เหมือน BOSS/home.html)
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');

        // โหลดและเล่น Lottie animation
        if (!lottieAnimation) {
          console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });

              console.log('✅ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('❌ Error loading Lottie animation:', error);
              // Fallback เฉพาะเมื่อ Lottie โหลดไม่สำเร็จ
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }


    window.addEventListener('beforeunload', () => {
      if (lottieAnimation) {
        lottieAnimation.destroy();
        lottieAnimation = null;
      }
    });

  </script>
</body>
</html>