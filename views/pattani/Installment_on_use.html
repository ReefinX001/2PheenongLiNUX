<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบผ่อน - ผ่อนไปใช้ไป Pattani</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="../js/activity-tracker.js"></script>
  <!-- Sidebar Management -->
  <script src="/views/pattani/sidebar/sidebar.js" onerror="console.warn('Sidebar.js failed to load, will use fallback')"></script>
  
  <!-- Inline Sidebar Fallback -->
  <script>
    // Inline sidebar functionality as backup
    window.sidebarFallback = {
      init: function() {
        const container = document.getElementById('sidebarContainer');
        if (!container) return;
    
        container.innerHTML = `
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 bg-white dark:bg-gray-800 shadow flex flex-col
                        transform transition-transform duration-300 z-20">
            
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                <li><a href="frontstore_pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-cash-stack text-xl mr-3 text-blue-500"></i>ซื้อสด</a></li>
                <li><a href="installment_Pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-credit-card text-xl mr-3 text-indigo-500"></i>ซื้อผ่อน</a></li>
                <li><a href="Installment_on_use" class="flex items-center h-12 px-4 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 font-semibold"><i class="bi bi-credit-card-2-front text-xl mr-3"></i>ผ่อนไปใช้ไป</a></li>
                <li><a href="Installment_complete_pickup" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-credit-card-fill text-xl mr-3 text-green-500"></i>ผ่อนหมดรับของ</a></li>
                <li><a href="Addproduct_pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-speedometer2 text-xl mr-3 text-emerald-500"></i>เพิ่มสินค้าใหม่</a></li>
                <li><a href="receiptVoucher" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-receipt text-xl mr-3 text-red-500"></i>ใบสำคัญรับเงิน</a></li>
                
                <li class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark" class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300 mr-3"></i>
                    <span id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <li class="my-px">
                  <button id="btnLogout" class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl mr-3"></i>
                    <span>ออกจากระบบ</span>
                  </button>
                </li>
                
                <li class="my-px mt-2">
                  <div id="profile" class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i class="bi bi-person text-gray-600"></i>
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">ผู้ใช้</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;
    
        this.setupEvents();
        this.loadProfile();
        console.log('✅ Inline sidebar fallback initialized');
      },
    
      setupEvents: function() {
        const toggleBtn = document.getElementById('btnToggleMenu');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
    
        if (toggleBtn && sidebar && mainContent) {
          toggleBtn.addEventListener('click', () => {
            const isHidden = sidebar.classList.contains('-translate-x-full');
            sidebar.classList.toggle('-translate-x-full');
    
            if (isHidden) {
              mainContent.style.marginLeft = '14rem';
              toggleBtn.querySelector('i').classList.replace('bi-chevron-right', 'bi-chevron-left');
            } else {
              mainContent.style.marginLeft = '0';
              toggleBtn.querySelector('i').classList.replace('bi-chevron-left', 'bi-chevron-right');
            }
          });
        }
    
        // Dark mode toggle
        const darkBtn = document.getElementById('btnToggleDark');
        if (darkBtn) {
          darkBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
          });
        }
    
        // Logout
        const logoutBtn = document.getElementById('btnLogout');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            localStorage.clear();
            window.location.href = '/login.html';
          });
        }
      },
    
      loadProfile: async function() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (res.ok && js.success && js.data) {
            const user = js.data;
            const nameEl = document.getElementById('employeeName');
            if (nameEl) {
              nameEl.textContent = user.name || 'ผู้ใช้';
            }
          }
        } catch (err) {
          console.log('Could not load employee profile:', err.message);
        }
      }
    };
  </script>
  
  <!-- Tailwind + DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] } }
      },
      daisyui: { themes: ['light', 'dark', 'corporate'] }
    };
  </script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    />

  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner { border-top-color: #10b981; }
    .loading-success .loading-progress-fill { background: #10b981; }

    .loading-warning .loading-spinner { border-top-color: #f59e0b; }
    .loading-warning .loading-progress-fill { background: #f59e0b; }

    .loading-error .loading-spinner { border-top-color: #ef4444; }
    .loading-error .loading-progress-fill { background: #ef4444; }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function(window) {
      'use strict';

      console.log('🚀 LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-content';
    
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
    
        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || 'กำลังโหลด...';
    
        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';
    
          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }
    
        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);
    
        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function(options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();
    
            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);
    
            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }
    
            container.appendChild(overlay);
    
            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };
    
            activeLoaders.set(loaderId, loaderData);
    
            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }
    
            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }
    
            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });
    
            console.log(`✅ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;
    
          } catch (error) {
            console.error('❌ LoadingSystem.show() error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;
    
            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }
    
            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }
    
            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }
    
            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');
    
            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);
    
            console.log(`✅ LoadingSystem.hide() - ID: ${loaderId}`);
    
          } catch (error) {
            console.error('❌ LoadingSystem.hide() error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`✅ LoadingSystem.hideAll() - ซ่อน ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('❌ LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function(loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
          } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function(loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
              }
            }
          } catch (error) {
            console.error('❌ LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function() {
          return activeLoaders.size;
        },

        cleanup: function() {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('🧹 LoadingSystem.cleanup() - ล้างข้อมูลทั้งหมดแล้ว');
        },

        debug: function() {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup เมื่อออกจากหน้า
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('✅ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@latest/dist/signature_pad.umd.min.js"></script>
  <!-- Added Socket.IO client library and global socket declaration -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    if (typeof io === 'function') {
      socket = io();
      socket.on('connect_error', err => console.warn('Socket.IO connect error:', err));
    } else {
      console.warn('Socket.IO script ไม่ได้โหลด — โยนผ่านไป');
    }
  </script>

  <!-- Sidebar Component Script -->
  <script>
    class SidebarComponent {
      constructor(config = {}) {
        this.config = {
          containerSelector: '#sidebar-container',
          mainContentSelector: '#mainContent',
          ...config
        };
    
        this.menuItems = [
          { href: 'frontstore_pattani',    icon: 'bi-cash-stack',       color: 'blue-500',   text: 'ซื้อสด' },
          { href: 'installment_Pattani',   icon: 'bi-credit-card',      color: 'indigo-500', text: 'ซื้อผ่อน' },
          { href: 'Addproduct_pattani',    icon: 'bi-speedometer2',     color: 'green-500',  text: 'เพิ่มสินค้าใหม่' },
          { href: 'services',              icon: 'bi-tools',            color: 'orange-500', text: 'บริการ' },
          { href: 'receiptVoucher',        icon: 'bi-receipt',          color: 'red-500',    text: 'ใบสำคัญรับเงิน' },
          { href: 'DepositReceipt',       icon: 'bi-receipt-cutoff',   color: 'teal-500',   text: 'ใบรับเงินมัดจำ' },
          { href: 'Quotationn',            icon: 'bi-file-earmark-text',color: 'purple-500', text: 'ใบเสนอราคา' },
          { href: 'Invoicee',              icon: 'bi-receipt',          color: 'fuchsia-500',text: 'ใบแจ้งหนี้' },
          { href: 'productTransfer',       icon: 'bi-arrow-left-right', color: 'pink-500',   text: 'โอนย้ายสินค้า' }
        ];
      }

      async render() {
        const container = document.querySelector(this.config.containerSelector);
        if (!container) {
          console.error('Sidebar container not found');
          return;
        }

        // สร้าง HTML
        container.innerHTML = this.generateHTML();
    
        // เพิ่ม CSS styles
        this.injectStyles();
    
        // Initialize events
        this.initializeEvents();
    
        // Load profile
        await this.loadEmployeeProfile();
    
        // Restore states
        this.restoreStates();
    
        // Highlight active menu
        this.highlightActiveMenu();
      }

      generateHTML() {
        const menuHTML = this.menuItems.map(item => {
          // สร้างชื่อคลาสสีแบบ static ให้ Tailwind คอมไพล์ออกมา
          const textColorClass = `text-${item.color}`;                         // เช่น text-blue-500
          const darkColorClass = `dark:text-${item.color.replace('500','400')}`; // เช่น dark:text-blue-400

          return `
          <li class="my-px">
            <a href="${item.href}"
               class="flex flex-row items-center h-12 px-4 rounded-lg 
                      ${textColorClass} ${darkColorClass} 
                      hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <span class="flex items-center justify-center text-lg ${textColorClass} ${darkColorClass}">
                <i class="bi ${item.icon} text-xl"></i>
              </span>
              <span class="ml-3">${item.text}</span>
            </a>
          </li>
          `;
        }).join('');

        return `
          <!-- Toggle Button -->
          <button id="btnToggleMenu"
                  title="Toggle Menu"
                  aria-label="Toggle Menu"
                  class="fixed left-0 top-1/2 transform -translate-y-1/2 
                         bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                         hover:bg-blue-700 transition">
            <i class="bi bi-chevron-left"></i>
          </button>

          <!-- Sidebar -->
          <aside id="sidebar"
                 class="fixed inset-y-0 left-0 w-56 overflow-y-hidden bg-white dark:bg-gray-800 shadow flex flex-col
                  transform transition-transform duration-300 translate-x-0 z-20">
            
            <!-- Logo -->
            <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
              <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
            </a>
            
            <!-- Menu Items -->
            <div class="flex-1 p-4 overflow-y-auto">
              <ul class="flex flex-col w-full space-y-1">
                ${menuHTML}
                
                <!-- Divider -->
                <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                  <button id="btnToggleDark"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-gray-600 dark:text-gray-200 
                                 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                    <i class="bi bi-moon-stars text-xl text-indigo-600 dark:text-indigo-300"></i>
                    <span class="ml-3" id="darkModeLabel">Dark Mode</span>
                  </button>
                </li>
                
                <!-- Logout -->
                <li class="my-px">
                  <button id="btnLogout"
                          class="flex items-center h-12 px-4 w-full rounded-lg text-red-500 
                                 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
                    <i class="bi bi-box-arrow-right text-xl"></i>
                    <span class="ml-3">ออกจากระบบ</span>
                  </button>
                </li>
                
                <!-- Profile -->
                <li class="my-px mt-2">
                  <div id="profile"
                       class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50 transition-colors">
                    <div class="avatar mr-3">
                      <div class="w-10 h-10 rounded-full ring-2 ring-primary-500/30 overflow-hidden">
                        <img id="employeePhoto" src="/static/images/avatar-default.png" alt="Profile" class="w-full h-full object-cover" />
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <span class="text-sm font-medium" id="employeeName">Loading…</span>
                      <span class="text-xs text-gray-500 dark:text-gray-400">พนักงาน</span>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </aside>
        `;
      }

      injectStyles() {
        if (document.getElementById('sidebar-styles')) return;
    
        const styles = document.createElement('style');
        styles.id = 'sidebar-styles';
        styles.textContent = `
          /* Sidebar collapsed state */
          aside.collapsed {
            width: 5rem;
          }
          
          aside.collapsed .ml-3 {
            display: none;
          }
          
          aside.collapsed .Logo,
          aside.collapsed #employeeName,
          aside.collapsed .text-xs {
            display: none;
          }
          
          aside.collapsed .p-4 {
            padding: 0.5rem;
          }
          
          aside.collapsed a {
            justify-content: center;
          }
          
          /* Sidebar translate animation */
          aside {
            transition: transform 0.3s;
          }
          
          aside.-translate-x-full {
            transform: translateX(-100%);
          }
          
          /* Active sidebar item */
          #sidebar ul li a.active {
            background-color: var(--primary-color);
            color: #fff;
          }
          
          #sidebar ul li a.active i {
            color: #fff !important;
          }
        `;
        document.head.appendChild(styles);
      }

      initializeEvents() {
        // Toggle menu
        document.getElementById('btnToggleMenu').addEventListener('click', () => this.toggleMenu());
    
        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => this.logout());
    
        // Dark mode toggle
        document.getElementById('btnToggleDark').addEventListener('click', () => this.toggleDarkMode());
    
        // Menu item clicks
        const menuLinks = document.querySelectorAll('#sidebar ul li a');
        menuLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Remove previous active
            menuLinks.forEach(l => l.classList.remove('active'));
            // Add active to clicked
            link.classList.add('active');
          });
        });
      }

      toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector(this.config.mainContentSelector);
        const icon = document.querySelector('#btnToggleMenu i');
    
        sidebar.classList.toggle('-translate-x-full');
    
        if (sidebar.classList.contains('-translate-x-full')) {
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.remove('bi-chevron-left');
          icon.classList.add('bi-chevron-right');
        } else {
          if (mainContent) mainContent.style.marginLeft = '14rem';
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-left');
        }
    
        // Save state
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('-translate-x-full'));
      }

      toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('darkMode', isDark);
    
        // Update button text
        document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
      }

      logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.href = '/login';
      }

      async loadEmployeeProfile() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;

          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });

          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error || js.message || res.status);

          const user = js.data;
          document.getElementById('employeeName').textContent = user.name || '(ไม่พบชื่อ)';

          let img = user.imageUrl || user.photoUrl || user.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }

          const photoElement = document.getElementById('employeePhoto');
          if (photoElement) {
            photoElement.src = img || '/static/images/avatar-placeholder.png';
          }
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      restoreStates() {
        // Restore sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.querySelector(this.config.mainContentSelector);
          const icon = document.querySelector('#btnToggleMenu i');
    
          sidebar.classList.add('-translate-x-full');
          if (mainContent) mainContent.style.marginLeft = '0';
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }
    
        // Restore dark mode
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
          document.getElementById('darkModeLabel').textContent = 'Light Mode';
        }
      }

      highlightActiveMenu() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop();
    
        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          const href = link.getAttribute('href');
          if (href === currentPage || currentPath.includes(href)) {
            link.classList.add('active');
          }
        });
      }

      // Public methods
      show() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('-translate-x-full');
      }

      hide() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('-translate-x-full');
      }

      setActiveMenu(menuHref) {
        document.querySelectorAll('#sidebar ul li a').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === menuHref) {
            link.classList.add('active');
          }
        });
      }
    }

    // Export for use
    window.SidebarComponent = SidebarComponent;
  </script>
  
  <!-- Custom CSS -->
  <style>
    

@keyframes pulse { 
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --info: #560bad;
      --light-bg: #f5f7fa;
      --dark-text: #212529;
    }

    
    .dark {
      --primary-color: #ff8800;
      --primary-hover: #ffa733;
      --bg-color: #2a2a2a;
      --text-color: #ffffff;
      --border-color: #555555;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 0;
    }

    aside.collapsed .ml-3 {
      display: none;
    }

    /* ===== MINIMAL CARD STYLES - FINAL ATTEMPT ===== */
    body .card, 
    body div.card,
    body .card.p-4 {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 16px !important;
      padding: 1.5rem !important;
      margin-bottom: 1rem !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
      color: #374151 !important;
      backdrop-filter: blur(10px) !important;
      min-height: 120px !important;
      overflow: visible !important;
    }
    
    body .card:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08) !important;
    }
    
    /* Dark mode card styles */
    .dark .card {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      border: 1px solid #374151 !important;
      color: #d1d5db !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }
    
    .dark .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
    }
    
    /* Card text alignment */
    .card h6, .card h5 {
      margin: 0.5rem 0 !important;
      font-weight: 500 !important;
      color: inherit !important;
      white-space: normal !important;
      word-wrap: break-word !important;
    }
    
    .card p {
      margin: 0.25rem 0 !important;
      color: #6b7280 !important;
      font-size: 0.875rem !important;
    }
    
    .dark .card p {
      color: #9ca3af !important;
    }
    
    /* ===== STOCK ALERT STYLES - MINIMAL DESIGN ===== */
    /* Emergency out of stock - Red border only */
    .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15), 0 2px 8px rgba(239, 68, 68, 0.08) !important;
    }
    
    .dark .out-of-stock-emergency {
      border: 2px solid #ef4444 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25), 0 2px 8px rgba(239, 68, 68, 0.15) !important;
    }
    
    /* Low stock warning - Yellow border only */
    .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      position: relative !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.15), 0 2px 8px rgba(234, 179, 8, 0.08) !important;
    }
    
    .dark .low-stock-warning {
      border: 2px solid #eab308 !important;
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
      box-shadow: 0 4px 20px rgba(234, 179, 8, 0.25), 0 2px 8px rgba(234, 179, 8, 0.15) !important;
    }
    
    /* Status Icons - Top right corner minimal style */
    .status-icon {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      font-size: 20px !important;
      z-index: 30 !important;
      opacity: 0.8 !important;
      transition: opacity 0.3s ease !important;
    }
    
    .card:hover .status-icon {
      opacity: 1 !important;
    }
    
    .warning-icon {
      color: #eab308 !important;
      filter: drop-shadow(0 1px 2px rgba(234, 179, 8, 0.3)) !important;
    }
    
    .emergency-icon {
      color: #ef4444 !important;
      filter: drop-shadow(0 1px 2px rgba(239, 68, 68, 0.3)) !important;
    }
    
    /* Badge styles - Minimal design */
    .badge {
      display: inline-flex !important;
      align-items: center !important;
      padding: 0.375rem 0.75rem !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      border-radius: 12px !important;
      line-height: 1 !important;
      backdrop-filter: blur(8px) !important;
    }

    .warning-badge {
      background: rgba(234, 179, 8, 0.1) !important;
      color: #a16207 !important;
      border: 1px solid rgba(234, 179, 8, 0.2) !important;
    }
    
    .emergency-badge {
      background: rgba(239, 68, 68, 0.1) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.2) !important;
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #1d4ed8 !important;
      border: 1px solid rgba(59, 130, 246, 0.2) !important;
    }
    
    /* Dark mode badge styles */
    .dark .warning-badge {
      background: rgba(234, 179, 8, 0.2) !important;
      color: #fbbf24 !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
    }
    
    .dark .emergency-badge {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #f87171 !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }
    
    .dark .badge-info {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #60a5fa !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }
    
    /* Text styles for stock status */
    .warning-text {
      color: #a16207 !important;
      font-weight: 500 !important;
    }
    
    .emergency-text {
      color: #b91c1c !important;
      font-weight: 500 !important;
    }
    
    .dark .warning-text {
      color: #fbbf24 !important;
    }
    
    .dark .emergency-text {
      color: #f87171 !important;
    }
    
    /* Override card padding for consistency */
    .card.p-4 {
      padding: 1.5rem !important;
    }
    
    /* Grid spacing adjustments */
    #level1Grid .card,
    #level2Grid .card,
    #level3Grid .card {
      overflow: visible !important;
      min-height: 120px !important;
    }

    .card-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      color: #212529;
    }

    .dark .card-header {
      background-color: #2a2a2a;
    }

    .card-header i {
      margin-right: 10px;
      color: var(--primary);
    }

    .card-body {
      padding: 20px;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }

    /* Stepper */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .stepper::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }

    .step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #e9ecef;
      color: #adb5bd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .step.active .step-icon {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .step.completed .step-icon {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .step-text {
      font-size: 12px;
      color: #6c757d;
    }

    .step.active .step-text {
      color: var(--primary);
      font-weight: 600;
    }

    .step.completed .step-text {
      color: var(--success);
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
    }

    /* Product card */
    .product-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
      background-color: #fff;
      color: #212529;
    }

    .dark .product-card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #fff;
    }

    .product-card:hover {
      transform: translateY(-7px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    #step4.step-content.active {
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      padding-bottom: 2rem;
      background-color: #f5f7fa;
    }

    .product-img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 0.25rem;
    }

    /* 🔥 Fire Icon Animation */
/* 🔥 Fire Icon Animation */
.promo-fire-icon {
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 32px;
  z-index: 30;
  animation: fireScaleGlow 1.5s ease-in-out infinite;
}

@keyframes fireScaleGlow {
  0%, 100% {
    transform: scale(1);
    filter: drop-shadow(0 0 10px rgba(255, 69, 0, 0.8));
  }
  50% {
    transform: scale(1.3);
    filter: drop-shadow(0 0 25px rgba(255, 0, 0, 1))
            drop-shadow(0 0 35px rgba(255, 100, 0, 0.8))
            drop-shadow(0 0 45px rgba(255, 69, 0, 0.6));
  }
}

/* Card with promotion */
.card.has-promotion {
  position: relative;
  overflow: visible !important;
}

/* Override card overflow for promotion icons */
#level1Grid .card,
#level2Grid .card,
#level3Grid .card {
  overflow: visible !important;
}

/* Confetti styles */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 1000;
}
    /* Remove the following CSS rules */
    
    /* สีปกติของลิงก์ใน sidebar */
    /* Removed: #sidebar ul li a { color: #333333 !important; } */

    /* เมื่อ hover */
    /* Removed: Dynamic color rules for sidebar hover */

    /* เมื่อ active - ต้องมี background สีน้ำเงินด้วย */
    /* Removed: Dynamic color rules for sidebar active state */
    #sidebar ul li a.active {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #ffffff !important;
    }
    /* remove plan2/plan3 styles */
    /* Plan2 detail */
    /* .plan2-detail { display: none; } */

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>
</head>

          <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    <!-- Sidebar Container (will be populated by sidebar.js) -->
    <div id="sidebarContainer"></div>

<div id="mainContent" class="flex-1 flex flex-col ml-56 transition-all duration-300 ease-in-out">
      <!-- Header -->
      <header class="p-4 bg-white dark:bg-gray-800
                    border-b border-gray-200 dark:border-gray-700
                    flex items-center justify-between">
          <div>
          <h1 class="text-lg font-semibold" id="pageTitle">ระบบผ่อน - ผ่อนไปใช้ไป Pattani</h1>
          <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
            กำลังโหลดสาขา...
          </p>
        </div>
        
          <!-- ปุ่มใบเสร็จ/ใบกำกับภาษี + ผ่อนไปใช้ไป + ผ่อนหมดรับของ -->
      <div class="flex items-center gap-2">
        <a href="History_installment" 
           class="btn btn-primary flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          <i class="bi bi-receipt text-lg"></i>
          <span>ใบเสร็จ/ใบกำกับภาษี</span>
        </a>
        <a href="Installment_on_use" 
           class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
          <span>ผ่อนไปใช้ไป</span>
        </a>
        <a href="Installment_complete_pickup" 
           class="btn btn-secondary flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
          <span>ผ่อนหมดรับของ</span>
        </a>
      </div>
      </header>

      <!-- Content -->
      <main class="p-4">
        <!-- Stepper -->
        <div class="stepper mb-4">
  <div class="step active" data-step="1">
    <div class="step-icon">1</div>
    <div class="step-text">เลือกสินค้า</div>
  </div>
  <div class="step" data-step="2">
    <div class="step-icon">2</div>
    <div class="step-text">ข้อมูลลูกค้า</div>
  </div>
  <div class="step" data-step="3">
    <div class="step-icon">3</div>
    <div class="step-text">เสร็จสิ้น</div>
  </div>
</div>

        <!-- STEP 1 -->
        <div id="step1" class="step-content active">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- ซ้าย: Level1 + ค้นหา -->
            <div class="lg:col-span-2 space-y-4">
              <!-- Card ค้นหา -->
              <div class="card p-4">
                <div class="flex gap-2">
                  <input id="productSearchQuery" class="input input-bordered w-full"
                    placeholder="ค้นหาด้วยชื่อรุ่น..." />
                  <button id="btnProductSearch" class="btn btn-primary">ค้นหา</button>
                  <button id="btnProductReset" class="btn btn-secondary">รีเซ็ต</button>
                </div>
              </div>

              <!-- Container Level1 -->
              <div id="level1Container" class="card">
                <div class="card-header">
                  <i class="bi bi-box-seam"></i> แบรนด์สินค้า (Level 1)
                </div>
                <div class="card-body">
                  <div id="level1Grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- renderLevel1() -->
                  </div>
                </div>
              </div>

              <!-- Container Level2 -->
              <div id="level2Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-menu-button-wide"></i>
                    <span id="level2Title">รายการของ ...</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel1">
                    <i class="bi bi-arrow-left mr-1"></i> ย้อนกลับ
                  </button>
                </div>
                <div class="card-body">
                  <div id="level2Grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- renderLevel2() -->
                  </div>
                </div>
              </div>

              <!-- Container Level3 -->
              <div id="level3Container" class="card hidden">
                <div class="card-header flex justify-between items-center">
                  <div>
                    <i class="bi bi-phone"></i>
                    <span id="level3Title">รายละเอียดสินค้า</span>
                  </div>
                  <button class="btn btn-sm" id="btnBackToLevel2">
                    <i class="bi bi-arrow-left mr-1"></i> ย้อนกลับ
                  </button>
                </div>
                <div class="card-body">
                  <div id="level3Grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                  </div>
                </div>
              </div>

              <!-- Container ผลลัพธ์การค้นหา -->
              <div id="imeiResultContainer" class="card hidden">
                <div class="card-header">
                  <i class="bi bi-search"></i> ผลลัพธ์การค้นหา
                </div>
                <div class="card-body">
                  <div id="imeiResultGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  </div>
                </div>
              </div>
            </div>

            <!-- ขวา: ตะกร้าสินค้า/สรุป/ไป Step2 -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> สรุปรายการสินค้า
                </div>
                <div class="card-body">
                  <div class="cart-summary">
                    <p class="text-gray-500">ยังไม่มีสินค้าในตะกร้า</p>
                  </div>
                  <hr class="my-3" />
                  <button class="btn btn-primary w-full" id="btnStep1ToStep2">
                    <i class="bi bi-arrow-right mr-2"></i> ยืนยัน
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP1 -->

        <!-- STEP 2 -->
        <div id="step2" class="step-content">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- ซ้าย: ฟอร์มข้อมูลลูกค้า -->
            <div class="lg:col-span-2">
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-person"></i> ข้อมูลลูกค้า
                </div>
                <div class="card-body">
                  <!-- ปุ่มอ่านบัตรประชาชน -->
                  <button
                    id="btnReadCard"
                    class="btn btn-info w-full mb-4 flex items-center justify-center gap-2"
                  >
                    <i class="bi bi-credit-card-2-front"></i> อ่านข้อมูลจากบัตรประชาชน
                  </button>

                  <!-- ส่วนค้นหาลูกค้าเก่า -->
                  <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <label class="label">
                      <span class="label-text font-semibold">
                        <i class="bi bi-search"></i> ค้นหาลูกค้าเก่า
                      </span>
                    </label>
                    <div class="flex gap-2">
                      <input 
                        type="text" 
                        id="customerSearch" 
                        class="input input-bordered flex-1" 
                        placeholder="ค้นหาด้วยเลขบัตรประชาชน 13 หลัก"
                        maxlength="13"
                      />
                      <button 
                        id="btnSearchCustomer" 
                        class="btn btn-primary"
                        title="ค้นหาลูกค้า"
                      >
                        <i class="bi bi-search"></i>
                      </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      💡 <strong>เคล็ดลับ:</strong> พิมพ์ครบ 13 หลักจะค้นหาอัตโนมัติ | ระบบจำกัดการค้นหา 3 วินาที/ครั้ง
                    </div>
                    
                    <!-- ผลการค้นหา -->
                    <div id="customerSearchResults" class="mt-3 hidden">
                      <div class="max-h-48 overflow-y-auto border rounded-lg bg-white dark:bg-gray-800">
                        <div id="customerResultsList" class="divide-y divide-gray-200 dark:divide-gray-700">
                          <!-- Results will be inserted here -->
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ส่วนข้อมูลลูกค้าพื้นฐาน -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">คำนำหน้า</span></label>
                      <select id="customerPrefix" class="select select-bordered w-full">
                        <option value="">- เลือก -</option>
                        <option>นาย</option>
                        <option>นาง</option>
                        <option>นางสาว</option>
                      </select>
                    </div>
                    <div>
                      <label class="label"><span class="label-text">ชื่อ</span></label>
                      <input type="text" id="customerFirstName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">นามสกุล</span></label>
                      <input type="text" id="customerLastName" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">เลขบัตรประชาชน</span></label>
                      <input type="text" id="customerIdCard" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">เบอร์โทรศัพท์</span></label>
                      <input type="text" id="customerPhone" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">อีเมล</span></label>
                      <input type="email" id="customerEmail" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="label"><span class="label-text">บ้านเลขที่</span></label>
                      <input type="text" id="houseNo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">หมู่</span></label>
                      <input type="text" id="moo" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">ตำบล</span></label>
                      <input type="text" id="subDistrict" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">อำเภอ</span></label>
                      <input type="text" id="district" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">จังหวัด</span></label>
                      <input type="text" id="province" class="input input-bordered w-full" />
                    </div>
                    <div>
                      <label class="label"><span class="label-text">รหัสไปรษณีย์</span></label>
                      <input type="text" id="zipcode" class="input input-bordered w-full" />
                    </div>
                  </div>
                  <div class="collapse collapse-arrow border rounded-box mb-4">
                    <input type="checkbox" />
                    <div class="collapse-title text-lg font-medium">
                      ข้อมูลพยาน (ถ้ามี)
                    </div>
                    <div class="collapse-content">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label class="label"><span class="label-text">ชื่อ</span></label>
                          <input type="text" id="witnessName" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">เลขบัตร ปชช.</span></label>
                          <input type="text" id="witnessIdCard" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">เบอร์โทร</span></label>
                          <input type="text" id="witnessPhone" class="input input-bordered w-full" />
                        </div>
                        <div>
                          <label class="label"><span class="label-text">ความสัมพันธ์</span></label>
                          <input type="text" id="witnessRelation" class="input input-bordered w-full"
                            placeholder="ญาติ/เพื่อน/อื่นๆ" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ข้อมูลติดต่อโซเชียล -->
                  <div class="mt-4 p-4 bg-blue-50 dark:bg-gray-700 rounded-lg">
                    <h4 class="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-300">
                      <i class="bi bi-share"></i> ข้อมูลติดต่อเพิ่มเติม
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-facebook text-blue-600"></i> Facebook
                          </span>
                        </label>
                        <input type="text" id="customerFacebook" 
                               class="input input-bordered w-full" 
                               placeholder="ชื่อ Facebook หรือลิงก์โปรไฟล์" />
                      </div>
                      <div>
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-line text-green-500"></i> Line ID
                          </span>
                        </label>
                        <input type="text" id="customerLine" 
                               class="input input-bordered w-full" 
                               placeholder="Line ID หรือเบอร์โทรที่ใช้กับ Line" />
                      </div>
                      <div class="sm:col-span-2">
                        <label class="label">
                          <span class="label-text">
                            <i class="bi bi-geo-alt-fill text-red-500"></i> Google Maps (ลิงก์หรือพิกัด)
                          </span>
                        </label>
                        <input type="text" id="customerMapLocation" 
                               class="input input-bordered w-full" 
                               placeholder="วางลิงก์ Google Maps หรือพิกัด GPS" />
                        <label class="label">
                          <span class="label-text-alt text-gray-500">
                            ตัวอย่าง: https://goo.gl/maps/... หรือ 13.7563, 100.5018
                          </span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <hr class="my-4" />
                  <!-- ถ่ายรูปบัตรประชาชน -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">ถ่ายรูปบัตรประชาชน</span></label>
                    <div id="idCaptureContainer" class="relative w-full h-[480px] bg-gray-100 overflow-hidden rounded">
                      <video id="idVideo" autoplay playsinline muted
                        class="absolute inset-0 w-full h-full object-cover"></video>
                      <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <img src="/uploads/บัตร.png" class="w-full h-full object-contain pointer-events-none"
                          alt="ID template overlay" />
                      </div>
                    </div>
                    <div class="flex gap-2 mt-2">
                      <button id="btnStartIdCamera" class="btn btn-sm btn-primary flex-1">เปิดกล้อง</button>
                      <button id="btnCaptureId" class="btn btn-sm btn-success flex-1" disabled>ถ่ายรูป</button>
                      <button id="btnRetakeId" class="btn btn-sm btn-secondary flex-1 hidden">ถ่ายภาพใหม่</button>
                    </div>
                    <canvas id="idCanvas" class="hidden"></canvas>
                    <input type="hidden" id="idImageData" name="idImageData" />
                  </div>
                  <!-- อัปโหลดสลิปเงินเดือน -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">อัปโหลดสลิปเงินเดือน (ถ้ามี)</span></label>
                    <input type="file" id="incomeProof" class="file-input file-input-bordered w-full"
                      accept="image/*,application/pdf" />
                    <input type="hidden" id="salarySlipUrl" />
                  </div>
                  <!-- ลงลายเซ็นลูกค้า -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">ลายเซ็นลูกค้า</span></label>
                    <canvas id="signaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                    <div class="flex justify-between mt-2">
                      <button id="btnClearSignature" class="btn btn-sm btn-warning">เคลียร์ลายเซ็น</button>
                      <button id="btnSaveSignature" class="btn btn-sm btn-success">บันทึกลายเซ็น</button>
                    </div>
                    <input type="hidden" id="customerSignatureData" name="customerSignature" />
                  </div>
                  <!-- ถ่ายรูปเซลฟี่ยืนยันตัวตน -->
                  <div class="mb-4">
                    <label class="label">
                      <span class="label-text text-lg font-semibold">
                        <i class="bi bi-camera-fill text-blue-600"></i> ถ่ายรูปเซลฟี่ยืนยันตัวตน
                      </span>
                    </label>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-600">
                      <!-- วิดีโอแสดงตัวอย่าง -->
                      <video id="selfieVideo" class="w-full rounded hidden border-2 border-gray-300" autoplay playsinline muted style="max-height: 300px;"></video>

                      <!-- ปุ่มควบคุม -->
                      <div class="space-y-2 mt-3">
                        <button id="btnStartSelfie" class="btn btn-info w-full">
                          <i class="bi bi-camera-video-fill mr-2"></i> เปิดกล้องเซลฟี่
                        </button>
                        <button id="btnCaptureSelfie" class="btn btn-success w-full" disabled>
                          <i class="bi bi-camera-fill mr-2"></i> ถ่ายรูปเซลฟี่
                        </button>
                      </div>

                      <!-- แสดงผลรูปที่ถ่าย -->
                      <canvas id="selfieCanvas" class="hidden border rounded w-full mt-3"></canvas>
                      
                      <!-- Hidden inputs สำหรับเก็บข้อมูล -->
                      <input type="hidden" id="selfieDataURL" />
                      <input type="hidden" id="selfieUrl" />
                    </div>
                  </div>

                  <!-- ชื่อพนักงานขาย (ซ่อน) -->
                  <input type="hidden" id="salespersonName" />

                  <!-- ลงลายเซ็นพนักงานขาย -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text">ลายเซ็นพนักงานขาย</span></label>
                    <canvas id="employeeSignaturePad" class="border rounded w-full" style="height:200px;"></canvas>
                    <div class="flex justify-between mt-2">
                      <button id="btnClearEmpSignature" class="btn btn-sm btn-warning">เคลียร์ลายเซ็น</button>
                      <button id="btnSaveEmpSignature" class="btn btn-sm btn-success">บันทึกลายเซ็น</button>
                    </div>
                    <input type="hidden" id="employeeSignatureData" name="employeeSignature" />
                  </div>
                </div>
              </div>
            </div>
            <!-- ขวา: สรุปรายการสินค้าและปุ่มนำทาง -->
            <div>
              <div class="card">
                <div class="card-header">
                  <i class="bi bi-cart"></i> สรุปรายการสินค้า
                </div>
                <div class="card-body">
                  <div class="cart-summary space-y-2 text-sm text-gray-600">
                    <p>ยังไม่มีสินค้าในตะกร้า</p>
                  </div>

                  <!-- ช่องทางรับสินค้า -->
                  <div class="mt-4 mb-4">
                    <label class="label"><span class="label-text text-sm font-medium">ช่องทางรับสินค้า</span></label>
                    <div class="flex gap-3">
                      <label class="flex items-center text-sm">
                        <input type="radio" name="pickupMethod" value="store" checked class="radio radio-sm radio-primary mr-2" /> 
                        หน้าร้าน
                      </label>
                      <label class="flex items-center text-sm">
                        <input type="radio" name="pickupMethod" value="online" class="radio radio-sm radio-primary mr-2" /> 
                        ออนไลน์
                      </label>
                    </div>
                  </div>

                  <!-- ค่าจัดส่ง (ซ่อนไว้ก่อน) -->
                  <div class="mb-3 hidden" id="shippingFeeContainer">
                    <label class="label"><span class="label-text text-sm">ค่าจัดส่ง (฿)</span></label>
                    <input type="number" id="shippingFee" class="input input-bordered input-sm w-full" value="0" min="0" />
                  </div>

                  <!-- ค่าธรรมเนียมเอกสาร -->
                  <div class="mb-3">
                    <label class="label"><span class="label-text text-sm">ค่าธรรมเนียมเอกสาร (฿)</span></label>
                    <input type="number" id="documentFee" class="input input-bordered input-sm w-full" value="500" min="0" />
                  </div>

                  <!-- ส่วนลด -->
                  <div class="mb-3">
                    <label class="label"><span class="label-text text-sm">ส่วนลด (฿)</span></label>
                    <input type="number" id="step2Discount" class="input input-bordered input-sm w-full" value="0" min="0" />
                  </div>

                  <!-- วิธีชำระเงิน -->
                  <div class="mb-4">
                    <label class="label"><span class="label-text text-sm font-medium">วิธีชำระเงิน</span></label>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="เงินสด" checked class="radio radio-xs radio-primary mr-1" />
                        <span>เงินสด</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="เช็ค" class="radio radio-xs radio-primary mr-1" />
                        <span>เช็ค</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="โอนเงิน" class="radio radio-xs radio-primary mr-1" />
                        <span>โอนเงิน</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="payType" value="อื่นๆ" class="radio radio-xs radio-primary mr-1" />
                        <span>อื่นๆ</span>
                      </label>
                    </div>
                  </div>


                  <div class="mt-4 space-y-2">
                    <button type="button" class="btn btn-primary w-full" id="btnStep2OpenModal">
                      <i class="bi bi-save mr-2"></i> บันทึก
                    </button>
                    <button class="btn btn-outline-secondary w-full" id="btnStep2ToStep1">
                      <i class="bi bi-arrow-left mr-2"></i> ย้อนกลับ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- End STEP2 -->

        <!-- Modal แสดงข้อความให้พิมพ์ PDF ก่อนไป Step3 -->
        <input type="checkbox" id="printPromptModal" class="modal-toggle" />
        <div class="modal">
          <div class="modal-box">
            <h3 class="font-bold text-lg">📄 พิมพ์ไฟล์ PDF</h3>
            <p class="py-4">
              กรุณากดปุ่ม "ดาวน์โหลด PDF" เพื่อดาวน์โหลดหรือพิมพ์ไฟล์ PDF ก่อน
              จากนั้นกด "ยืนยัน" เพื่อไปยังขั้นตอนถัดไป
            </p>
            <div class="modal-action">
              <!-- ปุ่มดาวน์โหลด PDF ใบเสนอราคา -->
              <button type="button" id="btnStep2DownloadPdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf mr-2"></i> ใบเสนอราคา
              </button>
              <!-- ปุ่มดาวน์โหลด PDF ใบแจ้งหนี้ -->
              <button type="button" id="btnStep2DownloadInvoicePdf" class="btn btn-secondary">
                <i class="bi bi-file-earmark-pdf-fill mr-2"></i> ใบแจ้งหนี้
              </button>
              <!-- ปุ่มยืนยัน เพื่อไป STEP3 -->
              <label for="printPromptModal" id="confirmPrintPrompt" class="btn btn-primary">
                ยืนยัน
              </label>
            </div>
          </div>
        </div>

        


        <div id="step3" class="step-content">
  <div class="flex justify-center items-center py-20">
    <h2 class="text-3xl font-bold">ขอบคุณที่ใช้บริการ</h2>
    <p class="text-lg text-gray-600 mt-4">ระบบบันทึกข้อมูลผ่อนหมดรับของเรียบร้อยแล้ว</p>
  </div>
</div>
          <!-- End STEP4 -->







          
      </main>
    </div>
  </div>





  

  <!-- Script หลัก -->
  <script>
  // โหลดโปรไฟล์พนักงาน - ฟังก์ชันนี้ถูกย้ายไป sidebar.js แล้ว
  // ใช้ window.sidebarManager.loadEmployeeProfile() แทน

    // ฟังก์ชันช่วยอัปโหลดไฟล์ทั่วไป (รับชื่อ field + ชื่อไฟล์ได้)
    async function uploadFile(file, uploadEndpoint, fieldName = 'file', filename = 'file', extras = {}) {
      const formData = new FormData();
      formData.append(fieldName, file, filename);
      // append ค่าอื่นๆ ถ้ามี
      Object.entries(extras).forEach(([key, val]) => {
        formData.append(key, val);
      });
      const res = await fetch(uploadEndpoint, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
      const js = await res.json();
      return js.url; // Assuming the server returns { success: true, url: '...' }
    }

    // ฟังก์ชันช่วยอัปโหลดลายเซ็น (Simplified: assumes pad and urlFieldId are valid if called)
    async function uploadSignature(pad, urlFieldId) {
      if (!pad || pad.isEmpty()) {
        // Consider removing alert or making it conditional if pad might not exist
        // return alert("กรุณาลงลายเซ็นก่อนบันทึก");
        console.warn('Signature pad is empty or not provided.');
        return;
      }
      const dataURL = pad.toDataURL('image/png');
      const blob = await (await fetch(dataURL)).blob();
      try {
        const url = await uploadFile(
          blob,
          '/api/upload/signature',
          'signature',
          'signature.png'
        );
        const urlInput = document.getElementById(urlFieldId);
        if (urlInput) {
          urlInput.value = url;
        } else {
          console.warn(`Input field with ID ${urlFieldId} not found for signature URL.`);
        }
      } catch (error) {
        console.error('Error uploading signature:', error);
        showToast('อัปโหลดลายเซ็นไม่สำเร็จ: ' + error.message, 'error');
      }
    }

    // —————————————— จบส่วนที่เพิ่ม ——————————————

    // =========================== A) GLOBAL CONSTANTS & VARS ===========================
    const BRANCH_CODE = '00000';
    let branchInstallments = [];
    let productImages = [];
    let activePromotions = [];
    let appliedPromotions = {};
    let level2Groups = {};
    let cartItems = [];   // เก็บสินค้าในตะกร้า
    let hiddenProductIds = new Set();
    let currentLevel3Items = [];
  

    let signaturePad, empPad; // สำหรับลายเซ็น

    // ขยับมาด้านบนสุดของ <script> เลย
    if (!document.getElementById('toastContainer')) {
      const toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 space-y-2 z-50';
      document.body.appendChild(toastContainer);
    }
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} shadow-lg`;
      alert.innerHTML = `<span>${message}</span>`;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }


    // A) โหลดสินค้าผ่อนจาก API (Level1)
    async function loadBranchInstallments() {
  try {
    const token = localStorage.getItem('authToken') || '';
    const url = `/api/product-image/pricing/installment`;
    const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
    if (!res.ok) throw new Error(res.status);
    const js = await res.json();
  
    // กรองเฉพาะ mobile และมี pricePayOff
    productImages = (js.data || []).filter(item => {
      // ตรวจสอบหลายเงื่อนไขเพื่อให้แน่ใจว่าเป็นมือถือ
      const isMobile = item.productType === 'mobile' ||
                       item.productType === 'โทรศัพท์' ||
                       item.productType === 'มือถือ' ||
                       item.category === 'mobile' ||
                       item.category === 'โทรศัพท์' ||
                       item.category === 'มือถือ';
  
      const hasPrice = item.pricePayOff > 0;
  
      // Debug log
      if (!isMobile && item.productType) {
        console.log(`🚫 Filtered out non-mobile: ${item.name} (type: ${item.productType})`);
      }
  
      return isMobile && hasPrice;
    });
  
    console.log(`✅ Loaded ${productImages.length} mobile products`);
    console.log('Mobile products:', productImages.map(p => ({
      name: p.name,
      type: p.productType,
      category: p.category
    })));
  
  } catch (err) {
    console.error('loadBranchInstallments failed:', err);
    productImages = [];
  }
}

    /**
   * numberToThaiText: แปลงตัวเลข (จำนวนเต็ม) เป็นข้อความภาษาไทย
   * รองรับจนถึงหลักล้าน (และวนกลับที่ "ล้าน")
   */
    function numberToThaiText(number) {
      const txtNum = ['ศูนย์', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
      const txtDigit = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
      if (isNaN(number)) return '';

      let n = Math.floor(Math.abs(number)).toString();
      let len = n.length;
      let result = '';

      for (let i = 0; i < len; i++) {
        const digit = parseInt(n.charAt(i), 10);
        const pos = len - i - 1;                // 0 = หน่วย, 1 = สิบ, 2 = ร้อย, ...
        const unit = pos % 6;                   // วนซ้ำทุก 6 ตำแหน่ง (ล้าน)
        const group = Math.floor(pos / 6);       // กำหนดกลุ่ม "ล้าน" ซ้ำ

        if (digit !== 0) {
          // หลักสิบ special: 1 → "สิบ", 2 → "ยี่สิบ"
          if (unit === 1) {
            if (digit === 1) result += 'สิบ';
            else if (digit === 2) result += 'ยี่สิบ';
            else result += txtNum[digit] + 'สิบ';
          }
          // หลักหน่วย special: 1 → "เอ็ด" เมื่อไม่ใช่เลขหลักเดียว
          else if (unit === 0 && digit === 1 && len > 1) {
            result += 'เอ็ด';
          }
          else {
            result += txtNum[digit] + txtDigit[unit];
          }
        }

        // ครบกลุ่มล้าน ให้เติมคำว่า "ล้าน"
        if (unit === 0 && group > 0 && digit !== 0) {
          result += 'ล้าน'.repeat(group);
        }
      }

      // ถ้าเป็น 0 ให้เติม "ศูนย์"
      if (result === '') result = txtNum[0];

      return result;
    }





    async function loadBranchInfo() {
      try {
        const token = localStorage.getItem('authToken') || '';
        const res = await fetch('/api/branch', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const js = await res.json();
        if (!js.success) throw new Error('ไม่พบข้อมูลสาขา');
        const data = js.data || [];
        const found = data.find(b => b.branch_code === BRANCH_CODE);
        if (found) {
          // เก็บ global
          window.currentBranchInfo = {
            code: found.branch_code,
            name: found.name,
            address: found.address,
            taxId: found.taxId || '-',
            tel: found.tel || '-',
          };
          document.getElementById('branchInfo').textContent =
            `${found.name} — ${found.address}`;
        } else {
          throw new Error(`ไม่พบสาขา ${BRANCH_CODE}`);
        }
      } catch (err) {
        console.warn('loadBranchInfo error:', err);
        document.getElementById('branchInfo').textContent = '(ไม่พบข้อมูลสาขา)';
        // ให้ default object ไว้กัน error
        window.currentBranchInfo = {
          code: BRANCH_CODE,
          name: 'Default Branch',
          address: '-',
          taxId: '-',
          tel: '-',
        };
      }
    }



    // =========================== D) LOAD/RENDER LEVEL1/2/3 ===========================
    async function loadLevel1() {
  // เรียกฟังก์ชันตรวจสอบก่อนแสดงผล
  validateMobileOnly();
  
  document.getElementById('level1Container').classList.remove('hidden');
  
  // สร้าง brandCounts จาก productImages ที่กรองแล้ว
  const brandCounts = productImages.reduce((acc, item) => {
    const brand = item.brand || item.name.split(' ')[0];
    const key = brand.trim().toLowerCase();
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
  
  const categories = Object.entries(brandCounts)
    .map(([key, stock]) => ({ key, label: key[0].toUpperCase() + key.slice(1), stock }))
    .filter(c => c.stock > 0)
    .sort((a, b) => a.label.localeCompare(b.label));
  
  // แสดงเฉพาะแบรนด์มือถือ
  const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
  const mobileCategories = categories.filter(cat =>
    mobileBrands.some(brand => cat.key.includes(brand))
  );
  
  if (mobileCategories.length === 0 && categories.length > 0) {
    // ถ้าไม่พบแบรนด์มือถือที่รู้จัก แต่มีสินค้า ให้แสดงทั้งหมด
    console.warn('⚠️ No recognized mobile brands found, showing all categories');
    renderLevel1(categories);
  } else {
    renderLevel1(mobileCategories);
  }
}

// เพิ่มฟังก์ชันสำหรับ debug
window.debugMobileProducts = function() {
  console.log('=== Mobile Products Debug ===');
  console.log(`Total products: ${productImages.length}`);
  
  // แสดงสินค้าทั้งหมดแบบจัดกลุ่มตาม productType
  const grouped = productImages.reduce((acc, item) => {
    const type = item.productType || 'unknown';
    if (!acc[type]) acc[type] = [];
    acc[type].push(item.name);
    return acc;
  }, {});
  
  console.table(grouped);
  
  // แสดงสินค้าที่อาจไม่ใช่มือถือ
  const suspiciousItems = productImages.filter(item => {
    const name = item.name.toLowerCase();
    const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
    return !mobileBrands.some(brand => name.includes(brand));
  });
  
  if (suspiciousItems.length > 0) {
    console.log('⚠️ Suspicious non-mobile items:', suspiciousItems.map(i => ({
      name: i.name,
      type: i.productType,
      category: i.category
    })));
  }
};


    function renderLevel1(categories) {
  const grid = document.getElementById('level1Grid');
  grid.innerHTML = '';
  
  categories.forEach(cat => {
    const hasPromo = checkBrandHasPromotion(cat.key);
    const card = document.createElement('div');
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-semibold ${hasPromo ? 'text-red-600' : ''}">${cat.label}</h6>
      <p class="text-sm text-gray-500 mt-2">มี ${cat.stock || 0} ชิ้น</p>
    `;
  
    card.addEventListener('click', () => loadLevel2(cat.key, cat.label));
    grid.appendChild(card);
  });
}

    // 2) แก้ loadLevel2 ให้กรองจาก allProductImages ตามแบรนด์ (parentKey) แล้วจัดกลุ่ม
    // 2) แก้ loadLevel2 ให้กรองจาก branchInstallments ตามแบรนด์ (parentKey) แล้วจัดกลุ่ม
    function loadLevel2(parentKey, parentLabel) {
      // ซ่อน / แสดง container
      document.getElementById('level1Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level2Container').classList.remove('hidden');
      document.getElementById('level2Title').textContent = `รายการของ ${parentLabel}`;

      // กรองเฉพาะสินค้าที่ brand หรือชื่อขึ้นต้นด้วย parentKey
      const filtered = productImages.filter(p => {
    const brand = p.brand || p.name.split(' ')[0];
    const key = brand.trim().toLowerCase();
    return key === parentKey;
  });

      // จัดกลุ่ม Level2 ตามสองคำแรกของชื่อสินค้า
      level2Groups = filtered.reduce((groups, p) => {
        const baseName = p.name.split(' ').slice(0, 2).join(' ');
        (groups[baseName] ||= []).push(p);
        return groups;
      }, {});

      // ถ้าไม่เจออะไรเลย ให้ย้อนกลับ
      if (!Object.keys(level2Groups).length) {
        showToast('ไม่พบสินค้าในแบรนด์นี้', 'warning');
        return document.getElementById('btnBackToLevel1').click();
      }

      renderLevel2(Object.keys(level2Groups));
    }


    // 3) renderLevel2 รับเป็น list ของชื่อกลุ่ม
    function renderLevel2(groupNames) {
  const grid = document.getElementById('level2Grid');
  grid.innerHTML = '';

  groupNames.forEach(baseName => {
    const items = level2Groups[baseName];
    const hasPromo = checkGroupHasPromotion(items);
    const count = items.length;
  
    const card = document.createElement('div');
    card.className = `card p-4 flex flex-col items-center cursor-pointer shadow-md hover:shadow-lg transition-shadow relative ${hasPromo ? 'has-promotion' : ''}`;
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    card.innerHTML = `
      ${fireIcon}
      <h6 class="truncate font-medium ${hasPromo ? 'text-red-600' : ''}">${baseName}</h6>
      <p class="text-sm text-gray-500 mt-2">มี ${count} ชิ้น</p>
      ${hasPromo ? '<p class="text-xs text-red-500 mt-1 font-semibold animate-pulse">ลดราคาพิเศษ!</p>' : ''}
    `;
  
    card.addEventListener('click', () => showLevel3Group(baseName));
    grid.appendChild(card);
  });
}

    // 4) showLevel3Group ดึงข้อมูลจาก level2Groups มาแสดง
    function showLevel3Group(baseName) {
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.remove('hidden');
      document.getElementById('level3Title').textContent = `รายละเอียดสินค้า: ${baseName}`;

      // จัดการต่อแค่ renderLevel3 โดยตรง เพราะ rawItems คือรูป+ข้อมูลครบแล้ว
      renderLevel3(level2Groups[baseName]);
    }

    // แก้ไขฟังก์ชัน renderLevel3 - เอาส่วนแสดงราคาออก
function renderLevel3(items) {
  currentLevel3Items = items;
  const grid = document.getElementById('level3Grid');
  grid.innerHTML = '';

  const visible = items.filter(it => !hiddenProductIds.has(it._id));
  if (!visible.length) {
    return grid.innerHTML = `<div class="text-gray-500">ไม่พบสินค้า</div>`;
  }

  visible.forEach(it => {
    const hasPromo = checkPromotionForProduct(it._id);
  
    const col = document.createElement('div');
    col.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      col.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    let payUseHTML = '';
    if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0 && it.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>ผ่อนไปใช้ไป
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">เครดิต:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">฿${it.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">ผ่อน:</span>
              <span class="font-semibold">฿${it.payUseInstallment.toLocaleString()}/เดือน</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">จำนวนงวด:</span>
              <span class="font-semibold">${it.payUseInstallmentCount} งวด</span>
            </div>
          </div>
        </div>
      `;
    }
  
    col.innerHTML = `
      ${fireIcon}
      <img src="${it.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${it.name}" />
      <h6 class="font-medium text-sm mb-1">${it.name}</h6>
      
      <!-- แสดงประเภทสินค้า -->
      <div class="text-xs text-gray-500 mb-2">
        <i class="bi bi-phone mr-1"></i>
        ประเภท: มือถือ
      </div>
      
      ${payUseHTML}
      
      ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
    `;
  
    col.querySelector('button').addEventListener('click', () => addToCart(it));
    grid.appendChild(col);
  });
}

// เพิ่มฟังก์ชันตรวจสอบประเภทสินค้า
function validateMobileOnly() {
  // ตรวจสอบและกรองสินค้าที่ไม่ใช่มือถือออกจาก productImages
  const beforeCount = productImages.length;
  
  productImages = productImages.filter(item => {
    // รายการคำที่บ่งบอกว่าเป็นมือถือ
    const mobileKeywords = ['mobile', 'มือถือ', 'โทรศัพท์', 'phone', 'smartphone'];
  
    // ตรวจสอบ productType
    const typeCheck = mobileKeywords.some(keyword =>
      item.productType?.toLowerCase().includes(keyword)
    );
  
    // ตรวจสอบ category
    const categoryCheck = mobileKeywords.some(keyword =>
      item.category?.toLowerCase().includes(keyword)
    );
  
    // ตรวจสอบชื่อสินค้า (เฉพาะแบรนด์มือถือที่รู้จัก)
    const mobileBrands = ['iphone', 'samsung', 'oppo', 'vivo', 'xiaomi', 'realme', 'huawei', 'nokia', 'oneplus'];
    const nameCheck = mobileBrands.some(brand =>
      item.name?.toLowerCase().includes(brand)
    );
  
    return typeCheck || categoryCheck || nameCheck;
  });
  
  const afterCount = productImages.length;
  console.log(`🔍 Validated mobile products: ${afterCount} items (removed ${beforeCount - afterCount} non-mobile items)`);
}

// แก้ไขฟังก์ชัน renderSearchResult - เอาส่วนแสดงราคาออก
function renderSearchResult(items) {
  document.getElementById('level1Container').classList.add('hidden');
  document.getElementById('level2Container').classList.add('hidden');
  document.getElementById('level3Container').classList.add('hidden');
  
  const container = document.getElementById('imeiResultContainer');
  const grid = document.getElementById('imeiResultGrid');
  container.classList.remove('hidden');
  grid.innerHTML = '';

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">ไม่พบสินค้า</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
  
    const card = document.createElement('div');
    card.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>ผ่อนไปใช้ไป
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">เครดิต:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">฿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">ผ่อน:</span>
              <span class="font-semibold">฿${item.payUseInstallment.toLocaleString()}/เดือน</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">จำนวนงวด:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} งวด</span>
            </div>
          </div>
        </div>
      `;
    }
  
    card.innerHTML = `
      ${fireIcon}
      <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />
      <h6 class="font-medium text-sm mb-1">${item.name}</h6>
      
      ${payUseHTML}
      
      <!-- เอาส่วนแสดงราคาออกแล้ว -->
      
      ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
      <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
    `;
  
    card.querySelector('button').addEventListener('click', () => addToCart(item));
    grid.appendChild(card);
  });
}

    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
  // เช็คโปรโมชั่น
  const hasPromo = checkPromotionForProduct(item._id);
  
  // สร้างสำเนา item พร้อมแนบค่า docFee และข้อมูลผ่อนไปใช้ไป
  const cartItem = {
    ...item,
    docFee: item.docFee || 0,
    taxRate: item.taxRate ?? 0,
    taxType: item.taxType ?? 'ไม่มี VAT',
    // 🆕 เพิ่ม 3 บรรทัดนี้
    creditThreshold: item.creditThreshold || 0,
    payUseInstallmentCount: item.payUseInstallmentCount || 0,
    payUseInstallment: item.payUseInstallment || 0
  };

  // เพิ่มสินค้าเข้า cartItems
  cartItems.push(cartItem);
  hiddenProductIds.add(item._id);

  // รีเฟรช UI
  renderCart();
  renderLevel3(currentLevel3Items);
  
  // เรียกเช็คโปรโมชั่น
  checkAvailablePromotions();
  
  // แสดง effect ถ้ามีโปรโมชั่น
  if (hasPromo) {
    const mainContent = document.getElementById('mainContent');
    createConfettiEffect(mainContent);
    showToast(`🎉 ยินดีด้วย! ${item.name} มีโปรโมชั่นพิเศษ!`, 'success');
  } else {
    showToast(`✅ เพิ่ม ${item.name} ลงในตะกร้าแล้ว`, 'success');
  }

  // Removed check for selectedPlan and initManualTerms()
}

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    function renderCart() {
  console.log('=== renderCart called ===');
  console.log('cartItems:', cartItems);
  
  const summaries = document.querySelectorAll('.cart-summary');
  if (!summaries.length) return;

  const currentStep = document.querySelector('.step-content.active')?.id;
  let html = '';

  if (cartItems.length === 0) {
    html = `<p class="text-gray-500">ยังไม่มีสินค้าในตะกร้า</p>`;
  } else if (currentStep === 'step3') {
    html = document.querySelector('#step3 .cart-summary').innerHTML;
  } else {
    html = cartItems.map((it, idx) => {
      console.log(`Rendering item ${idx}:`, {
        name: it.name,
        creditThreshold: it.creditThreshold,
        pricePayOff: it.pricePayOff
      });
  
      const promo = appliedPromotions[it._id];
      const base = it.pricePayOff;
  
      let promoHTML = '';
      if (promo) {
        const disc = promo.type === 'percentage'
          ? base * (promo.discount / 100)
          : promo.discount;
        const newPrice = base - disc;
  
        promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">฿${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">฿${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-฿${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
      }

      let payUseInfo = '';
      if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0) {
        payUseInfo = `
          <div class="text-xs text-blue-600 mt-1">
            <i class="bi bi-info-circle mr-1"></i>
            ผ่อนไปใช้ไป: ฿${it.payUseInstallment.toLocaleString()}/เดือน x ${it.payUseInstallmentCount} งวด
          </div>
        `;
      }

      // แสดงเครดิตหรือราคา
      let priceDisplay = '';
      const displayPrice = it.creditThreshold > 0 ? it.creditThreshold : it.pricePayOff;
      const priceLabel = it.creditThreshold > 0 ? 'เครดิต' : 'ราคา';
  
      // คำนวณ VAT
      const rate = (it.taxRate || 7) / 100;
      const taxType = it.taxType || 'รวมภาษี';
      let vatAmount = 0;
  
      if (taxType === 'แยกภาษี') {
        vatAmount = displayPrice * rate;
      } else {
        vatAmount = displayPrice - (displayPrice / (1 + rate));
      }
  
      priceDisplay = `
        <div class="text-sm text-primary">${priceLabel}: ฿${displayPrice.toLocaleString()}</div>
        <div class="text-xs text-gray-500">VAT 7% ${taxType === 'รวมภาษี' ? '(รวมแล้ว)' : ''}: ฿${vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
      `;

      return `
        <div class="flex items-start gap-2 border-b py-2">
          <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />
          <div class="flex-1">
            <div class="font-semibold">${it.name}</div>
            ${priceDisplay}
            ${payUseInfo}
            ${promoHTML}
          </div>
          <button class="btn btn-sm btn-error" data-index="${idx}">ลบ</button>
        </div>
      `;
    }).join('');
  }
  
  console.log('HTML generated:', html.substring(0, 200) + '...');
  
  summaries.forEach(el => {
    el.innerHTML = html;
    el.querySelectorAll('button.btn-error').forEach(btn => {
      btn.addEventListener('click', () => {
        removeFromCart(parseInt(btn.dataset.index, 10));
      });
    });
  });
  
  // อัปเดตสรุปยอดถ้าอยู่ใน step 2
  if (currentStep === 'step2') {
    updateStep2Summary();
  }
  
  if (cartItems.length > 0 && currentStep !== 'step3') {
    checkAvailablePromotions();
  }
}

function calculateTotals() {
  let subtotal = 0;
  let totalVAT = 0;
  
  cartItems.forEach(item => {
    const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
    subtotal += itemPrice;
  
    const rate = (item.taxRate || 7) / 100;
    const taxType = item.taxType || 'รวมภาษี';
  
    if (taxType === 'แยกภาษี') {
      totalVAT += itemPrice * rate;
    } else {
      totalVAT += itemPrice - (itemPrice / (1 + rate));
    }
  });
  
  const shipping = parseFloat(document.getElementById('shippingFee')?.value || 0);
  const discount = parseFloat(document.getElementById('step2Discount')?.value || 0);
  const netTotal = subtotal - discount + shipping;
  
  const isInclusiveVAT = cartItems.every(item => !item.taxType || item.taxType === 'รวมภาษี');
  const grandTotal = isInclusiveVAT ? netTotal : netTotal + totalVAT;
  
  return {
    subtotal,
    discount,
    shipping,
    totalVAT,
    netTotal,
    grandTotal,
    isInclusiveVAT
  };
}

// Event listeners for shipping fee and pickup method changes will be handled in main DOMContentLoaded

// เพิ่มการ debug เพื่อดูข้อมูล
function debugCartItems() {
  console.log('=== Debug Cart Items ===');
  cartItems.forEach((item, idx) => {
    console.log(`Item ${idx}:`, {
      name: item.name,
      pricePayOff: item.pricePayOff,
      creditThreshold: item.creditThreshold,
      payUseInstallment: item.payUseInstallment,
      payUseInstallmentCount: item.payUseInstallmentCount
    });
  });
}

    /**
    * เอาผลลัพธ์ค้นหาไปแสดงในกล่อง imeiResultContainer
    */
    function renderSearchResult(items) {
  document.getElementById('level1Container').classList.add('hidden');
  document.getElementById('level2Container').classList.add('hidden');
  document.getElementById('level3Container').classList.add('hidden');
  
  const container = document.getElementById('imeiResultContainer');
  const grid = document.getElementById('imeiResultGrid');
  container.classList.remove('hidden');
  grid.innerHTML = '';

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">ไม่พบสินค้า</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
  
    const card = document.createElement('div');
    card.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    // สร้าง HTML สำหรับข้อมูลผ่อนไปใช้ไป
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>ผ่อนไปใช้ไป
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">เครดิต:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">฿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">ผ่อน:</span>
              <span class="font-semibold">฿${item.payUseInstallment.toLocaleString()}/เดือน</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">จำนวนงวด:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} งวด</span>
            </div>
          </div>
        </div>
      `;
    }
  
    card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  
  ${payUseHTML}
  
<div class="text-sm font-semibold text-primary mb-4">
  ฿${it.pricePayOff.toLocaleString()}
</div>
  ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
`;
  
    card.querySelector('button').addEventListener('click', () => addToCart(item));
    grid.appendChild(card);
  });
}


    // =========================== E) CART ITEMS ===========================
    function addToCart(item) {
  console.log('=== Adding to cart ===', {
    name: item.name,
    pricePayOff: item.pricePayOff,
    creditThreshold: item.creditThreshold,
    payUseInstallmentCount: item.payUseInstallmentCount,
    payUseInstallment: item.payUseInstallment
  });
  
  // เช็คโปรโมชั่น
  const hasPromo = checkPromotionForProduct(item._id);
  
  // สร้างสำเนา item พร้อมแนบค่า docFee และข้อมูลผ่อนไปใช้ไป
  const cartItem = {
    ...item,
    docFee: item.docFee || 0,
    taxRate: item.taxRate ?? 0,
    taxType: item.taxType ?? 'ไม่มี VAT',
    // *** ตรวจสอบให้แน่ใจว่าค่าเหล่านี้ถูกเก็บ ***
    creditThreshold: item.creditThreshold || 0,
    payUseInstallmentCount: item.payUseInstallmentCount || 0,
    payUseInstallment: item.payUseInstallment || 0
  };

  console.log('=== Cart item created ===', cartItem);

  // เพิ่มสินค้าเข้า cartItems
  cartItems.push(cartItem);
  hiddenProductIds.add(item._id);

  // รีเฟรช UI
  renderCart();
  renderLevel3(currentLevel3Items);
  
  // เรียกเช็คโปรโมชั่น
  checkAvailablePromotions();
  
  // แสดง effect ถ้ามีโปรโมชั่น
  if (hasPromo) {
    const mainContent = document.getElementById('mainContent');
    createConfettiEffect(mainContent);
    showToast(`🎉 ยินดีด้วย! ${item.name} มีโปรโมชั่นพิเศษ!`, 'success');
  } else {
    showToast(`✅ เพิ่ม ${item.name} ลงในตะกร้าแล้ว`, 'success');
  }
}

    function removeFromCart(idx) {
      const removed = cartItems.splice(idx, 1)[0];
      hiddenProductIds.delete(removed._id);
      renderCart();
      renderLevel3(currentLevel3Items);
      // Removed check for selectedPlan and initManualTerms()
    }
    // 1. เพิ่ม console.log เพื่อ debug
function renderCart() {
  console.log('=== renderCart called ===');
  console.log('cartItems:', cartItems);
  
  const summaries = document.querySelectorAll('.cart-summary');
  if (!summaries.length) return;

  const currentStep = document.querySelector('.step-content.active')?.id;
  let html = '';

  if (cartItems.length === 0) {
    html = `<p class="text-gray-500">ยังไม่มีสินค้าในตะกร้า</p>`;
  } else if (currentStep === 'step3') {
    html = document.querySelector('#step3 .cart-summary').innerHTML;
  } else {
    html = cartItems.map((it, idx) => {
      console.log(`Rendering item ${idx}:`, {
        name: it.name,
        creditThreshold: it.creditThreshold,
        pricePayOff: it.pricePayOff
      });
  
      const promo = appliedPromotions[it._id];
      const base = it.pricePayOff;
  
      let promoHTML = '';
      if (promo) {
        const disc = promo.type === 'percentage'
          ? base * (promo.discount / 100)
          : promo.discount;
        const newPrice = base - disc;
  
        promoHTML = `
          <div class="mt-1">
            <span class="badge badge-error badge-sm">${promo.name}</span>
            <div class="text-xs mt-1">
              <span class="line-through text-gray-500">฿${base.toLocaleString()}</span>
              <span class="text-red-600 ml-2">฿${newPrice.toLocaleString()}</span>
              <span class="text-green-600 ml-1">(-฿${disc.toLocaleString()})</span>
            </div>
          </div>
        `;
      }

      let payUseInfo = '';
      if (it.creditThreshold > 0 && it.payUseInstallmentCount > 0) {
        payUseInfo = `
          <div class="text-xs text-blue-600 mt-1">
            <i class="bi bi-info-circle mr-1"></i>
            ผ่อนไปใช้ไป: ฿${it.payUseInstallment.toLocaleString()}/เดือน x ${it.payUseInstallmentCount} งวด
          </div>
        `;
      }

      // *** ตรวจสอบและแสดงเครดิต ***
      let priceDisplay = '';
      if (it.creditThreshold && it.creditThreshold > 0) {
        console.log(`✅ Using credit: ${it.creditThreshold}`);
        priceDisplay = `<div class="text-sm text-primary">เครดิต: ฿${it.creditThreshold.toLocaleString()}</div>`;
      } else {
        console.log(`❌ No credit, using price: ${it.pricePayOff}`);
        priceDisplay = `<div class="text-sm text-primary">ราคา: ฿${it.pricePayOff.toLocaleString()}</div>`;
      }

      return `
        <div class="flex items-start gap-2 border-b py-2">
          <img src="${it.image || '/uploads/default-product.png'}" class="w-12 h-12 rounded" />
          <div class="flex-1">
            <div class="font-semibold">${it.name}</div>
            ${priceDisplay}
            ${payUseInfo}
            ${promoHTML}
          </div>
          <button class="btn btn-sm btn-error" data-index="${idx}">ลบ</button>
        </div>
      `;
    }).join('');
  }
  
  console.log('HTML generated:', html.substring(0, 200) + '...');
  
  summaries.forEach(el => {
    el.innerHTML = html;
    el.querySelectorAll('button.btn-error').forEach(btn => {
      btn.addEventListener('click', () => {
        removeFromCart(parseInt(btn.dataset.index, 10));
      });
    });
  });
  
  if (cartItems.length > 0 && currentStep !== 'step3') {
    checkAvailablePromotions();
  }
}

// 2. ทดสอบโดยเรียก renderCart อีกครั้ง
setTimeout(() => {
  console.log('🔄 Force re-render cart after 2 seconds');
  renderCart();
}, 2000);

// 3. ฟังก์ชันสำหรับ debug cart items
window.debugCart = function() {
  console.table(cartItems.map(item => ({
    name: item.name,
    pricePayOff: item.pricePayOff,
    creditThreshold: item.creditThreshold,
    hasCredit: item.creditThreshold > 0
  })));
  renderCart();
};

    /**
    * เอาผลลัพธ์ค้นหาไปแสดงในกล่อง imeiResultContainer
    */
    function renderSearchResult(items) {
  document.getElementById('level1Container').classList.add('hidden');
  document.getElementById('level2Container').classList.add('hidden');
  document.getElementById('level3Container').classList.add('hidden');
  
  const container = document.getElementById('imeiResultContainer');
  const grid = document.getElementById('imeiResultGrid');
  container.classList.remove('hidden');
  grid.innerHTML = '';

  if (!items.length) {
    grid.innerHTML = `<div class="text-gray-500 p-4">ไม่พบสินค้า</div>`;
    return;
  }

  items.forEach(item => {
    const hasPromo = checkPromotionForProduct(item._id);
  
    const card = document.createElement('div');
    card.className = 'card p-4 flex flex-col relative';
  
    if (hasPromo) {
      card.style.overflow = 'visible';
    }
  
    const fireIcon = hasPromo ? '<span class="promo-fire-icon">🔥</span>' : '';
  
    // สร้าง HTML สำหรับข้อมูลผ่อนไปใช้ไป
    let payUseHTML = '';
    if (item.creditThreshold > 0 && item.payUseInstallmentCount > 0 && item.payUseInstallment > 0) {
      payUseHTML = `
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
          <h6 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-2">
            <i class="bi bi-credit-card-2-front mr-1"></i>ผ่อนไปใช้ไป
          </h6>
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">เครดิต:</span>
              <span class="font-semibold text-blue-600 dark:text-blue-400">฿${item.creditThreshold.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">ผ่อน:</span>
              <span class="font-semibold">฿${item.payUseInstallment.toLocaleString()}/เดือน</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">จำนวนงวด:</span>
              <span class="font-semibold">${item.payUseInstallmentCount} งวด</span>
            </div>
          </div>
        </div>
      `;
    }
  
    card.innerHTML = `
  ${fireIcon}
  <img src="${item.image || '/uploads/default-product.png'}" class="product-img mb-2 rounded-md" alt="${item.name}" />
  <h6 class="font-medium text-sm mb-1">${item.name}</h6>
  
  ${payUseHTML}
  
<div class="text-sm font-semibold text-primary mb-4">
  ฿${item.pricePayOff.toLocaleString()}
</div>
  ${hasPromo ? '<p class="promotion-text">มีโปรโมชั่น!</p>' : ''}
  <button class="btn btn-primary mt-auto text-sm">หยิบใส่ตะกร้า</button>
`;
  
    card.querySelector('button').addEventListener('click', () => addToCart(item));
    grid.appendChild(card);
  });
}


    // F) ค้นหาสินค้า (ชื่อรุ่น หรือ IMEI)
    async function searchItems() {
  const query = document.getElementById('productSearchQuery').value.trim();
  if (!query) {
    showToast('กรุณากรอกคำค้นหา', 'warning');
    return;
  }

  // ค้นหาจาก productImages ที่กรองเฉพาะมือถือแล้ว
  const results = productImages.filter(item => {
    const matchName = item.name.toLowerCase().includes(query.toLowerCase());
  
    // ตรวจสอบเพิ่มเติมว่าเป็นมือถือจริงๆ
    const mobileKeywords = ['mobile', 'มือถือ', 'โทรศัพท์', 'phone', 'smartphone'];
    const isMobile = mobileKeywords.some(keyword =>
      item.productType?.toLowerCase().includes(keyword) ||
      item.category?.toLowerCase().includes(keyword)
    );
  
    return matchName && isMobile;
  });

  if (results.length === 0) {
    showToast('ไม่พบมือถือที่ค้นหา', 'info');
  } else {
    showToast(`พบมือถือ ${results.length} รุ่น`, 'success');
  }

  renderSearchResult(results);
}


    // ผูก event ให้ปุ่ม autoPrintYes
    // Removed event listener for btnAutoPrintYes

    // ผูก event ให้ปุ่ม "พิมพ์เอกสาร"
    // Removed event listener for btnPrintPdf


    function resetSearch() {
      document.getElementById('productSearchQuery').value = '';
      document.getElementById('imeiResultContainer').classList.add('hidden');
      document.getElementById('level1Container').classList.remove('hidden');
      document.getElementById('level2Container').classList.add('hidden');
      document.getElementById('level3Container').classList.add('hidden');
    }

    async function loadActivePromotions() {
  try {
    showToast('🔄 กำลังโหลดโปรโมชั่น...', 'info');
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/active', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const js = await res.json();
    if (js.status === 'success') {
      activePromotions = js.data.filter(p => {
        const now = new Date();
        const branchOk = (!p.applicableBranches?.length) || p.applicableBranches.includes(BRANCH_CODE);
        const startOk  = new Date(p.startDate) <= now;
        const endOk    = new Date(p.endDate) >= now;
        const activeOk = p.isActive === true;
        const usageOk  = !p.usageLimit || (p.usageCount < p.usageLimit);
        return branchOk && startOk && endOk && activeOk && usageOk;
      });
      showToast(`✅ โหลดโปรโมชั่นสำเร็จ: ${activePromotions.length} รายการ`, 'success');
    }
  } catch (err) {
    console.error('❌ Error loading promotions:', err);
    activePromotions = [];
  }
}

function checkPromotionForProduct(productId) {
  console.log('🔍 Checking promotion for product:', productId);
  
  // หาข้อมูลสินค้าจาก branchInstallments
  const stockItem = productImages.find(item => item._id === productId);
  if (!stockItem) {
    console.log('❌ Stock item not found');
    return false;
  }
  
  console.log('📦 Stock item found:', {
    _id: stockItem._id,
    name: stockItem.name,
    brand: stockItem.brand
  });
  
  const hasPromo = activePromotions.some(p => {
    // ถ้าไม่ระบุสินค้า = ใช้ได้กับทุกสินค้า
    const allProducts = !p.applicableProducts ||
                       (Array.isArray(p.applicableProducts) && p.applicableProducts.length === 0);
  
    if (allProducts) {
      console.log(`✅ Promotion "${p.name}" applies to all products`);
      return true;
    }
  
    // เช็คด้วยชื่อสินค้า
    let matchByName = false;
    if (stockItem.name && p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchByName = p.applicableProducts.some(prod => {
        const stockName = stockItem.name.trim().toLowerCase();
        const promoProductName = prod.name ? prod.name.trim().toLowerCase() : '';
        return stockName === promoProductName;
      });
    }
  
    // เช็คด้วย Product ID (fallback)
    let matchById = false;
    if (p.applicableProducts && Array.isArray(p.applicableProducts)) {
      matchById = p.applicableProducts.some(prod => {
        const prodId = typeof prod === 'string' ? prod : prod._id;
        return prodId === productId;
      });
    }
  
    return allProducts || matchByName || matchById;
  });
  
  console.log('🔥 Has promotion:', hasPromo);
  return hasPromo;
}

// ฟังก์ชันเช็คโปรโมชั่นระดับแบรนด์
function checkBrandHasPromotion(brandKey) {
  const brandProducts = productImages.filter(p => {
    const brand = p.brand || p.name.split(' ')[0];
    const key = brand.trim().toLowerCase();
    return key === brandKey;
  });
  
  return brandProducts.some(product => checkPromotionForProduct(product._id));
}

// ฟังก์ชันเช็คโปรโมชั่นระดับกลุ่ม
function checkGroupHasPromotion(groupItems) {
  return groupItems.some(item => checkPromotionForProduct(item._id));
}

// ฟังก์ชันสร้าง Confetti Effect
function createConfettiEffect(element) {
  const colors = ['#ff6b6b', '#ff3838', '#ffd93d', '#6bcf7f', '#4834d4'];
  const confettiCount = 30;
  
  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-10px';
    confetti.style.opacity = '1';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    confetti.style.transition = 'all 1s ease-out';
  
    element.appendChild(confetti);
  
    setTimeout(() => {
      confetti.style.top = '100%';
      confetti.style.opacity = '0';
      confetti.style.transform = `rotate(${Math.random() * 720}deg) translateX(${(Math.random() - 0.5) * 100}px)`;
    }, 10);
  
    setTimeout(() => confetti.remove(), 1000);
  }
}

async function checkAvailablePromotions() {
  if (!cartItems.length) {
    appliedPromotions = {};
    return;
  }
  try {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    const ids = [...new Set(cartItems.map(i => i._id))];
    const res = await fetch('/api/promotion/check-available', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+token,'Content-Type':'application/json' },
      body: JSON.stringify({ productIds: ids, branchCode: BRANCH_CODE })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const js = await res.json();
    if (js.status === 'success') displayAvailablePromotions(js.data);
  } catch (err) {
    console.error('❌ Error checking promotions:', err);
    appliedPromotions = {};
  }
}

function displayAvailablePromotions(data) {
  appliedPromotions = {};
  cartItems.forEach(item => {
    const promos = data[item._id] || [];
    if (promos.length) {
      const best = promos.reduce((b,p) => {
        const val = p.type === 'percentage'
          ? item.pricePayOff * (p.discount/100)
          : p.type === 'fixed'
            ? p.discount
            : 0;
        const bval = b.type === 'percentage'
          ? item.pricePayOff * (b.discount/100)
          : b.type === 'fixed'
            ? b.discount
            : 0;
        return val > bval ? p : b;
      });
      appliedPromotions[item._id] = best;
    }
  });
  renderCart();
}

function calculatePromotionDiscount() {
  let totalDiscount = 0, details = [];
  Object.entries(appliedPromotions).forEach(([pid,promo]) => {
    const item = cartItems.find(i=>i._id===pid);
    if (!item) return;
    const disc = promo.type === 'percentage'
      ? item.pricePayOff * (promo.discount/100)
      : promo.type === 'fixed'
        ? promo.discount
        : 0;
    totalDiscount += disc;
    details.push({ name: promo.name, discount: disc, productName: item.name });
  });
  return { totalDiscount, details };
}

async function recordPromotionUsage(promotionId) {
  try {
    const token = localStorage.getItem('authToken');
    const res = await fetch('/api/promotion/use', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ promotionId })
    });
    const js = await res.json();
    if (js.status !== 'success') {
      console.error('Failed to record promotion usage:', js.message);
    }
  } catch (err) {
    console.error('Error recording promotion usage:', err);
  }
}

    // =========================== I) CAMERA & SIGNATURE ===========================
    function setupIDCamera() {
      const btnStart = document.getElementById('btnStartIdCamera');
      const btnCapture = document.getElementById('btnCaptureId');
      const btnRetake = document.getElementById('btnRetakeId');
      const container = document.getElementById('idCaptureContainer');
      const canvas = document.getElementById('idCanvas');
      // const inputData = document.getElementById("idImageData"); // Likely removed
      const inputUrl = document.getElementById('idCardImageUrl'); // Keep if still used for storing URL
      let idStream = null;

      // If essential elements are missing, don't proceed with setup
      if (!btnStart || !btnCapture || !btnRetake || !container || !canvas) {
        console.log('ID Camera elements not found, skipping setup. This is normal if not on step 2.');
        return;
      }

      // เปิดกล้อง
      btnStart.addEventListener('click', async () => {
        try {
          idStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          const video = container.querySelector('video'); // Assuming video element is dynamically added or exists
          if (video) {
            video.srcObject = idStream;
            await video.play();
            btnCapture.disabled = false;
          } else {
            console.error('Video element for ID camera not found in container.');
            showToast('ไม่สามารถเตรียมกล้องบัตรประชาชน', 'error');
          }
        } catch (err) {
          console.error('ไม่สามารถเข้าถึงกล้อง:', err);
          showToast('ไม่สามารถเตรียมกล้องบัตรประชาชน', 'error');
        }
      });

      // ถ่ายรูปและอัปโหลด
      btnCapture.addEventListener('click', async () => {
        const video = container.querySelector('video');
        if (!video) {
            console.error('Video element for ID capture not found.');
            return;
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        // if (inputData) inputData.value = dataURL; // Keep if inputData exists

        // preview
        // Ensure container is robust enough or this part is conditional
        if (container.innerHTML.includes('<video')) { // Basic check
            container.innerHTML = `<img src="${dataURL}" class="w-full h-full object-contain rounded" alt="ID Preview"/>`;
        }
        if(idStream) idStream.getTracks().forEach(t => t.stop());
        btnStart.classList.add('hidden');
        btnCapture.classList.add('hidden');
        btnRetake.classList.remove('hidden');

        try {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
          const url = await uploadFile(
            blob,
            '/api/upload/id-card',
            'file',
            'id-card.jpg'
          );
          if (inputUrl) inputUrl.value = url;
          showToast('อัปโหลดบัตรประชาชนเรียบร้อย', 'success');
        } catch (err) {
          console.error('Upload ID card failed:', err);
          showToast('อัปโหลดบัตรประชาชนไม่สำเร็จ: ' + err.message, 'error');
        }
      });

      // ถ่ายใหม่
      btnRetake.addEventListener('click', () => {
        // This part heavily depends on the specific HTML structure for the video container
        // It's safer to make it conditional or ensure the elements exist
        const videoContainerHTML = `
          <video id="idVideo" autoplay playsinline muted
                 class="absolute inset-0 w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <img src="/uploads/บัตร.png"
                 class="w-full h-full object-contain pointer-events-none"
                 alt="ID template overlay"/>
          </div>`;
        // Check if container can be reset this way
        if (document.getElementById('idVideo')) { // Example check
            container.innerHTML = videoContainerHTML;
        } else {
            console.warn('Cannot reset ID camera view, video container structure might have changed.');
        }
        btnStart.classList.remove('hidden');
        btnCapture.classList.remove('hidden');
        btnRetake.classList.add('hidden');
      });
    }
    function setupSelfieCamera() {
      const btnStart = document.getElementById('btnStartSelfie');
      const btnCapture = document.getElementById('btnCaptureSelfie');
      const video = document.getElementById('selfieVideo');
      const canvas = document.getElementById('selfieCanvas');
      // const inputData = document.getElementById("selfieDataURL"); // Likely removed
      const inputUrl = document.getElementById('selfieUrl'); // Keep if used
      let selfieStream = null;

      if (!btnStart || !btnCapture || !video || !canvas || !inputUrl) {
        console.warn('Selfie camera elements not found, skipping setup.');
        return;
      }

      btnStart.addEventListener('click', async () => {
        try {
          selfieStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: 'environment' } }
          });
          video.srcObject = selfieStream;
          await video.play();
          video.classList.remove('hidden');
          btnCapture.disabled = false;
        } catch (err) {
          console.warn('ไม่สามารถเข้าถึงกล้องหลัง, ลองกล้องหน้า:', err);
          try {
            selfieStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = selfieStream;
            await video.play();
            video.classList.remove('hidden');
            btnCapture.disabled = false;
            showToast('สลับไปกล้องหน้า (fallback)', 'warning');
          } catch (err2) {
            console.error('ไม่สามารถเข้าถึงกล้องเซลฟี่:', err2);
            showToast('ไม่สามารถเข้าถึงกล้องเซลฟี่', 'error');
            btnStart.disabled = true;
          }
        }
      });

      btnCapture.addEventListener('click', async () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
        // if(inputData) inputData.value = dataUrl;
        canvas.classList.remove('hidden');

        try {
          let blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
          // if (!blob && dataUrl) { // Fallback if toBlob returns null
          //   const res = await fetch(dataUrl);
          //   blob = await res.blob();
          // }
          if (blob) {
            const url = await uploadFile(
              blob,
              '/api/upload/selfie',
              'file',
              'selfie.jpg'
            );
            if (inputUrl) inputUrl.value = url;
            showToast('อัปโหลดเซลฟี่เรียบร้อย', 'success');
          } else {
            showToast('ไม่สามารถสร้าง blob จาก selfie canvas', 'error');
          }
        } catch (err) {
          console.error('Upload selfie failed:', err);
          showToast('อัปโหลดเซลฟี่ไม่สำเร็จ: ' + err.message, 'error');
        } finally {
          if (selfieStream) {
            selfieStream.getTracks().forEach(track => track.stop());
            selfieStream = null;
          }
          btnCapture.disabled = true;
          btnStart.disabled = false;
        }
      });
    }

    function setupSignaturePad() {
      const canvasEl = document.getElementById('signaturePad');
      if (canvasEl) {
        const ctx = canvasEl.getContext('2d');
        function resizeCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data = signaturePad ? signaturePad.toData() : []; // Check if signaturePad exists
          canvasEl.width = canvasEl.offsetWidth * ratio;
          canvasEl.height = canvasEl.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          if (signaturePad) {
            signaturePad.clear();
            signaturePad.fromData(data);
          }
        }
        window.addEventListener('resize', resizeCanvas);
        signaturePad = new SignaturePad(canvasEl, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeCanvas();
        const btnClearSignature = document.getElementById('btnClearSignature');
        const btnSaveSignature = document.getElementById('btnSaveSignature');
        if (btnClearSignature) btnClearSignature.addEventListener('click', () => signaturePad.clear());
        if (btnSaveSignature) {
          btnSaveSignature.addEventListener('click', () => {
            if (!signaturePad.isEmpty()) {
              const signatureData = signaturePad.toDataURL();
              document.getElementById('customerSignatureData').value = signatureData;
              showToast('บันทึกลายเซ็นลูกค้าแล้ว', 'success');
            } else {
              showToast('กรุณาเซ็นชื่อก่อน', 'warning');
            }
          });
        }
      } else {
        console.warn('Customer signature pad canvas not found.');
      }
    }

    function setupEmployeeSignaturePad() {
      const empCanvas = document.getElementById('employeeSignaturePad');
      if (empCanvas) {
        const empCtx = empCanvas.getContext('2d');
        function resizeEmpCanvas() {
          const ratio = Math.max(window.devicePixelRatio || 1, 1);
          const data2 = empPad ? empPad.toData() : []; // Check if empPad exists
          empCanvas.width = empCanvas.offsetWidth * ratio;
          empCanvas.height = empCanvas.offsetHeight * ratio;
          empCtx.scale(ratio, ratio);
          if (empPad) {
            empPad.clear();
            empPad.fromData(data2);
          }
        }
        window.addEventListener('resize', resizeEmpCanvas);
        empPad = new SignaturePad(empCanvas, {
          backgroundColor: 'rgba(255,255,255,0)', penColor: 'black',
          minWidth: 0.5, maxWidth: 2.5, velocityFilterWeight: 0.7
        });
        resizeEmpCanvas();
        const btnClearEmpSignature = document.getElementById('btnClearEmpSignature');
        const btnSaveEmpSignature = document.getElementById('btnSaveEmpSignature');
        if (btnClearEmpSignature) btnClearEmpSignature.addEventListener('click', () => empPad.clear());
        if (btnSaveEmpSignature) {
          btnSaveEmpSignature.addEventListener('click', () => {
            if (!empPad.isEmpty()) {
              const empSignatureData = empPad.toDataURL();
              document.getElementById('employeeSignatureData').value = empSignatureData;
              showToast('บันทึกลายเซ็นพนักงานแล้ว', 'success');
            } else {
              showToast('กรุณาเซ็นชื่อก่อน', 'warning');
            }
          });
        }
      } else {
        console.warn('Employee signature pad canvas not found.');
      }
    }



    // =========================== J) MISC ACTIONS (Dark, ToggleMenu, Logout) ===========================
    // ฟังก์ชัน toggleDarkMode, logout, toggleMenu ถูกย้ายไป sidebar.js แล้ว
    // ใช้ window.sidebarManager.toggleDarkMode(), window.sidebarManager.logout(), window.sidebarManager.toggleSidebar() แทน
  
    // Fallback sidebar initialization if sidebar.js fails to load
    function initializeFallbackSidebar() {
      console.log('Initializing fallback sidebar...');
      const container = document.getElementById('sidebarContainer');
      if (!container) return;
  
      // Simple sidebar HTML that matches the expected structure
      container.innerHTML = `
        <button id="btnToggleMenu"
                title="Toggle Menu"
                aria-label="Toggle Menu"
                class="fixed left-0 top-1/2 transform -translate-y-1/2 
                       bg-blue-600 text-white p-2 rounded-r-full shadow-lg z-50 
                       hover:bg-blue-700 transition">
          <i class="bi bi-chevron-left"></i>
        </button>

        <aside id="sidebar"
               class="fixed inset-y-0 left-0 w-56 bg-white dark:bg-gray-800 shadow flex flex-col
                      transform transition-transform duration-300 z-20">
          
          <a href="pattani_home" class="p-4 border-b border-gray-200 dark:border-gray-700">
            <img src="/uploads/Logo2.png" alt="Logo" class="w-full h-auto object-cover"/>
          </a>
          
          <div class="flex-1 p-4 overflow-y-auto">
            <ul class="flex flex-col w-full space-y-1">
              <li><a href="frontstore_pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-cash-stack text-xl mr-3"></i>ซื้อสด</a></li>
              <li><a href="installment_Pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-credit-card text-xl mr-3"></i>ซื้อผ่อน</a></li>
              <li><a href="Installment_on_use" class="flex items-center h-12 px-4 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300"><i class="bi bi-credit-card-2-front text-xl mr-3"></i>ผ่อนไปใช้ไป</a></li>
              <li><a href="Installment_complete_pickup" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-credit-card-fill text-xl mr-3"></i>ผ่อนหมดรับของ</a></li>
              <li><a href="Addproduct_pattani" class="flex items-center h-12 px-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="bi bi-speedometer2 text-xl mr-3"></i>เพิ่มสินค้าใหม่</a></li>
              
              <li class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-2">
                <div class="flex items-center h-16 px-4 w-full rounded-lg bg-gray-50 dark:bg-gray-800/50">
                  <div class="avatar mr-3">
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                      <i class="bi bi-person text-gray-600"></i>
                    </div>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium">ผู้ใช้</span>
                    <span class="text-xs text-gray-500">พนักงาน</span>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </aside>
      `;
  
      // Toggle functionality
      const toggleBtn = document.getElementById('btnToggleMenu');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
  
      if (toggleBtn && sidebar && mainContent) {
        toggleBtn.addEventListener('click', () => {
          const isHidden = sidebar.classList.contains('-translate-x-full');
          sidebar.classList.toggle('-translate-x-full');
  
          if (isHidden) {
            mainContent.style.marginLeft = '14rem';
            toggleBtn.querySelector('i').classList.replace('bi-chevron-right', 'bi-chevron-left');
          } else {
            mainContent.style.marginLeft = '0';
            toggleBtn.querySelector('i').classList.replace('bi-chevron-left', 'bi-chevron-right');
          }
        });
      }
  
      console.log('✅ Fallback sidebar initialized');
    }
  
    function togglePlan2Detail() {
      const plan2Detail = document.querySelector('.plan2-detail');
      const plan2Radio = document.getElementById('plan2');
      if (plan2Detail && plan2Radio) {
        plan2Detail.style.display = plan2Radio.checked ? 'block' : 'none';
      }
    }



    // =========================== K) DOMContentLoaded : MAIN FLOW ===========================
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Initialize sidebar (prefer inline fallback for reliability)
      setTimeout(() => {
        const sidebarContainer = document.getElementById('sidebarContainer');
  
        // Check if external sidebar.js loaded and initialized
        const hasExternalSidebar = sidebarContainer && sidebarContainer.innerHTML.trim() !== '' &&
                                   document.getElementById('sidebar');
  
        if (hasExternalSidebar) {
          console.log('✅ External sidebar.js loaded successfully');
        } else {
          console.log('🔄 Using inline sidebar fallback');
          if (window.sidebarFallback) {
            window.sidebarFallback.init();
          } else {
            // Final fallback if inline script also fails
            initializeFallbackSidebar();
          }
        }
      }, 200);
  
      await loadActivePromotions();

              // 2) โหลดข้อมูลพนักงาน จะทำใน sidebar.js แล้ว

      // 3) ฟังก์ชันอื่น ๆ เช่น โหลดสต็อก, branch, bind events...
      await loadBranchInstallments();
      await loadBranchInfo();
      loadLevel1();

     // 4) Event listeners สำหรับ sidebar จะจัดการใน sidebar.js แล้ว
     // Event listeners for step2 summary updates will be added after function definitions

     // Step navigation
     document.getElementById('btnStep1ToStep2')?.addEventListener('click', () => goToStep(2));
     document.getElementById('btnStep2ToStep1')?.addEventListener('click', () => goToStep(1));
  


      // ส่วนนี้ไม่ต้องแก้ (เป็นการผูกให้คลิกแล้วไป step ที่ต่ำกว่าได้)
      document.querySelectorAll('.step').forEach(el => {
        el.style.cursor = 'pointer';
        el.addEventListener('click', () => {
          const target = Number(el.getAttribute('data-step'));
          const current = Number(document.querySelector('.step.active').getAttribute('data-step'));
          if (target <= current) {
            goToStep(target);
          }
        });
      });
  

    // ฟังก์ชันตรวจสอบสต็อกหลังการขาย
async function checkStockAfterSale() {
  try {
    const token = localStorage.getItem('authToken');
  
    for (const item of cartItems) {
      const res = await fetch(`/api/branch-stock/${item._id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
  
      const data = await res.json();
  
      if (data.success) {
        console.log(`สต็อกคงเหลือของ ${item.name}:`, data.data?.stock_value || 0);
      }
    }
  } catch (err) {
    console.error('Error checking stock:', err);
  }
}



    // แทรกลงไปในฟังก์ชัน goToStep หลังจากอัปเดตคลาส active/completed เสร็จ
function goToStep(stepNumber) {
  // Update step-content
  document.querySelectorAll('.step-content').forEach(st => st.classList.remove('active'));
  const target = document.getElementById('step' + stepNumber);
  if (target) target.classList.add('active');
  
  // Update visual stepper
  document.querySelectorAll('.step').forEach(elem => {
    const s = Number(elem.getAttribute('data-step'));
    elem.classList.remove('active', 'completed');
    if (s < stepNumber) elem.classList.add('completed');
    else if (s === stepNumber) elem.classList.add('active');
  });

  // เพิ่มการ render cart และอัปเดตสรุปเมื่อไป step 2
  if (stepNumber === 2) {
    renderCart();
    updateStep2Summary();
  }

  // ถ้าเป็น step 3 รอ 5 วินาที แล้วกลับไป step 1
  if (stepNumber === 3) {
    setTimeout(() => {
        cartItems = [];
        hiddenProductIds.clear();
        renderCart();
        if (typeof resetSearch === 'function') resetSearch();
        goToStep(1);
    }, 5000);
  }
}


// Removed selectedManualOption setup

      // ปิด Order Success Modal
      // Removed event listener for btnCloseSuccessModal
      // 1) ระบุสาขา
      branchCode: BRANCH_CODE,

        // Step2 -> สร้างใบเสนอราคา และเปิด modal
        document.getElementById('btnStep2OpenModal').addEventListener('click', async () => {
  try {
    // อ่านข้อมูลลูกค้า
    const prefix = document.getElementById('customerPrefix').value || '';
    const firstName = document.getElementById('customerFirstName').value || '';
    const lastName = document.getElementById('customerLastName').value || '';
    const customerName = `${prefix}${firstName} ${lastName}`.trim();
  
    // ที่อยู่
    const address = {
      houseNo: document.getElementById('houseNo').value,
      moo: document.getElementById('moo').value,
      subDistrict: document.getElementById('subDistrict').value,
      district: document.getElementById('district').value,
      province: document.getElementById('province').value,
      zipcode: document.getElementById('zipcode').value
    };
  
    // รายการสินค้า - ใช้เครดิตแทนราคาเต็ม
    const items = cartItems.map(item => {
      const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
      return {
        product: item._id,
        description: item.name,
        quantity: 1,
        unitPrice: itemPrice,  // ใช้เครดิตแทนราคาเต็ม
        totalPrice: itemPrice, // ใช้เครดิตแทนราคาเต็ม
        taxRate: item.taxRate || 7,
        taxType: item.taxType || 'รวมภาษี',
        // เพิ่มข้อมูลผ่อนไปใช้ไป
        creditThreshold: item.creditThreshold || 0,
        payUseInstallmentCount: item.payUseInstallmentCount || 0,
        payUseInstallment: item.payUseInstallment || 0
      };
    });
  
    // คำนวณยอด - ใช้เครดิตในการคำนวณ
    const subtotal = items.reduce((sum, i) => sum + i.totalPrice, 0);
    const shipping = parseFloat(document.getElementById('shippingFee').value) || 0;
    const discount = parseFloat(document.getElementById('step2Discount').value) || 0;
  
    // สร้าง payload
    const payload = {
      type: 'PAYOFF_RECEIPT',
      planType: 'plan3',
      installmentType: 'ผ่อนหมดรับของ',
      date: new Date().toISOString(),
      branchCode: BRANCH_CODE,
      customer: {
        customerType: 'individual',
        individual: {
          prefix: prefix,
          firstName: firstName,
          lastName: lastName,
          phone: document.getElementById('customerPhone').value,
          email: document.getElementById('customerEmail').value,
          taxId: document.getElementById('customerIdCard').value,
          address: address,
          socialContact: {
            facebook: '',
            line: '',
            mapLocation: ''
          }
        },
        name: customerName,
        fullAddress: `${address.houseNo} หมู่ ${address.moo} ต.${address.subDistrict} อ.${address.district} จ.${address.province} ${address.zipcode}`.trim()
      },
      items: items,
      summary: {
        subtotal: subtotal,
        shipping: shipping,
        discount: discount,
        netTotal: subtotal + shipping - discount
      },
      pickupMethod: document.querySelector('input[name="pickupMethod"]:checked')?.value || 'store',
      paymentMethod: document.querySelector('input[name="payType"]:checked')?.value || 'เงินสด',
      // ลายเซ็น
      customerSignatureUrl: document.getElementById('customerSignatureUrl').value,
      salespersonSignatureUrl: document.getElementById('salespersonSignatureUrl').value,
      salespersonName: window.employeeName || 'ไม่ระบุ'
    };
  
    // เรียก API สร้างใบเสร็จ
    const res = await fetch('/api/receipt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
      },
      body: JSON.stringify(payload)
    });
  
    const js = await res.json();
    if (!js.success) throw new Error(js.error || js.message);
  
    // เก็บข้อมูลใบเสร็จ
    window.currentInvoiceId = js.data._id;
    window.currentInvoiceNumber = js.data.invoiceNumber;
  
    showToast('สร้างใบเสร็จผ่อนหมดรับของสำเร็จ', 'success');
  
    // ไป step 3 (เสร็จสิ้น)
    goToStep(3);
  
  } catch (err) {
    console.error('Error:', err);
    showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
  }
});



      // เมื่อกด "ยืนยัน" ใน modal ค่อยไป STEP3
      // Removed event listener for confirmPrintPrompt

      // สรุปในท้าย renderStep4Summary:
      // Removed totalDocFee, subTotal, grandTotal calculation as it's not used in this flow

      // ปุ่มพิมพ์ PDF
      // Removed event listener for btnPrintPdf (related to quotation)

      // ปุ่มยืนยัน (กลับหน้าแรก)
      // Removed event listener for btnConfirmFinish


      // Removed fetchNextQuotationNumber() function





      // ผูกปุ่มดาวน์โหลดหลัง DOM โหลดเสร็จ
      // Removed event listener for btnDownloadPdf (related to quotation)


      // ผูกปุ่มกับฟังก์ชันใหม่
      // Removed event listener for btnDownloadPdf (related to quotation)

  



      // 4) ผูก Event ค้นหา
      document.getElementById('btnProductSearch')?.addEventListener('click', searchItems);
      document.getElementById('btnProductReset')?.addEventListener('click', resetSearch);

      // 5) กล้อง + ลายเซ็น
      setupIDCamera();
      setupSelfieCamera();
      setupSignaturePad();
      setupEmployeeSignaturePad();

      // 6) อัพโหลดสลิปเงินเดือน
      const incomeProofInput = document.getElementById('incomeProof');
      if (incomeProofInput) {
        incomeProofInput.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (file) {
            try {
              const url = await uploadFile(file, '/api/upload/income-proof', 'file', file.name);
              document.getElementById('salarySlipUrl').value = url;
              showToast('อัพโหลดสลิปเงินเดือนเรียบร้อย', 'success');
            } catch (err) {
              console.error('Upload income proof failed:', err);
              showToast('อัพโหลดสลิปเงินเดือนไม่สำเร็จ: ' + err.message, 'error');
            }
          }
        });
      }
      // ปุ่ม Back ใน Level2/3
      document.getElementById('btnBackToLevel1')?.addEventListener('click', () => {
        document.getElementById('level1Container').classList.remove('hidden');
        document.getElementById('level2Container').classList.add('hidden');
        document.getElementById('level3Container').classList.add('hidden');
      });
      document.getElementById('btnBackToLevel2')?.addEventListener('click', () => {
        document.getElementById('level2Container').classList.remove('hidden');
        document.getElementById('level3Container').classList.add('hidden');
      });

      // ปุ่ม manual
      // Removed event listener for btnConfirmManual



      // ——— เพิ่มตรงนี้ ———
      // ผูก event ให้คำนวณใหม่เมื่อผู้ใช้แก้ไขยอดดาวน์/เครดิต
      // Removed event listeners for manualDownInput and manualCreditInput
      // Removed call to calculateManualPlan()
      // ————————————

      // 1) ให้ปุ่ม Step2 เปิด modal แทนเดิม
      // Removed event listener for btnStep2OpenModal (related to printPromptModal)



      // — ADD these inside DOMContentLoaded, after signaturePad & empPad are set up —
      // Removed event listeners for btnSaveSignature and btnSaveEmpSignature

      // Define updateStep2Summary function early to avoid reference errors
      function updateStep2Summary() {
        let totalPrice = 0;
        let totalVAT = 0;

        cartItems.forEach(item => {
          // ใช้เครดิตแทนราคาเต็ม ถ้ามี
          const itemPrice = item.creditThreshold > 0 ? item.creditThreshold : item.pricePayOff;
          totalPrice += itemPrice;
  
          // คำนวณ VAT 7% (ถ้าไม่มี taxRate ให้ใช้ 7% เป็นค่าเริ่มต้น)
          const rate = (item.taxRate || 7) / 100;
          const taxType = item.taxType || 'รวมภาษี';
  
          if (taxType === 'แยกภาษี') {
            // ราคาสินค้า + VAT
            totalVAT += itemPrice * rate;
          } else {
            // ราคาสินค้ารวม VAT แล้ว ต้องแยก VAT ออกมา
            totalVAT += itemPrice - (itemPrice / (1 + rate));
          }
        });

        const shipping = parseFloat(document.getElementById('shippingFee')?.value || 0);
        const discount = parseFloat(document.getElementById('step2Discount')?.value || 0);
  
        // คำนวณยอดสุทธิ
        const subtotal = totalPrice;
        const afterDiscount = subtotal - discount;
        const netTotal = afterDiscount + shipping;
  
        // ถ้าราคาสินค้ารวม VAT แล้ว ยอดรวมคือ netTotal
        // ถ้าราคาสินค้าแยก VAT ยอดรวมคือ netTotal + totalVAT
        let grandTotal = netTotal;
        let vatDisplay = totalVAT;
  
        // ตรวจสอบว่าเป็นราคารวม VAT หรือแยก VAT
        const isInclusiveVAT = cartItems.every(item => !item.taxType || item.taxType === 'รวมภาษี');
  
        if (!isInclusiveVAT) {
          // ถ้าเป็นราคาแยก VAT ต้องบวก VAT เข้าไป
          grandTotal = netTotal + totalVAT;
        }

        const lines = [
          `<div class="flex justify-between"><span>ยอดสินค้า:</span><span>฿${subtotal.toLocaleString()}</span></div>`,
          discount > 0 ? `<div class="flex justify-between text-green-600"><span>ส่วนลด:</span><span>-฿${discount.toLocaleString()}</span></div>` : '',
          shipping > 0 ? `<div class="flex justify-between"><span>ค่าจัดส่ง:</span><span>฿${shipping.toLocaleString()}</span></div>` : '',
          `<div class="flex justify-between"><span>ยอดสุทธิ:</span><span>฿${netTotal.toLocaleString()}</span></div>`,
          `<div class="flex justify-between text-sm text-gray-600"><span>VAT 7% ${isInclusiveVAT ? '(รวมในราคาแล้ว)' : ''}:</span><span>฿${vatDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`,
          `<hr class="my-2 border-gray-300">`,
          `<div class="flex justify-between font-bold text-lg"><span>ยอดรวมทั้งสิ้น:</span><span class="text-blue-600">฿${grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></div>`
        ].filter(line => line); // กรอง line ที่ว่างออก

        const el = document.querySelector('#step2 .cart-summary');
        if (el) {
          el.innerHTML = lines.join('');
        }
      }

      // --- จัดการช่องทางรับสินค้า และสรุปยอดใน STEP2 ---
      const step2SummaryEl = document.querySelector('#step2 .cart-summary');
      const pickupRadios = document.querySelectorAll('input[name="pickupMethod"]');
      const shippingFeeContainer = document.getElementById('shippingFeeContainer');
      const shippingFeeInput = document.getElementById('shippingFee');
      const documentFeeInput = document.getElementById('documentFee');

      // Add event listeners for step2 summary updates after DOM is ready
      const step2DiscountEl = document.getElementById('step2Discount');
      if (step2DiscountEl) {
        step2DiscountEl.addEventListener('input', updateStep2Summary);
      }
  
      pickupRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          const shippingContainer = document.getElementById('shippingFeeContainer');
          if (this.value === 'online') {
            shippingContainer?.classList.remove('hidden');
          } else {
            shippingContainer?.classList.add('hidden');
            const shippingInput = document.getElementById('shippingFee');
            if (shippingInput) {
              shippingInput.value = '0';
            }
          }
          updateStep2Summary();
        });
      });

      // Add event listener for shipping fee input
      if (shippingFeeInput) {
        shippingFeeInput.addEventListener('input', updateStep2Summary);
      }

    });
  </script>
  
  <!-- Display Fixes Script -->
  <script>
    // 1. แก้ไข CSS สำหรับ step-content
    const fixStepContentCSS = () => {
      // ลบ CSS rule ที่ทำให้ step4 มี background แปลกๆ
      const style = document.createElement('style');
      style.textContent = `
        /* Reset step content styles */
        .step-content {
          display: none;
          background-color: transparent !important;
        }
        
        .step-content.active {
          display: block !important;
          min-height: auto;
        }
        
        /* ปรับ main content ให้ responsive */
        #mainContent {
          transition: margin-left 0.3s ease-in-out;
        }
        
        /* เมื่อ sidebar ถูกซ่อน */
        #mainContent.sidebar-collapsed {
          margin-left: 0 !important;
        }
        
        /* ลบพื้นที่สีเทาที่ไม่ต้องการ */
        main {
          background-color: transparent !important;
          min-height: calc(100vh - 80px); /* ลบความสูงของ header */
        }
        
        /* ปรับ card container */
        .card {
          background-color: #ffffff;
          border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dark .card {
          background-color: #2a2a2a;
          border-color: #555;
        }
      `;
      document.head.appendChild(style);
    };

    // 2. แก้ไขฟังก์ชัน toggleMenu ให้จัดการ margin ของ mainContent
    function fixToggleMenu() {
      const toggleMenu = () => {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const icon = document.querySelector('#btnToggleMenu i');
    
        sidebar.classList.toggle('-translate-x-full');
        mainContent.classList.toggle('ml-64');
        mainContent.classList.toggle('ml-0');
        icon.classList.toggle('bi-chevron-left');
        icon.classList.toggle('bi-chevron-right');
      };
    
      // แทนที่ event listener เดิม
      const btnToggle = document.getElementById('btnToggleMenu');
      if (btnToggle) {
        btnToggle.removeEventListener('click', window.toggleMenu);
        btnToggle.addEventListener('click', toggleMenu);
        window.toggleMenu = toggleMenu;
      }
    }

    // 3. แก้ไขการ restore sidebar state
    function fixSidebarRestore() {
      const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const icon = document.querySelector('#btnToggleMenu i');
    
      // ตรวจสอบว่า elements มีอยู่จริงก่อนจะแก้ไข
      if (!sidebar || !mainContent) {
        console.warn('Sidebar or mainContent element not found, skipping restore');
        return;
      }
    
      if (sidebarCollapsed) {
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.add('sidebar-collapsed');
        mainContent.style.marginLeft = '0';
        if (icon) {
          icon.classList.replace('bi-chevron-left', 'bi-chevron-right');
        }
      } else {
        sidebar.classList.remove('-translate-x-full');
        mainContent.classList.remove('sidebar-collapsed');
        mainContent.style.marginLeft = '14rem';
        if (icon) {
          icon.classList.replace('bi-chevron-right', 'bi-chevron-left');
        }
      }
    }

    // 4. ฟังก์ชันตรวจสอบและแก้ไขการแสดงผลของ containers
    function fixContainerDisplay() {
      // ตรวจสอบว่า step content ที่ active แสดงผลถูกต้อง
      const activeStep = document.querySelector('.step-content.active');
      if (!activeStep) {
        // ถ้าไม่มี active step ให้เซ็ตเป็น step 1
        const step1 = document.getElementById('step1');
        if (step1) {
          step1.classList.add('active');
        }
      }
    
      // ตรวจสอบ level containers
      const level1Container = document.getElementById('level1Container');
      const level2Container = document.getElementById('level2Container');
      const level3Container = document.getElementById('level3Container');
      const imeiResultContainer = document.getElementById('imeiResultContainer');
    
      // ซ่อน containers ที่ไม่ควรแสดง
      if (level2Container && !level2Container.querySelector('#level2Grid').children.length) {
        level2Container.classList.add('hidden');
      }
      if (level3Container && !level3Container.querySelector('#level3Grid').children.length) {
        level3Container.classList.add('hidden');
      }
      if (imeiResultContainer && !imeiResultContainer.querySelector('#imeiResultGrid').children.length) {
        imeiResultContainer.classList.add('hidden');
      }
    }

    // 5. ฟังก์ชันหลักสำหรับแก้ไขทั้งหมด
    function applyFixes() {
      // 1. แก้ไข CSS
      fixStepContentCSS();
    
      // 2. แก้ไข toggle menu
      fixToggleMenu();
    
      // 3. Restore sidebar state อย่างถูกต้อง
      fixSidebarRestore();
    
      // 4. แก้ไขการแสดงผล containers
      fixContainerDisplay();
    
      // 5. ลบ background สีเทาที่อาจติดมาจาก CSS เก่า
      const main = document.querySelector('main');
      if (main) {
        main.style.backgroundColor = 'transparent';
        main.style.minHeight = 'calc(100vh - 80px)';
      }
    
      console.log('✅ Applied all display fixes');
    }

    // เรียกใช้งานเมื่อ DOM โหลดเสร็จ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyFixes);
    } else {
      applyFixes();
    }

    // Export สำหรับใช้งาน
    window.applyInstallmentFixes = applyFixes;
  </script>

  <!-- Customer Search & Card Reader Script -->
  <script>
    // ตัวแปรสำหรับการค้นหาลูกค้า
    let isSearching = false;
    let lastSearchTime = 0;
    const searchCooldown = 3000; // 3 วินาที

    // ฟังก์ชันค้นหาลูกค้าเก่า
    async function searchExistingCustomer() {
      const searchValue = document.getElementById('customerSearch').value.trim();
      const resultsContainer = document.getElementById('customerSearchResults');
      const resultsList = document.getElementById('customerResultsList');
    
      if (!searchValue) {
        if (typeof showToast === 'function') {
          showToast('กรุณากรอกเลขบัตรประชาชน', 'warning');
        } else {
          alert('กรุณากรอกเลขบัตรประชาชน');
        }
        return;
      }

      // ตรวจสอบรูปแบบเลขบัตรประชาชน (13 หลัก)
      if (!/^[0-9]{13}$/.test(searchValue)) {
        if (typeof showToast === 'function') {
          showToast('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก', 'warning');
        } else {
          alert('เลขบัตรประชาชนต้องเป็นตัวเลข 13 หลัก');
        }
        return;
      }

      // Rate limiting
      const now = Date.now();
      if (isSearching) {
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาอยู่ กรุณารอสักครู่', 'info');
        }
        return;
      }

      if (now - lastSearchTime < searchCooldown) {
        const remaining = Math.ceil((searchCooldown - (now - lastSearchTime)) / 1000);
        if (typeof showToast === 'function') {
          showToast(`กรุณารอ ${remaining} วินาที ก่อนค้นหาใหม่`, 'warning');
        }
        return;
      }

      lastSearchTime = now;
      isSearching = true;

      try {
        if (typeof showToast === 'function') {
          showToast('กำลังค้นหาลูกค้า...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/lookup/${searchValue}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        // ตรวจสอบ status code ก่อน parse JSON
        if (response.status === 429) {
          if (typeof showToast === 'function') {
            showToast('🚫 คำขอเกินขีดจำกัด กรุณารอ 30 วินาที', 'error');
          }
          // เพิ่มเวลา cooldown เมื่อเจอ 429
          lastSearchTime = Date.now() + 27000; // บล็อกเพิ่มอีก 27 วินาที (รวม 30 วินาที)
    
          resultsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
              <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
              <p class="text-sm font-medium">คำขอเกินขีดจำกัด</p>
              <p class="text-xs text-gray-400 mt-1">กรุณารอ 30 วินาที ก่อนค้นหาใหม่</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success && result.data) {
          // เจอลูกค้า - แสดงผลลัพธ์
          displayCustomerSearchResult(result.data);
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('พบข้อมูลลูกค้า', 'success');
          }
        } else {
          // ไม่เจอลูกค้า
          resultsList.innerHTML = `
            <div class="p-4 text-center text-gray-500">
              <i class="bi bi-person-x text-2xl mb-2 block"></i>
              <p class="text-sm">ไม่พบข้อมูลลูกค้าเก่า</p>
              <p class="text-xs text-gray-400">เลขบัตรประชาชน: ${searchValue}</p>
            </div>
          `;
          resultsContainer.classList.remove('hidden');
    
          if (typeof showToast === 'function') {
            showToast('ไม่พบข้อมูลลูกค้าเก่า', 'info');
          }
        }

      } catch (error) {
        console.error('Customer search error:', error);
    
        let errorMessage = 'เกิดข้อผิดพลาดในการค้นหา';
        if (error.message.includes('429')) {
          errorMessage = 'คำขอเกินขีดจำกัด กรุณารอสักครู่';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
        }

        resultsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            <i class="bi bi-exclamation-triangle text-2xl mb-2 block"></i>
            <p class="text-sm font-medium">${errorMessage}</p>
            <p class="text-xs text-gray-400 mt-1">กรุณาลองใหม่อีกครั้ง</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
    
        if (typeof showToast === 'function') {
          showToast(errorMessage, 'error');
        } else {
          alert(errorMessage);
        }
      } finally {
        isSearching = false;
      }
    }

    // แสดงผลลัพธ์การค้นหาลูกค้า
    function displayCustomerSearchResult(customerData) {
      const resultsList = document.getElementById('customerResultsList');
    
      // แสดงข้อมูลลูกค้าที่พบ
      resultsList.innerHTML = `
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
             onclick="selectCustomer('${customerData._id}', '${customerData.contactPhone || ''}')">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-sm">${customerData.displayName || 'ไม่ระบุชื่อ'}</h4>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                <i class="bi bi-credit-card mr-1"></i>
                บัตรประชาชน: ${customerData.contactPhone || 'ไม่ระบุ'}
              </p>
              <p class="text-xs text-gray-600 dark:text-gray-400">
                <i class="bi bi-telephone mr-1"></i>
                โทร: ${customerData.contactPhone || 'ไม่ระบุ'}
              </p>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge badge-sm ${customerData.isNewCustomer ? 'badge-warning' : 'badge-success'}">
                  ${customerData.isNewCustomer ? 'ลูกค้าใหม่' : 'ลูกค้าเก่า'}
                </span>
                <span class="text-xs text-gray-500">
                  ซื้อมาแล้ว ${customerData.totalPurchases || 0} ครั้ง
                </span>
              </div>
            </div>
            <div class="text-right">
              <button class="btn btn-sm btn-primary">
                <i class="bi bi-check-circle mr-1"></i>
                เลือก
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // เลือกลูกค้าและกรอกข้อมูลลงในฟอร์ม
    async function selectCustomer(customerId, taxId) {
      try {
        if (typeof showToast === 'function') {
          showToast('กำลังโหลดข้อมูลลูกค้า...', 'info');
        }

        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/customer/${customerId}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success && result.data) {
          const customer = result.data;
    
          // กรอกข้อมูลลงในฟอร์ม
          fillCustomerForm(customer);
    
          // ซ่อนผลการค้นหา
          document.getElementById('customerSearchResults').classList.add('hidden');
          document.getElementById('customerSearch').value = '';
    
          if (typeof showToast === 'function') {
            showToast('โหลดข้อมูลลูกค้าเรียบร้อย', 'success');
          }
        } else {
          throw new Error(result.message || 'ไม่สามารถโหลดข้อมูลลูกค้าได้');
        }

      } catch (error) {
        console.error('Select customer error:', error);
        if (typeof showToast === 'function') {
          showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } else {
          alert('เกิดข้อผิดพลาด: ' + error.message);
        }
      }
    }

    // กรอกข้อมูลลูกค้าลงในฟอร์ม
    function fillCustomerForm(customer) {
      if (customer.customerType === 'individual' && customer.individual) {
        const individual = customer.individual;
    
        // ข้อมูลพื้นฐาน
        document.getElementById('customerPrefix').value = individual.prefix || '';
        document.getElementById('customerFirstName').value = individual.firstName || '';
        document.getElementById('customerLastName').value = individual.lastName || '';
        document.getElementById('customerIdCard').value = individual.taxId || individual.idCard || '';
        document.getElementById('customerPhone').value = individual.phone || '';
        document.getElementById('customerEmail').value = individual.email || '';
    
        // ที่อยู่
        if (individual.address) {
          const addr = individual.address;
          document.getElementById('houseNo').value = addr.houseNumber || '';
          document.getElementById('moo').value = addr.village || addr.moo || '';
          document.getElementById('subDistrict').value = addr.subDistrict || addr.tambon || '';
          document.getElementById('district').value = addr.district || addr.amphoe || '';
          document.getElementById('province').value = addr.province || addr.changwat || '';
          document.getElementById('zipcode').value = addr.zipCode || addr.postalCode || '';
        }
      }
    }

    // ฟังก์ชันตัดคำว่า "หมู่ที่", "หมู่", "ตำบล", "อำเภอ", "จังหวัด" ออก (ถ้ามี)
    function removeLocalityPrefix(str) {
      if (!str) return '';
      let result = str.trim();
      result = result.replace(/^หมู่ที่\s*/i, '').replace(/^หมู่\s*/i, '');
      result = result.replace(/^ตำบล\s*/i, '');
      result = result.replace(/^อำเภอ\s*/i, '');
      result = result.replace(/^จังหวัด\s*/i, '');
      return result.trim();
    }

    function removePrefixes(str) {
      if (!str) return '';
      return str.trim();
    }

    // อ่านบัตร ปชช.
    async function readCard() {
      console.log('readCard() ถูกเรียกแล้ว');
      try {
        const resp = await fetch('http://localhost:3999/read-card');
        const js = await resp.json();
        if (!resp.ok || !js.success) {
          if (typeof showToast === 'function') {
            showToast('ไม่สามารถอ่านข้อมูลบัตรได้: ' + (js.error || 'unknown'), 'error');
          } else {
            alert('ไม่สามารถอ่านข้อมูลบัตรได้: ' + (js.error || 'unknown'));
          }
          return;
        }
        const d = js.data;
        document.getElementById('customerPrefix').value = d.TitleTh || '';
        document.getElementById('customerFirstName').value = d.FirstNameTh || '';
        document.getElementById('customerLastName').value = d.LastNameTh || '';
        document.getElementById('customerIdCard').value = d.Citizenid || '';

        const addr = (d.Address || '').split('#').filter((a) => a.trim());
        document.getElementById('houseNo').value = removePrefixes(addr[0] || '');
        document.getElementById('moo').value = removeLocalityPrefix(addr[1] || '');
        document.getElementById('subDistrict').value = removeLocalityPrefix(addr[2] || '');
        document.getElementById('district').value = removeLocalityPrefix(addr[3] || '');
        document.getElementById('province').value = removeLocalityPrefix(addr[4] || '');
        document.getElementById('zipcode').value = removePrefixes(addr[5] || '');

        if (typeof showToast === 'function') {
          showToast('อ่านข้อมูลบัตรสำเร็จ', 'success');
        } else {
          alert('อ่านข้อมูลบัตรสำเร็จ');
        }
      } catch (err) {
        if (typeof showToast === 'function') {
          showToast(`Error: ${err.message}`, 'error');
        } else {
          alert(`Error: ${err.message}`);
        }
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ปุ่มค้นหาลูกค้า
      const btnSearchCustomer = document.getElementById('btnSearchCustomer');
      if (btnSearchCustomer) {
        btnSearchCustomer.addEventListener('click', searchExistingCustomer);
      }

      // ปุ่มอ่านบัตรประชาชน
      const btnReadCard = document.getElementById('btnReadCard');
      if (btnReadCard) {
        btnReadCard.addEventListener('click', readCard);
      }

      // ช่องค้นหาลูกค้า - กด Enter
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchExistingCustomer();
          }
        });

        // ค้นหาอัตโนมัติเมื่อพิมพ์ครบ 13 หลัก
        customerSearch.addEventListener('input', function(e) {
          const value = e.target.value.trim();
          if (value.length === 13 && /^[0-9]{13}$/.test(value)) {
            searchExistingCustomer();
          } else if (value.length < 13) {
            // ซ่อนผลการค้นหาเมื่อพิมพ์ไม่ครบ 13 หลัก
            document.getElementById('customerSearchResults').classList.add('hidden');
          }
        });
      }
    });
  </script>

  <script>
    // Lottie Loading Animation Function
    let lottieAnimation = null;

    function showLoading(message = 'กำลังโหลด...') {
      const overlay = document.getElementById('loadingOverlay');
      const container = document.getElementById('lottieContainer');

      if (overlay && container) {
        overlay.style.display = 'flex';
        overlay.classList.remove('animate__fadeOut');
        overlay.classList.add('animate__fadeIn');

        if (!lottieAnimation && window.lottie) {
          lottieAnimation = window.lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets2.lottiefiles.com/packages/lf20_x62chJ.json'
          });
        }

        if (message) {
          console.log('Loading:', message);
        }
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('animate__fadeIn');
        overlay.classList.add('animate__fadeOut');
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      showLoading('กำลังโหลดผ่อนไปใช้ไป...');

      window.addEventListener('load', function() {
        setTimeout(hideLoading, 1000);
      });
    });

    window.showLoading = showLoading;
    window.hideLoading = hideLoading;
  </script>
</body>