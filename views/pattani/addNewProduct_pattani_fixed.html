<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>คลังสินค้า</title>

  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

  <script src="../../js/activity-tracker.js"></script>
  <script src="/js/branch-navigation.js"></script>
  <script src="/views/pattani/sidebar/sidebar.js"></script>
  
  <!-- Security Headers -->
  <meta name="csrf-token" content="">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
        },
      },
      daisyui: {
        themes: ['light', 'dark', 'corporate'],
      },
    };
  </script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Google Fonts: Prompt -->

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet" />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Sidebar Management -->
  <script>
  </script>

  <style>
    /* Minimal Design System */
    :root {
      /* Colors - Simplified palette */
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      
      /* Neutrals */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      
      /* Border radius */
      --radius: 0.5rem;
      --radius-sm: 0.375rem;
      
      /* Shadows */
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    /* Dark mode */
    [data-theme="dark"] {
      --gray-50: #18181b;
      --gray-100: #27272a;
      --gray-200: #3f3f46;
      --gray-300: #52525b;
      --gray-500: #a1a1aa;
      --gray-700: #e4e4e7;
      --gray-900: #fafafa;
    }

    /* Base Reset */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Prompt', sans-serif;
      color: var(--gray-900);
      background: var(--gray-50);
      margin: 0;
      line-height: 1.5;
    }

    /* Minimal Components */
    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }
    
    [data-theme="dark"] .card {
      background: var(--gray-100);
      border-color: var(--gray-300);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-700);
      border-color: var(--gray-300);
    }

    .btn-ghost:hover:not(:disabled) {
      background: var(--gray-100);
    }

    .btn-danger {
      background: white;
      color: var(--danger);
      border-color: var(--danger);
    }

    .btn-danger:hover:not(:disabled) {
      background: var(--danger);
      color: white;
    }

    /* Button sizes */
    .btn-sm {
      padding: var(--space-1) var(--space-3);
      font-size: 0.75rem;
    }

    .btn-outline {
      background: transparent;
      color: var(--gray-700);
      border-color: var(--gray-300);
    }

    .btn-outline:hover:not(:disabled) {
      background: var(--gray-100);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #0f9d58;
    }

    .btn-error {
      background: var(--danger);
      color: white;
    }

    .btn-error:hover:not(:disabled) {
      background: #dc2626;
    }

    .input {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      font-size: 0.875rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      background: white;
      transition: border-color 0.15s;
    }

    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    [data-theme="dark"] .input {
      background: var(--gray-100);
      border-color: var(--gray-300);
      color: var(--gray-900);
    }

    .input-bordered {
      border: 1px solid var(--gray-300);
    }

    .input-sm {
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
    }

    /* Tables */
    .table {
      width: 100%;
      font-size: 0.875rem;
      border-collapse: collapse;
    }

    .table th {
      padding: var(--space-3);
      text-align: left;
      font-weight: 500;
      color: var(--gray-500);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    .table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--gray-100);
    }

    [data-theme="dark"] .table th {
      background: var(--gray-200);
      border-color: var(--gray-300);
    }

    [data-theme="dark"] .table td {
      border-color: var(--gray-200);
    }

    .table-zebra tbody tr:nth-child(odd) {
      background: var(--gray-50);
    }

    [data-theme="dark"] .table-zebra tbody tr:nth-child(odd) {
      background: var(--gray-200);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 9999px;
    }

    .badge-info {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge-error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    /* Layout */
    #mainContent {
      transition: margin-left 0.3s;
      margin-left: 14rem;
      min-height: 100vh;
      background: var(--gray-50);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* Tab styles */
    .tab-button {
      background: transparent;
      color: var(--gray-500);
      border: none;
      position: relative;
    }
    
    .tab-button:hover {
      color: var(--gray-700);
      background: var(--gray-100);
    }
    
    .tab-button.tab-active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow-sm);
    }
    
    [data-theme="dark"] .tab-button {
      color: var(--gray-500);
    }
    
    [data-theme="dark"] .tab-button:hover {
      color: var(--gray-300);
      background: var(--gray-200);
    }
    
    [data-theme="dark"] .tab-button.tab-active {
      background: var(--gray-100);
      color: var(--primary);
    }

    /* Animations */
    .animate-in {
      animation: fadeIn 0.3s ease-out;
    }

    .animate-out {
      animation: fadeOut 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Loading overlay */
        [data-theme="dark"]     #loadingOverlay .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid var(--gray-300);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Checkbox styles */
    .checkbox {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
    }

    .checkbox-sm {
      width: 0.875rem;
      height: 0.875rem;
    }

    /* Form controls */
    .form-control {
      margin-bottom: var(--space-4);
    }

    .label {
      display: block;
      margin-bottom: var(--space-1);
    }

    .label-text {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    [data-theme="dark"] .label-text {
      color: var(--gray-300);
    }

    /* Alert */
    .alert {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-4);
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .alert-info {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .modal-toggle:checked + .modal {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }

    .modal-box {
      background: white;
      padding: var(--space-6);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 32rem;
      width: 91.666667%;
      max-height: calc(100vh - 5em);
      overflow-y: auto;
    }

    [data-theme="dark"] .modal-box {
      background: var(--gray-100);
    }

    .modal-action {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    /* Utility classes */
    .text-primary {
      color: var(--primary);
    }

    .text-success {
      color: var(--success);
    }

    .text-error {
      color: var(--danger);
    }

    .text-warning {
      color: var(--warning);
    }

    .editable-imei {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    .editable-imei:hover {
      text-decoration-style: solid;
    }

    /* Toast notification */
    .toast-notification {
      min-width: 250px;
      max-width: 400px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #mainContent {
        margin-left: 0;
      }
      
      .btn span:not(.badge) {
        display: none;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
      }
    }
  </style>

  <!-- Loading System -->
  <link rel="stylesheet" href="/css/loading-components.css">
  <script src="/js/loading-system.js"></script>

</head>

<body class="flex flex-col min-h-screen">
    </div>
  
  <!-- Sidebar Container -->
  <div id="sidebarContainer"></div>

  <div class="flex min-h-screen">
    <!-- Main Content -->
    <div class="flex-1 flex flex-col ml-56" id="mainContent">
      <!-- Header -->
      <header class="p-4 bg-white dark:bg-gray-800"
                       border-b border-gray-200 dark:border-gray-700"
                       flex items-center justify-between"
                       id="mainHeader">
        <div>
          <h1 class="text-lg font-semibold" id="pageTitle">คลังสินค้า</h1>
          <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
            กำลังโหลดสาขา...
          </p>
        </div>
      </header>

      <!-- Branch Selection & Barcode Scanner -->
      <div class="card animate-in mb-6 p-6">
        <div class="section-header">
          <h2 class="section-title">
            <i class="bi bi-building text-primary"></i>
            เลือกสาขา &amp; สแกนบาร์โค้ด
          </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Branch Select -->
          <div>
            <label for="branchSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              สาขา
            </label>
            <select id="branchSelect" class="input" disabled>
              <option value="">กำลังโหลด...</option>
            </select>
          </div>
          
          <!-- Manual Barcode Entry -->
          <div>
            <label for="manualBarcode" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              กรอกเลขบาร์โค้ด
            </label>
            <div class="flex gap-2">
              <input 
                type="text" 
                id="manualBarcode" 
                class="input flex-1" 
                placeholder="พิมพ์เลขบาร์โค้ด..." 
              />
              <button id="btnAddManualCode" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                <span class="hidden sm:inline">เพิ่ม</span>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              <i class="bi bi-info-circle"></i> เมื่อกดเพิ่ม สินค้าจะเข้าสู่รายการ "รออนุมัติ" ทันที
            </p>
          </div>
          
          <!-- Scan Button -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              สแกนอัตโนมัติ
            </label>
            <button id="btnScanBarcode" class="btn btn-primary w-full">
              <i class="bi bi-upc-scan"></i>
              สแกนบาร์โค้ด
            </button>
            <p class="text-xs text-gray-500 mt-1">
              <i class="bi bi-info-circle"></i> สแกนเพื่อเพิ่มสินค้าเข้ารายการ "รออนุมัติ"
            </p>
          </div>
        </div>
        
        <!-- Scan status indicator -->
        <div id="scanStatus" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg hidden">
          <div class="flex items-center gap-2 text-sm">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span class="text-blue-700 dark:text-blue-300">กำลังรอการสแกนบาร์โค้ด... (สินค้าจะเข้าสู่รายการรออนุมัติทันที)</span>
          </div>
        </div>
      </div>

      <!-- Stock List -->
      <div class="card animate-in p-6">
        <div class="section-header mb-6">
          <h2 class="section-title">
            <i class="bi bi-box-seam text-primary"></i>
            รายการสต๊อก
            <span class="badge badge-info">
              <span id="stockCount">0</span> รายการ
            </span>
          </h2>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex gap-1 p-1 bg-gray-100 dark:bg-gray-700 rounded-lg mb-6">
          <button 
            class="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all duration-200 tab-button tab-active"
            id="tab-unverified" 
            onclick="switchTab('unverified')"'
          >
            <i class="bi bi-clock-history"></i>
            <span>รออนุมัติ</span>
            <span class="badge badge-warning" id="unverifiedCount">0</span>
          </button>
          <button 
            class="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-all duration-200 tab-button"
            id="tab-verified" 
            onclick="switchTab('verified')"'
          >
            <i class="bi bi-check-circle"></i>
            <span>อนุมัติแล้ว</span>
            <span class="badge badge-success" id="verifiedCount">0</span>
          </button>
        </div>
        
        <!-- Tab Content: รออนุมัติ -->
        <div id="content-unverified">
          <!-- คำอธิบาย Workflow -->
          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle-fill"></i>
            <span>
              <strong>ขั้นตอนการทำงาน:</strong>
              <ol class="ml-4 mt-1 text-sm">
                <li>1. Scan/กรอกบาร์โค้ด → สินค้าจะเข้าสู่รายการ "รออนุมัติ" ทันที</li>
                <li>2. เลือกสินค้าที่ต้องการส่งไปยังฝ่ายสต็อก</li>
                <li>3. กด "ส่งไปยังฝ่ายสต็อก" เพื่อส่งสินค้าที่เลือก</li>
                <li>4. ฝ่ายสต็อกจะเห็นสินค้าในหน้า "ตรวจสินค้า/อนุมัติ"</li>
              </ol>
              <div class="mt-2 text-xs text-blue-600">
                <i class="bi bi-lightbulb"></i> 
                <strong>หมายเหตุ:</strong> รายการ "รออนุมัติ" จะแสดงสินค้าทั้งหมดที่ยังไม่ได้ส่งไปยังฝ่ายสต็อก รวมถึงสินค้าที่ backend ตั้งสถานะ pending อัตโนมัติ
              </div>
            </span>
          </div>
          
          <!-- เพิ่มปุ่มส่งไปยังฝ่ายสต็อก -->
          <div class="flex justify-between items-center mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="flex gap-3">
              <button id="btnSelectAll" class="btn btn-primary btn-sm">
                <i class="bi bi-check2-all"></i> เลือกทั้งหมด
              </button>
              <button id="btnDeselectAll" class="btn btn-outline btn-sm">
                <i class="bi bi-x-lg"></i> ยกเลิกเลือกทั้งหมด
              </button>
              <button id="btnManualReload" class="btn btn-warning btn-sm" onclick="window.forceReloadStock()">
                <i class="bi bi-arrow-clockwise"></i> รีเฟรช
              </button>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-600 dark:text-gray-400">
                เลือกแล้ว: <span class="font-bold text-primary-600" id="selectedCount">0</span> รายการ
              </span>
              <button id="btnSendToStock" class="btn btn-success">
                <i class="bi bi-send-fill"></i> ส่งไปยังฝ่ายสต็อก
              </button>
            </div>
          </div>
          
          <div id="stockContainer">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Tab Content: อนุมัติแล้ว -->
        <div id="content-verified" class="hidden">
          <!-- Filter ช่วงวันที่ -->
          <div class="flex gap-4 mb-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text">วันที่เริ่มต้น</span>
              </label>
              <input type="date" id="dateFrom" class="input input-bordered" />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text">วันที่สิ้นสุด</span>
              </label>
              <input type="date" id="dateTo" class="input input-bordered" />
            </div>
            <div class="form-control">
              <label class="label">
                <span class="label-text">&nbsp;</span>
              </label>
              <button class="btn btn-primary" onclick="loadVerifiedHistory()">
                <i class="bi bi-search"></i> ค้นหา
              </button>
            </div>
          </div>
          
          <div id="verifiedContainer">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4 text-center">
    <small>© 2025 บริษัท 2 พี่น้อง โมบาย จำกัด. สงวนลิขสิทธิ์.</small>
  </footer>

  <!-- Modals -->
  <input type="checkbox" id="confirmActionModal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">ยืนยันการกระทำ</h3>
      <p class="py-4" id="confirmActionText">ข้อความที่นี่</p>
      <div class="modal-action">
        <label for="confirmActionModal" class="btn btn-secondary" id="cancelActionBtn">ยกเลิก</label>
        <label for="confirmActionModal" class="btn btn-primary" id="okActionBtn">ตกลง</label>
      </div>
    </div>
  </div>

  <!-- Hidden barcode input -->
  <input type="text" id="barcodeInput" autofocus lang="en" inputmode="latin" autocomplete="off" autocorrect="off" autocapitalize="off" style="ime-mode: disabled; display:none;" />

        <p class="text-sm font-medium" id="loadingText">กำลังประมวลผล...</p>
    </div>
  </div>

  <!-- Barcode Modal -->
  <!-- Modal นี้ไม่ใช้แล้ว เนื่องจากสินค้าจะถูกเพิ่มเข้ารายการรออนุมัติทันที
  <input type="checkbox" id="barcodeModalToggle" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-lg" id="barcodeModalLabel">
        <i class="bi bi-box-seam"></i> รายการบาร์โค้ดที่สแกน (ขั้นตอนที่ 1)
      </h3>
      <div class="mt-4">
        <div class="mb-3">
          <label for="scannedCodeModal" class="block mb-1 font-semibold">เลขบาร์โค้ดล่าสุด</label>
          <input type="text" class="input input-bordered w-full" id="scannedCodeModal" readonly>
        </div>
        <div class="overflow-x-auto">
          <table class="table w-full">
            <thead>
              <tr>
                <th>บาร์โค้ด</th>
                <th>รายละเอียดสินค้า</th>
                <th>IMEI</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="scannedProductsTable">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-action">
        <button class="btn btn-secondary" id="cancelManualEntry">ยกเลิก</button>
        <button class="btn btn-primary" id="confirmManualEntry">
          <i class="bi bi-send-fill"></i> ส่งไปยังฝ่ายสต็อก (ขั้นที่ 1)
        </button>
      </div>
    </div>
  </div>
  -->

  <script>
    // URL Parameters and Constants
    const urlParams = new URLSearchParams(window.location.search);
    let BRANCH_CODE = urlParams.get("branch") || localStorage.getItem('activeBranch');

    if (!BRANCH_CODE) {
      console.warn("Branch not found in URL or localStorage, defaulting to 'PATTANI'");
      BRANCH_CODE = 'PATTANI';
    }
    window.currentBranchCode = BRANCH_CODE;
    console.log(`[addNewProduct] Using branch code: ${BRANCH_CODE}`);
    
    // Initialize Sidebar Component
    let sidebar;
    
    // ==================== LOGGING SYSTEM ====================
    
    const Logger = {
      levels: {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3
      },
      currentLevel: 1, // Default to INFO in production
      
      log: function(level, message, data = null) {
        if (level < this.currentLevel) return;
        
        const timestamp = new Date().toISOString();
        const levelName = Object.keys(this.levels).find(key => this.levels[key] === level);
        
        const logEntry = {
          timestamp,
          level: levelName,
          message,
          data,
          url: window.location.href,
          userAgent: navigator.userAgent
        };
        
        // Console output
        if (level === this.levels.ERROR) {
          console.error(`[${levelName}] ${message}`, data);
        } else if (level === this.levels.WARN) {
          console.warn(`[${levelName}] ${message}`, data);
        } else if (window.location.hostname === 'localhost' || this.currentLevel === 0) {
          console.log(`[${levelName}] ${message}`, data);
        }
        
        // Store in localStorage for debugging
        if (level >= this.levels.WARN) {
          this.storeLog(logEntry);
        }
      },
      
      storeLog: function(logEntry) {
        try {
          const logs = JSON.parse(localStorage.getItem('appLogs') || '[]');
          logs.push(logEntry);
          // Keep only last 100 logs
          localStorage.setItem('appLogs', JSON.stringify(logs.slice(-100)));
        } catch (e) {
          // Ignore storage errors
        }
      },
      
      debug: function(message, data) {
        this.log(this.levels.DEBUG, message, data);
      },
      
      info: function(message, data) {
        this.log(this.levels.INFO, message, data);
      },
      
      warn: function(message, data) {
        this.log(this.levels.WARN, message, data);
      },
      
      error: function(message, data) {
        this.log(this.levels.ERROR, message, data);
      },
      
      setLevel: function(level) {
        this.currentLevel = this.levels[level] || this.levels.INFO;
      },
      
      getLogs: function() {
        return JSON.parse(localStorage.getItem('appLogs') || '[]');
      },
      
      clearLogs: function() {
        localStorage.removeItem('appLogs');
      }
    };
    
    // Set debug level for development - REMOVED a problematic check
    // This will default Logger level to INFO
    
    // ==================== END LOGGING SYSTEM ====================

    // Socket.IO initialization
    const socket = io();
    socket.on('connect', () => {
      Logger.info("เชื่อมต่อ realtime สำเร็จ");
    });
    socket.on('stockUpdate', () => {
      Logger.debug("ได้รับสัญญาณ update สต๊อกแบบ realtime");
      loadStock();
    });
    socket.on('branchStockUpdated', () => {
      Logger.debug("ได้รับสัญญาณ branchStock updated");
      loadStock();
    });

    // Global variables
    let scannedProducts = [];
    let allProductImages = [];
    let pendingAction = null;
    let selectedStocks = new Set();
    let defaultSupplier = null;

    // Socket listeners
    socket.on('branchstockCreated', () => {
      Logger.debug("ได้รับสัญญาณ branchStock created");
      loadStock();
    });
    
    socket.on('branchstockDeleted', () => {
      Logger.debug("ได้รับสัญญาณ branchStock deleted");
      loadStock();
    });

    // ==================== SECURITY & VALIDATION ====================
    
    // CSRF Token generation and management
    function generateCSRFToken() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      const token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      localStorage.setItem('csrfToken', token);
      document.querySelector('meta[name="csrf-token"]').content = token;
      return token;
    }
    
    // Initialize CSRF token on page load
    if (!localStorage.getItem('csrfToken')) {
      generateCSRFToken();
    }
    
    // Input validation functions
    const ValidationRules = {
      barcode: {
        pattern: /^.+$/, // ยอมรับทุกอักขระอย่างน้อย 1 ตัว
        message: 'กรุณากรอกบาร์โค้ด'
      },
      imei: {
        pattern: /^[0-9]{15,17}$/,
        message: 'IMEI ต้องเป็นตัวเลข 15-17 หลัก'
      },
      luhnCheck: function(imei) {
        // Luhn algorithm for IMEI validation (supports 15-17 digits)
        if (imei.length === 17) {
          // For 17-digit IMEI, check digit is already included
          imei = imei.slice(0, 16);
        }
        
        let sum = 0;
        let isEven = false;
        for (let i = imei.length - 1; i >= 0; i--) {
          let digit = parseInt(imei[i]);
          if (isEven) {
            digit *= 2;
            if (digit > 9) digit -= 9;
          }
          sum += digit;
          isEven = !isEven;
        }
        
        // For 15-digit IMEI
        if (imei.length === 15) {
          return sum % 10 === 0;
        }
        
        // For 16-digit IMEI (IMEISV)
        if (imei.length === 16) {
          // IMEISV doesn't use Luhn check'
          return true;
        }
        
        return false;
      }
    };

    // Validate barcode format
    function validateBarcode(barcode) {
      if (!barcode) return { valid: false, message: 'กรุณากรอกบาร์โค้ด' };
      
      barcode = barcode.trim();
      
      // ตรวจสอบความยาวขั้นต่ำ
      if (barcode.length < 1) {
        return { valid: false, message: 'บาร์โค้ดต้องมีอย่างน้อย 1 ตัวอักษร' };
      }
      
      // ไม่จำกัดประเภทหรือความยาวของบาร์โค้ด
      return { valid: true };
    }

    // Enhanced IMEI validation with all formats
    function validateIMEI(imei) {
      if (!imei) return { valid: false, message: 'กรุณากรอก IMEI' };
      
      imei = imei.trim();
      if (!ValidationRules.imei.pattern.test(imei)) {
        return { valid: false, message: ValidationRules.imei.message };
      }
      
      // Luhn algorithm check for IMEI (not IMEISV)
      if ((imei.length === 15 || imei.length === 17) && !ValidationRules.luhnCheck(imei)) {
        return { valid: false, message: 'IMEI ไม่ถูกต้องตาม Luhn algorithm' };
      }
      
      return { valid: true };
    }

    // Sanitize HTML to prevent XSS
    function sanitizeHTML(str) {
      if (!str) return '';
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    // Enhanced Rate limiting with different limits per action
    const RateLimiter = {
      attempts: {},
      limits: {
        'scan_barcode': { max: 20, window: 60000 },      // 20 per minute'
        'manual_barcode': { max: 10, window: 60000 },    // 10 per minute'
        'api_call': { max: 30, window: 60000 },          // 30 per minute'
        'delete_action': { max: 5, window: 60000 },      // 5 per minute'
        'update_action': { max: 15, window: 60000 }      // 15 per minute'
      },
      
      check: function(action) {
        const now = Date.now();
        const userId = localStorage.getItem('userId') || 'anonymous'
        const key = `${action}_${userId}`;
        const limit = this.limits[action] || { max: 30, window: 60000 };
        
        if (!this.attempts[key]) {
          this.attempts[key] = { count: 0, resetTime: now + limit.window };
        }
        
        if (now > this.attempts[key].resetTime) {
          this.attempts[key] = { count: 0, resetTime: now + limit.window };
        }
        
        if (this.attempts[key].count >= limit.max) {
          const waitTime = Math.ceil((this.attempts[key].resetTime - now) / 1000);
          showToast(`คุณทำรายการเร็วเกินไป กรุณารอ ${waitTime} วินาที`, 'warning');
          
          // Log rate limit exceeded
          createAuditLog('RATE_LIMIT_EXCEEDED', {'
            action: action,
            userId: userId,
            attempts: this.attempts[key].count,
            resetTime: new Date(this.attempts[key].resetTime).toISOString()
          });
          
          return false;
        }
        
        this.attempts[key].count++;
        return true;
      },
      
      reset: function(action) {
        const userId = localStorage.getItem('userId') || 'anonymous'
        const key = `${action}_${userId}`;
        delete this.attempts[key];
      }
    };

    // Enhanced Session timeout management
    let sessionTimeout;
    let warningTimeout;
    let lastActivity = Date.now();
    const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 minutes
    const WARNING_TIME = 2 * 60 * 1000;     // Warning at 2 minutes before timeout

    function resetSessionTimeout() {
      lastActivity = Date.now();
      clearTimeout(sessionTimeout);
      clearTimeout(warningTimeout);
      
      // Set warning timeout
      warningTimeout = setTimeout(() => {
        showToast('เซสชันจะหมดอายุใน 2 นาที กรุณาบันทึกข้อมูล', 'warning');
      }, SESSION_TIMEOUT - WARNING_TIME);
      
      // Set session timeout
      sessionTimeout = setTimeout(() => {
        showToast('เซสชันหมดอายุ กำลังออกจากระบบ...', 'error');
        createAuditLog('SESSION_TIMEOUT', {'
          lastActivity: new Date(lastActivity).toISOString(),
          sessionDuration: Date.now() - lastActivity
        });
        setTimeout(() => {
          logout();
        }, 2000);
      }, SESSION_TIMEOUT);
    }

    // Logout function
    async function logout() {
      try {
        // Create audit log before logout
        await createAuditLog('USER_LOGOUT', {'
          logoutType: 'manual','
          sessionDuration: Date.now() - lastActivity
        });
        
        // Clear all sensitive data
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('csrfToken');
        localStorage.removeItem('branchCode');
        
        // Clear session storage
        sessionStorage.clear();
        
        // Disconnect socket
        if (socket && socket.connected) {
          socket.disconnect();
        }
        
        // Redirect to login
        window.location.href = '/login'
      } catch (err) {
        console.error('Logout error:', err);
        // Force redirect even if audit log fails
        window.location.href = '/login'
      }
    }

    // Track user activity with debounce
    let activityDebounce;
    function trackActivity() {
      clearTimeout(activityDebounce);
      activityDebounce = setTimeout(() => {
        resetSessionTimeout();
      }, 1000);
    }

    document.addEventListener('click', trackActivity);
    document.addEventListener('keypress', trackActivity);
    document.addEventListener('mousemove', trackActivity);
    document.addEventListener('scroll', trackActivity);

    // CSRF Token management
    function getCSRFToken() {
      return localStorage.getItem('csrfToken') || generateCSRFToken();
    }

    // Enhanced fetch with CSRF token and retry logic
    async function secureFetch(url, options = {}) {
      // Rate limit check for API calls
      if (!RateLimiter.check('api_call')) {'
        throw new Error('Rate limit exceeded');
      }
      
      const token = localStorage.getItem('authToken');
      const csrfToken = getCSRFToken();
      
      if (!token) {
        throw new Error('No auth token found');
      }
      
      const headers = {
        'Authorization': 'Bearer ' + token,'
        'X-CSRF-Token': csrfToken,'
        'X-Request-ID': generateRequestId(),'
        ...options.headers
      };
      
      // Add loading state
      showLoadingState(true);
      
      try {
        const response = await fetch(url, { 
          ...options, 
          headers,
          credentials: 'same-origin''
        });
        
        // Check if token expired
        if (response.status === 401) {
          await createAuditLog('TOKEN_EXPIRED', {'
            url: url,
            method: options.method || 'GET''
          });
          logout();
          throw new Error('Authentication expired');
        }
        
        // Check CSRF token mismatch
        if (response.status === 403 && response.headers.get('X-CSRF-Error')) {'
          generateCSRFToken();
          throw new Error('CSRF token mismatch, please retry');
        }
        
        return response;
      } finally {
        showLoadingState(false);
      }
    }

    // Generate unique request ID for tracking
    function generateRequestId() {
      return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // Show/hide loading state
    function showLoadingState(show) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = show ? 'flex' : 'none'
      }
    }
    
    // Alias function for consistency with other pages
        // ==================== END SECURITY & VALIDATION ====================

    // ==================== AUDIT LOG SYSTEM ====================
    
    // Enhanced audit logging function with IP and device tracking
    async function createAuditLog(action, details) {
      // TEMPORARILY DISABLE AUDIT LOGGING DUE TO BACKEND ISSUES
      console.log('Audit log disabled:', action, details);
      return;
      
      /* Original code commented out temporarily
      try {
        // Skip if no auth token (not logged in yet)
        const token = localStorage.getItem('authToken');
        if (!token && action !== 'LOGIN_ATTEMPT') return;
        
        // Get browser and device info
        const deviceInfo = getDeviceInfo();
        
        // Get location info (if available)
        const locationInfo = await getLocationInfo();
        
        // Get user info
        const userInfo = await getCurrentUserInfo();
        
        // Map custom actions to valid backend actions
        const actionMapping = {
          'VIEW_STOCK': 'VIEW','
          'VIEW_BRANCHES': 'VIEW', '
          'PAGE_ACCESS': 'VIEW','
          'SEND_TO_STOCK': 'CREATE','
          'BULK_SEND_TO_STOCK': 'CREATE','
          'APPROVE_STOCK': 'UPDATE','
          'REJECT_STOCK': 'DELETE','
          'DELETE_STOCK': 'DELETE','
          'UPDATE_IMEI': 'UPDATE','
          'SCAN_BARCODE': 'CREATE','
          'IMEI_ADDED': 'CREATE','
          'PRODUCT_NOT_FOUND': 'VIEW','
          'TAB_SWITCH': 'VIEW','
          'VIEW_VERIFIED_HISTORY': 'VIEW','
          'ERROR_LOADING_STOCK': 'VIEW','
          'ERROR_LOADING_BRANCHES': 'VIEW','
          'ERROR_LOADING_VERIFIED_HISTORY': 'VIEW','
          'ERROR_APPROVE_STOCK': 'UPDATE','
          'ERROR_REJECT_STOCK': 'DELETE','
          'ERROR_UPDATE_IMEI': 'UPDATE','
          'ERROR_SCAN_BARCODE': 'CREATE','
          'ERROR_SEND_TO_STOCK': 'CREATE','
          'ERROR_BULK_SEND_TO_STOCK': 'CREATE','
          'BRANCH_NOT_FOUND': 'VIEW','
          'RATE_LIMIT_EXCEEDED': 'VIEW','
          'SESSION_TIMEOUT': 'VIEW','
          'TOKEN_EXPIRED': 'VIEW','
          'USER_LOGOUT': 'VIEW''
        };
        
        // Use mapped action or default to original
        const mappedAction = actionMapping[action] || action;
        
        // Convert device info to string
        const deviceString = `${deviceInfo.device.type} - ${deviceInfo.os.name} ${deviceInfo.os.version} - ${deviceInfo.browser.name} ${deviceInfo.browser.version}`;
        
        const payload = {
          action: mappedAction,
          resource: details.resource || 'BranchStock','
          resourceId: details.resourceId || null,
          resourceName: details.resourceName || null,
          userId: userInfo.userId || 'anonymous','
          userName: userInfo.userName || 'Unknown','
          userRole: userInfo.role || 'Unknown','
          branch: userInfo.branch || document.getElementById('branchSelect')?.value || 'Unknown','
          severity: getSeverityLevel(action),
          device: deviceString, // Send as string
          details: {
            ...details,
            originalAction: action, // Keep original action in details
            deviceInfo: deviceInfo, // Keep full device info in details
            ...locationInfo,
            timestamp: new Date().toISOString(),
            sessionDuration: Date.now() - lastActivity,
            pageUrl: window.location.href,
            pageTitle: document.title,
            referrer: document.referrer || 'Direct''
          }
        };
        
        // Don't use secureFetch for audit logs to avoid circular dependency'
        const response = await fetch('/api/audit/log', {'
          method: 'POST','
          headers: { 
            'Content-Type': 'application/json','
            'Authorization': 'Bearer ' + (token || ''),'
            'X-CSRF-Token': getCSRFToken()'
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          console.error('Audit log failed:', await response.text());
          // Store failed audit logs in localStorage for retry
          const failedLogs = JSON.parse(localStorage.getItem('failedAuditLogs') || '[]');
          failedLogs.push(payload);
          localStorage.setItem('failedAuditLogs', JSON.stringify(failedLogs.slice(-50))); // Keep last 50'
        }
      } catch (err) {
        console.error('Failed to create audit log:', err);
        // Store in localStorage for later retry
        try {
          const failedLogs = JSON.parse(localStorage.getItem('failedAuditLogs') || '[]');
          failedLogs.push({ action, details, error: err.message, timestamp: new Date().toISOString() });
          localStorage.setItem('failedAuditLogs', JSON.stringify(failedLogs.slice(-50)));
        } catch (e) {
          console.error('Failed to store audit log locally:', e);
        }
      }
      */
    }

    // Determine severity level based on action type
    function getSeverityLevel(action) {
      const highSeverity = ['DELETE', 'LOGIN_FAILED', 'UNAUTHORIZED_ACCESS', 'RATE_LIMIT_EXCEEDED', 'TOKEN_EXPIRED'];
      const mediumSeverity = ['UPDATE', 'CREATE', 'APPROVE', 'REJECT', 'SEND_TO_STOCK'];
      const lowSeverity = ['VIEW', 'SEARCH', 'SCAN', 'TAB_SWITCH'];
      
      if (highSeverity.some(a => action.includes(a))) return 'HIGH'
      if (mediumSeverity.some(a => action.includes(a))) return 'MEDIUM'
      if (lowSeverity.some(a => action.includes(a))) return 'LOW'
      return 'INFO'
    }

    // Retry failed audit logs
    async function retryFailedAuditLogs() {
      const failedLogs = JSON.parse(localStorage.getItem('failedAuditLogs') || '[]');
      if (failedLogs.length === 0) return;
      
      const token = localStorage.getItem('authToken');
      if (!token) return;
      
      Logger.info(`Retrying ${failedLogs.length} failed audit logs...`);
      
      for (const log of failedLogs) {
        try {
          const response = await fetch('/api/audit/log', {'
            method: 'POST','
            headers: { 
              'Content-Type': 'application/json','
              'Authorization': 'Bearer ' + token,'
              'X-CSRF-Token': getCSRFToken()'
            },
            body: JSON.stringify(log)
          });
          
          if (response.ok) {
            // Remove successful log
            const remaining = JSON.parse(localStorage.getItem('failedAuditLogs') || '[]');
            const filtered = remaining.filter(l => l.timestamp !== log.timestamp);
            localStorage.setItem('failedAuditLogs', JSON.stringify(filtered));
          }
        } catch (err) {
          console.error('Retry audit log failed:', err);
        }
      }
    }

    // Get detailed device information
    function getDeviceInfo() {
      const ua = navigator.userAgent;
      const parser = new UAParser(ua);
      const result = parser.getResult();
      
      return {
        userAgent: ua,
        browser: {
          name: result.browser.name || 'Unknown','
          version: result.browser.version || 'Unknown','
          major: result.browser.major || 'Unknown''
        },
        os: {
          name: result.os.name || 'Unknown','
          version: result.os.version || 'Unknown''
        },
        device: {
          type: result.device.type || 'desktop','
          vendor: result.device.vendor || 'Unknown','
          model: result.device.model || 'Unknown''
        },
        screen: {
          width: window.screen.width,
          height: window.screen.height,
          pixelRatio: window.devicePixelRatio || 1
        },
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        },
        language: navigator.language || 'Unknown','
        platform: navigator.platform || 'Unknown','
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        doNotTrack: navigator.doNotTrack || 'Unknown''
      };
    }

    // Get location info (requires user permission)
    async function getLocationInfo() {
      try {
        if ('geolocation' in navigator) {'
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 5000,
              maximumAge: 300000 // 5 minutes cache
            });
          });
          
          return {
            location: {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy
            }
          };
        }
      } catch (err) {
        // User denied location or error occurred
        Logger.debug('Location not available:', err.message);
      }
      
      return { location: null };
    }

    // Simple UA Parser (embedded to avoid external dependency)
    class UAParser {
      constructor(ua) {
        this.ua = ua.toLowerCase();
      }
      
      getResult() {
        return {
          browser: this.getBrowser(),
          os: this.getOS(),
          device: this.getDevice()
        };
      }
      
      getBrowser() {
        const browsers = [
          { name: 'Chrome', pattern: /chrome\/(\d+)\.(\d+)/ },'
          { name: 'Firefox', pattern: /firefox\/(\d+)\.(\d+)/ },'
          { name: 'Safari', pattern: /version\/(\d+)\.(\d+).*safari/ },'
          { name: 'Edge', pattern: /edg\/(\d+)\.(\d+)/ },'
          { name: 'Opera', pattern: /opr\/(\d+)\.(\d+)/ }'
        ];
        
        for (const browser of browsers) {
          const match = this.ua.match(browser.pattern);
          if (match) {
            return {
              name: browser.name,
              version: `${match[1]}.${match[2]}`,
              major: match[1]
            };
          }
        }
        
        return { name: 'Unknown', version: 'Unknown', major: 'Unknown' };
      }
      
      getOS() {
        const systems = [
          { name: 'Windows 11', pattern: /windows nt 10\.0.*win64/ },'
          { name: 'Windows 10', pattern: /windows nt 10\.0/ },'
          { name: 'Windows 8.1', pattern: /windows nt 6\.3/ },'
          { name: 'Windows 8', pattern: /windows nt 6\.2/ },'
          { name: 'Windows 7', pattern: /windows nt 6\.1/ },'
          { name: 'macOS', pattern: /mac os x (\d+)[._](\d+)/ },'
          { name: 'iOS', pattern: /iphone.*os (\d+)[._](\d+)/ },'
          { name: 'Android', pattern: /android (\d+)\.(\d+)/ },'
          { name: 'Linux', pattern: /linux/ }'
        ];
        
        for (const os of systems) {
          const match = this.ua.match(os.pattern);
          if (match) {
            const version = match[1] ? `${match[1]}.${match[2] || 0}` : 'Unknown'
            return { name: os.name, version };
          }
        }
        
        return { name: 'Unknown', version: 'Unknown' };
      }
      
      getDevice() {
        if (/mobile/i.test(this.ua)) {
          return { type: 'mobile' };
        } else if (/tablet|ipad/i.test(this.ua)) {
          return { type: 'tablet' };
        }
        return { type: 'desktop' };
      }
    }

    // ==================== END AUDIT LOG SYSTEM ====================

    // ==================== UTILITY FUNCTIONS ====================
    
    // Toast notification function
    function showToast(message, type = 'info') {'
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast-notification');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast-notification alert alert-${type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'} fixed top-4 right-4 z-50 max-w-sm shadow-lg animate-in`;
      
      const icon = type === 'success' ? 'bi-check-circle-fill' : '
                   type === 'error' ? 'bi-x-circle-fill' : '
                   type === 'warning' ? 'bi-exclamation-triangle-fill' : '
                   'bi-info-circle-fill'
      
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="bi ${icon} text-xl"></i>
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="btn btn-sm btn-ghost">
            <i class="bi bi-x"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.add('animate-out');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Get current user info with caching
    async function getCurrentUserInfo() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return { userId: null, userName: '', role: null, branch: null };
        
        // Check if cached user info is still valid
        const cachedUser = sessionStorage.getItem('currentUser');
        if (cachedUser) {
          const userData = JSON.parse(cachedUser);
          // Cache for 5 minutes
          if (Date.now() - userData.cachedAt < 5 * 60 * 1000) {
            return userData;
          }
        }
        
        const res = await fetch('/api/users/me', {'
          headers: { 'Authorization': 'Bearer ' + token }'
        });
        const data = await res.json();
        if (res.ok && data.success) {
          const userInfo = { 
            userId: data.data._id, 
            userName: data.data.name,
            role: data.data.role,
            branch: data.data.branch,
            permissions: data.data.allowedPages || [],
            cachedAt: Date.now()
          };
          
          // Cache user info
          sessionStorage.setItem('currentUser', JSON.stringify(userInfo));
          localStorage.setItem('userId', data.data._id);
          
          return userInfo;
        }
        return { userId: null, userName: '', role: null, branch: null };
      } catch (err) {
        Logger.error('Error getting user info:', err);
        return { userId: null, userName: '', role: null, branch: null };
      }
    }

    // ==================== END UTILITY FUNCTIONS ====================

    // ==================== API FUNCTIONS ====================
    
    // Load product images
    async function loadProductImages() {
      try {
        const res = await secureFetch('/api/product-image');
        const data = await res.json();
        if (!res.ok || data.status !== 'success') {'
          throw new Error(data.message || 'ไม่สามารถโหลดข้อมูล product-image');
        }
        allProductImages = data.data;
        Logger.debug('Product images loaded:', allProductImages.length);
      } catch (err) {
        Logger.error('Error loadProductImages:', err);
        showToast('ไม่สามารถโหลดรูปภาพสินค้าได้: ' + err.message, 'error');
      }
    }
    
    // Load suppliers
    async function loadSuppliers() {
      try {
        const res = await secureFetch('/api/supplier');
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลด suppliers');
        }
        
        if (data.data && data.data.length > 0) {
          // ใช้ supplier แรกเป็น default
          defaultSupplier = data.data[0];
          Logger.info('Default supplier set:', defaultSupplier.name);
        } else {
          Logger.warn('No suppliers found in system');
        }
      } catch (err) {
        Logger.error('Error loading suppliers:', err);
        // ไม่แสดง toast เพราะไม่ใช่ error ที่สำคัญ
      }
    }

    // Load branch info
    async function loadBranchInfo() {
      try {
        const branchCode = BRANCH_CODE;
        const token = localStorage.getItem("authToken") || "";
        
        // เรียก /api/branch เพื่อดึง list สาขา
        const res = await fetch(`/api/branch`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const js = await res.json();
        if (res.ok && js.success) {
          // หา record ที่ตรงกับ branch_code
          const branch = js.data.find(b => b.branch_code === branchCode);
          if (branch) {
            document.getElementById("branchInfo").textContent =
              `${branch.name} — ${branch.address}`;
            // อัพเดท title ของหน้าด้วยชื่อสาขาจริง
            document.title = `คลังสินค้า - ${branch.name}`;
            document.getElementById("pageTitle").textContent = `คลังสินค้า - ${branch.name}`;
            return;
          }
        }
        throw new Error("ไม่พบข้อมูลสาขา");
      } catch (err) {
        Logger.warn("loadBranchInfo error:", err);
        document.getElementById("branchInfo").textContent =
          "สาขา: (ไม่พบข้อมูล)";
      }
    }

    // Load branches
    async function loadBranches() {
      try {
        const res = await secureFetch('/api/branch', {'
          headers: {
            'Content-Type': 'application/json''
          }
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลดสาขา');
        }
        
        // Audit log for branch access
        createAuditLog('VIEW_BRANCHES', {'
          branchCount: data.data.length
        });
        
        const branchSelect = document.getElementById('branchSelect');
        branchSelect.innerHTML = ''
        
        // อ่าน branch code จาก URL parameter
        const branchFromUrl = BRANCH_CODE;
        
        const ptnBranches = data.data.filter(b => b.branch_code === branchFromUrl);
        
        // อัพเดท title ของหน้า
        if (ptnBranches.length > 0 && urlParams.get('name')) {'
          document.title = `คลังสินค้า - ${decodeURIComponent(urlParams.get('name'))}`;
        }
        
        if (ptnBranches.length === 0) {
          branchSelect.innerHTML = '<option value="">ไม่พบสาขา</option>'
          showToast('ไม่พบสาขา ' + branchFromUrl, 'error');
          
          // Audit log for branch not found
          createAuditLog('BRANCH_NOT_FOUND', {'
            requestedBranch: branchFromUrl
          });
          return;
        }
        
        ptnBranches.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.branch_code;
          opt.textContent = `[${b.branch_code}] ${b.name}`;
          branchSelect.appendChild(opt);
        });
        
        // Set value to BRANCH_CODE
        branchSelect.value = BRANCH_CODE;
        console.log('✅ Branch select value set to:', BRANCH_CODE);
        
        branchSelect.disabled = true;
        loadStock();
      } catch (err) {
        showToast('Error loading branches: ' + err.message, 'error');
        
        // Audit log for error
        createAuditLog('ERROR_LOADING_BRANCHES', {'
          error: err.message
        });
      }
    }

    // Load stock data
    async function loadStock() {
      const branchSelect = document.getElementById('branchSelect');
      console.log('🔍 Branch select element:', branchSelect);
      console.log('🔍 Branch select value:', branchSelect?.value);
      console.log('🔍 Branch select disabled:', branchSelect?.disabled);
      
      const branchId = branchSelect?.value || BRANCH_CODE;
      if (!branchId) {
        Logger.warn('No branch selected, cannot load stock');
        return;
      }
      
      Logger.info('Loading stock for branch:', branchId);
      console.log('🔍 Loading stock for branch:', branchId);

      try {
        // Audit log for stock loading
        createAuditLog('VIEW_STOCK', {'
          branch: branchId,
          action: 'load_stock_list''
        });
        
        // โหลดข้อมูลทั้งหมด ไม่ filter อะไรเลย
        const url = `/api/branch-stock?branch_code=${branchId}&include_unverified=1&include_all=1&_=${new Date().getTime()}`;
        Logger.info('Loading stock from:', url);
        console.log('📡 API URL (include all):', url);
        console.log('📍 Branch ID being used:', branchId);
        
        const res = await secureFetch(url);
        const result = await res.json();
        
        Logger.info('API Response:', {'
          ok: res.ok,
          status: res.status,
          success: result.success,
          dataLength: result.data ? result.data.length : 0
        });
        
        console.log('📦 API Response:', {'
          success: result.success,
          dataCount: result.data ? result.data.length : 0,
          error: result.error
        });
        
        // แสดง raw response data
        console.log('📋 Raw API Response Data:', result);
        
        if (!res.ok || !result.success) {
          Logger.error('Load stock error:', result);
          console.error('❌ Load stock error:', result);
          showToast('โหลดสต๊อกไม่สำเร็จ: ' + (result.error || 'Unknown error'), 'error');
          
          // Audit log for error
          createAuditLog('ERROR_LOADING_STOCK', {'
            branch: branchId,
            error: result.error || 'Unknown error''
          });
          return;
        }

        const rawStocks = result.data || [];
        Logger.info('Total stocks loaded:', rawStocks.length);
        console.log('📊 Total stocks:', rawStocks.length);
        
        // Debug: แสดงข้อมูลทั้งหมดที่ได้จาก API
        console.log('🔍 ALL Stocks from API:', rawStocks);
        
        // Debug: แสดง iPhone stocks โดยเฉพาะ
        const iPhoneStocks = rawStocks.filter(s => s.name && s.name.toLowerCase().includes('iphone'));
        console.log('📱 iPhone stocks found:', iPhoneStocks.length);
        if (iPhoneStocks.length > 0) {
          console.log('📱 iPhone stock details:');
          iPhoneStocks.forEach((stock, i) => {
            console.log(`  ${i+1}. ${stock.name}`);
            console.log(`     - Barcode: ${stock.barcode}`);
            console.log(`     - IMEI: ${stock.imei}`);
            console.log(`     - Branch: ${stock.branch_code}`);
            console.log(`     - Verified: ${stock.verified}`);
            console.log(`     - Sent to stock: ${stock.sent_to_stock}`);
            console.log(`     - Created: ${stock.created_at}`);
          });
        }
        
        // ตรวจสอบ stock ที่มี pending = false
        const falseStocks = rawStocks.filter(s => s.pending === false);
        console.log('📌 Stocks with pending=false:', falseStocks.length, falseStocks);
        
        // ตรวจสอบ stock ที่ไม่มี pending field
        const noPendingStocks = rawStocks.filter(s => s.pending === undefined);
        console.log('📌 Stocks with no pending field:', noPendingStocks.length, noPendingStocks);
        
        // Debug: แสดงข้อมูลดิบเพื่อตรวจสอบ
        if (rawStocks.length > 0) {
          Logger.debug('Sample stock data:', rawStocks[0]);
          console.log('📋 First stock item:', rawStocks[0]);
          
          // แสดง 5 รายการแรก
          console.log('📋 First 5 stocks:');
          rawStocks.slice(0, 5).forEach((stock, i) => {
            console.log(`${i+1}. ${stock.name} - Status: pending=${stock.pending}, verified=${stock.verified}, sent_to_stock=${stock.sent_to_stock}, branch=${stock.branch_code}`);
          });
        }

        // Debug เพิ่มเติม - แสดงสต๊อกที่ branch_code ตรงกับที่เลือก
        const currentBranch = document.getElementById('branchSelect').value;
        console.log('🏢 Current branch:', currentBranch);
        const branchStocks = rawStocks.filter(s => s.branch_code === currentBranch);
        console.log(`📊 Stocks for branch ${currentBranch}:`, branchStocks.length);
        
        if (branchStocks.length > 0) {
          console.log('📋 Branch stocks sample:', branchStocks.slice(0, 3));
        }

        // --- NEW FILTERING LOGIC ---
        // "รออนุมัติ" tab contains all items that are NOT yet verified.
        // "อนุมัติแล้ว" tab contains all items that ARE verified.
        const unverifiedStocks = rawStocks.filter(s => s.verified !== true);
        const verifiedStocks = rawStocks.filter(s => s.verified === true);

        Logger.info('Stock counts - Unverified:', unverifiedStocks.length, 'Verified:', verifiedStocks.length);
        console.log('📊 Stock breakdown:');
        console.log('  - Unverified (รออนุมัติ):', unverifiedStocks.length);
        console.log('  - Verified (อนุมัติแล้ว):', verifiedStocks.length);
        
        // Debug: แสดง unverified stocks
        if (unverifiedStocks.length > 0) {
          console.log('🔍 Unverified stocks details:');
          unverifiedStocks.forEach((stock, i) => {
            console.log(`  ${i+1}. ${stock.name} - ${stock.barcode} - ${stock.imei}`);
          });
        }
        
        // อัพเดท counts
        document.getElementById('unverifiedCount').textContent = unverifiedStocks.length;
        document.getElementById('verifiedCount').textContent = verifiedStocks.length;
        document.getElementById('stockCount').textContent = rawStocks.length;

        // ตรวจสอบ container ก่อน render
        const stockContainer = document.getElementById('stockContainer');
        const verifiedContainer = document.getElementById('verifiedContainer');
        
        console.log('🎯 Containers found:', {'
          stockContainer: !!stockContainer,
          verifiedContainer: !!verifiedContainer
        });

        // แสดงข้อมูลตาม tab ที่เลือก
        const activeTab = document.querySelector('.tab-active');
        console.log('🏷️ Active tab:', activeTab ? activeTab.id : 'none');
        
        if (activeTab && activeTab.id === 'tab-unverified') {'
          console.log('📝 Rendering unverified tab with', unverifiedStocks.length, 'items...');
          renderUnverifiedStocks(unverifiedStocks);
        } else if (activeTab && activeTab.id === 'tab-verified') {'
          console.log('📝 Rendering verified tab...');
          // แสดง verified stocks ที่โหลดมาแล้ว
          renderVerifiedHistory(verifiedStocks);
        }
      } catch (err) {
        Logger.error('Error loading stock:', err);
        console.error('❌ Error loading stock:', err);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message, 'error');
        
        // Audit log for error
        createAuditLog('ERROR_LOADING_STOCK', {'
          branch: branchId,
          error: err.message
        });
      }
    }

    // Get stock info by ID
    async function getStockInfo(stockId) {
      try {
        const res = await secureFetch(`/api/branch-stock/${stockId}`);
        const data = await res.json();
        return data.success ? data.data : null;
      } catch (err) {
        Logger.error('Error getting stock info:', err);
        return null;
      }
    }

    // ==================== END API FUNCTIONS ====================

    // ==================== RENDERING FUNCTIONS ====================
    
    // Sanitize HTML to prevent XSS
    function sanitizeHTML(str) {
      if (!str) return ''
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }
    
    // Group stock by brand
    function groupStockByBrand(stocks) {
      const map = {};
      stocks.forEach(stock => {
        const brand = stock.brand || 'ไม่ระบุแบรนด์'
        if (!map[brand]) map[brand] = [];
        map[brand].push(stock);
      });
      return map;
    }

    // Render unverified stocks (สินค้ารออนุมัติ)
    function renderUnverifiedStocks(unverifiedArray) {
      Logger.info('Rendering unverified stocks:', unverifiedArray.length);
      console.log('🎨 Starting renderUnverifiedStocks with', unverifiedArray.length, 'items');
      
      try {
        const container = document.getElementById("stockContainer");
        if (!container) {
          Logger.error('stockContainer element not found!');
          console.error('❌ stockContainer element not found!');
          return;
        }
        
        console.log('📦 Container found:', container);
        container.innerHTML = ''
        
        if (unverifiedArray.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="bi bi-inbox text-4xl mb-2 block"></i>
              ไม่มีสินค้ารออนุมัติ
            </div>`;
          return;
        }
        
        const grouped = groupStockByBrand(unverifiedArray);
        console.log('🏷️ Grouped by brand:', Object.keys(grouped));
        
        Object.keys(grouped).forEach(brand => {
          console.log(`🏭 Rendering brand: ${brand}`);
          const items = grouped[brand];
          const brandSection = document.createElement("div");
          brandSection.className = "mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow";
          
          const hdr = document.createElement("h5");
          hdr.className = "section-title mb-3 flex items-center gap-2 text-lg font-semibold";
          hdr.innerHTML = `<i class="bi bi-box-seam-fill text-blue-500"></i> ${brand} (${items.length} รายการ)`;
          brandSection.appendChild(hdr);
          
          const tblWrap = document.createElement("div");
          tblWrap.className = "overflow-x-auto";
          tblWrap.innerHTML = `
            <table class="table table-zebra w-full">
              <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                  <th class="p-3 text-center w-16">
                    <input type="checkbox" class="checkbox checkbox-sm brand-checkbox" data-brand="${brand}">
                  </th>
                  <th class="p-3 text-center">บาร์โค้ด</th>
                  <th class="p-3">ชื่อสินค้า</th>
                  <th class="p-3 text-center">IMEI</th>
                  <th class="p-3 text-center">สถานะ</th>
                  <th class="p-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>`;
          brandSection.appendChild(tblWrap);
          
          const tbody = tblWrap.querySelector("tbody");
          items.forEach((stock, index) => {
            console.log(`  📝 Rendering item ${index + 1}:`, stock.name);
            try {
              let imeiDisplay = ''
              const stockType = stock.stockType || stock.product_id?.stockType || 'imei'
              
              if (stockType === 'quantity') {'
                imeiDisplay = '<span class="badge badge-info">ไม่ใช้ IMEI</span>'
              } else if (stock.imei && stock.imei.trim() !== '') {'
                imeiDisplay = `<span class="text-green-600 dark:text-green-400">${stock.imei || ''}</span>`;
              } else {
                imeiDisplay = '<span class="text-orange-600 dark:text-orange-400">ยังไม่ได้กรอก</span>'
              }
              
              let statusBadge = ''
              let isCheckboxDisabled = false;
              if (stock.sent_to_stock === true) {
                statusBadge = '<span class="badge badge-warning"><i class="bi bi-clock-history mr-1"></i>รอฝ่ายสต็อกอนุมัติ</span>'
                isCheckboxDisabled = true;
              } else {
                statusBadge = '<span class="badge badge-info"><i class="bi bi-send mr-1"></i>พร้อมส่ง</span>'
                isCheckboxDisabled = false;
              }
              
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="p-3 text-center">
                  <input type="checkbox" class="checkbox checkbox-sm stock-checkbox" 
                         data-stock-id="${stock._id}" 
                         data-brand="${brand}" ${isCheckboxDisabled ? 'disabled' : ''}>'
                </td>
                <td class="p-3 text-center">${stock.barcode || "-"}</td>
                <td class="p-3">${stock.name || "-"}</td>
                <td class="p-3 text-center">${imeiDisplay}</td>
                <td class="p-3 text-center">${statusBadge}</td>
                <td class="p-3 text-center">
                  <button class="btn btn-sm btn-error remove-stock-button" data-stock-id="${stock._id}">
                    <i class="bi bi-trash"></i> ลบ
                  </button>
                </td>`;
              tbody.appendChild(tr);
            } catch (itemErr) {
              console.error(`❌ Error rendering item ${index}:`, itemErr, stock);
            }
          });
          
          container.appendChild(brandSection);
          console.log(`✅ Brand ${brand} rendered successfully`);
        });
        
        setupCheckboxListeners();
        selectedStocks.clear();
        updateSelectedCount();
        console.log('✅ renderUnverifiedStocks completed successfully');
        
      } catch (err) {
        console.error('❌ Error in renderUnverifiedStocks:', err);
        console.error('Stack trace:', err.stack);
        showToast('เกิดข้อผิดพลาดในการแสดงข้อมูล: ' + err.message, 'error');
      }
    }

    // Render verified history
    function renderVerifiedHistory(stocks) {
      const container = document.getElementById('verifiedContainer');
      container.innerHTML = ''
      
      if (stocks.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">ไม่พบสินค้าอนุมัติ</div>'
        return;
      }
      
      const grouped = groupStockByBrand(stocks);
      
      Object.keys(grouped).forEach(brand => {
        const items = grouped[brand];
        const brandSection = document.createElement("div");
        brandSection.className = "mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow";
        
        const hdr = document.createElement("h5");
        hdr.className = "section-title mb-3 flex items-center gap-2 text-lg font-semibold";
        hdr.innerHTML = `<i class="bi bi-box-seam-fill text-blue-500"></i> ${brand} (${items.length} รายการ)`;
        brandSection.appendChild(hdr);
        
        const tblWrap = document.createElement("div");
        tblWrap.className = "overflow-x-auto";
        tblWrap.innerHTML = `
          <table class="table table-zebra w-full">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="p-3 text-center w-16">
                  <input type="checkbox" class="checkbox checkbox-sm brand-checkbox" data-brand="${brand}">
                </th>
                <th class="p-3 text-center">บาร์โค้ด</th>
                <th class="p-3">ชื่อสินค้า</th>
                <th class="p-3 text-center">IMEI</th>
                <th class="p-3 text-center">สถานะ</th>
                <th class="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>`;
        brandSection.appendChild(tblWrap);
        
        const tbody = tblWrap.querySelector("tbody");
        items.forEach(stock => {
          let imeiDisplay = ''
          const stockType = stock.stockType || stock.product_id?.stockType || 'imei'
          
          if (stockType === 'quantity') {'
            imeiDisplay = '<span class="badge badge-info">ไม่ใช้ IMEI</span>'
          } else if (stock.imei && stock.imei.trim() !== '') {'
            imeiDisplay = `<span class="text-green-600 dark:text-green-400">${sanitizeHTML(stock.imei)}</span>`;
          } else {
            imeiDisplay = '<span class="text-orange-600 dark:text-orange-400">ยังไม่ได้กรอก</span>'
          }
          
          let statusBadge = ''
          let isCheckboxDisabled = false;
          if (stock.sent_to_stock === true) {
            statusBadge = '<span class="badge badge-warning"><i class="bi bi-clock-history mr-1"></i>รอฝ่ายสต็อกอนุมัติ</span>'
            isCheckboxDisabled = true;
          } else {
            statusBadge = '<span class="badge badge-info"><i class="bi bi-send mr-1"></i>พร้อมส่ง</span>'
            isCheckboxDisabled = false;
          }
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-3 text-center">
              <input type="checkbox" class="checkbox checkbox-sm stock-checkbox" 
                     data-stock-id="${stock._id}" 
                     data-brand="${brand}" ${isCheckboxDisabled ? 'disabled' : ''}>'
            </td>
            <td class="p-3 text-center">${sanitizeHTML(stock.barcode||"-")}</td>
            <td class="p-3">${sanitizeHTML(stock.name||"-")}</td>
            <td class="p-3 text-center">${imeiDisplay}</td>
            <td class="p-3 text-center">${statusBadge}</td>
            <td class="p-3 text-center">
              <button class="btn btn-sm btn-error remove-stock-button" data-stock-id="${stock._id}">
                <i class="bi bi-trash"></i> ลบ
              </button>
            </td>`;
          tbody.appendChild(tr);
        });
        
        container.appendChild(brandSection);
      });
      
      setupCheckboxListeners();
      selectedStocks.clear();
      updateSelectedCount();
    }

    // ==================== END RENDERING FUNCTIONS ====================

    // Load verified history
    async function loadVerifiedHistory() {
      try {
        Logger.info('Loading verified history...');
        
        const branchId = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        if (!branchId || branchId === 'all') {'
          Logger.warn('No specific branch selected for verified history');
          const container = document.getElementById('verifiedContainer');
          if (container) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">กรุณาเลือกสาขา</div>'
          }
          return;
        }
        
        // Get date range
        const dateFrom = document.getElementById('dateFrom')?.value;
        const dateTo = document.getElementById('dateTo')?.value;
        
        if (!dateFrom || !dateTo) {
          showToast('กรุณาเลือกช่วงวันที่', 'warning');
          return;
        }
        
        // Build URL with date filters
        let url = `/api/branch-stock?branch_code=${branchId}&verified=true`;
        
        // Add date filters
        if (dateFrom) {
          url += `&date_from=${dateFrom}`;
        }
        if (dateTo) {
          // Add 1 day to include the entire end date
          const endDate = new Date(dateTo);
          endDate.setDate(endDate.getDate() + 1);
          url += `&date_to=${endDate.toISOString().split('T')[0]}`;
        }
        
        Logger.info('Loading verified stocks from:', url);
        
        const res = await secureFetch(url);
        const result = await res.json();
        
        if (!res.ok || !result.success) {
          throw new Error(result.error || 'โหลดประวัติไม่สำเร็จ');
        }
        
        const verifiedStocks = result.data || [];
        Logger.info('Verified stocks loaded:', verifiedStocks.length);
        
        // Filter only verified stocks
        const filteredVerifiedStocks = verifiedStocks.filter(s => s.verified === true);
        
        // Use existing renderVerifiedHistory function
        renderVerifiedHistory(filteredVerifiedStocks);
        
        // Update count
        document.getElementById('verifiedCount').textContent = filteredVerifiedStocks.length;
        
        // Audit log
        createAuditLog('VIEW_VERIFIED_HISTORY', {'
          branch: branchId,
          dateFrom: dateFrom,
          dateTo: dateTo,
          recordCount: filteredVerifiedStocks.length
        });
        
      } catch (err) {
        Logger.error('Error loading verified history:', err);
        showToast('เกิดข้อผิดพลาดในการโหลดประวัติ: ' + err.message, 'error');
        const container = document.getElementById('verifiedContainer');
        if (container) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>'
        }
        
        // Audit log for error
        createAuditLog('ERROR_LOADING_VERIFIED_HISTORY', {'
          error: err.message
        });
      }
    }

    // ==================== STOCK MANAGEMENT FUNCTIONS ====================
    
    // Approve pending stock
    async function approvePending(stockId) {
      try {
        // Rate limit check
        if (!RateLimiter.check('update_action')) return;
        
        // ดึงข้อมูลผู้ใช้
        const userInfo = await getCurrentUserInfo();
        const userId = userInfo.userId;
        const userName = userInfo.userName;

        // Get stock info for audit
        const stockInfo = await getStockInfo(stockId);

        const res = await secureFetch(`/api/branch-stock/${stockId}`, {
          method: 'PATCH','
          headers: {
            'Content-Type': 'application/json''
          },
          body: JSON.stringify({
            pending: false,
            verified: true,
            verified_by: userId,
            verified_by_name: userName,
            verified_at: new Date().toISOString()
          })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'อนุมัติไม่สำเร็จ');
        }
        
        // Audit log for approval
        createAuditLog('APPROVE_STOCK', {'
          resourceId: stockId,
          resourceName: stockInfo?.name || 'Unknown','
          sku: stockInfo?.sku,
          imei: stockInfo?.imei,
          branch: document.getElementById('branchSelect').value,'
          approvedBy: userName
        });
        
        showToast('อนุมัติเรียบร้อย', 'success');
        loadStock();
      } catch (err) {
        showToast('Error approving: ' + err.message, 'error');
        
        // Audit log for error
        createAuditLog('ERROR_APPROVE_STOCK', {'
          resourceId: stockId,
          error: err.message
        });
      }
    }

    // Reject pending stock
    async function rejectPending(stockId) {
      customConfirm('ยืนยันการปฏิเสธรายการนี้?', async () => {'
        try {
          // Rate limit check
          if (!RateLimiter.check('delete_action')) return;
          
          // Get stock info for audit
          const stockInfo = await getStockInfo(stockId);
          
          const res = await secureFetch(`/api/branch-stock/${stockId}`, {
            method: 'DELETE''
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            throw new Error(data.error || 'ปฏิเสธไม่สำเร็จ');
          }
          
          // Audit log for rejection
          createAuditLog('REJECT_STOCK', {'
            resourceId: stockId,
            resourceName: stockInfo?.name || 'Unknown','
            sku: stockInfo?.sku,
            imei: stockInfo?.imei,
            branch: document.getElementById('branchSelect').value,'
            reason: 'Rejected from pending list''
          });
          
          showToast('ปฏิเสธและลบรายการเรียบร้อย', 'success');
          loadStock();
        } catch (err) {
          showToast('Error rejecting: ' + err.message, 'error');
          
          // Audit log for error
          createAuditLog('ERROR_REJECT_STOCK', {'
            resourceId: stockId,
            error: err.message
          });
        }
      });
    }

    // Remove stock
    async function removeStock(stockId, showAlert = true) {
      try {
        // Get stock info for audit log
        const stockInfo = await getStockInfo(stockId);
        
        const res = await secureFetch(`/api/branch-stock/${stockId}`, {
          method: 'DELETE''
        });
        
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'ลบสต๊อกไม่สำเร็จ');
        }
        
        // Audit log
        createAuditLog('DELETE_STOCK', {'
          resourceId: stockId,
          resourceName: stockInfo?.name || 'Unknown','
          sku: stockInfo?.sku,
          imei: stockInfo?.imei,
          branch: document.getElementById('branchSelect').value,'
          reason: 'Manual deletion''
        });
        
        if (showAlert) showToast('ลบสต๊อกเรียบร้อย', 'success');
        loadStock();
      } catch (err) {
        if (showAlert) showToast('Error removing stock: ' + err.message, 'error');
        else throw err;
      }
    }

    // ==================== END STOCK MANAGEMENT FUNCTIONS ====================

    // ==================== EVENT HANDLERS ====================
    
    // Handle barcode scan
    async function handleBarcodeScan(barcode) {
      Logger.debug('Scanned barcode:', barcode);
      
      if (!barcode || barcode.trim() === '') {'
        showToast('กรุณากรอกบาร์โค้ด', 'warning');
        return;
      }
      
      if (!RateLimiter.check('scan_barcode')) return;
      const validation = validateBarcode(barcode);
      if (!validation.valid) {
        showToast(validation.message, 'error');
        return;
      }
      
      barcode = barcode.trim();
      
      // แสดงสถานะกำลังประมวลผล
      showLoadingState(true);
      
      try {
        const res = await secureFetch(`/api/product/find-by-barcode?code=${barcode}`);
        const result = await res.json();
        
        if (!res.ok || !result.success) {
          showToast('ไม่พบข้อมูลสินค้าสำหรับบาร์โค้ดนี้', 'error');
          return;
        }
        
        const product = result.data;
        const stockType = product.stockType || 'imei'
        let imeiValue = ''
        let barcodeValue = product.barcode || barcode; // Use product's barcode first

        if (stockType === 'imei') {
            const imeiValidation = validateIMEI(barcode);
            if (!imeiValidation.valid) {
                showToast(`ค่าที่สแกน (${barcode}) ไม่ใช่ IMEI ที่ถูกต้องสำหรับสินค้านี้`, 'error');
                return;
            }
            imeiValue = barcode; // The scanned value is the IMEI
            // barcodeValue is already set to the product's canonical barcode
        }
        
        const branchCode = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        const existingStock = await checkExistingPendingStock(barcodeValue, imeiValue, stockType, branchCode);
        
        if (existingStock) {
          // แสดงข้อมูลสินค้าที่ซ้ำอย่างละเอียด
          let duplicateMessage = `สินค้านี้มีอยู่ในระบบแล้ว!\n\n`;
          duplicateMessage += `ชื่อสินค้า: ${existingStock.name}\n`;
          duplicateMessage += `บาร์โค้ด: ${existingStock.barcode}\n`;
          
          if (stockType === 'imei' && existingStock.imei) {'
            duplicateMessage += `IMEI: ${existingStock.imei}\n`;
          }
          
          if (existingStock.verified) {
            duplicateMessage += `สถานะ: อนุมัติแล้ว\n`;
          } else if (existingStock.sent_to_stock) {
            duplicateMessage += `สถานะ: รอฝ่ายสต็อกอนุมัติ\n`;
          } else {
            duplicateMessage += `สถานะ: รออนุมัติ\n`;
          }
          
          duplicateMessage += `\nวันที่เพิ่ม: ${new Date(existingStock.created_at).toLocaleString('th-TH')}`;
          
          // แสดง popup แจ้งเตือนแบบละเอียด
          customAlert(duplicateMessage, 'warning');
          
          // Clear inputs
          document.getElementById('barcodeInput').value = ''
          document.getElementById('manualBarcode').value = ''
          
          return;
        }
        
        const userInfo = await getCurrentUserInfo();
        const stockData = {
          branch_code: branchCode,
          barcode: barcodeValue,
          sku: product.sku || '','
          imei: imeiValue,
          name: product.name,
          price: product.price || 0,
          brand: product.brand || '','
          model: product.model || '','
          category: product.category || '','
          stockType: stockType,
          supplier: defaultSupplier ? defaultSupplier.name : 'ไม่ระบุ','
          scanned_by: userInfo.userId,
          scanned_by_name: userInfo.userName,
          updated_by: userInfo.userId,
          stock_value: 0,
          created_at: new Date().toISOString()
        };

        const createRes = await secureFetch('/api/branch-stock', {'
          method: 'POST','
          headers: { 'Content-Type': 'application/json' },'
          body: JSON.stringify(stockData)
        });
        
        const createResult = await createRes.json();
        
        if (!createRes.ok || !createResult.success) {
          // ตรวจสอบว่าเป็น error เรื่องสินค้าซ้ำจาก backend หรือไม่
          if (createResult.error && createResult.error.toLowerCase().includes('duplicate')) {'
            showToast('พบสินค้าซ้ำในระบบ! ' + createResult.error, 'error');
          } else {
            throw new Error(createResult.error || 'ไม่สามารถสร้างรายการสต็อกได้');
          }
          return;
        }
          
        showToast(`เพิ่ม '${product.name}' เข้ารายการรออนุมัติเรียบร้อย`, 'success');
        
        // Use a short delay before reloading to ensure DB has updated
        setTimeout(loadStock, 300);

      } catch (err) {
        Logger.error('Error in barcode handling process:', err);
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
      } finally {
        showLoadingState(false);
        document.getElementById('barcodeInput').value = ''
        document.getElementById('manualBarcode').value = ''
      }
    }

    // Check if a functionally identical item already exists in the pending list
    async function checkExistingPendingStock(barcode, imei, stockType, branchCode) {
      try {
        // สร้าง URL สำหรับตรวจสอบ - ต้องดูทุก status
        let url = `/api/branch-stock?branch_code=${branchCode}&barcode=${barcode}&include_unverified=1&include_all=1`;
        
        const res = await secureFetch(url);
        const result = await res.json();
        
        if (res.ok && result.success && result.data) {
          // ตรวจสอบสินค้าที่มีอยู่แล้วทั้งหมด (ไม่ว่าจะ verified หรือไม่)
          const existingStocks = result.data;
          
          if (stockType === 'quantity') {'
            // สำหรับสินค้าประเภท quantity ตรวจสอบเฉพาะ barcode
            const duplicate = existingStocks.find(s => 
              s.barcode === barcode && 
              s.stockType === 'quantity''
            );
            
            if (duplicate) {
              Logger.warn('Found duplicate quantity stock:', duplicate);
              return duplicate;
            }
          } else { // 'imei' type'
            // สำหรับสินค้าประเภท IMEI ตรวจสอบทั้ง barcode และ IMEI
            const duplicate = existingStocks.find(s => 
              s.barcode === barcode && 
              s.imei === imei &&
              s.stockType === 'imei''
            );
            
            if (duplicate) {
              Logger.warn('Found duplicate IMEI stock:', duplicate);
              return duplicate;
            }
          }
        }
        return null;
      } catch (err) {
        Logger.error('Error checking existing stock:', err);
        // ในกรณี error ให้ return null เพื่อไม่ block การทำงาน
        // แต่ backend จะเป็นตัวตรวจสอบขั้นสุดท้าย
        return null;
      }
    }

    // Setup checkbox listeners
    function setupCheckboxListeners() {
      // Brand checkboxes - select all items in brand
      document.querySelectorAll('.brand-checkbox').forEach(cb => {'
        cb.addEventListener('change', function() {'
          const brand = this.dataset.brand;
          const stockCheckboxes = document.querySelectorAll(`.stock-checkbox[data-brand="${brand}"]:not(:disabled)`);
          
          stockCheckboxes.forEach(stockCb => {
            stockCb.checked = this.checked;
            if (this.checked) {
              selectedStocks.add(stockCb.dataset.stockId);
            } else {
              selectedStocks.delete(stockCb.dataset.stockId);
            }
          });
          
          updateSelectedCount();
        });
      });
      
      // Individual stock checkboxes
      document.querySelectorAll('.stock-checkbox').forEach(cb => {'
        cb.addEventListener('change', function() {'
          if (this.checked) {
            selectedStocks.add(this.dataset.stockId);
          } else {
            selectedStocks.delete(this.dataset.stockId);
          }
          updateSelectedCount();
          
          // Update brand checkbox state
          const brand = this.dataset.brand;
          const brandCheckbox = document.querySelector(`.brand-checkbox[data-brand="${brand}"]`);
          if (brandCheckbox) {
            const allInBrand = document.querySelectorAll(`.stock-checkbox[data-brand="${brand}"]:not(:disabled)`);
            const checkedInBrand = document.querySelectorAll(`.stock-checkbox[data-brand="${brand}"]:checked`);
            brandCheckbox.checked = allInBrand.length === checkedInBrand.length && allInBrand.length > 0;
          }
        });
      });
      
      // Remove stock button
      document.querySelectorAll('.remove-stock-button').forEach(btn => {'
        btn.addEventListener('click', async function() {'
          const stockId = this.dataset.stockId;
          customConfirm('ยืนยันการลบสินค้านี้?', async () => {'
            await removeStock(stockId);
          });
        });
      });
    }

    // Update selected count
    function updateSelectedCount() {
      const count = selectedStocks.size;
      const countElement = document.getElementById('selectedCount');
      if (countElement) {
        countElement.textContent = count;
      }
      
      // Show/hide bulk actions
      const bulkActions = document.getElementById('bulkActions');
      if (bulkActions) {
        bulkActions.style.display = count > 0 ? 'flex' : 'none'
      }
    }

    // Bulk send to stock
    async function bulkSendToStock() {
      if (selectedStocks.size === 0) {
        showToast('กรุณาเลือกสินค้าที่ต้องการส่ง', 'warning');
        return;
      }
      
      customConfirm(`ยืนยันการส่งสินค้า ${selectedStocks.size} รายการไปยังฝ่ายสต็อก?`, async () => {
        try {
          // Rate limit check
          if (!RateLimiter.check('update_action')) return;
          
          const stockIds = Array.from(selectedStocks);
          const userInfo = await getCurrentUserInfo();
          
          // Update each stock with pending status (NOT verified)
          const promises = stockIds.map(stockId => 
            secureFetch(`/api/branch-stock/${stockId}`, {
              method: 'PATCH','
              headers: {
                'Content-Type': 'application/json''
              },
              body: JSON.stringify({ 
                sent_to_stock: true,  // ตั้งเป็น true เมื่อส่งไปฝ่ายสต็อก
                pending: true,  // ตั้งเป็น pending แทน verified
                verified: false, // ต้องรอการอนุมัติจากฝ่ายสต็อก
                sent_by: userInfo.userId,
                sent_by_name: userInfo.userName,
                sent_at: new Date().toISOString()
              })
            })
          );
          
          const results = await Promise.all(promises);
          const successCount = results.filter(r => r.ok).length;
          
          // Audit log
          createAuditLog('BULK_SEND_TO_STOCK', {'
            stockCount: stockIds.length,
            successCount: successCount,
            branch: document.getElementById('branchSelect').value'
          });
          
          showToast(`ส่งสินค้า ${successCount}/${stockIds.length} รายการไปยังฝ่ายสต็อกเรียบร้อย`, 'success');
          
          // Clear selection
          selectedStocks.clear();
          updateSelectedCount();
          
          // ส่ง socket event พร้อมข้อมูลที่ละเอียดขึ้น
          if (socket && socket.connected) {
            socket.emit('stockSentForApproval', {'
              stockIds: stockIds,
              branchCode: document.getElementById('branchSelect').value,'
              sentBy: userInfo.userId,
              sentByName: userInfo.userName,
              timestamp: new Date().toISOString()
            });
          }
          
          // Reload stock
          loadStock();
          
        } catch (err) {
          showToast('Error sending to stock: ' + err.message, 'error');
          
          // Audit log for error
          createAuditLog('ERROR_BULK_SEND_TO_STOCK', {'
            error: err.message,
            stockCount: selectedStocks.size
          });
        }
      });
    }

    // Custom confirm dialog
    function customConfirm(message, onConfirm) {
      const dialog = document.createElement('div');
      dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
      dialog.innerHTML = `
        <div class="modal-box">
          <h3 class="text-lg font-bold mb-4">ยืนยันการดำเนินการ</h3>
          <p class="mb-4">${message}</p>
          <div class="modal-action">
            <button onclick="this.closest('.fixed').remove()" class="btn btn-ghost">ยกเลิก</button>'
            <button class="btn btn-primary confirm-btn">ยืนยัน</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dialog);
      
      dialog.querySelector('.confirm-btn').addEventListener('click', () => {'
        dialog.remove();
        onConfirm();
      });
    }

    // เพิ่ม function สำหรับแสดง alert แบบละเอียด
    function customAlert(message, type = 'info') {'
      const existingAlert = document.querySelector('.custom-alert-modal');
      if (existingAlert) existingAlert.remove();
      
      const alertModal = document.createElement('div');
      alertModal.className = 'custom-alert-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
      
      const iconClass = type === 'warning' ? 'bi-exclamation-triangle-fill text-yellow-500' : '
                       type === 'error' ? 'bi-x-circle-fill text-red-500' : '
                       'bi-info-circle-fill text-blue-500'
      
      alertModal.innerHTML = `
        <div class="modal-box max-w-md">
          <div class="flex items-start gap-3">
            <i class="bi ${iconClass} text-2xl flex-shrink-0 mt-1"></i>
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-2">แจ้งเตือน</h3>
              <pre class="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300">${message}</pre>
            </div>
          </div>
          <div class="modal-action mt-4">
            <button onclick="this.closest('.custom-alert-modal').remove()" '
                    class="btn btn-primary">
              ตกลง
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(alertModal);
    }

    // ==================== END EVENT HANDLERS ====================

    // ==================== HELPER FUNCTIONS ====================
    
    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const mainHeader = document.getElementById('mainHeader');
      const toggleIcon = document.getElementById('toggleIcon');
      
      sidebar.classList.toggle('-translate-x-full');
      mainContent.classList.toggle('ml-0');
      mainContent.classList.toggle('ml-56');
      
      if (mainHeader) {
        mainHeader.classList.toggle('ml-0');
        mainHeader.classList.toggle('ml-56');
      }
      
      // Update icon
      if (sidebar.classList.contains('-translate-x-full')) {'
        toggleIcon.classList.remove('bi-x');
        toggleIcon.classList.add('bi-list');
      } else {
        toggleIcon.classList.remove('bi-list');
        toggleIcon.classList.add('bi-x');
      }
    }

    // Switch tab
    function switchTab(tabName) {
      Logger.info('Switching to tab:', tabName);
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {'
        btn.classList.remove('tab-active');
      });
      const targetTab = document.getElementById(`tab-${tabName}`);
      if (targetTab) {
        targetTab.classList.add('tab-active');
      }
      
      // Show/hide content
      const unverifiedContent = document.getElementById('content-unverified');
      const verifiedContent = document.getElementById('content-verified');
      
      if (unverifiedContent) {
        if (tabName === 'unverified') {'
          unverifiedContent.classList.remove('hidden');
          unverifiedContent.style.display = 'block'
        } else {
          unverifiedContent.classList.add('hidden');
          unverifiedContent.style.display = 'none'
        }
      }
      
      if (verifiedContent) {
        if (tabName === 'verified') {'
          verifiedContent.classList.remove('hidden');
          verifiedContent.style.display = 'block'
        } else {
          verifiedContent.classList.add('hidden');
          verifiedContent.style.display = 'none'
        }
      }
      
      // Audit log for tab switch
      createAuditLog('TAB_SWITCH', {'
        tab: tabName,
        branch: document.getElementById('branchSelect').value'
      });
      
      // Load appropriate data
      if (tabName === 'verified') {'
        loadVerifiedHistory();
      } else {
        loadStock();
      }
    }

         // ==================== END HELPER FUNCTIONS ====================

    // ==================== INITIALIZATION ====================
    
    // Clear failed audit logs on page load
    function clearFailedAuditLogs() {
      localStorage.removeItem('failedAuditLogs');
      console.log('Cleared failed audit logs');
    }
    
    // DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async function() {'
      const pageLoaderId = LoadingSystem.show({
        message: 'กำลังโหลดหน้าเว็บ...','
        showProgress: true,
        autoProgress: true,
        spinnerType: 'default''
      
      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        LoadingSystem.completeProgress();
      }});
      
      try {
      Logger.info('Initializing Add New Product page...');
      
      try {
        // Clear failed audit logs to prevent infinite retry
        clearFailedAuditLogs();
        
        // Check authentication
        const token = localStorage.getItem('authToken');
        if (!token) {
          window.location.href = '../login.html'
          return;
        }
        
        // Initialize CSRF token
        if (!localStorage.getItem('csrfToken')) {'
          generateCSRFToken();
        }
        
        // Reset session timeout
        resetSessionTimeout();
        
        // Comment out retry failed audit logs to prevent errors
        // setTimeout(() => retryFailedAuditLogs(), 5000);
        
        // Load initial data
        await Promise.all([
          loadBranchInfo(),
          loadBranches(),
          loadProductImages(),
          loadSuppliers(),
          getCurrentUserInfo()
        ]);
        
        // Setup event listeners
        
        // Barcode input
        const barcodeInput = document.getElementById('barcodeInput');
        if (barcodeInput) {
          barcodeInput.addEventListener('keypress', (e) => {'
            if (e.key === 'Enter') {'
              handleBarcodeScan(e.target.value);
              e.target.value = ''; // Clear after scan'
            }
          });
        }
        
        // Manual barcode button
        const btnAddManualCode = document.getElementById('btnAddManualCode');
        if (btnAddManualCode) {
          btnAddManualCode.addEventListener('click', () => {'
            const manualBarcode = document.getElementById('manualBarcode');
            if (manualBarcode && manualBarcode.value.trim()) {
              handleBarcodeScan(manualBarcode.value);
              manualBarcode.value = ''; // Clear input after scan'
            } else {
              showToast('กรุณากรอกเลขบาร์โค้ด', 'warning');
            }
          });
        }
        
        // Manual barcode input - handle Enter key
        const manualBarcodeInput = document.getElementById('manualBarcode');
        if (manualBarcodeInput) {
          manualBarcodeInput.addEventListener('keypress', (e) => {'
            if (e.key === 'Enter') {'
              e.preventDefault();
              if (manualBarcodeInput.value.trim()) {
                handleBarcodeScan(manualBarcodeInput.value);
                manualBarcodeInput.value = ''; // Clear input after scan'
              } else {
                showToast('กรุณากรอกเลขบาร์โค้ด', 'warning');
              }
            }
          });
        }
        
        // Scan barcode button
        const btnScanBarcode = document.getElementById('btnScanBarcode');
        if (btnScanBarcode) {
          btnScanBarcode.addEventListener('click', () => {'
            // Show scan status and focus on hidden input
            const scanStatus = document.getElementById('scanStatus');
            if (scanStatus) {
              scanStatus.classList.remove('hidden');
            }
            
            // Focus on hidden barcode input
            if (barcodeInput) {
              barcodeInput.focus();
              showToast('พร้อมสแกนบาร์โค้ด กรุณาสแกนบาร์โค้ดของสินค้า', 'info');
            }
            
            // Auto hide scan status after 30 seconds
            setTimeout(() => {
              if (scanStatus) {
                scanStatus.classList.add('hidden');
              }
            }, 30000);
          });
        }
        
        // Modal buttons - COMMENTED OUT (Modal no longer used)
        /*
        const sendToStockBtn = document.getElementById('sendToStockBtn');
        if (sendToStockBtn) {
          sendToStockBtn.addEventListener('click', sendToStock);
        }
        
        const cancelManualEntry = document.getElementById('cancelManualEntry');
        if (cancelManualEntry) {
          cancelManualEntry.addEventListener('click', () => {'
            const modal = document.getElementById('barcodeModalToggle');
            if (modal) modal.checked = false;
          });
        }
        
        const confirmManualEntry = document.getElementById('confirmManualEntry');
        if (confirmManualEntry) {
          confirmManualEntry.addEventListener('click', () => {'
            const modal = document.getElementById('barcodeModalToggle');
            if (modal) modal.checked = false;
            // Send scanned products to stock
            if (scannedProducts.length > 0) {
              sendToStock();
            }
          });
        }
        */
        
        // Date filters
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        if (dateFrom) {
          dateFrom.addEventListener('change', () => {'
            if (document.querySelector('.tab-active').id === 'tab-verified') {'
              loadVerifiedHistory();
            }
          });
        }
        if (dateTo) {
          dateTo.addEventListener('change', () => {'
            if (document.querySelector('.tab-active').id === 'tab-verified') {'
              loadVerifiedHistory();
            }
          });
        }
        
        // Tab buttons
        document.getElementById('tab-unverified').addEventListener('click', () => switchTab('unverified'));
        document.getElementById('tab-verified').addEventListener('click', () => switchTab('verified'));
        
        // Bulk send button
        const bulkSendBtn = document.getElementById('bulkSendBtn');
        if (bulkSendBtn) {
          bulkSendBtn.addEventListener('click', bulkSendToStock);
        }
        
        // Send to stock button (for selected items)
        const btnSendToStock = document.getElementById('btnSendToStock');
        if (btnSendToStock) {
          btnSendToStock.addEventListener('click', bulkSendToStock);
        }
        
        // Select all button
        const btnSelectAll = document.getElementById('btnSelectAll');
        if (btnSelectAll) {
          btnSelectAll.addEventListener('click', () => {'
            document.querySelectorAll('.stock-checkbox:not(:disabled)').forEach(cb => {'
              cb.checked = true;
              selectedStocks.add(cb.dataset.stockId);
            });
            document.querySelectorAll('.pending-checkbox').forEach(cb => {'
              cb.checked = true;
              selectedStocks.add(cb.dataset.stockId);
            });
            updateSelectedCount();
          });
        }
        
        // Deselect all button
        const btnDeselectAll = document.getElementById('btnDeselectAll');
        if (btnDeselectAll) {
          btnDeselectAll.addEventListener('click', () => {'
            document.querySelectorAll('.stock-checkbox').forEach(cb => {'
              cb.checked = false;
              selectedStocks.delete(cb.dataset.stockId);
            });
            document.querySelectorAll('.pending-checkbox').forEach(cb => {'
              cb.checked = false;
              selectedStocks.delete(cb.dataset.stockId);
            });
            selectedStocks.clear();
            updateSelectedCount();
          });
        }
        
        // Initialize sidebar (if sidebar.js is loaded)
        if (typeof initializeSidebar === 'function') {'
          initializeSidebar();
        }
        
        // Set default dates for verified tab
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        if (dateFrom) dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
        if (dateTo) dateTo.value = today.toISOString().split('T')[0];
        
        // Check DOM elements
        console.log('🔍 Checking DOM elements:');
        console.log('  - stockContainer:', !!document.getElementById('stockContainer'));
        console.log('  - verifiedContainer:', !!document.getElementById('verifiedContainer'));
        console.log('  - branchSelect:', !!document.getElementById('branchSelect'));
        console.log('  - branchSelect value:', document.getElementById('branchSelect')?.value);
        console.log('  - Active tab:', document.querySelector('.tab-active')?.id);
        
        Logger.info('Page initialization complete');
        
        // Comment out audit log for page access to prevent errors
        // createAuditLog('PAGE_ACCESS', {'
        //   page: 'addNewProduct_pattani','
        //   branch: BRANCH_CODE
        // });
        
      } catch (err) {
        Logger.error('Initialization error:', err);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
      }
    });

    // ==================== END INITIALIZATION ====================

    // Test function to check all stocks
    window.testLoadAllStocks = async function() {
      console.log('🧪 Testing: Loading ALL stocks without filter...');
      try {
        const branchCode = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        const token = localStorage.getItem('authToken');
        
        // Load ALL stocks without any filter
        const res = await fetch(`/api/branch-stock?branch_code=${branchCode}`, {
          headers: {
            'Authorization': 'Bearer ' + token'
          }
        });
        
        const result = await res.json();
        console.log('🧪 Test Result - All stocks:', result);
        
        if (result.data) {
          console.log('🧪 Total stocks found:', result.data.length);
          
          // Filter iPhone stocks
          const iPhoneStocks = result.data.filter(s => s.name && s.name.includes('iPhone'));
          console.log('🧪 iPhone stocks found:', iPhoneStocks.length);
          console.log('🧪 iPhone stocks details:', iPhoneStocks);
          
          // Check unverified stocks
          const unverifiedStocks = result.data.filter(s => 
            s.pending !== true && s.verified !== true
          );
          console.log('🧪 Unverified stocks:', unverifiedStocks.length);
          console.log('🧪 Unverified stocks details:', unverifiedStocks);
        }
      } catch (err) {
        console.error('🧪 Test error:', err);
      }
    };
    
    // Debug function to show all stocks with specific conditions
    window.debugShowAllStocks = async function() {
      console.log('🐛 Debug: Checking all stocks in the system...');
      try {
        const branchCode = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        const token = localStorage.getItem('authToken');
        
        // Try multiple API calls with different parameters
        const endpoints = [
          `/api/branch-stock?branch_code=${branchCode}`,
          `/api/branch-stock?branch_code=${branchCode}&pending=false`,
          `/api/branch-stock?branch_code=${branchCode}&verified=false`,
          `/api/branch-stock?branch_code=${branchCode}&include_unverified=1`,
          `/api/branch-stock?branch_code=${branchCode}&include_all=1`
        ];
        
        for (const endpoint of endpoints) {
          console.log(`\n🔍 Testing endpoint: ${endpoint}`);
          const res = await fetch(endpoint, {
            headers: { 'Authorization': 'Bearer ' + token }'
          });
          
          if (res.ok) {
            const result = await res.json();
            if (result.data && result.data.length > 0) {
              console.log(`✅ Found ${result.data.length} stocks`);
              
              // Show iPhone 13 stocks specifically
              const iPhone13Stocks = result.data.filter(s => s.name && s.name.includes('iPhone 13'));
              if (iPhone13Stocks.length > 0) {
                console.log(`📱 Found ${iPhone13Stocks.length} iPhone 13 stocks:`);
                iPhone13Stocks.forEach(stock => {
                  console.log(`  - ${stock.name}:`, {
                    id: stock._id,
                    pending: stock.pending,
                    verified: stock.verified,
                    sent_to_stock: stock.sent_to_stock,
                    created_at: stock.created_at
                  });
                });
              }
            } else {
              console.log('❌ No stocks found');
            }
          } else {
            console.error('❌ API call failed:', res.status);
          }
        }
      } catch (err) {
        console.error('🐛 Debug error:', err);
      }
    };
    
    console.log('💡 Debug functions available: debugShowAllStocks()');
    
    // Add test function to window for easy access
    console.log('💡 Test function available: testLoadAllStocks()');
    
    // Force reload stock with cache bypass
    window.forceReloadStock = async function() {
      console.log('🔄 Force reloading stock with cache bypass...');
      try {
        const branchCode = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        const token = localStorage.getItem('authToken');
        
        // Clear any cached data
        sessionStorage.removeItem('stockData');
        
        // Add timestamp and random number to force cache bypass
        const timestamp = new Date().getTime();
        const random = Math.random();
        const url = `/api/branch-stock?branch_code=${branchCode}&include_unverified=1&include_all=1&_=${timestamp}&r=${random}`;
        
        console.log('🌐 Fetching from:', url);
        
        const res = await fetch(url, {
          headers: {
            'Authorization': 'Bearer ' + token,'
            'Cache-Control': 'no-cache','
            'Pragma': 'no-cache''
          },
          cache: 'no-store''
        });
        
        const result = await res.json();
        console.log('📦 Force reload result:', {'
          success: result.success,
          dataCount: result.data ? result.data.length : 0,
          data: result.data
        });
        
        if (result.data && result.data.length > 0) {
          // Show all stocks
          console.log('📋 All stocks:');
          result.data.forEach((stock, i) => {
            console.log(`${i+1}. ${stock.name} - Barcode: ${stock.barcode}, IMEI: ${stock.imei}, Status: pending=${stock.pending}, verified=${stock.verified}, sent_to_stock=${stock.sent_to_stock}`);
          });
          
          // Show unverified stocks
          const unverified = result.data.filter(s => s.verified !== true);
          console.log(`\n📌 Unverified stocks (${unverified.length} items):`);
          unverified.forEach((stock, i) => {
            console.log(`${i+1}. ${stock.name} - Created: ${stock.created_at}`);
          });
        }
        
        // Reload the UI
        await loadStock();
        
      } catch (err) {
        console.error('❌ Force reload error:', err);
      }
    };
    
    // Debug function to manually add test stock
    window.addTestStock = async function(productName = 'iPhone 13') {'
      console.log('🧪 Adding test stock...');
      try {
        const branchCode = document.getElementById('branchSelect')?.value || BRANCH_CODE;
        const token = localStorage.getItem('authToken');
        const userInfo = await getCurrentUserInfo();
        
        // Generate unique barcode and IMEI
        const timestamp = Date.now();
        const testBarcode = `TEST${timestamp}`;
        const testIMEI = `${timestamp}123456789012345`;
        
        const testData = {
          branch_code: branchCode,
          barcode: testBarcode,
          sku: `SKU-${timestamp}`,
          imei: testIMEI,
          name: productName,
          price: 29900,
          brand: 'Apple','
          model: '13','
          category: 'Smartphone','
          stockType: 'imei','
          supplier: 'Test Supplier','
          scanned_by: userInfo.userId,
          scanned_by_name: userInfo.userName,
          updated_by: userInfo.userId,
          stock_value: 0,
          created_at: new Date().toISOString()
        };
        
        console.log('📤 Sending test data:', testData);
        
        const res = await fetch('/api/branch-stock', {'
          method: 'POST','
          headers: {
            'Content-Type': 'application/json','
            'Authorization': 'Bearer ' + token'
          },
          body: JSON.stringify(testData)
        });
        
        const result = await res.json();
        console.log('📥 Create result:', result);
        
        if (result.success) {
          console.log('✅ Test stock created successfully!');
          // Force reload to see the new item
          await forceReloadStock();
        } else {
          console.error('❌ Failed to create test stock:', result.error);
        }
        
      } catch (err) {
        console.error('❌ Error adding test stock:', err);
      }
    };
    
    console.log('💡 Debug functions available:');
    console.log('  - forceReloadStock() : Force reload all stock data with cache bypass');
    console.log('  - addTestStock() : Add a test iPhone 13 stock item');
    console.log('  - addTestStock("Product Name") : Add test stock with custom name');
    
    function checkConnection() {
      // Use a more flexible check for production environment
      if (window.location.hostname === 'localhost' || window.location.hostname.endsWith('2pheenong.com')) {
        console.log('Connection check passed');
      } else {
        // ... existing code ...
      }
    }
  
}</script>
</body>
</html>
