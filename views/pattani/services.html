<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</title>

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="../js/activity-tracker.js"></script>
    <script src="/js/branch-navigation.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
    <!-- (1) ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS CDN ‡∏Å‡πà‡∏≠‡∏ô -->
    <script src="https://cdn.tailwindcss.com"></script>
    

    <!-- (2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Tailwind ‡πÅ‡∏•‡∏∞ DaisyUI -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>

    <!-- DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Firebase Realtime Database Enhanced -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import { getDatabase, ref, onValue, set, push, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
        authDomain: "pheenongacc.firebaseapp.com",
        databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pheenongacc",
        storageBucket: "pheenongacc.appspot.com",
        messagingSenderId: "158417807357",
        appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
        measurementId: "G-F7DPQ7XG9K"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      
      // Current session data
      const currentSession = {
        branchCode: window.BRANCH_CODE || new URLSearchParams(window.location.search).get('branch') || 'SERVICES',
        sessionId: 'SERVICES_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        staffId: localStorage.getItem('userId'),
        staffName: localStorage.getItem('userName'),
        timestamp: Date.now()
      };

      // Firebase References
      const servicesRef = ref(db, `services/${currentSession.branchCode}`);
      const sessionRef = ref(db, `services/${currentSession.branchCode}/sessions/${currentSession.sessionId}`);
      const customersRef = ref(db, `services/${currentSession.branchCode}/customers`);
      const notificationsRef = ref(db, `services/${currentSession.branchCode}/notifications`);
      const onlineUsersRef = ref(db, `services/${currentSession.branchCode}/onlineUsers`);

      // Connection status tracking
      let isFirebaseConnected = false;

      // Monitor Firebase connection
      const connectedRef = ref(db, '.info/connected');
      onValue(connectedRef, (snapshot) => {
        isFirebaseConnected = snapshot.val() === true;
        window.isFirebaseConnected = isFirebaseConnected;
        console.log('Firebase connection status:', isFirebaseConnected ? 'Connected' : 'Disconnected');
        
        if (isFirebaseConnected) {
          registerSession();
          setupOnDisconnect();
          console.log('Firebase connected successfully');
        } else {
          console.warn('Firebase connection lost');
        }
        
        // Update connection status display
        updateConnectionStatus();
      });

      // Register session
      async function registerSession() {
        try {
          await set(sessionRef, {
            ...currentSession,
            status: 'online',
            lastActivity: serverTimestamp(),
            userAgent: navigator.userAgent,
            connectedAt: serverTimestamp(),
            service: 'services'
          });
          
          // Add to online users
          await set(ref(db, `services/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`), {
            staffId: currentSession.staffId,
            staffName: currentSession.staffName,
            sessionId: currentSession.sessionId,
            connectedAt: serverTimestamp(),
            service: 'services'
          });
          
          console.log('Session registered to Firebase');
        } catch (error) {
          console.error('Failed to register session:', error);
        }
      }

      // Setup disconnect handlers
      function setupOnDisconnect() {
        onDisconnect(sessionRef).set({
          ...currentSession,
          status: 'offline',
          lastActivity: serverTimestamp(),
          disconnectedAt: serverTimestamp()
        });
        
        onDisconnect(ref(db, `services/${currentSession.branchCode}/onlineUsers/${currentSession.sessionId}`)).remove();
      }

      // Listen for service updates
      onValue(servicesRef, (snapshot) => {
        const services = snapshot.val();
        if (services && services.updates) {
          console.log('Service updates received from Firebase:', services.updates);
          
          // Refresh service data if needed
          if (typeof refreshServiceData === 'function') {
            refreshServiceData();
          }
        }
      });

      // Listen for customer updates
      onValue(customersRef, (snapshot) => {
        const customers = snapshot.val();
        if (customers) {
          console.log('Customer data updated from Firebase');
          
          // Update local customer cache
          if (window.customerCache) {
            window.customerCache = customers;
          }
        }
      });

      // Listen for notifications
      onValue(notificationsRef, (snapshot) => {
        const notifications = snapshot.val();
        if (notifications) {
          Object.entries(notifications).forEach(([key, notification]) => {
            if (notification.timestamp > (Date.now() - 60000)) { // Recent notifications (1 minute)
              console.log('New notification:', notification.message);
            }
          });
        }
      });

      // Listen for online users
      onValue(onlineUsersRef, (snapshot) => {
        const users = snapshot.val() || {};
        const onlineCount = Object.keys(users).length;
        console.log(`Online users in ${currentSession.branchCode}:`, onlineCount);
        
        // Update online user count display if element exists
        const onlineCountEl = document.getElementById('onlineUserCount');
        if (onlineCountEl) {
          onlineCountEl.textContent = onlineCount;
        }
      });

      // Make Firebase available globally
      window.firebaseApp = app;
      window.firebaseDB = db;
      window.firebaseRef = ref;
      window.firebaseSet = set;
      window.firebasePush = push;
      window.firebaseOnValue = onValue;
      window.firebaseServerTimestamp = serverTimestamp;
      window.firebaseEnabled = true;
      window.currentFirebaseSession = currentSession;

      // Function to update connection status
      function updateConnectionStatus() {
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) {
          if (isFirebaseConnected) {
            statusEl.className = 'connection-status online text-xs font-medium';
            statusEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
          } else {
            statusEl.className = 'connection-status offline text-xs font-medium';
            statusEl.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
          }
        }
      }

      window.updateConnectionStatus = updateConnectionStatus;
      
      console.log('Firebase Realtime Database initialized for Services module');
    </script>

    <!-- Socket.IO -->
    <script src="/socket.io.min.js"></script>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

  <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

    <style>
      :root {
        --primary-color: #0d6efd;
        --primary-hover: #138af2;
        --bg-color: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --transition-speed: 0.3s;
      }
      .dark {
        --primary-color: #ff8800;
        --primary-hover: #ffa733;
        --bg-color: #2a2a2a;
        --text-color: #ffffff;
        --border-color: #555555;
      }
           .bubble h6 {
        font-size: 0.875rem;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
      }
      #btnToggleMenu {
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢ Toggle Sidebar (‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
      }
      .bubble {
        width: 110px;
        height: 130px;
        border-radius: 0.75rem;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform var(--transition-speed);
        background-color: var(--primary-color);
        position: relative;
      }
      .bubble:hover {
        transform: scale(1.05);
        background-color: var(--primary-hover);
      }
      .bubble h6 {
    font-size: 0.875rem;
    font-weight: 600;
    white-space: normal; /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    word-wrap: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
    margin: 0;
}
      .stock-count {
        position: absolute;
        bottom: 0.5rem;
        font-size: 0.75rem;
      }
      .card {
        background-color: var(--bg-color) !important;
        color: var(--text-color) !important;
        border-color: var(--border-color) !important;
      }
      .lightOnly {
        display: block;
      }
      .darkOnly {
        display: none;
      }
      .dark .lightOnly {
        display: none !important;
      }
      .dark .darkOnly {
        display: block !important;
      }
      .dark .dark-bg {
        background-color: var(--bg-color);
      }
      .dark .dark-text {
        color: var(--primary-color);
      }
      /* ===== Flip Card ===== */
      .flip-card {
        perspective: 1000px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 0.75rem;
        width: 200px;
        height: 420px;
      }
      .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.4s ease-in-out;
        transform-style: preserve-3d;
      }
      .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
      }
      .flip-card-front,
      .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 0.5rem;
      }
      .flip-card-back {
        transform: rotateY(180deg);
        background-color: var(--bg-color);
      }
      .product-price-big {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
      }
      .product-img {
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 0.25rem;
      }
      .product-name {
  position: absolute;
  top: 48%;
  left: 0.5rem; /* ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ left: 50%; transform: translateX(-50%) ‡∏Å‡πá‡πÑ‡∏î‡πâ */
  font-weight: 800;
}
#sidebar ul li a {
  color: #333333 !important; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
}

h6 {
    white-space: normal; /* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
    word-wrap: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
    overflow: visible; /* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
}
    #sidebar ul li a.active span,
    #sidebar ul li a.active i {
      color: #fff !important;
    }

    /* Loading overlay */
        [data-theme="dark"]     .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e2e8f0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    </style>
  
  </style>

  <script>
    // New Lottie Loading State with State Management (same as addNewProduct_pattani.html)
    let loadingCount = 0; // Track loading state to prevent multiple overlays
    let lottieAnimation = null;

    // Initialize Lottie animation
    function initLottieLoading() {
      const container = document.getElementById('lottieContainer');
      if (!container || lottieAnimation) return;

      try {
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: 'svg',
          loop: true,
          autoplay: false,
          path: '/Loading/Loading.json'
        });
      } catch (error) {
        console.warn('Lottie animation failed to load, using fallback:', error);
        container.innerHTML = '<div class="loading loading-lg"></div>';
      }
    }

    // Show/Hide loading with state management
    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');

      if (show) {
        loadingCount++;
        if (loadingCount === 1) { // Only show when first request
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      } else {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) { // Only hide when all requests complete
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');

          setTimeout(() => {
            if (loadingCount === 0) {
              loader.style.display = 'none';
              if (lottieAnimation) {
                lottieAnimation.stop();
              }
            }
          }, 500);
        }
      }
    }

    // Safe functions for backward compatibility
    function safeShowLoading(show, message) {
      showLoading(show);
    }

    function safeHideLoading() {
      showLoading(false);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initLottieLoading();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
    });
  </script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Loading Overlay CSS (Updated from addNewProduct_pattani.html) -->
  <style>
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }

    /* Loading spinner for fallback */
    .loading {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    .loading-lg {
      width: 2.5rem;
      height: 2.5rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

  <body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>

        </div>

    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <div class="flex min-h-screen">
      <!-- Main Content -->
      <div
        id="mainContent"
        class="flex-1 flex flex-col ml-64 transition-all duration-300 ease-in-out"
      >
        <header class="p-4 bg-white dark:bg-gray-800"
                         border-b border-gray-200 dark:border-gray-700
"
                         flex items-center justify-between"
                         id="mainHeader">
          <div>
            <h1 class="text-lg font-semibold" id="pageTitle">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h1>
            <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
            </p>
          </div>
          
          <!-- Real-time Connection Status -->
          <div class="flex items-center space-x-2">
            <!-- Firebase Status -->
            <div class="flex items-center space-x-1" id="firebaseStatus">
              <div class="w-2 h-2 rounded-full bg-gray-400" id="firebaseIndicator"></div>
              <span class="text-xs text-gray-500" id="firebaseLabel">Firebase</span>
            </div>
            
            <!-- Socket.IO Status -->
            <div class="flex items-center space-x-1" id="socketStatus">
              <div class="w-2 h-2 rounded-full bg-gray-400" id="socketIndicator"></div>
              <span class="text-xs text-gray-500" id="socketLabel">Socket.IO</span>
            </div>
            
            <!-- Real-time Activity Badge -->
            <div class="hidden" id="realtimeActivity">
              <span class="badge badge-xs badge-info animate-pulse">üîÑ Live</span>
            </div>
          </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 bg-gray-50 dark:bg-gray-900 transition-all duration-300">
          <!-- Page Header -->
          <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏Å‡∏±‡∏ô‡∏£‡∏≠‡∏¢</h1>
            <p class="text-gray-600 dark:text-gray-300 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
          </div>

          <!-- Service Tabs Navigation -->
          <div class="tabs tabs-boxed bg-gray-100 dark:bg-gray-800 mb-6">
            <a class="tab tab-active" id="tabFilm" onclick="switchServiceTab('film')">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°</a>
            <a class="tab" id="tabDevice" onclick="switchServiceTab('device')">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</a>
          </div>

          <!-- Service Cards Container -->
          <div id="serviceCardsContainer">
            <!-- Film Service Cards -->
            <div id="filmServiceCards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <h2 class="text-2xl font-bold text-gray-800 dark:text-white col-span-full mb-2">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏Å‡∏±‡∏ô‡∏£‡∏≠‡∏¢</h2>
              
              <!-- Phone Film Warranty Card -->
              <div class="card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center mb-4">
                  <i class="bi bi-phone text-3xl text-blue-500 mr-3"></i>
                  <h2 class="text-xl font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h2>
                </div>
                <div class="space-y-2 mb-4">
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡πÜ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                  <p class="flex items-center"><i class="bi bi-info-circle text-blue-500 mr-2"></i> <span class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÅ‡∏ï‡∏Å ‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏£‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô</p>
                </div>
                <button class="btn btn-primary w-full" onclick="openServiceForm('phone-film')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
              </div>
              
              <!-- iPad Film Warranty Card -->
              <div class="card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center mb-4">
                  <i class="bi bi-tablet text-3xl text-orange-500 mr-3"></i>
                  <h2 class="text-xl font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏≠‡πÅ‡∏û‡∏î</h2>
                </div>
                <div class="space-y-2 mb-4">
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡πÜ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                  <p class="flex items-center"><i class="bi bi-info-circle text-blue-500 mr-2"></i> <span class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÅ‡∏ï‡∏Å ‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏£‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô</p>
                </div>
                <button class="btn btn-primary w-full" onclick="openServiceForm('ipad-film')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
              </div>
            </div>

            <!-- Device Service Cards - Hidden by default -->
            <div id="deviceServiceCards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden">
              <h2 class="text-2xl font-bold text-gray-800 dark:text-white col-span-full mb-2">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
              
              <!-- Phone Device Warranty Card -->
              <div class="card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center mb-4">
                  <i class="bi bi-phone-fill text-3xl text-purple-500 mr-3"></i>
                  <h2 class="text-xl font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</h2>
                </div>
                <div class="space-y-2 mb-4">
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏ã‡πà‡∏≠‡∏°‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-info-circle text-blue-500 mr-2"></i> <span class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                </div>
                <button class="btn btn-secondary w-full" onclick="openServiceForm('phone-warranty')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
              </div>
              
              <!-- iPad Device Warranty Card -->
              <div class="card bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center mb-4">
                  <i class="bi bi-tablet-fill text-3xl text-pink-500 mr-3"></i>
                  <h2 class="text-xl font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡πÅ‡∏û‡∏î</h2>
                </div>
                <div class="space-y-2 mb-4">
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥</p>
                  <p class="flex items-center"><i class="bi bi-check-circle text-green-500 mr-2"></i> ‡∏ã‡πà‡∏≠‡∏°‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏µ</p>
                  <p class="flex items-center"><i class="bi bi-info-circle text-blue-500 mr-2"></i> <span class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                </div>
                <button class="btn btn-secondary w-full" onclick="openServiceForm('ipad-warranty')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</button>
              </div>
            </div>
          </div>

          <!-- Service Form Modal -->
          <div id="serviceFormModal" class="modal">
            <div class="modal-box w-full max-w-2xl">
              <h3 class="font-bold text-lg mb-4" id="serviceFormTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
              <form id="serviceForm" class="space-y-4">
                <input type="hidden" id="deviceType" name="deviceType" value="">
                <input type="hidden" id="serviceType" name="serviceType" value="">
                
                <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                  </label>
                  <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg" id="serviceTypeDisplay">
                    ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                  </div>
                </div>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
                <div class="form-control mb-2">
                  <label class="label">
                    <span class="label-text font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                  </label>
                  <div class="flex flex-col md:flex-row gap-2">
                    <div class="flex-grow">
                      <input type="text" id="customerSearch" class="input input-bordered w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô">
                    </div>
                    <button type="button" class="btn btn-primary whitespace-nowrap" onclick="searchCustomer()">
                      <i class="bi bi-search mr-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                  </div>
                  <div id="searchResults" class="mt-2 hidden">
                    <select id="customerSelect" class="select select-bordered w-full">
                      <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
                      <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                    </select>
                  </div>
                </div>

                <div class="divider">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                  </label>
                  <input type="text" id="customerName" name="customerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="input input-bordered w-full" required>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span>
                  </label>
                  <input type="tel" id="customerPhone" name="customerPhone" placeholder="0xx-xxx-xxxx" class="input input-bordered w-full" pattern="[0-9]{10}" maxlength="10" required>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span>
                  </label>
                  <input type="text" id="customerID" name="customerID" placeholder="x-xxxx-xxxxx-xx-x" class="input input-bordered w-full" pattern="[0-9]{13}" maxlength="13">
                </div>

                <div class="divider">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>
                    </label>
                    <input type="date" id="warrantyDate" name="warrantyDate" class="input input-bordered w-full" required>
                  </div>
                  
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                    </label>
                    <input type="date" id="serviceDate" name="serviceDate" class="input input-bordered w-full" required>
                  </div>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                  </label>
                  <select id="deviceModel" name="deviceModel" class="select select-bordered w-full" required>
   <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>
 </select>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                  </label>
                  <select id="serviceReason" name="serviceReason" class="select select-bordered w-full" required>
                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <!-- ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡πå‡∏° -->
                    <optgroup label="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏¥‡∏•‡πå‡∏°" id="filmReasonGroup">
                      <option value="‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÅ‡∏ï‡∏Å">‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÅ‡∏ï‡∏Å</option>
                      <option value="‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏£‡πâ‡∏≤‡∏ß">‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏£‡πâ‡∏≤‡∏ß</option>
                      <option value="‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô">‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô</option>
                      <option value="‡∏ü‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">‡∏ü‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
                    </optgroup>
                    <!-- ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
                    <optgroup label="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" id="warrantyReasonGroup">
                      <option value="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ï‡∏Å">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ï‡∏Å</option>
                      <option value="‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°">‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°</option>
                      <option value="‡πÇ‡∏î‡∏ô‡∏ô‡πâ‡∏≥">‡πÇ‡∏î‡∏ô‡∏ô‡πâ‡∏≥</option>
                      <option value="‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î</option>
                      <option value="‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏î‡∏±‡∏á">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏î‡∏±‡∏á</option>
                    </optgroup>
                    <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                  </select>
                </div>

                <div id="otherReasonContainer" class="form-control hidden">
                  <label class="label">
                    <span class="label-text">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)</span>
                  </label>
                  <input type="text" id="otherReason" name="otherReason" class="input input-bordered w-full">
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                  </label>
                  <select id="branchLocation" name="branchLocation" class="select select-bordered w-full" required disabled>
                    <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢ JavaScript -->
                  </select>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                  </label>
                  <select id="serviceStaff" name="serviceStaff" class="select select-bordered w-full" disabled>
                    <option>Loading...</option>
                  </select>
                </div>
                
                <div class="form-control">
                  <label class="label">
                    <span class="label-text">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                  </label>
                  <textarea id="serviceNotes" name="serviceNotes" class="textarea textarea-bordered w-full" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>
                
                <div class="modal-action">
                  <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                  <button type="button" class="btn btn-outline" onclick="closeServiceForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Service History Section -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
              
              <div class="flex gap-2">
                <div class="form-control max-w-xs">
                  <div class="input-group">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="input input-bordered w-full max-w-xs" />
                    <button class="btn btn-square">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
                
                <select id="filterDevice" class="select select-bordered">
                  <option value="all">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="phone">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option>
                  <option value="ipad">‡πÑ‡∏≠‡πÅ‡∏û‡∏î</option>
                </select>

                <select id="filterServiceType" class="select select-bordered">
                  <option value="all">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="film">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°</option>
                  <option value="warranty">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
                </select>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="table w-full table-zebra">
                <thead>
                  <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                    <th>‡∏£‡∏∏‡πà‡∏ô</th>
                    <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="serviceHistoryTable">
                  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
                  <tr>
                    <td colspan="10" class="text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Customer Detail Modal -->
          <div id="customerDetailModal" class="modal">
            <div class="modal-box w-full max-w-3xl">
              <h3 class="font-bold text-lg mb-4" id="customerDetailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
              <div id="customerDetailContent" class="space-y-4">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢ JavaScript -->
              </div>
              <div class="modal-action">
                <button class="btn btn-primary" onclick="closeCustomerDetail()">‡∏õ‡∏¥‡∏î</button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- JavaScript for Service functionality -->
    <script>
      // API Configuration
      const API_ROOT = '/api';
      
      // Get branch code from localStorage
      // ‡∏≠‡πà‡∏≤‡∏ô branch_code ‡∏à‡∏≤‡∏Å URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

        if (!BRANCH_CODE) {
          console.warn("Branch code not specified, defaulting to 'PATTANI'");
          BRANCH_CODE = 'PATTANI';
        }
        window.currentBranchCode = BRANCH_CODE;
        console.log(`[services] Using branch code: ${BRANCH_CODE}`);
      
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó localStorage ‡πÅ‡∏•‡∏∞ title
        if (urlParams.has('branch')) {
          localStorage.setItem('activeBranch', BRANCH_CODE);
        }
      
        if (urlParams.has('name')) {
          document.title = `‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ - ${decodeURIComponent(urlParams.get('name'))}`;
        }

      // ===== FIREBASE & SOCKET.IO INTEGRATION =====
      
      // Firebase ‡πÅ‡∏•‡∏∞ Socket.IO Manager
      class RealtimeDataManager {
        constructor() {
          this.socket = null;
          this.firebaseListeners = new Map();
          this.isConnected = false;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 5;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Socket.IO ‡πÅ‡∏•‡∏∞ Firebase
        async initialize() {
          try {
            console.log('üîå Initializing real-time connections...');
      
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Socket.IO
            await this.initializeSocket();
      
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase listeners
            await this.initializeFirebaseListeners();
      
            console.log('‚úÖ Real-time connections initialized successfully');
      
          } catch (error) {
            console.error('‚ùå Failed to initialize real-time connections:', error);
          }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Socket.IO
        async initializeSocket() {
          return new Promise((resolve, reject) => {
            try {
              this.socket = io({
                transports: ['websocket', 'polling'],
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                maxHttpBufferSize: 1e8,
                pingTimeout: 60000,
                pingInterval: 25000
              });

              // Socket.IO Event Handlers
              this.socket.on('connect', () => {
                console.log('üîå Socket.IO connected:', this.socket.id);
                this.isConnected = true;
                this.reconnectAttempts = 0;
      
                // Update UI status
                this.onSocketConnected();
      
                // Join branch room for real-time updates
                this.socket.emit('join-branch', {
                  branchCode: BRANCH_CODE,
                  page: 'services',
                  timestamp: new Date().toISOString()
                });
      
                resolve();
              });

              this.socket.on('disconnect', (reason) => {
                console.warn('üîå Socket.IO disconnected:', reason);
                this.isConnected = false;
      
                // Update UI status
                this.onSocketDisconnected();
      
                if (reason === 'io server disconnect') {
                  // Server disconnected, try to reconnect
                  this.handleReconnection();
                }
              });

              this.socket.on('connect_error', (error) => {
                console.error('üîå Socket.IO connection error:', error);
                this.handleReconnection();
              });

              // Custom service events
              this.socket.on('service-updated', (data) => {
                console.log('üìã Service updated:', data);
                this.handleServiceUpdate(data);
              });

              this.socket.on('customer-updated', (data) => {
                console.log('üë§ Customer updated:', data);
                this.handleCustomerUpdate(data);
              });

              this.socket.on('branch-status', (data) => {
                console.log('üè¢ Branch status:', data);
                this.handleBranchStatus(data);
              });

              // Error handling
              this.socket.on('error', (error) => {
                console.error('üîå Socket.IO error:', error);
              });

              // Timeout fallback
              setTimeout(() => {
                if (!this.isConnected) {
                  console.warn('‚ö†Ô∏è Socket.IO connection timeout');
                  resolve(); // Don't reject, continue with Firebase only
                }
              }, 8000);

            } catch (error) {
              console.error('‚ùå Socket.IO initialization error:', error);
              resolve(); // Don't reject, continue without Socket.IO
            }
          });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase Realtime Database listeners
        async initializeFirebaseListeners() {
          try {
            if (!window.firebaseDB) {
              console.warn('‚ö†Ô∏è Firebase not available, skipping Firebase listeners');
              return;
            }

            console.log('üî• Setting up Firebase listeners...');

            // Update Firebase status to connected
            this.onFirebaseConnected();

            // Listen to service history changes
            const serviceHistoryRef = window.firebaseRef(window.firebaseDB, `branches/${BRANCH_CODE}/services`);
            const serviceHistoryListener = window.firebaseOnValue(serviceHistoryRef, (snapshot) => {
              const data = snapshot.val();
              if (data) {
                console.log('üî• Firebase service history updated:', Object.keys(data).length, 'records');
                this.handleFirebaseServiceUpdate(data);
                this.updateRealtimeActivity(true); // Show real-time activity
              }
            }, (error) => {
              console.error('üî• Firebase service history error:', error);
              this.onFirebaseDisconnected();
            });

            this.firebaseListeners.set('serviceHistory', {
              ref: serviceHistoryRef,
              listener: serviceHistoryListener
            });

            // Listen to customer data changes
            const customerRef = window.firebaseRef(window.firebaseDB, `customers`);
            const customerListener = window.firebaseOnValue(customerRef, (snapshot) => {
              const data = snapshot.val();
              if (data) {
                console.log('üî• Firebase customer data updated:', Object.keys(data).length, 'customers');
                this.handleFirebaseCustomerUpdate(data);
              }
            });

            this.firebaseListeners.set('customers', {
              ref: customerRef,
              listener: customerListener
            });

            // Listen to branch activity
            const branchActivityRef = window.firebaseRef(window.firebaseDB, `branches/${BRANCH_CODE}/activity`);
            const branchActivityListener = window.firebaseOnValue(branchActivityRef, (snapshot) => {
              const data = snapshot.val();
              if (data) {
                console.log('üî• Firebase branch activity updated:', data);
                this.handleFirebaseBranchActivity(data);
              }
            });

            this.firebaseListeners.set('branchActivity', {
              ref: branchActivityRef,
              listener: branchActivityListener
            });

            console.log('‚úÖ Firebase listeners setup complete');

          } catch (error) {
            console.error('‚ùå Firebase listeners setup error:', error);
            this.onFirebaseDisconnected();
          }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ reconnect
        handleReconnection() {
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
      
            console.log(`üîÑ Attempting reconnection ${this.reconnectAttempts}/${this.maxReconnectAttempts} in ${delay}ms`);
      
            setTimeout(() => {
              if (!this.isConnected) {
                this.socket.connect();
              }
            }, delay);
          } else {
            console.error('‚ùå Max reconnection attempts reached');
            showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Real-time ‡∏´‡∏•‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Refresh ‡∏´‡∏ô‡πâ‡∏≤', 'warning');
          }
        }

        // === SOCKET.IO EVENT HANDLERS ===

        handleServiceUpdate(data) {
          if (data.branchCode === BRANCH_CODE) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó service history ‡πÅ‡∏ö‡∏ö real-time
            this.syncServiceToFirebase(data);
            loadServiceHistory(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI
      
            // ‡πÅ‡∏™‡∏î‡∏á notification
            showNotification(`‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: ${data.customerName} - ${data.deviceModel}`, 'success');
          }
        }

        handleCustomerUpdate(data) {
          console.log('üë§ Customer data updated:', data);
          // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó customer search results ‡πÅ‡∏ö‡∏ö real-time
        }

        handleBranchStatus(data) {
          if (data.branchCode === BRANCH_CODE) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏ö‡∏ö real-time
            this.updateBranchStatusIndicator(data);
          }
        }

        // === FIREBASE EVENT HANDLERS ===

        handleFirebaseServiceUpdate(data) {
          // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase format ‡πÄ‡∏õ‡πá‡∏ô array
          const servicesArray = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          }));
      
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó global serviceHistory
          serviceHistory = servicesArray.filter(s => s.branchCode === BRANCH_CODE);
      
          // ‡∏£‡∏µ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á
          renderServiceHistory();
        }

        handleFirebaseCustomerUpdate(data) {
          console.log('üî• Customer data from Firebase:', data);
          // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cache customer data
        }

        handleFirebaseBranchActivity(data) {
          console.log('üî• Branch activity from Firebase:', data);
          this.updateActivityIndicator(data);
        }

        // === DATA SYNC TO FIREBASE ===

        async syncServiceToFirebase(serviceData) {
          try {
            if (!window.firebaseDB) return;

            const serviceRef = window.firebaseRef(
              window.firebaseDB,
              `branches/${BRANCH_CODE}/services/${serviceData.id || Date.now()}`
            );

            const firebaseData = {
              ...serviceData,
              timestamp: window.firebaseServerTimestamp(),
              lastUpdated: new Date().toISOString(),
              branchCode: BRANCH_CODE
            };

            await window.firebaseSet(serviceRef, firebaseData);
            console.log('‚úÖ Service synced to Firebase');

          } catch (error) {
            console.error('‚ùå Firebase sync error:', error);
          }
        }

        async syncCustomerToFirebase(customerData) {
          try {
            if (!window.firebaseDB) return;

            const customerRef = window.firebaseRef(
              window.firebaseDB,
              `customers/${customerData.id}`
            );

            const firebaseData = {
              ...customerData,
              lastUpdated: new Date().toISOString(),
              lastSeenBranch: BRANCH_CODE
            };

            await window.firebaseSet(customerRef, firebaseData);
            console.log('‚úÖ Customer synced to Firebase');

          } catch (error) {
            console.error('‚ùå Customer Firebase sync error:', error);
          }
        }

        // === UI UPDATE HELPERS ===

        updateBranchStatusIndicator(status) {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á status indicator ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
          let indicator = document.getElementById('branchStatusIndicator');
          if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'branchStatusIndicator';
            indicator.className = 'fixed bottom-4 right-4 p-2 rounded-full shadow-lg z-50';
            document.body.appendChild(indicator);
          }

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          if (status.online && status.activeUsers > 0) {
            indicator.className = 'fixed bottom-4 right-4 p-2 rounded-full shadow-lg z-50 bg-green-500 text-white text-xs';
            indicator.innerHTML = `üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (${status.activeUsers})`;
          } else {
            indicator.className = 'fixed bottom-4 right-4 p-2 rounded-full shadow-lg z-50 bg-gray-500 text-white text-xs';
            indicator.innerHTML = '‚ö´ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
          }
        }

        updateActivityIndicator(activity) {
          // ‡πÅ‡∏™‡∏î‡∏á activity indicator ‡πÉ‡∏ô header
          const header = document.getElementById('mainHeader');
          let activityBadge = document.getElementById('activityBadge');
      
          if (!activityBadge) {
            activityBadge = document.createElement('div');
            activityBadge.id = 'activityBadge';
            activityBadge.className = 'badge badge-sm ml-2';
            header.querySelector('h1').appendChild(activityBadge);
          }

          if (activity.recentServices > 0) {
            activityBadge.className = 'badge badge-sm ml-2 badge-success';
            activityBadge.textContent = `${activity.recentServices} ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
          } else {
            activityBadge.className = 'badge badge-sm ml-2 badge-ghost';
            activityBadge.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
          }
        }

        // === CONNECTION STATUS INDICATORS ===

        updateFirebaseStatus(connected) {
          const indicator = document.getElementById('firebaseIndicator');
          const label = document.getElementById('firebaseLabel');
      
          if (connected) {
            indicator.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
            label.className = 'text-xs text-green-600';
            label.textContent = 'Firebase ‚úì';
          } else {
            indicator.className = 'w-2 h-2 rounded-full bg-red-500';
            label.className = 'text-xs text-red-600';
            label.textContent = 'Firebase ‚úó';
          }
        }

        updateSocketStatus(connected) {
          const indicator = document.getElementById('socketIndicator');
          const label = document.getElementById('socketLabel');
      
          if (connected) {
            indicator.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
            label.className = 'text-xs text-green-600';
            label.textContent = 'Socket.IO ‚úì';
          } else {
            indicator.className = 'w-2 h-2 rounded-full bg-red-500';
            label.className = 'text-xs text-red-600';
            label.textContent = 'Socket.IO ‚úó';
          }
        }

        updateRealtimeActivity(active) {
          const activity = document.getElementById('realtimeActivity');
      
          if (active) {
            activity.classList.remove('hidden');
            setTimeout(() => {
              activity.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
          }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        onFirebaseConnected() {
          this.updateFirebaseStatus(true);
          console.log('üî• Firebase connection established');
        }

        onFirebaseDisconnected() {
          this.updateFirebaseStatus(false);
          console.warn('üî• Firebase connection lost');
        }

        onSocketConnected() {
          this.updateSocketStatus(true);
          this.updateRealtimeActivity(true);
          console.log('üîå Socket.IO connection established');
        }

        onSocketDisconnected() {
          this.updateSocketStatus(false);
          console.warn('üîå Socket.IO connection lost');
        }

        // === CLEANUP ===

        cleanup() {
          // ‡∏õ‡∏¥‡∏î Socket.IO connection
          if (this.socket) {
            this.socket.disconnect();
            this.socket = null;
          }

          // ‡∏õ‡∏¥‡∏î Firebase listeners
          this.firebaseListeners.forEach((listener, key) => {
            window.firebaseOff(listener.ref, 'value', listener.listener);
          });
          this.firebaseListeners.clear();

          console.log('üßπ Real-time connections cleaned up');
        }

        // === PUBLIC METHODS ===

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô Socket.IO
        emitServiceUpdate(serviceData) {
          if (this.socket && this.isConnected) {
            this.socket.emit('service-update', {
              ...serviceData,
              branchCode: BRANCH_CODE,
              timestamp: new Date().toISOString()
            });
          }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase
        async saveToFirebase(path, data) {
          try {
            if (!window.firebaseDB) return false;

            const ref = window.firebaseRef(window.firebaseDB, path);
            await window.firebaseSet(ref, {
              ...data,
              timestamp: window.firebaseServerTimestamp(),
              branchCode: BRANCH_CODE
            });

            return true;
          } catch (error) {
            console.error('‚ùå Firebase save error:', error);
            return false;
          }
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
        async getFromFirebase(path) {
          try {
            if (!window.firebaseDB) return null;

            const ref = window.firebaseRef(window.firebaseDB, path);
            const snapshot = await new Promise((resolve) => {
              window.firebaseOnValue(ref, resolve, { onlyOnce: true });
            });

            return snapshot.val();
          } catch (error) {
            console.error('‚ùå Firebase get error:', error);
            return null;
          }
        }
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á instance ‡∏Ç‡∏≠‡∏á RealtimeDataManager
      const realtimeManager = new RealtimeDataManager();

      // ‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å global scope
      window.realtimeManager = realtimeManager;

      /*
      üîå SOCKET.IO SERVER-SIDE CONFIGURATION:
      
      ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå server.js ‡∏´‡∏£‡∏∑‡∏≠ app.js ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ:
      
      const io = require('socket.io')(server, {
        cors: {
          origin: "*",
          methods: ["GET", "POST"]
        }
      });
      
      io.on('connection', (socket) => {
        console.log('Client connected:', socket.id);
      
        // Join branch room
        socket.on('join-branch', (data) => {
          socket.join(`branch-${data.branchCode}`);
          console.log(`Socket ${socket.id} joined branch-${data.branchCode}`);
      
          // Send branch status
          socket.emit('branch-status', {
            branchCode: data.branchCode,
            online: true,
            activeUsers: io.sockets.adapter.rooms.get(`branch-${data.branchCode}`)?.size || 0
          });
        });
      
        // Handle service updates
        socket.on('service-update', (data) => {
          // Broadcast to all clients in the same branch
          socket.to(`branch-${data.branchCode}`).emit('service-updated', data);
      
          // Also save to database if needed
          // saveServiceToDatabase(data);
        });
      
        socket.on('disconnect', () => {
          console.log('Client disconnected:', socket.id);
        });
      });
      */
      
      // ‚úÖ ‡∏•‡∏ö Mock data ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API
      let serviceHistory = []; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á
      
      // ‚úÖ ‡∏•‡∏ö Mock customer data ‡∏≠‡∏≠‡∏Å - ‡πÉ‡∏ä‡πâ API ‡πÅ‡∏ó‡∏ô
      // const customerData = [...] ‚Üê ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å

      // DOM Elements
      const serviceFormModal = document.getElementById('serviceFormModal');
      const serviceFormTitle = document.getElementById('serviceFormTitle');
      const deviceTypeInput = document.getElementById('deviceType');
      const serviceStaffSelect = document.getElementById('serviceStaff');
      const serviceForm = document.getElementById('serviceForm');
      const serviceHistoryTable = document.getElementById('serviceHistoryTable');
      const searchInput = document.getElementById('searchInput');
      const filterDevice = document.getElementById('filterDevice');
      const customerDetailModal = document.getElementById('customerDetailModal');
      const customerDetailTitle = document.getElementById('customerDetailTitle');
      const customerDetailContent = document.getElementById('customerDetailContent');
      const customerSearch = document.getElementById('customerSearch');
      const searchResults = document.getElementById('searchResults');
      const customerSelect = document.getElementById('customerSelect');
      const customerIDInput = document.getElementById('customerID');
      const serviceReason = document.getElementById('serviceReason');
      const otherReasonContainer = document.getElementById('otherReasonContainer');

      // DOM Elements ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
      const tabFilm = document.getElementById('tabFilm');
      const tabDevice = document.getElementById('tabDevice');
      const filmServiceCards = document.getElementById('filmServiceCards');
      const deviceServiceCards = document.getElementById('deviceServiceCards');
      const filterServiceType = document.getElementById('filterServiceType');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á State Manager ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ global variables
      const AppState = {
        currentEmployeeName: null,
        selectedPurchase: null,
        currentServiceTab: 'film',
        branchCode: BRANCH_CODE || localStorage.getItem('branchCode') || 'PATTANI',
      
        // Methods ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ state
        setEmployee(name) {
          this.currentEmployeeName = name;
        },
      
        setSelectedPurchase(purchaseId, purchaseType) {
          this.selectedPurchase = { purchaseId, purchaseType };
        },
      
        clearSelectedPurchase() {
          this.selectedPurchase = null;
        },
      
        setServiceTab(tab) {
          this.currentServiceTab = tab;
        },
      
        reset() {
          this.selectedPurchase = null;
        }
      };
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á API Client ‡∏ó‡∏µ‡πà‡∏°‡∏µ error handling ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤
      const ApiClient = {
        baseURL: '',
      
        async request(url, options = {}) {
          const token = localStorage.getItem('authToken');
      
          if (!token) {
            window.location.href = '/login';
            throw new Error('No authentication token');
          }
      
          const defaultOptions = {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          };
      
          const finalOptions = {
            ...defaultOptions,
            ...options,
            headers: {
              ...defaultOptions.headers,
              ...options.headers
            }
          };
      
          try {
            const response = await fetch(url, finalOptions);
      
            // Handle 404 specifically for API endpoints that might not exist yet
            if (response.status === 404) {
              throw new Error(`API endpoint not found: ${url}`);
            }
      
            // Handle authentication errors
            if (response.status === 401 || response.status === 403) {
              alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
              window.location.href = '/login';
              return;
            }
      
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              // Log the actual response for debugging
              const responseText = await response.text();
              console.warn('Non-JSON response received:', {
                url,
                status: response.status,
                contentType,
                responseText: responseText.substring(0, 200) + (responseText.length > 200 ? '...' : '')
              });
      
              throw new Error(`Server returned non-JSON response (${response.status}): ${contentType || 'unknown content-type'}`);
            }
      
            const data = await response.json();
      
            if (!response.ok) {
              throw new Error(data.error || data.message || `HTTP Error ${response.status}`);
            }
      
            return data;
      
          } catch (error) {
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
              throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            }
            throw error;
          }
        },
      
        get(url) {
          return this.request(url);
        },
      
        post(url, data) {
          return this.request(url, {
            method: 'POST',
            body: JSON.stringify(data)
          });
        }
      };
      
      // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á notification
      function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotif = document.querySelector('.notification-toast');
        if (existingNotif) {
          existingNotif.remove();
        }
      
        const notif = document.createElement('div');
        notif.className = `notification-toast fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 
                           ${type === 'error' ? 'bg-red-500' :
                             type === 'warning' ? 'bg-yellow-500' :
                             type === 'success' ? 'bg-green-500' : 'bg-blue-500'} 
                           text-white animate-fade-in`;
      
        notif.innerHTML = `
          <div class="flex items-center">
            <i class="bi bi-${type === 'error' ? 'x-circle' :
                              type === 'warning' ? 'exclamation-triangle' :
                              type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
          </div>
        `;
      
        document.body.appendChild(notif);
      
        // Auto remove after 5 seconds
        setTimeout(() => {
          notif.classList.add('animate-fade-out');
          setTimeout(() => notif.remove(), 300);
        }, 5000);
      }

      // Add animation styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
          from { opacity: 1; transform: translateY(0); }
          to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-fade-out { animation: fadeOut 0.3s ease-out; }
      `;
      document.head.appendChild(style);
      
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç switchServiceTab ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ AppState
      function switchServiceTab(tab) {
        const tabFilm = document.getElementById('tabFilm');
        const tabDevice = document.getElementById('tabDevice');
        const filmServiceCards = document.getElementById('filmServiceCards');
        const deviceServiceCards = document.getElementById('deviceServiceCards');
      
        if (tab === 'film') {
          tabFilm.classList.add('tab-active');
          tabDevice.classList.remove('tab-active');
          filmServiceCards.classList.remove('hidden');
          deviceServiceCards.classList.add('hidden');
        } else if (tab === 'device') {
          tabDevice.classList.add('tab-active');
          tabFilm.classList.remove('tab-active');
          deviceServiceCards.classList.remove('hidden');
          filmServiceCards.classList.add('hidden');
        }
      
        AppState.setServiceTab(tab);
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token validity
async function checkTokenValidity() {
  const token = localStorage.getItem('authToken');
  if (!token) return false;
  try {
    const res = await fetch('/api/users/me', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    return res.ok;
  } catch (error) {
    return false;
  }
}

// Load branch information
async function loadBranchInfo() {
  try {
    const result = await ApiClient.get('/api/branch');

    if (!result.success || !result.data) {
      throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ');
    }

    const branch = result.data.find(b => b.branch_code === AppState.branchCode);

    if (!branch) {
      throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ ${AppState.branchCode}`);
    }

    // Update UI
    document.getElementById('branchInfo').textContent =
      `${branch.name} ‚Äî ${branch.address}`;

    const branchSelect = document.getElementById('branchLocation');
    branchSelect.innerHTML = `<option value="${branch.branch_code}" selected>${branch.name}</option>`;
    branchSelect.disabled = true;

  } catch (error) {
    console.error('Load branch info error:', error);
    document.getElementById('branchInfo').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤';
    showNotification(error.message, 'error');
  }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log('üöÄ Services page initializing...');

    // Show loading using new Lottie loading system
    showLoading(true);

    try {
      // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
      console.log('üìã Loading employee profile...');
      await loadEmployeeProfile();

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
      console.log('üîê Checking authentication...');
      const valid = await checkTokenValidity();
    if (!valid) {
      alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      window.location.href = '/login';
      return;
    }

    console.log('üè¢ Loading branch information...');
    await loadBranchInfo();

    // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Real-time connections (Firebase + Socket.IO)
    console.log('üîå Initializing real-time connections...');
    // Note: New loading system doesn't support message updates
    await realtimeManager.initialize();

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API
    console.log('üìã Loading service history...');
    // Note: New loading system doesn't support message updates
    await loadServiceHistory();

    // ‚úÖ ‡∏ú‡∏π‡∏Å‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    console.log('üîß Setting up form handlers...');
    const serviceForm = document.getElementById('serviceForm');
    if (serviceForm) {
      serviceForm.addEventListener('submit', handleServiceFormSubmit);
    }

    // ‡∏ú‡∏π‡∏Å‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á
    const searchInput = document.getElementById('searchInput');
    const filterDevice = document.getElementById('filterDevice');
    const filterServiceType = document.getElementById('filterServiceType');
    const customerSelect = document.getElementById('customerSelect');

    if (searchInput) searchInput.addEventListener('input', filterServiceHistory);
    if (filterDevice) filterDevice.addEventListener('change', filterServiceHistory);
    if (filterServiceType) filterServiceType.addEventListener('change', filterServiceHistory);
    if (customerSelect) customerSelect.addEventListener('change', fillCustomerData);

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ tab ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    switchServiceTab('film');

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    window.addEventListener('beforeunload', () => {
      realtimeManager.cleanup();
    });

    console.log('‚úÖ Services page initialized successfully!');
    } catch (error) {
      console.error('Initialization error:', error);
    } finally {
      // Hide loading using new Lottie loading system
      showLoading(false);
    }
  } catch (err) {
    console.error('Outer initialization failed:', err);
  }
});

      // Load employee information
      async function loadEmployeeProfile() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return;
          const res = await fetch('/api/users/me', {
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            }
          });
          const js = await res.json();
          if (!res.ok || !js.success) throw new Error(js.error||js.message||res.status);
          const u = js.data;
          document.getElementById('employeeName').textContent = u.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠)';
          let img = u.imageUrl || u.photoUrl || u.image || '';
          if (img && !/^https?:\/\//.test(img)) {
            img = img.startsWith('/') ? img : '/uploads/' + img;
          }
          document.getElementById('employeePhoto').src = img || '/static/images/avatar-default.png';

          // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô AppState
          AppState.setEmployee(u.name || 'Unknown Staff');

          // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô dropdown ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          const sel = document.getElementById('serviceStaff');
          sel.innerHTML = `<option value="${u.name}">${u.name}</option>`;
          sel.disabled = true;
        } catch (err) {
          console.error('Load Employee Profile Error:', err);
        }
      }

      // Open service form modal
      function openServiceForm(type) {
        deviceTypeInput.value = type;
        const serviceType = type.includes('-film') ? 'film' : 'warranty';
        document.getElementById('serviceType').value = serviceType;
      
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        let formTitle = '';
        let serviceTypeText = '';
      
        if (type === 'phone-film') {
          formTitle = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
          serviceTypeText = '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
        } else if (type === 'ipad-film') {
          formTitle = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏≠‡πÅ‡∏û‡∏î';
          serviceTypeText = '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏≠‡πÅ‡∏û‡∏î';
        } else if (type === 'phone-warranty') {
          formTitle = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
          serviceTypeText = '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
        } else if (type === 'ipad-warranty') {
          formTitle = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡πÅ‡∏û‡∏î';
          serviceTypeText = '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡πÅ‡∏û‡∏î';
        }
      
        serviceFormTitle.textContent = formTitle;
        document.getElementById('serviceTypeDisplay').textContent = serviceTypeText;
      
        // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        document.getElementById('filmReasonGroup').style.display = serviceType === 'film' ? 'block' : 'none';
        document.getElementById('warrantyReasonGroup').style.display = serviceType === 'warranty' ? 'block' : 'none';
      
        // Set today's date as default
        document.getElementById('serviceDate').valueAsDate = new Date();
      
        // Set current employee as default staff
        if (window.currentEmployeeName) {
          document.getElementById('serviceStaff').value = window.currentEmployeeName;
        }
        // Show the modal
        serviceFormModal.classList.add('modal-open');
      }

      // Close service form modal
      function closeServiceForm() {
        const modal = document.getElementById('serviceFormModal');
        modal.classList.remove('modal-open');
      
        // Clear form ‡πÅ‡∏•‡∏∞ state
        clearForm();
        AppState.clearSelectedPurchase();
      
        // Remove any temporary event listeners
        const form = document.getElementById('serviceForm');
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
      
        // Re-attach the submit handler
        newForm.addEventListener('submit', handleServiceFormSubmit);
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô clearForm ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢
      function clearForm() {
        document.getElementById('serviceForm').reset();
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('otherReasonContainer').classList.add('hidden');
        document.querySelector('.eligible-purchases-container')?.remove();
        window.selectedPurchase = null;
      }

      // Search customer in database
      async function searchCustomer() {
        const searchTerm = document.getElementById('customerSearch').value.trim();
      
        if (!searchTerm) {
          showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'warning');
          return;
        }
      
        // Show loading state
        const searchBtn = document.querySelector('button[onclick="searchCustomer()"]');
        const originalText = searchBtn.innerHTML;
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
      
        try {
          const params = new URLSearchParams();
      
          // Determine search type
          if (/^\d{13}$/.test(searchTerm)) {
            params.set('idCard', searchTerm);
          } else if (/^0\d{8,9}$/.test(searchTerm)) {
            params.set('phone', searchTerm);
          } else {
            params.set('customerName', searchTerm);
          }
      
          const result = await ApiClient.get(`/api/services/eligibility?${params}`);
      
          if (!result.success) {
            throw new Error(result.error || 'Search failed');
          }
      
          displayCustomerResults(result.data);
      
        } catch (error) {
          console.error('Search error:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            searchTerm: searchTerm,
            apiUrl: `/api/services/eligibility?${params}`
          });
          showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = originalText;
        }
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      function displayCustomerResults(customers) {
        const sel = document.getElementById('customerSelect');
        const wrapper = document.getElementById('searchResults');
        while (sel.options.length > 1) sel.remove(1);
        if (!customers.length) {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'warning');
          wrapper.classList.add('hidden');
          return;
        }
        customers.forEach(cust => {
          const opt = document.createElement('option');
          opt.value = cust.customer.id;
          opt.text = `${cust.customer.name} - ${cust.customer.phone}`;
          opt.dataset.customerData = JSON.stringify(cust);
          sel.append(opt);
        });
        wrapper.classList.remove('hidden');
        showNotification(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
      }

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      async function fillCustomerData() {
        const sel = document.getElementById('customerSelect');
        const opt = sel.selectedOptions[0];
        if (!opt?.dataset.customerData) return;
      
        const { customer, purchases } = JSON.parse(opt.dataset.customerData);
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone;
        document.getElementById('customerID').value = customer.taxId || '';
      
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
        document.getElementById('warrantyDate').value = '';
        document.getElementById('deviceModel').innerHTML = '<option value="" disabled selected>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô</option>';
      
        // ‚úÖ Sync customer data to Firebase for real-time availability
        try {
          const customerData = {
            id: customer.id,
            ...customer,
            lastAccessed: new Date().toISOString(),
            accessedBy: AppState.currentEmployeeName,
            accessedFromBranch: BRANCH_CODE,
            purchases: purchases.map(p => ({
              id: p.purchaseId,
              type: p.purchaseType,
              date: p.purchaseDate,
              warrantyEnd: p.warrantyEndDate,
              items: p.items,
              serviceUsage: p.serviceUsageCount
            }))
          };

          await realtimeManager.syncCustomerToFirebase(customerData);
      
          // Emit customer selection event
          realtimeManager.emitServiceUpdate({
            type: 'customer_selected',
            customerName: customer.name,
            customerPhone: customer.phone,
            branchCode: BRANCH_CODE,
            staffName: AppState.currentEmployeeName,
            timestamp: new Date().toISOString()
          });

          console.log('‚úÖ Customer data synced to real-time systems');
        } catch (error) {
          console.error('‚ùå Customer sync error:', error);
        }
      
        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        displayEligiblePurchases(purchases);
      }



      // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      function displayEligiblePurchases(purchases) {
        const form = document.querySelector('#serviceForm');
        document.querySelector('.eligible-purchases-container')?.remove();
        const cont = document.createElement('div');
        cont.className = 'eligible-purchases-container mt-4 p-3 bg-blue-50 dark:bg-gray-700 rounded-lg';
        cont.innerHTML = '<h4 class="font-semibold mb-2 text-blue-800 dark:text-blue-200">‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</h4>';
        if (!purchases.length) {
          cont.innerHTML += '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>';
        } else {
          purchases.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'mb-4 border-l-4 border-blue-500 pl-3 bg-white dark:bg-gray-600 rounded p-3';
            const status = new Date(p.warrantyEndDate) > new Date() ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
            const cls = new Date(p.warrantyEndDate) > new Date() ? 'text-green-600' : 'text-red-600';
      
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
            const itemsList = p.items.map(item => {
              const deviceType = getDeviceTypeFromName(item.name || item.description || '');
              const deviceIcon = deviceType === 'ipad' ? 'üì±' : 'üì±';
              return `<span class="text-sm bg-gray-200 dark:bg-gray-500 px-2 py-1 rounded mr-1 mb-1 inline-block">${deviceIcon} ${item.name || item.description}</span>`;
            }).join('');
      
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
            const serviceRights = Object.entries(p.serviceUsageCount || {}).map(([serviceType, count]) => {
              const max = getMaxUsageForService(serviceType);
              const remaining = max - count;
              const statusColor = remaining > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
              return `<span class="text-xs ${statusColor} px-2 py-1 rounded mr-1">${getServiceTypeName(serviceType)}: ${count}/${max} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining})</span>`;
            }).join('');
      
            div.innerHTML = `
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                    <div>
                      <p class="text-sm font-semibold text-blue-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</p>
                      <p class="text-lg">${p.purchaseType === 'cash' ? 'üí∞ ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏î' : 'üìÖ ‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≠‡∏ô'}</p>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-blue-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</p>
                      <p class="text-lg">${new Date(p.purchaseDate).toLocaleDateString('th-TH')}</p>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-blue-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</p>
                      <p class="text-lg ${cls}">${new Date(p.warrantyEndDate).toLocaleDateString('th-TH')}</p>
                      <p class="text-sm ${cls}">(${status})</p>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠:</p>
                    <div class="flex flex-wrap gap-1">${itemsList}</div>
                  </div>
                  
                  ${serviceRights ? `
                    <div class="mb-3">
                      <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</p>
                      <div class="flex flex-wrap gap-1">${serviceRights}</div>
                    </div>
                  ` : ''}
                </div>
                
                <div class="ml-4">
                  <button class="btn btn-sm btn-primary" onclick="selectPurchaseForService('${p.purchaseId}','${p.purchaseType}', ${index})">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                  </button>
                </div>
              </div>
            `;
            cont.append(div);
          });
        }
        form.append(cont);
      }

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
      function selectPurchaseForService(purchaseId, purchaseType, purchaseIndex) {
        AppState.setSelectedPurchase(purchaseId, purchaseType);
      
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const customerSelect = document.getElementById('customerSelect');
        const selectedCustomerOption = customerSelect.selectedOptions[0];
        if (selectedCustomerOption?.dataset.customerData) {
          const { purchases } = JSON.parse(selectedCustomerOption.dataset.customerData);
          const selectedPurchase = purchases[purchaseIndex];
      
          if (selectedPurchase) {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á
            const warrantyStartDate = new Date(selectedPurchase.purchaseDate);
            const warrantyDateInput = document.getElementById('warrantyDate');
            warrantyDateInput.value = warrantyStartDate.toISOString().split('T')[0];
      
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            populateDeviceModelsFromPurchase(selectedPurchase);
          }
        }
      
        const submitBtn = document.querySelector('#serviceForm button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
      
        // Highlight selected purchase
        document.querySelectorAll('.eligible-purchases-container button').forEach(btn => {
          btn.classList.remove('btn-success');
          btn.classList.add('btn-primary');
          btn.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
        });
      
        event.target.classList.remove('btn-primary');
        event.target.classList.add('btn-success');
        event.target.textContent = '‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
      }
      
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      function populateDeviceModelsFromPurchase(purchase) {
        const deviceSelect = document.getElementById('deviceModel');
        deviceSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>';
      
        if (purchase.items && purchase.items.length > 0) {
          purchase.items.forEach(item => {
            if (item.name || item.description) {
              const itemName = item.name || item.description;
              const deviceType = getDeviceTypeFromName(itemName);
              const deviceIcon = deviceType === 'ipad' ? 'üì±' : 'üì±';
      
              const option = document.createElement('option');
              option.value = itemName;
              option.textContent = `${deviceIcon} ${itemName} (${deviceType === 'phone' ? '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' : '‡πÑ‡∏≠‡πÅ‡∏û‡∏î'})`;
              option.dataset.deviceType = deviceType;
              option.dataset.imei = item.imei || '';
              option.dataset.purchaseId = purchase.purchaseId;
              option.dataset.purchaseType = purchase.purchaseType;
              deviceSelect.appendChild(option);
            }
          });
        }
      
        if (deviceSelect.options.length === 1) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ';
          option.disabled = true;
          deviceSelect.appendChild(option);
        }
      }
      
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function getDeviceTypeFromName(itemName) {
        const name = itemName.toLowerCase();
        if (name.includes('ipad') || name.includes('tablet')) {
          return 'ipad';
        }
        return 'phone'; // default ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
      }

      // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà handler ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ POST ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ API
      async function handleServiceFormSubmit(e) {
        e.preventDefault();
      
        if (!AppState.selectedPurchase) {
          showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', 'warning');
          return;
        }
      
        // Validate form data
        const formData = new FormData(e.target);
        const requiredFields = ['customerName', 'customerPhone', 'deviceModel', 'serviceReason', 'serviceDate'];
      
        for (const field of requiredFields) {
          if (!formData.get(field)) {
            const fieldNames = {
              'customerName': '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
              'customerPhone': '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
              'deviceModel': '‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
              'serviceReason': '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
              'serviceDate': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'
            };
            showNotification(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å${fieldNames[field]}`, 'warning');
            return;
          }
        }
      
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö serviceReason ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        const serviceReason = formData.get('serviceReason');
        if (serviceReason === 'other') {
          const otherReason = formData.get('otherReason');
          if (!otherReason || otherReason.trim() === '') {
            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ', 'warning');
            return;
          }
        }
      
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å dropdown ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const deviceModelSelect = document.getElementById('deviceModel');
        const selectedOption = deviceModelSelect.selectedOptions[0];
        let deviceType = formData.get('deviceType'); // ‡∏à‡∏≤‡∏Å hidden field
      
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ dataset ‡∏à‡∏≤‡∏Å option ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô
        if (selectedOption && selectedOption.dataset.deviceType) {
          deviceType = selectedOption.dataset.deviceType;
        }
      
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ deviceType ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô
        if (!deviceType) {
          const deviceModel = formData.get('deviceModel').toLowerCase();
          if (deviceModel.includes('ipad') || deviceModel.includes('tablet')) {
            deviceType = 'ipad';
          } else {
            deviceType = 'phone';
          }
        }
      
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á serviceType ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° enum ‡πÉ‡∏ô ServiceHistory model
        const correctServiceType = `${deviceType}-${formData.get('serviceType')}`;
      
        const payload = {
          purchaseId: AppState.selectedPurchase.purchaseId,
          purchaseType: AppState.selectedPurchase.purchaseType,
          customerId: document.getElementById('customerSelect').value,
          deviceType: deviceType,
          deviceModel: formData.get('deviceModel'),
          deviceImei: selectedOption?.dataset.imei || '',
          serviceType: correctServiceType, // ‡πÉ‡∏ä‡πâ format ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô 'phone-film', 'ipad-warranty'
          serviceReason: formData.get('serviceReason') === 'other' ?
                        formData.get('otherReason') : formData.get('serviceReason'),
          serviceDate: formData.get('serviceDate') || new Date().toISOString().split('T')[0], // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏° fallback
          branchCode: AppState.branchCode,
          staffName: formData.get('serviceStaff') || AppState.currentEmployeeName || 'Unknown Staff',
          notes: formData.get('serviceNotes') || ''
        };
      
        console.log('üîß Service submission payload:', payload);
        console.log('üìù Form data debug:', {
          deviceType: deviceType,
          originalServiceType: formData.get('serviceType'),
          correctedServiceType: correctServiceType,
          staffName: formData.get('serviceStaff'),
          appStateEmployee: AppState.currentEmployeeName,
          serviceReason: formData.get('serviceReason'),
          serviceDate: formData.get('serviceDate'),
          payloadServiceDate: payload.serviceDate,
          selectedPurchase: AppState.selectedPurchase
        });

        // Debug log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö serviceDate
        console.log('üìÖ Service Date Debug:', {
          formDataServiceDate: formData.get('serviceDate'),
          payloadServiceDate: payload.serviceDate,
          inputElementValue: document.getElementById('serviceDate')?.value,
          inputElementDate: document.getElementById('serviceDate')?.valueAsDate,
          currentDate: new Date().toISOString().split('T')[0]
        });
      
        try {
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      
          const response = await ApiClient.post('/api/services/usage', payload);
      
          // ‚úÖ Real-time data sync ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          if (response && response.success) {
            const serviceData = {
              id: response.data?.id || Date.now(),
              ...payload,
              customerName: formData.get('customerName'),
              customerPhone: formData.get('customerPhone'),
              customerID: formData.get('customerID'),
              serviceDate: payload.serviceDate, // ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å payload ‡∏ó‡∏µ‡πà‡∏°‡∏µ fallback ‡πÅ‡∏•‡πâ‡∏ß
              warrantyDate: formData.get('warrantyDate'),
              createdAt: new Date().toISOString(),
              status: 'completed'
            };

            // üî• Sync to Firebase
            console.log('üî• Syncing service data to Firebase...');
            await realtimeManager.syncServiceToFirebase(serviceData);

            // üîå Emit to Socket.IO for real-time updates
            console.log('üîå Broadcasting service update via Socket.IO...');
            realtimeManager.emitServiceUpdate(serviceData);

            // üìä Update branch activity
            const activityData = {
              type: 'service_completed',
              deviceType: serviceData.deviceType,
              serviceType: serviceData.serviceType,
              timestamp: new Date().toISOString(),
              staffName: serviceData.staffName,
              customerName: serviceData.customerName
            };

            await realtimeManager.saveToFirebase(
              `branches/${BRANCH_CODE}/activity/${Date.now()}`,
              activityData
            );

            console.log('‚úÖ Real-time sync completed successfully');
          }
      
          showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
          closeServiceForm();
          await loadServiceHistory();
      
        } catch (error) {
          console.error('Submit error:', error);
          showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        } finally {
          const submitBtn = e.target.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          }
        }
      }

      // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
      function getMaxUsageForService(serviceType) {
        const maxUsageMap = {
          'phone-film': 10,
          'ipad-film': 3,
          'phone-warranty': 1,
          'ipad-warranty': 1
        };
        return maxUsageMap[serviceType] || 1;
      }
      
      // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      function getServiceTypeName(serviceType) {
        const serviceNames = {
          'phone-film': '‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
          'ipad-film': '‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏≠‡πÅ‡∏û‡∏î',
          'phone-warranty': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
          'ipad-warranty': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡πÅ‡∏û‡∏î'
        };
        return serviceNames[serviceType] || serviceType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
      // Helper ‡∏î‡∏∂‡∏á branch code ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      function getCurrentBranchCode() {
        return localStorage.getItem('branchCode')||'00000';
      }
      
      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ fill ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      document.getElementById('customerSelect').addEventListener('change', fillCustomerData);

      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç populateStaffDropdown ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
      async function populateStaffDropdown() {
        const serviceStaffSelect = document.getElementById('serviceStaff');
      
        try {
          const token = localStorage.getItem('authToken');
          const response = await fetch('/api/users/me', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
      
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              serviceStaffSelect.innerHTML = `<option value="${data.data.name}" selected>${data.data.name}</option>`;
              serviceStaffSelect.disabled = true;
            }
          }
        } catch (error) {
          console.error('Error loading staff:', error);
          serviceStaffSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';
        }
      }

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      function renderServiceHistory(filteredData) {
        const data = filteredData || serviceHistory;
        const tbody = document.getElementById('serviceHistoryTable');
      
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</td></tr>';
          return;
        }
      
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        const sortedData = data
          .sort((a, b) => new Date(b.serviceDate || b.purchaseDate || b.createdAt) - new Date(a.serviceDate || a.purchaseDate || a.createdAt))
          .slice(0, 10);
      
        tbody.innerHTML = sortedData.map(s => {
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          const serviceDate = s.serviceDate || s.date || s.createdAt;
          const purchaseDate = s.warrantyStartDate || s.warrantyDate || s.purchaseDate || s.createdAt;

          // Debug log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π structure ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          console.log('Service data structure:', {
            serviceDate: s.serviceDate,
            date: s.date,
            createdAt: s.createdAt,
            keys: Object.keys(s)
          });
      
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          const customerName = s.customerInfo?.name || s.customerName || s.customer?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
          let deviceType = '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'; // default
          if (s.device?.type === 'ipad' || s.deviceType === 'ipad' ||
              (s.serviceType && s.serviceType.includes('ipad'))) {
            deviceType = '‡πÑ‡∏≠‡πÅ‡∏û‡∏î';
          }
      
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
          let deviceModel = s.device?.model || s.deviceModel || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          if (s.items && s.items.length > 0) {
            deviceModel = s.items[0].name || deviceModel;
          }
      
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤
          const branchName = getBranchName(s.branchCode || s.branch_code || s.branch) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          const staffName = s.staffName || s.staff || s.staffInfo?.name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
      
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
          const usageCount = s.usageCount || s.serviceCount || 0;
          const maxUsage = deviceType === '‡πÑ‡∏≠‡πÅ‡∏û‡∏î' ? 3 : 10;
          const usageBadgeClass = usageCount > (maxUsage * 0.8) ? 'bg-warning' : 'bg-info';
      
          return `
            <tr>
              <td>${serviceDate ? formatThaiDate(serviceDate) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
              <td>${purchaseDate ? formatThaiDate(purchaseDate) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
              <td>${customerName}</td>
              <td>${deviceType}</td>
              <td>${deviceModel}</td>
              <td>${branchName}</td>
              <td>${staffName}</td>
              <td>
                <span class="badge ${usageBadgeClass}">
                  ${usageCount}/${maxUsage}
                </span>
              </td>
              <td>${
                isWarrantyValid(s.warrantyEndDate || purchaseDate)
                  ? '<span class="badge bg-success">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>'
                  : '<span class="badge bg-danger">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>'
              }</td>
              <td>
                <button class="btn btn-sm btn-primary btn-circle" onclick="showCustomerDetail('${s._id || s.id}')">
                  <i class="bi bi-info-circle"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        if (data.length > 10) {
          tbody.innerHTML += `
            <tr>
              <td colspan="10" class="text-center text-info py-2">
                <i class="bi bi-info-circle"></i> ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                <button class="btn btn-sm btn-link" onclick="showAllServiceHistory()">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              </td>
            </tr>
          `;
        }
      }
      
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      function showAllServiceHistory() {
        // TODO: ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏° pagination
        showNotification('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ', 'info');
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• service history
      function filterServiceHistory() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const deviceFilter = document.getElementById('filterDevice').value;
        const serviceTypeFilter = document.getElementById('filterServiceType').value;
      
        let filtered = serviceHistory;
      
        if (searchTerm) {
          filtered = filtered.filter(s =>
            (s.customerInfo?.name || s.customerName || '').toLowerCase().includes(searchTerm) ||
            (s.device?.model || s.deviceModel || '').toLowerCase().includes(searchTerm) ||
            (s.staffName || s.staff || '').toLowerCase().includes(searchTerm)
          );
        }
      
        if (deviceFilter !== 'all') {
          filtered = filtered.filter(s =>
            (s.device?.type || s.deviceType) === deviceFilter
          );
        }
      
        if (serviceTypeFilter !== 'all') {
          filtered = filtered.filter(s => {
            const serviceType = s.serviceType || '';
            return serviceType.includes(serviceTypeFilter);
          });
        }
      
        renderServiceHistory(filtered);
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å API
      async function loadServiceHistory() {
        try {
          console.log('üîÑ Loading service history for branch:', AppState.branchCode);
      
          // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Å‡πà‡∏≠‡∏ô
          const result = await ApiClient.get(`/api/services/history?branchCode=${AppState.branchCode}`);
      
          if (result && result.success && result.data) {
            serviceHistory = result.data;
            console.log('üìã Loaded service history:', serviceHistory.length, 'records');
          } else {
            console.warn('No service history data returned, using empty array');
            serviceHistory = [];
          }
      
          renderServiceHistory();
      
        } catch (error) {
          console.error('Load service history error:', error);
      
          // ‡∏ñ‡πâ‡∏≤ API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ empty array ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á error
          if (error.message.includes('Server returned non-JSON response') ||
              error.message.includes('Failed to fetch') ||
              error.message.includes('404') ||
              error.message.includes('API endpoint not found')) {
            console.warn('üöß Service history API not available, using empty data');
            serviceHistory = [];
            renderServiceHistory();
          } else {
            // ‡πÅ‡∏™‡∏î‡∏á error ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'warning');
            serviceHistory = [];
            renderServiceHistory();
          }
        }
      }

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠
      function getBranchName(branchCode) {
        const map = {
          pattani: '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
          hatyai:  '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà',
          yala:    '‡∏¢‡∏∞‡∏•‡∏≤'
        };
        return map[branchCode] || branchCode;
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
      function formatThaiDate(dateString) {
        console.log('üìÖ formatThaiDate input:', dateString);

        if (!dateString) {
          console.log('‚ùå No date string provided');
          return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            console.log('‚ùå Invalid date format:', dateString);
            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          }
      
          const thaiMonths = [
            '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
            '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
          ];
      
          const day = date.getDate();
          const month = thaiMonths[date.getMonth()];
          const year = date.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®.
      
          return `${day} ${month} ${year}`;
        } catch (error) {
          console.error('Error formatting Thai date:', error);
          return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
      function isWarrantyValid(warrantyDate) {
        const start = new Date(warrantyDate);
        const end = new Date(start);
        end.setFullYear(end.getFullYear() + 1);
        return new Date() <= end;
      }

      // Show customer detail modal
      function showCustomerDetail(serviceId) {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å serviceHistory ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API
        const service = serviceHistory.find(s => (s._id || s.id) === serviceId);
        if (!service) {
          showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', 'error');
          return;
        }
      
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API response
        const customerName = service.customerInfo?.name || service.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const customerPhone = service.customerInfo?.phone || service.customerPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const deviceType = service.device?.type || service.deviceType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const deviceModel = service.device?.model || service.deviceModel || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const serviceDate = service.serviceDate || service.date;
        const warrantyDate = service.warrantyStartDate || service.warrantyDate;
        const branchCode = service.branchCode || service.branch;
        const staffName = service.staffName || service.staff || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        const usageCount = service.usageCount || service.serviceCount || 0;
        const maxUsage = (deviceType === 'phone') ? 10 : 3;
        const notes = service.notes || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
      
        customerDetailTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ - ${customerName}`;
        customerDetailContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold mb-2 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
              <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${customerName}</p>
              <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${customerPhone}</p>
            </div>
            <div>
              <h4 class="font-semibold mb-2 text-green-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
              <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${deviceType === 'phone' ? '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' : '‡πÑ‡∏≠‡πÅ‡∏û‡∏î'}</p>
              <p><strong>‡∏£‡∏∏‡πà‡∏ô:</strong> ${deviceModel}</p>
              ${service.device?.imei ? `<p><strong>IMEI:</strong> ${service.device.imei}</p>` : ''}
            </div>
            <div>
              <h4 class="font-semibold mb-2 text-purple-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</h4>
              <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</strong> ${warrantyDate ? new Date(warrantyDate).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${
                isWarrantyValid(service.warrantyEndDate || warrantyDate)
                                  ? '<span class="text-green-600 font-semibold">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>'
                : '<span class="text-red-600 font-semibold">‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span>'
              }</p>
              ${service.warrantyEndDate ? `<p><strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${new Date(service.warrantyEndDate).toLocaleDateString('th-TH')}</p>` : ''}
            </div>
            <div>
              <h4 class="font-semibold mb-2 text-orange-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h4>
              <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${serviceDate ? new Date(serviceDate).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${getServiceTypeName(service.serviceType)}</p>
              <p><strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${service.serviceReason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
              <p><strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà:</strong> <span class="badge ${usageCount > maxUsage * 0.8 ? 'badge-warning' : 'badge-info'}">${usageCount}/${maxUsage}</span></p>
            </div>
            <div class="col-span-full">
              <h4 class="font-semibold mb-2 text-gray-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
              <p><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${getBranchName(branchCode)}</p>
              <p><strong>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${staffName}</p>
              <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${notes}</p>
            </div>
          </div>
        `;
        customerDetailModal.classList.add('modal-open');
      }

      // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      function getServiceTypeName(serviceType) {
        const serviceNames = {
          'phone-film': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
          'ipad-film': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡πÑ‡∏≠‡πÅ‡∏û‡∏î',
          'phone-warranty': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
          'ipad-warranty': '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏≠‡πÅ‡∏û‡∏î'
        };
        return serviceNames[serviceType] || serviceType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }

      // Close customer detail modal
      function closeCustomerDetail() {
        customerDetailModal.classList.remove('modal-open');
      }

      // Add event listener for service reason dropdown
      serviceReason.addEventListener('change', function() {
        if (this.value === 'other') {
          otherReasonContainer.classList.remove('hidden');
          document.getElementById('otherReason').required = true;
        } else {
          otherReasonContainer.classList.add('hidden');
          document.getElementById('otherReason').required = false;
        }
      });
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadBranchInfo
      async function loadBranchInfo() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const branchCode = urlParams.get('branch') || localStorage.getItem('branchCode') || '00000';
          const token = localStorage.getItem('authToken') || '';
      
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
          const res = await fetch(`/api/branch`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const js = await res.json();
          if (res.ok && js.success) {
            // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö branch_code
            const branch = js.data.find(b => b.branch_code === branchCode);
            if (branch) {
              document.getElementById('branchInfo').textContent =
                `${branch.name} ‚Äî ${branch.address}`;
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
              document.title = `‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ - ${branch.name}`;
      
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó dropdown ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
              const branchSelect = document.getElementById('branchLocation');
              if (branchSelect) {
                branchSelect.innerHTML = `<option value="${branch.branch_code}" selected>${branch.name}</option>`;
                branchSelect.disabled = true;
              }
      
              return;
            }
          }
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
        } catch (err) {
          console.warn('loadBranchInfo error:', err);
          document.getElementById('branchInfo').textContent =
            '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        }
      }
      
      // Helper function checkTokenValidity
      async function checkTokenValidity() {
        try {
          const token = localStorage.getItem('authToken');
          if (!token) return false;
      
          const res = await fetch('/api/users/me', {
            headers: { Authorization: `Bearer ${token}` }
          });
      
          return res.ok;
        } catch (error) {
          console.error('Token validation error:', error);
          return false;
        }
      }
      
      // Loading state function
      
      // Switch Service Tab
      function switchServiceTab(tab) {
        AppState.setServiceTab(tab);
      
        // Update tab buttons
        document.getElementById('tabFilm').classList.toggle('tab-active', tab === 'film');
        document.getElementById('tabDevice').classList.toggle('tab-active', tab === 'device');
      
        // Show/hide cards
        document.getElementById('filmServiceCards').classList.toggle('hidden', tab !== 'film');
        document.getElementById('deviceServiceCards').classList.toggle('hidden', tab !== 'device');
      }
      
      // Show notification
      function showNotification(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
      
        // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ error ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á alert
        if (type === 'error') {
          alert('‚ùå ' + message);
        } else if (type === 'success') {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö success ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á toast ‡πÅ‡∏ó‡∏ô alert
          showToast(message, 'success');
        } else {
          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö warning ‡πÅ‡∏•‡∏∞ info ‡πÉ‡∏´‡πâ log ‡πÄ‡∏â‡∏¢‡πÜ
          console.warn(`‚ö†Ô∏è ${message}`);
        }
      }
      
      // Simple toast notification function
      function showToast(message, type = 'info') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
          existingToast.remove();
        }
      
        const toast = document.createElement('div');
        toast.className = `toast-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300`;
      
        // Set colors based on type
        if (type === 'success') {
          toast.className += ' bg-green-500 text-white';
        } else if (type === 'error') {
          toast.className += ' bg-red-500 text-white';
        } else if (type === 'warning') {
          toast.className += ' bg-yellow-500 text-black';
        } else {
          toast.className += ' bg-blue-500 text-white';
        }
      
        toast.innerHTML = `
          <div class="flex items-center">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-sm opacity-70 hover:opacity-100">‚úï</button>
          </div>
        `;
      
        document.body.appendChild(toast);
      
        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

    </script>
  </body>
</html>


