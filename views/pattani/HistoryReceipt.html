<!DOCTYPE html>
<!-- 
  ประวัติใบเสร็จ - History Receipt Page
  🔗 Tailscale Printer Integration Enabled
  📍 Printer Server: 100.106.108.57:4001
  🔑 API Key: printer-server-key-2024
  🔒 Secure connection via Tailscale VPN
  ✅ Ready for production use
-->
<html lang="th" class="scroll-smooth" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>ประวัติใบเสร็จ - Tailscale Integrated</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="../js/activity-tracker.js"></script>
    <!-- Tailwind CSS & DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Socket.IO, Bootstrap Icons, Google Fonts -->
    <script src="/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <!-- Notification System CSS -->
    <link rel="stylesheet" href="/css/notification-system.css" />
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

    <!-- Branch Navigation and Sidebar -->
    <script src="/js/branch-navigation.js"></script>
    <!-- Notification System JavaScript -->
    <script src="/js/notification-system.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
  
    <style>
      :root {
        --primary-color: #0d6efd;
        --primary-hover: #138af2;
        --bg-color: #ffffff;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --transition-speed: 0.3s;
      }
      .dark {
        --primary-color: #ff8800;
        --primary-hover: #ffa733;
        --bg-color: #2a2a2a;
        --text-color: #ffffff;
        --border-color: #555555;
      }
      .bubble h6 {
        font-size: 0.875rem;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
      }
      aside.collapsed {
        width: 5rem;
      }
      aside.collapsed .ml-3 {
        display: none;
      }
      .bubble {
        width: 110px;
        height: 130px;
        border-radius: 0.75rem;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: transform var(--transition-speed);
        background-color: var(--primary-color);
        position: relative;
      }
      .bubble:hover {
        transform: scale(1.05);
        background-color: var(--primary-hover);
      }
      .flip-card {
        perspective: 1000px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 0.75rem;
        width: 200px;
        height: 420px;
      }
      .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.4s ease-in-out;
        transform-style: preserve-3d;
      }
      .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
      }
      .flip-card-front,
      .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 0.5rem;
      }
      .flip-card-back {
        transform: rotateY(180deg);
        background-color: var(--bg-color);
      }
      .product-price-big {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
      }
      .product-img {
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 0.25rem;
      }
      aside {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
        background-color: #ffffff;
      }
      h6 {
        white-space: normal;
        word-wrap: break-word;
        overflow: visible;
      }
      /* Main content with sidebar */
      #mainContent {
        margin-left: 14rem;
        transition: margin-left 0.3s ease-in-out;
      }
      #sidebar ul li a {
        color: #333333 !important;
      }
      
      /* Loading overlay */
            [data-theme="dark"]       .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 0.25rem solid #e0e0e0;
        border-top-color: #0d6efd;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  
  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner { border-top-color: #10b981; }
    .loading-success .loading-progress-fill { background: #10b981; }

    .loading-warning .loading-spinner { border-top-color: #f59e0b; }
    .loading-warning .loading-progress-fill { background: #f59e0b; }

    .loading-error .loading-spinner { border-top-color: #ef4444; }
    .loading-error .loading-progress-fill { background: #ef4444; }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function(window) {
      'use strict';

      console.log('🚀 LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-content';
    
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
    
        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || 'กำลังโหลด...';
    
        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';
    
          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }
    
        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);
    
        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function(options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();
    
            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);
    
            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }
    
            container.appendChild(overlay);
    
            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };
    
            activeLoaders.set(loaderId, loaderData);
    
            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }
    
            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }
    
            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });
    
            console.log(`✅ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;
    
          } catch (error) {
            console.error('❌ LoadingSystem.show() error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;
    
            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }
    
            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }
    
            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }
    
            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');
    
            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);
    
            console.log(`✅ LoadingSystem.hide() - ID: ${loaderId}`);
    
          } catch (error) {
            console.error('❌ LoadingSystem.hide() error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`✅ LoadingSystem.hideAll() - ซ่อน ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('❌ LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function(loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
          } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function(loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
              }
            }
          } catch (error) {
            console.error('❌ LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function() {
          return activeLoaders.size;
        },

        cleanup: function() {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('🧹 LoadingSystem.cleanup() - ล้างข้อมูลทั้งหมดแล้ว');
        },

        debug: function() {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup เมื่อออกจากหน้า
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('✅ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

</head>

  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
        </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <div class="flex min-h-screen">
      <!-- Main Content -->
      <div id="mainContent" class="flex-1 flex flex-col">
        <header class="p-4 bg-white dark:bg-gray-800 flex justify-between items-center">
          <div>
            <h1 class="text-xl font-bold" id="pageTitle">ประวัติใบเสร็จ</h1>
            <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">กำลังโหลดสาขา...</p>
            <p class="text-xs text-green-600 dark:text-green-400">
              <i class="bi bi-shield-check"></i> Tailscale Printer Integration
            </p>
          </div>
          
          <!-- Printer Settings & Notifications -->
          <div class="flex items-center gap-3">
            <!-- Printer Settings -->
            <button onclick="setupPrinterServer()" class="btn btn-sm btn-outline gap-2">
              <i class="bi bi-printer"></i>
              ตั้งค่าเครื่องพิมพ์
            </button>
            
            <!-- Test Printer Connection -->
            <button onclick="testPrinterConnection()" class="btn btn-sm btn-secondary gap-2">
              <i class="bi bi-wifi"></i>
              ทดสอบเครื่องพิมพ์
            </button>
            
            <!-- Test Direct Printer Connection -->
            <button onclick="testDirectPrinterConnection()" class="btn btn-sm btn-accent gap-2">
              <i class="bi bi-lightning"></i>
              ทดสอบโดยตรง
            </button>
            
            <!-- Test API -->
            <button onclick="testCombinedReceiptsAPI()" class="btn btn-sm btn-info gap-2">
              <i class="bi bi-database"></i>
              ทดสอบ API
            </button>
            
            <!-- Printer Help -->
            <button onclick="showPrinterHelp()" class="btn btn-sm btn-warning gap-2">
              <i class="bi bi-question-circle"></i>
              ช่วยเหลือ
            </button>
            
            <!-- Notifications -->
            <div class="relative" id="notificationWrapper">
              <button id="notificationButton" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-600 dark:text-gray-300">
                <i class="bi bi-bell-fill"></i>
              </button>
            <span id="notificationDot" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 w-2.5 h-2.5 rounded-full hidden"></span>
            <span id="notificationBadge" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs rounded-full px-1 min-w-[1rem] text-center hidden">0</span>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden z-30">
              <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="font-medium">การแจ้งเตือน</h3>
                <button class="text-sm text-primary-600 dark:text-primary-400">อ่านทั้งหมดแล้ว</button>
              </div>
              <div class="max-h-96 overflow-y-auto">
                <!-- Empty state -->
                <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                  <i class="bi bi-bell-slash text-2xl mb-2"></i>
                  <p>ไม่มีการแจ้งเตือนใหม่</p>
                </div>
                <!-- Notification items would go here -->
              </div>
              <div class="p-2 border-t border-gray-200 dark:border-gray-700 text-center">
                <a href="#" class="text-sm text-primary-600 dark:text-primary-400">ดูการแจ้งเตือนทั้งหมด</a>
              </div>
            </div>
            </div>
          </div>
        </header>

        <!-- Filter Form -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg mb-4 mx-4">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <div class="flex items-center gap-2">
              <label class="font-semibold">จากวันที่:</label>
              <input type="date" id="startDate" class="input input-bordered max-w-xs" />
            </div>
            <div class="flex items-center gap-2">
              <label class="font-semibold">ถึงวันที่:</label>
              <input type="date" id="endDate" class="input input-bordered max-w-xs" />
            </div>
            <div class="flex items-center gap-2">
              <label class="font-semibold">ค้นหาชื่อลูกค้า:</label>
              <input type="text" id="customerSearch" class="input input-bordered max-w-xs" placeholder="ชื่อหรือนามสกุล" />
            </div>
            <button id="btnFilter" class="btn btn-primary">
              <i class="bi bi-search mr-1"></i> ค้นหา
            </button>
          </div>
        </div>

        <!-- History Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-4 mx-4">
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead>
                <tr>
                  <th class="px-4 py-3">เลขที่ใบเสร็จ</th>
                  <th class="px-4 py-3">วันที่/เวลา</th>
                  <th class="px-4 py-3">ชื่อลูกค้า</th>
                  <th class="px-4 py-3">รวมเงิน</th>
                  <th class="px-4 py-3">ชื่อพนักงาน</th>
                  <th class="px-4 py-3 text-center">การดำเนินการ</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <tr>
                  <td colspan="6" class="text-center text-gray-500 py-8">
                    <i class="bi bi-inbox text-3xl"></i>
                    <p class="mt-2">กำลังโหลดข้อมูล หรือไม่พบรายการที่ตรงกับเงื่อนไขการค้นหา</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Pagination Controls -->
          <div class="flex justify-between items-center p-4 border-t">
            <div class="text-sm text-gray-500">
              แสดง <span id="currentRange">0-0</span> จาก <span id="totalItems">0</span> รายการ
            </div>
            <div class="flex gap-2" id="paginationControls">
              <button class="btn btn-sm btn-outline" id="prevPage" disabled>
                <i class="bi bi-chevron-left"></i> ก่อนหน้า
              </button>
              <button class="btn btn-sm btn-outline" id="nextPage" disabled>
                ถัดไป <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Receipt Detail Modal -->
    <div id="receiptModal" class="modal">
      <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg mb-4">รายละเอียดใบเสร็จ <span id="modalInvoiceNo"></span></h3>
        <!-- ... modal content ... -->
        <div class="modal-action">
          <button id="btnPrintReceipt" class="btn btn-info">
            <i class="bi bi-printer mr-1"></i> พิมพ์ใบเสร็จอีกครั้ง
          </button>
          <button id="btnCloseModal" class="btn">ปิด</button>
        </div>
      </div>
    </div>

    <script>
      // Function to show/hide loading overlay
            // ✅ Fix: Get branch code from URL parameter - ใช้ Pattani branch code
      const urlParams = new URLSearchParams(window.location.search);
      let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');

      if (!BRANCH_CODE) {
        console.warn("Branch code not specified, defaulting to '00004' (สาขาพัทลุง)");
        BRANCH_CODE = '00004'; // ✅ Fix: เปลี่ยนเป็น 00004 สำหรับสาขาพัทลุง
      }
      window.currentBranchCode = BRANCH_CODE;
      console.log(`[HistoryReceipt] Using branch code: ${BRANCH_CODE}`);

      let globalOutData = [];
      let filteredData = [];
      let currentPage = 1;
      const pageSize = 10;

      // Helper: format date/time
      function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        const dt = new Date(dateStr);
        const d = String(dt.getDate()).padStart(2, '0');
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const y = dt.getFullYear();
        const hh = String(dt.getHours()).padStart(2, '0');
        const mi = String(dt.getMinutes()).padStart(2, '0');
        return `${d}/${m}/${y} ${hh}:${mi}`;
      }

      // Fetch history data from Receipt and TaxInvoice models
      async function fetchCombinedReceiptsData() {
        const loaderId = LoadingSystem.show({
          message: 'กำลังโหลดประวัติใบเสร็จและใบกำกับภาษี...',
          showProgress: true,
          autoProgress: true
        });
      
        try {
          LoadingSystem.updateMessage(loaderId, 'เชื่อมต่อกับเซิร์ฟเวอร์...');
          LoadingSystem.updateProgress(loaderId, 25);
      
          const token = localStorage.getItem('authToken');
      
          // สร้าง URL พร้อม query parameters
          const params = new URLSearchParams({
            branchCode: BRANCH_CODE,
            limit: 100  // เพิ่มขีดจำกัดสำหรับการแสดงผล
          });
      
          const res = await fetch(`/api/combined-receipts?${params.toString()}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
      
          LoadingSystem.updateMessage(loaderId, 'กำลังประมวลผลข้อมูล...');
          LoadingSystem.updateProgress(loaderId, 75);
      
          // Robust response handling (avoid parsing HTML error as JSON)
          const contentType = res.headers.get('content-type') || '';
          if (!res.ok) {
            const errorText = await res.text().catch(() => '');
            console.error('API Error:', errorText.slice(0, 200));
            LoadingSystem.updateMessage(loaderId, 'เกิดข้อผิดพลาด!');
            setTimeout(() => LoadingSystem.hide(loaderId), 1000);
            return [];
          }
          if (!contentType.includes('application/json')) {
            const text = await res.text().catch(() => '');
            console.error('Unexpected response (not JSON):', text.slice(0, 200));
            LoadingSystem.updateMessage(loaderId, 'เกิดข้อผิดพลาด!');
            setTimeout(() => LoadingSystem.hide(loaderId), 1000);
            return [];
          }
          const js = await res.json();
          if (!js.success) {
            LoadingSystem.updateMessage(loaderId, 'เกิดข้อผิดพลาด!');
            setTimeout(() => LoadingSystem.hide(loaderId), 1000);
            console.error('API Error:', js);
            return [];
          }
      
          LoadingSystem.updateMessage(loaderId, 'จัดเรียงข้อมูล...');
          LoadingSystem.updateProgress(loaderId, 90);
      
          console.log(`✅ โหลดข้อมูลสำเร็จ: ${js.data.length} รายการ`);
          console.log(`📊 สรุป: ${js.summary.receipts} ใบเสร็จ, ${js.summary.taxInvoices} ใบกำกับภาษี`);
      
          // ✅ Debug: แสดงข้อมูลตัวอย่างเพื่อ debug
          if (js.data && js.data.length > 0) {
            console.log('📋 ตัวอย่างข้อมูลที่ได้รับ:', js.data.slice(0, 3));
            console.log('📋 ประเภทการชำระเงิน:', js.data.map(item => ({
              documentNumber: item.documentNumber,
              paymentMethod: item.paymentMethod,
              documentType: item.documentType,
              totalAmount: item.totalAmount
            })).slice(0, 5));
          } else {
            console.warn('⚠️ ไม่มีข้อมูลขายสดหรือข้อมูลถูกกรองออกหมด');
            console.log('🔍 Query parameters ที่ส่งไป:', params.toString());
            console.log('🔍 Branch Code:', BRANCH_CODE);
          }
      
          LoadingSystem.completeProgress(loaderId);
          return js.data || [];
      
        } catch (err) {
          console.error('Error fetching combined receipts:', err);
          LoadingSystem.updateMessage(loaderId, 'เกิดข้อผิดพลาดในการโหลดข้อมูล!');
          setTimeout(() => LoadingSystem.hide(loaderId), 2000);
          return [];
        }
      }
      
      // Keep the old function for backward compatibility (if needed)
      async function fetchOutHistoryData() {
        console.warn('⚠️ fetchOutHistoryData is deprecated, using fetchCombinedReceiptsData instead');
        return await fetchCombinedReceiptsData();
      }

      // Filter by date range - updated for Receipt/TaxInvoice data
      function filterByDateRange(data, startStr, endStr) {
        const start = startStr ? new Date(startStr) : null;
        const end = endStr ? new Date(endStr) : null;
        if (!start && !end) return data;
        return data.filter(item => {
          const dt = new Date(item.issueDate);  // ใช้ issueDate แทน performed_at
          if (start && dt < start) return false;
          if (end) {
            const endDate = new Date(endStr);
            endDate.setHours(23,59,59,999);
            if (dt > endDate) return false;
          }
          return true;
        });
      }

      // Paginate
      function paginate(data, page) {
        const i = (page - 1) * pageSize;
        return data.slice(i, i + pageSize);
      }

      // Render table
      function renderHistoryTable(data, page) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
      
        if (data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-gray-500 py-8">
                <i class="bi bi-inbox text-3xl"></i>
                <p class="mt-2">ไม่พบรายการขายสดที่ตรงกับเงื่อนไขการค้นหา</p>
                <p class="mt-1 text-sm">🔍 ตรวจสอบ Console (F12) เพื่อดู debug information</p>
                <p class="mt-1 text-xs">Branch: ${BRANCH_CODE} | Filter: Cash Sales Only</p>
              </td>
            </tr>`;
      
          // ✅ Debug: แสดงข้อมูลเพิ่มเติมเมื่อไม่มีข้อมูล
          console.warn('⚠️ ไม่มีข้อมูลแสดงในตาราง');
          console.log('🔍 Debug info:', {
            'data.length': data.length,
            'globalOutData.length': globalOutData.length,
            'filteredData.length': filteredData.length,
            'currentPage': currentPage,
            'pageSize': pageSize,
            'BRANCH_CODE': BRANCH_CODE
          });
      
          return;
        }
      
        const pageData = paginate(data, page);
        pageData.forEach(rec => {
          const tr = document.createElement('tr');

          // เลขที่เอกสาร - แสดงทั้ง Receipt และ TaxInvoice (ถ้ามี)
          const tdNo = document.createElement('td');
          tdNo.className = 'px-4 py-3 font-medium';
      
          // ตรวจสอบว่ามีเอกสารทั้งสองประเภทหรือไม่
          if (rec.relatedDocuments && rec.relatedDocuments.length > 0) {
            // กรณีมีเอกสารทั้งสองใบ
            rec.relatedDocuments.forEach((doc, index) => {
              if (index > 0) {
                tdNo.appendChild(document.createElement('br'));
              }
      
              const docTypeSpan = document.createElement('span');
              docTypeSpan.className = doc.documentType === 'TAX_INVOICE'
                ? 'badge badge-accent badge-sm mr-2'
                : 'badge badge-primary badge-sm mr-2';
              docTypeSpan.textContent = doc.documentType === 'TAX_INVOICE' ? '🧾 ภาษี' : '📄 เสร็จ';
      
              const docNumberSpan = document.createElement('span');
              docNumberSpan.textContent = doc.documentNumber || '-';
              docNumberSpan.className = 'text-sm';
      
              tdNo.appendChild(docTypeSpan);
              tdNo.appendChild(docNumberSpan);
            });
          } else {
            // กรณีมีเอกสารเดียว (รูปแบบเดิม)
            const docTypeSpan = document.createElement('span');
            docTypeSpan.className = rec.documentType === 'TAX_INVOICE'
              ? 'badge badge-accent badge-sm mr-2'
              : 'badge badge-primary badge-sm mr-2';
            docTypeSpan.textContent = rec.documentType === 'TAX_INVOICE' ? '🧾 ภาษี' : '📄 เสร็จ';
      
            const docNumberSpan = document.createElement('span');
            docNumberSpan.textContent = rec.documentNumber || rec.invoiceNo || '-';
      
            tdNo.appendChild(docTypeSpan);
            tdNo.appendChild(docNumberSpan);
          }
      
          tr.appendChild(tdNo);

          // วันที่/เวลา - ใช้ issueDate จาก Receipt/TaxInvoice
          const tdDt = document.createElement('td');
          tdDt.className = 'px-4 py-3';
          tdDt.textContent = formatDateTime(rec.issueDate);
          tr.appendChild(tdDt);

          // ชื่อลูกค้า - ใช้ customerName ที่จัดรูปแบบแล้ว
          const tdCust = document.createElement('td');
          tdCust.className = 'px-4 py-3';
          tdCust.textContent = rec.customerName || 'ลูกค้าทั่วไป';
          tr.appendChild(tdCust);

          // รวมเงิน - ใช้ totalAmount จาก Combined API
          const tdAmt = document.createElement('td');
          tdAmt.className = 'px-4 py-3 text-right';
          const amount = rec.totalAmount;
          tdAmt.textContent = (amount != null)
            ? Number(amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ฿'
            : '-';
          tr.appendChild(tdAmt);

          // ชื่อพนักงาน - ใช้ employeeName จาก Combined API
          const tdStaff = document.createElement('td');
          tdStaff.className = 'px-4 py-3';
          tdStaff.textContent = rec.employeeName || 'พนักงาน';
          tr.appendChild(tdStaff);

          // Actions
          const tdAct = document.createElement('td');
          tdAct.className = 'px-4 py-3 text-center';
      
          const btnGroup = document.createElement('div');
          btnGroup.className = 'flex justify-center gap-1 flex-wrap';
      
          // ตรวจสอบว่ามีเอกสารทั้งสองประเภทหรือไม่
          if (rec.relatedDocuments && rec.relatedDocuments.length > 1) {
            // กรณีมีเอกสารทั้งสองใบ - แสดงปุ่มแยกกัน
            const receiptDoc = rec.relatedDocuments.find(d => d.documentType === 'RECEIPT');
            const taxInvoiceDoc = rec.relatedDocuments.find(d => d.documentType === 'TAX_INVOICE');
      
            if (receiptDoc) {
              const btnPrintReceipt = document.createElement('button');
              btnPrintReceipt.className = 'btn btn-xs btn-primary';
              btnPrintReceipt.innerHTML = '<i class="bi bi-printer"></i> เสร็จ';
              btnPrintReceipt.title = 'พิมพ์ใบเสร็จรับเงิน';
              btnPrintReceipt.onclick = () => printPOS(receiptDoc);
              btnGroup.appendChild(btnPrintReceipt);
            }
      
            if (taxInvoiceDoc) {
              const btnPrintTax = document.createElement('button');
              btnPrintTax.className = 'btn btn-xs btn-accent';
              btnPrintTax.innerHTML = '<i class="bi bi-printer"></i> ภาษี';
              btnPrintTax.title = 'พิมพ์ใบกำกับภาษี';
              btnPrintTax.onclick = () => printPOS(taxInvoiceDoc);
              btnGroup.appendChild(btnPrintTax);
            }
      
            // ปุ่ม PDF รวม
            const btnPDF = document.createElement('button');
            btnPDF.className = 'btn btn-xs btn-info';
            btnPDF.innerHTML = '<i class="bi bi-file-pdf"></i> PDF';
            btnPDF.title = 'ดาวน์โหลด PDF ทั้งสองใบ';
            btnPDF.onclick = () => downloadA4PDFFromDocument(rec);
            btnGroup.appendChild(btnPDF);
      
          } else {
            // กรณีมีเอกสารเดียว (รูปแบบเดิม)
            const btnP = document.createElement('button');
            btnP.className = 'btn btn-sm btn-primary';
            btnP.innerHTML = '<i class="bi bi-printer mr-1"></i> พิมพ์';
            btnP.onclick = () => printPOS(rec);
            btnGroup.appendChild(btnP);
      
            const btnD = document.createElement('button');
            btnD.className = 'btn btn-sm btn-secondary';
            btnD.innerHTML = '<i class="bi bi-download mr-1"></i> ดาวน์โหลด';
            btnD.onclick = () => downloadReceiptImage(rec);
            btnGroup.appendChild(btnD);
      
            const btnPDF = document.createElement('button');
            btnPDF.className = 'btn btn-sm btn-accent';
            btnPDF.innerHTML = '<i class="bi bi-file-pdf mr-1"></i> A4 PDF';
            btnPDF.onclick = () => downloadA4PDFFromDocument(rec);
            btnGroup.appendChild(btnPDF);
          }
      
          tdAct.appendChild(btnGroup);
          tr.appendChild(tdAct);

          tbody.appendChild(tr);
        });
      }

      // Render pagination
      function renderPagination(data, page) {
        const total = data.length;
        document.getElementById('totalItems').textContent = total;
        const start = (page - 1) * pageSize + 1;
        const end = Math.min(start + pageSize - 1, total);
        document.getElementById('currentRange').textContent = total ? `${start}-${end}` : '0-0';

        const controls = document.getElementById('paginationControls');
        controls.querySelector('#prevPage').disabled = page <= 1;
        controls.querySelector('#nextPage').disabled = page >= Math.ceil(total / pageSize);
        controls.querySelector('#prevPage').onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderHistoryTable(filteredData, currentPage);
            renderPagination(filteredData, currentPage);
          }
        };
        controls.querySelector('#nextPage').onclick = () => {
          const maxP = Math.ceil(total / pageSize);
          if (currentPage < maxP) {
            currentPage++;
            renderHistoryTable(filteredData, currentPage);
            renderPagination(filteredData, currentPage);
          }
        };
      }

      // Filter handler
      function onFilter() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        const q = document.getElementById('customerSearch').value.trim().toLowerCase();
        filteredData = filterByDateRange(globalOutData, s, e);
        if (q) {
          filteredData = filteredData.filter(item => {
            // ใช้ customerName ที่จัดรูปแบบแล้วจาก Combined API
            const customerName = (item.customerName || '').toLowerCase();
            return customerName.includes(q);
          });
        }
        currentPage = 1;
        renderHistoryTable(filteredData, currentPage);
        renderPagination(filteredData, currentPage);
      }

      // Print POS
      async function printPOS(documentData) {
        // Handle backward compatibility
        if (typeof documentData === 'string') {
          documentData = { _id: documentData, documentType: 'RECEIPT', documentNumber: documentData };
        }
        const loaderId = LoadingSystem.show({
          message: 'กำลังเตรียมใบเสร็จ...',
          showProgress: true
        });
      
        try {
          const token = localStorage.getItem('authToken');
          if (!token) {
            LoadingSystem.hide(loaderId);
            alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            window.location.href = '/login';
            return;
          }
      
          LoadingSystem.updateMessage(loaderId, `กำลังสร้างรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}...`);
          LoadingSystem.updateProgress(loaderId, 30);
      
          // ใช้ API ใหม่ที่สร้างรูปภาพจากข้อมูล Receipt/TaxInvoice โดยตรง
          let res = await fetch('/api/pos/generate-receipt-image', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              documentType: documentData.documentType,
              documentId: documentData._id,
              documentNumber: documentData.documentNumber || documentData.invoiceNo,
              originalData: documentData.originalData || documentData
            })
          });
          // ไม่มี fallback ไป BranchStockHistory ตามนโยบายใหม่
      
          if (res.status === 401) {
            LoadingSystem.hide(loaderId);
            alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
            return;
          }
      
          LoadingSystem.updateMessage(loaderId, 'ประมวลผลข้อมูล...');
          LoadingSystem.updateProgress(loaderId, 60);
      
          // Robust response handling (avoid parsing HTML error as JSON)
          const contentType = res.headers.get('content-type') || '';
          if (!res.ok) {
            const errorText = await res.text().catch(() => '');
            throw new Error(`HTTP ${res.status}: ${errorText.slice(0, 200) || 'Request failed'}`);
          }
          if (!contentType.includes('application/json')) {
            const text = await res.text().catch(() => '');
            throw new Error(`Unexpected response (not JSON): ${text.slice(0, 200)}`);
          }
          const js = await res.json();
          if (!js.success || typeof js.base64Data !== 'string') {
            throw new Error(js.error || 'Invalid response format from API');
          }
      
          LoadingSystem.updateMessage(loaderId, 'ค้นหาเครื่องพิมพ์สำหรับสาขา...');
          LoadingSystem.updateProgress(loaderId, 70);
      
          // ✅ Fix: ใช้ PrinterSystem เพื่อดึง URL ปริ้นเตอร์ตามสาขา (async) พร้อม debug
          const printerServerURL = await PrinterSystem.getPrinterURL();
          console.log(`🖨️ ใช้เครื่องพิมพ์ที่: ${printerServerURL} สำหรับสาขา: ${PrinterSystem.getBranchName()}`);
          console.log(`📡 ส่งคำสั่งพิมพ์ผ่าน proxy endpoint: /api/printer/print`);
          console.log(`🔑 API Key: ${PrinterSystem.getAPIKey().substring(0, 10)}...`);
          console.log(`📄 Document data:`, {
            type: documentData.documentType,
            number: documentData.documentNumber,
            hasBase64: !!js.base64Data,
            base64Length: js.base64Data?.length || 0
          });
      
          LoadingSystem.updateMessage(loaderId, 'ส่งคำสั่งไปยังเครื่องพิมพ์...');
          LoadingSystem.updateProgress(loaderId, 80);
      
          // ใช้ proxy endpoint ใน server ของเราเองเพื่อหลีกเลี่ยงปัญหา HSTS
          // ใช้ XMLHttpRequest เพื่อบังคับ localhost และหลีกเลี่ยง redirect
          const currentHost = window.location.hostname;
          const currentPort = window.location.port || '3000';
      
          // ตรวจสอบว่าเป็น localhost หรือ production
          let proxyEndpoint;
          if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
            // ใช้ absolute URL สำหรับ localhost เพื่อป้องกันการ redirect
            proxyEndpoint = `http://localhost:${currentPort}/api/printer/print`;
          } else {
            // สำหรับ production ให้ใช้ relative URL
            proxyEndpoint = `/api/printer/print`;
          }
      
          console.log(`🔗 Current host: ${currentHost}:${currentPort}`);
          console.log(`🔗 Using proxy endpoint: ${proxyEndpoint}`);
      
          // ใช้ XMLHttpRequest แทน fetch เพื่อป้องกันการ redirect
          const apiKey = PrinterSystem.getAPIKey(); // ดึง API Key สำหรับ printer server
      
          const response = await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', proxyEndpoint, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-API-Key', apiKey); // เพิ่ม API Key header
            xhr.timeout = 15000; // 15 seconds timeout
      
            xhr.onload = function() {
              resolve({
                ok: xhr.status >= 200 && xhr.status < 300,
                status: xhr.status,
                json: async () => JSON.parse(xhr.responseText)
              });
            };
      
            xhr.onerror = function() {
              reject(new Error(`Network error: ${xhr.status} ${xhr.statusText}`));
            };
      
            xhr.ontimeout = function() {
              reject(new Error('Request timeout (15 seconds)'));
            };
      
            // ✅ Fix: เพิ่ม debug และ error handling ที่ดีขึ้น
            const printPayload = {
              image: js.base64Data,
              printerURL: printerServerURL,
              apiKey: apiKey,
              branchCode: BRANCH_CODE,
              documentType: documentData.documentType,
              documentNumber: documentData.documentNumber
            };
      
            console.log('📤 Sending print request:', {
              ...printPayload,
              image: `${printPayload.image?.substring(0, 50)}...`, // แสดงแค่ส่วนหน้า
              apiKey: `${printPayload.apiKey?.substring(0, 10)}...`
            });
      
            xhr.send(JSON.stringify(printPayload));
          });
      
          let pr;
          try {
            pr = await response.json();
          } catch (jsonError) {
            console.error('Failed to parse JSON response:', jsonError);
            throw new Error(`Server returned invalid JSON (HTTP ${response.status})`);
          }
      
          console.log('📥 Server response:', pr);
      
          // ✅ เพิ่ม debug การพิมพ์ที่ละเอียดขึ้น
          if (pr.success) {
            console.log('✅ Print command sent successfully to printer server');
            console.log('🖨️ Printer response details:', {
              success: pr.success,
              message: pr.message || pr.data?.message,
              printerURL: printerServerURL,
              imageSize: js.base64Data?.length || 0,
              timestamp: new Date().toISOString()
            });
      
            // ตรวจสอบว่าเครื่องพิมพ์ได้รับคำสั่งหรือไม่
            if (pr.data) {
              console.log('📄 Printer data response:', pr.data);
            }
      
            // แสดงข้อความแนะนำถ้ากระดาษไม่ออก
            setTimeout(() => {
              console.log('🔍 หากกระดาษไม่ออก ให้ตรวจสอบ:');
              console.log('   • เครื่องพิมพ์มีกระดาษหรือไม่');
              console.log('   • เครื่องพิมพ์เปิดใช้งานหรือไม่');
              console.log('   • สายไฟเครื่องพิมพ์เสียบดีหรือไม่');
              console.log('   • ลองกดปุ่ม Test Printer ด้านบน');
            }, 3000);
          } else {
            console.error('❌ Print command failed at printer server');
          }
      
          if (!response.ok || !pr.success) {
            const errorMsg = pr.error || pr.message || `HTTP ${response.status}: Print failed`;
            console.error('❌ Print failed:', errorMsg);
      
            // แสดงข้อความแนะนำการแก้ไขตามประเภทของ error
            let userFriendlyMsg = errorMsg;
            if (errorMsg.includes('Cannot connect to printer server') || errorMsg.includes('ECONNREFUSED')) {
              userFriendlyMsg = '🖨️ ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้\n\nกรุณาตรวจสอบ:\n• เครื่องพิมพ์เปิดใช้งานหรือไม่\n• การเชื่อมต่อเครือข่าย\n• IP Address และ Port ของเครื่องพิมพ์';
            } else if (errorMsg.includes('Cannot resolve hostname') || errorMsg.includes('ENOTFOUND')) {
              userFriendlyMsg = '🌐 ไม่พบที่อยู่เครื่องพิมพ์\n\nกรุณาตรวจสอบ:\n• IP Address ของเครื่องพิมพ์\n• การตั้งค่าเครือข่าย\n• การเชื่อมต่ออินเทอร์เน็ต';
            } else if (errorMsg.includes('timeout')) {
              userFriendlyMsg = '⏰ เครื่องพิมพ์ตอบสนองช้าเกินไป\n\nกรุณา:\n• ลองใหม่อีกครั้ง\n• ตรวจสอบการเชื่อมต่อเครือข่าย\n• รีสตาร์ทเครื่องพิมพ์';
            }
      
            throw new Error(userFriendlyMsg);
          }
      
          // Success
          LoadingSystem.hide(loaderId);
          const successId = LoadingSystem.show({
            message: 'พิมพ์ใบเสร็จสำเร็จ! 🖨️',
            type: 'success',
            timeout: 3000
          });
      
          // แสดง Toast notification
          if (window.showToast) {
            window.showToast('พิมพ์ใบเสร็จสำเร็จ! 🖨️', 'success');
          }
      
          // ✅ ตรวจสอบสถานะเครื่องพิมพ์หลังพิมพ์
          setTimeout(async () => {
            try {
              console.log('🔍 ตรวจสอบสถานะเครื่องพิมพ์หลังการพิมพ์...');
      
              const statusCheck = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', proxyEndpoint, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-API-Key', apiKey);
                xhr.timeout = 5000;
      
                xhr.onload = function() {
                  resolve({
                    ok: xhr.status >= 200 && xhr.status < 300,
                    json: async () => JSON.parse(xhr.responseText)
                  });
                };
      
                xhr.onerror = () => reject(new Error('Status check failed'));
                xhr.ontimeout = () => reject(new Error('Status check timeout'));
      
                xhr.send(JSON.stringify({
                  image: 'status-check',
                  printerURL: printerServerURL,
                  apiKey: apiKey
                }));
              });
      
              const statusResult = await statusCheck.json();
              console.log('📊 Printer status after print:', statusResult);
      
              if (!statusResult.success) {
                console.warn('⚠️ เครื่องพิมพ์อาจมีปัญหา หลังจากพิมพ์');
      
                // แสดงปุ่มช่วยเหลือ
                if (!document.getElementById('printerHelpBtn')) {
                  const helpBtn = document.createElement('button');
                  helpBtn.id = 'printerHelpBtn';
                  helpBtn.textContent = '🔧 ช่วยเหลือเครื่องพิมพ์';
                  helpBtn.className = 'fixed bottom-20 right-4 z-50 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-orange-600';
                  helpBtn.onclick = () => {
                    alert(`🖨️ คำแนะนำเครื่องพิมพ์:\n\n` +
                          `1. ตรวจสอบว่าเครื่องพิมพ์เปิดอยู่\n` +
                          `2. ตรวจสอบว่ามีกระดาษในเครื่องพิมพ์\n` +
                          `3. ตรวจสอบสายเคเบิลเครื่องพิมพ์\n` +
                          `4. ลองรีสตาร์ทเครื่องพิมพ์\n` +
                          `5. คลิก "ทดสอบเครื่องพิมพ์" ด้านบน\n\n` +
                          `หาก printer server ตอบกลับ success แต่กระดาษไม่ออก\n` +
                          `แสดงว่าปัญหาอยู่ที่ฮาร์ดแวร์เครื่องพิมพ์`);
                  };
                  document.body.appendChild(helpBtn);
      
                  setTimeout(() => {
                    if (document.getElementById('printerHelpBtn')) {
                      document.getElementById('printerHelpBtn').remove();
                    }
                  }, 15000);
                }
              }
      
            } catch (error) {
              console.warn('⚠️ ไม่สามารถตรวจสอบสถานะเครื่องพิมพ์ได้:', error.message);
            }
          }, 2000);
      
        } catch (err) {
          console.error('❌ Print error details:', err);
          LoadingSystem.hide(loaderId);
      
          // ✅ Fix: แสดง error message ที่เป็นมิตรกับผู้ใช้มากขึ้น
          let userFriendlyMessage = 'เกิดข้อผิดพลาดระหว่างพิมพ์ใบเสร็จ';
          let troubleshootingTips = '';
      
          if (err.message.includes('timeout') || err.message.includes('Request timeout')) {
            userFriendlyMessage = 'เครื่องพิมพ์ตอบสนองช้าเกินไป';
            troubleshootingTips = 'ลองตรวจสอบการเชื่อมต่อเครือข่ายและลองใหม่อีกครั้ง';
          } else if (err.message.includes('ECONNREFUSED') || err.message.includes('Cannot connect')) {
            userFriendlyMessage = 'ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้';
            troubleshootingTips = 'ตรวจสอบว่าเครื่องพิมพ์เปิดใช้งานและเชื่อมต่อเครือข่ายแล้ว';
          } else if (err.message.includes('ENOTFOUND') || err.message.includes('Cannot resolve')) {
            userFriendlyMessage = 'ไม่พบเครื่องพิมพ์ในเครือข่าย';
            troubleshootingTips = 'ตรวจสอบ IP Address ของเครื่องพิมพ์';
          } else if (err.message.includes('401') || err.message.includes('Unauthorized')) {
            userFriendlyMessage = 'ไม่มีสิทธิ์เข้าถึงเครื่องพิมพ์';
            troubleshootingTips = 'ตรวจสอบ API Key หรือเข้าสู่ระบบใหม่';
          }
      
          const errorId = LoadingSystem.show({
            message: `${userFriendlyMessage} ❌`,
            type: 'error',
            timeout: 6000
          });
      
          // แสดง detailed error ใน console สำหรับ debug
          console.log('🔧 Troubleshooting tips:', troubleshootingTips);
          console.log('🔧 For debugging: Open debug-printer-pattani.html for detailed testing');
      
          // แสดง Toast notification
          if (window.showToast) {
            window.showToast(`${userFriendlyMessage} ❌${troubleshootingTips ? '\n' + troubleshootingTips : ''}`, 'error');
          }
      
          // เพิ่มปุ่มช่วยเหลือ debug (ถ้ายังไม่มี)
          if (!document.getElementById('debugHelpBtn')) {
            const debugBtn = document.createElement('button');
            debugBtn.id = 'debugHelpBtn';
            debugBtn.textContent = '🔧 Debug Printer';
            debugBtn.className = 'fixed bottom-4 right-4 z-50 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-red-600';
            debugBtn.onclick = () => window.open('debug-printer-pattani.html', '_blank');
            document.body.appendChild(debugBtn);
      
            // ซ่อนปุ่มหลังจาก 10 วินาที
            setTimeout(() => {
              if (document.getElementById('debugHelpBtn')) {
                document.getElementById('debugHelpBtn').remove();
              }
            }, 10000);
          }
        }
      }

      // Download A4 PDF from Receipt or TaxInvoice document
      async function downloadA4PDFFromDocument(documentData) {
        const loaderId = LoadingSystem.show({
          message: `กำลังสร้าง A4 PDF ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จรับเงิน'}...`,
          showProgress: true
        });
      
        try {
          const token = localStorage.getItem('authToken');
          if (!token) {
            LoadingSystem.hide(loaderId);
            alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            window.location.href = '../login.html';
            return;
          }
      
          LoadingSystem.updateMessage(loaderId, 'กำลังสร้าง PDF...');
          LoadingSystem.updateProgress(loaderId, 50);
      
          // เลือก API ตามแหล่งข้อมูล
          let pdfRes;
          if (true) {
            // ใช้ A4 PDF API โดยตรงกับข้อมูล Receipt/TaxInvoice
            let pdfUrl;
            if (documentData.documentType === 'TAX_INVOICE') {
              pdfUrl = `/api/pdf/a4-tax-invoice`;
            } else {
              pdfUrl = `/api/pdf/a4-receipt`;
            }
            pdfRes = await fetch(pdfUrl, {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(documentData.originalData)
            });
          }
      
          if (!pdfRes.ok) {
            throw new Error(`HTTP ${pdfRes.status}: ไม่สามารถสร้าง PDF ได้`);
          }
      
          LoadingSystem.updateMessage(loaderId, 'กำลังดาวน์โหลด...');
          LoadingSystem.updateProgress(loaderId, 90);
      
          // ดาวน์โหลดไฟล์ PDF
          const blob = await pdfRes.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${documentData.documentType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt'}_${documentData.documentNumber}.pdf`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);
      
          LoadingSystem.updateProgress(loaderId, 100);
          LoadingSystem.hide(loaderId);
      
          const successId = LoadingSystem.show({
            message: `ดาวน์โหลด A4 PDF ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จรับเงิน'} สำเร็จ! 📄`,
            type: 'success',
            timeout: 3000
          });
      
          if (window.showToast) {
            window.showToast(`ดาวน์โหลด A4 PDF ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จรับเงิน'} สำเร็จ! 📄`, 'success');
          }
      
        } catch (error) {
          console.error('A4 PDF download error:', error);
          LoadingSystem.hide(loaderId);
      
          const errorId = LoadingSystem.show({
            message: 'เกิดข้อผิดพลาดระหว่างสร้าง A4 PDF! ❌',
            type: 'error',
            timeout: 4000
          });
      
          let errorMsg = error.message;
          if (errorMsg.includes('404')) {
            errorMsg = '🔍 ไม่พบข้อมูลเอกสารนี้ในระบบ\n\nอาจเป็นเพราะ:\n• เอกสารนี้ยังไม่ได้บันทึกสมบูรณ์\n• เลขที่เอกสารไม่ถูกต้อง';
          } else if (errorMsg.includes('500')) {
            errorMsg = '⚠️ ข้อผิดพลาดจากเซิร์ฟเวอร์\n\nกรุณา:\n• ลองใหม่อีกครั้ง\n• ตรวจสอบการเชื่อมต่อ\n• ติดต่อผู้ดูแลระบบ';
          }
      
          alert(`❌ ไม่สามารถสร้าง A4 PDF ได้\n\n${errorMsg}`);
      
          if (window.showToast) {
            window.showToast('เกิดข้อผิดพลาดระหว่างสร้าง A4 PDF! ❌', 'error');
          }
        }
      }
      
      // Keep old function for backward compatibility
      async function downloadA4PDF(historyId, invoiceNo) {
        console.warn('⚠️ downloadA4PDF is deprecated, please use downloadA4PDFFromDocument instead');
        // Try to find the document in current data
        const document = globalOutData.find(item => item._id === historyId || item.invoiceNo === invoiceNo);
        if (document) {
          return await downloadA4PDFFromDocument(document);
        } else {
          alert('ไม่พบข้อมูลเอกสาร กรุณารีเฟรชหน้าและลองใหม่อีกครั้ง');
        }
      }

      // Download image
      function base64ToBlob(b64, mime) {
        const bin = atob(b64);
        const arr = new Uint8Array(bin.length);
        for (let i=0; i<bin.length; i++) arr[i] = bin.charCodeAt(i);
        return new Blob([arr], {type: mime});
      }
      
      async function downloadReceiptImage(documentData) {
        // Handle backward compatibility
        if (typeof documentData === 'string') {
          documentData = { _id: documentData, documentType: 'RECEIPT', documentNumber: documentData };
        }
        const loaderId = LoadingSystem.show({
          message: 'กำลังเตรียมดาวน์โหลด...',
          showProgress: true
        });
      
        try {
          const token = localStorage.getItem('authToken');
          if (!token) {
            LoadingSystem.hide(loaderId);
            alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            window.location.href = '../login.html';
            return;
          }
      
          LoadingSystem.updateMessage(loaderId, `กำลังสร้างรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}...`);
          LoadingSystem.updateProgress(loaderId, 25);
      
          // ใช้ API ใหม่ที่สร้างรูปภาพจากข้อมูล Receipt/TaxInvoice โดยตรง
          const res = await fetch('/api/pos/generate-receipt-image', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              documentType: documentData.documentType,
              documentId: documentData._id,
              documentNumber: documentData.documentNumber || documentData.invoiceNo,
              originalData: documentData.originalData || documentData
            })
          });
      
          if (res.status === 401) {
            LoadingSystem.hide(loaderId);
            alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
            localStorage.removeItem('authToken');
            window.location.href = '../login.html';
            return;
          }
      
          LoadingSystem.updateMessage(loaderId, 'ประมวลผลข้อมูลภาพ...');
          LoadingSystem.updateProgress(loaderId, 50);
      
          // Robust response handling (avoid parsing HTML error as JSON)
          const contentType = res.headers.get('content-type') || '';
          if (!res.ok) {
            const errorText = await res.text().catch(() => '');
            throw new Error(`HTTP ${res.status}: ${errorText.slice(0, 200) || 'Request failed'}`);
          }
          if (!contentType.includes('application/json')) {
            const text = await res.text().catch(() => '');
            throw new Error(`Unexpected response (not JSON): ${text.slice(0, 200)}`);
          }
          const js = await res.json();
          if (!js.success || typeof js.base64Data !== 'string') {
            throw new Error(js.error || 'Invalid response format from API');
          }

          LoadingSystem.updateMessage(loaderId, 'แปลงข้อมูลภาพ...');
          LoadingSystem.updateProgress(loaderId, 75);

          // ดึง base64 string รองรับทั้งรูปแบบใหม่และ fallback เดิม
          let b64 = js.base64Data;
          if (typeof b64 !== 'string') {
            if (js.data && js.data.receiptImage) {
              b64 = js.data.receiptImage;
              if (typeof b64 === 'object' && b64.base64) b64 = b64.base64;
            }
          }
          if (typeof b64 !== 'string') {
            throw new Error('Invalid image data from API');
          }

          // ถ้ามี data URL prefix ให้ตัดออก
          const commaIdx = b64.indexOf(',');
          if (commaIdx !== -1 && b64.startsWith('data:')) {
            b64 = b64.slice(commaIdx + 1);
          }
          // 3) ลบ whitespace ทั้งหมด
          b64 = b64.replace(/\s/g, '');

          LoadingSystem.updateMessage(loaderId, 'กำลังดาวน์โหลดไฟล์...');
          LoadingSystem.updateProgress(loaderId, 90);

          // 4) แปลง base64 -> binary
          const binStr = atob(b64);
          const len    = binStr.length;
          const buf    = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            buf[i] = binStr.charCodeAt(i);
          }

          // 5) สร้าง Blob URL แล้วสั่งดาวน์โหลด
          const blobUrl = URL.createObjectURL(new Blob([buf], { type: 'image/png' }));
          const link    = document.createElement('a');
          link.href     = blobUrl;
          link.download = `${documentData.documentType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt'}_${documentData.documentNumber}.png`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(blobUrl);

          LoadingSystem.updateProgress(loaderId, 100);
      
          // Success
          LoadingSystem.hide(loaderId);
          const successId = LoadingSystem.show({
            message: `ดาวน์โหลดรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'} สำเร็จ! 📥`,
            type: 'success',
            timeout: 3000
          });
      
          // แสดง Toast notification
          if (window.showToast) {
            window.showToast(`ดาวน์โหลดรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'} สำเร็จ! 📥`, 'success');
          }

        } catch (err) {
          console.error(err);
          LoadingSystem.hide(loaderId);
          const errorId = LoadingSystem.show({
            message: `เกิดข้อผิดพลาดระหว่างดาวน์โหลดรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}! ❌`,
            type: 'error',
            timeout: 4000
          });
      
          // แสดง Toast notification
          if (window.showToast) {
            window.showToast(`เกิดข้อผิดพลาดระหว่างดาวน์โหลดรูปภาพ ${documentData.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}! ❌`, 'error');
          }
        }
      }

      // Load branch info
      async function loadBranchInfo() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch('/api/branch', { headers:{ Authorization:'Bearer '+token } });
          const js = await res.json();
          if (res.ok && js.success) {
            const b = js.data.find(x=>x.branch_code===BRANCH_CODE);
            if (b) document.getElementById('branchInfo').textContent = `${b.name} — ${b.address}`;
            else throw '';
          } else throw js.error||'';
        } catch {
          document.getElementById('branchInfo').textContent = 'สาขา: (ไม่พบข้อมูล)';
        }
      }

      // Setup Socket.IO for real-time notifications
      function setupSocketIO() {
        if (typeof io === 'undefined') {
          console.warn('Socket.IO ไม่พร้อมใช้งาน - ข้ามการตั้งค่า');
          return;
        }

        try {
          const socket = io();
      
          socket.on('connect', () => {
            console.log('🔗 Socket.IO connected for HistoryReceipt');
      
            // ส่งข้อมูลสาขาไปยังเซิร์ฟเวอร์เพื่อ join room
            socket.emit('join_branch', {
              branchCode: BRANCH_CODE,
              page: 'HistoryReceipt',
              timestamp: new Date().toISOString()
            });

            // ส่ง join notification room สำหรับระบบแจ้งเตือน
            socket.emit('join_notification_room', {
              branchCode: BRANCH_CODE,
              timestamp: new Date().toISOString()
            });
          });

          socket.on('disconnect', (reason) => {
            console.log('❌ Socket.IO disconnected:', reason);
          });

          // ฟัง notification events
          socket.on('notification', (data) => {
            if (window.showToast) {
              window.showToast(data.message, data.type || 'info');
            }
            if (window.showNotificationDot) {
              window.showNotificationDot();
            }
          });

          socket.on('broadcast_notification', (data) => {
            if (window.showToast) {
              window.showToast(`📢 ${data.message}`, data.type || 'info', 6000);
            }
            if (window.showNotificationDot) {
              window.showNotificationDot();
            }
          });

          socket.on('system_notification', (data) => {
            if (window.showToast) {
              window.showToast(`🔧 ${data.message}`, data.type || 'warning', 8000);
            }
            if (window.showNotificationDot) {
              window.showNotificationDot();
            }
          });

          socket.on('forceLogout', (data) => {
            if (window.showToast) {
              window.showToast(data.reason || 'คุณถูกออกจากระบบโดยผู้ดูแล', 'error', 5000);
            }
            setTimeout(() => {
              localStorage.clear();
              window.location.href = '/login.html';
            }, 3000);
          });

          // ฟัง receipt-related notifications
          socket.on('receipt_printed', (data) => {
            if (window.showToast) {
              window.showToast('มีการพิมพ์ใบเสร็จใหม่', 'success');
            }
          });

          socket.on('receipt_updated', (data) => {
            if (window.showToast) {
              window.showToast('ข้อมูลใบเสร็จได้รับการอัพเดท', 'info');
            }
            // รีโหลดข้อมูลประวัติใหม่
            refreshHistoryData();
          });

        } catch (error) {
          console.error('❌ Socket.IO setup error:', error);
        }
      }

      // Function to refresh history data
      async function refreshHistoryData() {
        try {
          const loaderId = LoadingSystem.show({
            message: 'รีเฟรชข้อมูล...',
            showProgress: true,
            timeout: 5000
          });
      
          globalOutData = await fetchCombinedReceiptsData();
          filteredData = globalOutData;
          renderHistoryTable(filteredData, currentPage);
          renderPagination(filteredData, currentPage);
      
          LoadingSystem.hide(loaderId);
        } catch (error) {
          console.error('Error refreshing data:', error);
        }
      }

      // ระบบพิมพ์ใบเสร็จ
      const PrinterSystem = {
        config: {
          branches: {
            '00000': {
              url: 'http://100.106.108.57:4001', // ✅ สำนักงานใหญ่ (จากฐานข้อมูล)
              name: 'สำนักงานใหญ่',
              apiKey: 'printer-server-key-2024'
            },
            '00001': {
              url: 'http://192.168.1.121:4001', // ✅ สาขาหาดใหญ่ (จากฐานข้อมูล)
              name: 'สาขาหาดใหญ่',
              apiKey: 'printer-server-key-2024'
            },
            '00002': {
              url: 'http://192.168.1.122:4001', // ✅ สาขาสตูล (จากฐานข้อมูล)
              name: 'สาขาสตูล',
              apiKey: 'printer-server-key-2024'
            },
            '00003': {
              url: 'http://100.106.108.124:4001', // ✅ Fix: ใช้ Tailscale IP สำหรับสาขาพัทลุง
              name: 'สาขาพัทลุง',
              apiKey: 'printer-server-key-2024'
            },
            '00004': {
              url: 'http://100.106.108.124:4001', // ✅ Fix: Tailscale IP สำหรับสาขาพัทลุง (เหมือน 00003)
              name: 'สาขาพัทลุง',
              apiKey: 'printer-server-key-2024'
            }
          },
          currentBranch: '00004', // ✅ Fix: เปลี่ยน default เป็นสาขาพัทลุง
          branchDataCache: null,
          lastBranchDataFetch: null
        },

        // ดึงข้อมูล branch จากฐานข้อมูล
        fetchBranchData: async function() {
          try {
            const cacheValid = this.config.branchDataCache &&
                             this.config.lastBranchDataFetch &&
                             (Date.now() - this.config.lastBranchDataFetch) < 300000; // 5 minutes cache
      
            if (cacheValid) {
              console.log('📋 ใช้ branch data จาก cache');
              return this.config.branchDataCache;
            }
      
            console.log('🌐 ดึงข้อมูล branch จากฐานข้อมูล...');
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/branch', {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
      
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
      
            const result = await response.json();
            if (result.success && result.data) {
              this.config.branchDataCache = result.data;
              this.config.lastBranchDataFetch = Date.now();
              console.log(`✅ ดึงข้อมูล ${result.data.length} สาขาสำเร็จ`);
              return result.data;
            } else {
              throw new Error('Invalid response format');
            }
          } catch (error) {
            console.error('❌ ไม่สามารถดึงข้อมูล branch:', error);
            return null;
          }
        },

        // ดึง URL ปริ้นเตอร์ตามสาขา (ดึงจากฐานข้อมูลก่อน)
        getPrinterURL: async function(branchCode = null) {
          const branch = branchCode || BRANCH_CODE || this.config.currentBranch;
          console.log(`🔍 ค้นหา printer URL สำหรับสาขา: ${branch}`);
      
          // 1. ลองดึงจากฐานข้อมูลก่อน
          try {
            const branchData = await this.fetchBranchData();
            if (branchData) {
              const branchInfo = branchData.find(b => b.branch_code === branch);
              if (branchInfo && branchInfo.printerServerUrl) {
                console.log(`✅ พบ printer URL จากฐานข้อมูล: ${branchInfo.printerServerUrl}`);
                return this.ensureHttp(branchInfo.printerServerUrl);
              } else {
                console.log(`⚠️ สาขา ${branch} ไม่มี printerServerUrl ในฐานข้อมูล`);
              }
            }
          } catch (error) {
            console.error('❌ ข้อผิดพลาดในการดึงข้อมูลฐานข้อมูล:', error);
          }
      
          // 2. ใช้ config สำรอง
          const branchConfig = this.config.branches[branch];
          if (branchConfig) {
            console.log(`✅ ใช้ printer URL จาก config: ${branchConfig.url}`);
            return this.ensureHttp(branchConfig.url);
          }
      
          // 3. ใช้ localStorage หรือ default
          const fallbackUrl = localStorage.getItem('printerServerURL') || 'http://100.106.108.57:4001';
          console.warn(`⚠️ ใช้ fallback printer URL: ${fallbackUrl}`);
          return this.ensureHttp(fallbackUrl);
        },

        // บังคับให้ใช้ HTTP (ป้องกันการ redirect เป็น HTTPS)
        ensureHttp: function(url) {
          if (url.startsWith('https://')) {
            const httpUrl = url.replace('https://', 'http://');
            console.log(`🔧 แปลง HTTPS เป็น HTTP: ${httpUrl}`);
            return httpUrl;
          }
          return url;
        },

        // ดึง API Key ตามสาขา
        getAPIKey: function(branchCode = null) {
          const branch = branchCode || BRANCH_CODE.toLowerCase() || this.config.currentBranch;
          const branchConfig = this.config.branches[branch];
      
          if (branchConfig && branchConfig.apiKey) {
            return branchConfig.apiKey;
          }
      
          // ใช้ default API key
          return 'printer-server-key-2024';
        },

        // ดึงชื่อสาขา
        getBranchName: function(branchCode = null) {
          const branch = branchCode || BRANCH_CODE.toLowerCase() || this.config.currentBranch;
          const branchConfig = this.config.branches[branch];
          return branchConfig ? branchConfig.name : `สาขา ${branch.toUpperCase()}`;
        },

        // แสดงการตั้งค่าปัจจุบัน (async)
        showCurrentConfig: async function() {
          const currentBranch = BRANCH_CODE || this.config.currentBranch;
          const printerURL = await this.getPrinterURL();
          const branchName = this.getBranchName();
          const apiKey = this.getAPIKey();
      
          return {
            branch: currentBranch,
            branchName: branchName,
            printerURL: printerURL,
            apiKey: apiKey,
            hasConfig: !!this.config.branches[currentBranch],
            tailscaleEnabled: true,
            printerServerIntegrated: true,
            fromDatabase: this.config.branchDataCache ? true : false
          };
        }
      };

      // Single DOMContentLoaded
      document.addEventListener('DOMContentLoaded', async () => {
        let pageLoaderId = null;
        try {
          pageLoaderId = LoadingSystem.show({
            message: 'กำลังเริ่มต้นระบบ...',
            showProgress: true
          });
      
          LoadingSystem.updateMessage(pageLoaderId, 'เริ่มต้นระบบแจ้งเตือน...');
          LoadingSystem.updateProgress(pageLoaderId, 10);
      
          // เริ่มต้น Socket.IO สำหรับแจ้งเตือน
          setupSocketIO();
      
          LoadingSystem.updateMessage(pageLoaderId, 'โหลดข้อมูลสาขา...');
          LoadingSystem.updateProgress(pageLoaderId, 20);
          await loadBranchInfo();

          LoadingSystem.updateMessage(pageLoaderId, 'ดึงประวัติใบเสร็จ...');
          LoadingSystem.updateProgress(pageLoaderId, 40);
      
          // 1) ดึง data ประวัติจาก Receipt และ TaxInvoice
          globalOutData = await fetchCombinedReceiptsData();
          filteredData  = globalOutData;
          console.log('Loaded history data:', globalOutData); // debug
      
          // Debug: ดูข้อมูลตัวอย่างเพื่อตรวจสอบฟิลด์ที่มี
          if (globalOutData.length > 0) {
            console.log('Sample record fields:', Object.keys(globalOutData[0]));
            console.log('Sample record:', globalOutData[0]);
          }
      
          LoadingSystem.updateMessage(pageLoaderId, 'จัดเรียงข้อมูล...');
          LoadingSystem.updateProgress(pageLoaderId, 80);
      
          // 2) แสดงตาราง + pagination
          renderHistoryTable(filteredData, currentPage);
          renderPagination(filteredData, currentPage);
      
          LoadingSystem.updateMessage(pageLoaderId, 'ตั้งค่า Event Listeners...');
          LoadingSystem.updateProgress(pageLoaderId, 95);
      
          // 3) ผูก event ค้นหา
          document.getElementById('btnFilter').addEventListener('click', onFilter);
          document.getElementById('customerSearch').addEventListener('keyup', e => {
            if (e.key === 'Enter') onFilter();
          });
      
          LoadingSystem.completeProgress(pageLoaderId);
      
        } catch (error) {
          console.error('Page loading error:', error);
          if (pageLoaderId) {
            LoadingSystem.hide(pageLoaderId);
            const errorLoaderId = LoadingSystem.show({
              message: 'เกิดข้อผิดพลาดในการโหลดหน้าเว็บ! ❌',
              type: 'error',
              timeout: 5000
            });
          }
        }
      });

      // เพิ่มฟังก์ชันสำหรับการทดสอบ Notification System
      window.testHistoryNotifications = function() {
        console.log('🧪 Testing notification system in HistoryReceipt...');
      
        if (window.testNotifications) {
          window.testNotifications();
        } else if (window.showToast) {
          window.showToast('ทดสอบแจ้งเตือนในหน้าประวัติใบเสร็จ', 'info');
          setTimeout(() => window.showToast('พิมพ์ใบเสร็จสำเร็จ! 🖨️', 'success'), 1000);
          setTimeout(() => window.showToast('ดาวน์โหลดสำเร็จ! 📥', 'success'), 2000);
          setTimeout(() => window.showToast('เกิดข้อผิดพลาด! ❌', 'error'), 3000);
        }
      
        console.log('✅ Test notifications sent! ดูที่มุมขวาบนและคลิกไอคอน 🔔');
      };
      
              console.log('📖 HistoryReceipt - Available test functions:');
        console.log('   • testHistoryNotifications() - ทดสอบระบบแจ้งเตือน');
        console.log('   • testCombinedReceiptsAPI() - ทดสอบ API combined-receipts');
        console.log('   • testDirectPrinterConnection() - ทดสอบเครื่องพิมพ์');
        console.log('🔔 Notification system integrated successfully in HistoryReceipt.html');
      
        // ✅ Enhanced HistoryReceipt Integration Status
        console.log('📄 Direct Receipt/TaxInvoice Integration Status:');
        console.log('  • Data Source: ✅ Receipt & TaxInvoice models (via /api/combined-receipts)');
        console.log('  • Document Types: ✅ Receipt (ใบเสร็จ) & TaxInvoice (ใบกำกับภาษี)');
        console.log('  • A4 PDF Support: ✅ Direct from Receipt/TaxInvoice data');
        console.log('  • API Endpoints:');
        console.log('    - /api/combined-receipts (data source)');
        console.log('    - /api/pdf/a4-receipt (Receipt PDF)');
        console.log('    - /api/pdf/a4-tax-invoice (TaxInvoice PDF)');
        console.log('  • Visual Features: ✅ Document type badges, separate PDF handling');
        console.log('  • Available functions:');
        console.log('    - fetchCombinedReceiptsData() - ดึงข้อมูลรวม Receipt+TaxInvoice');
        console.log('    - downloadA4PDFFromDocument(document) - ดาวน์โหลด A4 PDF แยกตามประเภท');
        console.log('    - testDirectReceiptIntegration() - ทดสอบการทำงานใหม่');
      
        // ฟังก์ชันทดสอบระบบใหม่
        window.testDirectReceiptIntegration = function() {
          if (globalOutData && globalOutData.length > 0) {
            const firstRecord = globalOutData[0];
            console.log('🧪 Testing Direct Receipt/TaxInvoice integration:');
            console.log('📄 Document Type:', firstRecord.documentType);
            console.log('📋 Document Number:', firstRecord.documentNumber);
            console.log('👤 Customer:', firstRecord.customerName);
            console.log('💰 Amount:', firstRecord.totalAmount);
            console.log('🏢 Branch:', firstRecord.branchCode);
      
            // ทดสอบดาวน์โหลด PDF
            downloadA4PDFFromDocument(firstRecord);
          } else {
            console.warn('⚠️ No data available for test');
            alert('ไม่มีข้อมูลสำหรับทดสอบ กรุณาโหลดข้อมูลก่อน');
          }
        };
      
        // Keep old test function for backward compatibility
        window.testA4PDFFeature = function() {
          console.warn('⚠️ testA4PDFFeature is deprecated, using testDirectReceiptIntegration instead');
          window.testDirectReceiptIntegration();
        };
      
        console.log('✅ Enhanced HistoryReceipt with Direct Receipt/TaxInvoice Integration!');
      
        // Database Integration Info
        console.log('🗄️ Database Printer Integration Status:');
        console.log('  • Default Branch: 00000 (สำนักงานใหญ่)');
        console.log('  • Fallback URL: http://100.106.108.57:4001');
        console.log('  • API Key: printer-server-key-2024');
        console.log('  • Data Source: Database (with config fallback)');
        console.log('  • Available functions:');
        console.log('    - testDirectPrinterConnection() - ทดสอบเชื่อมต่อโดยตรง (async)');
        console.log('    - showPrinterSettings() - แสดงการตั้งค่าปัจจุบัน (async)');
        console.log('    - PrinterSystem.showCurrentConfig() - ดูข้อมูลการตั้งค่า (async)');
        console.log('    - PrinterSystem.fetchBranchData() - ดึงข้อมูลสาขาจากฐานข้อมูล');
        console.log('✅ Database-Driven Printer Server Integration Ready!');

        // ✅ ฟังก์ชันทดสอบ API combined-receipts โดยตรง
        window.testCombinedReceiptsAPI = async function() {
          const loaderId = LoadingSystem.show({
            message: 'กำลังทดสอบ API combined-receipts...',
            showProgress: true
          });
      
          try {
            const token = localStorage.getItem('authToken');
            const params = new URLSearchParams({
              branchCode: BRANCH_CODE,
              limit: 10
            });
      
            console.log('🔍 Testing combined-receipts API...');
            console.log('🔍 URL:', `/api/combined-receipts?${params.toString()}`);
            console.log('🔍 Branch Code:', BRANCH_CODE);
      
            const response = await fetch(`/api/combined-receipts?${params.toString()}`, {
              headers: { 'Authorization': 'Bearer ' + token }
            });
      
            console.log('📡 Response status:', response.status);
            console.log('📡 Response headers:', [...response.headers.entries()]);
      
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
      
            const result = await response.json();
            console.log('📊 API Response:', result);
      
            LoadingSystem.hide(loaderId);
      
            let message = `📊 API Test Results:\n\n`;
            message += `✅ Status: ${response.status} OK\n`;
            message += `📋 Success: ${result.success}\n`;
            message += `📊 Data Count: ${result.data ? result.data.length : 0}\n`;
            message += `🏪 Branch Code: ${BRANCH_CODE}\n`;
      
            if (result.summary) {
              message += `📄 Receipts: ${result.summary.receipts}\n`;
              message += `🧾 Tax Invoices: ${result.summary.taxInvoices}\n`;
              message += `📋 Total: ${result.summary.total}\n`;
            }
      
            if (result.data && result.data.length > 0) {
              message += `\n📋 ตัวอย่างข้อมูล:\n`;
              result.data.slice(0, 3).forEach((item, index) => {
                message += `${index + 1}. ${item.documentNumber} (${item.documentType})\n`;
                message += `   💰 ${item.totalAmount} บาท | 💳 ${item.paymentMethod}\n`;
              });
            } else {
              message += `\n⚠️ ไม่มีข้อมูลขายสดสำหรับสาขา ${BRANCH_CODE}\n`;
              message += `กรุณาตรวจสอบ:\n`;
              message += `• มีรายการขายสดในระบบหรือไม่\n`;
              message += `• paymentMethod = 'cash'\n`;
              message += `• ไม่มี contractNo หรือ downPaymentAmount\n`;
            }
      
            alert(message);
      
          } catch (error) {
            console.error('❌ API Test Error:', error);
            LoadingSystem.hide(loaderId);
            alert(`❌ API Test Failed:\n\n${error.message}`);
          }
        };

        // ✅ ฟังก์ชันช่วยเหลือเครื่องพิมพ์
        window.showPrinterHelp = function() {
          let helpMessage = `🖨️ คู่มือแก้ปัญหาเครื่องพิมพ์ POS\n\n`;
      
          helpMessage += `📋 ปัญหาที่พบบ่อย:\n`;
          helpMessage += `• Server ตอบ success แต่กระดาษไม่ออก\n`;
          helpMessage += `• เครื่องพิมพ์ไม่ตอบสนอง\n`;
          helpMessage += `• การเชื่อมต่อขาดหาย\n\n`;
      
          helpMessage += `🔧 วิธีแก้ไขทีละขั้น:\n\n`;
          helpMessage += `1️⃣ ตรวจสอบฮาร์ดแวร์:\n`;
          helpMessage += `   • เครื่องพิมพ์เปิดหรือไม่ (ไฟเขียว)\n`;
          helpMessage += `   • มีกระดาษในเครื่องพิมพ์หรือไม่\n`;
          helpMessage += `   • สายไฟและสาย USB เสียบแน่นหรือไม่\n`;
          helpMessage += `   • ฝาเครื่องพิมพ์ปิดสนิทหรือไม่\n\n`;
      
          helpMessage += `2️⃣ ตรวจสอบการเชื่อมต่อ:\n`;
          helpMessage += `   • คลิก "ทดสอบเครื่องพิมพ์" ด้านบน\n`;
          helpMessage += `   • ดูใน Console (F12) หาข้อความ error\n`;
          helpMessage += `   • IP: http://100.119.4.117:4002 (สาขาสตูล)\n\n`;
      
          helpMessage += `3️⃣ วิธีแก้ไขขั้นสูง:\n`;
          helpMessage += `   • รีสตาร์ทเครื่องพิมพ์ (ถอดปลั๊ก 10 วิ)\n`;
          helpMessage += `   • รีสตาร์ทคอมพิวเตอร์\n`;
          helpMessage += `   • ตรวจสอบ Printer Driver\n`;
          helpMessage += `   • ลองเปลี่ยนสาย USB\n\n`;
      
          helpMessage += `4️⃣ สำหรับ IT Support:\n`;
          helpMessage += `   • เปิด debug-printer-pattani.html\n`;
          helpMessage += `   • ตรวจสอบ Network Configuration\n`;
          helpMessage += `   • ดู Printer Server Logs\n`;
          helpMessage += `   • ตรวจสอบ Firewall Settings\n\n`;
      
          helpMessage += `🆘 หากยังแก้ไม่ได้:\n`;
          helpMessage += `กรุณาติดต่อ IT Support พร้อมส่งภาพหน้าจอ Console (F12)`;
      
          alert(helpMessage);
        };

        // ฟังก์ชันสำหรับตั้งค่าเซิร์ฟเวอร์ปริ้นเตอร์
        window.setupPrinterServer = async function() {
          const loaderId = LoadingSystem.show({
            message: 'กำลังโหลดการตั้งค่าปัจจุบัน...',
            timeout: 5000
          });
      
          try {
            const config = await PrinterSystem.showCurrentConfig();
      
            LoadingSystem.hide(loaderId);
      
            let message = `🖨️ การตั้งค่าเครื่องพิมพ์ (Database Integrated)\n\n`;
            message += `สาขาปัจจุบัน: ${config.branchName} (${config.branch.toUpperCase()})\n`;
            message += `URL ปัจจุบัน: ${config.printerURL}\n`;
            message += `API Key: ${config.apiKey.substring(0, 10)}...\n`;
            message += `Tailscale: ${config.tailscaleEnabled ? '✅ เปิดใช้งาน' : '❌ ปิดใช้งาน'}\n`;
            message += `ข้อมูลจากฐานข้อมูล: ${config.fromDatabase ? '✅ ใช่' : '❌ ไม่ใช่'}\n`;
            message += `การตั้งค่า: ${config.hasConfig ? '✅ มีการตั้งค่าอัตโนมัติ' : '⚠️ ใช้ fallback'}\n\n`;
      
            if (config.fromDatabase) {
              message += `✅ ระบบดึง URL จากฐานข้อมูลอัตโนมัติ\n`;
              message += `การเชื่อมต่อผ่าน Tailscale มีความปลอดภัยสูง\n\n`;
              message += `ต้องการตั้งค่า fallback URL หรือไม่?\n`;
              message += `(URL นี้จะใช้เมื่อไม่สามารถเชื่อมต่อฐานข้อมูลได้)`;
            } else if (config.hasConfig) {
              message += `⚠️ ใช้การตั้งค่าสำรองจาก config\n\n`;
              message += `ต้องการเปลี่ยน URL เครื่องพิมพ์หรือไม่?\n`;
              message += `(การเปลี่ยนแปลงจะบันทึกเป็น fallback สำหรับกรณีฉุกเฉิน)`;
            } else {
              message += `❌ ไม่พบการตั้งค่าในฐานข้อมูล\n\n`;
              message += `กรุณาใส่ URL ของเซิร์ฟเวอร์ปริ้นเตอร์:\n`;
              message += `(แนะนำ: ใช้ Tailscale IP สำหรับความปลอดภัย)`;
            }
      
            const newURL = prompt(message, config.printerURL);
      
            if (newURL && newURL.trim() && newURL.trim() !== config.printerURL) {
              localStorage.setItem('printerServerURL', newURL.trim());
      
              let successMessage = `✅ ตั้งค่าเซิร์ฟเวอร์ปริ้นเตอร์เรียบร้อย: ${newURL.trim()}\n\n`;
      
              if (config.fromDatabase) {
                successMessage += `หมายเหตุ: URL นี้จะใช้เป็น fallback เมื่อไม่สามารถเชื่อมต่อฐานข้อมูลได้\n`;
                successMessage += `ระบบจะใช้ URL จากฐานข้อมูลเป็นหลัก`;
              } else {
                successMessage += `หมายเหตุ: URL นี้จะใช้เป็น fallback เมื่อไม่พบการตั้งค่าอัตโนมัติ\n`;
                successMessage += `สำหรับการใช้งาน Tailscale แนะนำ IP: 100.106.108.57:4001`;
              }
      
              alert(successMessage);
            }
          } catch (error) {
            LoadingSystem.hide(loaderId);
            alert(`❌ เกิดข้อผิดพลาดในการโหลดการตั้งค่า:\n${error.message}`);
          }
        };

        // ฟังก์ชันทดสอบการเชื่อมต่อเครื่องพิมพ์
        window.testPrinterConnection = async function() {
          const loaderId = LoadingSystem.show({
            message: 'กำลังทดสอบการเชื่อมต่อเครื่องพิมพ์...',
            showProgress: true
          });
      
          try {
            LoadingSystem.updateProgress(loaderId, 25);
      
            const printerURL = await PrinterSystem.getPrinterURL();
            console.log(`🔍 Testing printer connection to: ${printerURL}`);
      
            LoadingSystem.updateMessage(loaderId, 'ส่งคำขอทดสอบ...');
            LoadingSystem.updateProgress(loaderId, 50);
      
            // ใช้ endpoint logic เดียวกับ printPOS function
            const currentHost = window.location.hostname;
            const currentPort = window.location.port || '3000';
      
            let proxyEndpoint;
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
              proxyEndpoint = `http://localhost:${currentPort}/api/printer/print`;
            } else {
              proxyEndpoint = `/api/printer/print`;
            }
      
            console.log(`🔗 Test using endpoint: ${proxyEndpoint}`);
      
            const apiKey = PrinterSystem.getAPIKey(); // ดึง API Key สำหรับ printer server
      
            const response = await new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              xhr.open('POST', proxyEndpoint, true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.setRequestHeader('X-API-Key', apiKey); // เพิ่ม API Key header
              xhr.timeout = 8000; // 8 seconds timeout for test
      
              xhr.onload = function() {
                resolve({
                  ok: xhr.status >= 200 && xhr.status < 300,
                  status: xhr.status,
                  json: async () => JSON.parse(xhr.responseText)
                });
              };
      
              xhr.onerror = function() {
                reject(new Error(`Network error: ${xhr.status} ${xhr.statusText}`));
              };
      
              xhr.ontimeout = function() {
                reject(new Error('Test timeout (8 seconds)'));
              };
      
              xhr.send(JSON.stringify({
                image: 'test',
                printerURL: printerURL,
                apiKey: apiKey // ส่ง API Key ใน body ด้วย
              }));
            });
      
            LoadingSystem.updateProgress(loaderId, 80);
      
            const result = await response.json();
      
            LoadingSystem.updateProgress(loaderId, 100);
            LoadingSystem.hide(loaderId);
      
            if (response.ok && result.success) {
              const successId = LoadingSystem.show({
                message: '✅ เชื่อมต่อเครื่องพิมพ์สำเร็จ!',
                type: 'success',
                timeout: 3000
              });
      
              if (window.showToast) {
                window.showToast('✅ เชื่อมต่อเครื่องพิมพ์สำเร็จ!', 'success');
              }
            } else {
              throw new Error(result.error || 'Connection test failed');
            }
      
          } catch (error) {
            console.error('Printer connection test failed:', error);
            LoadingSystem.hide(loaderId);
      
            const errorId = LoadingSystem.show({
              message: '❌ ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้',
              type: 'error',
              timeout: 5000
            });
      
            let errorMsg = error.message;
            if (errorMsg.includes('Cannot connect to printer server')) {
              errorMsg = '🖨️ ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้\n\nกรุณาตรวจสอบ:\n• เครื่องพิมพ์เปิดใช้งานหรือไม่\n• การเชื่อมต่อเครือข่าย\n• IP Address: ' + printerURL;
            }
      
            alert(`❌ การทดสอบเชื่อมต่อล้มเหลว\n\n${errorMsg}`);
      
            if (window.showToast) {
              window.showToast('❌ การทดสอบเชื่อมต่อเครื่องพิมพ์ล้มเหลว', 'error');
            }
          }
        };

        // ฟังก์ชันแสดงการตั้งค่าปัจจุบัน
        window.showPrinterSettings = async function() {
          const loaderId = LoadingSystem.show({
            message: 'กำลังโหลดการตั้งค่า...',
            timeout: 3000
          });
      
          try {
            const config = await PrinterSystem.showCurrentConfig();
      
            LoadingSystem.hide(loaderId);
      
            let message = `🖨️ ข้อมูลการตั้งค่าเครื่องพิมพ์ (Database Integrated)\n\n`;
            message += `สาขา: ${config.branchName} (${config.branch.toUpperCase()})\n`;
            message += `URL เครื่องพิมพ์: ${config.printerURL}\n`;
            message += `API Key: ${config.apiKey.substring(0, 10)}...\n`;
            message += `Tailscale: ${config.tailscaleEnabled ? '✅ เปิดใช้งาน' : '❌ ปิดใช้งาน'}\n`;
            message += `ข้อมูลจากฐานข้อมูล: ${config.fromDatabase ? '✅ ใช่' : '❌ ไม่ใช่'}\n`;
            message += `Printer Server: ${config.printerServerIntegrated ? '✅ รองรับ' : '❌ ไม่รองรับ'}\n`;
            message += `สถานะ: ${config.hasConfig ? '✅ ตั้งค่าอัตโนมัติ' : '⚠️ ใช้ fallback'}\n\n`;
      
            if (config.fromDatabase) {
              message += `✅ ระบบดึง printer URL จากฐานข้อมูลอัตโนมัติ\n`;
              message += `จะพิมพ์ใบเสร็จไปที่เครื่องพิมพ์ที่กำหนดในฐานข้อมูล\n`;
              message += `มีการรับรองความปลอดภัยด้วย API Key\n`;
              message += `การเชื่อมต่อผ่าน Tailscale VPN`;
            } else if (config.hasConfig) {
              message += `⚠️ ใช้การตั้งค่าสำรองจาก config\n`;
              message += `ไม่พบ printerServerUrl ในฐานข้อมูลสำหรับสาขานี้`;
            } else {
              message += `❌ ใช้ fallback URL\n`;
              message += `กรุณาตรวจสอบการตั้งค่าในฐานข้อมูล`;
            }
      
            message += `\n\nคลิก "ตั้งค่าเครื่องพิมพ์" เพื่อเปลี่ยนแปลง`;
      
            alert(message);
          } catch (error) {
            LoadingSystem.hide(loaderId);
            alert(`❌ เกิดข้อผิดพลาดในการโหลดการตั้งค่า:\n${error.message}`);
          }
        };

        // ฟังก์ชันทดสอบการเชื่อมต่อกับ Printer Server โดยตรง
        window.testDirectPrinterConnection = async function() {
          const loaderId = LoadingSystem.show({
            message: 'ทดสอบการเชื่อมต่อ Printer Server โดยตรง...',
            showProgress: true
          });
      
          try {
            LoadingSystem.updateMessage(loaderId, 'ดึงข้อมูลการตั้งค่า...');
            LoadingSystem.updateProgress(loaderId, 10);
      
            const printerURL = await PrinterSystem.getPrinterURL();
            const apiKey = PrinterSystem.getAPIKey();
      
            console.log(`🔍 Testing direct connection to: ${printerURL}`);
            console.log(`🔑 Using API Key: ${apiKey.substring(0, 10)}...`);
      
            LoadingSystem.updateMessage(loaderId, 'ตรวจสอบสถานะ Printer Server...');
            LoadingSystem.updateProgress(loaderId, 25);
      
            // ใช้ proxy endpoint เพื่อหลีกเลี่ยง SSL protocol error
            console.log('🔗 Using proxy endpoint to avoid SSL protocol error');
      
            // ทดสอบ health check ผ่าน proxy
            const healthResponse = await fetch('/api/printer/print', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
              },
              body: JSON.stringify({
                image: 'health-check',
                printerURL: printerURL,
                apiKey: apiKey
              })
            });
      
            const healthData = await healthResponse.json();
            console.log('🏥 Health check result:', healthData);
      
            LoadingSystem.updateMessage(loaderId, 'ตรวจสอบสถานะเครื่องพิมพ์...');
            LoadingSystem.updateProgress(loaderId, 50);
      
            // ทดสอบ status check ผ่าน proxy
            const statusResponse = await fetch('/api/printer/print', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
              },
              body: JSON.stringify({
                image: 'status-check',
                printerURL: printerURL,
                apiKey: apiKey
              })
            });
      
            const statusData = await statusResponse.json();
            console.log('📊 Status check result:', statusData);
      
            LoadingSystem.updateMessage(loaderId, 'ทดสอบการพิมพ์...');
            LoadingSystem.updateProgress(loaderId, 75);
      
            // ทดสอบ test print ผ่าน proxy
            const testResponse = await fetch('/api/printer/print', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
              },
              body: JSON.stringify({
                image: 'test-print',
                printerURL: printerURL,
                apiKey: apiKey
              })
            });
      
            const testData = await testResponse.json();
            console.log('🧪 Test print result:', testData);
      
            LoadingSystem.updateProgress(loaderId, 100);
            LoadingSystem.hide(loaderId);
      
            // แสดงผลลัพธ์ (proxy response format)
            let resultMessage = `🖨️ ผลการทดสอบ Printer Server (ผ่าน Proxy)\n\n`;
            resultMessage += `URL: ${printerURL}\n`;
            resultMessage += `API Key: ${apiKey.substring(0, 10)}...\n\n`;
      
            // proxy response จะเป็น {success: true/false, message: "..."}
            const healthSuccess = healthData.success || false;
            const statusSuccess = statusData.success || false;
            const testSuccess = testData.success || false;
      
            resultMessage += `Health Check: ${healthSuccess ? '✅ ผ่าน' : '❌ ล้มเหลว'}\n`;
            resultMessage += `Status Check: ${statusSuccess ? '✅ ผ่าน' : '❌ ล้มเหลว'}\n`;
            resultMessage += `Test Print: ${testSuccess ? '✅ ผ่าน' : '❌ ล้มเหลว'}\n\n`;
      
            if (healthSuccess && statusSuccess && testSuccess) {
              resultMessage += `🎉 การเชื่อมต่อสำเร็จทั้งหมด!\n`;
              resultMessage += `Printer Server พร้อมใช้งาน`;
      
              const successId = LoadingSystem.show({
                message: '✅ ทดสอบ Printer Server สำเร็จ!',
                type: 'success',
                timeout: 3000
              });
      
            } else {
              resultMessage += `⚠️ มีปัญหาในการเชื่อมต่อ\n`;
              resultMessage += `กรุณาตรวจสอบการตั้งค่าและเครื่องพิมพ์\n\n`;
      
              // แสดงรายละเอียดข้อผิดพลาดจาก proxy
              if (healthData.message) resultMessage += `Health: ${healthData.message}\n`;
              if (statusData.message) resultMessage += `Status: ${statusData.message}\n`;
              if (testData.message) resultMessage += `Test: ${testData.message}\n`;
            }
      
            alert(resultMessage);
      
            if (window.showToast) {
              window.showToast(healthSuccess && statusSuccess && testSuccess ?
                '✅ ทดสอบ Printer Server สำเร็จ!' :
                '❌ การทดสอบ Printer Server ล้มเหลว',
                healthSuccess && statusSuccess && testSuccess ? 'success' : 'error'
              );
            }
      
          } catch (error) {
            console.error('Direct printer test failed:', error);
            LoadingSystem.hide(loaderId);
      
            const errorId = LoadingSystem.show({
              message: '❌ ไม่สามารถเชื่อมต่อ Printer Server ได้',
              type: 'error',
              timeout: 5000
            });
      
            let errorMsg = `❌ การทดสอบ Printer Server ล้มเหลว\n\n`;
            errorMsg += `Error: ${error.message}\n\n`;
            errorMsg += `กรุณาตรวจสอบ:\n`;
            errorMsg += `• Printer Server ทำงานอยู่หรือไม่\n`;
            errorMsg += `• Tailscale เชื่อมต่อแล้วหรือไม่\n`;
            errorMsg += `• IP Address และ Port ถูกต้องหรือไม่\n`;
            errorMsg += `• API Key ถูกต้องหรือไม่`;
      
            alert(errorMsg);
      
            if (window.showToast) {
              window.showToast('❌ ทดสอบ Printer Server ล้มเหลว: ' + error.message, 'error');
            }
          }
        };
    </script>

    <!-- Printer Service - Multi-Branch Support -->
    <script src="/js/printer-service.js"></script>
    
    <script>
      // เพิ่ม BRANCH_CODE global variable สำหรับ PrinterService
      window.BRANCH_CODE = 'PATTANI'; // สามารถเปลี่ยนตาม branch ที่ใช้งาน
      
      // อัพเดท printPOS function ให้ใช้ PrinterService
      if (typeof window.PrinterService !== 'undefined') {
        console.log('🖨️ PrinterService available, upgrading printPOS function...');
      
        // Override printPOS function ให้ใช้ PrinterService
        window.printPOSWithService = async function(id) {
          const loaderId = LoadingSystem.show({
            message: 'กำลังพิมพ์ใบเสร็จ...',
            showProgress: true
          });
      
          try {
            LoadingSystem.updateMessage(loaderId, 'ดึงข้อมูลใบเสร็จ...');
            LoadingSystem.updateProgress(loaderId, 25);
      
            const token = localStorage.getItem('authToken');
            if (!token) {
              LoadingSystem.hide(loaderId);
              alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
              window.location.href = '../login.html';
              return;
            }
      
            const res = await fetch(`/api/pos/history-receipt-image?historyId=${id}`, {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              }
            });
      
            if (res.status === 401) {
              LoadingSystem.hide(loaderId);
              alert('กรุณาเข้าสู่ระบบใหม่อีกครั้ง');
              localStorage.removeItem('authToken');
              window.location.href = '../login.html';
              return;
            }
      
            const js = await res.json();
            if (!res.ok || !js.success) {
              throw new Error(js.error || js.message || 'ไม่สามารถดึงข้อมูลใบเสร็จได้');
            }
      
            if (!js.data.receiptImage) {
              throw new Error('ไม่พบข้อมูลรูปภาพใบเสร็จ');
            }
      
            LoadingSystem.updateMessage(loaderId, 'ส่งคำสั่งพิมพ์...');
            LoadingSystem.updateProgress(loaderId, 75);
      
            // ใช้ PrinterService แทนการส่งแบบเดิม
            const result = await window.PrinterService.print(js.data.receiptImage, {
              documentType: 'history_receipt',
              historyId: id,
              timestamp: new Date().toISOString()
            });
      
            LoadingSystem.updateProgress(loaderId, 100);
            LoadingSystem.hide(loaderId);
      
            const successId = LoadingSystem.show({
              message: 'พิมพ์ใบเสร็จสำเร็จ! 🖨️',
              type: 'success',
              timeout: 3000
            });
      
            if (window.showToast) {
              window.showToast('พิมพ์ใบเสร็จสำเร็จ! 🖨️', 'success');
            }
      
          } catch (error) {
            console.error('Print error:', error);
            LoadingSystem.hide(loaderId);
      
            const errorId = LoadingSystem.show({
              message: 'เกิดข้อผิดพลาดระหว่างพิมพ์! ❌',
              type: 'error',
              timeout: 4000
            });
      
            if (window.showToast) {
              window.showToast('เกิดข้อผิดพลาดระหว่างพิมพ์: ' + error.message, 'error');
            }
          }
        };
      
        // อัพเดท testPrinterConnection ให้ใช้ PrinterService
        window.testPrinterConnectionWithService = async function() {
          const loaderId = LoadingSystem.show({
            message: 'ทดสอบการเชื่อมต่อเครื่องพิมพ์...',
            showProgress: true
          });
      
          try {
            LoadingSystem.updateProgress(loaderId, 50);
      
            const status = await window.PrinterService.getStatus();
      
            LoadingSystem.updateProgress(loaderId, 100);
            LoadingSystem.hide(loaderId);
      
            if (status.status === 'connected' || status.status === 'ready') {
              const successId = LoadingSystem.show({
                message: '✅ เชื่อมต่อเครื่องพิมพ์สำเร็จ!',
                type: 'success',
                timeout: 3000
              });
      
              if (window.showToast) {
                window.showToast('✅ เชื่อมต่อเครื่องพิมพ์สำเร็จ!', 'success');
              }
            } else {
              throw new Error(status.message || 'ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้');
            }
      
          } catch (error) {
            console.error('Printer test failed:', error);
            LoadingSystem.hide(loaderId);
      
            const errorId = LoadingSystem.show({
              message: '❌ ไม่สามารถเชื่อมต่อเครื่องพิมพ์ได้',
              type: 'error',
              timeout: 5000
            });
      
            if (window.showToast) {
              window.showToast('❌ ทดสอบเชื่อมต่อเครื่องพิมพ์ล้มเหลว: ' + error.message, 'error');
            }
          }
        };
      
        // แสดงการตั้งค่าใหม่
        window.showPrinterSettingsWithService = function() {
          const branchInfo = window.PrinterService.getCurrentBranch();
      
          let message = `🖨️ ข้อมูลการตั้งค่าเครื่องพิมพ์ (PrinterService)\n\n`;
          message += `สาขาปัจจุบัน: ${branchInfo.code || 'ไม่ระบุ'}\n`;
          message += `ชื่อสาขา: ${branchInfo.data?.name || 'ไม่พบข้อมูล'}\n`;
          message += `URL เครื่องพิมพ์: ${branchInfo.printerURL || 'ไม่ได้ตั้งค่า'}\n`;
          message += `สถานะระบบ: ${window.PrinterService.isInitialized ? '✅ พร้อมใช้งาน' : '⚠️ กำลังเริ่มต้น'}\n\n`;
      
          if (branchInfo.data && branchInfo.data.printerServerUrl) {
            message += `✅ พบการตั้งค่าอัตโนมัติจากฐานข้อมูล\n`;
            message += `ระบบจะพิมพ์ไปยังเครื่องพิมพ์ของสาขาโดยอัตโนมัติ`;
          } else {
            message += `⚠️ ไม่พบการตั้งค่าอัตโนมัติ\n`;
            message += `กำลังใช้การตั้งค่าเริ่มต้น`;
          }
      
          alert(message);
        };
      
        console.log('✅ HistoryReceipt-PrinterService integration completed');
        console.log('📖 Available functions: printPOSWithService(), testPrinterConnectionWithService(), showPrinterSettingsWithService()');
      } else {
        console.warn('⚠️ PrinterService not available in HistoryReceipt');
      }
      
      // ข้อมูลเกี่ยวกับ Database Integration
      console.log('🔧 Database Printer Integration Summary:');
      console.log('   Data Source: https://www.2pheenong.com/api/branch');
      console.log('   Default Branch: 00000 (สำนักงานใหญ่)');
      console.log('   Fallback IP: 100.106.108.57:4001');
      console.log('   API Key: printer-server-key-2024');
      console.log('   Status: ✅ Database-Driven & Ready');
      console.log('   Benefits: 🗄️ Dynamic, 🔄 Auto-Update, 🔒 Secure, 🌐 Multi-Branch');
      console.log('');
      console.log('🎯 Quick Test Commands (All Async):');
      console.log('   await testDirectPrinterConnection() - ทดสอบเชื่อมต่อ Printer Server');
      console.log('   await showPrinterSettings() - ดูการตั้งค่าปัจจุบัน');
      console.log('   await PrinterSystem.showCurrentConfig() - ดูข้อมูลเต็ม');
      console.log('   await PrinterSystem.fetchBranchData() - ดึงข้อมูลสาขาจากฐานข้อมูล');
      console.log('');
      console.log('📖 Documentation: Database integration allows dynamic printer');
      console.log('   configuration per branch with secure Tailscale connections.');
    </script>

    <script>
      // Lottie Loading Animation Function
      let lottieAnimation = null;

      function showLoading(message = 'กำลังโหลด...') {
        const overlay = document.getElementById('loadingOverlay');
        const container = document.getElementById('lottieContainer');

        if (overlay && container) {
          // Show overlay
          overlay.style.display = 'flex';
          overlay.classList.remove('animate__fadeOut');
          overlay.classList.add('animate__fadeIn');

          // Initialize Lottie animation if not already done
          if (!lottieAnimation && window.lottie) {
            lottieAnimation = window.lottie.loadAnimation({
              container: container,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              path: 'https://assets2.lottiefiles.com/packages/lf20_x62chJ.json'
            });
          }

          // Show message if provided
          if (message) {
            console.log('Loading:', message);
          }
        }
      }

      function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.classList.remove('animate__fadeIn');
          overlay.classList.add('animate__fadeOut');
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 500);
        }
      }

      // Initialize loading on page load
      document.addEventListener('DOMContentLoaded', function() {
        showLoading('กำลังโหลดประวัติใบเสร็จ...');

        // Auto-hide loading after page is fully loaded
        window.addEventListener('load', function() {
          setTimeout(hideLoading, 1000);
        });
      });

      // Make functions globally available
      window.showLoading = showLoading;
      window.hideLoading = hideLoading;
    </script>
  </body>
</html>
