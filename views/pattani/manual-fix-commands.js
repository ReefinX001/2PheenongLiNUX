// ================================================
// üõ†Ô∏è MANUAL FIX COMMANDS
// ================================================
// Version: 1.0.0
// ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

console.log('üõ†Ô∏è Manual Fix Commands Loading...');

// ================================================
// 1. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πà‡∏ß‡∏ô
// ================================================

window.QuickFix = {
  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  fixAll() {
    console.log('üö® Running all quick fixes...');

    const fixes = [
      this.fixToastError,
      this.fixSyntaxError,
      this.fixLoadingStuck,
      this.fixModuleError,
      this.forceShowContent
    ];

    const results = [];

    fixes.forEach((fix, index) => {
      try {
        fix.call(this);
        results.push(`‚úÖ Fix ${index + 1} completed`);
      } catch (error) {
        console.error(`‚ùå Fix ${index + 1} failed:`, error);
        results.push(`‚ùå Fix ${index + 1} failed`);
      }
    });

    console.log('üèÅ Quick fixes completed:', results);

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    if (window.showToast || window.InstallmentCore?.showToast) {
      const toastFn = window.InstallmentCore?.showToast || window.showToast;
      toastFn('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', 'info');
    }

    return results;
  },

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Toast Error
  fixToastError() {
    console.log('üîß Fixing toast error...');

    // ‡∏•‡∏ö toast containers ‡πÄ‡∏Å‡πà‡∏≤
    document.querySelectorAll('[id*="toast"], .toast-container').forEach(el => {
      if (el.parentNode) el.parentNode.removeChild(el);
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á toast container ‡πÉ‡∏´‡∏°‡πà
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container fixed top-4 right-4 z-50';
    container.style.cssText = 'position: fixed !important; top: 1rem !important; right: 1rem !important; z-index: 9999 !important;';
    document.body.appendChild(container);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fallback toast function
    if (!window.showToast) {
      window.showToast = function(message, type) {
        console.log(`Toast: ${message} (${type})`);
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 9999;
          padding: 12px 20px; border-radius: 6px; color: white; font-weight: 500;
          background: ${type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#2563eb'};
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      };
    }

    console.log('‚úÖ Toast error fixed');
  },

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Syntax Error
  fixSyntaxError() {
    console.log('üîß Checking syntax errors...');

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô syntax errors
    const problematicScripts = document.querySelectorAll('script[src*="installment-main.js"]');
    problematicScripts.forEach(script => {
      script.setAttribute('data-syntax-checked', 'true');
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fallback functions
    const fallbackFunctions = {
      formatPrice: (num) => new Intl.NumberFormat('th-TH').format(num),
      showToast: (msg, type) => console.log(`${type}: ${msg}`),
      validateRequired: (value) => Boolean(value && value.toString().trim())
    };

    Object.entries(fallbackFunctions).forEach(([name, func]) => {
      if (!window[name]) {
        window[name] = func;
      }
    });

    console.log('‚úÖ Syntax errors checked');
  },

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
  fixLoadingStuck() {
    console.log('üîß Fixing loading stuck...');

    // ‡∏ã‡πà‡∏≠‡∏ô loading screens ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const loadingSelectors = [
      '.loading', '.loader', '#loading', '#loader',
      '.loading-overlay', '.loading-screen', '.spinner',
      '[class*="loading"]', '[id*="loading"]'
    ];

    loadingSelectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => {
        el.style.display = 'none';
        el.classList.add('hidden');
      });
    });

    console.log('‚úÖ Loading stuck fixed');
  },

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏°‡∏î‡∏π‡∏•
  fixModuleError() {
    console.log('üîß Fixing module errors...');

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á fallback modules
    const fallbackModules = {
      InstallmentCore: {
        showToast: (message, type) => console.log(`Toast: ${message} (${type})`),
        formatPrice: (num) => new Intl.NumberFormat('th-TH').format(num),
        validateRequired: (value) => Boolean(value && value.toString().trim())
      },
      InstallmentUI: {
        showToast: (message, type) => console.log(`UI Toast: ${message} (${type})`)
      }
    };

    Object.entries(fallbackModules).forEach(([moduleName, moduleObj]) => {
      if (!window[moduleName]) {
        window[moduleName] = moduleObj;
        console.log(`‚úÖ Created fallback module: ${moduleName}`);
      }
    });

    console.log('‚úÖ Module errors fixed');
  },

  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
  forceShowContent() {
    console.log('üîß Force showing content...');

    // ‡πÅ‡∏™‡∏î‡∏á main content
    const mainElements = document.querySelectorAll('main, #mainContent, .main-content, .container');
    mainElements.forEach(el => {
      el.style.display = 'block';
      el.classList.remove('hidden');
      el.style.visibility = 'visible';
      el.style.opacity = '1';
    });

    // ‡πÅ‡∏™‡∏î‡∏á steps
    const stepElements = document.querySelectorAll('#step1, #step2, #step3, #step4');
    stepElements.forEach(el => {
      if (el) {
        el.style.display = 'block';
        el.classList.remove('hidden');
      }
    });

    console.log('‚úÖ Content force shown');
  }
};

// ================================================
// 2. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
// ================================================

window.SystemCheck = {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  checkAll() {
    console.log('üîç Checking system status...');

    const checks = {
      modules: this.checkModules(),
      dom: this.checkDOM(),
      functions: this.checkFunctions(),
      ui: this.checkUI(),
      errors: this.checkErrors()
    };

    console.log('üìä System Check Results:', checks);

    const healthy = Object.values(checks).every(check => check.status === 'ok');

    console.log(healthy ? '‚úÖ System is healthy' : '‚ö†Ô∏è System has issues');

    return checks;
  },

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡∏î‡∏π‡∏•
  checkModules() {
    const modules = ['InstallmentCore', 'InstallmentUI', 'InstallmentAPI', 'InstallmentBusiness', 'InstallmentProduct'];
    const available = modules.filter(name => window[name]);

    return {
      status: available.length >= 3 ? 'ok' : 'warning',
      total: modules.length,
      available: available.length,
      missing: modules.filter(name => !window[name])
    };
  },

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö DOM
  checkDOM() {
    const elements = ['step1', 'step2', 'step3', 'step4', 'mainContent'];
    const found = elements.filter(id => document.getElementById(id));

    return {
      status: found.length >= 4 ? 'ok' : 'warning',
      total: elements.length,
      found: found.length,
      missing: elements.filter(id => !document.getElementById(id))
    };
  },

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
  checkFunctions() {
    const functions = ['showToast', 'formatPrice'];
    const available = functions.filter(name => typeof window[name] === 'function');

    return {
      status: available.length >= 1 ? 'ok' : 'error',
      total: functions.length,
      available: available.length,
      missing: functions.filter(name => typeof window[name] !== 'function')
    };
  },

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UI
  checkUI() {
    const uiElements = ['btnStep1ToStep2', 'cartCount', 'formProgress'];
    const found = uiElements.filter(id => document.getElementById(id));

    return {
      status: found.length >= 2 ? 'ok' : 'warning',
      total: uiElements.length,
      found: found.length,
      missing: uiElements.filter(id => !document.getElementById(id))
    };
  },

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö errors
  checkErrors() {
    const errors = [];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console errors
    if (window.lastError) {
      errors.push(window.lastError);
    }

    return {
      status: errors.length === 0 ? 'ok' : 'warning',
      count: errors.length,
      errors: errors
    };
  }
};

// ================================================
// 3. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
// ================================================

window.EmergencyCommands = {
  // ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏£‡∏∞‡∏ö‡∏ö
  restartSystem() {
    console.log('üîÑ Restarting system...');

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
    window.cartItems = [];
    window.currentStep = 1;

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI
    const cartCount = document.getElementById('cartCount');
    if (cartCount) cartCount.textContent = '0';

    const formProgress = document.getElementById('formProgress');
    if (formProgress) formProgress.textContent = '0%';

    // ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (window.QuickFix) {
      window.QuickFix.fixAll();
    }

    console.log('‚úÖ System restarted');

    if (window.showToast) {
      window.showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }
  },

  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  clearAllData() {
    console.log('üóëÔ∏è Clearing all data...');

    // ‡∏•‡πâ‡∏≤‡∏á localStorage
    Object.keys(localStorage).forEach(key => {
      if (key.includes('installment') || key.includes('cart')) {
        localStorage.removeItem(key);
      }
    });

    // ‡∏•‡πâ‡∏≤‡∏á global variables
    window.cartItems = [];
    window.customerData = {};
    window.currentStep = 1;

    console.log('‚úÖ All data cleared');

    if (window.showToast) {
      window.showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
    }
  },

  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
  forceRefresh() {
    console.log('üîÑ Force refreshing page...');

    if (window.showToast) {
      window.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤...', 'info');
    }

    setTimeout(() => {
      window.location.reload(true);
    }, 1000);
  }
};

// ================================================
// 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠
// ================================================

// ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
window.fix = window.QuickFix.fixAll;
window.check = window.SystemCheck.checkAll;
window.restart = window.EmergencyCommands.restartSystem;
window.clear = window.EmergencyCommands.clearAllData;
window.refresh = window.EmergencyCommands.forceRefresh;

// ================================================
// 5. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ
// ================================================

function showAvailableCommands() {
  console.log(`
üõ†Ô∏è === MANUAL FIX COMMANDS AVAILABLE ===

üìã QUICK FIXES:
   QuickFix.fixAll() ‡∏´‡∏£‡∏∑‡∏≠ fix() - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   QuickFix.fixToastError() - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Toast
   QuickFix.fixSyntaxError() - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Syntax Error
   QuickFix.fixLoadingStuck() - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
   QuickFix.fixModuleError() - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏°‡∏î‡∏π‡∏•
   QuickFix.forceShowContent() - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤

üîç SYSTEM CHECK:
   SystemCheck.checkAll() ‡∏´‡∏£‡∏∑‡∏≠ check() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   SystemCheck.checkModules() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡∏î‡∏π‡∏•
   SystemCheck.checkDOM() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö DOM elements
   SystemCheck.checkFunctions() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
   SystemCheck.checkUI() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UI elements

üö® EMERGENCY COMMANDS:
   EmergencyCommands.restartSystem() ‡∏´‡∏£‡∏∑‡∏≠ restart() - ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏£‡∏∞‡∏ö‡∏ö
   EmergencyCommands.clearAllData() ‡∏´‡∏£‡∏∑‡∏≠ clear() - ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   EmergencyCommands.forceRefresh() ‡∏´‡∏£‡∏∑‡∏≠ refresh() - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤

üí° ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏¢‡πà‡∏≠: fix(), check(), restart(), clear(), refresh()

üîß ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ: fix()
  `);
}

// ================================================
// 6. Auto-run ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
// ================================================

setTimeout(() => {
  showAvailableCommands();
}, 1000);

console.log('üõ†Ô∏è Manual Fix Commands Loaded');
console.log('üí° Type "fix()" to fix all problems or see console for more commands');