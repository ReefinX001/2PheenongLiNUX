<!DOCTYPE html>
<html lang="th" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ú‡πà‡∏≠‡∏ô / InstallmentOrder)</title>

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="../js/activity-tracker.js"></script>
    <script src="/js/branch-navigation.js"></script>
    <!-- Notification System JavaScript -->
    <script src="/js/notification-system.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
    />
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
  <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
      .loading-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
      }

      .dark .loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }
    </style>

    <script>
      let lottieAnimation = null;
    </script>

    <!-- Local CSS Loading Animation - No external dependencies -->
    <style>
      /* Enhanced Local Loading Animation */
      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      .loading-dots {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin: 20px 0;
      }

      .loading-dot {
        width: 12px;
        height: 12px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s ease-in-out infinite both;
      }

      .loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .loading-dot:nth-child(2) { animation-delay: -0.16s; }
      .loading-dot:nth-child(3) { animation-delay: 0; }

      .loading-text {
        color: #374151;
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-top: 16px;
        font-family: 'Noto Sans Thai', sans-serif;
      }

      .loading-progress {
        width: 200px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin: 20px auto;
        overflow: hidden;
      }

      .loading-progress-bar {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
        background-size: 200% 100%;
        animation: progress 2s ease-in-out infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      @keyframes progress {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .dark .loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }

      .dark .loading-text {
        color: #f9fafb;
      }

      .dark .loading-spinner {
        border-color: #374151;
        border-top-color: #60a5fa;
      }

      .dark .loading-dot {
        background: #60a5fa;
      }
    </style>
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Notification System CSS -->
  <link rel="stylesheet" href="/css/notification-system.css" />
    <style>
      body {
        font-family: "Prompt", sans-serif;
        background-color: #f3f4f6; /* Tailwind's bg-gray-100 */
      }
      .page-link {
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        margin: 0 0.25rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
            .bubble h6 {
        font-size: 0.875rem;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
      }
      .page-link.active {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }
      .page-link:hover {
        background-color: #e2e2e2;
        transform: translateY(-1px);
      }
      .loading {
        position: relative;
      }
      .loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Loading overlay */
            [data-theme="dark"]       #loadingOverlay .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 0.25rem solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
  
  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner { border-top-color: #10b981; }
    .loading-success .loading-progress-fill { background: #10b981; }

    .loading-warning .loading-spinner { border-top-color: #f59e0b; }
    .loading-warning .loading-progress-fill { background: #f59e0b; }

    .loading-error .loading-spinner { border-top-color: #ef4444; }
    .loading-error .loading-progress-fill { background: #ef4444; }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function(window) {
      'use strict';

      console.log('üöÄ LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-content';
    
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
    
        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    
        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';
    
          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }
    
        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);
    
        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function(options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();
    
            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);
    
            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }
    
            container.appendChild(overlay);
    
            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };
    
            activeLoaders.set(loaderId, loaderData);
    
            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }
    
            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }
    
            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });
    
            console.log(`‚úÖ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;
    
          } catch (error) {
            console.error('‚ùå LoadingSystem.show() error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;
    
            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }
    
            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }
    
            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }
    
            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');
    
            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);
    
            console.log(`‚úÖ LoadingSystem.hide() - ID: ${loaderId}`);
    
          } catch (error) {
            console.error('‚ùå LoadingSystem.hide() error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`‚úÖ LoadingSystem.hideAll() - ‡∏ã‡πà‡∏≠‡∏ô ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('‚ùå LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function(loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
    } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function(loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
      }
            }
          } catch (error) {
            console.error('‚ùå LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function() {
          return activeLoaders.size;
        },

        cleanup: function() {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('üßπ LoadingSystem.cleanup() - ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
        },

        debug: function() {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('‚úÖ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

</head>

  <body class="flex flex-col min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between ml-56 transition-all duration-300"
                     id="mainHeader">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤...
        </p>
      </div>

      <!-- Notifications -->
      <div class="relative" id="notificationWrapper">
        <button id="notificationButton" class="notification-button">
          <i class="bi bi-bell-fill text-lg"></i>
        </button>
        <span id="notificationDot" class="notification-dot hidden"></span>
        <span id="notificationBadge" class="notification-badge hidden">0</span>
        
        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown hidden">
          <div class="notification-dropdown-header">
            <h3 class="notification-dropdown-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <button class="mark-all-read text-sm text-blue-600 dark:text-blue-400 hover:underline">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</button>
          </div>
          <div class="notification-dropdown-content">
            <div class="notification-loading">
              <div class="notification-loading-spinner"></div>
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </div>
          </div>
          <div class="notification-dropdown-footer">
            <a href="#" class="text-sm">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 p-6 overflow-y-auto transition-all duration-300 ml-56">
      <div class="container mx-auto">
      <!-- Header Section -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
          <i class="bi bi-receipt text-blue-600 mr-2"></i>
          ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô
        </h1>
        <div class="badge badge-info">
          <span id="recordCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
      </div>

      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">
          <i class="bi bi-funnel mr-2"></i>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="label">
              <span class="label-text font-semibold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
            </label>
            <input type="date" id="startDate" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label">
              <span class="label-text font-semibold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
            </label>
            <input type="date" id="endDate" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label">
              <span class="label-text font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
            </label>
            <input
              type="text"
              id="customerSearch"
              class="input input-bordered w-full"
              placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
            />
          </div>
          <div class="flex items-end">
            <button id="btnFilter" class="btn btn-primary w-full">
              <i class="bi bi-search mr-2"></i>
              ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="btnClearFilter" class="btn btn-ghost btn-sm">
            <i class="bi bi-x-circle mr-1"></i>
            ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
          </button>
          <button id="btnRefresh" class="btn btn-ghost btn-sm">
            <i class="bi bi-arrow-clockwise mr-1"></i>
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-calendar-event mr-1"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-person mr-1"></i>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-file-earmark mr-1"></i>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-cash-stack mr-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-person-badge mr-1"></i>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-gear mr-1"></i>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                </th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Pagination) -->
      <div class="mt-6 flex justify-center">
        <div id="pagination" class="flex flex-wrap gap-1"></div>
      </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <script>
      // Function to show/hide loading overlay
            // Get branch code from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');
      
      if (!BRANCH_CODE) {
        console.warn("Branch code not specified, defaulting to 'PATTANI'");
        BRANCH_CODE = 'PATTANI';
      }
      window.currentBranchCode = BRANCH_CODE;
      console.log(`[History_installment] Using branch code: ${BRANCH_CODE}`);

      let globalInstallmentData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≠‡∏ô (branchStockHistory) ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
      let filteredData = [];         // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      let currentPage = 1;           // ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á
      const pageSize = 10;           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠ 1 ‡∏´‡∏ô‡πâ‡∏≤

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Toast Notification - ‡πÉ‡∏ä‡πâ notification system
      function showToast(message, type = 'info', duration = 3000) {
        // ‡πÉ‡∏ä‡πâ notification system ‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          return window.NotificationSystem.instance.showToast(message, type, duration);
        } else {
          // ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á instance ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
          if (document.body && window.createNotificationInstance) {
            console.log('üîÑ Auto-creating NotificationSystem instance for history...');
            window.createNotificationInstance();
      
            // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ instance ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            setTimeout(() => {
              if (window.NotificationSystem && window.NotificationSystem.instance) {
                return window.NotificationSystem.instance.showToast(message, type, duration);
              }
            }, 100);
          }

          // Fallback - ‡∏™‡∏£‡πâ‡∏≤‡∏á toast ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
          console.log(`[Toast Fallback: ${type.toUpperCase()}] ${message}`);
          const container = document.getElementById('toastContainer');
          if (!container) return;
      
          const toast = document.createElement('div');
      
          let bgColor = 'bg-blue-500';
          let icon = 'bi-info-circle';
      
          switch(type) {
            case 'success':
              bgColor = 'bg-green-500';
              icon = 'bi-check-circle';
              break;
            case 'error':
              bgColor = 'bg-red-500';
              icon = 'bi-x-circle';
              break;
            case 'warning':
              bgColor = 'bg-yellow-500';
              icon = 'bi-exclamation-triangle';
              break;
          }
      
          toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform translate-x-full transition-transform duration-300`;
          toast.innerHTML = `
            <i class="bi ${icon}"></i>
            <span>${message}</span>
          `;
      
          container.appendChild(toast);
      
          // Animate in
          setTimeout(() => {
            toast.classList.remove('translate-x-full');
          }, 100);
      
          // Auto remove
          setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
              if (container.contains(toast)) {
                container.removeChild(toast);
              }
            }, 300);
          }, duration);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ (performed_at) ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY HH:mm
      function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        try {
          const dt = new Date(dateStr);
          const day = String(dt.getDate()).padStart(2, '0');
          const month = String(dt.getMonth() + 1).padStart(2, '0');
          const year = dt.getFullYear();
          const hour = String(dt.getHours()).padStart(2, '0');
          const min = String(dt.getMinutes()).padStart(2, '0');
          return `${day}/${month}/${year} ${hour}:${min}`;
        } catch (err) {
          return 'N/A';
        }
      }

      // ‚úÖ Enhanced Performance: Retry logic and concurrent data fetching
      async function fetchWithRetry(url, options = {}, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const response = await fetch(url, options);
            if (response.ok) return response;

            if (attempt === maxRetries) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Exponential backoff delay
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
          } catch (error) {
            if (attempt === maxRetries) throw error;
            console.warn(`üîÑ Retry attempt ${attempt} for ${url}:`, error.message);
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
          }
        }
      }

      // ‚úÖ Enhanced Data Cache with TTL
      const dataCache = new Map();
      const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

      function getCachedData(key) {
        const cached = dataCache.get(key);
        if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
          console.log(`üìä Using cached data for: ${key}`);
          return cached.data;
        }
        return null;
      }

      function setCachedData(key, data) {
        dataCache.set(key, { data, timestamp: Date.now() });
        console.log(`üíæ Cached data for: ${key}`);
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ + ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
      async function fetchInstallmentHistoryData() {
        // ‚úÖ Check cache first
        const cacheKey = `installment_history_${BRANCH_CODE || 'PT'}`;
        const cachedData = getCachedData(cacheKey);

        if (cachedData) {
          return cachedData;
        }

        showLoading(true);
        try {
          const token = localStorage.getItem('authToken') || '';

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á query parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const queryParams = new URLSearchParams();
          queryParams.append('branch_code', BRANCH_CODE || 'PATTANI');
          queryParams.append('limit', '200');
          queryParams.append('status', 'active,completed,ongoing'); // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

          // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TaxInvoice ‡πÅ‡∏•‡∏∞ Receipt collections ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
          let allInstallmentData = [];

          // ‚úÖ Concurrent data fetching for better performance
          const [taxInvoiceResult, receiptResult] = await Promise.allSettled([
            fetchWithRetry(`/api/taxinvoice/branch/${BRANCH_CODE || 'PT'}?saleType=installment&limit=100`, {
              headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetchWithRetry(`/api/receipt/branch/${BRANCH_CODE || 'PT'}?receiptType=down_payment_receipt&limit=100`, {
              headers: { 'Authorization': `Bearer ${token}` }
            })
          ]);

          // 1. Handle TaxInvoice data
          if (taxInvoiceResult.status === 'fulfilled') {
            const taxInvoiceRes = taxInvoiceResult.value;
      
          if (taxInvoiceRes.ok) {
            const taxInvoiceData = await taxInvoiceRes.json();
            if (taxInvoiceData.success && taxInvoiceData.data?.documents) {
              taxInvoiceData.data.documents.forEach(taxInvoice => {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TaxInvoice
                allInstallmentData.push({
                  _id: taxInvoice._id,
                  contractNo: taxInvoice.contractNo || 'N/A',
                  performed_at: taxInvoice.createdAt || taxInvoice.issueDate,
                  customer_info: {
                    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TaxInvoice ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                    fullName: taxInvoice.customer?.name || taxInvoice.customer?.fullName || '',
                    firstName: taxInvoice.customer?.firstName || taxInvoice.customer?.first_name || '',
                    lastName: taxInvoice.customer?.lastName || taxInvoice.customer?.last_name || '',
                    phoneNumber: taxInvoice.customer?.phone || taxInvoice.customer?.phone_number || '',
                    taxId: taxInvoice.customer?.taxId || taxInvoice.customer?.tax_id || '',
                    address: taxInvoice.customer?.address || '',
                    customerType: taxInvoice.customer?.customerType || 'individual'
                  },
                  staff_name: taxInvoice.employeeName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                  status: 'installment_tax_invoice',
                  branch_code: taxInvoice.branchCode,
                  totalAmount: taxInvoice.summary?.totalWithTax || taxInvoice.calculation?.totalAmount || 0,
                  downPayment: taxInvoice.downPaymentAmount || 0,
                  vatAmount: taxInvoice.summary?.vatAmount || taxInvoice.calculation?.vatAmount || 0,
                  documentType: 'TAX_INVOICE',
                  documentNumber: taxInvoice.taxInvoiceNumber,
                  showVat: true,
                  isPrimaryDocument: true,
                  receiptType: 'installment_tax_invoice',
                  reason: '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô',
                  change_type: 'OUT'
                });
              });
            }
          } else {
            console.warn('‚ö†Ô∏è TaxInvoice fetch failed:', taxInvoiceResult.reason);
          }
        } else {
          console.warn('‚ö†Ô∏è TaxInvoice fetch failed:', taxInvoiceResult.reason);
        }

        // 2. Handle Receipt data
        if (receiptResult.status === 'fulfilled') {
          const receiptRes = receiptResult.value;

          if (receiptRes.ok) {
            const receiptData = await receiptRes.json();
            if (receiptData.success && receiptData.data?.documents) {
              receiptData.data.documents
                .filter(receipt => receipt.saleType === 'installment')
                .forEach(receipt => {
                  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Receipt
                  allInstallmentData.push({
                    _id: receipt._id,
                    contractNo: receipt.contractNo || 'N/A',
                    performed_at: receipt.createdAt || receipt.issueDate,
                    customer_info: {
                      // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Receipt ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                      fullName: receipt.customer?.name || receipt.customer?.fullName || '',
                      firstName: receipt.customer?.firstName || receipt.customer?.first_name || '',
                      lastName: receipt.customer?.lastName || receipt.customer?.last_name || '',
                      phoneNumber: receipt.customer?.phone || receipt.customer?.phone_number || '',
                      taxId: receipt.customer?.taxId || receipt.customer?.tax_id || '',
                      address: receipt.customer?.address || '',
                      customerType: receipt.customer?.customerType || 'individual'
                    },
                    staff_name: receipt.employeeName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    status: 'installment_receipt',
                    branch_code: receipt.branchCode,
                    totalAmount: receipt.totalAmount || 0,
                    downPayment: receipt.downPaymentAmount || receipt.totalAmount || 0,
                    vatAmount: receipt.vatAmount || 0,
                    documentType: 'RECEIPT',
                    documentNumber: receipt.receiptNumber,
                    showVat: false,
                    isPrimaryDocument: false,
                    receiptType: 'installment_receipt',
                    reason: '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô',
                    change_type: 'OUT'
                  });
                });
            }
          } else {
            console.warn('‚ö†Ô∏è Receipt fetch failed with HTTP error');
          }
        } else {
          console.warn('‚ö†Ô∏è Receipt fetch failed:', receiptResult.reason);
        }
      
          // Log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
          console.log(`üìä Loaded ${allInstallmentData.length} documents from TaxInvoice and Receipt collections`);
          console.log('üìã Document breakdown:', {
            receipts: allInstallmentData.filter(d => d.documentType === 'RECEIPT').length,
            taxInvoices: allInstallmentData.filter(d => d.documentType === 'TAX_INVOICE').length,
            uniqueContracts: new Set(allInstallmentData.map(d => d.contractNo)).size
          });
      
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏π‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (Tax Invoice ‡∏Å‡πà‡∏≠‡∏ô Receipt)
          allInstallmentData.sort((a, b) => {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô
            const dateA = new Date(a.performed_at);
            const dateB = new Date(b.performed_at);
            if (dateA.getTime() !== dateB.getTime()) {
              return dateB - dateA; // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
            }
      
            // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ Tax Invoice (‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å) ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô Receipt
            if (a.contractNo === b.contractNo) {
              if (a.documentType === 'TAX_INVOICE' && b.documentType === 'RECEIPT') return -1;
              if (a.documentType === 'RECEIPT' && b.documentType === 'TAX_INVOICE') return 1;
            }
      
            return 0;
          });
      
          console.log(`üìä Loaded ${allInstallmentData.length} installment documents (paired documents)`);
          console.log('üìã Document breakdown:', {
            receipts: allInstallmentData.filter(d => d.documentType === 'RECEIPT').length,
            taxInvoices: allInstallmentData.filter(d => d.documentType === 'TAX_INVOICE').length,
            uniqueContracts: new Set(allInstallmentData.map(d => d.contractNo)).size,
            documentPairs: allInstallmentData.length / 2,
            primaryDocs: allInstallmentData.filter(d => d.isPrimaryDocument === true).length,
            secondaryDocs: allInstallmentData.filter(d => d.isPrimaryDocument === false).length
          });
      
          // Debug ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏
          if (allInstallmentData.length > 0) {
            const sample = allInstallmentData[0];
            console.log('üîç Sample document data:', {
              contractNo: sample.contractNo,
              documentType: sample.documentType,
              isPrimaryDocument: sample.isPrimaryDocument,
              customer_info: sample.customer_info,
              rawCustomerData: {
                firstName: sample.customer_info?.firstName,
                lastName: sample.customer_info?.lastName,
                companyName: sample.customer_info?.companyName,
                customerType: sample.customer_info?.customerType,
                _rawCustomer: sample.customer_info?._rawCustomer,
                _rawCustomerInfo: sample.customer_info?._rawCustomerInfo
              }
            });
          }
      
          // ‚úÖ Cache successful data fetch
          setCachedData(cacheKey, allInstallmentData);

          showToast(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${allInstallmentData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
          return allInstallmentData;
        } catch (err) {
          console.error('‚ùå Error fetching installment data:', err);

          // ‚úÖ Enhanced error handling with specific messages
          const errorMessage = err.message?.includes('network')
            ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'
            : err.message?.includes('HTTP 401')
            ? '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà'
            : err.message?.includes('HTTP 403')
            ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
            : `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message}`;

          showToast(errorMessage, 'error');
          return [];
        } finally {
          showLoading(false);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
      function paginate(data, page, pageSize) {
        const startIndex = (page - 1) * pageSize;
        return data.slice(startIndex, startIndex + pageSize);
      }

      // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      function renderHistoryTable(data, page = 1) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        const pageData = paginate(data, page, pageSize);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        document.getElementById('recordCount').textContent = data.length;

        if (pageData.length === 0) {
          const trEmpty = document.createElement('tr');
          const tdEmpty = document.createElement('td');
          tdEmpty.setAttribute('colspan', 6); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 5 ‡πÄ‡∏õ‡πá‡∏ô 6 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
          tdEmpty.className = 'text-center text-gray-500 py-12';
          tdEmpty.innerHTML = `
            <div class="flex flex-col items-center">
              <i class="bi bi-inbox text-4xl text-gray-300 mb-2"></i>
              <p class="text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
              <p class="text-sm">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
          `;
          trEmpty.appendChild(tdEmpty);
          tbody.appendChild(trEmpty);
          return;
        }

        pageData.forEach((record, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-colors';

          // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ (performed_at)
          const tdDate = document.createElement('td');
          tdDate.className = 'font-mono text-sm';
          tdDate.textContent = formatDateTime(record.performed_at);
          tr.appendChild(tdDate);

          // ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ + ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          let customerName = 'N/A';
          if (record.customer_info) {
            if (record.customer_info.customerType === 'corporate' && record.customer_info.companyName) {
              // ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
              customerName = record.customer_info.companyName;
            } else {
              // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ - ‡πÉ‡∏ä‡πâ fullName ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏°‡∏≤‡∏à‡∏≤‡∏Å customer.name)
              const fullName = record.customer_info.fullName || '';
              const fn = record.customer_info.firstName || '';
              const ln = record.customer_info.lastName || '';
              const constructedName = (fn + ' ' + ln).trim();
      
              if (fullName && fullName.trim() && fullName !== 'undefined undefined') {
                customerName = fullName.trim();
              } else if (constructedName && constructedName !== ' ' && constructedName !== 'undefined undefined') {
                customerName = constructedName;
              } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
                if (record.contractNo && record.contractNo !== 'N/A') {
                  customerName = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${record.contractNo}`;
                } else {
                  customerName = '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                }
              }
            }
          }
          const tdCustomer = document.createElement('td');
          tdCustomer.className = 'font-medium';
      
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          let documentInfo = '';
          if (record.isPrimaryDocument === true) {
            documentInfo = '<br><small class="text-blue-600 font-semibold">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</small>';
          } else if (record.isPrimaryDocument === false) {
            documentInfo = '<br><small class="text-gray-500">üìã ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</small>';
          } else {
            // Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            documentInfo = record.documentType === 'TAX_INVOICE' ?
              '<br><small class="text-blue-600 font-semibold">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å</small>' :
              '<br><small class="text-gray-500">üìã ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</small>';
          }
      
          const contractInfo = record.contractNo && record.contractNo !== 'N/A' ?
            `<br><small class="text-gray-600">‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${record.contractNo}</small>` :
            '<br><small class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</small>';
      
          const documentNumberInfo = record.documentNumber ?
            `<br><small class="text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${record.documentNumber}</small>` : '';
      
          // Debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
          if (customerName === 'N/A' || customerName.includes('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ QT-')) {
            console.log('‚ö†Ô∏è Customer name issue for record:', {
              contractNo: record.contractNo,
              documentType: record.documentType,
              finalCustomerName: customerName,
              customer_info: record.customer_info,
              availableNames: {
                fullName: record.customer_info?.fullName,
                firstName: record.customer_info?.firstName,
                lastName: record.customer_info?.lastName,
                constructedName: (record.customer_info?.firstName + ' ' + record.customer_info?.lastName).trim()
              },
              _id: record._id
            });
          }
      
          tdCustomer.innerHTML = `${customerName}${contractInfo}${documentNumberInfo}${documentInfo}`;
          tr.appendChild(tdCustomer);

          // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
          const tdDocType = document.createElement('td');
          let statusBadge = '';
          let statusText = record.status || 'ongoing';
      
          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î badge ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á
          switch(statusText) {
            case 'pending':
              statusBadge = '<span class="badge badge-warning">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
              break;
            case 'approved':
              statusBadge = '<span class="badge badge-info">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>';
              break;
            case 'active':
            case 'ongoing':
              // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
              if (record.documentType === 'TAX_INVOICE') {
                statusBadge = '<span class="badge badge-success">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</span>';
              } else {
                statusBadge = '<span class="badge badge-primary">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>';
              }
              break;
            case 'completed':
              statusBadge = '<span class="badge badge-success">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>';
              break;
            case 'cancelled':
              statusBadge = '<span class="badge badge-error">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
              break;
            case 'rejected':
              statusBadge = '<span class="badge badge-error">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>';
              break;
            case 'installment_receipt':
              statusBadge = '<span class="badge badge-primary">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô</span>';
              break;
            case 'installment_tax_invoice':
              statusBadge = '<span class="badge badge-success">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ú‡πà‡∏≠‡∏ô</span>';
              break;
            default:
              statusBadge = '<span class="badge badge-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô</span>';
          }
      
          tdDocType.innerHTML = statusBadge;
          tr.appendChild(tdDocType);

          // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
          const tdAmount = document.createElement('td');
          tdAmount.className = 'font-mono text-right';
      
          let amountDisplay = '';
          const downPayment = record.downPayment || 0;
          const totalAmount = record.totalAmount || 0;
          const vatAmount = record.vatAmount || 0;
      
          if (record.documentType === 'TAX_INVOICE') {
            // ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ: ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏†‡∏≤‡∏©‡∏µ (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
            const beforeTax = totalAmount - vatAmount;
            amountDisplay = `
              <div class="text-sm">
                <div class="font-semibold text-green-600">‡∏ø${totalAmount.toLocaleString()}</div>
                <div class="text-xs text-gray-500">
                  ‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ ‡∏ø${beforeTax.toLocaleString()}<br>
                  ‡∏†‡∏≤‡∏©‡∏µ 7% ‡∏ø${vatAmount.toLocaleString()}
                </div>
              </div>
            `;
          } else {
            // ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏©‡∏µ)
            amountDisplay = `
              <div class="text-sm">
                <div class="font-semibold text-blue-600">‡∏ø${totalAmount.toLocaleString()}</div>
                <div class="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏µ)</div>
              </div>
            `;
          }
      
          tdAmount.innerHTML = amountDisplay;
          tr.appendChild(tdAmount);

          // ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (staff_name)
          const tdStaff = document.createElement('td');
          tdStaff.textContent = record.staff_name || 'N/A';
          tr.appendChild(tdStaff);

          // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£
          const tdAction = document.createElement('td');
          const actionDiv = document.createElement('div');
          actionDiv.className = 'flex gap-2';

          // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏¥‡πâ‡∏ô (80mm)
          const printBtn = document.createElement('button');
          printBtn.className = 'btn btn-sm btn-outline';
          printBtn.innerHTML = '<i class="bi bi-printer mr-1"></i>‡∏õ‡∏£‡∏¥‡πâ‡∏ô';
          printBtn.addEventListener('click', () => {
            printInstallmentReceipt(record._id, printBtn);
          });
          actionDiv.appendChild(printBtn);

          // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û JPG (POS 80mm)
          const loadBtn = document.createElement('button');
          loadBtn.className = 'btn btn-sm btn-secondary';
          loadBtn.innerHTML = '<i class="bi bi-image mr-1"></i>JPG (POS)';
          loadBtn.addEventListener('click', () => {
            downloadInstallmentReceiptAsJPG(record._id, loadBtn);
          });
          actionDiv.appendChild(loadBtn);

          // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î PDF (A4) - ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
          const pdfBtn = document.createElement('button');
          if (record.documentType === 'TAX_INVOICE') {
            pdfBtn.className = 'btn btn-sm btn-success';
            pdfBtn.innerHTML = '<i class="bi bi-file-earmark-pdf mr-1"></i>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';
          } else {
            pdfBtn.className = 'btn btn-sm btn-primary';
            pdfBtn.innerHTML = '<i class="bi bi-file-earmark-pdf mr-1"></i>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à';
          }
          pdfBtn.addEventListener('click', () => {
            downloadInstallmentReceiptAsPDF(record._id, pdfBtn);
          });
          actionDiv.appendChild(pdfBtn);

          tdAction.appendChild(actionDiv);
          tr.appendChild(tdAction);
          tbody.appendChild(tr);
        });
      }

      // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏∏‡πà‡∏° pagination
      function renderPagination(data, page = 1) {
        const totalPages = Math.ceil(data.length / pageSize);
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';
      
        if (totalPages <= 1) return;

        // ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        if (page > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn-outline btn-sm';
          prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
          prevBtn.addEventListener('click', () => {
            currentPage = page - 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(prevBtn);
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ (‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏´‡∏ô‡πâ‡∏≤)
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(totalPages, page + 2);

        if (startPage > 1) {
          const firstBtn = document.createElement('button');
          firstBtn.className = 'btn btn-outline btn-sm';
          firstBtn.textContent = '1';
          firstBtn.addEventListener('click', () => {
            currentPage = 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(firstBtn);

          if (startPage > 2) {
            const dotsSpan = document.createElement('span');
            dotsSpan.className = 'px-2 text-gray-500';
            dotsSpan.textContent = '...';
            paginationEl.appendChild(dotsSpan);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement('button');
          btn.className = `btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}`;
          btn.textContent = i;
          btn.addEventListener('click', () => {
            currentPage = i;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(btn);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const dotsSpan = document.createElement('span');
            dotsSpan.className = 'px-2 text-gray-500';
            dotsSpan.textContent = '...';
            paginationEl.appendChild(dotsSpan);
          }

          const lastBtn = document.createElement('button');
          lastBtn.className = 'btn btn-outline btn-sm';
          lastBtn.textContent = totalPages;
          lastBtn.addEventListener('click', () => {
            currentPage = totalPages;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(lastBtn);
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        if (page < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn-outline btn-sm';
          nextBtn.innerHTML = '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="bi bi-chevron-right"></i>';
          nextBtn.addEventListener('click', () => {
            currentPage = page + 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(nextBtn);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Receipt/TaxInvoice)
      async function printInstallmentReceipt(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'error');
            return;
          }

          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
          const originalInstallmentId = documentRecord._id.replace('_tax', '').replace('_receipt', '');
          const documentData = {
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            documentId: originalInstallmentId,
            documentNumber: documentRecord.documentNumber,
            contractNumber: documentRecord.contractNo,
            documentType: documentRecord.documentType,
            receiptType: documentRecord.receiptType || 'installment_down_payment',
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            customerInfo: {
              name: `${documentRecord.customer_info?.firstName || ''} ${documentRecord.customer_info?.lastName || ''}`.trim() || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
              phone: documentRecord.customer_info?.phoneNumber || '',
              address: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'
            },
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
            items: [
              {
                description: `‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ - ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${documentRecord.contractNo}`,
                amount: documentRecord.downPayment || documentRecord.totalAmount || 0,
                quantity: 1,
                unitPrice: documentRecord.downPayment || documentRecord.totalAmount || 0
              }
            ],
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            totalAmount: documentRecord.totalAmount || 0,
            downPayment: documentRecord.downPayment || 0,
            monthlyPayment: documentRecord.monthlyPayment || 0,
            installmentCount: documentRecord.installmentCount || 0,
      
            // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!
            vatAmount: documentRecord.showVat ? (documentRecord.vatAmount || 0) : 0,
            showVat: documentRecord.showVat || false,
            beforeTaxAmount: documentRecord.showVat ?
              ((documentRecord.downPayment || 0) - (documentRecord.vatAmount || 0)) :
              (documentRecord.downPayment || 0),
      
            remainingAmount: documentRecord.remainingAmount || 0,
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            paymentMethod: 'cash',
            createdAt: documentRecord.performed_at,
            status: documentRecord.status,
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
            branch: {
              name: '‡∏™‡∏≤‡∏Ç‡∏≤ ' + (documentRecord.branch_code || 'MAIN'),
              code: documentRecord.branch_code || 'MAIN',
              address: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≤‡∏Ç‡∏≤',
              phone: '000-000-0000'
            },
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            employeeName: documentRecord.staff_name,
      
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
            isPrimaryDocument: documentRecord.isPrimaryDocument,
            linkedTaxInvoiceId: documentRecord.linkedTaxInvoiceId,
      
            // Flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Controller - ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            useDatabase: true,
            sourceCollection: 'InstallmentOrder', // ‡πÉ‡∏ä‡πâ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
            renderMode: documentRecord.documentType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt',
            forceDocumentType: documentRecord.documentType, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            forceReceiptMode: documentRecord.documentType === 'RECEIPT', // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            suppressVatDisplay: documentRecord.documentType === 'RECEIPT' // ‡∏ã‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          };

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≤‡∏ô PDFoooRasterController
          const PDFoooRasterController = require('../../controllers/pdf/PDFoooRasterController');
      
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - ‡πÉ‡∏ä‡πâ endpoint ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          const token = localStorage.getItem('authToken') || '';
      
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ VAT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          if (documentRecord.documentType === 'RECEIPT') {
            documentData.vatAmount = 0;
            documentData.showVat = false;
            documentData.taxType = 'no_vat';
            documentData.beforeTaxAmount = documentData.totalAmount;
            documentData.items = documentData.items.map(item => ({
              ...item,
              hasVat: false,
              vatRate: 0
            }));
          }
      
          const pdfResponse = await fetch('/api/receipt/generate-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              receiptData: documentData,
              documentType: documentRecord.documentType,
              forceReceiptMode: documentRecord.documentType === 'RECEIPT'
            })
          });

          let receiptImage = null;
          if (pdfResponse.ok) {
            const pdfResult = await pdfResponse.json();
            if (pdfResult.success && pdfResult.data?.receiptImage) {
              receiptImage = pdfResult.data.receiptImage;
            }
          }

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á
          if (!receiptImage) {
            console.warn('‚ö†Ô∏è Using fallback receipt generation method');
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
            const receiptText = `
=== ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ===
‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${receiptData.documentNumber}
‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${receiptData.contractNumber}
‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${receiptData.customerInfo.name}
‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø${receiptData.totalAmount.toLocaleString()}
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(receiptData.createdAt).toLocaleDateString('th-TH')}
‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${receiptData.employeeName}
========================
            `;
      
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå)
            receiptImage = btoa(receiptText);
          }

          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å mini print server ‡∏ó‡∏µ‡πà localhost:4000
          const resp = await fetch('http://localhost:4000/print', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: receiptImage,
              type: 'installment_receipt',
              documentType: documentRecord.documentType
            })
          });
      
          const printResult = await resp.json();
          if (!resp.ok || !printResult.success) {
            console.error('Print error:', printResult.error);
            showToast('‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            return;
          }
      
          showToast(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå${documentRecord.documentType === 'TAX_INVOICE' ? '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
        } catch (err) {
          console.error('Error printing Installment Receipt:', err);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF A4 ‡∏à‡∏£‡∏¥‡∏á - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
      async function downloadInstallmentReceiptAsPDF(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF A4...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'error');
            return;
          }

          const token = localStorage.getItem('authToken') || '';
      
          // üîß ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ A4PDFController ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
          console.log('üìÑ Requesting PDF for document:', {
            id: documentRecord._id,
            documentNumber: documentRecord.documentNumber,
            documentType: documentRecord.documentType
          });

          let pdfResponse;

          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ A4PDFController ‡πÇ‡∏î‡∏¢‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          const originalInstallmentId = documentRecord._id.replace('_tax', '').replace('_receipt', '');
      
          if (documentRecord.documentType === 'TAX_INVOICE') {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏µ
            pdfResponse = await fetch('/api/pdf/a4-tax-invoice', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify({
                taxInvoiceId: originalInstallmentId,
                documentNumber: documentRecord.documentNumber,
                useDatabase: true,
                forceDocumentType: 'TAX_INVOICE',
                showVat: true,
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TaxInvoice collection ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                documentType: 'TAX_INVOICE'
              })
            });
          } else {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏µ
            pdfResponse = await fetch('/api/pdf/a4-receipt', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify({
                receiptId: originalInstallmentId,
                documentNumber: documentRecord.documentNumber,
                useDatabase: true,
                forceDocumentType: 'RECEIPT',
                showVat: false,
                suppressVatDisplay: true, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏µ
                taxType: 'no_vat',
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Receipt collection ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                documentType: 'RECEIPT',
                forceReceiptMode: true
              })
            });
          }

          if (!pdfResponse.ok) {
            // Fallback: ‡πÉ‡∏ä‡πâ API ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á A4 PDF
            console.warn('‚ö†Ô∏è A4 PDF API not available, trying fallback...');
      
            const fallbackData = {
              documentId: documentRecord._id,
              documentType: documentRecord.documentType,
              documentNumber: documentRecord.documentNumber,
              contractNo: documentRecord.contractNo,
              format: 'A4', // ‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö A4
              customer: {
                name: `${documentRecord.customer_info?.firstName || ''} ${documentRecord.customer_info?.lastName || ''}`.trim() || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                phone: documentRecord.customer_info?.phoneNumber || '',
                address: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'
              },
              totalAmount: documentRecord.downPayment || documentRecord.totalAmount || 0,
              employeeName: documentRecord.staff_name,
              branchCode: documentRecord.branch_code,
              createdAt: documentRecord.performed_at
            };

            pdfResponse = await fetch('/api/pdf/a4-document', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify(fallbackData)
            });
          }

          if (!pdfResponse.ok) {
            throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF A4 ‡πÑ‡∏î‡πâ (${pdfResponse.status})`);
          }

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Content-Type
          const contentType = pdfResponse.headers.get('Content-Type');
      
          if (contentType && contentType.includes('application/pdf')) {
            // ‡πÑ‡∏î‡πâ PDF ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const pdfBlob = await pdfResponse.blob();
            downloadImageAsFile(pdfBlob, documentRecord, 'pdf');
            showToast(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          } else {
            // ‡πÑ‡∏î‡πâ JSON response
            const jsonResult = await pdfResponse.json();
      
            if (jsonResult.success && jsonResult.pdfBase64) {
              // ‡πÅ‡∏õ‡∏•‡∏á base64 ‡πÄ‡∏õ‡πá‡∏ô PDF blob
              const pdfBlob = base64ToBlob(jsonResult.pdfBase64, 'application/pdf');
              downloadImageAsFile(pdfBlob, documentRecord, 'pdf');
              showToast(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            } else if (jsonResult.success && jsonResult.downloadUrl) {
              // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å URL
              downloadFromURL(jsonResult.downloadUrl, jsonResult.fileName || 'document.pdf');
              showToast(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
            } else {
              throw new Error(jsonResult.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF A4 ‡πÑ‡∏î‡πâ');
            }
          }

        } catch (err) {
          console.error('Error downloading A4 PDF:', err);
          showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå
      function downloadImageAsFile(blob, documentRecord, extension = 'png') {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
      
        const docType = documentRecord.documentType === 'TAX_INVOICE' ? 'tax-invoice' : 'receipt';
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `${docType}-${documentRecord.contractNo || documentRecord._id}-${timestamp}.${extension}`;
        link.download = fileName;
      
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF blob
      function downloadPDFBlob(blob, documentRecord) {
        downloadImageAsFile(blob, documentRecord, 'pdf');
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å URL
      function downloadFromURL(url, fileName) {
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.target = '_blank';
      
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JPG (POS 80mm ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö)
      async function downloadInstallmentReceiptAsJPG(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ POS...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'error');
            return;
          }

          const token = localStorage.getItem('authToken') || '';
          let imageResponse;

          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API PDFoooRasterController ‡∏ú‡πà‡∏≤‡∏ô routes ‡πÉ‡∏´‡∏°‡πà
          if (documentRecord.documentType === 'TAX_INVOICE') {
            imageResponse = await fetch(`/api/pdf/installment/tax-invoice/${documentRecord._id}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
              }
            });
          } else {
            imageResponse = await fetch(`/api/pdf/installment/receipt/${documentRecord._id}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
              }
            });
          }

          if (!imageResponse.ok) {
            throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ (${imageResponse.status})`);
          }

          const jsonResult = await imageResponse.json();
      
          if (jsonResult.success && jsonResult.data?.base64) {
            // ‡πÅ‡∏õ‡∏•‡∏á base64 ‡πÄ‡∏õ‡πá‡∏ô JPG blob
            const imageBlob = base64ToBlob(jsonResult.data.base64, 'image/jpeg');
      
            // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JPG
            const url = URL.createObjectURL(imageBlob);
            const link = document.createElement('a');
            link.href = url;
      
            const docType = documentRecord.documentType === 'TAX_INVOICE' ? 'tax-invoice' : 'receipt';
            const fileName = `${docType}-pos-${documentRecord.contractNo || historyId}-${new Date().getTime()}.jpg`;
            link.download = fileName;
      
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
      
            showToast(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û POS ${documentRecord.documentType === 'TAX_INVOICE' ? '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          } else {
            throw new Error(jsonResult.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ');
          }

        } catch (err) {
          console.error('Error downloading POS image:', err);
          showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á base64 ‡πÄ‡∏õ‡πá‡∏ô Blob
      function base64ToBlob(base64, mime) {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mime });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô memory ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      function filterDataInMemory(data, startDateStr, endDateStr, customerSearch) {
        let temp = [...data];

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (startDateStr) {
          const start = new Date(startDateStr);
          temp = temp.filter(item => new Date(item.performed_at) >= start);
        }
        if (endDateStr) {
          const end = new Date(endDateStr);
          end.setHours(23, 59, 59, 999);
          temp = temp.filter(item => new Date(item.performed_at) <= end);
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        if (customerSearch) {
          const lower = customerSearch.toLowerCase();
          temp = temp.filter(item => {
            let custName = '';
            if (item.customer_info) {
              const fn = item.customer_info.firstName || '';
              const ln = item.customer_info.lastName || '';
              custName = (fn + ' ' + ln).trim().toLowerCase();
            }
            return custName.includes(lower);
          });
        }

        return temp;
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô onFilter() ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      function onFilter() {
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('endDate').value;
        const searchValue = document.getElementById('customerSearch').value.trim();

        filteredData = filterDataInMemory(
          globalInstallmentData,
          startDateStr,
          endDateStr,
          searchValue
        );
        currentPage = 1;
        renderHistoryTable(filteredData, currentPage);
        renderPagination(filteredData, currentPage);
      
        showToast(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'info', 2000);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
      function clearFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('customerSearch').value = '';
      
        filteredData = globalInstallmentData;
        currentPage = 1;
        renderHistoryTable(filteredData, currentPage);
        renderPagination(filteredData, currentPage);
      
        showToast('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info', 2000);
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      async function refreshData() {
        const refreshBtn = document.getElementById('btnRefresh');
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
        refreshBtn.disabled = true;

        try {
          // ‚úÖ Clear cache to force fresh data fetch
          const cacheKey = `installment_history_${BRANCH_CODE || 'PT'}`;
          dataCache.delete(cacheKey);
          console.log('üóëÔ∏è Cache cleared for refresh');

          globalInstallmentData = await fetchInstallmentHistoryData();
          onFilter(); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success', 2000);
        } catch (error) {
          console.error('Refresh error:', error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        } finally {
          refreshBtn.innerHTML = originalHTML;
          refreshBtn.disabled = false;
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        let pageLoaderId = null;
        try {
          showLoading(true);
      
          // 1) ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å branchStockHistory
          globalInstallmentData = await fetchInstallmentHistoryData();
          // 2) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô filteredData = globalInstallmentData ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          filteredData = globalInstallmentData;

          // 3) ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á + pagination
          renderHistoryTable(filteredData, currentPage);
          renderPagination(filteredData, currentPage);

          // 4) ‡∏ú‡∏π‡∏Å event listeners
          document.getElementById('btnFilter').addEventListener('click', onFilter);
          document.getElementById('btnClearFilter').addEventListener('click', clearFilters);
          document.getElementById('btnRefresh').addEventListener('click', refreshData);
          document.getElementById('customerSearch').addEventListener('input', onFilter);
      
          // Auto-filter ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
          document.getElementById('startDate').addEventListener('change', onFilter);
          document.getElementById('endDate').addEventListener('change', onFilter);

          // Sidebar link highlighting
          const sidebarLinks = document.querySelectorAll('aside a');
          function highlightSidebar(link) {
            sidebarLinks.forEach(l => {
              l.style.backgroundColor = '';
              l.style.color = '';
              const ico = l.querySelector('i');
              if (ico) ico.style.color = '';
            });
            const icon = link.querySelector('i');
            if (icon) {
              const c = getComputedStyle(icon).color;
              link.style.backgroundColor = c;
              link.style.color = '#fff';
              icon.style.color = '#fff';
            }
          }
          sidebarLinks.forEach(link => link.addEventListener('click', () => highlightSidebar(link)));
          const page = window.location.pathname.split('/').pop();
          sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === page) highlightSidebar(link);
          });
        } catch (error) {
          console.error('Page loading error:', error);
        } finally {
          showLoading(false);
        }
      });</script>

    <!-- Firebase Realtime Database Integration -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
        authDomain: "pheenongacc.firebaseapp.com",
        databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pheenongacc",
        storageBucket: "pheenongacc.appspot.com",
        messagingSenderId: "158417807357",
        appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
        measurementId: "G-F7DPQ7XG9K"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      
      // ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≠‡∏ô
      const installmentRef = ref(db, 'installment/updated');
      onValue(installmentRef, snapshot => {
        if (snapshot.val()) {
          console.log('üì¶ Installment data updated via Firebase');
          // Auto refresh ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
          if (typeof refreshData === 'function') {
            refreshData();
          }
        }
      });

      console.log('üî• Firebase Realtime Database initialized for installment history');
    </script>

    <!-- Enhanced Socket.IO Integration -->
    <script>
      const socket = io();

      socket.on('connect', () => {
        console.log('üîó Socket.IO connected to installment history');
        console.log('üÜî Socket ID:', socket.id);
      
        socket.emit('join_branch', {
          branchCode: BRANCH_CODE,
          page: 'installment_history',
          timestamp: new Date().toISOString()
        });

        // ‡∏™‡πà‡∏á join notification room ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        socket.emit('join_notification_room', {
          branchCode: BRANCH_CODE,
          page: 'installment_history',
          timestamp: new Date().toISOString()
        });
      });

      socket.on('disconnect', (reason) => {
        console.log('‚ùå Socket.IO disconnected:', reason);
        showToast('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢', 'warning');
      });

      socket.on('reconnect', (attemptNumber) => {
        console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
        showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      });

      socket.on('installment_updated', (data) => {
        console.log('üì¶ Installment updated via Socket.IO:', data);
        showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', 'info', 2000);
      
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô notification dropdown ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: 'üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≠‡∏ô',
            message: `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô ${data.installmentId || ''} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï`,
            type: 'info',
            timestamp: new Date().toISOString(),
            read: false
          });
        }
      
        // Auto refresh data
        if (typeof refreshData === 'function') {
          refreshData();
        }
      });

      socket.on('receipt_printed', (data) => {
        if (data.type === 'installment') {
          console.log('üñ®Ô∏è Receipt printed:', data);
          showToast(`‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
      
          if (window.NotificationSystem && window.NotificationSystem.instance) {
            window.NotificationSystem.instance.addNotification({
              id: Date.now(),
              title: 'üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              message: `‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô ${data.receiptId || ''} ‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        }
      });

      socket.on('installment_payment_received', (data) => {
        console.log('üí∞ Payment received:', data);
        showToast(`üí∞ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${data.installmentNumber || '-'}`, 'success');
      
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: 'üí∞ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
            message: `‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${data.installmentNumber || '-'} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${data.amount || 0}`,
            type: 'success',
            timestamp: new Date().toISOString(),
            read: false
          });
        }
      
        // Refresh data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (typeof refreshData === 'function') {
          refreshData();
        }
      });

      socket.on('installment_overdue', (data) => {
        console.log('‚è∞ Installment overdue:', data);
        showToast(`‚è∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô ${data.installmentId || ''} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞`, 'warning');
      
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: '‚è∞ ‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
            message: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô ${data.installmentId || ''} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ ${data.daysPastDue || 0} ‡∏ß‡∏±‡∏ô`,
            type: 'warning',
            timestamp: new Date().toISOString(),
            read: false,
            priority: 'high'
          });
        }
      });

      // ‡∏ü‡∏±‡∏á branch ‡πÅ‡∏•‡∏∞ system notifications
      socket.on('branch_notification', (data) => {
        console.log('üîî Branch notification:', data);
        showToast(data.message || 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', data.type || 'info');
      });

      socket.on('system_notification', (data) => {
        console.log('üîß System notification:', data);
        showToast(`üîß ${data.message}`, data.type || 'warning');
      });

      // Error handling
      socket.on('error', (error) => {
        console.error('‚ùå Socket.IO error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
      });

      console.log('üîå Enhanced Socket.IO initialized for installment history');
    </script>
    </main>
    
    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ -->
    <script>
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤
      async function loadBranchInfo() {
        try {
          const branchCode = BRANCH_CODE;
          const token = localStorage.getItem('authToken') || '';
      
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /api/branch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á list ‡∏™‡∏≤‡∏Ç‡∏≤
          const res = await fetch(`/api/branch`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const js = await res.json();
          if (res.ok && js.success) {
            // ‡∏´‡∏≤ record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö branch_code
            const branch = js.data.find(b => b.branch_code === branchCode);
            if (branch) {
              document.getElementById('branchInfo').textContent =
                `${branch.name} ‚Äî ${branch.address}`;
              // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏£‡∏¥‡∏á
              document.title = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô - ${branch.name}`;
              return;
            }
          }
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
        } catch (err) {
          console.warn('loadBranchInfo error:', err);
          document.getElementById('branchInfo').textContent =
            '‡∏™‡∏≤‡∏Ç‡∏≤: (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        }
      }
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ loadBranchInfo ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      document.addEventListener('DOMContentLoaded', function() {
        try {
          loadBranchInfo();

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó title ‡∏à‡∏≤‡∏Å URL parameter
          const urlParams = new URLSearchParams(window.location.search);
          const branchName = urlParams.get('name');
          if (branchName) {
            document.title = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô - ${decodeURIComponent(branchName)}`;
          }
        } catch (error) {
          console.error('Branch loading error:', error);
        }
      });

      // ==================== DEBUG & TEST FUNCTIONS ====================

      // ‚úÖ Comprehensive Testing Suite for Loading States
      window.testLoadingStates = async function() {
        console.log('üß™ Testing all loading states...');

        try {
          // Test 1: Basic CSS Animation
          console.log('1Ô∏è‚É£ Testing CSS-based loading animation...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 2000));
          showLoading(false);
          console.log('‚úÖ CSS loading animation works');

          await new Promise(resolve => setTimeout(resolve, 1000));

          // Test 2: LoadingSystem integration
          console.log('2Ô∏è‚É£ Testing new showLoading integration...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 3000));
          showLoading(false);
          console.log('‚úÖ New showLoading works');

          await new Promise(resolve => setTimeout(resolve, 1000));

          // Test 3: Error handling
          console.log('3Ô∏è‚É£ Testing error handling...');
          try {
            await fetchWithRetry('https://invalid-url-for-testing.invalid', {}, 1);
          } catch (error) {
            console.log('‚úÖ Error handling works:', error.message);
          }

          // Test 4: Cache functionality
          console.log('4Ô∏è‚É£ Testing cache functionality...');
          setCachedData('test_key', { test: 'data' });
          const cached = getCachedData('test_key');
          console.log('‚úÖ Cache works:', !!cached);

          // Test 5: Thai language rendering
          console.log('5Ô∏è‚É£ Testing Thai language rendering...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 2000));
          showLoading(false);
          console.log('‚úÖ Thai language rendering works');

          showToast('üéâ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô', 'success');
          console.log('üéâ All loading states tested successfully!');

        } catch (error) {
          console.error('‚ùå Test failed:', error);
          showToast('‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        }
      };

      // ‚úÖ Network Performance Test
      window.testNetworkPerformance = async function() {
        console.log('üöÄ Testing network performance...');

        const startTime = Date.now();

        try {
          // Test concurrent fetching vs sequential
          console.log('Testing concurrent vs sequential fetching...');

          const sequentialStart = Date.now();
          await fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
          await fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
          const sequentialTime = Date.now() - sequentialStart;

          const concurrentStart = Date.now();
          await Promise.allSettled([
            fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } }),
            fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } })
          ]);
          const concurrentTime = Date.now() - concurrentStart;

          console.log(`üìä Sequential: ${sequentialTime}ms, Concurrent: ${concurrentTime}ms`);
          console.log(`üèÉ‚Äç‚ôÇÔ∏è Performance improvement: ${Math.round((sequentialTime - concurrentTime) / sequentialTime * 100)}%`);

          showToast(`‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ${Math.round((sequentialTime - concurrentTime) / sequentialTime * 100)}%`, 'success');

        } catch (error) {
          console.error('Network test error:', error);
        }
      };

      // ==================== DEBUG & TEST FUNCTIONS ====================
      
      // Global debug helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ History_installment
      window.HistoryInstallmentDebug = {
        notificationSystem: () => {
          return {
            available: !!window.NotificationSystem,
            instance: !!window.NotificationSystem?.instance,
            notifications: window.NotificationSystem?.instance?.notifications?.length || 0,
            dropdownExists: !!document.getElementById('notificationDropdown'),
            socketConnected: socket?.connected || false,
            branchCode: BRANCH_CODE
          };
        },
      
        testNotifications: () => {
          if (window.testNotifications) {
            window.testNotifications();
            console.log('üîî Testing notification system...');
          } else {
            console.warn('testNotifications function not available, using manual tests');
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö manual
            showToast('üìä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            setTimeout(() => showToast('üí∞ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ - ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'success'), 1000);
            setTimeout(() => showToast('üñ®Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ - ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'info'), 2000);
            setTimeout(() => showToast('‚è∞ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ - ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', 'warning'), 3000);
          }
        },

        testHistoryNotifications: () => {
          console.log('üß™ Testing history-specific notifications...');
      
          const notifications = [
            { message: 'üìä ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', type: 'success' },
            { message: 'üñ®Ô∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à #INS001', type: 'info' },
            { message: 'üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à #INS002.jpg', type: 'success' },
            { message: 'üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', type: 'info' },
            { message: 'üí∞ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà 5/12', type: 'success' },
            { message: '‚è∞ ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', type: 'warning' }
          ];
      
          notifications.forEach((notif, index) => {
            setTimeout(() => {
              showToast(notif.message, notif.type);
            }, index * 1000);
          });

          // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö dropdown notifications ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (window.NotificationSystem && window.NotificationSystem.instance) {
            setTimeout(() => {
              window.NotificationSystem.instance.addNotification({
                id: Date.now() + 1,
                title: 'üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô',
                message: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ú‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: 12 ‡πÉ‡∏ö, ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß: 8 ‡πÉ‡∏ö, ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞: 4 ‡πÉ‡∏ö',
                type: 'info',
                timestamp: new Date().toISOString(),
                read: false
              });
            }, 7000);
          }
      
          console.log('üéØ Test history notifications completed');
        },

        socketStatus: () => {
          return {
            connected: socket?.connected || false,
            id: socket?.id || null,
            transport: socket?.io?.engine?.transport?.name || null
          };
        },

        refreshHistoryData: () => {
          if (typeof refreshData === 'function') {
            refreshData();
            console.log('üîÑ Manual refresh triggered');
          } else {
            console.warn('refreshData function not available');
          }
        },

        version: '1.0.0-history-installment'
      };

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö notifications ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ history
      window.testHistoryNotifications = function() {
        return window.HistoryInstallmentDebug.testHistoryNotifications();
      };

      console.log('üéØ History Installment Debug functions ready');
      console.log('üîß Debug: HistoryInstallmentDebug object available globally');
      console.log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö History Notifications: testHistoryNotifications() ‡∏´‡∏£‡∏∑‡∏≠ HistoryInstallmentDebug.testHistoryNotifications()');
      console.log('üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: HistoryInstallmentDebug.notificationSystem()');
      console.log('üîå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Socket: HistoryInstallmentDebug.socketStatus()');
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      setTimeout(() => {
        const status = window.HistoryInstallmentDebug.notificationSystem();
        console.log('üîî NotificationSystem status:', status);
      
        if (!status.available) {
          console.warn('‚ö†Ô∏è NotificationSystem not available, only fallback toasts will work');
        } else if (!status.instance) {
          console.warn('‚ö†Ô∏è NotificationSystem instance not created, trying to create...');
          if (window.createNotificationInstance) {
            window.createNotificationInstance();
          }
        } else {
          console.log('‚úÖ NotificationSystem fully operational');
        }
      }, 2000);
    </script>

    <script>
      // Enhanced CSS-based Loading Animation Function
      // ‚úÖ No external dependencies - 100% local solution

      // Show/Hide Loading Function (based on home.html pattern)
      function showLoading(show) {
        const loader = document.getElementById('loadingOverlay');
        if (show) {
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô Lottie animation
          if (!lottieAnimation) {
            console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
            fetch('/Loading/Loading.json')
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to fetch Lottie animation');
                }
                return response.json();
              })
              .then(animationData => {
                lottieAnimation = lottie.loadAnimation({
                  container: document.getElementById('lottieContainer'),
                  renderer: 'svg',
                  loop: true,
                  autoplay: true,
                  animationData: animationData
                });
                console.log('‚úÖ Lottie animation loaded successfully');
              })
              .catch(error => {
                console.error('‚ùå Error loading Lottie animation:', error);
                // Fallback ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Lottie ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
              });
          } else {
            lottieAnimation.play();
          }
        } else {
          if (lottieAnimation) {
            lottieAnimation.pause();
          }
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');
          setTimeout(() => {
            loader.style.display = 'none';
          }, 300);
        }
      }

      // Initialize loading on page load
      document.addEventListener('DOMContentLoaded', function() {
        showLoading(true);

        // Auto-hide loading after page is fully loaded
        window.addEventListener('load', function() {
          setTimeout(() => showLoading(false), 1000);
        });
      });

      // Make functions globally available
      window.showLoading = showLoading;

      // Auto cleanup ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
      window.addEventListener('beforeunload', () => {
        if (lottieAnimation) {
          lottieAnimation.destroy();
          lottieAnimation = null;
        }
      });
    </script>
  </body>
</html>
