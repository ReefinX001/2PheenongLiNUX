<!DOCTYPE html>
<html lang="th" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>ประวัติใบเสร็จ (ผ่อน / InstallmentOrder)</title>

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="../js/activity-tracker.js"></script>
    <script src="/js/branch-navigation.js"></script>
    <!-- Notification System JavaScript -->
    <script src="/js/notification-system.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>
    <!-- โหลด DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
    />
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
  <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
      .loading-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
      }

      .dark .loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }
    </style>

    <script>
      let lottieAnimation = null;
    </script>

    <!-- Local CSS Loading Animation - No external dependencies -->
    <style>
      /* Enhanced Local Loading Animation */
      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      .loading-dots {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin: 20px 0;
      }

      .loading-dot {
        width: 12px;
        height: 12px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s ease-in-out infinite both;
      }

      .loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .loading-dot:nth-child(2) { animation-delay: -0.16s; }
      .loading-dot:nth-child(3) { animation-delay: 0; }

      .loading-text {
        color: #374151;
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-top: 16px;
        font-family: 'Noto Sans Thai', sans-serif;
      }

      .loading-progress {
        width: 200px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        margin: 20px auto;
        overflow: hidden;
      }

      .loading-progress-bar {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
        background-size: 200% 100%;
        animation: progress 2s ease-in-out infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      @keyframes progress {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
      }

      .dark .loading-overlay {
        background: rgba(17, 24, 39, 0.95);
      }

      .dark .loading-text {
        color: #f9fafb;
      }

      .dark .loading-spinner {
        border-color: #374151;
        border-top-color: #60a5fa;
      }

      .dark .loading-dot {
        background: #60a5fa;
      }
    </style>
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Notification System CSS -->
  <link rel="stylesheet" href="/css/notification-system.css" />
    <style>
      body {
        font-family: "Prompt", sans-serif;
        background-color: #f3f4f6; /* Tailwind's bg-gray-100 */
      }
      .page-link {
        cursor: pointer;
        padding: 0.5rem 0.75rem;
        margin: 0 0.25rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
            .bubble h6 {
        font-size: 0.875rem;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
      }
      .page-link.active {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }
      .page-link:hover {
        background-color: #e2e2e2;
        transform: translateY(-1px);
      }
      .loading {
        position: relative;
      }
      .loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Loading overlay */
            [data-theme="dark"]       #loadingOverlay .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 0.25rem solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    </style>
  
  <!-- LoadingSystem v2.0.0 - Inline Version -->
  <style>
    /* LoadingSystem CSS - Inline Version */
    .loading-system-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 10001;
      pointer-events: auto;
    }

    .loading-overlay.loading-visible {
      opacity: 1;
      visibility: visible;
    }

    .loading-overlay.loading-hiding {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      max-width: 90vw;
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      border: 0.25rem solid #e0e0e0;
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: loading-spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    .loading-message {
      color: #333333;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }

    .loading-progress {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress-fill {
      height: 100%;
      background: #0d6efd;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    /* Theme Variants */
    .loading-success .loading-spinner { border-top-color: #10b981; }
    .loading-success .loading-progress-fill { background: #10b981; }

    .loading-warning .loading-spinner { border-top-color: #f59e0b; }
    .loading-warning .loading-progress-fill { background: #f59e0b; }

    .loading-error .loading-spinner { border-top-color: #ef4444; }
    .loading-error .loading-progress-fill { background: #ef4444; }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    /* Dark mode support */
    [data-theme="dark"] .loading-content {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .loading-message {
      color: #ffffff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .loading-content {
        padding: 1.5rem;
        margin: 1rem;
      }
    }

    /* Lottie Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      backdrop-filter: blur(12px);
    }
  </style>

  <script>
    // LoadingSystem v2.0.0 - Inline Version
    (function(window) {
      'use strict';

      console.log('🚀 LoadingSystem v2.0.0 (Inline) initializing...');

      let activeLoaders = new Map();
      let loaderCounter = 0;
      let defaultContainer = null;

      function createDefaultContainer() {
        if (defaultContainer && document.body.contains(defaultContainer)) {
          return defaultContainer;
        }
        defaultContainer = document.createElement('div');
        defaultContainer.id = 'loading-system-container';
        defaultContainer.className = 'loading-system-container';
        document.body.appendChild(defaultContainer);
        return defaultContainer;
      }

      function generateLoaderId() {
        return `loader-${Date.now()}-${++loaderCounter}`;
      }

      function createLoadingOverlay(options = {}) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
    
        const content = document.createElement('div');
        content.className = 'loading-content';
    
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
    
        const message = document.createElement('div');
        message.className = 'loading-message';
        message.textContent = options.message || 'กำลังโหลด...';
    
        let progressBar = null;
        if (options.showProgress) {
          progressBar = document.createElement('div');
          progressBar.className = 'loading-progress';
    
          const progressFill = document.createElement('div');
          progressFill.className = 'loading-progress-fill';
          progressBar.appendChild(progressFill);
        }
    
        content.appendChild(spinner);
        content.appendChild(message);
        if (progressBar) {
          content.appendChild(progressBar);
        }
        overlay.appendChild(content);
    
        return { overlay, progressBar };
      }

      function updateProgress(loaderId, progress) {
        const loaderData = activeLoaders.get(loaderId);
        if (loaderData && loaderData.progressBar) {
          const fill = loaderData.progressBar.querySelector('.loading-progress-fill');
          if (fill) {
            fill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
          }
        }
      }

      function startAutoProgress(loaderId) {
        const loaderData = activeLoaders.get(loaderId);
        if (!loaderData || !loaderData.autoProgress) return;

        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 95) {
            progress = 95;
            clearInterval(interval);
          }
          updateProgress(loaderId, progress);
        }, 200);

        loaderData.progressInterval = interval;
      }

      const LoadingSystem = {
        show: function(options = {}) {
          try {
            const loaderId = generateLoaderId();
            const container = createDefaultContainer();
    
            const { overlay, progressBar } = createLoadingOverlay(options);
            overlay.setAttribute('data-loader-id', loaderId);
    
            if (options.type && options.type !== 'default') {
              overlay.classList.add(`loading-${options.type}`);
            }
    
            container.appendChild(overlay);
    
            const loaderData = {
              overlay: overlay,
              progressBar: progressBar,
              options: options,
              createdAt: Date.now(),
              autoProgress: options.autoProgress,
              progressInterval: null,
              timeout: null
            };
    
            activeLoaders.set(loaderId, loaderData);
    
            if (options.autoProgress && progressBar) {
              startAutoProgress(loaderId);
            }
    
            if (options.timeout && options.timeout > 0) {
              loaderData.timeout = setTimeout(() => {
                this.hide(loaderId);
              }, options.timeout);
            }
    
            requestAnimationFrame(() => {
              overlay.classList.add('loading-visible');
            });
    
            console.log(`✅ LoadingSystem.show() - ID: ${loaderId}`);
            return loaderId;
    
          } catch (error) {
            console.error('❌ LoadingSystem.show() error:', error);
            return null;
          }
        },

        hide: function(loaderId) {
          try {
            if (!loaderId) return;
    
            const loaderData = activeLoaders.get(loaderId);
            if (!loaderData) return;
    
            if (loaderData.progressBar) {
              updateProgress(loaderId, 100);
            }
    
            if (loaderData.progressInterval) {
              clearInterval(loaderData.progressInterval);
            }
    
            if (loaderData.timeout) {
              clearTimeout(loaderData.timeout);
            }
    
            loaderData.overlay.classList.remove('loading-visible');
            loaderData.overlay.classList.add('loading-hiding');
    
            setTimeout(() => {
              if (loaderData.overlay && loaderData.overlay.parentNode) {
                loaderData.overlay.parentNode.removeChild(loaderData.overlay);
              }
              activeLoaders.delete(loaderId);
            }, 300);
    
            console.log(`✅ LoadingSystem.hide() - ID: ${loaderId}`);
    
          } catch (error) {
            console.error('❌ LoadingSystem.hide() error:', error);
          }
        },

        hideAll: function() {
          try {
            const loaderIds = Array.from(activeLoaders.keys());
            loaderIds.forEach(loaderId => this.hide(loaderId));
            console.log(`✅ LoadingSystem.hideAll() - ซ่อน ${loaderIds.length} loaders`);
          } catch (error) {
            console.error('❌ LoadingSystem.hideAll() error:', error);
          }
        },

        updateProgress: function(loaderId, progress) {
          updateProgress(loaderId, progress);
        },

        completeProgress: function(loaderId = null) {
          if (loaderId) {
            updateProgress(loaderId, 100);
            setTimeout(() => this.hide(loaderId), 500);
    } else {
            activeLoaders.forEach((loaderData, id) => {
              if (loaderData.progressBar) {
                updateProgress(id, 100);
                setTimeout(() => this.hide(id), 500);
              }
            });
          }
        },

        updateMessage: function(loaderId, message) {
          try {
            const loaderData = activeLoaders.get(loaderId);
            if (loaderData) {
              const messageEl = loaderData.overlay.querySelector('.loading-message');
              if (messageEl) {
                messageEl.textContent = message;
      }
            }
          } catch (error) {
            console.error('❌ LoadingSystem.updateMessage() error:', error);
          }
        },

        isActive: function(loaderId) {
          return activeLoaders.has(loaderId);
        },

        getActiveCount: function() {
          return activeLoaders.size;
        },

        cleanup: function() {
          this.hideAll();
          if (defaultContainer && document.body.contains(defaultContainer)) {
            document.body.removeChild(defaultContainer);
            defaultContainer = null;
          }
          activeLoaders.clear();
          loaderCounter = 0;
          console.log('🧹 LoadingSystem.cleanup() - ล้างข้อมูลทั้งหมดแล้ว');
        },

        debug: function() {
          return {
            activeLoaders: activeLoaders.size,
            loaderIds: Array.from(activeLoaders.keys()),
            containerExists: !!defaultContainer,
            version: '2.0.0-inline'
          };
        }
      };

      // Export LoadingSystem to global scope
      window.LoadingSystem = LoadingSystem;

      // Auto cleanup เมื่อออกจากหน้า
      window.addEventListener('beforeunload', () => {
        LoadingSystem.cleanup();
      });

      console.log('✅ LoadingSystem v2.0.0 (Inline) initialized successfully');

    })(window);
  </script>

</head>

  <body class="flex flex-col min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header class="p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between ml-56 transition-all duration-300"
                     id="mainHeader">
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">ประวัติใบเสร็จผ่อน</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo">
          กำลังโหลดสาขา...
        </p>
      </div>

      <!-- Notifications -->
      <div class="relative" id="notificationWrapper">
        <button id="notificationButton" class="notification-button">
          <i class="bi bi-bell-fill text-lg"></i>
        </button>
        <span id="notificationDot" class="notification-dot hidden"></span>
        <span id="notificationBadge" class="notification-badge hidden">0</span>
        
        <!-- Notification Dropdown -->
        <div id="notificationDropdown" class="notification-dropdown hidden">
          <div class="notification-dropdown-header">
            <h3 class="notification-dropdown-title">การแจ้งเตือน</h3>
            <button class="mark-all-read text-sm text-blue-600 dark:text-blue-400 hover:underline">อ่านทั้งหมดแล้ว</button>
          </div>
          <div class="notification-dropdown-content">
            <div class="notification-loading">
              <div class="notification-loading-spinner"></div>
              กำลังโหลด...
            </div>
          </div>
          <div class="notification-dropdown-footer">
            <a href="#" class="text-sm">ดูการแจ้งเตือนทั้งหมด</a>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 p-6 overflow-y-auto transition-all duration-300 ml-56">
      <div class="container mx-auto">
      <!-- Header Section -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
          <i class="bi bi-receipt text-blue-600 mr-2"></i>
          ประวัติใบเสร็จผ่อน
        </h1>
        <div class="badge badge-info">
          <span id="recordCount">0</span> รายการ
        </div>
      </div>

      <!-- ฟอร์มเลือกวันที่และค้นหาชื่อลูกค้า -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">
          <i class="bi bi-funnel mr-2"></i>ตัวกรองข้อมูล
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="label">
              <span class="label-text font-semibold">จากวันที่:</span>
            </label>
            <input type="date" id="startDate" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label">
              <span class="label-text font-semibold">ถึงวันที่:</span>
            </label>
            <input type="date" id="endDate" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label">
              <span class="label-text font-semibold">ค้นหาชื่อลูกค้า:</span>
            </label>
            <input
              type="text"
              id="customerSearch"
              class="input input-bordered w-full"
              placeholder="ชื่อหรือนามสกุล"
            />
          </div>
          <div class="flex items-end">
            <button id="btnFilter" class="btn btn-primary w-full">
              <i class="bi bi-search mr-2"></i>
              ค้นหา
            </button>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="btnClearFilter" class="btn btn-ghost btn-sm">
            <i class="bi bi-x-circle mr-1"></i>
            เคลียร์ตัวกรอง
          </button>
          <button id="btnRefresh" class="btn btn-ghost btn-sm">
            <i class="bi bi-arrow-clockwise mr-1"></i>
            รีเฟรช
          </button>
        </div>
      </div>

      <!-- ตารางข้อมูล -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-calendar-event mr-1"></i>วันที่/เวลา
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-person mr-1"></i>ลูกค้า/สัญญา
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-file-earmark mr-1"></i>ประเภทเอกสาร
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-cash-stack mr-1"></i>จำนวนเงิน
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-person-badge mr-1"></i>พนักงาน
                </th>
                <th class="text-gray-700 font-semibold">
                  <i class="bi bi-gear mr-1"></i>การดำเนินการ
                </th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- แถวข้อมูลจะถูกแทรกด้วย JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- ส่วนแสดงปุ่มแบ่งหน้า (Pagination) -->
      <div class="mt-6 flex justify-center">
        <div id="pagination" class="flex flex-wrap gap-1"></div>
      </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <script>
      // Function to show/hide loading overlay
            // Get branch code from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      let BRANCH_CODE = urlParams.get('branch') || localStorage.getItem('activeBranch');
      
      if (!BRANCH_CODE) {
        console.warn("Branch code not specified, defaulting to 'PATTANI'");
        BRANCH_CODE = 'PATTANI';
      }
      window.currentBranchCode = BRANCH_CODE;
      console.log(`[History_installment] Using branch code: ${BRANCH_CODE}`);

      let globalInstallmentData = []; // เก็บข้อมูลผ่อน (branchStockHistory) ที่กรองแล้ว
      let filteredData = [];         // เก็บข้อมูลหลังจากกรองด้วยวันที่ / ชื่อลูกค้า
      let currentPage = 1;           // หน้าที่กำลังแสดง
      const pageSize = 10;           // จำนวนแถวต่อ 1 หน้า

      // ฟังก์ชันแสดง Toast Notification - ใช้ notification system
      function showToast(message, type = 'info', duration = 3000) {
        // ใช้ notification system ถ้าพร้อม
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          return window.NotificationSystem.instance.showToast(message, type, duration);
        } else {
          // ลองสร้าง instance ใหม่ถ้า DOM พร้อมแล้ว
          if (document.body && window.createNotificationInstance) {
            console.log('🔄 Auto-creating NotificationSystem instance for history...');
            window.createNotificationInstance();
      
            // ลองใช้ instance ที่สร้างใหม่
            setTimeout(() => {
              if (window.NotificationSystem && window.NotificationSystem.instance) {
                return window.NotificationSystem.instance.showToast(message, type, duration);
              }
            }, 100);
          }

          // Fallback - สร้าง toast แบบเดิม
          console.log(`[Toast Fallback: ${type.toUpperCase()}] ${message}`);
          const container = document.getElementById('toastContainer');
          if (!container) return;
      
          const toast = document.createElement('div');
      
          let bgColor = 'bg-blue-500';
          let icon = 'bi-info-circle';
      
          switch(type) {
            case 'success':
              bgColor = 'bg-green-500';
              icon = 'bi-check-circle';
              break;
            case 'error':
              bgColor = 'bg-red-500';
              icon = 'bi-x-circle';
              break;
            case 'warning':
              bgColor = 'bg-yellow-500';
              icon = 'bi-exclamation-triangle';
              break;
          }
      
          toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transform translate-x-full transition-transform duration-300`;
          toast.innerHTML = `
            <i class="bi ${icon}"></i>
            <span>${message}</span>
          `;
      
          container.appendChild(toast);
      
          // Animate in
          setTimeout(() => {
            toast.classList.remove('translate-x-full');
          }, 100);
      
          // Auto remove
          setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
              if (container.contains(toast)) {
                container.removeChild(toast);
              }
            }, 300);
          }, duration);
        }
      }

      // ฟังก์ชันแปลงวันที่/เวลา (performed_at) เป็นรูปแบบ DD/MM/YYYY HH:mm
      function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        try {
          const dt = new Date(dateStr);
          const day = String(dt.getDate()).padStart(2, '0');
          const month = String(dt.getMonth() + 1).padStart(2, '0');
          const year = dt.getFullYear();
          const hour = String(dt.getHours()).padStart(2, '0');
          const min = String(dt.getMinutes()).padStart(2, '0');
          return `${day}/${month}/${year} ${hour}:${min}`;
        } catch (err) {
          return 'N/A';
        }
      }

      // ✅ Enhanced Performance: Retry logic and concurrent data fetching
      async function fetchWithRetry(url, options = {}, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            const response = await fetch(url, options);
            if (response.ok) return response;

            if (attempt === maxRetries) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Exponential backoff delay
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
          } catch (error) {
            if (attempt === maxRetries) throw error;
            console.warn(`🔄 Retry attempt ${attempt} for ${url}:`, error.message);
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
          }
        }
      }

      // ✅ Enhanced Data Cache with TTL
      const dataCache = new Map();
      const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

      function getCachedData(key) {
        const cached = dataCache.get(key);
        if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
          console.log(`📊 Using cached data for: ${key}`);
          return cached.data;
        }
        return null;
      }

      function setCachedData(key, data) {
        dataCache.set(key, { data, timestamp: Date.now() });
        console.log(`💾 Cached data for: ${key}`);
      }

      // ดึงข้อมูลประวัติขายผ่อน พร้อมเอกสารที่เกี่ยวข้อง (ใบกำกับภาษี + ใบเสร็จ)
      async function fetchInstallmentHistoryData() {
        // ✅ Check cache first
        const cacheKey = `installment_history_${BRANCH_CODE || 'PT'}`;
        const cachedData = getCachedData(cacheKey);

        if (cachedData) {
          return cachedData;
        }

        showLoading(true);
        try {
          const token = localStorage.getItem('authToken') || '';

          // สร้าง query parameters สำหรับกรองข้อมูล
          const queryParams = new URLSearchParams();
          queryParams.append('branch_code', BRANCH_CODE || 'PATTANI');
          queryParams.append('limit', '200');
          queryParams.append('status', 'active,completed,ongoing'); // เฉพาะสถานะที่เกี่ยวข้อง

          // ดึงข้อมูลจาก TaxInvoice และ Receipt collections โดยตรง
          let allInstallmentData = [];

          // ✅ Concurrent data fetching for better performance
          const [taxInvoiceResult, receiptResult] = await Promise.allSettled([
            fetchWithRetry(`/api/taxinvoice/branch/${BRANCH_CODE || 'PT'}?saleType=installment&limit=100`, {
              headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetchWithRetry(`/api/receipt/branch/${BRANCH_CODE || 'PT'}?receiptType=down_payment_receipt&limit=100`, {
              headers: { 'Authorization': `Bearer ${token}` }
            })
          ]);

          // 1. Handle TaxInvoice data
          if (taxInvoiceResult.status === 'fulfilled') {
            const taxInvoiceRes = taxInvoiceResult.value;
      
          if (taxInvoiceRes.ok) {
            const taxInvoiceData = await taxInvoiceRes.json();
            if (taxInvoiceData.success && taxInvoiceData.data?.documents) {
              taxInvoiceData.data.documents.forEach(taxInvoice => {
                // สร้างข้อมูลจาก TaxInvoice
                allInstallmentData.push({
                  _id: taxInvoice._id,
                  contractNo: taxInvoice.contractNo || 'N/A',
                  performed_at: taxInvoice.createdAt || taxInvoice.issueDate,
                  customer_info: {
                    // ใช้ข้อมูลจาก TaxInvoice โดยตรง
                    fullName: taxInvoice.customer?.name || taxInvoice.customer?.fullName || '',
                    firstName: taxInvoice.customer?.firstName || taxInvoice.customer?.first_name || '',
                    lastName: taxInvoice.customer?.lastName || taxInvoice.customer?.last_name || '',
                    phoneNumber: taxInvoice.customer?.phone || taxInvoice.customer?.phone_number || '',
                    taxId: taxInvoice.customer?.taxId || taxInvoice.customer?.tax_id || '',
                    address: taxInvoice.customer?.address || '',
                    customerType: taxInvoice.customer?.customerType || 'individual'
                  },
                  staff_name: taxInvoice.employeeName || 'ไม่ระบุ',
                  status: 'installment_tax_invoice',
                  branch_code: taxInvoice.branchCode,
                  totalAmount: taxInvoice.summary?.totalWithTax || taxInvoice.calculation?.totalAmount || 0,
                  downPayment: taxInvoice.downPaymentAmount || 0,
                  vatAmount: taxInvoice.summary?.vatAmount || taxInvoice.calculation?.vatAmount || 0,
                  documentType: 'TAX_INVOICE',
                  documentNumber: taxInvoice.taxInvoiceNumber,
                  showVat: true,
                  isPrimaryDocument: true,
                  receiptType: 'installment_tax_invoice',
                  reason: 'ขายแบบผ่อน',
                  change_type: 'OUT'
                });
              });
            }
          } else {
            console.warn('⚠️ TaxInvoice fetch failed:', taxInvoiceResult.reason);
          }
        } else {
          console.warn('⚠️ TaxInvoice fetch failed:', taxInvoiceResult.reason);
        }

        // 2. Handle Receipt data
        if (receiptResult.status === 'fulfilled') {
          const receiptRes = receiptResult.value;

          if (receiptRes.ok) {
            const receiptData = await receiptRes.json();
            if (receiptData.success && receiptData.data?.documents) {
              receiptData.data.documents
                .filter(receipt => receipt.saleType === 'installment')
                .forEach(receipt => {
                  // สร้างข้อมูลจาก Receipt
                  allInstallmentData.push({
                    _id: receipt._id,
                    contractNo: receipt.contractNo || 'N/A',
                    performed_at: receipt.createdAt || receipt.issueDate,
                    customer_info: {
                      // ใช้ข้อมูลจาก Receipt โดยตรง
                      fullName: receipt.customer?.name || receipt.customer?.fullName || '',
                      firstName: receipt.customer?.firstName || receipt.customer?.first_name || '',
                      lastName: receipt.customer?.lastName || receipt.customer?.last_name || '',
                      phoneNumber: receipt.customer?.phone || receipt.customer?.phone_number || '',
                      taxId: receipt.customer?.taxId || receipt.customer?.tax_id || '',
                      address: receipt.customer?.address || '',
                      customerType: receipt.customer?.customerType || 'individual'
                    },
                    staff_name: receipt.employeeName || 'ไม่ระบุ',
                    status: 'installment_receipt',
                    branch_code: receipt.branchCode,
                    totalAmount: receipt.totalAmount || 0,
                    downPayment: receipt.downPaymentAmount || receipt.totalAmount || 0,
                    vatAmount: receipt.vatAmount || 0,
                    documentType: 'RECEIPT',
                    documentNumber: receipt.receiptNumber,
                    showVat: false,
                    isPrimaryDocument: false,
                    receiptType: 'installment_receipt',
                    reason: 'ขายแบบผ่อน',
                    change_type: 'OUT'
                  });
                });
            }
          } else {
            console.warn('⚠️ Receipt fetch failed with HTTP error');
          }
        } else {
          console.warn('⚠️ Receipt fetch failed:', receiptResult.reason);
        }
      
          // Log ข้อมูลที่ได้
          console.log(`📊 Loaded ${allInstallmentData.length} documents from TaxInvoice and Receipt collections`);
          console.log('📋 Document breakdown:', {
            receipts: allInstallmentData.filter(d => d.documentType === 'RECEIPT').length,
            taxInvoices: allInstallmentData.filter(d => d.documentType === 'TAX_INVOICE').length,
            uniqueContracts: new Set(allInstallmentData.map(d => d.contractNo)).size
          });
      
          // เรียงลำดับแบบพิเศษ: จัดให้เอกสารคู่อยู่ติดกัน (Tax Invoice ก่อน Receipt)
          allInstallmentData.sort((a, b) => {
            // เรียงตามวันที่ก่อน
            const dateA = new Date(a.performed_at);
            const dateB = new Date(b.performed_at);
            if (dateA.getTime() !== dateB.getTime()) {
              return dateB - dateA; // ล่าสุดก่อน
            }
      
            // ถ้าวันที่เดียวกัน ให้ Tax Invoice (เอกสารหลัก) มาก่อน Receipt
            if (a.contractNo === b.contractNo) {
              if (a.documentType === 'TAX_INVOICE' && b.documentType === 'RECEIPT') return -1;
              if (a.documentType === 'RECEIPT' && b.documentType === 'TAX_INVOICE') return 1;
            }
      
            return 0;
          });
      
          console.log(`📊 Loaded ${allInstallmentData.length} installment documents (paired documents)`);
          console.log('📋 Document breakdown:', {
            receipts: allInstallmentData.filter(d => d.documentType === 'RECEIPT').length,
            taxInvoices: allInstallmentData.filter(d => d.documentType === 'TAX_INVOICE').length,
            uniqueContracts: new Set(allInstallmentData.map(d => d.contractNo)).size,
            documentPairs: allInstallmentData.length / 2,
            primaryDocs: allInstallmentData.filter(d => d.isPrimaryDocument === true).length,
            secondaryDocs: allInstallmentData.filter(d => d.isPrimaryDocument === false).length
          });
      
          // Debug ตัวอย่างข้อมูลเพื่อหาสาเหตุ
          if (allInstallmentData.length > 0) {
            const sample = allInstallmentData[0];
            console.log('🔍 Sample document data:', {
              contractNo: sample.contractNo,
              documentType: sample.documentType,
              isPrimaryDocument: sample.isPrimaryDocument,
              customer_info: sample.customer_info,
              rawCustomerData: {
                firstName: sample.customer_info?.firstName,
                lastName: sample.customer_info?.lastName,
                companyName: sample.customer_info?.companyName,
                customerType: sample.customer_info?.customerType,
                _rawCustomer: sample.customer_info?._rawCustomer,
                _rawCustomerInfo: sample.customer_info?._rawCustomerInfo
              }
            });
          }
      
          // ✅ Cache successful data fetch
          setCachedData(cacheKey, allInstallmentData);

          showToast(`โหลดข้อมูลสำเร็จ ${allInstallmentData.length} รายการ`, 'success');
          return allInstallmentData;
        } catch (err) {
          console.error('❌ Error fetching installment data:', err);

          // ✅ Enhanced error handling with specific messages
          const errorMessage = err.message?.includes('network')
            ? 'เกิดข้อผิดพลาดเครือข่าย กรุณาตรวจสอบการเชื่อมต่อ'
            : err.message?.includes('HTTP 401')
            ? 'การเข้าสู่ระบบหมดอายุ กรุณาล็อกอินใหม่'
            : err.message?.includes('HTTP 403')
            ? 'ไม่มีสิทธิ์เข้าถึงข้อมูล'
            : `เกิดข้อผิดพลาดในการโหลดข้อมูล: ${err.message}`;

          showToast(errorMessage, 'error');
          return [];
        } finally {
          showLoading(false);
        }
      }

      // ฟังก์ชันแบ่งหน้า
      function paginate(data, page, pageSize) {
        const startIndex = (page - 1) * pageSize;
        return data.slice(startIndex, startIndex + pageSize);
      }

      // เรนเดอร์ตาราง
      function renderHistoryTable(data, page = 1) {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        const pageData = paginate(data, page, pageSize);

        // อัปเดตจำนวนรายการ
        document.getElementById('recordCount').textContent = data.length;

        if (pageData.length === 0) {
          const trEmpty = document.createElement('tr');
          const tdEmpty = document.createElement('td');
          tdEmpty.setAttribute('colspan', 6); // เปลี่ยนจาก 5 เป็น 6 เพราะเพิ่มคอลัมน์
          tdEmpty.className = 'text-center text-gray-500 py-12';
          tdEmpty.innerHTML = `
            <div class="flex flex-col items-center">
              <i class="bi bi-inbox text-4xl text-gray-300 mb-2"></i>
              <p class="text-lg">ไม่พบข้อมูลในช่วงที่เลือก</p>
              <p class="text-sm">ลองปรับเปลี่ยนตัวกรองข้อมูล</p>
            </div>
          `;
          trEmpty.appendChild(tdEmpty);
          tbody.appendChild(trEmpty);
          return;
        }

        pageData.forEach((record, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-colors';

          // วันที่/เวลา (performed_at)
          const tdDate = document.createElement('td');
          tdDate.className = 'font-mono text-sm';
          tdDate.textContent = formatDateTime(record.performed_at);
          tr.appendChild(tdDate);

          // ชื่อลูกค้า + เลขสัญญา + ประเภทเอกสาร
          let customerName = 'N/A';
          if (record.customer_info) {
            if (record.customer_info.customerType === 'corporate' && record.customer_info.companyName) {
              // นิติบุคคล
              customerName = record.customer_info.companyName;
            } else {
              // บุคคลธรรมดา - ใช้ fullName เป็นหลัก (มาจาก customer.name)
              const fullName = record.customer_info.fullName || '';
              const fn = record.customer_info.firstName || '';
              const ln = record.customer_info.lastName || '';
              const constructedName = (fn + ' ' + ln).trim();
      
              if (fullName && fullName.trim() && fullName !== 'undefined undefined') {
                customerName = fullName.trim();
              } else if (constructedName && constructedName !== ' ' && constructedName !== 'undefined undefined') {
                customerName = constructedName;
              } else {
                // ถ้าไม่มีชื่อ ลองใช้เลขสัญญาเป็นตัวแทน
                if (record.contractNo && record.contractNo !== 'N/A') {
                  customerName = `ลูกค้า ${record.contractNo}`;
                } else {
                  customerName = 'ลูกค้าทั่วไป';
                }
              }
            }
          }
          const tdCustomer = document.createElement('td');
          tdCustomer.className = 'font-medium';
      
          // แสดงความสัมพันธ์ระหว่างเอกสาร
          let documentInfo = '';
          if (record.isPrimaryDocument === true) {
            documentInfo = '<br><small class="text-blue-600 font-semibold">📄 เอกสารหลัก</small>';
          } else if (record.isPrimaryDocument === false) {
            documentInfo = '<br><small class="text-gray-500">📋 อิงจากใบกำกับภาษี</small>';
          } else {
            // Fallback สำหรับข้อมูลเก่า
            documentInfo = record.documentType === 'TAX_INVOICE' ?
              '<br><small class="text-blue-600 font-semibold">📄 เอกสารหลัก</small>' :
              '<br><small class="text-gray-500">📋 อิงจากใบกำกับภาษี</small>';
          }
      
          const contractInfo = record.contractNo && record.contractNo !== 'N/A' ?
            `<br><small class="text-gray-600">สัญญา: ${record.contractNo}</small>` :
            '<br><small class="text-gray-400">ไม่มีเลขสัญญา</small>';
      
          const documentNumberInfo = record.documentNumber ?
            `<br><small class="text-gray-500">เลขที่: ${record.documentNumber}</small>` : '';
      
          // Debug สำหรับแถวที่มีปัญหา
          if (customerName === 'N/A' || customerName.includes('ลูกค้า QT-')) {
            console.log('⚠️ Customer name issue for record:', {
              contractNo: record.contractNo,
              documentType: record.documentType,
              finalCustomerName: customerName,
              customer_info: record.customer_info,
              availableNames: {
                fullName: record.customer_info?.fullName,
                firstName: record.customer_info?.firstName,
                lastName: record.customer_info?.lastName,
                constructedName: (record.customer_info?.firstName + ' ' + record.customer_info?.lastName).trim()
              },
              _id: record._id
            });
          }
      
          tdCustomer.innerHTML = `${customerName}${contractInfo}${documentNumberInfo}${documentInfo}`;
          tr.appendChild(tdCustomer);

          // ประเภทเอกสาร (แสดงตามสถานะจริงและประเภทเอกสาร)
          const tdDocType = document.createElement('td');
          let statusBadge = '';
          let statusText = record.status || 'ongoing';
      
          // กำหนด badge ตามสถานะจริง
          switch(statusText) {
            case 'pending':
              statusBadge = '<span class="badge badge-warning">รอดำเนินการ</span>';
              break;
            case 'approved':
              statusBadge = '<span class="badge badge-info">อนุมัติแล้ว</span>';
              break;
            case 'active':
            case 'ongoing':
              // แสดงประเภทเอกสารสำหรับสถานะที่กำลังดำเนินการ
              if (record.documentType === 'TAX_INVOICE') {
                statusBadge = '<span class="badge badge-success">ใบกำกับภาษี</span>';
              } else {
                statusBadge = '<span class="badge badge-primary">ใบเสร็จ</span>';
              }
              break;
            case 'completed':
              statusBadge = '<span class="badge badge-success">เสร็จสิ้น</span>';
              break;
            case 'cancelled':
              statusBadge = '<span class="badge badge-error">ยกเลิก</span>';
              break;
            case 'rejected':
              statusBadge = '<span class="badge badge-error">ปฏิเสธ</span>';
              break;
            case 'installment_receipt':
              statusBadge = '<span class="badge badge-primary">ใบเสร็จผ่อน</span>';
              break;
            case 'installment_tax_invoice':
              statusBadge = '<span class="badge badge-success">ใบกำกับภาษีผ่อน</span>';
              break;
            default:
              statusBadge = '<span class="badge badge-info">กำลังผ่อน</span>';
          }
      
          tdDocType.innerHTML = statusBadge;
          tr.appendChild(tdDocType);

          // จำนวนเงิน (แสดงตามประเภทเอกสาร)
          const tdAmount = document.createElement('td');
          tdAmount.className = 'font-mono text-right';
      
          let amountDisplay = '';
          const downPayment = record.downPayment || 0;
          const totalAmount = record.totalAmount || 0;
          const vatAmount = record.vatAmount || 0;
      
          if (record.documentType === 'TAX_INVOICE') {
            // ใบกำกับภาษี: แสดงยอดรวมพร้อมภาษี (ตามข้อมูลจริงในฐานข้อมูล)
            const beforeTax = totalAmount - vatAmount;
            amountDisplay = `
              <div class="text-sm">
                <div class="font-semibold text-green-600">฿${totalAmount.toLocaleString()}</div>
                <div class="text-xs text-gray-500">
                  ก่อนภาษี ฿${beforeTax.toLocaleString()}<br>
                  ภาษี 7% ฿${vatAmount.toLocaleString()}
                </div>
              </div>
            `;
          } else {
            // ใบเสร็จ: แสดงยอดเงินดาวน์ (เหมือนใบกำกับภาษีแต่ไม่แสดงรายละเอียดภาษี)
            amountDisplay = `
              <div class="text-sm">
                <div class="font-semibold text-blue-600">฿${totalAmount.toLocaleString()}</div>
                <div class="text-xs text-gray-500">เงินดาวน์ (ไม่แสดงภาษี)</div>
              </div>
            `;
          }
      
          tdAmount.innerHTML = amountDisplay;
          tr.appendChild(tdAmount);

          // พนักงาน (staff_name)
          const tdStaff = document.createElement('td');
          tdStaff.textContent = record.staff_name || 'N/A';
          tr.appendChild(tdStaff);

          // ปุ่มปฏิบัติการ
          const tdAction = document.createElement('td');
          const actionDiv = document.createElement('div');
          actionDiv.className = 'flex gap-2';

          // ปุ่มปริ้น (80mm)
          const printBtn = document.createElement('button');
          printBtn.className = 'btn btn-sm btn-outline';
          printBtn.innerHTML = '<i class="bi bi-printer mr-1"></i>ปริ้น';
          printBtn.addEventListener('click', () => {
            printInstallmentReceipt(record._id, printBtn);
          });
          actionDiv.appendChild(printBtn);

          // ปุ่มโหลดภาพ JPG (POS 80mm)
          const loadBtn = document.createElement('button');
          loadBtn.className = 'btn btn-sm btn-secondary';
          loadBtn.innerHTML = '<i class="bi bi-image mr-1"></i>JPG (POS)';
          loadBtn.addEventListener('click', () => {
            downloadInstallmentReceiptAsJPG(record._id, loadBtn);
          });
          actionDiv.appendChild(loadBtn);

          // ปุ่มโหลด PDF (A4) - แสดงประเภทเอกสารที่ชัดเจน
          const pdfBtn = document.createElement('button');
          if (record.documentType === 'TAX_INVOICE') {
            pdfBtn.className = 'btn btn-sm btn-success';
            pdfBtn.innerHTML = '<i class="bi bi-file-earmark-pdf mr-1"></i>ใบกำกับภาษี';
          } else {
            pdfBtn.className = 'btn btn-sm btn-primary';
            pdfBtn.innerHTML = '<i class="bi bi-file-earmark-pdf mr-1"></i>ใบเสร็จ';
          }
          pdfBtn.addEventListener('click', () => {
            downloadInstallmentReceiptAsPDF(record._id, pdfBtn);
          });
          actionDiv.appendChild(pdfBtn);

          tdAction.appendChild(actionDiv);
          tr.appendChild(tdAction);
          tbody.appendChild(tr);
        });
      }

      // เรนเดอร์ปุ่ม pagination
      function renderPagination(data, page = 1) {
        const totalPages = Math.ceil(data.length / pageSize);
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';
      
        if (totalPages <= 1) return;

        // ปุ่มหน้าก่อนหน้า
        if (page > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn-outline btn-sm';
          prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i> ก่อนหน้า';
          prevBtn.addEventListener('click', () => {
            currentPage = page - 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(prevBtn);
        }

        // ปุ่มแต่ละหน้า (แสดงไม่เกิน 5 หน้า)
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(totalPages, page + 2);

        if (startPage > 1) {
          const firstBtn = document.createElement('button');
          firstBtn.className = 'btn btn-outline btn-sm';
          firstBtn.textContent = '1';
          firstBtn.addEventListener('click', () => {
            currentPage = 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(firstBtn);

          if (startPage > 2) {
            const dotsSpan = document.createElement('span');
            dotsSpan.className = 'px-2 text-gray-500';
            dotsSpan.textContent = '...';
            paginationEl.appendChild(dotsSpan);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement('button');
          btn.className = `btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}`;
          btn.textContent = i;
          btn.addEventListener('click', () => {
            currentPage = i;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(btn);
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const dotsSpan = document.createElement('span');
            dotsSpan.className = 'px-2 text-gray-500';
            dotsSpan.textContent = '...';
            paginationEl.appendChild(dotsSpan);
          }

          const lastBtn = document.createElement('button');
          lastBtn.className = 'btn btn-outline btn-sm';
          lastBtn.textContent = totalPages;
          lastBtn.addEventListener('click', () => {
            currentPage = totalPages;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(lastBtn);
        }

        // ปุ่มถัดไป
        if (page < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn-outline btn-sm';
          nextBtn.innerHTML = 'ถัดไป <i class="bi bi-chevron-right"></i>';
          nextBtn.addEventListener('click', () => {
            currentPage = page + 1;
            renderHistoryTable(data, currentPage);
            renderPagination(data, currentPage);
          });
          paginationEl.appendChild(nextBtn);
        }
      }

      // ฟังก์ชันปริ้นใบเสร็จ (ใช้ข้อมูลจาก Receipt/TaxInvoice)
      async function printInstallmentReceipt(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> กำลังพิมพ์...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // หาข้อมูลเอกสารจาก filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('ไม่พบข้อมูลเอกสาร', 'error');
            return;
          }

          // เตรียมข้อมูลสำหรับสร้างเอกสาร (ใบกำกับภาษี หรือ ใบเสร็จ)
          const originalInstallmentId = documentRecord._id.replace('_tax', '').replace('_receipt', '');
          const documentData = {
            // ข้อมูลเอกสาร
            documentId: originalInstallmentId,
            documentNumber: documentRecord.documentNumber,
            contractNumber: documentRecord.contractNo,
            documentType: documentRecord.documentType,
            receiptType: documentRecord.receiptType || 'installment_down_payment',
      
            // ข้อมูลลูกค้า
            customerInfo: {
              name: `${documentRecord.customer_info?.firstName || ''} ${documentRecord.customer_info?.lastName || ''}`.trim() || 'ลูกค้าทั่วไป',
              phone: documentRecord.customer_info?.phoneNumber || '',
              address: 'ไม่ระบุที่อยู่'
            },
      
            // ข้อมูลสินค้า/บริการ
            items: [
              {
                description: `เงินดาวน์การผ่อนชำระ - สัญญา ${documentRecord.contractNo}`,
                amount: documentRecord.downPayment || documentRecord.totalAmount || 0,
                quantity: 1,
                unitPrice: documentRecord.downPayment || documentRecord.totalAmount || 0
              }
            ],
      
            // ข้อมูลการเงิน - ปรับตามประเภทเอกสาร
            totalAmount: documentRecord.totalAmount || 0,
            downPayment: documentRecord.downPayment || 0,
            monthlyPayment: documentRecord.monthlyPayment || 0,
            installmentCount: documentRecord.installmentCount || 0,
      
            // การจัดการภาษี - สำคัญมาก!
            vatAmount: documentRecord.showVat ? (documentRecord.vatAmount || 0) : 0,
            showVat: documentRecord.showVat || false,
            beforeTaxAmount: documentRecord.showVat ?
              ((documentRecord.downPayment || 0) - (documentRecord.vatAmount || 0)) :
              (documentRecord.downPayment || 0),
      
            remainingAmount: documentRecord.remainingAmount || 0,
      
            // ข้อมูลอื่นๆ
            paymentMethod: 'cash',
            createdAt: documentRecord.performed_at,
            status: documentRecord.status,
      
            // ข้อมูลสาขา
            branch: {
              name: 'สาขา ' + (documentRecord.branch_code || 'MAIN'),
              code: documentRecord.branch_code || 'MAIN',
              address: 'ที่อยู่สาขา',
              phone: '000-000-0000'
            },
      
            // ข้อมูลพนักงาน
            employeeName: documentRecord.staff_name,
      
            // ข้อมูลความสัมพันธ์
            isPrimaryDocument: documentRecord.isPrimaryDocument,
            linkedTaxInvoiceId: documentRecord.linkedTaxInvoiceId,
      
            // Flag สำหรับ Controller - บังคับประเภทเอกสาร
            useDatabase: true,
            sourceCollection: 'InstallmentOrder', // ใช้แหล่งข้อมูลหลัก
            renderMode: documentRecord.documentType === 'TAX_INVOICE' ? 'tax_invoice' : 'receipt',
            forceDocumentType: documentRecord.documentType, // บังคับประเภทเอกสาร
            forceReceiptMode: documentRecord.documentType === 'RECEIPT', // บังคับโหมดใบเสร็จ
            suppressVatDisplay: documentRecord.documentType === 'RECEIPT' // ซ่อนภาษีสำหรับใบเสร็จ
          };

          // สร้างภาพใบเสร็จผ่าน PDFoooRasterController
          const PDFoooRasterController = require('../../controllers/pdf/PDFoooRasterController');
      
          // เรียกใช้ API สำหรับสร้างภาพใบเสร็จ - ใช้ endpoint ที่ถูกต้อง
          const token = localStorage.getItem('authToken') || '';
      
          // สร้างข้อมูลที่ไม่มี VAT สำหรับใบเสร็จ
          if (documentRecord.documentType === 'RECEIPT') {
            documentData.vatAmount = 0;
            documentData.showVat = false;
            documentData.taxType = 'no_vat';
            documentData.beforeTaxAmount = documentData.totalAmount;
            documentData.items = documentData.items.map(item => ({
              ...item,
              hasVat: false,
              vatRate: 0
            }));
          }
      
          const pdfResponse = await fetch('/api/receipt/generate-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              receiptData: documentData,
              documentType: documentRecord.documentType,
              forceReceiptMode: documentRecord.documentType === 'RECEIPT'
            })
          });

          let receiptImage = null;
          if (pdfResponse.ok) {
            const pdfResult = await pdfResponse.json();
            if (pdfResult.success && pdfResult.data?.receiptImage) {
              receiptImage = pdfResult.data.receiptImage;
            }
          }

          // ถ้าไม่สามารถสร้างภาพได้ ให้ใช้วิธีสำรอง
          if (!receiptImage) {
            console.warn('⚠️ Using fallback receipt generation method');
            // สร้างข้อความใบเสร็จแบบง่าย
            const receiptText = `
=== ใบเสร็จรับเงิน ===
เลขที่: ${receiptData.documentNumber}
สัญญา: ${receiptData.contractNumber}
ลูกค้า: ${receiptData.customerInfo.name}
จำนวนเงิน: ฿${receiptData.totalAmount.toLocaleString()}
วันที่: ${new Date(receiptData.createdAt).toLocaleDateString('th-TH')}
พนักงาน: ${receiptData.employeeName}
========================
            `;
      
            // แปลงเป็น base64 (สำหรับการพิมพ์)
            receiptImage = btoa(receiptText);
          }

          // เรียก mini print server ที่ localhost:4000
          const resp = await fetch('http://localhost:4000/print', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              image: receiptImage,
              type: 'installment_receipt',
              documentType: documentRecord.documentType
            })
          });
      
          const printResult = await resp.json();
          if (!resp.ok || !printResult.success) {
            console.error('Print error:', printResult.error);
            showToast('พิมพ์ใบเสร็จไม่สำเร็จ', 'error');
            return;
          }
      
          showToast(`ส่งคำสั่งพิมพ์${documentRecord.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}เรียบร้อย!`, 'success');
        } catch (err) {
          console.error('Error printing Installment Receipt:', err);
          showToast('เกิดข้อผิดพลาดระหว่างพิมพ์ใบเสร็จ', 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ฟังก์ชันดาวน์โหลดใบเสร็จเป็นไฟล์ PDF A4 จริง - ปรับปรุงให้ดึงข้อมูลจากฐานข้อมูลจริง
      async function downloadInstallmentReceiptAsPDF(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> กำลังสร้าง PDF A4...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // หาข้อมูลเอกสารจาก filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('ไม่พบข้อมูลเอกสาร', 'error');
            return;
          }

          const token = localStorage.getItem('authToken') || '';
      
          // 🔧 แทนที่จะส่งข้อมูลที่อาจไม่ครบ ให้ใช้ A4PDFController ดึงข้อมูลจากฐานข้อมูลโดยตรง
          console.log('📄 Requesting PDF for document:', {
            id: documentRecord._id,
            documentNumber: documentRecord.documentNumber,
            documentType: documentRecord.documentType
          });

          let pdfResponse;

          // เรียกใช้ A4PDFController โดยบังคับประเภทเอกสาร
          const originalInstallmentId = documentRecord._id.replace('_tax', '').replace('_receipt', '');
      
          if (documentRecord.documentType === 'TAX_INVOICE') {
            // สำหรับใบกำกับภาษี - ดึงข้อมูลจากฐานข้อมูลและแสดงภาษี
            pdfResponse = await fetch('/api/pdf/a4-tax-invoice', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify({
                taxInvoiceId: originalInstallmentId,
                documentNumber: documentRecord.documentNumber,
                useDatabase: true,
                forceDocumentType: 'TAX_INVOICE',
                showVat: true,
                // ดึงข้อมูลจาก TaxInvoice collection โดยตรง
                documentType: 'TAX_INVOICE'
              })
            });
          } else {
            // สำหรับใบเสร็จ - ดึงข้อมูลเดียวกันแต่ไม่แสดงภาษี
            pdfResponse = await fetch('/api/pdf/a4-receipt', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify({
                receiptId: originalInstallmentId,
                documentNumber: documentRecord.documentNumber,
                useDatabase: true,
                forceDocumentType: 'RECEIPT',
                showVat: false,
                suppressVatDisplay: true, // บังคับไม่แสดงภาษี
                taxType: 'no_vat',
                // ดึงข้อมูลจาก Receipt collection โดยตรง
                documentType: 'RECEIPT',
                forceReceiptMode: true
              })
            });
          }

          if (!pdfResponse.ok) {
            // Fallback: ใช้ API ทั่วไปสำหรับการสร้าง A4 PDF
            console.warn('⚠️ A4 PDF API not available, trying fallback...');
      
            const fallbackData = {
              documentId: documentRecord._id,
              documentType: documentRecord.documentType,
              documentNumber: documentRecord.documentNumber,
              contractNo: documentRecord.contractNo,
              format: 'A4', // ระบุให้สร้างแบบ A4
              customer: {
                name: `${documentRecord.customer_info?.firstName || ''} ${documentRecord.customer_info?.lastName || ''}`.trim() || 'ลูกค้าทั่วไป',
                phone: documentRecord.customer_info?.phoneNumber || '',
                address: 'ไม่ระบุที่อยู่'
              },
              totalAmount: documentRecord.downPayment || documentRecord.totalAmount || 0,
              employeeName: documentRecord.staff_name,
              branchCode: documentRecord.branch_code,
              createdAt: documentRecord.performed_at
            };

            pdfResponse = await fetch('/api/pdf/a4-document', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/pdf'
              },
              body: JSON.stringify(fallbackData)
            });
          }

          if (!pdfResponse.ok) {
            throw new Error(`ไม่สามารถสร้าง PDF A4 ได้ (${pdfResponse.status})`);
          }

          // ตรวจสอบ Content-Type
          const contentType = pdfResponse.headers.get('Content-Type');
      
          if (contentType && contentType.includes('application/pdf')) {
            // ได้ PDF โดยตรง
            const pdfBlob = await pdfResponse.blob();
            downloadImageAsFile(pdfBlob, documentRecord, 'pdf');
            showToast(`ดาวน์โหลด PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}สำเร็จ`, 'success');
          } else {
            // ได้ JSON response
            const jsonResult = await pdfResponse.json();
      
            if (jsonResult.success && jsonResult.pdfBase64) {
              // แปลง base64 เป็น PDF blob
              const pdfBlob = base64ToBlob(jsonResult.pdfBase64, 'application/pdf');
              downloadImageAsFile(pdfBlob, documentRecord, 'pdf');
              showToast(`ดาวน์โหลด PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}สำเร็จ`, 'success');
            } else if (jsonResult.success && jsonResult.downloadUrl) {
              // ดาวน์โหลดจาก URL
              downloadFromURL(jsonResult.downloadUrl, jsonResult.fileName || 'document.pdf');
              showToast(`ดาวน์โหลด PDF A4 ${documentRecord.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}สำเร็จ`, 'success');
            } else {
              throw new Error(jsonResult.message || 'ไม่สามารถสร้าง PDF A4 ได้');
            }
          }

        } catch (err) {
          console.error('Error downloading A4 PDF:', err);
          showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ฟังก์ชันช่วยสำหรับดาวน์โหลดภาพเป็นไฟล์
      function downloadImageAsFile(blob, documentRecord, extension = 'png') {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
      
        const docType = documentRecord.documentType === 'TAX_INVOICE' ? 'tax-invoice' : 'receipt';
        const timestamp = new Date().toISOString().slice(0, 10);
        const fileName = `${docType}-${documentRecord.contractNo || documentRecord._id}-${timestamp}.${extension}`;
        link.download = fileName;
      
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      // ฟังก์ชันช่วยสำหรับดาวน์โหลด PDF blob
      function downloadPDFBlob(blob, documentRecord) {
        downloadImageAsFile(blob, documentRecord, 'pdf');
      }

      // ฟังก์ชันช่วยสำหรับดาวน์โหลดจาก URL
      function downloadFromURL(url, fileName) {
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        link.target = '_blank';
      
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ฟังก์ชันดาวน์โหลดภาพใบเสร็จเป็นไฟล์ JPG (POS 80mm ข้อมูลครบ)
      async function downloadInstallmentReceiptAsJPG(historyId, buttonElement) {
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<span class="loading loading-spinner loading-xs"></span> กำลังสร้างรูป POS...';
        buttonElement.disabled = true;
        showLoading(true);

        try {
          // หาข้อมูลเอกสารจาก filteredData
          const documentRecord = filteredData.find(item => item._id === historyId);
          if (!documentRecord) {
            showToast('ไม่พบข้อมูลเอกสาร', 'error');
            return;
          }

          const token = localStorage.getItem('authToken') || '';
          let imageResponse;

          // เรียกใช้ API PDFoooRasterController ผ่าน routes ใหม่
          if (documentRecord.documentType === 'TAX_INVOICE') {
            imageResponse = await fetch(`/api/pdf/installment/tax-invoice/${documentRecord._id}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
              }
            });
          } else {
            imageResponse = await fetch(`/api/pdf/installment/receipt/${documentRecord._id}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
              }
            });
          }

          if (!imageResponse.ok) {
            throw new Error(`ไม่สามารถสร้างภาพได้ (${imageResponse.status})`);
          }

          const jsonResult = await imageResponse.json();
      
          if (jsonResult.success && jsonResult.data?.base64) {
            // แปลง base64 เป็น JPG blob
            const imageBlob = base64ToBlob(jsonResult.data.base64, 'image/jpeg');
      
            // ดาวน์โหลดเป็นไฟล์ JPG
            const url = URL.createObjectURL(imageBlob);
            const link = document.createElement('a');
            link.href = url;
      
            const docType = documentRecord.documentType === 'TAX_INVOICE' ? 'tax-invoice' : 'receipt';
            const fileName = `${docType}-pos-${documentRecord.contractNo || historyId}-${new Date().getTime()}.jpg`;
            link.download = fileName;
      
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
      
            showToast(`ดาวน์โหลดภาพ POS ${documentRecord.documentType === 'TAX_INVOICE' ? 'ใบกำกับภาษี' : 'ใบเสร็จ'}สำเร็จ`, 'success');
          } else {
            throw new Error(jsonResult.message || 'ไม่สามารถสร้างภาพได้');
          }

        } catch (err) {
          console.error('Error downloading POS image:', err);
          showToast(`เกิดข้อผิดพลาด: ${err.message}`, 'error');
        } finally {
          buttonElement.innerHTML = originalHTML;
          buttonElement.disabled = false;
          showLoading(false);
        }
      }

      // ฟังก์ชันแปลง base64 เป็น Blob
      function base64ToBlob(base64, mime) {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mime });
      }

      // ฟังก์ชันกรองข้อมูลใน memory ตามวันที่และชื่อลูกค้า
      function filterDataInMemory(data, startDateStr, endDateStr, customerSearch) {
        let temp = [...data];

        // กรองตามวันที่
        if (startDateStr) {
          const start = new Date(startDateStr);
          temp = temp.filter(item => new Date(item.performed_at) >= start);
        }
        if (endDateStr) {
          const end = new Date(endDateStr);
          end.setHours(23, 59, 59, 999);
          temp = temp.filter(item => new Date(item.performed_at) <= end);
        }

        // กรองตามชื่อลูกค้า
        if (customerSearch) {
          const lower = customerSearch.toLowerCase();
          temp = temp.filter(item => {
            let custName = '';
            if (item.customer_info) {
              const fn = item.customer_info.firstName || '';
              const ln = item.customer_info.lastName || '';
              custName = (fn + ' ' + ln).trim().toLowerCase();
            }
            return custName.includes(lower);
          });
        }

        return temp;
      }

      // ฟังก์ชัน onFilter() เมื่อกดปุ่มค้นหา
      function onFilter() {
        const startDateStr = document.getElementById('startDate').value;
        const endDateStr = document.getElementById('endDate').value;
        const searchValue = document.getElementById('customerSearch').value.trim();

        filteredData = filterDataInMemory(
          globalInstallmentData,
          startDateStr,
          endDateStr,
          searchValue
        );
        currentPage = 1;
        renderHistoryTable(filteredData, currentPage);
        renderPagination(filteredData, currentPage);
      
        showToast(`พบข้อมูล ${filteredData.length} รายการ`, 'info', 2000);
      }

      // ฟังก์ชันเคลียร์ตัวกรอง
      function clearFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('customerSearch').value = '';
      
        filteredData = globalInstallmentData;
        currentPage = 1;
        renderHistoryTable(filteredData, currentPage);
        renderPagination(filteredData, currentPage);
      
        showToast('เคลียร์ตัวกรองแล้ว', 'info', 2000);
      }

      // ฟังก์ชันรีเฟรชข้อมูล
      async function refreshData() {
        const refreshBtn = document.getElementById('btnRefresh');
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> กำลังโหลด...';
        refreshBtn.disabled = true;

        try {
          // ✅ Clear cache to force fresh data fetch
          const cacheKey = `installment_history_${BRANCH_CODE || 'PT'}`;
          dataCache.delete(cacheKey);
          console.log('🗑️ Cache cleared for refresh');

          globalInstallmentData = await fetchInstallmentHistoryData();
          onFilter(); // ใช้ตัวกรองปัจจุบัน
          showToast('รีเฟรชข้อมูลสำเร็จ', 'success', 2000);
        } catch (error) {
          console.error('Refresh error:', error);
          showToast('เกิดข้อผิดพลาดในการรีเฟรชข้อมูล', 'error');
        } finally {
          refreshBtn.innerHTML = originalHTML;
          refreshBtn.disabled = false;
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        let pageLoaderId = null;
        try {
          showLoading(true);
      
          // 1) ดึงประวัติผ่อนจาก branchStockHistory
          globalInstallmentData = await fetchInstallmentHistoryData();
          // 2) เริ่มต้น filteredData = globalInstallmentData ทั้งหมด
          filteredData = globalInstallmentData;

          // 3) เรนเดอร์ตาราง + pagination
          renderHistoryTable(filteredData, currentPage);
          renderPagination(filteredData, currentPage);

          // 4) ผูก event listeners
          document.getElementById('btnFilter').addEventListener('click', onFilter);
          document.getElementById('btnClearFilter').addEventListener('click', clearFilters);
          document.getElementById('btnRefresh').addEventListener('click', refreshData);
          document.getElementById('customerSearch').addEventListener('input', onFilter);
      
          // Auto-filter เมื่อเปลี่ยนวันที่
          document.getElementById('startDate').addEventListener('change', onFilter);
          document.getElementById('endDate').addEventListener('change', onFilter);

          // Sidebar link highlighting
          const sidebarLinks = document.querySelectorAll('aside a');
          function highlightSidebar(link) {
            sidebarLinks.forEach(l => {
              l.style.backgroundColor = '';
              l.style.color = '';
              const ico = l.querySelector('i');
              if (ico) ico.style.color = '';
            });
            const icon = link.querySelector('i');
            if (icon) {
              const c = getComputedStyle(icon).color;
              link.style.backgroundColor = c;
              link.style.color = '#fff';
              icon.style.color = '#fff';
            }
          }
          sidebarLinks.forEach(link => link.addEventListener('click', () => highlightSidebar(link)));
          const page = window.location.pathname.split('/').pop();
          sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === page) highlightSidebar(link);
          });
        } catch (error) {
          console.error('Page loading error:', error);
        } finally {
          showLoading(false);
        }
      });</script>

    <!-- Firebase Realtime Database Integration -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCv4EBbKN8Kr4IMRqszJGBWTSoMihtYLo",
        authDomain: "pheenongacc.firebaseapp.com",
        databaseURL: "https://pheenongacc-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pheenongacc",
        storageBucket: "pheenongacc.appspot.com",
        messagingSenderId: "158417807357",
        appId: "1:158417807357:web:4a9c78f7aea793dc7d64494",
        measurementId: "G-F7DPQ7XG9K"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      
      // ฟังการเปลี่ยนแปลงข้อมูลผ่อน
      const installmentRef = ref(db, 'installment/updated');
      onValue(installmentRef, snapshot => {
        if (snapshot.val()) {
          console.log('📦 Installment data updated via Firebase');
          // Auto refresh ถ้ามีการอัปเดต
          if (typeof refreshData === 'function') {
            refreshData();
          }
        }
      });

      console.log('🔥 Firebase Realtime Database initialized for installment history');
    </script>

    <!-- Enhanced Socket.IO Integration -->
    <script>
      const socket = io();

      socket.on('connect', () => {
        console.log('🔗 Socket.IO connected to installment history');
        console.log('🆔 Socket ID:', socket.id);
      
        socket.emit('join_branch', {
          branchCode: BRANCH_CODE,
          page: 'installment_history',
          timestamp: new Date().toISOString()
        });

        // ส่ง join notification room สำหรับระบบแจ้งเตือน
        socket.emit('join_notification_room', {
          branchCode: BRANCH_CODE,
          page: 'installment_history',
          timestamp: new Date().toISOString()
        });
      });

      socket.on('disconnect', (reason) => {
        console.log('❌ Socket.IO disconnected:', reason);
        showToast('การเชื่อมต่อขาดหาย', 'warning');
      });

      socket.on('reconnect', (attemptNumber) => {
        console.log('🔄 Socket.IO reconnected after', attemptNumber, 'attempts');
        showToast('เชื่อมต่อใหม่สำเร็จ', 'success');
      });

      socket.on('installment_updated', (data) => {
        console.log('📦 Installment updated via Socket.IO:', data);
        showToast('ข้อมูลผ่อนได้รับการอัปเดต', 'info', 2000);
      
        // เพิ่มลงใน notification dropdown ถ้ามี
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: '📦 อัปเดตข้อมูลผ่อน',
            message: `ข้อมูลรายการผ่อน ${data.installmentId || ''} ได้รับการอัปเดต`,
            type: 'info',
            timestamp: new Date().toISOString(),
            read: false
          });
        }
      
        // Auto refresh data
        if (typeof refreshData === 'function') {
          refreshData();
        }
      });

      socket.on('receipt_printed', (data) => {
        if (data.type === 'installment') {
          console.log('🖨️ Receipt printed:', data);
          showToast(`ใบเสร็จผ่อนถูกพิมพ์เรียบร้อย`, 'success');
      
          if (window.NotificationSystem && window.NotificationSystem.instance) {
            window.NotificationSystem.instance.addNotification({
              id: Date.now(),
              title: '🖨️ พิมพ์ใบเสร็จสำเร็จ',
              message: `ใบเสร็จผ่อน ${data.receiptId || ''} ถูกพิมพ์เรียบร้อย`,
              type: 'success',
              timestamp: new Date().toISOString(),
              read: false
            });
          }
        }
      });

      socket.on('installment_payment_received', (data) => {
        console.log('💰 Payment received:', data);
        showToast(`💰 ได้รับการชำระเงินงวดที่ ${data.installmentNumber || '-'}`, 'success');
      
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: '💰 ได้รับการชำระเงิน',
            message: `งวดที่ ${data.installmentNumber || '-'} จำนวน ฿${data.amount || 0}`,
            type: 'success',
            timestamp: new Date().toISOString(),
            read: false
          });
        }
      
        // Refresh data เพื่อแสดงสถานะล่าสุด
        if (typeof refreshData === 'function') {
          refreshData();
        }
      });

      socket.on('installment_overdue', (data) => {
        console.log('⏰ Installment overdue:', data);
        showToast(`⏰ รายการผ่อน ${data.installmentId || ''} เกินกำหนดชำระ`, 'warning');
      
        if (window.NotificationSystem && window.NotificationSystem.instance) {
          window.NotificationSystem.instance.addNotification({
            id: Date.now(),
            title: '⏰ การผ่อนเกินกำหนด',
            message: `รายการผ่อน ${data.installmentId || ''} เกินกำหนดชำระ ${data.daysPastDue || 0} วัน`,
            type: 'warning',
            timestamp: new Date().toISOString(),
            read: false,
            priority: 'high'
          });
        }
      });

      // ฟัง branch และ system notifications
      socket.on('branch_notification', (data) => {
        console.log('🔔 Branch notification:', data);
        showToast(data.message || '📢 แจ้งเตือนจากระบบ', data.type || 'info');
      });

      socket.on('system_notification', (data) => {
        console.log('🔧 System notification:', data);
        showToast(`🔧 ${data.message}`, data.type || 'warning');
      });

      // Error handling
      socket.on('error', (error) => {
        console.error('❌ Socket.IO error:', error);
        showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
      });

      console.log('🔌 Enhanced Socket.IO initialized for installment history');
    </script>
    </main>
    
    <!-- เพิ่ม JavaScript สำหรับโหลดข้อมูลสาขา -->
    <script>
      // โหลดข้อมูลสาขา
      async function loadBranchInfo() {
        try {
          const branchCode = BRANCH_CODE;
          const token = localStorage.getItem('authToken') || '';
      
          // เรียก /api/branch เพื่อดึง list สาขา
          const res = await fetch(`/api/branch`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const js = await res.json();
          if (res.ok && js.success) {
            // หา record ที่ตรงกับ branch_code
            const branch = js.data.find(b => b.branch_code === branchCode);
            if (branch) {
              document.getElementById('branchInfo').textContent =
                `${branch.name} — ${branch.address}`;
              // อัพเดท title ของหน้าด้วยชื่อสาขาจริง
              document.title = `ประวัติใบเสร็จผ่อน - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `ประวัติใบเสร็จผ่อน - ${branch.name}`;
              return;
            }
          }
          throw new Error('ไม่พบข้อมูลสาขา');
        } catch (err) {
          console.warn('loadBranchInfo error:', err);
          document.getElementById('branchInfo').textContent =
            'สาขา: (ไม่พบข้อมูล)';
        }
      }
      
      // เรียกใช้ loadBranchInfo เมื่อ DOM โหลดเสร็จ
      document.addEventListener('DOMContentLoaded', function() {
        try {
          loadBranchInfo();

          // อัพเดท title จาก URL parameter
          const urlParams = new URLSearchParams(window.location.search);
          const branchName = urlParams.get('name');
          if (branchName) {
            document.title = `ประวัติใบเสร็จผ่อน - ${decodeURIComponent(branchName)}`;
          }
        } catch (error) {
          console.error('Branch loading error:', error);
        }
      });

      // ==================== DEBUG & TEST FUNCTIONS ====================

      // ✅ Comprehensive Testing Suite for Loading States
      window.testLoadingStates = async function() {
        console.log('🧪 Testing all loading states...');

        try {
          // Test 1: Basic CSS Animation
          console.log('1️⃣ Testing CSS-based loading animation...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 2000));
          showLoading(false);
          console.log('✅ CSS loading animation works');

          await new Promise(resolve => setTimeout(resolve, 1000));

          // Test 2: LoadingSystem integration
          console.log('2️⃣ Testing new showLoading integration...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 3000));
          showLoading(false);
          console.log('✅ New showLoading works');

          await new Promise(resolve => setTimeout(resolve, 1000));

          // Test 3: Error handling
          console.log('3️⃣ Testing error handling...');
          try {
            await fetchWithRetry('https://invalid-url-for-testing.invalid', {}, 1);
          } catch (error) {
            console.log('✅ Error handling works:', error.message);
          }

          // Test 4: Cache functionality
          console.log('4️⃣ Testing cache functionality...');
          setCachedData('test_key', { test: 'data' });
          const cached = getCachedData('test_key');
          console.log('✅ Cache works:', !!cached);

          // Test 5: Thai language rendering
          console.log('5️⃣ Testing Thai language rendering...');
          showLoading(true);
          await new Promise(resolve => setTimeout(resolve, 2000));
          showLoading(false);
          console.log('✅ Thai language rendering works');

          showToast('🎉 การทดสอบเสร็จสิ้น - ระบบทำงานปกติทุกส่วน', 'success');
          console.log('🎉 All loading states tested successfully!');

        } catch (error) {
          console.error('❌ Test failed:', error);
          showToast('การทดสอบล้มเหลว: ' + error.message, 'error');
        }
      };

      // ✅ Network Performance Test
      window.testNetworkPerformance = async function() {
        console.log('🚀 Testing network performance...');

        const startTime = Date.now();

        try {
          // Test concurrent fetching vs sequential
          console.log('Testing concurrent vs sequential fetching...');

          const sequentialStart = Date.now();
          await fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
          await fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } });
          const sequentialTime = Date.now() - sequentialStart;

          const concurrentStart = Date.now();
          await Promise.allSettled([
            fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } }),
            fetchWithRetry('/api/branch', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } })
          ]);
          const concurrentTime = Date.now() - concurrentStart;

          console.log(`📊 Sequential: ${sequentialTime}ms, Concurrent: ${concurrentTime}ms`);
          console.log(`🏃‍♂️ Performance improvement: ${Math.round((sequentialTime - concurrentTime) / sequentialTime * 100)}%`);

          showToast(`เทสต์ประสิทธิภาพเสร็จสิ้น - ปรับปรุงเร็วขึ้น ${Math.round((sequentialTime - concurrentTime) / sequentialTime * 100)}%`, 'success');

        } catch (error) {
          console.error('Network test error:', error);
        }
      };

      // ==================== DEBUG & TEST FUNCTIONS ====================
      
      // Global debug helper สำหรับหน้า History_installment
      window.HistoryInstallmentDebug = {
        notificationSystem: () => {
          return {
            available: !!window.NotificationSystem,
            instance: !!window.NotificationSystem?.instance,
            notifications: window.NotificationSystem?.instance?.notifications?.length || 0,
            dropdownExists: !!document.getElementById('notificationDropdown'),
            socketConnected: socket?.connected || false,
            branchCode: BRANCH_CODE
          };
        },
      
        testNotifications: () => {
          if (window.testNotifications) {
            window.testNotifications();
            console.log('🔔 Testing notification system...');
          } else {
            console.warn('testNotifications function not available, using manual tests');
            // ทดสอบแบบ manual
            showToast('📊 ทดสอบแจ้งเตือนประวัติ - สำเร็จ', 'success');
            setTimeout(() => showToast('💰 ทดสอบแจ้งเตือนประวัติ - ได้รับชำระเงิน', 'success'), 1000);
            setTimeout(() => showToast('🖨️ ทดสอบแจ้งเตือนประวัติ - พิมพ์ใบเสร็จ', 'info'), 2000);
            setTimeout(() => showToast('⏰ ทดสอบแจ้งเตือนประวัติ - เกินกำหนด', 'warning'), 3000);
          }
        },

        testHistoryNotifications: () => {
          console.log('🧪 Testing history-specific notifications...');
      
          const notifications = [
            { message: '📊 โหลดประวัติใบเสร็จผ่อนสำเร็จ', type: 'success' },
            { message: '🖨️ ส่งคำสั่งพิมพ์ใบเสร็จ #INS001', type: 'info' },
            { message: '💾 ดาวน์โหลดใบเสร็จ #INS002.jpg', type: 'success' },
            { message: '🔄 อัปเดตข้อมูลประวัติใบเสร็จ', type: 'info' },
            { message: '💰 ได้รับการชำระงวดที่ 5/12', type: 'success' },
            { message: '⏰ มีรายการเกินกำหนด 3 รายการ', type: 'warning' }
          ];
      
          notifications.forEach((notif, index) => {
            setTimeout(() => {
              showToast(notif.message, notif.type);
            }, index * 1000);
          });

          // ทดสอบ dropdown notifications ถ้ามี
          if (window.NotificationSystem && window.NotificationSystem.instance) {
            setTimeout(() => {
              window.NotificationSystem.instance.addNotification({
                id: Date.now() + 1,
                title: '📋 รายงานประจำวัน',
                message: 'ใบเสร็จผ่อนวันนี้: 12 ใบ, ชำระแล้ว: 8 ใบ, ค้างชำระ: 4 ใบ',
                type: 'info',
                timestamp: new Date().toISOString(),
                read: false
              });
            }, 7000);
          }
      
          console.log('🎯 Test history notifications completed');
        },

        socketStatus: () => {
          return {
            connected: socket?.connected || false,
            id: socket?.id || null,
            transport: socket?.io?.engine?.transport?.name || null
          };
        },

        refreshHistoryData: () => {
          if (typeof refreshData === 'function') {
            refreshData();
            console.log('🔄 Manual refresh triggered');
          } else {
            console.warn('refreshData function not available');
          }
        },

        version: '1.0.0-history-installment'
      };

      // ฟังก์ชันทดสอบ notifications เฉพาะสำหรับหน้า history
      window.testHistoryNotifications = function() {
        return window.HistoryInstallmentDebug.testHistoryNotifications();
      };

      console.log('🎯 History Installment Debug functions ready');
      console.log('🔧 Debug: HistoryInstallmentDebug object available globally');
      console.log('🧪 ทดสอบ History Notifications: testHistoryNotifications() หรือ HistoryInstallmentDebug.testHistoryNotifications()');
      console.log('📊 ตรวจสอบสถานะ: HistoryInstallmentDebug.notificationSystem()');
      console.log('🔌 ตรวจสอบ Socket: HistoryInstallmentDebug.socketStatus()');
      
      // ตรวจสอบสถานะระบบหลังจากโหลดเสร็จ
      setTimeout(() => {
        const status = window.HistoryInstallmentDebug.notificationSystem();
        console.log('🔔 NotificationSystem status:', status);
      
        if (!status.available) {
          console.warn('⚠️ NotificationSystem not available, only fallback toasts will work');
        } else if (!status.instance) {
          console.warn('⚠️ NotificationSystem instance not created, trying to create...');
          if (window.createNotificationInstance) {
            window.createNotificationInstance();
          }
        } else {
          console.log('✅ NotificationSystem fully operational');
        }
      }, 2000);
    </script>

    <script>
      // Enhanced CSS-based Loading Animation Function
      // ✅ No external dependencies - 100% local solution

      // Show/Hide Loading Function (based on home.html pattern)
      function showLoading(show) {
        const loader = document.getElementById('loadingOverlay');
        if (show) {
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          // โหลดและเล่น Lottie animation
          if (!lottieAnimation) {
            console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
            fetch('/Loading/Loading.json')
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to fetch Lottie animation');
                }
                return response.json();
              })
              .then(animationData => {
                lottieAnimation = lottie.loadAnimation({
                  container: document.getElementById('lottieContainer'),
                  renderer: 'svg',
                  loop: true,
                  autoplay: true,
                  animationData: animationData
                });
                console.log('✅ Lottie animation loaded successfully');
              })
              .catch(error => {
                console.error('❌ Error loading Lottie animation:', error);
                // Fallback เฉพาะเมื่อ Lottie โหลดไม่สำเร็จ
                document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
              });
          } else {
            lottieAnimation.play();
          }
        } else {
          if (lottieAnimation) {
            lottieAnimation.pause();
          }
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');
          setTimeout(() => {
            loader.style.display = 'none';
          }, 300);
        }
      }

      // Initialize loading on page load
      document.addEventListener('DOMContentLoaded', function() {
        showLoading(true);

        // Auto-hide loading after page is fully loaded
        window.addEventListener('load', function() {
          setTimeout(() => showLoading(false), 1000);
        });
      });

      // Make functions globally available
      window.showLoading = showLoading;

      // Auto cleanup เมื่อออกจากหน้า
      window.addEventListener('beforeunload', () => {
        if (lottieAnimation) {
          lottieAnimation.destroy();
          lottieAnimation = null;
        }
      });
    </script>
  </body>
</html>
