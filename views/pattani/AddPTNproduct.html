<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Inventory Dashboard (Mobile Friendly) - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f8f9fa;
      margin-top: 20px;
    }
    .card {
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    footer {
      background-color: #fff;
      padding: 1rem 0;
      text-align: center;
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 2rem;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.03);
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Keyboard Wedge) */
    #barcodeInput {
      position: absolute;
      top: 0;
      left: 0;
      width: 1px;
      height: 1px;
      opacity: 0;
      border: none;
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏¥‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI */
    .editable-imei {
      cursor: pointer;
    }
    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ + ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢) */
    .supplier-header button {
      font-weight: 700;
      font-size: 1rem;
    }
    /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkbox */
    .form-check-input {
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-secondary">Inventory Dashboard</h4>
    <div>
      <span id="loggedInUser" class="me-3 text-secondary"></span>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-box-arrow-right me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <h2 class="mb-4">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h2>

  <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î -->
  <div class="card p-3 mb-4">
    <h5 class="card-title mb-3">
      <i class="bi bi-building me-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
    </h5>
    <div class="row g-2">
      <div class="col-12 col-sm-6">
        <label for="branchSelect" class="form-label fw-semibold">‡∏™‡∏≤‡∏Ç‡∏≤</label>
        <select class="form-select" id="branchSelect">
          <option value="">-- Loading --</option>
        </select>
      </div>
      <div class="col-12 col-sm-6 d-flex align-items-end">
        <button class="btn btn-primary w-100" id="btnScanBarcode">
          <i class="bi bi-camera"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
        </button>
      </div>
    </div>
  </div>

  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö 2-Level Accordion -->
  <div class="card p-3">
    <h5 class="card-title mb-3">
      <i class="bi bi-people"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å (Grouped by Supplier)
    </h5>
    <div id="stockContainer"><!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ renderStocksGroupedBySupplier() --></div>
  </div>
</div>

<footer>
  <div class="container">
    <small>¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.</small>
  </div>
</footer>

<!-- Hidden input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î (Keyboard Wedge) -->
<input type="text" id="barcodeInput" autofocus />

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô -->
<div class="modal fade" id="barcodeModal" tabindex="-1" aria-labelledby="barcodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="barcodeModalLabel">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
         <div class="mb-3">
           <label for="scannedCodeModal" class="form-label fw-semibold">‡πÄ‡∏•‡∏Ç‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
           <input type="text" class="form-control" id="scannedCodeModal" readonly>
         </div>
         <div class="table-responsive">
           <table class="table table-bordered table-sm">
              <thead class="table-light">
                <tr>
                  <th>‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</th>
                  <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="scannedProductsTable">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
              </tbody>
           </table>
         </div>
      </div>
      <div class="modal-footer">
         <button type="button" class="btn btn-secondary" id="cancelManualEntry">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
         <button type="button" class="btn btn-primary" id="confirmManualEntry">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let scannedProduct = null;
  let scannedProducts = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ô modal

  document.addEventListener('DOMContentLoaded', async () => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const token = localStorage.getItem('authToken');
    const userEmail = localStorage.getItem('userEmail');
    if (!token) {
      alert('‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ token');
      window.location.href = '/login';
      return;
    }
    try {
      const res = await fetch('/api/users/me', {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
      }
      document.getElementById('loggedInUser').textContent = userEmail
        ? `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${userEmail}`
        : 'Guest';
      const allowedPages = data.data.allowedPages || [];
      if (!allowedPages.includes('inventory')) {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Inventory');
        window.location.href = '/login';
        return;
      }
    } catch (err) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      window.location.href = '/login';
      return;
    }
  
    // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PTN01 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    await loadBranches();
  
    // ‡∏ï‡∏±‡πâ‡∏á event listener ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
    document.getElementById('btnLogout').addEventListener('click', logout);
    document.getElementById('branchSelect').addEventListener('change', loadStock);
    document.getElementById('btnScanBarcode').addEventListener('click', onScanBarcodeClick);

    // ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡πà‡∏≤‡∏ô keyboard wedge (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    barcodeInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        const code = e.target.value.trim();
        if (code) {
          console.log('üî∏ Barcode Received:', code);
          processBarcode(code);
        }
        e.target.value = '';
      }
    });

    // ‡∏ï‡∏±‡πâ‡∏á event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal
    document.getElementById('confirmManualEntry').addEventListener('click', confirmScannedProducts);
    document.getElementById('cancelManualEntry').addEventListener('click', cancelScannedProducts);

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Modal -> focus ‡∏ó‡∏µ‡πà input ‡∏ï‡πà‡∏≠
    const barcodeModalEl = document.getElementById('barcodeModal');
    barcodeModalEl.addEventListener('hidden.bs.modal', () => {
      barcodeInput.focus();
    });
  });
  
  function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    window.location.href = '/login';
  }
  
  async function loadBranches() {
    try {
      const token = localStorage.getItem('authToken');
      const res = await fetch('/api/branch', {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤');
      }
  
      const branchSelect = document.getElementById('branchSelect');
      branchSelect.innerHTML = '';
      const ptnBranches = data.data.filter(b => b.branch_code === 'PTN01');
      if (ptnBranches.length === 0) {
        branchSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ PTN01</option>';
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ PTN01');
        return;
      }
      ptnBranches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b._id;
        opt.textContent = `[${b.branch_code}] ${b.name}`;
        branchSelect.appendChild(opt);
      });
      branchSelect.disabled = true;
      loadStock();
    } catch (err) {
      alert('Error loading branches: ' + err.message);
    }
  }
  
  async function loadStock() {
    const branchId = document.getElementById('branchSelect').value;
    if (!branchId) return;
    try {
      const token = localStorage.getItem('authToken');
      const url = `/api/branch-stock?branch_id=${branchId}&include_unverified=1`;
      const res = await fetch(url, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const json = await res.json();
      if (!res.ok || !json.success) {
        throw new Error(json.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å');
      }
      renderStocksGroupedBySupplier(json.data);
    } catch (err) {
      alert('Error loading stock: ' + err.message);
    }
  }

  function renderStocksGroupedBySupplier(stocks) {
    const container = document.getElementById('stockContainer');
    container.innerHTML = `<div class="accordion" id="supplierAccordion"></div>`;
    const accordion = document.getElementById('supplierAccordion');
  
    const supplierMap = {};
    stocks.forEach(st => {
      const p = st.product_id || {};
      const supName = (p.supplier && p.supplier._id)
        ? `[${p.supplier.code || '??'}] ${p.supplier.name}`
        : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå';
      if (!supplierMap[supName]) {
        supplierMap[supName] = [];
      }
      supplierMap[supName].push(st);
    });

    let supIdx = 0;
    Object.keys(supplierMap).forEach(supName => {
      supIdx++;
      const supAccId = `supplier_${supIdx}`;
      const stItems = supplierMap[supName];
  
      const accItem = document.createElement('div');
      accItem.className = 'accordion-item mb-2';
      accItem.innerHTML = `
        <h2 class="accordion-header supplier-header" id="heading_${supAccId}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapse_${supAccId}" aria-expanded="false" aria-controls="collapse_${supAccId}">
            ${supName} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${stItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
          </button>
        </h2>
        <div id="collapse_${supAccId}" class="accordion-collapse collapse"
             aria-labelledby="heading_${supAccId}" data-bs-parent="#supplierAccordion">
          <div class="accordion-body p-2" id="body_${supAccId}"></div>
        </div>
      `;
      accordion.appendChild(accItem);
  
      const bodyDiv = document.getElementById(`body_${supAccId}`);
  
      const groupMap = {};
      stItems.forEach(st => {
        const p = st.product_id || {};
        const gKey = `[${p.brand || '-'}] ${p.name || 'NoName'} (mdl:${p.model || '-'})`;
        if (!groupMap[gKey]) groupMap[gKey] = [];
        groupMap[gKey].push(st);
      });
  
      // ‡∏õ‡∏∏‡πà‡∏° "Select All" ‡πÅ‡∏•‡∏∞ "Delete Selected" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô group ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      // (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å group ‡∏Å‡πá‡πÑ‡∏õ‡∏ó‡∏≥‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏ó‡∏ô)
      const groupActionDiv = document.createElement('div');
      groupActionDiv.className = 'd-flex gap-2 align-items-center';
      groupActionDiv.innerHTML = `
        <input type="checkbox" class="form-check-input" id="selectAll_${supAccId}" />
        <label for="selectAll_${supAccId}">Select All</label>
        <button class="btn btn-sm btn-danger" id="btnDeleteSelected_${supAccId}">
          ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        </button>
      `;
      bodyDiv.appendChild(groupActionDiv);

      // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô toggle "Select All" + ‡∏•‡∏ö‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      const selectAllCb = groupActionDiv.querySelector(`#selectAll_${supAccId}`);
      const deleteSelectedBtn = groupActionDiv.querySelector(`#btnDeleteSelected_${supAccId}`);

      // ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á groupKey ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô supplier ‡∏ô‡∏µ‡πâ
      const mainTable = document.createElement('table');
      mainTable.className = 'table table-bordered table-sm mt-2';
      mainTable.innerHTML = `
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" class="form-check-input" id="selectAllInTable_${supAccId}" /></th>
            <th>‡∏†‡∏≤‡∏û</th>
            <th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th>
            <th>‡∏£‡∏∏‡πà‡∏ô</th>
            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</th>
            <th>‡∏™‡∏µ</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
            <th>IMEI</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      bodyDiv.appendChild(mainTable);

      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° heading => toggle ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
      // (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å heading groupKey ‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡πá‡πÑ‡∏î‡πâ)
      // ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)
  
      const tableTbody = mainTable.querySelector('tbody');

      // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å groupKey ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      Object.keys(groupMap).forEach(gKey => {
        groupMap[gKey].forEach(st => {
          const p = st.product_id || {};
          const imageUrl = p.image
            ? `/uploads/${p.image}`
            : 'https://via.placeholder.com/100?text=No+Image';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <input type="checkbox" class="form-check-input row-check" data-stock-id="${st._id}" />
            </td>
            <td><img src="${imageUrl}" alt="${p.name || ''}" style="width:60px;"></td>
            <td>${p.brand || '-'}</td>
            <td>${p.model || '-'}</td>
            <td>${p.capacity || '-'}</td>
            <td>${p.color || '-'}</td>
            <td>${p.price || 0}</td>
            <td class="editable-imei" data-stock-id="${st._id}">
              ${st.imei || '-'}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="removeStock('${st._id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tableTbody.appendChild(row);
        });
      });

      // Event: selectAll (checkbox)
      selectAllCb.addEventListener('change', (e) => {
        const checked = e.target.checked;
        // ‡∏ï‡∏¥‡πä‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡πä‡∏Å ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const rowCbs = mainTable.querySelectorAll('.row-check');
        rowCbs.forEach(cb => {
          cb.checked = checked;
        });
      });

      // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ selectAllInTable ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ
      const selectAllInTable = mainTable.querySelector(`#selectAllInTable_${supAccId}`);
      selectAllInTable.addEventListener('change', (e) => {
        const checked = e.target.checked;
        const rowCbs = mainTable.querySelectorAll('.row-check');
        rowCbs.forEach(cb => {
          cb.checked = checked;
        });
        // sync ‡∏Å‡∏±‡∏ö checkbox ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        selectAllCb.checked = checked;
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      deleteSelectedBtn.addEventListener('click', async () => {
        // ‡∏´‡∏≤ checkbox ‡∏ó‡∏µ‡πà checked
        const rowCbs = mainTable.querySelectorAll('.row-check:checked');
        if (rowCbs.length === 0) {
          alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏î ‡πÜ');
          return;
        }
        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${rowCbs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

        // ‡∏•‡∏π‡∏õ‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß
        for (let cb of rowCbs) {
          const stockId = cb.getAttribute('data-stock-id');
          try {
            await removeStock(stockId, false); // false = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert
          } catch (err) {
            console.error('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err);
          }
        }
        // ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß reload stock
        loadStock();
      });
    });
  }
  
  // Inline Editing IMEI
  document.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('editable-imei')) {
      const cell = e.target;
      if (cell.querySelector('input')) return;
      const stockId = cell.getAttribute('data-stock-id');
      const currentIMEI = (cell.textContent.trim() === '-' ? '' : cell.textContent.trim());
      enableIMEIEditing(cell, stockId, currentIMEI);
    }
  });
  
  async function enableIMEIEditing(cell, stockId, currentIMEI) {
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm';
    input.value = currentIMEI;
    input.style.width = '100px';
  
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-success ms-1';
    btn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
  
    cell.innerHTML = '';
    cell.appendChild(input);
    cell.appendChild(btn);
  
    btn.addEventListener('click', async () => {
      const newIMEI = input.value.trim();
      if (newIMEI === currentIMEI) {
        cell.textContent = currentIMEI || '-';
        return;
      }
      const token = localStorage.getItem('authToken');
      try {
        const res = await fetch(`/api/branch-stock/${stockId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ imei: newIMEI })
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (json.error || 'Error'));
          cell.textContent = currentIMEI || '-';
        } else {
          alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç IMEI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          cell.textContent = newIMEI || '-';
        }
      } catch (err) {
        alert('Error updating IMEI: ' + err.message);
        cell.textContent = currentIMEI || '-';
      }
    });
  }
  
  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‚Äù
  function onScanBarcodeClick() {
    const branchId = document.getElementById('branchSelect').value;
    if (!branchId) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    document.getElementById('barcodeInput').focus();
  }
  
  // processBarcode: ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
  async function processBarcode(code) {
    console.log('üî∏ processBarcode =>', code);
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô modal
    document.getElementById('scannedCodeModal').value = code;
  
    const branchId = document.getElementById('branchSelect').value;
    if (!branchId) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
      document.getElementById('barcodeInput').focus();
      return;
    }
    const token = localStorage.getItem('authToken');
    try {
      const res = await fetch(`/api/product/find-by-barcode?code=${encodeURIComponent(code)}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const findData = await res.json();
      let product = null;
      if (!res.ok || !findData.success || !findData.data || !findData.data._id) {
        if (confirm(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î "${code}"\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
          product = null; // manual entry
        } else {
          document.getElementById('barcodeInput').focus();
          return;
        }
      } else {
        product = findData.data;
        if (!product.supplier || !product.supplier._id) {
          alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ SKU:${product.sku} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô`);
          document.getElementById('barcodeInput').focus();
          return;
        }
      }
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ modal
      addScannedProductRow(code, product);
  
      // ‡∏´‡∏≤‡∏Å modal ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
      const modalEl = document.getElementById('barcodeModal');
      if (!modalEl.classList.contains('show')) {
        const barcodeModal = new bootstrap.Modal(modalEl);
        barcodeModal.show();
      }
    } catch (err) {
      alert('Error scanning barcode: ' + err.message);
    }
  
    document.getElementById('barcodeInput').focus();
  }
  
  function addScannedProductRow(code, product) {
    const id = Date.now();
    scannedProducts.push({ id, code, product });
    updateScannedProductsTable();
  }
  
  function updateScannedProductsTable() {
    const tbody = document.getElementById('scannedProductsTable');
    tbody.innerHTML = '';
    scannedProducts.forEach(item => {
      const tr = document.createElement('tr');
      const details = item.product
         ? `SKU: ${item.product.sku}, ‡∏ä‡∏∑‡πà‡∏≠: ${item.product.name}`
         : `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Manual entry)`;
      tr.innerHTML = `
        <td>${item.code}</td>
        <td>${details}</td>
        <td>
           <button class="btn btn-sm btn-outline-danger" onclick="deleteScannedProduct(${item.id})">
             <i class="bi bi-trash"></i>
           </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function deleteScannedProduct(id) {
    scannedProducts = scannedProducts.filter(item => item.id !== id);
    updateScannedProductsTable();
  }
  
  async function confirmScannedProducts() {
    if (scannedProducts.length === 0) {
      alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤');
      document.getElementById('barcodeInput').focus();
      return;
    }
    const token = localStorage.getItem('authToken');
    const branchId = document.getElementById('branchSelect').value;
    if (!branchId) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
      document.getElementById('barcodeInput').focus();
      return;
    }
    // Loop ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    for (const item of scannedProducts) {
      if (!item.product) {
        alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î ${item.code} ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Manual entry not implemented)`);
        continue;
      }
      try {
        const res = await fetch('/api/branch-stock', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            product_id: item.product._id,
            branch_id: branchId,
            quantity: 1,
            imei: ''
          })
        });
        const stockData = await res.json();
        if (!res.ok || !stockData.success) {
          alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${item.product.sku} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${stockData.error || 'Error'}`);
        } else {
          console.log(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${item.product.sku} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
      } catch (err) {
        alert(`Error adding product ${item.code}: ${err.message}`);
      }
    }
    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    scannedProducts = [];
    updateScannedProductsTable();
    const barcodeModalEl = document.getElementById('barcodeModal');
    const barcodeModal = bootstrap.Modal.getInstance(barcodeModalEl);
    barcodeModal.hide();

    document.getElementById('barcodeInput').focus();
  
    loadStock();
  }
  
  function cancelScannedProducts() {
    if (confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
      scannedProducts = [];
      updateScannedProductsTable();
      const barcodeModalEl = document.getElementById('barcodeModal');
      const barcodeModal = bootstrap.Modal.getInstance(barcodeModalEl);
      barcodeModal.hide();
    }
    document.getElementById('barcodeInput').focus();
  }
  
  /**
   * ‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å
   * @param {string} stockId - _id ‡∏Ç‡∏≠‡∏á branch-stock
   * @param {boolean} showAlert - ‡∏ñ‡πâ‡∏≤ true ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á alert ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (default=true)
   */
  async function removeStock(stockId, showAlert = true) {
    try {
      const token = localStorage.getItem('authToken');
      const res = await fetch(`/api/branch-stock/${stockId}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        throw new Error(data.error || '‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
      if (showAlert) alert('‡∏•‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ reloadStock ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
    } catch (err) {
      if (showAlert) alert('Error removing stock: ' + err.message);
      else throw err; // ‡πÇ‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    }
  }
</script>
</body>
</html>
