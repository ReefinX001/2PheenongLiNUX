<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Removed CSP to allow Firebase to work properly -->
    <!-- If you need CSP, configure it on server-side instead -->
    
    <title>POS - โอนย้ายสินค้า</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />

    <script src="/js/activity-tracker.js"></script>
    <script src="/js/branch-navigation.js"></script>
    <script src="/views/pattani/sidebar/sidebar.js"></script>
    <!-- Tailwind CSS & DaisyUI -->
    <!-- TODO: Replace CDN with compiled CSS for production -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Suppress production warning for development
      if (window.tailwind && window.tailwind.config) {
        console.warn = function(message) {
          if (message.includes('should not be used in production')) return;
          console.log(message);
        };
      }
      
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
            animation: {
              fadeIn: 'fadeIn 0.3s ease-in-out',
              fadeOut: 'fadeOut 0.3s ease-in-out'
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: 0 },
                '100%': { opacity: 1 }
              },
              fadeOut: {
                '0%': { opacity: 1 },
                '100%': { opacity: 0 }
              }
            }
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

    <!-- Flatpickr (Date Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

   <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />


    <!-- External CSS file for better organization and performance -->
    <link rel="stylesheet" href="/views/pattani/css/productTransfer.css">
  
  <!-- LoadingSystem styles moved to external CSS file -->

  <!-- Optimized LoadingSystem loaded from external file -->
      <script src="/views/pattani/js/loadingSystem.js" onload="console.log('✅ LoadingSystem script loaded successfully')"></script>

    <style>
      .loading-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(255, 255, 255, 0.9);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999;
        backdrop-filter: blur(12px);
      }
    </style>
</head>
  <body class="flex flex-col min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
      <div class="text-center">
        <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
      </div>
    </div>

        </div>
    
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <!-- Header -->
    <header
      id="mainHeader"
      class="p-4 bg-white dark:bg-gray-800
             border-b border-gray-200 dark:border-gray-700
             flex items-center justify-between
             ml-56 transition-all duration-300"
    >
      <div>
        <h1 class="text-lg font-semibold" id="pageTitle">โอนย้ายสินค้า</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300" id="branchInfo2">
          กำลังโหลดสาขา...
        </p>
      </div>
    </header>
    
    <div class="flex min-h-screen">
      <!-- Main Content -->
      <main id="mainContent" class="flex-1 p-6 space-y-6 transition-all duration-300 ease-in-out ml-56">
        <!-- Page Header -->
        <div class="mb-6">
          <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 flex items-center">
            <i class="bi bi-arrow-left-right text-primary-500 mr-2"></i>
            ย้ายสินค้าระหว่างสาขา
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            จัดการการย้ายสินค้าระหว่างสาขาและติดตามประวัติการย้าย<br />
            <span class="text-sm text-gray-500 dark:text-gray-400">
              ※ กรุณาเลือกสาขาต้นทางก่อน เพื่อโหลดรายการสินค้าคงคลัง
            </span>
          </p>
        </div>
        <!-- add branch info panel with connection status -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="bi bi-shop text-blue-600 dark:text-blue-400 text-xl mr-3"></i>
              <div>
                <p class="text-sm text-gray-600 dark:text-gray-400">สาขาปัจจุบัน</p>
                <p class="font-medium text-gray-800 dark:text-gray-200" id="branchInfo">กำลังโหลด...</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <!-- Server Status Badge -->
              <div id="serverStatusBadge" class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                <span id="serverStatusText">ตรวจสอบเซิร์ฟเวอร์...</span>
              </div>
              <!-- Connection Status Badge -->
              <div id="connectionStatusBadge" class="hidden px-2 py-1 rounded-full text-xs font-medium">
                <span id="connectionStatusText">ไม่ทราบสถานะ</span>
              </div>
              <!-- Retry Button (shown only when connection fails) -->
              <button id="retryConnectionBtn" class="hidden px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium transition-colors" onclick="window.retrySocketConnection && window.retrySocketConnection()">
                <i class="bi bi-arrow-clockwise mr-1"></i>
                ลองใหม่
              </button>
            </div>
          </div>
        </div>

        <!-- Tabs: ทำรายการ vs ประวัติ -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
          <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="transferTabs">
            <li class="mr-2">
              <a
                href="#"
                class="inline-block p-4 text-primary-600 tab-active"
                id="transferFormTab"
                >ทำรายการย้ายสินค้า</a
              >
            </li>
            <li class="mr-2">
              <a
                href="#"
                class="inline-block p-4 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
                id="transferHistoryTab"
                >ประวัติการย้ายสินค้า</a
              >
            </li>
          </ul>
        </div>

        <!-- Transfer Form -->
        <div id="transferFormContent">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- ฟอร์มย้ายสินค้า -->
            <section
              class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm lg:col-span-4 space-y-6"
            >
              <div class="flex items-center mb-4">
                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center mr-3">
                  <i class="bi bi-clipboard-data text-primary-500 text-lg"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                  รายละเอียดการย้าย
                </h2>
              </div>
              <div class="w-full h-1 bg-gradient-to-r from-primary-400 to-primary-600 rounded-full"></div>

              <form id="transferForm" class="space-y-5">
                <!-- วันที่ย้ายสินค้า -->
                <div>
                  <label
                    for="transferDate"
                    class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                    >วันที่ย้ายสินค้า</label
                  >
                  <div class="relative">
                    <input
                      id="transferDate"
                      name="transferDate"
                      type="text"
                      readonly
                      placeholder="เลือกวันที่"
                      class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 cursor-pointer focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all"
                      disabled
                    />
                    <span class="absolute inset-y-0 right-3 flex items-center text-primary-500">
                      <i class="bi bi-calendar-date"></i>
                    </span>
                  </div>
                </div>

                <!-- สาขาต้นทาง & สาขาปลายทาง -->
                <div class="grid grid-cols-1 gap-5">
                  <div>
                    <label for="branchFromDisplay" class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300">
                      สาขาต้นทาง
                    </label>
                    <div
                      id="branchFromDisplay"
                      class="w-full bg-gray-50 dark:bg-gray-700
                             border border-gray-300 dark:border-gray-600
                             rounded-lg px-4 py-2.5 text-gray-700 dark:text-gray-300"
                    >
                      กำลังโหลด...
                    </div>
                  </div>
                  <div>
                    <label for="branchTo" class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300">
                      สาขาปลายทาง
                    </label>
                    <div class="relative">
                      <select
                        id="branchTo"
                        name="branchTo"
                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 appearance-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all"
                      >
                        <option value="">-- เลือกสาขาปลายทาง --</option>
                      </select>
                      <span
                        class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500 dark:text-gray-400"
                      >
                        <i class="bi bi-chevron-down"></i>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- ผู้ส่ง & ผู้รับ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                  <div>
                    <label
                      for="sender"
                      class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                      >ผู้ส่ง</label
                    >
                    <input
                      id="sender"
                      name="sender"
                      type="text"
                      readonly
                      class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5"
                    />
                  </div>
                  <div>
                    <label
                      for="receiver"
                      class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                      >ผู้รับ</label
                    >
                    <div class="relative">
                      <select
                        id="receiver"
                        name="receiver"
                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 appearance-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all"
                      >
                        <option value="">-- เลือกผู้รับ --</option>
                      </select>
                      <span
                        class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500 dark:text-gray-400"
                      >
                        <i class="bi bi-chevron-down"></i>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- หมายเหตุ -->
                <div>
                  <label
                    for="note"
                    class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                    >หมายเหตุ (ถ้ามี)</label
                  >
                  <textarea
                    id="note"
                    name="note"
                    rows="3"
                    placeholder="กรอกหมายเหตุเพิ่มเติม"
                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all"
                  ></textarea>
                </div>

                <!-- ปุ่มบันทึก & ยกเลิก -->
                <div class="flex flex-col space-y-3 pt-2">
                  <button
                    id="btnSubmit"
                    type="submit"
                    disabled
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-3 font-medium shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center"
                  >
                    <i class="bi bi-send mr-2"></i>
                    สร้างใบโอนสินค้า (DO-YYMMDD-XXX)
                  </button>
                  <button
                    type="reset"
                    class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg px-4 py-3 transition-all flex items-center justify-center text-gray-700 dark:text-gray-200"
                  >
                    <i class="bi bi-x-circle mr-2"></i>
                    ยกเลิก
                  </button>
                </div>

                <!-- สรุปรายการ -->
                <div
                  id="transferSummary"
                  class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg hidden"
                >
                  <h3 class="font-medium text-gray-800 dark:text-gray-200 mb-2">
                    สรุปรายการโอนย้าย
                  </h3>
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-gray-600 dark:text-gray-400">จำนวนรายการ:</div>
                    <div
                      class="text-gray-800 dark:text-gray-200 font-medium"
                      id="summaryItemCount"
                      >0 รายการ</div
                    >
                  </div>
                </div>
              </form>
            </section>

            <!-- เลือกสินค้า -->
            <section
              class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm lg:col-span-8 space-y-6"
            >
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  <div
                    class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center mr-3"
                  >
                    <i class="bi bi-box-seam text-green-500 text-lg"></i>
                  </div>
                  <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">เลือกสินค้า</h2>
                </div>
                <div
                  class="text-sm bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-300 py-1 px-3 rounded-full flex items-center"
                >
                  <i class="bi bi-info-circle mr-1"></i>
                  <span>ค้นหาสินค้าได้จากชื่อหรือ IMEI</span>
                </div>
              </div>
              <div class="w-full h-1 bg-gradient-to-r from-green-400 to-green-600 rounded-full"></div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label
                    for="searchInput"
                    class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                    >ค้นหาสินค้า / เลข IMEI</label
                  >
                  <div class="relative">
                    <input
                      id="searchInput"
                      type="text"
                      class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 pr-10 focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all disabled:opacity-50"
                      placeholder="พิมพ์ชื่อสินค้า หรือ IMEI…"
                      disabled
                    />
                    <span
                      class="absolute inset-y-0 right-3 flex items-center text-gray-400 dark:text-gray-300"
                    >
                      <i class="bi bi-search"></i>
                    </span>
                  </div>
                </div>
                <div>
                  <label
                    for="categoryFilter"
                    class="block mb-1.5 font-medium text-gray-700 dark:text-gray-300"
                    >หมวดหมู่</label
                  >
                  <div class="relative">
                    <select
                      id="categoryFilter"
                      class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 appearance-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all"
                      disabled
                    >
                      <option value="">-- เลือกหมวดหมู่ --</option>
                    </select>
                    <span
                      class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500 dark:text-gray-400"
                    >
                      <i class="bi bi-chevron-down"></i>
                    </span>
                  </div>
                </div>
              </div>

              <!-- สินค้าต้นทาง -->
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-5 space-y-3">
                <div class="flex items-center justify-between">
                  <h3 class="font-medium text-primary-600 dark:text-primary-400 flex items-center">
                    <i class="bi bi-box-arrow-up text-lg mr-2"></i>
                    สินค้าต้นทาง
                  </h3>
                  <div
                    id="sourceItemCount"
                    class="text-xs bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300 py-1 px-2 rounded"
                    >0 รายการ</div
                  >
                </div>
                <div class="overflow-auto max-h-[250px] border border-gray-200 dark:border-gray-700 rounded-lg">
                  <table class="w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
                      <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          รหัสสินค้า
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          ชื่อสินค้า
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          ยี่ห้อ
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          IMEI
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          หมวดหมู่
                        </th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700 dark:text-gray-300">
                          คงเหลือ
                        </th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">
                          ดำเนินการ
                        </th>
                      </tr>
                    </thead>
                    <tbody id="transferListIn" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                      <tr>
                        <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                          กรุณาเลือกสาขาต้นทางเพื่อโหลดสินค้า
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- สินค้าปลายทาง -->
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                  <h3 class="font-medium text-green-600 dark:text-green-400 flex items-center">
                    <i class="bi bi-box-arrow-in-down text-lg mr-2"></i>
                    สินค้าปลายทาง
                  </h3>
                  <div
                    id="destItemCount"
                    class="text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 py-1 px-2 rounded"
                    >0 รายการ</div
                  >
                </div>
                <div class="overflow-auto max-h-[250px] border border-gray-200 dark:border-gray-700 rounded-lg">
                  <table class="w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
                      <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          รหัสสินค้า
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          ชื่อสินค้า
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          ยี่ห้อ
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          IMEI
                        </th>
                        <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">
                          หมวดหมู่
                        </th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700 dark:text-gray-300">
                          คงเหลือ
                        </th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">
                          ดำเนินการ
                        </th>
                      </tr>
                    </thead>
                    <tbody id="transferListOut" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                      <tr>
                        <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                          ยังไม่มีสินค้าที่เลือกส่งออก
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Quick Guide -->
              <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                <h4 class="font-medium text-blue-800 dark:text-blue-300 flex items-center mb-2">
                  <i class="bi bi-lightbulb text-lg mr-2"></i>
                  คำแนะนำการใช้งาน
                </h4>
                              <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 dark:text-gray-400">
                <li>ขั้นตอน 1: เลือกสาขาต้นทางก่อน เพื่อโหลดสินค้าคงคลัง</li>
                <li>ขั้นตอน 2: สาขาปลายทางจะถูกปลดล็อกอัตโนมัติเมื่อเลือกสาขาต้นทาง</li>
                <li>ขั้นตอน 3: ค้นหาสินค้าจากชื่อหรือ IMEI เพื่อกรองรายการ</li>
                <li>ขั้นตอน 4: คลิก "ย้าย" เพื่อเพิ่มสินค้าไปยังตะกร้าส่งออก</li>
                <li>ขั้นตอน 5: คลิก "ลบ" เพื่อนำสินค้ากลับสู่รายการต้นทาง</li>
                <li>ขั้นตอน 6: เลือกสาขาปลายทาง - รายชื่อผู้รับจะแสดงเฉพาะผู้ที่มีสิทธิ์เข้าถึงสาขานั้น</li>
                <li>ขั้นตอน 7: เลือกผู้รับที่มีสิทธิ์เข้าถึงสาขาปลายทาง</li>
                <li>ขั้นตอน 8: เมื่อเลือกข้อมูลครบแล้ว กรอกหมายเหตุ (ถ้ามี) แล้วคลิก "บันทึก"</li>
              </ul>
              </div>
            </section>
          </div>
        </div>

        <!-- Transfer History -->
        <div id="transferHistoryContent" class="hidden">
          <!-- Sample Data Warning Banner -->
          <div id="sampleDataBanner" class="hidden bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <i class="bi bi-exclamation-triangle-fill text-yellow-600 dark:text-yellow-400 text-xl mr-3"></i>
              <div class="flex-1">
                <h4 class="font-semibold text-yellow-800 dark:text-yellow-300">ข้อมูลตัวอย่าง</h4>
                <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                  🚨 ข้อมูลที่แสดงเป็นข้อมูลตัวอย่าง เนื่องจาก API ไม่พร้อมใช้งาน 
                  <br>
                  💡 กรุณาติดต่อผู้ดูแลระบบเพื่อตรวจสอบการเชื่อมต่อ API
                </p>
              </div>
              <button onclick="tryReloadHistory()" 
                      class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm transition-all">
                <i class="bi bi-arrow-clockwise mr-1"></i>
                ลองใหม่
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 space-y-6">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center">
                <div
                  class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center mr-3"
                >
                  <i class="bi bi-clock-history text-indigo-500 text-xl"></i>
                </div>
                <div>
                  <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                    ประวัติการย้ายสินค้า
                  </h2>
                </div>
              </div>

              <!-- Filters -->
              <div class="flex space-x-2">
                <div class="relative">
                  <input
                    id="historySearch"
                    type="text"
                    placeholder="ค้นหา..."
                    class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 w-48 focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-500 transition-all"
                  />
                </div>
                <div class="relative">
                  <select
                    id="historyFilter"
                    class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 appearance-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-500 transition-all"
                  >
                    <option value="">ทั้งหมด</option>
                    <option value="approved">สำเร็จ</option>
                    <option value="pending">รอดำเนินการ</option>
                    <option value="rejected">ถูกปฏิเสธ</option>
                  </select>
                  <span
                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-500 dark:text-gray-400"
                  >
                    <i class="bi bi-chevron-down"></i>
                  </span>
                </div>
              </div>
            </div>

            <!-- History Table -->
            <div class="overflow-auto">
              <table class="w-full text-sm divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th
                      class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300"
                    >
                      เลขที่
                    </th>
                    <th
                      class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300"
                    >
                      วันที่
                    </th>
                    <th
                      class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300"
                    >
                      จาก
                    </th>
                    <th
                      class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300"
                    >
                      ไปยัง
                    </th>
                    <th
                      class="px-4 py-3 text-center font-medium text-gray-700 dark:text-gray-300"
                    >
                      จำนวนรายการ
                    </th>
                    <th
                      class="px-4 py-3 text-center font-medium text-gray-700 dark:text-gray-300"
                    >
                      สถานะ
                    </th>
                    <th
                      class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300"
                    >
                      ดำเนินการ
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="historyTableBody"
                  class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
                >
                  <!-- JavaScript will fill this -->
                  <tr>
                    <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                      ยังไม่มีข้อมูลประวัติการย้ายสินค้า
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              id="historyPagination"
              class="flex justify-between items-center mt-6 text-sm"
            >
              <div class="text-gray-600 dark:text-gray-400">
                <span id="historyPaginationInfo">แสดง 0-0 จาก 0 รายการ</span>
              </div>
              <div class="flex space-x-2">
                <button
                  id="prevPageBtn"
                  class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  <i class="bi bi-chevron-left"></i>
                </button>
                <div id="pageNumbers" class="flex space-x-1">
                  <!-- Page numbers generated dynamically -->
                </div>
                <button
                  id="nextPageBtn"
                  class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Transfer Detail Modal -->
    <input type="checkbox" id="transferDetailModal" class="modal-toggle" />
    <div class="modal">
      <div
        class="modal-box max-w-3xl bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700"
      >
        <h3 class="font-bold text-lg flex items-center">
          <i class="bi bi-info-circle mr-2 text-primary-500"></i>
          รายละเอียดการย้ายสินค้า
          <span
            id="modalTransferNo"
            class="ml-2 text-sm bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 py-1 px-2 rounded-lg"
            ></span
          >
        </h3>

        <div class="py-4 space-y-4">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <div class="text-gray-500 dark:text-gray-400">วันที่</div>
              <div id="modalDate" class="font-medium"></div>
            </div>
            <div>
              <div class="text-gray-500 dark:text-gray-400">สถานะ</div>
              <div id="modalStatus" class="font-medium"></div>
            </div>
            <div>
              <div class="text-gray-500 dark:text-gray-400">จากสาขา</div>
              <div id="modalFromBranch" class="font-medium"></div>
            </div>
            <div>
              <div class="text-gray-500 dark:text-gray-400">ไปยังสาขา</div>
              <div id="modalToBranch" class="font-medium"></div>
            </div>
            <div>
              <div class="text-gray-500 dark:text-gray-400">ผู้ส่ง</div>
              <div id="modalSender" class="font-medium"></div>
            </div>
            <div>
              <div class="text-gray-500 dark:text-gray-400">ผู้รับ</div>
              <div id="modalReceiver" class="font-medium"></div>
            </div>
            <div class="col-span-2">
              <div class="text-gray-500 dark:text-gray-400">หมายเหตุ</div>
              <div id="modalNote" class="font-medium"></div>
            </div>
          </div>

          <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-2">
            <h4 class="font-semibold mb-2">รายการสินค้า</h4>
            <div class="overflow-x-auto max-h-60">
              <table
                class="w-full text-sm divide-y divide-gray-200 dark:divide-gray-700"
              >
                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                  <tr>

                    <th class="px-3 py-2 text-left">ชื่อสินค้า</th>
                    <th class="px-3 py-2 text-left">ยี่ห้อ</th>
                    <th class="px-3 py-2 text-left">IMEI</th>
                    <th class="px-3 py-2 text-center">จำนวน</th>
                  </tr>
                </thead>
                <tbody id="modalItems" class="divide-y divide-gray-200 dark:divide-gray-700">
                  <!-- JavaScript will fill this -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-action">
          <button id="modalPDFBtn"
                  class="btn btn-error text-white flex items-center"
                  onclick="generateTransferPDF(this.dataset.transferId)">
            <i class="bi bi-file-earmark-pdf mr-2"></i> ดาวน์โหลด PDF
          </button>
          <label for="transferDetailModal" class="btn">ปิด</label>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <input type="checkbox" id="confirmActionModal" class="modal-toggle" />
    <div class="modal">
      <div
        class="modal-box bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700"
      >
        <div class="flex items-center mb-4">
          <div
            class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center mr-3"
          >
            <i class="bi bi-question-circle text-blue-600 dark:text-blue-400 text-xl"></i>
          </div>
          <h3 class="font-bold text-lg">ยืนยันการดำเนินการ</h3>
        </div>
        <p class="py-4" id="confirmActionText">ข้อความยืนยันที่นี่</p>
        <div class="modal-action">
          <label
            for="confirmActionModal"
            class="btn btn-outline border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600"
            id="cancelActionBtn"
          >
            <i class="bi bi-x-lg mr-2"></i> ยกเลิก
          </label>
          <label
            for="confirmActionModal"
            class="btn bg-primary-600 dark:bg-primary-600 hover:bg-primary-700 dark:hover:bg-primary-700 text-white border-none"
            id="okActionBtn"
          >
            <i class="bi bi-check-lg mr-2"></i> ยืนยัน
          </label>
        </div>
      </div>
    </div>


    <!-- Socket.IO with Enhanced Error Handling -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Browser Extension Conflict Prevention -->
    <script>
      // Prevent browser extension conflicts
      window.addEventListener('error', function(e) {
        // Suppress pRTLPCB and other extension-related errors
        if (e.message && (
          e.message.includes('pRTLPCB') ||
          e.message.includes('Extension context invalidated') ||
          e.message.includes('chrome-extension://') ||
          e.message.includes('moz-extension://') ||
          e.filename && e.filename.includes('extension')
        )) {
          console.warn('🔇 Suppressed browser extension error:', e.message);
          e.preventDefault();
          e.stopPropagation();
          return true;
        }
      }, true); // Use capture phase to catch errors earlier

      // Additional global error suppression for pRTLPCB
      window.onerror = function(message, source, lineno, colno, error) {
        if (message && (
          message.includes('pRTLPCB is not defined') ||
          message.includes('pRTLPCB') ||
          (source && source.includes('.lp'))
        )) {
          console.warn('🔇 Suppressed pRTLPCB error:', message);
          return true; // Prevent default error handling
        }
        return false;
      };

      // Global error handler for unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && e.reason.message && e.reason.message.includes('pRTLPCB')) {
          console.warn('🔇 Suppressed extension promise rejection:', e.reason.message);
          e.preventDefault();
        }
      });

      // Prevent extension script injection conflicts
      (function() {
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
          const element = originalCreateElement.call(this, tagName);
      
          // Block suspicious script injections
          if (tagName.toLowerCase() === 'script') {
            const originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
              if (name === 'src' && value && (
                value.includes('pRTLPCB') ||
                value.includes('chrome-extension://') ||
                value.includes('moz-extension://')
              )) {
                console.warn('🚫 Blocked suspicious script injection:', value);
                return;
              }
              return originalSetAttribute.call(this, name, value);
            };
          }
      
          return element;
        };
      })();
    </script>
    
    <script>
      // Enhanced Socket.IO connection with robust error handling and fallback
      let socket = null;
      let transferSocket = null;
      let socketConnectionAttempts = 0;
      let maxSocketAttempts = 3;
      let socketFallbackMode = false;
      let socketReconnectTimer = null;

      // Check if Socket.IO is available
      window.socketIOAvailable = typeof io !== 'undefined';
      
      if (!window.socketIOAvailable) {
        console.warn('⚠️ Socket.IO library not loaded - enabling fallback mode');
        socketFallbackMode = true;
        updateConnectionStatus('fallback', 'Socket.IO library not available');
      }

      function initializeProductTransferSocket() {
        if (!window.socketIOAvailable) {
          console.warn('⚠️ Socket.IO library not available - enabling fallback mode');
          enableSocketFallback();
          return;
        }

        try {
          socketConnectionAttempts++;
          console.log(`🔗 Attempting Socket.IO connection (attempt ${socketConnectionAttempts}/${maxSocketAttempts})`);

          socket = io({
            timeout: 10000,
            reconnection: true,
            reconnectionAttempts: 2,
            reconnectionDelay: 3000,
            reconnectionDelayMax: 10000,
            randomizationFactor: 0.3,
            forceNew: false,
            transports: ['websocket', 'polling'], // Allow fallback to polling
            upgrade: true
          });

          // Connection successful
          socket.on('connect', () => {
            console.log('✅ Socket.IO connected successfully:', socket.id);
            socketConnectionAttempts = 0; // Reset counter on success
            socketFallbackMode = false;
            updateConnectionStatus('connected');
      
            // Join product transfer room
            socket.emit('join_room', {
              room: 'product_transfer',
              branchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
                ? window.ProductTransferApp.utils.getCurrentBranchCode()
                : window.currentBranchCode || 'PATTANI'),
              userId: localStorage.getItem('userId'),
              timestamp: new Date().toISOString()
            });

            // Clear any reconnection timers
            if (socketReconnectTimer) {
              clearTimeout(socketReconnectTimer);
              socketReconnectTimer = null;
            }

            // Sync any pending events
            setTimeout(() => {
              syncFallbackEvents();
            }, 1000);
          });

          // Connection error handling
          socket.on('connect_error', (error) => {
            console.error('❌ Socket.IO connection error:', error);
      
            // Add more specific error handling
            if (error.message && error.message.includes('websocket error')) {
              console.log('🔄 WebSocket failed, Socket.IO will try polling transport');
            }
      
            handleSocketError(error);
          });

          socket.on('disconnect', (reason) => {
            console.log('🔌 Socket.IO disconnected:', reason);
            updateConnectionStatus('disconnected', reason);

            if (reason === 'io server disconnect') {
              console.log('🔄 Server disconnect - attempting reconnection...');
              setTimeout(() => {
                if (socket && !socket.connected) {
                  socket.connect();
                }
              }, 2000);
            }
          });

          // Reconnection events
          socket.on('reconnect', (attemptNumber) => {
            console.log(`🔄 Socket.IO reconnected after ${attemptNumber} attempts`);
            socketConnectionAttempts = 0;
            updateConnectionStatus('reconnected');
          });

          socket.on('reconnect_error', (error) => {
            console.error('❌ Socket.IO reconnection error:', error);
            handleSocketError(error);
          });

          socket.on('reconnect_failed', () => {
            console.error('💥 Socket.IO reconnection failed - enabling fallback mode');
            enableSocketFallback();
          });

          // Product transfer specific events
          socket.on('transfer_status_updated', (data) => {
            console.log('📦 Transfer status updated:', data);
            if (typeof loadTransferHistory === 'function') {
              loadTransferHistory();
            }
          });

          socket.on('stock_updated', (data) => {
            console.log('📊 Stock updated:', data);
            if (typeof fetchStockList === 'function') {
              fetchStockList();
            }
          });

        } catch (error) {
          console.error('💥 Failed to initialize Socket.IO:', error);
          handleSocketError(error);
        }
      }

      function handleSocketError(error) {
        console.error('🚨 Socket Error Details:', {
          type: error.type,
          description: error.description,
          context: error.context,
          transport: error.transport,
          message: error.message
        });

        // Safely convert error details to strings
        const errorDescription = error.description ? String(error.description) : '';
        const errorMessage = error.message ? String(error.message) : '';
      
        // Update connection status
        updateConnectionStatus('error', errorDescription || errorMessage || '502 Bad Gateway');

        // Check if we should enable fallback mode
        if (socketConnectionAttempts >= maxSocketAttempts ||
            (errorDescription && errorDescription.includes('502')) ||
            (errorMessage && errorMessage.includes('502')) ||
            (errorDescription && errorDescription.includes('websocket error')) ||
            (errorMessage && errorMessage.includes('websocket error'))) {
          console.warn('⚠️ Max connection attempts reached or server error - enabling fallback mode');
          enableSocketFallback();
        } else {
          // Schedule retry with exponential backoff
          const retryDelay = Math.min(2000 * Math.pow(1.5, socketConnectionAttempts), 15000);
          console.log(`⏰ Scheduling retry in ${retryDelay}ms...`);
      
          socketReconnectTimer = setTimeout(() => {
            if (!socket || !socket.connected) {
              console.log('🔄 Retrying Socket.IO connection...');
              initializeProductTransferSocket();
            }
          }, retryDelay);
        }
      }

      function enableSocketFallback() {
        socketFallbackMode = true;
        console.log('🔄 Socket.IO fallback mode enabled - using offline functionality');
        updateConnectionStatus('fallback', 'Working offline');
      
        // Clear any pending reconnection timers
        if (socketReconnectTimer) {
          clearTimeout(socketReconnectTimer);
          socketReconnectTimer = null;
        }
      
        // Disconnect existing socket if any
        if (socket) {
          try {
            socket.disconnect();
            socket = null;
          } catch (e) {
            console.warn('⚠️ Error disconnecting socket:', e);
          }
        }
      
        // Show user notification about offline mode
        setTimeout(() => {
          if (typeof showToast === 'function') {
            showToast('⚠️ เซิร์ฟเวอร์ไม่สามารถเข้าถึงได้ - ระบบจะทำงานแบบออฟไลน์', 'warning');
          }
        }, 1000);
      
        // Set up periodic health check to try reconnecting later
        setTimeout(() => {
          if (socketFallbackMode) {
            console.log('🔍 Checking if server is back online...');
            checkServerAndReconnect();
          }
        }, 30000); // Check again in 30 seconds
      }

      async function checkServerAndReconnect() {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);
      
          const response = await fetch('/api/health', {
            method: 'GET',
            signal: controller.signal,
            headers: { 'Cache-Control': 'no-cache' }
          });
      
          clearTimeout(timeoutId);
      
          if (response.ok) {
            console.log('✅ Server is back online - attempting to reconnect Socket.IO');
            socketFallbackMode = false;
            socketConnectionAttempts = 0;
            initializeProductTransferSocket();
          } else {
            console.log('⚠️ Server still not fully available - staying in fallback mode');
            // Schedule another check
            setTimeout(() => {
              if (socketFallbackMode) {
                checkServerAndReconnect();
              }
            }, 60000); // Check again in 1 minute
          }
        } catch (error) {
          console.log('⚠️ Server health check failed - staying in fallback mode');
          // Schedule another check
          setTimeout(() => {
            if (socketFallbackMode) {
              checkServerAndReconnect();
            }
          }, 60000); // Check again in 1 minute
        }
      }

      function updateConnectionStatus(status, message = '') {
        // Update floating indicator
        let statusIndicator = document.getElementById('connectionStatus');
      
        if (!statusIndicator) {
          // Create status indicator if it doesn't exist
          statusIndicator = document.createElement('div');
          statusIndicator.id = 'connectionStatus';
          statusIndicator.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 cursor-pointer';
          statusIndicator.style.transform = 'translateY(-100px)';
          statusIndicator.style.opacity = '0';
          document.body.appendChild(statusIndicator);
        }

        // Update badge in branch info panel
        const connectionBadge = document.getElementById('connectionStatusBadge');
        const connectionText = document.getElementById('connectionStatusText');
        const retryBtn = document.getElementById('retryConnectionBtn');

        const statusMessages = {
          connected: {
            text: '🟢 เชื่อมต่อแล้ว',
            badgeText: 'เชื่อมต่อ real-time',
            class: 'bg-green-100 text-green-800 border border-green-200',
            badgeClass: 'bg-green-100 text-green-700'
          },
          disconnected: {
            text: '🟡 ขาดการเชื่อมต่อ',
            badgeText: 'ขาดการเชื่อมต่อ',
            class: 'bg-yellow-100 text-yellow-800 border border-yellow-200',
            badgeClass: 'bg-yellow-100 text-yellow-700'
          },
          reconnected: {
            text: '🔄 เชื่อมต่อใหม่แล้ว',
            badgeText: 'เชื่อมต่อใหม่แล้ว',
            class: 'bg-blue-100 text-blue-800 border border-blue-200',
            badgeClass: 'bg-blue-100 text-blue-700'
          },
          error: {
            text: '🔴 ข้อผิดพลาด',
            badgeText: 'ข้อผิดพลาดการเชื่อมต่อ',
            class: 'bg-red-100 text-red-800 border border-red-200',
            badgeClass: 'bg-red-100 text-red-700'
          },
          fallback: {
            text: '⚠️ โหมดออฟไลน์',
            badgeText: 'โหมดออฟไลน์',
            class: 'bg-gray-100 text-gray-800 border border-gray-200',
            badgeClass: 'bg-gray-100 text-gray-700'
          },
          connecting: {
            text: '🔄 กำลังเชื่อมต่อ...',
            badgeText: 'กำลังเชื่อมต่อ...',
            class: 'bg-blue-100 text-blue-800 border border-blue-200',
            badgeClass: 'bg-blue-100 text-blue-700'
          }
        };

        const statusInfo = statusMessages[status] || statusMessages.error;
        let displayText = statusInfo.text;
      
        if (message) {
          // ตรวจสอบว่า message เป็น string ก่อน
          const messageStr = typeof message === 'string' ? message : String(message);
          if (messageStr.includes('502')) {
            displayText += ' (เซิร์ฟเวอร์ไม่พร้อมใช้งาน)';
          } else {
            displayText += ` (${messageStr})`;
          }
        }

        // Update floating indicator
        statusIndicator.textContent = displayText;
        statusIndicator.className = `fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 cursor-pointer ${statusInfo.class}`;

        // Update badge in branch panel
        if (connectionBadge && connectionText) {
          connectionBadge.className = `px-2 py-1 rounded-full text-xs font-medium ${statusInfo.badgeClass}`;
          connectionText.textContent = statusInfo.badgeText;
          connectionBadge.classList.remove('hidden');
        }

        // Show/hide retry button
        if (retryBtn) {
          if (status === 'error' || status === 'fallback') {
            retryBtn.classList.remove('hidden');
          } else {
            retryBtn.classList.add('hidden');
          }
        }

        // Show the floating indicator
        setTimeout(() => {
          statusIndicator.style.transform = 'translateY(0)';
          statusIndicator.style.opacity = '1';
        }, 100);

        // Add click handler for manual retry (for error states)
        if (status === 'error' || status === 'fallback') {
          statusIndicator.title = 'คลิกเพื่อลองเชื่อมต่อใหม่';
          statusIndicator.onclick = () => {
            retrySocketConnection();
          };
        } else {
          statusIndicator.title = '';
          statusIndicator.onclick = null;
        }

        // Auto-hide success status after 3 seconds
        if (status === 'connected' || status === 'reconnected') {
          setTimeout(() => {
            statusIndicator.style.opacity = '0';
            statusIndicator.style.transform = 'translateY(-100px)';
            setTimeout(() => {
              if (statusIndicator.parentNode) {
                statusIndicator.parentNode.removeChild(statusIndicator);
              }
            }, 300);
          }, 3000);
        }
      }

      // Fallback functions for when Socket.IO is not available
      function emitTransferEvent(eventName, data) {
        if (socket && socket.connected && !socketFallbackMode) {
          try {
            socket.emit(eventName, data);
            console.log(`📤 Emitted ${eventName}:`, data);
            return true;
          } catch (error) {
            console.error(`❌ Failed to emit ${eventName}:`, error);
          }
        } else {
          console.log(`📴 Fallback mode - ${eventName} event logged locally:`, data);
          // Store in localStorage for potential later sync
          const fallbackEvents = JSON.parse(localStorage.getItem('fallback_transfer_events') || '[]');
          fallbackEvents.push({
            event: eventName,
            data: data,
            timestamp: new Date().toISOString(),
            synced: false
          });
      
          // Keep only last 50 events
          if (fallbackEvents.length > 50) {
            fallbackEvents.splice(0, fallbackEvents.length - 50);
          }
      
          localStorage.setItem('fallback_transfer_events', JSON.stringify(fallbackEvents));
        }
        return false;
      }

      // Function to retry connection manually
      function retrySocketConnection() {
        console.log('🔄 Manual Socket.IO reconnection initiated...');
      
        if (socketReconnectTimer) {
          clearTimeout(socketReconnectTimer);
          socketReconnectTimer = null;
        }
      
        socketConnectionAttempts = 0; // Reset attempts
        socketFallbackMode = false;
      
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      
        updateConnectionStatus('connecting', 'กำลังเชื่อมต่อ...');
        initializeProductTransferSocket();
      }

      // Sync fallback events when connection is restored
      function syncFallbackEvents() {
        if (!socket || !socket.connected || socketFallbackMode) return;

        const fallbackEvents = JSON.parse(localStorage.getItem('fallback_transfer_events') || '[]');
        const unsyncedEvents = fallbackEvents.filter(event => !event.synced);

        if (unsyncedEvents.length > 0) {
          console.log(`📤 Syncing ${unsyncedEvents.length} fallback events...`);
      
          unsyncedEvents.forEach((eventData, index) => {
            setTimeout(() => {
              emitTransferEvent(eventData.event, {
                ...eventData.data,
                _fallbackSync: true,
                _originalTimestamp: eventData.timestamp
              });
      
              // Mark as synced
              eventData.synced = true;
            }, index * 200); // Stagger events
          });

          // Update localStorage
          setTimeout(() => {
            localStorage.setItem('fallback_transfer_events', JSON.stringify(fallbackEvents));
          }, unsyncedEvents.length * 200 + 1000);
        }
      }

      // Global exposure
      window.productTransferSocket = {
        socket: () => socket,
        emit: emitTransferEvent,
        retry: retrySocketConnection,
        sync: syncFallbackEvents,
        isConnected: () => socket && socket.connected && !socketFallbackMode,
        isFallbackMode: () => socketFallbackMode,
        getConnectionAttempts: () => socketConnectionAttempts,
        getMaxAttempts: () => maxSocketAttempts
      };

      // Make the retry function globally available
      window.retrySocketConnection = retrySocketConnection;

    </script>

    <!-- Firebase v9 SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
      import { getDatabase, ref, set, push, onValue, off, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

      // Firebase configuration - loaded securely from server
      let app;
      let database;
      let transferSessionId = null;
      let userActivityRef = null;
      let onlineUserRef = null;

      // Fallback Firebase initialization with minimal config
      async function initializeFirebaseFallback() {
        try {
          // Use minimal config that doesn't expose sensitive data
          const fallbackConfig = {
            apiKey: "demo-api-key", // Demo key for development
            authDomain: "demo.firebaseapp.com",
            databaseURL: "https://demo-default-rtdb.firebaseio.com/",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "000000000000",
            appId: "1:000000000000:web:demo"
          };
          
          // Initialize Firebase with fallback config
          app = initializeApp(fallbackConfig);
          database = getDatabase(app);
          console.log('⚠️ Firebase initialized with fallback config (limited functionality)');
          
          // Make Firebase available globally but mark as fallback
          window.firebaseApp = app;
          window.firebaseDatabase = database;
          window.firebaseRef = ref;
          window.firebaseSet = set;
          window.firebasePush = push;
          window.firebaseOnValue = onValue;
          window.firebaseOff = off;
          window.firebaseServerTimestamp = serverTimestamp;
          window.firebaseOnDisconnect = onDisconnect;
          window.firebaseFallbackMode = true;
          
          return true;
          
        } catch (error) {
          console.error('❌ Firebase fallback initialization failed:', error);
          return false;
        }
      }

      // Secure Firebase initialization function
      async function initializeFirebaseSecurely() {
        try {
          // Try to fetch Firebase config from server API (secure approach)
          const response = await fetch('/api/firebase-config', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            // If server endpoint not available, use fallback config
            if (response.status === 404) {
              console.warn('⚠️ Firebase config API not available, using fallback configuration');
              return await initializeFirebaseFallback();
            }
            throw new Error(`Failed to fetch Firebase config: ${response.status}`);
          }
          
          const firebaseConfig = await response.json();
          
          // Initialize Firebase with config from server
          app = initializeApp(firebaseConfig);
          database = getDatabase(app);
          console.log('✅ Firebase initialized securely for Product Transfer');
          
          // Make Firebase available globally
          window.firebaseApp = app;
          window.firebaseDatabase = database;
          window.firebaseRef = ref;
          window.firebaseSet = set;
          window.firebasePush = push;
          window.firebaseOnValue = onValue;
          window.firebaseOff = off;
          window.firebaseServerTimestamp = serverTimestamp;
          window.firebaseOnDisconnect = onDisconnect;
          
          return true;
          
        } catch (error) {
          console.error('❌ Secure Firebase initialization failed:', error);
          
          // Fallback: Try to continue without Firebase
          console.warn('⚠️ Continuing without Firebase features...');
          window.firebaseApp = null;
          window.firebaseDatabase = null;
          
          // Show user-friendly error
          if (typeof showToast === 'function') {
            showToast('ไม่สามารถเชื่อมต่อกับระบบ real-time ได้ บางฟีเจอร์อาจไม่ทำงาน', 'warning');
          }
          
          return false;
        }
      }

      // Create session for product transfer activities
      async function createTransferSession() {
        if (!database) {
          console.warn('Firebase not available, skipping session creation');
          return null;
        }

        try {
          // Use window.ProductTransferApp if available, otherwise use fallback
          const branchCode = (window.ProductTransferApp && window.ProductTransferApp.utils) 
            ? window.ProductTransferApp.utils.getCurrentBranchCode()
            : (window.currentBranchCode || localStorage.getItem('currentBranchCode') || 'PATTANI');
          const userId = localStorage.getItem('userId');
          const userName = localStorage.getItem('userName');
          const userRole = localStorage.getItem('userRole');

          if (!branchCode || !userId) {
            console.error('Missing branch code or user ID for session creation');
            return null;
          }

          // Generate session ID
          transferSessionId = `transfer_${userId}_${Date.now()}`;

          // Session data
          const sessionData = {
            sessionId: transferSessionId,
            userId: userId,
            userName: userName || 'Unknown User',
            userRole: userRole || 'user',
            branchCode: branchCode,
            activity: 'product-transfer',
            startTime: serverTimestamp(),
            lastActivity: serverTimestamp(),
            status: 'active',
            page: 'productTransfer.html',
            userAgent: navigator.userAgent,
            ipAddress: null // Will be set by server if needed
          };

          // Save session
          const sessionRef = ref(database, `pos/${branchCode}/sessions/${transferSessionId}`);
          await set(sessionRef, sessionData);

          // Setup online presence
          const onlineRef = ref(database, `pos/${branchCode}/onlineUsers/${userId}`);
          const onlineData = {
            userId: userId,
            userName: userName || 'Unknown User',
            userRole: userRole || 'user',
            sessionId: transferSessionId,
            activity: 'product-transfer',
            lastSeen: serverTimestamp(),
            status: 'online'
          };

          await set(onlineRef, onlineData);
          onlineUserRef = onlineRef;

          // Handle disconnect
          const disconnectRef = onDisconnect(onlineRef);
          await disconnectRef.set({
            ...onlineData,
            status: 'offline',
            lastSeen: serverTimestamp()
          });

          // Setup activity tracking
          userActivityRef = ref(database, `pos/${branchCode}/sessions/${transferSessionId}/lastActivity`);
          
          console.log('✅ Transfer session created:', transferSessionId);
          return transferSessionId;

        } catch (error) {
          console.error('❌ Failed to create transfer session:', error);
          return null;
        }
      }

      // Log activity to Firebase
      async function logTransferActivity(action, details = {}) {
        if (!database) return;

        try {
          // Use window.ProductTransferApp if available, otherwise use fallback
          const branchCode = (window.ProductTransferApp && window.ProductTransferApp.utils) 
            ? window.ProductTransferApp.utils.getCurrentBranchCode()
            : (window.currentBranchCode || localStorage.getItem('currentBranchCode') || 'PATTANI');
          const userId = localStorage.getItem('userId');
          const userName = localStorage.getItem('userName');

          if (!branchCode || !userId) return;

          const activityData = {
            sessionId: transferSessionId,
            userId: userId,
            userName: userName || 'Unknown User',
            action: action,
            details: details,
            timestamp: serverTimestamp(),
            branchCode: branchCode,
            page: 'productTransfer'
          };

          // Save to activity history
          const activityRef = ref(database, `pos/${branchCode}/activityHistory`);
          await push(activityRef, activityData);

          // Update session last activity
          if (userActivityRef) {
            await set(userActivityRef, serverTimestamp());
          }

          console.log(`📝 Activity logged: ${action}`);

        } catch (error) {
          console.error('❌ Failed to log activity:', error);
        }
      }

      // Broadcast transfer event via Firebase
      async function broadcastTransferEvent(eventType, data) {
        if (!database) return;

        try {
          // Use window.ProductTransferApp if available, otherwise use fallback
          const branchCode = (window.ProductTransferApp && window.ProductTransferApp.utils) 
            ? window.ProductTransferApp.utils.getCurrentBranchCode()
            : (window.currentBranchCode || localStorage.getItem('currentBranchCode') || 'PATTANI');
          const userId = localStorage.getItem('userId');
          const userName = localStorage.getItem('userName');

          const eventData = {
            eventType: eventType,
            userId: userId,
            userName: userName || 'Unknown User',
            sessionId: transferSessionId,
            data: data,
            timestamp: serverTimestamp(),
            branchCode: branchCode
          };

          // Broadcast to stock updates
          const stockUpdateRef = ref(database, `pos/${branchCode}/stockUpdates`);
          await push(stockUpdateRef, eventData);

          console.log(`📡 Transfer event broadcasted: ${eventType}`);

        } catch (error) {
          console.error('❌ Failed to broadcast transfer event:', error);
        }
      }

      // Cleanup Firebase session
      async function cleanupTransferSession() {
        if (!database || !transferSessionId) return;

        try {
          // Use window.ProductTransferApp if available, otherwise use fallback
          const branchCode = (window.ProductTransferApp && window.ProductTransferApp.utils) 
            ? window.ProductTransferApp.utils.getCurrentBranchCode()
            : (window.currentBranchCode || localStorage.getItem('currentBranchCode') || 'PATTANI');
          const userId = localStorage.getItem('userId');

          // Update session status
          const sessionRef = ref(database, `pos/${branchCode}/sessions/${transferSessionId}`);
          await set(sessionRef, {
            status: 'ended',
            endTime: serverTimestamp(),
            lastActivity: serverTimestamp()
          });

          // Remove from online users
          if (onlineUserRef) {
            await set(onlineUserRef, {
              status: 'offline',
              lastSeen: serverTimestamp()
            });
          }

          console.log('🧹 Transfer session cleaned up');

        } catch (error) {
          console.error('❌ Failed to cleanup transfer session:', error);
        }
      }

      // Make functions available globally
      window.createTransferSession = createTransferSession;
      window.logTransferActivity = logTransferActivity;
      window.broadcastTransferEvent = broadcastTransferEvent;
      window.cleanupTransferSession = cleanupTransferSession;

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Firebase first
        const firebaseInitialized = await initializeFirebaseSecurely();
        
        if (firebaseInitialized && database) {
          await createTransferSession();
        } else {
          console.warn('Firebase not available - some features may not work');
        }
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', async () => {
        if (database) {
          await cleanupTransferSession();
        }
      });

    </script>

    <script>
      // Enhanced button loading function for compatibility
      function enhanceButtonWithLoading(button, options = {}) {
        if (!button) return;

        console.log('enhanceButtonWithLoading called for button:', button.id || 'unnamed', 'with options:', options);

        // Store original button properties
        const originalText = button.innerHTML;
        const originalDisabled = button.disabled;

        // Add loading method to button
        button.showLoading = function(message = 'กำลังดำเนินการ...') {
          this.disabled = true;
          this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${message}`;
        };

        // Add success method to button
        button.showSuccess = function(message = options.successMessage || 'สำเร็จ') {
          this.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = originalDisabled;
          }, 2000);
        };

        // Add error method to button
        button.showError = function(message = options.errorMessage || 'เกิดข้อผิดพลาด') {
          this.innerHTML = `<i class="fas fa-times mr-2"></i>${message}`;
          this.disabled = originalDisabled;
          setTimeout(() => {
            this.innerHTML = originalText;
          }, 3000);
        };

        // Add reset method to button
        button.resetLoading = function() {
          this.innerHTML = originalText;
          this.disabled = originalDisabled;
        };

        return button;
      }

      // Safe loading functions for backward compatibility
      function safeShowLoading(options = {}) {
        console.log('safeShowLoading called with:', options);
        return 'loading_' + Date.now(); // Return fake ID for compatibility
      }

      function safeHideLoading(id) {
        console.log('safeHideLoading called with ID:', id);
        return true;
      }

      function safeUpdateMessage(id, message, subMessage = null) {
        console.log('safeUpdateMessage called:', message, subMessage);
        return true; // Just log for compatibility
      }

      // Legacy variables (kept for compatibility)
      // Remove duplicate transferSocket declaration
      // let transferSocket = null; // This line should be removed

      // Assign global socket reference for backward compatibility
      function updateTransferSocketReference() {
        if (socket && socket.connected) {
          transferSocket = socket;
          window.transferSocket = socket;
        } else {
          transferSocket = null;
          window.transferSocket = null;
        }
      }

      // Update socket reference when connection changes
      if (typeof window.productTransferSocket === 'object') {
        const originalSocket = window.productTransferSocket.socket;
        window.productTransferSocket.socket = function() {
          const currentSocket = originalSocket();
          updateTransferSocketReference();
          return currentSocket;
        };
      }

      // Initialize enhanced Socket.IO with delay to ensure DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          initializeProductTransferSocket();
        }, 1000);
      });

      // Periodic activity update with enhanced error handling
      setInterval(() => {
        // Socket.IO activity
        if (socket && socket.connected && !socketFallbackMode) {
          try {
            socket.emit('user-activity', {
              userId: localStorage.getItem('userId'),
              userName: localStorage.getItem('userName'),
              activity: 'product-transfer',
              timestamp: new Date().toISOString(),
              branchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
                ? window.ProductTransferApp.utils.getCurrentBranchCode()
                : window.currentBranchCode || 'PATTANI')
            });
          } catch (error) {
            console.error('Error sending Socket.IO activity:', error);
          }
        }
      
        // Update Firebase activity
        if (window.logTransferActivity) {
          try {
            logTransferActivity('HEARTBEAT', {
              page: 'productTransfer',
              socketConnected: socket && socket.connected && !socketFallbackMode,
              fallbackMode: socketFallbackMode,
              timestamp: new Date().toISOString()
            });
          } catch (error) {
            console.error('Error logging Firebase activity:', error);
          }
        }
      }, 30000); // Every 30 seconds

      // Enhanced cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (socket && socket.connected) {
          try {
            socket.emit('user-leave', {
              userId: localStorage.getItem('userId'),
              userName: localStorage.getItem('userName'),
              activity: 'product-transfer',
              branchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
                ? window.ProductTransferApp.utils.getCurrentBranchCode()
                : window.currentBranchCode || 'PATTANI')
            });
            socket.disconnect();
          } catch (error) {
            console.error('Error during Socket.IO cleanup:', error);
          }
        }
      
        if (window.cleanupTransferSession) {
          try {
            cleanupTransferSession();
          } catch (error) {
            console.error('Error during Firebase cleanup:', error);
          }
        }
      });

      // Function to show/hide loading overlay
            // Global Variables (minimized)
      let sidebar; // Added for SidebarComponent
      
      // Initialize URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      
      // Update localStorage and title based on URL parameters
      if (urlParams.has('branch')) {
        localStorage.setItem('activeBranch', urlParams.get('branch'));
      }
      
      if (urlParams.has('name')) {
        document.title = `POS - โอนย้ายสินค้า - ${decodeURIComponent(urlParams.get('name'))}`;
      }
      // ProductTransfer Application Namespace
      window.ProductTransferApp = {
        // Data storage
        data: {
          branches: [],
          incomingItems: [],
          outgoingItems: [],
          categoryMap: {},
          transferHistory: [],
          allUsers: []
        },
      
        // UI state
        ui: {
          currentTab: 'form',
          currentPage: 1,
          itemsPerPage: 10,
          totalTransfers: 0
        },
      
        // Configuration
        config: {
          branchCode: urlParams.get('branch') || localStorage.getItem('activeBranch') || 'PATTANI'
        },
      
        // Error tracking
        errors: {
          lastError: null,
          errorCount: 0
        },
      
        // Utility methods
        utils: {
          getCurrentBranchCode() {
            return ProductTransferApp.config.branchCode || window.currentBranchCode || 'PATTANI';
          },
      
          logError(error, context = 'General') {
            ProductTransferApp.errors.lastError = error;
            ProductTransferApp.errors.errorCount++;
            console.error(`[${context}] Error:`, error);
          },
      
          resetErrorState() {
            ProductTransferApp.errors.lastError = null;
            ProductTransferApp.errors.errorCount = 0;
          },
      
          // Get best available display name for user
          getUserDisplayName(user) {
            if (!user) return '-';
      
            // If user is a string, return it directly
            if (typeof user === 'string') {
              return user;
            }
      
            // If user is an object, try various properties
            // Priority: employee.name > fullName > firstName+lastName > firstName > name > username > email
            let displayName = '';
      
            if (user.employee?.name) {
              displayName = user.employee.name;
            } else if (user.fullName) {
              displayName = user.fullName;
            } else if (user.firstName && user.lastName) {
              displayName = `${user.firstName} ${user.lastName}`.trim();
            } else if (user.firstName) {
              displayName = user.firstName;
            } else if (user.name) {
              displayName = user.name;
            } else if (user.username) {
              displayName = user.username;
            } else if (user.email) {
              displayName = user.email;
            } else {
              displayName = `User ${user._id?.slice(-6) || 'Unknown'}`;
            }
      
            // Ensure we don't return empty strings
            return displayName && displayName.trim() ? displayName.trim() : `User ${user._id?.slice(-6) || 'Unknown'}`;
          },
      
        // Check if user has complete name information
        hasCompleteUserInfo(user) {
          if (!user) return false;
          return !!(user.employee?.name || user.fullName || (user.firstName && user.lastName));
        },
      
        // Get available name fields for debugging
        getAvailableNameFields(user) {
          if (!user) return [];
      
          const fields = [];
          if (user.employee?.name) fields.push('employee.name');
          if (user.fullName) fields.push('fullName');
          if (user.firstName) fields.push('firstName');
          if (user.lastName) fields.push('lastName');
          if (user.name) fields.push('name');
          if (user.username) fields.push('username');
          if (user.email) fields.push('email');
      
          return fields;
        }
        }
      };

      // Shorthand references for frequently used data
      const { data: appData, ui: appUI, config: appConfig, utils: appUtils } = window.ProductTransferApp;

      // Legacy global references for backward compatibility
      window.currentBranchCode = appConfig.branchCode;
      window.getCurrentBranchCode = appUtils.getCurrentBranchCode;
      
      console.log(`[productTransfer] Using branch code: ${appConfig.branchCode}`);
      
      // Debug information for troubleshooting
      console.log('🔍 Browser Environment Debug Info:', {
        userAgent: navigator.userAgent,
        extensions: {
          chromeExtensions: !!window.chrome?.runtime,
          pRTLPCB: typeof window.pRTLPCB,
          extensionElements: document.querySelectorAll('[data-extension-id]').length
        },
        scripts: Array.from(document.querySelectorAll('script')).map(s => ({
          src: s.src || 'inline',
          hasExtensionPattern: s.src && (s.src.includes('extension://') || s.src.includes('pRTLPCB'))
        })),
        loadTime: new Date().toISOString()
      });

      // Extension Detection and Notification
      function detectProblematicExtensions() {
        const problematicPatterns = [
          'pRTLPCB',
          'chrome-extension://',
          'moz-extension://',
          'Extension context invalidated'
        ];
      
        let extensionDetected = false;
      
        // Check for extension-injected elements
        const scripts = document.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.src && problematicPatterns.some(pattern => script.src.includes(pattern))) {
            extensionDetected = true;
          }
        });
      
        // Check global variables that extensions might create
        if (window.pRTLPCB !== undefined ||
            window.chrome?.runtime?.getURL ||
            document.querySelector('[data-extension-id]')) {
          extensionDetected = true;
        }
      
        if (extensionDetected) {
          console.warn('🔍 Browser extension detected that may cause conflicts');
      
          // Show user-friendly notification
          setTimeout(() => {
            if (typeof showToast === 'function') {
              showToast(
                '🔧 ตรวจพบส่วนขยายของเบราว์เซอร์ที่อาจทำให้เกิดข้อผิดพลาด\n\n' +
                '💡 หากพบปัญหาการใช้งาน แนะนำให้:\n' +
                '• ปิดส่วนขยาย Ad Blocker ชั่วคราว\n' +
                '• ลองใช้งานในโหมด Incognito/Private\n' +
                '• ล้าง Cache และ Cookies',
                'warning'
              );
            }
          }, 2000);
        }
      
        return extensionDetected;
      }

      // Function to update server status
      function updateServerStatus(status, message = '') {
        const serverBadge = document.getElementById('serverStatusBadge');
        const serverText = document.getElementById('serverStatusText');
      
        if (!serverBadge || !serverText) return;
      
        const statusConfig = {
          checking: { text: 'ตรวจสอบเซิร์ฟเวอร์...', class: 'bg-gray-100 text-gray-700' },
          online: { text: 'เซิร์ฟเวอร์ออนไลน์', class: 'bg-green-100 text-green-700' },
          offline: { text: 'เซิร์ฟเวอร์ออฟไลน์', class: 'bg-red-100 text-red-700' },
          error: { text: 'เซิร์ฟเวอร์มีปัญหา', class: 'bg-yellow-100 text-yellow-700' }
        };
      
        const config = statusConfig[status] || statusConfig.error;
        let displayText = config.text;
      
        if (message) {
          displayText += ` (${message})`;
        }
      
        serverText.textContent = displayText;
        serverBadge.className = `px-2 py-1 rounded-full text-xs font-medium ${config.class}`;
      }

      // Check server status using existing API endpoint
      async function checkServerStatus() {
        updateServerStatus('checking');
      
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
      
          // ใช้ health endpoint ที่เพิ่งสร้าง
          const response = await fetch('/api/health', {
            method: 'GET',
            signal: controller.signal,
            headers: {
              'Cache-Control': 'no-cache'
            }
          });
      
          clearTimeout(timeoutId);
      
          if (response.ok) {
            const healthData = await response.json();
            if (healthData.success && healthData.status === 'healthy') {
              updateServerStatus('online');
            } else {
              updateServerStatus('error', 'Service Unhealthy');
            }
          } else if (response.status === 502) {
            updateServerStatus('error', '502 Bad Gateway');
          } else if (response.status === 404) {
            // ถ้า /api/health ไม่มี ลองใช้ endpoint อื่น
            try {
              const token = localStorage.getItem('authToken');
              const fallbackResponse = await fetch('/api/branch', {
                method: 'GET',
                signal: controller.signal,
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Cache-Control': 'no-cache'
                }
              });
      
              if (fallbackResponse.ok || fallbackResponse.status === 401) {
                updateServerStatus('online');
              } else if (fallbackResponse.status === 502) {
                updateServerStatus('error', '502 Bad Gateway');
              } else {
                updateServerStatus('error', `HTTP ${fallbackResponse.status}`);
              }
            } catch (fallbackError) {
              updateServerStatus('offline', 'ไม่สามารถเชื่อมต่อได้');
            }
          } else {
            updateServerStatus('error', `HTTP ${response.status}`);
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            updateServerStatus('offline', 'Timeout');
          } else {
            updateServerStatus('offline', 'ไม่สามารถเชื่อมต่อได้');
          }
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        // Detect problematic extensions early
        detectProblematicExtensions();
      
        // Check server status first
        checkServerStatus();
      
        // Enhanced page loading with progress tracking
        const pageLoaderId = safeShowLoading({
          message: 'กำลังโหลดหน้าเว็บ...',
          subMessage: 'เตรียมระบบโอนย้ายสินค้า',
          showProgress: true,
          autoProgress: true,
          spinnerType: 'default'
        });
      
        try {
          // Set sender first (5%)
          safeUpdateMessage(pageLoaderId, 'กำลังตั้งค่าผู้ส่ง...', 'ใช้ข้อมูลผู้ใช้ที่ล็อกอิน');
          safeUpdateProgress(pageLoaderId, 5);
          updateSender();
      
          // Load branch info (10%)
          safeUpdateMessage(pageLoaderId, 'กำลังโหลดข้อมูลสาขา...', 'ตรวจสอบสาขาปัจจุบัน');
          safeUpdateProgress(pageLoaderId, 10);
          await loadBranchInfo();

          // Initialize tabs (20%)
          safeUpdateMessage(pageLoaderId, 'กำลังเตรียมหน้าจอ...', 'ตั้งค่า Tab Navigation');
          safeUpdateProgress(pageLoaderId, 20);
          initializeTabs();
      
          // Load data in parallel (30-70%)
          safeUpdateMessage(pageLoaderId, 'กำลังโหลดข้อมูลพื้นฐาน...', 'ผู้ใช้, สาขา และหมวดหมู่สินค้า');
          safeUpdateProgress(pageLoaderId, 30);
          await Promise.all([loadUsers(), loadBranches(), loadCategories()]);
      
          // Initialize components (80%)
          safeUpdateProgress(pageLoaderId, 80);
          initializeFlatpickr();
          setupEventListeners();
      
          // Load stock list (90%)
          if (appConfig.branchCode) {
            safeUpdateMessage(pageLoaderId, 'กำลังโหลดข้อมูลสต็อก...', `สาขา ${appConfig.branchCode}`);
            safeUpdateProgress(pageLoaderId, 90);
            await fetchStockList();
          }
      
          // Complete (100%)
          safeUpdateProgress(pageLoaderId, 100);
          safeUpdateMessage(pageLoaderId, 'เตรียมระบบเสร็จสิ้น', 'พร้อมใช้งาน');
          await new Promise(resolve => setTimeout(resolve, 500));
      
        } catch (error) {
          console.error('Initialization error:', error);
          safeUpdateMessage(pageLoaderId, 'เกิดข้อผิดพลาด', 'ไม่สามารถโหลดระบบได้');
          await new Promise(resolve => setTimeout(resolve, 1500));
          showToast('เกิดข้อผิดพลาดในการโหลดระบบ: ' + error.message, 'error');
        } finally {
          safeHideLoading(pageLoaderId);
        }
      
        // Check server status periodically
        setInterval(checkServerStatus, 30000); // Check every 30 seconds
      });

      // Initialize Flatpickr with Thai locale
      function initializeFlatpickr() {
        const today = new Date();
        const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(
          today.getDate()
        ).padStart(2, '0')}`;
        flatpickr('#transferDate', {
          dateFormat: 'Y-m-d',
          defaultDate: formattedDate,
          locale: 'th',
          altInput: true,
          altFormat: 'd M Y',
          disableMobile: true,
        });
      }

      // Tab Management
      let currentTab = 'form'; // เพิ่มตัวแปร currentTab
      
      function initializeTabs() {
        const formTab = document.getElementById('transferFormTab');
        const historyTab = document.getElementById('transferHistoryTab');
        const formContent = document.getElementById('transferFormContent');
        const historyContent = document.getElementById('transferHistoryContent');

        formTab.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentTab === 'form') return;
          currentTab = 'form';
          formTab.classList.add('tab-active', 'text-primary-600');
          historyTab.classList.remove('tab-active', 'text-primary-600');
          historyTab.classList.add('text-gray-500', 'dark:text-gray-400');
          formContent.classList.remove('hidden');
          historyContent.classList.add('hidden');
        });

        historyTab.addEventListener('click', (e) => {
          e.preventDefault();
          if (currentTab === 'history') return;
          currentTab = 'history';
          historyTab.classList.add('tab-active', 'text-primary-600');
          formTab.classList.remove('tab-active', 'text-primary-600');
          formTab.classList.add('text-gray-500', 'dark:text-gray-400');
          historyContent.classList.remove('hidden');
          formContent.classList.add('hidden');
          loadTransferHistory();
        });
      }

      // Remove redundant functions
      // Removed: toggleDarkMode(), loadDarkMode(), toggleMenu(), loadEmployeeProfile(), confirmLogout()

      // Enhanced setupEventListeners with button loading
      function setupEventListeners() {
        // Form submit & reset
        document.getElementById('transferForm').addEventListener('submit', submitTransfer);
        document.getElementById('transferForm').addEventListener('reset', resetForm);

        // Enhanced search & filter events with loading
        document.getElementById('searchInput').addEventListener('input',
          debounce(async () => {
            const searchButton = document.querySelector('[data-search-trigger]');
            if (searchButton) {
              const loadingId = LoadingSystem.showButtonLoading(searchButton, { spinnerType: 'dots' });
              try {
                await fetchStockList();
              } finally {
                LoadingSystem.hideButtonLoading(loadingId);
              }
            } else {
              await fetchStockList();
            }
          }, 500)
        );
      
        document.getElementById('categoryFilter').addEventListener('change', async () => {
          const loadingId = safeShowLoading({
            message: 'กำลังกรองตามหมวดหมู่...',
            spinnerType: 'dots',
            showProgress: false
          });
          try {
            await fetchStockList();
          } finally {
            safeHideLoading(loadingId);
          }
        });

        document.getElementById('branchTo').addEventListener('change', function() {
          const selectedBranchCode = this.value;
          if (selectedBranchCode) {
            // Update receivers based on selected destination branch
            updateReceiversForBranch(selectedBranchCode);
          } else {
            // Clear receivers if no branch selected
            const receiverSelect = document.getElementById('receiver');
            receiverSelect.innerHTML = '<option value="">-- เลือกสาขาปลายทางก่อน --</option>';
          }
          updateMoveButtonState();
        });
        document.getElementById('receiver').addEventListener('change', updateMoveButtonState);

        // Enhanced history filter & search with loading
        document.getElementById('historyFilter').addEventListener('change', () =>
          loadTransferHistory(1, document.getElementById('historyFilter').value)
        );
        document.getElementById('historySearch').addEventListener('input',
          debounce(() => loadTransferHistory(1, document.getElementById('historyFilter').value), 500)
        );

        // Enhanced pagination buttons with loading
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
      
        enhanceButtonWithLoading(prevPageBtn, {
          spinnerType: 'default',
          successMessage: 'โหลดหน้าก่อนหน้าสำเร็จ',
          errorMessage: 'ไม่สามารถโหลดหน้าก่อนหน้าได้'
        });
      
        enhanceButtonWithLoading(nextPageBtn, {
          spinnerType: 'default',
          successMessage: 'โหลดหน้าถัดไปสำเร็จ',
          errorMessage: 'ไม่สามารถโหลดหน้าถัดไปได้'
        });

        prevPageBtn.onclick = async () => {
          if (appUI.currentPage > 1) {
            await loadTransferHistory(appUI.currentPage - 1, document.getElementById('historyFilter').value);
          }
        };
      
        nextPageBtn.onclick = async () => {
          const totalPages = Math.ceil(appUI.totalTransfers / appUI.itemsPerPage);
          if (appUI.currentPage < totalPages) {
            await loadTransferHistory(appUI.currentPage + 1, document.getElementById('historyFilter').value);
          }
        };

        // Enhance submit button with loading
        const submitBtn = document.getElementById('btnSubmit');
        enhanceButtonWithLoading(submitBtn, {
          spinnerType: 'default',
          successMessage: 'บันทึกการย้ายสำเร็จ',
          errorMessage: 'ไม่สามารถบันทึกการย้ายได้',
          showSuccess: false, // We handle success manually
          showError: false // We handle errors manually
        });
      }

      // Update loadBranchInfo to set sender name
      async function loadBranchInfo() {
        try {
          const token = localStorage.getItem('authToken') || '';
          const res = await fetch(`/api/branch`, { headers: { Authorization: `Bearer ${token}` } });
          const js = await res.json();
          if (res.ok && js.success) {
            const branch = js.data.find(b => b.branch_code === appConfig.branchCode);
            if (branch) {
              document.getElementById('branchInfo').textContent = `${branch.name} — ${branch.address}`;
              document.getElementById('branchFromDisplay').textContent = `[${appConfig.branchCode}] ${branch.name}`;
              document.getElementById('branchInfo2').textContent = `${branch.name} — ${branch.address}`;
              // อัพเดท title ของหน้าด้วยชื่อสาขาจริง
              document.title = `โอนย้ายสินค้า - ${branch.name}`;
              document.getElementById('pageTitle').textContent = `โอนย้ายสินค้า - ${branch.name}`;

              // Set sender from logged-in user
              updateSender();

              await fetchStockList();
              return;
            }
          }
          throw new Error('ไม่พบข้อมูลสาขา');
        } catch (err) {
          console.warn('loadBranchInfo error:', err);
          document.getElementById('branchInfo').textContent = 'สาขา: (ไม่พบข้อมูล)';
          document.getElementById('branchFromDisplay').textContent = '(ไม่พบสาขาต้นทาง)';
          document.getElementById('branchInfo2').textContent = 'สาขา: (ไม่พบข้อมูล)';
          showToast('ไม่พบข้อมูลสาขาในระบบ กรุณาติดต่อผู้ดูแลระบบ', 'warning');
        }
      }


       // Generate PDF using local template
       async function generateTransferPDF(transferId) {
         try {
           // Get transfer data
           let transfer = appData.transferHistory.find(t => t._id === transferId);
      
           // If not found in history, try to fetch from API
           if (!transfer) {
             try {
               const token = localStorage.getItem('authToken');
               const response = await fetch(`/api/transfers/${transferId}`, {
                 headers: { Authorization: `Bearer ${token}` }
               });
               const result = await response.json();
               if (result.success) {
                 transfer = result.data;
               }
             } catch (error) {
               console.error('Error fetching transfer data:', error);
             }
           }
      
           if (!transfer) {
             showToast('ไม่พบข้อมูลการโอนย้าย', 'error');
             return;
           }

           console.log('Transfer data for PDF:', transfer);

           // Open PDF template using the registered route
           const pdfWindow = window.open('/TransferPDF', '_blank');
      
           // Wait for window to load and populate data
           pdfWindow.onload = function() {
             console.log('PDF window loaded, setting transfer data:', transfer);
      
             // Pass transfer data and current user ID to PDF window
             pdfWindow.transferData = transfer;
             pdfWindow.currentUserId = localStorage.getItem('userId');
      
             // Trigger manual population if auto-populate doesn't work
             setTimeout(() => {
               if (pdfWindow.manualPopulateData) {
                 pdfWindow.manualPopulateData();
               }
             }, 200);
           };
      
           // Also set data with multiple attempts
           let attempts = 0;
           const maxAttempts = 5;
      
           const setDataInterval = setInterval(() => {
             attempts++;
      
             if (pdfWindow && !pdfWindow.closed && pdfWindow.document && pdfWindow.document.readyState === 'complete') {
               console.log(`Setting transfer data (attempt ${attempts}):`, transfer);
      
               pdfWindow.transferData = transfer;
               pdfWindow.currentUserId = localStorage.getItem('userId');
      
               if (pdfWindow.manualPopulateData) {
                 pdfWindow.manualPopulateData();
                 clearInterval(setDataInterval);
               }
             }
      
             if (attempts >= maxAttempts) {
               clearInterval(setDataInterval);
               console.log('Max attempts reached for setting PDF data');
             }
           }, 500);
      
         } catch (error) {
           console.error('Error generating PDF:', error);
           showToast('เกิดข้อผิดพลาดในการสร้าง PDF', 'error');
         }
       }

      // Download PDF with Authorization header
      async function downloadTransferSlip(transferId) {
        // ข้ามข้อมูลตัวอย่าง
        if (transferId.startsWith('sample_')) {
          showToast('📄 นี่เป็นข้อมูลตัวอย่าง ไม่สามารถดาวน์โหลด PDF ได้\n\n💡 เมื่อ API พร้อมใช้งาน จะสามารถดาวน์โหลดใบโอนสินค้าจริงได้', 'info');
          return;
        }
      
        const loadingId = safeShowLoading({
          message: 'กำลังสร้าง PDF ใบโอนสินค้า...',
          subMessage: `เลขที่: ${transferId}`,
          showProgress: true,
          spinnerType: 'default'
        });
      
        try {
          safeUpdateMessage(loadingId, 'กำลังดึงข้อมูลการโอนย้าย...', 'ตรวจสอบข้อมูลในฐานข้อมูล');
          safeUpdateProgress(loadingId, 25);
      
          const token = localStorage.getItem('authToken');
          const res = await fetch(`/api/transfers/${transferId}/pdf`, {
            headers: { Authorization: `Bearer ${token}` }
          });
      
          safeUpdateProgress(loadingId, 50);
          safeUpdateMessage(loadingId, 'กำลังสร้างไฟล์ PDF...', 'ประมวลผลเทมเพลตและข้อมูล');
      
          if (!res.ok) {
            const errorText = await res.text();
            console.error('PDF API Error Response:', errorText);
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
      
          safeUpdateProgress(loadingId, 75);
          safeUpdateMessage(loadingId, 'กำลังเตรียมไฟล์ดาวน์โหลด...', 'สร้างลิงก์ดาวน์โหลด');
      
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `DO-${transferId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
      
          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'ดาวน์โหลดสำเร็จ', 'ไฟล์ PDF ถูกบันทึกแล้ว');
      
          showToast(`📄 ดาวน์โหลดใบโอนสินค้าสำเร็จ!\n\nไฟล์: DO-${transferId}.pdf`, 'success');
          await new Promise(resolve => setTimeout(resolve, 800));
      
        } catch (e) {
          console.error('❌ Download PDF failed:', e);
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', `ไม่สามารถดาวน์โหลด PDF ได้: ${e.message}`);
          await new Promise(resolve => setTimeout(resolve, 1500));
          showToast('ไม่สามารถดาวน์โหลด PDF ได้: ' + e.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }

      // Print PDF with Authorization header
      async function printTransferSlip(transferId) {
        // ข้ามข้อมูลตัวอย่าง
        if (transferId.startsWith('sample_')) {
          showToast('🖨️ นี่เป็นข้อมูลตัวอย่าง ไม่สามารถพิมพ์ PDF ได้\n\n💡 เมื่อ API พร้อมใช้งาน จะสามารถพิมพ์ใบโอนสินค้าจริงได้', 'info');
          return;
        }
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch(`/api/transfers/${transferId}/pdf`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          document.body.appendChild(iframe);
          iframe.onload = () => {
            iframe.contentWindow.print();
            setTimeout(() => {
              document.body.removeChild(iframe);
              URL.revokeObjectURL(url);
            }, 500);
          };
        } catch (e) {
          console.error('❌ Print PDF failed:', e);
          showToast('ไม่สามารถพิมพ์ PDF ได้: ' + e.message, 'error');
        }
      }

      // Enhanced Fetch Stock List with Loading UX
      async function fetchStockList() {
        const code = appConfig.branchCode; // use locked branch
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const searchQuery = searchInput?.value?.trim() || '';
        const categoryQuery = categoryFilter?.value || '';

        // Reset outgoing items using namespace
        appData.outgoingItems = [];
        renderOutgoing([]);
        updateTransferSummary();
        document.getElementById('transferDate').disabled = true;

        if (!code) {
          renderIncoming([]);
          if (searchInput) searchInput.disabled = true;
          if (categoryFilter) categoryFilter.disabled = true;
          return;
        }

        // Show loading in table first
        const incomingBody = document.getElementById('transferListIn');
        incomingBody.innerHTML = `
          <tr>
            <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
              <div class="flex justify-center items-center space-x-2">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600"></div>
                <span>กำลังโหลดข้อมูลสต็อก...</span>
              </div>
            </td>
          </tr>
        `;

        let loadingId = null;
        const isSearching = searchQuery || categoryQuery;
      
        if (isSearching) {
          loadingId = safeShowLoading({
            message: 'กำลังค้นหาสินค้า...',
            subMessage: searchQuery ? `ค้นหา: "${searchQuery}"` : 'กรองตามหมวดหมู่',
            showProgress: true,
            spinnerType: 'dots'
          });
        }

        try {
          if (loadingId) {
            safeUpdateMessage(loadingId, 'กำลังดึงข้อมูลจากฐานข้อมูล...', 'เชื่อมต่อกับเซิร์ฟเวอร์');
            safeUpdateProgress(loadingId, 25);
          }

          const token = localStorage.getItem('authToken');
          const res = await fetch(
            `/api/branch-stock?branch_code=${encodeURIComponent(code)}`,
            {
              headers: { Authorization: 'Bearer ' + token },
            }
          );
      
          if (loadingId) {
            safeUpdateProgress(loadingId, 50);
            safeUpdateMessage(loadingId, 'กำลังประมวลผลข้อมูล...', 'กรองและจัดเรียงสินค้า');
          }

          // ตรวจสอบ 502 error
          if (res.status === 502) {
            console.warn('⚠️ Server 502 error - no stock data available');
            appData.incomingItems = [];
            renderIncoming([]);
            if (loadingId) {
              safeUpdateMessage(loadingId, 'เซิร์ฟเวอร์ไม่พร้อมใช้งาน', 'ไม่สามารถโหลดข้อมูลสต็อกได้');
            }
            showToast('เซิร์ฟเวอร์ไม่พร้อมใช้งาน - ไม่สามารถโหลดข้อมูลสต็อกได้', 'warning');
            return;
          }
      
          // ตรวจสอบว่าได้ JSON หรือ HTML
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('⚠️ Server returned HTML instead of JSON - no stock data available');
            appData.incomingItems = [];
            renderIncoming([]);
            if (loadingId) {
              safeUpdateMessage(loadingId, 'เซิร์ฟเวอร์ตอบกลับไม่ถูกต้อง', 'ได้รับ HTML แทน JSON');
            }
            showToast('เซิร์ฟเวอร์ตอบกลับไม่ถูกต้อง - ไม่สามารถโหลดข้อมูลสต็อกได้', 'warning');
            return;
          }

          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลสต๊อก');
          const raw = result.data || [];

          if (loadingId) {
            safeUpdateProgress(loadingId, 75);
            safeUpdateMessage(loadingId, 'กำลังกรองข้อมูล...', 'ค้นหาสินค้าที่ตรงเงื่อนไข');
          }

          const q = searchQuery.toLowerCase();
          const c = categoryQuery;

          appData.incomingItems = raw
            .filter((item) => item.stock_value > 0)
            .map((item) => ({
              id: item._id,

              name: item.name,
              brand: item.brand,
              imei: item.imei,
              categoryGroup: item.categoryGroup,
              stock_value: item.stock_value,
            }))
            .filter(
              (i) =>
                (!q || i.name.toLowerCase().includes(q) || (i.imei || '').toLowerCase().includes(q)) &&
                (!c || i.categoryGroup?._id === c)
            );

          if (loadingId) {
            safeUpdateProgress(loadingId, 100);
            safeUpdateMessage(loadingId, 'เสร็จสิ้น', `พบสินค้า ${appData.incomingItems.length} รายการ`);
            await new Promise(resolve => setTimeout(resolve, 500));
          }

          // Enable search & filter once branch is selected
          if (searchInput) searchInput.disabled = false;
          if (categoryFilter) categoryFilter.disabled = false;

          renderIncoming(appData.incomingItems);
          document.getElementById('transferDate').disabled = false; // Enable date picker
      
          // Log stock loading activity
          if (window.logTransferActivity) {
            logTransferActivity('STOCK_LOADED', {
              branchCode: code,
              totalItems: appData.incomingItems.length,
              searchQuery: searchQuery || '',
              categoryFilter: categoryQuery || '',
              isSearching: isSearching
            });
          }
      
          // Show success toast for search results
          if (isSearching && loadingId) {
            if (appData.incomingItems.length > 0) {
              showToast(`พบสินค้า ${appData.incomingItems.length} รายการ`, 'success');
            } else {
              showToast('ไม่พบสินค้าที่ตรงเงื่อนไข', 'warning');
            }
          }

        } catch (e) {
          appUtils.logError(e, 'fetchStockList');
          appData.incomingItems = [];
          renderIncoming([]);
      
          if (loadingId) {
            safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้');
            await new Promise(resolve => setTimeout(resolve, 1200));
          }
      
          showToast('ไม่สามารถโหลดข้อมูลสต๊อก: ' + e.message, 'error');
        } finally {
          if (loadingId) {
            safeHideLoading(loadingId);
          }
        }
      }

      // Render Incoming (Source) Table
      function renderIncoming(items) {
        const incomingBody = document.getElementById('transferListIn');
        const sourceItemCount = document.getElementById('sourceItemCount');
        sourceItemCount.textContent = `${items.length} รายการ`;

        if (!items.length) {
          incomingBody.innerHTML = `
            <tr>
              <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                ไม่มีสินค้าในสต๊อก
              </td>
            </tr>`;
          updateMoveButtonState();
          return;
        }

        incomingBody.innerHTML = items
          .map(
            (i, idx) => `
          <tr data-id="${i.id}" class="hover-row hover:bg-blue-50 dark:hover:bg-blue-900/20">
            <td class="px-4 py-2 font-mono text-sm">${i.sku || i._id?.slice(-6) || '-'}</td>
            <td class="px-4 py-2 font-medium">${i.name || '-'}</td>
            <td class="px-4 py-2">${i.brand || '-'}</td>
            <td class="px-4 py-2 font-mono text-sm">${i.imei || '-'}</td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs">
                ${i.categoryGroup?.name || '-'}
              </span>
            </td>
            <td class="px-4 py-2 text-center">
              <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-xs font-medium">
                ${i.stock_value}
              </span>
            </td>
            <td class="px-4 py-2 text-right">
              <button
                class="text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-2 text-sm font-medium transition-all transform hover:scale-105 shadow-sm"
                onclick="moveItemToOutgoing(${idx})"
                title="โอนย้ายสินค้านี้ไปยังสาขาปลายทาง"
              >
                <i class="bi bi-arrow-right mr-1"></i>
                โอนย้าย
              </button>
            </td>
          </tr>
        `
          )
          .join('');
        updateMoveButtonState();
      }

      // Render Outgoing (Destination) Table
      function renderOutgoing(items) {
        const outgoingBody = document.getElementById('transferListOut');
        const destItemCount = document.getElementById('destItemCount');
        destItemCount.textContent = `${items.length} รายการ`;

        if (!items.length) {
          outgoingBody.innerHTML = `
            <tr>
              <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                ยังไม่มีสินค้าที่เลือกส่งออก
              </td>
            </tr>`;
          updateMoveButtonState();
          return;
        }

        outgoingBody.innerHTML = items
          .map(
            (i, idx) => `
          <tr data-id="${i.id}" class="hover-row hover:bg-green-50 dark:hover:bg-green-900/20 border-l-4 border-green-500">
            <td class="px-4 py-2 font-mono text-sm">${i.sku || i._id?.slice(-6) || '-'}</td>
            <td class="px-4 py-2 font-medium">${i.name || '-'}</td>
            <td class="px-4 py-2">${i.brand || '-'}</td>
            <td class="px-4 py-2 font-mono text-sm">${i.imei || '-'}</td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs">
                ${i.categoryGroup?.name || '-'}
              </span>
            </td>
            <td class="px-4 py-2 text-center">
              <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-xs font-medium">
                ${i.stock_value}
              </span>
            </td>
            <td class="px-4 py-2 text-right">
              <button
                class="text-white bg-red-600 hover:bg-red-700 rounded-lg px-4 py-2 text-sm font-medium transition-all transform hover:scale-105 shadow-sm"
                onclick="removeItemFromOutgoing(${idx})"
                title="นำสินค้านี้กลับไปยังรายการต้นทาง"
              >
                <i class="bi bi-arrow-left mr-1"></i>
                ยกเลิก
              </button>
            </td>
          </tr>
        `
          )
          .join('');
        updateMoveButtonState();
      }

      // Move Item from Incoming to Outgoing
      function moveItemToOutgoing(idx) {
        const item = appData.incomingItems[idx];
        if (!item) return;
        appData.outgoingItems.push(item);
        appData.incomingItems = appData.incomingItems.filter((i) => i.id !== item.id);
        renderIncoming(appData.incomingItems);
        renderOutgoing(appData.outgoingItems);
        updateTransferSummary();
      
        // Log activity to Firebase
        if (window.logTransferActivity) {
          logTransferActivity('ITEM_ADDED_TO_TRANSFER', {
            itemId: item.id || '',
            itemName: item.name || '',
            itemImei: item.imei || '',
            totalOutgoingItems: appData.outgoingItems.length
          });
        }
      
        // Broadcast via Socket.IO
        if (socket && socket.connected) {
          socket.emit('transfer-item-added', {
            userId: localStorage.getItem('userId'),
            userName: localStorage.getItem('userName'),
            itemName: item.name,
            itemSku: item.sku,
            branchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
                ? window.ProductTransferApp.utils.getCurrentBranchCode()
                : window.currentBranchCode || 'PATTANI'),
            timestamp: new Date().toISOString()
          });
        }
      
        // Broadcast via Firebase
        if (window.broadcastTransferEvent) {
          broadcastTransferEvent('ITEM_ADDED_TO_TRANSFER', {
            itemId: item.id || '',
            itemName: item.name || '',
            totalItems: appData.outgoingItems.length
          });
        }
      }

      // Remove Item from Outgoing (back to Incoming)
      function removeItemFromOutgoing(idx) {
        const item = appData.outgoingItems[idx];
        if (!item) return;
        appData.incomingItems.push(item);
        appData.outgoingItems = appData.outgoingItems.filter((i) => i.id !== item.id);
        renderIncoming(appData.incomingItems);
        renderOutgoing(appData.outgoingItems);
        updateTransferSummary();
      
        // Log activity to Firebase
        if (window.logTransferActivity) {
          logTransferActivity('ITEM_REMOVED_FROM_TRANSFER', {
            itemId: item.id || '',
            itemName: item.name || '',
            itemImei: item.imei || '',
            totalOutgoingItems: appData.outgoingItems.length
          });
        }
      
        // Broadcast via Socket.IO
        if (socket && socket.connected) {
          socket.emit('transfer-item-removed', {
            userId: localStorage.getItem('userId'),
            userName: localStorage.getItem('userName'),
            itemName: item.name,
            itemSku: item.sku,
            branchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
                ? window.ProductTransferApp.utils.getCurrentBranchCode()
                : window.currentBranchCode || 'PATTANI'),
            timestamp: new Date().toISOString()
          });
        }
      
        // Broadcast via Firebase
        if (window.broadcastTransferEvent) {
          broadcastTransferEvent('ITEM_REMOVED_FROM_TRANSFER', {
            itemId: item.id || '',
            itemName: item.name || '',
            totalItems: appData.outgoingItems.length
          });
        }
      }

      // Update Transfer Summary (Count & Total Value)
      function updateTransferSummary() {
        const summary = document.getElementById('transferSummary');
        const count = document.getElementById('summaryItemCount');
        const value = document.getElementById('summaryTotalValue');

        if (appData.outgoingItems.length > 0) {
          summary.classList.remove('hidden');
          count.textContent = `${appData.outgoingItems.length} รายการ`;
        } else {
          summary.classList.add('hidden');
        }
      }

      // Enable/Disable Submit Button
      function updateMoveButtonState() {
        const branchTo = document.getElementById('branchTo');
        const receiver = document.getElementById('receiver');
        const submitBtn = document.getElementById('btnSubmit');
        const isValid = appConfig.branchCode &&
                        branchTo.value &&
                        receiver.value &&
                        appData.outgoingItems.length > 0;
        submitBtn.disabled = !isValid;
      }

      // Load Users for Sender/Receiver Select based on branch access
      async function loadUsers() {
        try {
          const token = localStorage.getItem('authToken');
      
          // โหลดพนักงานทั้งหมดทุกหน้า
          let allUsers = [];
          let page = 1;
          let hasMore = true;
      
          while (hasMore) {
            const res = await fetch(`/api/users?page=${page}`, {
              headers: { Authorization: 'Bearer ' + token },
            });
      
            // ตรวจสอบ 502 error
            if (res.status === 502) {
              console.warn('⚠️ Server 502 error - using fallback user data');
              appData.allUsers = [];
              return;
            }
      
            // ตรวจสอบว่าได้ JSON หรือ HTML
            const contentType = res.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
              console.warn('⚠️ Server returned HTML instead of JSON - using fallback user data');
              appData.allUsers = [];
              return;
            }
      
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลผู้ใช้');
      
            // เพิ่มพนักงานจากหน้านี้
            if (result.data && result.data.length > 0) {
              allUsers = [...allUsers, ...result.data];
            }
      
            // ตรวจสอบว่ายังมีหน้าถัดไปหรือไม่
            if (result.pagination && page < result.pagination.pages) {
              page++;
            } else {
              hasMore = false;
            }
          }
      
          // Store all users for filtering using namespace
          appData.allUsers = allUsers;
      
          // Debug: Log all users for troubleshooting
          console.log('✅ All users loaded:', appData.allUsers.length, 'users');
      
          // Check for users with incomplete name information
          const incompleteUsers = appData.allUsers.filter(user => !appUtils.hasCompleteUserInfo(user));
          if (incompleteUsers.length > 0) {
            console.warn('⚠️ Users with incomplete name information:', incompleteUsers.length);
            console.log('📋 Incomplete users sample:', incompleteUsers.slice(0, 3).map(user => ({
              id: user._id,
              displayName: appUtils.getUserDisplayName(user),
              availableFields: appUtils.getAvailableNameFields(user),
              role: user.role?.name
            })));
          }
      
          // Log sample of complete users
          const completeUsers = appData.allUsers.filter(user => appUtils.hasCompleteUserInfo(user));
          console.log('✅ Users with complete names:', completeUsers.length);
          if (completeUsers.length > 0) {
            console.log('📋 Complete users sample:', completeUsers.slice(0, 3).map(user => ({
              id: user._id,
              displayName: appUtils.getUserDisplayName(user),
              availableFields: appUtils.getAvailableNameFields(user),
              role: user.role?.name
            })));
          }
      
          // Initial load for receiver (will be filtered when branch is selected)
          const userSelect = document.getElementById('receiver');
          userSelect.innerHTML = '<option value="">-- เลือกสาขาปลายทางก่อน --</option>';
      
        } catch (e) {
          console.error('User loading error:', e);
          showToast('ไม่สามารถโหลดข้อมูลผู้ใช้', 'error');
        }
      }

      // Filter users by branch access
      function getUsersForBranch(branchCode) {
        if (!appData.allUsers || !branchCode) return [];
      
        return appData.allUsers.filter(user => {
          // Check if user has access to this branch
          const hasCheckinAccess = user.checkinBranches?.some(branch => {
            return (typeof branch === 'string' ? branch : branch._id) === branchCode ||
                   (typeof branch === 'object' && branch.branch_code === branchCode);
          });
      
          const hasAllowedAccess = user.allowedBranches?.some(branch => {
            return (typeof branch === 'string' ? branch : branch._id) === branchCode ||
                   (typeof branch === 'object' && branch.branch_code === branchCode);
          });
      
          // Admin users can access all branches
          const isAdmin = user.role?.name?.toLowerCase().includes('admin') ||
                         user.role?.name?.toLowerCase().includes('ceo') ||
                         user.role?.allowedPages?.includes('*');
      
          return hasCheckinAccess || hasAllowedAccess || isAdmin;
        });
      }

      // Update sender based on logged-in user
      function updateSender() {
        const senderInput = document.getElementById('sender');
        if (!senderInput) return;
      
        // Create a user object from localStorage data
        const currentUser = {
          username: localStorage.getItem('userName'),
          fullName: localStorage.getItem('userFullName'),
          firstName: localStorage.getItem('firstName'),
          lastName: localStorage.getItem('lastName'),
          name: localStorage.getItem('employeeName'),
          employee: {
            name: localStorage.getItem('employeeName')
          },
          email: localStorage.getItem('userEmail')
        };
      
        // Use helper function to get display name
        const senderName = appUtils.getUserDisplayName(currentUser);
        senderInput.value = senderName;
      
        console.log('✅ Sender set to logged-in user:', senderName);
      }

      // Update receiver dropdown based on destination branch
      async function updateReceiversForBranch(branchCode) {
        const receiverSelect = document.getElementById('receiver');
        if (!receiverSelect || !branchCode) {
          receiverSelect.innerHTML = '<option value="">-- เลือกสาขาปลายทางก่อน --</option>';
          return;
        }
      
        // Show loading state
        receiverSelect.innerHTML = '<option value="">-- กำลังโหลดผู้ใช้... --</option>';
        receiverSelect.disabled = true;
      
        const loadingId = safeShowLoading({
          message: 'กำลังโหลดรายชื่อผู้รับ...',
          subMessage: `สาขา: ${branchCode}`,
          showProgress: true,
          spinnerType: 'dots'
        });

        try {
          safeUpdateMessage(loadingId, 'กำลังดึงข้อมูลผู้ใช้...', 'ค้นหาผู้ใช้ที่มีสิทธิ์เข้าถึงสาขา');
          safeUpdateProgress(loadingId, 30);

          // Get branch details first to get branch ID
          const token = localStorage.getItem('authToken');
          const branchRes = await fetch(`/api/branch`, {
            headers: { Authorization: 'Bearer ' + token }
          });
      
          if (!branchRes.ok) {
            throw new Error('ไม่สามารถดึงข้อมูลสาขาได้');
          }
      
          const branchResult = await branchRes.json();
          if (!branchResult.success) {
            throw new Error(branchResult.error || 'ไม่สามารถดึงข้อมูลสาขาได้');
          }
      
          const targetBranch = branchResult.data.find(b => b.branch_code === branchCode);
          if (!targetBranch) {
            throw new Error('ไม่พบข้อมูลสาขาปลายทาง');
          }

          safeUpdateMessage(loadingId, 'กำลังค้นหาผู้ใช้...', 'ดึงรายชื่อผู้ใช้จากฐานข้อมูล');
          safeUpdateProgress(loadingId, 60);

          // Get users who have access to this branch
          console.log(`🔍 Fetching users for branch: ${targetBranch.name} (ID: ${targetBranch._id})`);
      
          const usersRes = await fetch(`/api/users/by-branch/${targetBranch._id}`, {
            headers: { Authorization: 'Bearer ' + token }
          });

          let usersInBranch = [];
      
          if (usersRes.ok) {
            const usersResult = await usersRes.json();
            if (usersResult.success) {
              usersInBranch = usersResult.data || [];
              console.log(`✅ API returned ${usersInBranch.length} users for branch ${targetBranch.name}`);
            } else {
              console.warn('⚠️ API returned unsuccessful response:', usersResult);
            }
          } else {
            console.warn('⚠️ API request failed with status:', usersRes.status);
          }
      
          // Fallback: If specific endpoint doesn't exist, filter from all users
          if (usersInBranch.length === 0) {
            console.log('🔄 Using fallback method to find users for branch');
            const allUsersCount = appData.allUsers ? appData.allUsers.length : 0;
            console.log(`📊 Total users in memory: ${allUsersCount}`);
      
            usersInBranch = getUsersForBranch(branchCode);
            console.log(`🔄 Fallback method found ${usersInBranch.length} users for branch ${branchCode}`);
          }

          safeUpdateProgress(loadingId, 80);
          safeUpdateMessage(loadingId, 'กำลังจัดเรียงรายชื่อ...', 'เตรียมข้อมูลสำหรับแสดงผล');
      
          receiverSelect.innerHTML = '<option value="">-- เลือกผู้รับ --</option>';
      
          if (usersInBranch.length === 0) {
            receiverSelect.innerHTML = '<option value="">-- ไม่พบผู้ใช้ในสาขานี้ --</option>';
            showToast('ไม่พบผู้ใช้ที่มีสิทธิ์เข้าถึงสาขาปลายทาง', 'warning');
            return;
          }
      
          // Sort users by display name
          usersInBranch.sort((a, b) => {
            const nameA = appUtils.getUserDisplayName(a).toLowerCase();
            const nameB = appUtils.getUserDisplayName(b).toLowerCase();
            return nameA.localeCompare(nameB, 'th');
          });
      
          usersInBranch.forEach((user) => {
            const displayName = appUtils.getUserDisplayName(user);
      
            // Debug: Log individual user data to understand name structure
            console.log(`🔍 Processing user ${user._id}:`, {
              displayName: displayName,
              username: user.username,
              name: user.name,
              firstName: user.firstName,
              lastName: user.lastName,
              fullName: user.fullName,
              employee: user.employee,
              role: user.role?.name,
              availableFields: appUtils.getAvailableNameFields(user),
              rawUserObject: user // Show complete user object for debugging
            });
      
            // แสดงชื่อผู้ใช้ พร้อมข้อมูลเพิ่มเติมถ้าชื่อไม่ชัดเจน
            let optionText = displayName;
      
            // ถ้าชื่อแสดงเป็น username หรือ email ให้เพิ่มข้อมูลเพิ่มเติม
            if (displayName === user.username || displayName === user.email || displayName.startsWith('User ')) {
              const nameInfo = [];
              if (user.firstName) nameInfo.push(user.firstName);
              if (user.lastName) nameInfo.push(user.lastName);
              if (user.employee?.name) nameInfo.push(`(${user.employee.name})`);
              if (user.role?.name) nameInfo.push(`[${user.role.name}]`);
      
              if (nameInfo.length > 0) {
                optionText = `${displayName} - ${nameInfo.join(' ')}`;
              }
            }
      
            const option = new Option(optionText, user._id);
      
            // Add tooltip with additional user info (ไม่แสดงข้อมูลสาขา)
            const additionalInfo = [];
            if (user.role?.name) {
              additionalInfo.push(`ตำแหน่ง: ${user.role.name}`);
            }
            if (user.username && user.username !== displayName) {
              additionalInfo.push(`Username: ${user.username}`);
            }
            if (user.email) {
              additionalInfo.push(`Email: ${user.email}`);
            }
            if (user.employee?.position) {
              additionalInfo.push(`หน้าที่: ${user.employee.position}`);
            }
            if (user.employee?.name && user.employee.name !== displayName) {
              additionalInfo.push(`ชื่อพนักงาน: ${user.employee.name}`);
            }
      
            if (additionalInfo.length > 0) {
              option.title = `${displayName}\n${additionalInfo.join('\n')}`;
            } else {
              option.title = displayName;
            }
      
            receiverSelect.appendChild(option);
          });
      
          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'เสร็จสิ้น', `พบผู้ใช้ ${usersInBranch.length} คน`);
      
          showToast(`พบผู้ใช้ ${usersInBranch.length} คนในสาขาปลายทาง`, 'success');
      
          // Debug: Log user names for troubleshooting
          console.log('✅ Users loaded for branch', branchCode, ':',
            usersInBranch.map(user => ({
              id: user._id,
              name: appUtils.getUserDisplayName(user),
              username: user.username,
              role: user.role?.name,
              // แสดงสาขาที่ user มีสิทธิ์เข้าถึง
              allowedBranches: user.allowedBranches?.map(b => b.name || b.branch_code) || [],
              checkinBranches: user.checkinBranches?.map(b => b.name || b.branch_code) || []
            }))
          );
      
          // แสดงสรุปการกรอง
          console.log(`📊 Summary: Showing ${usersInBranch.length} users who have access to branch "${targetBranch.name}" (${branchCode})`);
          if (usersInBranch.length > 0) {
            console.log('🎯 These users can receive transfers at this branch because they have access via:');
            usersInBranch.forEach(user => {
              const accessMethods = [];
              if (user.allowedBranches?.some(b => b._id === targetBranch._id || b.branch_code === branchCode)) {
                accessMethods.push('allowedBranches');
              }
              if (user.checkinBranches?.some(b => b._id === targetBranch._id || b.branch_code === branchCode)) {
                accessMethods.push('checkinBranches');
              }
              if (user.defaultBranches?.some(b => b._id === targetBranch._id || b.branch_code === branchCode)) {
                accessMethods.push('defaultBranches');
              }
              console.log(`   - ${appUtils.getUserDisplayName(user)}: ${accessMethods.join(', ')}`);
            });
          }

          await new Promise(resolve => setTimeout(resolve, 500));
      
        } catch (error) {
          console.error('❌ Error loading users for branch:', error);
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', error.message);
      
          receiverSelect.innerHTML = '<option value="">-- เกิดข้อผิดพลาดในการโหลด --</option>';
          showToast('ไม่สามารถโหลดรายชื่อผู้รับได้: ' + error.message, 'error');
      
          await new Promise(resolve => setTimeout(resolve, 1500));
        } finally {
          receiverSelect.disabled = false;
          safeHideLoading(loadingId);
        }
      }

      // Load Branches for Destination Select
      async function loadBranches() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch('/api/branch', {
            headers: { Authorization: 'Bearer ' + token },
          });
      
          // ตรวจสอบ 502 error
          if (res.status === 502) {
            console.warn('⚠️ Server 502 error - using fallback branch data');
            appData.branches = [];
            return;
          }
      
          if (res.status === 404) throw new Error('ไม่พบ API สำหรับโหลดข้อมูลสาขา');
      
          // ตรวจสอบว่าได้ JSON หรือ HTML
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('⚠️ Server returned HTML instead of JSON - using fallback branch data');
            appData.branches = [];
            return;
          }
      
          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลสาขา');
          appData.branches = result.data || [];
          const branchToSelect = document.getElementById('branchTo');
          branchToSelect.innerHTML = '<option value="">-- เลือกสาขาปลายทาง --</option>';
          appData.branches.forEach((branch) => {
            if (branch.branch_code !== appConfig.branchCode) {
              const option = new Option(
                `${branch.name} (${branch.branch_code})`,
                branch.branch_code
              );
              branchToSelect.appendChild(option);
            }
          });
        } catch (e) {
          console.error('Branch loading error:', e);
          showToast(e.message || 'ไม่สามารถโหลดข้อมูลสาขา', 'error');
        }
      }

      // Add loadCategories function
      async function loadCategories() {
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch('/api/category-group', {
            headers: { Authorization: 'Bearer ' + token },
          });
      
          // ตรวจสอบ 502 error
          if (res.status === 502) {
            console.warn('⚠️ Server 502 error - using fallback category data');
            return;
          }
      
          // ตรวจสอบว่าได้ JSON หรือ HTML
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('⚠️ Server returned HTML instead of JSON - using fallback category data');
            return;
          }
      
          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลหมวดหมู่');
          categoryMap = result.data.reduce((map, category) => {
            map[category._id] = category.name;
            return map;
          }, {});
          const categoryFilter = document.getElementById('categoryFilter');
          categoryFilter.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
          result.data.forEach((category) => {
            categoryFilter.append(new Option(category.name, category._id));
          });
        } catch (e) {
          console.error('Category loading error:', e);
          showToast('ไม่สามารถโหลดข้อมูลหมวดหมู่', 'error');
        }
      }

      // Enhanced Load Transfer History with Loading UX
      async function loadTransferHistory(page = 1, filter = '') {
        const loadingId = safeShowLoading({
          message: 'กำลังโหลดประวัติการย้ายสินค้า...',
          subMessage: page > 1 ? `หน้าที่ ${page}` : 'ประวัติการโอนย้ายทั้งหมด',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          safeUpdateMessage(loadingId, 'กำลังตรวจสอบสิทธิ์...', 'ตรวจสอบ Token การเข้าสู่ระบบ');
          safeUpdateProgress(loadingId, 10);

          const token = localStorage.getItem('authToken');
      
          // ตรวจสอบ token ก่อน
          if (!token) {
            safeUpdateMessage(loadingId, 'ไม่พบ Token', 'กำลังเปลี่ยนเส้นทางไปหน้าเข้าสู่ระบบ');
            await new Promise(resolve => setTimeout(resolve, 1500));
            showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
            window.location.href = '/login';
            return;
          }
      
          const searchInput = document.getElementById('historySearch')?.value || '';

          // Show loading indicator in table first
          const tbody = document.getElementById('historyTableBody');
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                <div class="flex justify-center items-center space-x-2">
                  <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600"></div>
                  <span>กำลังโหลดข้อมูล...</span>
                </div>
              </td>
            </tr>
          `;

          safeUpdateMessage(loadingId, 'กำลังดึงข้อมูลจากเซิร์ฟเวอร์...', 'เชื่อมต่อกับฐานข้อมูลประวัติ');
          safeUpdateProgress(loadingId, 30);

          const res = await fetch(
            `/api/transfers?page=${page}&limit=${appUI.itemsPerPage}&filter=${filter}&search=${searchInput}`,
            {
              headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
              },
            }
          );
      
          safeUpdateProgress(loadingId, 60);
          safeUpdateMessage(loadingId, 'กำลังประมวลผลข้อมูล...', 'ตรวจสอบและแปลงข้อมูล');
      
          // ตรวจสอบสถานะ response ก่อน
          if (!res.ok) {
            let errorMessage = `HTTP ${res.status}: ${res.statusText}`;
      
            if (res.status === 404) {
              // ไม่พบ API endpoint, แสดง error
              throw new Error('ไม่พบ API endpoint /api/transfers');
            } else if (res.status === 401) {
              safeUpdateMessage(loadingId, 'Session หมดอายุ', 'กำลังเปลี่ยนเส้นทางไปหน้าเข้าสู่ระบบ');
              await new Promise(resolve => setTimeout(resolve, 1500));
              showToast('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่', 'error');
              localStorage.removeItem('authToken');
              window.location.href = '/login';
              return;
            } else if (res.status >= 500) {
              errorMessage = 'เซิร์ฟเวอร์เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง';
            }
      
            throw new Error(errorMessage);
          }
      
          // ตรวจสอบ response headers
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response (ได้รับ HTML แทน JSON)');
          }
      
          const result = await res.json();
      
          if (!result.success) {
            throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลประวัติ');
          }

          safeUpdateProgress(loadingId, 80);
          safeUpdateMessage(loadingId, 'กำลังแสดงผลข้อมูล...', 'จัดเรียงและแสดงประวัติ');

          appUI.currentPage = page;
          appData.transferHistory = result.data || [];
          appUI.totalTransfers = result.total || 0;

          renderTransferHistory();
          renderPagination();

          // Hide sample data banner if showing real data
          window.usingSampleData = false;
          hideSampleDataBanner();

          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'โหลดเสร็จสิ้น', `พบประวัติ ${appUI.totalTransfers} รายการ`);
      
          // Log history loading activity
          if (window.logTransferActivity) {
            logTransferActivity('TRANSFER_HISTORY_LOADED', {
              page: page,
              filter: filter || '',
              searchQuery: searchInput || '',
              totalResults: appUI.totalTransfers,
              currentPageResults: appData.transferHistory.length
            });
          }
      
          // Success feedback
          if (filter || searchInput) {
            showToast(`พบประวัติ ${appData.transferHistory.length} รายการ`, 'success');
          }

          await new Promise(resolve => setTimeout(resolve, 500));
      
                      } catch (e) {
          console.error('❌ History loading error:', e);
          console.log('🔍 API Request URL:', `/api/transfers?page=${page}&limit=${appUI.itemsPerPage}&filter=${filter}&search=${searchInput}`);
          console.log('🔑 Auth Token:', localStorage.getItem('authToken') ? 'Present' : 'Missing');
          console.log('🌐 Current Location:', window.location.href);
          console.log('💡 Troubleshooting Tips:');
          console.log('   1. Check if /api/transfers endpoint exists on the server');
          console.log('   2. Verify server is running and accessible');
          console.log('   3. Check network connectivity');
          console.log('   4. Verify API authentication is working');
          console.log('   5. Check server logs for more details');
      
          // แสดง error message ที่ชัดเจนกว่า
          let errorMessage = 'ไม่สามารถโหลดข้อมูลประวัติ';
          let useSampleData = false;
      
        if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
          errorMessage = 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
          useSampleData = true;
        } else if (e.message.includes('non-JSON')) {
          errorMessage = 'เซิร์ฟเวอร์ตอบกลับข้อมูลไม่ถูกต้อง';
          useSampleData = true;
        } else if (e.message.includes('404')) {
          errorMessage = 'ไม่พบ API endpoint';
          useSampleData = true;
        } else if (e.message) {
          errorMessage = e.message;
        }
      
        if (useSampleData) {
          // ใช้ข้อมูลตัวอย่างแทน
          safeUpdateMessage(loadingId, 'ใช้ข้อมูลตัวอย่าง', 'เนื่องจาก API ไม่พร้อมใช้งาน');
          await new Promise(resolve => setTimeout(resolve, 1000));
      
          const sampleData = createSampleTransferHistory();
          appUI.currentPage = page;
          appData.transferHistory = sampleData;
          appUI.totalTransfers = sampleData.length;
          window.usingSampleData = true;
      
          renderTransferHistory();
          renderPagination();
          showSampleDataBanner();
      
          showToast('⚠️ ' + errorMessage + '\n\nแสดงข้อมูลตัวอย่างแทน', 'warning');
        } else {
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', errorMessage);
          await new Promise(resolve => setTimeout(resolve, 1500));
      
          showToast(errorMessage, 'error');
      
          const tbody = document.getElementById('historyTableBody');
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="py-6 text-center text-red-500 dark:text-red-400">
                <i class="bi bi-exclamation-triangle-fill mr-2"></i>
                ${errorMessage}
                <br>
                <button onclick="loadTransferHistory()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-all">
                  <i class="bi bi-arrow-clockwise mr-1"></i> ลองใหม่
                </button>
              </td>
            </tr>
          `;
        }
      } finally {
        safeHideLoading(loadingId);
      }
      }

      // Render Transfer History Table
      function renderTransferHistory() {
        const tbody = document.getElementById('historyTableBody');
        if (!appData.transferHistory.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="py-6 text-center text-gray-400 dark:text-gray-500">
                ไม่พบข้อมูลการย้ายสินค้า
              </td>
            </tr>`;
          return;
        }
        const userRole = localStorage.getItem('userRole');
        const currentBranch = appConfig.branchCode;

        tbody.innerHTML = appData.transferHistory
          .map(t => {
            let actionButton = '';
      
            // Check if this is the newly created transfer
            const isNewlyCreated = window.newlyCreatedTransferId && t._id === window.newlyCreatedTransferId;
            const rowClass = isNewlyCreated ? 'hover-row bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500' : 'hover-row';

            // ปุ่มตามสถานะและสิทธิ์
            if (t.status === 'pending' && t.fromBranch?.branch_code === currentBranch) {
              // สาขาต้นทาง: ปุ่มจัดส่ง (เซ็นผู้จัดเตรียม)
              actionButton = `<button onclick="prepareTransfer('${t._id}')"
                          class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 mr-1">
                        <i class="bi bi-box-seam mr-1"></i> จัดส่ง
                      </button>`;
            } else if ((t.status === 'in-transit' || t.status === 'pending-receive') && t.toBranch?.branch_code === currentBranch) {
              // สาขาปลายทาง: ปุ่มรับสินค้า
              actionButton = `<button onclick="receiveTransfer('${t._id}')"
                          class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 mr-1">
                        <i class="bi bi-box-arrow-in-down mr-1"></i> รับสินค้า
                      </button>`;
            }

            // ปุ่มยกเลิก (เฉพาะสถานะที่ยกเลิกได้)
            if ((t.status === 'pending' || t.status === 'in-transit' || t.status === 'pending-receive') &&
                (t.fromBranch?.branch_code === currentBranch || userRole?.includes('admin'))) {
              actionButton += `<button onclick="cancelTransfer('${t._id}')"
                          class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 mr-1">
                        <i class="bi bi-x-circle mr-1"></i> ยกเลิก
                      </button>`;
            }

            // ปุ่มดูรายละเอียด (ทุกคนเห็น)
            actionButton += `<label for="transferDetailModal"
                          class="px-3 py-1 bg-blue-50 text-blue-700 rounded text-xs cursor-pointer mr-1"
                          onclick="showTransferDetail('${t._id}')">
                        <i class="bi bi-eye mr-1"></i> รายละเอียด
                      </label>`;

            // ปุ่ม PDF สำหรับทุกสถานะ
            actionButton += `
              <button onclick="generateTransferPDF('${t._id}')" 
                      class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700"
                      title="ดาวน์โหลด PDF">
                <i class="bi bi-file-earmark-pdf mr-1"></i> PDF
              </button>`;

            // เพิ่มไอคอน "ใหม่" สำหรับรายการที่เพิ่งสร้าง
            const newBadge = isNewlyCreated ? '<span class="ml-2 px-2 py-1 bg-green-500 text-white text-xs rounded-full animate-pulse">ใหม่</span>' : '';

            return `
              <tr class="${rowClass}">
                <td class="px-4 py-3">${t.transferNo || '-'}${newBadge}</td>
                <td class="px-4 py-3">${new Date(t.transferDate).toLocaleDateString('th-TH', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}</td>
                <td class="px-4 py-3">${t.fromBranch?.name || '-'}</td>
                <td class="px-4 py-3">${t.toBranch?.name || '-'}</td>
                <td class="px-4 py-3 text-center">${t.items?.length || 0}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClasses[t.status] || ''}">
                    ${statusText[t.status] || 'ไม่ระบุ'}
                  </span>
                </td>
                <td class="px-4 py-3 text-right">
                  ${actionButton}
                </td>
              </tr>
            `;
          })
          .join('');
      
        // Clear the newly created transfer ID after highlighting
        setTimeout(() => {
          window.newlyCreatedTransferId = null;
        }, 10000); // Clear after 10 seconds
      }

      // Render Pagination Controls
      function renderPagination() {
        const info = document.getElementById('historyPaginationInfo');
        const pageNumbers = document.getElementById('pageNumbers');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const totalPages = Math.ceil(appUI.totalTransfers / appUI.itemsPerPage) || 1;
        const start = (appUI.currentPage - 1) * appUI.itemsPerPage + 1;
        const end = Math.min(start + appUI.itemsPerPage - 1, appUI.totalTransfers);
        info.textContent = `แสดง ${start}-${end} จาก ${appUI.totalTransfers} รายการ`;
        prevBtn.disabled = appUI.currentPage <= 1;
        nextBtn.disabled = appUI.currentPage >= totalPages;
        pageNumbers.innerHTML = '';

        let startPage = Math.max(1, appUI.currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) {
          startPage = Math.max(1, endPage - 4);
        }
        if (startPage > 1) {
          pageNumbers.appendChild(createPageButton(1));
          if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-gray-500 dark:text-gray-400';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          pageNumbers.appendChild(createPageButton(i));
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-gray-500 dark:text-gray-400';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
          }
          pageNumbers.appendChild(createPageButton(totalPages));
        }
      }

      // Create Individual Page Button
      function createPageButton(pageNum) {
        const btn = document.createElement('button');
        btn.textContent = pageNum;
        if (pageNum === appUI.currentPage) {
          btn.className = 'px-3 py-1 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-all';
        } else {
          btn.className = 'px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-all';
          btn.addEventListener('click', () => loadTransferHistory(pageNum));
        }
        return btn;
      }

      // Enhanced Show Transfer Detail Modal with loading
      async function showTransferDetail(id) {
        // Check if this is sample data
        if (id.startsWith('sample_')) {
          const sampleTransfer = appData.transferHistory.find(t => t._id === id);
          if (sampleTransfer) {
            populateTransferDetailModal(sampleTransfer);
            showToast('แสดงรายละเอียดข้อมูลตัวอย่าง', 'info');
          } else {
            showToast('ไม่พบข้อมูลตัวอย่าง', 'error');
          }
          return;
        }

        const loadingId = safeShowLoading({
          message: 'กำลังโหลดรายละเอียดการโอนย้าย...',
          subMessage: 'ดึงข้อมูลจากฐานข้อมูล',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          safeUpdateMessage(loadingId, 'กำลังตรวจสอบสิทธิ์...', 'ตรวจสอบ Token การเข้าสู่ระบบ');
          safeUpdateProgress(loadingId, 20);

          const token = localStorage.getItem('authToken');
          if (!token) {
            throw new Error('ไม่พบ Token การเข้าสู่ระบบ');
          }

          safeUpdateMessage(loadingId, 'กำลังดึงข้อมูลการโอนย้าย...', `รหัสการโอนย้าย: ${id}`);
          safeUpdateProgress(loadingId, 50);

          const res = await fetch(`/api/transfers/${id}`, {
            headers: { Authorization: 'Bearer ' + token },
          });

          safeUpdateProgress(loadingId, 70);
          safeUpdateMessage(loadingId, 'กำลังประมวลผลข้อมูล...', 'แปลงและจัดรูปแบบข้อมูล');

          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลรายละเอียด');
          const data = result.data;
          if (!data) throw new Error('ไม่พบข้อมูล');

          safeUpdateProgress(loadingId, 90);
          safeUpdateMessage(loadingId, 'กำลังแสดงผลข้อมูล...', 'เตรียมข้อมูลสำหรับแสดงใน Modal');

          populateTransferDetailModal(data);

          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'เสร็จสิ้น', 'พร้อมแสดงรายละเอียด');

          // Success feedback
          showToast('โหลดรายละเอียดสำเร็จ', 'success');
          await new Promise(resolve => setTimeout(resolve, 500));

        } catch (e) {
          console.error('Transfer detail error:', e);
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', e.message || 'ไม่สามารถโหลดข้อมูลได้');
          await new Promise(resolve => setTimeout(resolve, 1500));
          showToast('ไม่สามารถโหลดข้อมูลรายละเอียด: ' + e.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }

      // Helper function to populate transfer detail modal
      function populateTransferDetailModal(data) {
        // Debug: Log the received data to understand its structure
        console.log('Transfer Detail Modal Data:', {
          data: data,
          sender: data.sender,
          receiver: data.receiver,
          senderName: data.senderName,
          receiverName: data.receiverName,
          senderType: typeof data.sender,
          receiverType: typeof data.receiver
        });
      
        // Set transferId on PDF button
        const pdfBtn = document.getElementById('modalPDFBtn');
        if (pdfBtn) {
          pdfBtn.dataset.transferId = data._id;
        }
      
        // Populate modal data
        document.getElementById('modalTransferNo').textContent = data.transferNo || '-';
        const date = new Date(data.transferDate).toLocaleDateString('th-TH', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
        document.getElementById('modalDate').textContent = date;
        document.getElementById(
          'modalStatus'
        ).innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusClasses[data.status] || ''}">${statusText[data.status] || 'ไม่ระบุ'}</span>`;
        document.getElementById('modalFromBranch').textContent = data.fromBranch?.name || '-';
        document.getElementById('modalToBranch').textContent = data.toBranch?.name || '-';
      
        // Use the transformed senderName and receiverName from API response first
        let senderName = data.senderName;
        if (!senderName || senderName === 'ไม่ระบุผู้ส่ง') {
          // Enhanced fallback sender name resolution
          if (data.sender) {
            if (typeof data.sender === 'object') {
              senderName = data.sender.employee?.name ||
                          data.sender.name ||
                          data.sender.fullName ||
                          (data.sender.firstName && data.sender.lastName ?
                           `${data.sender.firstName} ${data.sender.lastName}` : '') ||
                          data.sender.firstName ||
                          data.sender.username ||
                          data.sender.email ||
                          'ไม่ระบุผู้ส่ง';
            }
          } else {
            senderName = localStorage.getItem('userName') || 'ไม่ระบุผู้ส่ง';
          }
        }
        document.getElementById('modalSender').textContent = senderName;
      
        // Use the transformed receiverName from API response first
        let receiverName = data.receiverName;
        if (!receiverName || receiverName === 'ไม่ระบุผู้รับ') {
          // Enhanced fallback receiver name resolution
          if (data.receiver) {
            if (typeof data.receiver === 'object') {
              receiverName = data.receiver.employee?.name ||
                            data.receiver.name ||
                            data.receiver.fullName ||
                            (data.receiver.firstName && data.receiver.lastName ?
                             `${data.receiver.firstName} ${data.receiver.lastName}` : '') ||
                            data.receiver.firstName ||
                            data.receiver.username ||
                            data.receiver.email ||
                            'ไม่ระบุผู้รับ';
            }
          } else {
            receiverName = 'ไม่ระบุผู้รับ';
          }
        }
        document.getElementById('modalReceiver').textContent = receiverName;
      
        // Add sample data indicator if needed
        const noteText = data.note || '-';
        const isSample = data._id?.startsWith('sample_');
        document.getElementById('modalNote').textContent = isSample ?
          `${noteText} (ข้อมูลตัวอย่าง)` : noteText;

        const itemsTable = document.getElementById('modalItems');
        itemsTable.innerHTML = (data.items || [])
          .map(
            (item) => `
            <tr>
              <td class="px-3 py-2">${item.sku || item.SKU || '-'}</td>
              <td class="px-3 py-2">${item.name || item.productName || item.itemName || '-'}</td>
              <td class="px-3 py-2">${item.brand || item.category || item.manufacturer || '-'}</td>
              <td class="px-3 py-2">${item.imei || item.IMEI || item.serialNumber || '-'}</td>
              <td class="px-3 py-2 text-center">${item.quantity || 1}</td>
            </tr>
          `
          )
          .join('');

        document.getElementById('modalDownloadBtn').dataset.transferId = data._id;
        document.getElementById('modalPrintBtn').dataset.transferId = data._id;
      }

      // Submit Transfer (with Confirmation)
      async function submitTransfer(event) {
        event.preventDefault();
        const branchTo = document.getElementById('branchTo').value;
        const transferDate = document.getElementById('transferDate').value;
        const receiver = document.getElementById('receiver').value;
        const note = document.getElementById('note').value;

        if (!appConfig.branchCode || !branchTo || !transferDate || !receiver || !appData.outgoingItems.length) {
          showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
          return;
        }

        // Validate receiver has access to destination branch
        const destUsers = getUsersForBranch(branchTo);
        const receiverHasAccess = destUsers.some(user => user._id === receiver);
      
        if (!receiverHasAccess) {
          showToast('ผู้รับที่เลือกไม่มีสิทธิ์เข้าถึงสาขาปลายทาง', 'error');
          return;
        }
        try {
          document.getElementById('confirmActionText').textContent =
            'ยืนยันการย้ายสินค้า? การดำเนินการนี้ไม่สามารถยกเลิกได้';
          document.getElementById('confirmActionModal').checked = true;

          const okButton = document.getElementById('okActionBtn');
          okButton.onclick = async () => {
            okButton.onclick = null;
            const token = localStorage.getItem('authToken');
            const items = appData.outgoingItems.map((i) => ({
              id: i.id,
              sku: i.sku,
              name: i.name,
              brand: i.brand,
              imei: i.imei,
              categoryGroup: i.categoryGroup?._id,
              quantity: 1,
            }));
            window.pendingTransferData = {
              fromBranchCode: appConfig.branchCode,
              toBranchCode: document.getElementById('branchTo').value,
              transferDate: document.getElementById('transferDate').value,
              senderId: localStorage.getItem('userId'),  // ✅ ส่ง ID ของผู้ส่ง
              receiverId: document.getElementById('receiver').value,
              note: document.getElementById('note').value,
              items: appData.outgoingItems.map(i => ({
                id: i.id,
                sku: i.sku || i._id?.slice(-6) || '',
                name: i.name,
                brand: i.brand,
                imei: i.imei,
                categoryGroup: i.categoryGroup?._id,
                quantity: 1,
                stock_value: i.stock_value || 0
              })),
              status: 'pending'  // สถานะเริ่มต้น: รอโอน
            };
      
            // Close the confirmation modal
            document.getElementById('confirmActionModal').checked = false;
      
            // Call the actual transfer submission function
            await processActualTransfer();
          };
        } catch (e) {
          console.error('Submit transfer error:', e);
          showToast('ไม่สามารถบันทึกการย้ายสินค้า: ' + e.message, 'error');
        }
      }

      // Process actual transfer submission to API
      async function processActualTransfer() {
        const loadingId = safeShowLoading({
          message: 'กำลังสร้างใบโอนสินค้า...',
          subMessage: 'เตรียมข้อมูลสำหรับส่ง',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          safeUpdateMessage(loadingId, 'กำลังสร้างคำขอโอนย้าย...', 'เตรียมข้อมูลรายการสินค้า');
          safeUpdateProgress(loadingId, 40);
      
          // Validate required data
          const token = localStorage.getItem('authToken');
          const userId = localStorage.getItem('userId');
          const branchTo = document.getElementById('branchTo').value;
          const receiver = document.getElementById('receiver').value;
      
          if (!token || !userId) {
            throw new Error('กรุณาเข้าสู่ระบบใหม่');
          }
      
          if (!branchTo || !receiver) {
            throw new Error('กรุณาเลือกสาขาปลายทางและผู้รับ');
          }

          const payload = {
            fromBranchCode: (window.ProductTransferApp && window.ProductTransferApp.utils
              ? window.ProductTransferApp.utils.getCurrentBranchCode()
              : window.currentBranchCode || 'PATTANI'),
            toBranchCode: branchTo,
            transferDate: document.getElementById('transferDate').value,
            senderId: userId,
            receiverId: receiver,
            note: document.getElementById('note').value || '',
            items: window.pendingTransferData.items.map(item => ({
              id: item.id,
              name: item.name,
              brand: item.brand,
              imei: item.imei,
              categoryGroup: item.categoryGroup?._id,
              quantity: 1
            }))
          };

          // Log payload for debugging
          console.log('📤 Sending transfer request:', {
            url: '/api/transfers',
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            payload
          });

          safeUpdateMessage(loadingId, 'กำลังส่งคำขอไปยังระบบ...', 'บันทึกลงฐานข้อมูล');
          safeUpdateProgress(loadingId, 70);

          const res = await fetch('/api/transfers', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          // Log response status and headers
          console.log('📥 Response status:', res.status);
          console.log('📥 Response headers:', Object.fromEntries(res.headers.entries()));

          // Get response text first
          const responseText = await res.text();
          console.log('📥 Response text:', responseText);

          let result;
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error('❌ JSON parse error:', parseError);
            throw new Error(`ไม่สามารถแปลงข้อมูลตอบกลับได้: ${responseText.substring(0, 100)}`);
          }

          if (!res.ok) {
            console.error('❌ HTTP Error:', res.status, result);
            throw new Error(result.error || result.message || `HTTP ${res.status}: ${res.statusText}`);
          }

          if (!result.success) {
            console.error('❌ API Error:', result);
            throw new Error(result.error || result.message || 'การสร้างใบโอนสินค้าไม่สำเร็จ');
          }

          // Store the newly created transfer ID for potential future use
          window.newlyCreatedTransferId = result.data?._id;

          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'สำเร็จ', `สร้างใบโอนสินค้า ${result.transferNo} เรียบร้อยแล้ว`);
      
          // Success feedback with transfer number
          showToast(`🎉 สร้างใบโอนสินค้าสำเร็จ!\n\n📄 เลขที่: ${result.transferNo}\n📦 จำนวนสินค้า: ${result.data?.itemCount || 0} รายการ\n\n✅ ส่งไปยังสาขาปลายทางเรียบร้อยแล้ว`, 'success');
          await new Promise(resolve => setTimeout(resolve, 1200));

          // Reset form and reload history
          resetForm();
          loadTransferHistory();

        } catch (error) {
          console.error('❌ Transfer submission error:', error);
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', error.message);
          await new Promise(resolve => setTimeout(resolve, 1500));
          showToast('ไม่สามารถสร้างใบโอนสินค้าได้: ' + error.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }

      // Reset Form to Initial State
      function resetForm() {
        const form = document.getElementById('transferForm');
        form.reset();
        document.getElementById('branchTo').value = '';
      
        // Reset receiver dropdown to initial state
        const receiverSelect = document.getElementById('receiver');
        receiverSelect.innerHTML = '<option value="">-- เลือกสาขาปลายทางก่อน --</option>';
      
        document.getElementById('transferDate').disabled = true;
        document.getElementById('searchInput').disabled = true;
        document.getElementById('categoryFilter').disabled = true;

        appData.incomingItems = [];
        appData.outgoingItems = [];
        renderIncoming([]);
        renderOutgoing([]);
        updateTransferSummary();
      }

      // Print Transfer (opens new window)
      function printTransfer(id) {
        printTransferSlip(id);
      }

      // Toast Notification
      function showToast(message, type = 'info') {
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'fixed top-4 right-4 z-50 flex flex-col space-y-2';
          document.body.appendChild(toastContainer);
        }
        const toast = document.createElement('div');
        let bgClass, iconClass;
        switch (type) {
          case 'success':
            bgClass = 'bg-green-100 dark:bg-green-900/80 text-green-800 dark:text-green-300';
            iconClass = 'bi-check-circle-fill text-green-500 dark:text-green-400';
            break;
          case 'error':
            bgClass = 'bg-red-100 dark:bg-red-900/80 text-red-800 dark:text-red-300';
            iconClass = 'bi-x-circle-fill text-red-500 dark:text-red-400';
            break;
          case 'warning':
            bgClass = 'bg-yellow-100 dark:bg-yellow-900/80 text-yellow-800 dark:text-yellow-300';
            iconClass = 'bi-exclamation-triangle-fill text-yellow-500 dark:text-yellow-400';
            break;
          default:
            bgClass = 'bg-blue-100 dark:bg-blue-900/80 text-blue-800 dark:text-blue-300';
            iconClass = 'bi-info-circle-fill text-blue-500 dark:text-blue-400';
        }
        toast.className = `${bgClass} px-4 py-3 rounded-lg shadow-md flex items-center min-w-[300px] animate-fadeIn`;
        toast.innerHTML = `
          <i class="bi ${iconClass} text-lg mr-3"></i>
          <div class="flex-1">${message}</div>
          <button class="ml-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
            <i class="bi bi-x"></i>
          </button>
        `;
        const closeBtn = toast.querySelector('button');
        closeBtn.addEventListener('click', () => {
          toast.classList.add('opacity-0');
          setTimeout(() => {
            toast.remove();
          }, 300);
        });
        toastContainer.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0');
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 4000);
      }

      // Debounce Helper
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Create sample transfer history data when API is not available
      function createSampleTransferHistory() {
        const currentUser = localStorage.getItem('userName') || 'ผู้ใช้งาน';
        const currentBranch = appConfig.branchCode || 'PATTANI';
        const currentTime = new Date();
      
        return [
          {
            _id: 'sample_001',
            transferNo: 'TRF-' + currentTime.getFullYear() + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
            transferDate: new Date(currentTime.getTime() - Math.floor(Math.random() * 7) * 86400000).toISOString(), // Random within last 7 days
            fromBranch: { name: 'สำนักงานใหญ่', branch_code: 'HEAD' },
            toBranch: { name: 'สาขาปัตตานี', branch_code: currentBranch },
            sender: { name: currentUser },
            receiver: { name: 'ผู้รับตัวอย่าง A' },
            items: [
              { sku: 'IPH15P-256-GLD', name: 'iPhone 15 Pro 256GB', brand: 'Apple', imei: '359876543210987', quantity: 1 },
              { sku: 'SAM-S24U-512-BLK', name: 'Samsung Galaxy S24 Ultra', brand: 'Samsung', imei: '358765432109876', quantity: 1 }
            ],
            status: 'pending-receive',
            note: '🚛 รอสาขาปลายทางรับสินค้า (ข้อมูลตัวอย่าง)',
            createdAt: new Date(currentTime.getTime() - Math.floor(Math.random() * 7) * 86400000).toISOString()
          },
          {
            _id: 'sample_002',
            transferNo: 'TRF-' + currentTime.getFullYear() + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
            transferDate: new Date(currentTime.getTime() - Math.floor(Math.random() * 30) * 86400000).toISOString(), // Random within last 30 days
            fromBranch: { name: 'สาขาหาดใหญ่', branch_code: 'HDY' },
            toBranch: { name: 'สาขาปัตตานี', branch_code: currentBranch },
            sender: { name: 'ผู้ส่งตัวอย่าง B' },
            receiver: { name: currentUser },
            items: [
              { sku: 'IPD-AIR-256-SLV', name: 'iPad Air 256GB WiFi', brand: 'Apple', imei: '357654321098765', quantity: 1 }
            ],
            status: 'completed',
            note: '✅ การย้ายสำเร็จ (ข้อมูลตัวอย่าง)',
            createdAt: new Date(currentTime.getTime() - Math.floor(Math.random() * 30) * 86400000).toISOString()
          },
          {
            _id: 'sample_003',
            transferNo: 'TRF-' + currentTime.getFullYear() + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
            transferDate: new Date(currentTime.getTime() - Math.floor(Math.random() * 14) * 86400000).toISOString(),
            fromBranch: { name: 'สาขาสงขลา', branch_code: 'SKL' },
            toBranch: { name: 'สาขาปัตตานี', branch_code: currentBranch },
            sender: { name: 'ผู้ส่งตัวอย่าง C' },
            receiver: { name: 'ผู้รับตัวอย่าง C' },
            items: [
              { sku: 'APP-MAC-M3-SLV', name: 'MacBook Air M3', brand: 'Apple', imei: 'C02ABC123DEF', quantity: 1 },
              { sku: 'APP-WTC-S9-BLK', name: 'Apple Watch Series 9', brand: 'Apple', imei: 'WT9876543210', quantity: 1 }
            ],
            status: 'pending-receive',
            note: '🚛 รอรับสินค้า (ข้อมูลตัวอย่าง)',
            createdAt: new Date(currentTime.getTime() - Math.floor(Math.random() * 14) * 86400000).toISOString()
          },
          {
            _id: 'sample_004',
            transferNo: 'TRF-' + (currentTime.getFullYear() - 1) + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
            transferDate: new Date(currentTime.getTime() - Math.floor(Math.random() * 90) * 86400000).toISOString(),
            fromBranch: { name: 'สาขาปัตตานี', branch_code: currentBranch },
            toBranch: { name: 'สาขานราธิวาส', branch_code: 'NWT' },
            sender: { name: currentUser },
            receiver: { name: 'ผู้รับตัวอย่าง D' },
            items: [
              { sku: 'SONY-PS5-STD', name: 'PlayStation 5 Standard', brand: 'Sony', imei: 'PS5123456789', quantity: 1 }
            ],
            status: 'rejected',
            note: '❌ ถูกปฏิเสธ - สินค้าไม่ตรงตามคำสั่ง (ข้อมูลตัวอย่าง)',
            createdAt: new Date(currentTime.getTime() - Math.floor(Math.random() * 90) * 86400000).toISOString()
          }
        ];
      }

      // Show sample data banner
      function showSampleDataBanner() {
        const banner = document.getElementById('sampleDataBanner');
        if (banner) {
          banner.classList.remove('hidden');
        }
      }

      // Hide sample data banner
      function hideSampleDataBanner() {
        const banner = document.getElementById('sampleDataBanner');
        if (banner) {
          banner.classList.add('hidden');
        }
      }

      // Try to reload history (force real API call)
      async function tryReloadHistory() {
        hideSampleDataBanner();
        window.usingSampleData = false; // Reset flag
        await loadTransferHistory(1, document.getElementById('historyFilter').value);
      }

      // Updated status system
      const statusText = {
        'pending': 'รอโอน',
        'pending-stock': 'รอโอน', // Legacy support
        'in-transit': 'กำลังจัดส่ง',
        'pending-receive': 'กำลังจัดส่ง', // Legacy support
        'received': 'รับแล้ว',
        'completed': 'รับแล้ว', // Legacy support
        'cancelled': 'ยกเลิก',
        'rejected': 'ยกเลิก', // Legacy support
      };
      const statusClasses = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'pending-stock': 'bg-yellow-100 text-yellow-800', // Legacy support
        'in-transit': 'bg-blue-100 text-blue-800',
        'pending-receive': 'bg-blue-100 text-blue-800', // Legacy support
        'received': 'bg-green-100 text-green-800',
        'completed': 'bg-green-100 text-green-800', // Legacy support
        'cancelled': 'bg-red-100 text-red-800',
        'rejected': 'bg-red-100 text-red-800', // Legacy support
      };

      // Process transfer function
      async function processTransfer() {
        const loadingId = safeShowLoading({
          message: 'กำลังประมวลผล...',
          subMessage: 'เตรียมข้อมูลสำหรับส่ง',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          if (window.pendingReceiveId) {
            actionText = 'รับสินค้า';
            successText = 'รับสินค้าเรียบร้อยแล้ว';
          } else if (window.pendingPrepareId) {
            actionText = 'จัดเตรียมสินค้า';
            successText = 'จัดเตรียมสินค้าเรียบร้อยแล้ว';
          } else {
            actionText = 'บันทึกการย้ายสินค้า';
            successText = 'บันทึกการย้ายสินค้าเรียบร้อยแล้ว';
          }

          safeUpdateMessage(loadingId, `กำลัง${actionText}...`, 'ประมวลผลลายเซ็นและบันทึกข้อมูล');
          safeUpdateProgress(loadingId, 20);

            safeUpdateMessage(loadingId, 'กำลังบันทึกการรับสินค้า...', 'อัปเดตสถานะและลายเซ็น');
            safeUpdateProgress(loadingId, 50);
      
            const res = await fetch(`/api/transfers/${window.pendingReceiveId}/receive`, {
              method: 'PUT',
              headers: {
                Authorization: 'Bearer ' + localStorage.getItem('authToken'),
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                status: 'received',
                receivedAt: new Date().toISOString(),
                receivedBy: localStorage.getItem('userId')
              })
            });
      
            safeUpdateProgress(loadingId, 80);
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'รับสินค้าไม่สำเร็จ');
      
            safeUpdateMessage(loadingId, 'กำลังบันทึกการจัดเตรียม...', 'อัปเดตสถานะและลายเซ็น');
            safeUpdateProgress(loadingId, 50);
      
            const prepareRes = await fetch(`/api/transfers/${window.pendingPrepareId}/prepare`, {
              method: 'PUT',
              headers: {
                Authorization: 'Bearer ' + localStorage.getItem('authToken'),
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                status: 'in-transit',
                preparedAt: new Date().toISOString(),
                preparedBy: localStorage.getItem('userId')
              })
            });
      
            safeUpdateProgress(loadingId, 80);
            const prepareResult = await prepareRes.json();
            if (!prepareResult.success) throw new Error(prepareResult.error || 'จัดเตรียมสินค้าไม่สำเร็จ');
      
            // Log transfer received to Firebase
            if (window.logTransferActivity) {
              logTransferActivity('TRANSFER_RECEIVED', {
                transferId: window.pendingReceiveId,
                status: 'completed',
                receivedAt: new Date().toISOString()
              });
            }
      
            // Broadcast transfer received
            if (socket && socket.connected) {
              socket.emit('transfer-received', {
                userId: localStorage.getItem('userId'),
                userName: localStorage.getItem('userName'),
                transferId: window.pendingReceiveId,
                timestamp: new Date().toISOString()
              });
            }
      
            showToast('จัดเตรียมสินค้าเรียบร้อยแล้ว', 'success');
            loadTransferHistory();
      
          } catch (error) {
            console.error('Prepare transfer error:', error);
            showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
        }
      }

      // Cancel transfer function
      async function cancelTransfer(id) {
        if (!confirm('ต้องการยกเลิกการโอนย้ายนี้หรือไม่?')) return;
      
        const loadingId = safeShowLoading({
          message: 'กำลังยกเลิกการโอนย้าย...',
          subMessage: 'อัปเดตสถานะ',
          showProgress: true
        });
      
        try {
          const token = localStorage.getItem('authToken');
          const res = await fetch(`/api/transfers/${id}/cancel`, {
            method: 'PUT',
            headers: {
              Authorization: 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              cancelledBy: localStorage.getItem('userId'),
              cancelledAt: new Date().toISOString(),
              status: 'cancelled'
            })
          });
      
          const result = await res.json();
          if (!result.success) throw new Error(result.error || 'ยกเลิกไม่สำเร็จ');
      
          showToast('ยกเลิกการโอนย้ายเรียบร้อย', 'success');
          loadTransferHistory();
      
        } catch (error) {
          console.error('Cancel transfer error:', error);
          showToast('ไม่สามารถยกเลิกได้: ' + error.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }
      // Function submitTransfer is already defined above, removing duplicate

      // Prepare transfer (ผู้จัดเตรียมเซ็น)
      async function prepareTransfer(id) {
        const loadingId = safeShowLoading({
          message: 'กำลังเตรียมการจัดส่ง...',
          subMessage: 'เปิดหน้าต่างลายเซ็นผู้จัดเตรียม',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          safeUpdateProgress(loadingId, 50);
          safeUpdateMessage(loadingId, 'กำลังโหลดข้อมูลการโอนย้าย...', 'ตรวจสอบรายละเอียด');
      
          await new Promise(resolve => setTimeout(resolve, 800));
      
          window.pendingPrepareId = id;
      
          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'พร้อมจัดเตรียมสินค้า', 'กรุณาลงลายเซ็นผู้จัดเตรียม');
      
          await new Promise(resolve => setTimeout(resolve, 500));
      
        } catch (error) {
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', 'ไม่สามารถเตรียมการจัดส่งได้');
          await new Promise(resolve => setTimeout(resolve, 1200));
          showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }

      // Enhanced receiveTransfer handler with loading
      async function receiveTransfer(id) {
        const loadingId = safeShowLoading({
          message: 'กำลังเตรียมการรับสินค้า...',
          subMessage: 'เปิดหน้าต่างลายเซ็น',
          showProgress: true,
          spinnerType: 'default'
        });

        try {
          safeUpdateProgress(loadingId, 50);
          safeUpdateMessage(loadingId, 'กำลังโหลดข้อมูลการโอนย้าย...', 'ตรวจสอบรายละเอียด');
      
          await new Promise(resolve => setTimeout(resolve, 800));
      
          window.pendingReceiveId = id;
      
          safeUpdateProgress(loadingId, 100);
          safeUpdateMessage(loadingId, 'พร้อมรับสินค้า', 'กรุณาลงลายเซ็นผู้รับ');
      
          await new Promise(resolve => setTimeout(resolve, 500));
      
        } catch (error) {
          safeUpdateMessage(loadingId, 'เกิดข้อผิดพลาด', 'ไม่สามารถเตรียมการรับสินค้าได้');
          await new Promise(resolve => setTimeout(resolve, 1200));
          showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
        } finally {
          safeHideLoading(loadingId);
        }
      }

      // Show/Hide Loading with Lottie animation
      let lottieAnimation = null;
      function showLoading(show) {
        const loader = document.getElementById('loadingOverlay');
        if (show) {
          loader.style.display = 'flex';
          loader.classList.remove('animate__fadeOut');
          loader.classList.add('animate__fadeIn');

          if (!lottieAnimation) {
            console.log('🔄 Loading Lottie animation from /Loading/Loading.json');
            fetch('/Loading/Loading.json')
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then(animationData => {
                lottieAnimation = lottie.loadAnimation({
                  container: document.getElementById('lottieContainer'),
                  renderer: 'svg',
                  loop: true,
                  autoplay: true,
                  animationData: animationData
                });
                console.log('✅ Lottie animation loaded successfully');
              })
              .catch(error => {
                console.error('❌ Error loading Lottie animation:', error);
                document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
              });
          } else {
            lottieAnimation.play();
          }
        } else {
          if (lottieAnimation) {
            lottieAnimation.pause();
          }
          loader.classList.remove('animate__fadeIn');
          loader.classList.add('animate__fadeOut');
          setTimeout(() => { loader.style.display = 'none'; }, 600);
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        showLoading(true);
        // existing code...
        setTimeout(() => showLoading(false), 800);
      });

      window.addEventListener('beforeunload', () => {
        if (lottieAnimation) {
          lottieAnimation.destroy();
          lottieAnimation = null;
        }
      });

    </script>
  </body>
</html>
