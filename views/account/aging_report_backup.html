<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายการสินค้าคงเหลือ</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Required Libraries for Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Add Thai calendar locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/locale/th.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
            }
          }
        },
      }
    };
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    #mainContent {
      flex: 1;
    }
    
    body {
      font-family: 'Prompt', sans-serif;
      font-size: 0.875rem;
      background-color: #f8f9fa;
    }
    
      background-color: #1a202c;
      color: #f8f9fa;
    }
    
    .breadcrumb-item {
      color: #6c757d;
    }
    
    .breadcrumb-item a {
      color: #0ea5e9;
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
      background-color: #2d3748;
      border-color: #4a5568;
    }
    
    .form-control {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      width: 100%;
    }
    
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
      transition: all 0.2s;
    }
    
    .btn-rounded {
      border-radius: 30px;
    }
    
    .btn-outline-primary {
      border: 1px solid #0ea5e9;
      color: #0ea5e9;
      background-color: white;
    }
    
    .btn-outline-primary:hover {
      background-color: #f0f9ff;
    }
    
      color: #38bdf8;
      border-color: #38bdf8;
      background-color: transparent;
    }
    
      background-color: rgba(56, 189, 248, 0.1);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 1px solid #eee;
    }
    
      background-color: #2d3748;
      color: #d1d5db;
      border-bottom-color: #4a5568;
    }
    
    .table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    
      border-bottom-color: #4a5568;
      color: #f8f9fa;
    }
    
    .text-right {
      text-align: right;
    }
    
    .page-link {
      min-width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      margin: 0 2px;
    }
    
      border-color: #4a5568;
      color: #d1d5db;
    }
    
    .page-link:hover {
      background-color: #f9f9fb;
    }
    
      background-color: #374151;
    }
    
    .page-link.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .account-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
      border-bottom-color: #4a5568;
    }
    
    .account-list li:hover {
      background-color: #f9f9fb;
    }
    
      background-color: #374151;
    }
    
    .account-list li.active {
      background-color: #f0f9ff;
      color: #0ea5e9;
      font-weight: 500;
    }
    
      background-color: #1a4971;
      color: #38bdf8;
    }
    
    .date-range {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .date-range:focus {
      border-color: #0ea5e9;
      outline: none;
    }
    
    .negative-value {
      color: #ef4444;
    }
    
      color: #f87171;
    }
    
    .5rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 30; /* Lowered z-index for navbar if menu dropdowns need to be higher */
    }
    
    }
    
    .flex-1 {
      flex: 1;
    }
    
    .flex-none {
      flex: none;
    }
    
    .01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 1s;
    }
    
    .3;
      transition: 0s;
    }
    
    /* Dropdown menu styling */
    .5rem 1rem; /* Adjust as needed */
      cursor: pointer;
      align-items: center; /* Vertically align icon and text */
    }
    
    /* First Level Dropdown Panel */
    .1); /* From Tailwind: shadow-lg */
      border-radius: 0.375rem; /* From Tailwind: rounded-lg */
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      z-index: 40; /* Ensure dropdown is above other content but below higher-level modals if any */
      padding: 0.5rem; /* From Tailwind: p-2 */
    }
    
      left: 100%;
      /* Inherit background, shadow, radius, min-width, padding from first-level or define specifically */
      background: white; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      min-width: 220px; /* Or adjust as needed */
      opacity: 0;
      visibility: hidden;
      transform: translateX(10px); /* Fly-out from right */
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      z-index: 45; /* Higher than first-level dropdown */
      padding: 0.5rem;
    }
    
      color: #374151; /* Tailwind: text-gray-700 */
      text-decoration: none;
      border-radius: 0.25rem; /* Tailwind: rounded-md */
      white-space: nowrap; /* Prevent text wrapping in menu items */
    }
    
      border-left: 3px solid transparent;
      margin-bottom: 2px; /* Spacing between items */
    }
    
    .25rem; */ /* Original style, can be kept or removed */
    }
    
    /* User badge */
    .1);
      border-radius: 30px;
    }
    
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0ea5e9;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .expense-voucher {
      margin-left: 20px;
      position: relative;
    }
    
    .expense-voucher::before {
      content: '';
      position: absolute;
      left: -15px;
      top: 50%;
      width: 10px;
      height: 1px;
      background-color: #cbd5e0;
    }
    
      background-color: #4a5568;
    }
    
    /* Income Statement specific styles */
    .fin-statement-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .fin-statement-table td {
      padding: 10px 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e5e7eb;
    }
    
      border-bottom-color: #374151;
    }
    
    .fin-statement-table .item-title {
      font-weight: 500;
    }
    
    .fin-statement-table .bold {
      font-weight: 600;
    }
    
    .fin-statement-table .section-header {
      font-weight: 600;
      font-size: 1.05rem;
      color: #111827;
    }
    
      color: #f9fafb;
    }
    
    .fin-statement-table .section-total {
      font-weight: 600;
      color: #1e40af;
      background-color: #f0f9ff;
    }
    
      color: #93c5fd;
      background-color: #1e3a8a;
    }
    
    .fin-statement-table .grand-total {
      font-weight: 700;
      color: #0284c7;
      background-color: #e0f2fe;
      font-size: 1.05rem;
    }
    
      color: #38bdf8;
      background-color: #075985;
    }
    
    .fin-statement-table .indent-1 {
      padding-left: 2rem;
    }
    
    .fin-statement-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .overview-card {
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      background-color: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
      background-color: #1e293b;
    }
    
    .overview-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .metric-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
      color: #9ca3af;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
    }
    
      color: #f9fafb;
    }
    
    .trend-up {
      color: #10b981;
    }
    
    .trend-down {
      color: #ef4444;
    }
    
      color: #34d399;
    }
    
      color: #f87171;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    .view-switcher {
      display: flex;
      padding: 0.25rem;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
      background-color: #374151;
    }
    
    .view-option {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .view-option.active {
      background-color: white;
      color: #0ea5e9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
      background-color: #1f2937;
      color: #38bdf8;
    }
    
    .action-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
      background-color: white;
      color: #374151;
      transition: all 0.2s;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .action-button:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }
    
      background-color: #374151;
      border-color: #6b7280;
    }
    
    .period-selector {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      background-color: white;
      font-size: 0.875rem;
      color: #374151;
      outline: none;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    /* Dashboard Card Styles */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background-color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
      background-color: #1e293b;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .card-title {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
      color: #9ca3af;
    }
    
    .card-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    
      color: #f9fafb;
    }
    
    .comparison-value {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .comparison-up {
      color: #10b981;
    }
    
    .comparison-down {
      color: #ef4444;
    }
    
      color: #34d399;
    }
    
      color: #f87171;
    }
    
    /* Menu bar styles */
    .5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }
    
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
      border-bottom-color: #0ea5e9;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .month-selector {
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 0.25rem 0.5rem;
      background-color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    /* Display toggle */
    .display-toggle {
      display: flex;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.25rem;
    }
    
      background-color: #334155;
    }
    
    .toggle-btn {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .toggle-btn.active {
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      color: #0ea5e9;
    }
    
      background-color: #1f2937;
    }
    
    /* Financial table */
    .view-container {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
      background-color: #1e293b;
    }
    
    .hidden {
      display: none;
    }
    
    .financial-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .financial-table th {
      background-color: #f8f9fa;
      color: #6b7280;
      font-weight: 500;
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
      background-color: #1f2937;
      color: #d1d5db;
      border-bottom-color: #4b5563;
    }
    
    .financial-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
      border-bottom-color: #4b5563;
    }
    
    .financial-table .section-header {
      font-weight: 600;
      background-color: #f3f4f6;
      color: #111827;
      padding: 0.75rem 1rem;
    }
    
      background-color: #374151;
      color: #f3f4f6;
    }
    
    .financial-table .subsection-header {
      font-weight: 500;
      color: #4b5563;
      padding: 0.75rem 1rem;
      background-color: #f9fafb;
    }
    
      background-color: #1f2937;
      color: #e5e7eb;
    }
    
    .financial-table .amount {
      text-align: right;
      position: relative;
    }
    
    .financial-table .indent-1 {
      padding-left: 2rem;
    }
    
    .financial-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .financial-table .total-row {
      background-color: #e0f2fe;
      font-weight: 600;
    }
    
      background-color: #0c4a6e;
    }
    
    .comparison-value {
      display: inline-block;
      margin-left: 0.5rem;
      font-size: 0.75rem;
      font-weight: normal;
    }

    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .financial-table {
        font-size: 0.875rem;
      }
      
      .card-value {
        font-size: 1.25rem;
      }
      
      .view-container {
        padding: 1rem;
      }
    }
    
    @media print {
      .display-toggle, .dashboard-cards {
        display: none;
      }
      
      .view-container {
        box-shadow: none;
        padding: 0;
      }
      
      body {
        font-size: 12pt;
      }
    }
    
    /* Thai Calendar Styles */
    .date-picker-container {
      position: relative;
      display: inline-block;
    }
    
    .date-picker-input {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .thai-calendar {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      padding: 12px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 50;
      width: 280px;
      display: none;
    }
    
      background-color: #1e293b;
      border-color: #4b5563;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .month-year {
      font-weight: 500;
      font-size: 1.05rem;
    }
    
    .nav-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6b7280;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
      color: #9ca3af;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 8px;
    }
    
    .day-name {
      text-align: center;
      font-weight: 500;
      color: #6b7280;
      font-size: 0.85rem;
      padding: 4px 0;
    }
    
      color: #9ca3af;
    }
    
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .date-cell {
      height: 36px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      margin: 1px;
    }
    
    .date-cell:hover:not(.disabled) {
      background-color: #f3f4f6;
      border-radius: 50%;
    }
    
      background-color: #374151;
    }
    
    .date-cell.disabled {
      color: #d1d5db;
      cursor: default;
      opacity: 0.4;
    }
    
      color: #6b7280;
    }
    
    .date-cell.selected {
      background-color: #0ea5e9;
      color: white;
      border-radius: 50%;
    }
    
    .date-cell.today {
      border: 2px solid #0ea5e9;
      border-radius: 50%;
      font-weight: 500;
    }
    
      border-color: #38bdf8;
    }
  </style>
  
  <!-- Template สำหรับเมนู -->
  
  <!-- Account Menu Styles -->
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">
</head>

<body class="bg-gray-50 w-full h-screen">
  <script>
    // Force remove dark mode
    document.documentElement.classList.remove('dark');
    document.body.classList.remove('dark');
    localStorage.removeItem('darkMode');
    localStorage.setItem('theme', 'light');
  </script>
  <!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="loader"></div>
</div>
  <div id="mainContent" class="container mx-auto px-4 py-6">
    <!-- Navbar -->
    <!-- Account System Navbar Template -->
<div class="navbar bg-white shadow-md sticky top-0">
  <div class="flex-1 flex items-center space-x-6">
    <img src="/uploads/Logo2.png"
         alt="Logo"
         class="rounded-full shadow-lg"
         style="width: 40px; height: 40px;" />
    <span class="text-lg font-semibold" id="pageTitle">ระบบบัญชี</span>
    <!-- Menu Container -->
    <div id="mainMenuContainer" class="ml-auto"></div>
  </div>
  <div class="flex-none flex items-center space-x-2">
    <!-- User Profile Section -->
    <div class="flex items-center space-x-3 mr-4">
      <img id="employeePhoto"
           alt="Profile"
           class="w-10 h-10 rounded-full border-2 border-gray-300"
           src="/img/default-avatar.svg">
      <span id="employeeName" class="text-sm font-medium text-gray-700">Loading...</span>
    </div>


    <!-- Logout Button -->
    <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy">
      <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="loader"></div>
</div>

<div class="flex-none flex items-center space-x-2">
  <!-- เพิ่มส่วนแสดงข้อมูลผู้ใช้ -->
  <div class="flex items-center space-x-3 mr-4">
    <img id="employeePhoto" 
     alt="Profile" 
     class="w-10 h-10 rounded-full border-2 border-gray-300 object-cover shadow-sm">
    <span id="employeeName" class="text-sm font-medium text-gray-700">ผู้ดูแลระบบ</span>
  </div>
  
        <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy transition-all duration-200">
          <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
        </button>
      </div>
    </div>
    <!-- Breadcrumb -->
    <nav class="mb-6">
      <ol class="flex space-x-2 text-sm">
        <li class="breadcrumb-item"><a href="/">หน้าแรก</a></li>
        <li class="breadcrumb-item text-gray-500">/</li>
        <li class="breadcrumb-item"><a href="/reports">รายงาน</a></li>
        <li class="breadcrumb-item text-gray-500">/</li>
        <li class="breadcrumb-item text-gray-700">รายงานสินค้าคงเหลือ vs ขายออก</li>
      </ol>
    </nav>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="stats-value" id="totalItems">0</div>
        <div class="stats-label">รายการทั้งหมด</div>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="stats-value" id="totalQuantity">0</div>
        <div class="stats-label">จำนวนเข้า/ออก</div>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <div class="stats-value" id="totalValue">฿0</div>
        <div class="stats-label">ต้นทุน vs ขาย</div>
      </div>
      <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <div class="stats-value" id="avgPrice">฿0</div>
        <div class="stats-label">กำไร/ขาดทุน</div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <h3 class="text-lg font-semibold mb-4">
        <i class="bi bi-funnel-fill mr-2 text-blue-500"></i>
        ตัวกรองข้อมูล
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <!-- ช่วงวันที่ -->
        <div>
          <label class="block text-sm font-medium mb-2">วันที่เริ่มต้น</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">วันที่สิ้นสุด</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        
        <!-- ค้นหาตามรายการ -->
        <div>
          <label class="block text-sm font-medium mb-2">ค้นหาสินค้า</label>
          <div class="search-box">
            <input type="text" id="searchItem" class="form-control" placeholder="ค้นหาชื่อสินค้า...">
            <i class="bi bi-search search-icon"></i>
          </div>
        </div>
        
        <!-- ช่วงราคา -->
        <div>
          <label class="block text-sm font-medium mb-2">มูลค่าต่ำสุด</label>
          <input type="number" id="minPrice" class="form-control" placeholder="0" min="0">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">มูลค่าสูงสุด</label>
          <input type="number" id="maxPrice" class="form-control" placeholder="0" min="0">
        </div>
      </div>
      
      <div class="action-buttons mt-4">
        <button id="btnFilter" class="btn btn-primary">
          <i class="bi bi-search"></i> ค้นหา
        </button>
        <button id="btnClearFilter" class="btn btn-outline-primary">
          <i class="bi bi-x-circle"></i> ล้างตัวกรอง
        </button>
        <button id="btnAddItem" class="btn btn-success">
          <i class="bi bi-plus-circle"></i> เพิ่มรายการใหม่
        </button>
      </div>
    </div>

    <!-- Report Table -->
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">
          <i class="bi bi-table mr-2 text-blue-500"></i>
          ตารางรายงานสินค้าคงเหลือ vs ขายออก
        </h2>
        
        <div class="export-buttons">
          <button id="btnExportExcel" class="btn btn-success btn-sm">
            <i class="bi bi-file-earmark-excel"></i> Excel
          </button>
          <button id="btnExportPDF" class="btn btn-warning btn-sm">
            <i class="bi bi-file-earmark-pdf"></i> PDF
          </button>
          <button id="btnPrint" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-printer"></i> พิมพ์
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="table" id="reportTable">
          <thead>
            <tr>
              <th class="text-center" style="width: 5%;">#</th>
              <th style="width: 15%;">
                <button class="sort-btn" data-column="date">
                  วันเดือนปี <i class="bi bi-arrow-down-up"></i>
                </button>
              </th>
              <th style="width: 35%;">
                <button class="sort-btn" data-column="item">
                  ชื่อสินค้า <i class="bi bi-arrow-down-up"></i>
                </button>
              </th>
              <th class="text-center" style="width: 20%;">
                <button class="sort-btn" data-column="quantity">
                  จำนวน (เข้า/ออก/คงเหลือ) <i class="bi bi-arrow-down-up"></i>
                </button>
              </th>
              <th class="text-right" style="width: 20%;">
                <button class="sort-btn" data-column="price">
                  ต้นทุน/ขาย/กำไร <i class="bi bi-arrow-down-up"></i>
                </button>
              </th>
              <th class="text-center" style="width: 10%;">การจัดการ</th>
            </tr>
          </thead>
          <tbody id="reportTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-between items-center mt-4">
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-600">แสดง</span>
          <select id="itemsPerPage" class="form-control" style="width: auto; min-width: 80px;">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span class="text-sm text-gray-600">รายการต่อหน้า</span>
        </div>
        
        <div id="pagination" class="flex items-center space-x-2">
          <!-- Pagination buttons will be generated here -->
        </div>
        
        <div class="text-sm text-gray-600">
          แสดง <span id="showingFrom">0</span> ถึง <span id="showingTo">0</span> จาก <span id="totalRecords">0</span> รายการ
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Item Modal -->
  <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="text-lg font-semibold">เพิ่มรายการใหม่</h3>
        <button id="btnCloseModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <form id="itemForm">
        <input type="hidden" id="editItemId">
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">วันเดือนปี</label>
          <input type="date" id="itemDate" class="form-control" required>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">รายการ</label>
          <input type="text" id="itemName" class="form-control" placeholder="ระบุชื่อรายการ" required>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">จำนวน</label>
          <input type="number" id="itemQuantity" class="form-control" placeholder="0" min="0" step="0.01" required>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">ราคา (บาท)</label>
          <input type="number" id="itemPrice" class="form-control" placeholder="0.00" min="0" step="0.01" required>
        </div>
        
        <div class="flex gap-3">
          <button type="submit" class="btn btn-primary flex-1">
            <i class="bi bi-check-circle"></i> บันทึก
          </button>
          <button type="button" id="btnCancelModal" class="btn btn-outline-primary flex-1">
            <i class="bi bi-x-circle"></i> ยกเลิก
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Sample data for demonstration - ตรงกับข้อมูลในภาพ
    let reportData = [];
    let stockData = []; // ข้อมูลสินค้าคงเหลือ
    let salesData = []; // ข้อมูลสินค้าที่ขาย

    let filteredData = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let sortColumn = '';
    let sortDirection = 'asc';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Inject menu template
      const menuTemplate = document.getElementById('mainMenuTemplate');
      const menuContainer = document.getElementById('mainMenuContainer');
      if (menuTemplate && menuContainer) {
        const menuContent = menuTemplate.content.cloneNode(true);
        menuContainer.appendChild(menuContent);
      }
    
      // Set default dates (ปี พ.ศ.)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
      // แปลงเป็นปี พ.ศ. สำหรับ input date
      const todayBuddhist = new Date(today.getFullYear() - 543, today.getMonth(), today.getDate());
      const firstDayBuddhist = new Date(firstDay.getFullYear() - 543, firstDay.getMonth(), 1);
    
      document.getElementById('startDate').value = firstDayBuddhist.toISOString().split('T')[0];
      document.getElementById('endDate').value = todayBuddhist.toISOString().split('T')[0];
    
      loadDataFromAPI();
      setupEventListeners();
    });

    // ฟังก์ชันดึงข้อมูลจาก API
    async function loadDataFromAPI() {
      showLoading(true);
      try {
        // ดึงข้อมูลสินค้าคงเหลือจาก BranchStockHistory (IN)
        const stockResponse = await fetch('/api/branch-stock-history?change_type=IN');
        if (stockResponse.ok) {
          const stockResult = await stockResponse.json();
          stockData = stockResult.data || [];
        }

        // ดึงข้อมูลสินค้าที่ขายออกจาก BranchStockHistory (OUT)
        const salesResponse = await fetch('/api/branch-stock-history?change_type=OUT');
        if (salesResponse.ok) {
          const salesResult = await salesResponse.json();
          salesData = salesResult.data || [];
        }

        // ดึงข้อมูล Purchase Orders
        const poResponse = await fetch('/api/purchase-orders');
        if (poResponse.ok) {
          const poResult = await poResponse.json();
          const purchaseOrders = poResult.data || [];
    
          // รวมข้อมูล PO เข้ากับ stockData
          purchaseOrders.forEach(po => {
            if (po.items && po.items.length > 0) {
              po.items.forEach(item => {
                stockData.push({
                  _id: po._id,
                  performed_at: po.createdAt || po.updatedAt,
                  change_type: 'PURCHASE',
                  branch_code: po.branch_code,
                  items: [item],
                  quantity: item.qty,
                  stock_value: item.totalItemAmount || (item.qty * item.cost)
                });
              });
            }
          });
        }

        processReportData();
        loadData();
    
      } catch (error) {
        console.error('Error loading data from API:', error);
        showMessage('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
    
        // ใช้ข้อมูลตัวอย่างแทน
        loadSampleData();
      } finally {
        showLoading(false);
      }
    }

    // ฟังก์ชันประมวลผลข้อมูลรายงาน
    function processReportData() {
      reportData = [];
    
      // รวมข้อมูลสินค้าคงเหลือ
      stockData.forEach(record => {
        if (record.items && record.items.length > 0) {
          record.items.forEach(item => {
            reportData.push({
              id: `stock_${record._id}_${item._id || Date.now()}`,
              date: record.performed_at || new Date(),
              item: item.name || 'ไม่ระบุ',
              quantity: item.qty || record.quantity || 0,
              price: item.cost || item.price || 0,
              type: 'stock',
              branch_code: record.branch_code,
              change_type: record.change_type,
              sku: item.sku,
              barcode: item.barcode,
              rawName: item.name || 'ไม่ระบุ'
            });
          });
        }
      });

      // รวมข้อมูลสินค้าที่ขาย
      salesData.forEach(record => {
        if (record.items && record.items.length > 0) {
          record.items.forEach(item => {
            reportData.push({
              id: `sales_${record._id}_${item._id || Date.now()}`,
              date: record.performed_at || record.sale_date || new Date(),
              item: item.name || 'ไม่ระบุ',
              quantity: -(item.qty || record.quantity || 0), // ลบเพื่อแสดงว่าเป็นการขายออก
              price: item.price || 0,
              type: 'sales',
              branch_code: record.branch_code,
              change_type: record.change_type,
              sku: item.sku,
              barcode: item.barcode,
              customer: record.customerInfo?.firstName || record.corporateInfo?.companyName || 'ไม่ระบุ',
              rawName: item.name || 'ไม่ระบุ'
            });
          });
        }
      });

      // จัดกลุ่มข้อมูลตามชื่อสินค้า
      const groupedData = groupDataByProductName(reportData);
      reportData = groupedData;
    
      // เรียงตามวันที่
      reportData.sort((a, b) => new Date(b.latestDate) - new Date(a.latestDate));
    
      filteredData = [...reportData];
    }

    // ฟังก์ชันจัดกลุ่มข้อมูลตามชื่อสินค้า
    function groupDataByProductName(data) {
      const grouped = {};
    
      data.forEach(item => {
        const productName = item.rawName;
    
        if (!grouped[productName]) {
          grouped[productName] = {
            id: `group_${productName}_${Date.now()}`,
            productName: productName,
            items: [],
            totalStockIn: 0,
            totalStockOut: 0,
            totalCostValue: 0,  // มูลค่าต้นทุนรวม
            totalSaleValue: 0,  // มูลค่าขายรวม
            latestDate: item.date,
            branches: new Set(),
            skus: new Set(),
            barcodes: new Set(),
            avgCostPrice: 0,    // ราคาต้นทุนเฉลี่ยต่อชิ้น
            avgSalePrice: 0,    // ราคาขายเฉลี่ยต่อชิ้น
            costTransactions: [],  // เก็บรายการต้นทุนแยก
            saleTransactions: []   // เก็บรายการขายแยก
          };
        }
    
        grouped[productName].items.push(item);
    
        if (item.type === 'stock') {
          // คำนวณสำหรับสินค้าเข้า (ต้นทุน)
          const quantity = Math.abs(item.quantity);
          grouped[productName].totalStockIn += quantity;
          grouped[productName].totalCostValue += quantity * item.price;
          grouped[productName].costTransactions.push({
            quantity: quantity,
            price: item.price,
            totalValue: quantity * item.price
          });
        } else {
          // คำนวณสำหรับสินค้าออก (ขาย)
          const quantity = Math.abs(item.quantity);
          grouped[productName].totalStockOut += quantity;
          grouped[productName].totalSaleValue += quantity * item.price;
          grouped[productName].saleTransactions.push({
            quantity: quantity,
            price: item.price,
            totalValue: quantity * item.price
          });
        }
    
        if (new Date(item.date) > new Date(grouped[productName].latestDate)) {
          grouped[productName].latestDate = item.date;
        }
    
        if (item.branch_code) grouped[productName].branches.add(item.branch_code);
        if (item.sku) grouped[productName].skus.add(item.sku);
        if (item.barcode) grouped[productName].barcodes.add(item.barcode);
      });
    
      // คำนวณราคาเฉลี่ยและข้อมูลอื่น ๆ
      Object.values(grouped).forEach(group => {
        group.branches = Array.from(group.branches);
        group.skus = Array.from(group.skus);
        group.barcodes = Array.from(group.barcodes);
        group.netQuantity = group.totalStockIn - group.totalStockOut;
    
        // คำนวณราคาต้นทุนเฉลี่ยต่อชิ้น (weighted average)
        group.avgCostPrice = group.totalStockIn > 0 ? group.totalCostValue / group.totalStockIn : 0;
    
        // คำนวณราคาขายเฉลี่ยต่อชิ้น (weighted average)
        group.avgSalePrice = group.totalStockOut > 0 ? group.totalSaleValue / group.totalStockOut : 0;
    
        // คำนวณกำไร/ขาดทุน (ใช้ต้นทุนเฉลี่ยคูณจำนวนที่ขาย)
        const soldCostValue = group.totalStockOut * group.avgCostPrice;
        group.profitLoss = group.totalSaleValue - soldCostValue;
    
        // คำนวณ profit margin
        group.profitMargin = group.totalSaleValue > 0 ? ((group.profitLoss / group.totalSaleValue) * 100) : 0;
    
        // คำนวณ markup (% เพิ่มจากต้นทุน)
        group.markup = group.avgCostPrice > 0 ? (((group.avgSalePrice - group.avgCostPrice) / group.avgCostPrice) * 100) : 0;
    
        // คำนวณ ROI ต่อหน่วย
        group.roiPerUnit = group.avgSalePrice - group.avgCostPrice;
    
        // มูลค่าสินค้าคงเหลือ (ใช้ราคาต้นทุนเฉลี่ย)
        group.remainingValue = group.netQuantity > 0 ? group.netQuantity * group.avgCostPrice : 0;
      });
    
      return Object.values(grouped);
    }

    // ฟังก์ชันโหลดข้อมูลตัวอย่าง (กรณี API ไม่พร้อม)
    function loadSampleData() {
      reportData = [
        {
          id: 'group_1',
          productName: 'ปากกาลูกลื่น',
          items: [
            { id: 1, date: '2567-08-01', item: 'ปากกาลูกลื่น', quantity: 100, price: 10, type: 'stock', sku: 'PEN001', barcode: '1234567890' },
            { id: 2, date: '2567-08-02', item: 'ปากกาลูกลื่น', quantity: -30, price: 18, type: 'sales', customer: 'บริษัท ABC' },
            { id: 3, date: '2567-08-03', item: 'ปากกาลูกลื่น', quantity: -20, price: 20, type: 'sales', customer: 'ร้าน XYZ' }
          ],
          totalStockIn: 100,           // เข้า 100 ชิ้น
          totalStockOut: 50,           // ออก 30 + 20 = 50 ชิ้น
          netQuantity: 50,             // คงเหลือ 100 - 50 = 50 ชิ้น
          totalCostValue: 1000,        // ต้นทุนรวม: 100 × 10 = 1,000 บาท
          totalSaleValue: 940,         // ขายรวม: (30 × 18) + (20 × 20) = 540 + 400 = 940 บาท
          avgCostPrice: 10,            // ต้นทุนเฉลี่ย: 1,000 ÷ 100 = 10 บาท/ชิ้น
          avgSalePrice: 18.8,          // ขายเฉลี่ย: 940 ÷ 50 = 18.8 บาท/ชิ้น
          profitLoss: 440,             // กำไร: 940 - (50 × 10) = 940 - 500 = 440 บาท
          profitMargin: 46.81,         // อัตรากำไร: (440 ÷ 940) × 100 = 46.81%
          roiPerUnit: 8.8,             // กำไรต่อชิ้น: 18.8 - 10 = 8.8 บาท
          markup: 88,                  // Markup: ((18.8 - 10) ÷ 10) × 100 = 88%
          remainingValue: 500,         // มูลค่าคงเหลือ: 50 × 10 = 500 บาท
          latestDate: '2567-08-03',
          branches: ['สาขาหลัก'],
          skus: ['PEN001'],
          barcodes: ['1234567890'],
          costTransactions: [{ quantity: 100, price: 10, totalValue: 1000 }],
          saleTransactions: [
            { quantity: 30, price: 18, totalValue: 540 },
            { quantity: 20, price: 20, totalValue: 400 }
          ]
        },
        {
          id: 'group_2',
          productName: 'กระดาษ A4',
          items: [
            { id: 4, date: '2567-08-01', item: 'กระดาษ A4', quantity: 50, price: 80, type: 'stock', sku: 'PAPER001' },
            { id: 5, date: '2567-08-01', item: 'กระดาษ A4', quantity: 30, price: 90, type: 'stock', sku: 'PAPER001' },
            { id: 6, date: '2567-08-02', item: 'กระดาษ A4', quantity: -20, price: 150, type: 'sales', customer: 'โรงเรียน DEF' }
          ],
          totalStockIn: 80,            // เข้า 50 + 30 = 80 ชิ้น
          totalStockOut: 20,           // ออก 20 ชิ้น
          netQuantity: 60,             // คงเหลือ 80 - 20 = 60 ชิ้น
          totalCostValue: 6700,        // ต้นทุนรวม: (50 × 80) + (30 × 90) = 4000 + 2700 = 6,700 บาท
          totalSaleValue: 3000,        // ขายรวม: 20 × 150 = 3,000 บาท
          avgCostPrice: 83.75,         // ต้นทุนเฉลี่ย: 6,700 ÷ 80 = 83.75 บาท/ชิ้น
          avgSalePrice: 150,           // ขายเฉลี่ย: 3,000 ÷ 20 = 150 บาท/ชิ้น
          profitLoss: 1325,            // กำไร: 3,000 - (20 × 83.75) = 3,000 - 1,675 = 1,325 บาท
          profitMargin: 44.17,         // อัตรากำไร: (1,325 ÷ 3,000) × 100 = 44.17%
          roiPerUnit: 66.25,           // กำไรต่อชิ้น: 150 - 83.75 = 66.25 บาท
          markup: 79.10,               // Markup: ((150 - 83.75) ÷ 83.75) × 100 = 79.10%
          remainingValue: 5025,        // มูลค่าคงเหลือ: 60 × 83.75 = 5,025 บาท
          latestDate: '2567-08-02',
          branches: ['สาขาหลัก'],
          skus: ['PAPER001'],
          barcodes: [],
          costTransactions: [
            { quantity: 50, price: 80, totalValue: 4000 },
            { quantity: 30, price: 90, totalValue: 2700 }
          ],
          saleTransactions: [{ quantity: 20, price: 150, totalValue: 3000 }]
        },
        {
          id: 'group_3',
          productName: 'น้ำดื่ม',
          items: [
            { id: 7, date: '2567-08-02', item: 'น้ำดื่ม', quantity: -24, price: 15, type: 'sales', customer: 'ร้านสะดวกซื้อ GHI' }
          ],
          totalStockIn: 0,             // ไม่มีข้อมูลเข้า
          totalStockOut: 24,           // ออก 24 ชิ้น
          netQuantity: -24,            // ขาดสต็อก 24 ชิ้น
          totalCostValue: 0,           // ไม่มีข้อมูลต้นทุน
          totalSaleValue: 360,         // ขายรวม: 24 × 15 = 360 บาท
          avgCostPrice: 0,             // ไม่มีข้อมูลต้นทุน
          avgSalePrice: 15,            // ขายเฉลี่ย: 360 ÷ 24 = 15 บาท/ชิ้น
          profitLoss: 360,             // ไม่สามารถคำนวณกำไรได้ (แสดงเป็นรายได้)
          profitMargin: 100,           // ไม่มีข้อมูลต้นทุนเปรียบเทียบ
          roiPerUnit: 15,              // ไม่สามารถคำนวณได้
          markup: 0,                   // ไม่มีข้อมูลต้นทุน
          remainingValue: 0,           // ไม่มีสินค้าคงเหลือ
          latestDate: '2567-08-02',
          branches: ['สาขา 2'],
          skus: ['WATER001'],
          barcodes: [],
          costTransactions: [],
          saleTransactions: [{ quantity: 24, price: 15, totalValue: 360 }]
        }
      ];
      filteredData = [...reportData];
    }

    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      if (show) {
        spinner.classList.remove('hidden');
        spinner.classList.add('flex');
      } else {
        spinner.classList.add('hidden');
        spinner.classList.remove('flex');
      }
    }

    function setupEventListeners() {
      // Filter buttons
      document.getElementById('btnFilter').addEventListener('click', applyFilters);
      document.getElementById('btnClearFilter').addEventListener('click', clearFilters);
    
      // Modal buttons
      document.getElementById('btnAddItem').addEventListener('click', () => openModal());
      document.getElementById('btnCloseModal').addEventListener('click', closeModal);
      document.getElementById('btnCancelModal').addEventListener('click', closeModal);
    
      // Form submit
      document.getElementById('itemForm').addEventListener('submit', saveItem);
    
      // Export buttons
      document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
      document.getElementById('btnExportPDF').addEventListener('click', exportToPDF);
      document.getElementById('btnPrint').addEventListener('click', () => window.print());
    
      // Items per page change
      document.getElementById('itemsPerPage').addEventListener('change', function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        renderTable();
      });
    
      // Sort buttons
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const column = this.dataset.column;
          if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortDirection = 'asc';
          }
          sortData();
          renderTable();
        });
      });

    
      // Logout
      document.getElementById('btnLogout').addEventListener('click', function() {
        if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
          window.location.href = '/login';
        }
      });
    }

    function loadData() {
      renderTable();
      updateStats();
    }

    function renderTable() {
      const tbody = document.getElementById('reportTableBody');
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredData.slice(start, end);

      tbody.innerHTML = '';

      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
              <i class="bi bi-inbox text-4xl mb-2 block"></i>
              ไม่พบข้อมูล
            </td>
          </tr>
        `;
        return;
      }

      pageData.forEach((group, index) => {
        // แถวหลักของกลุ่มสินค้า
        const mainRow = document.createElement('tr');
        mainRow.className = 'group-main-row bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500';
    
        const netQuantityClass = group.netQuantity >= 0 ? 'text-green-600' : 'text-red-600';
        const stockIcon = group.netQuantity >= 0 ? 'bi-arrow-up-circle-fill' : 'bi-arrow-down-circle-fill';
    
        mainRow.innerHTML = `
          <td class="text-center font-semibold">${start + index + 1}</td>
          <td class="font-medium">${formatDate(group.latestDate)}</td>
          <td class="font-semibold">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg">
                ${group.productName.charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-semibold text-gray-800">${group.productName}</div>
                <div class="text-xs text-gray-500">
                  ${group.items.length} รายการ • ${group.branches.join(', ') || 'ไม่ระบุสาขา'}
                </div>
              </div>
            </div>
          </td>
          <td class="text-center">
            <div class="space-y-1">
              <div class="flex items-center justify-center gap-2 ${netQuantityClass}">
                <i class="bi ${stockIcon}"></i>
                <span class="font-bold">${formatNumber(Math.abs(group.netQuantity))}</span>
              </div>
              <div class="text-xs text-gray-500">
                <span class="text-green-600">+${formatNumber(group.totalStockIn)}</span> / 
                <span class="text-red-600">-${formatNumber(group.totalStockOut)}</span>
              </div>
            </div>
          </td>
          <td class="text-right">
            <div class="space-y-1">
              <div class="font-semibold text-blue-600">฿${formatNumber(group.totalCostValue)}</div>
              <div class="text-xs text-gray-500">ต้นทุน</div>
              <div class="font-semibold text-orange-600">฿${formatNumber(group.totalSaleValue)}</div>
              <div class="text-xs text-gray-500">ขาย</div>
              ${group.totalSaleValue > 0 ? `
              <div class="font-bold text-sm ${group.profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${group.profitLoss >= 0 ? '+' : ''}฿${formatNumber(group.profitLoss)}
              </div>
              <div class="text-xs text-gray-500">กำไร</div>
              ` : ''}
            </div>
          </td>
          <td class="text-center">
            <div class="flex items-center justify-center gap-1">
              <button class="btn btn-sm bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 shadow-md transition-all duration-200" 
                      onclick="toggleGroupDetails('${group.id}')" 
                      title="ดูรายละเอียด">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm bg-gradient-to-r from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700 shadow-md transition-all duration-200" 
                      onclick="exportGroupData('${group.id}')" 
                      title="ส่งออกข้อมูล">
                <i class="bi bi-download"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(mainRow);

        // แถวรายละเอียด (ซ่อนไว้เริ่มต้น)
        const detailsRow = document.createElement('tr');
        detailsRow.id = `details-${group.id}`;
        detailsRow.className = 'group-details-row hidden';
        detailsRow.innerHTML = `
          <td colspan="6" class="p-0">
            <div class="bg-gray-50 border-l-4 border-gray-300">
              <div class="p-4">
                <h4 class="font-semibold mb-3 text-gray-700">
                  <i class="bi bi-list-ul mr-2"></i>รายละเอียดการเคลื่อนไหว
                </h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  ${group.items.map(item => `
                    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                          <i class="bi ${item.type === 'sales' ? 'bi-arrow-down-circle text-red-500' : 'bi-arrow-up-circle text-green-500'}"></i>
                          <span class="font-medium ${item.type === 'sales' ? 'text-red-600' : 'text-green-600'}">
                            ${item.type === 'sales' ? 'ขายออก' : 'เข้าสต็อก'}
                          </span>
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(item.date)}</span>
                      </div>
                      <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                          <span class="text-gray-500">จำนวน:</span>
                          <span class="font-medium">${formatNumber(Math.abs(item.quantity))}</span>
                        </div>
                        <div>
                          <span class="text-gray-500">ราคา:</span>
                          <span class="font-medium ${item.type === 'sales' ? 'text-orange-600' : 'text-blue-600'}">
                            ฿${formatNumber(item.price)} ${item.type === 'sales' ? '(ขาย)' : '(ต้นทุน)'}
                          </span>
                        </div>
                        ${item.sku ? `
                        <div class="col-span-2">
                          <span class="text-gray-500">SKU:</span>
                          <span class="font-medium">${item.sku}</span>
                        </div>
                        ` : ''}
                        ${item.customer ? `
                        <div class="col-span-2">
                          <span class="text-gray-500">ลูกค้า:</span>
                          <span class="font-medium">${item.customer}</span>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                <!-- สรุปข้อมูลของกลุ่ม -->
                <div class="mt-4 bg-gradient-to-r from-blue-100 to-purple-100 rounded-lg p-4">
                  <h5 class="font-semibold mb-3 text-gray-700">
                    <i class="bi bi-pie-chart mr-2"></i>สรุปทางการเงิน
                  </h5>
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold text-green-600">${formatNumber(group.totalStockIn)}</div>
                      <div class="text-xs text-gray-600">เข้าสต็อก</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold text-red-600">${formatNumber(group.totalStockOut)}</div>
                      <div class="text-xs text-gray-600">ขายออก</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold ${group.netQuantity >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${group.netQuantity >= 0 ? '+' : ''}${formatNumber(group.netQuantity)}
                      </div>
                      <div class="text-xs text-gray-600">คงเหลือสุทธิ</div>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold text-blue-600">฿${formatNumber(group.totalCostValue)}</div>
                      <div class="text-xs text-gray-600">มูลค่าต้นทุน</div>
                      ${group.avgCostPrice > 0 ? `<div class="text-xs text-gray-500">เฉลี่ย ฿${formatNumber(group.avgCostPrice)}</div>` : ''}
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold text-orange-600">฿${formatNumber(group.totalSaleValue)}</div>
                      <div class="text-xs text-gray-600">มูลค่าขาย</div>
                      ${group.avgSalePrice > 0 ? `<div class="text-xs text-gray-500">เฉลี่ย ฿${formatNumber(group.avgSalePrice)}</div>` : ''}
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                      <div class="text-lg font-bold ${group.profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${group.profitLoss >= 0 ? '+' : ''}฿${formatNumber(group.profitLoss)}
                      </div>
                      <div class="text-xs text-gray-600">กำไร/ขาดทุน</div>
                      ${group.profitMargin !== 0 ? `<div class="text-xs text-gray-500">${formatNumber(group.profitMargin)}%</div>` : ''}
                    </div>
                  </div>
                  
                  <!-- เพิ่มข้อมูลเปรียบเทียบ -->
                  ${group.totalSaleValue > 0 && group.totalCostValue > 0 ? `
                  <div class="mt-4 pt-3 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                      <div class="text-center">
                        <div class="font-semibold text-gray-700">อัตราส่วนกำไร</div>
                        <div class="text-lg font-bold ${group.profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}">
                          ${formatNumber(group.profitMargin)}%
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="font-semibold text-gray-700">กำไรต่อชิ้น</div>
                        <div class="text-lg font-bold ${group.roiPerUnit >= 0 ? 'text-green-600' : 'text-red-600'}">
                          ${group.roiPerUnit >= 0 ? '+' : ''}฿${formatNumber(group.roiPerUnit)}
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="font-semibold text-gray-700">Markup</div>
                        <div class="text-lg font-bold text-purple-600">
                          ${formatNumber(group.markup)}%
                        </div>
                      </div>
                      <div class="text-center">
                        <div class="font-semibold text-gray-700">มูลค่าคงเหลือ</div>
                        <div class="text-lg font-bold text-indigo-600">
                          ฿${formatNumber(group.remainingValue)}
                        </div>
                      </div>
                    </div>
                    
                    <!-- แสดงรายละเอียดการคำนวณ -->
                    <div class="mt-3 pt-3 border-t border-gray-200">
                      <div class="text-xs text-gray-600 space-y-1">
                        <div><strong>การคำนวณ:</strong></div>
                        <div>• ราคาต้นทุนเฉลี่ย: ฿${formatNumber(group.totalCostValue)} ÷ ${formatNumber(group.totalStockIn)} = ฿${formatNumber(group.avgCostPrice)}/ชิ้น</div>
                        <div>• ราคาขายเฉลี่ย: ฿${formatNumber(group.totalSaleValue)} ÷ ${formatNumber(group.totalStockOut)} = ฿${formatNumber(group.avgSalePrice)}/ชิ้น</div>
                        <div>• กำไรต่อชิ้น: ฿${formatNumber(group.avgSalePrice)} - ฿${formatNumber(group.avgCostPrice)} = ฿${formatNumber(group.roiPerUnit)}</div>
                        <div>• กำไรรวม: ฿${formatNumber(group.totalSaleValue)} - (${formatNumber(group.totalStockOut)} × ฿${formatNumber(group.avgCostPrice)}) = ฿${formatNumber(group.profitLoss)}</div>
                      </div>
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(detailsRow);
      });

      renderPagination();
      updatePaginationInfo();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
    
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = `page-link ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}`;
      prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };
      pagination.appendChild(prevBtn);

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `page-link ${i === currentPage ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => {
            currentPage = i;
            renderTable();
          };
          pagination.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          const dots = document.createElement('span');
          dots.className = 'px-2 text-gray-500';
          dots.textContent = '...';
          pagination.appendChild(dots);
        }
      }

      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = `page-link ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}`;
      nextBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
      pagination.appendChild(nextBtn);
    }

    function updatePaginationInfo() {
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(currentPage * itemsPerPage, filteredData.length);
    
      document.getElementById('showingFrom').textContent = filteredData.length > 0 ? start : 0;
      document.getElementById('showingTo').textContent = end;
      document.getElementById('totalRecords').textContent = filteredData.length;
    }

    function updateStats() {
      const totalItems = filteredData.length;
      let totalStockIn = 0;
      let totalStockOut = 0;
      let totalCostValue = 0;
      let totalSaleValue = 0;
      let totalNetQuantity = 0;
      let totalRemainingValue = 0;
    
      filteredData.forEach(group => {
        totalStockIn += group.totalStockIn;
        totalStockOut += group.totalStockOut;
        totalCostValue += group.totalCostValue;
        totalSaleValue += group.totalSaleValue;
        totalNetQuantity += group.netQuantity;
        totalRemainingValue += group.remainingValue;
      });

      // คำนวณกำไรรวม (ใช้วิธีคำนวณที่ถูกต้อง)
      let totalProfit = 0;
      filteredData.forEach(group => {
        totalProfit += group.profitLoss;
      });

      // คำนวณ average cost และ sale price รวม
      const avgCostPriceOverall = totalStockIn > 0 ? totalCostValue / totalStockIn : 0;
      const avgSalePriceOverall = totalStockOut > 0 ? totalSaleValue / totalStockOut : 0;

      // อัปเดตการ์ดสถิติ
      document.getElementById('totalItems').textContent = `${formatNumber(totalItems)} กลุ่มสินค้า`;
      document.getElementById('totalQuantity').innerHTML = `
        <div class="text-green-300 text-lg">เข้า: ${formatNumber(totalStockIn)}</div>
        <div class="text-red-300 text-lg">ออก: ${formatNumber(totalStockOut)}</div>
        <div class="text-xs opacity-80 mt-1">คงเหลือ: ${formatNumber(totalNetQuantity)} ชิ้น</div>
      `;
      document.getElementById('totalValue').innerHTML = `
        <div class="text-blue-300 font-bold">฿${formatNumber(totalCostValue)}</div>
        <div class="text-xs opacity-90">ต้นทุน (฿${formatNumber(avgCostPriceOverall)}/ชิ้น)</div>
        <div class="text-yellow-300 font-bold mt-1">฿${formatNumber(totalSaleValue)}</div>
        <div class="text-xs opacity-90">ขาย (฿${formatNumber(avgSalePriceOverall)}/ชิ้น)</div>
      `;
    
      document.getElementById('avgPrice').innerHTML = `
        <div class="text-xl font-bold ${totalProfit >= 0 ? 'text-green-300' : 'text-red-300'}">
          ${totalProfit >= 0 ? '+' : ''}฿${formatNumber(totalProfit)}
        </div>
        <div class="text-xs opacity-90 mt-1">กำไร/ขาดทุนรวม</div>
        <div class="text-xs opacity-80">คงเหลือ: ฿${formatNumber(totalRemainingValue)}</div>
      `;
    }

    function applyFilters() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const searchItem = document.getElementById('searchItem').value.toLowerCase();
      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

      filteredData = reportData.filter(group => {
        const itemDate = formatDateForComparison(group.latestDate);
        const matchDate = (!startDate || itemDate >= startDate) && (!endDate || itemDate <= endDate);
        const matchItem = !searchItem || group.productName.toLowerCase().includes(searchItem);
        const matchPrice = group.totalValue >= minPrice && group.totalValue <= maxPrice;
    
        return matchDate && matchItem && matchPrice;
      });

      currentPage = 1;
      renderTable();
      updateStats();
    }

    function formatDateForComparison(dateString) {
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    }

    function clearFilters() {
      // Reset form fields
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('searchItem').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
    
      // Reset data
      filteredData = [...reportData];
      currentPage = 1;
    
      renderTable();
      updateStats();
    }

    function sortData() {
      filteredData.sort((a, b) => {
        let aVal, bVal;
    
        switch(sortColumn) {
          case 'date':
            aVal = new Date(a.latestDate);
            bVal = new Date(b.latestDate);
            break;
          case 'item':
            aVal = a.productName.toLowerCase();
            bVal = b.productName.toLowerCase();
            break;
          case 'quantity':
            aVal = a.netQuantity;
            bVal = b.netQuantity;
            break;
          case 'price':
            aVal = a.totalValue;
            bVal = b.totalValue;
            break;
          default:
            return 0;
        }
    
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // ฟังก์ชันสำหรับแสดง/ซ่อนรายละเอียดของกลุ่ม
    function toggleGroupDetails(groupId) {
      const detailsRow = document.getElementById(`details-${groupId}`);
      const isHidden = detailsRow.classList.contains('hidden');
    
      if (isHidden) {
        detailsRow.classList.remove('hidden');
        detailsRow.classList.add('animate-fadeIn');
      } else {
        detailsRow.classList.add('hidden');
        detailsRow.classList.remove('animate-fadeIn');
      }
    }

    // ฟังก์ชันส่งออกข้อมูลของกลุ่ม
    function exportGroupData(groupId) {
      const group = reportData.find(g => g.id === groupId);
      if (!group) return;
    
      const data = group.items.map((item, index) => ({
        'ลำดับ': index + 1,
        'วันเดือนปี': formatDate(item.date),
        'ชื่อสินค้า': group.productName,
        'ประเภท': item.type === 'sales' ? 'ขายออก' : 'เข้าสต็อก',
        'จำนวน': Math.abs(item.quantity),
        'ราคา': item.price,
        'มูลค่า': Math.abs(item.quantity) * item.price,
        'SKU': item.sku || '',
        'Barcode': item.barcode || '',
        'สาขา': item.branch_code || '',
        'ลูกค้า': item.customer || ''
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `${group.productName}`);
      XLSX.writeFile(wb, `รายงาน_${group.productName}_${new Date().toISOString().split('T')[0]}.xlsx`);
    
      showMessage(`ส่งออกข้อมูล "${group.productName}" เรียบร้อยแล้ว`, 'success');
    }

    function openModal(item = null) {
      const modal = document.getElementById('itemModal');
      const title = document.getElementById('modalTitle');
      const form = document.getElementById('itemForm');
    
      if (item) {
        title.textContent = 'แก้ไขรายการ';
        document.getElementById('editItemId').value = item.id;
        document.getElementById('itemDate').value = item.date;
        document.getElementById('itemName').value = item.item;
        document.getElementById('itemQuantity').value = item.quantity;
        document.getElementById('itemPrice').value = item.price;
      } else {
        title.textContent = 'เพิ่มรายการใหม่';
        form.reset();
        document.getElementById('editItemId').value = '';
        document.getElementById('itemDate').value = new Date().toISOString().split('T')[0];
      }
    
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      const modal = document.getElementById('itemModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.getElementById('itemForm').reset();
    }

    function saveItem(e) {
      e.preventDefault();
    
      const formData = {
        date: document.getElementById('itemDate').value,
        item: document.getElementById('itemName').value,
        quantity: parseFloat(document.getElementById('itemQuantity').value),
        price: parseFloat(document.getElementById('itemPrice').value)
      };
    
      const editId = document.getElementById('editItemId').value;
    
      if (editId) {
        // Edit existing item
        const index = reportData.findIndex(item => item.id == editId);
        if (index !== -1) {
          reportData[index] = { ...reportData[index], ...formData };
        }
      } else {
        // Add new item
        const newId = Math.max(...reportData.map(item => item.id)) + 1;
        reportData.push({ id: newId, ...formData });
      }
    
      applyFilters(); // Refresh with current filters
      closeModal();
    
      // Show success message
      showMessage(editId ? 'แก้ไขรายการเรียบร้อยแล้ว' : 'เพิ่มรายการเรียบร้อยแล้ว', 'success');
    }

    function viewDetails(id) {
      const item = reportData.find(item => item.id === id);
      if (!item) return;
    
      let details = `
        <div class="space-y-3">
          <div><strong>รายการ:</strong> ${item.item}</div>
          <div><strong>วันที่:</strong> ${formatDate(item.date)}</div>
          <div><strong>จำนวน:</strong> ${formatNumber(Math.abs(item.quantity))} ${item.quantity < 0 ? '(ออก)' : '(เข้า)'}</div>
          <div><strong>ราคา:</strong> ฿${formatNumber(item.price)}</div>
          <div><strong>ประเภท:</strong> ${item.type === 'sales' ? 'ขายออก' : 'คงเหลือ'}</div>
      `;
    
      if (item.branch_code) {
        details += `<div><strong>สาขา:</strong> ${item.branch_code}</div>`;
      }
      if (item.sku) {
        details += `<div><strong>SKU:</strong> ${item.sku}</div>`;
      }
      if (item.barcode) {
        details += `<div><strong>Barcode:</strong> ${item.barcode}</div>`;
      }
      if (item.customer) {
        details += `<div><strong>ลูกค้า:</strong> ${item.customer}</div>`;
      }
    
      details += '</div>';
    
      // แสดง modal รายละเอียด
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">รายละเอียดสินค้า</h3>
            <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          ${details}
          <div class="mt-6 text-center">
            <button class="btn btn-primary" onclick="this.closest('.fixed').remove()">
              <i class="bi bi-check-circle"></i> ตกลง
            </button>
          </div>
        </div>
      `;
    
      document.body.appendChild(modal);
    }

    function editItem(id) {
      const item = reportData.find(item => item.id === id);
      if (item) {
        openModal(item);
      }
    }

    function deleteItem(id) {
      if (confirm('คุณต้องการลบรายการนี้หรือไม่?')) {
        reportData = reportData.filter(item => item.id !== id);
        applyFilters(); // Refresh with current filters
        showMessage('ลบรายการเรียบร้อยแล้ว', 'success');
      }
    }

    // ฟังก์ชันรีเฟรชข้อมูลจาก API
    function refreshData() {
      showMessage('กำลังรีเฟรชข้อมูล...', 'info');
      loadDataFromAPI();
    }

    // เพิ่มปุ่มรีเฟรชในส่วน action buttons
    document.addEventListener('DOMContentLoaded', function() {
      const actionButtons = document.querySelector('.action-buttons');
      if (actionButtons) {
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'btn btn-outline-primary';
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> รีเฟรชข้อมูล';
        refreshBtn.onclick = refreshData;
        actionButtons.appendChild(refreshBtn);
      }
    });

    function exportToExcel() {
      const data = [];
    
      filteredData.forEach((group, groupIndex) => {
        // เพิ่มแถวหัวข้อของกลุ่ม
        data.push({
          'ลำดับ': groupIndex + 1,
          'วันเดือนปี': formatDate(group.latestDate),
          'ชื่อสินค้า': `${group.productName} (กลุ่ม)`,
          'ประเภท': 'สรุปกลุ่ม',
          'จำนวนเข้า': group.totalStockIn,
          'จำนวนออก': group.totalStockOut,
          'คงเหลือสุทธิ': group.netQuantity,
          'มูลค่าต้นทุน': group.totalCostValue,
          'มูลค่าขาย': group.totalSaleValue,
          'กำไร_ขาดทุน': group.profitLoss,
          'อัตราส่วนกำไร_%': group.profitMargin,
          'ราคาต้นทุนเฉลี่ย': group.avgCostPrice,
          'ราคาขายเฉลี่ย': group.avgSalePrice,
          'กำไรต่อชิ้น': group.roiPerUnit,
          'Markup_%': group.markup,
          'มูลค่าคงเหลือ': group.remainingValue,
          'จำนวนรายการ': group.items.length
        });
    
        // เพิ่มรายละเอียดของแต่ละรายการ
        group.items.forEach((item, itemIndex) => {
          data.push({
            'ลำดับ': `${groupIndex + 1}.${itemIndex + 1}`,
            'วันเดือนปี': formatDate(item.date),
            'ชื่อสินค้า': group.productName,
            'ประเภท': item.type === 'sales' ? 'ขายออก' : 'เข้าสต็อก',
            'จำนวน': Math.abs(item.quantity),
            'ราคาต่อหน่วย': item.price,
            'มูลค่า': Math.abs(item.quantity) * item.price,
            'ประเภทราคา': item.type === 'sales' ? 'ราคาขาย' : 'ราคาต้นทุน',
            'ราคาต้นทุนเฉลี่ย': group.avgCostPrice,
            'ราคาขายเฉลี่ย': group.avgSalePrice,
            'กำไรต่อชิ้น': group.roiPerUnit,
            'SKU': item.sku || '',
            'Barcode': item.barcode || '',
            'สาขา': item.branch_code || '',
            'ลูกค้า': item.customer || ''
          });
        });
    
        // เพิ่มแถวว่างเพื่อแยกกลุ่ม
        data.push({});
      });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'รายงานต้นทุนและกำไร');
      XLSX.writeFile(wb, `รายงานต้นทุนและกำไร_${new Date().toISOString().split('T')[0]}.xlsx`);
    
      showMessage('ส่งออกข้อมูลต้นทุนและกำไร Excel เรียบร้อยแล้ว', 'success');
    }

    function exportToPDF() {
      const element = document.getElementById('reportTable').parentElement;
      const opt = {
        margin: 1,
        filename: `รายงานข้อมูลสินค้า_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      };
      html2pdf().set(opt).from(element).save();
    }

    function formatDate(dateString) {
      // รองรับทั้งรูปแบบ 2567-08-01 และ 2024-08-01
      const date = new Date(dateString);
      let year = date.getFullYear();
    
      // ถ้าเป็นปี ค.ศ. ให้แปลงเป็น พ.ศ.
      if (year < 2500) {
        year = year + 543;
      }
    
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${day}/${month}/${year}`;
    }

    function formatNumber(number) {
      return new Intl.NumberFormat('th-TH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(number);
    }

    function showMessage(message, type = 'info') {
      // Create and show a toast message
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      toast.textContent = message;
    
      document.body.appendChild(toast);
    
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

        icon.className = 'bi bi-moon-stars-fill mr-2 text-gray-700';
      }
    
      // Save preference
    }

    }
  </script>
  <!-- Account Menu Script -->
  <script src="/js/account-menu.js?v=light-v2"></script>
</body>
</html>