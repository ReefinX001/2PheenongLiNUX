<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" crossorigin />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Required Libraries for Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin defer></script>
  
  <!-- Add Thai calendar locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js" defer crossorigin></script>
  <script>
// Wait for dayjs to load before loading locale
if (typeof dayjs !== 'undefined') {
  var script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/dayjs@1.10.7/locale/th.js';
  document.head.appendChild(script);
}
</script>

  <script>
    const API_BASE = '/api';
    const token = (function(){try{return localStorage.getItem('authToken');}catch(e){return null;}})();
    
    function resolvePhotoUrl(raw) {
      if (!raw) return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
      if (/^https?:\/\//.test(raw)) return raw;
      if (raw.startsWith('data:')) return raw;
      if (raw.startsWith('/uploads/employees/')) return raw;
      if (raw.startsWith('/uploads/')) return raw.replace(/^\/uploads\//, '/uploads/employees/');
      return '/uploads/employees/' + raw;
    }
    
    async function fetchUserProfile() {
      try {
        // Skip if no token
        if (!token) {
          throw new Error('No token available');
        }
    
        const res = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
    
        // If unauthorized, just use fallback without logging error
        if (res.status === 401) {
          throw new Error('Unauthorized');
        }
    
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.message || 'Failed to load profile');
    
        const userName = json.data.name || json.data.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        const photoUrl = json.data.photoUrl || json.data.employee?.imageUrl || null;
        const userRole = json.data.role || json.data.position || json.data.department || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        const nameEl = document.getElementById('employeeName');
        const photoEl = document.getElementById('employeePhoto');
        if (nameEl) nameEl.textContent = userName;
        if (photoEl) photoEl.src = resolvePhotoUrl(photoUrl);
        localStorage.setItem('userName', userName);
        localStorage.setItem('userRole', userRole);
        if (photoUrl) localStorage.setItem('userPhoto', photoUrl);
      } catch (err) {
        // Silently use fallback data without console errors
        const fallbackName = (function(){try{return localStorage.getItem('userName');}catch(e){return null;}})() || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        const fallbackPhoto = (function(){try{return localStorage.getItem('userPhoto');}catch(e){return null;}})();
        const nameEl = document.getElementById('employeeName');
        const photoEl = document.getElementById('employeePhoto');
        if (nameEl) nameEl.textContent = fallbackName;
        if (photoEl) photoEl.src = resolvePhotoUrl(fallbackPhoto);
      }
    }
    
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
            }
          }
        },
      }
    };
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    #mainContent {
      flex: 1;
    }
    
    body {
      font-family: 'Prompt', sans-serif;
      font-size: 0.875rem;
      background-color: #f8f9fa;
    }
    
    .dark body {
      background-color: #1a202c;
      color: #f8f9fa;
    }
    
    .breadcrumb-item {
      color: #6c757d;
    }
    
    .breadcrumb-item a {
      color: #0ea5e9;
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .dark .card {
      background-color: #2d3748;
      border-color: #4a5568;
    }
    
    .form-control {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      width: 100%;
    }
    
    .dark .form-control {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
      transition: all 0.2s;
    }
    
    .btn-rounded {
      border-radius: 30px;
    }
    
    .btn-outline-primary {
      border: 1px solid #0ea5e9;
      color: #0ea5e9;
      background-color: white;
    }
    
    .btn-outline-primary:hover {
      background-color: #f0f9ff;
    }
    
    .dark .btn-outline-primary {
      color: #38bdf8;
      border-color: #38bdf8;
      background-color: transparent;
    }
    
    .dark .btn-outline-primary:hover {
      background-color: rgba(56, 189, 248, 0.1);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 1px solid #eee;
    }
    
    .dark .table th {
      background-color: #2d3748;
      color: #d1d5db;
      border-bottom-color: #4a5568;
    }
    
    .table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    
    .dark .table td {
      border-bottom-color: #4a5568;
      color: #f8f9fa;
    }
    
    .text-right {
      text-align: right;
    }
    
    .page-link {
      min-width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      margin: 0 2px;
    }
    
    .dark .page-link {
      border-color: #4a5568;
      color: #d1d5db;
    }
    
    .page-link:hover {
      background-color: #f9f9fb;
    }
    
    .dark .page-link:hover {
      background-color: #374151;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .page-link.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }

    .dark .page-link.active {
      background-color: #0284c7;
      color: white;
      border-color: #0284c7;
    }
    
    .account-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .account-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    
    .dark .account-list li {
      border-bottom-color: #4a5568;
    }
    
    .account-list li:hover {
      background-color: #f9f9fb;
    }
    
    .dark .account-list li:hover {
      background-color: #374151;
    }
    
    .account-list li.active {
      background-color: #f0f9ff;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .dark .account-list li.active {
      background-color: #1a4971;
      color: #38bdf8;
    }
    
    .date-range {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dark .date-range {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #f8f9fa;
    }
    
    .date-range:focus {
      border-color: #0ea5e9;
      outline: none;
    }
    
    .negative-value {
      color: #ef4444;
    }
    
    .dark .negative-value {
      color: #f87171;
    }
    
    .navbar {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 30; /* Lowered z-index for navbar if menu dropdowns need to be higher */
    }
    
    .dark .navbar {
      background-color: #1e293b;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .flex-1 {
      flex: 1;
    }
    
    .flex-none {
      flex: none;
    }
    
    .btn-fancy {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
    }
    
    .btn-fancy:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 1s;
    }
    
    .btn-fancy:active:after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: rgba(14, 165, 233, 0.1);
      border-radius: 30px;
    }
    
    .user-avatar {
      background-color: #0ea5e9;
      color: white;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }
    
    .dark .user-avatar {
      background-color: #38bdf8;
      color: #1a202c;
    }
    
    
    .expense-voucher {
      margin-left: 20px;
      position: relative;
    }
    
    .expense-voucher::before {
      content: '';
      position: absolute;
      left: -15px;
      top: 50%;
      width: 10px;
      height: 1px;
      background-color: #cbd5e0;
    }
    
    .dark .expense-voucher::before {
      background-color: #4a5568;
    }
    
    /* Income Statement specific styles */
    .fin-statement-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .fin-statement-table td {
      padding: 10px 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .dark .fin-statement-table td {
      border-bottom-color: #374151;
    }
    
    .fin-statement-table .item-title {
      font-weight: 500;
    }
    
    .fin-statement-table .bold {
      font-weight: 600;
    }
    
    .fin-statement-table .section-header {
      font-weight: 600;
      font-size: 1.05rem;
      color: #111827;
    }
    
    .dark .fin-statement-table .section-header {
      color: #f9fafb;
    }
    
    .fin-statement-table .section-total {
      font-weight: 600;
      color: #1e40af;
      background-color: #f0f9ff;
    }
    
    .dark .fin-statement-table .section-total {
      color: #93c5fd;
      background-color: #1e3a8a;
    }
    
    .fin-statement-table .grand-total {
      font-weight: 700;
      color: #0284c7;
      background-color: #e0f2fe;
      font-size: 1.05rem;
    }
    
    .dark .fin-statement-table .grand-total {
      color: #38bdf8;
      background-color: #075985;
    }
    
    .fin-statement-table .indent-1 {
      padding-left: 2rem;
    }
    
    .fin-statement-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .overview-card {
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      background-color: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dark .overview-card {
      background-color: #1e293b;
    }
    
    .overview-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .metric-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .dark .metric-label {
      color: #9ca3af;
    }
    
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
    }
    
    .dark .metric-value {
      color: #f9fafb;
    }
    
    .trend-up {
      color: #10b981;
    }
    
    .trend-down {
      color: #ef4444;
    }
    
    .dark .trend-up {
      color: #34d399;
    }
    
    .dark .trend-down {
      color: #f87171;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    .view-switcher {
      display: flex;
      padding: 0.25rem;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .dark .view-switcher {
      background-color: #374151;
    }
    
    .view-option {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .view-option.active {
      background-color: white;
      color: #0ea5e9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .dark .view-option.active {
      background-color: #1f2937;
      color: #38bdf8;
    }
    
    .action-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
      background-color: white;
      color: #374151;
      transition: all 0.2s;
    }
    
    .dark .action-button {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .action-button:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }
    
    .dark .action-button:hover {
      background-color: #374151;
      border-color: #6b7280;
    }
    
    .period-selector {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      background-color: white;
      font-size: 0.875rem;
      color: #374151;
      outline: none;
    }
    
    .dark .period-selector {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    /* Dashboard Card Styles */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background-color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .dark .dashboard-card {
      background-color: #1e293b;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .card-title {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .dark .card-title {
      color: #9ca3af;
    }
    
    .card-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    
    .dark .card-value {
      color: #f9fafb;
    }
    
    .comparison-value {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .comparison-up {
      color: #10b981;
    }
    
    .comparison-down {
      color: #ef4444;
    }
    
    .dark .comparison-up {
      color: #34d399;
    }
    
    .dark .comparison-down {
      color: #f87171;
    }
    
    /* Menu bar styles */
    .menu-bar {
      display: flex;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }
    
    .dark .menu-bar {
      background-color: #1e293b;
    }
    
    .menu-item {
      padding: 0.75rem 1.25rem;
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .menu-item:hover {
      background-color: #f3f4f6;
      color: #0ea5e9;
    }
    
    .dark .menu-item:hover {
      background-color: #334155;
    }
    
    .menu-item.active {
      border-bottom-color: #0ea5e9;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .menu-spacer {
      flex: 1;
    }
    
    .month-selector {
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 0.25rem 0.5rem;
      background-color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
    .dark .month-selector {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    /* Display toggle */
    .display-toggle {
      display: flex;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.25rem;
    }
    
    .dark .display-toggle {
      background-color: #334155;
    }
    
    .toggle-btn {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .toggle-btn.active {
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      color: #0ea5e9;
    }
    
    .dark .toggle-btn.active {
      background-color: #1f2937;
    }
    
    /* Financial table */
    .view-container {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .dark .view-container {
      background-color: #1e293b;
    }
    
    .hidden {
      display: none;
    }
    
    .financial-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .financial-table th {
      background-color: #f8f9fa;
      color: #6b7280;
      font-weight: 500;
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .dark .financial-table th {
      background-color: #1f2937;
      color: #d1d5db;
      border-bottom-color: #4b5563;
    }
    
    .financial-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .dark .financial-table td {
      border-bottom-color: #4b5563;
    }
    
    .financial-table .section-header {
      font-weight: 600;
      background-color: #f3f4f6;
      color: #111827;
      padding: 0.75rem 1rem;
    }
    
    .dark .financial-table .section-header {
      background-color: #374151;
      color: #f3f4f6;
    }
    
    .financial-table .subsection-header {
      font-weight: 500;
      color: #4b5563;
      padding: 0.75rem 1rem;
      background-color: #f9fafb;
    }
    
    .dark .financial-table .subsection-header {
      background-color: #1f2937;
      color: #e5e7eb;
    }
    
    .financial-table .amount {
      text-align: right;
      position: relative;
    }
    
    .financial-table .indent-1 {
      padding-left: 2rem;
    }
    
    .financial-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .financial-table .total-row {
      background-color: #e0f2fe;
      font-weight: 600;
    }
    
    .dark .financial-table .total-row {
      background-color: #0c4a6e;
    }
    
    .comparison-value {
      display: inline-block;
      margin-left: 0.5rem;
      font-size: 0.75rem;
      font-weight: normal;
    }

    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .financial-table {
        font-size: 0.875rem;
      }
      
      .menu-bar {
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      
      .card-value {
        font-size: 1.25rem;
      }
      
      .view-container {
        padding: 1rem;
      }
    }
    
    @media print {
      .navbar, .menu-bar, .display-toggle, .dashboard-cards {
        display: none;
      }
      
      .view-container {
        box-shadow: none;
        padding: 0;
      }
      
      body {
        font-size: 12pt;
      }
    }
    
    /* Thai Calendar Styles */
    .date-picker-container {
      position: relative;
      display: inline-block;
    }
    
    .date-picker-input {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
    }
    
    .dark .date-picker-input {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .thai-calendar {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      padding: 12px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 50;
      width: 280px;
      display: none;
    }
    
    .dark .thai-calendar {
      background-color: #1e293b;
      border-color: #4b5563;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .month-year {
      font-weight: 500;
      font-size: 1.05rem;
    }
    
    .nav-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6b7280;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
    .dark .nav-btn {
      color: #9ca3af;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 8px;
    }
    
    .day-name {
      text-align: center;
      font-weight: 500;
      color: #6b7280;
      font-size: 0.85rem;
      padding: 4px 0;
    }
    
    .dark .day-name {
      color: #9ca3af;
    }
    
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .date-cell {
      height: 36px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      margin: 1px;
    }
    
    .date-cell:hover:not(.disabled) {
      background-color: #f3f4f6;
      border-radius: 50%;
    }
    
    .dark .date-cell:hover:not(.disabled) {
      background-color: #374151;
    }
    
    .date-cell.disabled {
      color: #d1d5db;
      cursor: default;
      opacity: 0.4;
    }
    
    .dark .date-cell.disabled {
      color: #6b7280;
    }
    
    .date-cell.selected {
      background-color: #0ea5e9;
      color: white;
      border-radius: 50%;
    }
    
    .date-cell.today {
      border: 2px solid #0ea5e9;
      border-radius: 50%;
      font-weight: 500;
    }
    
    .dark .date-cell.today {
      border-color: #38bdf8;
    }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed !important;
      top: 0 !important; 
      left: 0 !important;
      width: 100vw !important; 
      height: 100vh !important;
      background: rgba(255, 255, 255, 0.9) !important;
      display: flex !important; 
      justify-content: center !important; 
      align-items: center !important;
      z-index: 9999 !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      pointer-events: auto !important;
    }

    .w-96 { width: 24rem !important; }
    .h-96 { height: 24rem !important; }
    .mx-auto { margin-left: auto !important; margin-right: auto !important; }
    .flex { display: flex !important; }
    .items-center { align-items: center !important; }
    .justify-center { justify-content: center !important; }

    /* Dropdown styles for asset management */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 40;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    .dark .dropdown-content {
      background-color: #1f2937;
      border-color: #4b5563;
    }

    .dropdown-content a {
      color: #374151;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .dark .dropdown-content a {
      color: #e5e7eb;
    }

    .dropdown-content a:hover {
      background-color: #f3f4f6;
    }

    .dark .dropdown-content a:hover {
      background-color: #374151;
    }

    .dropdown-content a:first-child {
      border-radius: 8px 8px 0 0;
    }

    .dropdown-content a:last-child {
      border-radius: 0 0 8px 8px;
    }

  </style>
  
<!-- Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->
  
  <link rel="stylesheet" href="/account/css/account-menu.css">

<script>
// Enhanced Input Validation and Sanitization
(function() {
  'use strict';

  // DOMPurify alternative - basic HTML sanitizer
  window.sanitizeHTML = function(dirty) {
    const config = {
      ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
      ALLOWED_ATTR: ['href', 'title'],
      KEEP_CONTENT: true
    };

    // Create a temporary element
    const temp = document.createElement('div');
    temp.textContent = dirty;
    return temp.innerHTML;
  };

  // SQL injection prevention - FIXED VERSION
  window.escapeSQLString = function(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/[\0\x08\x09\x1a\n\r"'\\%]/g, function(char) {
      switch (char) {
        case '\0': return '\\0';
        case '\x08': return '\\b';
        case '\x09': return '\\t';
        case '\x1a': return '\\Z';
        case '\n': return '\\n';
        case '\r': return '\\r';
        case '"': return '\\"';
        case "'": return "\\'";
        case '\\': return '\\\\';
        case '%': return '\\%';
        default: return char;
      }
    });
  };

  // Path traversal prevention
  window.sanitizePath = function(filepath) {
    if (typeof filepath !== 'string') return '';
    // Remove any path traversal attempts
    return filepath.replace(/\.\./g, '').replace(/[^\w\s\-\.\/]/gi, '');
  };

  // Email validation
  window.validateEmail = function(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  };

  // Phone number validation (Thai format)
  window.validateThaiPhone = function(phone) {
    const re = /^(0[689]{1})+([0-9]{8})$/;
    return re.test(String(phone).replace(/\D/g, ''));
  };

  // Amount/currency validation
  window.validateAmount = function(amount) {
    const num = parseFloat(amount);
    return !isNaN(num) && num >= 0 && num <= 999999999.99;
  };

  // Date validation
  window.validateDate = function(dateStr) {
    const date = new Date(dateStr);
    return date instanceof Date && !isNaN(date);
  };

  // Auto-sanitize all inputs on blur
  document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
    inputs.forEach(input => {
      input.addEventListener('blur', function() {
        this.value = sanitizeHTML(this.value);
      });
    });

    // Prevent form submission with invalid data
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', function(e) {
        let isValid = true;

        // Validate email fields
        const emailInputs = form.querySelectorAll('input[type="email"]');
        emailInputs.forEach(input => {
          if (input.value && !validateEmail(input.value)) {
            isValid = false;
            input.classList.add('border-red-500');
            console.error('Invalid email:', input.value);
          }
        });

        // Validate amount fields
        const amountInputs = form.querySelectorAll('input[data-type="amount"], input[data-type="currency"]');
        amountInputs.forEach(input => {
          if (input.value && !validateAmount(input.value)) {
            isValid = false;
            input.classList.add('border-red-500');
            console.error('Invalid amount:', input.value);
          }
        });

        if (!isValid) {
          e.preventDefault();
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å');
        }
      });
    });
  });

  // CSRF Token Management
  window.getCSRFToken = function() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
  };

  // Secure fetch wrapper with CSRF token
  window.secureFetch = function(url, options = {}) {
    const csrfToken = getCSRFToken();
    if (csrfToken) {
      options.headers = {
        ...options.headers,
        'X-CSRF-Token': csrfToken
      };
    }

    // Add timeout
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

    return fetch(url, {
      ...options,
      signal: controller.signal
    }).finally(() => clearTimeout(timeout));
  };

  // Rate limiting for API calls
  const rateLimiter = {
    calls: {},
    limit: 10, // max calls
    window: 60000, // per minute

    check: function(endpoint) {
      const now = Date.now();
      if (!this.calls[endpoint]) {
        this.calls[endpoint] = [];
      }

      // Remove old calls outside window
      this.calls[endpoint] = this.calls[endpoint].filter(time => now - time < this.window);

      if (this.calls[endpoint].length >= this.limit) {
        console.warn('Rate limit exceeded for:', endpoint);
        return false;
      }

      this.calls[endpoint].push(now);
      return true;
    }
  };

  // Override fetch to add rate limiting and suppress certain 401 errors
  const originalFetch = window.fetch;
  window.fetch = function(url, ...args) {
    const endpoint = new URL(url, window.location.origin).pathname;

    if (!rateLimiter.check(endpoint)) {
      return Promise.reject(new Error('Rate limit exceeded. Please wait before making another request.'));
    }

    // For user profile endpoint, suppress 401 errors
    if (endpoint === '/api/users/me') {
      return originalFetch.apply(this, [url, ...args]).then(response => {
        // If 401 on user profile, don't log to console
        if (response.status === 401) {
          response._suppress401 = true;
        }
        return response;
      }).catch(err => {
        // Suppress network errors for this endpoint
        if (endpoint === '/api/users/me') {
          return Promise.reject(err);
        }
        throw err;
      });
    }

    return originalFetch.apply(this, [url, ...args]);
  };

  // Session timeout warning
  let sessionTimeout;
  let warningTimeout;
  const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
  const WARNING_BEFORE = 5 * 60 * 1000; // 5 minutes before expiry

  function resetSessionTimer() {
    clearTimeout(sessionTimeout);
    clearTimeout(warningTimeout);

    warningTimeout = setTimeout(() => {
      if (confirm('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        // Refresh session
        secureFetch('/api/auth/refresh', { method: 'POST' });
        resetSessionTimer();
      }
    }, SESSION_DURATION - WARNING_BEFORE);

    sessionTimeout = setTimeout(() => {
      alert('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      window.location.href = '/login.html';
    }, SESSION_DURATION);
  }

  // Track user activity
  ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, resetSessionTimer, { passive: true });
  });

  resetSessionTimer();

  // Prevent clickjacking
  if (window.top !== window.self) {
    window.top.location = window.self.location;
  }

  // Disable right-click on sensitive elements
  document.addEventListener('contextmenu', function(e) {
    if (e.target.matches('input[type="password"], input[data-sensitive="true"]')) {
      e.preventDefault();
      return false;
    }
  });

  // Clear sensitive data on page unload
  window.addEventListener('beforeunload', function() {
    // Clear any sensitive form data
    const sensitiveInputs = document.querySelectorAll('input[type="password"], input[data-sensitive="true"]');
    sensitiveInputs.forEach(input => {
      input.value = '';
    });

    // Clear session storage of sensitive data
    const sensitiveKeys = ['tempPassword', 'tempToken', 'tempApiKey'];
    sensitiveKeys.forEach(key => {
      sessionStorage.removeItem(key);
    });
  });

  console.log('üîí Security enhancements loaded successfully');
})();
</script>
</head>

<body class="bg-white dark:bg-gray-900 dark:text-white w-full h-screen">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <div id="mainContent" class="w-full px-4 py-6 min-h-screen">
    <!-- Navbar -->
    <div class="navbar bg-white dark:bg-gray-800 shadow-md sticky top-0"> <!-- Removed z-30 from navbar, menu will handle z-index -->
      <div class="flex-1 flex items-center space-x-6">
        <img src="/uploads/Logo2.png"
             alt="Logo"
             class="rounded-full shadow-lg"
             style="width: 40px; height: 40px;" / loading="lazy">
        <span class="text-lg font-semibold">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</span>
        <!-- ‡∏à‡∏∏‡∏î‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏°‡∏ô‡∏π -->
        <div id="mainMenuContainer" class="ml-auto"></div> <!-- Added ml-auto to push menu towards center/right if space allows -->
      </div>
      <div class="flex-none flex items-center space-x-2">
  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
  <div class="flex items-center space-x-3 mr-4">
    <img id="employeePhoto" 
     alt="Profile" 
     class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=" loading="lazy">
    <span id="employeeName" class="text-sm font-medium text-gray-700 dark:text-gray-300">Loading...</span>
  </div>
  
  <button id="btnToggleDark" class="btn btn-rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">
    <i id="themeIcon" class="bi bi-moon-stars-fill mr-2 text-gray-700 dark:text-yellow-300"></i>
    <span id="darkModeLabel">Dark Mode</span>
  </button>
        <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy">
          <i class="bi bi-box-arrow-right mr-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    </div>

    <script>
    // Use the fetchUserProfile function already defined in the head section
    document.addEventListener('DOMContentLoaded', function () {
      // Show loading on page initialization
      showLoading(true);

      // Hide loading after initialization
      setTimeout(() => { showLoading(false); }, 1000);

      // Only fetch profile if we have a token
      const token = localStorage.getItem('authToken');
      if (token) {
      fetchUserProfile(); // Call the function that's already defined above
      } else {
        // Just set default values without fetching
        const nameEl = document.getElementById('employeeName');
        const photoEl = document.getElementById('employeePhoto');
        const fallbackName = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        const fallbackPhoto = localStorage.getItem('userPhoto');
        if (nameEl) nameEl.textContent = fallbackName;
        if (photoEl) photoEl.src = resolvePhotoUrl(fallbackPhoto);
      }
      const mainMenuContainer = document.getElementById('mainMenuContainer');
      const mainMenuTemplate = document.getElementById('mainMenuTemplate');
      if (mainMenuContainer && mainMenuTemplate) {
        mainMenuContainer.innerHTML = mainMenuTemplate.innerHTML;
      }
      loadAssetsData();
    });
    
    let chartOfAccounts = [];
    let currentAssetsData = []; // Store current assets data for individual exports
    
    async function loadAssetsData() {
      try {
        const tbody = document.querySelector('table tbody');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center py-6">
                <i class="bi bi-arrow-clockwise text-2xl" style="animation: spin 1s linear infinite;"></i>
                <div class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
              </td>
            </tr>
          `;
        }
    
        await loadChartOfAccounts();
        const response = await fetch('/api/assets?limit=50&sortBy=purchaseDate&sortOrder=desc&status=all');
        const result = await response.json();
    
        if (result.success && result.data) {
          currentAssetsData = result.data; // Store the data
          renderAssetsTable(result.data);
        } else {
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        console.error('Error loading assets data:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }
    
    async function loadChartOfAccounts() {
      try {
        const response = await fetch('/api/chart-of-accounts');
        const result = await response.json();
        if (result.success && result.data) {
          chartOfAccounts = result.data;
        }
      } catch (error) {
        console.error('Error loading chart of accounts:', error);
      }
    }
    
    function renderAssetsTable(assets) {
      const tbody = document.querySelector('table tbody');
      if (!tbody) return;
    
      if (assets.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-6 text-gray-500">
              <i class="bi bi-inbox text-3xl"></i>
              <div class="mt-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</div>
            </td>
          </tr>
        `;
        return;
      }
    
      tbody.innerHTML = assets.map(asset => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
          <td><input type="checkbox" value="${asset._id}" /></td>
          <td>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClasses(asset.status)}">
              ${getStatusDisplayText(asset.status)}
            </span>
          </td>
          <td class="font-medium">${asset.name}</td>
          <td>${getCategoryName(asset.category)}</td>
          <td>${formatDate(asset.purchaseDate)}</td>
          <td class="text-right font-mono">${formatCurrency(asset.totalPrice)}</td>
          <td class="text-right font-mono">${formatCurrency(asset.accumulatedDepreciation)}</td>
          <td class="text-right font-mono font-semibold">${formatCurrency(asset.bookValue)}</td>
          <td class="text-center">
            <div class="flex justify-center space-x-2">
              <button onclick="exportAssetToPDF('${asset._id}', '${asset.name}')" class="btn btn-sm bg-green-100 hover:bg-green-200 text-green-600 border-green-200" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF">
                <i class="bi bi-file-earmark-pdf"></i>
              </button>
              <div class="dropdown dropdown-end relative">
                <button onclick="toggleDropdown(this)" class="btn btn-sm bg-blue-100 hover:bg-blue-200 text-blue-600 border-blue-200">
                  <i class="bi bi-gear mr-1"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <i class="bi bi-chevron-down ml-1"></i>
                </button>
                <div class="dropdown-content">
                  <a onclick="changeAssetStatus('${asset._id}', 'active'); closeDropdown(this)" class="text-green-600">
                    <i class="bi bi-check-circle mr-2"></i> ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
                  </a>
                  <a onclick="changeAssetStatus('${asset._id}', 'inactive'); closeDropdown(this)" class="text-gray-600">
                    <i class="bi bi-pause-circle mr-2"></i> ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                  </a>
                  <a onclick="changeAssetStatus('${asset._id}', 'disposed'); closeDropdown(this)" class="text-red-600">
                    <i class="bi bi-trash mr-2"></i> ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                  </a>
                  <a onclick="changeAssetStatus('${asset._id}', 'sold'); closeDropdown(this)" class="text-blue-600">
                    <i class="bi bi-currency-dollar mr-2"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                  </a>
                </div>
              </div>
              <button onclick="deleteAsset('${asset._id}', '${asset.name}')" class="btn btn-sm bg-red-100 hover:bg-red-200 text-red-600 border-red-200">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function getCategoryName(categoryId) {
      if (!categoryId) return '-';
      const account = chartOfAccounts.find(acc => acc._id === categoryId);
      if (account) {
        return account.name;
      }
      if (typeof categoryId === 'string' && categoryId.length !== 24) {
        return categoryId;
      }
      return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
    }
    
    function getStatusClasses(status) {
      switch (status) {
        case 'active': return 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100';
        case 'inactive': return 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100';
        case 'disposed': return 'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100';
        case 'sold': return 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100';
        default: return 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100';
      }
    }
    
    function getStatusDisplayText(status) {
      switch (status) {
        case 'active': return '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà';
        case 'inactive': return '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        case 'disposed': return '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
        case 'sold': return '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
        default: return status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      }
    }
    
    async function changeAssetStatus(assetId, newStatus) {
      try {
        const response = await fetch(`/api/assets/${assetId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        const result = await response.json();
    
        if (result.success) {
          alert(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô "${getStatusDisplayText(newStatus)}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
          loadAssetsData();
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + (result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
        }
      } catch (error) {
        console.error('Error changing asset status:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
      }
    }
    
    async function deleteAsset(assetId, assetName) {
      if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå "${assetName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
        return;
      }
    
      try {
        const response = await fetch(`/api/assets/${assetId}`, { method: 'DELETE' });
        const result = await response.json();
    
        if (result.success) {
          alert('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          loadAssetsData();
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + (result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
        }
      } catch (error) {
        console.error('Error deleting asset:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå');
      }
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }
    
    function formatCurrency(amount) {
      if (amount === null || amount === undefined) return '0.00';
      return new Intl.NumberFormat('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }
    
    let lottieAnimation = null;

    function showLoading(show) {
      const loader = document.getElementById('loadingOverlay');
      if (show) {
        loader.style.display = 'flex';
        loader.classList.remove('animate__fadeOut');
        loader.classList.add('animate__fadeIn');
    
        if (!lottieAnimation) {
          console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
          fetch('/Loading/Loading.json')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(animationData => {
              lottieAnimation = lottie.loadAnimation({
                container: document.getElementById('lottieContainer'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: animationData
              });
              console.log('‚úÖ Lottie animation loaded successfully');
            })
            .catch(error => {
              console.error('‚ùå Error loading Lottie animation:', error);
              document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
            });
        } else {
          lottieAnimation.play();
        }
      } else {
        if (lottieAnimation) {
          lottieAnimation.pause();
        }
        loader.classList.remove('animate__fadeIn');
        loader.classList.add('animate__fadeOut');
        setTimeout(() => { loader.style.display = 'none'; }, 600);
      }
    }

    function showError(message) {
      const tbody = document.querySelector('table tbody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-6 text-red-500">
              <i class="bi bi-exclamation-triangle text-3xl"></i>
              <div class="mt-2">${message}</div>
              <button onclick="loadAssetsData()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                <i class="bi bi-arrow-clockwise mr-1"></i>‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </button>
            </td>
          </tr>
        `;
      }
    }
    
    function refreshAssets() {
      loadAssetsData();
    }
    
    function toggleDropdown(button) {
      const dropdown = button.nextElementSibling;
      const isVisible = dropdown.style.display === 'block';
      document.querySelectorAll('.dropdown-content').forEach(d => d.style.display = 'none');
      dropdown.style.display = isVisible ? 'none' : 'block';
    }
    
    function closeDropdown(element) {
      const dropdown = element.closest('.dropdown').querySelector('.dropdown-content');
      dropdown.style.display = 'none';
    }
    
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(d => d.style.display = 'none');
      }
    });

// Export individual asset to PDF using HTML template
async function exportAssetToPDF(assetId, assetName) {
  try {
    // Show loading
    showLoading(true);
    
  // Find the asset data
  const asset = currentAssetsData.find(a => a._id === assetId);
  if (!asset) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå');
      showLoading(false);
    return;
  }

    // Debug: Log asset data to understand structure
    console.log('Asset data:', asset);
    console.log('Supplier field:', asset.supplier);
    console.log('SupplierId field:', asset.supplierId);
    
    // Use hardcoded headquarters data
    const branchData = {
      name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
      isHeadquarters: true,
      branchCode: '00000',
      address: '148/91 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 6',
      subDistrict: '‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡∏π‡∏™‡∏∞‡∏°‡∏¥‡πÅ‡∏•',
      district: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
      province: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ',
      postalCode: '94000',
      taxId: '0945566000616',
      phone: '09-2427-0769',
      email: 'acc.2pheenong@gmail.com'
    };
    
    // Fetch supplier data if asset has supplier (which might be an ID)
    let supplierData = null;
    const supplierId = asset.supplierId || asset.supplier;
    
    // Check if supplier is an ID (MongoDB ObjectId format)
    const isObjectId = /^[a-f\d]{24}$/i.test(supplierId);
    
    if (supplierId && isObjectId) {
      try {
        const supplierResponse = await fetch(`/api/supplier/${supplierId}`);
        const supplierResult = await supplierResponse.json();
        if (supplierResult.success && supplierResult.data) {
          supplierData = supplierResult.data;
        }
      } catch (error) {
        console.error('Error fetching supplier data:', error);
      }
    }
    
    // Load the HTML template
    const response = await fetch('/account/pdf/paymentVoucher.html');
    let htmlTemplate = await response.text();
    
    // Calculate amounts first - check multiple possible field names
    let purchasePrice = parseFloat(asset.purchasePrice || asset.price || asset.cost || asset.amount) || 0;
    let vatAmount = parseFloat(asset.vat || asset.vatAmount || asset.tax) || 0;
    let totalAmount = parseFloat(asset.totalPrice || asset.total || asset.totalAmount) || 0;
    
    // If we have total and VAT but no purchase price, calculate it
    if (totalAmount > 0 && vatAmount > 0 && purchasePrice === 0) {
      purchasePrice = totalAmount - vatAmount;
    }
    // If we have total but no VAT and no purchase price, assume VAT is 7%
    else if (totalAmount > 0 && vatAmount === 0 && purchasePrice === 0) {
      purchasePrice = totalAmount / 1.07;
      vatAmount = totalAmount - purchasePrice;
    }
    // If we have purchase price but no VAT, calculate 7% VAT
    else if (purchasePrice > 0 && vatAmount === 0) {
      vatAmount = purchasePrice * 0.07;
      if (totalAmount === 0) {
        totalAmount = purchasePrice + vatAmount;
      }
    }
    // If we have purchase price and VAT but no total
    else if (purchasePrice > 0 && vatAmount > 0 && totalAmount === 0) {
      totalAmount = purchasePrice + vatAmount;
    }
    
    // Debug logging to check values
    console.log('Asset data for GL calculation:', {
      assetId: asset._id,
      assetName: asset.name,
      assetCode: asset.assetCode,
      originalData: {
        purchasePrice: asset.purchasePrice,
        vat: asset.vat,
        totalPrice: asset.totalPrice
      },
      calculatedValues: {
        purchasePrice,
        vatAmount,
        totalAmount
      },
      availableFields: Object.keys(asset)
    });
    
    // Check if we have valid amounts
    if (purchasePrice === 0 && vatAmount === 0 && totalAmount === 0) {
      console.warn('Warning: All amounts are zero for asset:', asset.name);
      console.warn('Available asset fields:', Object.keys(asset));
      console.table(asset); // Show all asset data in table format
    
      // Show user-friendly warning
      if (confirm(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå "${asset.name}" ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`)) {
        // Continue with zero values
      } else {
        // Cancel PDF generation
        showLoading(false);
        return;
      }
    }
    
    // Always log GL calculation for debugging
    console.log('GL Calculation Summary:', {
      assetName: asset.name,
      assetId: assetId,
      calculationMethod: {
        scenario: totalAmount > 0 && vatAmount > 0 && purchasePrice > 0 ? 'All values provided' :
                 totalAmount > 0 && vatAmount > 0 ? 'Calculated purchase price from total-vat' :
                 totalAmount > 0 ? 'Calculated from total with 7% VAT' :
                 purchasePrice > 0 ? 'Calculated VAT and total from purchase price' : 'No valid amounts'
      },
      glEntries: [
        { account: '1530-01', description: `${getCategoryName(asset.category)} - ${asset.name}`, debit: purchasePrice, credit: 0 },
        { account: '1154-00', description: '‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠', debit: vatAmount, credit: 0 },
        { account: '1111-01', description: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', debit: 0, credit: totalAmount }
      ],
      totals: { debit: purchasePrice + vatAmount, credit: totalAmount },
      balanced: Math.abs((purchasePrice + vatAmount) - totalAmount) < 0.01,
      amounts: {
        purchasePrice: formatCurrency(purchasePrice),
        vatAmount: formatCurrency(vatAmount),
        totalAmount: formatCurrency(totalAmount)
      }
    });
    
    const assetPurchaseDate = formatDate(asset.purchaseDate);
    
    // Replace data in HTML template before rendering
    // Company header is already hardcoded correctly in the template, just update phone number
    htmlTemplate = htmlTemplate.replace('‡πÇ‡∏ó‡∏£: acc.2pheenong@gmail.com', '‡πÇ‡∏ó‡∏£: 09-2427-0769');
    
    // Note: Document number will be replaced later with generated PV-YYYYMMXXX format
    
    // Replace vendor info
    let vendorName = '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î';
    let vendorTaxId = '0-1355-44005-28-1';
    
    if (supplierData) {
      vendorName = supplierData.name || vendorName;
      vendorTaxId = supplierData.taxId || vendorTaxId;
    } else if (asset.supplier && !isObjectId) {
      // If supplier is a string name, not an ID
      vendorName = asset.supplier;
    }
    
    htmlTemplate = htmlTemplate.replace('‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡πÇ‡∏≠‡∏¢‡∏π ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡πä‡∏õ ‡∏à‡∏≥‡∏Å‡∏±‡∏î', vendorName);
    htmlTemplate = htmlTemplate.replace('0-1355-44005-28-1 00244', vendorTaxId);
    
    // Replace vendor address
    const vendorAddress = supplierData ?
      `${supplierData.address || ''} ${supplierData.subDistrict || ''} ${supplierData.district || ''} ${supplierData.province || ''} ${supplierData.postalCode || ''}`.trim() :
      '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 5B 172 ‡∏ä‡∏±‡πâ‡∏ô 2 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 99 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ñ‡∏ô‡∏ô<br>‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô ‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á ‡∏Ñ‡∏π‡∏Ñ‡∏ï ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï ‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤<br>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ 12130';
    htmlTemplate = htmlTemplate.replace('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 5B 172 ‡∏ä‡∏±‡πâ‡∏ô 2 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 99 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ñ‡∏ô‡∏ô<br>‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô ‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á ‡∏Ñ‡∏π‡∏Ñ‡∏ï ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï ‡∏•‡∏≥‡∏•‡∏π‡∏Å‡∏Å‡∏≤<br>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ 12130', vendorAddress);
    
    // Replace dates and info
    const currentDate = new Date().toLocaleDateString('th-TH');
    htmlTemplate = htmlTemplate.replace(/30\/08\/2568/g, currentDate);
    htmlTemplate = htmlTemplate.replace(/30\/08\/2025/g, currentDate);
    
    // Get the actual creator of the asset from database
    let preparedByName = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    
    // Try to get the creator information from the asset data
    if (asset.createdBy) {
      try {
        if (typeof asset.createdBy === 'object' && asset.createdBy !== null) {
          // If createdBy is populated object from API
          preparedByName = asset.createdBy.name || asset.createdBy.username || asset.createdBy.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        } else if (typeof asset.createdBy === 'string' && asset.createdBy.length === 24) {
          // If createdBy is still an ObjectId, fetch user data
          const userResponse = await fetch(`/api/users/${asset.createdBy}`);
          const userResult = await userResponse.json();
          if (userResult.success && userResult.data) {
            preparedByName = userResult.data.name || userResult.data.username || userResult.data.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
          }
        }
      } catch (error) {
        console.error('Error getting creator information:', error);
        // Fallback to current user
        preparedByName = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      }
    } else {
      // Fallback to current user if no createdBy data
      preparedByName = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    }
    
    // Replace prepared by field with actual creator name
    htmlTemplate = htmlTemplate.replace('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', preparedByName);
    
    // Debug log to verify user data
    console.log('User Info for PDF:', {
      preparedByName: preparedByName,
      assetCreatedBy: asset.createdBy,
      source: 'database/localStorage fallback'
    });
    htmlTemplate = htmlTemplate.replace('60 ‡∏ß‡∏±‡∏ô', asset.creditTerm || '30 ‡∏ß‡∏±‡∏ô');
    
    // Replace payment method
    const paymentMethod = asset.paymentMethod === 'transfer' ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' :
                         asset.paymentMethod === 'cheque' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£' : '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
    htmlTemplate = htmlTemplate.replace('<div class="value">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>', `<div class="value">${paymentMethod}</div>`);
    
    // Replace main table data
    htmlTemplate = htmlTemplate.replace('EX-000000100', asset.assetCode || '-');
    htmlTemplate = htmlTemplate.replace('‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', asset.name);
    htmlTemplate = htmlTemplate.replace(/27,962\.62/g, formatCurrency(purchasePrice));
    htmlTemplate = htmlTemplate.replace(/1,957\.38/g, formatCurrency(vatAmount));
    htmlTemplate = htmlTemplate.replace(/29,920\.00/g, formatCurrency(totalAmount));
    
    // Replace payment details section
    const paymentDetailsText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${currentDate} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${formatCurrency(totalAmount)} ‡∏ö‡∏≤‡∏ó`;
    htmlTemplate = htmlTemplate.replace('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30/08/2025 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 29,920.00 ‡∏ö‡∏≤‡∏ó', paymentDetailsText);
    
    // Update payment checkboxes based on payment method
    if (asset.paymentMethod === 'transfer') {
      htmlTemplate = htmlTemplate.replace('<div class="checkbox checked"></div>', '<div class="checkbox"></div>'); // Remove check from cash
      htmlTemplate = htmlTemplate.replace('‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>\n                        <div style="font-size: 9px;">Bank Transfer</div>\n                    </div>\n                </div>\n                <div class="checkbox-item">\n                    <div class="checkbox">',
                                          '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>\n                        <div style="font-size: 9px;">Bank Transfer</div>\n                    </div>\n                </div>\n                <div class="checkbox-item">\n                    <div class="checkbox checked">');
    } else if (asset.paymentMethod === 'cheque') {
      htmlTemplate = htmlTemplate.replace('<div class="checkbox checked"></div>', '<div class="checkbox"></div>'); // Remove check from cash
      htmlTemplate = htmlTemplate.replace('‡πÄ‡∏ä‡πá‡∏Ñ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>\n                        <div style="font-size: 9px;">Cheque Bank</div>\n                    </div>\n                </div>\n                <div class="checkbox-item">\n                    <div class="checkbox">',
                                          '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>\n                        <div style="font-size: 9px;">Cheque Bank</div>\n                    </div>\n                </div>\n                <div class="checkbox-item">\n                    <div class="checkbox checked">');
    }
    
    // Replace GL account entries
    const categoryName = getCategoryName(asset.category);
    let assetAccountCode = '1530-01';
    let assetAccountName = categoryName || '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    
    // Update GL entries in the account table - replace the entire GL table rows
    // Find and replace the GL account table body
    const glTablePattern = /<tr>\s*<td class="text-center">5130-01<\/td>[\s\S]*?<\/tr>\s*<tr>\s*<td class="text-center">1154-00<\/td>[\s\S]*?<\/tr>\s*<tr>\s*<td class="text-center">1111-01<\/td>[\s\S]*?<\/tr>/;
    
    const glTableReplacement = `<tr>
                    <td class="text-center">${assetAccountCode}</td>
                    <td>${assetAccountName} - ${asset.name}</td>
                    <td class="text-right">${purchasePrice > 0 ? formatCurrency(purchasePrice) : '0.00'}</td>
                    <td class="text-right">0.00</td>
        </tr>
        <tr>
                    <td class="text-center">1154-00</td>
                    <td>‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠</td>
                    <td class="text-right">${vatAmount > 0 ? formatCurrency(vatAmount) : '0.00'}</td>
                    <td class="text-right">0.00</td>
        </tr>
        <tr>
                    <td class="text-center">1111-01</td>
                    <td>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</td>
                    <td class="text-right">0.00</td>
                    <td class="text-right">${totalAmount > 0 ? formatCurrency(totalAmount) : '0.00'}</td>
                </tr>`;
    
    htmlTemplate = htmlTemplate.replace(glTablePattern, glTableReplacement);
    
    // Generate document number for voucher - use only numeric values
    const year = new Date().getFullYear();
    const month = (new Date().getMonth()+1).toString().padStart(2,'0');
    // Convert last 3 characters of assetId to numeric only
    const assetIdNumeric = parseInt(assetId.substr(-6), 16).toString().substr(-3).padStart(3, '0');
    const documentNo = `PV-${year}${month}${assetIdNumeric}`;
    
    // Replace document number in voucher header
    htmlTemplate = htmlTemplate.replace('PP-000000104', documentNo);
    
    // Update GL table totals
    const glTotalsPattern = /<td colspan="2" style="font-weight: bold;">Journal No\. PV-[\d]+<\/td>\s*<td class="text-right" style="font-weight: bold; border-top: 2px solid black;">\s*‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br>[\d,]+\.[\d]+\s*<\/td>\s*<td class="text-right" style="font-weight: bold; border-top: 2px solid black;">\s*<br>[\d,]+\.[\d]+\s*<\/td>/;
    
    // Calculate GL totals correctly - must balance
    // Debit = Asset Cost + VAT
    // Credit = Total Payment
    const debitTotal = purchasePrice + vatAmount;
    const creditTotal = totalAmount;
    
    // Ensure balance - if not balanced, adjust
    if (Math.abs(debitTotal - creditTotal) > 0.01) {
      console.warn('GL not balanced:', { debitTotal, creditTotal, difference: debitTotal - creditTotal });
      // For display purposes, show the actual amounts but warn user
    }
    
    const glTotalsReplacement = `<td colspan="2" style="font-weight: bold;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                    <td class="text-right" style="font-weight: bold; border-top: 2px solid black;">
                        ${formatCurrency(debitTotal)}
          </td>
                    <td class="text-right" style="font-weight: bold; border-top: 2px solid black;">
                        ${formatCurrency(creditTotal)}
                    </td>`;
    
    htmlTemplate = htmlTemplate.replace(glTotalsPattern, glTotalsReplacement);
    
    // Update all signature dates to current date
    htmlTemplate = htmlTemplate.replace(/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà \/ Date 30\/08\/2568/g, `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / Date ${currentDate}`);
    
    // Add user name to signature section (optional - for reference)
    // Note: The signature section shows "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ / Prepared By" as a label,
    // the actual name is shown in the info table above
    
    // Create a new window with the modified template
    const printWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=no,resizable=no');
    
    // Add additional CSS to hide browser elements
    const enhancedTemplate = htmlTemplate.replace(
      '<style>',
      `<style>
        /* Hide browser elements */
        @media print {
          @page {
            size: A4;
            margin: 0.3in;
          }
          
          body {
            transform: scale(0.95);
            transform-origin: top left;
          }
        }
      `
    );
    
    printWindow.document.write(enhancedTemplate);
    printWindow.document.close();
    
    // Wait for content to load before printing
    printWindow.onload = function() {
      // Small delay to ensure all styles are applied
      setTimeout(() => {
        printWindow.focus();
    
        // Try to hide browser print headers/footers
        if (printWindow.print) {
          // For Chrome/Edge - try to set print options
          try {
            printWindow.print();
          } catch (e) {
            // Fallback to regular print
            printWindow.print();
          }
        }
    
        // Close window after printing (optional)
        printWindow.onafterprint = function() {
          printWindow.close();
        };
    
    // Hide loading
    showLoading(false);
      }, 500);
    };
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF');
    showLoading(false);
  }
}

// Export all assets to PDF using client-side generation
function exportToPDF() {
  const element = document.querySelector('.card');
  const opt = {
    margin: 10,
    filename: `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå_${new Date().toLocaleDateString('th-TH')}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };

  // Show loading
  showLoading(true);

  html2pdf().set(opt).from(element).save().then(() => {
    // Hide loading
    showLoading(false);
  }).catch(err => {
    console.error('Error generating PDF:', err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF');
    showLoading(false);
  });
}

// Export to Excel function
function exportToExcel() {
  try {
    // Get table data
    const table = document.querySelector('table');
    const rows = table.querySelectorAll('tr');
    const data = [];
    
    // Get headers (skip checkbox and action columns)
    const headers = ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'];
    data.push(headers);
    
    // Get data rows
    rows.forEach((row, index) => {
      if (index === 0) return; // Skip header row
    
      const cells = row.querySelectorAll('td');
      if (cells.length > 1) { // Skip empty rows
        const rowData = [
          cells[1]?.textContent.trim() || '', // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          cells[2]?.textContent.trim() || '', // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
          cells[3]?.textContent.trim() || '', // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
          cells[4]?.textContent.trim() || '', // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
          cells[5]?.textContent.trim() || '', // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
          cells[6]?.textContent.trim() || '', // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°
          cells[7]?.textContent.trim() || ''  // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        ];
        data.push(rowData);
      }
    });
    
    // Create workbook
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå');
    
    // Set column widths
    const wscols = [
      {wch: 15}, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      {wch: 30}, // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
      {wch: 20}, // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      {wch: 15}, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
      {wch: 15}, // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
      {wch: 15}, // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°
      {wch: 15}  // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    ];
    ws['!cols'] = wscols;
    
    // Save file
    const fileName = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
  }
}</script>

    <div class="w-full mt-6">
      <!-- Page Header -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold text-gray-800 dark:text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</h1>
        <div class="flex space-x-2">
          <button onclick="exportToPDF()" class="btn btn-outline-primary btn-sm btn-rounded">
            <i class="bi bi-file-earmark-pdf mr-1"></i> PDF
          </button>
          <button onclick="exportToExcel()" class="btn btn-outline-primary btn-sm btn-rounded">
            <i class="bi bi-file-earmark-excel mr-1"></i> Excel
          </button>
          <button onclick="loadAssetsData()" class="btn btn-outline-primary btn-sm btn-rounded">
            <i class="bi bi-arrow-clockwise mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
          <a href="purchase_asset" class="btn bg-primary-500 hover:bg-primary-600 text-white btn-sm btn-rounded">
            <i class="bi bi-plus-circle-fill mr-1"></i> ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà
          </a>
        </div>
      </div>
      
      <div class="card p-4">
        <div class="overflow-x-auto">
          <table class="table w-full min-w-full">
            <thead>
              <tr>
                <th><input type="checkbox" /></th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th>
                <th class="text-right">‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°</th>
                <th class="text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                <th class="text-center">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be loaded dynamically via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/account-menu.js"></script>

<script>
// Security Monitoring and Logging
(function() {
  'use strict';

  const securityLog = [];
  const MAX_LOG_SIZE = 100;

  // Log security events
  function logSecurityEvent(type, details) {
    const event = {
      timestamp: new Date().toISOString(),
      type: type,
      details: details,
      url: window.location.href,
      userAgent: navigator.userAgent
    };

    securityLog.push(event);

    // Keep log size manageable
    if (securityLog.length > MAX_LOG_SIZE) {
      securityLog.shift();
    }

    // Send critical events to server
    if (type === 'CRITICAL' || type === 'XSS_ATTEMPT' || type === 'SQL_INJECTION_ATTEMPT') {
      fetch('/api/security/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(event)
      }).catch(err => console.error('Failed to log security event:', err));
    }
  }

  // Monitor for XSS attempts
  const originalWrite = document.write;
  document.write = function() {
    logSecurityEvent('XSS_ATTEMPT', { method: 'document.write', content: arguments[0] });
    console.error('document.write blocked for security reasons');
  };

  // Monitor for suspicious eval usage
  window.eval = new Proxy(window.eval, {
    apply: function(target, thisArg, argumentsList) {
      logSecurityEvent('EVAL_USAGE', { code: argumentsList[0] });
      console.warn('eval usage detected - this is a security risk');
      return target.apply(thisArg, argumentsList);
    }
  });

  // Monitor console errors for security issues
  const originalError = console.error;
  console.error = function() {
    const message = Array.from(arguments).join(' ');
    if (message.includes('CSP') || message.includes('Security') || message.includes('CORS')) {
      logSecurityEvent('SECURITY_ERROR', { message: message });
    }
    originalError.apply(console, arguments);
  };

  // Detect and prevent common attacks
  document.addEventListener('DOMContentLoaded', function() {
    // Check for suspicious URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.forEach((value, key) => {
      // Check for potential XSS in URL parameters
      if (/<script|javascript:|on\w+=/i.test(value)) {
        logSecurityEvent('XSS_ATTEMPT', { source: 'URL_PARAM', key: key, value: value });
        // Clean the URL
        urlParams.delete(key);
        window.history.replaceState({}, '', window.location.pathname + '?' + urlParams.toString());
      }

      // Check for SQL injection patterns
      if (/(--|'|"|;|\/\*|\*\/|xp_|sp_|exec|execute|union|select|insert|update|delete|drop)/i.test(value)) {
        logSecurityEvent('SQL_INJECTION_ATTEMPT', { source: 'URL_PARAM', key: key, value: value });
      }
    });
  });

  // Export security log for debugging (only in development)
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.getSecurityLog = function() {
      return securityLog;
    };
  }
})();
</script>
<script>
// Clean up Lottie animation on page unload
window.addEventListener('beforeunload', () => {
  if (lottieAnimation) {
    lottieAnimation.destroy();
    lottieAnimation = null;
  }
});
</script>

</body>
</html>