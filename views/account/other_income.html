<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายได้อื่นๆ | ระบบบัญชี</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt', 'sans-serif'] },
          colors: { primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', } }
        }
      }
    }
  </script>

  <style>
    * { font-family: 'Prompt', sans-serif; }
    body { background-color: #f8fafc; margin: 0; padding: 0; }
    .loading-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background: rgba(255, 255, 255, 0.98) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 999999 !important; backdrop-filter: blur(12px) !important; -webkit-backdrop-filter: blur(12px) !important; transition: opacity 0.5s ease-out, visibility 0.5s ease-out !important; pointer-events: auto !important; }
    .loading-overlay.hiding { opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; }
    .navbar { display: flex; align-items: center; justify-content: space-between; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 30; padding: 0.5rem 1rem; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 1.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .stat-card.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.green { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .table-container { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .table { margin-bottom: 0; }
    .table thead th { background-color: #f8fafc; border-bottom: 2px solid #e2e8f0; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; color: #64748b; padding: 1rem; }
    .table tbody td { padding: 1rem; vertical-align: middle; }
    .table tbody tr:hover { background-color: #f8fafc; }
    .badge { padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .btn-action { padding: 0.375rem 0.75rem; font-size: 0.875rem; border-radius: 6px; transition: all 0.2s; }
    .btn-action:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .pagination { margin-bottom: 0; }
    .page-link { border-radius: 6px; margin: 0 2px; border: 1px solid #e2e8f0; color: #64748b; }
    .page-link:hover { background-color: #f8fafc; border-color: #0ea5e9; color: #0ea5e9; }
    .page-item.active .page-link { background-color: #0ea5e9; border-color: #0ea5e9; }
    .empty-state { text-align: center; padding: 3rem; color: #64748b; }
    .empty-state i { font-size: 4rem; color: #cbd5e1; margin-bottom: 1rem; }
    #btnLogout { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: #0ea5e9; background-color: white; border: 1px solid #0ea5e9; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; }
    #btnLogout:hover { background-color: #0ea5e9; color: white; }
    #btnLogout:active { transform: scale(0.98); }
    @media print { .navbar, .filters, .pagination, .btn-action { display: none !important; } }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeIn" style="display: flex;">
    <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
      <div id="lottieContainer" style="width: 300px; height: 300px;"></div>
    </div>
  </div>

  <div class="navbar bg-white shadow-md sticky top-0 z-30 px-4 py-2">
    <div class="flex-1 flex items-center space-x-6">
      <a href="/account/accounting_dashboard.html" class="flex items-center space-x-2">
        <i class="bi bi-cash-coin text-primary" style="font-size: 1.5rem;"></i>
        <span class="text-lg font-semibold">รายได้อื่นๆ</span>
      </a>
      <div id="mainMenuContainer" class="ml-auto"></div>
    </div>
    <div class="flex-none flex items-center space-x-2">
      <div class="flex items-center space-x-3 mr-4">
        <img id="employeePhoto" alt="Profile" class="w-10 h-10 rounded-full border-2 border-gray-300" src="" loading="lazy">
        <span id="employeeName" class="text-sm font-medium text-gray-700">กำลังโหลด...</span>
      </div>
      <button id="btnLogout" class="btn btn-outline btn-primary btn-sm">
        <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
      </button>
    </div>
  </div>

  <div class="container-fluid px-4 py-6">
    <div class="row g-4 mb-6">
      <div class="col-md-4">
        <div class="stat-card blue">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">จำนวนรายการ</div>
              <div class="text-3xl font-bold" id="totalRecords">0</div>
            </div>
            <i class="bi bi-cash-coin fs-1"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card green">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">รายได้รวม</div>
              <div class="text-3xl font-bold" id="totalAmount">฿0.00</div>
            </div>
            <i class="bi bi-graph-up fs-1"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card orange">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">ยอดสุทธิ</div>
              <div class="text-3xl font-bold" id="totalNetAmount">฿0.00</div>
            </div>
            <i class="bi bi-wallet2 fs-1"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4 filters">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label text-sm font-medium">ค้นหา</label>
            <input type="text" id="searchInput" class="form-control" placeholder="เลขที่เอกสาร, รายละเอียด...">
          </div>
          <div class="col-md-2">
            <label class="form-label text-sm font-medium">หมวดหมู่</label>
            <select id="categoryFilter" class="form-select">
              <option value="">ทั้งหมด</option>
              <option value="ดอกเบี้ยรับ">ดอกเบี้ยรับ</option>
              <option value="เงินปันผล">เงินปันผล</option>
              <option value="กำไรจากการขายสินทรัพย์">กำไรจากการขายสินทรัพย์</option>
              <option value="รายได้ค่าเช่า">รายได้ค่าเช่า</option>
              <option value="รายได้ค่าบริการ">รายได้ค่าบริการ</option>
              <option value="รายได้อื่นๆ">รายได้อื่นๆ</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label text-sm font-medium">วันที่เริ่มต้น</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label text-sm font-medium">วันที่สิ้นสุด</label>
            <input type="date" id="endDate" class="form-control">
          </div>
          <div class="col-md-3 d-flex align-items-end gap-2">
            <button id="btnSearch" class="btn btn-primary flex-grow-1">
              <i class="bi bi-search me-1"></i> ค้นหา
            </button>
            <button id="btnReset" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button id="btnCreate" class="btn btn-success">
              <i class="bi bi-plus-lg me-1"></i> สร้างใหม่
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="tableContainer" class="table-container" style="display: none;">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>เลขที่เอกสาร</th>
            <th>วันที่</th>
            <th>หมวดหมู่</th>
            <th>รายละเอียด</th>
            <th>จำนวนเงิน</th>
            <th>VAT</th>
            <th>รวมทั้งสิ้น</th>
            <th>สถานะ</th>
            <th>การดำเนินการ</th>
          </tr>
        </thead>
        <tbody id="incomeTableBody"></tbody>
      </table>
      <div class="d-flex justify-content-between align-items-center p-3 border-top">
        <div class="text-sm text-muted">
          แสดง <span id="showingStart">0</span> - <span id="showingEnd">0</span> จาก <span id="totalItems">0</span> รายการ
        </div>
        <nav>
          <ul class="pagination mb-0" id="pagination"></ul>
        </nav>
      </div>
    </div>

    <div id="emptyState" class="card" style="display: none;">
      <div class="card-body empty-state">
        <i class="bi bi-inbox"></i>
        <h5 class="mt-3">ไม่พบข้อมูล</h5>
        <p class="text-muted">ไม่พบรายได้อื่นที่ค้นหา</p>
      </div>
    </div>

    <div id="errorState" class="card" style="display: none;">
      <div class="card-body empty-state">
        <i class="bi bi-exclamation-triangle text-danger"></i>
        <h5 class="mt-3 text-danger">เกิดข้อผิดพลาด</h5>
        <p class="text-muted">ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง</p>
        <button onclick="location.reload()" class="btn btn-primary mt-2">
          <i class="bi bi-arrow-clockwise me-1"></i> โหลดใหม่
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="/js/account-menu.js?v=light-v2"></script>

  <script>
    let currentPage = 1;
    const limit = 20;
    let searchTimeout = null;

    document.addEventListener('DOMContentLoaded', function() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const lottieContainer = document.getElementById('lottieContainer');
      if (lottieContainer && typeof lottie !== 'undefined') {
        try {
          const animation = lottie.loadAnimation({ container: lottieContainer, renderer: 'svg', loop: true, autoplay: true, path: '/Loading/Loading.json' });
          animation.addEventListener('data_failed', () => { console.error('Failed to load Lottie animation'); if (loadingOverlay) loadingOverlay.style.display = 'none'; });
          animation.addEventListener('DOMLoaded', () => { console.log('✅ Lottie animation loaded successfully'); });
        } catch (error) { console.error('Error initializing Lottie:', error); if (loadingOverlay) loadingOverlay.style.display = 'none'; }
      }
    });

    function hidePageLoading() { const loadingOverlay = document.getElementById('loadingOverlay'); if (loadingOverlay) { loadingOverlay.classList.add('hiding'); setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500); } }
    function showPageLoading() { const loadingOverlay = document.getElementById('loadingOverlay'); if (loadingOverlay) { loadingOverlay.style.display = 'flex'; loadingOverlay.classList.remove('hiding'); } }
    function getAuthToken() { return localStorage.getItem('authToken') || localStorage.getItem('token') || sessionStorage.getItem('token'); }
    function handleAuthError() { localStorage.removeItem('authToken'); localStorage.removeItem('token'); sessionStorage.removeItem('token'); window.location.href = '/login'; }
    function formatCurrency(amount) { return '฿' + (amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function formatDateThai(dateString) { if (!dateString) return '-'; const date = new Date(dateString); return date.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' }); }
    function getStatusBadge(status) { const badges = { 'confirmed': '<span class="badge bg-success">ยืนยันแล้ว</span>', 'draft': '<span class="badge bg-warning">แบบร่าง</span>', 'cancelled': '<span class="badge bg-danger">ยกเลิก</span>' }; return badges[status] || '<span class="badge bg-secondary">ไม่ทราบสถานะ</span>'; }
    function loadUserProfile() { const userName = localStorage.getItem('userName') || 'ผู้ใช้งาน'; const userPhoto = localStorage.getItem('userPhoto') || '/images/default-avatar.png'; document.getElementById('employeeName').textContent = userName; document.getElementById('employeePhoto').src = userPhoto; document.getElementById('employeePhoto').onerror = function() { this.src = '/images/default-avatar.png'; }; }

    const btnLogout = document.getElementById('btnLogout');
    if (btnLogout) { btnLogout.addEventListener('click', function() { if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) { localStorage.removeItem('authToken'); localStorage.removeItem('token'); sessionStorage.removeItem('token'); localStorage.removeItem('userName'); localStorage.removeItem('userPhoto'); showPageLoading(); setTimeout(() => { window.location.href = '/login'; }, 500); } }); }

    async function loadStatistics() {
      const token = getAuthToken();
      if (!token) { handleAuthError(); return; }
      try {
        const response = await fetch('/api/other-income/statistics', { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
        if (response.status === 401) { handleAuthError(); return; }
        if (!response.ok) throw new Error('Failed to load statistics');
        const result = await response.json();
        const data = result.data || {};
        document.getElementById('totalRecords').textContent = data.totalRecords || 0;
        document.getElementById('totalAmount').textContent = formatCurrency(data.totalAmount || 0);
        document.getElementById('totalNetAmount').textContent = formatCurrency(data.totalNetAmount || 0);
      } catch (error) { console.error('Error loading statistics:', error); }
    }

    async function loadIncomeRecords(page = 1) {
      const token = getAuthToken();
      if (!token) { handleAuthError(); return; }
      currentPage = page;
      document.getElementById('tableContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      const params = new URLSearchParams();
      params.append('page', page);
      params.append('limit', limit);
      params.append('status', 'confirmed');
      const searchQuery = document.getElementById('searchInput')?.value.trim();
      if (searchQuery) params.append('search', searchQuery);
      const category = document.getElementById('categoryFilter')?.value;
      if (category) params.append('category', category);
      const startDate = document.getElementById('startDate')?.value;
      if (startDate) params.append('startDate', startDate);
      const endDate = document.getElementById('endDate')?.value;
      if (endDate) params.append('endDate', endDate);
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(`/api/other-income?${params}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, signal: controller.signal });
        clearTimeout(timeoutId);
        if (response.status === 401) { handleAuthError(); return; }
        if (!response.ok) throw new Error('Failed to load income records');
        const result = await response.json();
        if (!result.data || result.data.length === 0) { document.getElementById('emptyState').style.display = 'block'; return; }
        displayIncomeRecords(result.data);
        displayPagination(result.pagination);
        document.getElementById('tableContainer').style.display = 'block';
      } catch (error) { console.error('Error loading income records:', error); document.getElementById('errorState').style.display = 'block'; }
    }

    function displayIncomeRecords(records) {
      const tbody = document.getElementById('incomeTableBody');
      tbody.innerHTML = '';
      records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `<td class="font-medium">${record.documentNumber || '-'}</td><td>${formatDateThai(record.date)}</td><td>${record.category || '-'}</td><td>${record.description || '-'}</td><td>${formatCurrency(record.amount || 0)}</td><td>${formatCurrency(record.vatAmount || 0)}</td><td class="font-semibold">${formatCurrency(record.totalAmount || 0)}</td><td>${getStatusBadge(record.status)}</td><td><div class="btn-group btn-group-sm"><button onclick="viewIncome('${record._id}')" class="btn btn-info btn-action" title="ดูรายละเอียด"><i class="bi bi-eye"></i></button><button onclick="editIncome('${record._id}')" class="btn btn-warning btn-action" title="แก้ไข"><i class="bi bi-pencil"></i></button>${record.status !== 'cancelled' ? `<button onclick="deleteIncome('${record._id}')" class="btn btn-danger btn-action" title="ลบ"><i class="bi bi-trash"></i></button>` : ''}</div></td>`;
        tbody.appendChild(row);
      });
    }

    function displayPagination(pagination) {
      const paginationElement = document.getElementById('pagination');
      paginationElement.innerHTML = '';
      const { page, pages, total } = pagination;
      const start = (page - 1) * limit + 1;
      const end = Math.min(page * limit, total);
      document.getElementById('showingStart').textContent = start;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('totalItems').textContent = total;
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${page > 1 ? `loadIncomeRecords(${page - 1})` : ''}">ก่อนหน้า</a>`;
      paginationElement.appendChild(prevLi);
      const maxButtons = 5;
      let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
      let endPage = Math.min(pages, startPage + maxButtons - 1);
      if (endPage - startPage < maxButtons - 1) { startPage = Math.max(1, endPage - maxButtons + 1); }
      for (let i = startPage; i <= endPage; i++) { const li = document.createElement('li'); li.className = `page-item ${i === page ? 'active' : ''}`; li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadIncomeRecords(${i})">${i}</a>`; paginationElement.appendChild(li); }
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${page === pages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${page < pages ? `loadIncomeRecords(${page + 1})` : ''}">ถัดไป</a>`;
      paginationElement.appendChild(nextLi);
    }

    function viewIncome(id) { window.location.href = `/account/other_income_detail.html?id=${id}`; }
    function editIncome(id) { window.location.href = `/account/other_income_edit.html?id=${id}`; }
    async function deleteIncome(id) { if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?')) { return; } const token = getAuthToken(); if (!token) { handleAuthError(); return; } try { const response = await fetch(`/api/other-income/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } }); if (response.ok) { alert('ลบรายการเรียบร้อยแล้ว'); loadIncomeRecords(currentPage); loadStatistics(); } else { alert('ไม่สามารถลบรายการได้'); } } catch (error) { console.error('Error deleting income:', error); alert('เกิดข้อผิดพลาดในการลบรายการ'); } }
    function createNewIncome() { window.location.href = '/account/other_income_create.html'; }

    document.getElementById('searchInput')?.addEventListener('input', function() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { loadIncomeRecords(1); }, 500); });
    document.getElementById('categoryFilter')?.addEventListener('change', function() { loadIncomeRecords(1); });
    document.getElementById('startDate')?.addEventListener('change', function() { loadIncomeRecords(1); });
    document.getElementById('endDate')?.addEventListener('change', function() { loadIncomeRecords(1); });
    document.getElementById('btnSearch')?.addEventListener('click', function() { loadIncomeRecords(1); });
    document.getElementById('btnReset')?.addEventListener('click', function() { document.getElementById('searchInput').value = ''; document.getElementById('categoryFilter').value = ''; document.getElementById('startDate').value = ''; document.getElementById('endDate').value = ''; loadIncomeRecords(1); });
    document.getElementById('btnCreate')?.addEventListener('click', createNewIncome);

    window.addEventListener('DOMContentLoaded', async function() {
      console.log('🚀 Initializing other income page...');
      try {
        loadUserProfile();
        await Promise.all([ loadStatistics(), loadIncomeRecords(1) ]);
        console.log('✅ Page initialized successfully');
      } catch (error) { console.error('❌ Error initializing page:', error); } finally { setTimeout(() => { hidePageLoading(); }, 1000); }
    });
  </script>
</body>
</html>
