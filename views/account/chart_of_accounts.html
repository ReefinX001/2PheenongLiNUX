<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<link rel="stylesheet" href="/account/chart_of_accounts.css" />

  <!-- Required Libraries for Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/locale/th.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
            }
          }
        },
      }
    };
  </script>

     <!-- Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π -->

  <style>
    /* Loading overlay styles */
    .loading-overlay {
      position: fixed !important;
      top: 0 !important; 
      left: 0 !important;
      width: 100vw !important; 
      height: 100vh !important;
      background: rgba(255, 255, 255, 0.9) !important;
      display: flex !important; 
      justify-content: center !important; 
      align-items: center !important;
      z-index: 9999 !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      pointer-events: auto !important;
    }

    .w-96 { width: 24rem !important; }
    .h-96 { height: 24rem !important; }
    .mx-auto { margin-left: auto !important; margin-right: auto !important; }
    .flex { display: flex !important; }
    .items-center { align-items: center !important; }
    .justify-center { justify-content: center !important; }
  </style>

  <!-- Account Menu Styles -->
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">
</head>

<body class="bg-white w-full h-screen">
  <script>
    // Force remove dark mode
    document.documentElement.classList.remove('dark');
    document.body.classList.remove('dark');
    localStorage.removeItem('darkMode');
    localStorage.setItem('theme', 'light');
  </script>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeOut" style="display: none;">
    <div class="text-center">
      <div id="lottieContainer" class="w-96 h-96 mx-auto flex items-center justify-center"></div>
    </div>
  </div>
  <div id="mainContent" class="container mx-auto px-4 py-6">
    <!-- Navbar -->
    <!-- Account System Navbar Template -->
<div class="navbar bg-white shadow-md sticky top-0">
  <div class="flex-1 flex items-center space-x-6">
    <img src="/uploads/Logo2.png"
         alt="Logo"
         class="rounded-full shadow-lg"
         style="width: 40px; height: 40px;" />
    <span class="text-lg font-semibold" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
    <!-- Menu Container -->
    <div id="mainMenuContainer" class="ml-auto"></div>
  </div>
  <div class="flex-none flex items-center space-x-2">
    <!-- User Profile Section -->
    <div class="flex items-center space-x-3 mr-4">
      <img id="employeePhoto"
           alt="Profile"
           class="w-10 h-10 rounded-full border-2 border-gray-300"
           src="/img/default-avatar.svg">
      <span id="employeeName" class="text-sm font-medium text-gray-700">Loading...</span>
    </div>


    <!-- Logout Button -->
    <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy">
      <i class="bi bi-box-arrow-right mr-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="loader"></div>
</div>

<script>
  // === 1. API Configuration ===
  const API_BASE_URL = '/api';
  const AUTH_TOKEN = localStorage.getItem('token');
  
  // === 2. API Helper Function ===
  async function apiCall(endpoint, options = {}) {
  try {
    // Check if we have a valid API URL
    if (!API_BASE_URL) {
      throw new Error('API base URL is not configured');
    }
  
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`,
        ...options.headers
      }
    });
  
    if (!response.ok) {
      throw new Error(`API Error: ${response.status} ${response.statusText}`);
    }
  
    return await response.json();
  } catch (error) {
    console.error('API Call Error:', error);
  
    // Provide more specific error messages
    if (error.message.includes('Failed to fetch')) {
      throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
    }
  
    throw error;
  }
}
  
  // === 3. Utility Functions ===
  let lottieAnimation = null;

  function showLoading(show) {
    const loader = document.getElementById('loadingOverlay');
    if (show) {
      loader.style.display = 'flex';
      loader.classList.remove('animate__fadeOut');
      loader.classList.add('animate__fadeIn');
  
      if (!lottieAnimation) {
        console.log('üîÑ Loading Lottie animation from /Loading/Loading.json');
        fetch('/Loading/Loading.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(animationData => {
            lottieAnimation = lottie.loadAnimation({
              container: document.getElementById('lottieContainer'),
              renderer: 'svg',
              loop: true,
              autoplay: true,
              animationData: animationData
            });
            console.log('‚úÖ Lottie animation loaded successfully');
          })
          .catch(error => {
            console.error('‚ùå Error loading Lottie animation:', error);
            document.getElementById('lottieContainer').innerHTML = '<div class="loading loading-spinner loading-lg"></div>';
          });
      } else {
        lottieAnimation.play();
      }
    } else {
      if (lottieAnimation) {
        lottieAnimation.pause();
      }
      loader.classList.remove('animate__fadeIn');
      loader.classList.add('animate__fadeOut');
      setTimeout(() => { loader.style.display = 'none'; }, 600);
    }
  }

  function hideLoading() {
    showLoading(false);
  }
  
  function showSuccess(message) {
    // TODO: ‡πÉ‡∏ä‡πâ toast library ‡πÅ‡∏ó‡∏ô alert
    alert('‚úÖ ' + message);
  }
  
  function showError(message) {
    alert('‚ùå ' + message);
  }

async function loadEmployeeProfile() {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
    const token = localStorage.getItem('authToken') ||
                  localStorage.getItem('token') ||
                  sessionStorage.getItem('token');
  
    if (!token) {
      console.warn('No authentication token found');
      setDefaultProfile();
      return;
    }

    // ‡πÉ‡∏ä‡πâ endpoint ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const response = await fetch('/api/users/me', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      if (response.status === 401) {
        console.warn('Token expired or invalid');
        clearAuthData();
        setDefaultProfile();
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
        return;
      }
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
  
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö response format
    let userData;
    if (data.success && data.data) {
      userData = data.data;
    } else {
      userData = data;
    }
  
    // Update UI - ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ field ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const employeeName = userData.name || userData.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    document.getElementById('employeeName').textContent = employeeName;
  
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢ field
    let imageUrl = userData.imageUrl ||
                   userData.photoUrl ||
                   userData.image ||
                   userData.profileImage ||
                   userData.profile_image ||
                   userData.avatar;
  
    if (imageUrl) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!imageUrl.startsWith('http')) {
        imageUrl = imageUrl.startsWith('/') ? imageUrl : '/uploads/' + imageUrl;
      }
  
      const img = document.getElementById('employeePhoto');
      img.onerror = function() {
        this.src = '/static/images/avatar-placeholder.png';
      };
      img.src = imageUrl;
    } else {
      // ‡πÉ‡∏ä‡πâ placeholder
      document.getElementById('employeePhoto').src = '/static/images/avatar-placeholder.png';
    }
  
  } catch (error) {
    console.error('Error loading employee profile:', error);
    setDefaultProfile();
  
    if (error.message.includes('Failed to fetch')) {
      console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
    }
  }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° function clearAuthData ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
function clearAuthData() {
  localStorage.removeItem('token');
  localStorage.removeItem('authToken');
  localStorage.removeItem('userId');
  localStorage.removeItem('userName');
  sessionStorage.clear();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setDefaultProfile
function setDefaultProfile() {
  const nameEl = document.getElementById('employeeName');
  const imgEl = document.getElementById('employeePhoto');
  if (nameEl) nameEl.textContent = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
  if (imgEl) imgEl.src = '/static/images/avatar-placeholder.png';
}

// ‚úÖ Helper functions ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà - ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
function formatCurrency(amount) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const numAmount = parseFloat(amount) || 0;
  
  return new Intl.NumberFormat('th-TH', {
    style: 'currency',
    currency: 'THB',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(numAmount);
}

// ‚úÖ Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress bar
function updateProgressBarForSummary(card, amount) {
  const progressBar = card.querySelector('.bg-blue-500, .bg-red-500, .bg-purple-500, .bg-green-500, .bg-yellow-500');
  if (progressBar) {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì percentage ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏° 100% = 1,000,000 ‡∏ö‡∏≤‡∏ó)
    const maxAmount = 1000000;
    const percentage = Math.min((amount / maxAmount) * 100, 100);
    progressBar.style.width = `${percentage}%`;
  }
}

// ‚úÖ Fallback function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
async function loadAccountsSummaryFallback() {
  try {
    const res = await fetch('/api/chart-of-accounts', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
  
    if (res.ok) {
      const jsonResponse = await res.json();
      const list = Array.isArray(jsonResponse.data) ? jsonResponse.data : jsonResponse;
  
      // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      const summary = {
        assets: 0,
        liabilities: 0,
        equity: 0,
        income: 0,
        expenses: 0
      };
  
      list.forEach(account => {
        switch(account.category) {
          case 'Asset':
            summary.assets++;
            break;
          case 'Liabilities':
            summary.liabilities++;
            break;
          case 'Equity':
            summary.equity++;
            break;
          case 'Income':
            summary.income++;
            break;
          case 'Expense':
            summary.expenses++;
            break;
        }
      });
  
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î
      updateFallbackCards(summary);
      console.log('‚úÖ Used fallback data from chart of accounts');
    }
  } catch (error) {
    console.error('Fallback also failed:', error);
  }
}

// ‚úÖ Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fallback
function updateFallbackCards(summary) {
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
  const assetCard = document.querySelector('.stat-card:nth-child(1)');
  if (assetCard) {
    assetCard.querySelector('.text-sm').textContent = `${summary.assets} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    assetCard.querySelector('.text-lg').textContent = formatCurrency(0);
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô
  const liabCard = document.querySelector('.stat-card:nth-child(2)');
  if (liabCard) {
    liabCard.querySelector('.text-sm').textContent = `${summary.liabilities} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    liabCard.querySelector('.text-lg').textContent = formatCurrency(0);
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô
  const equityCard = document.querySelector('.stat-card:nth-child(3)');
  if (equityCard) {
    equityCard.querySelector('.text-sm').textContent = `${summary.equity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    equityCard.querySelector('.text-lg').textContent = formatCurrency(0);
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
  const incomeCard = document.querySelector('.stat-card:nth-child(4)');
  if (incomeCard) {
    incomeCard.querySelector('.text-sm').textContent = `${summary.income} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    incomeCard.querySelector('.text-lg').textContent = formatCurrency(0);
  }
  
  // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
  const expenseCard = document.querySelector('.stat-card:nth-child(5)');
  if (expenseCard) {
    expenseCard.querySelector('.text-sm').textContent = `${summary.expenses} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    expenseCard.querySelector('.text-lg').textContent = formatCurrency(0);
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Expand/Collapse All
function initializeExpandCollapseButtons() {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Expand/Collapse All ‡πÉ‡∏ô UI
  const filterSection = document.querySelector('.dropdown.dropdown-hover');
  if (filterSection && filterSection.parentNode) {
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex items-center space-x-2 ml-2';
  
    buttonContainer.innerHTML = `
      <button id="btnExpandAll" class="btn btn-outline btn-sm">
        <i class="bi bi-arrows-expand mr-2"></i>‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
      <button id="btnCollapseAll" class="btn btn-outline btn-sm">
        <i class="bi bi-arrows-collapse mr-2"></i>‡∏¢‡∏∏‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
    `;
    filterSection.parentNode.insertBefore(buttonContainer, filterSection.nextSibling);
  }

  // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Expand/Collapse All
  document.getElementById('btnExpandAll')?.addEventListener('click', function() {
    const allRows = document.querySelectorAll('.account-table tbody tr[data-level]');
    const allIcons = document.querySelectorAll('.account-table tbody .bi-caret-right-fill, .account-table tbody .bi-caret-down-fill');
  
    allRows.forEach(row => {
      row.classList.remove('hidden');
    });
  
    allIcons.forEach(icon => {
      const parentRow = icon.closest('tr');
      if (parentRow && parentRow.dataset.accountId) {
        const accountId = parentRow.dataset.accountId;
        const hasChildren = Array.from(allRows).some(r => r.dataset.parentId === accountId);
        if(hasChildren) {
          icon.classList.remove('bi-caret-right-fill');
          icon.classList.add('bi-caret-down-fill');
        }
      }
    });
  });

  document.getElementById('btnCollapseAll')?.addEventListener('click', function() {
    const allRows = document.querySelectorAll('.account-table tbody tr[data-level]');
    const allIcons = document.querySelectorAll('.account-table tbody .bi-caret-right-fill, .account-table tbody .bi-caret-down-fill');
  
    allRows.forEach(row => {
      if (parseInt(row.dataset.level) > 0) {
        row.classList.add('hidden');
      }
    });
  
    allIcons.forEach(icon => {
       const parentRow = icon.closest('tr');
       if (parentRow && parentRow.dataset.accountId) {
          const accountId = parentRow.dataset.accountId;
          const hasChildren = Array.from(allRows).some(r => r.dataset.parentId === accountId);
           if(hasChildren){
            icon.classList.remove('bi-caret-down-fill');
            icon.classList.add('bi-caret-right-fill');
           }
       }
    });
  });
}

  // === 4. Data Loading Functions ===
async function loadChartOfAccounts() {
  try {
    showLoading(true);
  
    const res = await fetch('/api/chart-of-accounts', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
  
    if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
  
    const jsonResponse = await res.json();
  
    const list = Array.isArray(jsonResponse.data)
      ? jsonResponse.data
      : Array.isArray(jsonResponse)
        ? jsonResponse
        : [];

    console.log('Raw data:', list);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á tree structure
    const map = {};
    const roots = [];
  
    list.forEach(account => {
      map[account._id] = {
        ...account,
        children: [],
        parentId: account.parent
      };
    });

    list.forEach(account => {
      if (account.parent && map[account.parent]) {
        map[account.parent].children.push(map[account._id]);
      } else {
        roots.push(map[account._id]);
      }
    });

    const flat = [];
  
    function buildFlatArray(nodes, level = 0) {
      const sorted = nodes.sort((a, b) => {
        const codeA = parseInt(a.code, 10);
        const codeB = parseInt(b.code, 10);
        if (!isNaN(codeA) && !isNaN(codeB)) {
          return codeA - codeB;
        }
        return String(a.code).localeCompare(String(b.code));
      });

      sorted.forEach(account => {
        flat.push({
          ...account,
          level: level,
          hasChildren: account.children && account.children.length > 0
        });
  
        if (account.children && account.children.length > 0) {
          buildFlatArray(account.children, level + 1);
        }
      });
    }

    buildFlatArray(roots);

    console.log('Flat array:', flat);

    renderTable(flat);
  
    // ‚ùå ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateSummaryCards ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    // updateSummaryCards(groupAccountsByType(list));
  
    // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
    await loadAccountsSummary();
  
    updateTotalCount(list.length);
  
    hideLoading();
  
  } catch (err) {
    hideLoading();
    console.error('Failed to load chart of accounts:', err);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ: ' + err.message);
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° function ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç function loadAccountsSummary ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
async function loadAccountsSummary() {
  try {
    const response = await fetch('/api/receipt-vouchers/dashboard/accounts-summary', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
  
    if (!response.ok) {
      throw new Error('Failed to load accounts summary');
    }
  
    const result = await response.json();
    console.log('API Response:', result);
  
    if (result.success && result.data) {
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (card ‡∏ó‡∏µ‡πà 1)
      const assetCard = document.querySelector('.stat-card:nth-child(1)');
      if (assetCard) {
        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        const assetAmount = result.data.assets || 0;
  
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        const countElement = assetCard.querySelector('.text-sm');
        if (countElement) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1000) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1000) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö
          const itemCount = assetAmount > 1000 ? 1 : Math.round(assetAmount);
          countElement.textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
  
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        const amountElement = assetCard.querySelector('.text-lg');
        if (amountElement) {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á 0
          const displayAmount = assetAmount > 1000 ? assetAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
  
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó progress bar
        updateProgressBarForSummary(assetCard, assetAmount);
      }
  
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (card ‡∏ó‡∏µ‡πà 2)
      const liabCard = document.querySelector('.stat-card:nth-child(2)');
      if (liabCard) {
        const liabAmount = result.data.liabilities || 0;
  
        const countElement = liabCard.querySelector('.text-sm');
        if (countElement) {
          const itemCount = liabAmount > 1000 ? 1 : Math.round(liabAmount);
          countElement.textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
  
        const amountElement = liabCard.querySelector('.text-lg');
        if (amountElement) {
          const displayAmount = liabAmount > 1000 ? liabAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
  
        updateProgressBarForSummary(liabCard, liabAmount);
      }
  
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (card ‡∏ó‡∏µ‡πà 4)
      const incomeCard = document.querySelector('.stat-card:nth-child(4)');
      if (incomeCard) {
        const revenueAmount = result.data.revenue || 0;
  
        const countElement = incomeCard.querySelector('.text-sm');
        if (countElement) {
          const itemCount = revenueAmount > 1000 ? 1 : Math.round(revenueAmount);
          countElement.textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
  
        const amountElement = incomeCard.querySelector('.text-lg');
        if (amountElement) {
          const displayAmount = revenueAmount > 1000 ? revenueAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
  
        updateProgressBarForSummary(incomeCard, revenueAmount);
      }
  
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (card ‡∏ó‡∏µ‡πà 5)
      const expenseCard = document.querySelector('.stat-card:nth-child(5)');
      if (expenseCard) {
        const expenseAmount = result.data.expenses || 0;
  
        const countElement = expenseCard.querySelector('.text-sm');
        if (countElement) {
          const itemCount = expenseAmount > 1000 ? 1 : Math.round(expenseAmount);
          countElement.textContent = `${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
  
        const amountElement = expenseCard.querySelector('.text-lg');
        if (amountElement) {
          const displayAmount = expenseAmount > 1000 ? expenseAmount : 0;
          amountElement.textContent = formatCurrency(displayAmount);
        }
  
        updateProgressBarForSummary(expenseCard, expenseAmount);
      }
  
      // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô - ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞ API ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
      const equityCard = document.querySelector('.stat-card:nth-child(3)');
      if (equityCard) {
        const countElement = equityCard.querySelector('.text-sm');
        if (countElement) {
          countElement.textContent = `0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
        const amountElement = equityCard.querySelector('.text-lg');
        if (amountElement) {
          amountElement.textContent = formatCurrency(0);
        }
      }
  
      console.log('‚úÖ Updated summary with amounts from Receipt Vouchers');
    }
  
  } catch (error) {
    console.error('Error loading accounts summary:', error);
    // ‡πÉ‡∏ä‡πâ fallback ‡∏à‡∏≤‡∏Å‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    if (typeof loadAccountsSummaryFallback === 'function') {
      await loadAccountsSummaryFallback();
    }
  }
}

    // === Export/Import Functions (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà) ===
async function exportToExcel() {
  try {
    showLoading(true);
  
    const response = await fetch('/api/accounts/export', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });
  
    if (!response.ok) throw new Error('Export failed');
  
    // ‡∏£‡∏±‡∏ö blob ‡∏à‡∏≤‡∏Å response
    const blob = await response.blob();
  
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö download
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chart_of_accounts_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  
    hideLoading();
    showSuccess('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  
  } catch (error) {
    hideLoading();
    console.error('Export error:', error);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
  }
}

function importFromExcel() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xlsx,.xls';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
  
    const formData = new FormData();
    formData.append('file', file);
  
    try {
      showLoading(true);
  
      const response = await fetch('/api/accounts/import', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
  
      if (!response.ok) throw new Error('Import failed');
  
      const result = await response.json();
  
      hideLoading();
      showSuccess(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.data.success.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  
      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà failed ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (result.data.failed.length > 0) {
        console.error('Failed imports:', result.data.failed);
        showError(`‡∏°‡∏µ ${result.data.failed.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Console`);
      }
  
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      await loadChartOfAccounts();
  
    } catch (error) {
      hideLoading();
      console.error('Import error:', error);
      showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
    }
  };
  
  input.click();
}

  // === 5. Data Processing Functions ===
  function groupAccountsByType(accounts) {
  const groups = {
    'Asset': { count: 0, total: 0, items: [] },
    'Liabilities': { count: 0, total: 0, items: [] },
    'Equity': { count: 0, total: 0, items: [] },
    'Income': { count: 0, total: 0, items: [] },
    'Expense': { count: 0, total: 0, items: [] }
  };
  
  accounts.forEach(account => {
    const type = account.category; // ‡πÉ‡∏ä‡πâ category ‡∏ï‡∏≤‡∏° Schema
    if (groups[type]) {
      groups[type].count++;
      groups[type].items.push(account);
      groups[type].total += parseFloat(account.balance || 0);
    }
  });
  
  return groups;
}

  // === 6. UI Update Functions ===
  function updateTotalCount(total) {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
    const headerElement = document.querySelector('.text-2xl.font-bold');
    if (headerElement) {
      headerElement.innerHTML = `
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} 
        <span class="text-gray-500 text-xl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
      `;
    }
  }
  
  function updateSummaryCards(groupedAccounts) {
    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (card ‡∏ó‡∏µ‡πà 1)
    const assetCard = document.querySelector('.stat-card:nth-child(1)');
    if (assetCard) {
      assetCard.querySelector('.text-sm').textContent = `${groupedAccounts.Asset.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      assetCard.querySelector('.text-lg').textContent = `‡∏ø${formatNumber(groupedAccounts.Asset.total)}`;
      updateProgressBar(assetCard, groupedAccounts.Asset.count, getTotalAccounts(groupedAccounts));
    }
  
    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (card ‡∏ó‡∏µ‡πà 2)
    const liabCard = document.querySelector('.stat-card:nth-child(2)');
    if (liabCard) {
      liabCard.querySelector('.text-sm').textContent = `${groupedAccounts.Liabilities.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      liabCard.querySelector('.text-lg').textContent = `‡∏ø${formatNumber(groupedAccounts.Liabilities.total)}`;
      updateProgressBar(liabCard, groupedAccounts.Liabilities.count, getTotalAccounts(groupedAccounts));
    }
  
    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô (card ‡∏ó‡∏µ‡πà 3)
    const equityCard = document.querySelector('.stat-card:nth-child(3)');
    if (equityCard) {
      equityCard.querySelector('.text-sm').textContent = `${groupedAccounts.Equity.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      equityCard.querySelector('.text-lg').textContent = `‡∏ø${formatNumber(groupedAccounts.Equity.total)}`;
      updateProgressBar(equityCard, groupedAccounts.Equity.count, getTotalAccounts(groupedAccounts));
    }
  
    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (card ‡∏ó‡∏µ‡πà 4)
    const incomeCard = document.querySelector('.stat-card:nth-child(4)');
    if (incomeCard) {
      incomeCard.querySelector('.text-sm').textContent = `${groupedAccounts.Income.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      incomeCard.querySelector('.text-lg').textContent = `‡∏ø${formatNumber(groupedAccounts.Income.total)}`;
      updateProgressBar(incomeCard, groupedAccounts.Income.count, getTotalAccounts(groupedAccounts));
    }
  
    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (card ‡∏ó‡∏µ‡πà 5)
    const expenseCard = document.querySelector('.stat-card:nth-child(5)');
    if (expenseCard) {
      expenseCard.querySelector('.text-sm').textContent = `${groupedAccounts.Expense.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      expenseCard.querySelector('.text-lg').textContent = `‡∏ø${formatNumber(groupedAccounts.Expense.total)}`;
      updateProgressBar(expenseCard, groupedAccounts.Expense.count, getTotalAccounts(groupedAccounts));
    }
  }
  
  function updateProgressBar(card, count, total) {
    const progressBar = card.querySelector('.bg-blue-500, .bg-red-500, .bg-purple-500, .bg-green-500, .bg-yellow-500');
    if (progressBar && total > 0) {
      const percentage = (count / total) * 100;
      progressBar.style.width = `${percentage}%`;
    }
  }
  
  function formatNumber(num) {
    return new Intl.NumberFormat('th-TH').format(num);
  }
  
  function getTotalAccounts(grouped) {
    return Object.values(grouped).reduce((sum, g) => sum + g.count, 0);
  }

  // === Drag & Drop Functions ===
let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  
  const afterElement = getDragAfterElement(e.currentTarget.parentNode, e.clientY);
  if (afterElement == null) {
    e.currentTarget.parentNode.appendChild(draggedElement);
  } else {
    e.currentTarget.parentNode.insertBefore(draggedElement, afterElement);
  }
  
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedElement !== this) {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    updateAccountOrder(draggedElement.dataset.accountId, this.dataset.accountId);
  }
  
  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';
  
  // ‡∏•‡∏ö class ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ drag
  const rows = document.querySelectorAll('.account-table tbody tr');
  rows.forEach(row => {
    row.classList.remove('drag-over');
  });
  
  draggedElement = null;
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
  
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

async function updateAccountOrder(draggedId, targetId) {
  try {
    const response = await fetch(`/api/accounts/${draggedId}/reorder`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ targetId })
    });
  
    if (!response.ok) {
      throw new Error('Failed to update order');
    }
  
  } catch (error) {
    console.error('Error updating account order:', error);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ');
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ reset
    await loadChartOfAccounts();
  }
}

function addSubAccount(parentId, parentCode, parentName) {
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ parent account info
  document.getElementById('parentAccountId').value = parentId;
  document.getElementById('parentAccountDisplay').textContent = `${parentCode} - ${parentName}`;
  
  // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢
  const suggestedCode = parentCode + '01';
  document.getElementById('subAccountCode').value = suggestedCode;
  
  // ‡πÄ‡∏õ‡∏¥‡∏î modal
  document.getElementById('addSubAccountModal').classList.remove('hidden');
}

function closeAddSubAccountModal() {
  document.getElementById('addSubAccountModal').classList.add('hidden');
  document.getElementById('addSubAccountForm').reset();
}

// Submit form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢
document.getElementById('addSubAccountForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const parentId = document.getElementById('parentAccountId').value;
  const code = document.getElementById('subAccountCode').value.trim();
  const name = document.getElementById('subAccountName').value.trim();
  
  try {
    showLoading(true);
  
    // ‡∏´‡∏≤ parent account ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á category
    const parentRow = document.querySelector(`tr[data-account-id="${parentId}"]`);
    const parentCategory = parentRow?.querySelector('td:nth-child(3) span')?.textContent;
  
    const response = await fetch('/api/accounts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({
        name: name,
        code: code,
        category: getCategoryFromThai(parentCategory), // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        type: 'detail',
        parent: parentId,
        balance: 0,
        status: 'active'
      })
    });
  
    if (!response.ok) {
      throw new Error('Failed to add sub account');
    }
  
    closeAddSubAccountModal();
    hideLoading();
    showSuccess('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    await loadChartOfAccounts();
  
  } catch (error) {
    hideLoading();
    console.error('Error adding sub account:', error);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ');
  }
});

// Helper function ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
function getCategoryFromThai(thai) {
  const map = {
    '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå': 'Asset',
    '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô': 'Liabilities',
    '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á': 'Equity',
    '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ': 'Income',
    '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢': 'Expense'
  };
  return map[thai] || thai;
}

function createAccountRow(account, level) {
  const tr = document.createElement('tr');
  tr.dataset.accountId = account._id;
  tr.dataset.level = level;
  tr.dataset.parentId = account.parentId || '';
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á cells ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
  const tdName = document.createElement('td');
  tdName.className = 'p-4 border-b border-gray-200
  tdName.style.paddingLeft = `${level * 24 + 16}px`;
  tdName.textContent = `${account.code} ‚Äì ${account.name}`;
  tr.appendChild(tdName);
  
  const tdCode = document.createElement('td');
  tdCode.className = 'p-4 border-b border-gray-200 text-gray-600
  tdCode.textContent = account.code;
  tr.appendChild(tdCode);
  
  const tdType = document.createElement('td');
  tdType.className = 'p-4 border-b border-gray-200
  const typeLabel = getTypeLabel(account.category);
  tdType.innerHTML = `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${typeLabel}</span>`;
  tr.appendChild(tdType);
  
  const tdActions = document.createElement('td');
  tdActions.className = 'p-4 border-b border-gray-200 text-right';
  tdActions.innerHTML = `
    <div class="action-buttons flex items-center justify-end space-x-2">
      <button onclick="editAccount('${account._id}','${account.name}','${account.code}','${account.category}')"
              class="text-blue-600 hover:text-blue-800"
              title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
        <i class="bi bi-pencil-square"></i>
      </button>
      <button onclick="deleteAccount('${account._id}','${account.code}')"
              class="text-red-600 hover:text-red-800"
              title="‡∏•‡∏ö">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `;
  tr.appendChild(tdActions);
  
  return tr;
}
  // === 7. Table Rendering Functions ===
function renderTable(accounts) {
  const tbody = document.querySelector('.account-table tbody');
  if (!tbody) {
    console.error("Table body '.account-table tbody' not found.");
    return;
  }
  tbody.innerHTML = '';

  accounts.forEach(acc => {
    const tr = document.createElement('tr');
    tr.dataset.accountId = acc._id;
    tr.dataset.level = acc.level;
    tr.dataset.parentId = acc.parentId || '';
  
    // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà level > 0 ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    if (acc.level > 0) {
      tr.classList.add('hidden');
    }

    // Cell: Account Name
    const tdName = document.createElement('td');
    tdName.className = `p-4 border-b border-gray-200
    tdName.style.paddingLeft = `${acc.level * 24 + 16}px`;
  
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥
    const accountDisplayName = acc.name.startsWith(acc.code)
      ? acc.name
      : `${acc.code} ‚Äì ${acc.name}`;

    if (acc.hasChildren) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-center cursor-pointer hover:text-primary-600
  
      let iconClass = 'bi bi-caret-right-fill text-xs mr-2 text-primary-600 transition-transform';
      let spanClass = '';

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î style ‡∏ï‡∏≤‡∏° level
      if (acc.level === 0) {
        spanClass = 'font-bold text-lg text-primary-600
      } else if (acc.level === 1) {
        spanClass = 'font-semibold text-primary-600
      } else if (acc.level === 2) {
        spanClass = 'font-medium';
      }
  
      wrapper.innerHTML = `
        <i class="${iconClass}"></i>
        <span class="${spanClass}">${accountDisplayName}</span>
      `;
      wrapper.addEventListener('click', toggleSubmenu);
      tdName.appendChild(wrapper);
    } else {
      const span = document.createElement('span');
      let spanClass = '';
  
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î style ‡∏ï‡∏≤‡∏° level ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö leaf nodes
      if (acc.level === 0) {
        spanClass = 'font-bold text-lg text-primary-600
      } else if (acc.level === 1) {
        spanClass = 'font-semibold text-primary-600
      } else if (acc.level === 2) {
        spanClass = 'font-medium';
      } else {
        spanClass = 'text-gray-700
      }
  
      if(spanClass) span.className = spanClass;
      span.textContent = accountDisplayName;
      tdName.appendChild(span);
    }
    tr.appendChild(tdName);

    // Cell: Account Code
    const tdCode = document.createElement('td');
    tdCode.className = 'p-4 border-b border-gray-200 text-gray-600
    tdCode.textContent = acc.code;
    tr.appendChild(tdCode);

    // Cell: Account Type
    const tdType = document.createElement('td');
    tdType.className = 'p-4 border-b border-gray-200
  
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    let typeLabel = '';
    let badgeClass = '';
  
    switch(acc.category) {
      case 'Asset':
        typeLabel = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå';
        badgeClass = 'bg-blue-100 text-blue-800
        break;
      case 'Liabilities':
        typeLabel = '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô';
        badgeClass = 'bg-red-100 text-red-800
        break;
      case 'Equity':
        typeLabel = '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á';
        badgeClass = 'bg-purple-100 text-purple-800
        break;
      case 'Income':
        typeLabel = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ';
        badgeClass = 'bg-green-100 text-green-800
        break;
      case 'Expense':
        typeLabel = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢';
        badgeClass = 'bg-yellow-100 text-yellow-800
        break;
      default:
        typeLabel = acc.category || '';
        badgeClass = 'bg-slate-100 text-slate-800
    }
  
    tdType.innerHTML = `<span class="px-2 py-1 rounded text-xs ${badgeClass}">${typeLabel}</span>`;
    tr.appendChild(tdType);

    // Cell: Actions
    const tdActions = document.createElement('td');
    tdActions.className = 'p-4 border-b border-gray-200 text-right';
    tdActions.innerHTML = `
      <div class="action-buttons flex items-center justify-end space-x-2">
        ${acc.level < 3 ? `
          <button onclick="addSubAccount('${acc._id}','${acc.code}','${acc.name}')"
                  class="text-green-600 hover:text-green-800"
                  title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢">
            <i class="bi bi-plus-circle"></i>
          </button>
        ` : ''}
        <button onclick="editAccount('${acc._id}','${acc.name}','${acc.code}','${acc.category}')"
                class="text-blue-600 hover:text-blue-800"
                title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
          <i class="bi bi-pencil-square"></i>
        </button>
        ${!acc.hasChildren ? `
          <button onclick="deleteAccount('${acc._id}','${acc.code}')"
                  class="text-red-600 hover:text-red-800"
                  title="‡∏•‡∏ö">
            <i class="bi bi-trash"></i>
          </button>
        ` : ''}
      </div>
    `;
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  });
}

function closeLedgerModal() {
  const modal = document.getElementById('ledgerModal');
  if (modal) {
    modal.remove();
  }
}

// === 5. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö real-time ===
document.getElementById('search')?.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.account-table tbody tr');
  
  rows.forEach(row => {
    const code = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
    const name = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
  
    // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    if (code.includes(searchTerm) || name.includes(searchTerm)) {
      row.style.display = '';
  
      // ‡πÅ‡∏™‡∏î‡∏á parent rows ‡∏î‡πâ‡∏ß‡∏¢
      let parentLevel = parseInt(row.dataset.level) - 1;
      let prevRow = row.previousElementSibling;
  
      while (prevRow && parentLevel >= 0) {
        if (parseInt(prevRow.dataset.level) === parentLevel) {
          prevRow.classList.remove('hidden');
          prevRow.style.display = '';
  
          // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô icon ‡πÄ‡∏õ‡πá‡∏ô expanded
          const icon = prevRow.querySelector('i.bi-caret-right-fill');
          if (icon) {
            icon.classList.remove('bi-caret-right-fill');
            icon.classList.add('bi-caret-down-fill');
          }
  
          parentLevel--;
        }
        prevRow = prevRow.previousElementSibling;
      }
    } else {
      row.style.display = 'none';
    }
  });
});

// === 6. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export/Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ä‡πâ API ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô) ===

// === 8. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ===
function filterByCategory(category) {
  const rows = document.querySelectorAll('.account-table tbody tr');
  
  rows.forEach(row => {
    if (category === 'all') {
      row.style.display = '';
    } else {
      const rowCategory = row.querySelector('td:nth-child(3) span')?.textContent;
      const categoryMap = {
        'Asset': '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå',
        'Liabilities': '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô',
        'Equity': '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á',
        'Income': '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
        'Expense': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢'
      };
  
      if (categoryMap[category] === rowCategory) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    }
  });
}
    // Function to toggle submenus
function toggleSubmenu(event) {
  event.stopPropagation();
  const wrapper = event.currentTarget;
  const tr = wrapper.closest('tr');
  if (!tr) return;

  const icon = wrapper.querySelector('i');
  const accountId = tr.dataset.accountId;

  // Toggle icon
  const isExpanded = icon.classList.contains('bi-caret-down-fill');
  icon.classList.toggle('bi-caret-right-fill', isExpanded);
  icon.classList.toggle('bi-caret-down-fill', !isExpanded);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á children ‡πÅ‡∏ö‡∏ö recursive
  function toggleDescendants(parentId, shouldHide) {
    // ‡πÉ‡∏ä‡πâ data-parent-id (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô dataset.parentId ‡πÇ‡∏î‡∏¢ JavaScript)
    const children = document.querySelectorAll(`tr[data-parent-id="${parentId}"]`);
  
    children.forEach(child => {
      child.classList.toggle('hidden', shouldHide);
  
      // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ reset icon ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô descendants ‡∏Ç‡∏≠‡∏á child ‡∏î‡πâ‡∏ß‡∏¢
      if (shouldHide) {
        const childIcon = child.querySelector('i.bi-caret-down-fill');
        if (childIcon) {
          childIcon.classList.remove('bi-caret-down-fill');
          childIcon.classList.add('bi-caret-right-fill');
        }
        // Recursive call ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô descendants
        toggleDescendants(child.dataset.accountId, true);
      }
    });
  }

  // Toggle direct children ‡πÅ‡∏•‡∏∞ descendants
  toggleDescendants(accountId, isExpanded);
}

document.querySelectorAll('.filter-option').forEach(option => {
  option.addEventListener('click', function() {
    const filterType = this.dataset.filter;
    filterByCategory(filterType);
  
    // Update active state
    document.querySelectorAll('.filter-option').forEach(opt => {
      opt.classList.remove('active');
      opt.querySelector('i').className = 'bi bi-square';
    });
    this.classList.add('active');
    this.querySelector('i').className = 'bi bi-check';
  });
});

    // Inject the menu template into the mainMenuContainer
    document.addEventListener('DOMContentLoaded', async () => {
      showLoading(true);

      try {
        // 1) ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π
  const menuTemplate = document.getElementById('mainMenuTemplate');
  const menuContainer = document.getElementById('mainMenuContainer');
  if (menuTemplate && menuContainer) {
    menuContainer.innerHTML = menuTemplate.innerHTML;
  }
  
        // 2) ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  await loadEmployeeProfile();
  
        // 3) ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadAccountsSummary ‡πÄ‡∏≠‡∏á)
  await loadChartOfAccounts();
  
        // 3.5) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Expand/Collapse
        if (typeof initializeExpandCollapseButtons === 'function') {
          initializeExpandCollapseButtons();
        }

  if (darkMode === 'true') {
          if (themeIcon) themeIcon.className = 'bi bi-sun-fill mr-2 text-yellow-300';
        }

        // 5) toggle dark
          try {
  
    if (isDark) {
      themeIcon.className = 'bi bi-sun-fill mr-2 text-yellow-300';
    } else {
      themeIcon.className = 'bi bi-moon-stars-fill mr-2 text-gray-700';
    }
  
            window.dispatchEvent(new CustomEvent('darkModeChanged', { detail: { isDark } }));
          } catch (err) {
          }
        });

window.addEventListener('darkModeChanged', (event) => {
});

        // 6) logout
        document.getElementById('btnLogout')?.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('authToken');
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    window.location.href = '/login';
  });

      } catch (error) {
        console.error('Page loading error:', error);
      } finally {
        showLoading(false);
      }
    });
</script>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Main Content) -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-xl font-semibold mb-2 text-gray-800">‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h1>
        
        <!-- Header Actions -->
        <div class="flex items-center space-x-3">
          <!-- Notifications -->
          <div class="relative">
            <button class="p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
              <i class="bi bi-bell"></i>
              <span class="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center">2</span>
            </button>
          </div>
          
          <!-- Help -->
          <button class="p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <i class="bi bi-question-circle"></i>
          </button>
        </div>
      </header>

        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (5 ‡∏´‡∏°‡∏ß‡∏î) -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6 animate-fadeIn">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">
                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 94 
                <span class="text-gray-500 text-xl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
              </h1>
            </div>
            <div class="text-right">
              <span class="text-sm text-gray-600">‡∏õ‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 2568</span>
            </div>
          </div>
        </div>

        <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ 5 ‡∏´‡∏°‡∏ß‡∏î -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
          <!-- ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå -->
          <div class="stat-card bg-white border-l-4 border-blue-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600">76 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="text-lg font-semibold text-blue-600">‡∏ø00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-blue-500 h-1.5 rounded-full" style="width: 35%"></div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô -->
          <div class="stat-card bg-white border-l-4 border-red-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600">37 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="text-lg font-semibold text-red-600">‡∏ø00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-red-500 h-1.5 rounded-full" style="width: 32%"></div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô -->
          <div class="stat-card bg-white border-l-4 border-purple-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600">4 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="text-lg font-semibold text-purple-600">‡∏ø00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-purple-500 h-1.5 rounded-full" style="width: 3%"></div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ -->
          <div class="stat-card bg-white border-l-4 border-green-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600">20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="text-lg font-semibold text-green-600">‡∏ø00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-green-500 h-1.5 rounded-full" style="width: 18%"></div>
              </div>
            </div>
          </div>
          
          <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
          <div class="stat-card bg-white border-l-4 border-yellow-500 p-4 rounded-lg shadow-sm">
            <div class="font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
            <div class="mt-2 flex justify-between items-end">
              <div class="text-sm text-gray-600">153 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div class="text-lg font-semibold text-yellow-600">‡∏ø00</div>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-yellow-500 h-1.5 rounded-full" style="width: 12%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <!-- ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
            <div class="flex-1 min-w-[250px]">
              <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <i class="bi bi-search text-gray-400"></i>
                </div>
                <input 
                  type="text" 
                  id="search" 
                  class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500" 
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ..."
                >
              </div>
            </div>
            
            <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
            <div class="dropdown dropdown-hover">
              <label tabindex="0" class="btn btn-outline btn-sm">
                <i class="bi bi-funnel mr-2"></i>
                ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
              </label>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-white rounded-lg w-52 z-20">
                <li class="menu-title"><span>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span></li>
                <li><a class="filter-option active" data-filter="all"><i class="bi bi-check"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a></li>
                <li><a class="filter-option" data-filter="Asset"><i class="bi bi-square"></i> ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</a></li>
                <li><a class="filter-option" data-filter="Liabilities"><i class="bi bi-square"></i> ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</a></li>
                <li><a class="filter-option" data-filter="Equity"><i class="bi bi-square"></i> ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</a></li>
                <li><a class="filter-option" data-filter="Income"><i class="bi bi-square"></i> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</a></li>
                <li><a class="filter-option" data-filter="Expense"><i class="bi bi-square"></i> ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</a></li>
              </ul>
            </div>

            <div class="flex items-center gap-2">
  <button onclick="exportToExcel()" class="btn btn-outline btn-sm">
    <i class="bi bi-download mr-2"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
  </button>
  <button onclick="importFromExcel()" class="btn btn-outline btn-sm">
    <i class="bi bi-upload mr-2"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel
  </button>
</div>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <button 
              id="btnAddAccount" 
              class="btn btn-primary btn-sm"
              onclick="openAddAccountModal()"
            >
              <i class="bi bi-plus-circle mr-2"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>
        </div>

        <!-- Modal Popup for Adding New Account -->
        <div id="addAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-hidden="true" role="dialog">
          <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
            <button 
 
              class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
              onclick="closeAddAccountModal()"
              aria-label="Close"
            >
              <i class="bi bi-x-circle"></i>
            </button>
            <h2 class="text-lg font-semibold mb-4 text-gray-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
            <form id="addAccountForm">
              <div class="mb-4">
                <label for="accountName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <input 
                  type="text" 
                  id="accountName" 
                  class="form-control" 
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" 
                  required
                >
                <small id="accountNameError" class="text-red-500 hidden">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</small>
              </div>
              <div class="mb-4">
                <label for="accountNumber" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <input 
                  type="text" 
                  id="accountNumber" 
                  class="form-control" 
                  placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" 
                  required
                >
                <small id="accountNumberError" class="text-red-500 hidden">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</small>
              </div>
              <div class="mb-4">
                <label for="accountCategory" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                <select id="accountCategory" class="form-control" required>
                  <option value="‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</option>
                  <option value="‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</option>
                  <option value="‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</option>
                  <option value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option>
                  <option value="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</option>
                </select>
              </div>
              <div class="flex justify-end gap-2">
                <button 
                  type="button" 
                  class="btn btn-outline btn-sm"
                  onclick="closeAddAccountModal()"
                >
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button 
                  type="submit" 
                  class="btn btn-primary btn-sm"
                >
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
<div id="editAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-hidden="true" role="dialog">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button 
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
      onclick="closeEditAccountModal()"
      aria-label="Close"
    >
      <i class="bi bi-x-circle"></i>
    </button>
    <h2 class="text-lg font-semibold mb-4 text-gray-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
    <form id="editAccountForm">
      <input type="hidden" id="editAccountId">
      <div class="mb-4">
        <label for="editAccountName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input 
          type="text" 
          id="editAccountName" 
          class="form-control" 
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" 
          required
        >
      </div>
      <div class="mb-4">
        <label for="editAccountNumber" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input 
          type="text" 
          id="editAccountNumber" 
          class="form-control" 
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" 
          readonly
        >
      </div>
      <div class="mb-4">
        <label for="editAccountCategory" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <select id="editAccountCategory" class="form-control" required>
          <option value="Asset">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</option>
          <option value="Liabilities">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</option>
          <option value="Equity">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô</option>
          <option value="Income">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option>
          <option value="Expense">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</option>
        </select>
      </div>
      <div class="mb-4">
        <label for="editAccountParent" class="block text-sm font-medium text-gray-700">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å</label>
        <select id="editAccountParent" class="form-control">
          <option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å --</option>
          <!-- Options ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
        </select>
      </div>
      <div class="flex justify-end gap-2">
        <button 
          type="button" 
          class="btn btn-outline btn-sm"
          onclick="closeEditAccountModal()"
        >
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button 
          type="submit" 
          class="btn btn-primary btn-sm"
        >
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal for Adding Sub Account -->
<div id="addSubAccountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button 
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
      onclick="closeAddSubAccountModal()"
    >
      <i class="bi bi-x-circle"></i>
    </button>
    <h2 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢</h2>
    <p class="text-sm text-gray-600 mb-4">
      ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å: <span id="parentAccountDisplay" class="font-semibold"></span>
    </p>
    <form id="addSubAccountForm">
      <input type="hidden" id="parentAccountId">
      <input type="hidden" id="parentAccountCategory">
      <div class="mb-4">
        <label for="subAccountCode" class="block text-sm font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input 
          type="text" 
          id="subAccountCode" 
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô 1101"
          required
        >
      </div>
      <div class="mb-4">
        <label for="subAccountName" class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input 
          type="text" 
          id="subAccountName" 
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡πà‡∏≠‡∏¢"
          required
        >
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeAddSubAccountModal()" 
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </form>
  </div>
</div>
        <script>
          // Open the modal
          function openAddAccountModal() {
            const modal = document.getElementById('addAccountModal');
            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
          }

          // Close the modal
          function closeAddAccountModal() {
            const modal = document.getElementById('addAccountModal');
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
          }

          // Close modal on outside click
          document.getElementById('addAccountModal').addEventListener('click', function(event) {
            if (event.target === this) {
              closeAddAccountModal();
            }
          });

          document.getElementById('addAccountForm').addEventListener('submit', async function(event) {
  event.preventDefault();

   // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô function
  const AUTH_TOKEN = localStorage.getItem('token');
  if (!AUTH_TOKEN) {
    showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    setTimeout(() => {
      window.location.href = '/login';
    }, 2000);
    return; // ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ return ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô function ‡πÅ‡∏•‡πâ‡∏ß
  }

  // Get form values
  const accountName = document.getElementById('accountName').value.trim();
  const accountNumber = document.getElementById('accountNumber').value.trim();
  const accountCategory = document.getElementById('accountCategory').value;

  // Validate inputs
  let isValid = true;
  if (!accountName) {
    document.getElementById('accountNameError').classList.remove('hidden');
    isValid = false;
  } else {
    document.getElementById('accountNameError').classList.add('hidden');
  }

  if (!accountNumber) {
    document.getElementById('accountNumberError').classList.remove('hidden');
    isValid = false;
  } else {
    document.getElementById('accountNumberError').classList.add('hidden');
  }

  if (!isValid) return;

  try {
    // ‡πÅ‡∏™‡∏î‡∏á loading
    showLoading(true);

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á API
    const formData = {
      name: accountName,
      code: accountNumber,
      type: accountCategory,
      category: accountCategory,
      level: 0,
      parent_id: null,
      balance: 0,
      status: 'active'
    };

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
    const engCategory = getCategoryFromThai(accountCategory);

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const response = await fetch('/api/accounts', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: JSON.stringify({
    name: accountName,
    code: accountNumber,
        category: engCategory,   // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ó‡∏¢‚Üí‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        type: 'detail',
    level: 0,
        parent: null,            // ‚úÖ ‡πÉ‡∏ä‡πâ parent (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà parentId)
    balance: 0,
    status: 'active'
  })
});

    if (!response.ok) throw new Error('Failed to create account');

    const created = await response.json();
    const newAccount = created.data || created; // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á

    // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡πÄ‡∏û‡∏¥‡πà‡∏° row ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const tableBody = document.querySelector('.account-table tbody');
    if (tableBody && newAccount) {
      const newRow = createAccountRow(newAccount, 0);

      // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏° code
      const allRows = tableBody.querySelectorAll('tr[data-level="0"]');
      let inserted = false;

      for (let row of allRows) {
        const rowCode = row.querySelector('td:nth-child(2)').textContent;
        if (accountNumber < rowCode) {
          tableBody.insertBefore(newRow, row);
          inserted = true;
          break;
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
      if (!inserted) {
        tableBody.appendChild(newRow);
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ
      await updateSummaryAfterAdd(accountCategory);
    }

    // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞ reset form
    closeAddAccountModal();
    document.getElementById('addAccountForm').reset();

    // ‡∏ã‡πà‡∏≠‡∏ô loading
    hideLoading();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    showSuccess('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ' + accountNumber + ' - ' + accountName + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

  } catch (error) {
    // ‡∏ã‡πà‡∏≠‡∏ô loading
    hideLoading();

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error
    console.error('Error adding account:', error);

    // ‡πÅ‡∏™‡∏î‡∏á error message ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
    let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ';

    if (error.message.includes('duplicate')) {
      errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ' + accountNumber + ' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
    } else if (error.message.includes('network')) {
      errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
    } else if (error.message.includes('401')) {
      errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà';
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
    }

    showError(errorMessage);
  }
});

// Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Account
function editAccount(id, name, code, category) {
  // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById('editAccountId').value = id;
  document.getElementById('editAccountName').value = name;
  document.getElementById('editAccountNumber').value = code;
  document.getElementById('editAccountCategory').value = category;

  document.getElementById('editAccountModal').classList.remove('hidden');
  document.getElementById('editAccountModal').setAttribute('aria-hidden', 'false');
}

function closeEditAccountModal() {
  document.getElementById('editAccountModal').classList.add('hidden');
  document.getElementById('editAccountModal').setAttribute('aria-hidden', 'true');
  document.getElementById('editAccountForm').reset();
}

// Close modal on outside click
document.getElementById('editAccountModal').addEventListener('click', function(event) {
  if (event.target === this) {
    closeEditAccountModal();
  }
});

// Submit Edit Form
document.getElementById('editAccountForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  const id = document.getElementById('editAccountId').value;
  const accountName = document.getElementById('editAccountName').value.trim();
  const accountCategory = document.getElementById('editAccountCategory').value;

  try {
    showLoading(true);

    const response = await fetch(`/api/accounts/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({
        name: accountName,
        category: accountCategory
      })
    });

    if (!response.ok) {
      throw new Error('Failed to update account');
    }

    closeEditAccountModal();
    hideLoading();
    showSuccess('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    await loadChartOfAccounts();

  } catch (error) {
    hideLoading();
    console.error('Error updating account:', error);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ');
  }
});

// Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Delete Account
async function deleteAccount(id, code) {
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${code} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
    return;
  }

  try {
    showLoading(true);

    const response = await fetch(`/api/accounts/${id}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (!response.ok) {
      throw new Error('Failed to delete account');
    }

    hideLoading();
    showSuccess('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    await loadChartOfAccounts();

  } catch (error) {
    hideLoading();
    console.error('Error deleting account:', error);
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á');
  }
}

// Function ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function updateSummaryAfterAdd(category) {
  try {
    // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö category
    let cardIndex;
    switch(category) {
      case '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå': cardIndex =  1; break;
      case '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô': cardIndex = 2; break;
      case '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô': cardIndex = 3; break;
      case '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ': cardIndex = 4; break;
      case '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢': cardIndex = 5; break;
    }

    if (cardIndex) {
      const card = document.querySelector(`.stat-card:nth-child(${cardIndex})`);
      if (card) {
        const countElement = card.querySelector('.text-sm');
        const currentText = countElement.textContent;
        const currentCount = parseInt(currentText.match(/\d+/)[0]);
        countElement.textContent = `${currentCount + 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      }
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°
    const totalElement = document.querySelector('.text-2xl.font-bold');
    if (totalElement) {
      const currentTotal = parseInt(totalElement.textContent.match(/\d+/)[0]);
      totalElement.innerHTML = `
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${currentTotal + 1} 
        <span class="text-gray-500 text-xl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
      `;
    }

  } catch (error) {
    console.error('Error updating summary:', error);
  }
}

async function viewAccountDetails(accountId) {
  try {
    showLoading(true);

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    const response = await fetch(`/api/accounts/${accountId}/ledger`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    const ledgerData = await response.json();

    // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
    showAccountLedgerModal(ledgerData);

    hideLoading();
  } catch (error) {
    hideLoading();
    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
  }
}

// Expand All
// This will be replaced by the new DOMContentLoaded listener below
// document.getElementById('btnExpandAll')?.addEventListener('click', function() { ... });

// Collapse All
// This will be replaced by the new DOMContentLoaded listener below
// document.getElementById('btnCollapseAll')?.addEventListener('click', function() { ... });

function toggleChildren(parentRow, parentLevel, show) {
  let sibling = parentRow.nextElementSibling;

  while (sibling && parseInt(sibling.dataset.level) > parentLevel) {
    const siblingLevel = parseInt(sibling.dataset.level);

    if (siblingLevel === parentLevel + 1) {
      // Direct children
      sibling.classList.toggle('hidden', !show);

      // Reset icon if hiding
      if (!show) {
        const icon = sibling.querySelector('i.bi-caret-down-fill');
        if (icon) {
          icon.classList.remove('bi-caret-down-fill');
          icon.classList.add('bi-caret-right-fill');
        }
      }
    } else if (!show) {
      // Hide all descendants
      sibling.classList.add('hidden');
    }

    sibling = sibling.nextElementSibling;
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß

function formatDate(date) {
  return new Date(date).toLocaleDateString('th-TH');
}

// Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
function getTypeLabel(type) {
  const labels = {
    'Asset': '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå',
    'Liabilities': '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô',
    'Equity': '‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á',
    'Income': '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
    'Expense': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢'
  };
  return labels[type] || type;
}

function showAccountLedgerModal(data) {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
  const modalHTML = `
    <div id="ledgerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[80vh] overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold">${data.accountCode} - ${data.accountName}</h3>
          <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${formatCurrency(data.balance)}</p>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh]">
          <table class="w-full">
            <thead>
              <tr class="border-b">
                <th class="text-left p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="text-left p-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th class="text-right p-2">‡πÄ‡∏î‡∏ö‡∏¥‡∏ï</th>
                <th class="text-right p-2">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
                <th class="text-right p-2">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
              </tr>
            </thead>
            <tbody>
              ${data.entries.map(entry => `
                <tr class="border-b">
                  <td class="p-2">${formatDate(entry.date)}</td>
                  <td class="p-2">${entry.description}</td>
                  <td class="p-2 text-right">${entry.debit ? formatCurrency(entry.debit) : '-'}</td>
                  <td class="p-2 text-right">${entry.credit ? formatCurrency(entry.credit) : '-'}</td>
                  <td class="p-2 text-right">${formatCurrency(entry.balance)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end">
          <button onclick="closeLedgerModal()" class="btn btn-outline">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initializeExpandCollapseButtons ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß</script>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
          <!-- ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
          <div class="border-b border-gray-200 p-4">
            <h2 class="font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
          </div>
          
          <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
          <div class="table-container">
            <table class="account-table w-full">
  <thead>
  <tr class="text-left">
    <th class="p-4 border-b border-gray-200">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
    <th class="p-4 border-b border-gray-200">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
    <th class="p-4 border-b border-gray-200">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
    <th class="p-4 border-b border-gray-200 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ -->
  </tr>
</thead>

<tbody id="accountsTableBody">
  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
</tbody>

          <!-- Pagination -->
          <div class="p-4 flex flex-wrap gap-4 items-center justify-between border-t border-gray-200">
            <div class="text-sm text-gray-600">
              ‡πÅ‡∏™‡∏î‡∏á 1-20 ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 94 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </div>
            
            <div class="btn-group">
              <button class="btn btn-sm btn-outline">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button class="btn btn-sm btn-outline btn-active">1</button>
              <button class="btn btn-sm btn-outline">2</button>
              <button class="btn btn-sm btn-outline">3</button>
              <button class="btn btn-sm btn-outline">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Footer -->
<footer class="bg-white py-3 px-6 shadow-inner border-t border-gray-200 text-center text-sm text-gray-600">
  ¬© 2025 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó 2 ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.
</footer>

<script>
// Clean up Lottie animation on page unload
window.addEventListener('beforeunload', () => {
  if (lottieAnimation) {
    lottieAnimation.destroy();
    lottieAnimation = null;
  }
});
</script>

  <!-- Account Menu Script -->
  <script src="/js/account-menu.js?v=light-v2"></script>
</body>
</html>
