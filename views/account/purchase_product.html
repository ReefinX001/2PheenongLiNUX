<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ระบบซื้อสินค้า - จัดการการซื้อสินค้าและบริการจากซัพพลายเออร์" />
  <meta name="keywords" content="purchase product, ซื้อสินค้า, procurement, จัดซื้อสินค้า" />
  <meta name="author" content="2 พี่น้อง โมบาย" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ซื้อสินค้า - Purchase Product</title>

  <!-- Google Font with performance optimization -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" /></noscript>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" crossorigin />

  <!-- Bootstrap CSS 5.3.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Configuration -->
  <script>
    (function() {
      function configureTailwind() {
        try {
          if (typeof tailwind !== 'undefined') {
            tailwind.config = {
              theme: {
                extend: {
                  fontFamily: {
                    sans: ['Prompt', 'sans-serif'],
                  },
                  colors: {
                    primary: {
                      50: '#f0f9ff',
                      100: '#e0f2fe',
                      500: '#0ea5e9',
                      600: '#0284c7',
                    }
                  },
                },
              }
            };
          } else {
            setTimeout(configureTailwind, 100);
          }
        } catch (error) {
          console.error('Error configuring Tailwind:', error);
        }
      }
      configureTailwind();
    })();
  </script>

  <!-- Enhanced API and User Management -->
  <script>
    const API_BASE = '/api';

    function getAuthToken() {
      try {
        return localStorage.getItem('authToken');
      } catch (error) {
        console.error('Error getting auth token:', error);
        return null;
      }
    }

    function resolvePhotoUrl(raw) {
      try {
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';

        if (!raw || typeof raw !== 'string' || raw.trim() === '') {
          return defaultAvatar;
        }

        const sanitizedRaw = raw.trim();

        if (/^https?:\/\//.test(sanitizedRaw)) return sanitizedRaw;
        if (sanitizedRaw.startsWith('data:')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/employees/')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/')) {
          return sanitizedRaw.replace(/^\/uploads\//, '/uploads/employees/');
        }

        return '/uploads/employees/' + encodeURIComponent(sanitizedRaw);
      } catch (error) {
        console.error('Error resolving photo URL:', error);
        return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
      }
    }

    async function fetchUserProfile() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('No authentication token found');
          loadFallbackUserData();
          return;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(`${API_BASE}/users/me`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          if (response.status === 401) {
            handleAuthError();
            return;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || 'Failed to load profile');
        }

        const userData = result.data || {};
        const userName = (userData.name || userData.username || 'ผู้ใช้').trim();
        const photoUrl = userData.photoUrl || userData.employee?.imageUrl || null;

        updateUserInterface(userName, photoUrl);

        localStorage.setItem('userName', userName);
        if (photoUrl) localStorage.setItem('userPhoto', photoUrl);

      } catch (error) {
        console.error('Error fetching user profile:', error);
        loadFallbackUserData();
      }
    }

    function updateUserInterface(userName, photoUrl) {
      try {
        const nameElement = document.getElementById('employeeName');
        const photoElement = document.getElementById('employeePhoto');

        if (nameElement) nameElement.textContent = userName;
        if (photoElement) {
          photoElement.src = resolvePhotoUrl(photoUrl);
          photoElement.alt = `รูปโปรไฟล์ของ ${userName}`;
          photoElement.onerror = function() {
            this.src = resolvePhotoUrl(null);
          };
        }
      } catch (error) {
        console.error('Error updating user interface:', error);
      }
    }

    function loadFallbackUserData() {
      try {
        const fallbackName = localStorage.getItem('userName') || 'ผู้ใช้';
        const fallbackPhoto = localStorage.getItem('userPhoto');
        updateUserInterface(fallbackName, fallbackPhoto);
      } catch (error) {
        console.error('Error loading fallback data:', error);
      }
    }

    function showLoadingAndRedirect(url) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
        overlay.classList.remove('animate__fadeOut');
        overlay.classList.add('animate__fadeIn');
      }
      setTimeout(() => { window.location.href = url; }, 300);
    }

    function handleAuthError() {
      try {
        console.warn('Authentication error - session expired');
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('userPhoto');

        if (confirm('เซสชันหมดอายุ ต้องการเข้าสู่ระบบใหม่หรือไม่?')) {
          showLoadingAndRedirect('/login.html');
        }
      } catch (error) {
        console.error('Error handling auth error:', error);
        showLoadingAndRedirect('/login.html');
      }
    }
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: 'Prompt', sans-serif;
      font-size: 0.875rem;
      background-color: #f8f9fa;
    }

    #mainContent {
      flex: 1;
    }

    /* Loading Overlay Styles */
    .loading-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(255, 255, 255, 0.95) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 999999 !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      transition: opacity 0.5s ease-out !important;
      pointer-events: auto !important;
    }

    .loading-overlay.animate__fadeOut {
      opacity: 0;
      pointer-events: none !important;
    }

    .loading-overlay.hidden,
    .loading-overlay[style*="display: none"] {
      display: none !important;
      pointer-events: none !important;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      background-color: #10b981;
      color: white;
    }

    .toast.error {
      background-color: #ef4444;
      color: white;
    }

    .toast.warning {
      background-color: #f59e0b;
      color: white;
    }

    .toast.info {
      background-color: #3b82f6;
      color: white;
    }

    .toast-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.875rem;
      opacity: 0.95;
    }

    .toast-close {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      font-size: 1.25rem;
      background: none;
      border: none;
      color: inherit;
      padding: 0;
      margin-left: 8px;
    }

    .toast-close:hover {
      opacity: 1;
    }

    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 12px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 2px solid #dee2e6;
      font-size: 0.813rem;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      color: #333;
      font-size: 0.813rem;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .btn {
      border-radius: 6px;
      padding: 8px 16px;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      font-weight: 500;
    }

    .btn-primary {
      background-color: #0ea5e9;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0284c7;
    }

    .btn-sm {
      padding: 4px 12px;
      font-size: 0.813rem;
    }

    .btn-outline {
      border: 1px solid;
      background-color: transparent;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-confirmed {
      background-color: #d1fae5;
      color: #065f46;
    }

    .badge-pending {
      background-color: #fef3c7;
      color: #92400e;
    }

    .badge-received {
      background-color: #dbeafe;
      color: #1e40af;
    }
  </style>

  <!-- Account Menu Styles -->
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">
</head>

<body>
  <!-- Loading Overlay with Lottie Animation -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeIn" style="display: flex;">
    <div class="text-center">
      <div id="lottieContainer" style="width: 300px; height: 300px;"></div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <div id="mainContent" class="container-fluid px-4 py-6">
    <!-- Navbar -->
    <div class="navbar bg-white shadow-md sticky top-0 mb-4" style="padding: 0.75rem 1rem; display: flex; align-items: center;">
      <div class="flex-1 flex items-center space-x-6">
        <img src="/uploads/Logo2.png" alt="Logo" class="rounded-full shadow-lg"
             style="width: 40px; height: 40px;" loading="lazy" />
        <span class="text-lg font-semibold">ระบบบัญชี - ซื้อสินค้า</span>
        <div id="mainMenuContainer" class="ml-auto"></div>
      </div>
      <div class="flex items-center space-x-3">
        <img id="employeePhoto" alt="Profile" class="w-10 h-10 rounded-full border-2 border-gray-300" loading="lazy" />
        <span id="employeeName" class="text-sm font-medium text-gray-700">ผู้ใช้</span>
        <button id="btnLogout" class="btn btn-primary btn-sm">
          <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
        </button>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="font-medium d-flex align-items-center text-sm">
            <i class="bi bi-calendar-event mr-2 text-primary"></i> วันที่ออกใบสั่งซื้อ
          </span>
          <div class="position-relative">
            <button id="datePickerTrigger" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
              <i class="bi bi-calendar3"></i>
              <span id="selectedDateRange">เดือนนี้</span>
              <i class="bi bi-chevron-down"></i>
            </button>
            <div id="datePickerMenu" class="position-absolute bg-white border rounded shadow p-3 d-none" style="top: 100%; left: 0; margin-top: 0.5rem; z-index: 50; min-width: 300px;">
              <h6 class="mb-2">เลือกช่วงเวลา</h6>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label text-sm">วันที่เริ่มต้น</label>
                  <input type="date" id="startDate" class="form-control form-control-sm" />
                </div>
                <div class="col-6">
                  <label class="form-label text-sm">วันที่สิ้นสุด</label>
                  <input type="date" id="endDate" class="form-control form-control-sm" />
                </div>
              </div>
              <div class="d-flex justify-content-end gap-2 mt-3">
                <button id="cancelDatePicker" class="btn btn-sm btn-outline-secondary">ยกเลิก</button>
                <button id="applyDatePicker" class="btn btn-sm btn-primary">ยืนยัน</button>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="position-relative">
            <i class="bi bi-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
            <input type="text" id="searchInput" placeholder="ค้นหาใบสั่งซื้อ, ชื่อซัพพลายเออร์..."
                   class="form-control form-control-sm" style="padding-left: 36px; min-width: 300px;" />
          </div>
          <select id="statusFilter" class="form-select form-select-sm" style="min-width: 150px;">
            <option value="">ทุกสถานะ</option>
            <option value="confirmed">ยืนยันสั่งซื้อ</option>
            <option value="pending">รอดำเนินการ</option>
            <option value="received">รับสินค้าแล้ว</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">กำลังโหลดข้อมูล...</p>
      </div>

      <div id="emptyState" class="text-center py-5 d-none">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #d1d5db;"></i>
        <p class="mt-3 text-muted">ไม่พบข้อมูลใบสั่งซื้อ</p>
      </div>

      <div id="tableContainer" class="d-none">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>เลขที่ใบสั่งซื้อ</th>
                <th>วันที่</th>
                <th>ซัพพลายเออร์</th>
                <th class="text-end">มูลค่า</th>
                <th class="text-center">สถานะ</th>
                <th class="text-center" style="width: 140px;">จัดการ</th>
              </tr>
            </thead>
            <tbody id="poTableBody">
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="text-center text-sm text-muted mt-3">
          แสดง <span id="recordCount">0</span> รายการ
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS 5.3.2 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    // Initialize Lottie Animation for Loading
    const lottieContainer = document.getElementById('lottieContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');
    let lottieAnimation;

    // Function to show page loading overlay
    window.showPageLoading = function() {
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        loadingOverlay.classList.remove('animate__fadeOut');
        loadingOverlay.classList.add('animate__fadeIn');
      }
    };

    // Function to hide page loading overlay
    window.hidePageLoading = function() {
      if (loadingOverlay) {
        loadingOverlay.classList.remove('animate__fadeIn');
        loadingOverlay.classList.add('animate__fadeOut');
        setTimeout(function() {
          loadingOverlay.style.display = 'none';
        }, 500);
      }
    };

    if (lottieContainer && typeof lottie !== 'undefined') {
      try {
        lottieAnimation = lottie.loadAnimation({
          container: lottieContainer,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: '/Loading/Loading.json'
        });

        showPageLoading();

        window.addEventListener('load', function() {
          setTimeout(function() {
            hidePageLoading();
          }, 800);
        });

        fetchUserProfile();
      } catch (error) {
        console.error('Error loading Lottie animation:', error);
        loadingOverlay.style.display = 'none';
      }
    } else {
      if (loadingOverlay) loadingOverlay.style.display = 'none';
      fetchUserProfile();
    }

    // Show loading before page navigation
    window.addEventListener('beforeunload', function() {
      showPageLoading();
    });

    // Intercept internal links to show loading
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a[href]');
      if (link && !link.hasAttribute('target') && !link.getAttribute('href').startsWith('#')) {
        const href = link.getAttribute('href');
        if (href && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
          showPageLoading();
        }
      }
    });

    // Toast Notification Function
    function showToast(type, title, message, duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type} animate__animated animate__fadeInRight`;

      const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-x-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        info: 'bi-info-circle-fill'
      };

      toast.innerHTML = `
        <i class="bi ${icons[type]} toast-icon"></i>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="bi bi-x"></i>
        </button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('animate__fadeInRight');
        toast.classList.add('animate__fadeOutRight');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Format Currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 2
      }).format(amount || 0);
    }

    // Format Date Thai
    function formatDateThai(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Get Status Badge
    function getStatusBadge(status) {
      const statusMap = {
        confirmed: { class: 'badge-confirmed', text: 'ยืนยันสั่งซื้อ' },
        pending: { class: 'badge-pending', text: 'รอดำเนินการ' },
        received: { class: 'badge-received', text: 'รับสินค้าแล้ว' }
      };
      const badge = statusMap[status] || { class: 'badge-pending', text: status };
      return `<span class="badge ${badge.class}">${badge.text}</span>`;
    }

    // Debounce function
    function debounce(fn, delay = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }

    // Fetch Purchase Orders
    async function fetchPurchaseOrders() {
      try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('statusFilter').value;
        const keyword = document.getElementById('searchInput').value.trim();

        const params = new URLSearchParams();
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        if (status) params.append('status', status);
        if (keyword) params.append('keyword', keyword);

        const url = `/api/purchase-order?${params}`;

        const token = getAuthToken();
        const response = await fetch(url, {
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        document.getElementById('loadingState').classList.add('d-none');

        if (!result.success || !result.data || result.data.length === 0) {
          document.getElementById('emptyState').classList.remove('d-none');
          document.getElementById('tableContainer').classList.add('d-none');
          return;
        }

        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('tableContainer').classList.remove('d-none');

        const tbody = document.getElementById('poTableBody');
        tbody.innerHTML = result.data.map(po => `
          <tr>
            <td><span class="font-medium text-primary">${po.poNumber || '-'}</span></td>
            <td>${formatDateThai(po.docDate)}</td>
            <td>${po.supplierName || '-'}</td>
            <td class="text-end font-medium">${formatCurrency(po.totalAmount)}</td>
            <td class="text-center">${getStatusBadge(po.status)}</td>
            <td class="text-center">
              <div class="d-flex justify-content-center gap-1">
                <button onclick="viewPO('${po._id}')" class="btn btn-sm btn-outline-primary" title="ดูรายละเอียด">
                  <i class="bi bi-eye"></i>
                </button>
                <button onclick="editPO('${po._id}')" class="btn btn-sm btn-outline-warning" title="แก้ไข">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button onclick="deletePO('${po._id}', '${po.poNumber}')" class="btn btn-sm btn-outline-danger" title="ลบ">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        document.getElementById('recordCount').textContent = result.data.length;

      } catch (error) {
        console.error('Error fetching purchase orders:', error);
        document.getElementById('loadingState').classList.add('d-none');
        showToast('error', 'ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้: ' + error.message);
      }
    }

    // Action functions
    function viewPO(id) {
      showPageLoading();
      window.location.href = `/account/purchase_order_detail.html?id=${id}`;
    }

    function editPO(id) {
      showPageLoading();
      window.location.href = `/account/edit_purchase_order.html?id=${id}`;
    }

    async function deletePO(id, poNumber) {
      if (!confirm(`คุณต้องการลบใบสั่งซื้อ ${poNumber} ใช่หรือไม่?`)) {
        return;
      }

      try {
        const token = getAuthToken();
        const response = await fetch(`/api/purchase-order/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.message || 'ไม่สามารถลบได้');
        }

        showToast('success', 'สำเร็จ', 'ลบใบสั่งซื้อเรียบร้อยแล้ว');
        fetchPurchaseOrders();
      } catch (error) {
        console.error('Error deleting PO:', error);
        showToast('error', 'ข้อผิดพลาด', error.message);
      }
    }

    // Date Picker
    document.getElementById('datePickerTrigger').addEventListener('click', function() {
      const menu = document.getElementById('datePickerMenu');
      menu.classList.toggle('d-none');
    });

    document.getElementById('applyDatePicker').addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        document.getElementById('selectedDateRange').textContent =
          `${new Date(startDate).toLocaleDateString('th-TH')} - ${new Date(endDate).toLocaleDateString('th-TH')}`;
      }
      document.getElementById('datePickerMenu').classList.add('d-none');
      fetchPurchaseOrders();
    });

    document.getElementById('cancelDatePicker').addEventListener('click', function() {
      document.getElementById('datePickerMenu').classList.add('d-none');
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date range (current month)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
      document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];

      fetchPurchaseOrders();
    });

    // Event listeners
    document.getElementById('statusFilter').addEventListener('change', fetchPurchaseOrders);
    document.getElementById('searchInput').addEventListener('input', debounce(fetchPurchaseOrders));

    // Logout
    document.getElementById('btnLogout').addEventListener('click', function() {
      if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
        localStorage.removeItem('authToken');
        showLoadingAndRedirect('/login.html');
      }
    });
  </script>

  <!-- Account Menu Script -->
  <script src="/js/account-menu.js?v=light-v2"></script>
</body>
</html>
