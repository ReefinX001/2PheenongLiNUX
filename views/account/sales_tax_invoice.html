<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≤‡∏¢ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Bootstrap CSS 5.3.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- Account Menu Styles -->
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif']
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
            }
          }
        }
      }
    }
  </script>

  <style>
    * {
      font-family: 'Prompt', sans-serif;
    }

    body {
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
    }

    /* Enhanced Loading Overlay */
    .loading-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(255, 255, 255, 0.98) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 999999 !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out !important;
      pointer-events: auto !important;
    }

    .loading-overlay.hiding {
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* Navbar Styles */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 30;
      padding: 0.5rem 1rem;
    }

    /* Card Styles */
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 1.5rem;
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    /* Table Styles */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background-color: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: #64748b;
      padding: 1rem;
    }

    .table tbody td {
      padding: 1rem;
      vertical-align: middle;
    }

    .table tbody tr:hover {
      background-color: #f8fafc;
    }

    /* Badge Styles */
    .badge {
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* Button Styles */
    .btn-action {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Pagination */
    .pagination {
      margin-bottom: 0;
    }

    .page-link {
      border-radius: 6px;
      margin: 0 2px;
      border: 1px solid #e2e8f0;
      color: #64748b;
    }

    .page-link:hover {
      background-color: #f8fafc;
      border-color: #0ea5e9;
      color: #0ea5e9;
    }

    .page-item.active .page-link {
      background-color: #0ea5e9;
      border-color: #0ea5e9;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .empty-state i {
      font-size: 4rem;
      color: #cbd5e1;
      margin-bottom: 1rem;
    }

    /* Logout Button Styles */
    #btnLogout {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #0ea5e9;
      background-color: white;
      border: 1px solid #0ea5e9;
      border-radius: 0.375rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    #btnLogout:hover {
      background-color: #0ea5e9;
      color: white;
    }

    #btnLogout:active {
      transform: scale(0.98);
    }

    /* Print Styles */
    @media print {
      .navbar, .filters, .pagination, .btn-action {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <!-- Loading Overlay with Lottie Animation -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeIn" style="display: flex;">
    <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
      <div id="lottieContainer" style="width: 300px; height: 300px;"></div>
    </div>
  </div>

  <!-- Navbar -->
  <div class="navbar bg-white shadow-md sticky top-0 z-30 px-4 py-2">
    <div class="flex-1 flex items-center space-x-6">
      <a href="/account/accounting_dashboard.html" class="flex items-center space-x-2">
        <i class="bi bi-receipt text-primary" style="font-size: 1.5rem;"></i>
        <span class="text-lg font-semibold">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≤‡∏¢</span>
      </a>

      <!-- Menu Container -->
      <div id="mainMenuContainer" class="ml-auto"></div>
    </div>

    <div class="flex-none flex items-center space-x-2">
      <!-- User Profile Section -->
      <div class="flex items-center space-x-3 mr-4">
        <img id="employeePhoto" alt="Profile" class="w-10 h-10 rounded-full border-2 border-gray-300" src="" loading="lazy">
        <span id="employeeName" class="text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
      </div>

      <!-- Logout Button -->
      <button id="btnLogout" class="btn btn-outline btn-primary btn-sm">
        <i class="bi bi-box-arrow-right mr-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid px-4 py-6">
    <!-- Dashboard Cards -->
    <div class="row g-4 mb-6">
      <div class="col-md-4">
        <div class="stat-card blue">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              <div class="text-3xl font-bold" id="totalTaxInvoices">0</div>
            </div>
            <i class="bi bi-receipt fs-1"></i>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat-card green">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
              <div class="text-3xl font-bold" id="paidAmount">‡∏ø0.00</div>
            </div>
            <i class="bi bi-check-circle fs-1"></i>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat-card orange">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="text-sm opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</div>
              <div class="text-3xl font-bold" id="pendingAmount">‡∏ø0.00</div>
            </div>
            <i class="bi bi-clock-history fs-1"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 filters">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label text-sm font-medium">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input type="text" id="searchInput" class="form-control" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
          </div>

          <div class="col-md-2">
            <label class="form-label text-sm font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="statusFilter" class="form-select">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
              <option value="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
              <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
            <input type="date" id="startDate" class="form-control">
          </div>

          <div class="col-md-2">
            <label class="form-label text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
            <input type="date" id="endDate" class="form-control">
          </div>

          <div class="col-md-3 d-flex align-items-end gap-2">
            <button id="btnSearch" class="btn btn-primary flex-grow-1">
              <i class="bi bi-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button id="btnReset" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button id="btnCreate" class="btn btn-success">
              <i class="bi bi-plus-lg me-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div id="tableContainer" class="table-container" style="display: none;">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th>‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
            <th>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="taxInvoiceTableBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center p-3 border-top">
        <div class="text-sm text-muted">
          ‡πÅ‡∏™‡∏î‡∏á <span id="showingStart">0</span> - <span id="showingEnd">0</span> ‡∏à‡∏≤‡∏Å <span id="totalRecords">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
        <nav>
          <ul class="pagination mb-0" id="pagination">
            <!-- Pagination will be populated here -->
          </ul>
        </nav>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="card" style="display: none;">
      <div class="card-body empty-state">
        <i class="bi bi-inbox"></i>
        <h5 class="mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
        <p class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="card" style="display: none;">
      <div class="card-body empty-state">
        <i class="bi bi-exclamation-triangle text-danger"></i>
        <h5 class="mt-3 text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h5>
        <p class="text-muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        <button onclick="location.reload()" class="btn btn-primary mt-2">
          <i class="bi bi-arrow-clockwise me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <!-- Account Menu JS -->
  <script src="/js/account-menu.js?v=light-v2"></script>

  <script>
    // ==================== Global Variables ====================
    let currentPage = 1;
    const limit = 20;
    let searchTimeout = null;

    // ==================== Lottie Animation ====================
    document.addEventListener('DOMContentLoaded', function() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const lottieContainer = document.getElementById('lottieContainer');

      if (lottieContainer && typeof lottie !== 'undefined') {
        try {
          const animation = lottie.loadAnimation({
            container: lottieContainer,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: '/Loading/Loading.json'
          });

          animation.addEventListener('data_failed', () => {
            console.error('Failed to load Lottie animation');
            if (loadingOverlay) loadingOverlay.style.display = 'none';
          });

          animation.addEventListener('DOMLoaded', () => {
            console.log('‚úÖ Lottie animation loaded successfully');
          });
        } catch (error) {
          console.error('Error initializing Lottie:', error);
          if (loadingOverlay) loadingOverlay.style.display = 'none';
        }
      } else {
        console.warn('Lottie container not found or lottie library not loaded');
        if (loadingOverlay) loadingOverlay.style.display = 'none';
      }
    });

    // ==================== Helper Functions ====================
    function hidePageLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.add('hiding');
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 500);
      }
    }

    function showPageLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        loadingOverlay.classList.remove('hiding');
      }
    }

    function getAuthToken() {
      return localStorage.getItem('authToken') ||
             localStorage.getItem('token') ||
             sessionStorage.getItem('token');
    }

    function handleAuthError() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      window.location.href = '/login';
    }

    function formatCurrency(amount) {
      return '‡∏ø' + (amount || 0).toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatDateThai(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    function getStatusBadge(status) {
      const badges = {
        'paid': '<span class="badge bg-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>',
        'pending': '<span class="badge bg-warning">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>',
        'cancelled': '<span class="badge bg-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>';
    }

    // ==================== User Profile ====================
    function loadUserProfile() {
      const userName = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      const userPhoto = localStorage.getItem('userPhoto') || '/images/default-avatar.png';

      document.getElementById('employeeName').textContent = userName;
      document.getElementById('employeePhoto').src = userPhoto;
      document.getElementById('employeePhoto').onerror = function() {
        this.src = '/images/default-avatar.png';
      };
    }

    // ==================== Logout ====================
    const btnLogout = document.getElementById('btnLogout');
    if (btnLogout) {
      btnLogout.addEventListener('click', function() {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
          // Clear all tokens
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          sessionStorage.removeItem('token');
          localStorage.removeItem('userName');
          localStorage.removeItem('userPhoto');

          // Show loading before redirect
          showPageLoading();

          // Redirect to login
          setTimeout(() => {
            window.location.href = '/login';
          }, 500);
        }
      });
    }

    // ==================== Statistics ====================
    async function loadStatistics() {
      const token = getAuthToken();
      if (!token) {
        handleAuthError();
        return;
      }

      try {
        const response = await fetch('/api/taxinvoice/statistics', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.status === 401) {
          handleAuthError();
          return;
        }

        if (!response.ok) throw new Error('Failed to load statistics');

        const result = await response.json();
        const data = result.data || {};

        document.getElementById('totalTaxInvoices').textContent = data.totalTaxInvoices || 0;
        document.getElementById('paidAmount').textContent = formatCurrency(data.paidAmount || 0);
        document.getElementById('pendingAmount').textContent = formatCurrency(data.pendingAmount || 0);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // ==================== Load Tax Invoices ====================
    async function loadTaxInvoices(page = 1) {
      const token = getAuthToken();
      if (!token) {
        handleAuthError();
        return;
      }

      currentPage = page;

      // Hide all states
      document.getElementById('tableContainer').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';

      // Build query parameters
      const params = new URLSearchParams();
      params.append('page', page);
      params.append('limit', limit);

      const searchQuery = document.getElementById('searchInput')?.value.trim();
      if (searchQuery) params.append('search', searchQuery);

      const status = document.getElementById('statusFilter')?.value;
      if (status) params.append('status', status);

      const startDate = document.getElementById('startDate')?.value;
      if (startDate) params.append('startDate', startDate);

      const endDate = document.getElementById('endDate')?.value;
      if (endDate) params.append('endDate', endDate);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(`/api/taxinvoice?${params}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.status === 401) {
          handleAuthError();
          return;
        }

        if (!response.ok) throw new Error('Failed to load tax invoices');

        const result = await response.json();

        if (!result.data || result.data.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          return;
        }

        displayTaxInvoices(result.data);
        displayPagination(result.pagination);

        document.getElementById('tableContainer').style.display = 'block';

      } catch (error) {
        console.error('Error loading tax invoices:', error);
        document.getElementById('errorState').style.display = 'block';
      }
    }

    // ==================== Display Tax Invoices ====================
    function displayTaxInvoices(taxInvoices) {
      const tbody = document.getElementById('taxInvoiceTableBody');
      tbody.innerHTML = '';

      taxInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="font-medium">${invoice.taxInvoiceNumber || '-'}</td>
          <td>${formatDateThai(invoice.createdAt)}</td>
          <td>${invoice.customer?.name || '-'}</td>
          <td>${formatCurrency(invoice.summary?.subtotal || 0)}</td>
          <td>${formatCurrency(invoice.summary?.vatAmount || 0)}</td>
          <td class="font-semibold">${formatCurrency(invoice.summary?.total || 0)}</td>
          <td>${getStatusBadge(invoice.status)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button onclick="viewTaxInvoice('${invoice._id}')" class="btn btn-info btn-action" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                <i class="bi bi-eye"></i>
              </button>
              <button onclick="printTaxInvoice('${invoice._id}')" class="btn btn-primary btn-action" title="‡∏û‡∏¥‡∏°‡∏û‡πå">
                <i class="bi bi-printer"></i>
              </button>
              ${invoice.status !== 'cancelled' ? `
              <button onclick="cancelTaxInvoice('${invoice._id}')" class="btn btn-danger btn-action" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">
                <i class="bi bi-x-circle"></i>
              </button>
              ` : ''}
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ==================== Display Pagination ====================
    function displayPagination(pagination) {
      const paginationElement = document.getElementById('pagination');
      paginationElement.innerHTML = '';

      const { current, total, count, totalRecords } = pagination;

      // Update showing info
      const start = (current - 1) * limit + 1;
      const end = start + count - 1;
      document.getElementById('showingStart').textContent = start;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('totalRecords').textContent = totalRecords;

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${current === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${current > 1 ? `loadTaxInvoices(${current - 1})` : ''}">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>`;
      paginationElement.appendChild(prevLi);

      // Page numbers
      const maxButtons = 5;
      let startPage = Math.max(1, current - Math.floor(maxButtons / 2));
      let endPage = Math.min(total, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === current ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadTaxInvoices(${i})">${i}</a>`;
        paginationElement.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${current === total ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${current < total ? `loadTaxInvoices(${current + 1})` : ''}">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>`;
      paginationElement.appendChild(nextLi);
    }

    // ==================== Action Functions ====================
    function viewTaxInvoice(id) {
      window.location.href = `/account/sales_tax_invoice_detail.html?id=${id}`;
    }

    async function printTaxInvoice(id) {
      const token = getAuthToken();
      if (!token) {
        handleAuthError();
        return;
      }

      try {
        const response = await fetch(`/api/taxinvoice/${id}/pdf`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `tax-invoice-${id}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        console.error('Error printing tax invoice:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
      }
    }

    async function cancelTaxInvoice(id) {
      const reason = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å:');
      if (!reason || reason.trim() === '') {
        return;
      }

      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ô‡∏µ‡πâ?')) {
        return;
      }

      const token = getAuthToken();
      if (!token) {
        handleAuthError();
        return;
      }

      try {
        const response = await fetch(`/api/taxinvoice/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'cancelled',
            notes: `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ${reason}`
          })
        });

        if (response.ok) {
          alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          loadTaxInvoices(currentPage);
          loadStatistics();
        } else {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ');
        }
      } catch (error) {
        console.error('Error cancelling tax invoice:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
      }
    }

    function createNewTaxInvoice() {
      window.location.href = '/account/sales_tax_invoice_create.html';
    }

    // ==================== Search and Filter ====================
    document.getElementById('searchInput')?.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        loadTaxInvoices(1);
      }, 500);
    });

    document.getElementById('statusFilter')?.addEventListener('change', function() {
      loadTaxInvoices(1);
    });

    document.getElementById('startDate')?.addEventListener('change', function() {
      loadTaxInvoices(1);
    });

    document.getElementById('endDate')?.addEventListener('change', function() {
      loadTaxInvoices(1);
    });

    document.getElementById('btnSearch')?.addEventListener('click', function() {
      loadTaxInvoices(1);
    });

    document.getElementById('btnReset')?.addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      loadTaxInvoices(1);
    });

    document.getElementById('btnCreate')?.addEventListener('click', createNewTaxInvoice);

    // ==================== Initialize ====================
    window.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Initializing sales tax invoice page...');

      try {
        // Load user profile
        loadUserProfile();

        // Load data
        await Promise.all([
          loadStatistics(),
          loadTaxInvoices(1)
        ]);

        console.log('‚úÖ Page initialized successfully');
      } catch (error) {
        console.error('‚ùå Error initializing page:', error);
      } finally {
        // Hide loading overlay
        setTimeout(() => {
          hidePageLoading();
        }, 1000);
      }
    });
  </script>
</body>
</html>
