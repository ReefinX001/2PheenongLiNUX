<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ระบบใบรับสินค้า - จัดการการรับสินค้าและวัสดุจากซัพพลายเออร์" />
  <title>ใบรับสินค้า - Goods Receipt</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Prompt', 'sans-serif'] },
          colors: { primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7' } }
        }
      }
    };
  </script>

  <!-- API Configuration -->
  <script>
    const API_BASE = '/api';

    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function resolvePhotoUrl(raw) {
      const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
      if (!raw || typeof raw !== 'string' || raw.trim() === '') return defaultAvatar;
      const sanitizedRaw = raw.trim();
      if (/^https?:\/\//.test(sanitizedRaw)) return sanitizedRaw;
      if (sanitizedRaw.startsWith('data:')) return sanitizedRaw;
      if (sanitizedRaw.startsWith('/uploads/employees/')) return sanitizedRaw;
      if (sanitizedRaw.startsWith('/uploads/')) return sanitizedRaw.replace(/^\/uploads\//, '/uploads/employees/');
      return '/uploads/employees/' + encodeURIComponent(sanitizedRaw);
    }

    async function fetchUserProfile() {
      try {
        const token = getAuthToken();
        if (!token) { loadFallbackUserData(); return; }
        const response = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
        });
        if (!response.ok) { if (response.status === 401) handleAuthError(); return; }
        const result = await response.json();
        if (result.success) {
          const userData = result.data || {};
          const userName = (userData.name || userData.username || 'ผู้ใช้').trim();
          const photoUrl = userData.photoUrl || userData.employee?.imageUrl || null;
          updateUserInterface(userName, photoUrl);
          localStorage.setItem('userName', userName);
          if (photoUrl) localStorage.setItem('userPhoto', photoUrl);
        }
      } catch (error) { loadFallbackUserData(); }
    }

    function updateUserInterface(userName, photoUrl) {
      const nameElement = document.getElementById('employeeName');
      const photoElement = document.getElementById('employeePhoto');
      if (nameElement) nameElement.textContent = userName;
      if (photoElement) {
        photoElement.src = resolvePhotoUrl(photoUrl);
        photoElement.onerror = function() { this.src = resolvePhotoUrl(null); };
      }
    }

    function loadFallbackUserData() {
      updateUserInterface(localStorage.getItem('userName') || 'ผู้ใช้', localStorage.getItem('userPhoto'));
    }

    function handleAuthError() {
      localStorage.clear();
      if (confirm('เซสชันหมดอายุ ต้องการเข้าสู่ระบบใหม่หรือไม่?')) window.location.href = '/login.html';
    }
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Prompt', sans-serif; font-size: 0.875rem; background: #f8f9fa; }
    .card { background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .form-control { border: 1px solid #ddd; border-radius: 4px; padding: 8px 12px; width: 100%; }
    .btn { border-radius: 4px; padding: 8px 16px; transition: all 0.2s; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; font-weight: 500; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-primary:hover { background: #0284c7; }
    .btn-outline { border: 1px solid #ddd; background: white; color: #333; }
    .btn-outline:hover { background: #f9f9fb; }
    .btn-sm { padding: 4px 12px; font-size: 0.875rem; }
    .btn-rounded { border-radius: 30px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th { background: #f8f9fa; text-align: left; padding: 12px; color: #6c757d; font-weight: 500; border-bottom: 2px solid #eee; }
    .table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; }
    .table tbody tr:hover { background: #f9fafb; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0.75rem 1rem; position: sticky; top: 0; z-index: 30; }
    .breadcrumb-item { color: #6c757d; }
    .breadcrumb-item a { color: #0ea5e9; text-decoration: none; }
    .breadcrumb-item a:hover { text-decoration: underline; }
    #toastContainer { position: fixed; top: 1rem; right: 1rem; z-index: 99999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
    .modal-backdrop { background: rgba(0,0,0,0.5); }
  </style>

  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">
</head>

<body class="bg-white w-full min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <div class="navbar bg-white shadow-md sticky top-0 mb-6 rounded-lg">
      <div class="flex-1 flex items-center space-x-6">
        <img src="/uploads/Logo2.png" alt="Logo" class="rounded-full shadow-lg" style="width: 40px; height: 40px;" />
        <span class="text-lg font-semibold">ระบบบัญชี - ใบรับสินค้า</span>
        <div id="mainMenuContainer" class="ml-auto"></div>
      </div>
      <div class="flex-none flex items-center space-x-2">
        <div class="flex items-center space-x-3 mr-4">
          <img id="employeePhoto" alt="Profile" class="w-10 h-10 rounded-full border-2 border-gray-300" />
          <span id="employeeName" class="text-sm font-medium text-gray-700">Loading...</span>
        </div>
        <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded">
          <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
        </button>
      </div>
    </div>

    <div class="text-sm mb-6">
      <ul class="flex flex-wrap gap-2">
        <li class="breadcrumb-item"><a href="/dashboard">หน้าหลัก</a></li>
        <li class="breadcrumb-item"><a href="/purchase">การซื้อ</a></li>
        <li class="breadcrumb-item">ใบรับสินค้า</li>
      </ul>
    </div>

    <div class="card p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="bi bi-inbox-fill text-primary-500 mr-3"></i> ใบรับสินค้า
          </h1>
          <p class="text-sm text-gray-600 mt-1">จัดการและติดตามใบรับสินค้าจากซัพพลายเออร์</p>
        </div>
      </div>

      <div class="mb-6">
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
          <div class="relative flex-1 max-w-md">
            <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="ค้นหาเลขที่เอกสาร, ผู้จำหน่าย..." class="form-control pl-10" />
          </div>
          <div class="flex gap-2 flex-wrap">
            <select id="statusFilter" class="form-control w-40">
              <option value="">ทุกสถานะ</option>
              <option value="pending">รอดำเนินการ</option>
              <option value="completed">รับสินค้าแล้ว</option>
              <option value="partial">รับบางส่วน</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
            <button id="btnCreateGoodsReceipt" class="btn btn-primary btn-rounded">
              <i class="bi bi-plus-circle mr-2"></i> สร้างใบรับสินค้าใหม่
            </button>
          </div>
        </div>
      </div>

      <div class="flex justify-between items-center mb-4">
        <div class="text-sm text-gray-600">แสดง <span id="recordCount">0</span> รายการ</div>
        <div class="flex items-center gap-2">
          <button id="prevPageBtn" class="btn btn-sm btn-outline" disabled><i class="bi bi-chevron-left"></i> ก่อนหน้า</button>
          <span id="pageInfo" class="text-sm text-gray-600">หน้า 1</span>
          <button id="nextPageBtn" class="btn btn-sm btn-outline">ถัดไป <i class="bi bi-chevron-right"></i></button>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">แสดง:</label>
          <select id="limitSelect" class="form-control w-20 text-sm">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th class="text-center w-12"><input type="checkbox" id="selectAll" /></th>
              <th>เลขที่เอกสาร</th>
              <th>วันที่รับ</th>
              <th>ผู้จำหน่าย</th>
              <th>อ้างอิง PO</th>
              <th class="text-right">มูลค่า</th>
              <th class="text-center">สถานะ</th>
              <th class="text-center">จัดการ</th>
            </tr>
          </thead>
          <tbody id="goodsReceiptTableBody">
            <tr><td colspan="8" class="text-center py-10 text-gray-500"><i class="bi bi-inbox text-4xl mb-2 block"></i><p class="font-medium">กำลังโหลดข้อมูล...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toastContainer"></div>

  <!-- View Modal -->
  <div id="viewGoodsReceiptModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50" style="display:none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-semibold"><i class="bi bi-eye text-primary-600"></i> รายละเอียดใบรับสินค้า</h2>
        <button id="closeViewModal" class="text-gray-400 hover:text-gray-600"><i class="bi bi-x-lg text-2xl"></i></button>
      </div>
      <div id="viewModalContent" class="p-6"></div>
      <div class="sticky bottom-0 bg-gray-50 px-6 py-4 flex justify-end gap-2 border-t">
        <button id="closeViewBtn" class="btn btn-primary">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="createGoodsReceiptModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50" style="display:none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto m-4">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-semibold"><i class="bi bi-plus-circle text-primary-600"></i> สร้างใบรับสินค้าใหม่</h2>
        <button id="closeCreateModal" class="text-gray-400 hover:text-gray-600"><i class="bi bi-x-lg text-2xl"></i></button>
      </div>
      <form id="createGoodsReceiptForm" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div><label class="block text-sm font-medium mb-1">เลขที่เอกสาร</label><input type="text" id="createDocumentNumber" class="form-control bg-gray-50" readonly /></div>
          <div><label class="block text-sm font-medium mb-1">วันที่รับสินค้า</label><input type="date" id="createReceiveDate" class="form-control" required /></div>
        </div>
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3"><i class="bi bi-building text-primary-600 mr-2"></i> ข้อมูลผู้จำหน่าย</h3>
          <div class="relative mb-4">
            <input type="text" id="createSupplierSearch" class="form-control" placeholder="ค้นหาชื่อผู้จำหน่าย..." />
            <div id="createSupplierResults" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
            <input type="hidden" id="createSupplierId" />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div><input type="text" id="createSupplierName" class="form-control bg-gray-50" placeholder="ชื่อผู้จำหน่าย" readonly /></div>
            <div><input type="text" id="createSupplierTaxId" class="form-control bg-gray-50" placeholder="เลขผู้เสียภาษี" readonly /></div>
          </div>
        </div>
        <div class="mb-6"><input type="text" id="createPOReference" class="form-control" placeholder="อ้างอิงจากใบสั่งซื้อ (PO)" /></div>
        <div class="mb-6">
          <div class="flex justify-between mb-3">
            <h3 class="text-lg font-semibold"><i class="bi bi-list-ul text-primary-600 mr-2"></i> รายการสินค้า</h3>
            <button type="button" id="createAddItemBtn" class="btn btn-sm btn-outline text-primary-600"><i class="bi bi-plus-circle mr-1"></i> เพิ่มรายการ</button>
          </div>
          <table class="table">
            <thead class="bg-gray-50"><tr><th>รายการ</th><th class="w-24 text-center">จำนวน</th><th class="w-32 text-right">ราคา/หน่วย</th><th class="w-32 text-right">รวม</th><th class="w-20"></th></tr></thead>
            <tbody id="createItemsBody">
              <tr>
                <td><input type="text" class="form-control item-description" placeholder="รายละเอียด..." /></td>
                <td><input type="number" class="form-control text-center item-quantity" value="1" min="0" step="0.01" /></td>
                <td><input type="number" class="form-control text-right item-price" value="0" min="0" step="0.01" /></td>
                <td class="text-right font-medium item-amount">0.00</td>
                <td class="text-center"><button type="button" class="text-red-500 remove-item-btn"><i class="bi bi-trash"></i></button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-4">
            <div><textarea id="createNotes" class="form-control" rows="3" placeholder="หมายเหตุ"></textarea></div>
            <div class="space-y-2">
              <div class="flex justify-between"><span class="text-sm">ยอดรวมก่อน VAT:</span><span id="createSubtotal">0.00</span></div>
              <div class="flex justify-between"><span class="text-sm">VAT:</span><div class="flex gap-2"><select id="createVatRate" class="form-control w-20 text-sm"><option value="0">0%</option><option value="7" selected>7%</option></select><span id="createVatAmount">0.00</span></div></div>
              <div class="flex justify-between pt-2 border-t"><span class="text-lg font-semibold">ยอดรวม:</span><span id="createTotalAmount" class="text-xl font-bold text-primary-600">0.00</span></div>
            </div>
          </div>
        </div>
        <div class="mb-6">
          <select id="createStatus" class="form-control w-64">
            <option value="pending">รอดำเนินการ</option>
            <option value="completed" selected>รับสินค้าแล้ว</option>
            <option value="partial">รับบางส่วน</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelCreateBtn" class="btn btn-outline"><i class="bi bi-x-circle mr-1"></i> ยกเลิก</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle mr-1"></i> บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editGoodsReceiptModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50" style="display:none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
        <h2 class="text-xl font-semibold"><i class="bi bi-pencil-square text-primary-600"></i> แก้ไขใบรับสินค้า</h2>
        <button id="closeEditModal" class="text-gray-400 hover:text-gray-600"><i class="bi bi-x-lg text-2xl"></i></button>
      </div>
      <form id="editGoodsReceiptForm" class="p-6">
        <input type="hidden" id="editGoodsReceiptId" />
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div><input type="text" id="editDocumentNumber" class="form-control bg-gray-50" readonly /></div>
          <div><input type="date" id="editReceiveDate" class="form-control" /></div>
        </div>
        <div class="mb-6">
          <div class="grid grid-cols-2 gap-4">
            <div><input type="text" id="editSupplierName" class="form-control bg-gray-50" readonly /></div>
            <div><input type="text" id="editSupplierTaxId" class="form-control bg-gray-50" readonly /></div>
          </div>
        </div>
        <div class="mb-6"><textarea id="editNotes" class="form-control" rows="3"></textarea></div>
        <div class="mb-6">
          <select id="editStatus" class="form-control w-64">
            <option value="pending">รอดำเนินการ</option>
            <option value="completed">รับสินค้าแล้ว</option>
            <option value="partial">รับบางส่วน</option>
            <option value="cancelled">ยกเลิก</option>
          </select>
        </div>
        <div id="editItemsDisplay" class="mb-6"></div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEditBtn" class="btn btn-outline">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_ENDPOINT = '/api/goods-receipts';
    let currentGoodsReceipts = [], currentPage = 1, currentLimit = 10, totalPages = 1, searchQuery = '', statusFilter = '', supplierSearchTimeout, searchTimeout;
    let isCreateModalOpen = false;

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', warning: 'bi-exclamation-triangle-fill', info: 'bi-info-circle-fill' };
      const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-orange-500', info: 'bg-blue-500' };
      toast.className = `flex items-center gap-3 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg mb-2 animate__animated animate__slideInRight`;
      toast.style.pointerEvents = 'auto';
      toast.innerHTML = `<i class="bi ${icons[type]} text-xl"></i><span>${message}</span><button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1"><i class="bi bi-x text-xl"></i></button>`;
      toastContainer.appendChild(toast);
      setTimeout(() => { toast.classList.add('animate__slideOutRight'); setTimeout(() => toast.remove(), 500); }, 4000);
    }

    function formatDateThai(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('th-TH'); }
    function formatCurrency(a) { return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(a || 0); }
    function getStatusBadge(s) {
      const badges = { pending: '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">รอดำเนินการ</span>', completed: '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">รับสินค้าแล้ว</span>', partial: '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">รับบางส่วน</span>', cancelled: '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">ยกเลิก</span>' };
      return badges[s] || '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">-</span>';
    }

    async function loadGoodsReceipts() {
      try {
        const token = getAuthToken();
        if (!token) { showToast('กรุณาเข้าสู่ระบบ', 'error'); return; }
        const params = new URLSearchParams({ page: currentPage, limit: currentLimit });
        if (searchQuery) params.append('search', searchQuery);
        if (statusFilter) params.append('status', statusFilter);
        const response = await fetch(`${API_ENDPOINT}?${params}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        if (result.success) {
          currentGoodsReceipts = result.data || [];
          totalPages = result.pagination?.pages || 1;
          renderGoodsReceiptsTable();
          updatePagination();
        }
      } catch (error) {
        showToast('เกิดข้อผิดพลาด', 'error');
        renderEmptyState();
      }
    }

    function renderGoodsReceiptsTable() {
      const tbody = document.getElementById('goodsReceiptTableBody');
      if (!currentGoodsReceipts || currentGoodsReceipts.length === 0) { renderEmptyState(); return; }
      tbody.innerHTML = currentGoodsReceipts.map(gr => `
        <tr>
          <td class="text-center"><input type="checkbox" value="${gr._id}" /></td>
          <td><span class="font-medium text-primary-600">${gr.documentNumber || '-'}</span></td>
          <td>${formatDateThai(gr.receiveDate)}</td>
          <td>${gr.supplier?.name || gr.supplierName || '-'}</td>
          <td>${gr.poReference || '-'}</td>
          <td class="text-right font-medium">${formatCurrency(gr.totalAmount)}</td>
          <td class="text-center">${getStatusBadge(gr.status)}</td>
          <td class="text-center"><div class="flex justify-center gap-1">
            <button onclick="viewGoodsReceipt('${gr._id}')" class="btn btn-sm btn-outline text-blue-600"><i class="bi bi-eye"></i></button>
            ${gr.status !== 'cancelled' ? `<button onclick="openEditGoodsReceiptModal('${gr._id}')" class="btn btn-sm btn-outline text-yellow-600"><i class="bi bi-pencil-square"></i></button><button onclick="deleteGoodsReceipt('${gr._id}')" class="btn btn-sm btn-outline text-red-600"><i class="bi bi-trash"></i></button>` : ''}
          </div></td>
        </tr>
      `).join('');
      document.getElementById('recordCount').textContent = currentGoodsReceipts.length;
    }

    function renderEmptyState() {
      document.getElementById('goodsReceiptTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-10 text-gray-500"><i class="bi bi-inbox text-4xl mb-2 block"></i><p class="font-medium">ไม่พบข้อมูล</p></td></tr>';
      document.getElementById('recordCount').textContent = '0';
    }

    function updatePagination() {
      const pageInfo = `หน้า ${currentPage} จาก ${totalPages}`;
      document.getElementById('pageInfo').textContent = pageInfo;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

    async function viewGoodsReceipt(id) {
      try {
        const response = await fetch(`${API_ENDPOINT}/${id}`, { headers: { 'Authorization': `Bearer ${getAuthToken()}` } });
        const result = await response.json();
        if (result.success && result.data) {
          const gr = result.data;
          let itemsHtml = gr.items && gr.items.length > 0 ? `<table class="table"><thead class="bg-gray-50"><tr><th>รายการ</th><th class="text-center">จำนวน</th><th class="text-right">ราคา</th><th class="text-right">รวม</th></tr></thead><tbody>${gr.items.map(i => `<tr><td>${i.description || '-'}</td><td class="text-center">${i.quantity}</td><td class="text-right">${formatCurrency(i.unitPrice)}</td><td class="text-right">${formatCurrency(i.amount)}</td></tr>`).join('')}</tbody></table>` : '';
          document.getElementById('viewModalContent').innerHTML = `
            <div class="grid grid-cols-2 gap-6 mb-6">
              <div class="bg-gray-50 rounded p-4"><div class="flex justify-between mb-2"><span>เลขที่:</span><span class="font-medium">${gr.documentNumber || '-'}</span></div><div class="flex justify-between mb-2"><span>วันที่:</span><span>${formatDateThai(gr.receiveDate)}</span></div><div class="flex justify-between mb-2"><span>PO:</span><span>${gr.poReference || '-'}</span></div><div class="flex justify-between"><span>สถานะ:</span>${getStatusBadge(gr.status)}</div></div>
              <div class="bg-gray-50 rounded p-4"><div class="flex justify-between mb-2"><span>ผู้จำหน่าย:</span><span>${gr.supplier?.name || '-'}</span></div><div class="flex justify-between"><span>เลขภาษี:</span><span>${gr.supplier?.taxId || '-'}</span></div></div>
            </div>
            <div class="mb-6">${itemsHtml}</div>
            <div class="bg-gray-50 rounded p-4"><div class="flex justify-between mb-2"><span>รวมก่อน VAT:</span><span>${formatCurrency(gr.subtotal)}</span></div><div class="flex justify-between mb-2"><span>VAT ${gr.vatRate||7}%:</span><span>${formatCurrency(gr.vatAmount)}</span></div><div class="flex justify-between pt-2 border-t"><span class="text-lg font-semibold">รวมทั้งสิ้น:</span><span class="text-xl font-bold text-primary-600">${formatCurrency(gr.totalAmount)}</span></div></div>
            ${gr.notes ? `<div class="mt-4 p-3 bg-gray-50 rounded"><strong>หมายเหตุ:</strong> ${gr.notes}</div>` : ''}
          `;
          document.getElementById('viewGoodsReceiptModal').style.display = 'flex';
        }
      } catch (error) {
        showToast('ไม่สามารถแสดงรายละเอียด', 'error');
      }
    }

    async function openCreateGoodsReceiptModal() {
      // ป้องกันการเปิด modal ซ้ำ
      if (isCreateModalOpen) {
        console.log('Modal is already open');
        return;
      }

      isCreateModalOpen = true;

      try {
        console.log('Fetching document number...');
        const response = await fetch(`${API_ENDPOINT}/generate-document-number`, { headers: { 'Authorization': `Bearer ${getAuthToken()}` } });

        console.log('Response status:', response.status);

        if (response.ok) {
          const result = await response.json();
          console.log('Generate number result:', result);

          // API ส่ง documentNumber มาที่ root level ไม่ได้อยู่ใน data
          if (result.success && result.documentNumber) {
            document.getElementById('createDocumentNumber').value = result.documentNumber;
            console.log('Document number set:', result.documentNumber);
          } else {
            console.warn('No document number in response:', result);
            document.getElementById('createDocumentNumber').value = 'GR-AUTO';
          }
        } else {
          console.error('API response not OK:', response.status);
          document.getElementById('createDocumentNumber').value = 'GR-AUTO';
        }

        // Set default date
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('createReceiveDate').value = `${year}-${month}-${day}`;

        // Reset form
        document.getElementById('createGoodsReceiptForm').reset();

        // Keep date and document number after reset
        document.getElementById('createReceiveDate').value = `${year}-${month}-${day}`;

        // Reset supplier fields
        document.getElementById('createSupplierId').value = '';
        document.getElementById('createSupplierName').value = '';
        document.getElementById('createSupplierTaxId').value = '';

        // Reset items table
        document.getElementById('createItemsBody').innerHTML = '<tr><td><input type="text" class="form-control item-description" placeholder="รายละเอียดสินค้า..." /></td><td><input type="number" class="form-control text-center item-quantity" value="1" min="0" step="0.01" /></td><td><input type="number" class="form-control text-right item-price" value="0" min="0" step="0.01" /></td><td class="text-right item-amount">0.00</td><td class="text-center"><button type="button" class="text-red-500 remove-item-btn"><i class="bi bi-trash"></i></button></td></tr>';

        // Calculate totals
        calculateCreateTotals();

        // Show modal
        const modal = document.getElementById('createGoodsReceiptModal');
        if (modal) {
          modal.style.display = 'flex';
          modal.classList.remove('hidden');
          console.log('Modal opened successfully');
        } else {
          console.error('Modal element not found!');
        }
      } catch (error) {
        console.error('Error in openCreateGoodsReceiptModal:', error);
        showToast('เกิดข้อผิดพลาดในการเปิดฟอร์ม: ' + error.message, 'error');
        isCreateModalOpen = false;
      }
    }

    async function searchSuppliers(query, resultsId, idField, nameField, taxField) {
      if (!query || query.length < 2) { document.getElementById(resultsId).classList.add('hidden'); return; }
      try {
        const response = await fetch(`${API_BASE}/supplier?search=${encodeURIComponent(query)}`, { headers: { 'Authorization': `Bearer ${getAuthToken()}` } });
        const result = await response.json();
        if (result.success && result.data) {
          const div = document.getElementById(resultsId);
          div.innerHTML = result.data.length === 0 ? '<div class="p-3 text-sm text-gray-500">ไม่พบ</div>' : result.data.map(s => `<div class="p-3 hover:bg-gray-50 cursor-pointer supplier-result-item" data-id="${s._id}" data-name="${s.name}" data-taxid="${s.taxId || ''}"><div class="font-medium">${s.name}</div><div class="text-sm text-gray-500">${s.taxId || ''}</div></div>`).join('');
          div.querySelectorAll('.supplier-result-item').forEach(item => {
            item.addEventListener('click', function() {
              document.getElementById(idField).value = this.dataset.id;
              document.getElementById(nameField).value = this.dataset.name;
              document.getElementById(taxField).value = this.dataset.taxid;
              div.classList.add('hidden');
            });
          });
          div.classList.remove('hidden');
        }
      } catch (error) {}
    }

    function calculateCreateTotals() {
      let subtotal = 0;
      document.querySelectorAll('#createItemsBody tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.item-quantity')?.value || 0);
        const price = parseFloat(row.querySelector('.item-price')?.value || 0);
        const amount = qty * price;
        const cell = row.querySelector('.item-amount');
        if (cell) cell.textContent = amount.toFixed(2);
        subtotal += amount;
      });
      const vatRate = parseFloat(document.getElementById('createVatRate')?.value || 7);
      const vatAmount = (subtotal * vatRate) / 100;
      document.getElementById('createSubtotal').textContent = subtotal.toFixed(2);
      document.getElementById('createVatAmount').textContent = vatAmount.toFixed(2);
      document.getElementById('createTotalAmount').textContent = (subtotal + vatAmount).toFixed(2);
    }

    function addCreateItemRow() {
      const tbody = document.getElementById('createItemsBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = '<td><input type="text" class="form-control item-description" /></td><td><input type="number" class="form-control text-center item-quantity" value="1" min="0" step="0.01" /></td><td><input type="number" class="form-control text-right item-price" value="0" min="0" step="0.01" /></td><td class="text-right item-amount">0.00</td><td class="text-center"><button type="button" class="text-red-500 remove-item-btn"><i class="bi bi-trash"></i></button></td>';
      tbody.appendChild(newRow);
    }

    async function handleCreateGoodsReceipt(e) {
      e.preventDefault();
      try {
        const supplierId = document.getElementById('createSupplierId').value;
        if (!supplierId) { showToast('กรุณาเลือกผู้จำหน่าย', 'warning'); return; }
        const items = [];
        document.querySelectorAll('#createItemsBody tr').forEach(row => {
          const desc = row.querySelector('.item-description')?.value;
          const qty = parseFloat(row.querySelector('.item-quantity')?.value || 0);
          const price = parseFloat(row.querySelector('.item-price')?.value || 0);
          if (desc && qty > 0) items.push({ description: desc, quantity: qty, unitPrice: price, amount: qty * price });
        });
        if (items.length === 0) { showToast('กรุณาเพิ่มรายการสินค้า', 'warning'); return; }
        const subtotal = items.reduce((sum, i) => sum + i.amount, 0);
        const vatRate = parseFloat(document.getElementById('createVatRate').value);
        const vatAmount = (subtotal * vatRate) / 100;
        const data = {
          documentNumber: document.getElementById('createDocumentNumber').value,
          receiveDate: document.getElementById('createReceiveDate').value,
          supplierId, supplierName: document.getElementById('createSupplierName').value,
          supplierTaxId: document.getElementById('createSupplierTaxId').value,
          poReference: document.getElementById('createPOReference').value,
          items, notes: document.getElementById('createNotes').value,
          vatRate, vatAmount, subtotal, totalAmount: subtotal + vatAmount,
          status: document.getElementById('createStatus').value
        };
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
          showToast('สร้างใบรับสินค้าสำเร็จ', 'success');
          closeCreateModal();
          loadGoodsReceipts();
        }
      } catch (error) {
        showToast('เกิดข้อผิดพลาด', 'error');
      }
    }

    async function openEditGoodsReceiptModal(id) {
      try {
        const response = await fetch(`${API_ENDPOINT}/${id}`, { headers: { 'Authorization': `Bearer ${getAuthToken()}` } });
        const result = await response.json();
        if (result.success && result.data) {
          const gr = result.data;
          document.getElementById('editGoodsReceiptId').value = gr._id;
          document.getElementById('editDocumentNumber').value = gr.documentNumber || '';
          document.getElementById('editReceiveDate').value = gr.receiveDate ? gr.receiveDate.split('T')[0] : '';
          document.getElementById('editSupplierName').value = gr.supplier?.name || gr.supplierName || '';
          document.getElementById('editSupplierTaxId').value = gr.supplier?.taxId || gr.supplierTaxId || '';
          document.getElementById('editNotes').value = gr.notes || '';
          document.getElementById('editStatus').value = gr.status || 'pending';
          document.getElementById('editItemsDisplay').innerHTML = gr.items && gr.items.length > 0 ? `<table class="table"><thead class="bg-gray-50"><tr><th>รายการ</th><th class="text-center">จำนวน</th><th class="text-right">ราคา</th><th class="text-right">รวม</th></tr></thead><tbody>${gr.items.map(i => `<tr><td>${i.description || '-'}</td><td class="text-center">${i.quantity}</td><td class="text-right">${formatCurrency(i.unitPrice)}</td><td class="text-right">${formatCurrency(i.amount)}</td></tr>`).join('')}</tbody></table>` : '';
          document.getElementById('editGoodsReceiptModal').style.display = 'flex';
        }
      } catch (error) {
        showToast('ไม่สามารถเปิดหน้าแก้ไข', 'error');
      }
    }

    async function handleEditGoodsReceipt(e) {
      e.preventDefault();
      try {
        const id = document.getElementById('editGoodsReceiptId').value;
        const data = {
          receiveDate: document.getElementById('editReceiveDate').value,
          notes: document.getElementById('editNotes').value,
          status: document.getElementById('editStatus').value
        };
        const response = await fetch(`${API_ENDPOINT}/${id}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${getAuthToken()}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
          showToast('แก้ไขสำเร็จ', 'success');
          closeEditModal();
          loadGoodsReceipts();
        }
      } catch (error) {
        showToast('เกิดข้อผิดพลาด', 'error');
      }
    }

    async function deleteGoodsReceipt(id) {
      if (!confirm('ต้องการลบใบรับสินค้านี้?')) return;
      try {
        const response = await fetch(`${API_ENDPOINT}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${getAuthToken()}` } });
        const result = await response.json();
        if (result.success) {
          showToast('ลบสำเร็จ', 'success');
          loadGoodsReceipts();
        }
      } catch (error) {
        showToast('เกิดข้อผิดพลาด', 'error');
      }
    }

    function closeViewModal() {
      document.getElementById('viewGoodsReceiptModal').style.display = 'none';
      document.getElementById('viewGoodsReceiptModal').classList.add('hidden');
    }

    function closeCreateModal() {
      document.getElementById('createGoodsReceiptModal').style.display = 'none';
      document.getElementById('createGoodsReceiptModal').classList.add('hidden');
      isCreateModalOpen = false; // Reset flag
    }

    function closeEditModal() {
      document.getElementById('editGoodsReceiptModal').style.display = 'none';
      document.getElementById('editGoodsReceiptModal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', function() {
      fetchUserProfile();
      loadGoodsReceipts();

      document.getElementById('searchInput')?.addEventListener('input', e => {
        clearTimeout(searchTimeout);
        searchQuery = e.target.value;
        searchTimeout = setTimeout(() => { currentPage = 1; loadGoodsReceipts(); }, 500);
      });

      document.getElementById('statusFilter')?.addEventListener('change', e => { statusFilter = e.target.value; currentPage = 1; loadGoodsReceipts(); });
      document.getElementById('limitSelect')?.addEventListener('change', e => { currentLimit = parseInt(e.target.value); currentPage = 1; loadGoodsReceipts(); });

      document.getElementById('prevPageBtn')?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadGoodsReceipts(); } });
      document.getElementById('nextPageBtn')?.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; loadGoodsReceipts(); } });

      document.getElementById('btnCreateGoodsReceipt')?.addEventListener('click', openCreateGoodsReceiptModal);
      document.getElementById('closeCreateModal')?.addEventListener('click', closeCreateModal);
      document.getElementById('cancelCreateBtn')?.addEventListener('click', closeCreateModal);
      document.getElementById('createGoodsReceiptForm')?.addEventListener('submit', handleCreateGoodsReceipt);
      document.getElementById('createAddItemBtn')?.addEventListener('click', addCreateItemRow);

      document.getElementById('createSupplierSearch')?.addEventListener('input', e => {
        clearTimeout(supplierSearchTimeout);
        supplierSearchTimeout = setTimeout(() => searchSuppliers(e.target.value, 'createSupplierResults', 'createSupplierId', 'createSupplierName', 'createSupplierTaxId'), 300);
      });

      document.getElementById('createItemsBody')?.addEventListener('input', e => {
        if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) calculateCreateTotals();
      });

      document.getElementById('createItemsBody')?.addEventListener('click', e => {
        if (e.target.closest('.remove-item-btn')) {
          const row = e.target.closest('tr');
          if (document.querySelectorAll('#createItemsBody tr').length > 1) { row.remove(); calculateCreateTotals(); }
          else showToast('ต้องมีรายการอย่างน้อย 1 รายการ', 'warning');
        }
      });

      document.getElementById('createVatRate')?.addEventListener('change', calculateCreateTotals);
      document.getElementById('closeViewModal')?.addEventListener('click', closeViewModal);
      document.getElementById('closeViewBtn')?.addEventListener('click', closeViewModal);
      document.getElementById('closeEditModal')?.addEventListener('click', closeEditModal);
      document.getElementById('cancelEditBtn')?.addEventListener('click', closeEditModal);
      document.getElementById('editGoodsReceiptForm')?.addEventListener('submit', handleEditGoodsReceipt);

      document.getElementById('btnLogout')?.addEventListener('click', () => {
        if (confirm('ต้องการออกจากระบบ?')) {
          localStorage.clear();
          window.location.href = '/login.html';
        }
      });

      window.addEventListener('click', e => {
        if (e.target === document.getElementById('viewGoodsReceiptModal')) closeViewModal();
        if (e.target === document.getElementById('createGoodsReceiptModal')) closeCreateModal();
        if (e.target === document.getElementById('editGoodsReceiptModal')) closeEditModal();
      });
    });
  </script>

  <script src="/js/account-menu.js?v=light-v2"></script>
</body>
</html>
