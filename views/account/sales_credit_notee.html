<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ใบลดหนี้การขาย - Sales Credit Note</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Bootstrap CSS 5.3.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Account Menu CSS -->
  <link rel="stylesheet" href="/css/account-menu.css?v=light-v3">

  <style>
    * {
      font-family: 'Prompt', sans-serif;
    }

    body {
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(255, 255, 255, 0.95) !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 999999 !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      transition: opacity 0.5s ease-out !important;
    }

    .loading-overlay.animate__fadeOut {
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Navbar */
    .navbar {
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Cards */
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Badges */
    .badge-pending {
      background-color: #fef3c7;
      color: #92400e;
    }

    .badge-approved {
      background-color: #d1fae5;
      color: #065f46;
    }

    .badge-rejected {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .badge-cancelled {
      background-color: #f1f5f9;
      color: #475569;
    }

    /* Table */
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    table {
      margin-bottom: 0;
    }

    thead {
      background-color: #f8fafc;
    }

    th {
      font-weight: 600;
      color: #475569;
      font-size: 0.875rem;
      text-transform: uppercase;
      white-space: nowrap;
    }

    tbody tr:hover {
      background-color: #f8fafc;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay animate__animated animate__fadeIn">
    <div style="text-align: center;">
      <div id="lottieContainer" style="width: 300px; height: 300px; margin: 0 auto;"></div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-light sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center gap-3">
          <img src="/uploads/Logo2.png" alt="Logo" class="rounded-circle" style="width: 40px; height: 40px;">
          <h5 class="mb-0 fw-semibold">ใบลดหนี้การขาย</h5>
          <div id="mainMenuContainer"></div>
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center gap-2">
            <img id="employeePhoto" alt="Profile" class="rounded-circle border border-2" 
                 style="width: 40px; height: 40px;" src="/img/default-avatar.svg">
            <span id="employeeName" class="fw-medium">Loading...</span>
          </div>
          <button id="btnLogout" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-box-arrow-right"></i> ออกจากระบบ
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid px-4 py-4">
    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-secondary small mb-1">รายการทั้งหมด</div>
              <h3 class="mb-0 fw-bold" id="totalCount">0</h3>
            </div>
            <div class="bg-primary bg-opacity-10 p-3 rounded">
              <i class="bi bi-file-earmark-text text-primary fs-4"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-secondary small mb-1">รออนุมัติ</div>
              <h3 class="mb-0 fw-bold text-warning" id="pendingCount">0</h3>
            </div>
            <div class="bg-warning bg-opacity-10 p-3 rounded">
              <i class="bi bi-clock-history text-warning fs-4"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-secondary small mb-1">อนุมัติแล้ว</div>
              <h3 class="mb-0 fw-bold text-success" id="approvedCount">0</h3>
            </div>
            <div class="bg-success bg-opacity-10 p-3 rounded">
              <i class="bi bi-check-circle text-success fs-4"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-secondary small mb-1">ยอดรวมทั้งหมด</div>
              <h3 class="mb-0 fw-bold text-primary" id="totalAmount">฿0.00</h3>
            </div>
            <div class="bg-primary bg-opacity-10 p-3 rounded">
              <i class="bi bi-currency-dollar text-primary fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
              <input type="text" id="searchInput" class="form-control" placeholder="ค้นหา...">
            </div>
          </div>
          <div class="col-md-3">
            <select id="statusFilter" class="form-select">
              <option value="all">ทุกสถานะ</option>
              <option value="pending">รออนุมัติ</option>
              <option value="approved">อนุมัติแล้ว</option>
              <option value="rejected">ปฏิเสธ</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="date" id="dateFilter" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>เลขที่ใบลดหนี้</th>
              <th>วันที่</th>
              <th>ลูกค้า</th>
              <th>สถานะ</th>
              <th class="text-end">ยอดรวม</th>
              <th>ผู้สร้าง</th>
              <th class="text-center">การจัดการ</th>
            </tr>
          </thead>
          <tbody id="creditNoteTableBody">
            <tr>
              <td colspan="7" class="text-center py-5">
                <i class="bi bi-inbox display-4 d-block mb-2 text-muted"></i>
                <p class="text-muted">กำลังโหลดข้อมูล...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center p-3 border-top">
        <div class="text-muted small">
          แสดง <span id="showingStart">0</span> - <span id="showingEnd">0</span> จาก <span id="showingTotal">0</span>
        </div>
        <div class="d-flex gap-2">
          <button id="prevPage" class="btn btn-sm btn-outline-secondary" disabled>
            <i class="bi bi-chevron-left"></i>
          </button>
          <div id="paginationNumbers" class="d-flex gap-1"></div>
          <button id="nextPage" class="btn btn-sm btn-outline-secondary" disabled>
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <!-- Account Menu Script -->
  <script src="/js/account-menu.js?v=light-v2"></script>

  <script>
    console.log('Sales Credit Note - Script started');

    // ==================== Loading Animation ====================
    const loadingOverlay = document.getElementById('loadingOverlay');
    const lottieContainer = document.getElementById('lottieContainer');
    let lottieAnimation = null;

    function showLoading() {
      console.log('Show loading');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        loadingOverlay.classList.remove('animate__fadeOut');
        loadingOverlay.classList.add('animate__fadeIn');
      }
    }

    function hideLoading() {
      console.log('Hide loading');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('animate__fadeIn');
        loadingOverlay.classList.add('animate__fadeOut');
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
        }, 500);
      }
    }

    // Load Lottie
    if (lottieContainer && typeof lottie !== 'undefined') {
      try {
        lottieAnimation = lottie.loadAnimation({
          container: lottieContainer,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: '/Loading/Loading.json'
        });
        console.log('Lottie loaded successfully');
      } catch (error) {
        console.error('Lottie error:', error);
        hideLoading();
      }
    } else {
      console.warn('Lottie not available');
      hideLoading();
    }

    // ==================== Helpers ====================
    function getAuthToken() {
      return localStorage.getItem('authToken') ||
             localStorage.getItem('token') ||
             sessionStorage.getItem('authToken') ||
             sessionStorage.getItem('token');
    }

    function resolvePhotoUrl(raw) {
      try {
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
        if (!raw || typeof raw !== 'string' || raw.trim() === '') return defaultAvatar;
        const sanitizedRaw = raw.trim();
        if (/^https?:\/\//.test(sanitizedRaw)) return sanitizedRaw;
        if (sanitizedRaw.startsWith('data:')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/employees/')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/')) {
          return sanitizedRaw.replace(/^\/uploads\//, '/uploads/employees/');
        }
        return '/uploads/employees/' + encodeURIComponent(sanitizedRaw);
      } catch (error) {
        console.error('Error resolving photo URL:', error);
        return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
      }
    }

    function updateUserInterface(userName, photoUrl) {
      try {
        const nameElement = document.getElementById('employeeName');
        const photoElement = document.getElementById('employeePhoto');
        if (nameElement) nameElement.textContent = userName;
        if (photoElement) {
          photoElement.src = resolvePhotoUrl(photoUrl);
          photoElement.alt = `รูปโปรไฟล์ของ ${userName}`;
          photoElement.onerror = function() {
            this.src = resolvePhotoUrl(null);
          };
        }
      } catch (error) {
        console.error('Error updating user interface:', error);
      }
    }

    function loadFallbackUserData() {
      try {
        const fallbackName = localStorage.getItem('userName') || 'ผู้ใช้';
        const fallbackPhoto = localStorage.getItem('userPhoto');
        updateUserInterface(fallbackName, fallbackPhoto);
      } catch (error) {
        console.error('Error loading fallback data:', error);
      }
    }

    async function loadUserProfile() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('No auth token for user profile');
          loadFallbackUserData();
          return;
        }

        const res = await fetch('/api/users/me', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Cache-Control': 'no-cache'
          }
        });

        if (!res.ok) {
          console.warn('Failed to load user profile:', res.status);
          loadFallbackUserData();
          return;
        }

        const json = await res.json();
        if (!json.success || !json.data) {
          loadFallbackUserData();
          return;
        }

        const userName = json.data.name || json.data.username || 'ผู้ใช้';
        const photoUrl = json.data.photoUrl || json.data.employee?.imageUrl || null;

        localStorage.setItem('userName', userName);
        if (photoUrl) localStorage.setItem('userPhoto', photoUrl);

        updateUserInterface(userName, photoUrl);
      } catch (error) {
        console.error('Error loading user profile:', error);
        loadFallbackUserData();
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount || 0);
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // ==================== State ====================
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;
    const limit = 10;

    // ==================== Load Statistics ====================
    async function loadStatistics() {
      console.log('Loading statistics...');
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('No auth token for statistics');
          return;
        }

        const response = await fetch('/api/sales-credit-notes/stats', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Stats response status:', response.status);
        const result = await response.json();
        console.log('Stats result:', result);

        if (result.success && result.data) {
          document.getElementById('totalCount').textContent = result.data.totalCount || 0;
          document.getElementById('pendingCount').textContent = result.data.pendingCount || 0;
          document.getElementById('approvedCount').textContent = result.data.approvedCount || 0;
          document.getElementById('totalAmount').textContent = formatCurrency(result.data.totalAmount || 0);
        }
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // ==================== Load Credit Notes ====================
    async function loadCreditNotes() {
      console.log('Loading credit notes...');
      showLoading();

      try {
        const token = getAuthToken();
        if (!token) {
          console.error('No auth token - redirecting to login');
          hideLoading();
          alert('กรุณาเข้าสู่ระบบก่อนใช้งาน');
          window.location.href = '/login.html';
          return;
        }

        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;

        let url = `/api/sales-credit-notes?page=${currentPage}&limit=${limit}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (status && status !== 'all') url += `&status=${status}`;
        if (dateFilter) url += `&dateFrom=${dateFilter}&dateTo=${dateFilter}`;

        console.log('Fetching:', url);
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Result:', result);

        if (result.success) {
          renderTable(result.data || []);
          updatePagination(result.pagination || {});
        } else {
          console.error('API error:', result.error);
          renderTable([]);
        }
      } catch (error) {
        console.error('Error loading credit notes:', error);
        renderTable([]);
      } finally {
        hideLoading();
      }
    }

    // ==================== Render Table ====================
    function renderTable(data) {
      console.log('Rendering table with', data.length, 'items');
      const tbody = document.getElementById('creditNoteTableBody');

      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-5">
              <i class="bi bi-inbox display-4 d-block mb-2 text-muted"></i>
              <p class="text-muted">ไม่พบข้อมูล</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = data.map(note => {
        const statusBadge = getStatusBadge(note.status);
        const customerName = note.customer?.displayName || 'ไม่ระบุ';
        const createdBy = note.createdBy?.name || note.createdBy?.username || '-';

        return `
          <tr>
            <td class="fw-medium text-primary">${note.creditNoteNumber || '-'}</td>
            <td>${formatDate(note.issueDate)}</td>
            <td>${customerName}</td>
            <td>${statusBadge}</td>
            <td class="text-end fw-semibold">${formatCurrency(note.totalAmount)}</td>
            <td>${createdBy}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <button onclick="viewNote('${note._id}')" class="btn btn-outline-primary" title="ดู">
                  <i class="bi bi-eye"></i>
                </button>
                ${note.status === 'pending' ? `
                  <button onclick="approveNote('${note._id}')" class="btn btn-success" title="อนุมัติ">
                    <i class="bi bi-check"></i>
                  </button>
                  <button onclick="rejectNote('${note._id}')" class="btn btn-danger" title="ปฏิเสธ">
                    <i class="bi bi-x"></i>
                  </button>
                ` : ''}
                ${note.status !== 'cancelled' && note.status !== 'approved' ? `
                  <button onclick="cancelNote('${note._id}')" class="btn btn-outline-secondary" title="ยกเลิก">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getStatusBadge(status) {
      const badges = {
        pending: '<span class="badge badge-pending">รออนุมัติ</span>',
        approved: '<span class="badge badge-approved">อนุมัติแล้ว</span>',
        rejected: '<span class="badge badge-rejected">ปฏิเสธ</span>',
        cancelled: '<span class="badge badge-cancelled">ยกเลิก</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">-</span>';
    }

    // ==================== Pagination ====================
    function updatePagination(pagination) {
      currentPage = pagination.page || 1;
      totalPages = pagination.pages || 1;
      totalRecords = pagination.total || 0;

      const start = totalRecords > 0 ? (currentPage - 1) * limit + 1 : 0;
      const end = Math.min(currentPage * limit, totalRecords);

      document.getElementById('showingStart').textContent = start;
      document.getElementById('showingEnd').textContent = end;
      document.getElementById('showingTotal').textContent = totalRecords;

      document.getElementById('prevPage').disabled = currentPage <= 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;

      renderPaginationNumbers();
    }

    function renderPaginationNumbers() {
      const container = document.getElementById('paginationNumbers');
      const maxVisible = 5;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = Math.min(totalPages, start + maxVisible - 1);

      if (end - start < maxVisible - 1) {
        start = Math.max(1, end - maxVisible + 1);
      }

      let html = '';
      for (let i = start; i <= end; i++) {
        html += `
          <button onclick="goToPage(${i})" class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}">
            ${i}
          </button>
        `;
      }
      container.innerHTML = html;
    }

    function goToPage(page) {
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        loadCreditNotes();
      }
    }

    // ==================== Event Listeners ====================
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadCreditNotes();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        loadCreditNotes();
      }
    });

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentPage = 1;
        loadCreditNotes();
      }, 500);
    });

    document.getElementById('statusFilter').addEventListener('change', () => {
      currentPage = 1;
      loadCreditNotes();
    });

    document.getElementById('dateFilter').addEventListener('change', () => {
      currentPage = 1;
      loadCreditNotes();
    });

    // ==================== Actions ====================
    function viewNote(id) {
      window.location.href = `/account/sales_credit_note_detail.html?id=${id}`;
    }

    async function approveNote(id) {
      if (!confirm('คุณต้องการอนุมัติใบลดหนี้นี้ใช่หรือไม่?')) return;

      showLoading();
      try {
        const token = getAuthToken();
        const response = await fetch(`/api/sales-credit-notes/${id}/approve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (result.success) {
          alert('อนุมัติสำเร็จ');
          loadStatistics();
          loadCreditNotes();
        } else {
          alert('เกิดข้อผิดพลาด: ' + (result.error || ''));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาด');
      } finally {
        hideLoading();
      }
    }

    async function rejectNote(id) {
      const reason = prompt('กรุณาระบุเหตุผล:');
      if (!reason) return;

      showLoading();
      try {
        const token = getAuthToken();
        const response = await fetch(`/api/sales-credit-notes/${id}/reject`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        const result = await response.json();
        if (result.success) {
          alert('ปฏิเสธสำเร็จ');
          loadStatistics();
          loadCreditNotes();
        } else {
          alert('เกิดข้อผิดพลาด: ' + (result.error || ''));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาด');
      } finally {
        hideLoading();
      }
    }

    async function cancelNote(id) {
      if (!confirm('คุณต้องการยกเลิกใบลดหนี้นี้ใช่หรือไม่?')) return;

      showLoading();
      try {
        const token = getAuthToken();
        const response = await fetch(`/api/sales-credit-notes/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (result.success) {
          alert('ยกเลิกสำเร็จ');
          loadStatistics();
          loadCreditNotes();
        } else {
          alert('เกิดข้อผิดพลาด: ' + (result.error || ''));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาด');
      } finally {
        hideLoading();
      }
    }

    // ==================== Logout ====================
    document.getElementById('btnLogout').addEventListener('click', () => {
      if (confirm('ออกจากระบบ?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('userName');
        localStorage.removeItem('userPhoto');
        localStorage.removeItem('userInfo');
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('token');
        window.location.href = '/login.html';
      }
    });

    // ==================== Initialize ====================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM ready, initializing...');
      loadFallbackUserData(); // โหลด fallback ก่อน
      loadUserProfile(); // แล้วเรียก API
      loadStatistics();
      loadCreditNotes();
    });

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      console.log('Document already loaded, initializing...');
      setTimeout(() => {
        loadFallbackUserData(); // โหลด fallback ก่อน
        loadUserProfile(); // แล้วเรียก API
        loadStatistics();
        loadCreditNotes();
      }, 100);
    }
  </script>
</body>
</html>
