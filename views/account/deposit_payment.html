<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ระบบจ่ายเงินมัดจำ - จัดการการจ่ายเงินมัดจำให้ผู้จำหน่าย" />
  <meta name="keywords" content="deposit payment, จ่ายเงินมัดจำ, เงินมัดจำผู้จำหน่าย, advance payment, ชำระเงินมัดจำ" />
  <meta name="author" content="2 พี่น้อง โมบาย" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="จ่ายเงินมัดจำ" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>จ่ายเงินมัดจำ - Deposit Payment</title>

  <!-- Google Font with performance optimization -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet" /></noscript>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" crossorigin />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Lottie Animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <!-- Required Libraries for Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Tailwind CSS with performance optimization -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Add Thai calendar locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/locale/th.js"></script>

  <!-- Tailwind Configuration -->
  <script>
    // Wait for tailwind to be available
    (function() {
      function configureTailwind() {
        try {
          if (typeof tailwind !== 'undefined') {
            tailwind.config = {
              theme: {
                extend: {
                  fontFamily: {
                    sans: ['Prompt', 'sans-serif'],
                  },
                  colors: {
                    primary: {
                      50: '#f0f9ff',
                      100: '#e0f2fe',
                      500: '#0ea5e9',
                      600: '#0284c7',
                    }
                  },
                  gridTemplateColumns: {
                    '16': 'repeat(16, minmax(0, 1fr))',
                  }
                },
              }
            };
          } else {
            setTimeout(configureTailwind, 100);
          }
        } catch (error) {
          console.error('Error configuring Tailwind:', error);
        }
      }
      configureTailwind();
    })();
  </script>

  <!-- Enhanced API and User Management -->
  <script>
    const API_BASE = '/api';

    function getAuthToken() {
      try {
        return localStorage.getItem('authToken');
      } catch (error) {
        console.error('Error getting auth token:', error);
        return null;
      }
    }

    function resolvePhotoUrl(raw) {
      try {
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
        if (!raw || typeof raw !== 'string' || raw.trim() === '') return defaultAvatar;
        const sanitizedRaw = raw.trim();
        if (/^https?:\/\//.test(sanitizedRaw)) return sanitizedRaw;
        if (sanitizedRaw.startsWith('data:')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/employees/')) return sanitizedRaw;
        if (sanitizedRaw.startsWith('/uploads/')) {
          return sanitizedRaw.replace(/^\/uploads\//, '/uploads/employees/');
        }
        return '/uploads/employees/' + encodeURIComponent(sanitizedRaw);
      } catch (error) {
        console.error('Error resolving photo URL:', error);
        return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNlNWU3ZWIiLz4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSIxOCIgZmlsbD0iIzljYTNhZiIvPgogIDxlbGxpcHNlIGN4PSI1MCIgY3k9Ijc1IiByeD0iMzAiIHJ5PSIyMCIgZmlsbD0iIzljYTNhZiIvPgo8L3N2Zz4=';
      }
    }

    async function fetchUserProfile() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('No authentication token found');
          loadFallbackUserData();
          return;
        }
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(`${API_BASE}/users/me`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
          if (response.status === 401) {
            handleAuthError();
            return;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || 'Failed to load profile');
        }
        const userData = result.data || {};
        const userName = (userData.name || userData.username || 'ผู้ใช้').trim();
        const photoUrl = userData.photoUrl || userData.employee?.imageUrl || null;
        updateUserInterface(userName, photoUrl);
        localStorage.setItem('userName', userName);
        if (photoUrl) localStorage.setItem('userPhoto', photoUrl);
      } catch (error) {
        console.error('Error fetching user profile:', error);
        if (error.name === 'AbortError') {
          console.warn('Profile fetch timeout');
        } else if (error.message && error.message.includes('401')) {
          handleAuthError();
          return;
        }
        loadFallbackUserData();
      }
    }

    function updateUserInterface(userName, photoUrl) {
      try {
        const nameElement = document.getElementById('employeeName');
        const photoElement = document.getElementById('employeePhoto');
        if (nameElement) nameElement.textContent = userName;
        if (photoElement) {
          photoElement.src = resolvePhotoUrl(photoUrl);
          photoElement.alt = `รูปโปรไฟล์ของ ${userName}`;
          photoElement.onerror = function() {
            this.src = resolvePhotoUrl(null);
          };
        }
      } catch (error) {
        console.error('Error updating user interface:', error);
      }
    }

    function loadFallbackUserData() {
      try {
        const fallbackName = localStorage.getItem('userName') || 'ผู้ใช้';
        const fallbackPhoto = localStorage.getItem('userPhoto');
        updateUserInterface(fallbackName, fallbackPhoto);
      } catch (error) {
        console.error('Error loading fallback data:', error);
      }
    }

    function handleAuthError() {
      try {
        console.warn('Authentication error - session expired');
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('userPhoto');
        if (confirm('เซสชันหมดอายุ ต้องการเข้าสู่ระบบใหม่หรือไม่?')) {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Error handling auth error:', error);
        window.location.href = '/login.html';
      }
    }
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    #mainContent {
      flex: 1;
    }
    
    body {
      font-family: 'Prompt', sans-serif;
      font-size: 0.875rem;
      background-color: #f8f9fa;
    }
    
    .breadcrumb-item {
      color: #6c757d;
    }
    
    .breadcrumb-item a {
      color: #0ea5e9;
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      text-decoration: underline;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-control {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      width: 100%;
    }
    
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
      transition: all 0.2s;
    }
    
    .btn-rounded {
      border-radius: 30px;
    }
    
    .btn-outline-primary {
      border: 1px solid #0ea5e9;
      color: #0ea5e9;
      background-color: white;
    }
    
    .btn-outline-primary:hover {
      background-color: #f0f9ff;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 10px;
      color: #6c757d;
      font-weight: 500;
      border-bottom: 1px solid #eee;
    }

    .table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    
    .text-right {
      text-align: right;
    }
    
    .page-link {
      min-width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      text-decoration: none;
      margin: 0 2px;
    }

    .page-link:hover {
      background-color: #f9f9fb;
    }
    
    .page-link.active {
      background-color: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    
    .dropdown-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      color: #333;
    }

    .account-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .account-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .account-list li:hover {
      background-color: #f9f9fb;
    }

    .account-list li.active {
      background-color: #f0f9ff;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .date-range {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-range:focus {
      border-color: #0ea5e9;
      outline: none;
    }

    .negative-value {
      color: #ef4444;
    }
    
    .navbar {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .flex-1 {
      flex: 1;
    }
    
    .flex-none {
      flex: none;
    }
    
    .btn-fancy {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
    }
    
    .btn-fancy:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform 0.5s, opacity 1s;
    }
    
    .btn-fancy:active:after {
      transform: scale(0, 0);
      opacity: 0.3;
      transition: 0s;
    }
    
    /* Dropdown menu styling */
    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
    }
    
    .menu-horizontal {
      display: flex;
      flex-direction: row;
    }
    
    .dropdown {
      position: relative;
    }
    
    .dropdown > a { /* Main category link */
      display: flex;
      padding: 0.5rem 1rem; /* Adjust as needed */
      cursor: pointer;
      align-items: center; /* Vertically align icon and text */
    }
    
    /* First Level Dropdown Panel */
    .dropdown > ul {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      z-index: 40;
      padding: 0.5rem;
    }

    .dropdown:hover > ul,
    .dropdown:focus-within > ul {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* Nested Dropdown Panels (Fly-out) */
    .dropdown ul li.dropdown > ul {
      position: absolute;
      top: -0.5rem;
      left: 100%;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateX(10px);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      z-index: 45;
      padding: 0.5rem;
    }

    .dropdown ul li.dropdown:hover > ul,
    .dropdown ul li.dropdown:focus-within > ul {
      opacity: 1;
      visibility: visible;
      transform: translateX(0);
    }

    .dropdown ul li {
      list-style: none;
    }

    .dropdown ul li a {
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      color: #374151;
      text-decoration: none;
      border-radius: 0.25rem;
      white-space: nowrap;
    }

    .dropdown ul li a:hover {
      background-color: #f3f4f6;
    }

    /* Specific for an LI that is a dropdown trigger within another dropdown */
    .dropdown ul li.dropdown > a {
      justify-content: space-between; /* Puts arrow icon to the right */
    }
    
    .submenu-item { /* General styling for submenu items, including hover effect */
      transition: background-color 0.2s, padding-left 0.2s;
      border-left: 3px solid transparent;
      margin-bottom: 2px; /* Spacing between items */
    }
    
    .submenu-item:hover { /* Visual cue on hover */
      /* border-left-color: #0ea5e9; */ /* Original style, can be kept or removed */
      /* padding-left: 0.25rem; */ /* Original style, can be kept or removed */
    }
    
    /* User badge */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: rgba(14, 165, 233, 0.1);
      border-radius: 30px;
    }
    
    .user-avatar {
      background-color: #0ea5e9;
      color: white;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }
    
    /* Loader */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0ea5e9;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .expense-voucher {
      margin-left: 20px;
      position: relative;
    }
    
    .expense-voucher::before {
      content: '';
      position: absolute;
      left: -15px;
      top: 50%;
      width: 10px;
      height: 1px;
      background-color: #cbd5e0;
    }
    
    /* Income Statement specific styles */
    .fin-statement-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .fin-statement-table td {
      padding: 10px 16px;
      vertical-align: middle;
      border-bottom: 1px solid #e5e7eb;
    }

    .fin-statement-table .item-title {
      font-weight: 500;
    }

    .fin-statement-table .bold {
      font-weight: 600;
    }

    .fin-statement-table .section-header {
      font-weight: 600;
      font-size: 1.05rem;
      color: #111827;
    }

    .fin-statement-table .section-total {
      font-weight: 600;
      color: #1e40af;
      background-color: #f0f9ff;
    }

    .fin-statement-table .grand-total {
      font-weight: 700;
      color: #0284c7;
      background-color: #e0f2fe;
      font-size: 1.05rem;
    }
    
    .fin-statement-table .indent-1 {
      padding-left: 2rem;
    }
    
    .fin-statement-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .overview-card {
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      background-color: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .overview-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .metric-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
    }

    .trend-up {
      color: #10b981;
    }

    .trend-down {
      color: #ef4444;
    }
    
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    .view-switcher {
      display: flex;
      padding: 0.25rem;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .view-option {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .view-option.active {
      background-color: white;
      color: #0ea5e9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .action-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 0.375rem;
      border: 1px solid #e5e7eb;
      background-color: white;
      color: #374151;
      transition: all 0.2s;
    }

    .action-button:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }

    .period-selector {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      background-color: white;
      font-size: 0.875rem;
      color: #374151;
      outline: none;
    }
    
    /* Dashboard Card Styles */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-card {
      background-color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .card-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .comparison-value {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .comparison-up {
      color: #10b981;
    }

    .comparison-down {
      color: #ef4444;
    }
    
    /* Menu bar styles */
    .menu-bar {
      display: flex;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .menu-item {
      padding: 0.75rem 1.25rem;
      white-space: nowrap;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .menu-item:hover {
      background-color: #f3f4f6;
      color: #0ea5e9;
    }

    .menu-item.active {
      border-bottom-color: #0ea5e9;
      color: #0ea5e9;
      font-weight: 500;
    }
    
    .menu-spacer {
      flex: 1;
    }
    
    .month-selector {
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 0.25rem 0.5rem;
      background-color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    /* Display toggle */
    .display-toggle {
      display: flex;
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      padding: 0.25rem;
    }
    
      background-color: #334155;
    }
    
    .toggle-btn {
      flex: 1;
      text-align: center;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 0.375rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .toggle-btn.active {
      background-color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      color: #0ea5e9;
    }
    
      background-color: #1f2937;
    }
    
    /* Financial table */
    .view-container {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
      background-color: #1e293b;
    }
    
    .hidden {
      display: none;
    }
    
    .financial-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .financial-table th {
      background-color: #f8f9fa;
      color: #6b7280;
      font-weight: 500;
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
      background-color: #1f2937;
      color: #d1d5db;
      border-bottom-color: #4b5563;
    }
    
    .financial-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
      border-bottom-color: #4b5563;
    }
    
    .financial-table .section-header {
      font-weight: 600;
      background-color: #f3f4f6;
      color: #111827;
      padding: 0.75rem 1rem;
    }
    
      background-color: #374151;
      color: #f3f4f6;
    }
    
    .financial-table .subsection-header {
      font-weight: 500;
      color: #4b5563;
      padding: 0.75rem 1rem;
      background-color: #f9fafb;
    }
    
      background-color: #1f2937;
      color: #e5e7eb;
    }
    
    .financial-table .amount {
      text-align: right;
      position: relative;
    }
    
    .financial-table .indent-1 {
      padding-left: 2rem;
    }
    
    .financial-table .indent-2 {
      padding-left: 3.5rem;
    }
    
    .financial-table .total-row {
      background-color: #e0f2fe;
      font-weight: 600;
    }
    
      background-color: #0c4a6e;
    }
    
    .comparison-value {
      display: inline-block;
      margin-left: 0.5rem;
      font-size: 0.75rem;
      font-weight: normal;
    }

    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .financial-table {
        font-size: 0.875rem;
      }
      
      .menu-bar {
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      
      .card-value {
        font-size: 1.25rem;
      }
      
      .view-container {
        padding: 1rem;
      }
    }
    
    @media print {
      .navbar, .menu-bar, .display-toggle, .dashboard-cards {
        display: none;
      }
      
      .view-container {
        box-shadow: none;
        padding: 0;
      }
      
      body {
        font-size: 12pt;
      }
    }
    
    /* Thai Calendar Styles */
    .date-picker-container {
      position: relative;
      display: inline-block;
    }
    
    .date-picker-input {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
    }
    
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    .thai-calendar {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      padding: 12px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 50;
      width: 280px;
      display: none;
    }
    
      background-color: #1e293b;
      border-color: #4b5563;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .month-year {
      font-weight: 500;
      font-size: 1.05rem;
    }
    
    .nav-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6b7280;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    
      color: #9ca3af;
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 8px;
    }
    
    .day-name {
      text-align: center;
      font-weight: 500;
      color: #6b7280;
      font-size: 0.85rem;
      padding: 4px 0;
    }
    
      color: #9ca3af;
    }
    
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .date-cell {
      height: 36px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      margin: 1px;
    }
    
    .date-cell:hover:not(.disabled) {
      background-color: #f3f4f6;
      border-radius: 50%;
    }
    
      background-color: #374151;
    }
    
    .date-cell.disabled {
      color: #d1d5db;
      cursor: default;
      opacity: 0.4;
    }
    
      color: #6b7280;
    }
    
    .date-cell.selected {
      background-color: #0ea5e9;
      color: white;
      border-radius: 50%;
    }
    
    .date-cell.today {
      border: 2px solid #0ea5e9;
      border-radius: 50%;
      font-weight: 500;
    }

      border-color: #38bdf8;
    }

    /* Loading Overlay Styles - Minimal CSS, use Tailwind classes in HTML */
    .loading-overlay {
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out !important;
    }

    .loading-overlay.animate__fadeOut {
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    .loading-overlay.hidden,
    .loading-overlay[style*="display: none"] {
      display: none !important;
      pointer-events: none !important;
      visibility: hidden !important;
    }
  </style>

   <!-- Template สำหรับเมนู -->
  <template id="mainMenuTemplate">
    <div class="flex justify-center">
      <ul class="menu menu-horizontal p-0 bg-white rounded-lg shadow-md space-x-2">
<!-- ซื้อ -->
<li tabindex="0" class="dropdown">
  <a class="flex justify-between items-center px-4 py-2">
    <i class="bi bi-cart-fill text-green-600 mr-2"></i> ซื้อ
    <i class="bi bi-caret-down-fill text-green-600 ml-1"></i> <!-- Added ml-1 for spacing -->
  </a>
  <ul class="p-2 bg-base-100 shadow-lg rounded-lg space-y-1">
    <li class="submenu-item">
      <a href="purchase_order">
        <i class="bi bi-file-earmark-text text-green-500 mr-2"></i> ใบสั่งซื้อ
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_product">
        <i class="bi bi-bag-fill text-green-500 mr-2"></i> ซื้อสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_asset"> 
        <i class="bi bi-archive-fill text-green-500 mr-2"></i> ซื้อสินทรัพย์ 
      </a>
      <li class="submenu-item">
      <a href="goods_receipt">
        <i class="bi bi-box-arrow-in-down text-green-500 mr-2"></i> ใบรับสินค้า 
      </a>
    </li>
    </li>
    <li class="submenu-item">
      <a href="supplier_details"> 
        <i class="bi bi-person-lines-fill text-green-500 mr-2"></i> รายละเอียดผู้จำหน่าย
      </a>
    </li>
    
    <li class="submenu-item">
      <a href="deposit_payment">
        <i class="bi bi-cash-stack text-green-500 mr-2"></i> ใบจ่ายเงินมัดจำ
      </a>
    </li>
    <li class="submenu-item">
      <a href="purchase_tax_invoice">
        <i class="bi bi-file-earmark-spreadsheet text-green-500 mr-2"></i> ใบกำกับภาษีซื้อ
      </a>
    </li>
    <li class="submenu-item">
      <a href="credit_note">
        <i class="bi bi-file-earmark-minus text-green-500 mr-2"></i> ใบลดหนี้
      </a>
    </li>
    <li class="submenu-item">
      <a href="debit_note">
        <i class="bi bi-file-earmark-plus text-green-500 mr-2"></i> ใบเพิ่มหนี้
      </a>
    </li>
    <li class="submenu-item expense-group">
      <a href="expense_record">
        <i class="bi bi-journal-text text-green-500 mr-2"></i> บันทึกค่าใช้จ่าย
      </a>
    </li>
  </ul>
</li>
      
        <!-- ขาย -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-shop text-red-600 mr-2"></i> ขาย
            <i class="bi bi-caret-down-fill text-red-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="quotation">
                <i class="bi bi-file-earmark-text text-red-500 mr-2"></i> ใบเสนอราคา
              </a>
            </li>
            <li class="submenu-item">
              <a href="invoice">
                <i class="bi bi-receipt text-red-500 mr-2"></i> ใบแจ้งหนี้
              </a>
            </li>
            <li class="submenu-item">
              <a href="deposit_receipt">
                <i class="bi bi-file-earmark-check text-red-500 mr-2"></i> ใบรับเงินมัดจำ
              </a>
            </li>
            <li class="submenu-item">
              <a href="receipt">
                <i class="bi bi-receipt-cutoff text-red-500 mr-2"></i> ใบเสร็จรับเงิน
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_tax_invoice">
                <i class="bi bi-file-earmark-spreadsheet text-red-500 mr-2"></i> ใบกำกับภาษีขาย
              </a>
            </li>
            <li class="submenu-item">
              <a href="other_income">
                <i class="bi bi-cash-coin text-red-500 mr-2"></i> บันทึกรายได้อื่นๆ
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_debit_notee">
                <i class="bi bi-file-earmark-plus text-red-500 mr-2"></i> ใบเพิ่มหนี้
              </a>
            </li>
            <li class="submenu-item">
              <a href="sales_credit_notee">
                <i class="bi bi-file-earmark-minus text-red-500 mr-2"></i> ใบลดหนี้
              </a>
            </li>
            <!-- เพิ่มเมนู รายละเอียดลูกหนี้ -->
            <li class="submenu-item">
            <a href="customer_details">
            <i class="bi bi-people text-red-500 mr-2"></i> รายละเอียดลูกหนี้
            </a>
          </li>
          </ul>
        </li>
      
        <!-- บัญชี -->
         <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-bank text-blue-600 mr-2"></i> บัญชี
            <i class="bi bi-caret-down-fill text-blue-600 ml-1"></i>
          </a>
          
          <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="chart_of_accounts">
                <i class="bi bi-diagram-3-fill text-blue-500 mr-2"></i> ผังบัญชี
              </a>
            </li>

            <!-- หัวข้อย่อย ลงประจำวัน (Nested Dropdown) -->
            <li tabindex="0" class="submenu-item dropdown"> <!-- Added tabindex for focus -->
              <a href="javascript:void(0);" class="flex justify-between items-center w-full"> <!-- Use href for focusability -->
                <i class="bi bi-journal-text text-blue-500 mr-2"></i> ลงประจำวัน
                <i class="bi bi-caret-right-fill text-blue-500 ml-auto"></i>
              </a>
              <ul class="p-2 bg-base-100 shadow-lg rounded-lg"> <!-- Nested UL for fly-out -->
                <li class="submenu-item">
                  <a href="journal_general">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันทั่วไป
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_payment">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันจ่าย
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_receipt">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันรับ
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_sales">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันขาย
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="journal_purchase">
                    <i class="bi bi-journal-text text-blue-500 mr-2"></i> สมุดรายวันซื้อ
                  </a>
                </li>
              </ul>
            </li>

            <!-- เพิ่มเมนู งบกระแสเงินสด -->
            <li class="submenu-item">
              <a href="cash_flow">
                <i class="bi bi-cash text-blue-500 mr-2"></i> งบกระแสเงินสด
              </a>
            </li>
  
             <li class="submenu-item">
              <a href="social_security">
                <i class="bi bi-shield-check text-blue-500 mr-2"></i> ภาษีและประกันสังคม
              </a>
            </li>
            <li class="submenu-item">
              <a href="assets">
                <i class="bi bi-collection-fill text-blue-500 mr-2"></i> สินทรัพย์
              </a>
            </li>
            <!-- เพิ่มเมนู ทุน -->
            <li class="submenu-item">
              <a href="capital">
                <i class="bi bi-piggy-bank text-blue-500 mr-2"></i> ทุน
              </a>
            </li>
          </ul>
        </li>

 <!-- การเงิน -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-currency-exchange text-teal-600 mr-2"></i> การเงิน
            <i class="bi bi-caret-down-fill text-teal-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="cash_management">
                <i class="bi bi-wallet2 text-teal-500 mr-2"></i> การจัดการเงินสด
              </a>
            </li>
            <li class="submenu-item">
              <a href="bank_reconciliation">
                <i class="bi bi-bank text-teal-500 mr-2"></i> กระทบยอดธนาคาร
              </a>
            </li>
            <li class="submenu-item">
              <a href="loan_management">
                <i class="bi bi-cash-coin text-teal-500 mr-2"></i> การจัดการเงินกู้
              </a>
            </li>
            <li class="submenu-item">
              <a href="investment_management">
                <i class="bi bi-bar-chart text-teal-500 mr-2"></i> การจัดการการลงทุน
              </a>
            </li>
             <li class="submenu-item">
              <a href="cash_flow_planning">
                <i class="bi bi-calendar3-range text-teal-500 mr-2"></i> วางแผนกระแสเงินสด
              </a>
            </li>
            <li class="submenu-item">
              <a href="received_checks">
                <i class="bi bi-receipt text-teal-500 mr-2"></i> เช็ครับ
              </a>
            </li>
            <li class="submenu-item">
              <a href="issued_checks">
                <i class="bi bi-journal-check text-teal-500 mr-2"></i> เช็คจ่าย
              </a>
            </li>
            <!-- เพิ่มเมนู ตั๋วเงินรับ และ ตั๋วเงินจ่าย -->
    <li class="submenu-item">
      <a href="promissory_notes_received">
        <i class="bi bi-file-earmark-text text-teal-500 mr-2"></i> ตั๋วเงินรับ
      </a>
    </li>
    <li class="submenu-item">
      <a href="promissory_notes_payable">
        <i class="bi bi-file-earmark-text text-teal-500 mr-2"></i> ตั๋วเงินจ่าย
      </a>
    </li>
            <li class="submenu-item">
              <a href="withholding_tax_received">
                <i class="bi bi-file-earmark-minus text-teal-500 mr-2"></i> ภาษีถูกหัก ณ ที่จ่าย
              </a>
            </li>
            <li class="submenu-item">
              <a href="withholding_tax_paid">
                <i class="bi bi-file-earmark-plus text-teal-500 mr-2"></i> ภาษีหัก ณ ที่จ่าย
              </a>
            </li>
          </ul>
        </li>

      
        <!-- สินค้า -->
<li tabindex="0" class="dropdown">
  <a class="flex justify-between items-center px-4 py-2">
    <i class="bi bi-box-seam text-amber-600 mr-2"></i> สินค้า
    <i class="bi bi-caret-down-fill text-amber-600 ml-1"></i>
  </a>
  <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
    <li class="submenu-item">
      <a href="product_details">
        <i class="bi bi-info-circle text-amber-500 mr-2"></i> รายละเอียดสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="service_details">
        <i class="bi bi-briefcase text-amber-500 mr-2"></i> รายละเอียดบริการ
      </a>
    </li>
    <!-- เพิ่มเมนูรายการเคลื่อนไหวสินค้า -->
    <li class="submenu-item">
      <a href="product_movements">
        <i class="bi bi-arrow-left-right text-amber-500 mr-2"></i> รายการเคลื่อนไหวสินค้า
      </a>
    </li>
    <li class="submenu-item">
      <a href="opening_inventory">
        <i class="bi bi-box-arrow-in-left text-amber-500 mr-2"></i> สินค้าคงเหลือต้นงวด
      </a>
    </li>
    <li class="submenu-item">
      <a href="closing_inventory">
        <i class="bi bi-box-arrow-right text-amber-500 mr-2"></i> สินค้าคงเหลือปลายงวด
      </a>
    </li>
  </ul>
</li>
      
       
      
       <!-- รายงาน -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-folder2 text-cyan-600 mr-2"></i> รายงาน
            <i class="bi bi-caret-down-fill text-cyan-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
            <li class="submenu-item">
              <a href="inventory_report">
                <i class="bi bi-box-seam text-cyan-500 mr-2"></i> รายงานสินค้าคงเหลือ
              </a>
            </li>
             <!-- ... other report items ... -->
            <li class="submenu-item">
              <a href="purchase_summary_report"><i class="bi bi-cart-check text-cyan-500 mr-2"></i> รายงานสรุปยอดซื้อ</a>
            </li>
            <li class="submenu-item">
              <a href="sales_summary_report"><i class="bi bi-bar-chart text-cyan-500 mr-2"></i> รายงานสรุปยอดขาย</a>
            </li>
            <li class="submenu-item">
              <a href="financial_statement_report"><i class="bi bi-graph-up text-cyan-500 mr-2"></i> รายงานงบการเงิน</a>
            </li>
            <li class="submenu-item">
              <a href="product_cost_report"><i class="bi bi-cash-coin text-cyan-500 mr-2"></i> รายงานต้นทุนสินค้า</a>
            </li>
            <li class="submenu-item">
              <a href="customer_report"><i class="bi bi-people text-cyan-500 mr-2"></i> รายงานลูกหนี้</a>
            </li>
            <li class="submenu-item">
              <a href="supplier_report"><i class="bi bi-truck text-cyan-500 mr-2"></i> รายงานเจ้าหนี้</a>
            </li>
            
    <li class="submenu-item">
      <a href="trial_balance">
        <i class="bi bi-list-ul text-cyan-500 mr-2"></i> รายงานงบทดลอง
      </a>
    </li>
    <li class="submenu-item">
      <a href="financial_position">
        <i class="bi bi-columns-gap text-cyan-500 mr-2"></i> รายงานงบฐานะการเงิน
      </a>
    </li>
    <li class="submenu-item">
      <a href="income_statement">
        <i class="bi bi-cash-stack text-cyan-500 mr-2"></i> รายงานงบกำไรขาดทุน
      </a>
    </li>
    <!-- รายงานงบกระแสเงินสด -->
    <li class="submenu-item">
      <a href="cash_flow">
        <i class="bi bi-cash text-cyan-500 mr-2"></i> รายงานงบกระแสเงินสด
      </a>
    </li>
        <!-- รายงานบัญชีแยกประเภท -->
    <li class="submenu-item">
      <a href="general_ledger">
        <i class="bi bi-journal-text text-cyan-500 mr-2"></i> รายงานบัญชีแยกประเภท
      </a>
    </li>
           

            <!-- รายงานภาษี (Nested Dropdown) -->
            <li tabindex="0" class="submenu-item dropdown">
              <a href="javascript:void(0);" class="flex justify-between items-center w-full">
                <i class="bi bi-receipt text-cyan-500 mr-2"></i> รายงานภาษี
                <i class="bi bi-caret-right-fill text-cyan-500 ml-auto"></i>
              </a>
              <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
                <!-- ภาษีมูลค่าเพิ่ม (Deeper Nested Dropdown) -->
                <li tabindex="0" class="submenu-item dropdown">
                  <a href="javascript:void(0);" class="flex justify-between items-center w-full">
                    ภาษีมูลค่าเพิ่ม
                    <i class="bi bi-caret-right-fill text-cyan-500 ml-auto"></i>
                  </a>
                  <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
                    <li class="submenu-item">
                      <a href="vat_purchase_report">
                        <i class="bi bi-arrow-down-circle text-cyan-500 mr-2"></i> ภาษีซื้อ
                      </a>
                    </li>
                    <li class="submenu-item">
                      <a href="vat_sales_report">
                        <i class="bi bi-arrow-up-circle text-cyan-500 mr-2"></i> ภาษีขาย
                      </a>
                    </li>
                  </ul>
                </li>
                <li class="submenu-item">
                  <a href="withholding_tax_report">
                    <i class="bi bi-currency-exchange text-cyan-500 mr-2"></i> ภาษีหัก ณ ที่จ่าย
                  </a>
                </li>
              </ul>
            </li>
                
            <li class="submenu-item">
              <a href="sales_analysis_report"><i class="bi bi-bar-chart-line text-cyan-500 mr-2"></i> รายงานวิเคราะห์การขาย</a>
            </li>
            <li class="submenu-item">
              <a href="purchase_analysis_report"><i class="bi bi-graph-up-arrow text-cyan-500 mr-2"></i> รายงานวิเคราะห์การซื้อ</a>
            </li>
          </ul>
        </li>
      
        <!-- ตั้งค่า -->
        <li tabindex="0" class="dropdown">
          <a class="flex justify-between items-center px-4 py-2">
            <i class="bi bi-gear-fill text-slate-600 mr-2"></i> ตั้งค่า
            <i class="bi bi-caret-down-fill text-slate-600 ml-1"></i>
          </a>
          <ul class="p-2 bg-base-100 shadow-lg rounded-lg">
            
            <li class="submenu-item"><a href="organization_settings"><i class="bi bi-building text-slate-500 mr-2"></i> ตั้งค่าองค์กร</a></li>
            <li class="submenu-item"><a href="user_settings"><i class="bi bi-person-gear text-slate-500 mr-2"></i> ตั้งค่าผู้ใช้งาน</a></li>
            <li class="submenu-item"><a href="document_settings"><i class="bi bi-file-earmark-text text-slate-500 mr-2"></i> ตั้งค่าเอกสาร</a></li>
            <li class="submenu-item"><a href="accounting_policy"><i class="bi bi-shield-lock text-slate-500 mr-2"></i> นโยบายบัญชี</a></li>
            <li class="submenu-item"><a href="external_integration"><i class="bi bi-plug-fill text-slate-500 mr-2"></i> เชื่อมต่อภายนอก</a></li>
            <li class="submenu-item"><a href="register_accounting_firm"><i class="bi bi-journal-bookmark-fill text-slate-500 mr-2"></i> ลงทะเบียนสำนักงานบัญชี</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </template>

</head>

<body class="bg-white w-full h-screen">
  <script>
    // Force remove dark mode
    document.documentElement.classList.remove('dark');
    document.body.classList.remove('dark');
    localStorage.removeItem('darkMode');
    localStorage.setItem('theme', 'light');
  </script>

  <!-- Loading Overlay with Lottie Animation -->
  <div id="loadingOverlay" class="loading-overlay"
       style="position: fixed !important;
              top: 0 !important;
              left: 0 !important;
              right: 0 !important;
              bottom: 0 !important;
              width: 100vw !important;
              height: 100vh !important;
              display: flex !important;
              justify-content: center !important;
              align-items: center !important;
              z-index: 999999 !important;
              background: rgba(255, 255, 255, 0.98) !important;
              backdrop-filter: blur(12px) !important;
              -webkit-backdrop-filter: blur(12px) !important;
              transition: opacity 0.5s ease-out, visibility 0.5s ease-out !important;">
    <div style="display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;">
      <div id="lottieContainer"
           style="width: 300px !important;
                  height: 300px !important;
                  margin: 0 auto !important;"></div>
    </div>
  </div>

  <div id="mainContent" class="container mx-auto px-4 py-6">
    <!-- Navbar -->
    <div class="navbar bg-white shadow-md sticky top-0 z-30 px-4 py-2">
      <div class="flex-1 flex items-center space-x-6">
        <img src="/uploads/Logo2.png"
             alt="Logo"
             class="w-10 h-10 rounded-full shadow-lg"
             loading="lazy" />
        <span class="text-lg font-semibold" id="pageTitle">จ่ายเงินมัดจำผู้จำหน่าย</span>
        <!-- จุดปล่อยเมนู -->
        <div id="mainMenuContainer" class="ml-auto"></div>
      </div>
      <div class="flex-none flex items-center space-x-2">
  <!-- เพิ่มส่วนแสดงข้อมูลผู้ใช้ -->
  <div class="flex items-center space-x-3 mr-4">
    <img id="employeePhoto"
     alt="Profile"
     class="w-10 h-10 rounded-full border-2 border-gray-300"
     loading="lazy">
    <span id="employeeName" class="text-sm font-medium text-gray-700">Loading...</span>
  </div>
  
        <button id="btnLogout" class="btn btn-outline btn-primary btn-sm btn-rounded btn-fancy">
          <i class="bi bi-box-arrow-right mr-1"></i> ออกจากระบบ
        </button>
      </div>
    </div>


 
    
   
    
    
      
        <!-- ส่วนค้นหาและตัวกรอง -->
      <div class="p-4 flex justify-between items-center flex-wrap gap-4 bg-gray-50 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <span class="font-medium flex items-center text-sm"><i class="bi bi-calendar-event mr-2 text-primary-500"></i> วันที่จ่ายเงินมัดจำ</span>
          <div class="relative">
            <div id="datePickerTrigger" class="flex items-center gap-2 cursor-pointer bg-white border border-gray-300 rounded-lg px-3 py-1.5 shadow-sm hover:shadow-md transition-shadow duration-300 text-sm">
              <i class="bi bi-calendar3 text-blue-600"></i>
              <span id="selectedDateRange">01/04/2025 - 31/05/2025</span>
              <i class="bi bi-chevron-down text-blue-600 text-xs"></i>
            </div>
            <div id="datePickerMenu" class="absolute top-full left-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden z-50">
              <h3 class="text-sm font-medium text-gray-700 mb-2">เลือกช่วงเวลา</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                  <input type="date" id="startDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="2025-04-01" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                  <input type="date" id="endDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="2025-05-31" />
                </div>
              </div>
              <div class="flex justify-end gap-2 mt-4">
                <button id="cancelDatePicker" class="btn btn-sm btn-outline">ยกเลิก</button>
                <button id="applyDatePicker" class="btn btn-sm btn-primary">ยืนยัน</button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="relative">
            <i class="bi bi-search search-icon text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="ค้นหาเลขที่เอกสาร, ผู้จำหน่าย, หรือเลขที่ PO" class="pl-9 pr-4 py-1.5 rounded-lg bg-white border border-gray-300 w-64 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-200 focus:ring-opacity-50 text-sm" />
          </div>
          <div class="relative">
            <select id="statusFilter" class="dropdown-select">
              <option value="all">ทุกสถานะ</option>
              <option value="paid">ชำระแล้ว</option>
              <option value="unpaid">ยังไม่ชำระ</option>
              <option value="overdue">เกินกำหนด</option>
            </select>
          </div>
          <a href="#" class="text-blue-600 hover:underline font-medium flex items-center text-sm">
            <i class="bi bi-funnel-fill mr-1"></i> ค้นหาขั้นสูง
          </a>
        </div>
      </div>

      <!-- ตาราง -->
      <div class="quotation-table-container overflow-x-auto">
        <table class="table w-full table-custom">
          <thead class="bg-gray-100">
            <tr>
              <th class="w-12"><input type="checkbox" class="rounded border-gray-300" /></th>
              <th class="cursor-pointer"><div class="flex items-center">เลขที่เอกสาร <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
              <th><div class="flex items-center">สถานะ</div></th>
              <th class="cursor-pointer"><div class="flex items-center">วันที่จ่าย <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
              <th><div class="flex items-center">เลขที่ PO</div></th>
              <th><div class="flex items-center">ผู้จำหน่าย</div></th>
              <th><div class="flex items-center">ประเภท</div></th>
              <th class="cursor-pointer text-right"><div class="flex items-center justify-end">ยอดมัดจำ <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
              <th class="cursor-pointer text-right"><div class="flex items-center justify-end">ยอดรวม <i class="bi bi-arrow-down-up text-gray-400 ml-1 text-xs"></i></div></th>
              <th class="text-center"><div class="flex items-center justify-center">จัดการ</div></th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be loaded dynamically via JavaScript -->
            <tr>
              <td colspan="10" class="text-center py-8 text-gray-500">กำลังโหลดข้อมูล...</td>
            </tr>
          </tbody>
        </table>
      </div>

      
      <!-- Pagination -->
      <div class="px-4 py-3 border-t border-gray-200 flex justify-between items-center flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <span class="text-gray-600 text-sm">แสดง</span>
          <div class="dropdown relative">
            <button tabindex="0" class="btn btn-xs btn-outline no-animation flex items-center gap-2 bg-white border border-gray-300 px-2 py-1 rounded text-sm">
              10 <i class="bi bi-chevron-down text-primary-500"></i>
            </button>
            <ul tabindex="0" class="dropdown-content menu shadow bg-base-100 rounded-md w-16 border border-gray-200 text-sm hidden absolute top-full left-0 mt-1 z-50 bg-white">
              <li><a class="block px-4 py-2 hover:bg-gray-100">10</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-100">20</a></li>
              <li><a class="block px-4 py-2 hover:bg-gray-100">50</a></li>
            </ul>
          </div>
          <span class="text-gray-600 text-sm">รายการ</span>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn btn-xs btn-outline border border-gray-300 px-2 py-1 rounded bg-white disabled:opacity-50" disabled><i class="bi bi-chevron-left text-gray-400"></i></button>
          <span class="text-sm">หน้า</span>
          <input type="text" value="1" class="input input-xs input-bordered w-12 text-center bg-white border border-gray-300 rounded px-2 py-1" />
          <button class="btn btn-xs btn-outline border border-gray-300 px-2 py-1 rounded bg-white"><i class="bi bi-chevron-right text-blue-500"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for creating a new deposit receipt -->
  <div id="newDepositReceiptModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-6 modal-container">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">สร้างใบจ่ายเงินมัดจำ</h2>
        <div class="flex items-center gap-2">
          <label for="receiptDate" class="text-sm font-medium text-gray-700">วันที่และเวลา:</label>
          <input
            type="datetime-local"
            id="receiptDate"
            readonly
            class="block w-60 bg-gray-100 border border-gray-300 rounded-md shadow-sm py-2 px-3 cursor-not-allowed"
          />
        </div>
        <button id="closeDepositReceiptModal" class="text-gray-500 hover:text-gray-700">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="overflow-y-auto">
        <form id="depositReceiptForm">
          <!-- Salesperson Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-4">พนักงานขาย / ตัวแทนขาย</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">พนักงานขาย</label>
                <div class="relative">
                  <select class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 pr-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500 appearance-none">
                    <option disabled selected>เลือกพนักงานขาย</option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-600">
                    <i class="bi bi-chevron-down"></i>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">ตัวแทนขาย</label>
                <div class="relative">
                  <select class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 pr-10 focus:outline-none focus:ring-blue-500 focus:border-blue-500 appearance-none">
                    <option disabled selected>เลือกตัวแทนขาย</option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-600">
                    <i class="bi bi-chevron-down"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Supplier Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-4">ผู้จำหน่าย</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">ชื่อผู้จำหน่าย</label>
                <div class="relative mt-1 flex gap-2">
                  <select id="supplierSelect" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">เลือกผู้จำหน่าย</option>
                  </select>
                  <button type="button" id="btnSearchSupplier" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-600">
                    <i class="bi bi-search"></i> ค้นหา
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">ที่อยู่</label>
                <textarea id="supplierAddress" placeholder="รายละเอียดที่อยู่" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-50 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">เลขประจำตัวผู้เสียภาษี</label>
                <input id="supplierTaxId" type="text" readonly placeholder="เลขประจำตัวผู้เสียภาษี" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-50 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">เบอร์โทร</label>
                <input id="supplierPhone" type="text" readonly placeholder="เบอร์โทรศัพท์" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-50 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
              </div>
            </div>
          </div>

          <!-- Transaction Section -->
          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-4">รายละเอียดรายการ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">ประเภทเงินมัดจำ</label>
                <select id="depositType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="deposit">เงินมัดจำสินค้า</option>
                  <option value="advance">เงินจ่ายล่วงหน้า</option>
                  <option value="partial">เงินชำระบางส่วน</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">เลขที่ใบสั่งซื้อ (PO)</label>
                <input type="text" id="poNumber" placeholder="เลขที่ PO (ถ้ามี)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
              </div>
            </div>
          </div>
          
          <!-- Amount Section -->
          <div class="mb-6 border p-4 rounded-lg border-gray-200 bg-gray-50">
            <h3 class="text-lg font-medium text-gray-700 mb-4">รายละเอียดการชำระเงิน</h3>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">ยอดรวมก่อนภาษี</label>
                <div class="mt-1 relative">
                  <input type="number" id="subtotalAmount" value="0.00" step="0.01" min="0" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 pl-3 pr-12 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-right" />
                  <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                    บาท
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">ส่วนลด</label>
                <div class="mt-1 relative">
                  <input type="number" id="discountAmount" value="0.00" step="0.01" min="0" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 pl-3 pr-12 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-right" />
                  <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                    บาท
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">ภาษีมูลค่าเพิ่ม (7.00%)</label>
                <div class="mt-1 relative">
                  <input type="number" id="vatAmount" value="0.00" step="0.01" min="0" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 pl-3 pr-12 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-right" readonly />
                  <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                    บาท
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 font-semibold">ยอดเงินที่ต้องชำระ</label>
                <div class="mt-1 relative">
                  <input type="number" id="totalAmount" value="0.00" step="0.01" min="0" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 pl-3 pr-12 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-right font-bold bg-blue-50" readonly />
                  <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                    บาท
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Payment Method Section -->
          <div class="mb-4">
            <h3 class="text-lg font-medium text-gray-700 mb-2">รูปแบบการชำระเงิน</h3>
            <div class="flex gap-4">
              <label class="inline-flex items-center">
                <input type="radio" name="paymentType" value="cash" checked class="form-radio h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">เงินสด</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="paymentType" value="transfer" class="form-radio h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">โอนเงิน</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="paymentType" value="check" class="form-radio h-5 w-5 text-blue-600">
                <span class="ml-2 text-gray-700">เช็คธนาคาร</span>
              </label>
            </div>
            
            <!-- Bank Check Fields (Initially Hidden) -->
            <div id="bankCheckFields" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
              <div>
                <label class="block text-sm font-medium text-gray-700">ธนาคารที่ออกเช็ค</label>
                <div class="relative mt-1">
                  <select class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 appearance-none pr-10">
                    <option value="" disabled selected>เลือกธนาคาร</option>
                    <option value="SCB" class="flex items-center">
                      <div class="flex items-center">
                        <img src="/static/images/banks/scb-logo.png" alt="SCB" class="inline-block w-5 h-5 mr-2" loading="lazy"
                            onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2E5MjZmNyI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnoiPjwvcGF0aD48L3N2Zz4='; this.className='inline-block w-5 h-5 mr-2 text-purple-600';" /> ธนาคารไทยพาณิชย์'
                      </div>
                    </option>
                    <option value="KBANK">
                      <img src="/static/images/banks/kbank-logo.png" alt="KBANK" class="inline-block w-5 h-5 mr-2" loading="lazy"
                          onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzBiODczOCI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjwvc3ZnPg=='; this.className='inline-block w-5 h-5 mr-2 text-green-600';" /> ธนาคารกสิกรไทย'
                    </option>
                    <option value="BBL">
                      <img src="/static/images/banks/bbl-logo.png" alt="BBL" class="inline-block w-5 h-5 mr-2" loading="lazy"
                          onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzEzMzJhMSI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjwvc3ZnPg=='; this.className='inline-block w-5 h-5 mr-2 text-blue-700';" /> ธนาคารกรุงเทพ'
                    </option>
                    <option value="KTB">
                      <img src="/static/images/banks/ktb-logo.png" alt="KTB" class="inline-block w-5 h-5 mr-2" loading="lazy"
                          onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzE3NTY5ZiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjwvc3ZnPg=='; this.className='inline-block w-5 h-5 mr-2 text-blue-800';" /> ธนาคารกรุงไทย'
                    </option>
                    <option value="BAY">
                      <img src="/static/images/banks/bay-logo.png" alt="BAY" class="inline-block w-5 h-5 mr-2" loading="lazy"
                          onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2ZkYmIzMCI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy1yIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjwvc3ZnPg=='; this.className='inline-block w-5 h-5 mr-2 text-yellow-500';" /> ธนาคารกรุงศรีอยุธยา'
                    </option>
                    <option value="TMB">
                      <img src="/static/images/banks/ttb-logo.png" alt="TTB" class="inline-block w-5 h-5 mr-2" loading="lazy"
                          onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzAzOTZhNiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjwvc3ZnPg=='; this.className='inline-block w-5 h-5 mr-2 text-teal-500';" /> ธนาคารทหารไทยธนชาต'
                    </option>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="bi bi-chevron-down"></i>
                  </div>
                </div>
                <!-- Note: Add actual bank logo images to your project -->
                <div class="text-xs text-gray-500 mt-1">
                  <i class="bi bi-info-circle"></i> กรุณาเพิ่มโลโก้ธนาคารในโฟลเดอร์ /static/images/banks/
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">เลขที่เช็ค</label>
                <input type="text" placeholder="เลขที่เช็ค" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
              </div>
            </div>
          </div>
          
          <!-- Account Selection -->
          <div class="mb-4">
            <label for="bankAccount" class="block text-sm font-medium text-gray-700">เข้าบัญชี</label>
            <div class="relative mt-1">
              <select id="bankAccount" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 appearance-none pr-10">
                <option>อุ๊บ รวมทุน</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                <i class="bi bi-chevron-down"></i>
              </div>
            </div>
          </div>
          
          <!-- Amount and Date -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">ยอดชำระเงิน</label>
              <input type="number" value="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">วันที่รับเงิน</label>
              <div class="relative">
                <input type="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <i class="bi bi-calendar"></i>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Evidence Section -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">หลักฐานการชำระ</label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
              <div class="space-y-1 text-center">
                <i class="bi bi-cloud-arrow-up mx-auto text-gray-400 text-3xl"></i>
                <div class="text-sm text-gray-600">
                  <label for="file-upload" class="relative cursor-pointer rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                    <span>อัพโหลดไฟล์</span>
                    <input id="file-upload" name="file-upload" type="file" class="sr-only">
                  </label>
                </div>
                <p class="text-xs text-gray-500">PNG, JPG, GIF ขนาดไม่เกิน 10MB</p>
              </div>
            </div>
          </div>
          
          <!-- Notes -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
            <textarea placeholder="เพิ่มข้อมูล" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>

          <!-- Action Buttons -->
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" id="cancelDepositReceipt" class="btn btn-outline btn-sm px-4 py-2 border border-gray-300 hover:bg-gray-100 rounded-md text-gray-700">ยกเลิก</button>
            <button type="submit" class="btn btn-primary btn-sm px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">บันทึก</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-[99999] flex flex-col gap-2" style="pointer-events: none;"></div>

  <!-- View Deposit Payment Modal -->
  <div id="viewDepositPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">
          <i class="bi bi-eye text-primary-600"></i> รายละเอียดใบจ่ายเงินมัดจำ
        </h2>
        <button id="closeViewModal" class="text-gray-400 hover:text-gray-600">
          <i class="bi bi-x-lg text-2xl"></i>
        </button>
      </div>

      <div id="viewModalContent" class="p-6">
        <!-- Content will be dynamically populated -->
      </div>

      <div class="sticky bottom-0 bg-gray-50 px-6 py-4 flex justify-between items-center border-t border-gray-200">
        <div class="flex gap-2">
          <button id="printDepositBtn" class="btn btn-outline">
            <i class="bi bi-printer mr-1"></i> พิมพ์
          </button>
          <button id="exportDepositPdfBtn" class="btn btn-outline">
            <i class="bi bi-file-pdf mr-1"></i> Export PDF
          </button>
        </div>
        <button id="closeViewBtn" class="btn btn-primary">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Edit Deposit Payment Modal -->
  <div id="editDepositPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">
          <i class="bi bi-pencil-square text-primary-600"></i> แก้ไขใบจ่ายเงินมัดจำ
        </h2>
        <button id="closeEditModal" class="text-gray-400 hover:text-gray-600">
          <i class="bi bi-x-lg text-2xl"></i>
        </button>
      </div>

      <form id="editDepositPaymentForm" class="p-6">
        <input type="hidden" id="editPaymentId" />

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">เลขที่ใบจ่ายเงินมัดจำ</label>
            <input type="text" id="editPaymentNumber" class="form-control bg-gray-50" readonly />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ชำระ</label>
            <input type="date" id="editPaymentDate" class="form-control" />
          </div>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">ข้อมูลผู้จำหน่าย</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้จำหน่าย</label>
              <input type="text" id="editSupplierName" class="form-control bg-gray-50" readonly />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">เลขประจำตัวผู้เสียภาษี</label>
              <input type="text" id="editSupplierTaxId" class="form-control bg-gray-50" readonly />
            </div>
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
          <textarea id="editNotes" class="form-control" rows="3"></textarea>
        </div>

        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEditBtn" class="btn btn-outline">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึกการแก้ไข</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // โหลดข้อมูลผู้ใช้จาก API
    async function fetchUserProfile() {
      try {
        const token = localStorage.getItem('authToken');

        // ตรวจสอบว่ามี token หรือไม่
        if (!token) {
          console.error('❌ No auth token found');
          alert('ไม่พบข้อมูลการเข้าสู่ระบบ กรุณา login ใหม่');
          window.location.href = '/login.html';
          return;
        }

        console.log('🔍 Fetching user profile from API...');

        const res = await fetch('/api/users/me', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Cache-Control': 'no-cache' // บังคับไม่ใช้ cache
          }
        });

        const json = await res.json();
        console.log('📦 API Response:', json);

        // ตรวจสอบ response status
        if (!res.ok) {
          console.error('❌ API Error:', res.status, json);

          // ถ้า token หมดอายุหรือไม่ถูกต้อง
          if (res.status === 401 || res.status === 403) {
            console.log('🚫 Unauthorized - clearing cache and redirecting');
            localStorage.removeItem('authToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userPhoto');
            localStorage.removeItem('userInfo');
            alert('เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่');
            window.location.href = '/login.html';
            return;
          }

          throw new Error(json.error || json.message || 'Failed to load profile');
        }

        if (!json.success || !json.data) {
          throw new Error('Invalid response from server');
        }

        // ดึงข้อมูลจาก response
        const userName = json.data.name || json.data.username || 'ผู้ใช้';
        const photoUrl = json.data.photoUrl || json.data.employee?.imageUrl || null;

        console.log('✅ User Profile Loaded:', { userName, photoUrl });

        // อัพเดท UI
        const nameEl = document.getElementById('employeeName');
        const photoEl = document.getElementById('employeePhoto');

        if (nameEl) {
          nameEl.textContent = userName;
          console.log('✅ Updated employeeName to:', userName);
        }

        if (photoEl) {
          if (photoUrl) {
            // แปลง photoUrl ให้ถูกต้อง
            let finalPhotoUrl = photoUrl;
            if (!photoUrl.startsWith('http://') && !photoUrl.startsWith('https://') && !photoUrl.startsWith('data:')) {
              if (!photoUrl.startsWith('/uploads/')) {
                finalPhotoUrl = '/uploads/employees/' + photoUrl;
              }
            }
            photoEl.src = finalPhotoUrl;
          } else {
            photoEl.src = '/img/default-avatar.svg';
          }
          console.log('✅ Updated employeePhoto to:', photoEl.src);
        }

        // บันทึกข้อมูลใหม่ใน localStorage (เขียนทับข้อมูลเก่า)
        localStorage.setItem('userName', userName);
        if (photoUrl) {
          localStorage.setItem('userPhoto', photoUrl);
        } else {
          localStorage.removeItem('userPhoto'); // ลบถ้าไม่มีรูป
        }

        console.log('✅ Profile update completed successfully');
      } catch (err) {
        console.error('❌ fetchUserProfile error:', err);

        // แสดง error ที่ชัดเจนขึ้น
        const errorMessage = err.message || 'Unknown error';
        console.error('Error details:', errorMessage);

        // ถ้าเป็น network error หรือ server error ให้ลอง fallback แต่แสดงคำเตือน
        if (errorMessage.includes('Failed to fetch') || errorMessage.includes('Network')) {
          console.warn('⚠️ Network error - using cached data as fallback');

          const fallbackName = localStorage.getItem('userName') || 'ผู้ใช้';
          const fallbackPhoto = localStorage.getItem('userPhoto');

          const nameEl = document.getElementById('employeeName');
          const photoEl = document.getElementById('employeePhoto');

          if (nameEl) nameEl.textContent = fallbackName + ' (Offline)';
          if (photoEl) {
            if (fallbackPhoto) {
              photoEl.src = fallbackPhoto;
            } else {
              photoEl.src = '/img/default-avatar.svg';
            }
          }
        } else {
          // ถ้าเป็น error อื่นๆ ให้ clear cache และ redirect
          console.error('🚫 Critical error - clearing cache and redirecting');
          localStorage.removeItem('authToken');
          localStorage.removeItem('userName');
          localStorage.removeItem('userPhoto');
          localStorage.removeItem('userInfo');
          alert('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้: ' + errorMessage);
          window.location.href = '/login.html';
        }
      }
    }

    // JavaScript code for handling modals and other interactive elements
    document.addEventListener('DOMContentLoaded', function () {
      // โหลดข้อมูลผู้ใช้
      fetchUserProfile();

      // เก็บรายการสินค้า
      let branchProducts = [];

      // โหลดรายการสินค้าจาก API สาขา 00000
      async function loadBranchProducts() {
        try {
          const res = await fetch('/api/branch-stock?branch_code=00000');
          const body = await res.json();
          if (body.success) branchProducts = body.data;
          else console.error('Load products failed:', body.error);
        } catch (err) {
          console.error('Fetch error:', err);
        }
      }
      
      // helper สร้าง <option>
      function createProductOptions() {
        let html = '<option disabled selected>เลือกสินค้า/บริการ</option>';
        branchProducts.forEach(p => {
          html += `<option value="${p._id}">${p.name}</option>`;
        });
        return html;
      }
      
      // โหลดตอนเริ่มหน้า
      loadBranchProducts();

      // Logout button functionality
      const btnLogout = document.getElementById('btnLogout');
      if (btnLogout) {
        btnLogout.addEventListener('click', function () {
          // Perform logout action here
          alert('ออกจากระบบเรียบร้อยแล้ว');
        });
      }
      
      // Open display settings modal (guard in case element is missing)
      const btnDisplaySettings = document.getElementById('btnDisplaySettings');
      if (btnDisplaySettings) {
        btnDisplaySettings.addEventListener('click', function () {
          document.getElementById('displaySettingsModal').classList.remove('hidden');
        });
      }
      
      // Close display settings modal
      document.getElementById('closeDisplaySettingsModal')?.addEventListener('click', function () {
        document.getElementById('displaySettingsModal').classList.add('hidden');
      });
      
      // Open print report modal (guard in case element is missing)
      const btnPrintReport = document.getElementById('btnPrintReport');
      if (btnPrintReport) {
        btnPrintReport.addEventListener('click', function () {
          document.getElementById('printReportModal').classList.remove('hidden');
        });
      }
      
      // Close print report modal
      document.getElementById('closePrintReportModal')?.addEventListener('click', function () {
        document.getElementById('printReportModal').classList.add('hidden');
      });
      
      // Print report button in modal
      document.getElementById('printReportModal')?.addEventListener('submit', function (e) {
        e.preventDefault();
        // Perform print action here
        alert('กำลังพิมพ์รายงาน...');
        document.getElementById('printReportModal').classList.add('hidden');
      });
      
      // Display settings form submission
      document.getElementById('displaySettingsModal')?.addEventListener('submit', function (e) {
        e.preventDefault();
        // Perform settings save action here
        alert('บันทึกการตั้งค่าเรียบร้อยแล้ว');
        document.getElementById('displaySettingsModal').classList.add('hidden');
      });
    });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const datePickerTrigger = document.getElementById('datePickerTrigger');
    const datePickerMenu = document.getElementById('datePickerMenu');
    const selectedDateRange = document.getElementById('selectedDateRange');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const cancelDatePicker = document.getElementById('cancelDatePicker');
    const applyDatePicker = document.getElementById('applyDatePicker');

    if (datePickerTrigger && datePickerMenu) {
      // Toggle date picker menu
      datePickerTrigger.addEventListener('click', function () {
        datePickerMenu.classList.toggle('hidden');
      });

      // Cancel button functionality
      if (cancelDatePicker) {
        cancelDatePicker.addEventListener('click', function () {
          datePickerMenu.classList.add('hidden');
        });
      }

      // Apply button functionality
      if (applyDatePicker) {
        applyDatePicker.addEventListener('click', function () {
          const start = startDate?.value;
          const end = endDate?.value;
          if (start && end) {
            if (selectedDateRange) {
              selectedDateRange.textContent = `${start} - ${end}`;
            }
            datePickerMenu.classList.add('hidden');
          } else {
            alert('กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด');
          }
        });
      }

      // Close menu when clicking outside
      document.addEventListener('click', function (e) {
        if (!datePickerTrigger.contains(e.target) && !datePickerMenu.contains(e.target)) {
          datePickerMenu.classList.add('hidden');
        }
      });
    }
  });
  </script>

  <!-- Additional script for VAT calculation -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // VAT calculation (guard if elements are missing)
      const vatOption = document.getElementById('vatOption');
      const vatElement = document.getElementById('vat');
      const totalValueElement = document.querySelector('.font-medium');
      if (vatOption && vatElement) {
        function updateVAT() {
          const vatRate = 0.07;
          // derive totalValue from your actual element or logic:
          const totalValue = parseFloat(totalValueElement?.textContent) || 0;
          let vat = vatOption.value === 'exclusive'
            ? totalValue * vatRate
            : totalValue - totalValue / (1 + vatRate);
          vatElement.textContent = vat.toFixed(2);
        }
        vatOption.addEventListener('change', updateVAT);
        updateVAT();
      }
    });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const btnCreateNewDepositReceipt = document.getElementById('createNewDepositReceipt');
    const btnCreateFromEmpty = document.getElementById('btnCreateFromEmpty');
    const modalNewDepositReceipt = document.getElementById('newDepositReceiptModal');
    const btnCloseDepositReceiptModal = document.getElementById('closeDepositReceiptModal');
    const btnCancelDepositReceipt = document.getElementById('cancelDepositReceipt');
    const depositReceiptForm = document.getElementById('depositReceiptForm');

    // Open Modal when clicking the create new button
    if (btnCreateNewDepositReceipt) {
      btnCreateNewDepositReceipt.addEventListener('click', openDepositModal);
    }

    // Also open modal from empty state button if it exists
    if (btnCreateFromEmpty) {
      btnCreateFromEmpty.addEventListener('click', openDepositModal);
    }

    // Function to open modal and setup data
    function openDepositModal() {
      // Set current date/time in the receipt date field
      const now = new Date();
      const offsetMs = now.getTimezoneOffset() * 60000;
      const localISOTime = new Date(now - offsetMs).toISOString().slice(0,16);
      const dateInput = document.getElementById('receiptDate');
      if (dateInput) {
        dateInput.value = localISOTime;
      }
      
      // Show the modal
      modalNewDepositReceipt.classList.remove('hidden');
    }

    // Close Modal (X button)
    if (btnCloseDepositReceiptModal) {
      btnCloseDepositReceiptModal.addEventListener('click', () => {
        modalNewDepositReceipt.classList.add('hidden');
      });
    }

    // Close Modal (Cancel button)
    if (btnCancelDepositReceipt) {
      btnCancelDepositReceipt.addEventListener('click', () => {
        modalNewDepositReceipt.classList.add('hidden');
      });
    }

    // Handle form submission
    if (depositReceiptForm) {
      depositReceiptForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await createDepositPayment();
      });
    }

    // ==================== API Functions ====================

    // Load Suppliers
    async function loadSuppliers() {
      try {
        const response = await fetch('/api/supplier', {
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`
          }
        });

        if (!response.ok) throw new Error('Failed to load suppliers');

        const result = await response.json();
        const supplierSelect = document.getElementById('supplierSelect');

        // Handle both array and object response
        const suppliers = Array.isArray(result) ? result : (result.data || []);

        if (supplierSelect && suppliers.length > 0) {
          supplierSelect.innerHTML = '<option value="">เลือกผู้จำหน่าย</option>';
          suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier._id;
            option.textContent = `${supplier.name} (${supplier.code})`;
            option.dataset.supplier = JSON.stringify(supplier);
            supplierSelect.appendChild(option);
          });
          console.log(`✅ Loaded ${suppliers.length} suppliers`);
        } else {
          console.warn('⚠️ No suppliers found');
          supplierSelect.innerHTML = '<option value="">ไม่พบผู้จำหน่าย</option>';
        }
      } catch (error) {
        console.error('Error loading suppliers:', error);
        const supplierSelect = document.getElementById('supplierSelect');
        if (supplierSelect) {
          supplierSelect.innerHTML = '<option value="">เกิดข้อผิดพลาด</option>';
        }
      }
    }

    // Load Deposit Payments
    async function loadDepositPayments() {
      try {
        const response = await fetch('/api/deposit-payments?limit=50', {
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`
          }
        });

        if (!response.ok) {
          console.error('API Error:', response.status, response.statusText);
          throw new Error(`Failed to load deposit payments: ${response.status}`);
        }

        const result = await response.json();
        console.log('📊 Deposit Payments Response:', result);

        if (result.success && result.data) {
          renderDepositPaymentsTable(result.data);
          console.log(`✅ Loaded ${result.data.length} deposit payments`);
        } else {
          console.warn('⚠️ No deposit payments found');
          renderDepositPaymentsTable([]);
        }
      } catch (error) {
        console.error('Error loading deposit payments:', error);
        const tbody = document.querySelector('.quotation-table-container tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        }
      }
    }

    // Render Table
    function renderDepositPaymentsTable(payments) {
      const tbody = document.querySelector('.quotation-table-container tbody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ไม่พบข้อมูล</td></tr>';
        return;
      }

      payments.forEach(payment => {
        const statusBadge = getStatusBadge(payment.status);
        const formatDate = (date) => {
          if (!date) return '-';
          try {
            return new Date(date).toLocaleDateString('th-TH', {
              year: '2-digit',
              month: '2-digit',
              day: '2-digit'
            });
          } catch (e) {
            return '-';
          }
        };
        const formatMoney = (amount) => {
          if (!amount && amount !== 0) return '-';
          return '฿' + new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        };

        const poNumber = payment.purchaseOrder?.poNumber ||
                        (typeof payment.purchaseOrder === 'string' ? payment.purchaseOrder : '-');

        // Action buttons based on status
        const actionButtons = payment.status === 'pending' ? `
          <button onclick="openEditDepositPaymentModal('${payment._id}')" class="btn btn-sm btn-outline text-purple-600" title="แก้ไข">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button onclick="approveDepositPayment('${payment._id}')" class="btn btn-sm btn-outline text-green-600" title="อนุมัติ">
            <i class="bi bi-check-circle"></i>
          </button>
        ` : '';

        const row = `
          <tr class="hover:bg-gray-50 transition-colors">
            <td><input type="checkbox" class="rounded border-gray-300" value="${payment._id}" /></td>
            <td><span class="text-blue-600 font-medium">${payment.paymentNumber || '-'}</span></td>
            <td>${statusBadge}</td>
            <td>${formatDate(payment.paymentDate)}</td>
            <td>${poNumber}</td>
            <td>${payment.supplierName || payment.supplier?.name || '-'}</td>
            <td>${getDepositTypeLabel(payment.depositType)}</td>
            <td class="text-right font-medium">${formatMoney(payment.depositAmount || payment.amounts?.depositAmount)}</td>
            <td class="text-right font-medium">${formatMoney(payment.totalAmount || payment.amounts?.totalAmount)}</td>
            <td class="text-center">
              <div class="flex items-center justify-center gap-2">
                <button onclick="viewDepositPayment('${payment._id}')" class="btn btn-sm btn-outline text-blue-600" title="ดูรายละเอียด">
                  <i class="bi bi-eye"></i>
                </button>
                ${actionButtons}
                <button onclick="deleteDepositPayment('${payment._id}')" class="btn btn-sm btn-outline text-red-600" title="ลบ">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function getStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-warning">รออนุมัติ</span>',
        'approved': '<span class="badge badge-info">อนุมัติแล้ว</span>',
        'paid': '<span class="badge badge-success">จ่ายแล้ว</span>',
        'completed': '<span class="badge badge-success">เสร็จสิ้น</span>',
        'cancelled': '<span class="badge badge-error">ยกเลิก</span>'
      };
      return badges[status] || '<span class="badge">-</span>';
    }

    function getDepositTypeLabel(type) {
      const labels = {
        'deposit': 'เงินมัดจำ',
        'advance': 'เงินล่วงหน้า',
        'partial': 'จ่ายบางส่วน'
      };
      return labels[type] || '-';
    }

    // ========== TOAST NOTIFICATION SYSTEM ==========
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-x-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        info: 'bi-info-circle-fill'
      };
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-orange-500',
        info: 'bg-blue-500'
      };

      toast.className = `flex items-center gap-3 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg mb-2 animate__animated animate__slideInRight`;
      toast.style.pointerEvents = 'auto';
      toast.innerHTML = `
        <i class="bi ${icons[type]} text-xl"></i>
        <span class="font-medium">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1">
          <i class="bi bi-x text-xl"></i>
        </button>
      `;

      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove('animate__slideInRight');
        toast.classList.add('animate__slideOutRight');
        setTimeout(() => toast.remove(), 500);
      }, 4000);
    }

    // ========== VIEW DEPOSIT PAYMENT ==========
    async function viewDepositPayment(id) {
      try {
        showPageLoading();
        const token = getAuthToken();
        const response = await fetch(`/api/deposit-payments/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load deposit payment');

        const result = await response.json();
        const payment = result.data;

        const formatDate = (date) => date ? new Date(date).toLocaleDateString('th-TH') : '-';
        const formatMoney = (amount) => {
          if (!amount && amount !== 0) return '-';
          return '฿' + new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        };

        const content = document.getElementById('viewModalContent');
        content.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-semibold text-gray-800 mb-3">ข้อมูลใบจ่ายเงินมัดจำ</h3>
              <div class="space-y-2 text-sm">
                <div><span class="text-gray-600">เลขที่:</span> <span class="font-medium">${payment.paymentNumber || '-'}</span></div>
                <div><span class="text-gray-600">วันที่จ่าย:</span> ${formatDate(payment.paymentDate)}</div>
                <div><span class="text-gray-600">สถานะ:</span> ${getStatusBadge(payment.status)}</div>
                <div><span class="text-gray-600">ประเภท:</span> ${getDepositTypeLabel(payment.depositType)}</div>
                <div><span class="text-gray-600">เลขที่ PO:</span> ${payment.purchaseOrder?.poNumber || '-'}</div>
              </div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <h3 class="font-semibold text-gray-800 mb-3">ข้อมูลผู้จำหน่าย</h3>
              <div class="space-y-2 text-sm">
                <div><span class="text-gray-600">ชื่อ:</span> <span class="font-medium">${payment.supplier?.name || '-'}</span></div>
                <div><span class="text-gray-600">รหัส:</span> ${payment.supplier?.code || '-'}</div>
                <div><span class="text-gray-600">เลขประจำตัวผู้เสียภาษี:</span> ${payment.supplier?.taxId || '-'}</div>
                <div><span class="text-gray-600">ที่อยู่:</span> ${payment.supplier?.address || '-'}</div>
              </div>
            </div>
          </div>

          <div class="mt-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="font-semibold text-gray-800 mb-3">ข้อมูลการชำระเงิน</h3>
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-gray-600">วิธีชำระ:</span> <span class="font-medium">${payment.paymentMethod || '-'}</span></div>
              <div><span class="text-gray-600">ยอดรวมก่อนภาษี:</span> <span class="font-medium">${formatMoney(payment.amounts?.subtotalAmount)}</span></div>
              <div><span class="text-gray-600">ส่วนลด:</span> <span class="font-medium">${formatMoney(payment.amounts?.discountAmount)}</span></div>
              <div><span class="text-gray-600">ภาษีมูลค่าเพิ่ม:</span> <span class="font-medium">${formatMoney(payment.amounts?.vatAmount)}</span></div>
              <div class="col-span-2 pt-2 border-t border-gray-300">
                <div class="flex justify-between items-center">
                  <span class="text-lg font-semibold">ยอดรวมทั้งสิ้น:</span>
                  <span class="text-xl font-bold text-primary-600">${formatMoney(payment.amounts?.totalAmount)}</span>
                </div>
              </div>
              <div class="col-span-2">
                <div class="flex justify-between items-center">
                  <span class="font-medium text-green-700">ยอดมัดจำที่จ่าย:</span>
                  <span class="font-bold text-green-700">${formatMoney(payment.amounts?.depositAmount)}</span>
                </div>
              </div>
              <div class="col-span-2">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">ยอดคงเหลือ:</span>
                  <span class="font-medium">${formatMoney(payment.amounts?.remainingAmount)}</span>
                </div>
              </div>
            </div>
          </div>

          ${payment.notes ? `<div class="mt-4 p-3 bg-yellow-50 rounded"><strong>หมายเหตุ:</strong> ${payment.notes}</div>` : ''}
        `;

        const modal = document.getElementById('viewDepositPaymentModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      } catch (error) {
        console.error('Error viewing deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
      } finally {
        hidePageLoading();
      }
    }

    // ========== EDIT DEPOSIT PAYMENT ==========
    async function openEditDepositPaymentModal(id) {
      try {
        showPageLoading();
        const token = getAuthToken();
        const response = await fetch(`/api/deposit-payments/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load deposit payment');

        const result = await response.json();
        const payment = result.data;

        document.getElementById('editPaymentId').value = payment._id;
        document.getElementById('editPaymentNumber').value = payment.paymentNumber;
        document.getElementById('editPaymentDate').value = payment.paymentDate?.split('T')[0] || '';
        document.getElementById('editSupplierName').value = payment.supplier?.name || '';
        document.getElementById('editSupplierTaxId').value = payment.supplier?.taxId || '';
        document.getElementById('editNotes').value = payment.notes || '';

        const modal = document.getElementById('editDepositPaymentModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      } catch (error) {
        console.error('Error loading deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
      } finally {
        hidePageLoading();
      }
    }

    async function handleUpdateDepositPayment(event) {
      event.preventDefault();

      const id = document.getElementById('editPaymentId').value;
      const formData = {
        paymentDate: document.getElementById('editPaymentDate')?.value,
        notes: document.getElementById('editNotes')?.value
      };

      try {
        showPageLoading();
        const token = getAuthToken();
        const response = await fetch(`/api/deposit-payments/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) throw new Error('Failed to update deposit payment');

        showToast('แก้ไขใบจ่ายเงินมัดจำสำเร็จ', 'success');
        closeEditDepositPaymentModal();
        await loadDepositPayments();
      } catch (error) {
        console.error('Error updating deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการแก้ไข', 'error');
      } finally {
        hidePageLoading();
      }
    }

    // ========== APPROVE DEPOSIT PAYMENT ==========
    async function approveDepositPayment(id) {
      if (!confirm('คุณต้องการอนุมัติใบจ่ายเงินมัดจำนี้ใช่หรือไม่?')) return;

      try {
        showPageLoading();
        const token = getAuthToken();
        const response = await fetch(`/api/deposit-payments/${id}/approve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            approvedBy: localStorage.getItem('userName') || 'Admin'
          })
        });

        if (!response.ok) throw new Error('Failed to approve deposit payment');

        showToast('อนุมัติใบจ่ายเงินมัดจำสำเร็จ', 'success');
        await loadDepositPayments();
      } catch (error) {
        console.error('Error approving deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการอนุมัติ', 'error');
      } finally {
        hidePageLoading();
      }
    }

    // ========== DELETE DEPOSIT PAYMENT ==========
    async function deleteDepositPayment(id) {
      if (!confirm('คุณต้องการลบใบจ่ายเงินมัดจำนี้ใช่หรือไม่?')) return;

      try {
        showPageLoading();
        const token = getAuthToken();
        const response = await fetch(`/api/deposit-payments/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) throw new Error('Failed to delete deposit payment');

        showToast('ลบใบจ่ายเงินมัดจำสำเร็จ', 'success');
        await loadDepositPayments();
      } catch (error) {
        console.error('Error deleting deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการลบ', 'error');
      } finally {
        hidePageLoading();
      }
    }

    // ========== MODAL MANAGEMENT ==========
    function closeViewDepositPaymentModal() {
      const modal = document.getElementById('viewDepositPaymentModal');
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }

    function closeEditDepositPaymentModal() {
      const modal = document.getElementById('editDepositPaymentModal');
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }

    // Create Deposit Payment
    async function createDepositPayment() {
      try {
        const supplierSelect = document.getElementById('supplierSelect');
        const selectedOption = supplierSelect.options[supplierSelect.selectedIndex];

        if (!selectedOption.value) {
          alert('กรุณาเลือกผู้จำหน่าย');
          return;
        }

        const supplierData = JSON.parse(selectedOption.dataset.supplier);

        const paymentData = {
          supplier: {
            supplierId: supplierData._id,
            code: supplierData.code,
            name: supplierData.name,
            taxId: supplierData.taxId || '',
            address: supplierData.address || '',
            phone: supplierData.phone || ''
          },
          branch: {
            code: localStorage.getItem('branchCode') || '00000',
            name: localStorage.getItem('branchName') || 'สำนักงานใหญ่'
          },
          paymentDate: document.getElementById('receiptDate').value,
          purchaseOrder: {
            poNumber: document.getElementById('poNumber').value || null
          },
          depositType: document.getElementById('depositType').value,
          amounts: {
            subtotalAmount: parseFloat(document.getElementById('subtotalAmount').value) || 0,
            discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
            vatAmount: parseFloat(document.getElementById('vatAmount').value) || 0,
            totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
            depositAmount: parseFloat(document.getElementById('depositAmount').value) || 0,
            remainingAmount: 0
          },
          paymentMethod: document.querySelector('input[name="paymentType"]:checked')?.value || 'transfer',
          paymentDetails: getPaymentDetails(),
          notes: document.getElementById('notes')?.value || '',
          createdBy: {
            name: localStorage.getItem('userName') || 'Admin'
          }
        };

        // Calculate remaining amount
        paymentData.amounts.remainingAmount = paymentData.amounts.totalAmount - paymentData.amounts.depositAmount;

        const response = await fetch('/api/deposit-payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
          },
          body: JSON.stringify(paymentData)
        });

        const result = await response.json();

        if (result.success) {
          showToast('บันทึกใบจ่ายเงินมัดจำสำเร็จ!', 'success');
          modalNewDepositReceipt.classList.add('hidden');
          depositReceiptForm.reset();
          loadDepositPayments();
        } else {
          showToast('เกิดข้อผิดพลาด: ' + result.message, 'error');
        }

      } catch (error) {
        console.error('Error creating deposit payment:', error);
        showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
      }
    }

    function getPaymentDetails() {
      const paymentMethod = document.querySelector('input[name="paymentType"]:checked')?.value;
      const details = {};

      if (paymentMethod === 'transfer') {
        details.bankName = document.getElementById('bankName')?.value || '';
        details.bankAccountNumber = document.getElementById('accountNumber')?.value || '';
        details.transferReference = document.getElementById('transferRef')?.value || '';
      } else if (paymentMethod === 'check') {
        details.checkNumber = document.getElementById('checkNumber')?.value || '';
        details.checkBankName = document.getElementById('checkBank')?.value || '';
        details.checkDate = document.getElementById('checkDate')?.value || '';
      }

      return details;
    }

    // Event Listener for Supplier Select
    const supplierSelect = document.getElementById('supplierSelect');
    if (supplierSelect) {
      supplierSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
          const supplier = JSON.parse(selectedOption.dataset.supplier);
          document.getElementById('supplierAddress').value = supplier.address || '';
          document.getElementById('supplierTaxId').value = supplier.taxId || '';
          document.getElementById('supplierPhone').value = supplier.phone || '';
        } else {
          document.getElementById('supplierAddress').value = '';
          document.getElementById('supplierTaxId').value = '';
          document.getElementById('supplierPhone').value = '';
        }
      });
    }

    // Modal event listeners for View and Edit
    document.getElementById('closeViewModal')?.addEventListener('click', closeViewDepositPaymentModal);
    document.getElementById('closeViewBtn')?.addEventListener('click', closeViewDepositPaymentModal);
    document.getElementById('closeEditModal')?.addEventListener('click', closeEditDepositPaymentModal);
    document.getElementById('cancelEditBtn')?.addEventListener('click', closeEditDepositPaymentModal);
    document.getElementById('editDepositPaymentForm')?.addEventListener('submit', handleUpdateDepositPayment);

    // Initialize
    loadSuppliers();
    loadDepositPayments();

    // Fix for fallback image

    // Close modal when clicking outside (backdrop)
    if (modalNewDepositReceipt) {
      modalNewDepositReceipt.addEventListener('click', (e) => {
        if (e.target === modalNewDepositReceipt) {
          modalNewDepositReceipt.classList.add('hidden');
        }
      });
    }

    // Close modals when clicking outside
    document.getElementById('viewDepositPaymentModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'viewDepositPaymentModal') {
        closeViewDepositPaymentModal();
      }
    });

    document.getElementById('editDepositPaymentModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'editDepositPaymentModal') {
        closeEditDepositPaymentModal();
      }
    });
        const emptyStateImg = document.querySelector('.empty-state-container img');
    if (emptyStateImg) {
      emptyStateImg.onerror = function() {
        this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2E5MjZmNyI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiI+PC9wYXRoPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnoiPjwvcGF0aD48L3N2Zz4=';
        this.onerror = null;
      };
    }
  });
  </script>

  <script>
    // JavaScript code for handling modals and other interactive elements
    document.addEventListener('DOMContentLoaded', function () {
      // Clone the main menu from the template
      const menuTemplate = document.getElementById('mainMenuTemplate');
      const menuContainer = document.getElementById('mainMenuContainer');
    
      if (menuTemplate && menuContainer) {
        const menuClone = menuTemplate.content.cloneNode(true);
        menuContainer.appendChild(menuClone);
      }
      
      // Show/Hide Bank Check fields based on payment type selection
      const paymentTypeRadios = document.querySelectorAll('input[name="paymentType"]');
      const bankCheckFields = document.getElementById('bankCheckFields');
      
      paymentTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'check') {
            bankCheckFields.classList.remove('hidden');
          } else {
            bankCheckFields.classList.add('hidden');
          }
        });
      });
    });
  </script>

  <script>
    // Define the toggleSubmenu function
    function toggleSubmenu(event) {
      event.preventDefault();
      const parent = event.currentTarget.parentElement;
      const submenu = parent.querySelector('ul');
      submenu.classList.toggle('hidden');
    }
  </script>

  <!-- Animation Control Script -->
  <script>
    // Initialize Lottie Animation for Page Loading
    const lottieContainer = document.getElementById('lottieContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');
    let lottieAnimation;

    // Function to show page loading overlay
    window.showPageLoading = function() {
      if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        loadingOverlay.style.opacity = '1';
        loadingOverlay.style.visibility = 'visible';
      }
    };

    // Function to hide page loading overlay
    window.hidePageLoading = function() {
      if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(function() {
          loadingOverlay.style.display = 'none';
          loadingOverlay.style.visibility = 'hidden';
        }, 500);
      }
    };

    if (lottieContainer && typeof lottie !== 'undefined') {
      try {
        // Load Lottie animation
        lottieAnimation = lottie.loadAnimation({
          container: lottieContainer,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          path: '/Loading/Loading.json'
        });

        // Hide loading overlay after page loads
        window.addEventListener('load', function() {
          setTimeout(hidePageLoading, 800);
        });
      } catch (error) {
        console.error('Error loading Lottie animation:', error);
        loadingOverlay.style.display = 'none';
      }
    } else {
      if (loadingOverlay) loadingOverlay.style.display = 'none';
    }

    // Show loading before page navigation
    window.addEventListener('beforeunload', function() {
      showPageLoading();
    });
  </script>

  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>