<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>การคืนเงิน (Refund) - Accounting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png" />
    
    <!-- Google Fonts: Prompt -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- Bootstrap Icons (ถ้าต้องการไอคอน) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- Socket.IO Client (CDN ทางการ) + SRI -->
    <script
      src="/socket.io.min.js"
      integrity="sha384-xWmNuOozkup5L7vb2ZFBg8dy0whlJd0gZAq3pvXuNa+5tSl/AjYqFNXN7kmjVTx2"
      crossorigin="anonymous"
    ></script>

    <style>
      body {
        font-family: 'Prompt', sans-serif;'
        /* ใช้ Tailwind คลุมแทน background: #f8f9fa; */
      }
      /* ตัวอย่างการสร้างเงา + hover (Tailwind + DaisyUI) */
      .card-custom {
        @apply bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 transition-transform;
      }
      .card-custom:hover {
        @apply -translate-y-1 shadow-lg;
      }
    </style>
  </head>

  <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

    <!-- Navbar (Tailwind + DaisyUI) -->
    <div class="navbar bg-white dark:bg-gray-800 shadow">
      <div class="flex-1">
        <a
          href="accounting_dashboard.html"
          class="btn btn-ghost normal-case text-lg text-gray-700 dark:text-gray-200"
        >
          <i class="bi bi-arrow-left mr-2"></i> กลับสู่หน้า Dashboard
        </a>
      </div>
    </div>

    <!-- Container -->
    <div class="max-w-5xl mx-auto p-4 mt-4">
      <h2 class="text-2xl font-bold mb-4">การคืนเงิน (Refund)</h2>

      <!-- Layout แบ่งเป็น 2 ส่วน: ฟอร์ม + ตาราง -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- ฟอร์มสร้างรายการคืนเงิน -->
        <div class="card-custom">
          <h5 class="text-xl font-semibold mb-4">เพิ่มรายการคืนเงิน</h5>
          <form id="refundForm" class="space-y-4">
            <div>
              <label
                for="refundAmount"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >จำนวนเงิน</label
              >
              <input
                type="number"
                id="refundAmount"
                placeholder="500"
                required
                class="mt-1 input input-bordered w-full dark:bg-gray-700 dark:border-gray-600"
              />
            </div>
            <div>
              <label
                for="refundReason"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                >เหตุผลการคืนเงิน</label
              >
              <textarea
                id="refundReason"
                rows="2"
                class="mt-1 textarea textarea-bordered w-full dark:bg-gray-700 dark:border-gray-600"
              ></textarea>
            </div>
            <button
              type="submit"
              class="btn btn-warning w-full"
            >
              <i class="bi bi-arrow-counterclockwise mr-1"></i> บันทึกรายการคืนเงิน
            </button>
          </form>
        </div>

        <!-- รายการคืนเงินทั้งหมด -->
        <div class="md:col-span-2 card-custom">
          <h5 class="text-xl font-semibold mb-4">รายการคืนเงินทั้งหมด</h5>
          <div class="overflow-x-auto">
            <table class="table w-full" id="refundTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>จำนวนเงิน</th>
                  <th>เหตุผล</th>
                  <th>วันที่สร้าง</th>
                </tr>
              </thead>
              <tbody>
                <!-- แสดงจาก JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="mt-6 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 py-3 text-center"
    >
      <small>© 2025 ระบบบัญชี. สงวนลิขสิทธิ์.</small>
    </footer>

    <!-- JavaScript ส่วนหลัก -->
    <script>
      // ตัวอย่างการเชื่อมต่อ Socket.IO
      const socket = io();
      socket.on('connect', () => {
        console.log('Socket.IO connected (Refund Page).');'
      });
      socket.on('disconnect', () => {
        console.warn('Socket.IO disconnected.');
      });
      // ตัวอย่าง event จาก server เช่น 'refundUpdate''
      socket.on('refundUpdate', (payload) => {'
        console.log('Realtime refund update:', payload);
        // เมื่อเกิด refundUpdate => โหลดข้อมูลใหม่
        loadRefunds();
      });

      // POST /api/refund => สร้างรายการคืนเงิน
      document.getElementById('refundForm').addEventListener('submit', async (e) => {'
        e.preventDefault();
        const amount = document.getElementById('refundAmount').value;
        const reason = document.getElementById('refundReason').value;

        try {
          const res = await fetch('/api/refund', {'
            method: 'POST','
            headers: { 'Content-Type': 'application/json' },'
            body: JSON.stringify({ amount: Number(amount), reason })
          });
          const json = await res.json();
          if (!res.ok || !json.success) {
            throw new Error(json.error || 'Add Refund failed');'
          }

          alert('บันทึกการคืนเงินเรียบร้อย!');'
          loadRefunds();
          document.getElementById('refundForm').reset();'
        } catch (err) {
          alert('เกิดข้อผิดพลาด: ' + err.message);'
        }
      });

      // GET /api/refund => แสดงรายการคืนเงิน
      async function loadRefunds() {
        try {
          const res = await fetch('/api/refund');
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'Fetch refund failed');'

          const tableBody = document.querySelector('#refundTable tbody');
          tableBody.innerHTML = '';'

          data.data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item._id}</td>
              <td>${item.amount}</td>
              <td>${item.reason || ''}</td>'
              <td>${new Date(item.createdAt).toLocaleString('th-TH')}</td>'
            `;
            tableBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
        }
      }

      // เรียกครั้งแรกเมื่อหน้าโหลด
      loadRefunds();
    </script>
  </body>
</html>
