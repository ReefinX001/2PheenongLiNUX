const express = require('express'); const router = express.Router(); const { google } = require('googleapis'); router.get('/google/callback', async (req, res) => { const { code } = req.query; if (!code) return res.send('<h1>No code received</h1>'); try { const oauth2Client = new google.auth.OAuth2(process.env.GMAIL_CLIENT_ID, process.env.GMAIL_CLIENT_SECRET, process.env.GMAIL_REDIRECT_URI); const { tokens } = await oauth2Client.getToken(code); res.send(`<h1> OAuth Success!</h1><p>Refresh Token:</p><textarea style="width:100%;height:100px">${tokens.refresh_token}</textarea><p>Add to .env:</p><code>GMAIL_REFRESH_TOKEN=${tokens.refresh_token}</code>`); } catch (error) { res.send(`<h1>Error: ${error.message}</h1>`); } }); router.get('/google/auth', (req, res) => { const oauth2Client = new google.auth.OAuth2(process.env.GMAIL_CLIENT_ID, process.env.GMAIL_CLIENT_SECRET, process.env.GMAIL_REDIRECT_URI); const authUrl = oauth2Client.generateAuthUrl({ access_type: 'offline', scope: ['https://www.googleapis.com/auth/gmail.send'], prompt: 'consent' }); res.redirect(authUrl); }); module.exports = router;
