[TAILING] Tailing last 100 lines for [server] process (change the value with --lines option)
C:\Users\Administrator\.pm2\logs\server-error.log last 100 lines:
0|server   | (node:4044) [MONGOOSE] Warning: Duplicate schema index on {"documentNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:4044) [MONGOOSE] Warning: Duplicate schema index on {"slug":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | ⚠️ Redis not available (running without Redis): Redis is already connecting/connected
0|server   | ❌ Error using DocumentNumberSystem, falling back to legacy format: TypeError: Cannot read properties of undefined (reading 'generateQuotationNumber')
0|server   |     at exports.createQuotation (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\controllers\quotationController.js:196:52)
0|server   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|server   | ⚠️ Firebase Admin SDK not initialized, skipping sync
0|server   | ⚠️ Receipt Voucher sync failed: fetch failed
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ⚠️ Receipt Voucher sync error: fetch failed
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ❌ Quotation PDF generation failed, falling back to controller: TypeError: Only absolute URLs are supported
0|server   |     at getNodeRequestOptions (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1327:9)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1450:19
0|server   |     at new Promise (<anonymous>)
0|server   |     at fetch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1447:9)
0|server   |     at EnhancedEmailService.generateQuotationPdf (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:454:30)
0|server   |     at EnhancedEmailService.generateEnhancedPdfAttachments (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:372:38)
0|server   |     at EnhancedEmailService.sendInstallmentEmailEnhanced (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:168:34)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\routes\enhancedEmailRoutes.js:54:47
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:149:13)
0|server   |     at Route.dispatch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:119:3)
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:284:15
0|server   |     at Function.process_params (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:346:12)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:280:10)
0|server   |     at Function.handle (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:175:3)
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"personalInfo.phone":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (Use `node --trace-warnings ...` to show where the warning was created)
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"depositReceiptId":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"expiresAt":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"receiptNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"assetNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"name":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"taxInvoiceNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"receiptNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"documentNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:5524) [MONGOOSE] Warning: Duplicate schema index on {"slug":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | ⚠️ Redis not available (running without Redis): Redis is already connecting/connected
0|server   | ❌ Error using DocumentNumberSystem, falling back to legacy format: TypeError: Cannot read properties of undefined (reading 'generateQuotationNumber')
0|server   |     at exports.createQuotation (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\controllers\quotationController.js:196:52)
0|server   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ⚠️ Receipt Voucher sync error: fetch failed
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ❌ Quotation PDF generation failed, falling back to controller: TypeError: Only absolute URLs are supported
0|server   |     at getNodeRequestOptions (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1327:9)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1450:19
0|server   |     at new Promise (<anonymous>)
0|server   |     at fetch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1447:9)
0|server   |     at EnhancedEmailService.generateQuotationPdf (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:454:30)
0|server   |     at EnhancedEmailService.generateEnhancedPdfAttachments (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:372:38)
0|server   |     at EnhancedEmailService.sendInstallmentEmailEnhanced (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:168:34)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\routes\enhancedEmailRoutes.js:54:47
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:149:13)
0|server   |     at Route.dispatch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:119:3)
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:284:15
0|server   |     at Function.process_params (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:346:12)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:280:10)
0|server   |     at Function.handle (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:175:3)
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"personalInfo.phone":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (Use `node --trace-warnings ...` to show where the warning was created)
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"depositReceiptId":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"expiresAt":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"receiptNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"assetNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"name":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"taxInvoiceNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"receiptNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"documentNumber":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | (node:3620) [MONGOOSE] Warning: Duplicate schema index on {"slug":1} found. This is often due to declaring an index using both "index: true" and "schema.index()". Please remove the duplicate index definition.
0|server   | ⚠️ Redis not available (running without Redis): Redis is already connecting/connected
0|server   | ❌ Error using DocumentNumberSystem, falling back to legacy format: TypeError: Cannot read properties of undefined (reading 'generateQuotationNumber')
0|server   |     at exports.createQuotation (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\controllers\quotationController.js:196:52)
0|server   |     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
0|server   | ⚠️ Firebase Admin SDK not initialized, skipping sync
0|server   | ⚠️ Receipt Voucher sync failed: fetch failed
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ⚠️ Receipt Voucher sync error: fetch failed
0|server   | ⚠️ A4PDF: No payment/financial data received
0|server   | ❌ Quotation PDF generation failed, falling back to controller: TypeError: Only absolute URLs are supported
0|server   |     at getNodeRequestOptions (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1327:9)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1450:19
0|server   |     at new Promise (<anonymous>)
0|server   |     at fetch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\node-fetch\lib\index.js:1447:9)
0|server   |     at EnhancedEmailService.generateQuotationPdf (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:454:30)
0|server   |     at EnhancedEmailService.generateEnhancedPdfAttachments (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:372:38)
0|server   |     at EnhancedEmailService.sendInstallmentEmailEnhanced (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\services\enhancedEmailService.js:168:34)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\routes\enhancedEmailRoutes.js:54:47
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:149:13)
0|server   |     at Route.dispatch (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\route.js:119:3)
0|server   |     at Layer.handle [as handle_request] (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\layer.js:95:5)
0|server   |     at C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:284:15
0|server   |     at Function.process_params (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:346:12)
0|server   |     at next (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:280:10)
0|server   |     at Function.handle (C:\Users\Administrator\Desktop\Project 3\my-accounting-app\node_modules\express\lib\router\index.js:175:3)

C:\Users\Administrator\.pm2\logs\server-out.log last 100 lines:
0|server   |   quotationNo: 'undefined',
0|server   |   order_number: 'undefined',
0|server   |   validUntil: 2025-09-30T11:34:56.411Z
0|server   | }
0|server   | 🖋️ QuotationPDF Signature Data (Enhanced Debug): {
0|server   |   customer: 'None',
0|server   |   salesperson: 'None',
0|server   |   authorized: 'None',
0|server   |   hasCustomer: true,
0|server   |   hasSalesperson: true,
0|server   |   hasEmployee: false,
0|server   |   orderKeys: [
0|server   |     '_id',             'contractNo',
0|server   |     'quotationId',     'invoiceId',
0|server   |     'customerInfo',    'items',
0|server   |     'totalAmount',     'downPayment',
0|server   |     'monthlyPayment',  'installmentTerms',
0|server   |     'docFee',          'doc_fee',
0|server   |     'vatAmount',       'taxType',
0|server   |     'beforeTaxAmount', 'totalWithTax',
0|server   |     'createdAt',       'status',
0|server   |     'quotationNumber', 'quotationNo',
0|server   |     'order_number',    'validUntil',
0|server   |     'customer',        'invoiceNumber',
0|server   |     'receiptNumber',   'salesperson'
0|server   |   ]
0|server   | }
0|server   | 🖼️ loadImageBuffer: No URL provided
0|server   | 🖼️ loadImageBuffer: No URL provided
0|server   | 🖼️ loadImageBuffer: No URL provided
0|server   | 🖼️ loadImageBuffer called with: string /uploads/S__15892486-Photoroom.png
0|server   | 🖼️ Found upload file: C:\Users\Administrator\Desktop\Project 3\my-accounting-app\uploads\S__15892486-Photoroom.png
0|server   | 🖋️ Signature loading results: {
0|server   |   customer: 'Failed',
0|server   |   salesperson: 'Failed',
0|server   |   authorized: 'Failed',
0|server   |   companyStamp: 'OK'
0|server   | }
0|server   | 🔍 QuotationPDF Raw signature data received: {
0|server   |   customerSignature: 'EMPTY',
0|server   |   customerSignatureUrl: 'EMPTY',
0|server   |   employeeSignature: 'EMPTY',
0|server   |   salespersonSignatureUrl: 'EMPTY',
0|server   |   authorizedSignature: 'EMPTY',
0|server   |   authorizedSignatureUrl: 'EMPTY'
0|server   | }
0|server   | 🖋️ QuotationPDF Signature Buffers: {
0|server   |   customer: 'NULL',
0|server   |   salesperson: 'NULL',
0|server   |   authorized: 'NULL',
0|server   |   companyStamp: 'OK'
0|server   | }
0|server   | 📄 No valid quotation number found, generating new one...
0|server   | 📄 Generated new quotation number: QT-680831-033
0|server   | 💰 QuotationPDF Document Fee Calculation: {
0|server   |   orderDocFee: 150,
0|server   |   step3DocFee: undefined,
0|server   |   fallbackDocFee: 'N/A',
0|server   |   finalDocFee: 150,
0|server   |   orderType: 'QUOTATION',
0|server   |   quotationNumber: 'QT-680831-033',
0|server   |   invoiceNumber: 'undefined'
0|server   | }
0|server   | 🔍 QuotationPDF Tax Debug: {
0|server   |   taxType: 'none',
0|server   |   documentType: undefined,
0|server   |   docFee: 150,
0|server   |   originalData: { taxType: 'none', vatAmount: 0, docFee: 150 }
0|server   | }
0|server   | 💰 QuotationPDF Price Calculation (updated to match InvoicePDF): {
0|server   |   itemsSubtotal: 0,
0|server   |   docFee: 150,
0|server   |   shipFee: 0,
0|server   |   vatTotal: 0,
0|server   |   taxType: 'none',
0|server   |   summary: { beforeTax: 150, tax: 0, netTotal: 150 },
0|server   |   grandTotal: 150
0|server   | }
0|server   | 🔍 QuotationPDF Debug - Number fields received: {
0|server   |   quotationNumber: 'QT-680831-033',
0|server   |   quotationNo: 'QT-680831-033',
0|server   |   order_number: 'QT-680831-033',
0|server   |   number: undefined,
0|server   |   _id: undefined,
0|server   |   selectedValue: 'QT-680831-033'
0|server   | }
0|server   | 💓 Health check - Server is running
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | info: 198.244.240.18 - - [31/Aug/2025:11:35:01 +0000] "GET /opening_inventory HTTP/1.1" 200 - "-" "Mozilla/5.0 (compatible; AhrefsBot/7.0; +http://ahrefs.com/robot/)" {"service":"my-accounting-app","timestamp":"2025-08-31T11:35:01.791Z"}
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | info: 2403:6200:8883:192f:1cd3:c7e2:b5e3:cdf3 - - [31/Aug/2025:11:35:56 +0000] "POST /api/enhanced-email/send-installment-enhanced HTTP/1.1" - - "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36" {"service":"my-accounting-app","timestamp":"2025-08-31T11:35:56.359Z"}
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 Running fallback auto-approval check...
0|server   | 🤖 AutoApproval: Processing all pending requests...
0|server   | 🤖 Fallback check: ไม่มีคำขอที่ต้องอนุมัติ (72ms)
0|server   | 🤖 AutoApproval: Processing all pending requests...

