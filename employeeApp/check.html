<!DOCTYPE html>
<html lang="th" class="scroll-smooth" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
    <title>เช็คอิน/เช็คเอ้าท์ - ระบบพนักงาน</title>

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2) ค่อยกำหนดค่า Tailwind -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Prompt', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                200: '#bae6fd',
                300: '#7dd3fc',
                400: '#38bdf8',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                800: '#075985',
                900: '#0c4a6e',
              },
              secondary: {
                50: '#f8fafc',
                100: '#f1f5f9',
                200: '#e2e8f0',
                300: '#cbd5e1',
                400: '#94a3b8',
                500: '#64748b',
                600: '#475569',
                700: '#334155',
                800: '#1e293b',
                900: '#0f172a',
              },
            },
            boxShadow: {
              'card': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05)',
              'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05)',
            },
          },
        },
        daisyui: {
          themes: ['light', 'dark', 'corporate'],
        },
      };
    </script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Google Fonts - Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --primary-color: #667eea;
            --primary-hover: #5a67d8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --border-color: #e5e7eb;
        }

        .dark {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --border-color: #374151;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Card styles matching frontstore_pattani */
        .card {
            background: var(--card-bg) !important;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .dark .card {
            background: #1f2937 !important;
            border-color: #374151;
        }

        .dark .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        /* Header styles */
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .location-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Status card */
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 24px;
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            margin-bottom: 24px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        /* Button styles */
        .btn-custom {
            width: 100%;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-custom:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-custom:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            color: white;
        }

        /* Map container */
        .map-container {
            width: 100%;
            height: 320px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid var(--border-color);
        }

        /* Info card */
        .info-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #bfdbfe;
        }

        .dark .info-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-color: #3b82f6;
        }

        /* History item */
        .history-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .time-badge {
            background: #e0e7ff;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .dark .time-badge {
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
        }

        /* Tab buttons */
        .tab-button {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        /* Container */
        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Dark mode toggle */
        .theme-toggle {
            padding: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(20deg);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }

            .header-section {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-section" style="display: none;">
        <div class="location-badge" id="locationInfo" style="display: none;">
            <i class="bi bi-geo-alt-fill"></i>
            <span class="text-sm" id="locationText">กำลังตรวจสอบตำแหน่ง...</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Map Container -->
        <div class="card mb-6 p-0 overflow-hidden animate__animated animate__fadeIn">
            <div class="map-container" id="map"></div>
        </div>

        <!-- Status Card -->
        <div class="status-card animate__animated animate__fadeIn">
            <div class="text-center">
                <div class="text-sm opacity-90 mb-2">สถานะวันนี้</div>
                <div class="text-3xl font-bold mb-4" id="statusText">ยังไม่ได้เช็คอิน</div>
                <div class="flex justify-center gap-4 flex-wrap">
                    <div class="status-badge">
                        <i class="bi bi-box-arrow-in-right"></i>
                        <span>เข้า: <span id="checkInTime">--:--</span></span>
                    </div>
                    <div class="status-badge">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>ออก: <span id="checkOutTime">--:--</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mb-6">
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-2 text-center" id="nextActionHint">
                กดปุ่มด้านล่างเพื่อเริ่มต้น
            </div>
            <button class="btn-custom btn-success w-full" id="actionBtn" onclick="handleAction()">
                <i class="bi bi-box-arrow-in-right text-2xl"></i>
                <span id="actionBtnText">เข้างาน</span>
            </button>
        </div>

        <!-- Working Hours Info -->
        <div class="info-card mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">ชั่วโมงทำงานวันนี้</div>
                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="workingHours">0.0</div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">พักเบรก</div>
                    <div class="text-xl font-semibold text-gray-800 dark:text-gray-200" id="breakTime">0 นาที</div>
                </div>
            </div>
        </div>

        <!-- History Tabs -->
        <div class="flex gap-2 mb-4 overflow-x-auto">
            <button class="tab-button active" onclick="switchTab(event, 'today')">วันนี้</button>
            <button class="tab-button" onclick="switchTab(event, 'week')">สัปดาห์นี้</button>
            <button class="tab-button" onclick="switchTab(event, 'month')">เดือนนี้</button>
        </div>

        <!-- History Section -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="bi bi-clock-history text-indigo-600"></i>
                ประวัติการเช็คอิน
            </h3>

            <!-- Date Range Picker -->
            <div class="mb-4 flex gap-2 flex-wrap">
                <input type="date"
                       id="startDate"
                       class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       style="flex: 1; min-width: 150px;">
                <input type="date"
                       id="endDate"
                       class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       style="flex: 1; min-width: 150px;">
                <button onclick="loadAttendanceByDateRange()"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    <i class="bi bi-search"></i> ค้นหา
                </button>
            </div>

            <div id="historyList">
                <!-- History items will be loaded here -->
                <div class="text-center text-gray-400 py-12">
                    <i class="bi bi-inbox text-5xl mb-3 block opacity-50"></i>
                    <p>ไม่มีประวัติ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script>
        window.initGoogleMaps = function() {
            console.log('🗺️ Google Maps API loaded successfully');
            window.isGoogleMapsLoaded = true;
            initMap();
        };

        window.gm_authFailure = function() {
            console.error('Google Maps API authentication failed');
            document.getElementById('map').innerHTML = `
                <div class="flex items-center justify-center h-full bg-gray-100 dark:bg-gray-800">
                    <div class="text-center p-4">
                        <i class="bi bi-exclamation-triangle text-5xl text-red-500 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400">ไม่สามารถโหลดแผนที่ได้</p>
                    </div>
                </div>
            `;
        };
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBA0Qs-rHslLghMCAmbLplx_zMNjeY7TZE&libraries=geometry&callback=initGoogleMaps"></script>

    <!-- Main Script -->
    <script>
        let map, marker, circle;
        let currentPosition = null;
        let currentAction = 'checkin'; // checkin, break_out, break_in, checkout
        let todayAttendance = {
            checkIn: null,
            checkOut: null,
            location: null
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            requestLocation();
            loadTodayAttendance();
            initTheme();

            // Set default date range (last 7 days)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);

            document.getElementById('endDate').valueAsDate = today;
            document.getElementById('startDate').valueAsDate = sevenDaysAgo;

            // Load today's history by default
            loadAttendanceHistory('today');
        });

        // Update date and time
        function updateDateTime() {
            const now = new Date();

            // Update working hours if checked in
            if (todayAttendance.checkIn && !todayAttendance.checkOut) {
                const hours = (now - new Date(todayAttendance.checkIn)) / (1000 * 60 * 60);
                const workingHoursEl = document.getElementById('workingHours');
                if (workingHoursEl) {
                    workingHoursEl.textContent = hours.toFixed(1);
                }
            }
        }

        // Initialize Google Map
        function initMap() {
            const defaultCenter = { lat: 13.7563, lng: 100.5018 }; // Bangkok default

            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Add marker for user location
            marker = new google.maps.Marker({
                map: map,
                position: defaultCenter,
                title: 'ตำแหน่งของคุณ',
                animation: google.maps.Animation.DROP,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }
            });

            // Add circle for user's current location (small indicator)
            circle = new google.maps.Circle({
                map: map,
                center: defaultCenter,
                radius: 50, // 50 meters
                fillColor: '#FF0000',
                fillOpacity: 0.15,
                strokeColor: '#FF0000',
                strokeOpacity: 0.6,
                strokeWeight: 2
            });

            // Update map with current location when available
            if (currentPosition) {
                updateMapLocation(currentPosition.lat, currentPosition.lng);
            }

            // Load and display all zones
            loadZonesOnMap();
        }

        // Load zones and display on map
        async function loadZonesOnMap() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('⚠️ No auth token, skipping zone loading');
                    return;
                }

                console.log('📍 Fetching zones from /api/zone/my-zones');

                const response = await fetch('/api/zone/my-zones', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('❌ Failed to fetch zones:', response.status);
                    return;
                }

                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    console.log('ℹ️ No zones found for this user');
                    return;
                }

                const zones = result.data;
                console.log(`✅ Loaded ${zones.length} zones:`, zones);

                // Store zone markers
                window.zoneMarkers = [];
                window.zoneCircles = [];

                // Create bounds to fit all zones
                const bounds = new google.maps.LatLngBounds();

                zones.forEach(zone => {
                    const lat = zone.center?.latitude;
                    const lng = zone.center?.longitude;

                    if (!lat || !lng) {
                        console.warn('⚠️ Zone missing coordinates:', zone.name);
                        return;
                    }

                    const radius = zone.radius || 500;
                    const position = { lat, lng };

                    // Add zone marker (blue)
                    const zoneMarker = new google.maps.Marker({
                        map: map,
                        position: position,
                        title: zone.name,
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                        }
                    });

                    // Add info window
                    const infoContent = `
                        <div style="padding: 10px; max-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; font-weight: bold; color: #1a73e8;">${zone.name}</h3>
                            <p style="margin: 4px 0; font-size: 13px;"><strong>รหัส:</strong> ${zone.branch_code || 'N/A'}</p>
                            <p style="margin: 4px 0; font-size: 13px;"><strong>รัศมี:</strong> ${radius} เมตร</p>
                            ${zone.branchId?.name ? `<p style="margin: 4px 0; font-size: 13px;"><strong>สาขา:</strong> ${zone.branchId.name}</p>` : ''}
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    zoneMarker.addListener('click', () => {
                        // Close other info windows
                        window.zoneMarkers.forEach(m => {
                            if (m.infoWindow) m.infoWindow.close();
                        });
                        infoWindow.open(map, zoneMarker);
                    });

                    zoneMarker.infoWindow = infoWindow;

                    // Add zone circle
                    const zoneCircle = new google.maps.Circle({
                        map: map,
                        center: position,
                        radius: radius,
                        fillColor: '#4285F4',
                        fillOpacity: 0.15,
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.5,
                        strokeWeight: 2
                    });

                    window.zoneMarkers.push(zoneMarker);
                    window.zoneCircles.push(zoneCircle);

                    // Extend bounds to include this zone
                    bounds.extend(position);

                    console.log(`✅ Added zone: ${zone.name} at ${lat}, ${lng}, radius: ${radius}m`);
                });

                // Fit map to show all zones
                if (zones.length > 0) {
                    map.fitBounds(bounds);
                    // Adjust zoom if too close
                    const listener = google.maps.event.addListener(map, 'idle', () => {
                        if (map.getZoom() > 16) map.setZoom(16);
                        google.maps.event.removeListener(listener);
                    });
                }

                console.log(`✅ Successfully loaded ${window.zoneMarkers.length} zones on map`);

            } catch (err) {
                console.error('❌ Error loading zones on map:', err);
            }
        }

        // Request geolocation
        async function requestLocation() {
            const locationText = document.getElementById('locationText');

            try {
                const hasPermission = await checkGeolocationPermission();

                if (!hasPermission || !navigator.geolocation) {
                    // Hide location info if not available
                    document.getElementById('locationInfo').style.display = 'none';
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };

                        // Show location info only when we have position
                        document.getElementById('locationInfo').style.display = 'flex';
                        locationText.textContent = `ตำแหน่งปัจจุบัน: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;

                        if (map) {
                            updateMapLocation(currentPosition.lat, currentPosition.lng);
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let errorMsg = 'ไม่สามารถระบุตำแหน่งได้';

                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'กรุณาอนุญาตการเข้าถึงตำแหน่ง';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'ไม่สามารถระบุตำแหน่งได้';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'หมดเวลาในการระบุตำแหน่ง';
                                break;
                        }

                        // Hide location info on error
                        document.getElementById('locationInfo').style.display = 'none';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('Error requesting location:', error);
                // Hide location info on error
                document.getElementById('locationInfo').style.display = 'none';
            }
        }

        async function checkGeolocationPermission() {
            try {
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    return permission.state === 'granted' || permission.state === 'prompt';
                }
                return 'geolocation' in navigator;
            } catch (error) {
                return 'geolocation' in navigator;
            }
        }

        function updateMapLocation(lat, lng) {
            const position = { lat, lng };

            if (map) {
                map.setCenter(position);
                marker.setPosition(position);
                circle.setCenter(position);
            }
        }

        // Get user's branch ID from latest user data
        async function getUserBranch() {
            const token = localStorage.getItem('authToken');

            // Try to get from localStorage first (fast)
            let userData = JSON.parse(localStorage.getItem('userData') || '{}');
            let branchId = userData.checkinBranches?.[0]?._id ||
                          userData.checkinBranches?.[0] ||
                          userData.allowedBranches?.[0]?._id ||
                          userData.allowedBranches?.[0] ||
                          userData.defaultBranches?.[0]?._id ||
                          userData.defaultBranches?.[0];

            // If not found, fetch from API
            if (!branchId && token) {
                try {
                    const response = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            userData = result.data;
                            localStorage.setItem('userData', JSON.stringify(userData));

                            branchId = userData.checkinBranches?.[0]?._id ||
                                      userData.checkinBranches?.[0] ||
                                      userData.allowedBranches?.[0]?._id ||
                                      userData.allowedBranches?.[0] ||
                                      userData.defaultBranches?.[0]?._id ||
                                      userData.defaultBranches?.[0];
                        }
                    }
                } catch (err) {
                    console.error('Error fetching user branch:', err);
                }
            }

            return branchId;
        }

        // Update button UI based on current action
        function updateActionButton() {
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('actionBtnText');
            const hint = document.getElementById('nextActionHint');

            const actionConfig = {
                'checkin': {
                    text: 'เข้างาน',
                    icon: 'bi-box-arrow-in-right',
                    color: 'btn-success',
                    hint: 'กดเพื่อบันทึกเวลาเข้างาน'
                },
                'break_out': {
                    text: 'ออกพัก',
                    icon: 'bi-cup-hot',
                    color: 'btn-warning',
                    hint: 'กดเพื่อบันทึกเวลาออกพัก'
                },
                'break_in': {
                    text: 'เข้างาน (หลังพัก)',
                    icon: 'bi-box-arrow-in-right',
                    color: 'btn-info',
                    hint: 'กดเพื่อบันทึกเวลากลับเข้างานหลังพัก'
                },
                'checkout': {
                    text: 'เลิกงาน',
                    icon: 'bi-box-arrow-right',
                    color: 'btn-danger',
                    hint: 'กดเพื่อบันทึกเวลาเลิกงาน'
                }
            };

            const config = actionConfig[currentAction];
            if (!config) return;

            btnText.textContent = config.text;
            hint.textContent = config.hint;

            // Update button color
            btn.className = `btn-custom ${config.color} w-full`;
            btn.querySelector('i').className = `${config.icon} text-2xl`;
        }

        // Handle Action
        async function handleAction() {
            const btn = document.getElementById('actionBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div><span>กำลังบันทึก...</span>';

            try {
                if (!currentPosition) {
                    showToast('กรุณารอสักครู่ เพื่อระบุตำแหน่งของคุณ', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    return;
                }

                const token = localStorage.getItem('authToken');
                const userId = localStorage.getItem('userId');

                if (!token || !userId) {
                    showToast('กรุณาเข้าสู่ระบบใหม่อีกครั้ง', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    return;
                }

                const branchId = await getUserBranch();

                if (!branchId) {
                    showToast('ไม่พบข้อมูลสาขา กรุณาติดต่อฝ่ายบุคคล', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    return;
                }

                const response = await fetch('/api/attendance/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        branch: branchId,
                        actionType: currentAction,
                        location: {
                            latitude: currentPosition.lat,
                            longitude: currentPosition.lng
                        },
                        checkInType: 'normal'
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'บันทึกไม่สำเร็จ');
                }

                // Update next action
                if (result.nextAction) {
                    currentAction = result.nextAction;
                } else {
                    // เลิกงานแล้ว
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-check-circle text-2xl"></i><span>เลิกงานแล้ว</span>';
                    document.getElementById('nextActionHint').textContent = 'คุณได้บันทึกการเลิกงานวันนี้แล้ว';
                }

                const actionLabels = {
                    'checkin': 'เข้างาน',
                    'break_out': 'ออกพัก',
                    'break_in': 'เข้างาน (หลังพัก)',
                    'checkout': 'เลิกงาน'
                };

                showToast(`บันทึก ${actionLabels[result.attendance.actionType]} สำเร็จ!`, 'success');

                // Update button for next action
                if (result.nextAction) {
                    updateActionButton();
                    btn.disabled = false;
                }

                loadAttendanceHistory('today');

            } catch (err) {
                console.error('Action error:', err);
                showToast(err.message || 'เกิดข้อผิดพลาดในการบันทึก', 'error');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Handle Check In (backward compatibility)
        async function handleCheckIn() {
            const btn = document.getElementById('checkInBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div><span>กำลังเช็คอิน...</span>';

            try {
                if (!currentPosition) {
                    showToast('กรุณารอสักครู่ เพื่อระบุตำแหน่งของคุณ', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-box-arrow-in-right text-2xl"></i><span>เช็คอิน</span>';
                    return;
                }

                // Send to server
                const token = localStorage.getItem('authToken');
                const userId = localStorage.getItem('userId');

                if (!token || !userId) {
                    showToast('กรุณาเข้าสู่ระบบใหม่อีกครั้ง', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-box-arrow-in-right text-2xl"></i><span>เช็คอิน</span>';
                    return;
                }

                // Get user's branch from API
                const branchId = await getUserBranch();

                if (!branchId) {
                    showToast('ไม่พบข้อมูลสาขา กรุณาติดต่อฝ่ายบุคคล', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-box-arrow-in-right text-2xl"></i><span>เช็คอิน</span>';
                    return;
                }

                const selectedShift = document.getElementById('shiftSelect').value;

                const response = await fetch('/api/attendance/checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        branch: branchId,
                        shift: selectedShift,
                        location: {
                            latitude: currentPosition.lat,
                            longitude: currentPosition.lng
                        },
                        checkInType: 'normal'
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'เช็คอินไม่สำเร็จ');
                }

                const now = new Date();
                todayAttendance.checkIn = result.attendance?.checkIn || now.toISOString();
                todayAttendance.location = currentPosition;
                todayAttendance._id = result.attendance?._id;

                document.getElementById('statusText').textContent = 'เช็คอินแล้ว';
                document.getElementById('checkInTime').textContent = new Date(todayAttendance.checkIn).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                btn.disabled = true;
                document.getElementById('checkOutBtn').disabled = false;

                btn.innerHTML = '<i class="bi bi-check-circle text-2xl"></i><span>เช็คอินแล้ว</span>';

                showToast('เช็คอินสำเร็จ!', 'success');
                addHistoryItem('เช็คอิน', new Date(todayAttendance.checkIn));

            } catch (error) {
                console.error('Check-in error:', error);
                showToast('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-in-right text-2xl"></i><span>เช็คอิน</span>';
            }
        }

        // Handle Check Out
        async function handleCheckOut() {
            const btn = document.getElementById('checkOutBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner"></div><span>กำลังเช็คเอ้าท์...</span>';

            try {
                if (!currentPosition) {
                    showToast('กรุณารอสักครู่ เพื่อระบุตำแหน่งของคุณ', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-box-arrow-right text-2xl"></i><span>เช็คเอ้าท์</span>';
                    return;
                }

                // Send to server
                const token = localStorage.getItem('authToken');
                const userId = localStorage.getItem('userId');

                if (!token || !userId) {
                    showToast('กรุณาเข้าสู่ระบบใหม่อีกครั้ง', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-box-arrow-right text-2xl"></i><span>เช็คเอ้าท์</span>';
                    return;
                }

                // Get user's branch from API
                const branchId = await getUserBranch();

                const selectedShift = document.getElementById('shiftSelect').value;

                const response = await fetch('/api/attendance/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        branch: branchId,
                        shift: selectedShift,
                        location: {
                            lat: currentPosition.lat,
                            lng: currentPosition.lng
                        }
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'เช็คเอ้าท์ไม่สำเร็จ');
                }

                const now = new Date();
                todayAttendance.checkOut = result.attendance?.checkOut || now.toISOString();

                document.getElementById('statusText').textContent = 'เช็คเอ้าท์แล้ว';
                document.getElementById('checkOutTime').textContent = new Date(todayAttendance.checkOut).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                const hours = (new Date(todayAttendance.checkOut) - new Date(todayAttendance.checkIn)) / (1000 * 60 * 60);
                document.getElementById('workingHours').textContent = hours.toFixed(1);

                btn.innerHTML = '<i class="bi bi-check-circle text-2xl"></i><span>เช็คเอ้าท์แล้ว</span>';

                showToast('เช็คเอ้าท์สำเร็จ!', 'success');
                addHistoryItem('เช็คเอ้าท์', new Date(todayAttendance.checkOut));

            } catch (error) {
                console.error('Check-out error:', error);
                showToast('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-right text-2xl"></i><span>เช็คเอ้าท์</span>';
            }
        }

        async function loadTodayAttendance() {
            const token = localStorage.getItem('authToken');
            const userId = localStorage.getItem('userId');

            if (!token || !userId) {
                console.log('No auth token or userId, skipping attendance load');
                return;
            }

            try {
                // Fetch user profile to get checkinBranches (same as attendance.html)
                console.log('🔍 Fetching user profile from /api/users/me');
                const userResponse = await fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error(`Failed to fetch user profile: ${userResponse.status}`);
                }

                const userResult = await userResponse.json();
                console.log('👤 User profile:', userResult);

                if (!userResult.success || !userResult.data) {
                    throw new Error('Invalid user profile response');
                }

                const userData = userResult.data;

                // Update localStorage with fresh data
                localStorage.setItem('userData', JSON.stringify(userData));

                // Get user's checkin branch (same logic as attendance.html)
                const branchId = userData.checkinBranches?.[0]?._id ||
                                userData.checkinBranches?.[0] ||
                                userData.allowedBranches?.[0]?._id ||
                                userData.allowedBranches?.[0] ||
                                userData.defaultBranches?.[0]?._id ||
                                userData.defaultBranches?.[0];

                if (!branchId) {
                    console.log('❌ No branch found for user');
                    showToast('ไม่พบสาขาที่คุณสามารถเช็คอินได้ กรุณาติดต่อฝ่ายบุคคล', 'warning');
                    return;
                }

                console.log('✅ Found branch:', branchId);

                // Fetch branch details to get location for map
                console.log('🔍 Fetching branch details from /api/branch');
                try {
                    const branchResponse = await fetch(`/api/branch/${branchId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (branchResponse.ok) {
                        const branchResult = await branchResponse.json();
                        console.log('🏢 Branch details:', branchResult);

                        if (branchResult.success && branchResult.data) {
                            const branchData = branchResult.data;

                            // Extract location coordinates from different possible structures (same as attendance.html)
                            const lat = branchData.latitude ||
                                       branchData.lat ||
                                       branchData.center?.latitude ||
                                       branchData.coordinates?.lat ||
                                       branchData.location?.latitude ||
                                       branchData.location?.coordinates?.lat;

                            const lng = branchData.longitude ||
                                       branchData.lng ||
                                       branchData.center?.longitude ||
                                       branchData.coordinates?.lng ||
                                       branchData.location?.longitude ||
                                       branchData.location?.coordinates?.lng;

                            const radius = branchData.checkInRadius ||
                                          branchData.location?.allowedRadius ||
                                          100;

                            // Update map to branch location if available
                            if (lat && lng) {
                                console.log('📍 Updating map to branch location:', { lat, lng, radius });

                                // Store branch location globally
                                window.branchLocation = {
                                    lat: lat,
                                    lng: lng,
                                    name: branchData.name || branchData.branchName || 'สาขา',
                                    radius: radius
                                };

                                // Update map if already loaded
                                if (map && marker && circle) {
                                    const branchPos = {
                                        lat: lat,
                                        lng: lng
                                    };
                                    map.setCenter(branchPos);
                                    circle.setCenter(branchPos);
                                    circle.setRadius(radius);

                                    // Add branch marker (blue marker for branch location)
                                    if (!window.branchMarker) {
                                        window.branchMarker = new google.maps.Marker({
                                            map: map,
                                            position: branchPos,
                                            title: branchData.name || 'สาขา',
                                            icon: {
                                                url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                                            }
                                        });
                                    } else {
                                        window.branchMarker.setPosition(branchPos);
                                    }
                                }
                            }
                        }
                    }
                } catch (branchErr) {
                    console.error('❌ Failed to fetch branch details:', branchErr);
                }

                // Test endpoint first
                console.log('🧪 Testing /api/attendance/test');
                try {
                    const testResp = await fetch('/api/attendance/test');
                    const testResult = await testResp.json();
                    console.log('🧪 Test result:', testResult);
                } catch (testErr) {
                    console.error('🧪 Test failed:', testErr);
                }

                // Load from API - use session/today endpoint
                console.log('🔍 Loading attendance for branch:', branchId);
                console.log('🔑 Token:', token ? 'Present' : 'Missing');
                console.log('🔑 Token value:', token?.substring(0, 20) + '...');

                const response = await fetch(`/api/attendance/session/today?branch=${branchId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('📡 Response status:', response.status);
                console.log('📡 Response ok:', response.ok);

                if (!response.ok) {
                    // If 404, the endpoint might not exist or route not registered
                    if (response.status === 404) {
                        console.warn('⚠️ Attendance API endpoint not found (404). Using localStorage fallback.');
                    } else {
                        const errorText = await response.text();
                        console.error('❌ API Error:', errorText);
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('📥 Result:', result);

                // Handle both response formats: { session } or { inTime, outTime }
                if (result.success) {
                    let todayRecord;

                    if (result.session) {
                        // New format
                        todayRecord = result.session;
                    } else if (result.inTime) {
                        // Legacy format from /session/today
                        todayRecord = {
                            checkIn: result.inTime,
                            checkOut: result.outTime
                        };
                    }

                    if (todayRecord && todayRecord.checkIn) {
                        todayAttendance = {
                            _id: todayRecord._id,
                            checkIn: todayRecord.checkIn,
                            checkOut: todayRecord.checkOut,
                            location: todayRecord.location
                        };

                        // Update UI
                        updateAttendanceUI();

                        // Save to localStorage
                        localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
                    }
                }
            } catch (error) {
                console.error('Error loading today attendance:', error);

                // Fallback to localStorage if API fails
                loadAttendanceFromLocalStorage();
            }
        }

        function updateAttendanceUI() {
            if (!todayAttendance.checkIn) return;

            const checkInTime = new Date(todayAttendance.checkIn);
            document.getElementById('checkInTime').textContent = checkInTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('checkInBtn').disabled = true;
            document.getElementById('checkInBtn').innerHTML = '<i class="bi bi-check-circle text-2xl"></i><span>เช็คอินแล้ว</span>';

            if (todayAttendance.checkOut) {
                const checkOutTime = new Date(todayAttendance.checkOut);
                document.getElementById('statusText').textContent = 'เช็คเอ้าท์แล้ว';
                document.getElementById('checkOutTime').textContent = checkOutTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('checkOutBtn').disabled = true;
                document.getElementById('checkOutBtn').innerHTML = '<i class="bi bi-check-circle text-2xl"></i><span>เช็คเอ้าท์แล้ว</span>';

                const hours = (checkOutTime - checkInTime) / (1000 * 60 * 60);
                document.getElementById('workingHours').textContent = hours.toFixed(1);
            } else {
                document.getElementById('statusText').textContent = 'เช็คอินแล้ว';
                document.getElementById('checkOutBtn').disabled = false;
            }
        }

        function loadAttendanceFromLocalStorage() {
            const saved = localStorage.getItem('todayAttendance');
            if (saved) {
                todayAttendance = JSON.parse(saved);
                updateAttendanceUI();
            }
        }

        function addHistoryItem(type, time) {
            const historyList = document.getElementById('historyList');

            if (historyList.querySelector('.text-gray-400')) {
                historyList.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'history-item animate__animated animate__fadeInUp';
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-semibold text-gray-800 dark:text-gray-200">${type}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            <i class="bi bi-geo-alt mr-1"></i>
                            ${currentPosition ? `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}` : 'ไม่มีข้อมูลตำแหน่ง'}
                        </div>
                    </div>
                    <span class="time-badge">
                        ${time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
                    </span>
                </div>
            `;

            historyList.insertBefore(item, historyList.firstChild);
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            console.log('Loading history for:', tab);
            loadAttendanceHistory(tab);
        }

        // Load attendance history from API
        async function loadAttendanceHistory(period = 'today') {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('⚠️ No auth token');
                    return;
                }

                const userId = localStorage.getItem('userId');
                if (!userId) {
                    console.log('⚠️ No user ID');
                    return;
                }

                // Calculate date range based on period
                const now = new Date();
                let startDate, endDate;

                if (period === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                } else if (period === 'week') {
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Monday
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(now.getFullYear(), now.getMonth(), diff + 6, 23, 59, 59);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                }

                console.log(`📅 Loading ${period} history from ${startDate} to ${endDate}`);

                // Fetch attendance history
                const response = await fetch(`/api/attendance/my-history?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch history: ${response.status}`);
                }

                const result = await response.json();
                const historyList = document.getElementById('historyList');

                if (!result.success || !result.data || result.data.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <i class="bi bi-inbox text-5xl mb-3 block opacity-50"></i>
                            <p>ไม่มีประวัติการเช็คอิน</p>
                        </div>
                    `;
                    return;
                }

                // Filter data by period
                const filteredData = result.data.filter(record => {
                    const checkInDate = new Date(record.checkIn);
                    return checkInDate >= startDate && checkInDate <= endDate;
                });

                if (filteredData.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <i class="bi bi-inbox text-5xl mb-3 block opacity-50"></i>
                            <p>ไม่มีประวัติการเช็คอินในช่วงเวลานี้</p>
                        </div>
                    `;
                    return;
                }

                // Display history items
                historyList.innerHTML = filteredData.map(record => {
                    const checkIn = new Date(record.checkIn);
                    const checkOut = record.checkOut ? new Date(record.checkOut) : null;
                    const duration = checkOut ? ((checkOut - checkIn) / (1000 * 60 * 60)).toFixed(1) : 'กำลังทำงาน';

                    // Action label mapping
                    const actionLabels = {
                        checkin: '✅ เข้างาน',
                        break_out: '☕ ออกพัก',
                        break_in: '↩️ เข้างาน',
                        checkout: '🏁 เลิกงาน'
                    };
                    const actionLabel = actionLabels[record.actionType] || record.actionType || '';

                    return `
                        <div class="history-item animate__animated animate__fadeInUp">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-gray-800 dark:text-gray-200">
                                        ${checkIn.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' })}
                                        ${actionLabel ? `<span class="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">${actionLabel}</span>` : ''}
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                        เข้า: ${checkIn.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
                                        ${checkOut ? `| ออก: ${checkOut.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                    ${record.branch?.name ? `<div class="text-xs text-gray-500 mt-1">📍 ${record.branch.name}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-indigo-600 dark:text-indigo-400">
                                        ${typeof duration === 'number' ? duration + ' ชม.' : duration}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${record.checkInType === 'normal' ? 'ปกติ' : record.checkInType === 'outside_area' ? 'นอกพื้นที่' : 'ต่างสาขา'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log(`✅ Loaded ${result.data.length} history records`);

            } catch (err) {
                console.error('❌ Error loading attendance history:', err);
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = `
                    <div class="text-center text-red-400 py-12">
                        <i class="bi bi-exclamation-triangle text-5xl mb-3 block"></i>
                        <p>เกิดข้อผิดพลาดในการโหลดประวัติ</p>
                    </div>
                `;
            }
        }

        // Load attendance by custom date range
        async function loadAttendanceByDateRange() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;

            if (!startDateInput || !endDateInput) {
                showToast('กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด', 'error');
                return;
            }

            const startDate = new Date(startDateInput);
            startDate.setHours(0, 0, 0, 0);

            const endDate = new Date(endDateInput);
            endDate.setHours(23, 59, 59, 999);

            if (startDate > endDate) {
                showToast('วันที่เริ่มต้นต้องไม่มากกว่าวันที่สิ้นสุด', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showToast('กรุณาเข้าสู่ระบบใหม่', 'error');
                    setTimeout(() => window.location.href = '/employee/login', 1500);
                    return;
                }

                const response = await fetch(`/api/attendance/my-history?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'ไม่สามารถดึงข้อมูลได้');
                }

                // Filter records by date range
                const filteredData = result.data.filter(record => {
                    const checkInDate = new Date(record.checkIn);
                    return checkInDate >= startDate && checkInDate <= endDate;
                });

                const historyList = document.getElementById('historyList');

                if (filteredData.length === 0) {
                    historyList.innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <i class="bi bi-inbox text-5xl mb-3 block opacity-50"></i>
                            <p>ไม่มีประวัติในช่วงวันที่นี้</p>
                        </div>
                    `;
                    return;
                }

                // Display filtered records
                historyList.innerHTML = filteredData.map(record => {
                    const checkIn = new Date(record.checkIn);
                    const checkOut = record.checkOut ? new Date(record.checkOut) : null;
                    const duration = checkOut ? ((checkOut - checkIn) / (1000 * 60 * 60)).toFixed(1) : 'กำลังทำงาน';

                    // Action label mapping
                    const actionLabels = {
                        checkin: '✅ เข้างาน',
                        break_out: '☕ ออกพัก',
                        break_in: '↩️ เข้างาน',
                        checkout: '🏁 เลิกงาน'
                    };
                    const actionLabel = actionLabels[record.actionType] || record.actionType || '';

                    return `
                        <div class="history-item animate__animated animate__fadeInUp">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium text-gray-800 dark:text-gray-200">
                                        ${checkIn.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' })}
                                        ${actionLabel ? `<span class="ml-2 text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">${actionLabel}</span>` : ''}
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                        เข้า: ${checkIn.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}
                                        ${checkOut ? `| ออก: ${checkOut.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                    ${record.branch?.name ? `<div class="text-xs text-gray-500 mt-1">📍 ${record.branch.name}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-indigo-600 dark:text-indigo-400">
                                        ${typeof duration === 'number' ? duration + ' ชม.' : duration}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${record.checkInType === 'normal' ? 'ปกติ' : record.checkInType === 'outside_area' ? 'นอกพื้นที่' : 'ต่างสาขา'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                showToast(`พบ ${filteredData.length} รายการ`, 'success');
                console.log(`✅ Loaded ${filteredData.length} records from ${startDateInput} to ${endDateInput}`);

            } catch (err) {
                console.error('❌ Error loading attendance by date range:', err);
                showToast('เกิดข้อผิดพลาดในการโหลดประวัติ', 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? 'check-circle-fill' :
                        type === 'error' ? 'x-circle-fill' : 'info-circle-fill';

            const color = type === 'success' ? '#10b981' :
                         type === 'error' ? '#ef4444' : '#3b82f6';

            toast.innerHTML = `
                <i class="bi bi-${icon}" style="color: ${color}; font-size: 20px;"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideInUp 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Theme toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').classList.replace('bi-moon-fill', 'bi-sun-fill');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');

            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.setAttribute('data-theme', 'light');
                icon.classList.replace('bi-sun-fill', 'bi-moon-fill');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                html.setAttribute('data-theme', 'dark');
                icon.classList.replace('bi-moon-fill', 'bi-sun-fill');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Save attendance to localStorage
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('todayAttendance', JSON.stringify(todayAttendance));
        });
    </script>

    <!-- Navigation Scripts -->
    <script src="/employeeApp/js/app.js"></script>
    <script src="/employeeApp/js/nav.js"></script>
</body>
</html>
