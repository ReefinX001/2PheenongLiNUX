<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>à¸£à¸°à¸šà¸šà¸œà¹ˆà¸­à¸™à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ - à¸«à¸™à¹‰à¸²à¹à¸£à¸ (Pro Version)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind & DaisyUI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // à¹‚à¸«à¸¥à¸”à¸˜à¸µà¸¡à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰ (à¸à¹ˆà¸­à¸™ CSS/Lazy load)
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          animation: {
            'fadeIn': 'fadeIn 0.5s ease-out',
            'pulse-slow': 'pulse 3s infinite',
            'bounce-slow': 'bounce 3s infinite',
          }
        },
      },
      daisyui: { themes: ['light','dark','corporate'] },
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" />

  <!-- Icons & Socket.io -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Socket.io will be loaded below via CDN -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Day.js with Thai locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
  <script>dayjs.locale('th');</script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>

  <!-- SweetAlert2 for better alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="/views/pattani/sidebar/sidebar.css" />

  <!-- Avatar Utils -->
  <script src="/js/avatar-utils.js"></script>

  <!-- Loan Sidebar JS -->
  <script src="/views/loan/loan-sidebar.js"></script>

  <!-- Customer API Integration -->
  <!-- <script src="/views/loan/js/customer-api-integration.js"></script> à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ UnifiedCustomer à¹à¸¥à¹‰à¸§ -->

  <!-- Utility Functions -->
  <script>
    // Utility functions to prevent console errors
    // Debounce function for search performance optimization
    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function showToast(message, type = 'info') {
      // Only log errors and important messages
      if (type === 'error') {
        console.error(`[${type.toUpperCase()}] ${message}`);
      }
      // If SweetAlert2 is available, use it
      if (typeof Swal !== 'undefined') {
        const Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true
        });
        Toast.fire({
          icon: type === 'error' ? 'error' : type === 'success' ? 'success' : 'info',
          title: message
        });
      }
    }

    function showLoading(show = true) {
      const loader = document.getElementById('loadingOverlay');
      if (loader) {
        loader.style.display = show ? 'flex' : 'none';
      } else if (show) {
        // Create loading overlay if it doesn't exist
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        overlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(overlay);
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(amount || 0);
    }

    function formatDate(date) {
      if (!date) return '-';
      return dayjs(date).format('DD/MM/YYYY');
    }

    function formatDateTime(date) {
      if (!date) return '-';
      return dayjs(date).format('DD/MM/YYYY HH:mm');
    }

    // Make functions globally available
    window.showToast = showToast;
    window.showLoading = showLoading;
    window.formatCurrency = formatCurrency;
    window.formatDate = formatDate;
    window.formatDateTime = formatDateTime;
  </script>

  <style>
    html { scroll-behavior: smooth }
    body { font-family: 'Inter', sans-serif; }
    
    /* Animation Effects */
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px)} to {opacity:1;transform:translateY(0)} }
    .animate-fadeIn { animation:fadeIn .5s ease-out }
    
    /* Loading Animation */
    @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    /* Logo */
    .Logo { max-width:100%; height:auto; transition: transform 0.3s ease-in-out; }
    .Logo:hover { transform: scale(1.05); }
    
    /* Enhanced Table */
    .enhanced-table th {
      background-color: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      font-weight: 600;
    }
    .dark .enhanced-table th {
      background-color: rgba(96, 165, 250, 0.2);
      color: #93c5fd;
    }
    

    
    /* Minimal enhancements */
    .search-input {
      transition: all 0.2s ease;
    }
  </style>
</head>
  <body class="bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-200">
  <!-- Sidebar Container - à¸ˆà¸°à¸–à¸¹à¸à¹€à¸•à¸´à¸¡à¸”à¹‰à¸§à¸¢ loan-sidebar.js -->
  <div id="sidebarContainer"></div>

  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Main Content -->
    <div class="flex-1 flex flex-col ml-64 main-content">
      <header class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-800 dark:text-white">à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400">à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¸°à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium p-2 bg-blue-50 dark:bg-gray-700 rounded-lg shadow-sm" id="currentDate">
            <i class="bi bi-calendar-check mr-1 text-blue-500"></i>
            <span id="dateDisplay">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</span>
          </span>
        </div>
      </header>
      
      <section class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
        <div class="flex flex-col sm:flex-row flex-wrap gap-3 mb-4">
          <input type="text" id="searchInput" class="input input-bordered search-input w-full sm:w-60" placeholder="à¸„à¹‰à¸™à¸«à¸² (à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£ / à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£)..." />
          
          <select id="branchSelector" class="select select-bordered w-full sm:w-48">
            <option value="">à¸—à¸¸à¸à¸ªà¸²à¸‚à¸²</option>
            <option value="1">à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆ 1</option>
            <option value="2">à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆ 2</option>
            <!-- à¹€à¸žà¸´à¹ˆà¸¡à¸ªà¸²à¸‚à¸²à¹€à¸­à¸‡à¸à¸£à¸“à¸µà¹„à¸¡à¹ˆà¸¡à¸µ API -->
          </select>
          
          <select id="monthSelector" class="select select-bordered w-full sm:w-36">
            <option value="">à¸—à¸¸à¸à¹€à¸”à¸·à¸­à¸™</option>
            <option value="1">à¸¡à¸à¸£à¸²à¸„à¸¡</option>
            <option value="2">à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ</option>
            <option value="3">à¸¡à¸µà¸™à¸²à¸„à¸¡</option>
            <option value="4">à¹€à¸¡à¸©à¸²à¸¢à¸™</option>
            <option value="5">à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡</option>
            <option value="6">à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™</option>
            <option value="7">à¸à¸£à¸à¸Žà¸²à¸„à¸¡</option>
            <option value="8">à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡</option>
            <option value="9">à¸à¸±à¸™à¸¢à¸²à¸¢à¸™</option>
            <option value="10">à¸•à¸¸à¸¥à¸²à¸„à¸¡</option>
            <option value="11">à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™</option>
            <option value="12">à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡</option>
          </select>
          
          <select id="yearSelector" class="select select-bordered w-full sm:w-32">
            <option value="">à¸—à¸¸à¸à¸›à¸µ</option>
            <!-- à¸ˆà¸°à¸–à¸¹à¸à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸”à¸¢ JavaScript -->
          </select>
          
          <button id="btnSearch" class="btn btn-primary flex items-center gap-1 w-full sm:w-auto">
            <i class="bi bi-search"></i><span>à¸„à¹‰à¸™à¸«à¸²</span>
          </button>
          
          <button id="btnAddCustomer" class="btn btn-secondary flex items-center gap-1 ml-auto w-full sm:w-auto">
            <i class="bi bi-plus-circle"></i><span>à¹€à¸žà¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ</span>
          </button>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border dark:border-gray-700 shadow-sm">
          <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¸¹à¸à¸„à¹‰à¸² (à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°)</h3>
            <div class="flex items-center">
              <span class="text-sm text-gray-500 dark:text-gray-400 mr-2" id="customerCounter">0 à¸£à¸²à¸¢à¸à¸²à¸£</span>
              <button id="btnExportExcel" class="btn btn-sm btn-secondary flex items-center gap-1">
                <i class="bi bi-file-earmark-excel"></i><span class="hidden sm:inline">Excel</span>
              </button>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="table w-full table-zebra enhanced-table">
              <thead>
                <tr>
                  <th class="text-center">#</th>
                  <th>à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µ</th>
                  <th>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²</th>
                  <th>à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸ªà¸±à¸à¸à¸²</th>
                  <th>à¸ªà¸´à¸™à¸„à¹‰à¸²</th>
                  <th>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™</th>
                  <th>à¸ªà¸–à¸²à¸™à¸°</th>
                  <th>à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡</th>
                  <th>à¸ªà¸²à¸‚à¸²</th>
                  <th class="text-center">à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</th>
                </tr>
              </thead>
              <tbody id="customerTableBody"></tbody>
            </table>
            <div id="pager" class="mt-4 mb-2 flex justify-center items-center gap-2"></div>
          </div>
        </div>
      </section>
    </div>
  </div>
  </div>
  
  <!-- Modal for Customer Details -->
  <div class="modal" id="customerDetailModal">
    <div class="modal-box w-11/12 max-w-3xl">
      <h3 class="font-bold text-lg mb-4">à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸¥à¸¹à¸à¸„à¹‰à¸²</h3>
      <div id="customerDetailContent" class="space-y-4">
        <!-- à¸ˆà¸°à¸–à¸¹à¸à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸”à¸¢ JavaScript -->
      </div>
      <div class="modal-action">
        <button class="btn" id="closeCustomerModal">à¸›à¸´à¸”</button>
      </div>
    </div>
  </div>

  <!-- Modal for Add New Customer -->
  <div class="modal" id="addCustomerModal">
    <div class="modal-box w-11/12 max-w-4xl">
      <h3 class="font-bold text-lg mb-4">à¹€à¸žà¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ</h3>
      <form id="addCustomerForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§ -->
          <div class="space-y-4">
            <h4 class="font-semibold text-primary">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§</h4>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸² <span class="text-red-500">*</span></span>
              </label>
              <select id="prefix" class="select select-bordered w-full" required>
                <option value="">à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸²</option>
                <option value="à¸™à¸²à¸¢">à¸™à¸²à¸¢</option>
                <option value="à¸™à¸²à¸‡">à¸™à¸²à¸‡</option>
                <option value="à¸™à¸²à¸‡à¸ªà¸²à¸§">à¸™à¸²à¸‡à¸ªà¸²à¸§</option>
              </select>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸Šà¸·à¹ˆà¸­ <span class="text-red-500">*</span></span>
              </label>
              <input type="text" id="firstName" class="input input-bordered w-full" required>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥ <span class="text-red-500">*</span></span>
              </label>
              <input type="text" id="lastName" class="input input-bordered w-full" required>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™ <span class="text-red-500">*</span></span>
              </label>
              <input type="text" id="taxId" class="input input-bordered w-full" maxlength="13" required>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ <span class="text-red-500">*</span></span>
              </label>
              <input type="tel" id="phoneNumber" class="input input-bordered w-full" required>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸§à¸±à¸™à¹€à¸à¸´à¸”</span>
              </label>
              <input type="date" id="birthDate" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸­à¸µà¹€à¸¡à¸¥</span>
              </label>
              <input type="email" id="email" class="input input-bordered w-full">
            </div>
          </div>
          
          <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¸°à¸­à¸·à¹ˆà¸™à¹† -->
          <div class="space-y-4">
            <h4 class="font-semibold text-primary">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ</h4>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸šà¹‰à¸²à¸™à¹€à¸¥à¸‚à¸—à¸µà¹ˆ</span>
              </label>
              <input type="text" id="houseNo" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸«à¸¡à¸¹à¹ˆà¸—à¸µà¹ˆ</span>
              </label>
              <input type="text" id="moo" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸•à¸³à¸šà¸¥</span>
              </label>
              <input type="text" id="subDistrict" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸­à¸³à¹€à¸ à¸­</span>
              </label>
              <input type="text" id="district" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”</span>
              </label>
              <input type="text" id="province" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ</span>
              </label>
              <input type="text" id="zipcode" class="input input-bordered w-full" maxlength="5">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸ªà¸²à¸‚à¸² <span class="text-red-500">*</span></span>
              </label>
              <select id="customerBranch" class="select select-bordered w-full" required>
                <option value="">à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²</option>
                <!-- à¸ˆà¸°à¸–à¸¹à¸à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸”à¸¢ JavaScript -->
              </select>
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">Facebook URL</span>
              </label>
              <input type="url" id="facebookUrl" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">Line ID</span>
              </label>
              <input type="text" id="lineId" class="input input-bordered w-full">
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text">à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ</span>
              </label>
              <input type="file" id="selfieImage" class="file-input file-input-bordered w-full" accept="image/*">
              <div class="label">
                <span class="label-text-alt">à¸£à¸­à¸‡à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ JPG, PNG, GIF à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2MB</span>
              </div>
              <!-- Preview area -->
              <div id="imagePreview" class="mt-2 hidden">
                <img id="previewImg" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300" alt="Preview">
                <button type="button" id="removeImage" class="btn btn-sm btn-outline mt-1">à¸¥à¸šà¸£à¸¹à¸›à¸ à¸²à¸ž</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-action">
          <button type="button" class="btn" id="closeAddCustomerModal">à¸¢à¸à¹€à¸¥à¸´à¸</button>
          <button type="submit" class="btn btn-primary" id="submitAddCustomer">
            <span class="loading loading-spinner loading-sm hidden" id="submitLoading"></span>
            <span id="submitText">à¸šà¸±à¸™à¸—à¸¶à¸</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
// Fixed syntax error - Updated 2025-08-25

// Auto login function
async function autoLogin() {
  try {
    // Auto login attempt
    // à¸¥à¸­à¸‡ login à¸”à¹‰à¸§à¸¢ user à¸•à¹ˆà¸²à¸‡à¹†
    const loginAttempts = [
      { username: 'admin', password: 'admin123' },
      { username: 'admin', password: 'password' },
      { username: 'user', password: 'password' },
    ];
    
    let loginSuccess = false;
    let res;
    
    for (const attempt of loginAttempts) {
      console.log(`ðŸ”‘ Trying login with: ${attempt.username}`);
      res = await fetch('/api/users/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(attempt)
      });
      
      const data = await res.json();
      
      if (data.success && data.token) {
        localStorage.setItem('authToken', data.token);
        console.log('âœ… Auto login successful with:', attempt.username);
        console.log('Token saved:', data.token.substring(0, 20) + '...');
        loginSuccess = true;
        break;
      }
    }
    
    if (!loginSuccess) {
      console.error('âŒ All auto login attempts failed');
      // login à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ
      console.error('Unable to authenticate');
      return false;
    }
    
    return loginSuccess;
  } catch (error) {
    console.error('âŒ Auto login error:', error);
    return false;
  }
}

// Process installment data helper
function processInstallmentData(apiResponse) {
  console.log('ðŸ”„ Processing installment data:', apiResponse);
  
  const customerMap = new Map();
  
  if (apiResponse.success && apiResponse.data) {
    console.log('ðŸ“Š Raw data items:', apiResponse.data.length);
    
    // à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²
    apiResponse.data.forEach((order, index) => {
      console.log(`ðŸ“‹ Processing order ${index + 1}:`, order);
      
      const customerKey = order.customer_info?.taxId || order.customer_info?.phone || order.customer?._id || order.customerPhone || `customer-${index}`;
      
      if (!customerMap.has(customerKey)) {
        const fullName = `${order.customer_info?.firstName || ''} ${order.customer_info?.lastName || ''}`.trim() || order.customerName || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
        
        customerMap.set(customerKey, {
          _id: order.customer?._id || customerKey,
          customerCode: order.customer?.customerCode || `CUST-${customerKey ? customerKey.slice(-6) : Date.now()}`,
          fullName: fullName,
          phone: order.customer_info?.phone || order.customerPhone,
          nationalId: order.customer_info?.taxId,
          installmentSummary: {
            totalOrders: 0,
            activeOrders: 0,
            completedOrders: 0,
            overdueOrders: 0,
            totalDebt: 0,
            monthlyPayment: 0
          },
          orders: []
        });
      }
      
      const customer = customerMap.get(customerKey);
      customer.orders.push(order);
      customer.installmentSummary.totalOrders++;
      
      if (order.status === 'active') {
        customer.installmentSummary.activeOrders++;
        customer.installmentSummary.totalDebt += order.remainingAmount || 0;
        customer.installmentSummary.monthlyPayment += order.installmentAmount || 0;
      } else if (order.status === 'completed') {
        customer.installmentSummary.completedOrders++;
      } else if (order.status === 'overdue') {
        customer.installmentSummary.overdueOrders++;
        customer.installmentSummary.totalDebt += order.remainingAmount || 0;
      }
    });
  }
  
  const result = {
    success: true,
    data: Array.from(customerMap.values()),
    pagination: apiResponse.pagination || {
      currentPage: 1,
      totalPages: 1,
      totalItems: customerMap.size
    }
  };
  
  console.log('âœ… Processed customers:', result.data.length);
  console.log('ðŸ” First processed customer:', result.data[0]);
  
  return result;
}

// 1. helper normalize URL
 function getImageUrl(pathInDb) {
  console.log('ðŸ–¼ï¸ Processing image URL:', pathInDb);
  
  if (!pathInDb || pathInDb.trim() === '') {
    console.log('âŒ No image path provided');
    return '';               // à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸¹à¸›
  }
  
  // à¸¥à¸š whitespace
  pathInDb = pathInDb.trim();
  
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¹à¸„à¹ˆà¸•à¸±à¸§à¹€à¸¥à¸‚ (à¹€à¸Šà¹ˆà¸™ "1941001330610") à¸‹à¸¶à¹ˆà¸‡à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ path à¸£à¸¹à¸›à¸ à¸²à¸žà¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
  if (/^\d+$/.test(pathInDb)) {
    console.log('âŒ Invalid image path (numbers only):', pathInDb);
    return '';
  }
  
  if (pathInDb.startsWith('http://') || pathInDb.startsWith('https://')) {
    console.log('âœ… Full URL found:', pathInDb);
    return pathInDb;        // à¸à¸£à¸“à¸µà¹€à¸›à¹‡à¸™ URL à¹€à¸•à¹‡à¸¡
  }
  
  if (pathInDb.startsWith('data:')) {
    console.log('âœ… Data URL found');
    return pathInDb;        // à¸à¸£à¸“à¸µà¹€à¸›à¹‡à¸™ base64 data URL
  }
  
  if (pathInDb.startsWith('/uploads/')) {
    console.log('âœ… Uploads path found:', pathInDb);
    return pathInDb;                      // à¸„à¸·à¸™à¸•à¸£à¸‡à¹†
  }
  
  if (pathInDb.startsWith('/static/')) {
    console.log('âœ… Static path found:', pathInDb);
    return pathInDb;                      // à¸„à¸·à¸™à¸•à¸£à¸‡à¹†
  }
  
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸žà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
  const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
  const hasImageExtension = imageExtensions.some(ext => pathInDb.toLowerCase().includes(ext));
  
  if (!hasImageExtension) {
    console.log('âŒ No image extension found in path:', pathInDb);
    return '';
  }
  
  // à¸à¸£à¸“à¸µà¹€à¸à¹‡à¸šà¹à¸šà¸š 'uploads/selfies/...' à¸«à¸£à¸·à¸­ 'selfies/...'
  if (pathInDb.startsWith('uploads/')) {
    const finalUrl = '/' + pathInDb;
    console.log('âœ… Fixed uploads path:', finalUrl);
    return finalUrl;
  }
  
  // à¹à¸à¹‰à¹„à¸‚ path à¸—à¸µà¹ˆà¸œà¸´à¸”à¸£à¸¹à¸›à¹à¸šà¸š
  let fixedPath = pathInDb.replace(/^.*uploads[\\/]/, "");
  fixedPath = fixedPath.replace(/\\/g, "/");
  
  const finalUrl = `/uploads/${fixedPath}`;
  console.log('âœ… Constructed URL:', finalUrl);
  return finalUrl;
}

let allCustomers = [];      // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
let currentPage = 1;        // à¸«à¸™à¹‰à¸²à¹à¸£à¸
const pageSize = 10;        // à¹à¸ªà¸”à¸‡ 10 à¸£à¸²à¸¢à¸à¸²à¸£à¸•à¹ˆà¸­à¸«à¸™à¹‰à¸²
let branches = [];          // à¹€à¸à¹‡à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸²à¸‚à¸²

// Global functions that need to be accessible outside DOMContentLoaded
// Consolidated render function - replaces renderCustomersWithFullData, renderCustomers, and enhancedPopulateTable
function renderCustomers(customers, usesPagination = false) {
  console.log('ðŸŽ¨ Rendering customers:', customers);
  
  const tbody = document.getElementById("customerTableBody");
  if (!tbody) {
    console.error('customerTableBody element not found');
    return;
  }
  
  tbody.innerHTML = "";

  if (!customers || customers.length === 0) {
    console.log('âš ï¸ No customers to display');
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-8 text-gray-500">
          <i class="bi bi-inbox text-4xl mb-2"></i>
          <p>à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²</p>
        </td>
      </tr>
    `;
    return;
  }

  // Handle pagination if needed
  let displayCustomers = customers;
  if (usesPagination) {
    const start = (currentPage - 1) * pageSize;
    displayCustomers = customers.slice(start, start + pageSize);
  }

  console.log('ðŸ‘¥ Customers to display:', displayCustomers.length);

  // Set global variable for button handlers
  window.allCustomers = customers;
  allCustomers = customers;

  // Generate table rows
  displayCustomers.forEach((customer, index) => {
    const actualIndex = usesPagination ? (currentPage - 1) * pageSize + index : index;
    console.log(`ðŸ”§ Generating row ${actualIndex + 1} for customer:`, customer.fullName);
    const rowHTML = generateCustomerTableRow(customer, actualIndex);
    tbody.innerHTML += rowHTML;
  });

  console.log('âœ… Table rendered successfully');

  // Update summary
  const summaryElement = document.getElementById('customerCounter');
  if (summaryElement) {
    summaryElement.textContent = `${customers.length} à¸£à¸²à¸¢à¸à¸²à¸£`;
    console.log('ðŸ“Š Updated counter to:', customers.length);
  }
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸£à¹‰à¸²à¸‡à¹à¸–à¸§à¸•à¸²à¸£à¸²à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²
function generateCustomerTableRow(customer, index) {
  console.log(`ðŸ—ï¸ Building row for customer ${index + 1}:`, customer);
  
  const installmentSummary = customer.installmentSummary || {};
  const firstOrder = customer.orders && customer.orders.length > 0 ? customer.orders[0] : {};
  const customerInfo = firstOrder.customer_info || {};
  
  console.log('ðŸ“Š Row data sources:', {
    installmentSummary,
    firstOrder: firstOrder,
    customerInfo
  });
  
  // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡
  const selfieUrl = customer.selfieUrl || customerInfo.selfieImage || firstOrder.selfieUrl;
  const fullName = customer.fullName || `${customerInfo.firstName || ''} ${customerInfo.lastName || ''}`.trim() || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
  const phone = customer.phone || customerInfo.phone || firstOrder.customerPhone || '-';
  const contractNo = firstOrder.contractNo || firstOrder.contract_no || '-';
  
  // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²
  const items = firstOrder.items || [];
  const productInfo = items.length > 0 ? items[0] : {};
  const productName = productInfo.name || productInfo.productName || firstOrder.productName || '-';
  
  // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™
  const totalDebt = installmentSummary.totalDebt || firstOrder.remainingAmount || 0;
  const monthlyPayment = installmentSummary.monthlyPayment || firstOrder.installmentAmount || 0;
  
  // à¸ªà¸–à¸²à¸™à¸°
  const status = firstOrder.status || 'active';
  const statusBadge = getStatusBadge(installmentSummary.overdueOrders > 0 ? 'overdue' : 
                                     installmentSummary.activeOrders > 0 ? 'active' : 'normal');
  
  // à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡
  const createdDate = firstOrder.createdAt ? formatDate(firstOrder.createdAt) : '-';
  
  // à¸ªà¸²à¸‚à¸²
  const branchInfo = firstOrder.branch_name || firstOrder.branchName || firstOrder.branch_code || firstOrder.branchCode || '-';
  
  console.log('ðŸ“‹ Extracted data for row:', {
    fullName,
    phone,
    contractNo,
    productName,
    totalDebt,
    monthlyPayment,
    status,
    createdDate,
    branchInfo
  });
  
  return `
    <tr class="hover:bg-gray-50 transition-colors">
      <td class="text-center">${index + 1}</td>
      <td class="text-center">
        ${selfieUrl ? 
          `<div class="avatar">
             <div class="w-8 h-8 rounded">
               <img src="${getImageUrl(selfieUrl)}" alt="à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ" class="object-cover" onerror="this.parentElement.innerHTML='<div class=\\"w-8 h-8 rounded bg-gray-200 flex items-center justify-center\\"><i class=\\"bi bi-person text-gray-400\\"></i></div>'">
             </div>
           </div>` :
          '<div class="w-8 h-8 rounded bg-gray-200 flex items-center justify-center mx-auto"><i class="bi bi-person text-gray-400"></i></div>'
        }
      </td>
      <td>
        <div>
          <div class="font-medium">${fullName}</div>
          <div class="text-sm text-gray-500">${phone}</div>
          <div class="text-xs text-gray-400">${customer.nationalId || customerInfo.taxId || '-'}</div>
        </div>
      </td>
      <td>
        <span class="font-mono text-sm">${contractNo}</span>
      </td>
      <td>
        <div class="text-sm">${productName}</div>
        ${productInfo.imei ? `<div class="text-xs text-gray-500">IMEI: ${productInfo.imei}</div>` : ''}
      </td>
      <td>
        <div class="text-right">
          <div class="font-medium text-red-600">${formatCurrency(totalDebt)}</div>
          <div class="text-sm text-gray-500">${formatCurrency(monthlyPayment)}/à¹€à¸”à¸·à¸­à¸™</div>
        </div>
      </td>
      <td class="text-center">${statusBadge}</td>
      <td class="text-center text-sm">${createdDate}</td>
      <td class="text-center text-sm">${branchInfo}</td>
      <td class="text-center">
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost btn-sm">
            <i class="bi bi-three-dots-vertical"></i>
          </label>
          <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
            <li><a onclick="viewCustomerDetail('${customer._id}')"><i class="bi bi-eye"></i> à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”</a></li>
            <li><a onclick="editCustomer('${customer._id}')"><i class="bi bi-pencil"></i> à¹à¸à¹‰à¹„à¸‚</a></li>
            <li><a onclick="viewInstallmentHistory('${customer._id}')"><i class="bi bi-clock-history"></i> à¸›à¸£à¸°à¸§à¸±à¸•à¸´</a></li>
          </ul>
        </div>
      </td>
    </tr>
  `;
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸ªà¸–à¸²à¸™à¸°
function getStatusBadge(status) {
  const badges = {
    'overdue': '<span class="badge badge-error badge-sm">à¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸°</span>',
    'active': '<span class="badge badge-warning badge-sm">à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°</span>',
    'normal': '<span class="badge badge-success badge-sm">à¸›à¸à¸•à¸´</span>'
  };
  return badges[status] || badges.normal;
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸•à¸±à¸§à¹€à¸¥à¸‚
function formatCurrency(amount) {
  return new Intl.NumberFormat('th-TH', {
    style: 'currency',
    currency: 'THB',
    minimumFractionDigits: 0
  }).format(amount || 0);
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸£à¹‰à¸²à¸‡ modal content à¹à¸¢à¸à¸­à¸­à¸à¸¡à¸²à¹€à¸žà¸·à¹ˆà¸­à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡ syntax error
function createCustomerModalContent(customer, customerInfo, firstOrder, data) {
  // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¸ à¸²à¸ž
  const findImage = (searchTerms) => {
    const deepSearch = (obj, terms) => {
      if (!obj || typeof obj !== 'object') return null;
      
      for (const term of terms) {
        if (obj[term] && typeof obj[term] === 'string' && obj[term].trim() !== '') {
          return obj[term];
        }
      }
      
      for (const [key, value] of Object.entries(obj)) {
        if (typeof value === 'object' && value !== null) {
          const found = deepSearch(value, terms);
          if (found) return found;
        }
      }
      
      return null;
    };
    
    let imageUrl = deepSearch(customer, searchTerms) ||
                   deepSearch(customerInfo, searchTerms) ||
                   deepSearch(firstOrder, searchTerms);
    
    if (!imageUrl) {
      const allObjects = [customer, customerInfo, firstOrder];
      for (const obj of allObjects) {
        if (!obj) continue;
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === 'string' && value.trim() !== '' && 
              searchTerms.some(term => key.toLowerCase().includes(term.toLowerCase()))) {
            imageUrl = value;
            console.log('âœ… Found image in field:', key, '=', value);
            break;
          }
        }
        if (imageUrl) break;
      }
    }
    
    return imageUrl;
  };

  // à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¸ à¸²à¸ž
  const selfieUrl = findImage(['selfieImage', 'selfieUrl', 'selfie']);
  const idCardUrl = findImage(['idCardImage', 'idCardImageUrl', 'idCard', 'nationalIdImage']);
  const salaryUrl = findImage(['salarySlipImage', 'salarySlipUrl', 'salarySlip', 'paySlip']);
  const signatureUrl = findImage(['signatureImage', 'customerSignatureUrl', 'signature']);

  console.log('ðŸ–¼ï¸ Found images:', { selfieUrl, idCardUrl, salaryUrl, signatureUrl });

  // à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸¹à¸›à¸ à¸²à¸ž
  const createImageHtml = (imageUrl, altText) => {
    if (!imageUrl) {
      return `<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center">
                <i class="bi bi-image text-gray-400"></i>
              </div>`;
    }
    
    const processedUrl = getImageUrl(imageUrl);
    return `<img src="${processedUrl}" class="w-20 h-20 object-cover rounded border mx-auto cursor-pointer hover:opacity-75" 
                 alt="${altText}" onclick="window.open('${processedUrl}', '_blank')" 
                 onerror="console.log('Image load error:', this.src); this.parentElement.innerHTML='<div class=\\"w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center\\"><i class=\\"bi bi-image text-gray-400\\"></i></div>'">`;
  };

  return `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸² -->
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
        <h4 class="font-semibold text-lg mb-3 text-blue-600 dark:text-blue-400">
          ðŸ‘¤ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
        </h4>
        <div class="space-y-2 text-sm">
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥:</span>
            <span class="col-span-2">${data.fullName}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£:</span>
            <span class="col-span-2">${customer.phone || customerInfo.phone || '-'}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸­à¸µà¹€à¸¡à¸¥:</span>
            <span class="col-span-2">${customerInfo.email || '-'}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™:</span>
            <span class="col-span-2">${customer.nationalId || customerInfo.taxId || '-'}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸ªà¸²à¸‚à¸²:</span>
            <span class="col-span-2">${data.branchName}</span>
          </div>
        </div>
      </div>

      <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸² -->
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
        <h4 class="font-semibold text-lg mb-3 text-green-600 dark:text-green-400">
          ðŸ“‹ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸²
        </h4>
        <div class="space-y-2 text-sm">
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¹€à¸¥à¸‚à¸ªà¸±à¸à¸à¸²:</span>
            <span class="col-span-2">${data.contractNo}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸ªà¸–à¸²à¸™à¸°:</span>
            <span class="col-span-2">${data.status}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™à¸£à¸§à¸¡:</span>
            <span class="col-span-2">${formatCurrency(data.totalAmount)}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸„à¹ˆà¸²à¸‡à¸§à¸”/à¹€à¸”à¸·à¸­à¸™:</span>
            <span class="col-span-2">${formatCurrency(data.monthlyPayment)}</span>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <span class="font-medium">à¸¢à¸­à¸”à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­:</span>
            <span class="col-span-2 text-red-600 font-medium">${formatCurrency(data.remainingAmount)}</span>
          </div>
        </div>
      </div>

      <!-- à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸™à¸š -->
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border lg:col-span-2">
        <h4 class="font-semibold text-lg mb-3 text-rose-600 dark:text-rose-400">
          ðŸ“Ž à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸™à¸š
        </h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-sm font-medium mb-2">à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ</div>
            ${createImageHtml(selfieUrl, 'à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ')}
          </div>
          <div class="text-center">
            <div class="text-sm font-medium mb-2">à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™</div>
            ${createImageHtml(idCardUrl, 'à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™')}
          </div>
          <div class="text-center">
            <div class="text-sm font-medium mb-2">à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™</div>
            ${createImageHtml(salaryUrl, 'à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™')}
          </div>
          <div class="text-center">
            <div class="text-sm font-medium mb-2">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</div>
            ${createImageHtml(signatureUrl, 'à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™')}
          </div>
        </div>
      </div>

      <!-- à¸›à¸¸à¹ˆà¸¡à¸ˆà¸±à¸”à¸à¸²à¸£ -->
      <div class="lg:col-span-2 flex flex-wrap gap-2 justify-end">
        <button class="btn btn-sm btn-secondary" onclick="generateContract('${customer._id}')">
          <i class="bi bi-file-pdf"></i> à¸ªà¸£à¹‰à¸²à¸‡ PDF
        </button>
        <button class="btn btn-sm btn-info" onclick="editCustomer('${customer._id}')">
          <i class="bi bi-pencil"></i> à¹à¸à¹‰à¹„à¸‚
        </button>
        <button class="btn btn-sm btn-warning" onclick="viewInstallmentHistory('${customer._id}')">
          <i class="bi bi-clock-history"></i> à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸Šà¸³à¸£à¸°
        </button>
      </div>
    </div>
  `;
}

// Wrap authentication and initialization in DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Note: Sidebar toggle is handled by loan-sidebar.js

    // Note: Dark mode toggle is handled by loan-sidebar.js

    // Authentication & headers
    const authToken = localStorage.getItem('authToken');
    
    if (!authToken) {
      console.error('No authentication token found');
      alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™');
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login';
      return;
    }
    const headers   = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + authToken
    };

    // Initialize the page
    initializePage();
    
    function initializePage() {
        // à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ updateDateDisplay à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
        updateDateDisplay();
        setInterval(updateDateDisplay, 60000); // à¸­à¸±à¸žà¹€à¸”à¸—à¸—à¸¸à¸à¸™à¸²à¸—à¸µ
        
        // Initialize loan sidebar first
        if (typeof initializeLoanSidebar === 'function') {
          initializeLoanSidebar();
        }
        
        // à¹€à¸•à¸´à¸¡à¸›à¸µà¹ƒà¸™ selector
        const yearSelector = document.getElementById('yearSelector');
        if (yearSelector) {
          const currentYear = new Date().getFullYear();
          for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + 543; // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ à¸ž.à¸¨.
            if (year === currentYear) option.selected = true;
            yearSelector.appendChild(option);
          }
        }
        
        // Setup event listeners
        setupEventListeners();
        
        // Load data
        fetchBranches();
        loadInstallmentCustomers();
        
        // à¸—à¸³à¹ƒà¸«à¹‰à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸›à¹‡à¸™ global à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹ƒà¸™ onclick
        window.viewCustomerDetail = viewCustomerDetail;
        window.getImageUrl = getImageUrl;
        window.calculateAge = calculateAge;
    }

    // à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ updateDateDisplay à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
    function updateDateDisplay() {
      const now = new Date();
      
      // à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
      const thaiMonths = [
        'à¸¡à¸à¸£à¸²à¸„à¸¡', 'à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ', 'à¸¡à¸µà¸™à¸²à¸„à¸¡', 'à¹€à¸¡à¸©à¸²à¸¢à¸™',
        'à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡', 'à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™', 'à¸à¸£à¸à¸Žà¸²à¸„à¸¡', 'à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡',
        'à¸à¸±à¸™à¸¢à¸²à¸¢à¸™', 'à¸•à¸¸à¸¥à¸²à¸„à¸¡', 'à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™', 'à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡'
      ];
      
      // à¸§à¸±à¸™à¸—à¸µà¹ˆ à¹€à¸”à¸·à¸­à¸™ à¸›à¸µ à¸ž.à¸¨.
      const day = now.getDate();
      const month = thaiMonths[now.getMonth()];
      const year = now.getFullYear() + 543; // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ à¸ž.à¸¨.
      
      // à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸§à¸±à¸™à¸—à¸µà¹ˆà¹à¸šà¸šà¹„à¸—à¸¢
      const formattedDate = `${day} ${month} ${year}`;
      
      // à¹à¸ªà¸”à¸‡à¸œà¸¥à¹ƒà¸™à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
      document.getElementById('dateDisplay').textContent = formattedDate;
    }

    // Note: Employee profile loading is handled by loan-sidebar.js

    // à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸²à¸‚à¸² - à¸›à¸£à¸±à¸šà¹ƒà¸«à¹‰à¹„à¸¡à¹ˆà¸¥à¹‰à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸ˆà¸­ 404
    async function fetchBranches() {
      try {
        console.log('ðŸ”„ Loading branches...');
        
        // à¹ƒà¸Šà¹‰ API à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: /api/branch (à¹„à¸¡à¹ˆà¸¡à¸µ s)
        const res = await fetch('/api/branch', { headers });
        
        // à¸–à¹‰à¸² API à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸›à¸à¸•à¸´
        if (res.ok) {
          const contentType = res.headers.get('content-type');
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ JSON à¸ˆà¸£à¸´à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
          if (contentType && contentType.includes('application/json')) {
            const json = await res.json();
            
            if (json.success && json.data) {
            branches = json.data || [];
            
            // à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¹ƒà¸™ dropdown
            const branchSelector = document.getElementById('branchSelector');
            // à¸¥à¹‰à¸²à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¹€à¸”à¸´à¸¡ à¹à¸•à¹ˆà¹€à¸à¹‡à¸šà¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ "à¸—à¸¸à¸à¸ªà¸²à¸‚à¸²"
            while (branchSelector.options.length > 1) {
              branchSelector.remove(1);
            }
            
            branches.forEach(branch => {
              const option = document.createElement('option');
                option.value = branch._id || branch.branch_code;
                option.textContent = branch.name || branch.branch_code;
              branchSelector.appendChild(option);
            });
              
              console.log('âœ… Loaded', branches.length, 'branches');
            } else {
              console.warn('âŒ Branch API response not successful:', json.error || json.message);
              throw new Error('API response not successful');
            }
          } else {
            // à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ JSON à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸­à¸°à¹„à¸£ à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
            console.log('âŒ Branch API responded but not with JSON');
            throw new Error('API response not JSON');
          }
        } else {
          // API à¹„à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ - à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
          console.warn('âŒ Branch API error:', res.status, res.statusText);
          throw new Error(`API Error: ${res.status}`);
        }
      } catch (err) {
        console.warn('âŒ Fetch branches failed, using fallback:', err.message);
        
        // à¹ƒà¸Šà¹‰ fallback branches
        branches = [
          { _id: 'PATTANI', name: 'à¸ªà¸²à¸‚à¸²à¸›à¸±à¸•à¸•à¸²à¸™à¸µ', branch_code: 'PATTANI' },
          { _id: 'YALA', name: 'à¸ªà¸²à¸‚à¸²à¸¢à¸°à¸¥à¸²', branch_code: 'YALA' },
          { _id: 'NARATHIWAT', name: 'à¸ªà¸²à¸‚à¸²à¸™à¸£à¸²à¸˜à¸´à¸§à¸²à¸ª', branch_code: 'NARATHIWAT' },
          { _id: 'MAIN', name: 'à¸ªà¸²à¸‚à¸²à¸«à¸¥à¸±à¸', branch_code: 'MAIN' }
        ];
        
        const branchSelector = document.getElementById('branchSelector');
        // à¸¥à¹‰à¸²à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¹€à¸”à¸´à¸¡ à¹à¸•à¹ˆà¹€à¸à¹‡à¸šà¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ "à¸—à¸¸à¸à¸ªà¸²à¸‚à¸²"
        while (branchSelector.options.length > 1) {
          branchSelector.remove(1);
        }
        
        branches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch._id;
          option.textContent = branch.name;
          branchSelector.appendChild(option);
        });
        
        console.log('ðŸ“‹ Using fallback branches:', branches.length);
      }
    }

    // à¸­à¹ˆà¸²à¸™à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ ?id=...
  function getCustomerIdFromUrl() {
    return new URLSearchParams(window.location.search).get('id');
  }

  // à¹€à¸£à¸µà¸¢à¸ API à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
  async function loadCustomerDetail() {
    const id = getCustomerIdFromUrl();
    if (!id) return alert('à¹„à¸¡à¹ˆà¸žà¸šà¸£à¸«à¸±à¸ªà¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸™ URL');
    try {
      const res = await fetch(`/api/customers/${id}`, { headers });
      if (!res.ok) throw new Error('Response '+res.status);
      const js = await res.json();
      if (!js.success) throw new Error(js.error||'Unknown error');

      const c = js.data;
      // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸™à¸«à¸™à¹‰à¸²
      document.getElementById('custName').textContent    = `${c.first_name} ${c.last_name}`;
      document.getElementById('custPhone').textContent   = c.phone_number || '-';
      document.getElementById('custEmail').textContent   = c.email || '-';
      document.getElementById('custTaxId').textContent   = c.tax_id || '-';
      // à¸£à¸§à¸šà¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹€à¸›à¹‡à¸™à¸ªà¸•à¸£à¸´à¸‡à¹€à¸”à¸µà¸¢à¸§
      const a = c.address || {};
      document.getElementById('custAddress').textContent =
        [a.houseNo, a.moo&&'à¸«à¸¡à¸¹à¹ˆ'+a.moo, a.subDistrict&&'à¸•.'+a.subDistrict,
         a.district&&'à¸­.'+a.district, a.province&&'à¸ˆ.'+a.province, a.zipcode]
         .filter(Boolean).join(' ') || '-';

      // à¸–à¹‰à¸²à¸­à¸¢à¸²à¸à¹‚à¸Šà¸§à¹Œà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸±à¸à¸à¸²à¸œà¹ˆà¸­à¸™ à¸à¹‡à¹€à¸£à¸µà¸¢à¸ API à¹€à¸žà¸´à¹ˆà¸¡ à¸«à¸£à¸·à¸­à¸‚à¸¢à¸²à¸¢ endpoint à¸‚à¹‰à¸²à¸‡à¸šà¸™à¹ƒà¸«à¹‰ return js.data.installmentOrders
      renderInstallmentOrders(js.data.installmentOrders || []);

    } catch (e) {
      console.error('Error in loadCustomers:', e);
      showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²: ' + e.message, 'error');
    }
  }

  // à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ render à¸£à¸²à¸¢à¸à¸²à¸£à¸œà¹ˆà¸­à¸™ à¸–à¹‰à¸²à¸¡à¸µ
  function renderInstallmentOrders(orders) {
    const ul = document.getElementById('installmentList');
    if (!ul) {
      console.error('installmentList element not found');
      return;
    }
    ul.innerHTML = orders.length
      ? orders.map(o=>`<li>${o.contractNo} â€” ${o.status}</li>`).join('')
      : '<li>à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸œà¹ˆà¸­à¸™</li>';
  }



    async function deleteCustomer(id,name) {
      if (!confirm(`à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²: ${name} ?`)) return;
      try {
        const res = await fetch(`/api/customers/${id}`, {
          method: 'DELETE',
          headers
        });
        if (res.status === 401) return window.location.href = 'login.html';
        if (!res.ok) throw new Error(await res.text());
        alert("à¸¥à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢");
        fetchAllCustomers();
      } catch (e) {
        console.error("Delete error:", e);
        alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: "+e.message);
      }
    }



    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸±à¸žà¹€à¸”à¸— pagination
    function updatePagination(pagination) {
      if (!pagination) return;
      
      currentPage = pagination.currentPage;
      totalPages = pagination.totalPages;
      
      // à¸­à¸±à¸žà¹€à¸”à¸— UI pagination
      const pageInfo = document.getElementById('pageInfo');
      if (pageInfo) {
        pageInfo.textContent = `à¸«à¸™à¹‰à¸² ${currentPage} à¸ˆà¸²à¸ ${totalPages}`;
      }
      
      // à¸­à¸±à¸žà¹€à¸”à¸—à¸›à¸¸à¹ˆà¸¡ prev/next
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }

    // Remove this duplicate function - using consolidated renderCustomers function above

    // à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸£à¹‰à¸²à¸‡ PDF à¸ªà¸±à¸à¸à¸²
    window.generateContract = async function(customerId) {
      try {
        const customer = allCustomers.find(c => c._id === customerId);
        if (!customer) {
          alert('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²');
          return;
        }

        showToast('à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸±à¸à¸à¸² PDF...', 'info');
        
        const response = await fetch(`/api/installment/${customerId}/generate-contract`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `à¸ªà¸±à¸à¸à¸²_${customer.contractNo || customerId}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          showToast('à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸ªà¸±à¸à¸à¸² PDF à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
        } else {
          throw new Error('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¹‰à¸²à¸‡ PDF à¹„à¸”à¹‰');
        }
      } catch (error) {
        console.error('Error generating contract:', error);
        showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ PDF', 'error');
      }
    };

    function renderPagination() {
      const totalPages = Math.ceil(allCustomers.length / pageSize);
      const pager = document.getElementById('pager');
      pager.innerHTML = '';
      
      // à¸›à¸¸à¹ˆà¸¡à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn btn-sm';
      prevBtn.textContent = 'â€¹ à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderCustomers(allCustomers);
        }
      };
      pager.appendChild(prevBtn);
      
      // à¹à¸ªà¸”à¸‡à¹€à¸¥à¸‚à¸«à¸™à¹‰à¸²
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => {
            currentPage = i;
            renderCustomers(allCustomers);
          };
          pager.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.className = 'mx-2';
          pager.appendChild(dots);
        }
      }
      
      // à¸›à¸¸à¹ˆà¸¡à¸–à¸±à¸”à¹„à¸›
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn btn-sm';
      nextBtn.textContent = 'à¸–à¸±à¸”à¹„à¸› â€º';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderCustomers(allCustomers);
        }
      };
      pager.appendChild(nextBtn);
    }

    async function fetchAllCustomers() {
      try {
        const branchId = document.getElementById('branchSelector').value;
        const month = document.getElementById('monthSelector').value;
        const year = document.getElementById('yearSelector').value;
        
        // à¹ƒà¸Šà¹‰ API installment à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸œà¹ˆà¸­à¸™à¹€à¸‰à¸žà¸²à¸°
        let url = '/api/installment/customers';
        
        // à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸à¸£à¸­à¸‡à¸•à¸²à¸¡à¸ªà¸²à¸‚à¸²
        if (branchId) {
          url += `?branch=${branchId}`;
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸à¸£à¸­à¸‡à¸•à¸²à¸¡à¹€à¸”à¸·à¸­à¸™
        if (month) {
          url += branchId ? `&month=${month}` : `?month=${month}`;
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸à¸£à¸­à¸‡à¸•à¸²à¸¡à¸›à¸µ
        if (year) {
          url += (branchId || month) ? `&year=${year}` : `?year=${year}`;
        }
        
        console.log('ðŸ”„ Fetching installment customers from:', url);
        
        const res = await fetch(url, {
          headers
        });
        if (res.status === 401) return window.location.href = 'login.html';
        
        const responseData = await res.json();
        // Received installment customers data
        
        allCustomers = responseData.data || [];
        renderCustomers(allCustomers);
      } catch (err) {
        console.error('Fetch installment customers failed:', err);
        showToast('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸œà¹ˆà¸­à¸™à¹„à¸”à¹‰', 'error');
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¹‰à¸™à¸«à¸²
    async function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const branch = document.getElementById('branchSelector').value;
      const month = document.getElementById('monthSelector').value;
      const year = document.getElementById('yearSelector').value;
      
      if (!searchTerm && !branch && !month && !year) {
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ à¹à¸ªà¸”à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        await loadInstallmentCustomers();
        return;
      }
      
      try {
        // Performing search
        
        // à¹ƒà¸Šà¹‰ API à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²
        let url = '/api/loan/installment/history?';
        const params = new URLSearchParams();
        
        // à¸›à¸£à¸±à¸š parameters à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š backend
        if (searchTerm) params.append('customerName', searchTerm);
        if (branch) params.append('branchCode', branch);
        if (month && year) {
          // à¸ªà¸£à¹‰à¸²à¸‡ date range à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸”à¸·à¸­à¸™/à¸›à¸µà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 0);
          params.append('startDate', startDate.toISOString().split('T')[0]);
          params.append('endDate', endDate.toISOString().split('T')[0]);
        }
        
        const response = await fetch(url + params.toString(), { headers });
        
        if (!response.ok) {
          throw new Error(`Search API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.data) {
          // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ history à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸š customers
          allCustomers = data.data.map(order => ({
            _id: order._id || order.contractId,
            customerName: order.customer_info ?
              `${order.customer_info.firstName || ''} ${order.customer_info.lastName || ''}`.trim() : '-',
            firstName: order.customer_info?.firstName || '',
            lastName: order.customer_info?.lastName || '',
            phone: order.customer_info?.phone || '-',
            phone_number: order.customer_info?.phone || '-',
            taxId: order.customer_info?.taxId || '-',
            tax_id: order.customer_info?.taxId || '-',
            branchName: order.branchName || order.branch_code || '-',
            branch_name: order.branchName || order.branch_code || '-',
            totalAmount: Math.max(0, order.totalAmount || order.installmentAmount || 0),
            monthlyPayment: Math.max(0, order.monthlyPayment || order.monthlyAmount || 0),
            overdueAmount: Math.max(0, order.overdueAmount || 0),
            status: order.status || 'active',
            contractNo: order.contractNo || order.contractId || '-',
            startDate: order.startDate || order.createdAt || order.created_at,
            remainingAmount: Math.max(0, order.remainingAmount || order.totalAmount || 0),
            age: order.customer_info?.age || '-',
            birth_date: order.customer_info?.birthDate || null,
            email: order.customer_info?.email || '-',
            prefix: order.customer_info?.prefix || '-',
            address: order.customer_info?.address || {},
            facebook_url: order.customer_info?.facebook_url || null,
            line_id: order.customer_info?.line_id || null,
            selfie_url: order.customer_info?.selfie_url || null
          }));

          currentPage = 1;
          // Search completed
          renderCustomers(allCustomers);
        } else {
          console.warn('âŒ Search API response not successful:', data.error || data.message);
          allCustomers = [];
          renderCustomers(allCustomers);
        }
      } catch (error) {
        console.error('âŒ Search error:', error);
        
        // à¹à¸ªà¸”à¸‡ error à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
        alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸² à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡');
        
        // à¸à¸¥à¸±à¸šà¹„à¸›à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        await loadInstallmentCustomers();
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸™ modal
    function showCustomerDetailModal(customer) {
      try {
        // Showing customer detail modal
        console.log('ðŸ” Customer data structure:', customer); // Debug log to see available data
        
        // Handle different data structures - check if this is already a processed customer or raw order data
        const orders = customer.orders || [customer]; // If no orders array, treat customer as the order itself
        const firstOrder = orders.length > 0 ? orders[0] : customer;
        console.log('ðŸ” Orders array:', orders);
        console.log('ðŸ” First order data:', firstOrder);
        
        // à¹€à¸žà¸´à¹ˆà¸¡ debugging à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸¹à¸›à¸ à¸²à¸ž
        console.log('ðŸ–¼ï¸ Image debugging - Customer level:');
        console.log('  - customer.selfieUrl:', customer.selfieUrl);
        console.log('  - customer.selfieImage:', customer.selfieImage);
        console.log('  - customer.idCardImageUrl:', customer.idCardImageUrl);
        console.log('  - customer.idCardImage:', customer.idCardImage);
        console.log('  - customer.images:', customer.images);
        console.log('  - customer.attachments:', customer.attachments);
        console.log('  - customer.documents:', customer.documents);
        
        const customerInfo = firstOrder.customer_info || {};
        console.log('ðŸ–¼ï¸ CustomerInfo level:');
        console.log('  - customerInfo.selfieImage:', customerInfo.selfieImage);
        console.log('  - customerInfo.idCardImage:', customerInfo.idCardImage);
        console.log('  - customerInfo.salarySlipImage:', customerInfo.salarySlipImage);
        console.log('  - customerInfo.signatureImage:', customerInfo.signatureImage);
        
        console.log('ðŸ–¼ï¸ FirstOrder level:');
        console.log('  - firstOrder.selfieUrl:', firstOrder.selfieUrl);
        console.log('  - firstOrder.idCardImageUrl:', firstOrder.idCardImageUrl);
        console.log('  - firstOrder.images:', firstOrder.images);
        console.log('  - firstOrder.attachments:', firstOrder.attachments);
        console.log('  - firstOrder.documents:', firstOrder.documents);
        
        // à¸ªà¹à¸à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸«à¸²à¸—à¸¸à¸ field à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸¡à¸µà¸£à¸¹à¸›à¸ à¸²à¸ž
        console.log('ðŸ” Auto-scanning for image fields...');
        const autoScanFields = (obj, prefix = '') => {
          if (!obj || typeof obj !== 'object') return;
          
          Object.keys(obj).forEach(key => {
            const value = obj[key];
            const fullKey = prefix ? `${prefix}.${key}` : key;
            
            // à¸«à¸² field à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸³à¸§à¹ˆà¸² image, url, photo, pic à¸«à¸£à¸·à¸­ attachment
            if (typeof value === 'string' && value.trim() !== '' && 
                (key.toLowerCase().includes('image') || 
                 key.toLowerCase().includes('url') || 
                 key.toLowerCase().includes('photo') || 
                 key.toLowerCase().includes('pic') ||
                 key.toLowerCase().includes('selfie') ||
                 key.toLowerCase().includes('signature') ||
                 key.toLowerCase().includes('card') ||
                 key.toLowerCase().includes('slip') ||
                 value.includes('/uploads/') ||
                 value.includes('.jpg') ||
                 value.includes('.jpeg') ||
                 value.includes('.png') ||
                 value.includes('.gif'))) {
              console.log(`ðŸ“· Found potential image field: ${fullKey} = ${value}`);
            }
            
            // à¸ªà¹à¸à¸™à¸¥à¸‡à¹„à¸›à¹ƒà¸™ object à¸¢à¹ˆà¸­à¸¢ (à¹à¸•à¹ˆà¸ˆà¸³à¸à¸±à¸”à¸£à¸°à¸”à¸±à¸šà¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸§à¸™à¸¥à¸¹à¸›à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸š)
            if (typeof value === 'object' && prefix.split('.').length < 3) {
              autoScanFields(value, fullKey);
            }
          });
        };
        
        autoScanFields(customer, 'customer');
        autoScanFields(customerInfo, 'customerInfo');
        autoScanFields(firstOrder, 'firstOrder');
        
        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¸²à¸ customer_info à¸‚à¸­à¸‡ order à¹à¸£à¸
        const fullName = customer.fullName || `${customerInfo.prefix || ''} ${customerInfo.firstName || ''} ${customerInfo.lastName || ''}`.trim() || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
        
        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸² - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ order à¹à¸£à¸
        const contractNo = firstOrder.contractNo || firstOrder.contract_no || '-';
        const status = firstOrder.status || '-';
        const planType = firstOrder.planType || firstOrder.plan_type || '-';
        const installmentType = firstOrder.installmentType || firstOrder.installment_type || '-';
        const branchCode = firstOrder.branch_code || firstOrder.branchCode || '-';
        const branchName = firstOrder.branch_name || firstOrder.branchName || branchCode;

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸² - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ order à¹à¸£à¸
        const items = firstOrder.items || [];
        const productInfo = items.length > 0 ? items[0] : {};
        const productName = productInfo.name || productInfo.productName || firstOrder.productName || (items.length > 0 ? `${items[0].brand || ''} ${items[0].model || ''}`.trim() : '-');

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™ - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸§à¸¡à¹à¸¥à¸°à¸ˆà¸²à¸ order à¹à¸£à¸
        const totalAmount = firstOrder.totalAmount || firstOrder.total_amount || 0;
        const finalTotalAmount = firstOrder.finalTotalAmount || firstOrder.final_total_amount || totalAmount;
        const downPayment = firstOrder.downPayment || firstOrder.down_payment || 0;
        const monthlyPayment = (customer.installmentSummary && customer.installmentSummary.monthlyPayment) || firstOrder.installmentAmount || 0;
        const installmentCount = firstOrder.installmentCount || firstOrder.installment_count || firstOrder.installmentPeriod || 0;
        const paidAmount = firstOrder.paidAmount || firstOrder.paid_amount || 0;
        const remainingAmount = (customer.installmentSummary && customer.installmentSummary.totalDebt) || Math.max(0, (firstOrder.remainingAmount || firstOrder.remaining_amount || finalTotalAmount - paidAmount));
        const promotionDiscount = firstOrder.promotionDiscount || firstOrder.promotion_discount || 0;

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
        const address = customerInfo.address || {};
        const contactAddress = customerInfo.contactAddress || {};

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸¢à¸²à¸™
        const witness = firstOrder.witness || {};

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢
        const salesperson = firstOrder.salesperson || {};

        // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸Šà¸³à¸£à¸°
        const payments = firstOrder.payments || [];
        const lastPayment = payments.length > 0 ? payments[payments.length - 1] : null;

        // Debug image URLs
        console.log('ðŸ–¼ï¸ Image data debug:', {
          customer_selfie: customer.selfieUrl,
          customerInfo_selfie: customerInfo.selfieImage,
          firstOrder_selfie: firstOrder.customer_info?.selfieImage,
          customer_idCard: customer.idCardImageUrl,
          customerInfo_idCard: customerInfo.idCardImage,
          firstOrder_idCard: firstOrder.customer_info?.idCardImage
        });

        // à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸² - à¹à¸šà¸šà¸‡à¹ˆà¸²à¸¢
        const modalContent = createCustomerModalContent(customer, customerInfo, firstOrder, {
          fullName, contractNo, status, planType, installmentType, branchCode, branchName,
          totalAmount, finalTotalAmount, downPayment, monthlyPayment, installmentCount,
          paidAmount, remainingAmount, promotionDiscount
        });

        document.getElementById('customerDetailContent').innerHTML = modalContent;
              <h4 class="font-semibold text-lg mb-3 text-green-600 dark:text-green-400">
                ðŸ“‹ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸²${orders.length > 1 ? ` (à¹à¸ªà¸”à¸‡à¸ªà¸±à¸à¸à¸²à¹à¸£à¸)` : ''}
              </h4>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸ªà¸±à¸à¸à¸²:</span>
                  <span class="col-span-2 font-mono">${contractNo}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹à¸œà¸™à¸à¸²à¸£à¸œà¹ˆà¸­à¸™:</span>
                  <span class="col-span-2">${planType}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸œà¹ˆà¸­à¸™:</span>
                  <span class="col-span-2">${installmentType === 'pay-as-you-go' ? 'à¸œà¹ˆà¸­à¸™à¹„à¸›à¹ƒà¸Šà¹‰à¹„à¸›' : 'à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¸£à¸±à¸šà¸‚à¸­à¸‡'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ªà¸²à¸‚à¸²:</span>
                  <span class="col-span-2">${branchName !== branchCode ? `${branchName} (${branchCode})` : branchCode}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ªà¸–à¸²à¸™à¸°:</span>
                  <span class="col-span-2">${getStatusBadge(status)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡:</span>
                  <span class="col-span-2">${firstOrder.createdAt ? formatDateTime(firstOrder.createdAt) : '-'}</span>
                </div>
              </div>
            </div>

            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸² -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
              <h4 class="font-semibold text-lg mb-3 text-purple-600 dark:text-purple-400">
                ðŸ“± à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²${orders.length > 1 ? ` (à¸ªà¸±à¸à¸à¸²à¹à¸£à¸)` : ''}
              </h4>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸²:</span>
                  <span class="col-span-2">${productName}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ˆà¸³à¸™à¸§à¸™:</span>
                  <span class="col-span-2">${productInfo.qty || productInfo.quantity || 1} à¸Šà¸´à¹‰à¸™</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">IMEI:</span>
                  <span class="col-span-2 font-mono">${productInfo.imei || productInfo.serialNumber || '-'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹€à¸‡à¸´à¸™à¸”à¸²à¸§à¸™à¹Œà¸ªà¸´à¸™à¸„à¹‰à¸²:</span>
                  <span class="col-span-2">${formatCurrency(productInfo.downAmount || 0)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²:</span>
                  <span class="col-span-2">${productInfo.payUseInstallmentCount || 0} à¸‡à¸§à¸”</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸„à¹ˆà¸²à¸‡à¸§à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²:</span>
                  <span class="col-span-2">${formatCurrency(productInfo.payUseInstallment || 0)}</span>
                </div>
              </div>
            </div>

            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™ -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
              <h4 class="font-semibold text-lg mb-3 text-yellow-600 dark:text-yellow-400">
                ðŸ’° à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‡à¸´à¸™${orders.length > 1 ? ` (à¸£à¸§à¸¡à¸—à¸¸à¸à¸ªà¸±à¸à¸à¸²)` : ''}
              </h4>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸¢à¸­à¸”à¸£à¸§à¸¡à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸§à¸™à¸¥à¸”:</span>
                  <span class="col-span-2 font-semibold">${formatCurrency(totalAmount)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ªà¹ˆà¸§à¸™à¸¥à¸”à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™:</span>
                  <span class="col-span-2 text-red-600">${formatCurrency(promotionDiscount)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸¢à¸­à¸”à¸£à¸§à¸¡à¸ªà¸¸à¸—à¸˜à¸´:</span>
                  <span class="col-span-2 font-semibold text-blue-600">${formatCurrency(finalTotalAmount)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹€à¸‡à¸´à¸™à¸”à¸²à¸§à¸™à¹Œ:</span>
                  <span class="col-span-2">${formatCurrency(downPayment)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸„à¹ˆà¸²à¸‡à¸§à¸”à¸•à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™:</span>
                  <span class="col-span-2 font-semibold text-blue-600">${formatCurrency(orders.length > 1 && customer.installmentSummary ? customer.installmentSummary.monthlyPayment : monthlyPayment)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸ˆà¸³à¸™à¸§à¸™à¸‡à¸§à¸”:</span>
                  <span class="col-span-2">${installmentCount} à¸‡à¸§à¸”</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸¢à¸­à¸”à¸—à¸µà¹ˆà¸Šà¸³à¸£à¸°à¹à¸¥à¹‰à¸§:</span>
                  <span class="col-span-2 font-semibold text-green-600">${formatCurrency(paidAmount)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸¢à¸­à¸”à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­:</span>
                  <span class="col-span-2 font-semibold text-red-600">${formatCurrency(orders.length > 1 && customer.installmentSummary ? customer.installmentSummary.totalDebt : remainingAmount)}</span>
                </div>
              </div>
            </div>

            <!-- à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border lg:col-span-2">
              <h4 class="font-semibold text-lg mb-3 text-indigo-600 dark:text-indigo-400">
                ðŸ  à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h5 class="font-medium mb-2">à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸•à¸²à¸¡à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™:</h5>
                  <div class="text-sm space-y-1">
                    <div>à¸šà¹‰à¸²à¸™à¹€à¸¥à¸‚à¸—à¸µà¹ˆ: ${address.houseNo || '-'}</div>
                    <div>à¸«à¸¡à¸¹à¹ˆ: ${address.moo || '-'}</div>
                    <div>à¸•à¸³à¸šà¸¥: ${address.subDistrict || '-'}</div>
                    <div>à¸­à¸³à¹€à¸ à¸­: ${address.district || '-'}</div>
                    <div>à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”: ${address.province || '-'}</div>
                    <div>à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ: ${address.zipcode || '-'}</div>
                  </div>
                </div>
                <div>
                  <h5 class="font-medium mb-2">à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸´à¸”à¸•à¹ˆà¸­à¹„à¸”à¹‰:</h5>
                  <div class="text-sm space-y-1">
                    ${contactAddress.useSameAddress ? 
                      '<div class="text-gray-600">à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™à¸à¸±à¸šà¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™</div>' :
                      `<div>à¸šà¹‰à¸²à¸™à¹€à¸¥à¸‚à¸—à¸µà¹ˆ: ${contactAddress.houseNo || '-'}</div>
                       <div>à¸«à¸¡à¸¹à¹ˆ: ${contactAddress.moo || '-'}</div>
                       <div>à¸‹à¸­à¸¢: ${contactAddress.lane || '-'}</div>
                       <div>à¸–à¸™à¸™: ${contactAddress.road || '-'}</div>
                       <div>à¸•à¸³à¸šà¸¥: ${contactAddress.subDistrict || '-'}</div>
                       <div>à¸­à¸³à¹€à¸ à¸­: ${contactAddress.district || '-'}</div>
                       <div>à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”: ${contactAddress.province || '-'}</div>
                       <div>à¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ: ${contactAddress.zipcode || '-'}</div>`
                    }
                  </div>
                </div>
              </div>
            </div>

            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸¢à¸²à¸™ -->
            ${(witness.name || witness.firstName || witness.idCard) ? `
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
              <h4 class="font-semibold text-lg mb-3 text-orange-600 dark:text-orange-400">
                ðŸ‘¥ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸¢à¸²à¸™
              </h4>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸Šà¸·à¹ˆà¸­:</span>
                  <span class="col-span-2">${witness.name || `${witness.firstName || ''} ${witness.lastName || ''}`.trim() || '-'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™:</span>
                  <span class="col-span-2">${witness.idCard || witness.taxId || '-'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£:</span>
                  <span class="col-span-2">${witness.phone || witness.phoneNumber || '-'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œ:</span>
                  <span class="col-span-2">${witness.relation || witness.relationship || '-'}</span>
                </div>
              </div>
            </div>
            ` : ''}

            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢ -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border">
              <h4 class="font-semibold text-lg mb-3 text-teal-600 dark:text-teal-400">
                ðŸ‘¨â€ðŸ’¼ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢
              </h4>
              <div class="space-y-2 text-sm">
                <div class="grid grid-cols-3 gap-2">
                  <span class="font-medium">à¸Šà¸·à¹ˆà¸­:</span>
                  <span class="col-span-2">${salesperson.name || customer.staffName || '-'}</span>
                </div>
              </div>
            </div>

            <!-- à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸Šà¸³à¸£à¸° -->
            ${payments.length > 0 ? `
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border lg:col-span-2">
              <h4 class="font-semibold text-lg mb-3 text-cyan-600 dark:text-cyan-400">
                ðŸ’³ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸Šà¸³à¸£à¸° (${payments.length} à¸£à¸²à¸¢à¸à¸²à¸£)
              </h4>
              <div class="overflow-x-auto max-h-64">
                <table class="table table-compact w-full">
                  <thead>
                    <tr>
                      <th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
                      <th>à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™</th>
                      <th>à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸Šà¸³à¸£à¸°</th>
                      <th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${payments.map(payment => `
                      <tr>
                        <td class="text-sm">${formatDate(payment.payDate)}</td>
                        <td class="text-sm font-medium">${formatCurrency(payment.amount)}</td>
                        <td class="text-sm">${payment.method === 'cash' ? 'à¹€à¸‡à¸´à¸™à¸ªà¸”' : payment.method}</td>
                        <td class="text-sm">${payment.note || '-'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            ` : ''}

            <!-- à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸™à¸š -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border lg:col-span-2">
              <h4 class="font-semibold text-lg mb-3 text-rose-600 dark:text-rose-400">
                ðŸ“Ž à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸™à¸š
              </h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <div class="text-sm font-medium mb-2">à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ</div>
                  ${(() => {
                    // à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆà¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸²
                    console.log('ðŸ–¼ï¸ Searching for selfie image...');
                    
                    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¶à¸à¹ƒà¸™ object
                    const deepSearch = (obj, searchTerms) => {
                      if (!obj || typeof obj !== 'object') return null;
                      
                      // à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸™ level à¹à¸£à¸
                      for (const term of searchTerms) {
                        if (obj[term] && typeof obj[term] === 'string' && obj[term].trim() !== '') {
                          return obj[term];
                        }
                      }
                      
                      // à¸„à¹‰à¸™à¸«à¸²à¸¥à¸¶à¸à¸¥à¸‡à¹„à¸›
                      for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null) {
                          const found = deepSearch(value, searchTerms);
                          if (found) return found;
                        }
                      }
                      
                      return null;
                    };
                    
                    // à¸„à¸³à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ
                    const selfieTerms = ['selfieImage', 'selfieUrl', 'selfie_image', 'selfie_url', 'selfie'];
                    
                    // à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸à¹à¸«à¸¥à¹ˆà¸‡à¸•à¹ˆà¸²à¸‡à¹†
                    let selfieUrl = deepSearch(customer, selfieTerms) ||
                                   deepSearch(customerInfo, selfieTerms) ||
                                   deepSearch(firstOrder, selfieTerms);
                    
                    // à¸«à¸²à¸à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸žà¸š à¹ƒà¸«à¹‰à¸„à¹‰à¸™à¸«à¸²à¸ˆà¸²à¸à¸—à¸¸à¸ field à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸³à¸§à¹ˆà¸² selfie
                    if (!selfieUrl) {
                      const allObjects = [customer, customerInfo, firstOrder];
                      for (const obj of allObjects) {
                        if (!obj) continue;
                        for (const [key, value] of Object.entries(obj)) {
                          if (typeof value === 'string' && value.trim() !== '' && 
                              key.toLowerCase().includes('selfie')) {
                            selfieUrl = value;
                            console.log('âœ… Found selfie in field:', key, '=', value);
                            break;
                          }
                        }
                        if (selfieUrl) break;
                      }
                    }
                    
                    if (selfieUrl) {
                      console.log('âœ… Found selfie image:', selfieUrl);
                    } else {
                      console.log('âŒ No selfie image found');
                    }
                    
                    const imageUrl = selfieUrl ? getImageUrl(selfieUrl) : null;
                    return imageUrl ? 
                      `<img src="${imageUrl}" class="w-20 h-20 object-cover rounded border mx-auto cursor-pointer hover:opacity-75" alt="à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ" onclick="window.open('${imageUrl}', '_blank')" onerror="console.log('Image load error:', this.src); this.parentElement.innerHTML='<div class=\\"w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center\\"><i class=\\"bi bi-image text-gray-400\\"></i></div>'">` :
                      '<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>';
                  })()}
                </div>
                <div class="text-center">
                  <div class="text-sm font-medium mb-2">à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™</div>
                  ${(() => {
                    // à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸²
                    console.log('ðŸ–¼ï¸ Searching for ID card image...');
                    
                    const deepSearch = (obj, searchTerms) => {
                      if (!obj || typeof obj !== 'object') return null;
                      
                      for (const term of searchTerms) {
                        if (obj[term] && typeof obj[term] === 'string' && obj[term].trim() !== '') {
                          return obj[term];
                        }
                      }
                      
                      for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null) {
                          const found = deepSearch(value, searchTerms);
                          if (found) return found;
                        }
                      }
                      
                      return null;
                    };
                    
                    const idCardTerms = ['idCardImage', 'idCardImageUrl', 'id_card_image', 'id_card_url', 'idCard', 'nationalIdImage'];
                    
                    let idCardUrl = deepSearch(customer, idCardTerms) ||
                                   deepSearch(customerInfo, idCardTerms) ||
                                   deepSearch(firstOrder, idCardTerms);
                    
                    if (!idCardUrl) {
                      const allObjects = [customer, customerInfo, firstOrder];
                      for (const obj of allObjects) {
                        if (!obj) continue;
                        for (const [key, value] of Object.entries(obj)) {
                          if (typeof value === 'string' && value.trim() !== '' && 
                              (key.toLowerCase().includes('idcard') || key.toLowerCase().includes('id_card') || 
                               key.toLowerCase().includes('nationalid'))) {
                            idCardUrl = value;
                            console.log('âœ… Found ID card in field:', key, '=', value);
                            break;
                          }
                        }
                        if (idCardUrl) break;
                      }
                    }
                    
                    if (idCardUrl) {
                      console.log('âœ… Found ID card image:', idCardUrl);
                    } else {
                      console.log('âŒ No ID card image found');
                    }
                    
                    const imageUrl = idCardUrl ? getImageUrl(idCardUrl) : null;
                    return imageUrl ? 
                      `<img src="${imageUrl}" class="w-20 h-20 object-cover rounded border mx-auto cursor-pointer hover:opacity-75" alt="à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™" onclick="window.open('${imageUrl}', '_blank')" onerror="console.log('Image load error:', this.src); this.parentElement.innerHTML='<div class=\\"w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center\\"><i class=\\"bi bi-image text-gray-400\\"></i></div>'">` :
                      '<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>';
                  })()}
                </div>
                <div class="text-center">
                  <div class="text-sm font-medium mb-2">à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™</div>
                  ${(() => {
                    // à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸²
                    console.log('ðŸ–¼ï¸ Searching for salary slip image...');
                    
                    const deepSearch = (obj, searchTerms) => {
                      if (!obj || typeof obj !== 'object') return null;
                      
                      for (const term of searchTerms) {
                        if (obj[term] && typeof obj[term] === 'string' && obj[term].trim() !== '') {
                          return obj[term];
                        }
                      }
                      
                      for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null) {
                          const found = deepSearch(value, searchTerms);
                          if (found) return found;
                        }
                      }
                      
                      return null;
                    };
                    
                    const salaryTerms = ['salarySlipImage', 'salarySlipUrl', 'salary_slip_image', 'salary_slip_url', 'salarySlip', 'paySlip'];
                    
                    let salaryUrl = deepSearch(customer, salaryTerms) ||
                                   deepSearch(customerInfo, salaryTerms) ||
                                   deepSearch(firstOrder, salaryTerms);
                    
                    if (!salaryUrl) {
                      const allObjects = [customer, customerInfo, firstOrder];
                      for (const obj of allObjects) {
                        if (!obj) continue;
                        for (const [key, value] of Object.entries(obj)) {
                          if (typeof value === 'string' && value.trim() !== '' && 
                              (key.toLowerCase().includes('salary') || key.toLowerCase().includes('slip') || 
                               key.toLowerCase().includes('pay'))) {
                            salaryUrl = value;
                            console.log('âœ… Found salary slip in field:', key, '=', value);
                            break;
                          }
                        }
                        if (salaryUrl) break;
                      }
                    }
                    
                    if (salaryUrl) {
                      console.log('âœ… Found salary slip image:', salaryUrl);
                    } else {
                      console.log('âŒ No salary slip image found');
                    }
                    
                    const imageUrl = salaryUrl ? getImageUrl(salaryUrl) : null;
                    return imageUrl ? 
                      `<img src="${imageUrl}" class="w-20 h-20 object-cover rounded border mx-auto cursor-pointer hover:opacity-75" alt="à¸ªà¸¥à¸´à¸›à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™" onclick="window.open('${imageUrl}', '_blank')" onerror="console.log('Image load error:', this.src); this.parentElement.innerHTML='<div class=\\"w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center\\"><i class=\\"bi bi-image text-gray-400\\"></i></div>'">` :
                      '<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>';
                  })()}
                </div>
                <div class="text-center">
                  <div class="text-sm font-medium mb-2">à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™</div>
                  ${(() => {
                    // à¸„à¹‰à¸™à¸«à¸²à¸£à¸¹à¸›à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™à¸ˆà¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸²
                    console.log('ðŸ–¼ï¸ Searching for signature image...');
                    
                    const deepSearch = (obj, searchTerms) => {
                      if (!obj || typeof obj !== 'object') return null;
                      
                      for (const term of searchTerms) {
                        if (obj[term] && typeof obj[term] === 'string' && obj[term].trim() !== '') {
                          return obj[term];
                        }
                      }
                      
                      for (const [key, value] of Object.entries(obj)) {
                        if (typeof value === 'object' && value !== null) {
                          const found = deepSearch(value, searchTerms);
                          if (found) return found;
                        }
                      }
                      
                      return null;
                    };
                    
                    const signatureTerms = ['signatureImage', 'customerSignatureUrl', 'signature_image', 'signature_url', 'signature'];
                    
                    let signatureUrl = deepSearch(customer, signatureTerms) ||
                                      deepSearch(customerInfo, signatureTerms) ||
                                      deepSearch(firstOrder, signatureTerms);
                    
                    if (!signatureUrl) {
                      const allObjects = [customer, customerInfo, firstOrder];
                      for (const obj of allObjects) {
                        if (!obj) continue;
                        for (const [key, value] of Object.entries(obj)) {
                          if (typeof value === 'string' && value.trim() !== '' && 
                              key.toLowerCase().includes('signature')) {
                            signatureUrl = value;
                            console.log('âœ… Found signature in field:', key, '=', value);
                            break;
                          }
                        }
                        if (signatureUrl) break;
                      }
                    }
                    
                    if (signatureUrl) {
                      console.log('âœ… Found signature image:', signatureUrl);
                    } else {
                      console.log('âŒ No signature image found');
                    }
                    
                    const imageUrl = signatureUrl ? getImageUrl(signatureUrl) : null;
                    return imageUrl ? 
                      `<img src="${imageUrl}" class="w-20 h-20 object-cover rounded border mx-auto cursor-pointer hover:opacity-75" alt="à¸¥à¸²à¸¢à¹€à¸‹à¹‡à¸™" onclick="window.open('${imageUrl}', '_blank')" onerror="console.log('Image load error:', this.src); this.parentElement.innerHTML='<div class=\\"w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center à¸ˆà¥‚enter\\"><i class=\\"bi bi-image text-gray-400\\"></i></div>'">` :
                      '<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>';
                  })()}
                </div>
              </div>
            </div>
                    '<div class="w-20 h-20 bg-gray-200 rounded border mx-auto flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>'
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- à¸›à¸¸à¹ˆà¸¡à¸ˆà¸±à¸”à¸à¸²à¸£ -->
          <div class="mt-6 flex flex-wrap gap-2 justify-end">
            <button class="btn btn-sm btn-secondary" onclick="generateContract('${customer._id}')">
              <i class="bi bi-file-pdf"></i> à¸ªà¸£à¹‰à¸²à¸‡ PDF
            </button>
            <button class="btn btn-sm btn-info" onclick="editCustomer('${customer._id}')">
              <i class="bi bi-pencil"></i> à¹à¸à¹‰à¹„à¸‚
            </button>
            <button class="btn btn-sm btn-warning" onclick="viewInstallmentHistory('${customer._id}')">
              <i class="bi bi-clock-history"></i> à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸Šà¸³à¸£à¸°
            </button>
          </div>
        `;

        document.getElementById('customerDetailContent').innerHTML = modalContent;
        
        // à¹à¸ªà¸”à¸‡ modal
        const modal = document.getElementById('customerDetailModal');
        modal.checked = true;
        modal.classList.add('modal-open');
        
      } catch (error) {
        console.error('Error showing customer detail modal:', error);
        alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²');
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸² - à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸œà¹ˆà¸­à¸™à¸ˆà¸²à¸ Installment API

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸¥à¸¹à¸à¸„à¹‰à¸² (à¸ªà¸³à¸«à¸£à¸±à¸š compatibility)
    async function viewCustomerDetail(customerId) {
      try {
        const customer = allCustomers.find(c => c._id === customerId);
        if (customer) {
          showCustomerDetailModal(customer);
        } else {
          console.error('Customer not found:', customerId);
          alert('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²');
        }
      } catch (error) {
        console.error('Error loading customer detail:', error);
      }
    }

    // Expose functions to window object for onclick handlers
    window.viewCustomerDetail = viewCustomerDetail;

        // à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸œà¹ˆà¸­à¸™à¸ˆà¸²à¸ Installment API
    async function loadInstallmentCustomers() {
      try {
        // Loading customers from database

        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸” token
        let authToken = localStorage.getItem('authToken');
        
        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² token à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        if (authToken && authToken !== 'null' && authToken !== 'undefined') {
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ JWT token à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸¡à¸µ 3 à¸ªà¹ˆà¸§à¸™ à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢ .)
          const tokenParts = authToken.split('.');
          if (tokenParts.length !== 3) {
            console.warn('âš ï¸ Invalid token format, clearing and getting new token...');
            localStorage.removeItem('authToken');
            authToken = null;
          }
        } else {
          authToken = null;
        }
        
        if (!authToken) {
          console.warn('âš ï¸ No valid auth token found, trying to get new token...');
          // à¸¥à¸­à¸‡ login à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ token
          const loginSuccess = await autoLogin();
          if (!loginSuccess) {
            console.error('âŒ Auto login failed, showing empty data');
            return {
              success: false,
              data: [],
              pagination: { currentPage: 1, totalPages: 1, totalItems: 0 }
            };
          }
        }

        // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ InstallmentOrder à¹‚à¸”à¸¢à¸•à¸£à¸‡
        const params = new URLSearchParams();
        params.append('page', 1);
        params.append('limit', 100); // à¸”à¸¶à¸‡à¹€à¸¢à¸­à¸°à¹† à¹€à¸žà¸·à¹ˆà¸­ group à¸•à¸²à¸¡ customer
        
        const branchSelector = document.getElementById('branchSelector');
        const branchId = branchSelector ? branchSelector.value : '';
        console.log('Branch selector value:', branchId);
        
        // à¸ªà¹ˆà¸‡ branch_code à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¹ˆà¸²à¸§à¹ˆà¸²à¸‡
        if (branchId && branchId !== '' && branchId !== 'all') {
          params.append('branch_code', branchId);
        }
        
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value : '';
        console.log('Search term:', searchTerm);
        
        if (searchTerm && searchTerm.trim() !== '') {
          params.append('search', searchTerm.trim());
        }
        
        console.log('API params:', params.toString());

        // à¹€à¸£à¸µà¸¢à¸ API InstallmentOrder à¹‚à¸”à¸¢à¸•à¸£à¸‡
        // à¸¥à¸­à¸‡à¹€à¸£à¸µà¸¢à¸à¸«à¸¥à¸²à¸¢ endpoints à¸ˆà¸™à¸à¸§à¹ˆà¸²à¸ˆà¸°à¹„à¸”à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
        const endpoints = [
          `/api/installment/customers?${params}`,
          `/api/installment/reports/debtors?${params}`
        ];
        
        let res;
        let apiResponse = null;
        
        for (const endpoint of endpoints) {
          console.log(`ðŸ” Trying endpoint: ${endpoint}`);
          res = await fetch(endpoint, {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (res.ok) {
            apiResponse = await res.json();
            console.log(`âœ… Got data from: ${endpoint}`);
            break;
          } else {
            console.log(`âŒ Failed: ${endpoint} - Status: ${res.status}`);
          }
        }
        
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ endpoint à¹„à¸«à¸™à¹€à¸¥à¸¢
        if (!apiResponse) {
          console.warn('âš ï¸ No data from any endpoint');
          
          // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
          apiResponse = {
            success: false,
            data: [],
            pagination: { currentPage: 1, totalPages: 1, totalItems: 0 }
          };
        }
        
        // à¹ƒà¸Šà¹‰ helper function processInstallmentData
        const response = processInstallmentData(apiResponse);
        
        if (response.success) {
          console.log(`âœ… Loaded ${response.data.length} customers with installment data`);
          
          // à¸­à¸±à¸žà¹€à¸”à¸—à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
          allCustomers = response.data;
          totalPages = response.pagination?.totalPages || 1;
          
          // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡
          renderCustomers(response.data, true);
          updatePagination(response.pagination);
          
          return true;
        }

        // Fallback to old API if new one fails
        console.log('âš ï¸ New API failed, trying fallback endpoints...');
        const apiEndpoints = [
          '/api/installment/customers',
          '/api/installment/reports/debtors',
          '/api/loan/dashboard/debtors',
          '/api/customers?hasInstallment=true'
        ];

        let success = false;
        let rawData = [];

        for (const endpoint of apiEndpoints) {
          try {
            console.log(`ðŸ”„ Trying API endpoint: ${endpoint}`);
            const response = await fetch(endpoint, { headers });

            if (response.ok) {
              const data = await response.json();

              if (data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                rawData = data.data;
                success = true;
                console.log(`âœ… Successfully loaded data from ${endpoint}:`, rawData.length, 'records');

                // Debug: à¹à¸ªà¸”à¸‡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸±à¸§à¹à¸£à¸
                console.log('ðŸ“Š Raw data structure:', rawData[0]);
                break;
              } else {
                console.warn(`âš ï¸ API ${endpoint} returned empty or invalid data:`, data);
              }
            } else {
              console.warn(`âš ï¸ API ${endpoint} failed:`, response.status, response.statusText);
            }
          } catch (endpointError) {
            console.warn(`âŒ Error with ${endpoint}:`, endpointError.message);
          }
        }

        if (success && rawData.length > 0) {
          // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸¡à¸²à¸•à¸£à¸à¸²à¸™ - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸ API
          allCustomers = rawData.map((item, index) => {
            // Map à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ API response à¹„à¸›à¸¢à¸±à¸‡ frontend format
            return {
              _id: item._id || `cust_${index}`,
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸Šà¸·à¹ˆà¸­ - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ API à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸¡à¸²
              first_name: item.firstName || (item.customerName ? item.customerName.split(' ')[0] : ''),
              last_name: item.lastName || (item.customerName ? item.customerName.split(' ').slice(1).join(' ') : ''),
              customerName: item.customerName || `${item.firstName || ''} ${item.lastName || ''}`.trim(),
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸´à¸”à¸•à¹ˆà¸­ - à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ API
              phone_number: item.phone || item.phone_number || '',
              email: item.email || '',
              tax_id: item.idCard || item.tax_id || '',
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§
              prefix: item.prefix || 'à¸™à¸²à¸¢',
              gender: item.gender || '',
              age: item.age || '',
              birth_date: item.birth_date || null,
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
              occupation: item.occupation || '',
              income: item.income || null,
              workplace: item.workplace || '',
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²
              branch_name: item.branchName || item.branch_name || `à¸ªà¸²à¸‚à¸² ${item.branchCode || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸'}`,
              branchCode: item.branchCode || '',
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
              address: item.address || null,
              coordinates: item.coordinates || '',
              
              // Social Media
              facebook_url: item.facebook_url || null,
              line_id: item.line_id || null,
              referral_code: item.referral_code || '',
              
              // à¸£à¸¹à¸›à¸ à¸²à¸ž
              selfieImage: item.selfieImage || item.selfie_url || null,
              
              // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°
              contractNo: item.contracts?.[0]?.contractNo || item.contractNo || '-',
              totalAmount: Math.max(0, item.totalAmount || 0),
              monthlyPayment: Math.max(0, item.monthlyPayment || 0),
              remainingAmount: Math.max(0, item.totalRemaining || item.remainingAmount || 0),
              overdueAmount: Math.max(0, item.overdueAmount || 0),
              paidAmount: Math.max(0, item.totalPaid || item.paidAmount || 0),
              installmentCount: item.totalContracts || item.installmentCount || 0,
              
              // à¸ªà¸–à¸²à¸™à¸°
              status: item.status || 'active',
              statusLabel: item.status === 'completed' ? 'à¸Šà¸³à¸£à¸°à¸„à¸£à¸š' : 
                          item.status === 'active' ? 'à¸›à¸à¸•à¸´' : 
                          item.status === 'overdue' ? 'à¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸°' : 'à¸­à¸·à¹ˆà¸™à¹†',
              statusColor: item.status === 'completed' ? 'success' :
                          item.status === 'active' ? 'info' : 
                          item.status === 'overdue' ? 'warning' : 'default',
              
              // à¸§à¸±à¸™à¸—à¸µà¹ˆ
              startDate: item.startDate || item.createdAt || null,
              dueDate: item.dueDate || null,
              
              // à¸„à¸³à¸™à¸§à¸“à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡
              progress: item.totalAmount > 0 ? Math.round((item.totalPaid || 0) / item.totalAmount * 100) : 0,
              isOverdue: item.status === 'overdue' || (item.overdueAmount || 0) > 0,
              daysOverdue: item.daysOverdue || 0,
              priority: item.priority || 'normal'
            };
          });

          console.log('âœ… Processed customers:', allCustomers.length);
          console.log('ðŸ“Š First processed customer:', allCustomers[0]);
          
          // Debug: à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹à¸¥à¹‰à¸§
          console.group('ðŸ” Customer Data Debug');
          console.log('Total customers loaded:', allCustomers.length);
          if (allCustomers.length > 0) {
            console.log('Sample customer data structure:', JSON.stringify(allCustomers[0], null, 2));
            console.log('Customer fields available:', Object.keys(allCustomers[0]));
          }
          console.groupEnd();

          // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸ˆà¸²à¸ API à¸¥à¸¹à¸à¸„à¹‰à¸²
          await enrichCustomerData();

          renderCustomers(allCustomers);
        } else {
          console.error('âŒ All API endpoints failed');
          allCustomers = [];
          renderCustomers(allCustomers);
        }
      } catch (error) {
        console.error('âŒ Error loading installment customers:', error.message);

        // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”
        console.error('Failed to load customer data');
        allCustomers = [];
        renderCustomers(allCustomers);
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²
    async function enrichCustomerData() {
      try {
        console.log('ðŸ”„ Enriching customer data from additional APIs...');
        
        // à¹ƒà¸Šà¹‰ API installment à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸
        const customerApiEndpoints = [
          '/api/installment/customers',
          '/api/installment/reports/debtors',
          '/api/customers',
          '/api/loan/customers'
        ];

        for (const endpoint of customerApiEndpoints) {
          try {
            console.log(`ðŸ”„ Trying customer API: ${endpoint}`);
            const response = await fetch(endpoint, { headers });

            if (response.ok) {
              const data = await response.json();

              if (data.success && data.data && Array.isArray(data.data)) {
                console.log(`âœ… Got additional customer data from ${endpoint}:`, data.data.length, 'records');

                // à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¹ƒà¸™à¸¥à¸¹à¸à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
                allCustomers.forEach(customer => {
                  // à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸ˆà¸²à¸à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸«à¸£à¸·à¸­à¸ªà¸±à¸à¸à¸²
                  const additionalData = data.data.find(item => 
                    item.phone === customer.phone ||
                    item.phone_number === customer.phone_number ||
                    item.contractNo === customer.contractNo ||
                    item.customerName === customer.customerName ||
                    item.customer_name === `${customer.first_name} ${customer.last_name}`.trim()
                  );

                  if (additionalData) {
                    // à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
                    customer.tax_id = additionalData.tax_id || additionalData.idCard || customer.tax_id;
                    customer.prefix = additionalData.prefix || customer.prefix;
                    customer.gender = additionalData.gender || customer.gender;
                    customer.age = additionalData.age || customer.age;
                    customer.birth_date = additionalData.birth_date || additionalData.birthDate || customer.birth_date;
                    customer.email = additionalData.email || customer.email;
                    customer.occupation = additionalData.occupation || customer.occupation;
                    customer.income = additionalData.income || customer.income;
                    customer.workplace = additionalData.workplace || customer.workplace;
                    customer.address = additionalData.address || customer.address;
                    customer.coordinates = additionalData.coordinates || additionalData.lat && additionalData.lng ? 
                      `${additionalData.lat}, ${additionalData.lng}` : customer.coordinates;
                    customer.facebook_url = additionalData.facebook_url || customer.facebook_url;
                    customer.line_id = additionalData.line_id || customer.line_id;
                    customer.referral_code = additionalData.referral_code || customer.referral_code;
                    customer.selfieImage = additionalData.selfieImage || additionalData.selfie_url || customer.selfieImage;

                    console.log(`ðŸ“ Enriched customer: ${customer.first_name} ${customer.last_name}`);
                  }
                });

                break; // à¸«à¸¢à¸¸à¸”à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
              }
            }
          } catch (endpointError) {
            console.warn(`âŒ Customer API ${endpoint} failed:`, endpointError.message);
          }
        }

        console.log('âœ… Customer data enrichment completed');
      } catch (error) {
        console.warn('âŒ Error enriching customer data:', error.message);
      }
    }



    // Setup event listeners function
    function setupEventListeners() {
        updateDateDisplay();
        setInterval(updateDateDisplay, 60000); // à¸­à¸±à¸žà¹€à¸”à¸—à¸—à¸¸à¸à¸™à¸²à¸—à¸µ
        
        // Initialize loan sidebar first
        if (typeof initializeLoanSidebar === 'function') {
          initializeLoanSidebar();
        }
        
        // à¹€à¸•à¸´à¸¡à¸›à¸µà¹ƒà¸™ selector
        const yearSelector = document.getElementById('yearSelector');
        if (yearSelector) {
          const currentYear = new Date().getFullYear();
          for (let year = currentYear; year >= currentYear - 5; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year + 543; // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ à¸ž.à¸¨.
            if (year === currentYear) option.selected = true;
            yearSelector.appendChild(option);
          }
        }
        
        // Event listeners with null checks
        const btnSearch = document.getElementById('btnSearch');
        if (btnSearch) {
          btnSearch.addEventListener('click', performSearch);
        }
        
        
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          // Add debounced search for better performance
          const debouncedSearch = debounce(performSearch, 500);
          
          searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
          });
          
          // Add real-time search with debounce
          searchInput.addEventListener('input', debouncedSearch);
        }
        
        const closeCustomerModal = document.getElementById('closeCustomerModal');
        if (closeCustomerModal) {
          closeCustomerModal.addEventListener('click', () => {
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
              modal.classList.remove('modal-open');
            }
          });
        }
        
        const btnAddCustomer = document.getElementById('btnAddCustomer');
        if (btnAddCustomer) {
          btnAddCustomer.addEventListener('click', () => {
            openAddCustomerModal();
          });
        }
        
        // Event listeners for add customer modal
        const closeAddCustomerModal = document.getElementById('closeAddCustomerModal');
        if (closeAddCustomerModal) {
          closeAddCustomerModal.addEventListener('click', () => {
            closeAddCustomerModal();
          });
        }
        
        const addCustomerForm = document.getElementById('addCustomerForm');
        if (addCustomerForm) {
          addCustomerForm.addEventListener('submit', handleAddCustomer);
        }
        
        const btnExportExcel = document.getElementById('btnExportExcel');
        if (btnExportExcel) {
          btnExportExcel.addEventListener('click', exportToExcel);
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž
        const selfieInput = document.getElementById('selfieImage');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImageBtn = document.getElementById('removeImage');
        
        if (selfieInput) {
          selfieInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
              // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ
              if (file.size > 2 * 1024 * 1024) {
                alert('à¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸žà¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2MB');
                e.target.value = '';
                return;
              }
              
              // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸Ÿà¸¥à¹Œ
              const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
              if (!allowedTypes.includes(file.type)) {
                alert('à¸£à¸­à¸‡à¸£à¸±à¸šà¹€à¸‰à¸žà¸²à¸°à¹„à¸Ÿà¸¥à¹Œ JPG, PNG, GIF à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™');
                e.target.value = '';
                return;
              }
              
              // à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž
              const reader = new FileReader();
              reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('hidden');
              };
              reader.readAsDataURL(file);
            } else {
              imagePreview.classList.add('hidden');
            }
          });
        }
        
        if (removeImageBtn) {
          removeImageBtn.addEventListener('click', () => {
            selfieInput.value = '';
            imagePreview.classList.add('hidden');
          });
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸›à¸´à¸”à¹‚à¸¡à¸”à¸±à¸¥à¹€à¸¡à¸·à¹ˆà¸­à¸„à¸¥à¸´à¸à¸‚à¹‰à¸²à¸‡à¸™à¸­à¸
        document.getElementById('addCustomerModal').addEventListener('click', (e) => {
          if (e.target.classList.contains('modal')) {
            closeAddCustomerModal();
          }
        });
        
        document.getElementById('customerDetailModal').addEventListener('click', (e) => {
          if (e.target.classList.contains('modal')) {
            document.getElementById('customerDetailModal').classList.remove('modal-open');
          }
        });
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
        const birthDateInput = document.getElementById('birthDate');
        if (birthDateInput) {
          birthDateInput.addEventListener('change', (e) => {
            const age = calculateAge(e.target.value);
            if (age !== null) {
              console.log('à¸­à¸²à¸¢à¸¸:', age, 'à¸›à¸µ');
            }
          });
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™
        const taxIdInput = document.getElementById('taxId');
        if (taxIdInput) {
          taxIdInput.addEventListener('input', (e) => {
            // à¸¥à¸šà¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸•à¸±à¸§à¹€à¸¥à¸‚
            e.target.value = e.target.value.replace(/\D/g, '');
            
            // à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 13 à¸•à¸±à¸§
            if (e.target.value.length > 13) {
              e.target.value = e.target.value.slice(0, 13);
            }
          });
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
          phoneInput.addEventListener('input', (e) => {
            // à¸¥à¸šà¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸•à¸±à¸§à¹€à¸¥à¸‚
            e.target.value = e.target.value.replace(/\D/g, '');
            
            // à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 10 à¸•à¸±à¸§
            if (e.target.value.length > 10) {
              e.target.value = e.target.value.slice(0, 10);
            }
          });
        }
        
        // à¹€à¸žà¸´à¹ˆà¸¡ event listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸«à¸±à¸ªà¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¹Œ
        const zipcodeInput = document.getElementById('zipcode');
        if (zipcodeInput) {
          zipcodeInput.addEventListener('input', (e) => {
            // à¸¥à¸šà¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸•à¸±à¸§à¹€à¸¥à¸‚
            e.target.value = e.target.value.replace(/\D/g, '');
            
            // à¸ˆà¸³à¸à¸±à¸”à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5 à¸•à¸±à¸§
            if (e.target.value.length > 5) {
              e.target.value = e.target.value.slice(0, 5);
            }
          });
        }
    } // End of setupEventListeners function

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Export Excel
    async function exportToExcel() {
      try {
        const response = await fetch('/api/customers/export', { headers });
        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `customers_${new Date().toISOString().slice(0, 10)}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);
        }
      } catch (error) {
        console.error('Export error:', error);
        alert('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸– export à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰');
      }
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£ URL à¸£à¸¹à¸›à¸ à¸²à¸ž
    function getImageUrl(imagePath) {
      if (!imagePath || imagePath.trim() === '') {
        // à¹ƒà¸Šà¹‰ SVG placeholder à¹à¸—à¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
        return 'data:image/svg+xml;charset=UTF-8,%3Csvg width=\'48\' height=\'48\' viewBox=\'0 0 48 48\' fill=\'none\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Ccircle cx=\'24\' cy=\'24\' r=\'24\' fill=\'%23E5E7EB\'/%3E%3Cpath d=\'M24 14c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm0 14c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z\' fill=\'%236B7280\'/%3E%3C/svg%3E';
      }
      
      // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ full URL
      if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        return imagePath;
      }
      
      // à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ data URL
      if (imagePath.startsWith('data:')) {
        return imagePath;
      }
      
      // à¸–à¹‰à¸²à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ /uploads/ à¸«à¸£à¸·à¸­ /static/ à¹à¸¥à¹‰à¸§
      if (imagePath.startsWith('/uploads/') || imagePath.startsWith('/static/')) {
        return imagePath;
      }
      
      // à¸–à¹‰à¸²à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ uploads/
      if (imagePath.startsWith('uploads/')) {
        return '/' + imagePath;
      }
      
      // à¹à¸à¹‰à¹„à¸‚ path à¸—à¸µà¹ˆà¸œà¸´à¸”à¸£à¸¹à¸›à¹à¸šà¸š
      let fixedPath = imagePath.replace(/^.*uploads[\\/]/, "");
      fixedPath = fixedPath.replace(/\\/g, "/");
      
      return `/uploads/${fixedPath}`;
    }

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸›à¸´à¸”/à¸›à¸´à¸”à¹‚à¸¡à¸”à¸±à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ
    function openAddCustomerModal() {
      // à¹€à¸•à¸´à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²à¹ƒà¸™à¹‚à¸¡à¸”à¸±à¸¥
      const customerBranchSelect = document.getElementById('customerBranch');
      customerBranchSelect.innerHTML = '<option value="">à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²</option>';
      
      branches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch._id || branch.branch_code;
        option.textContent = branch.name || branch.branch_code;
        customerBranchSelect.appendChild(option);
      });
      
      // à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸Ÿà¸­à¸£à¹Œà¸¡
      document.getElementById('addCustomerForm').reset();
      
      // à¹€à¸›à¸´à¸”à¹‚à¸¡à¸”à¸±à¸¥
      document.getElementById('addCustomerModal').classList.add('modal-open');
    }
    
    function closeAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.remove('modal-open');
      document.getElementById('addCustomerForm').reset();
      
      // à¸‹à¹ˆà¸­à¸™à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž
      const imagePreview = document.getElementById('imagePreview');
      if (imagePreview) {
        imagePreview.classList.add('hidden');
      }
    }
    
    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸ž
    async function uploadImage(file) {
      if (!file) return null;
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('folder', 'selfies'); // à¹€à¸žà¸´à¹ˆà¸¡ folder parameter
      
      try {
        // à¸¥à¸­à¸‡à¹ƒà¸Šà¹‰ API à¸«à¸¥à¸²à¸¢à¸•à¸±à¸§
        const uploadEndpoints = [
          '/api/upload/selfie',
          '/api/upload/image',
          '/api/upload',
          '/upload/image'
        ];
        
        for (const endpoint of uploadEndpoints) {
          try {
            console.log(`ðŸ”„ Trying upload endpoint: ${endpoint}`);
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + authToken
              },
              body: formData
            });
            
            if (response.ok) {
              const result = await response.json();
              if (result.success && result.data) {
                console.log(`âœ… Upload successful via ${endpoint}`);
                return result.data.url || result.data.path || result.data.filename;
              }
            }
          } catch (endpointError) {
            console.warn(`âŒ Upload failed for ${endpoint}:`, endpointError.message);
            continue;
          }
        }
        
        // à¸–à¹‰à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¹ƒà¸«à¹‰à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ base64 à¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
        console.log('ðŸ“ Converting to base64 as fallback...');
        return await convertToBase64(file);
        
      } catch (error) {
        console.error('Image upload error:', error);
        // à¸ªà¹ˆà¸‡à¸„à¸·à¸™ null à¹à¸—à¸™à¸—à¸µà¹ˆà¸ˆà¸° throw error
        return null;
      }
    }
    
    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸›à¸¥à¸‡à¹„à¸Ÿà¸¥à¹Œà¹€à¸›à¹‡à¸™ base64
    function convertToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ
    async function handleAddCustomer(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitAddCustomer');
      const submitText = document.getElementById('submitText');
      const submitLoading = document.getElementById('submitLoading');
      
      // à¹à¸ªà¸”à¸‡à¸ªà¸–à¸²à¸™à¸° loading
      submitBtn.disabled = true;
      submitText.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...';
      submitLoading.classList.remove('hidden');
      
      try {
        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
        const prefix = document.getElementById('prefix').value;
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const taxId = document.getElementById('taxId').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const customerBranch = document.getElementById('customerBranch').value;
        
        if (!prefix || !firstName || !lastName || !taxId || !phoneNumber || !customerBranch) {
          throw new Error('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™ (à¸Šà¹ˆà¸­à¸‡à¸—à¸µà¹ˆà¸¡à¸µà¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸¡à¸²à¸¢ * à¸ªà¸µà¹à¸”à¸‡)');
        }
        
        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™
        if (!/^\d{13}$/.test(taxId)) {
          throw new Error('à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 13 à¸«à¸¥à¸±à¸');
        }
        
        // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸¹à¸›à¹à¸šà¸šà¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£
        if (!/^[0-9]{9,10}$/.test(phoneNumber)) {
          throw new Error('à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 9-10 à¸«à¸¥à¸±à¸');
        }
        
        // à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¹€à¸‹à¸¥à¸Ÿà¸µà¹ˆ (à¸–à¹‰à¸²à¸¡à¸µ)
        const selfieFile = document.getElementById('selfieImage').files[0];
        let selfieUrl = null;
        
        if (selfieFile) {
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œ (à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2MB)
          if (selfieFile.size > 2 * 1024 * 1024) {
            throw new Error('à¸‚à¸™à¸²à¸”à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸žà¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 2MB');
          }
          
          // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸Ÿà¸¥à¹Œ
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
          if (!allowedTypes.includes(selfieFile.type)) {
            throw new Error('à¸£à¸­à¸‡à¸£à¸±à¸šà¹€à¸‰à¸žà¸²à¸°à¹„à¸Ÿà¸¥à¹Œ JPG, PNG, GIF à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™');
          }
          
          console.log('ðŸ”„ Uploading selfie image...');
          selfieUrl = await uploadImage(selfieFile);
          
          if (!selfieUrl) {
            // à¸–à¹‰à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ à¹ƒà¸«à¹‰à¹€à¸•à¸·à¸­à¸™à¹à¸•à¹ˆà¸¢à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰
            console.warn('âš ï¸ Image upload failed, proceeding without image');
            // à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ throw error à¹ƒà¸«à¹‰à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¹ˆà¸­à¹„à¸”à¹‰
          } else {
            console.log('âœ… Image uploaded successfully:', selfieUrl);
          }
        }
        
        // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
        const customerData = {
          prefix: prefix,
          first_name: firstName,
          last_name: lastName,
          tax_id: taxId,
          phone_number: phoneNumber,
          birth_date: document.getElementById('birthDate').value || null,
          email: document.getElementById('email').value || null,
          branch_code: customerBranch,
          address: {
            houseNo: document.getElementById('houseNo').value || null,
            moo: document.getElementById('moo').value || null,
            subDistrict: document.getElementById('subDistrict').value || null,
            district: document.getElementById('district').value || null,
            province: document.getElementById('province').value || null,
            zipcode: document.getElementById('zipcode').value || null
          },
          facebook_url: document.getElementById('facebookUrl').value || null,
          line_id: document.getElementById('lineId').value || null,
          selfie_url: selfieUrl
        };

        // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸¢à¸±à¸‡ API à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰ Axios à¸«à¸£à¸·à¸­ fetch
        const apiEndpoints = [
          '/api/v1/customers',         // Try v1 API first
          '/api/customers/create',     // Then try explicit create endpoint  
          '/api/customer',            // Then try singular
          '/api/loan/contracts' // Finally try loan contracts
        ];

        let success = false;
        let lastError = null;
        let savedCustomer = null;

        for (const endpoint of apiEndpoints) {
          try {
            console.log(`ðŸ”„ Trying endpoint: ${endpoint}`);
            const response = await fetch(endpoint, {
              method: 'POST', 
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken,
                'Accept': 'application/json'  // Explicitly request JSON response
              },
              body: JSON.stringify(customerData)
            });

            if (response.ok) {
              const contentType = response.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                if (result.success || result.data) {
                  success = true;
                  savedCustomer = result.data;
                  console.log(`âœ… Customer created via ${endpoint}`, result);
                  break;
                }
              }
            } else {
              // Try to get error message from response
              try {
                const errorData = await response.json();
                lastError = errorData.message || errorData.error;
              } catch (e) {
                lastError = `API Error: ${response.status} ${response.statusText}`;
              }
              console.warn(`âŒ Error from ${endpoint}:`, lastError);
            }
          } catch (err) {
            console.warn(`âŒ Error with ${endpoint}:`, err.message);
            lastError = err.message;
            continue;
          }
        }

        if (!success) {
          // If all APIs failed, try to save locally or show appropriate message
          console.warn('âŒ All API endpoints failed, trying local storage fallback');
          
          try {
            // Get existing customers from localStorage
            const existingCustomers = JSON.parse(localStorage.getItem('customers') || '[]');
            
            // Add new customer with generated ID
            const localCustomer = {
              ...customerData,
              _id: 'LOCAL_' + Date.now(),
              created_at: new Date().toISOString()
            };
            
            existingCustomers.push(localCustomer);
            localStorage.setItem('customers', JSON.stringify(existingCustomers));
            
            savedCustomer = localCustomer;
            success = true;
            
            console.log('âœ… Customer saved to local storage');
            
          } catch (localError) {
            console.error('Local storage fallback failed:', localError);
            throw new Error(lastError || 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡');
          }
        }

        // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
        let successMessage = 'à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§';
        if (savedCustomer?._id?.startsWith('LOCAL_')) {
          successMessage += ' (à¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸ˆà¸°à¸‹à¸´à¸‡à¸„à¹Œà¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­)';
        }
        if (selfieFile && !selfieUrl) {
          successMessage += '\n(à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸žà¹„à¸”à¹‰)';
        }
        
        alert(successMessage);
        
        // à¸›à¸´à¸”à¹‚à¸¡à¸”à¸±à¸¥
        closeAddCustomerModal();
        
        // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆ
        await loadInstallmentCustomers();
      } catch (error) {
        console.error('Add customer error:', error);
        alert('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + error.message);
      } finally {
        // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸ªà¸–à¸²à¸™à¸°à¸›à¸¸à¹ˆà¸¡
        submitBtn.disabled = false;
        submitText.textContent = 'à¸šà¸±à¸™à¸—à¸¶à¸';
        submitLoading.classList.add('hidden');
      }
    }
    
    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¸³à¸™à¸§à¸“à¸­à¸²à¸¢à¸¸à¸ˆà¸²à¸à¸§à¸±à¸™à¹€à¸à¸´à¸”
    function calculateAge(birthDate) {
      if (!birthDate) return null;

      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();

      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }

      return age;
    }

    // Global functions à¸ªà¸³à¸«à¸£à¸±à¸šà¸›à¸¸à¹ˆà¸¡à¹ƒà¸™ table
    window.viewCustomerDetail = function(customerId) {
      try {
        console.log('ðŸ” Looking for customer with ID:', customerId);
        
        // à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹‚à¸«à¸¥à¸”à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§
        let customer = null;
        
        // à¸¥à¸­à¸‡à¸«à¸²à¸ˆà¸²à¸ allCustomers à¸à¹ˆà¸­à¸™
        if (window.allCustomers && Array.isArray(window.allCustomers)) {
          customer = window.allCustomers.find(c => c._id === customerId || c.contractNo === customerId);
        }
        
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
        if (!customer) {
          console.error('Customer not found:', customerId);
        }
        
        if (customer) {
          console.log('âœ… Found customer:', customer);
          showCustomerDetailModal(customer);
        } else {
          console.warn('âŒ Customer not found:', customerId);
          showToast('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²', 'warning');
        }
      } catch (error) {
        console.error('Error viewing customer:', error);
        showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²', 'error');
      }
    };

    window.editCustomer = function(customerId) {
      // Redirect à¹„à¸›à¸«à¸™à¹‰à¸²à¹à¸à¹‰à¹„à¸‚ à¸«à¸£à¸·à¸­à¹€à¸›à¸´à¸” modal à¹à¸à¹‰à¹„à¸‚
      window.location.href = `/views/loan/customer-edit.html?id=${customerId}`;
    };

    // Function to close customer detail modal
    window.closeCustomerDetailModal = function() {
      const modal = document.getElementById('customerDetailModal');
      if (modal) {
        modal.remove();
      }
    };
    
    window.viewInstallmentHistory = function(customerId) {
      try {
        console.log('ðŸ” Looking for installment history for customer:', customerId);
        
        // à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹‚à¸«à¸¥à¸”à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§
        let customer = null;
        
        // à¸¥à¸­à¸‡à¸«à¸²à¸ˆà¸²à¸ allCustomers à¸à¹ˆà¸­à¸™
        if (window.allCustomers && Array.isArray(window.allCustomers)) {
          customer = window.allCustomers.find(c => c._id === customerId || c.contractNo === customerId);
        }
        
        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
        if (!customer) {
          console.error('Customer not found:', customerId);
        }
        
        if (customer) {
          console.log('âœ… Found customer for history:', customer);
          
          // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
          const installmentHistory = [{
            contractNo: customer.contractNo,
            productName: customer.product || 'à¸ªà¸´à¸™à¸„à¹‰à¸²',
            totalAmount: customer.totalAmount,
            monthlyPayment: customer.installmentAmount,
            remainingAmount: customer.remainingAmount,
            status: customer.status,
            startDate: customer.createdAt,
            // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸Šà¸³à¸£à¸°
            payments: []
          }];
          
          showInstallmentHistoryModal(installmentHistory);
        } else {
          console.warn('âŒ Customer not found for history:', customerId);
          showToast('à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™', 'warning');
        }
      } catch (error) {
        console.error('Error viewing installment history:', error);
        showToast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™', 'error');
      }
    };


    // Duplicate showCustomerDetailModal function removed - using the more complete version above

    // Close customer detail modal
    window.closeCustomerDetailModal = function() {
      const modal = document.getElementById('customerDetailModal');
      if (modal) modal.remove();
    };

    // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡ modal à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™
    function showInstallmentHistoryModal(history) {
      console.log('ðŸ“‹ Showing installment history modal for:', history);
      
      if (!history || history.length === 0) {
        showToast('à¹„à¸¡à¹ˆà¸žà¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°', 'info');
        return;
      }
      
      const installment = history[0]; // à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸²à¹à¸£à¸
      const payments = installment.payments || [];
      
      const modalHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="installmentHistoryModal">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold text-gray-800 dark:text-white">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°</h2>
              <button onclick="closeInstallmentHistoryModal()" class="btn btn-ghost btn-sm">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            
            <!-- à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸² -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <span class="text-sm text-gray-600 dark:text-gray-400">à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸ªà¸±à¸à¸à¸²</span>
                  <p class="font-semibold">${installment.contractNo}</p>
                </div>
                <div>
                  <span class="text-sm text-gray-600 dark:text-gray-400">à¸ªà¸´à¸™à¸„à¹‰à¸²</span>
                  <p class="font-semibold">${installment.productName}</p>
                </div>
                <div>
                  <span class="text-sm text-gray-600 dark:text-gray-400">à¸¢à¸­à¸”à¸£à¸§à¸¡</span>
                  <p class="font-semibold text-blue-600">${formatCurrency(installment.totalAmount)}</p>
                </div>
                <div>
                  <span class="text-sm text-gray-600 dark:text-gray-400">à¸„à¹ˆà¸²à¸‡à¸§à¸”/à¹€à¸”à¸·à¸­à¸™</span>
                  <p class="font-semibold text-green-600">${formatCurrency(installment.monthlyPayment)}</p>
                </div>
              </div>
            </div>
            
            <!-- à¸•à¸²à¸£à¸²à¸‡à¸à¸²à¸£à¸Šà¸³à¸£à¸° -->
            <div class="overflow-x-auto">
              <table class="table w-full">
                <thead>
                  <tr class="bg-gray-100 dark:bg-gray-700">
                    <th class="text-center">à¸‡à¸§à¸”à¸—à¸µà¹ˆ</th>
                    <th class="text-center">à¸à¸³à¸«à¸™à¸”à¸Šà¸³à¸£à¸°</th>
                    <th class="text-center">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™</th>
                    <th class="text-center">à¸§à¸±à¸™à¸—à¸µà¹ˆà¸Šà¸³à¸£à¸°</th>
                    <th class="text-center">à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ</th>
                    <th class="text-center">à¸ªà¸–à¸²à¸™à¸°</th>
                  </tr>
                </thead>
                <tbody>
                  ${payments.map(payment => `
                    <tr class="${payment.status === 'paid' ? 'bg-green-50 dark:bg-green-900/20' : 
                                 payment.status === 'pending' ? 'bg-yellow-50 dark:bg-yellow-900/20' : 
                                 'bg-gray-50 dark:bg-gray-800'}">
                      <td class="text-center font-medium">${payment.period}</td>
                      <td class="text-center">${formatDate(payment.dueDate)}</td>
                      <td class="text-center font-medium">${formatCurrency(payment.amount)}</td>
                      <td class="text-center">${payment.paidDate ? formatDate(payment.paidDate) : '-'}</td>
                      <td class="text-center">${payment.receiptNo || '-'}</td>
                      <td class="text-center">
                        <span class="badge ${
                          payment.status === 'paid' ? 'badge-success' : 
                          payment.status === 'pending' ? 'badge-warning' : 
                          'badge-ghost'
                        }">
                          ${payment.status === 'paid' ? 'à¸Šà¸³à¸£à¸°à¹à¸¥à¹‰à¸§' : 
                            payment.status === 'pending' ? 'à¸£à¸­à¸Šà¸³à¸£à¸°' : 
                            'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡à¸à¸³à¸«à¸™à¸”'}
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸Šà¸³à¸£à¸° -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="text-center p-4 bg-green-100 dark:bg-green-900/30 rounded-lg">
                <div class="text-2xl font-bold text-green-600">${payments.filter(p => p.status === 'paid').length}</div>
                <div class="text-sm text-green-700 dark:text-green-300">à¸‡à¸§à¸”à¸—à¸µà¹ˆà¸Šà¸³à¸£à¸°à¹à¸¥à¹‰à¸§</div>
              </div>
              <div class="text-center p-4 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                <div class="text-2xl font-bold text-yellow-600">${payments.filter(p => p.status === 'pending').length}</div>
                <div class="text-sm text-yellow-700 dark:text-yellow-300">à¸‡à¸§à¸”à¸—à¸µà¹ˆà¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸°</div>
              </div>
              <div class="text-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div class="text-2xl font-bold text-gray-600">${payments.filter(p => p.status === 'upcoming').length}</div>
                <div class="text-sm text-gray-700 dark:text-gray-300">à¸‡à¸§à¸”à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡à¸à¸³à¸«à¸™à¸”</div>
              </div>
            </div>
            
            <div class="flex justify-end mt-6">
              <button onclick="closeInstallmentHistoryModal()" class="btn btn-secondary">
                à¸›à¸´à¸”
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      console.log('âœ… Installment history modal displayed');
    }

    window.closeInstallmentHistoryModal = function() {
      const modal = document.getElementById('installmentHistoryModal');
      if (modal) modal.remove();
    };

}); // End of DOMContentLoaded event listener

// ======== Customer Data Population Functions ========

// Function to populate table with real data from tax-summary API
async function populateCustomerDataFromTaxSummary() {
  try {
    // Loading customer data from API
    
    const token = localStorage.getItem('authToken');
    if (!token) {
      console.error('âŒ No auth token found');
      return [];
    }
    
    // à¹€à¸£à¸µà¸¢à¸ tax-summary API à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²
    const response = await fetch('/api/installment/tax-summary', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('ðŸ“Š Tax summary data:', data);
    
    if (data.success && data.data.details && data.data.details.length > 0) {
      // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ tax-summary à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸¥à¸¹à¸à¸„à¹‰à¸²
      const customers = data.data.details.map((detail, index) => ({
        _id: detail.contractNumber || `customer-${index + 1}`,
        contractNo: detail.contractNumber,
        customerName: detail.customerName,
        customerPhone: '08xxxxxxxx', // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¹ƒà¸™ tax-summary
        customer_info: {
          firstName: detail.customerName.split(' ').slice(-1)[0] || '',
          lastName: detail.customerName.split(' ').slice(0, -1).join(' ') || '',
          phone: '08xxxxxxxx',
          taxId: detail.taxId,
          prefix: detail.customerName.split(' ')[0] || ''
        },
        status: detail.status || 'active',
        totalAmount: detail.total || detail.amount,
        remainingAmount: detail.total || detail.amount, // à¸ªà¸¡à¸¡à¸•à¸´à¸§à¹ˆà¸²à¸¢à¸±à¸‡à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¹€à¸•à¹‡à¸¡à¸ˆà¸³à¸™à¸§à¸™
        installmentAmount: Math.round((detail.total || detail.amount) / 24), // à¸ªà¸¡à¸¡à¸•à¸´ 24 à¸‡à¸§à¸”
        product: detail.product,
        gender: detail.customerName.includes('à¸™à¸²à¸‡') ? 'à¸«à¸à¸´à¸‡' : 
                detail.customerName.includes('à¸™à¸²à¸¢') ? 'à¸Šà¸²à¸¢' : 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸',
        selfieUrl: null,
        branchCode: '00000',
        createdAt: detail.date
      }));
      
      console.log('ðŸ‘¥ Processed customers from API:', customers);
      return customers;
    } else {
      console.log('â„¹ï¸ No customer data found in tax-summary');
      return [];
    }
    
  } catch (error) {
    console.error('âŒ Error loading customer data from API:', error);
    return [];
  }
}

// Customer data population function

// Initialize customer data when page loads - DISABLED to prevent conflict
// setTimeout(async () => {
//   // à¸¥à¸­à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ API à¸à¹ˆà¸­à¸™
//   let customers = await populateCustomerDataFromTaxSummary();
//   
//   // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ API
//   if (!customers || customers.length === 0) {
//     return;
//   }
//   
//   // à¹à¸ªà¸”à¸‡à¸œà¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ using consolidated render function
//   renderCustomers(customers, false);
//   
// }, 2000); // à¸£à¸­ 2 à¸§à¸´à¸™à¸²à¸—à¸µà¹ƒà¸«à¹‰à¸«à¸™à¹‰à¸²à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ

  </script>
  
  <!-- Remove external script reference since we included it inline -->
</body>
</html>




