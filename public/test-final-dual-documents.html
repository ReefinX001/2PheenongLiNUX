<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö (Final Test)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .log-success { @apply text-green-600 font-semibold; }
        .log-error { @apply text-red-600 font-semibold; }
        .log-info { @apply text-blue-600; }
        .log-step { @apply text-purple-600 font-bold text-lg; }
        .log-section { @apply text-gray-800 font-bold text-xl border-b-2 border-gray-300 pb-2 mb-4; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-600">
                üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
            </h1>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
            <div class="flex gap-4 mb-6">
                <button onclick="runTest()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üöÄ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                </button>
                <button onclick="clearResults()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                </button>
                <button onclick="checkLoginStatus()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                    üîë ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <a href="/login.html" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors inline-block">
                    üë§ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </a>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö -->
            <div class="bg-gray-100 rounded-lg p-4 mb-6">
                <h3 class="font-bold text-lg mb-2">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> 00006 - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏ï‡∏π‡∏•<br>
                        <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> BOTH_DOCUMENTS<br>
                        <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> 14,900 ‡∏ö‡∏≤‡∏ó
                    </div>
                    <div>
                        <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ‡∏ô‡∏≤‡∏¢ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢<br>
                        <strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> IPAD GEN10 256GB BLUE<br>
                        <strong>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:</strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                    </div>
                </div>
            </div>

            <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
            <div id="results" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
                <div class="text-yellow-400">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
            </div>

            <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
            <div id="summary" class="mt-6 hidden">
                <h3 class="font-bold text-lg mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h3>
                <div id="summaryContent" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        const testData = {
            items: [
                {
                    id: '68721b5537da42f5e3681e5b',
                    name: 'IPAD GEN10 256GB BLUE (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)',
                    qty: 1,
                    price: 14900,
                    total: 14900,
                    taxType: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ',
                    imei: 'SWKD4W5N61C',
                    brand: '',
                    productCode: '',
                    category: ''
                }
            ],
            customerType: 'individual',
            customerInfo: {
                prefix: '‡∏ô‡∏≤‡∏¢',
                firstName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                lastName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢',
                phone: '0622070097',
                phoneNumber: '0622070097',
                email: 'test@example.com',
                age: 30,
                birthDate: '1994-01-15',
                address: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 123 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï‡∏≥‡∏ö‡∏• ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 94000',
                taxId: '1234567891234'
            },
            customerTaxId: '1234567891234',
            companyTaxId: '',
            subTotal: 14900,
            vatAmount: 0,
            netAmount: 14900,
            discount: 0,
            promotionDiscount: 0,
            total: 14900,
            paymentMethod: 'cash',
            paymentInfo: {
                received: true,
                method: 'cash',
                amount: 14900,
                timestamp: new Date().toISOString()
            },
            invoiceType: 'BOTH_DOCUMENTS',
            transactionType: 'sale',
            branch_code: '00006', // ‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏ï‡∏π‡∏•
            staffId: '681eb8aeb1593cea17568916',
            staffName: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
            appliedPromotions: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            documentNumberFormat: {
                receiptPrefix: 'RE',
                taxInvoicePrefix: 'TX',
                dateFormat: new Date().toISOString().slice(2, 10).replace(/-/g, '')
            }
        };

        let testResults = {
            success: false,
            receiptNumber: null,
            taxInvoiceNumber: null,
            receiptId: null,
            taxInvoiceId: null,
            errors: []
        };

        function logMessage(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            const colorClass = type === 'success' ? 'text-green-400' :
                              type === 'error' ? 'text-red-400' :
                              type === 'step' ? 'text-yellow-400' :
                              type === 'section' ? 'text-cyan-400' : 'text-white';
        
            results.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function logSection(title) {
            logMessage('‚îÅ'.repeat(60), 'section');
            logMessage(`üîç ${title}`, 'section');
            logMessage('‚îÅ'.repeat(60), 'section');
        }

        function logStep(step, message) {
            logMessage(`üìå Step ${step}: ${message}`, 'step');
        }

        function logSuccess(message) {
            logMessage(`‚úÖ ${message}`, 'success');
        }

        function logError(message) {
            logMessage(`‚ùå ${message}`, 'error');
            testResults.errors.push(message);
        }

        function logInfo(message) {
            logMessage(`‚ÑπÔ∏è  ${message}`, 'info');
        }

        async function runTest() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').classList.add('hidden');
            testResults = { success: false, receiptNumber: null, taxInvoiceNumber: null, receiptId: null, taxInvoiceId: null, errors: [] };

            logSection('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)');
        
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token
                const token = localStorage.getItem('authToken');
                if (!token) {
                    logError('‡πÑ‡∏°‡πà‡∏û‡∏ö authentication token');
                    logInfo('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≤‡∏ô POS ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                    logInfo('üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: /login.html');
                    return;
                }

                logStep(1, '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á API...');
                logInfo(`üîó URL: /api/taxinvoice/checkout`);
                logInfo(`üìã Invoice Type: ${testData.invoiceType}`);
                logInfo(`üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${testData.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
                logInfo(`üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${testData.customerInfo.firstName} ${testData.customerInfo.lastName}`);
                logInfo(`üì± ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${testData.items[0].name}`);
                logInfo(`üîë Token: ${token.substring(0, 20)}...`);
        
                const response = await fetch('/api/taxinvoice/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testData)
                });

                logStep(2, '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å API...');
                logInfo(`üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á: ${response.status}`);

                const responseData = await response.json();

                if (!response.ok) {
                    logError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${response.status} - ${response.statusText}`);
                    logError(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${JSON.stringify(responseData, null, 2)}`);
                    return;
                }

                logSuccess('‚úì API ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                logSuccess(`‚úì Message: ${responseData.message || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'}`);

                logStep(3, '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á...');
        
                // Debug: ‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                logInfo(`üîç DEBUG - Response structure: ${JSON.stringify(Object.keys(responseData), null, 2)}`);
                logInfo(`üîç DEBUG - Data structure: ${JSON.stringify(responseData.data ? Object.keys(responseData.data) : 'No data', null, 2)}`);

                if (responseData.data) {
                    const data = responseData.data;
        
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠ structure ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
                    let receiptData = data.receipt || data.receiptData || null;
                    let receiptNumber = receiptData?.receiptNumber || receiptData?.documentNumber || data.receiptNumber || null;
                    let receiptId = receiptData?.id || receiptData?._id || data.receipt_id || null;
        
                    logInfo(`üìÑ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${receiptNumber || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'}`);
                    logInfo(`üìÑ Receipt ID: ${receiptId || '‡πÑ‡∏°‡πà‡∏û‡∏ö ID'}`);
        
                    if (receiptNumber) {
                        testResults.receiptNumber = receiptNumber;
                        testResults.receiptId = receiptId;
        
                        if (receiptNumber.startsWith('RE-') && !receiptNumber.includes('RE-RE')) {
                            logSuccess('‚úì ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö RE-XXXXXX-XXXX)');
                        } else {
                            logError(`‚úó ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${receiptNumber}`);
                        }
                    } else {
                        logError('‚úó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à');
                        logInfo(`üîç Available receipt keys: ${JSON.stringify(Object.keys(receiptData || {}), null, 2)}`);
                    }
        
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠ structure ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
                    let taxInvoiceData = data.taxInvoice || data.taxInvoiceData || null;
                    let taxInvoiceNumber = taxInvoiceData?.taxInvoiceNumber || data.taxInvoiceNumber || data.invoice_no || null;
                    let taxInvoiceId = taxInvoiceData?.id || taxInvoiceData?._id || data.taxInvoice_id || null;
        
                    logInfo(`üßæ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ: ${taxInvoiceNumber || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'}`);
                    logInfo(`üßæ Tax Invoice ID: ${taxInvoiceId || '‡πÑ‡∏°‡πà‡∏û‡∏ö ID'}`);
        
                    if (taxInvoiceNumber) {
                        testResults.taxInvoiceNumber = taxInvoiceNumber;
                        testResults.taxInvoiceId = taxInvoiceId;
        
                        if (taxInvoiceNumber.startsWith('TX-') && !taxInvoiceNumber.includes('RE-TX')) {
                            logSuccess('‚úì ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö TX-XXXXXX-XXXX)');
                        } else {
                            logError(`‚úó ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${taxInvoiceNumber}`);
                        }
                    } else {
                        logError('‚úó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ');
                        logInfo(`üîç Available tax invoice keys: ${JSON.stringify(Object.keys(taxInvoiceData || {}), null, 2)}`);
                    }
        
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö
                    if (testResults.receiptNumber && testResults.taxInvoiceNumber) {
                        const receiptSeq = testResults.receiptNumber.split('-').pop();
                        const taxInvoiceSeq = testResults.taxInvoiceNumber.split('-').pop();
        
                        if (receiptSeq === taxInvoiceSeq) {
                            logSuccess(`‚úì ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô: ${receiptSeq}`);
                        } else {
                            logError(`‚úó ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (Receipt: ${receiptSeq}, Tax Invoice: ${taxInvoiceSeq})`);
                        }
                    }

                    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á PDF
                    if (testResults.receiptId || testResults.taxInvoiceId) {
                        await testPDFAccess();
                    }

                    testResults.success = testResults.errors.length === 0;
                    showSummary();
        
                } else {
                    logError('‚úó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á');
                }

            } catch (error) {
                logError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        }

        async function testPDFAccess() {
            logStep(4, '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå PDF...');
        
            const token = localStorage.getItem('authToken');
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            if (testResults.receiptId) {
                try {
                    logInfo('üìÑ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô...');
                    const receiptPdfResponse = await fetch(`/api/pdf/receipt-pdf/${testResults.receiptId}`, {
                        headers: headers
                    });
        
                    if (receiptPdfResponse.ok) {
                        logSuccess(`‚úì PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ (Status: ${receiptPdfResponse.status})`);
                        logInfo(`üîó URL: /api/pdf/receipt-pdf/${testResults.receiptId}`);
                    } else {
                        logError(`‚úó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ (Status: ${receiptPdfResponse.status})`);
                    }
                } catch (error) {
                    logError(`‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${error.message}`);
                }
            }

            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            if (testResults.taxInvoiceId) {
                try {
                    logInfo('üßæ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ...');
                    const taxInvoicePdfResponse = await fetch(`/api/pdf/tax-invoice-pdf/${testResults.taxInvoiceId}`, {
                        headers: headers
                    });
        
                    if (taxInvoicePdfResponse.ok) {
                        logSuccess(`‚úì PDF ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ (Status: ${taxInvoicePdfResponse.status})`);
                        logInfo(`üîó URL: /api/pdf/a4-tax-invoice-fixed/${testResults.taxInvoiceId}`);
                    } else {
                        logError(`‚úó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á PDF ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ (Status: ${taxInvoicePdfResponse.status})`);
                    }
                } catch (error) {
                    logError(`‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö PDF ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ: ${error.message}`);
                }
            }
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
        
            summaryContent.innerHTML = '';
        
            if (testResults.success) {
                summaryContent.innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                        <strong>‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÉ‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <h4 class="font-bold">üìÑ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4>
                            <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${testResults.receiptNumber}</p>
                            ${testResults.receiptId ? `<a href="/api/pdf/receipt-pdf/${testResults.receiptId}" target="_blank" class="text-blue-600 hover:underline">üìÑ ‡∏î‡∏π PDF</a>` : ''}
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <h4 class="font-bold">üßæ ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</h4>
                            <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${testResults.taxInvoiceNumber}</p>
                            ${testResults.taxInvoiceId ? `<a href="/api/pdf/tax-invoice-pdf/${testResults.taxInvoiceId}" target="_blank" class="text-blue-600 hover:underline">üßæ ‡∏î‡∏π PDF</a>` : ''}
                        </div>
                    </div>
                `;
            } else {
                summaryContent.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong>‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</strong><br>
                        ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${testResults.errors.length} ‡∏à‡∏∏‡∏î:
                        <ul class="list-disc list-inside mt-2">
                            ${testResults.errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        
            summaryDiv.classList.remove('hidden');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '<div class="text-yellow-400">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>';
            document.getElementById('summary').classList.add('hidden');
        }

        function checkLoginStatus() {
            document.getElementById('results').innerHTML = '';
        
            const token = localStorage.getItem('authToken');
        
            logSection('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        
            if (token) {
                logSuccess('‚úì ‡∏û‡∏ö authentication token');
                logInfo(`üîë Token: ${token.substring(0, 30)}...`);
                logInfo(`üìè Token length: ${token.length} characters`);
        
                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö token ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API /api/users/me
                fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        logSuccess('‚úì Token ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
                        logInfo(`üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${data.data.username || data.data.email}`);
                        logInfo(`üè∑Ô∏è Role: ${data.data.role?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`);
                        logSuccess('üéØ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£!');
                    } else {
                        logError('‚úó Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
                        logInfo('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    }
                })
                .catch(error => {
                    logError(`‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token: ${error.message}`);
                });
            } else {
                logError('‚úó ‡πÑ‡∏°‡πà‡∏û‡∏ö authentication token');
                logInfo('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
                logInfo('üîó ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô');
            }
        }
    </script>
</body>
</html>
